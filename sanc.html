<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SanctuaryRPG Mobile</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Courier New', monospace;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            background-color: #000;
            color: #0f0;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        
        #game-wrapper {
            height: 75vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #0f0;
            padding: 5px;
            overflow: hidden;
        }
        
        #output {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            font-size: 20px;
        }
        
        #input-container {
            display: flex;
            flex-direction: column;
        }
        
        .button-row {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 5px;
        }
        
        button {
            flex: 1;
            min-width: 60px;
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 12px 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:active {
            background: #0f0;
            color: #000;
        }
        
        .enemy {
            color: #f00;
        }
        
        .player {
            color: #0af;
        }
        
        .item {
            color: #ff0;
        }
        
        .gold {
            color: #fc0;
        }
        
        .health {
            color: #f00;
        }
        
        .mana {
            color: #00f;
        }
        
        .xp {
            color: #0f0;
        }
        
        .level {
            color: #f0f;
        }
        
        .critical {
            color: #f80;
            font-weight: bold;
        }
        
        .dodge {
            color: #0ff;
            font-weight: bold;
        }
        
        .success {
            color: #0f0;
            font-weight: bold;
        }
        
        .warning {
            color: #f80;
        }
        
        .error {
            color: #f00;
        }
        
        .ascii-art {
            font-family: monospace;
            white-space: pre;
            line-height: 1;
            font-size: 8px;
        }
        
        .rare {
            color: #0ff;
            font-weight: bold;
        }
        
        .epic {
            color: #f0f;
            font-weight: bold;
        }
        
        .legendary {
            color: #f80;
            font-weight: bold;
        }
        
        /* Mobile-specific optimizations */
        @media (max-width: 480px) {
            button {
                padding: 14px 5px;
                font-size: 14px;
            }
        }

        /* New styles for tutorial and achievements */
        .tutorial {
            color: #0ff;
            font-style: italic;
        }
        
        .achievement {
            color: #f0f;
            font-weight: bold;
            animation: pulse 1s infinite alternate;
        }
        
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }
        
        /* Combat animations */
        .damage-animation {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        
        .heal-animation {
            animation: pulseHeal 0.5s;
        }
        
        @keyframes pulseHeal {
            0% { color: #0f0; }
            50% { color: #fff; }
            100% { color: #0f0; }
        }
        
        /* Health bar styles */
        #health-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #333;
        }
        
        #health-bar-container {
            width: 100%;
            height: 20px;
            background-color: #222;
            border: 1px solid #0f0;
            margin-bottom: 5px;
        }
        
        #health-bar {
            height: 100%;
            background-color: #f00;
            width: 100%;
            transition: width 0.3s ease;
        }
        
        #health-text {
            text-align: center;
            font-size: 14px;
            color: #f00;
        }
        
        #mana-bar-container {
            width: 100%;
            height: 20px;
            background-color: #222;
            border: 1px solid #0f0;
            margin-bottom: 5px;
        }
        
        #mana-bar {
            height: 100%;
            background-color: #00f;
            width: 100%;
            transition: width 0.3s ease;
        }
        
        #mana-text {
            text-align: center;
            font-size: 14px;
            color: #00f;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .action-row {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px 5px;
        }
        
        .back-btn {
            background: #300;
            color: #f88;
            border-color: #f88;
        }
        
        /* New styles for dungeon map */
        .dungeon-map {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin: 10px 0;
            padding: 5px;
            border: 1px solid #333;
            background-color: #111;
        }
        
        .room {
            width: 40px;
            height: 40px;
            border: 1px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
        }
        
        .current-room {
            border: 2px solid #0f0;
            background-color: #222;
        }
        
        .enemy-room {
            color: #f00;
        }
        
        .empty-room {
            color: #666;
        }
        
        .shop-room {
            color: #ff0;
        }
        
        .boss-room {
            color: #f80;
            animation: pulse 1s infinite alternate;
        }
        
        .character-sprite {
            font-size: 24px;
            margin: 10px 0;
            text-align: center;
        }
        
        /* Quest styles */
        .quest {
            color: #af0;
            border-left: 3px solid #af0;
            padding-left: 5px;
            margin: 5px 0;
        }
        
        .quest-completed {
            color: #5a5;
            text-decoration: line-through;
        }
        
        /* Save/Load styles */
        .save-notification {
            color: #5f5;
            animation: fadeOut 2s forwards;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="output"></div>
        <div id="health-container">
            <div id="health-bar-container">
                <div id="health-bar"></div>
            </div>
            <div id="health-text">HP: 100/100</div>
            <div id="mana-bar-container">
                <div id="mana-bar"></div>
            </div>
            <div id="mana-text">MP: 50/50</div>
        </div>
        <div id="input-container">
            <!-- Main action buttons -->
            <div class="button-row" id="main-buttons">
                <button id="btn-fight">Fight</button>
                <button id="btn-inventory">Inventory</button>
                <button id="btn-stats">Stats</button>
                <button id="btn-shop">Shop</button>
                <button id="btn-map">Map</button>
                <button id="btn-quests">Quests</button>
            </div>
            
            <!-- Combat action buttons (hidden by default) -->
            <div class="action-buttons" id="combat-buttons" style="display: none;">
                <div class="action-row">
                    <button class="action-btn" id="btn-attack">Attack</button>
                    <button class="action-btn" id="btn-item">Use Item</button>
                </div>
                <div class="action-row">
                    <button class="action-btn" id="btn-flee">Flee</button>
                    <button class="action-btn" id="btn-special">Special Attack</button>
                </div>
                <button class="action-btn back-btn" id="btn-back">Back</button>
            </div>
            
            <!-- Inventory action buttons (hidden by default) -->
            <div class="action-buttons" id="inventory-buttons" style="display: none;">
                <div class="button-row" id="inventory-items">
                    <!-- Dynamically populated -->
                </div>
                <button class="action-btn back-btn" id="btn-inventory-back">Back</button>
            </div>
            
            <!-- Shop action buttons (hidden by default) -->
            <div class="action-buttons" id="shop-buttons" style="display: none;">
                <div class="action-row">
                    <button class="action-btn" id="btn-weapons">Weapons</button>
                    <button class="action-btn" id="btn-armor">Armor</button>
                </div>
                <div class="action-row">
                    <button class="action-btn" id="btn-potions">Potions</button>
                    <button class="action-btn" id="btn-accessories">Accessories</button>
                </div>
                <div class="action-row">
                    <button class="action-btn" id="btn-sell">Sell Items</button>
                </div>
                <button class="action-btn back-btn" id="btn-shop-back">Back</button>
            </div>
            
            <!-- Shop category buttons (hidden by default) -->
            <div class="action-buttons" id="shop-category-buttons" style="display: none;">
                <div class="button-row" id="shop-items">
                    <!-- Dynamically populated -->
                </div>
                <button class="action-btn back-btn" id="btn-shop-category-back">Back</button>
            </div>
            
            <!-- Number selection buttons (hidden by default) -->
            <div class="button-row" id="number-buttons" style="display: none;">
                <button id="btn-1">1</button>
                <button id="btn-2">2</button>
                <button id="btn-3">3</button>
                <button id="btn-4">4</button>
            </div>
            
            <!-- Save/Load buttons -->
            <div class="button-row" id="save-load-buttons">
                <button id="btn-save">Save Game</button>
                <button id="btn-load">Load Game</button>
            </div>
        </div>
    </div>
    
    <div style="height: 25vh; background-color: #000;"></div>

    <script>
        // Enhanced Game State
        const gameState = {
            player: {
                name: "Hero",
                level: 1,
                xp: 0,
                xpToNextLevel: 100,
                health: 100,
                maxHealth: 100,
                mana: 50,
                maxMana: 50,
                attack: 10,
                defense: 5,
                gold: 50,
                inventory: [],
                equipped: {
                    weapon: null,
                    armor: null,
                    ring: null,
                    amulet: null
                },
                achievements: [],
                tutorialCompleted: false
            },
            currentEnemy: null,
            inCombat: false,
            inShop: false,
            inInventory: false,
            gameOver: false,
            currentRoom: 0,
            enemiesDefeated: 0,
            shopCategory: null,
            combatTurns: 0,
            lastAction: null,
            // New state properties
            quests: [],
            enemyKillCounts: {}
        };

        // Items Database - Expanded with more items
        const items = {
            weapons: [
                { id: 1, name: "Rusty Sword", type: "weapon", attack: 5, value: 10, rarity: "common" },
                { id: 2, name: "Iron Axe", type: "weapon", attack: 8, value: 20, rarity: "common" },
                { id: 3, name: "Steel Greatsword", type: "weapon", attack: 12, value: 40, rarity: "common" },
                { id: 4, name: "Enchanted Blade", type: "weapon", attack: 18, value: 80, rarity: "uncommon" },
                { id: 5, name: "Vorpal Sword", type: "weapon", attack: 25, value: 150, rarity: "rare" },
                { id: 6, name: "Dragonbone Greatsword", type: "weapon", attack: 35, value: 300, rarity: "epic" },
                { id: 7, name: "Sword of a Thousand Truths", type: "weapon", attack: 50, value: 500, rarity: "legendary" },
                { id: 8, name: "Shadow Dagger", type: "weapon", attack: 15, critChance: 0.2, value: 120, rarity: "rare" },
                { id: 9, name: "Frostbrand", type: "weapon", attack: 22, frostDamage: 5, value: 200, rarity: "epic" },
                { id: 10, name: "Staff of the Magi", type: "weapon", attack: 12, magicPower: 15, value: 250, rarity: "epic" },
                { id: 11, name: "Vampiric Blade", type: "weapon", attack: 20, lifesteal: 0.3, value: 180, rarity: "rare" },
                { id: 12, name: "Thunder Hammer", type: "weapon", attack: 28, shockDamage: 8, value: 220, rarity: "epic" }
            ],
            armor: [
                { id: 101, name: "Leather Armor", type: "armor", defense: 3, value: 15, rarity: "common" },
                { id: 102, name: "Chainmail", type: "armor", defense: 6, value: 30, rarity: "common" },
                { id: 103, name: "Plate Armor", type: "armor", defense: 10, value: 60, rarity: "common" },
                { id: 104, name: "Dragon Scale Mail", type: "armor", defense: 15, value: 120, rarity: "uncommon" },
                { id: 105, name: "Mithril Armor", type: "armor", defense: 20, value: 250, rarity: "rare" },
                { id: 106, name: "Armor of the Gods", type: "armor", defense: 30, healthBonus: 50, value: 500, rarity: "legendary" },
                { id: 107, name: "Cloak of Shadows", type: "armor", defense: 8, dodgeChance: 0.15, value: 180, rarity: "rare" },
                { id: 108, name: "Void Robes", type: "armor", defense: 12, manaBonus: 30, value: 220, rarity: "epic" },
                { id: 109, name: "Phoenix Armor", type: "armor", defense: 18, healthRegen: 5, value: 280, rarity: "epic" },
                { id: 110, name: "Titan's Cuirass", type: "armor", defense: 25, damageReduction: 0.1, value: 350, rarity: "legendary" }
            ],
            potions: [
                { id: 201, name: "Health Potion", type: "potion", health: 30, value: 10, rarity: "common" },
                { id: 202, name: "Mana Potion", type: "potion", mana: 20, value: 10, rarity: "common" },
                { id: 203, name: "Elixir", type: "potion", health: 50, mana: 30, value: 25, rarity: "uncommon" },
                { id: 204, name: "Super Potion", type: "potion", health: 100, mana: 50, value: 50, rarity: "rare" },
                { id: 205, name: "Potion of Invulnerability", type: "potion", defenseBonus: 10, duration: 3, value: 80, rarity: "epic" },
                { id: 206, name: "Potion of Rage", type: "potion", attackBonus: 10, duration: 3, value: 70, rarity: "rare" },
                { id: 207, name: "Potion of Clarity", type: "potion", manaRegen: 10, duration: 5, value: 60, rarity: "uncommon" }
            ],
            rings: [
                { id: 301, name: "Ring of Strength", type: "ring", attack: 5, value: 100, rarity: "uncommon" },
                { id: 302, name: "Ring of Protection", type: "ring", defense: 5, value: 100, rarity: "uncommon" },
                { id: 303, name: "Ring of the Phoenix", type: "ring", healthRegen: 5, value: 150, rarity: "rare" },
                { id: 304, name: "Ring of Arcane Power", type: "ring", manaRegen: 5, value: 150, rarity: "rare" },
                { id: 305, name: "Ring of the Berserker", type: "ring", attack: 10, defense: -3, value: 200, rarity: "rare" },
                { id: 306, name: "Ring of the Turtle", type: "ring", defense: 10, attack: -3, value: 200, rarity: "rare" }
            ],
            amulets: [
                { id: 401, name: "Amulet of Vitality", type: "amulet", maxHealth: 20, value: 120, rarity: "uncommon" },
                { id: 402, name: "Amulet of Wisdom", type: "amulet", maxMana: 20, value: 120, rarity: "uncommon" },
                { id: 403, name: "Amulet of the Berserker", type: "amulet", attack: 10, defense: -5, value: 200, rarity: "rare" },
                { id: 404, name: "Amulet of the Turtle", type: "amulet", defense: 10, attack: -5, value: 200, rarity: "rare" },
                { id: 405, name: "Amulet of the Elements", type: "amulet", elementalDamage: 5, value: 250, rarity: "epic" },
                { id: 406, name: "Amulet of Life", type: "amulet", maxHealth: 50, healthRegen: 3, value: 300, rarity: "epic" }
            ],
            scrolls: [
                { id: 501, name: "Scroll of Fireball", type: "scroll", damage: 40, manaCost: 20, value: 50, rarity: "uncommon" },
                { id: 502, name: "Scroll of Lightning", type: "scroll", damage: 60, manaCost: 30, value: 75, rarity: "rare" },
                { id: 503, name: "Scroll of Healing", type: "scroll", heal: 80, manaCost: 25, value: 60, rarity: "uncommon" },
                { id: 504, name: "Scroll of Freezing", type: "scroll", damage: 30, freezeDuration: 2, manaCost: 25, value: 70, rarity: "rare" },
                { id: 505, name: "Scroll of Summoning", type: "scroll", summon: "Wolf", duration: 3, manaCost: 40, value: 90, rarity: "epic" }
            ],
            materials: [
                { id: 601, name: "Iron Ingot", type: "material", value: 10, rarity: "common" },
                { id: 602, name: "Steel Ingot", type: "material", value: 25, rarity: "common" },
                { id: 603, name: "Mithril Ore", type: "material", value: 50, rarity: "uncommon" },
                { id: 604, name: "Dragon Scale", type: "material", value: 100, rarity: "rare" },
                { id: 605, name: "Enchanted Gem", type: "material", value: 150, rarity: "epic" },
                { id: 606, name: "Phoenix Feather", type: "material", value: 200, rarity: "legendary" }
            ]
        };

        // Enemies Database - Expanded with more enemies
        const enemies = [
            { name: "Goblin", health: 30, attack: 8, defense: 2, xp: 20, gold: 5, lootChance: 0.3, minLevel: 1 },
            { name: "Orc", health: 50, attack: 12, defense: 5, xp: 35, gold: 10, lootChance: 0.4, minLevel: 2 },
            { name: "Skeleton", health: 40, attack: 10, defense: 4, xp: 30, gold: 8, lootChance: 0.35, minLevel: 1 },
            { name: "Troll", health: 70, attack: 15, defense: 8, xp: 50, gold: 15, lootChance: 0.5, minLevel: 3 },
            { name: "Dark Knight", health: 90, attack: 20, defense: 12, xp: 70, gold: 25, lootChance: 0.6, minLevel: 5 },
            { name: "Dragon", health: 150, attack: 30, defense: 15, xp: 100, gold: 50, lootChance: 0.8, minLevel: 8 },
            { name: "Lich", health: 120, attack: 35, defense: 10, xp: 120, gold: 40, lootChance: 0.7, minLevel: 7 },
            { name: "Demon", health: 180, attack: 40, defense: 20, xp: 150, gold: 60, lootChance: 0.9, minLevel: 10 },
            { name: "Goblin King", health: 200, attack: 25, defense: 15, xp: 100, gold: 75, lootChance: 1.0, minLevel: 6 },
            { name: "Ancient Dragon", health: 300, attack: 50, defense: 30, xp: 250, gold: 100, lootChance: 1.0, minLevel: 15 },
            { name: "Wraith", health: 80, attack: 25, defense: 5, xp: 60, gold: 20, lootChance: 0.5, minLevel: 4 },
            { name: "Minotaur", health: 120, attack: 30, defense: 15, xp: 90, gold: 35, lootChance: 0.7, minLevel: 6 },
            { name: "Vampire", health: 100, attack: 28, lifesteal: 0.2, defense: 10, xp: 80, gold: 30, lootChance: 0.6, minLevel: 5 }
        ];

        // Boss Enemies - Expanded with more bosses
        const bosses = [
            { name: "The Forgotten King", health: 500, attack: 60, defense: 40, xp: 500, gold: 250, lootChance: 1.0, minLevel: 20 },
            { name: "The Voidwalker", health: 400, attack: 70, defense: 30, xp: 450, gold: 200, lootChance: 1.0, minLevel: 18 },
            { name: "The Corruptor", health: 600, attack: 50, defense: 50, xp: 600, gold: 300, lootChance: 1.0, minLevel: 25 },
            { name: "The Eternal Dragon", health: 700, attack: 65, defense: 45, xp: 700, gold: 400, lootChance: 1.0, minLevel: 30 },
            { name: "The Shadow Lord", health: 550, attack: 75, defense: 35, xp: 650, gold: 350, lootChance: 1.0, minLevel: 28 }
        ];

        // Achievements
        const achievements = [
            { id: 1, name: "First Blood", description: "Defeat your first enemy", earned: false },
            { id: 2, name: "Level 5", description: "Reach level 5", earned: false },
            { id: 3, name: "Level 10", description: "Reach level 10", earned: false },
            { id: 4, name: "Dragon Slayer", description: "Defeat a dragon", earned: false },
            { id: 5, name: "Boss Killer", description: "Defeat your first boss", earned: false },
            { id: 6, name: "Legendary Warrior", description: "Equip a legendary item", earned: false },
            { id: 7, name: "Rich Adventurer", description: "Collect 1000 gold", earned: false },
            { id: 8, name: "Dungeon Explorer", description: "Reach dungeon level 20", earned: false },
            { id: 9, name: "Master Adventurer", description: "Defeat 50 enemies", earned: false },
            { id: 10, name: "The Ultimate", description: "Defeat the final boss", earned: false }
        ];

        // Quests
        const quests = [
            {
                id: 1,
                name: "Goblin Extermination",
                description: "Defeat 5 Goblins",
                type: "kill",
                target: "Goblin",
                count: 5,
                reward: { gold: 50, xp: 100 },
                completed: false
            },
            {
                id: 2,
                name: "Dragon Slayer",
                description: "Defeat a Dragon",
                type: "kill",
                target: "Dragon",
                count: 1,
                reward: { gold: 200, xp: 300 },
                completed: false
            },
            {
                id: 3,
                name: "Treasure Hunter",
                description: "Collect 500 gold",
                type: "collect",
                target: "gold",
                count: 500,
                reward: { item: items.weapons[3] },
                completed: false
            },
            {
                id: 4,
                name: "Dungeon Explorer",
                description: "Reach room 10",
                type: "progress",
                target: "room",
                count: 10,
                reward: { gold: 100, xp: 150 },
                completed: false
            },
            {
                id: 5,
                name: "Equipment Master",
                description: "Equip a rare item",
                type: "equip",
                target: "rare",
                count: 1,
                reward: { gold: 75, xp: 100 },
                completed: false
            }
        ];

        // DOM Elements
        const outputEl = document.getElementById('output');
        const healthBar = document.getElementById('health-bar');
        const healthText = document.getElementById('health-text');
        const manaBar = document.getElementById('mana-bar');
        const manaText = document.getElementById('mana-text');
        
        // Button containers
        const mainButtons = document.getElementById('main-buttons');
        const combatButtons = document.getElementById('combat-buttons');
        const inventoryButtons = document.getElementById('inventory-buttons');
        const shopButtons = document.getElementById('shop-buttons');
        const shopCategoryButtons = document.getElementById('shop-category-buttons');
        const numberButtons = document.getElementById('number-buttons');
        
        // Inventory and shop item containers
        const inventoryItems = document.getElementById('inventory-items');
        const shopItems = document.getElementById('shop-items');
        
        // Main action buttons
        const btnFight = document.getElementById('btn-fight');
        const btnInventory = document.getElementById('btn-inventory');
        const btnStats = document.getElementById('btn-stats');
        const btnShop = document.getElementById('btn-shop');
        const btnMap = document.getElementById('btn-map');
        const btnQuests = document.getElementById('btn-quests');
        const btnSave = document.getElementById('btn-save');
        const btnLoad = document.getElementById('btn-load');
        
        // Combat action buttons
        const btnAttack = document.getElementById('btn-attack');
        const btnItem = document.getElementById('btn-item');
        const btnFlee = document.getElementById('btn-flee');
        const btnSpecial = document.getElementById('btn-special');
        const btnBack = document.getElementById('btn-back');
        
        // Inventory action buttons
        const btnInventoryBack = document.getElementById('btn-inventory-back');
        
        // Shop action buttons
        const btnWeapons = document.getElementById('btn-weapons');
        const btnArmor = document.getElementById('btn-armor');
        const btnPotions = document.getElementById('btn-potions');
        const btnAccessories = document.getElementById('btn-accessories');
        const btnSell = document.getElementById('btn-sell');
        const btnShopBack = document.getElementById('btn-shop-back');
        const btnShopCategoryBack = document.getElementById('btn-shop-category-back');
        
        // Number buttons
        const btn1 = document.getElementById('btn-1');
        const btn2 = document.getElementById('btn-2');
        const btn3 = document.getElementById('btn-3');
        const btn4 = document.getElementById('btn-4');

        // Event Listeners
        btnFight.addEventListener('click', startCombat);
        btnInventory.addEventListener('click', showInventory);
        btnStats.addEventListener('click', showStats);
        btnShop.addEventListener('click', showShop);
        btnMap.addEventListener('click', showMap);
        btnQuests.addEventListener('click', showQuests);
        btnSave.addEventListener('click', saveGame);
        btnLoad.addEventListener('click', loadGame);
        
        // Combat buttons
        btnAttack.addEventListener('click', () => combatChoice(1));
        btnItem.addEventListener('click', () => combatChoice(2));
        btnFlee.addEventListener('click', () => combatChoice(3));
        btnSpecial.addEventListener('click', () => combatChoice(4));
        btnBack.addEventListener('click', backToMain);
        
        // Inventory buttons
        btnInventoryBack.addEventListener('click', backToMain);
        
        // Shop buttons
        btnWeapons.addEventListener('click', () => showShopCategory('weapons'));
        btnArmor.addEventListener('click', () => showShopCategory('armor'));
        btnPotions.addEventListener('click', () => showShopCategory('potions'));
        btnAccessories.addEventListener('click', () => showShopCategory('accessories'));
        btnSell.addEventListener('click', () => showShopCategory('sell'));
        btnShopBack.addEventListener('click', backToMain);
        btnShopCategoryBack.addEventListener('click', showShop);
        
        // Number buttons
        btn1.addEventListener('click', () => handleButton(1));
        btn2.addEventListener('click', () => handleButton(2));
        btn3.addEventListener('click', () => handleButton(3));
        btn4.addEventListener('click', () => handleButton(4));

        // Initialize game
        initializeGame();
        
        function initializeGame() {
            printMessage("=== SanctuaryRPG ===");
            printMessage("A text-based adventure for mobile");
            printMessage("");
            printMessage("Use the buttons below to play.");
            printMessage("You find yourself in a dark dungeon...");
            printMessage("What will you do?");
            printMessage("");
            
            // Initialize enemy kill counts
            enemies.forEach(enemy => {
                gameState.enemyKillCounts[enemy.name] = 0;
            });
            bosses.forEach(boss => {
                gameState.enemyKillCounts[boss.name] = 0;
            });
            
            // Initialize quests
            gameState.quests = JSON.parse(JSON.stringify(quests));
            
            // Update health and mana bars initially
            updateHealthBar();
            updateManaBar();
            
            // Show tutorial if not completed
            if (!gameState.player.tutorialCompleted) {
                showTutorial();
            }
            
            // Try to load saved game
            if (localStorage.getItem('sanctuaryRPG_save')) {
                printMessage("Found saved game. Press 'Load Game' to continue.", "tutorial");
            }
        }

        // Game Functions
        function printMessage(text, className = "") {
            const p = document.createElement('p');
            if (className) p.className = className;
            p.textContent = text;
            outputEl.appendChild(p);
            outputEl.scrollTop = outputEl.scrollHeight;
        }

        function clearOutput() {
            outputEl.innerHTML = '';
        }

        function showMainButtons() {
            mainButtons.style.display = 'flex';
            combatButtons.style.display = 'none';
            inventoryButtons.style.display = 'none';
            shopButtons.style.display = 'none';
            shopCategoryButtons.style.display = 'none';
            numberButtons.style.display = 'none';
        }
        
        function showCombatButtons() {
            mainButtons.style.display = 'none';
            combatButtons.style.display = 'flex';
            inventoryButtons.style.display = 'none';
            shopButtons.style.display = 'none';
            shopCategoryButtons.style.display = 'none';
            numberButtons.style.display = 'none';
        }
        
        function showInventoryButtons() {
            mainButtons.style.display = 'none';
            combatButtons.style.display = 'none';
            inventoryButtons.style.display = 'flex';
            shopButtons.style.display = 'none';
            shopCategoryButtons.style.display = 'none';
            numberButtons.style.display = 'none';
        }
        
        function showShopButtons() {
            mainButtons.style.display = 'none';
            combatButtons.style.display = 'none';
            inventoryButtons.style.display = 'none';
            shopButtons.style.display = 'flex';
            shopCategoryButtons.style.display = 'none';
            numberButtons.style.display = 'none';
        }
        
        function showShopCategoryButtons() {
            mainButtons.style.display = 'none';
            combatButtons.style.display = 'none';
            inventoryButtons.style.display = 'none';
            shopButtons.style.display = 'none';
            shopCategoryButtons.style.display = 'flex';
            numberButtons.style.display = 'none';
        }
        
        function showNumberButtons() {
            mainButtons.style.display = 'none';
            combatButtons.style.display = 'none';
            inventoryButtons.style.display = 'none';
            shopButtons.style.display = 'none';
            shopCategoryButtons.style.display = 'none';
            numberButtons.style.display = 'flex';
        }
        
        function backToMain() {
            gameState.inCombat = false;
            gameState.inShop = false;
            gameState.inInventory = false;
            gameState.shopCategory = null;
            showMainButtons();
            printMessage("");
            printMessage("What will you do now?");
        }

        function updateHealthBar() {
            const player = gameState.player;
            const healthPercentage = (player.health / player.maxHealth) * 100;
            healthBar.style.width = `${healthPercentage}%`;
            healthText.textContent = `HP: ${player.health}/${player.maxHealth}`;
            
            // Change color based on health level
            if (healthPercentage < 20) {
                healthBar.style.backgroundColor = '#ff0000';
            } else if (healthPercentage < 50) {
                healthBar.style.backgroundColor = '#ff6600';
            } else {
                healthBar.style.backgroundColor = '#00ff00';
            }
        }

        function updateManaBar() {
            const player = gameState.player;
            const manaPercentage = (player.mana / player.maxMana) * 100;
            manaBar.style.width = `${manaPercentage}%`;
            manaText.textContent = `MP: ${player.mana}/${player.maxMana}`;
        }

        function showTutorial() {
            clearOutput();
            printMessage("=== TUTORIAL ===", "tutorial");
            printMessage("Welcome to SanctuaryRPG!", "tutorial");
            printMessage("This is a text-based adventure game where you fight enemies, collect loot, and grow stronger.", "tutorial");
            printMessage("", "tutorial");
            printMessage("HOW TO PLAY:", "tutorial");
            printMessage("- Use the buttons to navigate and make choices", "tutorial");
            printMessage("- In combat, choose actions with the combat buttons", "tutorial");
            printMessage("- Equip weapons and armor from your inventory to become stronger", "tutorial");
            printMessage("- Buy better gear at the shop with gold earned from battles", "tutorial");
            printMessage("- Use potions to heal during combat", "tutorial");
            printMessage("- Check your Map to see dungeon progress", "tutorial");
            printMessage("- Complete Quests for additional rewards", "tutorial");
            printMessage("- Save your progress regularly", "tutorial");
            printMessage("", "tutorial");
            printMessage("TIP: The deeper you go in the dungeon, the stronger the enemies become!", "tutorial");
            printMessage("", "tutorial");
            printMessage("Press any button to begin your adventure!", "tutorial");
            
            // Mark tutorial as completed
            gameState.player.tutorialCompleted = true;
        }

        function handleButton(choice) {
            if (gameState.inCombat) {
                combatChoice(choice);
            } else if (gameState.inShop) {
                if (gameState.shopCategory) {
                    handleShopSelection(choice - 1);
                }
            } else if (gameState.inInventory) {
                handleInventorySelection(choice - 1);
            }
        }

        function startCombat() {
            if (gameState.inCombat) {
                printMessage("You're already in combat!", "warning");
                return;
            }
            
            gameState.currentRoom++;
            gameState.combatTurns = 0;
            
            // Every 10 rooms, spawn a boss
            let enemyPool;
            if (gameState.currentRoom % 10 === 0 && gameState.player.level >= 15) {
                enemyPool = bosses;
            } else {
                enemyPool = enemies;
            }
            
            // Filter enemies by minimum level
            const availableEnemies = enemyPool.filter(enemy => enemy.minLevel <= gameState.player.level);
            
            if (availableEnemies.length === 0) {
                printMessage("No suitable enemies found at your level!", "warning");
                return;
            }
            
            // Higher chance for stronger enemies as room number increases
            const enemyIndex = Math.min(
                Math.floor(Math.pow(gameState.currentRoom / 3, 0.7)), 
                availableEnemies.length - 1
            );
            
            gameState.currentEnemy = {...availableEnemies[enemyIndex]};
            gameState.inCombat = true;
            gameState.inShop = false;
            gameState.inInventory = false;
            gameState.shopCategory = null;
            
            clearOutput();
            showCombatButtons();
            showCombatSprites();
            printMessage(`You encounter a ${gameState.currentEnemy.name}!`);
            printMessage("");
            printCombatStatus();
        }

        function printCombatStatus() {
            const player = gameState.player;
            const enemy = gameState.currentEnemy;
            
            printMessage(`You: HP [${player.health}/${player.maxHealth}] | MP [${player.mana}/${player.maxMana}]`, "player");
            printMessage(`${enemy.name}: HP [${enemy.health}]`, "enemy");
            
            // Update health and mana bars
            updateHealthBar();
            updateManaBar();
        }

        function combatChoice(choice) {
            if (!gameState.inCombat) return;
            
            gameState.combatTurns++;
            gameState.lastAction = choice;
            
            const player = gameState.player;
            const enemy = gameState.currentEnemy;
            
            switch(choice) {
                case 1: // Attack
                    playerAttack();
                    break;
                case 2: // Use Item
                    useItemInCombat();
                    break;
                case 3: // Flee
                    attemptFlee();
                    break;
                case 4: // Special Attack
                    specialAttack();
                    break;
                default:
                    printMessage("Invalid choice in combat!", "warning");
            }
        }

        function playerAttack() {
            const player = gameState.player;
            const enemy = gameState.currentEnemy;
            
            // Calculate base attack value
            let playerAttackValue = player.attack;
            
            // Add weapon attack if equipped
            if (player.equipped.weapon) {
                playerAttackValue += player.equipped.weapon.attack;
                
                // Check for special weapon effects
                if (player.equipped.weapon.critChance && Math.random() < player.equipped.weapon.critChance) {
                    playerAttackValue *= 2;
                    printMessage(`Your ${player.equipped.weapon.name} glows as you strike!`, "rare");
                }
                
                if (player.equipped.weapon.frostDamage) {
                    playerAttackValue += player.equipped.weapon.frostDamage;
                }
                
                if (player.equipped.weapon.lifesteal) {
                    // Lifesteal effect will be applied after damage is calculated
                }
                
                if (player.equipped.weapon.shockDamage) {
                    playerAttackValue += player.equipped.weapon.shockDamage;
                }
            }
            
            // Add ring attack if equipped
            if (player.equipped.ring && player.equipped.ring.attack) {
                playerAttackValue += player.equipped.ring.attack;
            }
            
            // Add amulet attack if equipped
            if (player.equipped.amulet && player.equipped.amulet.attack) {
                playerAttackValue += player.equipped.amulet.attack;
            }
            
            const playerDamage = calculateDamage(playerAttackValue, enemy.defense);
            
            if (playerDamage === 0) {
                printMessage(`You attack the ${enemy.name} but miss!`, "dodge");
            } else if (playerDamage > playerAttackValue * 1.5) {
                printMessage(`You critically hit the ${enemy.name} for ${playerDamage} damage!`, "critical");
                enemy.health -= playerDamage;
                
                // Apply lifesteal if weapon has it
                if (player.equipped.weapon && player.equipped.weapon.lifesteal) {
                    const healAmount = Math.floor(playerDamage * player.equipped.weapon.lifesteal);
                    player.health = Math.min(player.maxHealth, player.health + healAmount);
                    printMessage(`You steal ${healAmount} health from the ${enemy.name}!`, "health heal-animation");
                    updateHealthBar();
                }
            } else {
                printMessage(`You hit the ${enemy.name} for ${playerDamage} damage.`);
                enemy.health -= playerDamage;
                
                // Apply lifesteal if weapon has it
                if (player.equipped.weapon && player.equipped.weapon.lifesteal) {
                    const healAmount = Math.floor(playerDamage * player.equipped.weapon.lifesteal);
                    player.health = Math.min(player.maxHealth, player.health + healAmount);
                    printMessage(`You steal ${healAmount} health from the ${enemy.name}!`, "health heal-animation");
                    updateHealthBar();
                }
            }
            
            // Check if enemy is defeated
            if (enemy.health <= 0) {
                enemyDefeated();
                return;
            }
            
            enemyAttack();
        }

        function specialAttack() {
            const player = gameState.player;
            const enemy = gameState.currentEnemy;
            
            if (player.mana < 20) {
                printMessage("Not enough mana for special attack!", "warning");
                return;
            }
            
            player.mana -= 20;
            updateManaBar();
            
            // Calculate special attack damage (1.5x normal attack)
            let specialAttackValue = (player.attack + 
                                    (player.equipped.weapon ? player.equipped.weapon.attack : 0)) * 1.5;
            
            // Add bonuses from accessories
            if (player.equipped.ring && player.equipped.ring.attack) {
                specialAttackValue += player.equipped.ring.attack;
            }
            if (player.equipped.amulet && player.equipped.amulet.attack) {
                specialAttackValue += player.equipped.amulet.attack;
            }
            
            const specialDamage = calculateDamage(specialAttackValue, enemy.defense * 0.8); // Bypasses some defense
            
            if (specialDamage === 0) {
                printMessage(`You unleash a special attack but the ${enemy.name} dodges!`, "dodge");
            } else {
                printMessage(`You unleash a powerful special attack for ${specialDamage} damage!`, "critical");
                enemy.health -= specialDamage;
                
                // Apply lifesteal if weapon has it
                if (player.equipped.weapon && player.equipped.weapon.lifesteal) {
                    const healAmount = Math.floor(specialDamage * player.equipped.weapon.lifesteal);
                    player.health = Math.min(player.maxHealth, player.health + healAmount);
                    printMessage(`You steal ${healAmount} health from the ${enemy.name}!`, "health heal-animation");
                    updateHealthBar();
                }
            }
            
            // Check if enemy is defeated
            if (enemy.health <= 0) {
                enemyDefeated();
                return;
            }
            
            enemyAttack();
        }

        function enemyAttack() {
            const player = gameState.player;
            const enemy = gameState.currentEnemy;
            
            // Enemy attack
            const enemyDamage = calculateDamage(enemy.attack, 
                                            player.defense + (player.equipped.armor ? player.equipped.armor.defense : 0));
            
            if (enemyDamage === 0) {
                printMessage(`The ${enemy.name} attacks you but you dodge!`, "dodge");
            } else if (enemyDamage > enemy.attack * 1.5) {
                printMessage(`The ${enemy.name} critically hits you for ${enemyDamage} damage!`, "critical enemy");
                player.health -= enemyDamage;
                updateHealthBar();
                
                // Apply enemy lifesteal if they have it
                if (enemy.lifesteal) {
                    const enemyHeal = Math.floor(enemyDamage * enemy.lifesteal);
                    enemy.health = Math.min(enemy.health + enemyHeal, enemy.health);
                    printMessage(`The ${enemy.name} steals ${enemyHeal} health from you!`, "enemy");
                }
            } else {
                printMessage(`The ${enemy.name} hits you for ${enemyDamage} damage.`, "enemy");
                player.health -= enemyDamage;
                updateHealthBar();
                
                // Apply enemy lifesteal if they have it
                if (enemy.lifesteal) {
                    const enemyHeal = Math.floor(enemyDamage * enemy.lifesteal);
                    enemy.health = Math.min(enemy.health + enemyHeal, enemy.health);
                    printMessage(`The ${enemy.name} steals ${enemyHeal} health from you!`, "enemy");
                }
            }
            
            // Check if player is defeated
            if (player.health <= 0) {
                playerDefeated();
                return;
            }
            
            // Apply regeneration effects at the end of turn
            applyRegenerationEffects();
            
            printMessage("");
            printCombatStatus();
        }

        function applyRegenerationEffects() {
            const player = gameState.player;
            
            // Health regeneration from ring
            if (player.equipped.ring && player.equipped.ring.healthRegen) {
                const oldHealth = player.health;
                player.health = Math.min(player.maxHealth, player.health + player.equipped.ring.healthRegen);
                const healed = player.health - oldHealth;
                if (healed > 0) {
                    printMessage(`You regenerate ${healed} health from your ${player.equipped.ring.name}.`, "health heal-animation");
                    updateHealthBar();
                }
            }
            
            // Mana regeneration from ring
            if (player.equipped.ring && player.equipped.ring.manaRegen) {
                const oldMana = player.mana;
                player.mana = Math.min(player.maxMana, player.mana + player.equipped.ring.manaRegen);
                const restored = player.mana - oldMana;
                if (restored > 0) {
                    printMessage(`You regenerate ${restored} mana from your ${player.equipped.ring.name}.`, "mana");
                    updateManaBar();
                }
            }
            
            // Health regeneration from armor
            if (player.equipped.armor && player.equipped.armor.healthRegen) {
                const oldHealth = player.health;
                player.health = Math.min(player.maxHealth, player.health + player.equipped.armor.healthRegen);
                const healed = player.health - oldHealth;
                if (healed > 0) {
                    printMessage(`You regenerate ${healed} health from your ${player.equipped.armor.name}.`, "health heal-animation");
                    updateHealthBar();
                }
            }
        }

        function calculateDamage(attack, defense) {
            // Damage reduction from armor (if equipped)
            let damageReduction = 0;
            if (gameState.player.equipped.armor && gameState.player.equipped.armor.damageReduction) {
                damageReduction = gameState.player.equipped.armor.damageReduction;
            }
            
            const baseDamage = Math.max(1, (attack - defense * 0.5) * (1 - damageReduction));
            const damageVariation = baseDamage * 0.3;
            const finalDamage = baseDamage + (Math.random() * damageVariation * 2) - damageVariation;
            
            // 10% chance to miss (reduced by dodge chance if armor has it)
            let dodgeChance = 0.1;
            if (gameState.player.equipped.armor && gameState.player.equipped.armor.dodgeChance) {
                dodgeChance += gameState.player.equipped.armor.dodgeChance;
            }
            
            if (Math.random() < dodgeChance) {
                return 0;
            }
            
            // 10% chance for critical hit (50% more damage)
            if (Math.random() < 0.1) {
                return Math.floor(finalDamage * 1.5);
            }
            
            return Math.max(0, Math.floor(finalDamage));
        }

        function attemptFlee() {
            if (Math.random() < 0.5) {
                printMessage("You successfully flee from combat!", "success");
                gameState.inCombat = false;
                showMainButtons();
                printMessage("");
                printMessage("What will you do now?");
            } else {
                printMessage("You failed to flee!", "warning");
                
                // Enemy gets a free attack
                enemyAttack();
            }
        }

        function enemyDefeated() {
            const player = gameState.player;
            const enemy = gameState.currentEnemy;
            
            printMessage(`You defeated the ${enemy.name}!`, "success");
            
            // Gain XP and gold
            player.xp += enemy.xp;
            player.gold += enemy.gold;
            gameState.enemiesDefeated++;
            
            // Update kill count for quest tracking
            gameState.enemyKillCounts[enemy.name] = (gameState.enemyKillCounts[enemy.name] || 0) + 1;
            
            printMessage(`You gained ${enemy.xp} XP and found ${enemy.gold} gold.`, "gold");
            
            // Check for loot drop
            if (Math.random() < enemy.lootChance) {
                const loot = generateLoot(enemy);
                player.inventory.push(loot);
                printMessage(`The enemy dropped: ${loot.name}`, getRarityClass(loot.rarity));
                
                if (loot.type === "material") {
                    printMessage("You can sell materials at the shop.", "item");
                }
            }
            
            // Check for achievements
            checkAchievements();
            
            // Check for quest progress
            checkQuestProgress();
            
            // Check for level up
            checkLevelUp();
            
            gameState.inCombat = false;
            showMainButtons();
            printMessage("");
            printMessage("What will you do now?");
        }

        function checkAchievements() {
            const player = gameState.player;
            const enemy = gameState.currentEnemy;
            
            // First Blood
            if (gameState.enemiesDefeated === 1 && !achievements[0].earned) {
                achievements[0].earned = true;
                player.achievements.push(achievements[0]);
                printMessage(`Achievement Unlocked: ${achievements[0].name} - ${achievements[0].description}`, "achievement");
            }
            
            // Dragon Slayer
            if (enemy.name.includes("Dragon") && !achievements[3].earned) {
                achievements[3].earned = true;
                player.achievements.push(achievements[3]);
                printMessage(`Achievement Unlocked: ${achievements[3].name} - ${achievements[3].description}`, "achievement");
            }
            
            // Boss Killer
            if (bosses.some(boss => boss.name === enemy.name) && !achievements[4].earned) {
                achievements[4].earned = true;
                player.achievements.push(achievements[4]);
                printMessage(`Achievement Unlocked: ${achievements[4].name} - ${achievements[4].description}`, "achievement");
            }
            
            // Dungeon Explorer
            if (gameState.currentRoom >= 20 && !achievements[7].earned) {
                achievements[7].earned = true;
                player.achievements.push(achievements[7]);
                printMessage(`Achievement Unlocked: ${achievements[7].name} - ${achievements[7].description}`, "achievement");
            }
            
            // Master Adventurer
            if (gameState.enemiesDefeated >= 50 && !achievements[8].earned) {
                achievements[8].earned = true;
                player.achievements.push(achievements[8]);
                printMessage(`Achievement Unlocked: ${achievements[8].name} - ${achievements[8].description}`, "achievement");
            }
        }

        function generateLoot(enemy) {
            // Higher level enemies drop better loot
            const lootTier = Math.min(Math.floor(enemy.minLevel / 3), 4); // 0-4
            
            // Possible loot categories based on enemy type
            let lootPool = [];
            
            if (enemy.name.includes("Dragon") || enemy.name.includes("Lich") || enemy.name.includes("Demon") || 
                enemy.name.includes("Boss") || enemy.name.includes("King") || enemy.name.includes("Lord")) {
                // Magical enemies drop more magical items
                lootPool = [
                    ...items.weapons.filter(w => w.rarity === "rare" || w.rarity === "epic" || w.rarity === "legendary"),
                    ...items.armor.filter(a => a.rarity === "rare" || a.rarity === "epic" || a.rarity === "legendary"),
                    ...items.rings,
                    ...items.amulets,
                    ...items.scrolls,
                    ...items.materials.filter(m => m.rarity === "rare" || m.rarity === "epic" || m.rarity === "legendary")
                ];
            } else {
                // Normal enemies drop more common items
                lootPool = [
                    ...items.weapons.filter(w => w.rarity === "common" || w.rarity === "uncommon"),
                    ...items.armor.filter(a => a.rarity === "common" || a.rarity === "uncommon"),
                    ...items.potions,
                    ...items.materials.filter(m => m.rarity === "common" || m.rarity === "uncommon")
                ];
            }
            
            // Filter by tier (simplified - higher tier enemies can drop lower tier items)
            const availableLoot = lootPool.filter(item => {
                const itemTier = getItemTier(item);
                return itemTier <= lootTier + 1; // Allow items one tier higher
            });
            
            if (availableLoot.length === 0) {
                // Fallback to a basic health potion if no loot available (shouldn't happen)
                return {...items.potions[0]};
            }
            
            // Weighted random selection - higher rarity items are less likely
            const lootRarityRoll = Math.random();
            let targetRarity;
            
            if (lootRarityRoll < 0.5) {
                targetRarity = "common";
            } else if (lootRarityRoll < 0.8) {
                targetRarity = "uncommon";
            } else if (lootRarityRoll < 0.95) {
                targetRarity = "rare";
            } else if (lootRarityRoll < 0.99) {
                targetRarity = "epic";
            } else {
                targetRarity = "legendary";
            }
            
            // Filter by target rarity
            const rarityLoot = availableLoot.filter(item => item.rarity === targetRarity);
            
            // If no items of target rarity, just pick from available loot
            const finalLootPool = rarityLoot.length > 0 ? rarityLoot : availableLoot;
            
            // Randomly select an item
            const selectedIndex = Math.floor(Math.random() * finalLootPool.length);
            return {...finalLootPool[selectedIndex]};
        }

        function getItemTier(item) {
            // Simple tier system based on item value
            if (item.value < 30) return 0;
            if (item.value < 100) return 1;
            if (item.value < 250) return 2;
            if (item.value < 500) return 3;
            return 4;
        }

        function getRarityClass(rarity) {
            switch(rarity) {
                case "common": return "item";
                case "uncommon": return "item";
                case "rare": return "rare";
                case "epic": return "epic";
                case "legendary": return "legendary";
                default: return "item";
            }
        }

        function playerDefeated() {
            const player = gameState.player;
            
            printMessage("You have been defeated!", "error");
            printMessage("You lose half your gold and are returned to town.", "warning");
            printMessage("Your health and mana have been restored.", "player");
            
            // Reset player but keep items and level
            player.health = player.maxHealth;
            player.mana = player.maxMana;
            player.gold = Math.floor(player.gold * 0.5); // Lose half gold
            
            updateHealthBar();
            updateManaBar();
            
            gameState.inCombat = false;
            gameState.currentRoom = 0;
            showMainButtons();
            printMessage("");
            printMessage("What will you do now?");
        }

        function checkLevelUp() {
            const player = gameState.player;
            
            if (player.xp >= player.xpToNextLevel) {
                player.level++;
                player.xp -= player.xpToNextLevel;
                player.xpToNextLevel = Math.floor(player.xpToNextLevel * 1.5);
                
                // Increase stats
                player.maxHealth += 10;
                player.health = player.maxHealth;
                player.maxMana += 5;
                player.mana = player.maxMana;
                player.attack += 2;
                player.defense += 1;
                
                updateHealthBar();
                updateManaBar();
                
                printMessage(`You leveled up to level ${player.level}!`, "level");
                printMessage("Your stats have increased!", "player");
                printMessage(`Health: +10 (now ${player.maxHealth})`, "health");
                printMessage(`Mana: +5 (now ${player.maxMana})`, "mana");
                printMessage(`Attack: +2 (now ${player.attack})`);
                printMessage(`Defense: +1 (now ${player.defense})`);
                
                // Check for level-based achievements
                if (player.level === 5 && !achievements[1].earned) {
                    achievements[1].earned = true;
                    player.achievements.push(achievements[1]);
                    printMessage(`Achievement Unlocked: ${achievements[1].name} - ${achievements[1].description}`, "achievement");
                }
                
                if (player.level === 10 && !achievements[2].earned) {
                    achievements[2].earned = true;
                    player.achievements.push(achievements[2]);
                    printMessage(`Achievement Unlocked: ${achievements[2].name} - ${achievements[2].description}`, "achievement");
                }
                
                // Check for new abilities or features at certain levels
                if (player.level === 5) {
                    printMessage("You've learned the Special Attack ability!", "success");
                    printMessage("You can now use Special Attacks in combat (Option 4).", "success");
                }
                
                if (player.level === 10) {
                    printMessage("You feel more powerful as you reach level 10!", "legendary");
                    player.maxHealth += 20;
                    player.health += 20;
                    player.maxMana += 10;
                    player.mana += 10;
                    printMessage(`Health: +20 (now ${player.maxHealth})`, "health");
                    printMessage(`Mana: +10 (now ${player.maxMana})`, "mana");
                    updateHealthBar();
                    updateManaBar();
                }
            }
        }

        function showInventory() {
            clearOutput();
            gameState.inShop = false;
            gameState.inInventory = true;
            gameState.shopCategory = null;
            
            const player = gameState.player;
            
            printMessage("=== INVENTORY ===");
            printMessage(`Gold: ${player.gold}`, "gold");
            printMessage("");
            
            // Equipped items
            printMessage("EQUIPPED:");
            printMessage(`Weapon: ${player.equipped.weapon ? player.equipped.weapon.name : "None"}`);
            if (player.equipped.weapon) {
                printMessage(`  Attack: +${player.equipped.weapon.attack}`, getRarityClass(player.equipped.weapon.rarity));
                if (player.equipped.weapon.critChance) printMessage(`  Crit Chance: +${Math.floor(player.equipped.weapon.critChance * 100)}%`, getRarityClass(player.equipped.weapon.rarity));
                if (player.equipped.weapon.frostDamage) printMessage(`  Frost Damage: +${player.equipped.weapon.frostDamage}`, getRarityClass(player.equipped.weapon.rarity));
                if (player.equipped.weapon.lifesteal) printMessage(`  Lifesteal: +${Math.floor(player.equipped.weapon.lifesteal * 100)}%`, getRarityClass(player.equipped.weapon.rarity));
            }
            
            printMessage(`Armor: ${player.equipped.armor ? player.equipped.armor.name : "None"}`);
            if (player.equipped.armor) {
                printMessage(`  Defense: +${player.equipped.armor.defense}`, getRarityClass(player.equipped.armor.rarity));
                if (player.equipped.armor.healthBonus) printMessage(`  Health Bonus: +${player.equipped.armor.healthBonus}`, getRarityClass(player.equipped.armor.rarity));
                if (player.equipped.armor.dodgeChance) printMessage(`  Dodge Chance: +${Math.floor(player.equipped.armor.dodgeChance * 100)}%`, getRarityClass(player.equipped.armor.rarity));
                if (player.equipped.armor.healthRegen) printMessage(`  Health Regen: +${player.equipped.armor.healthRegen}/turn`, getRarityClass(player.equipped.armor.rarity));
            }
            
            printMessage(`Ring: ${player.equipped.ring ? player.equipped.ring.name : "None"}`);
            if (player.equipped.ring) {
                if (player.equipped.ring.attack) printMessage(`  Attack: +${player.equipped.ring.attack}`, getRarityClass(player.equipped.ring.rarity));
                if (player.equipped.ring.defense) printMessage(`  Defense: +${player.equipped.ring.defense}`, getRarityClass(player.equipped.ring.rarity));
                if (player.equipped.ring.healthRegen) printMessage(`  Health Regen: +${player.equipped.ring.healthRegen}/turn`, getRarityClass(player.equipped.ring.rarity));
                if (player.equipped.ring.manaRegen) printMessage(`  Mana Regen: +${player.equipped.ring.manaRegen}/turn`, getRarityClass(player.equipped.ring.rarity));
            }
            
            printMessage(`Amulet: ${player.equipped.amulet ? player.equipped.amulet.name : "None"}`);
            if (player.equipped.amulet) {
                if (player.equipped.amulet.maxHealth) printMessage(`  Max Health: +${player.equipped.amulet.maxHealth}`, getRarityClass(player.equipped.amulet.rarity));
                if (player.equipped.amulet.maxMana) printMessage(`  Max Mana: +${player.equipped.amulet.maxMana}`, getRarityClass(player.equipped.amulet.rarity));
                if (player.equipped.amulet.attack) printMessage(`  Attack: +${player.equipped.amulet.attack}`, getRarityClass(player.equipped.amulet.rarity));
                if (player.equipped.amulet.defense) printMessage(`  Defense: +${player.equipped.amulet.defense}`, getRarityClass(player.equipped.amulet.rarity));
            }
            
            printMessage("");
            
            // Inventory items
            if (player.inventory.length === 0) {
                printMessage("Your inventory is empty.");
            } else {
                printMessage("ITEMS:");
                
                // Clear previous inventory buttons
                inventoryItems.innerHTML = '';
                
                player.inventory.forEach((item, index) => {
                    let itemText = `${item.name}`;
                    if (item.type === "potion") {
                        if (item.health) itemText += ` (Heals ${item.health} HP)`;
                        if (item.mana) itemText += ` (Restores ${item.mana} MP)`;
                    } else if (item.type === "weapon") {
                        itemText += ` (ATK +${item.attack})`;
                    } else if (item.type === "armor") {
                        itemText += ` (DEF +${item.defense})`;
                    } else if (item.type === "scroll") {
                        if (item.damage) itemText += ` (Deals ${item.damage} damage)`;
                        if (item.heal) itemText += ` (Heals ${item.heal} HP)`;
                    } else if (item.type === "material") {
                        itemText += ` (Value: ${item.value} gold)`;
                    }
                    
                    // Create button for each item
                    const btn = document.createElement('button');
                    btn.textContent = itemText;
                    btn.className = getRarityClass(item.rarity);
                    btn.addEventListener('click', () => handleInventorySelection(index));
                    inventoryItems.appendChild(btn);
                });
            }
            
            showInventoryButtons();
            printMessage("");
            printMessage("Select an item to use/equip, or press Back to exit.");
        }

        function useItemInCombat() {
            clearOutput();
            gameState.inInventory = true;
            
            const player = gameState.player;
            
            printMessage("=== USE ITEM ===");
            printMessage("");
            
            if (player.inventory.length === 0) {
                printMessage("Your inventory is empty.", "warning");
                printMessage("");
                printCombatStatus();
                gameState.inInventory = false;
                return;
            }
            
            printMessage("Select an item to use:");
            
            // Clear previous inventory buttons
            inventoryItems.innerHTML = '';
            
            player.inventory.forEach((item, index) => {
                let itemText = `${item.name}`;
                if (item.type === "potion") {
                    if (item.health) itemText += ` (Heals ${item.health} HP)`;
                    if (item.mana) itemText += ` (Restores ${item.mana} MP)`;
                } else if (item.type === "scroll") {
                    if (item.damage) itemText += ` (Deals ${item.damage} damage)`;
                    if (item.heal) itemText += ` (Heals ${item.heal} HP)`;
                }
                
                // Create button for each item
                const btn = document.createElement('button');
                btn.textContent = itemText;
                btn.className = getRarityClass(item.rarity);
                btn.addEventListener('click', () => handleInventorySelection(index));
                inventoryItems.appendChild(btn);
            });
            
            showInventoryButtons();
            printMessage("");
            printMessage("Select an item to use, or press Back to cancel.");
        }

        function handleInventorySelection(index) {
            const player = gameState.player;
            
            if (isNaN(index) || index < 0 || index >= player.inventory.length) {
                if (gameState.inCombat) {
                    showCombatButtons();
                    printMessage("");
                    printCombatStatus();
                } else {
                    showMainButtons();
                    printMessage("");
                    printMessage("What will you do now?");
                }
                return;
            }
            
            const item = player.inventory[index];
            
            // Handle different item types
            switch(item.type) {
                case "weapon":
                case "armor":
                    equipItem(item, index);
                    break;
                case "ring":
                case "amulet":
                    equipAccessory(item, index);
                    break;
                case "potion":
                    usePotion(item, index);
                    break;
                case "scroll":
                    useScroll(item, index);
                    break;
                case "material":
                    printMessage("Materials can only be sold at the shop.", "warning");
                    break;
                default:
                    printMessage("You can't use that item directly.", "warning");
            }
            
            if (gameState.inCombat && (item.type === "potion" || item.type === "scroll")) {
                // After using a consumable in combat, enemy gets a turn
                enemyAttack();
            }
        }

        function equipItem(item, index) {
            const player = gameState.player;
            
            if (item.type === "weapon") {
                // It's a weapon
                if (player.equipped.weapon) {
                    player.inventory.push({...player.equipped.weapon});
                    printMessage(`You unequipped ${player.equipped.weapon.name}.`, getRarityClass(player.equipped.weapon.rarity));
                }
                player.equipped.weapon = {...item};
                player.inventory.splice(index, 1);
                printMessage(`You equipped the ${item.name}.`, getRarityClass(item.rarity));
                printMessage(`Attack increased by +${item.attack}.`);
                
                // Check for legendary achievement
                if (item.rarity === "legendary" && !achievements[5].earned) {
                    achievements[5].earned = true;
                    player.achievements.push(achievements[5]);
                    printMessage(`Achievement Unlocked: ${achievements[5].name} - ${achievements[5].description}`, "achievement");
                }
                
                // Check for equipment quest
                checkEquipmentQuest(item);
            } else if (item.type === "armor") {
                // It's armor
                if (player.equipped.armor) {
                    player.inventory.push({...player.equipped.armor});
                    printMessage(`You unequipped ${player.equipped.armor.name}.`, getRarityClass(player.equipped.armor.rarity));
                }
                player.equipped.armor = {...item};
                player.inventory.splice(index, 1);
                printMessage(`You equipped the ${item.name}.`, getRarityClass(item.rarity));
                printMessage(`Defense increased by +${item.defense}.`);
                
                // Apply any health bonus from armor
                if (item.healthBonus) {
                    player.maxHealth += item.healthBonus;
                    player.health = Math.min(player.health + item.healthBonus, player.maxHealth);
                    printMessage(`Max health increased by +${item.healthBonus}.`, "health");
                    updateHealthBar();
                }
                
                // Check for legendary achievement
                if (item.rarity === "legendary" && !achievements[5].earned) {
                    achievements[5].earned = true;
                    player.achievements.push(achievements[5]);
                    printMessage(`Achievement Unlocked: ${achievements[5].name} - ${achievements[5].description}`, "achievement");
                }
                
                // Check for equipment quest
                checkEquipmentQuest(item);
            }
            
            if (gameState.inCombat) {
                showCombatButtons();
            } else {
                showMainButtons();
                printMessage("");
                printMessage("What will you do now?");
            }
        }

        function equipAccessory(item, index) {
            const player = gameState.player;
            
            if (item.type === "ring") {
                // It's a ring
                if (player.equipped.ring) {
                    player.inventory.push({...player.equipped.ring});
                    printMessage(`You unequipped ${player.equipped.ring.name}.`, getRarityClass(player.equipped.ring.rarity));
                }
                player.equipped.ring = {...item};
                player.inventory.splice(index, 1);
                printMessage(`You equipped the ${item.name}.`, getRarityClass(item.rarity));
                
                // Display stat changes
                if (item.attack) printMessage(`Attack increased by +${item.attack}.`);
                if (item.defense) printMessage(`Defense increased by +${item.defense}.`);
                if (item.healthRegen) printMessage(`You will now regenerate ${item.healthRegen} HP per turn.`, "health");
                if (item.manaRegen) printMessage(`You will now regenerate ${item.manaRegen} MP per turn.`, "mana");
                
                // Check for equipment quest
                checkEquipmentQuest(item);
            } else if (item.type === "amulet") {
                // It's an amulet
                if (player.equipped.amulet) {
                    player.inventory.push({...player.equipped.amulet});
                    printMessage(`You unequipped ${player.equipped.amulet.name}.`, getRarityClass(player.equipped.amulet.rarity));
                }
                player.equipped.amulet = {...item};
                player.inventory.splice(index, 1);
                printMessage(`You equipped the ${item.name}.`, getRarityClass(item.rarity));
                
                // Display stat changes
                if (item.maxHealth) {
                    const oldMaxHealth = player.maxHealth;
                    player.maxHealth += item.maxHealth;
                    player.health += item.maxHealth;
                    printMessage(`Max health increased by +${item.maxHealth} (now ${player.maxHealth}).`, "health");
                    updateHealthBar();
                }
                if (item.maxMana) {
                    player.maxMana += item.maxMana;
                    player.mana += item.maxMana;
                    printMessage(`Max mana increased by +${item.maxMana} (now ${player.maxMana}).`, "mana");
                    updateManaBar();
                }
                if (item.attack) printMessage(`Attack increased by +${item.attack}.`);
                if (item.defense) printMessage(`Defense increased by +${item.defense}.`);
                
                // Check for legendary achievement
                if (item.rarity === "legendary" && !achievements[5].earned) {
                    achievements[5].earned = true;
                    player.achievements.push(achievements[5]);
                    printMessage(`Achievement Unlocked: ${achievements[5].name} - ${achievements[5].description}`, "achievement");
                }
                
                // Check for equipment quest
                checkEquipmentQuest(item);
            }
            
            if (gameState.inCombat) {
                showCombatButtons();
            } else {
                showMainButtons();
                printMessage("");
                printMessage("What will you do now?");
            }
        }

        function usePotion(item, index) {
            const player = gameState.player;
            
            if (item.health) {
                const oldHealth = player.health;
                player.health = Math.min(player.maxHealth, player.health + item.health);
                const healed = player.health - oldHealth;
                printMessage(`You used ${item.name} and restored ${healed} HP.`, "health heal-animation");
                updateHealthBar();
            }
            if (item.mana) {
                const oldMana = player.mana;
                player.mana = Math.min(player.maxMana, player.mana + item.mana);
                const restored = player.mana - oldMana;
                printMessage(`You used ${item.name} and restored ${restored} MP.`, "mana");
                updateManaBar();
            }
            
            // Remove from inventory
            player.inventory.splice(index, 1);
            
            if (!gameState.inCombat) {
                showMainButtons();
                printMessage("");
                printMessage("What will you do now?");
            }
        }

        function useScroll(item, index) {
            const player = gameState.player;
            const enemy = gameState.currentEnemy;
            
            if (gameState.inCombat) {
                if (item.damage) {
                    // Damage scroll
                    if (item.manaCost && player.mana < item.manaCost) {
                        printMessage(`Not enough mana to use ${item.name}! Need ${item.manaCost} MP.`, "warning");
                        return;
                    }
                    
                    if (item.manaCost) {
                        player.mana -= item.manaCost;
                        printMessage(`Used ${item.manaCost} MP to cast ${item.name}.`, "mana");
                        updateManaBar();
                    }
                    
                    const damage = Math.floor(item.damage * (0.8 + Math.random() * 0.4)); // 80-120% of base damage
                    enemy.health -= damage;
                    printMessage(`The ${item.name} hits the ${enemy.name} for ${damage} damage!`, "critical");
                    
                    // Check if enemy is defeated
                    if (enemy.health <= 0) {
                        enemyDefeated();
                        return;
                    }
                } else if (item.heal) {
                    // Healing scroll
                    if (item.manaCost && player.mana < item.manaCost) {
                        printMessage(`Not enough mana to use ${item.name}! Need ${item.manaCost} MP.`, "warning");
                        return;
                    }
                    
                    if (item.manaCost) {
                        player.mana -= item.manaCost;
                        printMessage(`Used ${item.manaCost} MP to cast ${item.name}.`, "mana");
                        updateManaBar();
                    }
                    
                    const oldHealth = player.health;
                    player.health = Math.min(player.maxHealth, player.health + item.heal);
                    const healed = player.health - oldHealth;
                    printMessage(`The ${item.name} healed you for ${healed} HP.`, "health heal-animation");
                    updateHealthBar();
                }
                
                // Remove from inventory
                player.inventory.splice(index, 1);
            } else {
                printMessage("Scrolls can only be used in combat.", "warning");
            }
        }

        function showStats() {
            clearOutput();
            gameState.inShop = false;
            gameState.inInventory = false;
            gameState.shopCategory = null;
            
            const player = gameState.player;
            
            // Calculate total stats including equipment
            const totalAttack = player.attack + 
                              (player.equipped.weapon ? player.equipped.weapon.attack : 0) +
                              (player.equipped.ring ? player.equipped.ring.attack || 0 : 0) +
                              (player.equipped.amulet ? player.equipped.amulet.attack || 0 : 0);
            
            const totalDefense = player.defense + 
                               (player.equipped.armor ? player.equipped.armor.defense : 0) +
                               (player.equipped.ring ? player.equipped.ring.defense || 0 : 0) +
                               (player.equipped.amulet ? player.equipped.amulet.defense || 0 : 0);
            
            printMessage("=== STATS ===");
            printMessage(`Name: ${player.name}`);
            printMessage(`Level: ${player.level}`, "level");
            printMessage(`XP: ${player.xp}/${player.xpToNextLevel}`, "xp");
            printMessage(`Health: ${player.health}/${player.maxHealth}`, "health");
            printMessage(`Mana: ${player.mana}/${player.maxMana}`, "mana");
            printMessage(`Attack: ${totalAttack}`);
            printMessage(`Defense: ${totalDefense}`);
            printMessage(`Gold: ${player.gold}`, "gold");
            printMessage(`Enemies Defeated: ${gameState.enemiesDefeated}`);
            printMessage(`Current Dungeon Level: ${gameState.currentRoom}`);
            printMessage("");
            
            // Equipment summary
            printMessage("EQUIPMENT:");
            printMessage(`Weapon: ${player.equipped.weapon ? player.equipped.weapon.name : "None"}`);
            printMessage(`Armor: ${player.equipped.armor ? player.equipped.armor.name : "None"}`);
            printMessage(`Ring: ${player.equipped.ring ? player.equipped.ring.name : "None"}`);
            printMessage(`Amulet: ${player.equipped.amulet ? player.equipped.amulet.name : "None"}`);
            
            // Achievements
            if (player.achievements.length > 0) {
                printMessage("");
                printMessage("ACHIEVEMENTS:");
                player.achievements.forEach(ach => {
                    printMessage(`${ach.name}: ${ach.description}`, "achievement");
                });
            }
            
            // Check for rich adventurer achievement
            if (player.gold >= 1000 && !achievements[6].earned) {
                achievements[6].earned = true;
                player.achievements.push(achievements[6]);
                printMessage(`Achievement Unlocked: ${achievements[6].name} - ${achievements[6].description}`, "achievement");
            }
            
            showMainButtons();
            printMessage("");
            printMessage("Press any button to continue.");
        }

        function showShop() {
            clearOutput();
            gameState.inShop = true;
            gameState.inInventory = false;
            gameState.shopCategory = null;
            
            const player = gameState.player;
            
            printMessage("=== SHOP ===");
            printMessage(`Gold: ${player.gold}`, "gold");
            printMessage("");
            
            showShopButtons();
        }

        function showShopCategory(category) {
            clearOutput();
            gameState.shopCategory = category;
            
            const player = gameState.player;
            
            printMessage("=== SHOP ===");
            printMessage(`Gold: ${player.gold}`, "gold");
            printMessage("");
            
            // Clear previous shop buttons
            shopItems.innerHTML = '';
            
            if (category === 'sell') {
                // Selling items
                if (player.inventory.length === 0) {
                    printMessage("You have no items to sell.", "warning");
                } else {
                    printMessage("SELL ITEMS:");
                    player.inventory.forEach((item, index) => {
                        const sellPrice = Math.floor(item.value * 0.5);
                        const btn = document.createElement('button');
                        btn.textContent = `${item.name} - ${sellPrice} gold`;
                        btn.className = getRarityClass(item.rarity);
                        btn.addEventListener('click', () => handleShopSelection(index));
                        shopItems.appendChild(btn);
                    });
                }
            } else {
                // Buying items
                let itemsList;
                
                // Determine which items we're looking at
                switch(category) {
                    case 'weapons': 
                        itemsList = items.weapons;
                        printMessage("WEAPONS:");
                        break;
                    case 'armor': 
                        itemsList = items.armor;
                        printMessage("ARMOR:");
                        break;
                    case 'potions': 
                        itemsList = items.potions;
                        printMessage("POTIONS:");
                        break;
                    case 'accessories':
                        // For accessories, combine rings and amulets
                        itemsList = items.rings.concat(items.amulets);
                        printMessage("ACCESSORIES:");
                        break;
                    default: 
                        showShop(); 
                        return;
                }
                
                itemsList.forEach((item, index) => {
                    const equipped = 
                        (item.type === "weapon" && player.equipped.weapon && player.equipped.weapon.id === item.id) ||
                        (item.type === "armor" && player.equipped.armor && player.equipped.armor.id === item.id) ||
                        (item.type === "ring" && player.equipped.ring && player.equipped.ring.id === item.id) ||
                        (item.type === "amulet" && player.equipped.amulet && player.equipped.amulet.id === item.id);
                    
                    const inInventory = player.inventory.some(invItem => invItem.id === item.id);
                    
                    let status = "";
                    if (equipped) status = " (EQUIPPED)";
                    else if (inInventory) status = " (IN INVENTORY)";
                    
                    let itemText = `${item.name} - ${item.value} gold${status}`;
                    
                    if (item.type === "weapon") {
                        itemText = `${item.name} (ATK +${item.attack}) - ${item.value} gold${status}`;
                        if (item.critChance) itemText += ` [Crit: +${Math.floor(item.critChance * 100)}%]`;
                        if (item.frostDamage) itemText += ` [Frost: +${item.frostDamage}]`;
                        if (item.lifesteal) itemText += ` [Lifesteal: +${Math.floor(item.lifesteal * 100)}%]`;
                    } else if (item.type === "armor") {
                        itemText = `${item.name} (DEF +${item.defense}) - ${item.value} gold${status}`;
                        if (item.healthBonus) itemText += ` [HP +${item.healthBonus}]`;
                        if (item.dodgeChance) itemText += ` [Dodge: +${Math.floor(item.dodgeChance * 100)}%]`;
                        if (item.healthRegen) itemText += ` [Regen: +${item.healthRegen}/turn]`;
                    } else if (item.type === "potion") {
                        if (item.health) itemText += ` (Heals ${item.health} HP)`;
                        if (item.mana) itemText += ` (Restores ${item.mana} MP)`;
                    }
                    
                    const btn = document.createElement('button');
                    btn.textContent = itemText;
                    btn.className = getRarityClass(item.rarity);
                    btn.addEventListener('click', () => handleShopSelection(index));
                    shopItems.appendChild(btn);
                });
            }
            
            showShopCategoryButtons();
            printMessage("");
            printMessage("Select an item to buy/sell, or press Back to cancel.");
        }

        function handleShopSelection(index) {
            const player = gameState.player;
            
            if (gameState.shopCategory === 'sell') {
                // Selling items
                if (isNaN(index) || index < 0 || index >= player.inventory.length) {
                    showShop();
                    return;
                }
                
                const item = player.inventory[index];
                const sellPrice = Math.floor(item.value * 0.5);
                
                player.gold += sellPrice;
                player.inventory.splice(index, 1);
                
                printMessage(`You sold ${item.name} for ${sellPrice} gold.`, "gold");
                printMessage("");
                showShop();
            } else {
                // Buying items
                let itemsList;
                
                // Determine which items we're looking at
                switch(gameState.shopCategory) {
                    case 'weapons': 
                        itemsList = items.weapons;
                        break;
                    case 'armor': 
                        itemsList = items.armor;
                        break;
                    case 'potions': 
                        itemsList = items.potions;
                        break;
                    case 'accessories':
                        // For accessories, combine rings and amulets
                        itemsList = items.rings.concat(items.amulets);
                        break;
                    default: 
                        showShop(); 
                        return;
                }
                
                // Validate selection
                if (isNaN(index) || index < 0 || index >= itemsList.length) {
                    showShop();
                    return;
                }
                
                const item = itemsList[index];
                
                // Check if already have this item (not equipped)
                const alreadyHas = player.inventory.some(invItem => invItem.id === item.id);
                if (alreadyHas) {
                    printMessage(`You already have ${item.name} in your inventory!`, "warning");
                    printMessage("");
                    showShop();
                    return;
                }
                
                // Check if player has enough gold
                if (player.gold < item.value) {
                    printMessage("You don't have enough gold for that!", "warning");
                    printMessage("");
                    showShop();
                    return;
                }
                
                // Purchase item
                player.gold -= item.value;
                player.inventory.push({...item});
                
                printMessage(`You bought ${item.name} for ${item.value} gold.`, "gold");
                printMessage(`Added to inventory.`, "success");
                
                if (item.type === "weapon" || item.type === "armor" || item.type === "ring" || item.type === "amulet") {
                    printMessage(`Equip it from your inventory.`, "success");
                }
                
                printMessage("");
                showShop();
            }
        }

        // New Functions for Map, Save/Load, and Quests

        function showMap() {
            clearOutput();
            printMessage("=== DUNGEON MAP ===");
            
            const map = generateDungeonMap();
            outputEl.appendChild(map);
            
            printMessage("");
            printMessage(`Current Floor: ${Math.floor(gameState.currentRoom / 10) + 1}`);
            printMessage(`Room: ${gameState.currentRoom}`);
            printMessage("");
            printMessage(" - Your position");
            printMessage(" - Enemy encounter");
            printMessage(" - Boss encounter");
            printMessage("$ - Shop");
            printMessage(" - Cleared room");
            printMessage("? - Unknown");
            
            showMainButtons();
            printMessage("");
            printMessage("What will you do next?");
        }

        function generateDungeonMap() {
            const mapContainer = document.createElement('div');
            mapContainer.className = 'dungeon-map';
            
            for (let i = 0; i < 25; i++) {
                const room = document.createElement('div');
                room.className = 'room';
                
                if (i === gameState.currentRoom) {
                    room.className += ' current-room';
                    room.textContent = ''; // Player icon
                } else if (i % 10 === 9 && i > 0) {
                    room.className += ' boss-room';
                    room.textContent = ''; // Boss icon
                } else if (i % 5 === 2) {
                    room.className += ' shop-room';
                    room.textContent = '$'; // Shop icon
                } else if (i < gameState.currentRoom) {
                    room.className += ' empty-room';
                    room.textContent = ''; // Completed room
                } else if (i > gameState.currentRoom) {
                    room.className += ' enemy-room';
                    room.textContent = ''; // Enemy icon
                } else {
                    room.className += ' empty-room';
                    room.textContent = '?'; // Undiscovered
                }
                
                mapContainer.appendChild(room);
            }
            
            return mapContainer;
        }

        function showCombatSprites() {
            const spriteContainer = document.createElement('div');
            spriteContainer.style.display = 'flex';
            spriteContainer.style.justifyContent = 'space-between';
            spriteContainer.style.margin = '10px 0';
            
            const playerSprite = document.createElement('div');
            playerSprite.className = 'character-sprite';
            playerSprite.textContent = ''; // Player sprite
            playerSprite.style.color = '#0af';
            
            const vsText = document.createElement('div');
            vsText.textContent = 'VS';
            vsText.style.margin = '0 20px';
            vsText.style.alignSelf = 'center';
            
            const enemySprite = document.createElement('div');
            enemySprite.className = 'character-sprite';
            
            // Different sprites for different enemy types
            if (gameState.currentEnemy.name.includes('Dragon')) {
                enemySprite.textContent = '';
            } else if (gameState.currentEnemy.name.includes('Goblin')) {
                enemySprite.textContent = '';
            } else if (gameState.currentEnemy.name.includes('Skeleton')) {
                enemySprite.textContent = '';
            } else if (gameState.currentEnemy.name.includes('Orc')) {
                enemySprite.textContent = '';
            } else {
                enemySprite.textContent = '';
            }
            
            enemySprite.style.color = '#f00';
            
            spriteContainer.appendChild(playerSprite);
            spriteContainer.appendChild(vsText);
            spriteContainer.appendChild(enemySprite);
            
            outputEl.appendChild(spriteContainer);
        }

        function saveGame() {
            try {
                localStorage.setItem('sanctuaryRPG_save', JSON.stringify(gameState));
                printMessage("Game saved successfully!", "save-notification");
                setTimeout(() => {
                    if (outputEl.lastChild.className === "save-notification") {
                        outputEl.removeChild(outputEl.lastChild);
                    }
                }, 2000);
            } catch (e) {
                printMessage("Failed to save game: " + e, "error");
            }
        }

        function loadGame() {
            try {
                const saveData = localStorage.getItem('sanctuaryRPG_save');
                if (saveData) {
                    const loadedState = JSON.parse(saveData);
                    Object.assign(gameState, loadedState);
                    
                    updateHealthBar();
                    updateManaBar();
                    
                    printMessage("Game loaded successfully!", "success");
                    printMessage("");
                    printMessage("What will you do now?");
                } else {
                    printMessage("No saved game found.", "warning");
                }
            } catch (e) {
                printMessage("Failed to load game: " + e, "error");
            }
        }

        function showQuests() {
            clearOutput();
            printMessage("=== QUESTS ===");
            printMessage("");
            
            if (gameState.quests.length === 0) {
                printMessage("No active quests. Check back later!");
            } else {
                let hasActiveQuests = false;
                
                gameState.quests.forEach(quest => {
                    if (!quest.completed) {
                        hasActiveQuests = true;
                        printMessage(`${quest.name}: ${quest.description}`, "quest");
                        
                        // Show progress for relevant quest types
                        if (quest.type === "kill") {
                            const currentCount = gameState.enemyKillCounts[quest.target] || 0;
                            printMessage(`Progress: ${currentCount}/${quest.count} ${quest.target}s defeated`, "quest");
                        } else if (quest.type === "collect") {
                            if (quest.target === "gold") {
                                printMessage(`Progress: ${gameState.player.gold}/${quest.count} gold collected`, "quest");
                            }
                        } else if (quest.type === "progress") {
                            if (quest.target === "room") {
                                printMessage(`Progress: Room ${gameState.currentRoom}/${quest.count}`, "quest");
                            }
                        }
                        printMessage("");
                    }
                });
                
                // Show completed quests
                const completedQuests = gameState.quests.filter(quest => quest.completed);
                if (completedQuests.length > 0) {
                    printMessage("=== COMPLETED QUESTS ===");
                    completedQuests.forEach(quest => {
                        printMessage(`${quest.name}: ${quest.description}`, "quest-completed");
                    });
                }
                
                if (!hasActiveQuests && completedQuests.length > 0) {
                    printMessage("All quests completed! More may be added in future updates.");
                }
            }
            
            showMainButtons();
            printMessage("");
            printMessage("Press any button to continue.");
        }

        function checkQuestProgress() {
            const player = gameState.player;
            let questsUpdated = false;
            
            gameState.quests.forEach(quest => {
                if (!quest.completed) {
                    let completed = false;
                    
                    switch(quest.type) {
                        case "kill":
                            if ((gameState.enemyKillCounts[quest.target] || 0) >= quest.count) {
                                completed = true;
                            }
                            break;
                        case "collect":
                            if (quest.target === "gold" && player.gold >= quest.count) {
                                completed = true;
                            }
                            break;
                        case "progress":
                            if (quest.target === "room" && gameState.currentRoom >= quest.count) {
                                completed = true;
                            }
                            break;
                        case "equip":
                            // This is handled in the equip functions
                            break;
                    }
                    
                    if (completed) {
                        quest.completed = true;
                        questsUpdated = true;
                        
                        // Grant rewards
                        if (quest.reward.gold) {
                            player.gold += quest.reward.gold;
                            printMessage(`Quest Complete! Received ${quest.reward.gold} gold.`, "gold");
                        }
                        if (quest.reward.xp) {
                            player.xp += quest.reward.xp;
                            printMessage(`Received ${quest.reward.xp} XP.`, "xp");
                        }
                        if (quest.reward.item) {
                            player.inventory.push({...quest.reward.item});
                            printMessage(`Received ${quest.reward.item.name}!`, getRarityClass(quest.reward.item.rarity));
                        }
                        
                        printMessage(`Quest Complete: ${quest.name}`, "success");
                        printMessage("");
                        
                        // Check for level up after XP reward
                        checkLevelUp();
                    }
                }
            });
            
            return questsUpdated;
        }

        function checkEquipmentQuest(item) {
            gameState.quests.forEach(quest => {
                if (!quest.completed && quest.type === "equip") {
                    if (quest.target === "rare" && item.rarity === "rare") {
                        quest.completed = true;
                        
                        // Grant rewards
                        if (quest.reward.gold) {
                            gameState.player.gold += quest.reward.gold;
                            printMessage(`Quest Complete! Received ${quest.reward.gold} gold.`, "gold");
                        }
                        if (quest.reward.xp) {
                            gameState.player.xp += quest.reward.xp;
                            printMessage(`Received ${quest.reward.xp} XP.`, "xp");
                        }
                        
                        printMessage(`Quest Complete: ${quest.name}`, "success");
                        printMessage("");
                        
                        // Check for level up after XP reward
                        checkLevelUp();
                    }
                }
            });
        }
    </script>
</body>
</html>
