<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Island of Lost Souls - Level 3: Mountains of Moor</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #0a0;
            background-color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
            position: relative;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #0a0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #0f0;
            font-size: 28px;
            margin: 10px 0;
            text-transform: uppercase;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #0a0;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            font-size: 18px;
        }
        
        .screen {
            display: none;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #0a0;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #050;
            color: #0f0;
            border-color: #0f0;
        }
        
        .level-number.current {
            background-color: #0a0;
            color: #fff;
            border-color: #0f0;
            box-shadow: 0 0 8px #0f0;
        }
        
        .stats-bar {
            background-color: #111;
            border: 1px solid #0a0;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #0f0;
            font-weight: bold;
            font-size: 16px;
        }
        
        .inventory-container {
            background-color: #111;
            border: 1px solid #0a0;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #0f0;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #0a0;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #0f0;
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #0f0;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .story-text {
            background-color: #000;
            border: 1px solid #0a0;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #0a0;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .choice-btn:hover {
            background-color: #333;
            color: #0f0;
            border-color: #0f0;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #0a0;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background-color: #333;
            color: #0f0;
            border-color: #0f0;
        }
        
        .dice-roll {
            background-color: #111;
            border: 1px solid #0a0;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #0f0;
            font-weight: bold;
        }
        
        .combat-log {
            background-color: #222;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
            color: #0f0;
        }
        
        .game-over {
            color: #f00;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
        }
        
        .success {
            color: #0f0;
            font-weight: bold;
        }
        
        .damage {
            color: #f00;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9900;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #0ff;
            font-weight: bold;
        }
        
        .cursed {
            color: #a0f;
            font-weight: bold;
        }
        
        .magic {
            color: #0cf;
            font-weight: bold;
        }
        
        .undead {
            color: #8b8;
            font-weight: bold;
        }
        
        .beast {
            color: #b85;
            font-weight: bold;
        }
        
        .mountain {
            color: #ccc;
            font-weight: bold;
        }
        
        .cold {
            color: #aaf;
            font-weight: bold;
        }
        
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #0a0;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }
        
        .next-level-btn:hover {
            background-color: #0a0;
            color: #fff;
            border-color: #0f0;
        }
        
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
        }
        
        .top-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        
        .top-control-btn {
            background: #111;
            border: 1px solid #0a0;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .top-control-btn:hover {
            background: #222;
            color: #0f0;
        }
        
        .new-game-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #a00;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .new-game-btn:hover {
            background-color: #500;
            color: #f00;
            border-color: #f00;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-controls">
            <div class="top-control-btn" onclick="toggleSound()">
                SOUND: <span id="sound-status">ON</span>
            </div>
            <div class="top-control-btn" onclick="newGame()">
                NEW GAME
            </div>
        </div>
        
        <div class="header">
            <h1>ISLAND OF LOST SOULS</h1>
            <h2>LEVEL 3: MOUNTAINS OF MOOR</h2>
        </div>
        
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number completed">2</div>
            <div class="level-number current">3</div>
            <div class="level-number">4</div>
            <div class="level-number">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">MAGIC:</span> <span id="stat-magic" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
                <div class="stat-item" id="dark-power-stat" style="display: none;"><span class="stat-label">DARK POWER:</span> <span id="stat-darkpower" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/12</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory will be added here -->
                </div>
            </div>
            
            <h2>MOUNTAINS OF MOOR</h2>
            <div class="story-text" id="story-text">
                <!-- Story will be added here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be added here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useClassAbility()">CLASS ABILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
                <button class="new-game-btn" onclick="newGame()">NEW GAME</button>
            </div>
        </div>
        
        <div id="screen-next" class="screen">
            <h2>LEVEL 3 COMPLETE!</h2>
            <div class="story-text">
                <p>You have survived the treacherous Mountains of Moor!</p>
                <p>As you descend from the icy peaks, you see the dark entrance to the Caves of Chaos ahead.</p>
                <p>All your stats, gold, and inventory will carry over to Level 4: Caves of Chaos.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">MAGIC:</span> <span id="next-stat-magic" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #111; border: 1px solid #0a0;">
                    <h3 style="color: #0f0; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO LEVEL 4: CAVES OF CHAOS</button>
            </div>
        </div>
        
        <div class="footer">
            ISLAND OF LOST SOULS - Level 3: Mountains of Moor
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            magic: 0,
            darkPower: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Fists',
            equippedArmor: 'Tattered Clothes',
            currentSection: 1,
            level: 3,
            mountainsCleared: false
        };
        
        // Combat State
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1
        };
        
        // Sound
        let soundEnabled = true;
        
        function playSound(type) {
            if (!soundEnabled) return;
            // Simple beep for now
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            let frequency = 800;
            let duration = 0.1;
            
            switch(type) {
                case 'click': frequency = 800; break;
                case 'success': frequency = 1000; break;
                case 'failure': frequency = 400; break;
                case 'damage': frequency = 200; break;
                case 'combat': frequency = 1200; break;
                case 'item': frequency = 600; break;
            }
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'square';
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            playSound('click');
        }
        
        // Story Sections for Level 3: Mountains of Moor
        const storySections = {
            1: {
                text: "You stand at the base of the <span class='mountain'>Mountains of Moor</span>. Jagged peaks pierce the sky, and icy winds bite at your skin. A narrow path winds upward into the mist.",
                choices: [
                    {text: "Take the winding mountain path", nextSection: 2, skillCheck: false},
                    {text: "Climb the rocky cliff face", nextSection: 3, skillCheck: true, checkType: 'agility', difficulty: 13},
                    {text: "Search for a cave entrance", nextSection: 4, skillCheck: false}
                ]
            },
            2: {
                text: "The winding path is treacherous but manageable. The air grows thinner and colder as you ascend.",
                choices: [
                    {text: "Continue up the path", nextSection: 5, skillCheck: false},
                    {text: "Rest at an overlook", nextSection: 6, skillCheck: false}
                ]
            },
            3: {
                text: "You attempt to scale the cliff face. The rocks are slick with ice.",
                choices: [
                    {text: "Continue climbing", nextSection: 7, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "Your agility serves you well! You find a shortcut up the mountain.";
                    } else {
                        playSound('failure');
                        const damage = rollDice(1, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "You slip and fall! You take <span class='damage'>" + damage + " damage</span>.";
                    }
                }
            },
            4: {
                text: "You search along the mountain base and find a dark cave entrance partially hidden by rocks.",
                choices: [
                    {text: "Enter the cave", nextSection: 8, skillCheck: false},
                    {text: "Take the path instead", nextSection: 2, skillCheck: false}
                ]
            },
            5: {
                text: "The path becomes steeper. You notice strange carvings on nearby rocks.",
                choices: [
                    {text: "Examine the carvings", nextSection: 9, skillCheck: true, checkType: 'magic', difficulty: 12},
                    {text: "Continue upward", nextSection: 10, skillCheck: false}
                ]
            },
            6: {
                text: "You find a relatively flat area to rest. The view is breathtaking but the cold is intense.",
                choices: [
                    {text: "Continue upward", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 6) + 2;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    playSound('success');
                    return "The brief rest helps. You recover " + actualHeal + " Health.";
                }
            },
            7: {
                text: "You continue your climb up the cliff face.",
                choices: [
                    {text: "Reach for a handhold", nextSection: 11, skillCheck: false}
                ]
            },
            8: {
                text: "The cave is dark and smells of damp earth. Strange glowing moss provides faint illumination.",
                choices: [
                    {text: "Explore deeper", nextSection: 12, skillCheck: false},
                    {text: "Exit and take the path", nextSection: 2, skillCheck: false}
                ]
            },
            9: {
                text: "",
                choices: [
                    {text: "Continue upward", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        addToInventory('Mountain Rune Knowledge');
                        return "You recognize these as ancient mountain runes. You gain <span class='item'>Mountain Rune Knowledge</span>.";
                    } else {
                        playSound('failure');
                        return "The carvings are weathered and unreadable.";
                    }
                }
            },
            10: {
                text: "A fierce <span class='cold'>ice wind</span> blows down the mountain, chilling you to the bone.",
                choices: [
                    {text: "Push through the wind", nextSection: 13, skillCheck: true, checkType: 'strength', difficulty: 12},
                    {text: "Find shelter", nextSection: 14, skillCheck: false}
                ]
            },
            11: {
                text: "You reach the top of the cliff and find yourself on a narrow ledge overlooking a deep chasm.",
                choices: [
                    {text: "Cross the chasm", nextSection: 15, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Look for another way", nextSection: 16, skillCheck: false}
                ]
            },
            12: {
                text: "The cave twists and turns. You hear dripping water echoing through the tunnels.",
                choices: [
                    {text: "Follow the sound of water", nextSection: 17, skillCheck: false},
                    {text: "Take a dark side passage", nextSection: 18, skillCheck: false}
                ]
            },
            13: {
                text: "",
                choices: [
                    {text: "Continue upward", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You push through the freezing wind, moving steadily upward.";
                    } else {
                        playSound('failure');
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "The icy wind overwhelms you! You take <span class='damage'>" + damage + " cold damage</span>.";
                    }
                }
            },
            14: {
                text: "You find a small alcove in the rock that provides shelter from the wind.",
                choices: [
                    {text: "Rest here for a while", nextSection: 20, skillCheck: false},
                    {text: "Continue upward", nextSection: 19, skillCheck: false}
                ]
            },
            15: {
                text: "",
                choices: [
                    {text: "Continue your journey", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You skillfully cross the chasm using a fallen tree as a bridge.";
                    } else {
                        playSound('failure');
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "You slip and fall into the chasm! You barely catch yourself, taking <span class='damage'>" + damage + " damage</span>.";
                    }
                }
            },
            16: {
                text: "You search for another route around the chasm.",
                choices: [
                    {text: "Find a longer path", nextSection: 22, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "You find a longer but safer path around the chasm.";
                }
            },
            17: {
                text: "The tunnel opens into a large cavern with an underground stream. Crystals in the walls glow with soft light.",
                choices: [
                    {text: "Collect some crystals", nextSection: 23, skillCheck: false},
                    {text: "Follow the stream", nextSection: 24, skillCheck: false}
                ]
            },
            18: {
                text: "The side passage is pitch black. You feel along the wall as you move forward.",
                choices: [
                    {text: "Continue forward", nextSection: 25, skillCheck: false},
                    {text: "Turn back", nextSection: 12, skillCheck: false}
                ]
            },
            19: {
                text: "The path becomes even steeper. You hear a rumbling sound from above.",
                choices: [
                    {text: "Take cover", nextSection: 26, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Run forward", nextSection: 27, skillCheck: false}
                ]
            },
            20: {
                text: "The sheltered alcove provides respite from the wind.",
                choices: [
                    {text: "Continue upward", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(2, 4) + 4;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    playSound('success');
                    return "The shelter allows you to recover. You heal " + actualHeal + " Health.";
                }
            },
            21: {
                text: "Beyond the chasm, you find yourself on a high mountain plateau. The air is painfully thin here.",
                choices: [
                    {text: "Continue across the plateau", nextSection: 28, skillCheck: false}
                ]
            },
            22: {
                text: "The longer path winds through a field of large boulders.",
                choices: [
                    {text: "Navigate through the boulders", nextSection: 29, skillCheck: false}
                ]
            },
            23: {
                text: "You carefully collect some of the glowing crystals.",
                choices: [
                    {text: "Follow the stream", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Glowing Mountain Crystals');
                    playSound('item');
                    return "You collect <span class='item'>Glowing Mountain Crystals</span>.";
                }
            },
            24: {
                text: "Following the stream, you eventually see daylight ahead. The cave exits high on the mountain!",
                choices: [
                    {text: "Exit the cave", nextSection: 30, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The cave was a shortcut! You're now high on the mountain.";
                }
            },
            25: {
                text: "Your hands brush against something metallic in the dark.",
                choices: [
                    {text: "Grab it", nextSection: 31, skillCheck: false},
                    {text: "Be cautious", nextSection: 32, skillCheck: false}
                ]
            },
            26: {
                text: "",
                choices: [
                    {text: "Continue upward", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You dive behind a large rock just as an avalanche thunders past!";
                    } else {
                        playSound('failure');
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "You're caught in the avalanche! You take <span class='damage'>" + damage + " damage</span>.";
                    }
                }
            },
            27: {
                text: "You try to outrun the avalanche!",
                choices: [
                    {text: "See if you made it", nextSection: 34, skillCheck: false}
                ]
            },
            28: {
                text: "Crossing the plateau, you spot a mountain goat with enormous curved horns watching you.",
                choices: [
                    {text: "Approach cautiously", nextSection: 35, skillCheck: false},
                    {text: "Give it wide berth", nextSection: 36, skillCheck: false}
                ]
            },
            29: {
                text: "Moving through the boulder field, you notice movement among the rocks.",
                choices: [
                    {text: "Investigate", nextSection: 37, skillCheck: false},
                    {text: "Hide and observe", nextSection: 38, skillCheck: true, checkType: 'agility', difficulty: 13}
                ]
            },
            30: {
                text: "You emerge from the cave onto a narrow mountain ledge. The view is spectacular but terrifying.",
                choices: [
                    {text: "Continue along the ledge", nextSection: 39, skillCheck: false}
                ]
            },
            31: {
                text: "You grab the metallic object. It's a sword! But something doesn't feel right...",
                choices: [
                    {text: "Take the sword", nextSection: 40, skillCheck: false},
                    {text: "Leave it", nextSection: 41, skillCheck: false}
                ]
            },
            32: {
                text: "You approach cautiously. The metallic object is a sword embedded in rock.",
                choices: [
                    {text: "Try to pull it free", nextSection: 42, skillCheck: true, checkType: 'strength', difficulty: 16},
                    {text: "Leave it", nextSection: 41, skillCheck: false}
                ]
            },
            33: {
                text: "After the avalanche passes, the path ahead is clearer but littered with debris.",
                choices: [
                    {text: "Continue upward", nextSection: 43, skillCheck: false}
                ]
            },
            34: {
                text: "",
                choices: [
                    {text: "Continue upward", nextSection: 43, skillCheck: false}
                ],
                action: function() {
                    const survivalChance = Math.random();
                    if (survivalChance > 0.5) {
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('failure');
                        return "You're partially buried but manage to dig yourself out. You take <span class='damage'>" + damage + " damage</span>.";
                    } else {
                        playSound('success');
                        return "You somehow outrun the avalanche! Incredible luck!";
                    }
                }
            },
            35: {
                text: "As you approach, the mountain goat lowers its head and charges!",
                choices: [
                    {text: "Fight the goat", nextSection: 44, skillCheck: false},
                    {text: "Try to dodge", nextSection: 45, skillCheck: true, checkType: 'agility', difficulty: 14}
                ]
            },
            36: {
                text: "You give the goat a wide berth. It watches you but doesn't attack.",
                choices: [
                    {text: "Continue across the plateau", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "Wise choice. The goat could have been dangerous.";
                }
            },
            37: {
                text: "You investigate the movement and find a group of <span class='beast'>ROCK GRYPHONS</span> nesting among the boulders!",
                choices: [
                    {text: "Fight them", nextSection: 47, skillCheck: false},
                    {text: "Sneak past", nextSection: 48, skillCheck: true, checkType: 'agility', difficulty: 15}
                ]
            },
            38: {
                text: "",
                choices: [
                    {text: "Continue through the boulders", nextSection: 49, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully sneak past the rock gryphons without being noticed.";
                    } else {
                        playSound('failure');
                        return "You're spotted! The gryphons attack!";
                    }
                }
            },
            39: {
                text: "The narrow ledge winds around the mountain. A <span class='cold'>bitter wind</span> threatens to blow you off.",
                choices: [
                    {text: "Continue carefully", nextSection: 50, skillCheck: true, checkType: 'agility', difficulty: 13},
                    {text: "Look for another route", nextSection: 51, skillCheck: false}
                ]
            },
            40: {
                text: "As you take the sword, a dark energy courses through you!",
                choices: [
                    {text: "Continue", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Cursed Mountain Blade');
                    gameState.strength += 3;
                    gameState.maxHealth -= 5;
                    gameState.health = Math.min(gameState.health, gameState.maxHealth);
                    updateStatsDisplay();
                    playSound('cursed');
                    return "You feel the sword's dark power! <span class='cursed'>Strength +3, Maximum Health -5</span>. You gain the <span class='cursed'>Cursed Mountain Blade</span>.";
                }
            },
            41: {
                text: "You leave the sword where it is. Something about it feels wrong.",
                choices: [
                    {text: "Continue down the passage", nextSection: 53, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "Probably a wise decision. The sword radiated dark energy.";
                }
            },
            42: {
                text: "",
                choices: [
                    {text: "Continue down the passage", nextSection: 53, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.strength += 2;
                        addToInventory('Mountain-forged Sword');
                        updateStatsDisplay();
                        return "You pull the sword free! It's perfectly balanced. <span class='success'>Strength +2</span>. You gain a <span class='item'>Mountain-forged Sword</span>.";
                    } else {
                        playSound('failure');
                        return "The sword won't budge. It's stuck fast in the rock.";
                    }
                }
            },
            43: {
                text: "You're nearing the summit now. The air is so thin it's hard to breathe.",
                choices: [
                    {text: "Push for the summit", nextSection: 54, skillCheck: true, checkType: 'strength', difficulty: 14},
                    {text: "Rest before the final push", nextSection: 55, skillCheck: false}
                ]
            },
            44: {
                text: "The mountain goat charges with incredible speed!",
                choices: [
                    {text: "Fight!", nextSection: 56, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Mountain Goat";
                    combatState.enemyHealth = 25;
                    combatState.enemyCurrentHealth = 25;
                    combatState.enemyStrength = 12;
                    combatState.nextSection = 57;
                    playSound('combat');
                    return "<span class='beast'>Mountain Goat</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            45: {
                text: "",
                choices: [
                    {text: "Continue across the plateau", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You dodge the charging goat! It misses you and runs off.";
                    } else {
                        playSound('failure');
                        const damage = rollDice(1, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "The goat catches you! You take <span class='damage'>" + damage + " damage</span>.";
                    }
                }
            },
            46: {
                text: "You reach the far side of the plateau. The descent begins here.",
                choices: [
                    {text: "Begin descending", nextSection: 58, skillCheck: false}
                ]
            },
            47: {
                text: "The rock gryphons shriek and attack!",
                choices: [
                    {text: "Fight!", nextSection: 59, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Rock Gryphons";
                    combatState.enemyHealth = 40;
                    combatState.enemyCurrentHealth = 40;
                    combatState.enemyStrength = 11;
                    combatState.enemyDamageDice = 2;
                    combatState.nextSection = 60;
                    playSound('combat');
                    return "<span class='beast'>Rock Gryphons</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            48: {
                text: "",
                choices: [
                    {text: "Continue through the boulders", nextSection: 49, skillCheck: false}
                ]
            },
            49: {
                text: "You make it through the boulder field without incident.",
                choices: [
                    {text: "Continue upward", nextSection: 61, skillCheck: false}
                ]
            },
            50: {
                text: "",
                choices: [
                    {text: "Continue along the ledge", nextSection: 62, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You navigate the treacherous ledge with care.";
                    } else {
                        playSound('failure');
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "You slip on the icy ledge! You take <span class='damage'>" + damage + " damage</span>.";
                    }
                }
            },
            51: {
                text: "Looking for another route, you find a hidden path behind a waterfall of ice.",
                choices: [
                    {text: "Take the hidden path", nextSection: 63, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The hidden path is safer than the ledge!";
                }
            },
            52: {
                text: "The cursed sword hums with dark energy in your hand.",
                choices: [
                    {text: "Continue down the passage", nextSection: 53, skillCheck: false}
                ]
            },
            53: {
                text: "The passage eventually leads to daylight. You emerge onto the mountainside.",
                choices: [
                    {text: "Continue upward", nextSection: 64, skillCheck: false}
                ]
            },
            54: {
                text: "",
                choices: [
                    {text: "Reach the summit", nextSection: 65, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You push through the thin air and reach the summit!";
                    } else {
                        playSound('failure');
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "The thin air overwhelms you. You take <span class='damage'>" + damage + " damage</span>.";
                    }
                }
            },
            55: {
                text: "You find a sheltered spot to catch your breath.",
                choices: [
                    {text: "Push for the summit", nextSection: 65, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 8) + 3;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    playSound('success');
                    return "The rest helps you acclimate. You recover " + actualHeal + " Health.";
                }
            },
            56: {
                text: "", // Combat round
                choices: [
                    {text: "Continue fighting!", nextSection: 66, skillCheck: false}
                ]
            },
            57: {
                text: "After defeating the goat, you examine its body.",
                choices: [
                    {text: "Take what you can", nextSection: 67, skillCheck: false},
                    {text: "Continue descending", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(1, 10);
                    gameState.gold += goldFound;
                    addToInventory('Goat Horn');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Goat Horn</span>.";
                }
            },
            58: {
                text: "The descent is steep but manageable. You're finally going down the other side of the mountains.",
                choices: [
                    {text: "Continue descending", nextSection: 68, skillCheck: false}
                ]
            },
            59: {
                text: "", // Combat round
                choices: [
                    {text: "Continue fighting!", nextSection: 69, skillCheck: false}
                ]
            },
            60: {
                text: "After defeating the gryphons, you search their nest.",
                choices: [
                    {text: "Take what you find", nextSection: 70, skillCheck: false},
                    {text: "Continue upward", nextSection: 61, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(2, 20);
                    gameState.gold += goldFound;
                    addToInventory('Gryphon Feather');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Gryphon Feather</span>.";
                }
            },
            61: {
                text: "You continue your ascent. The summit is visible now.",
                choices: [
                    {text: "Push for the summit", nextSection: 65, skillCheck: false}
                ]
            },
            62: {
                text: "The ledge eventually widens into a path again.",
                choices: [
                    {text: "Continue upward", nextSection: 71, skillCheck: false}
                ]
            },
            63: {
                text: "The hidden path leads through a tunnel of ice. It's beautiful but freezing.",
                choices: [
                    {text: "Continue through the ice tunnel", nextSection: 72, skillCheck: false}
                ]
            },
            64: {
                text: "You rejoin the main path, now higher up the mountain.",
                choices: [
                    {text: "Continue upward", nextSection: 71, skillCheck: false}
                ]
            },
            65: {
                text: "You stand at the summit of the Mountains of Moor! The view is incredible, but you can't linger.",
                choices: [
                    {text: "Begin the descent", nextSection: 73, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    const goldFound = rollDice(1, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    return "At the summit, you find an offering left by previous travelers: <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            66: {
                text: "", // Combat round
                choices: [
                    {text: "Continue fighting!", nextSection: 56, skillCheck: false}
                ]
            },
            67: {
                text: "You've taken what you need from the goat.",
                choices: [
                    {text: "Continue descending", nextSection: 58, skillCheck: false}
                ]
            },
            68: {
                text: "The descent becomes treacherous as loose rocks shift underfoot.",
                choices: [
                    {text: "Descend carefully", nextSection: 74, skillCheck: true, checkType: 'agility', difficulty: 13},
                    {text: "Look for a safer route", nextSection: 75, skillCheck: false}
                ]
            },
            69: {
                text: "", // Combat round
                choices: [
                    {text: "Continue fighting!", nextSection: 59, skillCheck: false}
                ]
            },
            70: {
                text: "You've taken what you found in the nest.",
                choices: [
                    {text: "Continue upward", nextSection: 61, skillCheck: false}
                ]
            },
            71: {
                text: "You're close to the summit now. The wind howls fiercely.",
                choices: [
                    {text: "Push for the summit", nextSection: 65, skillCheck: false}
                ]
            },
            72: {
                text: "The ice tunnel opens onto the mountainside near the summit.",
                choices: [
                    {text: "Push for the summit", nextSection: 65, skillCheck: false}
                ]
            },
            73: {
                text: "The descent on the other side is steep and dangerous.",
                choices: [
                    {text: "Descend carefully", nextSection: 76, skillCheck: false}
                ]
            },
            74: {
                text: "",
                choices: [
                    {text: "Continue descending", nextSection: 77, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You navigate the treacherous slope with skill.";
                    } else {
                        playSound('failure');
                        const damage = rollDice(2, 4);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "You slip on loose rocks! You take <span class='damage'>" + damage + " damage</span>.";
                    }
                }
            },
            75: {
                text: "You find a game trail that's less steep but longer.",
                choices: [
                    {text: "Take the game trail", nextSection: 78, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The game trail is safer but will take longer.";
                }
            },
            76: {
                text: "You descend carefully. The air grows thicker and warmer as you go lower.",
                choices: [
                    {text: "Continue descending", nextSection: 79, skillCheck: false}
                ]
            },
            77: {
                text: "You make good progress down the mountain.",
                choices: [
                    {text: "Continue descending", nextSection: 80, skillCheck: false}
                ]
            },
            78: {
                text: "The game trail winds back and forth down the mountain slope.",
                choices: [
                    {text: "Follow the trail", nextSection: 80, skillCheck: false}
                ]
            },
            79: {
                text: "You're nearing the base of the mountains on the other side.",
                choices: [
                    {text: "Continue to the base", nextSection: 81, skillCheck: false}
                ]
            },
            80: {
                text: "The descent continues. You spot the dark entrance to caves below.",
                choices: [
                    {text: "Head toward the caves", nextSection: 82, skillCheck: false}
                ]
            },
            81: {
                text: "You reach the base of the mountains. Ahead, you see the entrance to the Caves of Chaos.",
                choices: [
                    {text: "Approach the caves", nextSection: 100, skillCheck: false}
                ]
            },
            82: {
                text: "As you approach the cave entrance, you notice strange markings on the rocks.",
                choices: [
                    {text: "Examine the markings", nextSection: 83, skillCheck: true, checkType: 'magic', difficulty: 13},
                    {text: "Enter the caves", nextSection: 84, skillCheck: false}
                ]
            },
            83: {
                text: "",
                choices: [
                    {text: "Enter the caves", nextSection: 84, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        addToInventory('Cave Entrance Knowledge');
                        return "The markings warn of chaos and danger within. You gain <span class='item'>Cave Entrance Knowledge</span>.";
                    } else {
                        playSound('failure');
                        return "The markings are crude and unreadable.";
                    }
                }
            },
            84: {
                text: "You enter the cave system that will lead you through the mountain base.",
                choices: [
                    {text: "Explore the caves", nextSection: 85, skillCheck: false}
                ]
            },
            85: {
                text: "The caves are dark and echo with strange sounds. You proceed cautiously.",
                choices: [
                    {text: "Continue through the caves", nextSection: 86, skillCheck: false}
                ]
            },
            86: {
                text: "After what seems like hours, you see daylight ahead.",
                choices: [
                    {text: "Head toward the light", nextSection: 87, skillCheck: false}
                ]
            },
            87: {
                text: "You emerge from the caves at the base of the mountains!",
                choices: [
                    {text: "Continue your journey", nextSection: 100, skillCheck: false}
                ]
            },
            100: {
                text: "CONGRATULATIONS! You have survived the Mountains of Moor. You stand before the entrance to the Caves of Chaos, ready for your next challenge.",
                choices: [],
                action: function() {
                    gameState.mountainsCleared = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-magic').textContent = gameState.magic;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    gameState.level = 4;
                    saveGame();
                    
                    return "";
                }
            }
        };
        
        // Initialize Game
        function initGame() {
            console.log("Initializing Level 3...");
            
            // Try to load saved game
            const savedGame = localStorage.getItem('islandLostSoulsGameState');
            console.log("Saved game found:", savedGame);
            
            if (savedGame) {
                try {
                    const savedState = JSON.parse(savedGame);
                    console.log("Parsed saved state:", savedState);
                    
                    // Update game state with saved data
                    Object.assign(gameState, savedState);
                    gameState.level = 3; // Force level to 3 for this page
                    gameState.currentSection = 1; // Start at beginning of mountains
                    
                    console.log("Game state loaded:", gameState);
                    
                    // Update display
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    
                    // Load first section
                    loadSection(1);
                    
                } catch (e) {
                    console.error("Error loading saved game:", e);
                    alert("Error loading saved game. Starting new game.");
                    startNewGame();
                }
            } else {
                console.log("No saved game found, starting new");
                alert("No saved game found. Please complete Level 2 first.");
                window.location.href = 'lvl2.html';
            }
        }
        
        function startNewGame() {
            // Default values for testing
            gameState = {
                playerClass: 'warrior',
                strength: 12,
                maxHealth: 45,
                health: 45,
                agility: 9,
                magic: 6,
                darkPower: 0,
                gold: 75,
                inventory: ['Healing Herbs', 'Length of Rope', 'Lockpicks', 'Forest Rune Knowledge'],
                equippedWeapon: 'Broken Sword',
                equippedArmor: 'Tattered Clothes',
                currentSection: 1,
                level: 3,
                mountainsCleared: false
            };
            
            updateStatsDisplay();
            updateInventoryDisplay();
            loadSection(1);
        }
        
        // Show screen
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-magic').textContent = gameState.magic;
            document.getElementById('stat-gold').textContent = gameState.gold;
            
            if (gameState.playerClass === 'necromancer' && gameState.darkPower > 0) {
                document.getElementById('dark-power-stat').style.display = 'block';
                document.getElementById('stat-darkpower').textContent = gameState.darkPower;
            }
        }
        
        // Add to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item)) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index > -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped items
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory
            gameState.inventory.forEach(item => {
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => useInventoryItem(item);
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            document.getElementById('inventory-count').textContent = `ITEMS: ${gameState.inventory.length + 2}/12`;
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Herbs' || item === 'Sacred Herbs') {
                const healAmount = rollDice(1, 10) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use <span class='item'>${item}</span> and heal ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Length of Rope') {
                message = "The rope could be useful for climbing or securing yourself.";
            } else if (item === 'Lockpicks') {
                message = "Lockpicks might help with locked doors or chests.";
            } else if (item === 'Glowing Mountain Crystals') {
                message = "The crystals glow with a soft, magical light.";
            } else if (item === 'Goat Horn') {
                message = "The goat horn is sturdy and could be useful.";
            } else if (item === 'Gryphon Feather') {
                message = "The gryphon feather is beautiful and strangely warm.";
            } else if (item === 'Bear Pelt') {
                message = "The bear pelt provides warmth against the cold.";
            } else if (item.includes('Knowledge') || item.includes('Wisdom')) {
                message = `Your <span class='item'>${item}</span> gives you special understanding of this place.`;
            } else if (item === 'Cursed Mountain Blade') {
                message = "The cursed blade hums with dark energy. It feels powerful but dangerous.";
            } else if (item === 'Mountain-forged Sword') {
                message = "The mountain-forged sword is perfectly balanced and razor sharp.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Your inventory is empty.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item:</strong><br>";
            gameState.inventory.forEach(item => {
                itemText += `<button onclick="useInventoryItem('${item}')" style="margin:5px;">${item}</button> `;
            });
            itemText += `<br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Cancelled.</div>'" style="margin:5px;">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Class ability
        function useClassAbility() {
            playSound('click');
            let abilityText = "<div class='dice-roll'>";
            
            if (gameState.playerClass === 'wizard') {
                abilityText += "<strong>Wizard Spells:</strong><br>";
                abilityText += `<button onclick="castSpell('light')" style="margin:5px;">Light</button> `;
                abilityText += `<button onclick="castSpell('shield')" style="margin:5px;">Shield</button>`;
                abilityText += `<button onclick="castSpell('warmth')" style="margin:5px;">Warmth</button>`;
            } else if (gameState.playerClass === 'warrior') {
                abilityText += "<strong>Warrior Abilities:</strong><br>";
                abilityText += `<button onclick="warriorAbility('intimidate')" style="margin:5px;">Intimidate</button> `;
                abilityText += `<button onclick="warriorAbility('second_wind')" style="margin:5px;">Second Wind</button>`;
                abilityText += `<button onclick="warriorAbility('mountain_strength')" style="margin:5px;">Mountain Strength</button>`;
            } else if (gameState.playerClass === 'necromancer') {
                abilityText += "<strong>Necromancer Powers:</strong><br>";
                abilityText += `<button onclick="necromancerAbility('dark_healing')" style="margin:5px;">Dark Healing</button> `;
                abilityText += `<button onclick="necromancerAbility('sense_death')" style="margin:5px;">Sense Death</button>`;
                abilityText += `<button onclick="necromancerAbility('cold_resistance')" style="margin:5px;">Cold Resistance</button>`;
            }
            
            abilityText += `<br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Cancelled.</div>'" style="margin:5px;">Cancel</button>`;
            abilityText += "</div>";
            
            document.getElementById('story-text').innerHTML += abilityText;
        }
        
        // Wizard spells
        function castSpell(spell) {
            playSound('magic');
            const magicCheck = rollDice(2, 6);
            let message = "";
            
            if (magicCheck <= gameState.magic) {
                playSound('success');
                if (spell === 'light') {
                    message = "You cast Light! The area brightens.";
                } else if (spell === 'shield') {
                    message = "You cast Shield! You gain temporary protection.";
                } else if (spell === 'warmth') {
                    const healAmount = rollDice(1, 4);
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    message = `You cast Warmth! You recover ${actualHeal} Health and resist the cold.`;
                    updateStatsDisplay();
                }
            } else {
                playSound('failure');
                message = "The spell fizzles.";
                gameState.health -= 1;
                updateStatsDisplay();
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Warrior abilities
        function warriorAbility(ability) {
            playSound('combat');
            let message = "";
            
            if (ability === 'intimidate') {
                const strengthCheck = rollDice(2, 6);
                if (strengthCheck <= gameState.strength) {
                    playSound('success');
                    message = "You intimidate your foes with your mountain-hardened resolve!";
                } else {
                    playSound('failure');
                    message = "Your attempt fails.";
                }
            } else if (ability === 'second_wind') {
                const healAmount = rollDice(1, 6) + Math.floor(gameState.strength / 2);
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                playSound('success');
                message = `You catch your second wind and heal ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (ability === 'mountain_strength') {
                playSound('success');
                message = "You draw upon your inner strength like the mountains themselves! You feel empowered.";
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Necromancer abilities
        function necromancerAbility(ability) {
            playSound('magic');
            let message = "";
            
            if (ability === 'dark_healing') {
                if (gameState.darkPower >= 1) {
                    const healAmount = rollDice(1, 8) + gameState.darkPower;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    gameState.darkPower -= 1;
                    playSound('success');
                    message = `You drain life energy from the mountain itself, healing ${actualHeal} Health!`;
                    updateStatsDisplay();
                } else {
                    playSound('failure');
                    message = "Not enough Dark Power.";
                }
            } else if (ability === 'sense_death') {
                message = "You sense the ancient deaths preserved in these frozen mountains.";
                playSound('success');
            } else if (ability === 'cold_resistance') {
                playSound('success');
                message = "You draw upon the cold of the grave to resist the mountain's chill.";
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p>Error: Section not found</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check for combat
            if ((sectionId === 56 || sectionId === 59 || sectionId === 66 || sectionId === 69) && combatState.active) {
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                if (!combatState.active) {
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p>";
            
            // Update choice buttons
            const choiceButtons = document.getElementById('choice-buttons');
            choiceButtons.innerHTML = '';
            
            const availableChoices = section.choices.filter(choice => {
                if (choice.requirement === 'magic') {
                    return gameState.magic >= choice.minValue;
                }
                return true;
            });
            
            if (availableChoices.length === 0 && section.choices.length > 0) {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = "Continue through the mountains";
                button.onclick = () => loadSection(1);
                choiceButtons.appendChild(button);
            } else {
                availableChoices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    button.onclick = () => {
                        if (choice.skillCheck) {
                            performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                        } else {
                            loadSection(choice.nextSection);
                        }
                    };
                    choiceButtons.appendChild(button);
                });
            }
            
            saveGame();
        }
        
        // Execute combat round
        function executeCombatRound() {
            combatState.round++;
            
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log">Round ${combatState.round}: ${combatState.enemyName}<br>`;
            resultText += `Your Health: ${gameState.health}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                let damage = 0;
                if (gameState.equippedWeapon === 'Fists') damage = rollDice(1, 4);
                else if (gameState.equippedWeapon === 'Broken Sword') damage = rollDice(1, 8);
                else if (gameState.equippedWeapon === 'Cursed Mountain Blade') damage = rollDice(2, 6);
                else if (gameState.equippedWeapon === 'Mountain-forged Sword') damage = rollDice(1, 10);
                else damage = rollDice(1, 6);
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
            } else if (playerTotal < enemyTotal) {
                const enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">Enemy hits for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated!</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('islandLostSoulsGameState');
                        location.reload();
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                resultText += "The attacks are evenly matched!";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            window.checkResult = success;
            
            let resultText = `Roll: ${diceRoll}. Your ${checkType}: ${statValue}. `;
            resultText += success ? `<span class="success">Success!</span>` : `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) playSound('success');
            else playSound('failure');
            
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // New game
        function newGame() {
            playSound('click');
            if (confirm("Start new game? Current progress will be lost.")) {
                localStorage.removeItem('islandLostSoulsGameState');
                window.location.href = 'lvl1.html';
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('islandLostSoulsGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('islandLostSoulsGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                Object.assign(gameState, savedState);
                updateStatsDisplay();
                updateInventoryDisplay();
                loadSection(gameState.currentSection);
                document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            gameState.level = 4;
            localStorage.setItem('islandLostSoulsGameState', JSON.stringify(gameState));
            window.location.href = 'lvl4.html';
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
