<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASCII Wizard Duel - Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #0f0;
            line-height: 1.2;
            padding: 0;
            overflow-x: hidden;
            width: 100%;
            height: 100vh;
            height: 100dvh;
        }

        #game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        #main-menu {
            display: flex;
        }

        .active {
            display: flex !important;
        }

        .header {
            text-align: center;
            padding: 8px;
            border-bottom: 1px solid #0f0;
            margin-bottom: 0;
            flex-shrink: 0;
            flex-grow: 0;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            min-height: 0;
            margin: 0;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }

        .compact-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            justify-content: flex-start;
        }

        .content > * {
            margin-top: 0;
        }

        .content > *:first-child {
            margin-top: 0;
        }

        .footer {
            padding: 8px;
            border-top: 1px solid #0f0;
            margin-top: 0;
            flex-shrink: 0;
            flex-grow: 0;
        }

        button {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 12px 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 2px 0;
            cursor: pointer;
            width: 100%;
            min-height: 50px;
            flex-shrink: 0;
            transition: all 0.1s ease;
        }

        button:active {
            background-color: #0a0;
            color: #000;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }

        .battle-area {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .wizard {
            text-align: center;
            width: 48%;
            min-width: 150px;
            margin-bottom: 10px;
        }

        .wizard-ascii {
            font-size: 12px;
            line-height: 1;
            margin: 5px 0;
            white-space: pre;
        }

        .health-bar {
            width: 100%;
            height: 10px;
            background-color: #333;
            margin: 5px 0;
        }

        .health-fill {
            height: 100%;
            background-color: #0f0;
        }

        .mana-bar {
            width: 100%;
            height: 10px;
            background-color: #333;
            margin: 5px 0;
        }

        .mana-fill {
            height: 100%;
            background-color: #00f;
        }

        .spell-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 5px;
        }

        .spell {
            width: 48%;
            margin-bottom: 5px;
            min-width: 120px;
        }

        .log {
            height: 100px;
            overflow-y: auto;
            border: 1px solid #0f0;
            padding: 5px;
            margin-top: 10px;
            font-size: 12px;
            flex-shrink: 0;
        }

        .enemy-list {
            display: flex;
            flex-direction: column;
        }

        .enemy {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border: 1px solid #0f0;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }

        .profile {
            border: 1px solid #0f0;
            padding: 5px;
            margin-bottom: 10px;
        }

        .inventory {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 5px;
        }

        .item {
            width: 48%;
            margin-bottom: 5px;
            border: 1px solid #0f0;
            padding: 5px;
            min-width: 140px;
        }

        .item-common { border-color: #0f0; }
        .item-rare { border-color: #00f; }
        .item-epic { border-color: #90f; }
        .item-legendary { border-color: #ff0; }

        .xp-bar {
            width: 100%;
            height: 10px;
            background-color: #333;
            margin: 5px 0;
        }

        .xp-fill {
            height: 100%;
            background-color: #ff0;
        }

        .upgrade-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border: 1px solid #0f0;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }

        .mana-warning {
            color: #f00;
            text-align: center;
            margin: 5px 0;
        }

        .victory-screen, .defeat-screen, .loot-screen {
            text-align: center;
            padding: 10px;
        }

        .victory-rewards, .defeat-stats, .loot-items {
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
        }

        .victory-message, .defeat-message {
            font-size: 16px;
            margin: 10px 0;
            color: #ff0;
        }

        .defeat-message {
            color: #f00;
        }

        .health-critical {
            color: #f00;
            animation: pulse 1s infinite;
        }

        .loot-item {
            margin: 5px 0;
            padding: 5px;
            border: 1px solid #0f0;
        }

        .loot-rarity-common { color: #0f0; }
        .loot-rarity-rare { color: #00f; }
        .loot-rarity-epic { color: #90f; }
        .loot-rarity-legendary { color: #ff0; }

        .consumable-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin: 10px 0;
            gap: 5px;
        }

        .consumable-btn {
            width: 48%;
            margin-bottom: 5px;
            min-width: 120px;
        }

        .inventory-item {
            width: 100%;
            margin-bottom: 10px;
            border: 1px solid #0f0;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .item-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 5px;
            width: 100%;
            justify-content: flex-end;
        }

        .item-action-btn {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
            margin: 0;
            flex: 1;
            min-width: 80px;
        }

        .inventory-empty {
            text-align: center;
            padding: 20px;
            color: #666;
            width: 100%;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .enemy-defeated {
            color: #ff0;
            font-weight: bold;
        }

        .elemental-bonus {
            color: #ff0;
            font-weight: bold;
        }

        .status-effect {
            display: inline-block;
            padding: 2px 5px;
            margin: 0 2px;
            border-radius: 3px;
            font-size: 10px;
        }

        .status-burn { background-color: #f00; color: #fff; }
        .status-freeze { background-color: #0ff; color: #000; }
        .status-shock { background-color: #ff0; color: #000; }
        .status-poison { background-color: #8f0; color: #000; }

        .damage-number {
            position: absolute;
            color: #f00;
            font-weight: bold;
            animation: floatUp 1s ease-out forwards;
        }

        .critical-hit {
            color: #ff0;
            font-size: 14px;
            font-weight: bold;
        }

        .combo-counter {
            text-align: center;
            font-size: 16px;
            color: #ff0;
            margin: 5px 0;
        }

        .gold-display {
            text-align: center;
            margin: 5px 0;
            color: #ff0;
        }

        .achievement-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #000;
            border: 2px solid #ff0;
            padding: 10px;
            z-index: 100;
            text-align: center;
            max-width: 90%;
        }

        .shop-item {
            border: 1px solid #0f0;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .daily-challenge {
            border: 1px solid #ff0;
            padding: 10px;
            margin: 10px 0;
        }

        .scrollable-container {
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            -webkit-overflow-scrolling: touch;
            padding: 5px;
            display: flex;
            flex-direction: column;
        }

        .compact-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            justify-content: flex-start;
        }

        .compact-item {
            padding: 8px;
            border: 1px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .compact-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            width: 100%;
        }

        .compact-action-btn {
            flex: 1;
            padding: 4px 8px;
            font-size: 11px;
        }

        /* NEW: Skill tree styles */
        .skill-tree {
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
        }

        .skill-category {
            margin-bottom: 15px;
        }

        .skill {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border: 1px solid #0f0;
            margin: 5px 0;
        }

        .skill.unlocked {
            border-color: #ff0;
            background-color: rgba(255, 255, 0, 0.1);
        }

        .skill.locked {
            opacity: 0.6;
        }

        .skill-points {
            text-align: center;
            margin: 10px 0;
            color: #ff0;
            font-weight: bold;
        }

        /* NEW: Positioning system */
        .position-indicator {
            text-align: center;
            margin: 5px 0;
            font-size: 12px;
        }

        .position-btn {
            width: 30%;
            margin: 2px;
            min-width: 80px;
        }

        .position-buttons {
            display: flex;
            justify-content: center;
            margin: 5px 0;
        }

        /* NEW: Cooldown indicators */
        .spell-cooldown {
            position: relative;
        }

        .cooldown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
        }

        /* NEW: AI behavior indicators */
        .ai-behavior {
            font-size: 10px;
            color: #ff0;
            margin-top: 2px;
        }

        /* NEW: Info section styles */
        .info-section {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #0f0;
        }

        .info-section h3 {
            color: #ff0;
            margin-bottom: 8px;
        }

        .spell-info {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px dashed #0f0;
        }

        .elemental-combo {
            margin: 8px 0;
            padding: 8px;
            background-color: rgba(255, 255, 0, 0.1);
            border-left: 3px solid #ff0;
        }

        .combo-effect {
            color: #ff0;
            font-weight: bold;
        }

        /* Fix for achievements display */
        .achievement-item {
            border: 1px solid #0f0;
            padding: 10px;
            margin-bottom: 10px;
        }

        .achievement-unlocked {
            border-color: #ff0;
            background-color: rgba(255, 255, 0, 0.1);
        }

        .achievement-locked {
            opacity: 0.7;
        }

        /* NEW: Quest system styles */
        .quest-item {
            border: 1px solid #0f0;
            padding: 10px;
            margin-bottom: 10px;
        }

        .quest-completed {
            border-color: #ff0;
            background-color: rgba(255, 255, 0, 0.1);
        }

        .quest-progress {
            height: 5px;
            background-color: #333;
            margin: 5px 0;
        }

        .quest-progress-fill {
            height: 100%;
            background-color: #0f0;
        }

        /* NEW: Animation effects */
        .spell-animation {
            position: absolute;
            font-size: 24px;
            animation: spellFly 0.5s ease-out forwards;
            z-index: 10;
        }

        @keyframes spellFly {
            0% { transform: translateX(0) translateY(0); opacity: 1; }
            100% { transform: translateX(100px) translateY(-50px); opacity: 0; }
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }

        /* NEW: Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #000;
            color: #0f0;
            text-align: center;
            border: 1px solid #0f0;
            border-radius: 3px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* NEW: Quick play button */
        .quick-play-btn {
            background-color: #0a0;
            font-weight: bold;
        }

        @media (max-height: 700px) {
            .header {
                padding: 5px;
            }
            
            .header pre {
                font-size: 10px;
                line-height: 1;
            }
            
            .header h2 {
                font-size: 16px;
            }
            
            .content {
                padding: 5px;
            }
            
            button {
                padding: 10px 6px;
                min-height: 40px;
                font-size: 13px;
            }
            
            .footer {
                padding: 5px;
            }
        }

        @media (max-height: 500px) {
            .header pre {
                display: none;
            }
            
            .header {
                padding: 3px;
            }
            
            .content {
                padding: 3px;
            }
            
            button {
                padding: 8px 4px;
                min-height: 36px;
                font-size: 12px;
            }
            
            .compact-list {
                gap: 3px;
            }
        }

        @media (orientation: portrait) {
            .screen {
                height: 100vh;
                height: 100dvh;
            }
            
            .content {
                padding: 6px;
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            
            .compact-list {
                gap: 6px;
                flex: 1;
            }
            
            .scrollable-container {
                padding: 4px;
                flex: 1;
            }
        }

        @media (max-width: 480px) and (orientation: portrait) {
            body {
                padding: 0;
            }
            
            #game-container {
                height: 100vh;
                height: 100dvh;
            }
            
            .screen {
                height: 100vh;
                height: 100dvh;
            }
            
            .header {
                padding: 6px;
            }
            
            .content {
                padding: 6px;
                flex: 1;
            }
            
            .footer {
                padding: 6px;
            }
            
            .compact-list {
                gap: 6px;
                flex: 1;
            }
            
            button {
                margin: 1px 0;
                min-height: 44px;
            }
        }

        /* NEW: Sound controls */
        .sound-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .sound-btn {
            width: auto;
            padding: 5px;
            min-height: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Sound Controls -->
        <div class="sound-controls">
            <button id="toggle-sound" class="sound-btn">ðŸ”Š Sound: ON</button>
        </div>

        <!-- Main Menu Screen -->
        <div id="main-menu" class="screen active">
            <div class="header">
                <pre>
  _    _ _____ _     _ _______ _____  ______ 
 | |  | (____ | |   | (_______|____ \/ _____)
 | |  | |_   _| |__ | |_       _   | / /  _ 
 \ \/ /  | | |  __)| | | |   | |  | | |  |_| |
  \  /   | | | |   | | | |__/ /| |__| | |_ 
  / /    |_| |_|   |_| |_____/ |_____/ \___
 /_/                                         
                </pre>
                <h2>ENHANCED WIZARD DUEL</h2>
            </div>
            <div class="content">
                <div class="compact-list">
                    <button id="new-game">NEW GAME</button>
                    <button id="quick-play" class="quick-play-btn">QUICK PLAY</button>
                    <button id="player-profile">PLAYER PROFILE</button>
                    <button id="select-enemy">FIGHT WIZARD</button>
                    <button id="use-consumables">USE ITEMS</button>
                    <button id="shop-btn">SHOP</button>
                    <button id="skill-tree-btn">SKILL TREE</button>
                    <button id="achievements-btn">ACHIEVEMENTS</button>
                    <button id="quests-btn">QUESTS</button>
                    <button id="rest-btn">REST (Recover Mana)</button>
                    <button id="info-btn">INFO</button>
                    <div class="gold-display">Gold: <span id="gold-amount">0</span></div>
                    <div class="skill-points">Skill Points: <span id="skill-points-amount">0</span></div>
                    <div id="combo-counter-main" class="combo-counter" style="display: none;"></div>
                    <div id="daily-challenge-main" class="daily-challenge" style="display: none;">
                        <h3>Daily Challenge Available!</h3>
                        <button id="daily-challenge-btn">VIEW DAILY CHALLENGE</button>
                    </div>
                </div>
            </div>
            <div class="footer">
                <p>Use your spells wisely! (1-4: Quick Cast)</p>
            </div>
        </div>
        
        <!-- Player Profile Screen -->
        <div id="player-profile-screen" class="screen">
            <div class="header">
                <h2>PLAYER PROFILE</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="profile">
                        <div class="profile-header">
                            <pre>
     /\
    /  \
   / /\ \
  / ____ \
 /_/    \_\
                            </pre>
                            <h3 id="player-name">MERLIN</h3>
                            <div class="stats">
                                <div>Gold: <span id="player-gold">0</span></div>
                                <div>Skill Points: <span id="player-skill-points">0</span></div>
                                <div>Achievements: <span id="player-achievements">0</span>/5</div>
                            </div>
                        </div>
                        <div class="stats">
                            <div>Level: <span id="player-level">1</span></div>
                            <div>XP: <span id="player-xp">0</span>/<span id="player-next-level">100</span></div>
                        </div>
                        <div class="xp-bar">
                            <div class="xp-fill" id="player-xp-bar" style="width: 0%;"></div>
                        </div>
                        <div class="stats">
                            <div>Health: <span id="player-health">50</span>/<span id="player-max-health">50</span></div>
                            <div>Mana: <span id="player-mana">30</span>/<span id="player-max-mana">30</span></div>
                        </div>
                        <div class="stats">
                            <div>Attack: <span id="player-attack">5</span></div>
                            <div>Defense: <span id="player-defense">3</span></div>
                            <div>Critical: <span id="player-critical">5</span>%</div>
                        </div>
                        <div class="position-indicator">
                            Preferred Position: <span id="player-position">Medium</span>
                        </div>
                        <div id="player-status-effects" class="stats">
                            <!-- Status effects will appear here -->
                        </div>
                        <h4>SPELLS:</h4>
                        <div class="spell-list" id="profile-spells">
                            <!-- Spells will be dynamically added here -->
                        </div>
                        <h4>EQUIPMENT:</h4>
                        <div class="inventory">
                            <div class="item">
                                <div>Weapon: <span id="player-weapon">Staff</span></div>
                                <div>DMG: +<span id="player-weapon-dmg">2</span></div>
                            </div>
                            <div class="item">
                                <div>Armor: <span id="player-armor">Robes</span></div>
                                <div>DEF: +<span id="player-armor-def">1</span></div>
                            </div>
                        </div>
                        <h4>INVENTORY:</h4>
                        <div id="player-inventory-items">
                            <div class="inventory-empty">No items in inventory</div>
                        </div>
                        <button id="manage-inventory" style="margin-top: 10px;">MANAGE INVENTORY</button>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-profile">BACK</button>
            </div>
        </div>

        <!-- Skill Tree Screen -->
        <div id="skill-tree-screen" class="screen">
            <div class="header">
                <h2>SKILL TREE</h2>
                <div class="skill-points">Available Skill Points: <span id="available-skill-points">0</span></div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="skill-tree">
                        <h3>Elemental Mastery</h3>
                        <div class="skill-category">
                            <h4>Fire Magic</h4>
                            <div class="skill" id="skill-fire-1">
                                <div>
                                    <strong>Fire Affinity</strong>
                                    <div>Fire spells deal 10% more damage</div>
                                </div>
                                <button class="skill-btn" data-skill="fire_affinity" data-cost="1">Learn (1 point)</button>
                            </div>
                            <div class="skill locked" id="skill-fire-2">
                                <div>
                                    <strong>Burning Rage</strong>
                                    <div>Burn effects last 1 additional turn</div>
                                </div>
                                <button class="skill-btn" data-skill="burning_rage" data-cost="2">Learn (2 points)</button>
                            </div>
                        </div>
                        <div class="skill-category">
                            <h4>Ice Magic</h4>
                            <div class="skill" id="skill-ice-1">
                                <div>
                                    <strong>Ice Affinity</strong>
                                    <div>Ice spells cost 1 less mana</div>
                                </div>
                                <button class="skill-btn" data-skill="ice_affinity" data-cost="1">Learn (1 point)</button>
                            </div>
                            <div class="skill locked" id="skill-ice-2">
                                <div>
                                    <strong>Deep Freeze</strong>
                                    <div>Frozen enemies skip turns more often</div>
                                </div>
                                <button class="skill-btn" data-skill="deep_freeze" data-cost="2">Learn (2 points)</button>
                            </div>
                        </div>
                        <div class="skill-category">
                            <h4>Lightning Magic</h4>
                            <div class="skill" id="skill-lightning-1">
                                <div>
                                    <strong>Lightning Affinity</strong>
                                    <div>Lightning spells have +5% critical chance</div>
                                </div>
                                <button class="skill-btn" data-skill="lightning_affinity" data-cost="1">Learn (1 point)</button>
                            </div>
                            <div class="skill locked" id="skill-lightning-2">
                                <div>
                                    <strong>Chain Reaction</strong>
                                    <div>Lightning spells can jump to additional targets</div>
                                </div>
                                <button class="skill-btn" data-skill="chain_reaction" data-cost="3">Learn (3 points)</button>
                            </div>
                        </div>
                        <div class="skill-category">
                            <h4>General Skills</h4>
                            <div class="skill" id="skill-general-1">
                                <div>
                                    <strong>Mana Efficiency</strong>
                                    <div>All spells cost 1 less mana (min 1)</div>
                                </div>
                                <button class="skill-btn" data-skill="mana_efficiency" data-cost="2">Learn (2 points)</button>
                            </div>
                            <div class="skill locked" id="skill-general-2">
                                <div>
                                    <strong>Critical Thinking</strong>
                                    <div>+5% critical strike chance for all spells</div>
                                </div>
                                <button class="skill-btn" data-skill="critical_thinking" data-cost="3">Learn (3 points)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-skills">BACK</button>
            </div>
        </div>
        
        <!-- Enemy Selection Screen -->
        <div id="enemy-selection" class="screen">
            <div class="header">
                <h2>SELECT YOUR OPPONENT</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="enemy-list" id="enemy-list">
                        <!-- Enemies will be dynamically added here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-enemies">BACK</button>
            </div>
        </div>
        
        <!-- Battle Screen -->
        <div id="battle-screen" class="screen">
            <div class="header">
                <h2>WIZARD DUEL</h2>
                <div id="combo-counter-battle" class="combo-counter" style="display: none;"></div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="position-indicator">
                        Your Position: <span id="battle-player-position">Medium</span>
                        <div class="position-buttons">
                            <button class="position-btn" data-position="close">Close</button>
                            <button class="position-btn" data-position="medium">Medium</button>
                            <button class="position-btn" data-position="far">Far</button>
                        </div>
                    </div>
                    <div class="battle-area">
                        <div class="wizard">
                            <h3>PLAYER</h3>
                            <div class="wizard-ascii" id="player-ascii">
     /\
    /  \
   / /\ \
  / ____ \
 /_/    \_\
                            </div>
                            <div>Health: <span id="battle-player-health">50</span>/<span id="battle-player-max-health">50</span></div>
                            <div class="health-bar">
                                <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
                            </div>
                            <div>Mana: <span id="battle-player-mana">30</span>/<span id="battle-player-max-mana">30</span></div>
                            <div class="mana-bar">
                                <div class="mana-fill" id="player-mana-fill" style="width: 100%;"></div>
                            </div>
                            <div id="player-status-effects-battle" class="stats">
                                <!-- Player status effects in battle -->
                            </div>
                        </div>
                        <div class="wizard">
                            <h3 id="enemy-name">FIRE MAGE</h3>
                            <div class="ai-behavior" id="enemy-ai-behavior">AI: Aggressive</div>
                            <div class="wizard-ascii" id="enemy-ascii">
     /\
    /  \
   / /\ \
  / ____ \
 /_/    \_\
                            </div>
                            <div>Health: <span id="battle-enemy-health">40</span>/<span id="battle-enemy-max-health">40</span></div>
                            <div class="health-bar">
                                <div class="health-fill" id="enemy-health-fill" style="width: 100%;"></div>
                            </div>
                            <div>Mana: <span id="battle-enemy-mana">25</span>/<span id="battle-enemy-max-mana">25</span></div>
                            <div class="mana-bar">
                                <div class="mana-fill" id="enemy-mana-fill" style="width: 100%;"></div>
                            </div>
                            <div id="enemy-status-effects" class="stats">
                                <!-- Enemy status effects -->
                            </div>
                        </div>
                    </div>
                    <div class="log" id="battle-log">
                        <div>A wizard duel begins!</div>
                    </div>
                    <div id="mana-warning" class="mana-warning" style="display: none;">
                        Low on mana! Consider fleeing to recover.
                    </div>
                    <div id="health-warning" class="mana-warning health-critical" style="display: none;">
                        CRITICAL HEALTH! Use Heal or flee!
                    </div>
                    <h4>YOUR SPELLS:</h4>
                    <div class="spell-list" id="battle-spells">
                        <!-- Spells will be dynamically added here -->
                    </div>
                    <div class="consumable-buttons" id="battle-consumables" style="display: none;">
                        <!-- Consumable buttons will be added here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="flee">FLEE</button>
            </div>
        </div>
        
        <!-- Victory Screen -->
        <div id="victory-screen" class="screen">
            <div class="header">
                <h2>VICTORY!</h2>
            </div>
            <div class="content">
                <div class="victory-screen">
                    <pre>
   __   _____  _  _  ____  __    ____ 
  /__\ (  _  )( \( )( ___)(  )  ( ___)
 /(__)\ )(_)(  )  (  )__)  )(__  )__) 
(__)(__)(_____)(_)\_)(____)(____)(____)
                    </pre>
                    <div class="victory-message" id="victory-message">
                        You have defeated the enemy wizard!
                    </div>
                    <div class="victory-rewards">
                        <h3>REWARDS:</h3>
                        <div id="victory-xp">XP Gained: 0</div>
                        <div id="victory-gold">Gold Gained: 0</div>
                        <div id="victory-skill-points" style="display: none;">Skill Point Gained!</div>
                        <div id="victory-level-up" style="display: none; color: #ff0; font-weight: bold;">
                            LEVEL UP! You are now level <span id="new-level">2</span>!
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="continue-after-victory">CONTINUE</button>
            </div>
        </div>
        
        <!-- Loot Screen -->
        <div id="loot-screen" class="screen">
            <div class="header">
                <h2>LOOT FOUND!</h2>
            </div>
            <div class="content">
                <div class="loot-screen">
                    <pre>
   __   _____   ___  _____ 
  / /  |  _  | / _ \|_   _|
 / /   | | | |/ /_\ \ | |  
/ /    | | | ||  _  | | |  
\ \    | |_| || | | | | |  
 \_\   |_____/\_| |_/ \_/  
                    </pre>
                    <div class="loot-message">
                        You found valuable loot from the defeated wizard!
                    </div>
                    <div class="loot-items" id="loot-items">
                        <!-- Loot items will be displayed here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="take-loot">TAKE LOOT</button>
            </div>
        </div>
        
        <!-- Defeat Screen -->
        <div id="defeat-screen" class="screen">
            <div class="header">
                <h2>DEFEAT</h2>
            </div>
            <div class="content">
                <div class="defeat-screen">
                    <pre>
  _____  ______  _____  ______  _______  _____ 
 |  __ \|  ____|/ ____||  ____||__   __|/ ____|
 | |  | | |__  | (___  | |__      | |  | (___  
 | |  | |  __|  \___ \ |  __|     | |   \___ \ 
 | |__| | |____ ____) || |____    | |   ____) |
 |_____/|______|_____/ |______|   |_|  |_____/ 
                    </pre>
                    <div class="defeat-message" id="defeat-message">
                        You have been defeated in battle!
                    </div>
                    <div class="defeat-stats">
                        <h3>BATTLE STATS:</h3>
                        <div id="defeat-enemy">Defeated by: Unknown</div>
                        <div id="defeat-level">Your Level: 1</div>
                        <div id="defeat-xp">Current XP: 0</div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="try-again">TRY AGAIN</button>
                <button id="main-menu-after-defeat">MAIN MENU</button>
            </div>
        </div>
        
        <!-- Upgrade Screen -->
        <div id="upgrade-screen" class="screen">
            <div class="header">
                <h2>LEVEL UP!</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <p>You gained a level! Choose an upgrade:</p>
                    <div class="upgrade-option">
                        <div>
                            <h4>+10 Max Health</h4>
                            <p>Increases your maximum health by 10</p>
                        </div>
                        <button class="upgrade-btn" data-upgrade="health">SELECT</button>
                    </div>
                    <div class="upgrade-option">
                        <div>
                            <h4>+5 Max Mana</h4>
                            <p>Increases your maximum mana by 5</p>
                        </div>
                        <button class="upgrade-btn" data-upgrade="mana">SELECT</button>
                    </div>
                    <div class="upgrade-option">
                        <div>
                            <h4>+2 Attack</h4>
                            <p>Increases your attack power by 2</p>
                        </div>
                        <button class="upgrade-btn" data-upgrade="attack">SELECT</button>
                    </div>
                    <div class="upgrade-option">
                        <div>
                            <h4>+2 Defense</h4>
                            <p>Increases your defense by 2</p>
                        </div>
                        <button class="upgrade-btn" data-upgrade="defense">SELECT</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Consumables Screen -->
        <div id="consumables-screen" class="screen">
            <div class="header">
                <h2>USE ITEMS</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="consumables-list">
                        <!-- Consumable items will be listed here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-consumables">BACK</button>
            </div>
        </div>
        
        <!-- Inventory Screen -->
        <div id="inventory-screen" class="screen">
            <div class="header">
                <h2>INVENTORY</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="inventory-items">
                        <!-- Inventory items with actions will be listed here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-inventory">BACK</button>
            </div>
        </div>
        
        <!-- Shop Screen -->
        <div id="shop-screen" class="screen">
            <div class="header">
                <h2>SHOP</h2>
                <div>Your Gold: <span id="shop-gold">0</span></div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="shop-items">
                        <!-- Shop items will be dynamically added here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-shop">BACK</button>
            </div>
        </div>
        
        <!-- Achievements Screen -->
        <div id="achievements-screen" class="screen">
            <div class="header">
                <h2>ACHIEVEMENTS</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="achievements-list">
                        <!-- Achievements will be dynamically added here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-achievements">BACK</button>
            </div>
        </div>

        <!-- Quests Screen -->
        <div id="quests-screen" class="screen">
            <div class="header">
                <h2>QUESTS</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="quests-list">
                        <!-- Quests will be dynamically added here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-quests">BACK</button>
            </div>
        </div>
        
        <!-- Info Screen -->
        <div id="info-screen" class="screen">
            <div class="header">
                <h2>GAME INFORMATION</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="info-section">
                        <h3>HOW TO PLAY</h3>
                        <p>Welcome to ASCII Wizard Duel! This is a turn-based wizard battle game where you fight against various elemental wizards.</p>
                        <p><strong>Basic Gameplay:</strong></p>
                        <ul>
                            <li>Select an enemy wizard to fight from the "FIGHT WIZARD" menu</li>
                            <li>In battle, choose spells to cast against your opponent</li>
                            <li>Manage your mana - each spell costs mana to cast</li>
                            <li>Use positioning to your advantage - different ranges affect spell effectiveness</li>
                            <li>Defeat enemies to gain XP, gold, and loot</li>
                            <li>Level up to increase your stats and unlock new abilities</li>
                        </ul>
                        <p><strong>Battle Tips:</strong></p>
                        <ul>
                            <li>Use elemental advantages - some elements are strong against others</li>
                            <li>Watch for status effects - they can turn the tide of battle</li>
                            <li>Manage cooldowns - powerful spells can't be used every turn</li>
                            <li>Use consumables from your inventory when needed</li>
                            <li>Flee if you're in a bad situation to recover mana</li>
                        </ul>
                    </div>

                    <div class="info-section">
                        <h3>SPELLS</h3>
                        <p>Here are all the spells available in the game:</p>
                        
                        <div class="spell-info">
                            <strong>Fireball</strong>
                            <div>Damage: 8 | Cost: 5 MP | Element: Fire</div>
                            <div>Effect: Chance to inflict Burn status (2 damage per turn for 3 turns)</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Ice Shard</strong>
                            <div>Damage: 6 | Cost: 4 MP | Element: Ice</div>
                            <div>Effect: Chance to inflict Freeze status (may skip enemy turns)</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Lightning</strong>
                            <div>Damage: 10 | Cost: 7 MP | Element: Lightning</div>
                            <div>Effect: Chance to inflict Shock status (drains enemy mana)</div>
                            <div>Cooldown: 1 turn</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Heal</strong>
                            <div>Heal: 10 | Cost: 6 MP | Element: Holy</div>
                            <div>Effect: Restores your health</div>
                            <div>Cooldown: 2 turns</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Arcane Missile</strong>
                            <div>Damage: 12 | Cost: 8 MP | Element: Arcane</div>
                            <div>Effect: Pure magical damage with no elemental properties</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Chain Lightning</strong>
                            <div>Damage: 15 | Cost: 10 MP | Element: Lightning</div>
                            <div>Effect: Can jump to additional targets</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Meteor Shower</strong>
                            <div>Damage: 20 | Cost: 15 MP | Element: Fire</div>
                            <div>Effect: Massive area damage</div>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>ELEMENTAL SYSTEM & SPELL COMBOS</h3>
                        <p>The game features an elemental system where certain elements are strong or weak against others:</p>
                        
                        <div class="elemental-combo">
                            <strong>Elemental Advantages:</strong>
                            <div>â€¢ Fire is strong against Ice (+50% damage)</div>
                            <div>â€¢ Ice is strong against Storm (+50% damage)</div>
                            <div>â€¢ Lightning is strong against Water (+50% damage)</div>
                            <div>â€¢ Using an element against its weakness deals -25% damage</div>
                        </div>
                        
                        <div class="elemental-combo">
                            <strong>Spell Combos:</strong>
                            <div>â€¢ Casting the same element multiple times builds combo (increases damage)</div>
                            <div>â€¢ <span class="combo-effect">Fire + Fire</span>: Increases burn duration and damage</div>
                            <div>â€¢ <span class="combo-effect">Ice + Ice</span>: Higher chance to freeze enemy completely</div>
                            <div>â€¢ <span class="combo-effect">Lightning + Lightning</span>: Chance to stun enemy for 1 turn</div>
                            <div>â€¢ <span class="combo-effect">Fire + Lightning</span>: Creates explosion for additional area damage</div>
                            <div>â€¢ <span class="combo-effect">Ice + Lightning</span>: Creates storm effect that damages over time</div>
                        </div>
                        
                        <div class="elemental-combo">
                            <strong>Positioning Matters:</strong>
                            <div>â€¢ Close Range: +20% physical damage, -20% spell damage</div>
                            <div>â€¢ Medium Range: Balanced for all attacks</div>
                            <div>â€¢ Far Range: -20% physical damage, +20% spell damage</div>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>STATUS EFFECTS</h3>
                        <div class="spell-info">
                            <strong>Burn</strong>
                            <div>Effect: Takes 2 damage per turn for 3 turns</div>
                            <div>Caused by: Fire spells</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Freeze</strong>
                            <div>Effect: May skip turns for 2 turns</div>
                            <div>Caused by: Ice spells</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Shock</strong>
                            <div>Effect: Drains 5 mana per turn for 2 turns</div>
                            <div>Caused by: Lightning spells</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Poison</strong>
                            <div>Effect: Takes 3 damage per turn for 3 turns</div>
                            <div>Caused by: Dark spells</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-info">BACK</button>
            </div>
        </div>
        
        <!-- Daily Challenge Screen -->
        <div id="daily-challenge-screen" class="screen">
            <div class="header">
                <h2>DAILY CHALLENGE</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="daily-challenge-info">
                        <!-- Daily challenge info will be displayed here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-daily">BACK</button>
                <button id="start-daily-challenge">START CHALLENGE</button>
            </div>
        </div>
    </div>

    <script>
    // ============== ENHANCED GAME STATE ==============
    const gameState = {
        player: {
            name: "MERLIN",
            level: 1,
            xp: 0,
            nextLevel: 100,
            health: 50,
            maxHealth: 50,
            mana: 30,
            maxMana: 30,
            attack: 5,
            defense: 3,
            critical: 5,
            gold: 0,
            skillPoints: 0,
            position: "medium",
            statusEffects: [],
            spells: [
                { name: "Fireball", damage: 8, cost: 5, element: "fire", statusEffect: "burn", cooldown: 0, maxCooldown: 0 },
                { name: "Ice Shard", damage: 6, cost: 4, element: "ice", statusEffect: "freeze", cooldown: 0, maxCooldown: 0 },
                { name: "Lightning", damage: 10, cost: 7, element: "lightning", statusEffect: "shock", cooldown: 0, maxCooldown: 1 },
                { name: "Heal", heal: 10, cost: 6, element: "holy", cooldown: 0, maxCooldown: 2 }
            ],
            equipment: {
                weapon: { name: "Staff", damage: 2 },
                armor: { name: "Robes", defense: 1 }
            },
            inventory: [],
            unlockedSpells: [0, 1, 2, 3],
            comboCount: 0,
            lastSpellElement: null,
            skills: {
                fire_affinity: false,
                burning_rage: false,
                ice_affinity: false,
                deep_freeze: false,
                lightning_affinity: false,
                chain_reaction: false,
                mana_efficiency: false,
                critical_thinking: false
            }
        },
        currentEnemy: null,
        currentXpReward: 0,
        currentGoldReward: 0,
        battleLog: [],
        currentLoot: [],
        achievements: {
            first_blood: { name: "First Blood", description: "Defeat your first enemy", unlocked: false, reward: { gold: 50 } },
            elemental_master: { name: "Elemental Master", description: "Learn all elemental spells", unlocked: false, reward: { gold: 100 } },
            rich_wizard: { name: "Rich Wizard", description: "Collect 1000 gold", unlocked: false, reward: { gold: 200 } },
            combo_master: { name: "Combo Master", description: "Achieve a 5-spell combo", unlocked: false, reward: { gold: 75 } },
            dragon_slayer: { name: "Dragon Slayer", description: "Defeat the Ancient Dragon", unlocked: false, reward: { gold: 500 } },
            skill_master: { name: "Skill Master", description: "Unlock 5 skills", unlocked: false, reward: { gold: 150 } }
        },
        quests: {
            novice_wizard: {
                name: "Novice Wizard",
                description: "Defeat 3 enemies",
                type: "defeat_enemies",
                target: 3,
                progress: 0,
                completed: false,
                reward: { gold: 50, xp: 100 }
            },
            element_master: {
                name: "Element Master",
                description: "Use each element 5 times",
                type: "use_elements",
                progress: { fire: 0, ice: 0, lightning: 0 },
                target: 5,
                completed: false,
                reward: { skillPoint: 1 }
            },
            treasure_hunter: {
                name: "Treasure Hunter",
                description: "Collect 10 items",
                type: "collect_items",
                progress: 0,
                target: 10,
                completed: false,
                reward: { gold: 100 }
            }
        },
        dailyChallenge: {
            available: false,
            completed: false,
            progress: 0,
            required: 3,
            reward: { xp: 200, gold: 100 }
        },
        enemies: {
            fire: {
                name: "Fire Mage",
                level: 1,
                health: 40,
                maxHealth: 40,
                mana: 25,
                maxMana: 25,
                attack: 4,
                defense: 2,
                element: "fire",
                aiBehavior: "aggressive",
                preferredPosition: "close",
                spells: [
                    { name: "Fireball", damage: 8, cost: 5, element: "fire", statusEffect: "burn" },
                    { name: "Ember", damage: 4, cost: 3, element: "fire" }
                ],
                ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\`,
                xpReward: 25,
                goldReward: 10,
                lootTier: 1
            },
            ice: {
                name: "Ice Sorcerer",
                level: 2,
                health: 50,
                maxHealth: 50,
                mana: 30,
                maxMana: 30,
                attack: 5,
                defense: 3,
                element: "ice",
                aiBehavior: "defensive",
                preferredPosition: "far",
                spells: [
                    { name: "Ice Shard", damage: 6, cost: 4, element: "ice", statusEffect: "freeze" },
                    { name: "Frost Bolt", damage: 7, cost: 5, element: "ice" },
                    { name: "Ice Barrier", defense: 5, cost: 6, element: "ice", duration: 2 }
                ],
                ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\`,
                xpReward: 40,
                goldReward: 15,
                lootTier: 2
            },
            storm: {
                name: "Storm Caller",
                level: 3,
                health: 60,
                maxHealth: 60,
                mana: 35,
                maxMana: 35,
                attack: 6,
                defense: 4,
                element: "lightning",
                aiBehavior: "tactical",
                preferredPosition: "medium",
                spells: [
                    { name: "Lightning", damage: 10, cost: 7, element: "lightning", statusEffect: "shock" },
                    { name: "Wind Slash", damage: 5, cost: 4, element: "air" },
                    { name: "Chain Lightning", damage: 8, cost: 8, element: "lightning", chains: 2 }
                ],
                ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\`,
                xpReward: 60,
                goldReward: 20,
                lootTier: 3
            },
            necro: {
                name: "Necromancer",
                level: 4,
                health: 70,
                maxHealth: 70,
                mana: 40,
                maxMana: 40,
                attack: 7,
                defense: 5,
                element: "dark",
                aiBehavior: "strategic",
                preferredPosition: "medium",
                spells: [
                    { name: "Dark Bolt", damage: 9, cost: 6, element: "dark" },
                    { name: "Life Drain", damage: 6, heal: 3, cost: 5, element: "dark" },
                    { name: "Poison Cloud", damage: 4, cost: 4, element: "dark", statusEffect: "poison", duration: 3 }
                ],
                ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\`,
                xpReward: 80,
                goldReward: 25,
                lootTier: 4
            },
            dragon: {
                name: "Ancient Dragon",
                level: 10,
                health: 150,
                maxHealth: 150,
                mana: 80,
                maxMana: 80,
                attack: 12,
                defense: 8,
                element: "fire",
                aiBehavior: "adaptive",
                preferredPosition: "close",
                spells: [
                    { name: "Fire Breath", damage: 15, cost: 10, element: "fire", statusEffect: "burn" },
                    { name: "Dragon Claw", damage: 12, cost: 8 },
                    { name: "Tail Swipe", damage: 10, cost: 6, element: "physical", stun: true }
                ],
                ascii: `         __
        /  \\
       / ..|\\
      (_\\  |_)
      /  \\@'
     /     \\
    / *    \\
   :----....:
   (C   (C) `,
                xpReward: 200,
                goldReward: 100,
                lootTier: 5
            }
        },
        // FIXED: Enhanced elemental system with rock-paper-scissors
        elementalAdvantages: {
            fire: { strongVs: 'ice', weakVs: 'water' },
            ice: { strongVs: 'storm', weakVs: 'fire' },
            lightning: { strongVs: 'water', weakVs: 'earth' },
            water: { strongVs: 'fire', weakVs: 'lightning' },
            earth: { strongVs: 'lightning', weakVs: 'ice' }
        },
        statusEffects: {
            burn: { 
                name: "Burn", 
                damagePerTurn: 2, 
                duration: 3, 
                element: "fire",
                description: "Takes damage over time"
            },
            freeze: { 
                name: "Freeze", 
                skipTurns: 1, 
                duration: 2, 
                element: "ice",
                description: "Skips turns occasionally"
            },
            shock: { 
                name: "Shock", 
                manaDrain: 5, 
                duration: 2, 
                element: "lightning",
                description: "Drains mana each turn"
            },
            poison: {
                name: "Poison",
                damagePerTurn: 3,
                duration: 3,
                element: "dark",
                description: "Takes poison damage over time"
            }
        },
        lootItems: {
            weapons: [
                { name: "Crystal Wand", damage: 3, rarity: "common", type: "weapon" },
                { name: "Obsidian Staff", damage: 5, rarity: "rare", type: "weapon" },
                { name: "Dragonbone Rod", damage: 7, rarity: "epic", type: "weapon" },
                { name: "Elemental Scepter", damage: 8, critical: 10, rarity: "legendary", type: "weapon" }
            ],
            armor: [
                { name: "Mage Robes", defense: 2, rarity: "common", type: "armor" },
                { name: "Enchanted Cloak", defense: 3, rarity: "rare", type: "armor" },
                { name: "Arcane Armor", defense: 5, rarity: "epic", type: "armor" },
                { name: "Dragon Scale Mail", defense: 7, health: 20, rarity: "legendary", type: "armor" }
            ],
            potions: [
                { name: "Health Potion", type: "potion", potionType: "health", value: 20, rarity: "common" },
                { name: "Mana Potion", type: "potion", potionType: "mana", value: 15, rarity: "common" },
                { name: "Greater Health Potion", type: "potion", potionType: "health", value: 40, rarity: "rare" },
                { name: "Greater Mana Potion", type: "potion", potionType: "mana", value: 30, rarity: "rare" },
                { name: "Time Crystal", type: "special", effect: "freeze", value: 1, rarity: "epic", description: "Freeze enemy for 1 turn" },
                { name: "Mana Battery", type: "special", effect: "mana_boost", value: 10, rarity: "rare", description: "+10 mana regeneration for 3 turns" },
                { name: "Phoenix Feather", type: "special", effect: "revive", value: 50, rarity: "legendary", description: "Auto-revive with 50% health once" }
            ],
            spells: [
                { name: "Arcane Missile", damage: 12, cost: 8, rarity: "rare", type: "spell", element: "arcane" },
                { name: "Chain Lightning", damage: 15, cost: 10, rarity: "epic", type: "spell", element: "lightning" },
                { name: "Meteor Shower", damage: 20, cost: 15, rarity: "legendary", type: "spell", element: "fire" }
            ]
        },
        shopItems: [
            { name: "Health Potion", cost: 20, type: "potion", item: { name: "Health Potion", type: "potion", potionType: "health", value: 20, rarity: "common" } },
            { name: "Mana Potion", cost: 15, type: "potion", item: { name: "Mana Potion", type: "potion", potionType: "mana", value: 15, rarity: "common" } },
            { name: "Greater Health Potion", cost: 40, type: "potion", item: { name: "Greater Health Potion", type: "potion", potionType: "health", value: 40, rarity: "rare" } },
            { name: "Greater Mana Potion", cost: 35, type: "potion", item: { name: "Greater Mana Potion", type: "potion", potionType: "mana", value: 30, rarity: "rare" } },
            { name: "Time Crystal", cost: 100, type: "special", item: { name: "Time Crystal", type: "special", effect: "freeze", value: 1, rarity: "epic", description: "Freeze enemy for 1 turn" } },
            { name: "Mana Battery", cost: 75, type: "special", item: { name: "Mana Battery", type: "special", effect: "mana_boost", value: 10, rarity: "rare", description: "+10 mana regeneration for 3 turns" } }
        ],
        positionModifiers: {
            close: {
                physicalBonus: 1.2,
                spellBonus: 0.8,
                description: "Better for physical attacks"
            },
            medium: {
                physicalBonus: 1.0,
                spellBonus: 1.0,
                description: "Balanced for all attacks"
            },
            far: {
                physicalBonus: 0.8,
                spellBonus: 1.2,
                description: "Better for spell attacks"
            }
        },
        // NEW: Game settings
        settings: {
            soundEnabled: true,
            difficultyScaling: {
                enemyHealth: 1.0,
                enemyDamage: 1.0,
                goldReward: 1.0
            }
        },
        // NEW: Game statistics
        gameStats: {
            totalBattles: 0,
            victories: 0,
            spellsCast: {},
            goldEarned: 0,
            playTime: 0
        }
    };

    // ============== AUDIO SYSTEM ==============
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let soundEnabled = true;

    function playSound(frequency, duration, type = 'sine') {
        if (!soundEnabled) return;
        
        try {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        } catch (e) {
            console.log("Audio error:", e);
        }
    }

    const soundEffects = {
        spellCast: () => playSound(800, 0.1),
        damage: () => playSound(300, 0.2),
        heal: () => playSound(600, 0.3, 'sine'),
        victory: () => {
            playSound(1000, 0.2);
            setTimeout(() => playSound(1200, 0.2), 200);
            setTimeout(() => playSound(1400, 0.3), 400);
        },
        defeat: () => {
            playSound(200, 0.3);
            setTimeout(() => playSound(180, 0.3), 300);
            setTimeout(() => playSound(160, 0.4), 600);
        },
        levelUp: () => {
            playSound(800, 0.1);
            setTimeout(() => playSound(1000, 0.1), 100);
            setTimeout(() => playSound(1200, 0.2), 200);
        }
    };

    // ============== SAVE SYSTEM ==============
    function saveGame() {
        const saveData = {
            player: gameState.player,
            achievements: gameState.achievements,
            quests: gameState.quests,
            gameStats: gameState.gameStats,
            gold: gameState.player.gold,
            timestamp: Date.now()
        };
        localStorage.setItem('wizardDuelSave', JSON.stringify(saveData));
    }

    function loadGame() {
        const saveData = localStorage.getItem('wizardDuelSave');
        if (saveData) {
            try {
                const saved = JSON.parse(saveData);
                Object.assign(gameState.player, saved.player);
                Object.assign(gameState.achievements, saved.achievements);
                Object.assign(gameState.quests, saved.quests);
                Object.assign(gameState.gameStats, saved.gameStats);
                
                // Update UI
                updatePlayerProfile();
                updateSkillTree();
                addToLog("Game loaded successfully!");
            } catch (e) {
                console.error("Failed to load save:", e);
                addToLog("Failed to load saved game.");
            }
        }
    }

    function autoSave() {
        saveGame();
    }

    // ============== PROGRESSIVE DIFFICULTY ==============
    function updateDifficultyScaling() {
        const level = gameState.player.level;
        gameState.settings.difficultyScaling = {
            enemyHealth: 1 + (level * 0.1),
            enemyDamage: 1 + (level * 0.05),
            goldReward: 1 + (level * 0.2)
        };
    }

    // ============== SKILL TREE FIXES ==============
    function applySkillEffect(skillId) {
        const p = gameState.player;
        
        switch(skillId) {
            case 'fire_affinity':
                // Fire spells deal 10% more damage - handled in damage calculation
                addToLog("Fire spells now deal 10% more damage!");
                break;
            case 'burning_rage':
                // Burn effects last 1 additional turn - handled in status effect application
                addToLog("Burn effects now last 1 additional turn!");
                break;
            case 'ice_affinity':
                // Ice spells cost 1 less mana - handled in mana cost calculation
                addToLog("Ice spells now cost 1 less mana!");
                break;
            case 'deep_freeze':
                // Frozen enemies skip turns more often - handled in enemy turn processing
                addToLog("Frozen enemies now skip turns more often!");
                break;
            case 'lightning_affinity':
                p.critical += 5;
                addToLog("Lightning spells now have +5% critical chance!");
                break;
            case 'chain_reaction':
                // Lightning spells can jump to additional targets - handled in spell casting
                addToLog("Lightning spells can now chain to additional targets!");
                break;
            case 'mana_efficiency':
                // All spells cost 1 less mana - handled in mana cost calculation
                addToLog("All spells now cost 1 less mana!");
                break;
            case 'critical_thinking':
                p.critical += 5;
                addToLog("All spells now have +5% critical chance!");
                break;
        }
        
        updatePlayerProfile();
    }

    // ============== ENHANCED ELEMENTAL SYSTEM ==============
    function calculateElementalBonus(attackerElement, defenderElement) {
        let multiplier = 1;
        
        if (gameState.elementalAdvantages[attackerElement]) {
            if (gameState.elementalAdvantages[attackerElement].strongVs === defenderElement) {
                multiplier = 1.5; // 50% bonus
                if (attackerElement === "fire" && gameState.player.skills.fire_affinity) {
                    multiplier *= 1.1; // Additional 10% for fire affinity
                }
            } else if (gameState.elementalAdvantages[attackerElement].weakVs === defenderElement) {
                multiplier = 0.75; // 25% reduction
            }
        }
        
        return multiplier;
    }

    // ============== ENHANCED MANA COST CALCULATION ==============
    function calculateManaCost(baseCost, element = null) {
        let cost = baseCost;
        
        // Apply mana efficiency skill
        if (gameState.player.skills.mana_efficiency) {
            cost = Math.max(1, cost - 1);
        }
        
        // Apply ice affinity for ice spells
        if (element === "ice" && gameState.player.skills.ice_affinity) {
            cost = Math.max(1, cost - 1);
        }
        
        return cost;
    }

    // ============== ENHANCED STATUS EFFECT APPLICATION ==============
    function applyStatusEffect(target, effectType, duration = null) {
        const effect = gameState.statusEffects[effectType];
        if (!effect) return;
        
        let finalDuration = duration || effect.duration;
        
        // Apply skill modifications
        if (effectType === "burn" && gameState.player.skills.burning_rage) {
            finalDuration += 1;
        }
        
        if (effectType === "freeze" && gameState.player.skills.deep_freeze) {
            finalDuration += 1;
        }
        
        const existingEffect = target.statusEffects.find(e => e.type === effectType);
        if (existingEffect) {
            existingEffect.duration = finalDuration;
        } else {
            target.statusEffects.push({
                type: effectType,
                duration: finalDuration,
                ...effect
            });
        }
        
        updateStatusEffectsDisplay();
    }

    // ============== CHAIN LIGHTNING IMPLEMENTATION ==============
    function processChainLightning(damage, enemy) {
        if (gameState.player.skills.chain_reaction && Math.random() < 0.3) {
            const chainDamage = Math.floor(damage * 0.5);
            enemy.health -= chainDamage;
            addToLog(`Chain reaction! Additional ${chainDamage} damage!`);
            soundEffects.damage();
        }
    }

    // ============== QUEST SYSTEM ==============
    function updateQuestProgress(questType, data = null) {
        Object.keys(gameState.quests).forEach(questId => {
            const quest = gameState.quests[questId];
            if (quest.completed) return;
            
            switch(quest.type) {
                case 'defeat_enemies':
                    if (questType === 'defeat_enemy') {
                        quest.progress++;
                        if (quest.progress >= quest.target) {
                            completeQuest(questId);
                        }
                    }
                    break;
                case 'use_elements':
                    if (questType === 'use_element' && data && quest.progress[data]) {
                        quest.progress[data]++;
                        let allComplete = true;
                        Object.values(quest.progress).forEach(count => {
                            if (count < quest.target) allComplete = false;
                        });
                        if (allComplete) {
                            completeQuest(questId);
                        }
                    }
                    break;
                case 'collect_items':
                    if (questType === 'collect_item') {
                        quest.progress++;
                        if (quest.progress >= quest.target) {
                            completeQuest(questId);
                        }
                    }
                    break;
            }
        });
        
        updateQuestsScreen();
    }

    function completeQuest(questId) {
        const quest = gameState.quests[questId];
        quest.completed = true;
        
        // Apply rewards
        if (quest.reward.gold) {
            gameState.player.gold += quest.reward.gold;
            addToLog(`Quest completed! Received ${quest.reward.gold} gold.`);
        }
        if (quest.reward.xp) {
            gameState.player.xp += quest.reward.xp;
            addToLog(`Quest completed! Received ${quest.reward.xp} XP.`);
        }
        if (quest.reward.skillPoint) {
            gameState.player.skillPoints += quest.reward.skillPoint;
            addToLog(`Quest completed! Received ${quest.reward.skillPoint} skill point.`);
        }
        
        updatePlayerProfile();
    }

    function updateQuestsScreen() {
        const questsList = document.getElementById('quests-list');
        if (!questsList) return;
        
        questsList.innerHTML = '';
        
        Object.keys(gameState.quests).forEach(questId => {
            const quest = gameState.quests[questId];
            const questElement = document.createElement('div');
            questElement.className = `quest-item ${quest.completed ? 'quest-completed' : ''}`;
            
            let progressHtml = '';
            if (quest.type === 'use_elements') {
                progressHtml = `
                    <div>Fire: ${quest.progress.fire}/${quest.target}</div>
                    <div>Ice: ${quest.progress.ice}/${quest.target}</div>
                    <div>Lightning: ${quest.progress.lightning}/${quest.target}</div>
                `;
            } else {
                progressHtml = `
                    <div>Progress: ${quest.progress}/${quest.target}</div>
                    <div class="quest-progress">
                        <div class="quest-progress-fill" style="width: ${(quest.progress / quest.target) * 100}%"></div>
                    </div>
                `;
            }
            
            questElement.innerHTML = `
                <h3>${quest.name}</h3>
                <p>${quest.description}</p>
                ${progressHtml}
                <p><strong>Status: ${quest.completed ? 'COMPLETED' : 'IN PROGRESS'}</strong></p>
            `;
            
            questsList.appendChild(questElement);
        });
    }

    // ============== QUICK PLAY SYSTEM ==============
    function quickPlay() {
        // Select an appropriate enemy based on player level
        let availableEnemies = [];
        
        if (gameState.player.level <= 2) {
            availableEnemies = ['fire'];
        } else if (gameState.player.level <= 4) {
            availableEnemies = ['fire', 'ice'];
        } else if (gameState.player.level <= 6) {
            availableEnemies = ['ice', 'storm'];
        } else if (gameState.player.level <= 8) {
            availableEnemies = ['storm', 'necro'];
        } else {
            availableEnemies = ['necro', 'dragon'];
        }
        
        const randomEnemy = availableEnemies[Math.floor(Math.random() * availableEnemies.length)];
        startBattle(randomEnemy);
    }

    // ============== REST SYSTEM ==============
    function rest() {
        const manaRestore = Math.floor(gameState.player.maxMana * 0.5);
        const healthRestore = Math.floor(gameState.player.maxHealth * 0.25);
        
        gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + manaRestore);
        gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + healthRestore);
        
        // Clear status effects
        gameState.player.statusEffects = [];
        
        addToLog(`You rest and recover ${manaRestore} mana and ${healthRestore} health. Status effects cleared.`);
        updatePlayerProfile();
        showScreen('main-menu');
    }

    // ============== ENHANCED BATTLE SYSTEM ==============
    function castSpell(spellIndex) {
        const spell = gameState.player.spells[spellIndex];
        
        if (spell.cooldown > 0) {
            addToLog(`${spell.name} is on cooldown for ${spell.cooldown} more turns!`);
            return;
        }
        
        const manaCost = calculateManaCost(spell.cost, spell.element);
        
        if (gameState.player.mana < manaCost) {
            addToLog("Not enough mana!");
            return;
        }
        
        gameState.player.mana -= manaCost;
        document.getElementById('battle-player-mana').textContent = gameState.player.mana;
        document.getElementById('player-mana-fill').style.width = 
            `${(gameState.player.mana / gameState.player.maxMana) * 100}%`;
        
        if (spell.maxCooldown > 0) {
            spell.cooldown = spell.maxCooldown;
        }
        
        // Track spell usage for quests
        if (spell.element) {
            updateQuestProgress('use_element', spell.element);
            gameState.gameStats.spellsCast[spell.element] = (gameState.gameStats.spellsCast[spell.element] || 0) + 1;
        }
        
        updateComboCounter(spell.element);
        soundEffects.spellCast();
        
        if (spell.name === "Heal") {
            const positionBonus = getPositionBonus();
            const healAmount = Math.min(
                Math.floor(spell.heal * positionBonus.spellBonus), 
                gameState.player.maxHealth - gameState.player.health
            );
            gameState.player.health += healAmount;
            document.getElementById('battle-player-health').textContent = gameState.player.health;
            document.getElementById('player-health-fill').style.width = 
                `${(gameState.player.health / gameState.player.maxHealth) * 100}%`;
            addToLog(`You cast ${spell.name} and heal ${healAmount} health.`);
            soundEffects.heal();
        } else {
            const totalAttack = gameState.player.attack + gameState.player.equipment.weapon.damage;
            const elementalBonus = calculateElementalBonus(spell.element, gameState.currentEnemy.element);
            const positionBonus = getPositionBonus();
            const isCritical = calculateCriticalStrike();
            
            let baseDamage = spell.damage + totalAttack - gameState.currentEnemy.defense;
            baseDamage = Math.max(1, Math.floor(baseDamage * elementalBonus * positionBonus.spellBonus));
            
            const damage = isCritical ? Math.floor(baseDamage * 1.5) : baseDamage;
            
            gameState.currentEnemy.health -= damage;
            document.getElementById('battle-enemy-health').textContent = gameState.currentEnemy.health;
            document.getElementById('enemy-health-fill').style.width = 
                `${(gameState.currentEnemy.health / gameState.currentEnemy.maxHealth) * 100}%`;
            
            let logMessage = `You cast ${spell.name} and deal ${damage} damage.`;
            
            if (isCritical) {
                logMessage += ` <span class="critical-hit">CRITICAL HIT!</span>`;
                soundEffects.damage();
            }
            
            if (elementalBonus > 1) {
                logMessage += ` <span class="elemental-bonus">It's super effective!</span>`;
            } else if (elementalBonus < 1) {
                logMessage += ` <span class="elemental-bonus">It's not very effective...</span>`;
            }
            
            addToLog(logMessage);
            soundEffects.damage();
            
            // Process chain lightning if applicable
            if (spell.element === "lightning") {
                processChainLightning(damage, gameState.currentEnemy);
            }
            
            if (spell.statusEffect && Math.random() < 0.3) {
                let duration = gameState.statusEffects[spell.statusEffect].duration;
                applyStatusEffect(gameState.currentEnemy, spell.statusEffect, duration);
            }
        }
        
        updateSpellButtons();
        
        if (gameState.currentEnemy.health <= 0) {
            endBattle(true);
            return;
        }
        
        setTimeout(enemyTurn, 1000);
    }

    // ============== ENHANCED ENEMY TURN ==============
    function enemyTurn() {
        processStatusEffects(gameState.currentEnemy);
        
        const frozen = gameState.currentEnemy.statusEffects.find(e => e.type === 'freeze');
        let freezeChance = 0.5; // Base 50% chance to skip turn when frozen
        if (gameState.player.skills.deep_freeze) {
            freezeChance = 0.75; // 75% chance with deep freeze skill
        }
        
        if (frozen && Math.random() < freezeChance) {
            addToLog(`${gameState.currentEnemy.name} is frozen and cannot move!`);
            updateSpellButtons();
            return;
        }
        
        const spell = getEnemyAction();
        
        if (!spell) {
            const positionBonus = getPositionBonus();
            const damage = Math.max(1, Math.floor(
                (gameState.currentEnemy.attack - gameState.player.defense) * positionBonus.physicalBonus
            ));
            gameState.player.health -= damage;
            document.getElementById('battle-player-health').textContent = gameState.player.health;
            document.getElementById('player-health-fill').style.width = 
                `${(gameState.player.health / gameState.player.maxHealth) * 100}%`;
            addToLog(`${gameState.currentEnemy.name} attacks and deals ${damage} damage.`);
            soundEffects.damage();
        } else {
            gameState.currentEnemy.mana -= spell.cost;
            document.getElementById('battle-enemy-mana').textContent = gameState.currentEnemy.mana;
            document.getElementById('enemy-mana-fill').style.width = 
                `${(gameState.currentEnemy.mana / gameState.currentEnemy.maxMana) * 100}%`;
            
            if (spell.heal) {
                const healAmount = Math.min(spell.heal, gameState.currentEnemy.maxHealth - gameState.currentEnemy.health);
                gameState.currentEnemy.health += healAmount;
                document.getElementById('battle-enemy-health').textContent = gameState.currentEnemy.health;
                document.getElementById('enemy-health-fill').style.width = 
                    `${(gameState.currentEnemy.health / gameState.currentEnemy.maxHealth) * 100}%`;
                addToLog(`${gameState.currentEnemy.name} casts ${spell.name} and heals ${healAmount} health.`);
            } else if (spell.defense) {
                applyStatusEffect(gameState.currentEnemy, "defense_buff", spell.duration);
                addToLog(`${gameState.currentEnemy.name} casts ${spell.name} and gains +${spell.defense} defense.`);
            } else {
                const damage = Math.max(1, spell.damage + gameState.currentEnemy.attack - gameState.player.defense);
                gameState.player.health -= damage;
                document.getElementById('battle-player-health').textContent = gameState.player.health;
                document.getElementById('player-health-fill').style.width = 
                    `${(gameState.player.health / gameState.player.maxHealth) * 100}%`;
                addToLog(`${gameState.currentEnemy.name} casts ${spell.name} and deals ${damage} damage.`);
                soundEffects.damage();
                
                if (spell.statusEffect && Math.random() < 0.3) {
                    applyStatusEffect(gameState.player, spell.statusEffect);
                }
                
                if (spell.stun) {
                    applyStatusEffect(gameState.player, "freeze", 1);
                }
            }
        }
        
        if (gameState.player.health <= 0) {
            endBattle(false);
        } else {
            processStatusEffects(gameState.player);
            reduceCooldowns();
            updateSpellButtons();
        }
    }

    // ============== ENHANCED VICTORY ==============
    function endBattle(playerWon) {
        gameState.gameStats.totalBattles++;
        
        if (playerWon) {
            gameState.gameStats.victories++;
            addToLog(`You defeated ${gameState.currentEnemy.name}!`);
            
            // Apply difficulty scaling to rewards
            updateDifficultyScaling();
            const scaling = gameState.settings.difficultyScaling;
            
            const xpReward = Math.floor(gameState.currentEnemy.xpReward * scaling.goldReward);
            const goldReward = Math.floor(gameState.currentEnemy.goldReward * scaling.goldReward);
            
            gameState.currentXpReward = xpReward;
            gameState.currentGoldReward = goldReward;
            
            gameState.player.xp += xpReward;
            gameState.player.gold += goldReward;
            gameState.gameStats.goldEarned += goldReward;
            
            const skillPointChance = 0.2;
            if (Math.random() < skillPointChance) {
                gameState.player.skillPoints++;
                addToLog(`You gained a skill point!`);
            }
            
            addToLog(`You gained ${xpReward} XP and ${goldReward} gold!`);
            
            // Update quests
            updateQuestProgress('defeat_enemy');
            
            if (!gameState.achievements.first_blood.unlocked) {
                unlockAchievement('first_blood');
            }
            
            if (gameState.player.gold >= 1000 && !gameState.achievements.rich_wizard.unlocked) {
                unlockAchievement('rich_wizard');
            }
            
            if (gameState.currentEnemy.name === "Ancient Dragon" && !gameState.achievements.dragon_slayer.unlocked) {
                unlockAchievement('dragon_slayer');
            }
            
            const hasFire = gameState.player.spells.some(s => s.element === "fire");
            const hasIce = gameState.player.spells.some(s => s.element === "ice");
            const hasLightning = gameState.player.spells.some(s => s.element === "lightning");
            if (hasFire && hasIce && hasLightning && !gameState.achievements.elemental_master.unlocked) {
                unlockAchievement('elemental_master');
            }
            
            const loot = generateLoot(gameState.currentEnemy.lootTier);
            
            const manaRestore = Math.floor(gameState.player.maxMana * 0.25);
            gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + manaRestore);
            addToLog(`You recovered ${manaRestore} mana.`);
            
            gameState.player.comboCount = 0;
            gameState.player.lastSpellElement = null;
            gameState.player.spells.forEach(spell => {
                spell.cooldown = 0;
            });
            updateComboDisplay();
            
            if (loot.length > 0) {
                updateQuestProgress('collect_item');
                setTimeout(() => showLootScreen(loot), 1500);
            } else {
                setTimeout(() => showVictoryScreen(), 1500);
            }
            
            updatePlayerProfile();
            soundEffects.victory();
        } else {
            addToLog("You have been defeated!");
            setTimeout(() => showDefeatScreen(), 1500);
            soundEffects.defeat();
        }
        
        // Auto-save after battle
        autoSave();
    }

    // ============== KEYBOARD SHORTCUTS ==============
    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Only process number keys 1-4 in battle screen
            if (document.getElementById('battle-screen').classList.contains('active')) {
                const keyMap = { '1': 0, '2': 1, '3': 2, '4': 3 };
                if (keyMap[e.key] !== undefined) {
                    const spellIndex = keyMap[e.key];
                    const spell = gameState.player.spells[spellIndex];
                    
                    // Check if spell is available and has no cooldown
                    if (spell && spell.cooldown === 0) {
                        const manaCost = calculateManaCost(spell.cost, spell.element);
                        if (gameState.player.mana >= manaCost) {
                            castSpell(spellIndex);
                        }
                    }
                }
            }
            
            // Quick access to main menu with Escape
            if (e.key === 'Escape') {
                if (document.getElementById('battle-screen').classList.contains('active')) {
                    document.getElementById('flee').click();
                } else {
                    showScreen('main-menu');
                }
            }
        });
    }

    // ============== DOM ELEMENTS AND INITIALIZATION ==============
    const screens = {
        mainMenu: document.getElementById('main-menu'),
        playerProfile: document.getElementById('player-profile-screen'),
        skillTree: document.getElementById('skill-tree-screen'),
        enemySelection: document.getElementById('enemy-selection'),
        battle: document.getElementById('battle-screen'),
        victory: document.getElementById('victory-screen'),
        loot: document.getElementById('loot-screen'),
        defeat: document.getElementById('defeat-screen'),
        upgrade: document.getElementById('upgrade-screen'),
        consumables: document.getElementById('consumables-screen'),
        inventory: document.getElementById('inventory-screen'),
        shop: document.getElementById('shop-screen'),
        achievements: document.getElementById('achievements-screen'),
        quests: document.getElementById('quests-screen'),
        info: document.getElementById('info-screen'),
        dailyChallenge: document.getElementById('daily-challenge-screen')
    };

    // Initialize the game
    document.addEventListener('DOMContentLoaded', function() {
        // Load saved game
        loadGame();
        
        // Initialize UI
        updatePlayerProfile();
        updateEnemySelection();
        generateDailyChallenge();
        updateSkillTree();
        updateQuestsScreen();
        setupKeyboardShortcuts();

        // Set up sound toggle
        document.getElementById('toggle-sound').addEventListener('click', function() {
            soundEnabled = !soundEnabled;
            this.textContent = soundEnabled ? "ðŸ”Š Sound: ON" : "ðŸ”‡ Sound: OFF";
        });

        // Main menu buttons
        document.getElementById('new-game').addEventListener('click', () => { 
            if (confirm("Start a new game? This will erase your current progress.")) {
                resetGame(); 
                showScreen('enemySelection');
            }
        });
        
        document.getElementById('quick-play').addEventListener('click', () => { 
            quickPlay();
        });
        
        document.getElementById('player-profile').addEventListener('click', () => { 
            updatePlayerProfile(); 
            showScreen('playerProfile');
        });
        
        document.getElementById('skill-tree-btn').addEventListener('click', () => {
            updateSkillTree();
            showScreen('skillTree');
        });
        
        document.getElementById('select-enemy').addEventListener('click', () => { 
            updateEnemySelection(); 
            showScreen('enemySelection');
        });
        
        document.getElementById('use-consumables').addEventListener('click', () => {
            updateConsumablesScreen();
            showScreen('consumables');
        });
        
        document.getElementById('shop-btn').addEventListener('click', () => {
            updateShopScreen();
            showScreen('shop');
        });
        
        document.getElementById('achievements-btn').addEventListener('click', () => {
            updateAchievementsScreen();
            showScreen('achievements');
        });
        
        document.getElementById('quests-btn').addEventListener('click', () => {
            updateQuestsScreen();
            showScreen('quests');
        });
        
        document.getElementById('rest-btn').addEventListener('click', () => {
            rest();
        });
        
        document.getElementById('info-btn').addEventListener('click', () => {
            showScreen('info');
        });
        
        document.getElementById('daily-challenge-btn').addEventListener('click', () => {
            updateDailyChallengeDisplay();
            showScreen('daily-challenge');
        });

        // Navigation buttons
        document.getElementById('back-from-profile').addEventListener('click', () => showScreen('mainMenu'));
        document.getElementById('back-from-skills').addEventListener('click', () => showScreen('mainMenu'));
        document.getElementById('back-from-enemies').addEventListener('click', () => showScreen('mainMenu'));
        document.getElementById('back-from-quests').addEventListener('click', () => showScreen('mainMenu'));
        document.getElementById('back-from-info').addEventListener('click', () => showScreen('mainMenu'));
        
        document.getElementById('flee').addEventListener('click', () => {
            addToLog("You fled from the battle!");
            const manaRestore = Math.floor(gameState.player.maxMana * 0.5);
            gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + manaRestore);
            addToLog(`You recovered ${manaRestore} mana while fleeing.`);
            setTimeout(() => showScreen('mainMenu'), 1000);
            autoSave();
        });
        
        document.getElementById('continue-after-victory').addEventListener('click', () => {
            completeDailyChallenge();
            
            if (gameState.player.xp >= gameState.player.nextLevel) {
                showScreen('upgrade');
                soundEffects.levelUp();
            } else {
                showScreen('mainMenu');
            }
            autoSave();
        });
        
        document.getElementById('try-again').addEventListener('click', () => {
            restoreAfterDefeat();
            showScreen('enemySelection');
        });
        
        document.getElementById('main-menu-after-defeat').addEventListener('click', () => {
            restoreAfterDefeat();
            showScreen('mainMenu');
        });

        // Loot screen
        document.getElementById('take-loot').addEventListener('click', () => takeLoot());

        // Consumables screen
        document.getElementById('back-from-consumables').addEventListener('click', () => showScreen('mainMenu'));

        // Shop screen
        document.getElementById('back-from-shop').addEventListener('click', () => showScreen('mainMenu'));

        // Achievements screen
        document.getElementById('back-from-achievements').addEventListener('click', () => showScreen('mainMenu'));

        // Daily challenge screen
        document.getElementById('back-from-daily').addEventListener('click', () => showScreen('mainMenu'));
        document.getElementById('start-daily-challenge').addEventListener('click', () => showScreen('enemySelection'));

        // Skill tree buttons
        document.querySelectorAll('.skill-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const skillId = btn.dataset.skill;
                learnSkill(skillId);
            });
        });

        // Position buttons in battle
        document.querySelectorAll('.position-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const position = btn.dataset.position;
                changePosition(position);
            });
        });

        // Upgrade buttons
        document.querySelectorAll('.upgrade-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const upgradeType = btn.dataset.upgrade;
                applyUpgrade(upgradeType);
            });
        });

        // Inventory management button
        document.getElementById('manage-inventory').addEventListener('click', () => {
            updateInventoryScreen();
            showScreen('inventory');
        });

        // Back button for inventory screen
        document.getElementById('back-from-inventory').addEventListener('click', () => showScreen('playerProfile'));

        // Make functions globally available
        window.showScreen = showScreen;
    });

    // Include all the original functions that haven't been modified...
    // [The rest of the original functions remain the same but now use the enhanced systems]

    // ============== ORIGINAL FUNCTIONS (with minor enhancements) ==============

    function updatePlayerProfile() {
        const p = gameState.player;
        document.getElementById('player-name').textContent = p.name;
        document.getElementById('player-level').textContent = p.level;
        document.getElementById('player-xp').textContent = p.xp;
        document.getElementById('player-next-level').textContent = p.nextLevel;
        document.getElementById('player-xp-bar').style.width = `${(p.xp / p.nextLevel) * 100}%`;
        document.getElementById('player-health').textContent = p.health;
        document.getElementById('player-max-health').textContent = p.maxHealth;
        document.getElementById('player-mana').textContent = p.mana;
        document.getElementById('player-max-mana').textContent = p.maxMana;
        document.getElementById('player-attack').textContent = p.attack;
        document.getElementById('player-defense').textContent = p.defense;
        document.getElementById('player-critical').textContent = p.critical;
        document.getElementById('player-gold').textContent = p.gold;
        document.getElementById('player-skill-points').textContent = p.skillPoints;
        document.getElementById('player-position').textContent = p.position.charAt(0).toUpperCase() + p.position.slice(1);
        document.getElementById('player-weapon').textContent = p.equipment.weapon.name;
        document.getElementById('player-weapon-dmg').textContent = p.equipment.weapon.damage;
        document.getElementById('player-armor').textContent = p.equipment.armor.name;
        document.getElementById('player-armor-def').textContent = p.equipment.armor.defense;
        
        document.getElementById('gold-amount').textContent = p.gold;
        document.getElementById('skill-points-amount').textContent = p.skillPoints;
        
        const unlockedCount = Object.values(gameState.achievements).filter(a => a.unlocked).length;
        document.getElementById('player-achievements').textContent = unlockedCount;
        
        updateProfileInventoryDisplay();
        updateSpellDisplay();
        updateStatusEffectsDisplay();
    }

    function updateProfileInventoryDisplay() {
        const inventoryElement = document.getElementById('player-inventory-items');
        inventoryElement.innerHTML = '';
        
        if (gameState.player.inventory.length === 0) {
            inventoryElement.innerHTML = '<div class="inventory-empty">No items in inventory</div>';
            return;
        }
        
        gameState.player.inventory.forEach((item, index) => {
            const itemElement = document.createElement('div');
            itemElement.className = `compact-item item-${item.rarity}`;
            
            let itemText = `${item.name}`;
            if (item.type === 'weapon') {
                itemText += ` (DMG +${item.damage})`;
            } else if (item.type === 'armor') {
                itemText += ` (DEF +${item.defense})`;
            } else if (item.type === 'potion') {
                itemText += ` (${item.value} ${item.potionType})`;
            } else if (item.type === 'spell') {
                itemText += ` (DMG: ${item.damage}, Cost: ${item.cost})`;
            }
            
            const textElement = document.createElement('div');
            textElement.textContent = itemText;
            itemElement.appendChild(textElement);
            
            inventoryElement.appendChild(itemElement);
        });
    }

    function updateSpellDisplay() {
        const profileSpells = document.getElementById('profile-spells');
        profileSpells.innerHTML = '';
        
        const battleSpells = document.getElementById('battle-spells');
        battleSpells.innerHTML = '';
        
        gameState.player.unlockedSpells.forEach(spellIndex => {
            const spell = gameState.player.spells[spellIndex];
            
            const profileSpellElement = document.createElement('div');
            profileSpellElement.className = 'spell';
            profileSpellElement.innerHTML = `
                <button>${spell.name}</button>
                <div>${spell.heal ? `Heal: ${spell.heal}` : `DMG: ${spell.damage}`} | Cost: ${spell.cost} | Element: ${spell.element || 'None'}</div>
            `;
            profileSpells.appendChild(profileSpellElement);
            
            const button = document.createElement('button');
            button.className = 'spell-btn';
            button.setAttribute('data-spell', spellIndex);
            
            // Show cooldown if applicable
            if (spell.cooldown > 0) {
                button.textContent = `${spell.name} (CD: ${spell.cooldown})`;
                button.disabled = true;
            } else {
                const manaCost = calculateManaCost(spell.cost, spell.element);
                button.textContent = `${spell.name} (${manaCost} MP)`;
            }
            
            button.addEventListener('click', () => {
                castSpell(spellIndex);
            });
            
            battleSpells.appendChild(button);
        });
    }

    function updateBattleConsumables() {
        const consumablesElement = document.getElementById('battle-consumables');
        consumablesElement.innerHTML = '';
        
        const potionIndices = [];
        gameState.player.inventory.forEach((item, index) => {
            if (item.type === 'potion') {
                potionIndices.push(index);
            }
        });
        
        if (potionIndices.length === 0) {
            consumablesElement.style.display = 'none';
            return;
        }
        
        consumablesElement.style.display = 'flex';
        
        potionIndices.forEach(inventoryIndex => {
            const potion = gameState.player.inventory[inventoryIndex];
            const button = document.createElement('button');
            button.className = 'consumable-btn';
            button.textContent = `${potion.name}`;
            button.onclick = () => useConsumable(inventoryIndex);
            consumablesElement.appendChild(button);
        });
    }

    function updateStatusEffectsDisplay() {
        const playerEffectsElement = document.getElementById('player-status-effects');
        const playerBattleEffectsElement = document.getElementById('player-status-effects-battle');
        const enemyEffectsElement = document.getElementById('enemy-status-effects');
        
        if (playerEffectsElement) playerEffectsElement.innerHTML = '';
        if (playerBattleEffectsElement) playerBattleEffectsElement.innerHTML = '';
        if (enemyEffectsElement) enemyEffectsElement.innerHTML = '';
        
        gameState.player.statusEffects.forEach(effect => {
            const effectElement = document.createElement('span');
            effectElement.className = `status-effect status-${effect.type}`;
            effectElement.textContent = effect.name;
            effectElement.title = effect.description;
            
            if (playerEffectsElement) playerEffectsElement.appendChild(effectElement);
            if (playerBattleEffectsElement) playerBattleEffectsElement.appendChild(effectElement.cloneNode(true));
        });
        
        if (gameState.currentEnemy && gameState.currentEnemy.statusEffects) {
            gameState.currentEnemy.statusEffects.forEach(effect => {
                const effectElement = document.createElement('span');
                effectElement.className = `status-effect status-${effect.type}`;
                effectElement.textContent = effect.name;
                effectElement.title = effect.description;
                
                if (enemyEffectsElement) enemyEffectsElement.appendChild(effectElement);
            });
        }
    }

    function updateComboDisplay() {
        const comboCounterMain = document.getElementById('combo-counter-main');
        const comboCounterBattle = document.getElementById('combo-counter-battle');
        
        if (gameState.player.comboCount > 1) {
            const comboText = `Combo: x${gameState.player.comboCount}`;
            if (comboCounterMain) {
                comboCounterMain.textContent = comboText;
                comboCounterMain.style.display = 'block';
            }
            if (comboCounterBattle) {
                comboCounterBattle.textContent = comboText;
                comboCounterBattle.style.display = 'block';
            }
        } else {
            if (comboCounterMain) comboCounterMain.style.display = 'none';
            if (comboCounterBattle) comboCounterBattle.style.display = 'none';
        }
    }

    function updateSkillTree() {
        document.getElementById('available-skill-points').textContent = gameState.player.skillPoints;
        
        Object.keys(gameState.player.skills).forEach(skillId => {
            const skillElement = document.getElementById(`skill-${skillId.replace('_', '-')}`);
            if (!skillElement) return;
            
            const button = skillElement.querySelector('.skill-btn');
            
            if (gameState.player.skills[skillId]) {
                skillElement.classList.add('unlocked');
                skillElement.classList.remove('locked');
                button.textContent = 'Learned';
                button.disabled = true;
            } else {
                const cost = parseInt(button.dataset.cost);
                if (gameState.player.skillPoints >= cost) {
                    button.disabled = false;
                    button.textContent = `Learn (${cost} point${cost > 1 ? 's' : ''})`;
                } else {
                    button.disabled = true;
                    button.textContent = `Learn (${cost} point${cost > 1 ? 's' : ''})`;
                }
            }
        });
    }

    function learnSkill(skillId) {
        const button = document.querySelector(`[data-skill="${skillId}"]`);
        const cost = parseInt(button.dataset.cost);
        
        if (gameState.player.skillPoints < cost) {
            addToLog("Not enough skill points!");
            return;
        }
        
        gameState.player.skillPoints -= cost;
        gameState.player.skills[skillId] = true;
        
        applySkillEffect(skillId);
        
        addToLog(`Learned skill: ${skillId.replace('_', ' ').toUpperCase()}!`);
        
        const learnedSkills = Object.values(gameState.player.skills).filter(s => s).length;
        if (learnedSkills >= 5 && !gameState.achievements.skill_master.unlocked) {
            unlockAchievement('skill_master');
        }
        
        updatePlayerProfile();
        updateSkillTree();
        autoSave();
    }

    function changePosition(newPosition) {
        gameState.player.position = newPosition;
        document.getElementById('battle-player-position').textContent = newPosition.charAt(0).toUpperCase() + newPosition.slice(1);
        addToLog(`You move to ${newPosition} range.`);
    }

    function getPositionBonus() {
        return gameState.positionModifiers[gameState.player.position];
    }

    function calculateCriticalStrike() {
        const criticalChance = gameState.player.critical;
        return Math.random() * 100 < criticalChance;
    }

    function getEnemyAction() {
        const enemy = gameState.currentEnemy;
        const affordableSpells = enemy.spells.filter(spell => 
            enemy.mana >= (spell.cost || 0)
        );
        
        switch(enemy.aiBehavior) {
            case "aggressive":
                return getAggressiveAction(affordableSpells);
            case "defensive":
                return getDefensiveAction(affordableSpells);
            case "tactical":
                return getTacticalAction(affordableSpells);
            case "strategic":
                return getStrategicAction(affordableSpells);
            case "adaptive":
                return getAdaptiveAction(affordableSpells);
            default:
                return getDefaultAction(affordableSpells);
        }
    }

    function getAggressiveAction(spells) {
        const damageSpells = spells.filter(s => s.damage);
        if (damageSpells.length > 0) {
            return damageSpells.reduce((max, spell) => 
                spell.damage > max.damage ? spell : max
            );
        }
        return spells[0] || null;
    }

    function getDefensiveAction(spells) {
        if (gameState.currentEnemy.health < gameState.currentEnemy.maxHealth * 0.5) {
            const healSpells = spells.filter(s => s.heal);
            if (healSpells.length > 0) return healSpells[0];
            
            const defenseSpells = spells.filter(s => s.defense);
            if (defenseSpells.length > 0) return defenseSpells[0];
        }
        
        return spells[0] || null;
    }

    function getTacticalAction(spells) {
        const playerHealthPercent = gameState.player.health / gameState.player.maxHealth;
        const enemyHealthPercent = gameState.currentEnemy.health / gameState.currentEnemy.maxHealth;
        
        if (enemyHealthPercent < 0.3) {
            const healSpells = spells.filter(s => s.heal);
            if (healSpells.length > 0) return healSpells[0];
        }
        
        if (playerHealthPercent < 0.3) {
            const finishingSpells = spells.filter(s => s.damage > 8);
            if (finishingSpells.length > 0) return finishingSpells[0];
        }
        
        return spells[Math.floor(Math.random() * spells.length)] || null;
    }

    function getStrategicAction(spells) {
        const statusSpells = spells.filter(s => s.statusEffect);
        if (statusSpells.length > 0 && Math.random() < 0.6) {
            return statusSpells[Math.floor(Math.random() * statusSpells.length)];
        }
        
        return spells[0] || null;
    }

    function getAdaptiveAction(spells) {
        if (gameState.player.comboCount > 2) {
            const disruptiveSpells = spells.filter(s => s.statusEffect === "freeze" || s.stun);
            if (disruptiveSpells.length > 0) return disruptiveSpells[0];
        }
        
        return getTacticalAction(spells);
    }

    function getDefaultAction(spells) {
        return spells[0] || null;
    }

    function startBattle(enemyType) {
        gameState.currentEnemy = JSON.parse(JSON.stringify(gameState.enemies[enemyType]));
        gameState.currentEnemy.statusEffects = [];
        
        // Apply difficulty scaling to enemy stats
        const scaling = gameState.settings.difficultyScaling;
        gameState.currentEnemy.health = Math.floor(gameState.currentEnemy.health * scaling.enemyHealth);
        gameState.currentEnemy.maxHealth = Math.floor(gameState.currentEnemy.maxHealth * scaling.enemyHealth);
        gameState.currentEnemy.attack = Math.floor(gameState.currentEnemy.attack * scaling.enemyDamage);
        
        document.getElementById('enemy-name').textContent = gameState.currentEnemy.name;
        document.getElementById('enemy-ai-behavior').textContent = `AI: ${gameState.currentEnemy.aiBehavior.charAt(0).toUpperCase() + gameState.currentEnemy.aiBehavior.slice(1)}`;
        document.getElementById('enemy-ascii').textContent = gameState.currentEnemy.ascii;
        document.getElementById('battle-enemy-health').textContent = gameState.currentEnemy.health;
        document.getElementById('battle-enemy-max-health').textContent = gameState.currentEnemy.maxHealth;
        document.getElementById('battle-enemy-mana').textContent = gameState.currentEnemy.mana;
        document.getElementById('battle-enemy-max-mana').textContent = gameState.currentEnemy.maxMana;
        
        document.getElementById('battle-player-health').textContent = gameState.player.health;
        document.getElementById('battle-player-max-health').textContent = gameState.player.maxHealth;
        document.getElementById('battle-player-mana').textContent = gameState.player.mana;
        document.getElementById('battle-player-max-mana').textContent = gameState.player.maxMana;
        document.getElementById('battle-player-position').textContent = gameState.player.position.charAt(0).toUpperCase() + gameState.player.position.slice(1);
        
        document.getElementById('player-health-fill').style.width = `${(gameState.player.health / gameState.player.maxHealth) * 100}%`;
        document.getElementById('player-mana-fill').style.width = `${(gameState.player.mana / gameState.player.maxMana) * 100}%`;
        document.getElementById('enemy-health-fill').style.width = '100%';
        document.getElementById('enemy-mana-fill').style.width = '100%';
        
        gameState.battleLog = ["A wizard duel begins!"];
        updateBattleLog();
        
        updateSpellButtons();
        updateBattleConsumables();
        updateStatusEffectsDisplay();
        updateComboDisplay();
        
        showScreen('battle');
    }

    function reduceCooldowns() {
        gameState.player.spells.forEach(spell => {
            if (spell.cooldown > 0) {
                spell.cooldown--;
            }
        });
    }

    function updateSpellButtons() {
        const spellButtons = document.querySelectorAll('.spell-btn');
        const manaWarning = document.getElementById('mana-warning');
        const healthWarning = document.getElementById('health-warning');
        let hasEnoughMana = false;
        
        spellButtons.forEach(button => {
            const spellIndex = parseInt(button.dataset.spell);
            const spell = gameState.player.spells[spellIndex];
            
            const manaCost = calculateManaCost(spell.cost, spell.element);
            
            if (gameState.player.mana >= manaCost && spell.cooldown === 0) {
                button.disabled = false;
                hasEnoughMana = true;
                
                if (spell.cooldown > 0) {
                    button.textContent = `${spell.name} (CD: ${spell.cooldown})`;
                } else {
                    button.textContent = `${spell.name} (${manaCost} MP)`;
                }
            } else {
                button.disabled = true;
                if (spell.cooldown > 0) {
                    button.textContent = `${spell.name} (CD: ${spell.cooldown})`;
                } else {
                    button.textContent = `${spell.name} (${manaCost} MP)`;
                }
            }
        });
        
        manaWarning.style.display = !hasEnoughMana && gameState.player.mana > 0 ? 'block' : 'none';
        healthWarning.style.display = gameState.player.health <= gameState.player.maxHealth * 0.3 ? 'block' : 'none';
    }

    function processStatusEffects(target) {
        if (!target.statusEffects || target.statusEffects.length === 0) return;
        
        const effectsToRemove = [];
        
        target.statusEffects.forEach((effect, index) => {
            if (effect.damagePerTurn) {
                target.health -= effect.damagePerTurn;
                addToLog(`${target.name} takes ${effect.damagePerTurn} damage from ${effect.name}!`);
            }
            
            if (effect.manaDrain) {
                target.mana = Math.max(0, target.mana - effect.manaDrain);
                addToLog(`${target.name} loses ${effect.manaDrain} mana from ${effect.name}!`);
            }
            
            effect.duration--;
            
            if (effect.duration <= 0) {
                effectsToRemove.push(index);
                addToLog(`${effect.name} wears off from ${target.name}.`);
            }
        });
        
        effectsToRemove.reverse().forEach(index => {
            target.statusEffects.splice(index, 1);
        });
        
        updateStatusEffectsDisplay();
    }

    function updateComboCounter(spellElement) {
        if (gameState.player.lastSpellElement === spellElement) {
            gameState.player.comboCount++;
        } else {
            gameState.player.comboCount = 1;
        }
        gameState.player.lastSpellElement = spellElement;
        
        if (gameState.player.comboCount >= 5 && !gameState.achievements.combo_master.unlocked) {
            unlockAchievement('combo_master');
        }
        
        updateComboDisplay();
    }

    function showVictoryScreen() {
        const xpReward = gameState.currentEnemy ? gameState.currentEnemy.xpReward : gameState.currentXpReward;
        const goldReward = gameState.currentEnemy ? gameState.currentEnemy.goldReward : gameState.currentGoldReward;
        
        document.getElementById('victory-xp').textContent = `XP Gained: ${xpReward}`;
        document.getElementById('victory-gold').textContent = `Gold Gained: ${goldReward}`;
        document.getElementById('victory-message').textContent = `You have defeated ${gameState.currentEnemy.name}!`;
        
        const hadSkillPoints = gameState.player.skillPoints - (Math.random() < 0.2 ? 1 : 0);
        if (gameState.player.skillPoints > hadSkillPoints) {
            document.getElementById('victory-skill-points').style.display = 'block';
        } else {
            document.getElementById('victory-skill-points').style.display = 'none';
        }
        
        if (gameState.player.xp >= gameState.player.nextLevel) {
            document.getElementById('victory-level-up').style.display = 'block';
            document.getElementById('new-level').textContent = gameState.player.level + 1;
        } else {
            document.getElementById('victory-level-up').style.display = 'none';
        }
        
        showScreen('victory');
    }

    function showDefeatScreen() {
        document.getElementById('defeat-enemy').textContent = `Defeated by: ${gameState.currentEnemy.name}`;
        document.getElementById('defeat-level').textContent = `Your Level: ${gameState.player.level}`;
        document.getElementById('defeat-xp').textContent = `Current XP: ${gameState.player.xp}`;
        
        showScreen('defeat');
    }

    function applyUpgrade(upgradeType) {
        switch(upgradeType) {
            case 'health':
                gameState.player.maxHealth += 10;
                gameState.player.health = gameState.player.maxHealth;
                break;
            case 'mana':
                gameState.player.maxMana += 5;
                gameState.player.mana = gameState.player.maxMana;
                break;
            case 'attack':
                gameState.player.attack += 2;
                break;
            case 'defense':
                gameState.player.defense += 2;
                break;
        }
        
        gameState.player.level++;
        gameState.player.xp = 0;
        gameState.player.nextLevel = Math.floor(gameState.player.nextLevel * 1.5);
        
        updatePlayerProfile();
        showScreen('main-menu');
        autoSave();
    }

    function useConsumable(index) {
        const item = gameState.player.inventory[index];
        
        if (!item) return;
        
        if (item.type === 'potion') {
            if (item.potionType === 'health') {
                const healAmount = Math.min(item.value, gameState.player.maxHealth - gameState.player.health);
                gameState.player.health += healAmount;
                addToLog(`You used ${item.name} and healed ${healAmount} health!`);
                soundEffects.heal();
            } else if (item.potionType === 'mana') {
                const manaAmount = Math.min(item.value, gameState.player.maxMana - gameState.player.mana);
                gameState.player.mana += manaAmount;
                addToLog(`You used ${item.name} and restored ${manaAmount} mana!`);
            }
        } 
        else if (item.type === 'special') {
            switch(item.effect) {
                case 'freeze':
                    if (gameState.currentEnemy) {
                        applyStatusEffect(gameState.currentEnemy, "freeze", item.value);
                        addToLog(`You used ${item.name} and froze the enemy for ${item.value} turn!`);
                    }
                    break;
                case 'mana_boost':
                    addToLog(`You used ${item.name} and gained mana regeneration!`);
                    break;
                case 'revive':
                    addToLog(`You used ${item.name} - you will automatically revive if defeated!`);
                    break;
            }
        }
        
        gameState.player.inventory.splice(index, 1);
        
        updatePlayerProfile();
        updateBattleConsumables();
        updateConsumablesScreen();
        updateInventoryScreen();
        
        if (document.getElementById('battle-player-health')) {
            document.getElementById('battle-player-health').textContent = gameState.player.health;
            document.getElementById('battle-player-mana').textContent = gameState.player.mana;
            document.getElementById('player-health-fill').style.width = 
                `${(gameState.player.health / gameState.player.maxHealth) * 100}%`;
            document.getElementById('player-mana-fill').style.width = 
                `${(gameState.player.mana / gameState.player.maxMana) * 100}%`;
        }
        
        autoSave();
    }

    function equipItem(index) {
        const item = gameState.player.inventory[index];
        
        if (item.type === 'weapon') {
            const oldWeapon = {...gameState.player.equipment.weapon, type: 'weapon', rarity: 'common'};
            
            gameState.player.equipment.weapon = {
                name: item.name,
                damage: item.damage
            };
            
            gameState.player.inventory[index] = oldWeapon;
            
            addToLog(`You equipped ${item.name}!`);
        } 
        else if (item.type === 'armor') {
            const oldArmor = {...gameState.player.equipment.armor, type: 'armor', rarity: 'common'};
            
            gameState.player.equipment.armor = {
                name: item.name,
                defense: item.defense
            };
            
            gameState.player.inventory[index] = oldArmor;
            
            addToLog(`You equipped ${item.name}!`);
        }
        else if (item.type === 'spell') {
            const spellExists = gameState.player.spells.some(spell => spell.name === item.name);
            if (!spellExists) {
                gameState.player.spells.push({
                    name: item.name,
                    damage: item.damage,
                    cost: item.cost,
                    element: item.element || "arcane"
                });
                gameState.player.unlockedSpells.push(gameState.player.spells.length - 1);
                
                gameState.player.inventory.splice(index, 1);
                
                addToLog(`You learned ${item.name}!`);
            } else {
                addToLog(`You already know ${item.name}!`);
                return;
            }
        }
        
        updatePlayerProfile();
        updateInventoryScreen();
        autoSave();
    }

    function updateConsumablesScreen() {
        const consumablesList = document.getElementById('consumables-list');
        consumablesList.innerHTML = '';
        
        const potionIndices = [];
        gameState.player.inventory.forEach((item, index) => {
            if (item.type === 'potion' || item.type === 'special') {
                potionIndices.push(index);
            }
        });
        
        if (potionIndices.length === 0) {
            consumablesList.innerHTML = '<div class="inventory-empty">No consumables in inventory</div>';
            return;
        }
        
        potionIndices.forEach(inventoryIndex => {
            const potion = gameState.player.inventory[inventoryIndex];
            const itemElement = document.createElement('div');
            itemElement.className = `compact-item item-${potion.rarity}`;
            
            const textElement = document.createElement('div');
            let itemText = `${potion.name}`;
            if (potion.type === 'potion') {
                itemText += ` - ${potion.value} ${potion.potionType}`;
            } else if (potion.type === 'special') {
                itemText += ` - ${potion.description}`;
            }
            textElement.textContent = itemText;
            itemElement.appendChild(textElement);
            
            const actionsElement = document.createElement('div');
            actionsElement.className = 'compact-actions';
            
            const useButton = document.createElement('button');
            useButton.className = 'compact-action-btn';
            useButton.textContent = 'Use';
            useButton.onclick = () => {
                useConsumable(inventoryIndex);
            };
            actionsElement.appendChild(useButton);
            
            itemElement.appendChild(actionsElement);
            consumablesList.appendChild(itemElement);
        });
    }

    function updateInventoryScreen() {
        const inventoryItems = document.getElementById('inventory-items');
        inventoryItems.innerHTML = '';
        
        if (gameState.player.inventory.length === 0) {
            inventoryItems.innerHTML = '<div class="inventory-empty">No items in inventory</div>';
            return;
        }
        
        gameState.player.inventory.forEach((item, index) => {
            const itemElement = document.createElement('div');
            itemElement.className = `compact-item item-${item.rarity}`;
            
            let itemText = `${item.name}`;
            if (item.type === 'weapon') {
                itemText += ` (DMG +${item.damage})`;
            } else if (item.type === 'armor') {
                itemText += ` (DEF +${item.defense})`;
            } else if (item.type === 'potion') {
                itemText += ` (${item.value} ${item.potionType})`;
            } else if (item.type === 'spell') {
                itemText += ` (DMG: ${item.damage}, Cost: ${item.cost})`;
            } else if (item.type === 'special') {
                itemText += ` (${item.description})`;
            }
            
            const textElement = document.createElement('div');
            textElement.textContent = itemText;
            itemElement.appendChild(textElement);
            
            const actionsElement = document.createElement('div');
            actionsElement.className = 'compact-actions';
            
            if (item.type === 'potion' || item.type === 'special') {
                const useButton = document.createElement('button');
                useButton.className = 'compact-action-btn';
                useButton.textContent = 'Use';
                useButton.onclick = () => {
                    useConsumable(index);
                };
                actionsElement.appendChild(useButton);
            } else if (item.type === 'weapon' || item.type === 'armor' || item.type === 'spell') {
                const actionButton = document.createElement('button');
                actionButton.className = 'compact-action-btn';
                actionButton.textContent = item.type === 'spell' ? 'Learn' : 'Equip';
                actionButton.onclick = () => {
                    equipItem(index);
                };
                actionsElement.appendChild(actionButton);
            }
            
            itemElement.appendChild(actionsElement);
            inventoryItems.appendChild(itemElement);
        });
    }

    function generateLoot(enemyTier) {
        const loot = [];
        const numItems = Math.floor(Math.random() * 2) + 1;
        
        for (let i = 0; i < numItems; i++) {
            const lootType = Math.random();
            let item;
            
            if (lootType < 0.3) {
                const weaponIndex = Math.min(Math.floor(Math.random() * enemyTier), gameState.lootItems.weapons.length - 1);
                item = {...gameState.lootItems.weapons[weaponIndex]};
            } else if (lootType < 0.5) {
                const armorIndex = Math.min(Math.floor(Math.random() * enemyTier), gameState.lootItems.armor.length - 1);
                item = {...gameState.lootItems.armor[armorIndex]};
            } else if (lootType < 0.8) {
                const potionIndex = Math.min(Math.floor(Math.random() * enemyTier * 1.5), gameState.lootItems.potions.length - 1);
                item = {...gameState.lootItems.potions[potionIndex]};
            } else {
                if (Math.random() < 0.3 && gameState.lootItems.spells.length > 0) {
                    const spellIndex = Math.floor(Math.random() * gameState.lootItems.spells.length);
                    item = {...gameState.lootItems.spells[spellIndex]};
                } else {
                    const potionIndex = Math.min(Math.floor(Math.random() * enemyTier * 1.5), gameState.lootItems.potions.length - 1);
                    item = {...gameState.lootItems.potions[potionIndex]};
                }
            }
            
            loot.push(item);
        }
        
        return loot;
    }

    function showLootScreen(loot) {
        const lootItemsElement = document.getElementById('loot-items');
        lootItemsElement.innerHTML = '';
        
        loot.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = `loot-item loot-rarity-${item.rarity}`;
            
            let itemText = `${item.name} `;
            if (item.type === 'weapon') {
                itemText += `- DMG +${item.damage}`;
            } else if (item.type === 'armor') {
                itemText += `- DEF +${item.defense}`;
            } else if (item.type === 'potion') {
                itemText += `- Restores ${item.value} ${item.potionType}`;
            } else if (item.type === 'spell') {
                itemText += `- DMG: ${item.damage}, Cost: ${item.cost}`;
            } else if (item.type === 'special') {
                itemText += `- ${item.description}`;
            }
            
            itemElement.textContent = itemText;
            lootItemsElement.appendChild(itemElement);
        });
        
        gameState.currentLoot = loot;
        showScreen('loot');
    }

    function takeLoot() {
        gameState.currentLoot.forEach(item => {
            if (item.type === 'spell') {
                const spellExists = gameState.player.spells.some(spell => spell.name === item.name);
                if (!spellExists) {
                    gameState.player.spells.push({
                        name: item.name,
                        damage: item.damage,
                        cost: item.cost,
                        element: item.element || "arcane"
                    });
                    gameState.player.unlockedSpells.push(gameState.player.spells.length - 1);
                } else {
                    gameState.player.inventory.push(item);
                }
            } else {
                gameState.player.inventory.push(item);
            }
        });
        
        updatePlayerProfile();
        updateInventoryScreen();
        updateConsumablesScreen();
        
        showVictoryScreen();
        autoSave();
    }

    function showScreen(name) {
        Object.values(screens).forEach(s => s.classList.remove('active'));
        if (screens[name]) {
            screens[name].classList.add('active');
            const content = screens[name].querySelector('.content');
            if (content) content.scrollTop = 0;
        }
    }

    function updateBattleLog() {
        const logElement = document.getElementById('battle-log');
        logElement.innerHTML = '';
        gameState.battleLog.forEach(entry => {
            const div = document.createElement('div');
            div.innerHTML = entry;
            logElement.appendChild(div);
        });
        logElement.scrollTop = logElement.scrollHeight;
    }

    function addToLog(message) {
        gameState.battleLog.push(message);
        if (gameState.battleLog.length > 10) {
            gameState.battleLog.shift();
        }
        updateBattleLog();
    }

    function updateEnemySelection() {
        const enemyList = document.getElementById('enemy-list');
        enemyList.innerHTML = '';
        
        Object.keys(gameState.enemies).forEach(enemyType => {
            const enemy = gameState.enemies[enemyType];
            
            const enemyElement = document.createElement('div');
            enemyElement.className = 'enemy';
            
            enemyElement.innerHTML = `
                <div>
                    <h3>${enemy.name}</h3>
                    <div>Level: ${enemy.level} | Health: ${enemy.health}</div>
                    <div>Element: ${enemy.element}</div>
                    <div>Spells: ${enemy.spells.map(s => s.name).join(', ')}</div>
                </div>
                <button class="select-enemy" data-enemy="${enemyType}">FIGHT</button>
            `;
            
            enemyList.appendChild(enemyElement);
        });
        
        document.querySelectorAll('.select-enemy').forEach(btn => {
            btn.onclick = () => startBattle(btn.dataset.enemy);
        });
    }

    function resetGame() {
        Object.assign(gameState.player, {
            name: "MERLIN",
            level: 1,
            xp: 0,
            nextLevel: 100,
            health: 50,
            maxHealth: 50,
            mana: 30,
            maxMana: 30,
            attack: 5,
            defense: 3,
            critical: 5,
            gold: 0,
            skillPoints: 0,
            position: "medium",
            statusEffects: [],
            spells: [
                { name: "Fireball", damage: 8, cost: 5, element: "fire", statusEffect: "burn", cooldown: 0, maxCooldown: 0 },
                { name: "Ice Shard", damage: 6, cost: 4, element: "ice", statusEffect: "freeze", cooldown: 0, maxCooldown: 0 },
                { name: "Lightning", damage: 10, cost: 7, element: "lightning", statusEffect: "shock", cooldown: 0, maxCooldown: 1 },
                { name: "Heal", heal: 10, cost: 6, element: "holy", cooldown: 0, maxCooldown: 2 }
            ],
            equipment: {
                weapon: { name: "Staff", damage: 2 },
                armor: { name: "Robes", defense: 1 }
            },
            inventory: [],
            unlockedSpells: [0, 1, 2, 3],
            comboCount: 0,
            lastSpellElement: null,
            skills: {
                fire_affinity: false,
                burning_rage: false,
                ice_affinity: false,
                deep_freeze: false,
                lightning_affinity: false,
                chain_reaction: false,
                mana_efficiency: false,
                critical_thinking: false
            }
        });
        
        Object.keys(gameState.achievements).forEach(key => {
            gameState.achievements[key].unlocked = false;
        });
        
        Object.keys(gameState.quests).forEach(key => {
            if (gameState.quests[key].type === 'use_elements') {
                gameState.quests[key].progress = { fire: 0, ice: 0, lightning: 0 };
            } else {
                gameState.quests[key].progress = 0;
            }
            gameState.quests[key].completed = false;
        });
        
        gameState.gameStats = {
            totalBattles: 0,
            victories: 0,
            spellsCast: {},
            goldEarned: 0,
            playTime: 0
        };
        
        // Clear saved game
        localStorage.removeItem('wizardDuelSave');
        
        updatePlayerProfile();
        updateQuestsScreen();
    }

    function restoreAfterDefeat() {
        gameState.player.health = gameState.player.maxHealth;
        gameState.player.mana = gameState.player.maxMana;
        gameState.player.statusEffects = [];
        updatePlayerProfile();
    }

    function unlockAchievement(achievementId) {
        const achievement = gameState.achievements[achievementId];
        if (!achievement || achievement.unlocked) return;
        
        achievement.unlocked = true;
        
        const notification = document.createElement('div');
        notification.className = 'achievement-notification';
        notification.innerHTML = `
            <h3>Achievement Unlocked!</h3>
            <p>${achievement.name}</p>
            <p>${achievement.description}</p>
            <p>Reward: ${achievement.reward.gold} Gold</p>
            <button onclick="this.parentElement.remove()">OK</button>
        `;
        document.body.appendChild(notification);
        
        gameState.player.gold += achievement.reward.gold;
        addToLog(`Achievement Unlocked: ${achievement.name}! Received ${achievement.reward.gold} gold.`);
        
        updatePlayerProfile();
        updateAchievementsScreen();
        autoSave();
    }

    function updateAchievementsScreen() {
        const achievementsList = document.getElementById('achievements-list');
        achievementsList.innerHTML = '';
        
        Object.keys(gameState.achievements).forEach(achievementId => {
            const achievement = gameState.achievements[achievementId];
            const achievementElement = document.createElement('div');
            achievementElement.className = `achievement-item ${achievement.unlocked ? 'achievement-unlocked' : 'achievement-locked'}`;
            
            achievementElement.innerHTML = `
                <h3>${achievement.name}</h3>
                <p>${achievement.description}</p>
                <p>Reward: ${achievement.reward.gold} Gold</p>
                <p><strong>Status: ${achievement.unlocked ? 'UNLOCKED' : 'LOCKED'}</strong></p>
            `;
            
            achievementsList.appendChild(achievementElement);
        });
    }

    function updateShopScreen() {
        const shopItems = document.getElementById('shop-items');
        shopItems.innerHTML = '';
        
        gameState.shopItems.forEach((shopItem, index) => {
            const itemElement = document.createElement('div');
            itemElement.className = 'compact-item';
            
            const itemInfo = document.createElement('div');
            itemInfo.innerHTML = `
                <h3>${shopItem.name}</h3>
                <p>Cost: ${shopItem.cost} gold</p>
            `;
            
            const buyButton = document.createElement('button');
            buyButton.className = 'compact-action-btn';
            buyButton.textContent = 'Buy';
            buyButton.onclick = () => buyItem(index);
            buyButton.disabled = gameState.player.gold < shopItem.cost;
            
            itemElement.appendChild(itemInfo);
            itemElement.appendChild(buyButton);
            shopItems.appendChild(itemElement);
        });
        
        document.getElementById('shop-gold').textContent = gameState.player.gold;
    }

    function buyItem(shopIndex) {
        const shopItem = gameState.shopItems[shopIndex];
        
        if (gameState.player.gold < shopItem.cost) {
            addToLog("Not enough gold!");
            return;
        }
        
        gameState.player.gold -= shopItem.cost;
        gameState.player.inventory.push(shopItem.item);
        
        addToLog(`Purchased ${shopItem.name} for ${shopItem.cost} gold!`);
        
        updatePlayerProfile();
        updateShopScreen();
        updateInventoryScreen();
        autoSave();
    }

    function generateDailyChallenge() {
        gameState.dailyChallenge = {
            available: true,
            completed: false,
            progress: 0,
            required: 3,
            reward: { xp: 200, gold: 100 }
        };
        
        updateDailyChallengeDisplay();
    }

    function updateDailyChallengeDisplay() {
        const dailyChallengeElement = document.getElementById('daily-challenge-main');
        const dailyChallengeInfo = document.getElementById('daily-challenge-info');
        
        if (gameState.dailyChallenge.available && !gameState.dailyChallenge.completed) {
            dailyChallengeElement.style.display = 'block';
            
            if (dailyChallengeInfo) {
                dailyChallengeInfo.innerHTML = `
                    <h3>Daily Challenge</h3>
                    <p>Defeat ${gameState.dailyChallenge.required} enemies</p>
                    <p>Progress: ${gameState.dailyChallenge.progress}/${gameState.dailyChallenge.required}</p>
                    <p>Reward: ${gameState.dailyChallenge.reward.xp} XP and ${gameState.dailyChallenge.reward.gold} Gold</p>
                    ${gameState.dailyChallenge.completed ? '<p style="color: #0f0;">Completed!</p>' : ''}
                `;
            }
        } else {
            dailyChallengeElement.style.display = 'none';
        }
    }

    function completeDailyChallenge() {
        if (gameState.dailyChallenge.available && !gameState.dailyChallenge.completed) {
            gameState.dailyChallenge.progress++;
            
            if (gameState.dailyChallenge.progress >= gameState.dailyChallenge.required) {
                gameState.dailyChallenge.completed = true;
                gameState.player.xp += gameState.dailyChallenge.reward.xp;
                gameState.player.gold += gameState.dailyChallenge.reward.gold;
                
                addToLog(`Daily Challenge Completed! Received ${gameState.dailyChallenge.reward.xp} XP and ${gameState.dailyChallenge.reward.gold} gold.`);
                
                updatePlayerProfile();
            }
            
            updateDailyChallengeDisplay();
            autoSave();
        }
    }
    </script>
</body>
</html>
