<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tower of Terror - Enhanced Text Adventure</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'VT323', monospace;
            background-color: #000;
            color: #f00;
            line-height: 1.4;
            height: 100vh;
            overflow: hidden;
            touch-action: pan-x pan-y;
            padding: 5px;
        }
        
        .container {
            max-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 2px solid #f00;
            background-color: #000;
            padding: 8px;
            gap: 8px;
        }
        
        .header {
            text-align: center;
            padding: 8px 5px;
            border-bottom: 1px dashed #f00;
            flex-shrink: 0;
        }
        
        .game-title {
            font-size: 1.8rem;
            color: #f00;
            text-shadow: 0 0 5px #f00;
            margin-bottom: 5px;
        }
        
        .level-title {
            font-size: 1.2rem;
            color: #f00;
        }
        
        .screen {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #f00;
            padding: 12px;
            background-color: #111;
            font-size: 1.3rem; /* Increased from 1.1rem */
            line-height: 1.6; /* Increased from 1.5 */
            min-height: 0;
            scroll-behavior: smooth;
        }
        
        .screen::-webkit-scrollbar {
            width: 8px;
        }
        
        .screen::-webkit-scrollbar-thumb {
            background-color: #f00;
        }
        
        .output-text {
            margin-bottom: 10px; /* Increased from 8px */
            animation: typing 0.05s steps(1, end);
            word-wrap: break-word;
        }
        
        .enemy-text {
            color: #ff5555;
        }
        
        .combat-text {
            color: #ff3333;
            font-weight: bold;
        }
        
        .damage-text {
            color: #ff0000;
            text-shadow: 0 0 3px #ff0000;
        }
        
        .heal-text {
            color: #55ff55;
        }
        
        .loot-text {
            color: #ffaa00;
        }
        
        .player-text {
            color: #ff8888;
        }
        
        .important-text {
            color: #ff0;
            font-weight: bold;
        }
        
        .danger-text {
            color: #f00;
        }
        
        .success-text {
            color: #0f0;
        }
        
        .gold-text {
            color: #ffd700;
            text-shadow: 0 0 3px #ffd700;
        }
        
        .npc-text {
            color: #00aaff;
        }
        
        .merchant-text {
            color: #ff8800;
        }
        
        .mystic-text {
            color: #aa00ff;
        }
        
        .action-panel {
            display: none;
            border: 1px solid #f00;
            padding: 10px;
            background-color: #111;
            flex-shrink: 0;
        }
        
        .action-title {
            color: #f00;
            margin-bottom: 10px;
            font-size: 1.3rem; /* Increased from 1.2rem */
            text-align: center;
        }
        
        .action-choices {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .button {
            background-color: #000;
            color: #f00;
            border: 1px solid #f00;
            padding: 14px 8px;
            font-family: 'VT323', monospace;
            font-size: 1.2rem; /* Increased from 1.1rem */
            cursor: pointer;
            text-align: center;
            transition: all 0.1s;
            touch-action: manipulation;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
        }
        
        .button:active {
            background-color: #f00;
            color: #000;
        }
        
        .command-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            flex-shrink: 0;
        }
        
        .command-button {
            background-color: #000;
            color: #f00;
            border: 1px solid #f00;
            padding: 14px 5px;
            font-family: 'VT323', monospace;
            font-size: 1.2rem; /* Increased from 1.1rem */
            cursor: pointer;
            text-align: center;
            transition: all 0.1s;
            touch-action: manipulation;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .command-button:active {
            background-color: #f00;
            color: #000;
        }
        
        .combat-panel {
            display: none;
            border: 1px solid #f00;
            padding: 10px;
            background-color: #111;
            flex-shrink: 0;
        }
        
        .combat-title {
            color: #f00;
            margin-bottom: 10px;
            font-size: 1.3rem; /* Increased from 1.2rem */
            text-align: center;
        }
        
        .combat-choices {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .combat-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px dashed #f00;
            background-color: #000;
            font-size: 1.1rem;
        }
        
        .player-stats, .enemy-stats {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-bar {
            width: 100px;
            height: 10px;
            background-color: #222;
            margin: 2px 0;
            overflow: hidden;
        }
        
        .health-bar {
            height: 100%;
            background-color: #f00;
            width: 100%;
        }
        
        .mana-bar {
            height: 100%;
            background-color: #00f;
            width: 100%;
        }
        
        .inventory-panel {
            display: none;
            border: 1px solid #f00;
            padding: 10px;
            background-color: #111;
            flex-shrink: 0;
        }
        
        .inventory-title {
            color: #f00;
            margin-bottom: 10px;
            font-size: 1.3rem; /* Increased from 1.2rem */
            text-align: center;
        }
        
        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            border: 1px dashed #f00;
            padding: 8px 10px;
            font-size: 1.1rem; /* Increased from 1rem */
            min-width: 100px;
            text-align: center;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 8px 5px;
            border-top: 1px dashed #f00;
            flex-shrink: 0;
            font-size: 1rem; /* Increased from 0.9rem */
        }
        
        .equipment-panel {
            display: none;
            border: 1px solid #f00;
            padding: 10px;
            background-color: #111;
            flex-shrink: 0;
            margin-top: 8px;
        }
        
        .equipment-title {
            color: #f00;
            margin-bottom: 10px;
            font-size: 1.3rem; /* Increased from 1.2rem */
            text-align: center;
        }
        
        .equipment-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .equipment-slot {
            border: 1px dashed #f00;
            padding: 8px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        @keyframes typing {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Responsive adjustments */
        @media (max-height: 700px) {
            .button, .command-button {
                padding: 10px 5px;
                font-size: 1.1rem; /* Increased from 1rem */
                min-height: 40px;
            }
            
            .game-title {
                font-size: 1.5rem;
            }
            
            .level-title {
                font-size: 1rem;
            }
            
            .screen {
                font-size: 1.2rem; /* Adjusted for smaller screens */
            }
        }
        
        @media (max-height: 600px) {
            .screen {
                font-size: 1.1rem;
                padding: 8px;
            }
            
            .button, .command-button {
                padding: 8px 4px;
                min-height: 36px;
                font-size: 1rem;
            }
        }
        
        .conversation-log {
            border-top: 1px dashed #f00;
            margin-top: 10px;
            padding-top: 10px;
        }
        
        .conversation-title {
            color: #f00;
            font-size: 1.1rem; /* Increased from 1rem */
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="game-title">TOWER OF TERROR</div>
            <div class="level-title" id="levelTitle">FLOOR 1 - ENTRANCE HALL</div>
        </div>
        
        <div class="screen" id="gameScreen">
            <div class="output-text">TOWER OF TERROR - Enhanced Text Adventure</div>
            <div class="output-text">Copyright (C) 1985 Shadowbyte Games</div>
            <div class="output-text">Loading game data... OK</div>
            <div class="output-text">Initializing combat system... OK</div>
            <div class="output-text">Initializing loot system... OK</div>
            <div class="output-text">Initializing auto-scroll... OK</div>
            <div class="output-text">----------------------------------------</div>
            <div class="output-text" id="currentOutput">You stand before the TOWER OF TERROR, a monolithic structure piercing the blood-red sky. The entrance hall is dimly lit by flickering torches. Cold wind howls from within, carrying whispers of forgotten souls. A rusty sign reads: "Abandon all hope, ye who enter." To the north, a massive stone staircase leads upward. To the east, a corridor disappears into darkness.</div>
        </div>
        
        <!-- Action Panel for choices -->
        <div class="action-panel" id="actionPanel">
            <div class="action-title" id="actionTitle">Select Action</div>
            <div class="action-choices" id="actionChoices">
                <!-- Dynamic buttons will be inserted here -->
            </div>
        </div>
        
        <!-- Combat Panel -->
        <div class="combat-panel" id="combatPanel">
            <div class="combat-title" id="combatTitle">COMBAT</div>
            <div class="combat-info" id="combatInfo">
                <div class="player-stats">
                    <div>YOU</div>
                    <div>HP: <span id="playerHP">100</span>/<span id="playerMaxHP">100</span></div>
                    <div class="stat-bar">
                        <div class="health-bar" id="playerHealthBar"></div>
                    </div>
                    <div>MP: <span id="playerMP">30</span>/<span id="playerMaxMP">30</span></div>
                    <div class="stat-bar">
                        <div class="mana-bar" id="playerManaBar"></div>
                    </div>
                </div>
                <div class="enemy-stats">
                    <div id="enemyName">ENEMY</div>
                    <div>HP: <span id="enemyHP">50</span>/<span id="enemyMaxHP">50</span></div>
                    <div class="stat-bar">
                        <div class="health-bar" id="enemyHealthBar"></div>
                    </div>
                    <div id="enemyStatus">Status: Normal</div>
                </div>
            </div>
            <div class="combat-choices" id="combatChoices">
                <!-- Dynamic combat buttons will be inserted here -->
            </div>
        </div>
        
        <!-- Main Command Buttons -->
        <div class="command-buttons">
            <button class="command-button" id="lookBtn">LOOK</button>
            <button class="command-button" id="exploreBtn">EXPLORE</button>
            <button class="command-button" id="inventoryBtn">INVENTORY</button>
            <button class="command-button" id="equipmentBtn">EQUIPMENT</button>
            <button class="command-button" id="useBtn">USE ITEM</button>
            <button class="command-button" id="restBtn">REST</button>
            <button class="command-button" id="moveBtn">MOVE</button>
            <button class="command-button" id="talkBtn">TALK</button>
        </div>
        
        <!-- Inventory Panel -->
        <div class="inventory-panel" id="inventoryPanel">
            <div class="inventory-title">INVENTORY</div>
            <div class="inventory-items" id="inventoryItems">
                <div class="inventory-item">Empty</div>
            </div>
        </div>
        
        <!-- Equipment Panel -->
        <div class="equipment-panel" id="equipmentPanel">
            <div class="equipment-title">EQUIPMENT</div>
            <div class="equipment-slots" id="equipmentSlots">
                <!-- Equipment slots will be inserted here -->
            </div>
        </div>
        
        <div class="status-bar">
            <div>Floor: <span id="floorValue">1</span> | Room: <span id="roomValue">Entrance Hall</span></div>
            <div>HP: <span id="healthValue">100</span>/<span id="maxHealthValue">100</span></div>
            <div>MP: <span id="manaValue">30</span>/<span id="maxManaValue">30</span></div>
            <div>Gold: <span class="gold-text" id="goldValue">0</span></div>
            <div>Score: <span id="scoreValue">0</span></div>
        </div>
    </div>

    <script>
        // ============================================
        // ENHANCED GAME STATE WITH MORE CONTENT
        // ============================================
        let gameState = {
            currentFloor: 1,
            currentRoom: "entranceHall",
            inCombat: false,
            currentEnemy: null,
            playerTurn: true,
            inventory: ["rusty dagger", "health potion"],
            equipment: {
                weapon: "rusty dagger",
                armor: null,
                accessory: null,
                shield: null
            },
            score: 0,
            health: 100,
            maxHealth: 100,
            mana: 30,
            maxMana: 30,
            attack: 12,
            defense: 5,
            gold: 0,
            exploredRooms: {},
            floorCleared: false,
            // NPC interactions
            npcInteractions: {
                blacksmith: { talked: false, servicesUsed: [] },
                mystic: { talked: false, servicesUsed: [] },
                merchant: { talked: false, servicesUsed: [] },
                prisoner: { talked: false, questGiven: false }
            },
            // Room connections
            roomConnections: {
                entranceHall: { north: "grandStaircase", east: "corridor", west: null, south: null },
                grandStaircase: { north: "floor2Landing", east: null, west: null, south: "entranceHall" },
                corridor: { north: "armory", east: "dungeonEntrance", west: "entranceHall", south: "storageRoom" },
                armory: { north: null, east: null, west: null, south: "corridor" },
                storageRoom: { north: "corridor", east: null, west: null, south: null },
                dungeonEntrance: { north: "dungeonHall", east: null, west: "corridor", south: null },
                dungeonHall: { north: "prisonCells", east: "tortureChamber", west: null, south: "dungeonEntrance" },
                prisonCells: { north: null, east: null, west: null, south: "dungeonHall" },
                tortureChamber: { north: null, east: null, west: "dungeonHall", south: null },
                floor2Landing: { north: "library", east: "alchemyLab", west: "blacksmith", south: "grandStaircase" },
                library: { north: null, east: null, west: null, south: "floor2Landing" },
                alchemyLab: { north: null, east: null, west: "floor2Landing", south: null },
                blacksmith: { north: null, east: "floor2Landing", west: null, south: null }
            },
            // Room descriptions
            roomDescriptions: {
                entranceHall: "You're in the entrance hall. Flickering torches cast long shadows on the stone walls. A massive stone staircase leads upward to the north. A dark corridor stretches to the east.",
                grandStaircase: "You stand on the grand staircase. The steps are worn smooth by centuries of use. Above you, the tower continues upward into darkness. Below, the entrance hall lies to the south.",
                corridor: "A long, dark corridor stretches before you. Doors line the walls, some broken, some locked tight. The air is cold and damp.",
                armory: "This room contains rusted weapons and broken armor racks. A few items might still be salvageable. The blacksmith on floor 2 could repair some of these.",
                storageRoom: "A cluttered storage room filled with barrels, crates, and discarded equipment. Something useful might be hidden here.",
                dungeonEntrance: "The entrance to the tower's dungeon. Iron bars line the walls, and the sound of dripping water echoes in the distance.",
                dungeonHall: "The main dungeon hallway. Prison cells line both sides, their occupants long since turned to dust. The air smells of decay and despair.",
                prisonCells: "Rows of empty prison cells. Chains hang from the walls. In one cell, a skeletal figure sits silently.",
                tortureChamber: "A horrific room filled with rusty instruments of pain. The walls are stained dark. You feel a profound sense of dread here.",
                floor2Landing: "You've reached the second floor landing. Doors lead to various rooms. To the west, you hear the sound of hammer on anvil. To the east, strange chemical smells waft from a doorway.",
                library: "A vast library filled with ancient tomes. Dust covers everything. Some books glow with faint magical energy.",
                alchemyLab: "An alchemist's laboratory. Beakers bubble with strange liquids. A hooded figure works at a table, not noticing your entrance.",
                blacksmith: "A forge burns hot in this room. A muscular dwarf works at an anvil, hammering a glowing piece of metal. Weapons and armor line the walls."
            },
            // Room NPCs
            roomNPCs: {
                prisonCells: "prisoner",
                alchemyLab: "mystic",
                blacksmith: "blacksmith",
                floor2Landing: "merchant"
            },
            // Room loot availability
            roomLootAvailable: {
                armory: true,
                storageRoom: true,
                library: true
            },
            // Player abilities
            abilities: [
                { name: "Heavy Strike", cost: 0, damageMultiplier: 1.5, description: "A powerful attack that deals 1.5x damage" },
                { name: "Fire Bolt", cost: 8, damageMultiplier: 2.0, description: "Launch a bolt of fire (requires mana)" },
                { name: "Ice Shard", cost: 6, damageMultiplier: 1.8, slowEffect: true, description: "Launch shards of ice that slow the enemy" },
                { name: "Heal", cost: 12, healAmount: 40, description: "Restore 40 health (requires mana)" },
                { name: "Shield Bash", cost: 5, damageMultiplier: 1.2, stunChance: 0.3, description: "Bash with your shield, chance to stun" }
            ]
        };
        
        // Enhanced enemy definitions
        const enemies = {
            // Floor 1 enemies
            zombie: { name: "Zombie", health: 60, maxHealth: 60, attack: 10, defense: 2, gold: 15, xp: 25, floor: 1 },
            skeleton: { name: "Skeleton Warrior", health: 50, maxHealth: 50, attack: 14, defense: 5, gold: 20, xp: 30, floor: 1 },
            ghoul: { name: "Ghoul", health: 70, maxHealth: 70, attack: 12, defense: 4, gold: 18, xp: 28, floor: 1 },
            giantRat: { name: "Giant Rat", health: 30, maxHealth: 30, attack: 8, defense: 1, gold: 8, xp: 15, floor: 1 },
            // Floor 2 enemies
            specter: { name: "Specter", health: 80, maxHealth: 80, attack: 18, defense: 6, gold: 30, xp: 45, floor: 2 },
            wraith: { name: "Wraith", health: 75, maxHealth: 75, attack: 22, defense: 8, gold: 35, xp: 50, floor: 2 },
            ghost: { name: "Ghost", health: 65, maxHealth: 65, attack: 25, defense: 4, gold: 32, xp: 48, floor: 2 },
            goblin: { name: "Goblin Scout", health: 45, maxHealth: 45, attack: 16, defense: 3, gold: 25, xp: 35, floor: 2 },
            // Floor 3 enemies
            demon: { name: "Lesser Demon", health: 120, maxHealth: 120, attack: 30, defense: 12, gold: 60, xp: 85, floor: 3 },
            lich: { name: "Lich Apprentice", health: 110, maxHealth: 110, attack: 35, defense: 10, gold: 65, xp: 90, floor: 3 },
            vampire: { name: "Vampire Spawn", health: 130, maxHealth: 130, attack: 28, defense: 14, gold: 70, xp: 95, floor: 3 },
            troll: { name: "Cave Troll", health: 150, maxHealth: 150, attack: 25, defense: 15, gold: 55, xp: 80, floor: 3 },
            // Floor 4 enemies
            behemoth: { name: "Behemoth", health: 200, maxHealth: 200, attack: 40, defense: 18, gold: 120, xp: 160, floor: 4 },
            dragon: { name: "Young Dragon", health: 180, maxHealth: 180, attack: 45, defense: 22, gold: 140, xp: 180, floor: 4 },
            abomination: { name: "Flesh Abomination", health: 220, maxHealth: 220, attack: 38, defense: 20, gold: 130, xp: 170, floor: 4 },
            knight: { name: "Cursed Knight", health: 170, maxHealth: 170, attack: 42, defense: 25, gold: 125, xp: 165, floor: 4 },
            // Boss enemies
            demonLord: { name: "Demon Lord", health: 350, maxHealth: 350, attack: 50, defense: 30, gold: 500, xp: 500, floor: 5 },
            towerMaster: { name: "Tower Master", health: 400, maxHealth: 400, attack: 55, defense: 35, gold: 600, xp: 600, floor: 5 }
        };
        
        // Enhanced equipment definitions
        const equipmentItems = {
            // Weapons
            "rusty dagger": { type: "weapon", attack: 3, value: 5, tier: 1 },
            "iron sword": { type: "weapon", attack: 8, value: 20, tier: 1 },
            "steel sword": { type: "weapon", attack: 14, value: 50, tier: 2 },
            "enchanted blade": { type: "weapon", attack: 22, value: 150, tier: 3 },
            "demon slayer": { type: "weapon", attack: 30, value: 300, tier: 4 },
            "dragonscale sword": { type: "weapon", attack: 35, value: 400, tier: 4 },
            "great axe": { type: "weapon", attack: 25, defense: -2, value: 120, tier: 3 },
            "war hammer": { type: "weapon", attack: 20, stunChance: 0.1, value: 100, tier: 3 },
            "shadow dagger": { type: "weapon", attack: 18, criticalChance: 0.15, value: 180, tier: 3 },
            "firebrand": { type: "weapon", attack: 28, fireDamage: 5, value: 250, tier: 4 },
            
            // Armor
            "leather armor": { type: "armor", defense: 4, value: 10, tier: 1 },
            "chainmail": { type: "armor", defense: 9, value: 35, tier: 2 },
            "plate armor": { type: "armor", defense: 15, value: 80, tier: 3 },
            "dragon scale armor": { type: "armor", defense: 22, fireResistance: 0.3, value: 200, tier: 4 },
            "mage robes": { type: "armor", defense: 6, manaBonus: 10, value: 60, tier: 2 },
            "shadow cloak": { type: "armor", defense: 8, dodgeChance: 0.1, value: 120, tier: 3 },
            "knight's plate": { type: "armor", defense: 18, value: 150, tier: 3 },
            "demonhide armor": { type: "armor", defense: 20, poisonResistance: 0.5, value: 220, tier: 4 },
            
            // Shields
            "wooden shield": { type: "shield", defense: 3, blockChance: 0.1, value: 15, tier: 1 },
            "iron shield": { type: "shield", defense: 6, blockChance: 0.15, value: 40, tier: 2 },
            "tower shield": { type: "shield", defense: 10, blockChance: 0.2, value: 80, tier: 3 },
            "dragonbone shield": { type: "shield", defense: 14, blockChance: 0.25, fireResistance: 0.2, value: 180, tier: 4 },
            
            // Accessories
            "health amulet": { type: "accessory", healthBonus: 20, value: 50, tier: 2 },
            "mana ring": { type: "accessory", manaBonus: 15, value: 60, tier: 2 },
            "attack bracelet": { type: "accessory", attackBonus: 5, value: 70, tier: 2 },
            "defense ring": { type: "accessory", defenseBonus: 4, value: 65, tier: 2 },
            "lucky charm": { type: "accessory", criticalChance: 0.1, dodgeChance: 0.05, value: 100, tier: 3 },
            "vampire ring": { type: "accessory", lifesteal: 0.1, value: 150, tier: 3 },
            "elemental ward": { type: "accessory", fireResistance: 0.2, iceResistance: 0.2, value: 120, tier: 3 }
        };
        
        // Enhanced consumable items
        const consumableItems = {
            "health potion": { type: "consumable", healthRestore: 40, value: 15 },
            "mana potion": { type: "consumable", manaRestore: 25, value: 20 },
            "greater health potion": { type: "consumable", healthRestore: 80, value: 35 },
            "greater mana potion": { type: "consumable", manaRestore: 50, value: 40 },
            "elixir": { type: "consumable", healthRestore: 120, manaRestore: 40, value: 80 },
            "antidote": { type: "consumable", curePoison: true, value: 25 },
            "torch": { type: "utility", value: 5 },
            "lockpick": { type: "utility", value: 20 },
            "smoke bomb": { type: "combat", fleeBonus: 0.3, value: 30 },
            "throwing knife": { type: "combat", damage: 15, value: 10 },
            "bomb": { type: "combat", damage: 40, value: 50 },
            "scroll of fireball": { type: "combat", damage: 60, value: 75 },
            "scroll of healing": { type: "consumable", healthRestore: 100, value: 60 }
        };
        
        // NPC definitions
        const npcData = {
            blacksmith: {
                name: "Thrain the Blacksmith",
                description: "A muscular dwarf covered in soot and sweat. He works tirelessly at his forge.",
                dialogue: {
                    initial: "Hail, traveler! I am Thrain, master blacksmith. Care to see my wares or need something repaired?",
                    regular: "Back for more, eh? What can Thrain do for you today?",
                    services: [
                        { name: "Buy Weapons", gold: 0, action: "blacksmith_buy" },
                        { name: "Buy Armor", gold: 0, action: "blacksmith_buy_armor" },
                        { name: "Repair Equipment", gold: 20, action: "blacksmith_repair" },
                        { name: "Upgrade Equipment", gold: 50, action: "blacksmith_upgrade" },
                        { name: "Goodbye", gold: 0, action: "goodbye" }
                    ]
                }
            },
            mystic: {
                name: "Elara the Mystic",
                description: "A hooded figure surrounded by bubbling potions and ancient scrolls. Her eyes glow with arcane energy.",
                dialogue: {
                    initial: "Ah, a seeker of knowledge... or perhaps just another lost soul. I am Elara. I deal in potions and arcane artifacts.",
                    regular: "Have you come to peruse my collection?",
                    services: [
                        { name: "Buy Potions", gold: 0, action: "mystic_buy_potions" },
                        { name: "Buy Scrolls", gold: 0, action: "mystic_buy_scrolls" },
                        { name: "Identify Item", gold: 15, action: "mystic_identify" },
                        { name: "Enchant Item", gold: 100, action: "mystic_enchant" },
                        { name: "Goodbye", gold: 0, action: "goodbye" }
                    ]
                }
            },
            merchant: {
                name: "Silas the Merchant",
                description: "A sly-looking man with a calculating gaze. His pack is filled with various goods.",
                dialogue: {
                    initial: "Well met, traveler! I am Silas, purveyor of fine goods. Everything has a price, and I have everything!",
                    regular: "Back for more? My prices are always fair... for me.",
                    services: [
                        { name: "Buy General Goods", gold: 0, action: "merchant_buy" },
                        { name: "Sell Items", gold: 0, action: "merchant_sell" },
                        { name: "Special Deals", gold: 0, action: "merchant_special" },
                        { name: "Rumors", gold: 10, action: "merchant_rumors" },
                        { name: "Goodbye", gold: 0, action: "goodbye" }
                    ]
                }
            },
            prisoner: {
                name: "The Prisoner",
                description: "A skeletal figure chained to the wall. He looks up as you approach, hollow eye sockets fixed on you.",
                dialogue: {
                    initial: "...You... you're alive? Please... free me... I have information... about the tower...",
                    regular: "Have you found the key? Please... I beg you...",
                    services: [
                        { name: "Ask about the tower", gold: 0, action: "prisoner_info" },
                        { name: "Ask about the key", gold: 0, action: "prisoner_key" },
                        { name: "Try to free him", gold: 0, action: "prisoner_free" },
                        { name: "Leave him", gold: 0, action: "goodbye" }
                    ]
                }
            }
        };
        
        // DOM elements
        const gameScreen = document.getElementById('gameScreen');
        const actionPanel = document.getElementById('actionPanel');
        const actionTitle = document.getElementById('actionTitle');
        const actionChoices = document.getElementById('actionChoices');
        const combatPanel = document.getElementById('combatPanel');
        const combatTitle = document.getElementById('combatTitle');
        const combatInfo = document.getElementById('combatInfo');
        const combatChoices = document.getElementById('combatChoices');
        const inventoryPanel = document.getElementById('inventoryPanel');
        const inventoryItems = document.getElementById('inventoryItems');
        const equipmentPanel = document.getElementById('equipmentPanel');
        const equipmentSlots = document.getElementById('equipmentSlots');
        const healthValue = document.getElementById('healthValue');
        const maxHealthValue = document.getElementById('maxHealthValue');
        const manaValue = document.getElementById('manaValue');
        const maxManaValue = document.getElementById('maxManaValue');
        const scoreValue = document.getElementById('scoreValue');
        const goldValue = document.getElementById('goldValue');
        const floorValue = document.getElementById('floorValue');
        const roomValue = document.getElementById('roomValue');
        const levelTitle = document.getElementById('levelTitle');
        
        // Combat UI elements
        const playerHP = document.getElementById('playerHP');
        const playerMaxHP = document.getElementById('playerMaxHP');
        const playerMP = document.getElementById('playerMP');
        const playerMaxMP = document.getElementById('playerMaxMP');
        const enemyName = document.getElementById('enemyName');
        const enemyHP = document.getElementById('enemyHP');
        const enemyMaxHP = document.getElementById('enemyMaxHP');
        const playerHealthBar = document.getElementById('playerHealthBar');
        const playerManaBar = document.getElementById('playerManaBar');
        const enemyHealthBar = document.getElementById('enemyHealthBar');
        
        // ============================================
        // AUTO-SCROLL FUNCTIONALITY
        // ============================================
        // Auto-scroll to bottom whenever new content is added
        function autoScrollToBottom() {
            // Small delay to ensure DOM is updated
            setTimeout(() => {
                gameScreen.scrollTop = gameScreen.scrollHeight;
            }, 50);
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        function initGame() {
            updateStatus();
            addToOutput("Touch commands to play. Goal: Ascend to the top of the tower.", "important-text");
            addToOutput("Tip: Talk to NPCs for services and information. Explore every room thoroughly.", "npc-text");
            setupEventListeners();
            updateEquipmentDisplay();
            autoScrollToBottom(); // Initial scroll to bottom
        }
        
        // Set up event listeners for buttons
        function setupEventListeners() {
            // Command buttons
            document.getElementById('lookBtn').addEventListener('click', handleLook);
            document.getElementById('exploreBtn').addEventListener('click', handleExplore);
            document.getElementById('inventoryBtn').addEventListener('click', handleInventory);
            document.getElementById('equipmentBtn').addEventListener('click', handleEquipment);
            document.getElementById('useBtn').addEventListener('click', handleUseItem);
            document.getElementById('restBtn').addEventListener('click', handleRest);
            document.getElementById('moveBtn').addEventListener('click', handleMove);
            document.getElementById('talkBtn').addEventListener('click', handleTalk);
        }
        
        // ============================================
        // ENHANCED OUTPUT FUNCTION WITH AUTO-SCROLL
        // ============================================
        function addToOutput(text, className = "") {
            const newLine = document.createElement("div");
            newLine.className = `output-text ${className}`;
            newLine.textContent = text;
            gameScreen.appendChild(newLine);
            
            // Auto-scroll to bottom after adding new text
            autoScrollToBottom();
        }
        
        // Add conversation output
        function addConversation(speaker, text, npcType = "npc") {
            let speakerName, speakerClass;
            
            switch(npcType) {
                case "player":
                    speakerName = "You";
                    speakerClass = "player-text";
                    break;
                case "blacksmith":
                    speakerName = "Thrain";
                    speakerClass = "npc-text";
                    break;
                case "mystic":
                    speakerName = "Elara";
                    speakerClass = "mystic-text";
                    break;
                case "merchant":
                    speakerName = "Silas";
                    speakerClass = "merchant-text";
                    break;
                case "prisoner":
                    speakerName = "Prisoner";
                    speakerClass = "npc-text";
                    break;
                default:
                    speakerName = speaker;
                    speakerClass = "npc-text";
            }
            
            addToOutput(`${speakerName}: ${text}`, speakerClass);
            autoScrollToBottom();
        }
        
        // ============================================
        // STATUS & UI UPDATES
        // ============================================
        function updateStatus() {
            healthValue.textContent = gameState.health;
            maxHealthValue.textContent = gameState.maxHealth;
            manaValue.textContent = gameState.mana;
            maxManaValue.textContent = gameState.maxMana;
            scoreValue.textContent = gameState.score;
            goldValue.textContent = gameState.gold;
            floorValue.textContent = gameState.currentFloor;
            
            // Update room name display
            const roomName = gameState.currentRoom.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            roomValue.textContent = roomName;
            
            // Update location display
            levelTitle.textContent = `FLOOR ${gameState.currentFloor} - ${roomName.toUpperCase()}`;
            
            // Update combat UI if in combat
            if (gameState.inCombat) {
                updateCombatUI();
            }
        }
        
        function updateCombatUI() {
            playerHP.textContent = gameState.health;
            playerMaxHP.textContent = gameState.maxHealth;
            playerMP.textContent = gameState.mana;
            playerMaxMP.textContent = gameState.maxMana;
            
            // Update health bars
            const playerHealthPercent = (gameState.health / gameState.maxHealth) * 100;
            playerHealthBar.style.width = `${playerHealthPercent}%`;
            
            const playerManaPercent = (gameState.mana / gameState.maxMana) * 100;
            playerManaBar.style.width = `${playerManaPercent}%`;
            
            if (gameState.currentEnemy) {
                enemyName.textContent = gameState.currentEnemy.name;
                enemyHP.textContent = gameState.currentEnemy.health;
                enemyMaxHP.textContent = gameState.currentEnemy.maxHealth;
                
                const enemyHealthPercent = (gameState.currentEnemy.health / gameState.currentEnemy.maxHealth) * 100;
                enemyHealthBar.style.width = `${enemyHealthPercent}%`;
            }
        }
        
        // ============================================
        // PANEL MANAGEMENT
        // ============================================
        function showActionPanel(title, choices, callback) {
            actionTitle.textContent = title;
            actionChoices.innerHTML = '';
            
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'button';
                button.textContent = choice.text;
                button.addEventListener('click', () => {
                    hideActionPanel();
                    callback(choice.value, choice.text);
                    autoScrollToBottom(); // Scroll after button click
                });
                actionChoices.appendChild(button);
            });
            
            actionPanel.style.display = 'block';
            autoScrollToBottom();
        }
        
        function hideActionPanel() {
            actionPanel.style.display = 'none';
        }
        
        function showCombatPanel() {
            updateCombatUI();
            updateCombatChoices();
            combatPanel.style.display = 'block';
            autoScrollToBottom();
        }
        
        function hideCombatPanel() {
            combatPanel.style.display = 'none';
        }
        
        // ============================================
        // COMBAT SYSTEM
        // ============================================
        function updateCombatChoices() {
            combatChoices.innerHTML = '';
            
            // Basic attack
            const attackButton = document.createElement('button');
            attackButton.className = 'button';
            attackButton.textContent = 'ATTACK';
            attackButton.addEventListener('click', () => {
                playerAttack('normal');
                autoScrollToBottom();
            });
            combatChoices.appendChild(attackButton);
            
            // Abilities
            gameState.abilities.forEach(ability => {
                const abilityButton = document.createElement('button');
                abilityButton.className = 'button';
                abilityButton.textContent = ability.name;
                
                // Disable if not enough mana
                if (ability.cost > gameState.mana) {
                    abilityButton.disabled = true;
                    abilityButton.style.opacity = '0.5';
                }
                
                abilityButton.addEventListener('click', () => {
                    if (ability.name === "Heal") {
                        playerHeal(ability);
                    } else {
                        playerAttack(ability.name.toLowerCase());
                    }
                    autoScrollToBottom();
                });
                combatChoices.appendChild(abilityButton);
            });
            
            // Item button
            const itemButton = document.createElement('button');
            itemButton.className = 'button';
            itemButton.textContent = 'USE ITEM';
            itemButton.addEventListener('click', () => {
                showCombatItems();
                autoScrollToBottom();
            });
            combatChoices.appendChild(itemButton);
            
            // Flee button
            const fleeButton = document.createElement('button');
            fleeButton.className = 'button';
            fleeButton.textContent = 'FLEE';
            fleeButton.addEventListener('click', () => {
                attemptFlee();
                autoScrollToBottom();
            });
            combatChoices.appendChild(fleeButton);
        }
        
        function showCombatItems() {
            // Filter combat-usable items
            const combatItems = gameState.inventory.filter(item => 
                consumableItems[item] && (consumableItems[item].type === "combat" || consumableItems[item].type === "consumable")
            );
            
            if (combatItems.length === 0) {
                addToOutput("You have no usable items in combat.", "important-text");
                return;
            }
            
            const choices = combatItems.map(item => ({
                text: `${item.toUpperCase()}`,
                value: item
            }));
            
            choices.push({ text: "CANCEL", value: "cancel" });
            
            showActionPanel("USE ITEM IN COMBAT:", choices, handleCombatItemChoice);
        }
        
        function handleCombatItemChoice(item) {
            if (item === "cancel") {
                addToOutput("You decide not to use an item.");
                return;
            }
            
            // Remove from inventory
            const itemIndex = gameState.inventory.indexOf(item);
            if (itemIndex > -1) {
                gameState.inventory.splice(itemIndex, 1);
            }
            
            // Apply item effect
            const itemData = consumableItems[item];
            
            if (itemData.healthRestore) {
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + itemData.healthRestore);
                const healed = gameState.health - oldHealth;
                addToOutput(`You use ${item} and restore ${healed} health.`, "heal-text");
            }
            
            if (itemData.manaRestore) {
                const oldMana = gameState.mana;
                gameState.mana = Math.min(gameState.maxMana, gameState.mana + itemData.manaRestore);
                const restored = gameState.mana - oldMana;
                addToOutput(`You use ${item} and restore ${restored} mana.`, "heal-text");
            }
            
            if (itemData.damage && gameState.currentEnemy) {
                const damage = itemData.damage;
                gameState.currentEnemy.health -= damage;
                addToOutput(`You use ${item} and deal ${damage} damage to the ${gameState.currentEnemy.name}!`, "damage-text");
                
                if (gameState.currentEnemy.health <= 0) {
                    enemyDefeated();
                    return;
                }
            }
            
            if (itemData.fleeBonus) {
                addToOutput(`You use ${item}, creating a smokescreen. Your chance to flee increases.`, "important-text");
                // Flee chance is handled in attemptFlee function
            }
            
            updateInventory();
            updateCombatUI();
            
            // Enemy's turn
            gameState.playerTurn = false;
            setTimeout(enemyAttack, 1000);
        }
        
        function playerAttack(attackType) {
            if (!gameState.playerTurn || !gameState.inCombat) return;
            
            let damage = gameState.attack;
            let abilityCost = 0;
            let specialEffect = "";
            
            // Determine attack type
            switch(attackType) {
                case "heavy strike":
                    damage = Math.floor(damage * 1.5);
                    addToOutput("You use HEAVY STRIKE!", "combat-text");
                    break;
                case "fire bolt":
                    damage = Math.floor(damage * 2.0);
                    abilityCost = 8;
                    specialEffect = " The enemy is burned!";
                    addToOutput("You cast FIRE BOLT!", "combat-text");
                    break;
                case "ice shard":
                    damage = Math.floor(damage * 1.8);
                    abilityCost = 6;
                    specialEffect = " The enemy is slowed!";
                    addToOutput("You cast ICE SHARD!", "combat-text");
                    break;
                case "shield bash":
                    damage = Math.floor(damage * 1.2);
                    abilityCost = 5;
                    if (Math.random() < 0.3) {
                        specialEffect = " The enemy is stunned!";
                    }
                    addToOutput("You use SHIELD BASH!", "combat-text");
                    break;
                default:
                    addToOutput("You attack!", "combat-text");
            }
            
            // Deduct mana if using ability
            if (abilityCost > 0) {
                gameState.mana -= abilityCost;
                addToOutput(`You use ${abilityCost} mana.`, "important-text");
            }
            
            // Calculate final damage (consider enemy defense)
            damage = Math.max(1, damage - gameState.currentEnemy.defense);
            gameState.currentEnemy.health -= damage;
            
            addToOutput(`You hit the ${gameState.currentEnemy.name} for ${damage} damage!${specialEffect}`, "damage-text");
            
            updateCombatUI();
            
            // Check if enemy is defeated
            if (gameState.currentEnemy.health <= 0) {
                enemyDefeated();
                return;
            }
            
            // Enemy's turn
            gameState.playerTurn = false;
            setTimeout(enemyAttack, 1000);
        }
        
        function playerHeal(ability) {
            if (!gameState.playerTurn || !gameState.inCombat) return;
            
            if (gameState.mana < ability.cost) {
                addToOutput("Not enough mana!", "danger-text");
                return;
            }
            
            gameState.mana -= ability.cost;
            const oldHealth = gameState.health;
            gameState.health = Math.min(gameState.maxHealth, gameState.health + ability.healAmount);
            const healed = gameState.health - oldHealth;
            
            addToOutput(`You use HEAL and restore ${healed} health.`, "heal-text");
            addToOutput(`You use ${ability.cost} mana.`, "important-text");
            
            updateCombatUI();
            
            // Enemy's turn
            gameState.playerTurn = false;
            setTimeout(enemyAttack, 1000);
        }
        
        function enemyAttack() {
            if (!gameState.inCombat) return;
            
            addToOutput(`The ${gameState.currentEnemy.name} attacks!`, "enemy-text");
            
            // Calculate damage (consider player defense)
            let damage = Math.max(1, gameState.currentEnemy.attack - gameState.defense);
            
            // Critical hit chance
            if (Math.random() < 0.1) {
                damage = Math.floor(damage * 1.5);
                addToOutput("Critical hit!", "danger-text");
            }
            
            gameState.health -= damage;
            
            addToOutput(`The ${gameState.currentEnemy.name} hits you for ${damage} damage!`, "damage-text");
            
            updateCombatUI();
            
            // Check if player is defeated
            if (gameState.health <= 0) {
                playerDefeated();
                return;
            }
            
            // Player's turn again
            gameState.playerTurn = true;
            updateCombatChoices(); // Refresh abilities in case mana changed
        }
        
        function enemyDefeated() {
            addToOutput(`You defeated the ${gameState.currentEnemy.name}!`, "success-text");
            
            // Award gold and score
            const goldEarned = gameState.currentEnemy.gold;
            const xpEarned = gameState.currentEnemy.xp;
            
            gameState.gold += goldEarned;
            gameState.score += xpEarned;
            
            addToOutput(`You gain ${goldEarned} gold and ${xpEarned} score!`, "gold-text");
            
            // Chance to drop loot
            const dropChance = Math.random();
            if (dropChance < 0.5) {
                // Determine loot based on enemy floor
                const floorIndex = Math.min(gameState.currentFloor - 1, 3);
                let lootPool = [];
                
                if (floorIndex === 0) lootPool = ["health potion", "iron sword", "leather armor", "wooden shield"];
                else if (floorIndex === 1) lootPool = ["mana potion", "steel sword", "chainmail", "health amulet"];
                else if (floorIndex === 2) lootPool = ["greater health potion", "war hammer", "plate armor", "lucky charm"];
                else lootPool = ["elixir", "enchanted blade", "dragon scale armor", "vampire ring"];
                
                const lootType = lootPool[Math.floor(Math.random() * lootPool.length)];
                
                addToOutput(`The enemy drops a ${lootType.toUpperCase()}!`, "loot-text");
                gameState.inventory.push(lootType);
                updateInventory();
            }
            
            // End combat
            gameState.inCombat = false;
            gameState.currentEnemy = null;
            
            hideCombatPanel();
            updateStatus();
            
            // Check if player just defeated the final boss
            if (gameState.currentFloor >= 5 && gameState.currentEnemy && 
                (gameState.currentEnemy.name === "Demon Lord" || gameState.currentEnemy.name === "Tower Master")) {
                setTimeout(victory, 1000);
            }
        }
        
        function playerDefeated() {
            addToOutput("You have been defeated!", "danger-text");
            addToOutput("GAME OVER", "combat-text");
            
            // Calculate final score
            gameState.score += Math.floor(gameState.gold / 2);
            addToOutput(`Final Score: ${gameState.score}`, "important-text");
            
            // Disable all buttons
            document.querySelectorAll('.button, .command-button').forEach(btn => btn.disabled = true);
            
            // End combat
            gameState.inCombat = false;
            hideCombatPanel();
        }
        
        function attemptFlee() {
            if (!gameState.inCombat) return;
            
            let fleeChance = 0.6; // Base 60% chance to flee
            
            // Check for smoke bomb in inventory
            if (gameState.inventory.includes("smoke bomb")) {
                fleeChance += 0.3;
                // Remove smoke bomb
                const bombIndex = gameState.inventory.indexOf("smoke bomb");
                if (bombIndex > -1) {
                    gameState.inventory.splice(bombIndex, 1);
                    addToOutput("You use a smoke bomb to cover your escape!", "important-text");
                    updateInventory();
                }
            }
            
            if (Math.random() < fleeChance) {
                addToOutput("You successfully flee from combat!", "success-text");
                gameState.inCombat = false;
                gameState.currentEnemy = null;
                hideCombatPanel();
                
                // Take a small amount of damage when fleeing
                const fleeDamage = Math.floor(Math.random() * 10) + 5;
                gameState.health -= fleeDamage;
                addToOutput(`You take ${fleeDamage} damage while fleeing.`, "damage-text");
                
                updateStatus();
                
                if (gameState.health <= 0) {
                    playerDefeated();
                }
            } else {
                addToOutput("You failed to flee!", "danger-text");
                
                // Enemy gets a free attack
                gameState.playerTurn = false;
                setTimeout(enemyAttack, 1000);
            }
        }
        
        // ============================================
        // INVENTORY & EQUIPMENT MANAGEMENT
        // ============================================
        function updateInventory() {
            inventoryItems.innerHTML = "";
            
            if (gameState.inventory.length === 0) {
                const emptyItem = document.createElement("div");
                emptyItem.className = "inventory-item";
                emptyItem.textContent = "Empty";
                inventoryItems.appendChild(emptyItem);
            } else {
                // Group items by type for better display
                const itemCounts = {};
                gameState.inventory.forEach(item => {
                    itemCounts[item] = (itemCounts[item] || 0) + 1;
                });
                
                Object.keys(itemCounts).forEach(item => {
                    const itemElement = document.createElement("div");
                    itemElement.className = "inventory-item";
                    const count = itemCounts[item] > 1 ? ` (${itemCounts[item]})` : '';
                    itemElement.textContent = `${item.toUpperCase()}${count}`;
                    inventoryItems.appendChild(itemElement);
                });
            }
        }
        
        function updateEquipmentDisplay() {
            equipmentSlots.innerHTML = '';
            
            // Weapon slot
            const weaponSlot = document.createElement("div");
            weaponSlot.className = "equipment-slot";
            weaponSlot.innerHTML = `<strong>WEAPON</strong><br>${gameState.equipment.weapon ? gameState.equipment.weapon.toUpperCase() : 'None'}`;
            equipmentSlots.appendChild(weaponSlot);
            
            // Armor slot
            const armorSlot = document.createElement("div");
            armorSlot.className = "equipment-slot";
            armorSlot.innerHTML = `<strong>ARMOR</strong><br>${gameState.equipment.armor ? gameState.equipment.armor.toUpperCase() : 'None'}`;
            equipmentSlots.appendChild(armorSlot);
            
            // Shield slot
            const shieldSlot = document.createElement("div");
            shieldSlot.className = "equipment-slot";
            shieldSlot.innerHTML = `<strong>SHIELD</strong><br>${gameState.equipment.shield ? gameState.equipment.shield.toUpperCase() : 'None'}`;
            equipmentSlots.appendChild(shieldSlot);
            
            // Accessory slot
            const accessorySlot = document.createElement("div");
            accessorySlot.className = "equipment-slot";
            accessorySlot.innerHTML = `<strong>ACCESSORY</strong><br>${gameState.equipment.accessory ? gameState.equipment.accessory.toUpperCase() : 'None'}`;
            equipmentSlots.appendChild(accessorySlot);
            
            // Stats display
            const statsSlot = document.createElement("div");
            statsSlot.className = "equipment-slot";
            statsSlot.innerHTML = `<strong>STATS</strong><br>ATK: ${gameState.attack}<br>DEF: ${gameState.defense}<br>HP: ${gameState.maxHealth}<br>MP: ${gameState.maxMana}`;
            equipmentSlots.appendChild(statsSlot);
        }
        
        // ============================================
        // GAME COMMANDS
        // ============================================
        function handleLook() {
            if (gameState.inCombat) {
                addToOutput("You're in combat! Focus on the enemy!", "combat-text");
                return;
            }
            
            const roomDesc = gameState.roomDescriptions[gameState.currentRoom];
            addToOutput(roomDesc);
            
            // Check if there's an NPC in the room
            if (gameState.roomNPCs[gameState.currentRoom]) {
                const npcType = gameState.roomNPCs[gameState.currentRoom];
                const npc = npcData[npcType];
                addToOutput(`You see ${npc.name} here. ${npc.description}`, "npc-text");
            }
            
            // Check if room has been explored
            if (!gameState.exploredRooms[gameState.currentRoom]) {
                addToOutput("The room hasn't been fully explored yet. Try using the EXPLORE command.", "important-text");
            }
            
            autoScrollToBottom();
        }
        
        function handleExplore() {
            if (gameState.inCombat) {
                addToOutput("You're in combat! You can't explore now!", "combat-text");
                return;
            }
            
            if (gameState.exploredRooms[gameState.currentRoom]) {
                addToOutput("You've already explored this room thoroughly.");
                autoScrollToBottom();
                return;
            }
            
            addToOutput("You carefully explore the area...", "important-text");
            
            // Determine what happens during exploration
            const explorationRoll = Math.random();
            
            if (explorationRoll < 0.4) {
                // Encounter an enemy
                triggerEnemyEncounter();
            } else if (explorationRoll < 0.7) {
                // Find loot (if room has loot)
                if (gameState.roomLootAvailable[gameState.currentRoom]) {
                    findLoot();
                } else {
                    // Find gold instead
                    const goldFound = Math.floor(Math.random() * 30) + 10;
                    addToOutput(`You find ${goldFound} gold coins!`, "gold-text");
                    gameState.gold += goldFound;
                    updateStatus();
                }
            } else if (explorationRoll < 0.85) {
                // Find a useful item
                const items = ["health potion", "mana potion", "torch", "lockpick"];
                const foundItem = items[Math.floor(Math.random() * items.length)];
                addToOutput(`You find a ${foundItem.toUpperCase()}!`, "loot-text");
                gameState.inventory.push(foundItem);
                updateInventory();
            } else {
                // Find nothing or something special
                addToOutput("You explore the area but find nothing of value.");
            }
            
            gameState.exploredRooms[gameState.currentRoom] = true;
            autoScrollToBottom();
        }
        
        function triggerEnemyEncounter() {
            // Determine enemy based on floor
            let enemyPool = [];
            const floorEnemies = {
                1: ["zombie", "skeleton", "ghoul", "giantRat"],
                2: ["specter", "wraith", "ghost", "goblin"],
                3: ["demon", "lich", "vampire", "troll"],
                4: ["behemoth", "dragon", "abomination", "knight"],
                5: ["demonLord", "towerMaster"]
            };
            
            enemyPool = floorEnemies[gameState.currentFloor] || floorEnemies[1];
            const enemyType = enemyPool[Math.floor(Math.random() * enemyPool.length)];
            
            // Create enemy object
            const enemyTemplate = enemies[enemyType];
            gameState.currentEnemy = {
                name: enemyTemplate.name,
                health: enemyTemplate.health,
                maxHealth: enemyTemplate.maxHealth,
                attack: enemyTemplate.attack,
                defense: enemyTemplate.defense,
                gold: enemyTemplate.gold,
                xp: enemyTemplate.xp
            };
            
            addToOutput(`A ${gameState.currentEnemy.name} appears!`, "enemy-text");
            addToOutput("COMBAT INITIATED!", "combat-text");
            
            gameState.inCombat = true;
            gameState.playerTurn = true;
            
            showCombatPanel();
            autoScrollToBottom();
        }
        
        function findLoot() {
            let lootPool = [];
            
            // Different loot based on room type
            switch(gameState.currentRoom) {
                case "armory":
                    lootPool = ["iron sword", "steel sword", "chainmail", "plate armor", "wooden shield", "iron shield"];
                    break;
                case "storageRoom":
                    lootPool = ["health potion", "mana potion", "torch", "lockpick", "throwing knife", "antidote"];
                    break;
                case "library":
                    lootPool = ["scroll of fireball", "scroll of healing", "mana ring", "attack bracelet", "defense ring"];
                    break;
                default:
                    lootPool = ["health potion", "mana potion", "gold", "torch"];
            }
            
            const lootType = lootPool[Math.floor(Math.random() * lootPool.length)];
            
            if (lootType === "gold") {
                const goldFound = Math.floor(Math.random() * 50) + 20;
                addToOutput(`You find ${goldFound} gold coins!`, "gold-text");
                gameState.gold += goldFound;
                updateStatus();
            } else {
                addToOutput(`You find a ${lootType.toUpperCase()}!`, "loot-text");
                gameState.inventory.push(lootType);
                updateInventory();
            }
            
            autoScrollToBottom();
        }
        
        function handleInventory() {
            if (gameState.inCombat) {
                addToOutput("You can't access inventory during combat!", "combat-text");
                autoScrollToBottom();
                return;
            }
            
            if (inventoryPanel.style.display === "block") {
                inventoryPanel.style.display = "none";
            } else {
                inventoryPanel.style.display = "block";
                updateInventory();
            }
            autoScrollToBottom();
        }
        
        function handleEquipment() {
            if (gameState.inCombat) {
                addToOutput("You can't change equipment during combat!", "combat-text");
                autoScrollToBottom();
                return;
            }
            
            if (equipmentPanel.style.display === "block") {
                equipmentPanel.style.display = "none";
            } else {
                equipmentPanel.style.display = "block";
                updateEquipmentDisplay();
            }
            autoScrollToBottom();
        }
        
        function handleUseItem() {
            if (gameState.inCombat) {
                addToOutput("You can't use items from inventory during combat! Use the combat item button instead.", "combat-text");
                autoScrollToBottom();
                return;
            }
            
            if (gameState.inventory.length === 0) {
                addToOutput("Your inventory is empty. There's nothing to use.");
                autoScrollToBottom();
                return;
            }
            
            // Filter usable items
            const usableItems = gameState.inventory.filter(item => 
                consumableItems[item] || equipmentItems[item]
            );
            
            if (usableItems.length === 0) {
                addToOutput("You have no usable items in your inventory.");
                autoScrollToBottom();
                return;
            }
            
            const choices = usableItems.map((item, index) => ({
                text: `${item.toUpperCase()}${equipmentItems[item] ? ` (Equip)` : ` (Use)`}`,
                value: item
            }));
            
            // Add option to cancel
            choices.push({ text: "CANCEL", value: "cancel" });
            
            showActionPanel("USE OR EQUIP ITEM:", choices, handleUseItemChoice);
            autoScrollToBottom();
        }
        
        function handleUseItemChoice(item) {
            if (item === "cancel") {
                addToOutput("Cancelled.");
                autoScrollToBottom();
                return;
            }
            
            // Check if it's equipment
            if (equipmentItems[item]) {
                equipItem(item);
                autoScrollToBottom();
                return;
            }
            
            // Check if it's a consumable
            if (consumableItems[item]) {
                useConsumable(item);
                autoScrollToBottom();
                return;
            }
            
            addToOutput(`You can't use the ${item} right now.`);
            autoScrollToBottom();
        }
        
        function equipItem(item) {
            const itemData = equipmentItems[item];
            const slot = itemData.type;
            
            // Check if player already has something equipped in this slot
            if (gameState.equipment[slot]) {
                // Unequip current item
                const oldItem = gameState.equipment[slot];
                gameState.inventory.push(oldItem);
                
                // Remove stats
                removeEquipmentStats(oldItem);
                
                addToOutput(`You unequip ${oldItem}.`, "important-text");
            }
            
            // Equip new item
            gameState.equipment[slot] = item;
            
            // Remove from inventory
            const itemIndex = gameState.inventory.indexOf(item);
            if (itemIndex > -1) {
                gameState.inventory.splice(itemIndex, 1);
            }
            
            // Add stats
            applyEquipmentStats(item);
            
            addToOutput(`You equip ${item}.`, "success-text");
            
            updateInventory();
            updateEquipmentDisplay();
            updateStatus();
            autoScrollToBottom();
        }
        
        function applyEquipmentStats(item) {
            const itemData = equipmentItems[item];
            
            if (itemData.attack) gameState.attack += itemData.attack;
            if (itemData.defense) gameState.defense += itemData.defense;
            if (itemData.healthBonus) gameState.maxHealth += itemData.healthBonus;
            if (itemData.manaBonus) gameState.maxMana += itemData.manaBonus;
            if (itemData.attackBonus) gameState.attack += itemData.attackBonus;
            if (itemData.defenseBonus) gameState.defense += itemData.defenseBonus;
        }
        
        function removeEquipmentStats(item) {
            const itemData = equipmentItems[item];
            
            if (itemData.attack) gameState.attack -= itemData.attack;
            if (itemData.defense) gameState.defense -= itemData.defense;
            if (itemData.healthBonus) gameState.maxHealth -= itemData.healthBonus;
            if (itemData.manaBonus) gameState.maxMana -= itemData.manaBonus;
            if (itemData.attackBonus) gameState.attack -= itemData.attackBonus;
            if (itemData.defenseBonus) gameState.defense -= itemData.defenseBonus;
            
            // Ensure max health/mana doesn't go below current
            if (gameState.health > gameState.maxHealth) gameState.health = gameState.maxHealth;
            if (gameState.mana > gameState.maxMana) gameState.mana = gameState.maxMana;
        }
        
        function useConsumable(item) {
            const itemData = consumableItems[item];
            
            // Remove from inventory
            const itemIndex = gameState.inventory.indexOf(item);
            if (itemIndex > -1) {
                gameState.inventory.splice(itemIndex, 1);
            }
            
            // Apply effects
            if (itemData.healthRestore) {
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + itemData.healthRestore);
                const healed = gameState.health - oldHealth;
                addToOutput(`You use ${item} and restore ${healed} health.`, "heal-text");
            }
            
            if (itemData.manaRestore) {
                const oldMana = gameState.mana;
                gameState.mana = Math.min(gameState.maxMana, gameState.mana + itemData.manaRestore);
                const restored = gameState.mana - oldMana;
                addToOutput(`You use ${item} and restore ${restored} mana.`, "heal-text");
            }
            
            if (itemData.curePoison) {
                addToOutput(`You use ${item} and cure any poisoning.`, "heal-text");
            }
            
            updateInventory();
            updateStatus();
            autoScrollToBottom();
        }
        
        function handleRest() {
            if (gameState.inCombat) {
                addToOutput("You can't rest during combat!", "combat-text");
                autoScrollToBottom();
                return;
            }
            
            if (gameState.health >= gameState.maxHealth && gameState.mana >= gameState.maxMana) {
                addToOutput("You're already at full health and mana.");
                autoScrollToBottom();
                return;
            }
            
            addToOutput("You take a moment to rest and recover...", "important-text");
            
            // Restore health and mana
            const healthRestored = Math.floor(gameState.maxHealth * 0.4);
            const manaRestored = Math.floor(gameState.maxMana * 0.6);
            
            gameState.health = Math.min(gameState.maxHealth, gameState.health + healthRestored);
            gameState.mana = Math.min(gameState.maxMana, gameState.mana + manaRestored);
            
            addToOutput(`You restore ${healthRestored} health and ${manaRestored} mana.`, "heal-text");
            
            // Small chance of enemy encounter while resting
            if (Math.random() < 0.2) {
                addToOutput("An enemy stumbles upon you while you're resting!", "danger-text");
                setTimeout(() => {
                    triggerEnemyEncounter();
                    autoScrollToBottom();
                }, 1000);
            }
            
            updateStatus();
            autoScrollToBottom();
        }
        
        function handleMove() {
            if (gameState.inCombat) {
                addToOutput("You can't move during combat!", "combat-text");
                autoScrollToBottom();
                return;
            }
            
            const connections = gameState.roomConnections[gameState.currentRoom];
            const directions = [];
            
            if (connections.north) directions.push({ text: "NORTH", value: connections.north });
            if (connections.east) directions.push({ text: "EAST", value: connections.east });
            if (connections.west) directions.push({ text: "WEST", value: connections.west });
            if (connections.south) directions.push({ text: "SOUTH", value: connections.south });
            
            if (directions.length === 0) {
                addToOutput("There are no exits from this room.");
                autoScrollToBottom();
                return;
            }
            
            showActionPanel("MOVE WHERE?", directions, handleMoveChoice);
            autoScrollToBottom();
        }
        
        function handleMoveChoice(roomId) {
            gameState.currentRoom = roomId;
            
            // Convert room ID to readable name
            const roomName = roomId.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            addToOutput(`You move to the ${roomName}.`, "important-text");
            
            // Show room description
            const roomDesc = gameState.roomDescriptions[roomId];
            addToOutput(roomDesc);
            
            // Check for NPC
            if (gameState.roomNPCs[roomId]) {
                const npcType = gameState.roomNPCs[roomId];
                const npc = npcData[npcType];
                addToOutput(`You see ${npc.name} here.`, "npc-text");
            }
            
            updateStatus();
            autoScrollToBottom();
        }
        
        function handleTalk() {
            if (gameState.inCombat) {
                addToOutput("You can't talk during combat!", "combat-text");
                autoScrollToBottom();
                return;
            }
            
            // Check if there's an NPC in the room
            const npcType = gameState.roomNPCs[gameState.currentRoom];
            
            if (!npcType) {
                addToOutput("There's no one here to talk to.");
                autoScrollToBottom();
                return;
            }
            
            const npc = npcData[npcType];
            const interaction = gameState.npcInteractions[npcType];
            
            // Show initial dialogue or regular dialogue
            if (!interaction.talked) {
                addConversation(npcType, npc.dialogue.initial, npcType);
                interaction.talked = true;
            } else {
                addConversation(npcType, npc.dialogue.regular, npcType);
            }
            
            // Show service options
            setTimeout(() => {
                const choices = npc.dialogue.services.map(service => ({
                    text: service.name + (service.gold > 0 ? ` (${service.gold} gold)` : ''),
                    value: service.action
                }));
                
                showActionPanel(`TALK TO ${npc.name.toUpperCase()}:`, choices, (action) => handleNPCAction(npcType, action));
                autoScrollToBottom();
            }, 500);
        }
        
        function handleNPCAction(npcType, action) {
            const npc = npcData[npcType];
            
            switch(action) {
                case "goodbye":
                    addConversation("player", "Goodbye.", "player");
                    addConversation(npcType, "Farewell, traveler.", npcType);
                    break;
                    
                case "blacksmith_buy":
                    showBlacksmithBuy();
                    break;
                    
                case "blacksmith_repair":
                    if (gameState.gold >= 20) {
                        gameState.gold -= 20;
                        addConversation("player", "Please repair my equipment.", "player");
                        addConversation(npcType, "Aye, I'll have it good as new!", npcType);
                        addToOutput("Thrain repairs your equipment. All durability restored!", "success-text");
                        updateStatus();
                    } else {
                        addConversation(npcType, "You don't have enough gold for repairs.", npcType);
                    }
                    break;
                    
                case "prisoner_info":
                    addConversation("player", "Tell me about the tower.", "player");
                    addConversation(npcType, "The tower has 5 floors... each more dangerous than the last. The master resides at the top. He's... not human anymore.", npcType);
                    break;
                    
                case "prisoner_key":
                    addConversation("player", "What key do you need?", "player");
                    addConversation(npcType, "The jailer's key... it's on the jailer's corpse in the torture chamber. Free me, and I'll reward you.", npcType);
                    break;
                    
                case "prisoner_free":
                    // Check if player has jailer's key
                    if (gameState.inventory.includes("jailer's key") || gameState.currentRoom === "tortureChamber") {
                        addConversation("player", "I'll free you.", "player");
                        addConversation(npcType, "Thank you! I was once a knight... here, take my family heirloom.", npcType);
                        addToOutput("The prisoner gives you an ANCIENT AMULET!", "loot-text");
                        gameState.inventory.push("ancient amulet");
                        updateInventory();
                        gameState.score += 100;
                        updateStatus();
                    } else {
                        addConversation(npcType, "You need the jailer's key first. It's in the torture chamber.", npcType);
                    }
                    break;
                    
                default:
                    addConversation(npcType, "I can't help you with that right now.", npcType);
            }
            
            autoScrollToBottom();
        }
        
        function showBlacksmithBuy() {
            const weaponsForSale = [
                { name: "Iron Sword", cost: 50, item: "iron sword" },
                { name: "Steel Sword", cost: 120, item: "steel sword" },
                { name: "War Hammer", cost: 150, item: "war hammer" },
                { name: "Chainmail", cost: 80, item: "chainmail" },
                { name: "Plate Armor", cost: 200, item: "plate armor" },
                { name: "Iron Shield", cost: 60, item: "iron shield" }
            ];
            
            const choices = weaponsForSale.map(weapon => ({
                text: `${weapon.name} (${weapon.cost} gold)`,
                value: weapon.item,
                cost: weapon.cost
            }));
            
            choices.push({ text: "CANCEL", value: "cancel", cost: 0 });
            
            showActionPanel("BUY FROM BLACKSMITH:", choices, (item) => handleBlacksmithPurchase(item, weaponsForSale));
        }
        
        function handleBlacksmithPurchase(item, weaponsForSale) {
            if (item === "cancel") {
                addToOutput("You decide not to buy anything.");
                autoScrollToBottom();
                return;
            }
            
            const weapon = weaponsForSale.find(w => w.item === item);
            
            if (gameState.gold >= weapon.cost) {
                gameState.gold -= weapon.cost;
                gameState.inventory.push(weapon.item);
                addToOutput(`You buy ${weapon.name} for ${weapon.cost} gold.`, "success-text");
                updateInventory();
                updateStatus();
            } else {
                addToOutput("You don't have enough gold for that.", "danger-text");
            }
            
            autoScrollToBottom();
        }
        
        // ============================================
        // VICTORY CONDITION
        // ============================================
        function victory() {
            addToOutput("CONGRATULATIONS!", "success-text");
            addToOutput("You have conquered the Tower of Terror!", "important-text");
            
            // Calculate final score bonus
            const victoryBonus = gameState.currentFloor * 200 + gameState.gold;
            gameState.score += victoryBonus;
            
            addToOutput(`Victory Bonus: ${victoryBonus}`, "gold-text");
            addToOutput(`Final Score: ${gameState.score}`, "important-text");
            addToOutput("You are a true hero!", "success-text");
            
            // Disable all buttons
            document.querySelectorAll('.button, .command-button').forEach(btn => btn.disabled = true);
            
            // Show victory message
            setTimeout(() => {
                addToOutput("Thanks for playing TOWER OF TERROR!", "important-text");
                addToOutput("Refresh the page to play again.", "success-text");
                autoScrollToBottom();
            }, 2000);
        }
        
        // ============================================
        // INITIALIZE GAME
        // ============================================
        initGame();
    </script>
</body>
</html>
