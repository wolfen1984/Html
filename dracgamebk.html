<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dracula's Redemption - Complete Gamebook</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .game-container {
            border: 4px double #fff;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #111;
            min-height: 80vh;
        }
        
        .screen {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        h1, h2, h3 {
            color: #ff3333;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 5px #ff0000;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 30px;
        }
        
        h2 {
            font-size: 1.8rem;
            margin-top: 20px;
        }
        
        h3 {
            font-size: 1.2rem;
            text-align: left;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-top: 15px;
        }
        
        .game-text {
            background-color: #000;
            border: 2px solid #333;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.8;
        }
        
        .game-text p {
            margin-bottom: 15px;
        }
        
        .npc-dialogue {
            color: #ffff66;
            font-style: italic;
            margin: 10px 0;
            padding-left: 10px;
            border-left: 2px solid #ffff66;
        }
        
        .player-dialogue {
            color: #66ff66;
            margin: 10px 0;
            padding-left: 10px;
            border-left: 2px solid #66ff66;
        }
        
        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        button {
            background-color: #222;
            color: #fff;
            border: 2px solid #666;
            font-family: 'Press Start 2P', cursive;
            padding: 12px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            flex-grow: 1;
            min-width: 200px;
        }
        
        button:hover:not(:disabled) {
            background-color: #333;
            border-color: #ff3333;
            color: #ff3333;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            background-color: #222;
            padding: 10px;
            border: 1px solid #444;
        }
        
        .stat-value {
            color: #ffff66;
            font-weight: bold;
        }
        
        .inventory {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .item {
            background-color: #1a1a1a;
            padding: 8px;
            border: 1px solid #333;
            font-size: 0.8rem;
        }
        
        .item-rare {
            border-color: #ff9900;
            color: #ff9900;
        }
        
        .item-legendary {
            border-color: #ff3366;
            color: #ff3366;
        }
        
        .outcome-good {
            color: #66ff66;
        }
        
        .outcome-bad {
            color: #ff6666;
        }
        
        .warning {
            color: #ff9900;
        }
        
        .game-over {
            color: #ff0000;
            font-size: 1.5rem;
            text-align: center;
            margin: 30px 0;
        }
        
        .victory {
            color: #66ff66;
            font-size: 1.5rem;
            text-align: center;
            margin: 30px 0;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 0.7rem;
            border-top: 1px solid #333;
            padding-top: 15px;
        }
        
        /* New styles for gamebook features */
        .dice-roll {
            background-color: #2a2a2a;
            border: 2px solid #555;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
        }
        
        .dice-result {
            font-size: 1.5rem;
            color: #ffff66;
            margin: 10px 0;
        }
        
        .combat-log {
            background-color: #330000;
            border: 1px solid #660000;
            padding: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .combat-turn {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px dotted #660000;
        }
        
        .skill-check {
            background-color: #1a1a2a;
            border: 1px solid #4444ff;
            padding: 10px;
            margin: 10px 0;
        }
        
        .puzzle {
            background-color: #2a1a2a;
            border: 2px dashed #aa66aa;
            padding: 15px;
            margin: 15px 0;
        }
        
        .trap {
            background-color: #552222;
            border: 2px solid #ff5555;
            padding: 15px;
            margin: 15px 0;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { border-color: #ff5555; }
            50% { border-color: #ff0000; }
            100% { border-color: #ff5555; }
        }
        
        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background-color: #222;
            border: 1px solid #444;
        }
        
        .item-use-btn {
            padding: 5px 10px;
            font-size: 0.7rem;
            background-color: #333;
            border: 1px solid #666;
            cursor: pointer;
        }
        
        .health-bar {
            width: 100%;
            height: 20px;
            background-color: #330000;
            border: 1px solid #666;
            margin: 5px 0;
            position: relative;
        }
        
        .health-fill {
            height: 100%;
            background-color: #ff0000;
            transition: width 0.3s;
        }
        
        .health-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
            line-height: 20px;
            font-size: 0.7rem;
        }
        
        .luck-bar {
            width: 100%;
            height: 15px;
            background-color: #222244;
            border: 1px solid #4444aa;
            margin: 5px 0;
            position: relative;
        }
        
        .luck-fill {
            height: 100%;
            background-color: #4444ff;
            transition: width 0.3s;
        }
        
        .luck-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
            line-height: 15px;
            font-size: 0.6rem;
        }
        
        .section-number {
            color: #ff9900;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .gamebook-text {
            font-size: 1rem;
            line-height: 1.8;
        }
        
        .gamebook-text p {
            margin-bottom: 20px;
        }
        
        .turn-to {
            color: #ff9900;
            font-weight: bold;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .turn-to:hover {
            color: #ffcc00;
        }
        
        .combat-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .combat-stat {
            background-color: #2a2a2a;
            padding: 10px;
            text-align: center;
        }
        
        .enemy-sprite {
            text-align: center;
            margin: 15px 0;
            font-size: 3rem;
        }
        
        .continue-btn {
            background-color: #333;
            color: #66ff66;
            border: 2px solid #66ff66;
            font-size: 1rem;
            padding: 15px;
            margin: 20px auto;
            display: block;
            width: 80%;
        }
        
        .continue-btn:hover {
            background-color: #66ff66;
            color: #000;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .game-text {
                font-size: 0.8rem;
            }
            
            button {
                font-size: 0.7rem;
                min-width: 150px;
            }
            
            .combat-stats {
                grid-template-columns: 1fr;
            }
            
            .continue-btn {
                width: 95%;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Start Screen -->
        <div id="start-screen" class="screen active">
            <h1>DRACULA'S REDEMPTION - GAMEBOOK ADVENTURE</h1>
            <div class="game-text">
                <p>Transylvania, 1897. You are Count Dracula, an ancient vampire trapped between darkness and humanity.</p>
                <p>Tonight, the blood moon rises, and your castle calls to you. But in the village below, whispers tell of hunters, ancient relics, and a mysterious woman who knows your secret.</p>
                <p>Will you embrace your vampiric nature, seek redemption, or find a balance between both worlds?</p>
                <p>Your adventure is shaped by dice rolls, skill tests, and combat. Choose wisely - your Stamina, Skill, and Luck will be tested!</p>
                <p class="warning">Gamebook Style: Navigate through numbered sections. Roll dice for combat and skill tests.</p>
                <p class="outcome-good">INCLUDES: Dice-based combat, inventory management, puzzles, traps, NPCs, and multiple endings!</p>
            </div>
            <div class="button-container">
                <button id="start-btn">BEGIN ADVENTURE</button>
                <button id="rules-btn">GAME RULES</button>
            </div>
        </div>
        
        <!-- Rules Screen -->
        <div id="rules-screen" class="screen">
            <h2>GAMEBOOK RULES</h2>
            <div class="game-text">
                <h3>HOW TO PLAY</h3>
                <p>This is a gamebook adventure like Fighting Fantasy books. You'll navigate through numbered sections (paragraphs) and make choices that determine what happens next.</p>
                
                <h3>YOUR CHARACTER</h3>
                <p><span class="outcome-good">STAMINA:</span> Your health. If it reaches 0, you die.</p>
                <p><span class="outcome-good">SKILL:</span> Your combat ability and general prowess.</p>
                <p><span class="outcome-good">LUCK:</span> Your fortune. Test your Luck in dangerous situations.</p>
                <p><span class="outcome-good">CHARISMA:</span> Your ability to persuade and deceive.</p>
                <p><span class="outcome-good">PERCEPTION:</span> Your ability to notice details and detect danger.</p>
                <p><span class="outcome-good">WILLPOWER:</span> Your mental strength to resist dark influences.</p>
                
                <h3>COMBAT</h3>
                <p>When you enter combat:</p>
                <p>1. Roll two dice and add your SKILL score for your Attack Strength.</p>
                <p>2. The enemy does the same.</p>
                <p>3. Higher Attack Strength hits the opponent, reducing their STAMINA.</p>
                <p>4. Repeat until one combatant's STAMINA reaches 0.</p>
                
                <h3>TEST YOUR LUCK</h3>
                <p>When asked to Test Your Luck:</p>
                <p>1. Roll two dice.</p>
                <p>2. If the roll is EQUAL TO OR LESS than your current LUCK, you are Lucky.</p>
                <p>3. If the roll is HIGHER than your LUCK, you are Unlucky.</p>
                <p>4. Each time you Test Your Luck, reduce your LUCK score by 1.</p>
                
                <h3>SKILL TESTS</h3>
                <p>When asked to test a skill (Charisma, Perception, Willpower):</p>
                <p>1. Roll two dice.</p>
                <p>2. If the roll is EQUAL TO OR LESS than your skill score, you succeed.</p>
                <p>3. If the roll is HIGHER, you fail.</p>
            </div>
            <div class="button-container">
                <button onclick="showStartScreen()">RETURN TO START</button>
                <button onclick="showCharacterScreen()">CREATE CHARACTER</button>
            </div>
        </div>
        
        <!-- Character Creation Screen -->
        <div id="character-screen" class="screen">
            <h2>CREATE YOUR DRACULA</h2>
            <div class="game-text">
                <p>Roll two dice and add 12 to determine your initial STAMINA.</p>
                <p>Roll one die and add 6 to determine your initial SKILL.</p>
                <p>Roll one die and add 6 to determine your initial LUCK.</p>
                <p>Distribute 12 points among Charisma, Perception, and Willpower (minimum 4 each).</p>
                
                <div class="stats-container">
                    <div class="stat-item">
                        <h3>STAMINA <span id="stamina-value" class="stat-value">?</span></h3>
                        <p>Your health and endurance</p>
                        <button onclick="rollStamina()">ROLL STAMINA</button>
                    </div>
                    <div class="stat-item">
                        <h3>SKILL <span id="skill-value" class="stat-value">?</span></h3>
                        <p>Your combat ability</p>
                        <button onclick="rollSkill()">ROLL SKILL</button>
                    </div>
                    <div class="stat-item">
                        <h3>LUCK <span id="luck-value" class="stat-value">?</span></h3>
                        <p>Your fortune</p>
                        <button onclick="rollLuck()">ROLL LUCK</button>
                    </div>
                </div>
                
                <div class="stats-container">
                    <div class="stat-item">
                        <h3>CHARISMA <span id="charisma-value" class="stat-value">4</span></h3>
                        <p>Persuasion and deception</p>
                        <button onclick="changeStat('charisma', 1)" id="charisma-plus">+</button>
                        <button onclick="changeStat('charisma', -1)" id="charisma-minus">-</button>
                    </div>
                    <div class="stat-item">
                        <h3>PERCEPTION <span id="perception-value" class="stat-value">4</span></h3>
                        <p>Detect truth and danger</p>
                        <button onclick="changeStat('perception', 1)" id="perception-plus">+</button>
                        <button onclick="changeStat('perception', -1)" id="perception-minus">-</button>
                    </div>
                    <div class="stat-item">
                        <h3>WILLPOWER <span id="willpower-value" class="stat-value">4</span></h3>
                        <p>Resist temptation and fear</p>
                        <button onclick="changeStat('willpower', 1)" id="willpower-plus">+</button>
                        <button onclick="changeStat('willpower', -1)" id="willpower-minus">-</button>
                    </div>
                </div>
                
                <p id="points-remaining">Points remaining: <span id="points">12</span></p>
                
                <h3>CHOOSE STARTING EQUIPMENT</h3>
                <p>Select one starting item:</p>
            </div>
            
            <div class="button-container">
                <button id="silver-dagger-btn" onclick="selectStartingItem('silver_dagger')">SILVER DAGGER (+1 Attack in combat)</button>
                <button id="healing-potion-btn" onclick="selectStartingItem('healing_potion')">HEALING POTION (Restore 4 Stamina)</button>
                <button id="lucky-charm-btn" onclick="selectStartingItem('lucky_charm')">LUCKY CHARM (+1 to Luck tests)</button>
            </div>
            
            <div class="button-container">
                <button id="begin-btn" disabled>BEGIN ADVENTURE</button>
                <button onclick="showStartScreen()">BACK</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <h2>DRACULA'S REDEMPTION</h2>
            
            <div class="stats-container">
                <div class="stat-item">
                    <h3>STAMINA</h3>
                    <div class="health-bar">
                        <div id="stamina-fill" class="health-fill" style="width: 100%"></div>
                        <div class="health-text"><span id="current-stamina">?</span>/<span id="max-stamina">?</span></div>
                    </div>
                </div>
                <div class="stat-item">
                    <h3>SKILL</h3>
                    <p class="stat-value" id="current-skill">?</p>
                </div>
                <div class="stat-item">
                    <h3>LUCK</h3>
                    <div class="luck-bar">
                        <div id="luck-fill" class="luck-fill" style="width: 100%"></div>
                        <div class="luck-text"><span id="current-luck">?</span>/<span id="initial-luck">?</span></div>
                    </div>
                </div>
                <div class="stat-item">
                    <h3>GOLD</h3>
                    <p class="stat-value" id="gold">0</p>
                </div>
            </div>
            
            <div class="button-container">
                <button onclick="showInventory()">INVENTORY (<span id="inventory-count">0</span>)</button>
                <button onclick="showStats()">CHARACTER SHEET</button>
                <button onclick="saveGame()">SAVE GAME</button>
                <button onclick="loadGame()">LOAD GAME</button>
            </div>
            
            <div class="game-text" id="game-text">
                <!-- Gamebook text will appear here -->
            </div>
            
            <div class="button-container" id="action-buttons">
                <!-- Action buttons will appear here -->
            </div>
        </div>
        
        <!-- Inventory Screen -->
        <div id="inventory-screen" class="screen">
            <h2>INVENTORY</h2>
            <div class="game-text">
                <h3>EQUIPMENT</h3>
                <div id="equipment-display">
                    <!-- Equipment will appear here -->
                </div>
                
                <h3>ITEMS</h3>
                <div id="items-display">
                    <!-- Items will appear here -->
                </div>
                
                <h3>SPECIAL ITEMS</h3>
                <div id="special-items-display">
                    <!-- Special items will appear here -->
                </div>
                
                <h3>PROVISIONS</h3>
                <div id="provisions-display">
                    <!-- Provisions will appear here -->
                </div>
            </div>
            <div class="button-container">
                <button onclick="returnToGame()">RETURN TO ADVENTURE</button>
            </div>
        </div>
        
        <!-- Stats Screen -->
        <div id="stats-screen" class="screen">
            <h2>CHARACTER SHEET</h2>
            <div class="game-text">
                <div class="stats-container">
                    <div class="stat-item">
                        <h3>STAMINA</h3>
                        <p class="stat-value" id="sheet-stamina">?</p>
                    </div>
                    <div class="stat-item">
                        <h3>SKILL</h3>
                        <p class="stat-value" id="sheet-skill">?</p>
                    </div>
                    <div class="stat-item">
                        <h3>LUCK</h3>
                        <p class="stat-value" id="sheet-luck">?</p>
                    </div>
                    <div class="stat-item">
                        <h3>CHARISMA</h3>
                        <p class="stat-value" id="sheet-charisma">?</p>
                    </div>
                    <div class="stat-item">
                        <h3>PERCEPTION</h3>
                        <p class="stat-value" id="sheet-perception">?</p>
                    </div>
                    <div class="stat-item">
                        <h3>WILLPOWER</h3>
                        <p class="stat-value" id="sheet-willpower">?</p>
                    </div>
                </div>
                
                <h3>COMBAT BONUSES</h3>
                <div id="combat-bonuses">
                    <!-- Combat bonuses will appear here -->
                </div>
                
                <h3>SKILL TEST HISTORY</h3>
                <div id="skill-test-history">
                    <!-- Skill test history will appear here -->
                </div>
            </div>
            <div class="button-container">
                <button onclick="returnToGame()">RETURN TO ADVENTURE</button>
            </div>
        </div>
        
        <!-- Combat Screen -->
        <div id="combat-screen" class="screen">
            <h2>COMBAT!</h2>
            <div class="game-text">
                <div id="combat-description">
                    <!-- Combat description will appear here -->
                </div>
                
                <div class="combat-stats">
                    <div class="combat-stat">
                        <h3>YOU</h3>
                        <p>STAMINA: <span id="player-combat-stamina">?</span></p>
                        <p>ATTACK STRENGTH: <span id="player-attack">?</span></p>
                        <div class="health-bar">
                            <div id="player-combat-health" class="health-fill"></div>
                            <div class="health-text"><span id="player-stamina-text">?</span></div>
                        </div>
                    </div>
                    <div class="combat-stat">
                        <h3 id="enemy-name">ENEMY</h3>
                        <p>STAMINA: <span id="enemy-combat-stamina">?</span></p>
                        <p>ATTACK STRENGTH: <span id="enemy-attack">?</span></p>
                        <div class="health-bar">
                            <div id="enemy-combat-health" class="health-fill"></div>
                            <div class="health-text"><span id="enemy-stamina-text">?</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="enemy-sprite" id="enemy-sprite">
                    ☠️
                </div>
                
                <div class="combat-log" id="combat-log">
                    <!-- Combat log will appear here -->
                </div>
                
                <div id="combat-options">
                    <!-- Combat options will appear here -->
                </div>
            </div>
        </div>
        
        <!-- Dice Roll Screen -->
        <div id="dice-screen" class="screen">
            <h2>ROLL THE DICE!</h2>
            <div class="game-text">
                <div class="dice-roll">
                    <p id="dice-reason">Testing your skill...</p>
                    <div class="dice-result" id="dice-result">
                        ?
                    </div>
                    <p id="dice-outcome">Roll the dice to see what happens!</p>
                </div>
                
                <div id="dice-options">
                    <!-- Dice options will appear here -->
                </div>
            </div>
        </div>
        
        <!-- Game Over Screen -->
        <div id="gameover-screen" class="screen">
            <h2>GAME OVER</h2>
            <div class="game-text" id="gameover-text">
                <!-- Game over text will appear here -->
            </div>
            <div class="button-container">
                <button onclick="restartGame()">TRY AGAIN</button>
                <button onclick="showStartScreen()">MAIN MENU</button>
            </div>
        </div>
        
        <!-- Victory Screen -->
        <div id="victory-screen" class="screen">
            <h2>VICTORY!</h2>
            <div class="game-text" id="victory-text">
                <!-- Victory text will appear here -->
            </div>
            <div class="button-container">
                <button onclick="restartGame()">PLAY AGAIN</button>
                <button onclick="showStartScreen()">MAIN MENU</button>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>DRACULA'S REDEMPTION - A GAMEBOOK ADVENTURE</p>
        <p>Fight monsters, solve puzzles, and choose your destiny!</p>
    </div>

    <script>
        // Game State
        const gameState = {
            screen: 'start',
            currentSection: 1,
            visitedSections: [],
            stats: {
                stamina: 0,
                maxStamina: 0,
                skill: 0,
                luck: 0,
                initialLuck: 0,
                charisma: 4,
                perception: 4,
                willpower: 4,
                points: 12
            },
            gold: 0,
            inventory: [],
            equipment: {
                weapon: null,
                armor: null,
                special: null
            },
            combatBonus: 0,
            luckBonus: 0,
            provisions: 0,
            gameOver: false,
            victory: false,
            inCombat: false,
            enemy: null,
            enemyData: null,
            combatRound: 0,
            diceRoll: 0,
            skillTestHistory: [],
            afterCombatSection: null,
            testLuckResult: null
        };
        
        // Gamebook Sections (COMPLETE IMPLEMENTATION)
        const gamebook = {
            1: {
                text: "You awaken in your coffin as the blood moon rises. The hunger burns within you, but something feels different tonight. A strange compulsion draws you toward the village. Will you:",
                options: [
                    { text: "Remain in your castle and explore the crypts", goto: 2 },
                    { text: "Travel to the village in search of blood", goto: 3 },
                    { text: "Investigate the strange compulsion you feel", goto: 4 }
                ]
            },
            2: {
                text: "You descend into the crypts beneath your castle. The air is cold and thick with dust. In the flickering torchlight, you see three doors:",
                options: [
                    { text: "The iron door to the left", goto: 5 },
                    { text: "The wooden door straight ahead", goto: 6 },
                    { text: "The stone door to the right", goto: 7 }
                ]
            },
            3: {
                text: "You transform into a bat and fly to the village. As you approach, you see lights in the tavern and hear laughter. A lone traveler walks the road below. Will you:",
                options: [
                    { text: "Attack the traveler to sate your hunger", goto: 8 },
                    { text: "Observe the village from a distance", goto: 9 },
                    { text: "Enter the tavern in human guise", goto: 10 }
                ]
            },
            4: {
                text: "The compulsion leads you to an ancient altar in the castle's deepest chamber. On it lies a mysterious amulet that pulses with dark energy. As you approach, you hear a voice whisper, 'Take me... use my power...' Will you:",
                options: [
                    { text: "Take the amulet", goto: 11 },
                    { text: "Destroy the amulet", goto: 12 },
                    { text: "Leave it and return to the castle entrance", goto: 1 }
                ]
            },
            5: {
                text: "The iron door creaks open to reveal a treasure chamber! Gold coins, jewels, and ancient artifacts fill the room. But as you enter, you trigger a trap! A giant stone slab begins to descend from the ceiling!",
                trap: true,
                options: [
                    { text: "Test your Perception to find an escape", skill: "perception", difficulty: 10, success: 13, failure: 14 },
                    { text: "Use your strength to hold up the slab", goto: 15 },
                    { text: "Quickly grab what you can and roll out", goto: 16 }
                ]
            },
            6: {
                text: "The wooden door opens to a library filled with ancient tomes. One book catches your eye: 'The Path to Redemption' by Father Mikhail. As you reach for it, a spectral librarian appears!",
                enemy: "spectral_librarian",
                afterCombat: 17,
                options: [
                    { text: "Fight the spectral librarian", goto: "combat" },
                    { text: "Try to reason with it", skill: "charisma", difficulty: 11, success: 18, failure: "combat" }
                ]
            },
            7: {
                text: "The stone door leads to an alchemy laboratory. Strange potions bubble on burners, and a skeleton wearing a tattered robe lies slumped over a desk. On the desk, you find three potions:",
                options: [
                    { text: "Drink the red potion", goto: 19 },
                    { text: "Drink the blue potion", goto: 20 },
                    { text: "Drink the green potion", goto: 21 },
                    { text: "Take all three potions", goto: 22 }
                ]
            },
            8: {
                text: "You descend upon the traveler, but as you grab him, he turns and reveals a silver cross! You must Test Your Luck to avoid its holy power.",
                testLuck: true,
                lucky: { text: "You dodge the cross and feed on the traveler. Restore 4 Stamina.", effect: { stamina: 4 }, goto: 23 },
                unlucky: { text: "The cross burns you! Lose 3 Stamina and the traveler escapes.", effect: { stamina: -3 }, goto: 24 }
            },
            9: {
                text: "From the shadows, you observe the village. You notice a woman in white leaving the church alone. A group of hunters enters the tavern. And a mysterious cloaked figure watches the graveyard. Will you:",
                options: [
                    { text: "Follow the woman in white", goto: 25 },
                    { text: "Investigate the hunters", goto: 26 },
                    { text: "Approach the cloaked figure", goto: 27 }
                ]
            },
            10: {
                text: "You transform into human form and enter the tavern. The patrons fall silent as you enter. The barkeep eyes you suspiciously. 'We don't serve your kind here,' he says, hand reaching beneath the counter. Test your Charisma to convince him you mean no harm.",
                skillCheck: { skill: "charisma", difficulty: 12 },
                success: { text: "'Very well, stranger. One ale.' You sit in a dark corner and listen to the villagers' conversations.", goto: 28 },
                failure: { text: "'I said we don't serve vampires!' He pulls out a wooden stake! You must fight!", enemy: "tavern_brawlers", afterCombat: 29, goto: "combat" }
            },
            11: {
                text: "You take the amulet. Dark energy surges through you! Your Skill increases by 1, but your Willpower decreases by 2. The amulet whispers to you, showing visions of unlimited power.",
                effect: { skill: 1, willpower: -2 },
                options: [
                    { text: "Continue exploring the castle", goto: 2 },
                    { text: "Go to the village", goto: 3 }
                ]
            },
            12: {
                text: "You destroy the amulet with a burst of pure willpower. A bright light fills the chamber, and you feel your vampiric nature weaken slightly. Gain 2 Willpower.",
                effect: { willpower: 2 },
                goto: 2
            },
            13: {
                text: "Your keen Perception spots a hidden lever! You pull it just in time, and a secret door opens. You escape into a tunnel that leads outside the castle. You find 20 gold coins on your way out.",
                gold: 20,
                goto: 30
            },
            14: {
                text: "You can't find an escape in time! The stone slab crushes you. Lose 6 Stamina.",
                effect: { stamina: -6 },
                goto: 31
            },
            15: {
                text: "You use your vampiric strength to hold up the slab while you search for treasure. You find a silver dagger and 10 gold coins, but the strain costs you 2 Stamina.",
                effect: { stamina: -2 },
                addItem: "silver_dagger",
                gold: 10,
                goto: 32
            },
            16: {
                text: "You grab a handful of jewels and roll out just as the slab crashes down. You escape with minor injuries (lose 1 Stamina) and gain 15 gold coins.",
                effect: { stamina: -1 },
                gold: 15,
                goto: 32
            },
            17: {
                text: "You defeat the spectral librarian! It disappears in a puff of smoke, leaving behind a ghostly essence and the book you wanted. You take 'The Path to Redemption'.",
                addItem: "redemption_book",
                addItem2: "ghostly_essence",
                options: [
                    { text: "Continue exploring the library", goto: 33 },
                    { text: "Return to the crypt entrance", goto: 2 }
                ]
            },
            18: {
                text: "The spectral librarian recognizes you as the castle's master. 'Forgive me, my lord. The book you seek is on the top shelf.' It hands you 'The Path to Redemption'.",
                addItem: "redemption_book",
                goto: 33
            },
            19: {
                text: "The red potion is poison! You lose 3 Stamina. As you cough and choke, you notice a secret compartment in the desk that opens, revealing a map.",
                effect: { stamina: -3 },
                addItem: "castle_map",
                goto: 34
            },
            20: {
                text: "The blue potion is a healing elixir! Restore 5 Stamina. You also find a note in the skeleton's hand: 'Beware the werewolves in the east forest.'",
                effect: { stamina: 5 },
                goto: 34
            },
            21: {
                text: "The green potion enhances your fortune! Gain 2 Luck. You also find a silver key in the skeleton's pocket.",
                effect: { luck: 2 },
                addItem: "silver_key",
                goto: 34
            },
            22: {
                text: "As you grab all three potions, the skeleton animates! 'Thief! Those are mine!' You must fight the skeleton alchemist!",
                enemy: "skeleton_alchemist",
                afterCombat: 35,
                goto: "combat"
            },
            23: {
                text: "Having fed, you feel stronger. As you finish, you notice a letter on the traveler's body. It's addressed to 'Van Helsing' and warns of a vampire in the area. The letter mentions a 'cure' for vampirism hidden in the old church.",
                addItem: "van_helsing_letter",
                goto: 36
            },
            24: {
                text: "Burned by the cross, you retreat to the shadows. The traveler runs toward the village, shouting 'Vampire!'. You hear alarm bells ringing. The village will be on high alert now.",
                goto: 37
            },
            25: {
                text: "You follow the woman in white to the graveyard. She kneels at a fresh grave and begins to pray. As you approach, she turns. Her eyes glow red - she's a vampire too! 'Brother,' she says. 'I've been waiting for you.'",
                goto: 38
            },
            26: {
                text: "You peer through the tavern window at the hunters. There are four of them, heavily armed with stakes, crosses, and silver bullets. Their leader is a grim-faced man you recognize: Abraham Van Helsing himself! Test your Perception to eavesdrop without being noticed.",
                skillCheck: { skill: "perception", difficulty: 11 },
                success: { text: "You hear their plan: they intend to storm your castle at dawn. They mention a 'silver net' and 'holy water fountain'.", goto: 39 },
                failure: { text: "One of the hunters spots you! 'There he is!' They burst out of the tavern after you!", enemy: "vampire_hunters", afterCombat: 40, goto: "combat" }
            },
            27: {
                text: "You approach the cloaked figure. It turns to reveal the face of Dr. Frankenstein! 'Ah, Count Dracula! I've been hoping to meet you. I believe I can help with your... condition.' Will you:",
                options: [
                    { text: "Listen to his proposal", goto: 41 },
                    { text: "Attack him", enemy: "frankenstein_monster", afterCombat: 42, goto: "combat" },
                    { text: "Leave immediately", goto: 9 }
                ]
            },
            28: {
                text: "From your dark corner, you overhear the villagers talking about missing people, strange howls in the forest, and a 'pale woman' who walks the graveyard at night. One man mentions a secret tunnel beneath the church that leads to an ancient crypt. Will you:",
                options: [
                    { text: "Investigate the graveyard", goto: 43 },
                    { text: "Search for the tunnel beneath the church", goto: 44 },
                    { text: "Return to your castle", goto: 1 }
                ]
            },
            29: {
                text: "You defeat the tavern brawlers! The other patrons flee in terror. You find 8 gold coins on the bodies.",
                gold: 8,
                goto: 45
            },
            30: {
                text: "You emerge from the tunnel into the forest outside your castle. The night air feels refreshing. You can see the village lights in the distance. Will you:",
                options: [
                    { text: "Go to the village", goto: 3 },
                    { text: "Return to the castle", goto: 1 }
                ]
            },
            31: {
                text: "Badly injured, you crawl out from under the rubble. The treasure chamber is now completely destroyed. You must find another way out.",
                goto: 46
            },
            32: {
                text: "You return to the crypt entrance with your treasure. The other doors still await exploration.",
                goto: 2
            },
            33: {
                text: "The library contains many ancient books. In addition to 'The Path to Redemption', you find: 'Bestiary of Night Creatures', 'Alchemy of Immortality', and 'The Black Arts'. You can only carry one more book. Which do you take?",
                options: [
                    { text: "Bestiary of Night Creatures", addItem: "bestiary", goto: 47 },
                    { text: "Alchemy of Immortality", addItem: "alchemy_book", goto: 47 },
                    { text: "The Black Arts", addItem: "black_arts_book", goto: 47 },
                    { text: "Leave them all", goto: 47 }
                ]
            },
            34: {
                text: "Having explored the alchemy lab, you find a door leading out. It opens into a hallway with a strange mosaic on the floor showing a moon cycle. One tile is missing. If you have a moon-shaped item, you might be able to solve this puzzle.",
                puzzle: "moon_mosaic",
                options: [
                    { text: "Try to solve the puzzle (requires Moon Amulet)", item: "moon_amulet", goto: 48 },
                    { text: "Force the door at the end of the hall", goto: 49 },
                    { text: "Return to the crypt entrance", goto: 2 }
                ]
            },
            35: {
                text: "You defeat the skeleton alchemist! The laboratory is now yours to explore. You find all three potions and the silver key.",
                addItem: "silver_key",
                addItem2: "healing_potion",
                effect: { stamina: 5 },
                goto: 34
            },
            36: {
                text: "The letter mentions a cure! According to it, Father Mikhail in the village church has developed a ritual that can restore a vampire's humanity. But it requires three components: a vampire's fang, holy water from Jerusalem, and the willing sacrifice of something precious. Will you:",
                options: [
                    { text: "Seek out Father Mikhail", goto: 50 },
                    { text: "Destroy the letter and forget about a cure", goto: 51 },
                    { text: "Use the information to set a trap for Van Helsing", goto: 52 }
                ]
            },
            37: {
                text: "With the village alerted, your options are limited. You hear hunting horns in the distance. Will you:",
                options: [
                    { text: "Flee into the forest", goto: 53 },
                    { text: "Return to your castle to prepare defenses", goto: 54 },
                    { text: "Use your powers to create confusion in the village", skill: "charisma", difficulty: 13, success: 55, failure: 56 }
                ]
            },
            38: {
                text: "The vampire woman introduces herself as Elena. 'I was turned by the same master who turned you, centuries ago. I've been searching for you, brother. The master is dead, killed by hunters. We are the last of our line.' She offers you a choice:",
                options: [
                    { text: "Join her and rebuild your vampire lineage", goto: 57 },
                    { text: "Ask her about a cure for vampirism", goto: 58 },
                    { text: "Attack her and drink her blood to increase your power", enemy: "elena_vampire", afterCombat: 59, goto: "combat" }
                ]
            },
            39: {
                text: "Knowing the hunters' plans gives you an advantage. You have until dawn to prepare. Will you:",
                options: [
                    { text: "Return to your castle and set traps", goto: 60 },
                    { text: "Try to eliminate the hunters now", goto: 61 },
                    { text: "Seek an alliance with other night creatures", goto: 62 }
                ]
            },
            40: {
                text: "You defeat the vampire hunters! You find silver bullets and 20 gold coins on their bodies.",
                addItem: "silver_bullets",
                gold: 20,
                goto: 63
            },
            41: {
                text: "Dr. Frankenstein explains: 'I can transfer your consciousness into a new, mortal body. Or I can create a serum that allows you to walk in sunlight. But I need something in return: your knowledge of ancient sciences, and... a sample of your blood.'",
                options: [
                    { text: "Agree to his terms", goto: 64 },
                    { text: "Refuse and leave", goto: 9 },
                    { text: "Kill him and take his research", enemy: "frankenstein_monster", afterCombat: 65, goto: "combat" }
                ]
            },
            42: {
                text: "You defeat Frankenstein's monster! You find a laboratory key and 25 gold coins.",
                addItem: "laboratory_key",
                gold: 25,
                goto: 66
            },
            43: {
                text: "The graveyard is cold and silent. Ancient tombstones lean at unnatural angles. You see fresh earth near a mausoleum. Suddenly, a ghostly figure appears before you!",
                enemy: "ghost",
                afterCombat: 67,
                goto: "combat"
            },
            44: {
                text: "You find the secret tunnel beneath the church. It's dark and narrow, but your vampiric eyes can see in the dark. The tunnel leads to an ancient crypt filled with religious artifacts. At the far end, you see a golden cross glowing with holy light.",
                options: [
                    { text: "Take the golden cross", goto: 68 },
                    { text: "Leave it and search the crypt", goto: 69 },
                    { text: "Flee from the holy power", goto: 70 }
                ]
            },
            45: {
                text: "The tavern is empty except for you. Behind the bar, you find a bottle of rare wine and 5 gold coins.",
                addItem: "rare_wine",
                gold: 5,
                goto: 71
            },
            46: {
                text: "You find a narrow passage behind a collapsed wall. It leads upward, back to the main castle corridors.",
                goto: 1
            },
            47: {
                text: "You leave the library and return to the crypt entrance.",
                goto: 2
            },
            48: {
                text: "You place the Moon Amulet in the missing tile. The mosaic glows, and a hidden door slides open, revealing a treasure room! You find 50 gold coins and a magical moonstone.",
                gold: 50,
                addItem: "moonstone",
                goto: 72
            },
            49: {
                text: "You force the door open with your vampiric strength. It leads to a staircase going up, back to the main castle.",
                effect: { stamina: -1 },
                goto: 1
            },
            50: {
                text: "You approach the church. Father Mikhail is inside, praying. He looks up as you enter. 'I've been expecting you, my child. The path to redemption is difficult. Are you ready to begin?'",
                options: [
                    { text: "Yes, I seek redemption", goto: 73 },
                    { text: "I'm not sure", goto: 74 },
                    { text: "Attack him and drink his blood", enemy: "priest", afterCombat: 75, goto: "combat" }
                ]
            },
            51: {
                text: "You destroy the letter and abandon all hope of a cure. The hunger grows stronger within you. You return to your castle, embracing your vampiric nature completely.",
                effect: { skill: 2, willpower: -2 },
                goto: 76
            },
            52: {
                text: "You use the information to set a trap for Van Helsing in the forest. When he comes searching for you, you ambush him!",
                enemy: "vampire_hunters",
                afterCombat: 77,
                goto: "combat"
            },
            53: {
                text: "You flee into the dark forest. The hunting horns fade behind you. In the forest, you encounter a pack of werewolves!",
                enemy: "werewolf_pack",
                afterCombat: 78,
                goto: "combat"
            },
            54: {
                text: "You return to your castle and begin preparing defenses. You set traps at the entrances and gather your minions. When dawn comes, the hunters attack!",
                enemy: "vampire_hunters",
                afterCombat: 79,
                goto: "combat"
            },
            55: {
                text: "You use your Charisma to create confusion in the village. You spread rumors of multiple vampires in different locations, causing the hunters to split up. This gives you time to escape or pick them off one by one.",
                goto: 80
            },
            56: {
                text: "Your attempt to create confusion fails. The villagers rally together and join the hunters. Now you face an even larger force!",
                enemy: "angry_villagers",
                afterCombat: 81,
                goto: "combat"
            },
            57: {
                text: "You join Elena. Together, you begin creating new vampires and building an army of the night. You become the new vampire lord, ruling over Transylvania from the shadows.",
                victory: true,
                goto: 100
            },
            58: {
                text: "Elena laughs bitterly. 'A cure? There is no cure, brother. Once a vampire, always a vampire. The best we can hope for is to control our hunger and find purpose in eternity.' She offers you a choice: join her or go your own way.",
                options: [
                    { text: "Join Elena", goto: 57 },
                    { text: "Go your own way", goto: 82 }
                ]
            },
            59: {
                text: "You defeat Elena and drink her ancient blood. Your power increases dramatically! Gain 3 Skill and 5 Stamina.",
                effect: { skill: 3, stamina: 5 },
                goto: 83
            },
            60: {
                text: "You return to your castle and set elaborate traps. When the hunters arrive at dawn, they fall into your traps one by one. You pick them off from the shadows.",
                goto: 84
            },
            61: {
                text: "You attack the hunters at the tavern. It's a fierce battle, but you have the element of surprise.",
                enemy: "vampire_hunters",
                afterCombat: 85,
                goto: "combat"
            },
            62: {
                text: "You seek out the werewolves in the forest. After a tense negotiation, they agree to help you in exchange for your protection from the villagers.",
                goto: 86
            },
            63: {
                text: "With the hunters defeated, you have bought yourself time. But more will come. What will you do with your reprieve?",
                options: [
                    { text: "Search for a permanent solution to your vampirism", goto: 87 },
                    { text: "Flee to a new country", goto: 88 },
                    { text: "Fortify your position and prepare for war", goto: 89 }
                ]
            },
            64: {
                text: "You agree to Frankenstein's terms. He takes a sample of your blood and begins his experiments. After several weeks, he presents you with two options: a mortal body or a serum for sunlight tolerance.",
                options: [
                    { text: "Take the mortal body", goto: 90 },
                    { text: "Take the sunlight serum", goto: 91 }
                ]
            },
            65: {
                text: "You defeat Frankenstein's monster and take his research. With his notes, you might be able to create your own solutions to vampirism.",
                addItem: "frankenstein_notes",
                goto: 92
            },
            66: {
                text: "With the laboratory key, you can now access Frankenstein's secret lab whenever you wish. You take his research notes with you.",
                addItem: "frankenstein_notes",
                goto: 93
            },
            67: {
                text: "You defeat the ghost. It leaves behind a ghostly essence that might be useful for rituals.",
                addItem: "ghostly_essence",
                goto: 94
            },
            68: {
                text: "As you touch the golden cross, holy power burns you! Lose 4 Stamina. But you manage to grab it. This powerful artifact could be useful against other supernatural creatures.",
                effect: { stamina: -4 },
                addItem: "golden_cross",
                goto: 95
            },
            69: {
                text: "You search the crypt and find an ancient bible with silver pages. It might contain useful knowledge about vampire weaknesses.",
                addItem: "silver_bible",
                goto: 95
            },
            70: {
                text: "You flee from the holy power, returning to the village. The experience leaves you shaken.",
                goto: 96
            },
            71: {
                text: "With the tavern to yourself, you drink the rare wine and consider your next move.",
                effect: { stamina: 2 },
                options: [
                    { text: "Return to the village", goto: 9 },
                    { text: "Go to the graveyard", goto: 43 },
                    { text: "Return to your castle", goto: 1 }
                ]
            },
            72: {
                text: "The treasure room contains ancient artifacts and gold. Among them, you find a journal that reveals the true history of your transformation. You learn that you were cursed, not born a vampire. There might be a way to break the curse!",
                addItem: "ancient_journal",
                goto: 97
            },
            73: {
                text: "Father Mikhail begins the ritual. It requires great sacrifice, but you undergo the process. After days of pain and prayer, you feel your vampirism fading. You become mortal again, but at the cost of your immortality.",
                victory: true,
                goto: 100
            },
            74: {
                text: "You tell Father Mikhail you need more time to decide. He nods understandingly. 'The door is always open, my child.'",
                goto: 98
            },
            75: {
                text: "You defeat Father Mikhail, but killing a holy man weighs heavily on your soul. Your vampiric nature grows stronger, but you feel a deep emptiness.",
                effect: { skill: 1, willpower: -3 },
                goto: 99
            },
            76: {
                text: "You embrace your vampiric nature completely. You become the terror of Transylvania, ruling the night with an iron fist. Villagers whisper your name in fear for generations to come.",
                victory: true,
                goto: 100
            },
            77: {
                text: "You defeat Van Helsing and his hunters! With their leader dead, the vampire hunting organization collapses. You are safe... for now.",
                victory: true,
                goto: 100
            },
            78: {
                text: "You defeat the werewolf pack and drink their blood. Werewolf blood gives you strange new abilities, including resistance to silver.",
                effect: { skill: 1, stamina: 3 },
                goto: 101
            },
            79: {
                text: "You defend your castle successfully! The hunters are defeated, and your legend grows. Villagers now tell stories of the invincible vampire lord in the castle.",
                victory: true,
                goto: 100
            },
            80: {
                text: "Your deception works perfectly. The hunters waste precious time chasing shadows while you make your escape. You slip away into the night, free to continue your existence elsewhere.",
                victory: true,
                goto: 100
            },
            81: {
                text: "You fight valiantly against the villagers and hunters, but you are overwhelmed by numbers. They drag you into the sunlight...",
                gameOver: true,
                goto: "gameover"
            },
            82: {
                text: "You part ways with Elena. You continue your solitary existence, searching for meaning in your endless nights.",
                goto: 102
            },
            83: {
                text: "With Elena's ancient blood in your veins, you become one of the most powerful vampires in existence. You could rule the night if you choose.",
                options: [
                    { text: "Claim your throne as vampire lord", goto: 103 },
                    { text: "Use your power for redemption", goto: 104 }
                ]
            },
            84: {
                text: "Your traps work perfectly. The hunters are eliminated without you having to face them directly. You remain safe in your castle, a legend that frightens children at night.",
                victory: true,
                goto: 100
            },
            85: {
                text: "You defeat the hunters at the tavern. The village is now defenseless against you. You could rule it or leave it in peace.",
                options: [
                    { text: "Take control of the village", goto: 105 },
                    { text: "Leave the village in peace", goto: 106 }
                ]
            },
            86: {
                text: "With the werewolves as your allies, you create a powerful coalition of night creatures. Together, you keep the hunters at bay and maintain balance in Transylvania.",
                victory: true,
                goto: 100
            },
            87: {
                text: "You dedicate yourself to finding a cure or a way to coexist with humanity. Your search leads you to ancient texts and forgotten rituals.",
                goto: 107
            },
            88: {
                text: "You flee Transylvania, traveling to London under a new identity. There, you learn to control your hunger and live among humans without detection.",
                victory: true,
                goto: 100
            },
            89: {
                text: "You turn your castle into an impregnable fortress. You create more vampires to serve you and establish a court of the night. You become a dark king ruling from the shadows.",
                victory: true,
                goto: 100
            },
            90: {
                text: "Frankenstein transfers your consciousness into a mortal body. You are human again, but the process is imperfect. You age rapidly, living only a few more years. Still, you experience sunlight, food, and mortal love before the end.",
                victory: true,
                goto: 100
            },
            91: {
                text: "The sunlight serum works! You can now walk in daylight. You maintain your vampire powers but lose the weaknesses. You become something new - a daywalker who can move between both worlds.",
                victory: true,
                goto: 100
            },
            92: {
                text: "With Frankenstein's notes, you continue his research. After years of work, you develop a way to sustain yourself without harming humans. You become a protector of the night, using your powers for good.",
                victory: true,
                goto: 100
            },
            93: {
                text: "You use Frankenstein's laboratory to conduct your own experiments. You create a serum that allows you to control your hunger perfectly. You become a guardian, protecting villages from other monsters.",
                victory: true,
                goto: 100
            },
            94: {
                text: "With the ghostly essence, you perform a ritual that strengthens your connection to the spirit world. You gain new abilities to communicate with and command spirits.",
                effect: { willpower: 2 },
                goto: 108
            },
            95: {
                text: "You return from the crypt with powerful artifacts. These could be used for protection or study.",
                options: [
                    { text: "Study the artifacts", goto: 109 },
                    { text: "Use them for protection", goto: 110 }
                ]
            },
            96: {
                text: "Shaken by the holy power, you realize there are forces greater than yourself in the world. This humbling experience changes your perspective.",
                effect: { willpower: 1 },
                goto: 111
            },
            97: {
                text: "The journal reveals that you were cursed by a witch whose love you spurned. The curse can be broken by performing a selfless act of true love. You set out to find if such a thing is possible for a vampire.",
                goto: 112
            },
            98: {
                text: "You leave the church, still uncertain about your path. The night stretches before you, full of possibilities.",
                options: [
                    { text: "Return to your castle", goto: 1 },
                    { text: "Explore the village more", goto: 9 }
                ]
            },
            99: {
                text: "With Father Mikhail dead, you feel your humanity slipping away. You become a true monster, feared by all. But in quiet moments, you remember what you once were.",
                goto: 113
            },
            100: {
                text: "Congratulations! You have completed your adventure. Your choices have shaped your destiny as Dracula. Would you like to play again and explore different paths?",
                ending: true,
                options: [
                    { text: "Play Again", goto: "restart" },
                    { text: "Main Menu", goto: "start" }
                ]
            },
            101: {
                text: "With werewolf blood in your system, you become a unique hybrid creature. You have strengths of both vampires and werewolves, but also new weaknesses. You are truly alone in the world.",
                goto: 114
            },
            102: {
                text: "You wander the earth, a solitary figure in the night. You help some, harm others, always searching for meaning in your endless existence. Your story continues, unwritten.",
                goto: 115
            },
            103: {
                text: "You establish yourself as the vampire lord of Transylvania. Other vampires swear fealty to you. You create a code for vampires to follow, bringing order to the night.",
                victory: true,
                goto: 100
            },
            104: {
                text: "You use your enhanced powers to protect humans from other monsters. You become a legend - the vampire who fights for good. Parents tell children stories of the noble vampire who watches over them.",
                victory: true,
                goto: 100
            },
            105: {
                text: "You take control of the village, ruling it from the shadows. The villagers live in fear but also protection - you defend them from other monsters. An uneasy peace settles over the land.",
                victory: true,
                goto: 100
            },
            106: {
                text: "You leave the village in peace, retreating to your castle. The villagers, grateful for your mercy, leave offerings at the castle gates. A strange symbiosis develops between you and them.",
                victory: true,
                goto: 100
            },
            107: {
                text: "After years of research, you discover a way to sustain yourself on animal blood. You become a vegetarian vampire, living in harmony with humans while maintaining your powers.",
                victory: true,
                goto: 100
            },
            108: {
                text: "With spirit command abilities, you become a mediator between the living and the dead. You help lost souls find peace, gaining spiritual power in return.",
                goto: 116
            },
            109: {
                text: "Studying the artifacts, you learn ancient secrets about holy magic. You learn to harness this power for yourself, becoming a vampire with holy abilities - a true paradox.",
                victory: true,
                goto: 100
            },
            110: {
                text: "You use the artifacts to protect your castle. They create a barrier that repels evil creatures and hunters alike. Your home becomes a true sanctuary.",
                victory: true,
                goto: 100
            },
            111: {
                text: "Your humbling experience leads you to seek balance. You no longer see yourself as superior to humans, but as different. You strive to find a middle path between your nature and your former humanity.",
                goto: 117
            },
            112: {
                text: "You search for centuries for an opportunity to perform a selfless act of true love. Finally, you save a village from a plague at great personal cost. The curse breaks, and you become human again as an old man. You live your final years in peace.",
                victory: true,
                goto: 100
            },
            113: {
                text: "As a true monster, you terrorize the countryside. But even monsters can change. One day, a child shows you kindness instead of fear, and something in you awakens again...",
                goto: 118
            },
            114: {
                text: "As a vampire-werewolf hybrid, you belong to neither world. You create your own path, answering to no one. You become a legend whispered in both vampire courts and werewolf packs.",
                victory: true,
                goto: 100
            },
            115: {
                text: "Your solitary journey continues through the centuries. You witness history unfold, sometimes participating, often observing. You learn that existence itself is the meaning you sought.",
                victory: true,
                goto: 100
            },
            116: {
                text: "As a spirit mediator, you find purpose in helping the dead find peace. In doing so, you find a measure of peace yourself. Your existence gains meaning beyond mere survival.",
                victory: true,
                goto: 100
            },
            117: {
                text: "You find balance by becoming a protector. You use your powers to defend villages from monsters while controlling your own hunger. You become known as the Guardian of Transylvania.",
                victory: true,
                goto: 100
            },
            118: {
                text: "The child's kindness reawakens your humanity. You begin protecting the child's village instead of preying on it. Slowly, you rebuild your soul, one good deed at a time.",
                victory: true,
                goto: 100
            },
            "gameover": {
                text: "Your adventure has ended. The night claims you once more.",
                ending: true,
                options: [
                    { text: "Try Again", goto: "restart" },
                    { text: "Main Menu", goto: "start" }
                ]
            }
        };
        
        // Enemies for Combat (COMPLETE)
        const enemies = {
            spectral_librarian: {
                name: "Spectral Librarian",
                skill: 7,
                stamina: 8,
                attack: "Ethereal touch",
                damage: 2,
                weakness: "Holy items",
                loot: ["ghostly_essence", 5],
                description: "A ghostly figure bound to protect the castle library."
            },
            tavern_brawlers: {
                name: "Tavern Brawlers",
                skill: 6,
                stamina: 12,
                attack: "Wooden stakes and ale mugs",
                damage: 3,
                weakness: "Fear",
                loot: ["wooden_stake", 8],
                description: "Drunk villagers armed with makeshift weapons."
            },
            skeleton_alchemist: {
                name: "Skeleton Alchemist",
                skill: 8,
                stamina: 10,
                attack: "Poison flasks",
                damage: 3,
                weakness: "Blunt weapons",
                loot: ["alchemy_set", 15],
                description: "An undead alchemist protecting his creations."
            },
            vampire_hunters: {
                name: "Vampire Hunters",
                skill: 9,
                stamina: 16,
                attack: "Silver weapons and holy water",
                damage: 4,
                weakness: "Darkness",
                loot: ["silver_bullets", 20],
                description: "Trained hunters led by Van Helsing."
            },
            frankenstein_monster: {
                name: "Frankenstein's Monster",
                skill: 10,
                stamina: 20,
                attack: "Supernatural strength",
                damage: 5,
                weakness: "Fire",
                loot: ["laboratory_key", 25],
                description: "A patchwork creature brought to life by mad science."
            },
            elena_vampire: {
                name: "Elena",
                skill: 11,
                stamina: 15,
                attack: "Ancient vampire powers",
                damage: 4,
                weakness: "Love",
                loot: ["ancient_blood", 40],
                description: "A centuries-old vampire with mastery of dark arts."
            },
            ghost: {
                name: "Restless Ghost",
                skill: 5,
                stamina: 6,
                attack: "Chilling touch",
                damage: 2,
                weakness: "Holy symbols",
                loot: ["ghostly_essence", 3],
                description: "A tormented spirit bound to the graveyard."
            },
            priest: {
                name: "Father Mikhail",
                skill: 8,
                stamina: 12,
                attack: "Holy power",
                damage: 4,
                weakness: "Darkness",
                loot: ["holy_symbol", 10],
                description: "A priest armed with faith and holy relics."
            },
            werewolf_pack: {
                name: "Werewolf Pack",
                skill: 9,
                stamina: 18,
                attack: "Claws and teeth",
                damage: 4,
                weakness: "Silver",
                loot: ["werewolf_fur", 30],
                description: "A pack of ferocious werewolves."
            },
            angry_villagers: {
                name: "Angry Villagers",
                skill: 7,
                stamina: 20,
                attack: "Pitchforks and torches",
                damage: 3,
                weakness: "Superior power",
                loot: ["villager_offerings", 15],
                description: "An entire village risen against you."
            }
        };
        
        // Items (COMPLETE)
        const items = {
            silver_dagger: {
                name: "Silver Dagger",
                type: "weapon",
                description: "A dagger made of pure silver. Effective against werewolves and other creatures.",
                bonus: { combat: 1 },
                value: 10
            },
            healing_potion: {
                name: "Healing Potion",
                type: "provision",
                description: "Restores 4 Stamina when consumed.",
                effect: { stamina: 4 },
                value: 5
            },
            lucky_charm: {
                name: "Lucky Charm",
                type: "special",
                description: "A rabbit's foot charm. Adds +1 to Luck tests.",
                bonus: { luck: 1 },
                value: 15
            },
            holy_symbol: {
                name: "Holy Symbol",
                type: "special",
                description: "A silver cross. Useful against undead and demons.",
                value: 8
            },
            redemption_book: {
                name: "The Path to Redemption",
                type: "special",
                description: "Father Mikhail's book on curing vampirism.",
                value: 5
            },
            castle_map: {
                name: "Castle Map",
                type: "special",
                description: "A map of secret passages in your castle.",
                value: 10
            },
            silver_key: {
                name: "Silver Key",
                type: "special",
                description: "A key that unlocks something important.",
                value: 3
            },
            van_helsing_letter: {
                name: "Van Helsing's Letter",
                type: "special",
                description: "A letter detailing plans to destroy you.",
                value: 1
            },
            ghostly_essence: {
                name: "Ghostly Essence",
                type: "special",
                description: "Ethereal energy from a spirit. Might be useful for rituals.",
                value: 12
            },
            wooden_stake: {
                name: "Wooden Stake",
                type: "weapon",
                description: "A sharpened stake of ash wood. Deadly to vampires.",
                bonus: { combat: 2 },
                value: 2
            },
            alchemy_set: {
                name: "Alchemy Set",
                type: "special",
                description: "Tools for creating potions and elixirs.",
                value: 25
            },
            silver_bullets: {
                name: "Silver Bullets",
                type: "ammo",
                description: "Bullets made of silver. Effective against supernatural creatures.",
                value: 20
            },
            laboratory_key: {
                name: "Laboratory Key",
                type: "special",
                description: "Unlocks Dr. Frankenstein's laboratory.",
                value: 5
            },
            ancient_blood: {
                name: "Ancient Vampire Blood",
                type: "special",
                description: "Blood from an ancient vampire. Drinking it could increase your power.",
                value: 50
            },
            bestiary: {
                name: "Bestiary of Night Creatures",
                type: "special",
                description: "A book detailing weaknesses of supernatural creatures.",
                value: 10
            },
            alchemy_book: {
                name: "Alchemy of Immortality",
                type: "special",
                description: "Secrets of eternal life and transformation.",
                value: 15
            },
            black_arts_book: {
                name: "The Black Arts",
                type: "special",
                description: "Forbidden knowledge of dark magic.",
                value: 20
            },
            moon_amulet: {
                name: "Moon Amulet",
                type: "special",
                description: "An amulet shaped like a crescent moon.",
                value: 8
            },
            moonstone: {
                name: "Magical Moonstone",
                type: "special",
                description: "A stone that glows with magical energy.",
                value: 30
            },
            rare_wine: {
                name: "Rare Wine",
                type: "provision",
                description: "A bottle of fine wine. Restores 2 Stamina.",
                effect: { stamina: 2 },
                value: 15
            },
            golden_cross: {
                name: "Golden Cross",
                type: "special",
                description: "A cross made of gold with holy power.",
                value: 50
            },
            silver_bible: {
                name: "Silver-Paged Bible",
                type: "special",
                description: "An ancient bible with silver pages.",
                value: 25
            },
            frankenstein_notes: {
                name: "Frankenstein's Notes",
                type: "special",
                description: "Detailed research on life, death, and transformation.",
                value: 40
            },
            ancient_journal: {
                name: "Ancient Journal",
                type: "special",
                description: "A journal detailing the true history of your curse.",
                value: 20
            },
            werewolf_fur: {
                name: "Werewolf Fur",
                type: "special",
                description: "Fur from a werewolf. Has magical properties.",
                value: 15
            },
            villager_offerings: {
                name: "Villager Offerings",
                type: "special",
                description: "Various items offered by villagers.",
                value: 10
            }
        };
        
        // Initialize Game
        function initGame() {
            document.getElementById('start-btn').addEventListener('click', showCharacterScreen);
            document.getElementById('rules-btn').addEventListener('click', showRulesScreen);
            document.getElementById('begin-btn').addEventListener('click', startGame);
            
            // Initialize character creation buttons
            document.getElementById('charisma-plus').addEventListener('click', function() { changeStat('charisma', 1); });
            document.getElementById('charisma-minus').addEventListener('click', function() { changeStat('charisma', -1); });
            document.getElementById('perception-plus').addEventListener('click', function() { changeStat('perception', 1); });
            document.getElementById('perception-minus').addEventListener('click', function() { changeStat('perception', -1); });
            document.getElementById('willpower-plus').addEventListener('click', function() { changeStat('willpower', 1); });
            document.getElementById('willpower-minus').addEventListener('click', function() { changeStat('willpower', -1); });
            
            updatePointsDisplay();
            console.log("Game initialized successfully");
        }
        
        // Show Screens
        function showStartScreen() {
            hideAllScreens();
            document.getElementById('start-screen').classList.add('active');
            gameState.screen = 'start';
        }
        
        function showRulesScreen() {
            hideAllScreens();
            document.getElementById('rules-screen').classList.add('active');
            gameState.screen = 'rules';
        }
        
        function showCharacterScreen() {
            hideAllScreens();
            document.getElementById('character-screen').classList.add('active');
            gameState.screen = 'character';
            resetCharacterScreen();
        }
        
        function resetCharacterScreen() {
            // Reset all button highlights
            document.getElementById('silver-dagger-btn').style.borderColor = '#666';
            document.getElementById('silver-dagger-btn').style.color = '#fff';
            document.getElementById('healing-potion-btn').style.borderColor = '#666';
            document.getElementById('healing-potion-btn').style.color = '#fff';
            document.getElementById('lucky-charm-btn').style.borderColor = '#666';
            document.getElementById('lucky-charm-btn').style.color = '#fff';
            
            // Reset selected item
            selectedStartingItem = null;
            
            // Update begin button state
            updateBeginButtonState();
        }
        
        function showGameScreen() {
            hideAllScreens();
            document.getElementById('game-screen').classList.add('active');
            gameState.screen = 'game';
            displaySection(gameState.currentSection);
        }
        
        function showInventory() {
            hideAllScreens();
            document.getElementById('inventory-screen').classList.add('active');
            gameState.screen = 'inventory';
            displayInventory();
        }
        
        function showStats() {
            hideAllScreens();
            document.getElementById('stats-screen').classList.add('active');
            gameState.screen = 'stats';
            displayStats();
        }
        
        function showCombatScreen() {
            hideAllScreens();
            document.getElementById('combat-screen').classList.add('active');
            gameState.screen = 'combat';
            displayCombat();
        }
        
        function showDiceScreen() {
            hideAllScreens();
            document.getElementById('dice-screen').classList.add('active');
            gameState.screen = 'dice';
        }
        
        function showGameOver(message) {
            hideAllScreens();
            document.getElementById('gameover-screen').classList.add('active');
            gameState.screen = 'gameover';
            document.getElementById('gameover-text').innerHTML = message;
        }
        
        function showVictory(message) {
            hideAllScreens();
            document.getElementById('victory-screen').classList.add('active');
            gameState.screen = 'victory';
            document.getElementById('victory-text').innerHTML = message;
        }
        
        function hideAllScreens() {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => screen.classList.remove('active'));
        }
        
        // Character Creation Functions
        let selectedStartingItem = null;
        
        function rollDice(numDice, sides) {
            let total = 0;
            for (let i = 0; i < numDice; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        function rollStamina() {
            const roll = rollDice(2, 6) + 12;
            gameState.stats.stamina = roll;
            gameState.stats.maxStamina = roll;
            document.getElementById('stamina-value').textContent = roll;
            updateBeginButtonState();
        }
        
        function rollSkill() {
            const roll = rollDice(1, 6) + 6;
            gameState.stats.skill = roll;
            document.getElementById('skill-value').textContent = roll;
            updateBeginButtonState();
        }
        
        function rollLuck() {
            const roll = rollDice(1, 6) + 6;
            gameState.stats.luck = roll;
            gameState.stats.initialLuck = roll;
            document.getElementById('luck-value').textContent = roll;
            updateBeginButtonState();
        }
        
        function changeStat(stat, change) {
            // Don't allow going below 4
            if (change < 0 && gameState.stats[stat] <= 4) {
                return;
            }
            
            // Don't allow going above 18
            if (change > 0 && gameState.stats[stat] >= 18) {
                return;
            }
            
            // Check if we have points to spend or can take back points
            if (change > 0 && gameState.stats.points <= 0) {
                return;
            }
            
            gameState.stats[stat] += change;
            gameState.stats.points -= change;
            
            document.getElementById(`${stat}-value`).textContent = gameState.stats[stat];
            updatePointsDisplay();
            updateBeginButtonState();
        }
        
        function updatePointsDisplay() {
            document.getElementById('points').textContent = gameState.stats.points;
        }
        
        function selectStartingItem(item) {
            selectedStartingItem = item;
            
            // Reset all button styles
            document.getElementById('silver-dagger-btn').style.borderColor = '#666';
            document.getElementById('silver-dagger-btn').style.color = '#fff';
            document.getElementById('healing-potion-btn').style.borderColor = '#666';
            document.getElementById('healing-potion-btn').style.color = '#fff';
            document.getElementById('lucky-charm-btn').style.borderColor = '#666';
            document.getElementById('lucky-charm-btn').style.color = '#fff';
            
            // Highlight selected button
            document.getElementById(`${item.replace('_', '-')}-btn`).style.borderColor = '#ff3333';
            document.getElementById(`${item.replace('_', '-')}-btn`).style.color = '#ff3333';
            
            updateBeginButtonState();
        }
        
        function updateBeginButtonState() {
            const beginBtn = document.getElementById('begin-btn');
            const isDisabled = (
                gameState.stats.stamina === 0 ||
                gameState.stats.skill === 0 ||
                gameState.stats.luck === 0 ||
                gameState.stats.points !== 0 ||
                selectedStartingItem === null
            );
            beginBtn.disabled = isDisabled;
        }
        
        // Start Game
        function startGame() {
            // Add starting item
            if (selectedStartingItem) {
                gameState.inventory.push(selectedStartingItem);
                
                // If it's a weapon, equip it
                if (items[selectedStartingItem].type === 'weapon') {
                    gameState.equipment.weapon = selectedStartingItem;
                    if (items[selectedStartingItem].bonus && items[selectedStartingItem].bonus.combat) {
                        gameState.combatBonus = items[selectedStartingItem].bonus.combat;
                    }
                }
                
                // If it's a lucky charm, add luck bonus
                if (selectedStartingItem === 'lucky_charm') {
                    gameState.luckBonus = 1;
                }
            }
            
            // Update displays
            updateAllDisplays();
            
            // Start at section 1
            gameState.currentSection = 1;
            gameState.visitedSections = [1];
            
            // Show game screen
            showGameScreen();
        }
        
        // Update all displays
        function updateAllDisplays() {
            // Update stamina
            document.getElementById('current-stamina').textContent = gameState.stats.stamina;
            document.getElementById('max-stamina').textContent = gameState.stats.maxStamina;
            document.getElementById('stamina-fill').style.width = `${(gameState.stats.stamina / gameState.stats.maxStamina) * 100}%`;
            
            // Update skill
            document.getElementById('current-skill').textContent = gameState.stats.skill;
            
            // Update luck
            document.getElementById('current-luck').textContent = gameState.stats.luck;
            document.getElementById('initial-luck').textContent = gameState.stats.initialLuck;
            document.getElementById('luck-fill').style.width = `${(gameState.stats.luck / gameState.stats.initialLuck) * 100}%`;
            
            // Update gold
            document.getElementById('gold').textContent = gameState.gold;
            
            // Update inventory count
            document.getElementById('inventory-count').textContent = gameState.inventory.length;
        }
        
        // Display Gamebook Section (FIXED IMPLEMENTATION)
        function displaySection(sectionNumber) {
            const section = gamebook[sectionNumber];
            if (!section) {
                showGameOver(`<p class="game-over">ADVENTURE ENDED</p><p>You've reached section ${sectionNumber}, which hasn't been written yet. Your journey ends here.</p>`);
                return;
            }
            
            // Mark as visited if not already
            if (!gameState.visitedSections.includes(sectionNumber)) {
                gameState.visitedSections.push(sectionNumber);
            }
            
            // Update current section
            gameState.currentSection = sectionNumber;
            
            // Display section text
            let html = `<p><span class="section-number">[${sectionNumber}]</span> ${section.text}</p>`;
            
            // Add any effects if this section has them
            if (section.effect) {
                applyEffect(section.effect);
                if (section.effect.stamina) {
                    const change = section.effect.stamina > 0 ? 'restored' : 'lost';
                    html += `<p class="${section.effect.stamina > 0 ? 'outcome-good' : 'outcome-bad'}">You ${change} ${Math.abs(section.effect.stamina)} STAMINA.</p>`;
                }
                if (section.effect.luck) {
                    html += `<p class="outcome-good">You gained ${section.effect.luck} LUCK.</p>`;
                }
                if (section.effect.skill) {
                    html += `<p class="${section.effect.skill > 0 ? 'outcome-good' : 'outcome-bad'}">Your SKILL ${section.effect.skill > 0 ? 'increased' : 'decreased'} by ${Math.abs(section.effect.skill)}.</p>`;
                }
                if (section.effect.willpower) {
                    html += `<p class="${section.effect.willpower > 0 ? 'outcome-good' : 'outcome-bad'}">Your WILLPOWER ${section.effect.willpower > 0 ? 'increased' : 'decreased'} by ${Math.abs(section.effect.willpower)}.</p>`;
                }
            }
            
            // Add gold if this section gives it
            if (section.gold) {
                gameState.gold += section.gold;
                updateAllDisplays();
                html += `<p class="outcome-good">You found ${section.gold} gold coins!</p>`;
            }
            
            // Add item if this section gives one
            if (section.addItem) {
                if (!gameState.inventory.includes(section.addItem)) {
                    gameState.inventory.push(section.addItem);
                    updateAllDisplays();
                    html += `<p class="outcome-good">You acquired: ${items[section.addItem].name}</p>`;
                }
            }
            
            // Add second item if this section gives one
            if (section.addItem2) {
                if (!gameState.inventory.includes(section.addItem2)) {
                    gameState.inventory.push(section.addItem2);
                    updateAllDisplays();
                    html += `<p class="outcome-good">You acquired: ${items[section.addItem2].name}</p>`;
                }
            }
            
            // Check for traps
            if (section.trap) {
                html = `<div class="trap">${html}</div>`;
            }
            
            // Check for puzzles
            if (section.puzzle) {
                html = `<div class="puzzle">${html}</div>`;
            }
            
            document.getElementById('game-text').innerHTML = html;
            
            // Display options
            const buttonContainer = document.getElementById('action-buttons');
            buttonContainer.innerHTML = '';
            
            // If this is an ending, show ending options
            if (section.ending) {
                const restartButton = document.createElement('button');
                restartButton.textContent = "PLAY AGAIN";
                restartButton.onclick = restartGame;
                buttonContainer.appendChild(restartButton);
                
                const menuButton = document.createElement('button');
                menuButton.textContent = "MAIN MENU";
                menuButton.onclick = showStartScreen;
                buttonContainer.appendChild(menuButton);
                return;
            }
            
            // If section has a gameover flag
            if (section.gameOver) {
                showGameOver(`<p class="game-over">YOU HAVE DIED</p><p>${section.text}</p>`);
                return;
            }
            
            // If section has a victory flag
            if (section.victory) {
                showVictory(`<p class="victory">VICTORY!</p><p>${section.text}</p>`);
                return;
            }
            
            // If section has options, show them
            if (section.options) {
                section.options.forEach((option, index) => {
                    // Check if option requires an item and player doesn't have it
                    if (option.item && !gameState.inventory.includes(option.item)) {
                        // Don't show this option
                        return;
                    }
                    
                    const button = document.createElement('button');
                    button.textContent = option.text;
                    
                    // Check if this is a skill test option
                    if (option.skill) {
                        button.className = 'skill-check';
                    }
                    
                    button.onclick = function() {
                        if (option.skill) {
                            // This is a skill test option
                            testSkill(option.skill, option.difficulty, option.success, option.failure);
                        } else if (option.goto === "combat") {
                            // Start combat
                            if (section.enemy) {
                                gameState.enemy = section.enemy;
                                gameState.afterCombatSection = section.afterCombat || 100;
                                startCombat();
                            }
                        } else {
                            // Normal navigation
                            goToSection(option.goto);
                        }
                    };
                    
                    buttonContainer.appendChild(button);
                });
            }
            
            // If section has a goto but no options, create a continue button
            if (section.goto && !section.options && !section.skillCheck && !section.testLuck && !section.enemy) {
                const continueButton = document.createElement('button');
                continueButton.textContent = "CONTINUE";
                continueButton.className = 'continue-btn';
                continueButton.onclick = function() {
                    goToSection(section.goto);
                };
                buttonContainer.appendChild(continueButton);
            }
            
            // If section has enemy but no options, create a fight button
            if (section.enemy && !section.options) {
                const fightButton = document.createElement('button');
                fightButton.textContent = "FIGHT!";
                fightButton.className = 'combat-option';
                fightButton.onclick = function() {
                    gameState.enemy = section.enemy;
                    gameState.afterCombatSection = section.afterCombat || 100;
                    startCombat();
                };
                buttonContainer.appendChild(fightButton);
            }
            
            // If section has testLuck but no options, create a test luck button
            if (section.testLuck && !section.options) {
                const luckButton = document.createElement('button');
                luckButton.textContent = "TEST YOUR LUCK";
                luckButton.onclick = function() {
                    testLuck(section.testLuck, section.lucky, section.unlucky);
                };
                buttonContainer.appendChild(luckButton);
            }
            
            // If section has skillCheck but no options, create a skill check button
            if (section.skillCheck && !section.options) {
                const skillButton = document.createElement('button');
                skillButton.textContent = `TEST YOUR ${section.skillCheck.skill.toUpperCase()}`;
                skillButton.className = 'skill-check';
                skillButton.onclick = function() {
                    testSkillCheck(section.skillCheck, section.success, section.failure);
                };
                buttonContainer.appendChild(skillButton);
            }
        }
        
        // Go to a section (FIXED)
        function goToSection(sectionNumber) {
            if (sectionNumber === "combat") {
                if (gameState.enemy) {
                    startCombat();
                }
            } else if (sectionNumber === "restart") {
                restartGame();
            } else if (sectionNumber === "start") {
                showStartScreen();
            } else if (sectionNumber === "gameover") {
                showGameOver("<p class='game-over'>YOU HAVE DIED</p><p>Your adventure ends here.</p>");
            } else {
                displaySection(sectionNumber);
            }
        }
        
        // Apply effect to character (FIXED)
        function applyEffect(effect) {
            if (effect.stamina) {
                gameState.stats.stamina += effect.stamina;
                if (gameState.stats.stamina > gameState.stats.maxStamina) {
                    gameState.stats.stamina = gameState.stats.maxStamina;
                }
                if (gameState.stats.stamina <= 0) {
                    showGameOver("<p class='game-over'>YOU HAVE DIED</p><p>Your Stamina has reached zero. The adventure ends here.</p>");
                    return;
                }
                updateAllDisplays();
            }
            
            if (effect.skill) {
                gameState.stats.skill += effect.skill;
                if (gameState.stats.skill < 1) gameState.stats.skill = 1;
                updateAllDisplays();
            }
            
            if (effect.luck) {
                gameState.stats.luck += effect.luck;
                if (gameState.stats.luck > gameState.stats.initialLuck) {
                    gameState.stats.luck = gameState.stats.initialLuck;
                }
                if (gameState.stats.luck < 0) gameState.stats.luck = 0;
                updateAllDisplays();
            }
            
            if (effect.charisma) {
                gameState.stats.charisma += effect.charisma;
                if (gameState.stats.charisma < 1) gameState.stats.charisma = 1;
            }
            
            if (effect.perception) {
                gameState.stats.perception += effect.perception;
                if (gameState.stats.perception < 1) gameState.stats.perception = 1;
            }
            
            if (effect.willpower) {
                gameState.stats.willpower += effect.willpower;
                if (gameState.stats.willpower < 1) gameState.stats.willpower = 1;
            }
        }
        
        // Test Skill (FIXED)
        function testSkill(skill, difficulty, successSection, failureSection) {
            const skillValue = gameState.stats[skill];
            const roll = rollDice(2, 6);
            
            // Show dice roll screen
            showDiceScreen();
            
            document.getElementById('dice-reason').textContent = `Testing your ${skill.toUpperCase()} (${skillValue}) against difficulty ${difficulty}`;
            document.getElementById('dice-result').textContent = `You rolled ${roll}`;
            
            let outcomeText = "";
            let nextSection = null;
            
            if (roll <= skillValue) {
                outcomeText = `Success! Your ${skill.toUpperCase()} prevails.`;
                nextSection = successSection;
            } else {
                outcomeText = `Failure! Your ${skill.toUpperCase()} is insufficient.`;
                nextSection = failureSection;
            }
            
            document.getElementById('dice-outcome').innerHTML = outcomeText;
            
            // Create continue button
            const optionsDiv = document.getElementById('dice-options');
            optionsDiv.innerHTML = '';
            
            const continueButton = document.createElement('button');
            continueButton.textContent = "CONTINUE";
            continueButton.className = 'continue-btn';
            continueButton.onclick = function() {
                if (nextSection === "combat") {
                    if (gameState.enemy) {
                        startCombat();
                    }
                } else {
                    goToSection(nextSection);
                }
            };
            optionsDiv.appendChild(continueButton);
        }
        
        // Test Skill Check (FIXED - for sections with skillCheck property)
        function testSkillCheck(skillCheck, success, failure) {
            const skillValue = gameState.stats[skillCheck.skill];
            const roll = rollDice(2, 6);
            
            // Show dice roll screen
            showDiceScreen();
            
            document.getElementById('dice-reason').textContent = `Testing your ${skillCheck.skill.toUpperCase()} (${skillValue}) against difficulty ${skillCheck.difficulty}`;
            document.getElementById('dice-result').textContent = `You rolled ${roll}`;
            
            let outcomeText = "";
            let nextSection = null;
            
            if (roll <= skillValue) {
                outcomeText = `Success! Your ${skillCheck.skill.toUpperCase()} prevails.`;
                if (success && success.text) {
                    outcomeText += ` ${success.text}`;
                }
                if (success && success.effect) {
                    applyEffect(success.effect);
                }
                nextSection = success.goto;
            } else {
                outcomeText = `Failure! Your ${skillCheck.skill.toUpperCase()} is insufficient.`;
                if (failure && failure.text) {
                    outcomeText += ` ${failure.text}`;
                }
                if (failure && failure.effect) {
                    applyEffect(failure.effect);
                }
                nextSection = failure.goto;
            }
            
            document.getElementById('dice-outcome').innerHTML = outcomeText;
            
            // Create continue button
            const optionsDiv = document.getElementById('dice-options');
            optionsDiv.innerHTML = '';
            
            const continueButton = document.createElement('button');
            continueButton.textContent = "CONTINUE";
            continueButton.className = 'continue-btn';
            continueButton.onclick = function() {
                if (nextSection === "combat") {
                    if (gameState.enemy) {
                        startCombat();
                    }
                } else {
                    goToSection(nextSection);
                }
            };
            optionsDiv.appendChild(continueButton);
        }
        
       // Test Luck (SIMPLIFIED VERSION)
function testLuck(reason, lucky, unlucky) {
    // Reduce luck by 1 for testing it
    const currentLuck = gameState.stats.luck;
    gameState.stats.luck -= 1;
    if (gameState.stats.luck < 0) gameState.stats.luck = 0;
    updateAllDisplays();
    
    const roll = rollDice(2, 6);
    
    // Show dice roll screen
    showDiceScreen();
    
    // Fix: If reason is boolean true, use a default message
    if (reason === true) {
        reason = "Testing your luck...";
    }
    
    document.getElementById('dice-reason').textContent = reason;
    document.getElementById('dice-result').textContent = `You rolled ${roll}. Your Luck is ${currentLuck}.`;
    
    let outcomeText = "";
    let nextSection = null;
    
    // Apply luck bonus if player has lucky charm
    const effectiveLuck = currentLuck + (gameState.luckBonus || 0);
    
    if (roll <= effectiveLuck) {
        outcomeText = "You are Lucky!";
        if (lucky && lucky.text) {
            outcomeText += ` ${lucky.text}`;
        }
        if (lucky && lucky.effect) {
            applyEffect(lucky.effect);
        }
        nextSection = lucky.goto;
    } else {
        outcomeText = "You are Unlucky!";
        if (unlucky && unlucky.text) {
            outcomeText += ` ${unlucky.text}`;
        }
        if (unlucky && unlucky.effect) {
            applyEffect(unlucky.effect);
        }
        nextSection = unlucky.goto;
    }
    
    document.getElementById('dice-outcome').innerHTML = outcomeText;
    
    // Clear the options div
    const optionsDiv = document.getElementById('dice-options');
    optionsDiv.innerHTML = '';
    
    // Create a unique ID for the button
    const buttonId = 'dice-continue-' + Date.now();
    
    // Create button with a direct onclick handler
    const continueButton = document.createElement('button');
    continueButton.id = buttonId;
    continueButton.textContent = "CONTINUE";
    continueButton.className = 'continue-btn';
    
    // Store nextSection in a global variable that the handler can access
    window._diceNextSection = nextSection;
    
    // Use a direct function assignment
    continueButton.onclick = function() {
        console.log("Dice continue clicked, next section:", window._diceNextSection);
        
        if (window._diceNextSection === "combat") {
            if (gameState.enemy) {
                startCombat();
            }
        } else if (window._diceNextSection === "gameover") {
            showGameOver("<p class='game-over'>YOU HAVE DIED</p><p>Your adventure ends here.</p>");
        } else if (window._diceNextSection === "restart") {
            restartGame();
        } else if (window._diceNextSection === "start") {
            showStartScreen();
        } else {
            // Make sure we're going to a valid section
            if (window._diceNextSection && !isNaN(window._diceNextSection)) {
                goToSection(parseInt(window._diceNextSection));
            } else if (window._diceNextSection) {
                goToSection(window._diceNextSection);
            } else {
                console.error("No next section specified!");
                showGameScreen();
            }
        }
        
        // Clean up
        window._diceNextSection = null;
    };
    
    optionsDiv.appendChild(continueButton);
}
        
        // Start Combat (FIXED)
        function startCombat() {
            gameState.inCombat = true;
            gameState.combatRound = 0;
            gameState.enemyData = { ...enemies[gameState.enemy] };
            showCombatScreen();
        }
        
        // Display Combat (FIXED)
        function displayCombat() {
            const enemy = gameState.enemyData;
            
            // Set enemy name and sprite
            document.getElementById('enemy-name').textContent = enemy.name.toUpperCase();
            
            // Set enemy sprite based on enemy type
            let sprite = "☠️";
            if (gameState.enemy.includes("vampire")) sprite = "🧛";
            if (gameState.enemy.includes("skeleton")) sprite = "💀";
            if (gameState.enemy.includes("frankenstein")) sprite = "🧟";
            if (gameState.enemy.includes("hunter")) sprite = "🏹";
            if (gameState.enemy.includes("ghost")) sprite = "👻";
            if (gameState.enemy.includes("priest")) sprite = "🙏";
            if (gameState.enemy.includes("werewolf")) sprite = "🐺";
            if (gameState.enemy.includes("villager")) sprite = "👨‍🌾";
            document.getElementById('enemy-sprite').textContent = sprite;
            
            // Set initial stats
            document.getElementById('player-combat-stamina').textContent = gameState.stats.stamina;
            document.getElementById('player-stamina-text').textContent = `${gameState.stats.stamina}/${gameState.stats.maxStamina}`;
            document.getElementById('player-combat-health').style.width = `${(gameState.stats.stamina / gameState.stats.maxStamina) * 100}%`;
            
            document.getElementById('enemy-combat-stamina').textContent = enemy.stamina;
            document.getElementById('enemy-stamina-text').textContent = `${enemy.stamina}/${enemies[gameState.enemy].stamina}`;
            document.getElementById('enemy-combat-health').style.width = `${(enemy.stamina / enemies[gameState.enemy].stamina) * 100}%`;
            
            // Set combat description
            document.getElementById('combat-description').innerHTML = `
                <p>You face ${enemy.name}: ${enemy.description}</p>
                <p>Enemy Skill: ${enemy.skill}, Stamina: ${enemy.stamina}</p>
                ${enemy.weakness ? `<p class="warning">Weakness: ${enemy.weakness}</p>` : ''}
            `;
            
            // Clear combat log
            document.getElementById('combat-log').innerHTML = '<p>Combat begins!</p>';
            
            // Display combat options
            const optionsDiv = document.getElementById('combat-options');
            optionsDiv.innerHTML = '';
            
            const attackButton = document.createElement('button');
            attackButton.textContent = "ATTACK";
            attackButton.onclick = combatRound;
            optionsDiv.appendChild(attackButton);
            
            const testLuckButton = document.createElement('button');
            testLuckButton.textContent = "TEST YOUR LUCK";
            testLuckButton.onclick = testLuckInCombat;
            optionsDiv.appendChild(testLuckButton);
            
            const fleeButton = document.createElement('button');
            fleeButton.textContent = "ATTEMPT TO FLEE";
            fleeButton.onclick = attemptToFlee;
            optionsDiv.appendChild(fleeButton);
            
            // Add special item options if available
            if (gameState.inventory.includes("healing_potion")) {
                const potionButton = document.createElement('button');
                potionButton.textContent = "USE HEALING POTION";
                potionButton.className = 'skill-option';
                potionButton.onclick = useHealingPotion;
                optionsDiv.appendChild(potionButton);
            }
        }
        
        // Combat Round (FIXED)
        function combatRound() {
            const enemy = gameState.enemyData;
            gameState.combatRound++;
            
            // Player attack
            const playerAttack = rollDice(2, 6) + gameState.stats.skill + gameState.combatBonus;
            const enemyAttack = rollDice(2, 6) + enemy.skill;
            
            let combatLog = document.getElementById('combat-log');
            let logEntry = `<div class="combat-turn"><strong>Round ${gameState.combatRound}</strong><br>`;
            logEntry += `Your Attack Strength: ${playerAttack}<br>`;
            logEntry += `${enemy.name}'s Attack Strength: ${enemyAttack}<br>`;
            
            if (playerAttack > enemyAttack) {
                // Player hits
                logEntry += `<span class="outcome-good">You hit ${enemy.name} for ${enemy.damage} damage!</span>`;
                enemy.stamina -= enemy.damage;
                
                // Check if enemy is defeated
                if (enemy.stamina <= 0) {
                    logEntry += `<br><span class="victory">You defeated ${enemy.name}!</span>`;
                    combatLog.innerHTML += logEntry + '</div>';
                    
                    // Award loot and end combat after delay
                    setTimeout(function() { combatVictory(); }, 1500);
                    return;
                }
            } else if (enemyAttack > playerAttack) {
                // Enemy hits
                logEntry += `<span class="outcome-bad">${enemy.name} hits you for ${enemy.damage} damage!</span>`;
                gameState.stats.stamina -= enemy.damage;
                updateAllDisplays();
                
                // Check if player is defeated
                if (gameState.stats.stamina <= 0) {
                    logEntry += `<br><span class="game-over">You have been defeated!</span>`;
                    combatLog.innerHTML += logEntry + '</div>';
                    
                    setTimeout(function() {
                        showGameOver(`<p class="game-over">YOU HAVE DIED IN COMBAT</p><p>${enemy.name} has defeated you. Your adventure ends here.</p>`);
                    }, 1500);
                    return;
                }
            } else {
                // Tie
                logEntry += `<span class="warning">Your attacks cancel each other out!</span>`;
            }
            
            logEntry += '</div>';
            combatLog.innerHTML += logEntry;
            combatLog.scrollTop = combatLog.scrollHeight;
            
            // Update displays
            document.getElementById('player-combat-stamina').textContent = gameState.stats.stamina;
            document.getElementById('player-stamina-text').textContent = `${gameState.stats.stamina}/${gameState.stats.maxStamina}`;
            document.getElementById('player-combat-health').style.width = `${(gameState.stats.stamina / gameState.stats.maxStamina) * 100}%`;
            
            document.getElementById('enemy-combat-stamina').textContent = enemy.stamina;
            document.getElementById('enemy-stamina-text').textContent = `${enemy.stamina}/${enemies[gameState.enemy].stamina}`;
            document.getElementById('enemy-combat-health').style.width = `${(enemy.stamina / enemies[gameState.enemy].stamina) * 100}%`;
            
            // Update attack strengths for display
            document.getElementById('player-attack').textContent = playerAttack;
            document.getElementById('enemy-attack').textContent = enemyAttack;
        }
        
        // Test Luck in Combat (FIXED)
        function testLuckInCombat() {
            if (gameState.stats.luck <= 0) {
                const combatLog = document.getElementById('combat-log');
                combatLog.innerHTML += `<div class="combat-turn"><span class="outcome-bad">You have no Luck left to test!</span></div>`;
                combatLog.scrollTop = combatLog.scrollHeight;
                return;
            }
            
            const enemy = gameState.enemyData;
            const roll = rollDice(2, 6);
            
            // Reduce luck by 1 for testing it
            const currentLuck = gameState.stats.luck;
            gameState.stats.luck -= 1;
            updateAllDisplays();
            
            const combatLog = document.getElementById('combat-log');
            let logEntry = `<div class="combat-turn"><strong>Luck Test</strong><br>`;
            logEntry += `You rolled ${roll}. Your Luck is ${currentLuck}.<br>`;
            
            // Apply luck bonus if player has lucky charm
            const effectiveLuck = currentLuck + (gameState.luckBonus || 0);
            
            if (roll <= effectiveLuck) {
                // Lucky
                logEntry += `<span class="outcome-good">You are Lucky! You deal an extra 2 damage!</span>`;
                enemy.stamina -= 2;
                
                if (enemy.stamina <= 0) {
                    logEntry += `<br><span class="victory">You defeated ${enemy.name}!</span>`;
                    combatLog.innerHTML += logEntry + '</div>';
                    
                    setTimeout(function() { combatVictory(); }, 1500);
                    return;
                }
            } else {
                // Unlucky
                logEntry += `<span class="outcome-bad">You are Unlucky! ${enemy.name} deals an extra 2 damage!</span>`;
                gameState.stats.stamina -= 2;
                updateAllDisplays();
                
                if (gameState.stats.stamina <= 0) {
                    logEntry += `<br><span class="game-over">You have been defeated!</span>`;
                    combatLog.innerHTML += logEntry + '</div>';
                    
                    setTimeout(function() {
                        showGameOver(`<p class="game-over">YOU HAVE DIED IN COMBAT</p><p>${enemy.name} has defeated you. Your adventure ends here.</p>`);
                    }, 1500);
                    return;
                }
            }
            
            logEntry += '</div>';
            combatLog.innerHTML += logEntry;
            combatLog.scrollTop = combatLog.scrollHeight;
            
            // Update displays
            document.getElementById('player-combat-stamina').textContent = gameState.stats.stamina;
            document.getElementById('player-stamina-text').textContent = `${gameState.stats.stamina}/${gameState.stats.maxStamina}`;
            document.getElementById('player-combat-health').style.width = `${(gameState.stats.stamina / gameState.stats.maxStamina) * 100}%`;
            
            document.getElementById('enemy-combat-stamina').textContent = enemy.stamina;
            document.getElementById('enemy-stamina-text').textContent = `${enemy.stamina}/${enemies[gameState.enemy].stamina}`;
            document.getElementById('enemy-combat-health').style.width = `${(enemy.stamina / enemies[gameState.enemy].stamina) * 100}%`;
        }
        
        // Use Healing Potion in Combat (FIXED)
        function useHealingPotion() {
            // Find and remove potion from inventory
            const index = gameState.inventory.indexOf("healing_potion");
            if (index > -1) {
                gameState.inventory.splice(index, 1);
                updateAllDisplays();
                
                // Apply healing
                const healAmount = 4;
                gameState.stats.stamina += healAmount;
                if (gameState.stats.stamina > gameState.stats.maxStamina) {
                    gameState.stats.stamina = gameState.stats.maxStamina;
                }
                updateAllDisplays();
                
                // Update combat display
                document.getElementById('player-combat-stamina').textContent = gameState.stats.stamina;
                document.getElementById('player-stamina-text').textContent = `${gameState.stats.stamina}/${gameState.stats.maxStamina}`;
                document.getElementById('player-combat-health').style.width = `${(gameState.stats.stamina / gameState.stats.maxStamina) * 100}%`;
                
                // Log the action
                const combatLog = document.getElementById('combat-log');
                combatLog.innerHTML += `<div class="combat-turn"><span class="outcome-good">You drink a healing potion and restore ${healAmount} Stamina!</span></div>`;
                combatLog.scrollTop = combatLog.scrollHeight;
            }
        }
        
        // Attempt to Flee (FIXED)
        function attemptToFlee() {
            const enemy = gameState.enemyData;
            const roll = rollDice(2, 6);
            
            const combatLog = document.getElementById('combat-log');
            let logEntry = `<div class="combat-turn"><strong>Attempt to Flee</strong><br>`;
            logEntry += `You roll ${roll}.<br>`;
            
            // Need to roll less than Skill to escape
            if (roll < gameState.stats.skill) {
                logEntry += `<span class="outcome-good">You successfully flee from combat!</span>`;
                combatLog.innerHTML += logEntry + '</div>';
                
                // Return to game after a delay
                setTimeout(function() {
                    gameState.inCombat = false;
                    showGameScreen();
                }, 1500);
            } else {
                logEntry += `<span class="outcome-bad">You fail to escape! ${enemy.name} gets a free attack!</span>`;
                combatLog.innerHTML += logEntry + '</div>';
                
                // Enemy gets free attack
                setTimeout(function() {
                    gameState.stats.stamina -= enemy.damage;
                    updateAllDisplays();
                    
                    combatLog.innerHTML += `<div class="combat-turn"><span class="outcome-bad">${enemy.name} hits you for ${enemy.damage} damage as you try to flee!</span></div>`;
                    combatLog.scrollTop = combatLog.scrollHeight;
                    
                    // Check if player is defeated
                    if (gameState.stats.stamina <= 0) {
                        setTimeout(function() {
                            showGameOver(`<p class="game-over">YOU HAVE DIED IN COMBAT</p><p>${enemy.name} has defeated you. Your adventure ends here.</p>`);
                        }, 1500);
                        return;
                    }
                    
                    // Update displays
                    document.getElementById('player-combat-stamina').textContent = gameState.stats.stamina;
                    document.getElementById('player-stamina-text').textContent = `${gameState.stats.stamina}/${gameState.stats.maxStamina}`;
                    document.getElementById('player-combat-health').style.width = `${(gameState.stats.stamina / gameState.stats.maxStamina) * 100}%`;
                }, 1000);
            }
        }
        
        // Combat Victory (FIXED)
        function combatVictory() {
            const enemy = enemies[gameState.enemy];
            
            // Award loot
            if (enemy.loot) {
                const [item, gold] = enemy.loot;
                if (item && !gameState.inventory.includes(item)) {
                    gameState.inventory.push(item);
                }
                if (gold) {
                    gameState.gold += gold;
                }
                updateAllDisplays();
            }
            
            // Show victory message
            const combatLog = document.getElementById('combat-log');
            combatLog.innerHTML += `<div class="combat-turn"><span class="victory">VICTORY!</span><br>`;
            if (enemy.loot) {
                combatLog.innerHTML += `You found ${items[enemy.loot[0]].name} and ${enemy.loot[1]} gold!`;
            }
            combatLog.innerHTML += '</div>';
            combatLog.scrollTop = combatLog.scrollHeight;
            
            // Return to game after a delay
            setTimeout(function() {
                gameState.inCombat = false;
                // Go to the after combat section
                if (gameState.afterCombatSection) {
                    goToSection(gameState.afterCombatSection);
                } else {
                    goToSection(100); // Default ending
                }
            }, 3000);
        }
        
        // Display Inventory (FIXED)
        function displayInventory() {
            // Equipment
            const equipmentDiv = document.getElementById('equipment-display');
            equipmentDiv.innerHTML = '';
            
            if (gameState.equipment.weapon) {
                const item = items[gameState.equipment.weapon];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';
                itemDiv.innerHTML = `
                    <div>
                        <strong>WEAPON:</strong> ${item.name}<br>
                        <small>${item.description}</small>
                    </div>
                    <button class="item-use-btn" onclick="unequipItem('weapon')">UNEQUIP</button>
                `;
                equipmentDiv.appendChild(itemDiv);
            } else {
                equipmentDiv.innerHTML = '<p>No weapon equipped</p>';
            }
            
            // Items
            const itemsDiv = document.getElementById('items-display');
            itemsDiv.innerHTML = '';
            
            const regularItems = gameState.inventory.filter(itemId => 
                items[itemId] && items[itemId].type !== 'provision' && 
                items[itemId].type !== 'special' &&
                itemId !== gameState.equipment.weapon
            );
            
            if (regularItems.length === 0) {
                itemsDiv.innerHTML = '<p>No items</p>';
            } else {
                regularItems.forEach(itemId => {
                    const item = items[itemId];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    
                    let useButton = '';
                    if (item.type === 'weapon') {
                        useButton = `<button class="item-use-btn" onclick="equipItem('${itemId}')">EQUIP</button>`;
                    }
                    
                    itemDiv.innerHTML = `
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>${item.description}</small>
                        </div>
                        ${useButton}
                    `;
                    itemsDiv.appendChild(itemDiv);
                });
            }
            
            // Special Items
            const specialDiv = document.getElementById('special-items-display');
            specialDiv.innerHTML = '';
            
            const specialItems = gameState.inventory.filter(itemId => 
                items[itemId] && items[itemId].type === 'special'
            );
            
            if (specialItems.length === 0) {
                specialDiv.innerHTML = '<p>No special items</p>';
            } else {
                specialItems.forEach(itemId => {
                    const item = items[itemId];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    itemDiv.innerHTML = `
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>${item.description}</small>
                        </div>
                    `;
                    specialDiv.appendChild(itemDiv);
                });
            }
            
            // Provisions
            const provisionsDiv = document.getElementById('provisions-display');
            provisionsDiv.innerHTML = '';
            
            const provisions = gameState.inventory.filter(itemId => 
                items[itemId] && items[itemId].type === 'provision'
            );
            
            if (provisions.length === 0) {
                provisionsDiv.innerHTML = '<p>No provisions</p>';
            } else {
                provisions.forEach(itemId => {
                    const item = items[itemId];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    itemDiv.innerHTML = `
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>${item.description}</small>
                        </div>
                        <button class="item-use-btn" onclick="useItem('${itemId}')">USE</button>
                    `;
                    provisionsDiv.appendChild(itemDiv);
                });
            }
        }
        
        // Equip Item
        function equipItem(itemId) {
            const item = items[itemId];
            if (item.type === 'weapon') {
                gameState.equipment.weapon = itemId;
                if (item.bonus && item.bonus.combat) {
                    gameState.combatBonus = item.bonus.combat;
                } else {
                    gameState.combatBonus = 0;
                }
                displayInventory();
            }
        }
        
        // Unequip Item
        function unequipItem(slot) {
            gameState.equipment[slot] = null;
            if (slot === 'weapon') {
                gameState.combatBonus = 0;
            }
            displayInventory();
        }
        
        // Use Item
        function useItem(itemId) {
            const item = items[itemId];
            
            if (item.type === 'provision') {
                if (item.effect && item.effect.stamina) {
                    gameState.stats.stamina += item.effect.stamina;
                    if (gameState.stats.stamina > gameState.stats.maxStamina) {
                        gameState.stats.stamina = gameState.stats.maxStamina;
                    }
                    updateAllDisplays();
                    
                    // Show message
                    const gameText = document.getElementById('game-text');
                    gameText.innerHTML += `<p class="outcome-good">You use ${item.name} and restore ${item.effect.stamina} Stamina!</p>`;
                }
                
                // Remove from inventory
                const index = gameState.inventory.indexOf(itemId);
                if (index > -1) {
                    gameState.inventory.splice(index, 1);
                    updateAllDisplays();
                }
            }
            
            // Return to inventory screen
            displayInventory();
        }
        
        // Display Stats
        function displayStats() {
            document.getElementById('sheet-stamina').textContent = `${gameState.stats.stamina}/${gameState.stats.maxStamina}`;
            document.getElementById('sheet-skill').textContent = gameState.stats.skill;
            document.getElementById('sheet-luck').textContent = `${gameState.stats.luck}/${gameState.stats.initialLuck}`;
            document.getElementById('sheet-charisma').textContent = gameState.stats.charisma;
            document.getElementById('sheet-perception').textContent = gameState.stats.perception;
            document.getElementById('sheet-willpower').textContent = gameState.stats.willpower;
            
            // Combat Bonuses
            const bonusesDiv = document.getElementById('combat-bonuses');
            bonusesDiv.innerHTML = '';
            
            if (gameState.combatBonus > 0) {
                bonusesDiv.innerHTML = `<p>Weapon Bonus: +${gameState.combatBonus} to Attack Strength</p>`;
            }
            if (gameState.luckBonus > 0) {
                bonusesDiv.innerHTML += `<p>Luck Bonus: +${gameState.luckBonus} to Luck tests</p>`;
            }
            if (!gameState.combatBonus && !gameState.luckBonus) {
                bonusesDiv.innerHTML = `<p>No combat bonuses</p>`;
            }
            
            // Skill Test History
            const historyDiv = document.getElementById('skill-test-history');
            historyDiv.innerHTML = '';
            
            if (gameState.skillTestHistory.length === 0) {
                historyDiv.innerHTML = '<p>No skill tests recorded</p>';
            } else {
                gameState.skillTestHistory.forEach((test, index) => {
                    const testDiv = document.createElement('div');
                    testDiv.className = 'skill-check';
                    testDiv.innerHTML = `
                        <strong>${test.skill.toUpperCase()} Test</strong><br>
                        Difficulty: ${test.difficulty}<br>
                        Time: ${test.timestamp}
                    `;
                    historyDiv.appendChild(testDiv);
                });
            }
        }
        
        // Return to Game
        function returnToGame() {
            showGameScreen();
        }
        
        // Save/Load Game
        function saveGame() {
            const saveData = {
                currentSection: gameState.currentSection,
                visitedSections: gameState.visitedSections,
                stats: gameState.stats,
                gold: gameState.gold,
                inventory: gameState.inventory,
                equipment: gameState.equipment,
                combatBonus: gameState.combatBonus,
                luckBonus: gameState.luckBonus
            };
            
            localStorage.setItem('draculaSave', JSON.stringify(saveData));
            
            const gameText = document.getElementById('game-text');
            gameText.innerHTML += `<p class="outcome-good">Game saved!</p>`;
        }
        
        function loadGame() {
            const saveData = localStorage.getItem('draculaSave');
            if (!saveData) {
                const gameText = document.getElementById('game-text');
                gameText.innerHTML += `<p class="outcome-bad">No saved game found!</p>`;
                return;
            }
            
            try {
                const loaded = JSON.parse(saveData);
                
                // Restore game state
                gameState.currentSection = loaded.currentSection;
                gameState.visitedSections = loaded.visitedSections;
                gameState.stats = loaded.stats;
                gameState.gold = loaded.gold;
                gameState.inventory = loaded.inventory;
                gameState.equipment = loaded.equipment;
                gameState.combatBonus = loaded.combatBonus;
                gameState.luckBonus = loaded.luckBonus;
                
                // Update displays
                updateAllDisplays();
                
                // Go to current section
                displaySection(gameState.currentSection);
                
                const gameText = document.getElementById('game-text');
                gameText.innerHTML += `<p class="outcome-good">Game loaded!</p>`;
            } catch (error) {
                const gameText = document.getElementById('game-text');
                gameText.innerHTML += `<p class="outcome-bad">Error loading saved game!</p>`;
            }
        }
        
        // Restart Game (FIXED)
        function restartGame() {
            // Reset game state
            gameState.screen = 'start';
            gameState.currentSection = 1;
            gameState.visitedSections = [];
            gameState.stats = {
                stamina: 0,
                maxStamina: 0,
                skill: 0,
                luck: 0,
                initialLuck: 0,
                charisma: 4,
                perception: 4,
                willpower: 4,
                points: 12
            };
            gameState.gold = 0;
            gameState.inventory = [];
            gameState.equipment = {
                weapon: null,
                armor: null,
                special: null
            };
            gameState.combatBonus = 0;
            gameState.luckBonus = 0;
            gameState.provisions = 0;
            gameState.gameOver = false;
            gameState.victory = false;
            gameState.inCombat = false;
            gameState.enemy = null;
            gameState.enemyData = null;
            gameState.combatRound = 0;
            gameState.diceRoll = 0;
            gameState.skillTestHistory = [];
            gameState.afterCombatSection = null;
            gameState.testLuckResult = null;
            
            // Show character screen
            showCharacterScreen();
        }
        
        // Initialize game when page loads
        window.onload = initGame;
    </script>
</body>
</html>
