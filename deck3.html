<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Night Fever</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff2a2a;
            --primary-dark: #cc0000;
            --secondary: #2a2aff;
            --accent: #ffcc00;
            --bg-dark: #0a0a0a;
            --bg-darker: #050505;
            --text-light: #f0f0f0;
            --text-dim: #aaaaaa;
            --common: #aaaaaa;
            --rare: #5555ff;
            --epic: #ff5555;
            --legendary: #ffff55;
            --ancient: #aa55ff;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Orbitron', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            touch-action: manipulation;
            overscroll-behavior: none;
            height: 100vh;
            overflow: hidden;
        }

        #app-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 10px 15px;
            background: linear-gradient(to bottom, #1a1a1a, #0a0a0a);
            border-bottom: 1px solid var(--primary-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .header h1 {
            margin: 0;
            font-size: 1.4rem;
            color: var(--primary);
            text-shadow: 0 0 5px var(--primary);
            font-family: 'Press Start 2P', cursive;
            letter-spacing: 1px;
        }

        .header-stats {
            display: flex;
            gap: 15px;
        }

        .stat {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .stat-icon {
            margin-right: 5px;
            font-size: 1.1rem;
        }

        .hp-icon { color: var(--primary); }
        .gold-icon { color: var(--accent); }
        .energy-icon { color: var(--secondary); }

        .game-screen {
            flex: 1;
            overflow: hidden;
            position: relative;
            transition: transform 0.3s ease;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 15px;
            overflow-y: auto;
            background-color: var(--bg-darker);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .screen.active {
            transform: translateX(0);
        }

        .screen-title {
            color: var(--primary);
            text-align: center;
            margin: 10px 0 20px;
            font-size: 1.5rem;
            text-shadow: 0 0 5px var(--primary);
            font-family: 'Press Start 2P', cursive;
        }

        .screen-subtitle {
            color: var(--text-light);
            text-align: center;
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .button {
            background: linear-gradient(to bottom, #333, #222);
            color: var(--text-light);
            border: none;
            border-radius: 8px;
            padding: 12px 15px;
            margin: 8px 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 0 #111, 0 4px 4px rgba(0, 0, 0, 0.3);
            transition: all 0.1s;
            width: 100%;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #111;
        }

        .button.primary {
            background: linear-gradient(to bottom, var(--primary), var(--primary-dark));
            color: white;
        }

        .button.secondary {
            background: linear-gradient(to bottom, var(--secondary), #0000cc);
        }

        .button.accent {
            background: linear-gradient(to bottom, var(--accent), #ccaa00);
            color: #333;
        }

        .button.small {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .button-group .button {
            flex: 1;
            margin: 0;
        }

        .card {
            background: linear-gradient(to bottom, #222, #1a1a1a);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
            border-left: 4px solid var(--common);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:active {
            transform: scale(0.98);
        }

        .card h3 {
            margin: 0 0 8px;
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .card p {
            margin: 5px 0;
            color: var(--text-dim);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .card-cost {
            color: var(--accent);
            font-weight: bold;
            font-size: 0.9rem;
        }

        .card.rare { border-left-color: var(--rare); }
        .card.epic { border-left-color: var(--epic); }
        .card.legendary { border-left-color: var(--legendary); }
        .card.ancient { border-left-color: var(--ancient); }

        .health-bar {
            height: 20px;
            width: 100%;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(to right, var(--primary-dark), var(--primary));
            width: 100%;
            transition: width 0.3s;
        }

        .health-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
            line-height: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-shadow: 0 0 3px black;
        }

        .enemy-avatar {
            font-size: 4rem;
            text-align: center;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .battle-log {
            height: 120px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .battle-log p {
            margin: 5px 0;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .energy-display {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 10px 0;
        }

        .energy-orb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #333;
            border: 2px solid var(--secondary);
        }

        .energy-orb.filled {
            background-color: var(--secondary);
            box-shadow: 0 0 8px var(--secondary);
        }

        .combo-meter {
            height: 6px;
            background-color: #333;
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }

        .combo-fill {
            height: 100%;
            background: linear-gradient(to right, #ffcc00, #ff9900);
            width: 0%;
            transition: width 0.3s;
        }

        .combo-text {
            text-align: center;
            font-size: 0.9rem;
            color: var(--accent);
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .damage-popup {
            position: absolute;
            color: var(--primary);
            font-weight: bold;
            font-size: 1.2rem;
            animation: floatUp 1s forwards;
            pointer-events: none;
            text-shadow: 0 0 3px black;
            z-index: 100;
        }

        .heal-popup {
            position: absolute;
            color: #00ff00;
            font-weight: bold;
            font-size: 1.2rem;
            animation: floatUp 1s forwards;
            pointer-events: none;
            text-shadow: 0 0 3px black;
            z-index: 100;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-30px); }
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .status-effect {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 5px;
        }

        .buff { background-color: rgba(0, 255, 0, 0.2); color: #0f0; }
        .debuff { background-color: rgba(255, 0, 0, 0.2); color: #f00; }
        .block { background-color: rgba(0, 0, 255, 0.2); color: #00f; }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--bg-darker);
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-dim);
        }

        .class-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        .class-card {
            background: linear-gradient(to bottom, #222, #1a1a1a);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid var(--primary);
        }

        .class-card.werewolf {
            border-left-color: var(--secondary);
        }

        .class-card h3 {
            margin-top: 0;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .class-card.werewolf h3 {
            color: var(--secondary);
        }

        .class-card ul {
            padding-left: 20px;
            margin: 10px 0;
        }

        .class-card li {
            margin-bottom: 5px;
            color: var(--text-dim);
        }

        .talent-node {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #222;
            border: 2px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 0.8rem;
            cursor: pointer;
            position: absolute;
            transition: all 0.3s;
        }

        .talent-node.unlocked {
            background-color: var(--accent);
            color: #000;
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--accent);
        }

        .talent-node.available {
            border-color: var(--accent);
            box-shadow: 0 0 5px var(--accent);
        }

        .talent-node.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .talent-connector {
            position: absolute;
            height: 4px;
            background-color: var(--accent);
            transform-origin: 0 0;
            z-index: -1;
        }

        .talent-tree-container {
            position: relative;
            width: 100%;
            height: 400px;
            margin: 20px 0;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .talent-tooltip {
            position: absolute;
            background-color: var(--bg-dark);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 10px;
            max-width: 250px;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .achievement {
            background: linear-gradient(to bottom, #222, #1a1a1a);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            opacity: 0.5;
            border-left: 4px solid #333;
        }

        .achievement.unlocked {
            opacity: 1;
            border-left-color: var(--accent);
            box-shadow: 0 0 10px var(--accent);
        }

        .achievement-icon {
            font-size: 2rem;
            text-align: center;
            margin-bottom: 10px;
        }

        .achievement h3 {
            margin: 0;
            color: var(--text-light);
        }

        .achievement p {
            margin: 5px 0 0;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .gamepad {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            background: rgba(10, 10, 10, 0.8);
            display: flex;
            justify-content: space-around;
            z-index: 50;
            border-top: 1px solid #333;
        }

        .gamepad-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(to bottom, #333, #222);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: var(--text-light);
            box-shadow: 0 3px 0 #111, 0 4px 4px rgba(0, 0, 0, 0.3);
            transition: all 0.1s;
        }

        .gamepad-button:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #111;
        }

        .gamepad-button.primary {
            background: linear-gradient(to bottom, var(--primary), var(--primary-dark));
        }

        .gamepad-button.secondary {
            background: linear-gradient(to bottom, var(--secondary), #0000cc);
        }

        .gamepad-button.accent {
            background: linear-gradient(to bottom, var(--accent), #ccaa00);
            color: #333;
        }

        .hand-container {
            display: flex;
            gap: 10px;
            padding: 10px;
            overflow-x: auto;
            margin: 10px -15px;
            scroll-snap-type: x mandatory;
        }

        .hand-container::-webkit-scrollbar {
            display: none;
        }

        .hand-card {
            flex: 0 0 80%;
            scroll-snap-align: center;
        }

        @media (min-width: 500px) {
            .hand-card {
                flex: 0 0 60%;
            }
        }

        @media (min-width: 768px) {
            .hand-card {
                flex: 0 0 40%;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div class="header">
            <h1>NIGHT FEVER</h1>
            <div class="header-stats">
                <div class="stat">
                    <span class="stat-icon hp-icon">‚ù§Ô∏è</span>
                    <span id="hp-display">100/100</span>
                </div>
                <div class="stat">
                    <span class="stat-icon gold-icon">üí∞</span>
                    <span id="gold-display">0</span>
                </div>
                <div class="stat">
                    <span class="stat-icon energy-icon">‚ö°</span>
                    <span id="energy-display">3/3</span>
                </div>
            </div>
        </div>

        <div class="game-screen">
            <!-- SETTINGS SCREEN -->
            <div id="settings-screen" class="screen active">
    <h2 class="screen-title">GAME SETTINGS</h2>
                
                <div class="card">
                    <h3>ACCESSIBILITY</h3>
                    <label>Font Size:</label>
                    <select id="font-size" class="button">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>
                
                <button class="button primary" onclick="startGame()">START GAME</button>
</div>

            <!-- CLASS SELECTION -->
            <div id="class-selection" class="screen">
                <h2 class="screen-title">CHOOSE YOUR FACTION</h2>
                
                <div class="button-group">
                    <button class="button primary" onclick="chooseClass('Vampire')">VAMPIRE</button>
                    <button class="button secondary" onclick="chooseClass('Werewolf')">WEREWOLF</button>
                </div>
                
                <div class="class-info">
                    <div class="class-card">
                        <h3>VAMPIRES</h3>
                        <ul>
                            <li>+ Lifesteal abilities</li>
                            <li>+ Shadow magic</li>
                            <li>+ Lower health but higher evasion</li>
                            <li>+ Blood-based powers</li>
                            <li>+ Combo: Shadow Arts (3+ cards: +2 damage per card)</li>
                        </ul>
                    </div>
                    
                    <div class="class-card werewolf">
                        <h3>WEREWOLVES</h3>
                        <ul>
                            <li>+ Higher health and damage</li>
                            <li>+ Stronger physical attacks</li>
                            <li>+ Pack tactics and regeneration</li>
                            <li>+ Combo: Primal Fury (3+ attacks: +3 damage per attack)</li>
                        </ul>
                    </div>
                </div>
                
                <button class="button" onclick="showSettings()">BACK TO SETTINGS</button>
            </div>

            <!-- MAIN GAME SCREEN -->
            <div id="game-screen" class="screen">
                <h2 class="screen-title" id="class-name">VAMPIRE</h2>
                
                <div class="health-bar">
                    <div class="health-fill" id="player-health-fill"></div>
                    <div class="health-text" id="player-health-text"></div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                    <span>üí∞ <span id="gold-value">0</span></span>
                    <span>‚≠ê <span id="level-value">1</span></span>
                    <span>üìà <span id="xp-value">0</span>/<span id="xp-needed">20</span></span>
                </div>
                
                <div class="combo-meter">
                    <div class="combo-fill" id="combo-fill"></div>
                </div>
                <div class="combo-text" id="combo-text"></div>
                
                <div id="status-effects" style="margin: 10px 0;"></div>
                
                <div class="button-group">
                    <button class="button primary" onclick="startBattle()">BATTLE</button>
                    <button class="button secondary" onclick="enterShop()">SHOP</button>
                </div>
                
                <div class="button-group">
                    <button class="button" onclick="viewDeck()">DECK</button>
                    <button class="button" onclick="viewTalents()">TALENTS</button>
                    <button class="button" onclick="viewAchievements()">ACHIEVEMENTS</button>
                </div>
                
                <div class="card" style="margin-top: 15px;">
                    <p>NEXT ENEMY: <strong id="next-enemy">Hunter</strong></p>
                    <p>MODE: <strong id="game-mode">Standard</strong></p>
                </div>
            </div>

            <!-- BATTLE SCREEN -->
            <div id="battle-screen" class="screen">
                <h2 class="screen-title" id="battle-title">BATTLE</h2>
                
                <div class="enemy-avatar" id="enemy-avatar">üëπ</div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <div style="text-align: left;">
                        <h3>YOU</h3>
                        <div class="health-bar" style="width: 120px;">
                            <div class="health-fill" id="battle-player-health-fill"></div>
                            <div class="health-text" id="battle-player-health-text"></div>
                        </div>
                        <div id="battle-status-effects"></div>
                    </div>
                    
                    <div style="text-align: right;">
                        <h3 id="enemy-name">ENEMY</h3>
                        <div class="health-bar" style="width: 120px;">
                            <div class="health-fill" id="enemy-health-fill"></div>
                            <div class="health-text" id="enemy-health-text"></div>
                        </div>
                        <div id="enemy-status-effects"></div>
                    </div>
                </div>
                
                <div class="energy-display" id="energy-display"></div>
                
                <div class="combo-meter">
                    <div class="combo-fill" id="battle-combo-fill"></div>
                </div>
                <div class="combo-text" id="battle-combo-text"></div>

                <div class="hand-container" id="hand"></div>

                <div class="battle-log" id="battle-log"></div>
                
                <div id="game-over-message" style="text-align: center; color: #f55; font-size: 1.2rem; margin: 10px 0; display: none;"></div>
                <div id="victory-message" style="text-align: center; color: #0f0; font-size: 1.2rem; margin: 10px 0; display: none;"></div>
            </div>

            <!-- REWARD SCREEN -->
            <div id="reward-screen" class="screen">
                <h2 class="screen-title">VICTORY REWARDS</h2>
                <p class="screen-subtitle">Choose your reward:</p>
                
                <button class="button" onclick="skipReward()">SKIP REWARD</button>
                <button class="button primary" onclick="getRandomCardReward()">NEW CARD (3 CHOICES)</button>
                <button class="button accent" onclick="getGoldReward()">TAKE <span id="gold-reward-amount">50</span> GOLD</button>
                <button class="button" onclick="getPotionReward()">RECEIVE POTIONS</button>
                <button class="button secondary" onclick="getTalentPoint()">TALENT POINT</button>
                
                <div id="reward-cards" style="margin-top: 20px;"></div>
            </div>

            <!-- SHOP SCREEN -->
            <div id="shop-screen" class="screen">
                <h2 class="screen-title">SHOP</h2>
                <p class="screen-subtitle">Gold: <span id="gold-amount" style="color: var(--accent);">0</span></p>
                
                <div class="button-group">
                    <button class="button small" onclick="buyPotion()">HEALTH POTION (15)</button>
                    <button class="button small" onclick="buyEnergyPotion()">ENERGY POTION (20)</button>
                </div>
                
                <div class="button-group">
                    <button class="button small" onclick="upgradeMaxHP()">+10 MAX HP (25)</button>
                    <button class="button small" onclick="upgradeEnergy()">+1 ENERGY (30)</button>
                </div>
                
                <div class="button-group">
                    <button class="button small" onclick="removeCard()">REMOVE CARD (25)</button>
                    <button class="button small" onclick="buyRandomCard()">RANDOM CARD (20-150)</button>
                </div>
                
                <h3 style="margin: 20px 0 10px;">CARDS FOR SALE:</h3>
                <div id="shop-cards"></div>
                
                <div class="button-group" style="margin-top: 20px;">
                    <button class="button" onclick="exitShop()">EXIT SHOP</button>
                    <button class="button secondary" onclick="rerollShop()">REROLL (<span id="reroll-cost">10</span>)</button>
                </div>
            </div>

            <!-- TALENTS SCREEN -->
            <div id="talents-screen" class="screen">
                <h2 class="screen-title">TALENT TREE</h2>
                <p class="screen-subtitle">Points: <span id="talent-points" style="color: var(--accent);">0</span></p>
                
                <div class="talent-tree-container">
                    <div id="talents-tree"></div>
                    <div class="talent-tooltip" id="talent-tooltip"></div>
                </div>
                
                <button class="button" onclick="closeTalents()">BACK</button>
            </div>

            <!-- ACHIEVEMENTS SCREEN -->
            <div id="achievements-screen" class="screen">
                <h2 class="screen-title">ACHIEVEMENTS</h2>
                <div id="achievements-list"></div>
                <button class="button" onclick="closeAchievements()">BACK</button>
            </div>
        </div>

        <!-- GAMEPAD CONTROLS (BATTLE SCREEN) -->
        <div id="gamepad" class="gamepad" style="display: none;">
            <div class="gamepad-button" onclick="endTurn()">END</div>
            <div class="gamepad-button secondary" onclick="toggleInventory()">ITEMS</div>
            <div class="gamepad-button" onclick="viewDiscard()">DISCARD</div>
            <div class="gamepad-button primary" onclick="fleeBattle()">FLEE</div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="deck-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('deck-modal')">√ó</button>
            <h2>YOUR DECK (<span id="modal-deck-count">0</span> CARDS)</h2>
            <div style="margin-bottom: 10px;">
                <div class="button-group">
                    <button class="button small" onclick="sortDeck('name')">NAME</button>
                    <button class="button small" onclick="sortDeck('cost')">COST</button>
                    <button class="button small" onclick="sortDeck('rarity')">RARITY</button>
                    <button class="button small" onclick="sortDeck('type')">TYPE</button>
                </div>
            </div>
            <div id="modal-deck"></div>
        </div>
    </div>

    <div id="discard-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('discard-modal')">√ó</button>
            <h2>DISCARD PILE (<span id="modal-discard-count">0</span> CARDS)</h2>
            <div id="modal-discard"></div>
        </div>
    </div>

    <script>
    // Game State
    let player = {
        class: "",
        maxHP: 0,
        hp: 0,
        inventory: [],
        deck: [],
        level: 1,
        xp: 0,
        maxEnergy: 2,
        buffs: [],
        talents: [],
        talentPoints: 0,
        achievements: [],
        runHistory: [],
        gameMode: "standard" // "standard" or "endless"
    };

    let deck = [];
    let hand = [];
    let discard = [];
    let energy = 0;
    let gold = 50;
    let buffedAttack = 0;
    let block = 0;
    let evadeNextAttack = false;
    let enemyBleedStacks = 0;
    let enemyBleedDamage = 0;
    let shopRerollCost = 10;
    let energyCarryover = 0;
    let comboCount = 0;
    let comboType = "";
    let currentEnemyIndex = 0;
    let enemiesDefeated = 0;
    let damageDealt = 0;
    let damageTaken = 0;
    let cardsPlayed = 0;
    let turnsTaken = 0;
    let gameSettings = {
        colorblindMode: "none",
        fontSize: "medium"
    };

    // Card Database
    const vampireCards = [
        {name:"BITE", cost:1, effect:"attack", value:8, rarity:"common", description:"Deal 8 damage", class:"Vampire", type:"attack"},
        {name:"BLOOD DRAIN", cost:2, effect:"lifesteal", value:6, rarity:"rare", description:"Deal 6 damage and heal for 6", class:"Vampire", type:"attack"},
        {name:"DARK MIST", cost:1, effect:"buff", value:3, rarity:"common", description:"Gain +3 attack next turn", class:"Vampire", type:"buff"},
        {name:"NIGHT SLASH", cost:2, effect:"attack", value:10, rarity:"epic", description:"Deal 10 damage", class:"Vampire", type:"attack"},
        {name:"VAMPIRIC TOUCH", cost:3, effect:"lifesteal", value:12, rarity:"epic", description:"Deal 12 damage and heal for 12", class:"Vampire", type:"attack"},
        {name:"SHADOW STEP", cost:1, effect:"evade", value:0, rarity:"rare", description:"Avoid next enemy attack", class:"Vampire", type:"skill"},
        {name:"BLOOD FRENZY", cost:2, effect:"multistrike", value:5, rarity:"rare", description:"Deal 5 damage twice", class:"Vampire", type:"attack"},
        {name:"MOONLIGHT", cost:0, effect:"heal", value:5, rarity:"common", description:"Heal 5 HP", class:"Vampire", type:"heal"},
        {name:"SANGUINE SHIELD", cost:2, effect:"block", value:8, rarity:"rare", description:"Gain 8 block", class:"Vampire", type:"defense"},
        {name:"HEMORRHAGE", cost:3, effect:"bleed", value:4, rarity:"epic", description:"Enemy takes 4 damage each turn for 3 turns", class:"Vampire", type:"attack"},
        {name:"BLOOD PACT", cost:1, effect:"sacrifice", value:5, rarity:"rare", description:"Lose 5 HP, draw 2 cards", class:"Vampire", type:"skill"},
        {name:"NOSFERATU'S KISS", cost:4, effect:"lifesteal", value:15, rarity:"legendary", description:"Deal 15 damage and heal for 15", class:"Vampire", type:"attack"},
        {name:"SHADOW VEIL", cost:2, effect:"evade", value:0, rarity:"epic", description:"Avoid next 2 enemy attacks", class:"Vampire", type:"skill"},
        {name:"CRIMSON RITUAL", cost:3, effect:"buff", value:5, rarity:"rare", description:"Gain +5 attack next 2 turns", class:"Vampire", type:"buff"},
        {name:"BLOOD MOON", cost:4, effect:"aoe", value:10, rarity:"legendary", description:"Deal 10 damage to all enemies", class:"Vampire", type:"attack"},
        {name:"ETERNAL THIRST", cost:2, effect:"lifesteal", value:8, rarity:"epic", description:"Deal 8 damage and heal for 8", class:"Vampire", type:"attack"},
        {name:"SOUL SIPHON", cost:3, effect:"drain", value:10, rarity:"ancient", description:"Deal 10 damage, heal for half", class:"Vampire", type:"attack"},
        {name:"SHADOW STRIKE", cost:1, effect:"attack", value:6, rarity:"common", description:"Deal 6 damage. Combo: +2 damage per combo", class:"Vampire", type:"attack"},
        {name:"DARK EMBRACE", cost:2, effect:"heal", value:8, rarity:"rare", description:"Heal 8 HP. Combo: +2 HP per combo", class:"Vampire", type:"heal"},
        {name:"NIGHTFALL", cost:3, effect:"buff", value:0, rarity:"epic", description:"Next 3 attacks gain lifesteal", class:"Vampire", type:"buff"}
    ];

    const werewolfCards = [
        {name:"CLAW SWIPE", cost:1, effect:"attack", value:7, rarity:"common", description:"Deal 7 damage", class:"Werewolf", type:"attack"},
        {name:"HOWL", cost:1, effect:"buff", value:4, rarity:"common", description:"Gain +4 attack next turn", class:"Werewolf", type:"buff"},
        {name:"REGENERATE", cost:2, effect:"heal", value:8, rarity:"rare", description:"Heal 8 HP", class:"Werewolf", type:"heal"},
        {name:"REND", cost:2, effect:"attack", value:12, rarity:"epic", description:"Deal 12 damage", class:"Werewolf", type:"attack"},
        {name:"SAVAGE STRIKE", cost:3, effect:"attack", value:18, rarity:"epic", description:"Deal 18 damage", class:"Werewolf", type:"attack"},
        {name:"PACK TACTICS", cost:1, effect:"draw", value:1, rarity:"rare", description:"Draw 1 card", class:"Werewolf", type:"skill"},
        {name:"FERAL ROAR", cost:2, effect:"buff", value:6, rarity:"rare", description:"Gain +6 attack next turn", class:"Werewolf", type:"buff"},
        {name:"POUNCE", cost:1, effect:"attack", value:5, rarity:"common", description:"Deal 5 damage", class:"Werewolf", type:"attack"},
        {name:"TOUGH HIDE", cost:2, effect:"block", value:10, rarity:"rare", description:"Gain 10 block", class:"Werewolf", type:"defense"},
        {name:"MOON FRENZY", cost:3, effect:"multistrike", value:8, rarity:"legendary", description:"Deal 8 damage three times", class:"Werewolf", type:"attack"},
        {name:"ALPHA HOWL", cost:2, effect:"buff", value:8, rarity:"epic", description:"Gain +8 attack next turn", class:"Werewolf", type:"buff"},
        {name:"LUNAR BLESSING", cost:3, effect:"heal", value:15, rarity:"epic", description:"Heal 15 HP", class:"Werewolf", type:"heal"},
        {name:"PACK LEADER", cost:2, effect:"draw", value:2, rarity:"rare", description:"Draw 2 cards", class:"Werewolf", type:"skill"},
        {name:"FURY SWIPES", cost:1, effect:"multistrike", value:4, rarity:"common", description:"Deal 4 damage twice", class:"Werewolf", type:"attack"},
        {name:"MOON'S WRATH", cost:4, effect:"attack", value:25, rarity:"legendary", description:"Deal 25 damage", class:"Werewolf", type:"attack"},
        {name:"PRIMAL ROAR", cost:3, effect:"aoe", value:12, rarity:"legendary", description:"Deal 12 damage to all enemies", class:"Werewolf", type:"attack"},
        {name:"ECLIPSE STRIKE", cost:5, effect:"attack", value:30, rarity:"ancient", description:"Deal 30 damage", class:"Werewolf", type:"attack"},
        {name:"PRIMAL STRIKE", cost:1, effect:"attack", value:6, rarity:"common", description:"Deal 6 damage. Combo: +2 damage per combo", class:"Werewolf", type:"attack"},
        {name:"PACK HEAL", cost:2, effect:"heal", value:8, rarity:"rare", description:"Heal 8 HP. Combo: +2 HP per combo", class:"Werewolf", type:"heal"},
        {name:"BERSERK", cost:3, effect:"buff", value:0, rarity:"epic", description:"Next 3 attacks deal +5 damage", class:"Werewolf", type:"buff"}
    ];

    const neutralCards = [
        {name:"QUICK STRIKE", cost:0, effect:"attack", value:3, rarity:"common", description:"Deal 3 damage", type:"attack"},
        {name:"DEFEND", cost:1, effect:"block", value:5, rarity:"common", description:"Gain 5 block", type:"defense"},
        {name:"POWER UP", cost:1, effect:"energy", value:1, rarity:"rare", description:"Gain 1 energy", type:"skill"},
        {name:"SECOND WIND", cost:1, effect:"heal", value:4, rarity:"common", description:"Heal 4 HP", type:"heal"},
        {name:"PRECISION STRIKE", cost:2, effect:"attack", value:9, rarity:"rare", description:"Deal 9 damage", type:"attack"},
        {name:"ADRENALINE", cost:0, effect:"draw", value:1, rarity:"rare", description:"Draw 1 card", type:"skill"},
        {name:"COUNTER", cost:2, effect:"counter", value:6, rarity:"epic", description:"Deal 6 damage when attacked", type:"skill"},
        {name:"TAUNT", cost:1, effect:"taunt", value:0, rarity:"common", description:"Enemy is more likely to attack next turn", type:"skill"},
        {name:"DODGE", cost:1, effect:"evade", value:0, rarity:"rare", description:"50% chance to avoid next attack", type:"skill"},
        {name:"REJUVENATE", cost:2, effect:"heal", value:8, rarity:"rare", description:"Heal 8 HP", type:"heal"},
        {name:"DOUBLE STRIKE", cost:2, effect:"multistrike", value:5, rarity:"epic", description:"Deal 5 damage twice", type:"attack"},
        {name:"LAST STAND", cost:3, effect:"laststand", value:15, rarity:"legendary", description:"Deal 15 damage when below 25% HP", type:"attack"},
        {name:"FIRE STRIKE", cost:2, effect:"attack", value:7, rarity:"rare", description:"Deal 7 fire damage", type:"attack", element:"fire"},
        {name:"HOLY LIGHT", cost:2, effect:"heal", value:10, rarity:"rare", description:"Heal 10 HP", type:"heal", element:"holy"},
        {name:"SHADOW BOLT", cost:2, effect:"attack", value:8, rarity:"rare", description:"Deal 8 shadow damage", type:"attack", element:"shadow"}
    ];

    const talents = {
        vampire: [
            {id: "v1", name: "Bloodlust", description: "Lifesteal effects heal +2 more", cost: 1, requires: [], x: 0, y: 0},
            {id: "v2", name: "Shadow Affinity", description: "Shadow cards cost 1 less energy", cost: 2, requires: ["v1"], x: 1, y: 0},
            {id: "v3", name: "Hemomancy", description: "Bleed effects last +1 turn", cost: 1, requires: ["v1"], x: 1, y: 1},
            {id: "v4", name: "Nightborn", description: "+5 Max HP", cost: 1, requires: [], x: 0, y: 2},
            {id: "v5", name: "Sanguine Mastery", description: "Blood cards deal +2 damage", cost: 2, requires: ["v2", "v3"], x: 2, y: 0.5},
            {id: "v6", name: "Eternal Night", description: "Start combat with +1 energy", cost: 3, requires: ["v5"], x: 3, y: 0.5},
            {id: "v7", name: "Moonlight Veil", description: "Evade effects last +1 turn", cost: 2, requires: ["v4"], x: 1, y: 2},
            {id: "v8", name: "Ancient Bloodline", description: "Heal 5 HP at start of turn", cost: 3, requires: ["v7"], x: 2, y: 2}
        ],
        werewolf: [
            {id: "w1", name: "Primal Strength", description: "Attack cards deal +2 damage", cost: 1, requires: [], x: 0, y: 0},
            {id: "w2", name: "Pack Leader", description: "Draw +1 card at start of turn", cost: 2, requires: ["w1"], x: 1, y: 0},
            {id: "w3", name: "Thick Hide", description: "Block effects are +3 stronger", cost: 1, requires: ["w1"], x: 1, y: 1},
            {id: "w4", name: "Moon Frenzy", description: "+5 Max HP", cost: 1, requires: [], x: 0, y: 2},
            {id: "w5", name: "Alpha Howl", description: "Buff effects are +2 stronger", cost: 2, requires: ["w2", "w3"], x: 2, y: 0.5},
            {id: "w6", name: "Eclipse Power", description: "Start combat with +1 energy", cost: 3, requires: ["w5"], x: 3, y: 0.5},
            {id: "w7", name: "Regeneration", description: "Heal 3 HP at start of turn", cost: 2, requires: ["w4"], x: 1, y: 2},
            {id: "w8", name: "Primal Rage", description: "When below 50% HP, deal +3 damage", cost: 3, requires: ["w7"], x: 2, y: 2}
        ]
    };

    const achievements = [
        {id: "first_blood", name: "First Blood", description: "Defeat your first enemy", icon: "ü©∏", unlocked: false},
        {id: "shopaholic", name: "Shopaholic", description: "Spend 200 gold in shops", icon: "üõçÔ∏è", unlocked: false},
        {id: "combo_master", name: "Combo Master", description: "Reach a 5-card combo", icon: "üåÄ", unlocked: false},
        {id: "perfect_victory", name: "Perfect Victory", description: "Win a battle without taking damage", icon: "‚ú®", unlocked: false},
        {id: "deck_builder", name: "Deck Builder", description: "Have 20 cards in your deck", icon: "üÉè", unlocked: false},
        {id: "legendary_collector", name: "Legendary Collector", description: "Obtain 3 legendary cards", icon: "üåü", unlocked: false},
        {id: "vampire_master", name: "Vampire Master", description: "Complete the game as Vampire", icon: "üßõ", unlocked: false},
        {id: "werewolf_master", name: "Werewolf Master", description: "Complete the game as Werewolf", icon: "üê∫", unlocked: false},
        {id: "endless_champion", name: "Endless Champion", description: "Reach wave 10 in endless mode", icon: "‚ôæÔ∏è", unlocked: false},
        {id: "talent_legend", name: "Talent Legend", description: "Unlock all talents", icon: "üéì", unlocked: false}
    ];

    let enemies = [
        { name:"HUNTER", hp:40, maxHP:40, attack:6, ability:"buff", reward:15, description:"Gains strength each turn", avatar:"üßë‚Äçüåæ", tooltip:"Gains +2 attack each turn"},
        { name:"PALADIN", hp:60, maxHP:60, attack:8, ability:"smite", reward:25, description:"Occasionally smites for massive damage", avatar:"üßë‚Äç‚öñÔ∏è", tooltip:"30% chance to smite for +5 damage"},
        { name:"DEMON LORD", hp:100, maxHP:100, attack:12, ability:"fireball", reward:40, description:"Casts devastating fire spells", avatar:"üëπ", tooltip:"40% chance to cast fireball for 10 damage"},
        { name:"UNDEAD HORDE", hp:80, maxHP:80, attack:10, ability:"summon", reward:30, description:"Summons reinforcements", avatar:"üßü", tooltip:"25% chance to heal 10 HP"},
        { name:"DARK SORCERER", hp:70, maxHP:70, attack:15, ability:"curse", reward:35, description:"Inflicts debilitating curses", avatar:"üßô‚Äç‚ôÇÔ∏è", tooltip:"30% chance to curse you for 5 damage"},
        { name:"DRAGON", hp:120, maxHP:120, attack:20, ability:"firebreath", reward:50, description:"Breathes fire every turn", avatar:"üê≤", tooltip:"Deals 8 fire damage each turn"},
        { name:"NECROMANCER", hp:90, maxHP:90, attack:12, ability:"raise", reward:45, description:"Raises fallen enemies", avatar:"üßü‚Äç‚ôÇÔ∏è", tooltip:"May revive defeated enemies"},
        { name:"VAMPIRE HUNTER", hp:75, maxHP:75, attack:18, ability:"silver", reward:40, description:"Specialized against vampires", avatar:"üßõ‚Äç‚ôÄÔ∏è", tooltip:"Deals +3 damage to vampires"},
        { name:"WEREWOLF HUNTER", hp:85, maxHP:85, attack:16, ability:"silver", reward:40, description:"Specialized against werewolves", avatar:"üê∫‚Äçüó°Ô∏è", tooltip:"Deals +3 damage to werewolves"},
        { name:"ANCIENT LICH", hp:150, maxHP:150, attack:25, ability:"darkmagic", reward:75, description:"Master of dark arts", avatar:"üíÄ", tooltip:"Casts dark magic for 15 damage"}
    ];

    // Endless mode enemies (scaled versions of regular enemies)
    const endlessEnemies = [
        { name:"HUNTER PACK", hp:60, maxHP:60, attack:9, ability:"buff", reward:20, description:"Gains strength each turn", avatar:"üßë‚Äçüåæüßë‚Äçüåæ", tooltip:"Gains +3 attack each turn"},
        { name:"HOLY PALADIN", hp:90, maxHP:90, attack:12, ability:"smite", reward:35, description:"Frequently smites for massive damage", avatar:"üßë‚Äç‚öñÔ∏è‚ú®", tooltip:"40% chance to smite for +7 damage"},
        { name:"INFERNAL LORD", hp:150, maxHP:150, attack:18, ability:"fireball", reward:60, description:"Casts powerful fire spells", avatar:"üëπüî•", tooltip:"50% chance to cast fireball for 15 damage"},
        { name:"LEGION OF UNDEAD", hp:120, maxHP:120, attack:15, ability:"summon", reward:45, description:"Constantly summons reinforcements", avatar:"üßüüßüüßü", tooltip:"35% chance to heal 15 HP"},
        { name:"ARCHNECROMANCER", hp:135, maxHP:135, attack:18, ability:"raise", reward:65, description:"Raises powerful fallen enemies", avatar:"üßü‚Äç‚ôÇÔ∏èüëë", tooltip:"May revive multiple enemies"},
        { name:"ANCIENT DRAGON", hp:180, maxHP:180, attack:30, ability:"firebreath", reward:75, description:"Breathes intense fire every turn", avatar:"üê≤üî•", tooltip:"Deals 12 fire damage each turn"},
        { name:"VAMPIRE SLAYER", hp:110, maxHP:110, attack:27, ability:"silver", reward:60, description:"Expert vampire hunter", avatar:"üßõ‚Äç‚ôÄÔ∏è‚öîÔ∏è", tooltip:"Deals +5 damage to vampires"},
        { name:"WEREWOLF SLAYER", hp:125, maxHP:125, attack:24, ability:"silver", reward:60, description:"Expert werewolf hunter", avatar:"üê∫‚Äçüó°Ô∏è‚öîÔ∏è", tooltip:"Deals +5 damage to werewolves"},
        { name:"LICH KING", hp:225, maxHP:225, attack:35, ability:"darkmagic", reward:100, description:"Supreme master of dark arts", avatar:"üíÄüëë", tooltip:"Casts dark magic for 20 damage"}
    ];

    let enemy = {};
    let currentBattleEffects = [];
    let enemyEffects = [];
    let gameState = "settings"; // "settings", "class", "game", "battle", "shop", "reward"

    // Initialize the game
    window.onload = function() {
        loadGame();
        applySettings();
        showScreen('settings-screen');
        
        // Set up talent tooltip
        const tooltip = document.getElementById('talent-tooltip');
        document.getElementById('talents-tree').addEventListener('mousemove', (e) => {
            tooltip.style.left = (e.clientX + 10) + 'px';
            tooltip.style.top = (e.clientY + 10) + 'px';
        });
    };

    function showScreen(screenId) {
    // Hide all screens first
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    
    // Show the requested screen
    document.getElementById(screenId).classList.add('active');
    
    // Show/hide gamepad controls (only for battle screen)
    if (screenId === 'battle-screen') {
        document.getElementById('gamepad').style.display = 'flex';
    } else {
        document.getElementById('gamepad').style.display = 'none';
    }
}

    function loadGame() {
        const savedGame = localStorage.getItem('vampiresVsWerewolvesSave');
        if (savedGame) {
            const parsed = JSON.parse(savedGame);
            if (parsed.settings) gameSettings = parsed.settings;
            if (parsed.achievements) achievements = parsed.achievements;
        }
    }

    function saveGame() {
        const gameData = {
            settings: gameSettings,
            achievements: achievements
        };
        localStorage.setItem('vampiresVsWerewolvesSave', JSON.stringify(gameData));
    }

    function applySettings() {
        document.body.style.fontSize = gameSettings.fontSize === "small" ? "14px" : 
                                     gameSettings.fontSize === "large" ? "18px" : "16px";
    }

    function showSettings() {
        showScreen('settings-screen');
        document.getElementById('font-size').value = gameSettings.fontSize;
    }

    function startGame() {
        gameSettings.fontSize = document.getElementById('font-size').value;
        applySettings();
        saveGame();
        
        showScreen('class-selection');
    }

    // Game Functions
    function chooseClass(chosenClass) {
        if (chosenClass === "Vampire") {
            player = { 
                class: "Vampire", 
                maxHP: 60,
                hp: 60,
                inventory: ["Health Potion", "Energy Potion"],
                deck: [
                    getCardByName("BITE"),
                    getCardByName("BLOOD DRAIN"),
                    getCardByName("DARK MIST"),
                    getCardByName("MOONLIGHT"),
                    getCardByName("QUICK STRIKE"),
                    getCardByName("DEFEND")
                ],
                level: 1,
                xp: 0,
                maxEnergy: 2,
                talents: [],
                talentPoints: 0,
                achievements: [],
                runHistory: [],
                gameMode: player.gameMode || "standard"
            };
        } else {
            player = { 
                class: "Werewolf", 
                maxHP: 70,
                hp: 70,
                inventory: ["Health Potion", "Energy Potion"],
                deck: [
                    getCardByName("CLAW SWIPE"),
                    getCardByName("HOWL"),
                    getCardByName("REGENERATE"),
                    getCardByName("POUNCE"),
                    getCardByName("DEFEND"),
                    getCardByName("QUICK STRIKE")
                ],
                level: 1,
                xp: 0,
                maxEnergy: 2,
                talents: [],
                talentPoints: 0,
                achievements: [],
                runHistory: [],
                gameMode: player.gameMode || "standard"
            };
        }

        deck = [...player.deck];
        shuffleDeck(deck);
        showScreen('game-screen');
        document.getElementById("class-name").innerText = `THE ${player.class.toUpperCase()}`;
        document.getElementById("game-mode").innerText = player.gameMode === "endless" ? "Endless" : "Standard";
        
        updatePlayerStats();
        updateDeckInfo();
        updateNextEnemy();
        renderTalents();
        renderAchievements();
    }

    function toggleGameMode() {
        player.gameMode = player.gameMode === "standard" ? "endless" : "standard";
        document.getElementById("game-mode").innerText = player.gameMode === "endless" ? "Endless" : "Standard";
        currentEnemyIndex = 0;
        updateNextEnemy();
    }

    function getCardByName(name) {
        for (let card of vampireCards) {
            if (card.name === name) return {...card};
        }
        
        for (let card of werewolfCards) {
            if (card.name === name) return {...card};
        }
        
        for (let card of neutralCards) {
            if (card.name === name) return {...card};
        }
        
        return null;
    }

    function shuffleDeck(deck) {
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
    }

    function updatePlayerStats() {
        const healthPercent = (player.hp / player.maxHP) * 100;
        document.getElementById("player-health-fill").style.width = `${healthPercent}%`;
        document.getElementById("player-health-text").innerText = `${player.hp}/${player.maxHP}`;
        document.getElementById("battle-player-health-fill").style.width = `${healthPercent}%`;
        document.getElementById("battle-player-health-text").innerText = `${player.hp}/${player.maxHP}`;
        document.getElementById("hp-display").innerText = `${player.hp}/${player.maxHP}`;
        document.getElementById("gold-display").innerText = gold;
        document.getElementById("gold-value").innerText = gold;
        document.getElementById("energy-display").innerText = `${player.maxEnergy}/${player.maxEnergy}`;
        document.getElementById("level-value").innerText = player.level;
        document.getElementById("xp-value").innerText = player.xp;
        document.getElementById("xp-needed").innerText = player.level * 20;
        
        updateStatusEffects();
        updateComboMeter();
    }

    function updateStatusEffects() {
        const effectsDiv = document.getElementById("status-effects");
        const battleEffectsDiv = document.getElementById("battle-status-effects");
        effectsDiv.innerHTML = "";
        battleEffectsDiv.innerHTML = "";
        
        if (buffedAttack > 0) {
            effectsDiv.innerHTML += `<span class="status-effect buff">+${buffedAttack} ATK</span>`;
            battleEffectsDiv.innerHTML += `<span class="status-effect buff">+${buffedAttack} ATK</span>`;
        }
        
        if (block > 0) {
            effectsDiv.innerHTML += `<span class="status-effect block">${block} BLK</span>`;
            battleEffectsDiv.innerHTML += `<span class="status-effect block">${block} BLK</span>`;
        }
        
        if (evadeNextAttack) {
            const evadeText = typeof evadeNextAttack === 'number' ? 
                             `EVADE (${evadeNextAttack})` : "EVADE";
            effectsDiv.innerHTML += `<span class="status-effect buff">${evadeText}</span>`;
            battleEffectsDiv.innerHTML += `<span class="status-effect buff">${evadeText}</span>`;
        }
    }

    function updateComboMeter() {
        const comboPercent = comboCount > 0 ? Math.min(100, comboCount * 20) : 0;
        document.getElementById("combo-fill").style.width = `${comboPercent}%`;
        document.getElementById("battle-combo-fill").style.width = `${comboPercent}%`;
        
        const comboText = comboCount > 0 ? 
            `${comboCount}-CARD ${comboType.toUpperCase()} COMBO!` : "";
        document.getElementById("combo-text").innerText = comboText;
        document.getElementById("battle-combo-text").innerText = comboText;
    }

    function updateEnemyStatusEffects() {
        const effectsDiv = document.getElementById("enemy-status-effects");
        effectsDiv.innerHTML = "";
        
        if (enemyBleedStacks > 0) {
            effectsDiv.innerHTML += `<span class="status-effect debuff">BLEED (${enemyBleedStacks})</span>`;
        }
    }

    function updateDeckInfo() {
        document.getElementById("modal-deck-count").innerText = deck.length + hand.length;
        document.getElementById("modal-discard-count").innerText = discard.length;
    }

    function updateNextEnemy() {
        if (player.gameMode === "endless") {
            const endlessIndex = currentEnemyIndex % endlessEnemies.length;
            const wave = Math.floor(currentEnemyIndex / endlessEnemies.length) + 1;
            const enemyData = endlessEnemies[endlessIndex];
            document.getElementById("next-enemy").innerText = `${enemyData.name} (WAVE ${wave})`;
        } else {
            if (currentEnemyIndex < enemies.length) {
                const enemyData = enemies[currentEnemyIndex];
                document.getElementById("next-enemy").innerText = enemyData.name;
            } else {
                document.getElementById("next-enemy").innerText = "FINAL BOSS";
            }
        }
    }

    function startBattle() {
        if (player.gameMode === "endless") {
            const endlessIndex = currentEnemyIndex % endlessEnemies.length;
            const wave = Math.floor(currentEnemyIndex / endlessEnemies.length) + 1;
            enemy = {...endlessEnemies[endlessIndex]};
            enemy.hp = Math.floor(enemy.hp * (1 + (wave-1)*0.1));
            enemy.maxHP = enemy.hp;
            enemy.attack = Math.floor(enemy.attack * (1 + (wave-1)*0.1));
            enemy.reward = Math.floor(enemy.reward * (1 + (wave-1)*0.2));
        } else {
            if (currentEnemyIndex < enemies.length) {
                enemy = {...enemies[currentEnemyIndex]};
            } else {
                // Final boss is a powered-up Ancient Lich
                enemy = {
                    name: "ANCIENT LICH KING",
                    hp: 200,
                    maxHP: 200,
                    attack: 30,
                    ability: "darkmagic",
                    reward: 100,
                    description: "The supreme master of dark arts",
                    avatar: "üíÄüëë",
                    tooltip: "Casts devastating dark magic for 20 damage"
                };
            }
        }
        
        showScreen('battle-screen');
        const battleTitle = player.gameMode === "endless" ? 
            `BATTLE ${currentEnemyIndex+1} (WAVE ${Math.floor(currentEnemyIndex / endlessEnemies.length) + 1})` : 
            `BATTLE ${currentEnemyIndex+1}`;
        document.getElementById("battle-title").innerText = battleTitle;
        document.getElementById("enemy-name").innerText = enemy.name;
        document.getElementById("enemy-avatar").innerText = enemy.avatar;
        document.getElementById("game-over-message").style.display = 'none';
        document.getElementById("victory-message").style.display = 'none';
        
        // Apply talent effects
        let startEnergy = player.maxEnergy;
        if (player.class === "Vampire" && player.talents.includes("v6")) {
            startEnergy += 1;
        }
        if (player.class === "Werewolf" && player.talents.includes("w6")) {
            startEnergy += 1;
        }
        
        block = 0;
        evadeNextAttack = false;
        buffedAttack = 0;
        enemyBleedStacks = 0;
        enemyBleedDamage = 0;
        currentBattleEffects = [];
        enemyEffects = [];
        energyCarryover = 0;
        comboCount = 0;
        comboType = "";
        
        updateEnemyStats();
        energy = startEnergy;
        updateEnergyDisplay();
        drawCards(5);
        log(`A WILD ${enemy.name} APPEARS! ${enemy.description}`);
        
        // Apply talent effects at start of combat
        if (player.class === "Vampire" && player.talents.includes("v8")) {
            player.hp = Math.min(player.hp + 5, player.maxHP);
            log("ANCIENT BLOODLINE: Healed 5 HP at start of turn");
        }
        if (player.class === "Werewolf" && player.talents.includes("w7")) {
            player.hp = Math.min(player.hp + 3, player.maxHP);
            log("REGENERATION: Healed 3 HP at start of turn");
        }
        
        updatePlayerStats();
    }

    function updateEnemyStats() {
        const healthPercent = (enemy.hp / enemy.maxHP) * 100;
        document.getElementById("enemy-health-fill").style.width = `${healthPercent}%`;
        document.getElementById("enemy-health-text").innerText = `${enemy.hp}/${enemy.maxHP}`;
        updateEnemyStatusEffects();
    }

    function updateEnergyDisplay() {
        let energyDiv = document.getElementById("energy-display");
        energyDiv.innerHTML = "";
        for (let i = 0; i < energy; i++) {
            const orb = document.createElement("span");
            orb.className = "energy-orb filled";
            energyDiv.appendChild(orb);
        }
        for (let i = energy; i < player.maxEnergy; i++) {
            const orb = document.createElement("span");
            orb.className = "energy-orb";
            energyDiv.appendChild(orb);
        }
        
        document.getElementById("energy-display").innerText = `${energy}/${player.maxEnergy}`;
    }

    function drawCards(amount = 5) {
        // Apply talent effects
        let drawAmount = amount;
        if (player.class === "Werewolf" && player.talents.includes("w2")) {
            drawAmount += 1;
        }
        
        if (deck.length === 0) {
            if (discard.length === 0) {
                log("NO CARDS LEFT TO DRAW!");
                return;
            }
            deck = [...discard];
            discard = [];
            shuffleDeck(deck);
            log("SHUFFLED DISCARD PILE INTO DECK!");
        }
        
        let cardsDrawn = 0;
        for (let i = 0; i < drawAmount && deck.length > 0; i++) {
            let card = deck.shift();
            if (card) {
                hand.push(card);
                cardsDrawn++;
            }
        }
        
        if (cardsDrawn > 0) {
            log(`DREW ${cardsDrawn} CARD${cardsDrawn > 1 ? 'S' : ''}`);
            if (drawAmount > amount) {
                log("PACK LEADER: Drew an extra card!");
            }
        }
        
        renderHand();
        updateDeckInfo();
    }

    function renderHand() {
        let handDiv = document.getElementById("hand");
        handDiv.innerHTML = "";
        
        hand.forEach((card, index) => {
            const cardElement = document.createElement("div");
            cardElement.className = `card ${card.rarity} hand-card`;
            cardElement.onclick = () => playCard(index);
            
            const cardName = document.createElement("h3");
            cardName.textContent = card.name;
            
            const cardEffect = document.createElement("p");
            cardEffect.textContent = card.description;
            
            const cardCost = document.createElement("p");
            cardCost.className = "card-cost";
            cardCost.textContent = `COST: ${getCardActualCost(card)}`;
            
            cardElement.appendChild(cardName);
            cardElement.appendChild(cardEffect);
            cardElement.appendChild(cardCost);
            
            handDiv.appendChild(cardElement);
        });
    }

    function getCardActualCost(card) {
        // Apply talent discounts
        if (player.class === "Vampire" && player.talents.includes("v2") && 
            (card.element === "shadow" || card.class === "Vampire")) {
            return Math.max(0, card.cost - 1);
        }
        return card.cost;
    }

    function playCard(index) {
        if (index >= hand.length) return;
        
        let card = hand[index];
        const actualCost = getCardActualCost(card);
        if (energy < actualCost) {
            log("NOT ENOUGH ENERGY!");
            return;
        }
        
        energy -= actualCost;
        updateEnergyDisplay();
        
        // Update combo
        if (comboCount === 0) {
            // Start new combo
            comboCount = 1;
            if (card.effect === "attack" || card.effect === "lifesteal" || card.effect === "multistrike" || card.effect === "bleed") {
                comboType = "attack";
            } else if (card.effect === "heal") {
                comboType = "heal";
            } else {
                comboType = "skill";
            }
        } else {
            // Continue combo if same type
            let cardType = "";
            if (card.effect === "attack" || card.effect === "lifesteal" || card.effect === "multistrike" || card.effect === "bleed") {
                cardType = "attack";
            } else if (card.effect === "heal") {
                cardType = "heal";
            } else {
                cardType = "skill";
            }
            
            if (cardType === comboType) {
                comboCount++;
                checkAchievement("combo_master", comboCount >= 5);
            } else {
                // Break combo
                comboCount = 0;
                comboType = "";
            }
        }
        updateComboMeter();

        let effectApplied = false;
        let totalDamage = 0;
        
        // Apply talent bonuses
        let attackBonus = buffedAttack;
        if (player.class === "Vampire" && player.talents.includes("v5") && 
            (card.name.includes("BLOOD") || card.name.includes("SANGUINE"))) {
            attackBonus += 2;
        }
        if (player.class === "Werewolf" && player.talents.includes("w1") && 
            (card.effect === "attack" || card.effect === "lifesteal" || card.effect === "multistrike")) {
            attackBonus += 2;
        }
        if (player.class === "Werewolf" && player.talents.includes("w8") && player.hp <= player.maxHP / 2) {
            attackBonus += 3;
        }
        
        // Apply combo bonuses
        let comboBonus = 0;
        if (comboCount >= 3) {
            if (player.class === "Vampire" && comboType === "attack") {
                comboBonus = (comboCount - 2) * 2;
            }
            if (player.class === "Werewolf" && comboType === "attack") {
                comboBonus = (comboCount - 2) * 3;
            }
        }
        
        if (card.effect === "attack") {
            totalDamage = card.value + attackBonus + comboBonus;
            enemy.hp -= totalDamage;
            createDamagePopup(enemy.avatar, totalDamage);
            log(`${card.name} DEALS ${totalDamage} DAMAGE!`);
            effectApplied = true;
            damageDealt += totalDamage;
        } 
        else if (card.effect === "lifesteal") {
            totalDamage = card.value + attackBonus + comboBonus;
            enemy.hp -= totalDamage;
            let healAmount = totalDamage;
            
            // Apply talent bonuses
            if (player.class === "Vampire" && player.talents.includes("v1")) {
                healAmount += 2;
            }
            
            player.hp = Math.min(player.hp + healAmount, player.maxHP);
            createDamagePopup(enemy.avatar, totalDamage);
            createHealPopup("YOU", healAmount);
            log(`${card.name} DRAINS ${totalDamage} HP AND HEALS ${healAmount} HP!`);
            effectApplied = true;
            damageDealt += totalDamage;
        } 
        else if (card.effect === "buff") {
            let buffValue = card.value;
            
            // Apply talent bonuses
            if (player.class === "Werewolf" && player.talents.includes("w5")) {
                buffValue += 2;
            }
            
            buffedAttack += buffValue;
            log(`${card.name} POWERS YOU UP (+${buffValue} ATK NEXT TURN)!`);
            effectApplied = true;
        } 
        else if (card.effect === "heal") {
            let healValue = card.value;
            
            // Apply combo bonuses
            if (comboCount >= 3 && comboType === "heal") {
                healValue += (comboCount - 2) * 2;
            }
            
            player.hp = Math.min(player.hp + healValue, player.maxHP);
            createHealPopup("YOU", healValue);
            log(`${card.name} HEALS ${healValue} HP`);
            effectApplied = true;
        }
        else if (card.effect === "evade") {
            if (card.name === "DODGE") {
                evadeNextAttack = Math.random() < 0.5;
                if (evadeNextAttack) {
                    log(`${card.name} - YOU MAY DODGE THE NEXT ATTACK!`);
                } else {
                    log(`${card.name} - FAILED TO DODGE!`);
                }
            } else {
                evadeNextAttack = true;
                if (card.name === "SHADOW VEIL") {
                    evadeNextAttack = 2;
                    // Apply talent bonus
                    if (player.class === "Vampire" && player.talents.includes("v7")) {
                        evadeNextAttack += 1;
                        log("MOONLIGHT VEIL: Evade lasts +1 turn!");
                    }
                }
                log(`${card.name} - NEXT ENEMY ATTACK WILL MISS!`);
            }
            effectApplied = true;
        }
        else if (card.effect === "multistrike") {
            const hits = card.name === "MOON FRENZY" ? 3 : 
                        card.name === "BLOOD FRENZY" ? 2 : 
                        card.name === "FURY SWIPES" ? 2 : 2;
            totalDamage = (card.value + attackBonus + comboBonus) * hits;
            enemy.hp -= totalDamage;
            createDamagePopup(enemy.avatar, totalDamage);
            log(`${card.name} HITS ${hits} TIMES FOR ${card.value + attackBonus + comboBonus} DAMAGE EACH (${totalDamage} TOTAL)!`);
            effectApplied = true;
            damageDealt += totalDamage;
        }
        else if (card.effect === "block") {
            let blockValue = card.value;
            
            // Apply talent bonuses
            if (player.class === "Werewolf" && player.talents.includes("w3")) {
                blockValue += 3;
            }
            
            block += blockValue;
            log(`${card.name} GIVES YOU ${blockValue} BLOCK`);
            effectApplied = true;
        }
        else if (card.effect === "energy") {
            energy += card.value;
            updateEnergyDisplay();
            log(`${card.name} GIVES YOU ${card.value} ENERGY`);
            effectApplied = true;
        }
        else if (card.effect === "draw") {
            drawCards(card.value);
            log(`${card.name} LETS YOU DRAW ${card.value} CARD${card.value > 1 ? 'S' : ''}`);
            effectApplied = true;
        }
        else if (card.effect === "bleed") {
            enemyBleedStacks = 3;
            enemyBleedDamage = card.value;
            
            // Apply talent bonus
            if (player.class === "Vampire" && player.talents.includes("v3")) {
                enemyBleedStacks += 1;
                log("HEMOMANCY: Bleed lasts +1 turn!");
            }
            
            log(`${card.name} MAKES ENEMY BLEED FOR ${card.value} DAMAGE FOR ${enemyBleedStacks} TURNS`);
            effectApplied = true;
        }
        else if (card.effect === "sacrifice") {
            player.hp -= card.value;
            drawCards(2);
            createDamagePopup("YOU", card.value);
            log(`${card.name} - LOSE ${card.value} HP TO DRAW 2 CARDS`);
            effectApplied = true;
            damageTaken += card.value;
        }
        else if (card.effect === "aoe") {
            totalDamage = card.value + attackBonus + comboBonus;
            enemy.hp -= totalDamage;
            createDamagePopup(enemy.avatar, totalDamage);
            log(`${card.name} DEALS ${totalDamage} DAMAGE TO ALL ENEMIES!`);
            effectApplied = true;
            damageDealt += totalDamage;
        }
        else if (card.effect === "drain") {
            const damage = card.value + attackBonus + comboBonus;
            enemy.hp -= damage;
            let healAmount = Math.floor(damage/2);
            player.hp = Math.min(player.hp + healAmount, player.maxHP);
            createDamagePopup(enemy.avatar, damage);
            createHealPopup("YOU", healAmount);
            log(`${card.name} DEALS ${damage} DAMAGE AND HEALS FOR ${healAmount}`);
            effectApplied = true;
            damageDealt += damage;
        }
        else if (card.effect === "laststand" && player.hp <= Math.floor(player.maxHP * 0.25)) {
            totalDamage = card.value + attackBonus + comboBonus;
            enemy.hp -= totalDamage;
            createDamagePopup(enemy.avatar, totalDamage);
            log(`${card.name} - LAST STAND DEALS ${totalDamage} DAMAGE!`);
            effectApplied = true;
            damageDealt += totalDamage;
        }
        else if (card.effect === "counter") {
            currentBattleEffects.push({type: "counter", value: card.value + comboBonus});
            log(`${card.name} - WILL COUNTER NEXT ATTACK FOR ${card.value + comboBonus} DAMAGE`);
            effectApplied = true;
        }
        
        if (effectApplied) {
            discard.push(card);
            hand.splice(index, 1);
            renderHand();
            updateDeckInfo();
            
            updatePlayerStats();
            updateEnemyStats();
            cardsPlayed++;
            
            if (enemy.hp <= 0) {
                enemy.hp = 0;
                updateEnemyStats();
                victory();
                return;
            }
        }
    }

    function createDamagePopup(target, amount) {
        const popup = document.createElement("div");
        popup.className = "damage-popup";
        popup.textContent = `-${amount}`;
        
        if (target === "YOU") {
            const playerElement = document.getElementById("battle-player-health-text");
            popup.style.left = `${playerElement.offsetLeft + playerElement.offsetWidth/2}px`;
            popup.style.top = `${playerElement.offsetTop}px`;
        } else {
            const enemyElement = document.getElementById("enemy-health-text");
            popup.style.left = `${enemyElement.offsetLeft + enemyElement.offsetWidth/2}px`;
            popup.style.top = `${enemyElement.offsetTop}px`;
        }
        
        document.getElementById("battle-screen").appendChild(popup);
        setTimeout(() => popup.remove(), 1000);
        
        // Shake effect for large damage
        if (amount >= 15) {
            const avatar = document.getElementById("enemy-avatar");
            avatar.classList.add("shake");
            setTimeout(() => avatar.classList.remove("shake"), 500);
        }
    }

    function createHealPopup(target, amount) {
        const popup = document.createElement("div");
        popup.className = "heal-popup";
        popup.textContent = `+${amount}`;
        
        if (target === "YOU") {
            const playerElement = document.getElementById("battle-player-health-text");
            popup.style.left = `${playerElement.offsetLeft + playerElement.offsetWidth/2}px`;
            popup.style.top = `${playerElement.offsetTop}px`;
        } else {
            const enemyElement = document.getElementById("enemy-health-text");
            popup.style.left = `${enemyElement.offsetLeft + enemyElement.offsetWidth/2}px`;
            popup.style.top = `${enemyElement.offsetTop}px`;
        }
        
        document.getElementById("battle-screen").appendChild(popup);
        setTimeout(() => popup.remove(), 1000);
    }

    function enemyTurn() {
        turnsTaken++;
        
        if (enemyBleedStacks > 0) {
            enemy.hp -= enemyBleedDamage;
            enemyBleedStacks--;
            createDamagePopup(enemy.avatar, enemyBleedDamage);
            log(`ENEMY BLEEDS FOR ${enemyBleedDamage} DAMAGE! (${enemyBleedStacks} TURNS LEFT)`);
            updateEnemyStats();
            damageDealt += enemyBleedDamage;
            
            if (enemy.hp <= 0) {
                enemy.hp = 0;
                updateEnemyStats();
                victory();
                return;
            }
        }
        
        if (evadeNextAttack) {
            if (typeof evadeNextAttack === 'number') {
                evadeNextAttack--;
                if (evadeNextAttack <= 0) {
                    evadeNextAttack = false;
                    log(`YOU EVADE THE ENEMY'S ATTACK! (NO MORE EVADES LEFT)`);
                } else {
                    log(`YOU EVADE THE ENEMY'S ATTACK! (${evadeNextAttack} EVADES REMAINING)`);
                }
            } else {
                log(`YOU EVADE THE ENEMY'S ATTACK!`);
                evadeNextAttack = false;
            }
            return;
        }
        
        let damageTaken = 0;
        let attackDamage = enemy.attack;
        
        if (enemy.ability === "buff") {
            attackDamage += 2;
            enemy.attack = attackDamage;
            log(`${enemy.name} ENRAGES! ATTACK +2 (NOW ${enemy.attack})`);
        } 
        else if (enemy.ability === "smite" && Math.random() < 0.3) {
            attackDamage += 5;
            log(`‚òÑÔ∏è ${enemy.name} CHANNELS HOLY ENERGY...`);
        } 
        else if (enemy.ability === "fireball" && Math.random() < 0.4) {
            attackDamage = 10;
            log(`üî• ${enemy.name} GATHERS FIREBALL ENERGY...`);
        }
        else if (enemy.ability === "summon" && Math.random() < 0.25) {
            const healAmount = 10;
            enemy.hp = Math.min(enemy.hp + healAmount, enemy.maxHP);
            createHealPopup(enemy.avatar, healAmount);
            log(`${enemy.name} SUMMONS REINFORCEMENTS! +${healAmount} HP`);
            updateEnemyStats();
        }
        else if (enemy.ability === "curse" && Math.random() < 0.3) {
            attackDamage = 5;
            log(`‚ò†Ô∏è ${enemy.name} CASTS A CURSE...`);
        }
        else if (enemy.ability === "firebreath") {
            attackDamage = 8;
            log(`üî• ${enemy.name} TAKES A DEEP BREATH...`);
        }
        else if (enemy.ability === "silver") {
            attackDamage += 3;
            log(`‚öîÔ∏è ${enemy.name} BRANDISHES SILVER WEAPONS...`);
        }
        else if (enemy.ability === "darkmagic") {
            attackDamage = 15;
            log(`‚ò†Ô∏è ${enemy.name} CHANNELS DARK MAGIC...`);
        }
        
        damageTaken = Math.max(0, attackDamage - block);
        block = Math.max(0, block - attackDamage);
        player.hp -= damageTaken;
        
        if (enemy.ability === "smite" && attackDamage > enemy.attack) {
            log(`‚òÑÔ∏è ${enemy.name} USES SMITE! DEALS ${attackDamage} DAMAGE (${block > 0 ? `${block} BLOCKED` : ''})`);
        } else if (enemy.ability === "fireball" && attackDamage === 10) {
            log(`üî• ${enemy.name} CASTS FIREBALL! DEALS ${attackDamage} DAMAGE (${block > 0 ? `${block} BLOCKED` : ''})`);
        } else if (enemy.ability === "firebreath") {
            log(`üî• ${enemy.name} BREATHES FIRE! DEALS ${attackDamage} DAMAGE (${block > 0 ? `${block} BLOCKED` : ''})`);
        } else if (enemy.ability === "darkmagic") {
            log(`‚ò†Ô∏è ${enemy.name} CASTS DARK MAGIC! DEALS ${attackDamage} DAMAGE (${block > 0 ? `${block} BLOCKED` : ''})`);
        } else if (enemy.ability === "silver" && attackDamage > enemy.attack) {
            log(`‚öîÔ∏è ${enemy.name} USES SILVER WEAPONS! DEALS ${attackDamage} DAMAGE (${block > 0 ? `${block} BLOCKED` : ''})`);
        } else {
            log(`${enemy.name} ATTACKS FOR ${attackDamage} DAMAGE (${block > 0 ? `${block} BLOCKED` : ''})`);
        }
        
        if (damageTaken > 0) {
            createDamagePopup("YOU", damageTaken);
            damageTaken += damageTaken;
        }
        
        // Check for counter effects
        if (damageTaken > 0 && currentBattleEffects.some(e => e.type === "counter")) {
            const counterEffect = currentBattleEffects.find(e => e.type === "counter");
            enemy.hp -= counterEffect.value;
            createDamagePopup(enemy.avatar, counterEffect.value);
            log(`‚öîÔ∏è COUNTER ATTACK HITS FOR ${counterEffect.value} DAMAGE!`);
            currentBattleEffects = currentBattleEffects.filter(e => e.type !== "counter");
            updateEnemyStats();
            damageDealt += counterEffect.value;
            
            if (enemy.hp <= 0) {
                enemy.hp = 0;
                updateEnemyStats();
                victory();
                return;
            }
        }
        
        block = 0;
        
        updatePlayerStats();
        if (player.hp <= 0) {
            player.hp = 0;
            updatePlayerStats();
            endGame(false);
        }
    }

    function endTurn() {
        log("--- END OF TURN ---");
        
        if (buffedAttack > 0) {
            log(`YOUR ATTACK BONUS FADES`);
            buffedAttack = 0;
        }
        
        if (energy > 0) {
            energyCarryover = Math.min(energy, 10);
            log(`YOU HAVE ${energyCarryover} UNUSED ENERGY THAT WILL CARRY OVER TO NEXT TURN`);
        } else {
            energyCarryover = 0;
        }
        
        comboCount = 0;
        comboType = "";
        updateComboMeter();
        
        if (enemy.hp > 0) {
            enemyTurn();
        }
        
        energy = player.maxEnergy + energyCarryover;
        if (energy > 10) {
            energy = 10;
        }
        updateEnergyDisplay();
        discard.push(...hand);
        hand = [];
        drawCards(5);
        
        log("--- NEW TURN ---");
        
        // Apply talent effects at start of turn
        if (player.class === "Vampire" && player.talents.includes("v8")) {
            player.hp = Math.min(player.hp + 5, player.maxHP);
            createHealPopup("YOU", 5);
            log("ANCIENT BLOODLINE: Healed 5 HP at start of turn");
        }
        if (player.class === "Werewolf" && player.talents.includes("w7")) {
            player.hp = Math.min(player.hp + 3, player.maxHP);
            createHealPopup("YOU", 3);
            log("REGENERATION: Healed 3 HP at start of turn");
        }
        
        updatePlayerStats();
    }

    function fleeBattle() {
        if (confirm("Are you sure you want to flee? You'll lose some gold and return to town.")) {
            gold = Math.max(0, gold - 10);
            showScreen('game-screen');
            log("You fled the battle and lost 10 gold!");
            updatePlayerStats();
        }
    }

    function toggleInventory() {
    const inventory = player.inventory;
    if (inventory.length === 0) {
        log("YOUR INVENTORY IS EMPTY");
        return;
    }
    
    let message = "INVENTORY:\n";
    inventory.forEach((item, index) => {
        message += `${index+1}. ${item}\n`;
    });
    message += "Tap an item number to use it (or cancel)";
    
    const itemNumber = prompt(message);
    if (itemNumber && !isNaN(itemNumber)) {  // Fixed - added closing parenthesis
        const index = parseInt(itemNumber) - 1;
        if (index >= 0 && index < inventory.length) {
            useItem(index);
        }
    }
    }

    function useItem(index) {
        if (index >= player.inventory.length) return;
        
        let item = player.inventory[index];
        
        if (item === "Health Potion") {
            const healAmount = 20;
            player.hp = Math.min(player.hp + healAmount, player.maxHP);
            createHealPopup("YOU", healAmount);
            log("USED HEALTH POTION! +20 HP");
        } 
        else if (item === "Energy Potion") {
            energy = player.maxEnergy;
            updateEnergyDisplay();
            log("USED ENERGY POTION! ENERGY RESTORED");
        }
        
        player.inventory.splice(index, 1);
        updatePlayerStats();
    }

    function victory() {
        checkAchievement("first_blood", enemiesDefeated === 0);
        enemiesDefeated++;
        
        const xpGain = 10 + currentEnemyIndex * 5;
        player.xp += xpGain;
        gold += enemy.reward;
        
        const xpNeeded = player.level * 20;
        if (player.xp >= xpNeeded) {
            player.level++;
            player.xp = 0;
            player.maxHP += 5;
            player.hp = player.maxHP;
            player.talentPoints++;
            log(`LEVEL UP! YOU ARE NOW LEVEL ${player.level}! +5 MAX HP AND 1 TALENT POINT`);
        }
        
        // Check for perfect victory achievement
        if (damageTaken === 0) {
            checkAchievement("perfect_victory", true);
        }
        
        log(`VICTORY! YOU DEFEATED ${enemy.name} AND EARNED ${enemy.reward} GOLD AND ${xpGain} XP!`);
        
        setTimeout(() => {
            currentEnemyIndex++;
            
            if (player.gameMode === "endless" || currentEnemyIndex <= enemies.length) {
                rewardScreen();
            } else {
                endGame(true);
            }
        }, 1500);
    }

    function rewardScreen() {
        showScreen('reward-screen');
        document.getElementById("gold-reward-amount").textContent = Math.floor(enemy.reward * 1.5);
        
        document.getElementById("reward-cards").innerHTML = "";
        updatePlayerStats();
        updateNextEnemy();
    }

    function getRandomCardReward() {
        let rewardDiv = document.getElementById("reward-cards");
        rewardDiv.innerHTML = "";
        
        let classCards = player.class === "Vampire" ? vampireCards : werewolfCards;
        let allCards = [...classCards, ...neutralCards];
        
        let rewards = [];
        for (let i = 0; i < 3; i++) {
            let rarityRoll = Math.random();
            let rarity;
            
            if (rarityRoll < 0.5) rarity = "common";
            else if (rarityRoll < 0.8) rarity = "rare";
            else if (rarityRoll < 0.95) rarity = "epic";
            else if (rarityRoll < 0.99) rarity = "legendary";
            else rarity = "ancient";
            
            let eligibleCards = allCards.filter(card => card.rarity === rarity);
            if (eligibleCards.length === 0) {
                eligibleCards = allCards;
            }
            
            let card = {...eligibleCards[Math.floor(Math.random() * eligibleCards.length)]};
            rewards.push(card);
        }
        
        rewards.forEach(card => {
            const cardElement = document.createElement("div");
            cardElement.className = `card ${card.rarity}`;
            cardElement.onclick = () => chooseReward(card);
            
            const cardName = document.createElement("h3");
            cardName.textContent = card.name;
            
            const cardEffect = document.createElement("p");
            cardEffect.textContent = card.description;
            
            cardElement.appendChild(cardName);
            cardElement.appendChild(cardEffect);
            
            rewardDiv.appendChild(cardElement);
        });
    }

    function getGoldReward() {
        const goldAmount = Math.floor(enemy.reward * 1.5);
        gold += goldAmount;
        log(`YOU RECEIVED ${goldAmount} GOLD!`);
        showScreen('game-screen');
        updatePlayerStats();
    }

    function getPotionReward() {
        player.inventory.push("Health Potion", "Energy Potion");
        log(`YOU RECEIVED HEALTH POTION AND ENERGY POTION!`);
        showScreen('game-screen');
        updatePlayerStats();
    }

    function getTalentPoint() {
        player.talentPoints++;
        log(`YOU RECEIVED 1 TALENT POINT!`);
        showScreen('game-screen');
        updatePlayerStats();
    }

    function chooseReward(card) {
        deck.push({...card});
        log(`ADDED ${card.name} TO YOUR DECK!`);
        
        // Check for legendary collector achievement
        if (card.rarity === "legendary") {
            const legendaryCount = [...deck, ...hand, ...discard].filter(c => c.rarity === "legendary").length;
            checkAchievement("legendary_collector", legendaryCount >= 3);
        }
        
        // Check for deck builder achievement
        checkAchievement("deck_builder", deck.length + hand.length + discard.length >= 20);
        
        showScreen('game-screen');
        updatePlayerStats();
        updateDeckInfo();
    }

    function skipReward() {
        showScreen('game-screen');
    }

    function enterShop() {
        showScreen('shop-screen');
        document.getElementById("gold-amount").innerText = gold;
        document.getElementById("reroll-cost").innerText = shopRerollCost;
        renderShop();
    }

    function renderShop() {
        let shopDiv = document.getElementById("shop-cards");
        shopDiv.innerHTML = "";
        
        let classCards = player.class === "Vampire" ? vampireCards : werewolfCards;
        let allCards = [...classCards, ...neutralCards];
        
        let shopOffers = [];
        for (let i = 0; i < 6; i++) {
            let rarityRoll = Math.random();
            let rarity;
            
            if (rarityRoll < 0.6) rarity = "common";
            else if (rarityRoll < 0.85) rarity = "rare";
            else if (rarityRoll < 0.97) rarity = "epic";
            else if (rarityRoll < 0.99) rarity = "legendary";
            else rarity = "ancient";
            
            let eligibleCards = allCards.filter(card => card.rarity === rarity);
            if (eligibleCards.length === 0) {
                eligibleCards = allCards;
            }
            
            let card = {...eligibleCards[Math.floor(Math.random() * eligibleCards.length)]};
            shopOffers.push(card);
        }
        
        shopOffers.forEach(card => {
            const cardElement = document.createElement("div");
            cardElement.className = `card ${card.rarity}`;
            cardElement.onclick = () => buyCard(card);
            
            const cardName = document.createElement("h3");
            cardName.textContent = card.name;
            
            const cardEffect = document.createElement("p");
            cardEffect.textContent = card.description;
            
            const cardPrice = document.createElement("p");
            cardPrice.className = "card-cost";
            cardPrice.textContent = `${getCardCost(card)} GOLD`;
            
            cardElement.appendChild(cardName);
            cardElement.appendChild(cardEffect);
            cardElement.appendChild(cardPrice);
            
            shopDiv.appendChild(cardElement);
        });
    }

    function getCardCost(card) {
        switch(card.rarity) {
            case "common": return 20;
            case "rare": return 35;
            case "epic": return 60;
            case "legendary": return 100;
            case "ancient": return 150;
            default: return 25;
        }
    }

    function buyCard(card) {
        const cost = getCardCost(card);
        if (gold < cost) {
            log("NOT ENOUGH GOLD! NEED " + cost + " GOLD.");
            return;
        }
        
        deck.push({...card});
        gold -= cost;
        document.getElementById("gold-amount").innerText = gold;
        updatePlayerStats();
        log(`PURCHASED ${card.name} FOR ${cost} GOLD!`);
        
        // Check for legendary collector achievement
        if (card.rarity === "legendary") {
            const legendaryCount = [...deck, ...hand, ...discard].filter(c => c.rarity === "legendary").length;
            checkAchievement("legendary_collector", legendaryCount >= 3);
        }
        
        // Check for deck builder achievement
        checkAchievement("deck_builder", deck.length + hand.length + discard.length >= 20);
        
        renderShop();
    }

    function buyRandomCard() {
        let classCards = player.class === "Vampire" ? vampireCards : werewolfCards;
        let allCards = [...classCards, ...neutralCards];
        
        let rarityRoll = Math.random();
        let rarity;
        
        if (rarityRoll < 0.6) rarity = "common";
        else if (rarityRoll < 0.85) rarity = "rare";
        else if (rarityRoll < 0.97) rarity = "epic";
        else if (rarityRoll < 0.99) rarity = "legendary";
        else rarity = "ancient";
        
        let eligibleCards = allCards.filter(card => card.rarity === rarity);
        if (eligibleCards.length === 0) {
            eligibleCards = allCards;
        }
        
        let card = {...eligibleCards[Math.floor(Math.random() * eligibleCards.length)]};
        const cost = getCardCost(card);
        
        if (gold < cost) {
            log("NOT ENOUGH GOLD! NEED " + cost + " GOLD.");
            return;
        }
        
        deck.push(card);
        gold -= cost;
        document.getElementById("gold-amount").innerText = gold;
        updatePlayerStats();
        log(`PURCHASED RANDOM ${card.rarity.toUpperCase()} CARD (${card.name}) FOR ${cost} GOLD!`);
        
        // Check for legendary collector achievement
        if (card.rarity === "legendary") {
            const legendaryCount = [...deck, ...hand, ...discard].filter(c => c.rarity === "legendary").length;
            checkAchievement("legendary_collector", legendaryCount >= 3);
        }
        
        // Check for deck builder achievement
        checkAchievement("deck_builder", deck.length + hand.length + discard.length >= 20);
        
        renderShop();
    }

    function buyPotion() {
        if (gold < 15) {
            log("NOT ENOUGH GOLD! NEED 15 GOLD.");
            return;
        }
        
        player.inventory.push("Health Potion");
        gold -= 15;
        document.getElementById("gold-amount").innerText = gold;
        updatePlayerStats();
        log(`PURCHASED HEALTH POTION FOR 15 GOLD!`);
        renderShop();
    }

    function buyEnergyPotion() {
        if (gold < 20) {
            log("NOT ENOUGH GOLD! NEED 20 GOLD.");
            return;
        }
        
        player.inventory.push("Energy Potion");
        gold -= 20;
        document.getElementById("gold-amount").innerText = gold;
        updatePlayerStats();
        log(`PURCHASED ENERGY POTION FOR 20 GOLD!`);
        renderShop();
    }

    function upgradeMaxHP() {
        if (gold < 25) {
            log("NOT ENOUGH GOLD! NEED 25 GOLD.");
            return;
        }
        
        player.maxHP += 10;
        player.hp += 10;
        gold -= 25;
        document.getElementById("gold-amount").innerText = gold;
        updatePlayerStats();
        log(`UPGRADED MAX HP BY 10 FOR 25 GOLD!`);
        renderShop();
    }

    function upgradeEnergy() {
        if (gold < 30) {
            log("NOT ENOUGH GOLD! NEED 30 GOLD.");
            return;
        }
        
        player.maxEnergy += 1;
        gold -= 30;
        document.getElementById("gold-amount").innerText = gold;
        updatePlayerStats();
        log(`UPGRADED MAX ENERGY TO ${player.maxEnergy} FOR 30 GOLD!`);
        renderShop();
    }

    function removeCard() {
        if (gold < 25) {
            log("NOT ENOUGH GOLD! NEED 25 GOLD.");
            return;
        }
        
        if (deck.length + hand.length <= 5) {
            log("YOUR DECK IS TOO SMALL TO REMOVE CARDS!");
            return;
        }
        
        showDeckForRemoval();
    }

    function showDeckForRemoval() {
        document.getElementById("deck-modal").classList.add("active");
        
        const modalDeck = document.getElementById("modal-deck");
        modalDeck.innerHTML = "";
        
        const allCards = [...deck, ...hand];
        
        if (allCards.length === 0) {
            modalDeck.innerHTML = "<p>NO CARDS TO REMOVE</p>";
            return;
        }
        
        allCards.forEach((card, index) => {
            const cardElement = document.createElement("div");
            cardElement.className = `card ${card.rarity}`;
            cardElement.onclick = () => removeCardFromDeck(index, card);
            
            const cardName = document.createElement("h3");
            cardName.textContent = card.name;
            
            const cardEffect = document.createElement("p");
            cardEffect.textContent = card.description;
            
            cardElement.appendChild(cardName);
            cardElement.appendChild(cardEffect);
            
            modalDeck.appendChild(cardElement);
        });
    }

    function removeCardFromDeck(index, card) {
        if (index < deck.length) {
            deck.splice(index, 1);
        } else {
            hand.splice(index - deck.length, 1);
        }
        
        gold -= 25;
        document.getElementById("gold-amount").innerText = gold;
        updatePlayerStats();
        updateDeckInfo();
        log(`REMOVED ${card.name} FROM YOUR DECK FOR 25 GOLD`);
        closeModal("deck-modal");
    }

    function rerollShop() {
        if (gold < shopRerollCost) {
            log(`NOT ENOUGH GOLD! NEED ${shopRerollCost} GOLD.`);
            return;
        }
        
        gold -= shopRerollCost;
        shopRerollCost += 5;
        document.getElementById("gold-amount").innerText = gold;
        document.getElementById("reroll-cost").innerText = shopRerollCost;
        renderShop();
        log(`REROLLED SHOP FOR ${shopRerollCost-5} GOLD (NEXT REROLL: ${shopRerollCost} GOLD)`);
        updatePlayerStats();
    }

    function exitShop() {
        shopRerollCost = 10;
        showScreen('game-screen');
    }

    function viewDeck() {
        document.getElementById("deck-modal").classList.add("active");
        
        const modalDeck = document.getElementById("modal-deck");
        modalDeck.innerHTML = "";
        
        const allCards = [...deck, ...hand];
        
        if (allCards.length === 0) {
            modalDeck.innerHTML = "<p>YOUR DECK IS EMPTY</p>";
            return;
        }
        
        // Default sort by name
        sortDeck('name');
    }

    function sortDeck(sortBy) {
        const modalDeck = document.getElementById("modal-deck");
        modalDeck.innerHTML = "";
        
        const allCards = [...deck, ...hand];
        let sortedCards = [];
        
        switch(sortBy) {
            case 'name':
                sortedCards = [...allCards].sort((a, b) => a.name.localeCompare(b.name));
                break;
            case 'cost':
                sortedCards = [...allCards].sort((a, b) => a.cost - b.cost);
                break;
            case 'rarity':
                const rarityOrder = {common: 0, rare: 1, epic: 2, legendary: 3, ancient: 4};
                sortedCards = [...allCards].sort((a, b) => rarityOrder[b.rarity] - rarityOrder[a.rarity]);
                break;
            case 'type':
                sortedCards = [...allCards].sort((a, b) => {
                    if (a.type === b.type) return a.name.localeCompare(b.name);
                    return a.type.localeCompare(b.type);
                });
                break;
            default:
                sortedCards = allCards;
        }
        
        if (sortBy === 'type') {
            // Group by type when sorting by type
            const cardGroups = {};
            sortedCards.forEach(card => {
                if (!cardGroups[card.type]) cardGroups[card.type] = [];
                cardGroups[card.type].push(card);
            });
            
            for (const [type, cards] of Object.entries(cardGroups)) {
                const groupHeader = document.createElement("h3");
                groupHeader.textContent = `${type.toUpperCase()} CARDS`;
                groupHeader.style.marginTop = "20px";
                modalDeck.appendChild(groupHeader);
                
                cards.forEach(card => {
                    const cardElement = createCardElement(card);
                    modalDeck.appendChild(cardElement);
                });
            }
        } else {
            sortedCards.forEach(card => {
                const cardElement = createCardElement(card);
                modalDeck.appendChild(cardElement);
            });
        }
    }

    function createCardElement(card) {
        const cardElement = document.createElement("div");
        cardElement.className = `card ${card.rarity}`;
        
        const cardName = document.createElement("h3");
        cardName.textContent = card.name;
        
        const cardEffect = document.createElement("p");
        cardEffect.textContent = card.description;
        
        const cardInfo = document.createElement("p");
        cardInfo.innerHTML = `COST: ${card.cost} | TYPE: ${card.type}`;
        cardInfo.style.fontSize = "0.8em";
        cardInfo.style.color = "#aaa";
        
        cardElement.appendChild(cardName);
        cardElement.appendChild(cardEffect);
        cardElement.appendChild(cardInfo);
        
        return cardElement;
    }

    function viewDiscard() {
        document.getElementById("discard-modal").classList.add("active");
        
        const modalDiscard = document.getElementById("modal-discard");
        modalDiscard.innerHTML = "";
        
        if (discard.length === 0) {
            modalDiscard.innerHTML = "<p>YOUR DISCARD PILE IS EMPTY</p>";
            return;
        }
        
        discard.forEach(card => {
            const cardElement = document.createElement("div");
            cardElement.className = `card ${card.rarity}`;
            
            const cardName = document.createElement("h3");
            cardName.textContent = card.name;
            
            const cardEffect = document.createElement("p");
            cardEffect.textContent = card.description;
            
            cardElement.appendChild(cardName);
            cardElement.appendChild(cardEffect);
            
            modalDiscard.appendChild(cardElement);
        });
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
    }

    function log(message) {
        let logDiv = document.getElementById("battle-log");
        logDiv.innerHTML += `<p>${message}</p>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function renderTalents() {
        const talentsDiv = document.getElementById("talents-tree");
        talentsDiv.innerHTML = "";
        
        const talentList = player.class === "Vampire" ? talents.vampire : talents.werewolf;
        const talentSize = 50;
        const padding = 60;
        const tooltip = document.getElementById('talent-tooltip');
        
        // Find max x and y to determine canvas size
        let maxX = 0, maxY = 0;
        talentList.forEach(talent => {
            maxX = Math.max(maxX, talent.x);
            maxY = Math.max(maxY, talent.y);
        });
        
        talentsDiv.style.height = `${(maxY + 1) * padding}px`;
        talentsDiv.style.width = `${(maxX + 1) * padding}px`;
        
        // Draw connectors first so they're behind the nodes
        talentList.forEach(talent => {
            if (talent.requires && talent.requires.length > 0) {
                talent.requires.forEach(reqId => {
                    const reqTalent = talentList.find(t => t.id === reqId);
                    if (reqTalent) {
                        const connector = document.createElement("div");
                        connector.className = "talent-connector";
                        
                        const startX = reqTalent.x * padding + talentSize/2;
                        const startY = reqTalent.y * padding + talentSize/2;
                        const endX = talent.x * padding + talentSize/2;
                        const endY = talent.y * padding + talentSize/2;
                        
                        const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                        const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                        
                        connector.style.width = `${length}px`;
                        connector.style.left = `${startX}px`;
                        connector.style.top = `${startY}px`;
                        connector.style.transform = `rotate(${angle}deg)`;
                        connector.style.transformOrigin = "0 0";
                        
                        talentsDiv.appendChild(connector);
                    }
                });
            }
        });
        
        // Draw talent nodes
        talentList.forEach(talent => {
            const talentNode = document.createElement("div");
            talentNode.className = "talent-node";
            
            if (player.talents.includes(talent.id)) {
                talentNode.classList.add("unlocked");
            } else {
                const canUnlock = talent.requires.every(req => player.talents.includes(req)) && 
                                 player.talentPoints >= talent.cost;
                talentNode.classList.add(canUnlock ? "available" : "locked");
                
                if (canUnlock) {
                    talentNode.onclick = () => unlockTalent(talent);
                }
            }
            
            talentNode.style.left = `${talent.x * padding}px`;
            talentNode.style.top = `${talent.y * padding}px`;
            talentNode.textContent = talent.name.split(" ").map(w => w[0]).join("");
            
            // Tooltip events
            talentNode.addEventListener('mouseenter', () => {
                tooltip.innerHTML = `<strong>${talent.name}</strong><br>${talent.description}`;
                if (player.talents.includes(talent.id)) {
                    tooltip.innerHTML += "<br><em>Unlocked</em>";
                } else if (talentNode.classList.contains("available")) {
                    tooltip.innerHTML += `<br><em>Cost: ${talent.cost} points</em>`;
                } else {
                    const reqNames = talent.requires.map(req => talentList.find(t => t.id === req).name);
                    tooltip.innerHTML += `<br><em>Requires: ${reqNames.join(", ")}</em>`;
                }
                tooltip.style.opacity = '1';
            });
            
            talentNode.addEventListener('mouseleave', () => {
                tooltip.style.opacity = '0';
            });
            
            talentsDiv.appendChild(talentNode);
        });
        
        document.getElementById("talent-points").textContent = player.talentPoints;
    }

    function unlockTalent(talent) {
        if (player.talentPoints >= talent.cost && 
            talent.requires.every(req => player.talents.includes(req))) {
            player.talentPoints -= talent.cost;
            player.talents.push(talent.id);
            log(`UNLOCKED TALENT: ${talent.name}! ${talent.description}`);
            renderTalents();
            updatePlayerStats();
            
            // Check for talent legend achievement
            const talentList = player.class === "Vampire" ? talents.vampire : talents.werewolf;
            checkAchievement("talent_legend", player.talents.length === talentList.length);
        }
    }

    function viewTalents() {
        showScreen('talents-screen');
        renderTalents();
    }

    function closeTalents() {
        showScreen('game-screen');
    }

    function renderAchievements() {
        const achievementsDiv = document.getElementById("achievements-list");
        achievementsDiv.innerHTML = "";
        
        achievements.forEach(achievement => {
            const achievementElement = document.createElement("div");
            achievementElement.className = `achievement ${achievement.unlocked ? "unlocked" : ""}`;
            
            const icon = document.createElement("div");
            icon.className = "achievement-icon";
            icon.textContent = achievement.icon;
            
            const name = document.createElement("h3");
            name.textContent = achievement.name;
            
            const desc = document.createElement("p");
            desc.textContent = achievement.description;
            
            achievementElement.appendChild(icon);
            achievementElement.appendChild(name);
            achievementElement.appendChild(desc);
            
            achievementsDiv.appendChild(achievementElement);
        });
    }

    function checkAchievement(id, condition) {
        const achievement = achievements.find(a => a.id === id);
        if (achievement && !achievement.unlocked && condition) {
            achievement.unlocked = true;
            log(`ACHIEVEMENT UNLOCKED: ${achievement.name}!`);
            saveGame();
            
            if (id === "vampire_master" || id === "werewolf_master" || id === "endless_champion") {
                // These are major achievements that should be shown prominently
                const messageDiv = document.getElementById("victory-message");
                messageDiv.innerHTML = `ACHIEVEMENT UNLOCKED: ${achievement.name}!`;
                messageDiv.style.display = 'block';
            }
        }
    }

    function viewAchievements() {
        showScreen('achievements-screen');
        renderAchievements();
    }

    function closeAchievements() {
        showScreen('game-screen');
    }

    function endGame(victory) {
        const messageDiv = document.getElementById(victory ? "victory-message" : "game-over-message");
        messageDiv.style.display = 'block';
        
        if (victory) {
            if (player.gameMode === "endless") {
                messageDiv.innerHTML = `CONGRATULATIONS! You reached wave ${Math.floor(currentEnemyIndex / endlessEnemies.length) + 1} in endless mode!`;
                checkAchievement("endless_champion", Math.floor(currentEnemyIndex / endlessEnemies.length) + 1 >= 10);
            } else {
                messageDiv.innerHTML = `CONGRATULATIONS! YOU DEFEATED ALL ENEMIES AND WON THE GAME WITH ${gold} GOLD AT LEVEL ${player.level}!`;
                if (player.class === "Vampire") {
                    checkAchievement("vampire_master", true);
                } else {
                    checkAchievement("werewolf_master", true);
                }
            }
            messageDiv.style.color = "#0f0";
        } else {
            messageDiv.innerHTML = "GAME OVER - YOU WERE DEFEATED IN BATTLE";
            messageDiv.style.color = "#f55";
        }
        
        // Record run history
        player.runHistory.push({
            class: player.class,
            level: player.level,
            gold: gold,
            enemiesDefeated: enemiesDefeated,
            damageDealt: damageDealt,
            damageTaken: damageTaken,
            cardsPlayed: cardsPlayed,
            turnsTaken: turnsTaken,
            victory: victory,
            timestamp: new Date().toISOString()
        });
        
        // Add restart button
        const restartButton = document.createElement("button");
        restartButton.className = "button primary";
        restartButton.textContent = "RESTART GAME";
        restartButton.style.margin = "10px auto";
        restartButton.style.display = "block";
        restartButton.onclick = () => location.reload();
        messageDiv.appendChild(document.createElement("br"));
        messageDiv.appendChild(restartButton);
    }
    </script>
</body>
</html>
