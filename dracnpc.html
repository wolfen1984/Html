<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dracula's Redemption - Enhanced Text Adventure</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .game-container {
            border: 4px double #fff;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #111;
            min-height: 80vh;
        }
        
        .screen {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        h1, h2, h3 {
            color: #ff3333;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 5px #ff0000;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 30px;
        }
        
        h2 {
            font-size: 1.8rem;
            margin-top: 20px;
        }
        
        h3 {
            font-size: 1.2rem;
            text-align: left;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-top: 15px;
        }
        
        .game-text {
            background-color: #000;
            border: 2px solid #333;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.8;
        }
        
        .game-text p {
            margin-bottom: 15px;
        }
        
        .npc-dialogue {
            color: #ffff66;
            font-style: italic;
            margin: 10px 0;
            padding-left: 10px;
            border-left: 2px solid #ffff66;
        }
        
        .player-dialogue {
            color: #66ff66;
            margin: 10px 0;
            padding-left: 10px;
            border-left: 2px solid #66ff66;
        }
        
        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        button {
            background-color: #222;
            color: #fff;
            border: 2px solid #666;
            font-family: 'Press Start 2P', cursive;
            padding: 12px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            flex-grow: 1;
            min-width: 200px;
        }
        
        button:hover:not(:disabled) {
            background-color: #333;
            border-color: #ff3333;
            color: #ff3333;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            background-color: #222;
            padding: 10px;
            border: 1px solid #444;
        }
        
        .stat-value {
            color: #ffff66;
            font-weight: bold;
        }
        
        .inventory {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .item {
            background-color: #1a1a1a;
            padding: 8px;
            border: 1px solid #333;
            font-size: 0.8rem;
        }
        
        .item-rare {
            border-color: #ff9900;
            color: #ff9900;
        }
        
        .item-legendary {
            border-color: #ff3366;
            color: #ff3366;
        }
        
        .outcome-good {
            color: #66ff66;
        }
        
        .outcome-bad {
            color: #ff6666;
        }
        
        .warning {
            color: #ff9900;
        }
        
        .game-over {
            color: #ff0000;
            font-size: 1.5rem;
            text-align: center;
            margin: 30px 0;
        }
        
        .victory {
            color: #66ff66;
            font-size: 1.5rem;
            text-align: center;
            margin: 30px 0;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 0.7rem;
            border-top: 1px solid #333;
            padding-top: 15px;
        }
        
        /* New styles for enhanced features */
        .powers-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .power-branch {
            background-color: #1a1a1a;
            padding: 10px;
            border: 1px solid #333;
        }
        
        .power {
            padding: 5px;
            margin: 5px 0;
            border: 1px dashed #444;
            cursor: pointer;
        }
        
        .power.unlocked {
            border: 1px solid #66ff66;
            background-color: #223322;
        }
        
        .power.locked {
            color: #666;
            cursor: not-allowed;
        }
        
        .combat-screen {
            background-color: #220000;
            border: 2px solid #ff0000;
        }
        
        .combatant {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 10px 0;
            background-color: #330000;
            border: 1px solid #660000;
        }
        
        .combatant-player {
            border-color: #006600;
            background-color: #003300;
        }
        
        .health-bar {
            width: 100%;
            height: 20px;
            background-color: #330000;
            border: 1px solid #666;
            margin: 5px 0;
        }
        
        .health-fill {
            height: 100%;
            background-color: #ff0000;
            transition: width 0.3s;
        }
        
        .quest-log {
            background-color: #1a1a1a;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #333;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .quest-item {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px dotted #333;
        }
        
        .quest-completed {
            color: #66ff66;
            text-decoration: line-through;
        }
        
        .side-quest-option {
            border-color: #ff9900;
            color: #ff9900;
        }
        
        .romance-option {
            border-color: #ff66cc;
            color: #ff66cc;
        }
        
        .combat-option {
            border-color: #ff3333;
            color: #ff3333;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .game-text {
                font-size: 0.8rem;
            }
            
            button {
                font-size: 0.7rem;
                min-width: 150px;
            }
            
            .powers-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Start Screen -->
        <div id="start-screen" class="screen active">
            <h1>DRACULA'S REDEMPTION - ENHANCED</h1>
            <div class="game-text">
                <p>Transylvania, 1897. You are Count Dracula, an ancient vampire seeking purpose.</p>
                <p>But tonight is different. The blood moon rises, and ancient powers stir within you.</p>
                <p>New faces arrive in the village, each with their own agenda. Some offer power, others redemption.</p>
                <p>The choice is yours: master your vampiric abilities, seek a cure, or embrace ultimate darkness.</p>
                <p class="warning">Beware: Every choice shapes your destiny. Combat awaits the unwary.</p>
                <p class="warning">Unlock powers, complete quests, and choose your ending path.</p>
            </div>
            <div class="button-container">
                <button id="start-btn">BEGIN YOUR QUEST</button>
            </div>
        </div>
        
        <!-- Character Creation Screen -->
        <div id="character-screen" class="screen">
            <h2>CREATE YOUR DRACULA</h2>
            <div class="game-text">
                <p>Even immortals have strengths and weaknesses. Distribute 12 points among your attributes:</p>
                
                <div class="stats-container">
                    <div class="stat-item">
                        <h3>CHARISMA <span id="charisma-value" class="stat-value">4</span></h3>
                        <p>Persuasion and deception</p>
                        <button onclick="changeStat('charisma', 1)">+</button>
                        <button onclick="changeStat('charisma', -1)">-</button>
                    </div>
                    <div class="stat-item">
                        <h3>PERCEPTION <span id="perception-value" class="stat-value">4</span></h3>
                        <p>Detect truth and deception</p>
                        <button onclick="changeStat('perception', 1)">+</button>
                        <button onclick="changeStat('perception', -1)">-</button>
                    </div>
                    <div class="stat-item">
                        <h3>WILLPOWER <span id="willpower-value" class="stat-value">4</span></h3>
                        <p>Resist temptation and harm</p>
                        <button onclick="changeStat('willpower', 1)">+</button>
                        <button onclick="changeStat('willpower', -1)">-</button>
                    </div>
                </div>
                
                <p id="points-remaining">Points remaining: <span id="points">0</span></p>
                
                <h3>CHOOSE YOUR STARTING PATH</h3>
                <p>Select one starting focus for your abilities:</p>
            </div>
            
            <div class="button-container">
                <button id="mind-controller-btn" onclick="selectBackground('mind_controller', this)">MIND CONTROLLER (Unlocks Hypnotic Gaze)</button>
                <button id="night-stalker-btn" onclick="selectBackground('night_stalker', this)">NIGHT STALKER (Unlocks Shadow Step)</button>
                <button id="blood-mage-btn" onclick="selectBackground('blood_mage', this)">BLOOD MAGE (Unlocks Blood Boil)</button>
            </div>
            
            <div class="button-container">
                <button id="begin-btn" disabled>BEGIN ADVENTURE</button>
            </div>
        </div>
        
        <!-- Main Game Screen -->
        <div id="game-screen" class="screen">
            <h2>VILLAGE OF SHADOWS</h2>
            
            <div class="stats-container">
                <div class="stat-item">
                    <h3>CHARISMA <span id="game-charisma" class="stat-value">4</span></h3>
                </div>
                <div class="stat-item">
                    <h3>PERCEPTION <span id="game-perception" class="stat-value">4</span></h3>
                </div>
                <div class="stat-item">
                    <h3>WILLPOWER <span id="game-willpower" class="stat-value">4</span></h3>
                </div>
                <div class="stat-item">
                    <h3>HEALTH <span id="health" class="stat-value">10</span>/<span id="max-health">10</span></h3>
                    <div class="health-bar">
                        <div id="health-fill" class="health-fill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="stat-item">
                    <h3>BLOOD POINTS <span id="blood-points" class="stat-value">0</span></h3>
                    <p>Unlock new powers</p>
                </div>
            </div>
            
            <div class="button-container">
                <button onclick="showPowersScreen()">VAMPIRE POWERS</button>
                <button onclick="showQuestsScreen()">QUESTS (<span id="quest-count">0</span>)</button>
                <button onclick="showInventoryScreen()">INVENTORY</button>
            </div>
            
            <h3>LOCATION: <span id="location-name">VILLAGE SQUARE</span></h3>
            <div class="game-text" id="game-text">
                <!-- Game text will be added here dynamically -->
            </div>
            
            <div class="button-container" id="action-buttons">
                <!-- Action buttons will be added here dynamically -->
            </div>
        </div>
        
        <!-- Powers Screen -->
        <div id="powers-screen" class="screen">
            <h2>VAMPIRE POWERS TREE</h2>
            <div class="game-text">
                <p>Spend Blood Points to unlock new vampiric abilities. You have <span id="available-blood-points" class="stat-value">0</span> BP available.</p>
                <p>Each power unlocks new dialogue options and combat abilities.</p>
                
                <div class="powers-container">
                    <div class="power-branch">
                        <h3>MIND CONTROL</h3>
                        <div id="mind-powers">
                            <!-- Mind powers will be added here dynamically -->
                        </div>
                    </div>
                    <div class="power-branch">
                        <h3>PHYSICAL DOMINANCE</h3>
                        <div id="body-powers">
                            <!-- Body powers will be added here dynamically -->
                        </div>
                    </div>
                    <div class="power-branch">
                        <h3>DARK ARTS</h3>
                        <div id="darkness-powers">
                            <!-- Darkness powers will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="button-container">
                <button onclick="showGameScreen()">RETURN TO GAME</button>
            </div>
        </div>
        
        <!-- Quests Screen -->
        <div id="quests-screen" class="screen">
            <h2>QUEST LOG</h2>
            <div class="game-text">
                <h3>ACTIVE QUESTS</h3>
                <div class="quest-log" id="active-quests">
                    <!-- Active quests will be added here dynamically -->
                </div>
                
                <h3>COMPLETED QUESTS</h3>
                <div class="quest-log" id="completed-quests">
                    <!-- Completed quests will be added here dynamically -->
                </div>
                
                <h3>ROMANCE OPTIONS</h3>
                <div id="romance-status">
                    <!-- Romance status will be added here dynamically -->
                </div>
            </div>
            <div class="button-container">
                <button onclick="showGameScreen()">RETURN TO GAME</button>
            </div>
        </div>
        
        <!-- Inventory Screen -->
        <div id="inventory-screen" class="screen">
            <h2>INVENTORY</h2>
            <div class="game-text">
                <h3>ITEMS</h3>
                <div class="inventory" id="inventory-display">
                    <!-- Items will be added here dynamically -->
                </div>
                
                <h3>RELICS COLLECTED</h3>
                <div id="relics-display">
                    <!-- Relics will be added here dynamically -->
                </div>
                
                <h3>COMBAT ITEMS</h3>
                <div id="combat-items-display">
                    <!-- Combat items will be added here dynamically -->
                </div>
            </div>
            <div class="button-container">
                <button onclick="showGameScreen()">RETURN TO GAME</button>
            </div>
        </div>
        
        <!-- Combat Screen -->
        <div id="combat-screen" class="screen">
            <div class="game-text combat-screen" id="combat-text">
                <!-- Combat text will be added here dynamically -->
            </div>
            
            <div id="combatants-display">
                <!-- Combatants will be added here dynamically -->
            </div>
            
            <h3>COMBAT ACTIONS</h3>
            <div class="button-container" id="combat-actions">
                <!-- Combat action buttons will be added here dynamically -->
            </div>
        </div>
        
        <!-- Multiple Endings Screens -->
        <div id="redemption-screen" class="screen">
            <h2>REDEMPTION ENDING</h2>
            <div class="game-text">
                <p class="victory">YOU HAVE FOUND REDEMPTION</p>
                <p>Through great sacrifice and willpower, you have broken the vampire curse.</p>
                <p>Father Mikhail's ritual worked. As the first rays of dawn touch your skin, you feel warmth instead of pain.</p>
                <p>Your heartbeat returns, faint at first, then stronger. The hunger is gone. The darkness recedes.</p>
                <p>You are human again, with centuries of memories but a mortal lifespan ahead.</p>
                <p>The village celebrates their mysterious benefactor who saved them from the vampire threat.</p>
                <p>You live out your days in peace, finally at rest.</p>
            </div>
            <div class="button-container">
                <button onclick="restartGame()">PLAY AGAIN</button>
            </div>
        </div>
        
        <div id="ascension-screen" class="screen">
            <h2>ASCENSION ENDING</h2>
            <div class="game-text">
                <p class="victory">YOU HAVE ASCENDED TO ULTIMATE POWER</p>
                <p>You rejected humanity and embraced your vampiric nature completely.</p>
                <p>With the ancient relics and dark rituals, you have become something more than vampire.</p>
                <p>You are Vampire Lord Dracula, sovereign of the night, ruler of shadows.</p>
                <p>The village is now your domain, its inhabitants your willing thralls.</p>
                <p>Your castle expands, becoming a fortress of darkness that blots out the sun.</p>
                <p>For eternity, you reign supreme, a dark god feared by all.</p>
            </div>
            <div class="button-container">
                <button onclick="restartGame()">PLAY AGAIN</button>
            </div>
        </div>
        
        <div id="balance-screen" class="screen">
            <h2>BALANCE ENDING</h2>
            <div class="game-text">
                <p class="victory">YOU HAVE FOUND BALANCE</p>
                <p>You neither rejected your nature nor fully embraced the darkness.</p>
                <p>With Elena's help, you learned to control the hunger and use your powers for protection.</p>
                <p>The village now sees you as their guardianâ€”a mysterious protector who walks the night.</p>
                <p>You maintain your castle but often walk among mortals in disguise.</p>
                <p>The werewolves respect your territory, and vampire hunters leave you in peace.</p>
                <p>You have found a purpose: protecting the innocent from the very darkness you embody.</p>
            </div>
            <div class="button-container">
                <button onclick="restartGame()">PLAY AGAIN</button>
            </div>
        </div>
        
        <div id="destruction-screen" class="screen">
            <h2>DESTRUCTION ENDING</h2>
            <div class="game-text">
                <p class="game-over">YOU HAVE EMBRACED DESTRUCTION</p>
                <p>In your quest for power or redemption, you went too far.</p>
                <p>The ancient rituals were unstable, the relics too powerful.</p>
                <p>As you performed the final ritual, reality unraveled around you.</p>
                <p>Your castle crumbles, the village vanishes, and you are consumed by the very darkness you sought to control.</p>
                <p>Not even ash remains. The curse is broken, but at the cost of everything.</p>
                <p>In the end, there is only silence.</p>
            </div>
            <div class="button-container">
                <button onclick="restartGame()">PLAY AGAIN</button>
            </div>
        </div>
        
        <div id="betrayal-screen" class="screen">
            <h2>BETRAYAL ENDING</h2>
            <div class="game-text">
                <p class="game-over">YOU HAVE BETRAYED ALL</p>
                <p>You played every faction against each other for your own gain.</p>
                <p>The village is now a nest of vampires under your control.</p>
                <p>The church burns, the hunters are dead or turned, and the werewolves have fled.</p>
                <p>But your victory is hollow. You rule over thralls, not subjects.</p>
                <p>There is no challenge, no passion, no meaning in your eternal existence.</p>
                <p>You have everything you wanted, and it means nothing.</p>
                <p>Eternity stretches before you, an endless night of empty conquest.</p>
            </div>
            <div class="button-container">
                <button onclick="restartGame()">PLAY AGAIN</button>
            </div>
        </div>
        
        <!-- Game Over Screen -->
        <div id="gameover-screen" class="screen">
            <h2>GAME OVER</h2>
            <div class="game-text" id="gameover-text">
                <!-- Game over text will be added here dynamically -->
            </div>
            <div class="button-container">
                <button onclick="restartGame()">TRY AGAIN</button>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>DRACULA'S REDEMPTION ENHANCED - FEATURING POWERS, QUESTS, COMBAT & MULTIPLE ENDINGS</p>
        <p>Navigate with caution. Your choices determine your destiny.</p>
    </div>

    <script>
        // Enhanced Game State
        const gameState = {
            screen: 'start',
            stats: {
                charisma: 0,
                perception: 0,
                willpower: 0,
                maxPoints: 12,
                points: 0
            },
            health: 10,
            maxHealth: 10,
            bloodPoints: 0,
            inventory: [],
            relics: [],
            selectedBackground: null,
            currentLocation: 'village_square',
            encounters: [],
            gameOver: false,
            victory: false,
            day: 1,
            time: 'night',
            activeQuests: [],
            completedQuests: [],
            romance: {
                elena: { level: 0, status: 'unknown' },
                alchemist: { level: 0, status: 'unknown' }
            },
            combat: {
                inCombat: false,
                enemy: null,
                playerActions: [],
                enemyHealth: 0
            },
            powers: {
                mind: [
                    { id: 'hypnotic_gaze', name: 'Hypnotic Gaze', description: 'Compel weak minds to obey', cost: 3, unlocked: false, level: 1 },
                    { id: 'memory_wipe', name: 'Memory Wipe', description: 'Erase recent memories', cost: 5, unlocked: false, level: 2 },
                    { id: 'mass_hypnosis', name: 'Mass Hypnosis', description: 'Control groups of people', cost: 8, unlocked: false, level: 3 }
                ],
                body: [
                    { id: 'shadow_step', name: 'Shadow Step', description: 'Move instantly between shadows', cost: 3, unlocked: false, level: 1 },
                    { id: 'bat_swarm', name: 'Bat Swarm', description: 'Transform into a swarm of bats', cost: 5, unlocked: false, level: 2 },
                    { id: 'mist_form', name: 'Mist Form', description: 'Become intangible mist', cost: 8, unlocked: false, level: 3 }
                ],
                darkness: [
                    { id: 'blood_boil', name: 'Blood Boil', description: 'Heat enemy blood from within', cost: 3, unlocked: false, level: 1 },
                    { id: 'nightmare', name: 'Nightmare', description: 'Invade dreams with terror', cost: 5, unlocked: false, level: 2 },
                    { id: 'eternal_night', name: 'Eternal Night', description: 'Extend darkness temporarily', cost: 8, unlocked: false, level: 3 }
                ]
            },
            endingPath: null,
            factionStanding: {
                church: 0,
                villagers: 0,
                vampires: 5,
                werewolves: 0
            }
        };
        
        // Enhanced NPC Data with New NPCs
        const npcs = {
            priest: {
                name: "Father Mikhail",
                type: "helpful",
                description: "An elderly priest who tends the village church.",
                dialogue: {
                    initial: "My child, what brings you out on such a dark night? I sense a great burden upon your soul.",
                    options: [
                        { text: "I seek redemption for my sins.", response: "Redemption is possible for all who truly seek it. But the path is difficult and requires true repentance.", effect: { type: "stat", stat: "willpower", value: 1 }, check: null, quest: "redemption_path" },
                        { text: "I need guidance in dark times.", response: "The light always shines brightest in darkness. Come to the chapel tomorrow night for prayer.", effect: { type: "heal", value: 2 }, check: null },
                        { text: "Do you fear the vampire that haunts this village?", response: "I fear no creature of the night, for my faith protects me. But you... you seem unusually interested in such matters.", effect: { type: "damage", value: 3 }, check: { stat: "charisma", difficulty: 12 } },
                        { text: "Farewell, priest.", response: "Go with God, my child. May you find what you seek.", effect: null, check: null }
                    ],
                    discovered: false,
                    quests: ["redemption_path"]
                }
            },
            hunter: {
                name: "Van Helsing",
                type: "enemy",
                description: "A grim-faced man with a crossbow and stakes visible under his coat.",
                dialogue: {
                    initial: "You there! I don't recognize you. These are dangerous times with the vampire threat. What's your business here?",
                    options: [
                        { text: "I'm just a traveler passing through.", response: "Travelers should keep moving then. There's evil in this village that needs purging.", effect: { type: "stat", stat: "perception", value: -1 }, check: { stat: "charisma", difficulty: 10 } },
                        { text: "I too hunt the vampire. Perhaps we could join forces.", response: "I work alone. And you don't look like any hunter I've ever seen. There's something... unnatural about you.", effect: { type: "damage", value: 5 }, check: { stat: "willpower", difficulty: 14 } },
                        { text: "I am the darkness you seek. Face me now!", response: "So the monster reveals itself! Have at you, fiend!", effect: { type: "combat", enemy: "van_helsing" }, check: null },
                        { text: "I'll be on my way.", response: "See that you do. And pray we don't meet again.", effect: null, check: null }
                    ],
                    discovered: false
                }
            },
            alchemist: {
                name: "Dr. Moreau",
                type: "tricky",
                description: "A strange man who claims to sell potions and cures. His eyes gleam with unnatural knowledge.",
                dialogue: {
                    initial: "Ah, a new face! Interested in my wares? I have potions for every ailment... and every desire.",
                    options: [
                        { text: "Do you have anything for... eternal problems?", response: "Eternal problems require eternal solutions. I have just the thing. But it will cost you.", effect: { type: "item", item: "potion_eternity" }, check: { stat: "perception", difficulty: 11 }, quest: "alchemist_offer" },
                        { text: "I need something to control my hunger.", response: "Ah, that kind of hunger. Try this elixir. It should help... or make things more interesting.", effect: { type: "random_potion" }, check: null },
                        { text: "Can you cure vampirism?", response: "Cure it? Why would anyone want to cure such magnificent power? But yes... for a price.", effect: { type: "quest", quest: "vampire_cure" }, check: { stat: "charisma", difficulty: 13 } },
                        { text: "I don't trust you or your potions.", response: "Your loss. The night holds many dangers. You'll be back.", effect: null, check: null }
                    ],
                    discovered: false,
                    quests: ["alchemist_offer", "vampire_cure"]
                }
            },
            werewolf_alpha: {
                name: "Kieran",
                type: "neutral",
                description: "A large, imposing man with sharp eyes and a feral grace. He smells of wet earth and wild things.",
                dialogue: {
                    initial: "You walk in our territory, night-walker. State your purpose or leave.",
                    options: [
                        { text: "I mean no harm to your pack.", response: "Words are easy. Prove it. Help us with a problem, and we might tolerate your presence.", effect: { type: "quest", quest: "werewolf_problem" }, check: { stat: "charisma", difficulty: 12 } },
                        { text: "This territory is mine by right.", response: "Bold words for one alone. The pack hunts together. You hunt alone.", effect: { type: "combat", enemy: "werewolf_alpha" }, check: null },
                        { text: "I seek alliance against common enemies.", response: "The hunters? They trouble us as well. Perhaps an arrangement could be made.", effect: { type: "faction", faction: "werewolves", value: 5 }, check: { stat: "willpower", difficulty: 10 } },
                        { text: "I'll leave your territory.", response: "Wise choice. The full moon approaches. You don't want to be here then.", effect: null, check: null }
                    ],
                    discovered: false,
                    quests: ["werewolf_problem"]
                }
            },
            scientist: {
                name: "Dr. Frankenstein",
                type: "tricky",
                description: "A wild-eyed man in a stained lab coat, surrounded by strange electrical apparatus.",
                dialogue: {
                    initial: "Fascinating! Your bio-electrical field is unlike anything I've measured! May I study you?",
                    options: [
                        { text: "Study me? For what purpose?", response: "To advance science! To conquer death itself! With your unique physiology, I could create miracles!", effect: { type: "item", item: "lightning_rod" }, check: null, quest: "scientist_study" },
                        { text: "Can you enhance my abilities?", response: "Enhance? I can transcend! My galvanic apparatus can amplify your natural powers tenfold!", effect: { type: "stat", stat: "willpower", value: 2 }, check: { stat: "perception", difficulty: 14 } },
                        { text: "You meddle with forces you don't understand.", response: "On the contrary! I understand them better than anyone! The secret of life itself is within my grasp!", effect: { type: "damage", value: 4 }, check: null },
                        { text: "I have no time for mad science.", response: "Mad? They called Galileo mad! They called Darwin mad! History vindicates the visionary!", effect: null, check: null }
                    ],
                    discovered: false,
                    quests: ["scientist_study"]
                }
            },
            ghost: {
                name: "The Wraith",
                type: "helpful",
                description: "A translucent figure of a young woman, forever trapped between worlds.",
                dialogue: {
                    initial: "You... you're like him. The one who took my life. Do you remember me?",
                    options: [
                        { text: "I don't remember you. Should I?", response: "You drank my blood a century ago. I've been trapped here since, watching you forget.", effect: { type: "memory" }, check: null, quest: "ghost_redemption" },
                        { text: "I'm trying to change. Can you help me?", response: "Redemption requires remembering what you've done. I can show you... if you're brave enough.", effect: { type: "quest", quest: "ghost_redemption" }, check: { stat: "willpower", difficulty: 15 } },
                        { text: "Be gone, spirit! I have no time for ghosts!", response: "As you wish. But I am part of you now. You cannot escape what you've done.", effect: { type: "curse" }, check: null },
                        { text: "How can I free you?", response: "Find my locket, buried near the old oak. Return it to my grave, and I may find peace.", effect: { type: "quest", quest: "find_locket" }, check: null }
                    ],
                    discovered: false,
                    quests: ["ghost_redemption", "find_locket"]
                }
            },
            elena: {
                name: "Elena",
                type: "romance",
                description: "A pale, beautiful young woman who seems oddly comfortable in the darkness.",
                dialogue: {
                    initial: "Good evening, sir. You're out late... or early, depending on one's perspective. Are you lost?",
                    options: [
                        { text: "I'm searching for something... eternal.", response: "Eternity is a heavy burden. Are you certain you wish to carry it?", effect: { type: "stat", stat: "willpower", value: 2 }, check: { stat: "perception", difficulty: 13 }, romance: true },
                        { text: "You seem unafraid of the night.", response: "The night holds fewer terrors for me than the day. Sunlight can be so... burning.", effect: { type: "damage", value: 3 }, check: null },
                        { text: "Do you know of the vampire that haunts this place?", response: "I know him better than most. He is not what they say. He seeks something beyond blood.", effect: { type: "heal", value: 3 }, check: { stat: "charisma", difficulty: 12 }, romance: true },
                        { text: "Would you walk with me tonight?", response: "A dangerous offer... but intriguing. Very well, let us walk together.", effect: { type: "romance", character: "elena", value: 2 }, check: null, quest: "romance_elena" }
                    ],
                    discovered: false,
                    quests: ["romance_elena"]
                }
            }
        };
        
        // Enhanced Items Data
        const items = {
            potion_eternity: {
                name: "Potion of Eternity",
                description: "Alchemist's brew that enhances vampiric powers. Or poisons them.",
                type: "consumable",
                effect: "random_stat",
                value: 3,
                rarity: "rare"
            },
            lightning_rod: {
                name: "Lightning Rod",
                description: "Frankenstein's device that channels electrical energy.",
                type: "combat",
                damage: 8,
                rarity: "legendary"
            },
            wolfsbane_charm: {
                name: "Wolfsbane Charm",
                description: "Protects against werewolves. Given by Kieran for helping his pack.",
                type: "defense",
                value: 5,
                rarity: "rare"
            },
            ghost_locket: {
                name: "Silver Locket",
                description: "Belonged to the wraith. Returning it may grant peace.",
                type: "quest",
                rarity: "common"
            },
            ancient_relic_1: {
                name: "Amulet of Vlad",
                description: "First of three ancient vampire relics.",
                type: "relic",
                power: "Blood Control",
                rarity: "legendary"
            },
            ancient_relic_2: {
                name: "Ring of the Night",
                description: "Second of three ancient vampire relics.",
                type: "relic",
                power: "Shadow Walking",
                rarity: "legendary"
            },
            ancient_relic_3: {
                name: "Crown of Darkness",
                description: "Third of three ancient vampire relics.",
                type: "relic",
                power: "Eternal Dominion",
                rarity: "legendary"
            }
        };
        
        // Quests Data
        const quests = {
            redemption_path: {
                name: "Path to Redemption",
                description: "Follow Father Mikhail's guidance to break the vampire curse.",
                steps: ["Speak with Father Mikhail", "Gather holy items", "Perform purification ritual"],
                reward: "Redemption Ending",
                type: "main"
            },
            alchemist_offer: {
                name: "The Alchemist's Offer",
                description: "Dr. Moreau offers a potion that could enhance or poison you.",
                steps: ["Accept the potion", "Drink it cautiously", "Survive the effects"],
                reward: "Random stat boost or penalty",
                type: "side"
            },
            werewolf_problem: {
                name: "Werewolf Territory Dispute",
                description: "Help Kieran's pack with hunters encroaching on their territory.",
                steps: ["Speak with Kieran", "Deal with the hunters", "Report back to Kieran"],
                reward: "Wolfsbane Charm and werewolf alliance",
                type: "side"
            },
            scientist_study: {
                name: "Mad Scientist's Experiment",
                description: "Allow Dr. Frankenstein to study your unique physiology.",
                steps: ["Agree to be studied", "Survive the experiments", "Receive your 'reward'"],
                reward: "Lightning Rod gadget",
                type: "side"
            },
            ghost_redemption: {
                name: "Ghost of the Past",
                description: "Help the wraith find peace by confronting your past sins.",
                steps: ["Listen to the ghost's story", "Find her locket", "Lay her to rest"],
                reward: "Peace of mind and willpower boost",
                type: "side"
            },
            find_locket: {
                name: "The Missing Locket",
                description: "Find the silver locket belonging to the ghost.",
                steps: ["Search the cemetery", "Find the locket under the old oak", "Return it to the grave"],
                reward: "Ghost's blessing",
                type: "side"
            },
            romance_elena: {
                name: "Elena's Affection",
                description: "Court Elena and discover her mysterious nature.",
                steps: ["Walk with Elena", "Learn her secrets", "Choose your relationship path"],
                reward: "Romance options and potential ally",
                type: "romance"
            },
            vampire_cure: {
                name: "Search for a Cure",
                description: "Work with the alchemist to find a cure for vampirism.",
                steps: ["Commission the research", "Gather rare ingredients", "Test the cure"],
                reward: "Potential cure or enhanced vampirism",
                type: "main"
            },
            collect_relics: {
                name: "Ancient Vampire Relics",
                description: "Find the three ancient relics of vampire lords.",
                steps: ["Find Amulet of Vlad", "Find Ring of the Night", "Find Crown of Darkness"],
                reward: "Ultimate vampire power",
                type: "main"
            },
            missing_villagers: {
                name: "Missing Villagers",
                description: "Several villagers have disappeared. Some may want to be turned.",
                steps: ["Investigate disappearances", "Find the villagers", "Decide their fate"],
                reward: "Villager gratitude or new vampires",
                type: "side"
            }
        };
        
        // Enemies for Combat System
        const enemies = {
            van_helsing: {
                name: "Van Helsing",
                health: 25,
                damage: 4,
                special: "Holy Water",
                specialDamage: 8,
                description: "Expert vampire hunter armed with stakes and holy symbols.",
                weakness: "Darkness powers"
            },
            werewolf_alpha: {
                name: "Kieran (Werewolf Form)",
                health: 30,
                damage: 6,
                special: "Howl",
                specialDamage: 10,
                description: "Powerful alpha werewolf in full moon form.",
                weakness: "Silver"
            },
            vampire_hunter: {
                name: "Vampire Hunter",
                health: 15,
                damage: 3,
                special: "Crossbow",
                specialDamage: 6,
                description: "Trained hunter of the night.",
                weakness: "Mind control"
            },
            angry_mob: {
                name: "Angry Mob",
                health: 40,
                damage: 2,
                special: "Torches",
                specialDamage: 5,
                description: "Villagers armed with torches and pitchforks.",
                weakness: "Fear powers"
            }
        };
        
        // Locations
        const locations = {
            village_square: {
                name: "Village Square",
                description: "The central square of the village. A stone fountain stands dry in the moonlight.",
                npcs: ["priest", "hunter", "elena"],
                discovered: true,
                quests: ["missing_villagers"]
            },
            apothecary: {
                name: "Moreau's Apothecary",
                description: "A strange shop filled with bubbling potions and odd specimens in jars.",
                npcs: ["alchemist"],
                discovered: false,
                quests: ["alchemist_offer", "vampire_cure"]
            },
            wolf_woods: {
                name: "Wolf Woods",
                description: "Dense forest at the village edge. Howls echo in the distance.",
                npcs: ["werewolf_alpha"],
                discovered: false,
                quests: ["werewolf_problem"]
            },
            laboratory: {
                name: "Frankenstein's Laboratory",
                description: "A tower filled with crackling electrical equipment and strange specimens.",
                npcs: ["scientist"],
                discovered: false,
                quests: ["scientist_study"]
            },
            haunted_cemetery: {
                name: "Haunted Cemetery",
                description: "Ancient tombstones lean at unnatural angles. A cold mist hangs in the air.",
                npcs: ["ghost"],
                discovered: false,
                quests: ["ghost_redemption", "find_locket", "collect_relics"]
            }
        };
        
        // DOM Elements for screens
        const screens = {
            start: document.getElementById('start-screen'),
            character: document.getElementById('character-screen'),
            game: document.getElementById('game-screen'),
            powers: document.getElementById('powers-screen'),
            quests: document.getElementById('quests-screen'),
            inventory: document.getElementById('inventory-screen'),
            combat: document.getElementById('combat-screen'),
            gameover: document.getElementById('gameover-screen')
        };
        
        // Initialize Game
        function initGame() {
            document.getElementById('start-btn').addEventListener('click', showCharacterScreen);
            document.getElementById('begin-btn').addEventListener('click', startGame);
            
            // Initialize begin button state
            updateBeginButtonState();
            
            console.log("Game initialized successfully");
        }
        
        // Show Character Creation Screen
        function showCharacterScreen() {
            screens.start.classList.remove('active');
            screens.character.classList.add('active');
            gameState.screen = 'character';
            
            // Reset button highlights
            resetBackgroundButtonHighlights();
            
            console.log("Character screen shown");
        }
        
        // Change Stat Points
        function changeStat(stat, change) {
            // Don't allow going below 1
            if (change < 0 && gameState.stats[stat] <= 1) {
                return;
            }
            
            // Don't allow going above 10
            if (change > 0 && gameState.stats[stat] >= 10) {
                return;
            }
            
            // Check if we have points to spend or can take back points
            if (change > 0 && gameState.stats.points <= 0) {
                return;
            }
            
            gameState.stats[stat] += change;
            gameState.stats.points -= change;
            
            document.getElementById(`${stat}-value`).textContent = gameState.stats[stat];
            updatePointsDisplay();
            updateBeginButtonState();
            
            console.log(`${stat} changed by ${change}, points remaining: ${gameState.stats.points}`);
        }
        
        // Update Points Display
        function updatePointsDisplay() {
            document.getElementById('points').textContent = gameState.stats.points;
        }
        
        // Select Background
        function selectBackground(background, buttonElement) {
            gameState.selectedBackground = background;
            
            // Reset all button styles
            resetBackgroundButtonHighlights();
            
            // Highlight selected button
            buttonElement.style.borderColor = '#ff3333';
            buttonElement.style.color = '#ff3333';
            
            // Update begin button state
            updateBeginButtonState();
            
            console.log(`Selected background: ${background}`);
        }
        
        // Reset background button highlights
        function resetBackgroundButtonHighlights() {
            document.getElementById('mind-controller-btn').style.borderColor = '#666';
            document.getElementById('mind-controller-btn').style.color = '#fff';
            document.getElementById('night-stalker-btn').style.borderColor = '#666';
            document.getElementById('night-stalker-btn').style.color = '#fff';
            document.getElementById('blood-mage-btn').style.borderColor = '#666';
            document.getElementById('blood-mage-btn').style.color = '#fff';
        }
        
        // Update Begin Button State
        function updateBeginButtonState() {
            const beginBtn = document.getElementById('begin-btn');
            const isDisabled = gameState.stats.points !== 0 || gameState.selectedBackground === null;
            beginBtn.disabled = isDisabled;
            
            console.log(`Begin button disabled: ${isDisabled}, Points: ${gameState.stats.points}, Background selected: ${gameState.selectedBackground !== null}`);
        }
        
        // Unlock a power
        function unlockPower(branch, powerId) {
            const power = gameState.powers[branch].find(p => p.id === powerId);
            if (power && !power.unlocked) {
                power.unlocked = true;
                console.log(`Unlocked power: ${power.name}`);
            }
        }
        
        // Start Game
        function startGame() {
            console.log("Start game called");
            
            // Final validation
            if (gameState.stats.points !== 0) {
                alert("You must allocate all points before starting!");
                return;
            }
            
            if (!gameState.selectedBackground) {
                alert("You must select a background before starting!");
                return;
            }
            
            console.log("Starting game with background:", gameState.selectedBackground);
            
            // Unlock starting power based on background
            if (gameState.selectedBackground === 'mind_controller') {
                unlockPower('mind', 'hypnotic_gaze');
            } else if (gameState.selectedBackground === 'night_stalker') {
                unlockPower('body', 'shadow_step');
            } else if (gameState.selectedBackground === 'blood_mage') {
                unlockPower('darkness', 'blood_boil');
            }
            
            // Update game screen stats
            document.getElementById('game-charisma').textContent = gameState.stats.charisma;
            document.getElementById('game-perception').textContent = gameState.stats.perception;
            document.getElementById('game-willpower').textContent = gameState.stats.willpower;
            document.getElementById('health').textContent = gameState.health;
            document.getElementById('max-health').textContent = gameState.maxHealth;
            document.getElementById('blood-points').textContent = gameState.bloodPoints;
            
            // Add starting quests
            addQuest('missing_villagers');
            addQuest('collect_relics');
            
            // Update quest count
            updateQuestCount();
            
            // Switch to game screen
            screens.character.classList.remove('active');
            screens.game.classList.add('active');
            gameState.screen = 'game';
            
            // Start the game
            showLocation('village_square');
            
            console.log("Game started successfully");
        }
        
        // Show Location
        function showLocation(locationId) {
            const location = locations[locationId];
            gameState.currentLocation = locationId;
            
            document.getElementById('location-name').textContent = location.name.toUpperCase();
            
            let html = `<p>LOCATION: <strong>${location.name}</strong></p>`;
            html += `<p>${location.description}</p>`;
            
            // Show available NPCs
            html += `<p class="npc-dialogue">You can interact with:</p>`;
            
            location.npcs.forEach(npcId => {
                const npc = npcs[npcId];
                const discovered = npc.discovered ? '' : ' (new)';
                html += `<p><strong>${npc.name}</strong> - ${npc.description}${discovered}</p>`;
                npc.discovered = true;
            });
            
            // Show quests available in this location
            if (location.quests && location.quests.length > 0) {
                html += `<p class="warning">QUEST OPPORTUNITIES AVAILABLE HERE</p>`;
            }
            
            document.getElementById('game-text').innerHTML = html;
            
            // Create action buttons
            const buttonContainer = document.getElementById('action-buttons');
            buttonContainer.innerHTML = '';
            
            // Add NPC interaction buttons
            location.npcs.forEach(npcId => {
                const npc = npcs[npcId];
                const button = document.createElement('button');
                button.textContent = `SPEAK WITH ${npc.name.toUpperCase()}`;
                if (npc.type === 'romance') {
                    button.className = 'romance-option';
                }
                button.onclick = () => interactWithNPC(npcId);
                buttonContainer.appendChild(button);
            });
            
            // Add location movement buttons
            Object.keys(locations).forEach(locId => {
                if (locId !== locationId && (locations[locId].discovered || Math.random() > 0.7)) {
                    const loc = locations[locId];
                    const button = document.createElement('button');
                    button.textContent = `GO TO ${loc.name.toUpperCase()}`;
                    button.onclick = () => {
                        locations[locId].discovered = true;
                        showLocation(locId);
                    };
                    buttonContainer.appendChild(button);
                }
            });
            
            // Add special actions based on location
            if (locationId === 'haunted_cemetery') {
                const button = document.createElement('button');
                button.textContent = "SEARCH FOR RELICS";
                button.onclick = searchForRelics;
                buttonContainer.appendChild(button);
                
                const investigateButton = document.createElement('button');
                investigateButton.textContent = "INVESTIGATE DISAPPEARANCES";
                investigateButton.className = 'side-quest-option';
                investigateButton.onclick = investigateDisappearances;
                buttonContainer.appendChild(investigateButton);
            }
            
            if (locationId === 'wolf_woods') {
                const huntButton = document.createElement('button');
                huntButton.textContent = "HUNT FOR BLOOD";
                huntButton.onclick = huntForBlood;
                buttonContainer.appendChild(huntButton);
            }
            
            // Add inventory use button if we have consumables
            if (gameState.inventory.includes('potion_eternity')) {
                const button = document.createElement('button');
                button.textContent = "DRINK POTION OF ETERNITY";
                button.onclick = drinkPotion;
                buttonContainer.appendChild(button);
            }
            
            // Add end game button
            const endButton = document.createElement('button');
            endButton.textContent = "RETURN TO CASTLE";
            endButton.onclick = endGame;
            buttonContainer.appendChild(endButton);
        }
        
        // Interact with NPC
        function interactWithNPC(npcId) {
            const npc = npcs[npcId];
            const dialogue = npc.dialogue;
            
            let html = `<p>YOU APPROACH <strong>${npc.name.toUpperCase()}</strong></p>`;
            html += `<p class="npc-dialogue">"${dialogue.initial}"</p>`;
            html += `<p class="player-dialogue">How do you respond?</p>`;
            
            document.getElementById('game-text').innerHTML = html;
            
            // Create dialogue option buttons
            const buttonContainer = document.getElementById('action-buttons');
            buttonContainer.innerHTML = '';
            
            dialogue.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option.text;
                if (option.romance) {
                    button.className = 'romance-option';
                }
                button.onclick = () => selectDialogueOption(npcId, index);
                buttonContainer.appendChild(button);
            });
            
            // Add back button
            const backButton = document.createElement('button');
            backButton.textContent = "LEAVE THE CONVERSATION";
            backButton.onclick = () => showLocation(gameState.currentLocation);
            buttonContainer.appendChild(backButton);
        }
        
        // Select Dialogue Option
        function selectDialogueOption(npcId, optionIndex) {
            const npc = npcs[npcId];
            const option = npc.dialogue.options[optionIndex];
            let html = document.getElementById('game-text').innerHTML;
            
            html += `<p class="player-dialogue">${option.text}</p>`;
            html += `<p class="npc-dialogue">"${option.response}"</p>`;
            
            // Handle option effect
            let outcomeText = "";
            if (option.effect) {
                const effect = option.effect;
                
                // Check if stat check is required
                let checkPassed = true;
                if (option.check) {
                    const statValue = gameState.stats[option.check.stat];
                    const roll = Math.floor(Math.random() * 6) + 1; // 1d6
                    checkPassed = (statValue + roll) >= option.check.difficulty;
                    
                    if (!checkPassed) {
                        outcomeText = `<p class="outcome-bad">Your ${option.check.stat.toUpperCase()} failed! (${statValue} + ${roll} vs ${option.check.difficulty})</p>`;
                    } else {
                        outcomeText = `<p class="outcome-good">Your ${option.check.stat.toUpperCase()} succeeded! (${statValue} + ${roll} vs ${option.check.difficulty})</p>`;
                    }
                }
                
                // Apply effect if check passed or no check required
                if (checkPassed || !option.check) {
                    switch(effect.type) {
                        case "stat":
                            gameState.stats[effect.stat] += effect.value;
                            updateGameStats();
                            outcomeText += `<p class="${effect.value > 0 ? 'outcome-good' : 'outcome-bad'}">${effect.stat.toUpperCase()} ${effect.value > 0 ? 'increased' : 'decreased'} by ${Math.abs(effect.value)}</p>`;
                            break;
                        case "heal":
                            gameState.health = Math.min(gameState.maxHealth, gameState.health + effect.value);
                            updateGameStats();
                            outcomeText += `<p class="outcome-good">HEALTH restored by ${effect.value}</p>`;
                            break;
                        case "damage":
                            gameState.health -= effect.value;
                            updateGameStats();
                            outcomeText += `<p class="outcome-bad">You took ${effect.value} damage!</p>`;
                            
                            if (gameState.health <= 0) {
                                gameOver(`You were defeated by ${npc.name}!`);
                                return;
                            }
                            break;
                        case "combat":
                            startCombat(effect.enemy);
                            return;
                        case "item":
                            if (effect.item === "random_potion") {
                                const potions = ["potion_eternity", "vial_blood"];
                                const randomPotion = potions[Math.floor(Math.random() * potions.length)];
                                if (!gameState.inventory.includes(randomPotion)) {
                                    gameState.inventory.push(randomPotion);
                                    updateInventoryDisplay();
                                    outcomeText += `<p class="outcome-good">You received: ${items[randomPotion].name}</p>`;
                                }
                            } else if (!gameState.inventory.includes(effect.item)) {
                                gameState.inventory.push(effect.item);
                                updateInventoryDisplay();
                                outcomeText += `<p class="outcome-good">You received: ${items[effect.item].name}</p>`;
                            }
                            break;
                        case "quest":
                            if (!gameState.activeQuests.includes(effect.quest) && !gameState.completedQuests.includes(effect.quest)) {
                                addQuest(effect.quest);
                                outcomeText += `<p class="outcome-good">New Quest: ${quests[effect.quest].name}</p>`;
                            }
                            break;
                        case "faction":
                            gameState.factionStanding[effect.faction] += effect.value;
                            outcomeText += `<p class="outcome-good">${effect.faction.toUpperCase()} standing ${effect.value > 0 ? 'increased' : 'decreased'} by ${Math.abs(effect.value)}</p>`;
                            break;
                        case "romance":
                            gameState.romance[effect.character].level += effect.value;
                            outcomeText += `<p class="romance-option">Your relationship with ${effect.character} has deepened.</p>`;
                            break;
                        case "memory":
                            // Gain blood points for remembering past sins
                            gameState.bloodPoints += 2;
                            updateGameStats();
                            outcomeText += `<p class="outcome-good">You gain 2 Blood Points from confronting your past.</p>`;
                            break;
                        case "curse":
                            gameState.health -= 2;
                            gameState.stats.willpower -= 1;
                            updateGameStats();
                            outcomeText += `<p class="outcome-bad">The ghost's curse weakens you!</p>`;
                            break;
                    }
                }
                
                // Gain blood points for successful interaction
                if (checkPassed && effect.type !== "damage" && effect.type !== "curse") {
                    gameState.bloodPoints += 1;
                    updateGameStats();
                    outcomeText += `<p>Gained 1 Blood Point</p>`;
                }
            }
            
            // Check for quest assignment
            if (option.quest && !gameState.activeQuests.includes(option.quest) && !gameState.completedQuests.includes(option.quest)) {
                addQuest(option.quest);
                outcomeText += `<p class="outcome-good">New Quest: ${quests[option.quest].name}</p>`;
            }
            
            html += outcomeText;
            document.getElementById('game-text').innerHTML = html;
            
            // Check for ending conditions
            checkEndingConditions();
            
            // Update button options
            const buttonContainer = document.getElementById('action-buttons');
            buttonContainer.innerHTML = '';
            
            // Add continue button
            const continueButton = document.createElement('button');
            continueButton.textContent = "CONTINUE";
            continueButton.onclick = () => showLocation(gameState.currentLocation);
            buttonContainer.appendChild(continueButton);
        }
        
        // Search for Relics
        function searchForRelics() {
            let html = document.getElementById('game-text').innerHTML;
            html += `<p class="player-dialogue">You search the ancient tombs for vampire relics...</p>`;
            
            // Perception check
            const perceptionCheck = gameState.stats.perception + Math.floor(Math.random() * 6) + 1;
            
            if (perceptionCheck >= 15 && gameState.relics.length < 3) {
                const relicNames = ["Amulet of Vlad", "Ring of the Night", "Crown of Darkness"];
                const foundRelic = relicNames[gameState.relics.length];
                
                gameState.relics.push(foundRelic);
                html += `<p class="outcome-good">Your keen perception spots something gleaming in a hidden compartment!</p>`;
                html += `<p class="outcome-good">You found ${foundRelic} (${gameState.relics.length}/3 relics)!</p>`;
                
                // Update quest progress
                updateQuestProgress('collect_relics', gameState.relics.length);
                
                // Gain blood points
                gameState.bloodPoints += 3;
                updateGameStats();
                html += `<p>Gained 3 Blood Points</p>`;
            } else if (gameState.relics.length >= 3) {
                html += `<p>You have found all the ancient relics.</p>`;
            } else {
                html += `<p class="outcome-bad">You find nothing of interest. Your perception is not sharp enough (rolled ${perceptionCheck}).</p>`;
            }
            
            document.getElementById('game-text').innerHTML = html;
        }
        
        // Investigate Disappearances
        function investigateDisappearances() {
            let html = document.getElementById('game-text').innerHTML;
            html += `<p class="player-dialogue">You investigate the recent disappearances...</p>`;
            
            // Random outcome
            const outcome = Math.floor(Math.random() * 3);
            
            if (outcome === 0) {
                html += `<p>You find a villager hiding in a crypt. He begs for death rather than becoming a vampire.</p>`;
                html += `<p class="warning">Do you turn him or grant his wish?</p>`;
                
                const buttonContainer = document.getElementById('action-buttons');
                buttonContainer.innerHTML = '';
                
                const turnButton = document.createElement('button');
                turnButton.textContent = "TURN HIM INTO A VAMPIRE";
                turnButton.onclick = () => {
                    gameState.factionStanding.vampires += 2;
                    gameState.factionStanding.villagers -= 3;
                    html += `<p class="outcome-bad">You turn the villager. He becomes your thrall, but the village grows more fearful.</p>`;
                    updateQuestProgress('missing_villagers', 1);
                    document.getElementById('game-text').innerHTML = html;
                };
                buttonContainer.appendChild(turnButton);
                
                const killButton = document.createElement('button');
                killButton.textContent = "GRANT HIS WISH";
                killButton.onclick = () => {
                    gameState.factionStanding.villagers += 1;
                    gameState.bloodPoints += 1;
                    updateGameStats();
                    html += `<p class="outcome-good">You grant him a merciful death. The village would thank you if they knew.</p>`;
                    updateQuestProgress('missing_villagers', 1);
                    document.getElementById('game-text').innerHTML = html;
                };
                buttonContainer.appendChild(killButton);
            } else if (outcome === 1) {
                html += `<p>You find a villager who WANTS to become a vampire. She offers eternal servitude.</p>`;
                
                const buttonContainer = document.getElementById('action-buttons');
                buttonContainer.innerHTML = '';
                
                const acceptButton = document.createElement('button');
                acceptButton.textContent = "ACCEPT HER OFFER";
                acceptButton.onclick = () => {
                    gameState.factionStanding.vampires += 1;
                    html += `<p class="outcome-good">You gain a loyal servant. Your vampire family grows.</p>`;
                    updateQuestProgress('missing_villagers', 1);
                    document.getElementById('game-text').innerHTML = html;
                };
                buttonContainer.appendChild(acceptButton);
                
                const refuseButton = document.createElement('button');
                refuseButton.textContent = "REFUSE AND SEND HER AWAY";
                refuseButton.onclick = () => {
                    gameState.stats.willpower += 1;
                    updateGameStats();
                    html += `<p>You refuse her offer. Your willpower strengthens from the restraint.</p>`;
                    updateQuestProgress('missing_villagers', 1);
                    document.getElementById('game-text').innerHTML = html;
                };
                buttonContainer.appendChild(refuseButton);
            } else {
                html += `<p class="outcome-bad">You find evidence of werewolf activity. The disappearances may not be your doing.</p>`;
                html += `<p>This could be an opportunity to frame the werewolves or help them.</p>`;
                updateQuestProgress('missing_villagers', 1);
            }
            
            document.getElementById('game-text').innerHTML = html;
        }
        
        // Hunt for Blood
        function huntForBlood() {
            let html = document.getElementById('game-text').innerHTML;
            html += `<p class="player-dialogue">You hunt in the woods for blood...</p>`;
            
            const huntRoll = Math.floor(Math.random() * 6) + 1;
            
            if (huntRoll >= 5) {
                html += `<p class="outcome-good">You find a deer and feed. Health restored by 3.</p>`;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + 3);
                updateGameStats();
            } else if (huntRoll >= 3) {
                html += `<p>You find a rabbit. Small meal, but it helps. Health restored by 1.</p>`;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + 1);
                updateGameStats();
            } else {
                html += `<p class="outcome-bad">You find nothing. The hunger grows.</p>`;
                // Chance of encountering werewolves
                if (Math.random() > 0.7) {
                    html += `<p class="warning">You encounter werewolves while hunting!</p>`;
                    const buttonContainer = document.getElementById('action-buttons');
                    const fightButton = document.createElement('button');
                    fightButton.textContent = "FIGHT THE WEREWOLVES";
                    fightButton.className = 'combat-option';
                    fightButton.onclick = () => startCombat('werewolf_alpha');
                    buttonContainer.appendChild(fightButton);
                }
            }
            
            document.getElementById('game-text').innerHTML = html;
        }
        
        // Drink Potion
        function drinkPotion() {
            const index = gameState.inventory.indexOf('potion_eternity');
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
                
                let html = document.getElementById('game-text').innerHTML;
                html += `<p class="player-dialogue">You drink the mysterious potion...</p>`;
                
                // Random effect
                const effect = Math.floor(Math.random() * 3);
                
                if (effect === 0) {
                    html += `<p class="outcome-good">The potion enhances your powers! All stats increase by 1!</p>`;
                    gameState.stats.charisma += 1;
                    gameState.stats.perception += 1;
                    gameState.stats.willpower += 1;
                    updateGameStats();
                } else if (effect === 1) {
                    html += `<p class="outcome-bad">The potion was poison! You take 5 damage!</p>`;
                    gameState.health -= 5;
                    updateGameStats();
                    
                    if (gameState.health <= 0) {
                        gameOver("The alchemist's potion killed you!");
                        return;
                    }
                } else {
                    html += `<p class="warning">The potion has a strange effect. You gain 5 Blood Points but lose 2 Health.</p>`;
                    gameState.bloodPoints += 5;
                    gameState.health -= 2;
                    updateGameStats();
                }
                
                document.getElementById('game-text').innerHTML = html;
                updateQuestProgress('alchemist_offer', 3); // Complete the quest
            }
        }
        
        // Start Combat
        function startCombat(enemyId) {
            gameState.combat.inCombat = true;
            gameState.combat.enemy = enemyId;
            gameState.combat.enemyHealth = enemies[enemyId].health;
            gameState.combat.playerActions = [];
            
            // Switch to combat screen
            screens.game.classList.remove('active');
            screens.combat.classList.add('active');
            gameState.screen = 'combat';
            
            showCombatScreen();
        }
        
        // Show Combat Screen
        function showCombatScreen() {
            const enemy = enemies[gameState.combat.enemy];
            
            let html = `<p class="game-over">COMBAT INITIATED</p>`;
            html += `<p>You face <strong>${enemy.name}</strong>: ${enemy.description}</p>`;
            html += `<p>Weakness: ${enemy.weakness}</p>`;
            
            document.getElementById('combat-text').innerHTML = html;
            
            // Display combatants
            const combatantsDiv = document.getElementById('combatants-display');
            combatantsDiv.innerHTML = '';
            
            // Player
            const playerDiv = document.createElement('div');
            playerDiv.className = 'combatant combatant-player';
            playerDiv.innerHTML = `
                <div>
                    <strong>DRACULA</strong><br>
                    Health: ${gameState.health}/${gameState.maxHealth}
                </div>
                <div class="health-bar">
                    <div class="health-fill" style="width: ${(gameState.health / gameState.maxHealth) * 100}%"></div>
                </div>
            `;
            combatantsDiv.appendChild(playerDiv);
            
            // Enemy
            const enemyDiv = document.createElement('div');
            enemyDiv.className = 'combatant';
            enemyDiv.innerHTML = `
                <div>
                    <strong>${enemy.name.toUpperCase()}</strong><br>
                    Health: ${gameState.combat.enemyHealth}/${enemy.health}
                </div>
                <div class="health-bar">
                    <div class="health-fill" style="width: ${(gameState.combat.enemyHealth / enemy.health) * 100}%"></div>
                </div>
            `;
            combatantsDiv.appendChild(enemyDiv);
            
            // Display combat actions
            const actionsDiv = document.getElementById('combat-actions');
            actionsDiv.innerHTML = '';
            
            // Basic attacks
            const biteButton = document.createElement('button');
            biteButton.textContent = "BITE (3 DMG)";
            biteButton.onclick = () => performCombatAction('bite');
            biteButton.className = 'combat-option';
            actionsDiv.appendChild(biteButton);
            
            const clawButton = document.createElement('button');
            clawButton.textContent = "CLAW ATTACK (2 DMG)";
            clawButton.onclick = () => performCombatAction('claw');
            clawButton.className = 'combat-option';
            actionsDiv.appendChild(clawButton);
            
            // Unlocked powers
            gameState.powers.mind.forEach(power => {
                if (power.unlocked) {
                    const powerButton = document.createElement('button');
                    powerButton.textContent = `${power.name.toUpperCase()} (${power.level} DMG)`;
                    powerButton.onclick = () => performCombatAction('power', 'mind', power.id);
                    actionsDiv.appendChild(powerButton);
                }
            });
            
            gameState.powers.body.forEach(power => {
                if (power.unlocked) {
                    const powerButton = document.createElement('button');
                    powerButton.textContent = `${power.name.toUpperCase()} (${power.level} DMG)`;
                    powerButton.onclick = () => performCombatAction('power', 'body', power.id);
                    actionsDiv.appendChild(powerButton);
                }
            });
            
            gameState.powers.darkness.forEach(power => {
                if (power.unlocked) {
                    const powerButton = document.createElement('button');
                    powerButton.textContent = `${power.name.toUpperCase()} (${power.level} DMG)`;
                    powerButton.onclick = () => performCombatAction('power', 'darkness', power.id);
                    actionsDiv.appendChild(powerButton);
                }
            });
            
            // Defend
            const defendButton = document.createElement('button');
            defendButton.textContent = "DEFEND (Reduce damage)";
            defendButton.onclick = () => performCombatAction('defend');
            actionsDiv.appendChild(defendButton);
            
            // Flee
            const fleeButton = document.createElement('button');
            fleeButton.textContent = "ATTEMPT TO FLEE";
            fleeButton.onclick = attemptToFlee;
            actionsDiv.appendChild(fleeButton);
        }
        
        // Perform Combat Action
        function performCombatAction(action, branch = null, powerId = null) {
            const enemy = enemies[gameState.combat.enemy];
            let html = document.getElementById('combat-text').innerHTML;
            let damage = 0;
            let playerDefending = false;
            
            // Player's turn
            if (action === 'bite') {
                damage = 3;
                html += `<p class="player-dialogue">You bite your enemy for ${damage} damage!</p>`;
            } else if (action === 'claw') {
                damage = 2;
                html += `<p class="player-dialogue">You slash with your claws for ${damage} damage!</p>`;
            } else if (action === 'power' && branch && powerId) {
                const power = gameState.powers[branch].find(p => p.id === powerId);
                if (power && power.unlocked) {
                    damage = power.level;
                    html += `<p class="player-dialogue">You use ${power.name} for ${damage} damage!</p>`;
                    
                    // Special effects based on power
                    if (powerId === 'hypnotic_gaze' && enemy.weakness === 'Mind control') {
                        damage += 2;
                        html += `<p class="outcome-good">It's super effective! +2 damage!</p>`;
                    }
                }
            } else if (action === 'defend') {
                playerDefending = true;
                html += `<p class="player-dialogue">You take a defensive stance.</p>`;
            }
            
            // Apply player damage
            if (damage > 0) {
                gameState.combat.enemyHealth -= damage;
                html += `<p>${enemy.name} health: ${gameState.combat.enemyHealth}/${enemy.health}</p>`;
            }
            
            // Check if enemy is defeated
            if (gameState.combat.enemyHealth <= 0) {
                html += `<p class="outcome-good">You defeated ${enemy.name}!</p>`;
                html += `<p>Gained ${enemy.health} Blood Points!</p>`;
                gameState.bloodPoints += enemy.health;
                updateGameStats();
                
                document.getElementById('combat-text').innerHTML = html;
                
                // End combat after delay
                setTimeout(() => {
                    endCombat(true);
                }, 2000);
                return;
            }
            
            // Enemy's turn
            html += `<p class="npc-dialogue">${enemy.name} attacks!</p>`;
            
            let enemyDamage = enemy.damage;
            // Chance for special attack
            if (Math.random() > 0.7) {
                enemyDamage = enemy.specialDamage;
                html += `<p class="outcome-bad">${enemy.name} uses ${enemy.special} for ${enemyDamage} damage!</p>`;
            } else {
                html += `<p>${enemy.name} attacks for ${enemyDamage} damage.</p>`;
            }
            
            // Reduce damage if defending
            if (playerDefending) {
                enemyDamage = Math.max(1, Math.floor(enemyDamage / 2));
                html += `<p>Your defense reduces damage to ${enemyDamage}.</p>`;
            }
            
            // Apply enemy damage
            gameState.health -= enemyDamage;
            updateGameStats();
            html += `<p>Your health: ${gameState.health}/${gameState.maxHealth}</p>`;
            
            // Check if player is defeated
            if (gameState.health <= 0) {
                html += `<p class="game-over">You have been defeated by ${enemy.name}!</p>`;
                document.getElementById('combat-text').innerHTML = html;
                
                // End combat after delay
                setTimeout(() => {
                    endCombat(false);
                }, 2000);
                return;
            }
            
            document.getElementById('combat-text').innerHTML = html;
            showCombatScreen(); // Refresh combat screen
        }
        
        // Attempt to Flee
        function attemptToFlee() {
            let html = document.getElementById('combat-text').innerHTML;
            
            // Chance to flee based on willpower
            const fleeChance = gameState.stats.willpower * 10; // 10% per willpower point
            const roll = Math.random() * 100;
            
            if (roll <= fleeChance) {
                html += `<p class="outcome-good">You successfully flee from combat!</p>`;
                document.getElementById('combat-text').innerHTML = html;
                
                setTimeout(() => {
                    endCombat(false);
                }, 1500);
            } else {
                html += `<p class="outcome-bad">You fail to escape!</p>`;
                document.getElementById('combat-text').innerHTML = html;
                
                // Enemy gets a free attack
                setTimeout(() => {
                    const enemy = enemies[gameState.combat.enemy];
                    let enemyDamage = enemy.damage;
                    
                    html += `<p class="npc-dialogue">${enemy.name} attacks as you try to flee!</p>`;
                    html += `<p>You take ${enemyDamage} damage.</p>`;
                    
                    gameState.health -= enemyDamage;
                    updateGameStats();
                    
                    if (gameState.health <= 0) {
                        html += `<p class="game-over">You have been defeated!</p>`;
                        document.getElementById('combat-text').innerHTML = html;
                        
                        setTimeout(() => {
                            endCombat(false);
                        }, 2000);
                    } else {
                        document.getElementById('combat-text').innerHTML = html;
                        showCombatScreen();
                    }
                }, 1000);
            }
        }
        
        // End Combat
        function endCombat(victory) {
            gameState.combat.inCombat = false;
            
            if (!victory) {
                gameOver(`You were defeated in combat!`);
                return;
            }
            
            // Return to game screen
            screens.combat.classList.remove('active');
            screens.game.classList.add('active');
            gameState.screen = 'game';
            
            // Show location again
            showLocation(gameState.currentLocation);
        }
        
        // Show Powers Screen
        function showPowersScreen() {
            screens.game.classList.remove('active');
            screens.powers.classList.add('active');
            gameState.screen = 'powers';
            
            // Update available blood points
            document.getElementById('available-blood-points').textContent = gameState.bloodPoints;
            
            // Display mind powers
            const mindPowersDiv = document.getElementById('mind-powers');
            mindPowersDiv.innerHTML = '';
            
            gameState.powers.mind.forEach(power => {
                const powerDiv = document.createElement('div');
                powerDiv.className = `power ${power.unlocked ? 'unlocked' : 'locked'}`;
                powerDiv.innerHTML = `
                    <strong>${power.name}</strong><br>
                    ${power.description}<br>
                    Cost: ${power.cost} BP | Level: ${power.level}
                `;
                
                if (!power.unlocked && gameState.bloodPoints >= power.cost) {
                    powerDiv.classList.remove('locked');
                    powerDiv.onclick = () => unlockPowerWithPoints('mind', power.id);
                }
                
                mindPowersDiv.appendChild(powerDiv);
            });
            
            // Display body powers
            const bodyPowersDiv = document.getElementById('body-powers');
            bodyPowersDiv.innerHTML = '';
            
            gameState.powers.body.forEach(power => {
                const powerDiv = document.createElement('div');
                powerDiv.className = `power ${power.unlocked ? 'unlocked' : 'locked'}`;
                powerDiv.innerHTML = `
                    <strong>${power.name}</strong><br>
                    ${power.description}<br>
                    Cost: ${power.cost} BP | Level: ${power.level}
                `;
                
                if (!power.unlocked && gameState.bloodPoints >= power.cost) {
                    powerDiv.classList.remove('locked');
                    powerDiv.onclick = () => unlockPowerWithPoints('body', power.id);
                }
                
                bodyPowersDiv.appendChild(powerDiv);
            });
            
            // Display darkness powers
            const darknessPowersDiv = document.getElementById('darkness-powers');
            darknessPowersDiv.innerHTML = '';
            
            gameState.powers.darkness.forEach(power => {
                const powerDiv = document.createElement('div');
                powerDiv.className = `power ${power.unlocked ? 'unlocked' : 'locked'}`;
                powerDiv.innerHTML = `
                    <strong>${power.name}</strong><br>
                    ${power.description}<br>
                    Cost: ${power.cost} BP | Level: ${power.level}
                `;
                
                if (!power.unlocked && gameState.bloodPoints >= power.cost) {
                    powerDiv.classList.remove('locked');
                    powerDiv.onclick = () => unlockPowerWithPoints('darkness', power.id);
                }
                
                darknessPowersDiv.appendChild(powerDiv);
            });
        }
        
        // Unlock Power with Blood Points
        function unlockPowerWithPoints(branch, powerId) {
            const power = gameState.powers[branch].find(p => p.id === powerId);
            
            if (power && !power.unlocked && gameState.bloodPoints >= power.cost) {
                power.unlocked = true;
                gameState.bloodPoints -= power.cost;
                updateGameStats();
                
                // Add to inventory
                if (!gameState.inventory.includes(powerId)) {
                    gameState.inventory.push(powerId);
                }
                
                // Show success message
                alert(`You unlocked ${power.name}!`);
                
                // Refresh powers screen
                showPowersScreen();
            }
        }
        
        // Show Quests Screen
        function showQuestsScreen() {
            screens.game.classList.remove('active');
            screens.quests.classList.add('active');
            gameState.screen = 'quests';
            
            // Display active quests
            const activeQuestsDiv = document.getElementById('active-quests');
            activeQuestsDiv.innerHTML = '';
            
            if (gameState.activeQuests.length === 0) {
                activeQuestsDiv.innerHTML = '<p class="quest-item">No active quests.</p>';
            } else {
                gameState.activeQuests.forEach(questId => {
                    const quest = quests[questId];
                    const questDiv = document.createElement('div');
                    questDiv.className = 'quest-item';
                    questDiv.innerHTML = `
                        <strong>${quest.name}</strong><br>
                        ${quest.description}<br>
                        Type: ${quest.type} | Reward: ${quest.reward}
                    `;
                    activeQuestsDiv.appendChild(questDiv);
                });
            }
            
            // Display completed quests
            const completedQuestsDiv = document.getElementById('completed-quests');
            completedQuestsDiv.innerHTML = '';
            
            if (gameState.completedQuests.length === 0) {
                completedQuestsDiv.innerHTML = '<p class="quest-item">No completed quests.</p>';
            } else {
                gameState.completedQuests.forEach(questId => {
                    const quest = quests[questId];
                    const questDiv = document.createElement('div');
                    questDiv.className = 'quest-item quest-completed';
                    questDiv.innerHTML = `
                        <strong>${quest.name}</strong><br>
                        COMPLETED | Reward: ${quest.reward}
                    `;
                    completedQuestsDiv.appendChild(questDiv);
                });
            }
            
            // Display romance status
            const romanceDiv = document.getElementById('romance-status');
            romanceDiv.innerHTML = '';
            
            Object.keys(gameState.romance).forEach(character => {
                if (gameState.romance[character].level > 0) {
                    const romanceStatus = document.createElement('div');
                    romanceStatus.className = 'quest-item';
                    romanceStatus.innerHTML = `
                        <strong>${character.toUpperCase()}</strong><br>
                        Relationship Level: ${gameState.romance[character].level}/10<br>
                        Status: ${gameState.romance[character].status}
                    `;
                    romanceDiv.appendChild(romanceStatus);
                }
            });
        }
        
        // Show Inventory Screen
        function showInventoryScreen() {
            screens.game.classList.remove('active');
            screens.inventory.classList.add('active');
            gameState.screen = 'inventory';
            
            // Display inventory
            const inventoryDiv = document.getElementById('inventory-display');
            inventoryDiv.innerHTML = '';
            
            if (gameState.inventory.length === 0) {
                inventoryDiv.innerHTML = '<div class="item">Empty</div>';
            } else {
                gameState.inventory.forEach(itemId => {
                    const item = items[itemId];
                    if (item) {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = `item item-${item.rarity}`;
                        itemDiv.innerHTML = `
                            <strong>${item.name}</strong><br>
                            ${item.description}
                        `;
                        inventoryDiv.appendChild(itemDiv);
                    }
                });
            }
            
            // Display relics
            const relicsDiv = document.getElementById('relics-display');
            relicsDiv.innerHTML = '';
            
            if (gameState.relics.length === 0) {
                relicsDiv.innerHTML = '<p>No relics collected.</p>';
            } else {
                gameState.relics.forEach(relic => {
                    const relicDiv = document.createElement('div');
                    relicDiv.className = 'item item-legendary';
                    relicDiv.innerHTML = `<strong>${relic}</strong>`;
                    relicsDiv.appendChild(relicDiv);
                });
                
                relicsDiv.innerHTML += `<p>Relics collected: ${gameState.relics.length}/3</p>`;
            }
            
            // Display combat items
            const combatItemsDiv = document.getElementById('combat-items-display');
            combatItemsDiv.innerHTML = '';
            
            const combatItems = gameState.inventory.filter(itemId => 
                items[itemId] && items[itemId].type === 'combat'
            );
            
            if (combatItems.length === 0) {
                combatItemsDiv.innerHTML = '<p>No combat items.</p>';
            } else {
                combatItems.forEach(itemId => {
                    const item = items[itemId];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `item item-${item.rarity}`;
                    itemDiv.innerHTML = `
                        <strong>${item.name}</strong><br>
                        Damage: ${item.damage}
                    `;
                    combatItemsDiv.appendChild(itemDiv);
                });
            }
        }
        
        // Show Game Screen
        function showGameScreen() {
            screens.powers.classList.remove('active');
            screens.quests.classList.remove('active');
            screens.inventory.classList.remove('active');
            screens.game.classList.add('active');
            gameState.screen = 'game';
            
            showLocation(gameState.currentLocation);
        }
        
        // Add Quest
        function addQuest(questId) {
            if (!gameState.activeQuests.includes(questId) && !gameState.completedQuests.includes(questId)) {
                gameState.activeQuests.push(questId);
                updateQuestCount();
                
                // Show notification
                const gameText = document.getElementById('game-text');
                gameText.innerHTML += `<p class="outcome-good">New Quest: ${quests[questId].name}</p>`;
            }
        }
        
        // Update Quest Progress
        function updateQuestProgress(questId, progress) {
            if (gameState.activeQuests.includes(questId)) {
                // For simplicity, we'll just complete the quest when progress reaches 3
                if (progress >= 3) {
                    completeQuest(questId);
                }
            }
        }
        
        // Complete Quest
        function completeQuest(questId) {
            const index = gameState.activeQuests.indexOf(questId);
            if (index !== -1) {
                gameState.activeQuests.splice(index, 1);
                gameState.completedQuests.push(questId);
                updateQuestCount();
                
                // Award blood points
                gameState.bloodPoints += 5;
                updateGameStats();
                
                // Show notification
                const gameText = document.getElementById('game-text');
                gameText.innerHTML += `<p class="victory">Quest Completed: ${quests[questId].name}</p>`;
                gameText.innerHTML += `<p>Gained 5 Blood Points</p>`;
            }
        }
        
        // Update Quest Count Display
        function updateQuestCount() {
            document.getElementById('quest-count').textContent = gameState.activeQuests.length;
        }
        
        // Update Inventory Display
        function updateInventoryDisplay() {
            // This updates the inventory display in the main game screen
            // The full inventory screen has its own update function
        }
        
        // Check Ending Conditions
        function checkEndingConditions() {
            // Check for redemption ending
            if (gameState.completedQuests.includes('redemption_path') && 
                gameState.stats.willpower >= 15 &&
                gameState.factionStanding.church >= 5) {
                showEnding('redemption');
                return;
            }
            
            // Check for ascension ending
            if (gameState.relics.length >= 3 && 
                gameState.completedQuests.length >= 5 &&
                gameState.factionStanding.vampires >= 10) {
                showEnding('ascension');
                return;
            }
            
            // Check for balance ending
            if (gameState.romance.elena.level >= 8 &&
                gameState.factionStanding.villagers >= 3 &&
                gameState.factionStanding.vampires >= 3) {
                showEnding('balance');
                return;
            }
            
            // Check for destruction ending
            if (gameState.health <= 3 && 
                gameState.stats.willpower <= 3 &&
                gameState.completedQuests.includes('scientist_study')) {
                showEnding('destruction');
                return;
            }
            
            // Check for betrayal ending
            if (gameState.completedQuests.length >= 7 &&
                gameState.factionStanding.villagers <= -5 &&
                gameState.factionStanding.church <= -5 &&
                gameState.factionStanding.werewolves <= -5) {
                showEnding('betrayal');
                return;
            }
        }
        
        // Show Ending
        function showEnding(ending) {
            screens.game.classList.remove('active');
            document.getElementById(`${ending}-screen`).classList.add('active');
            gameState.endingPath = ending;
        }
        
        // End Game (Return to Castle)
        function endGame() {
            // Determine which ending based on game state
            if (gameState.endingPath) {
                showEnding(gameState.endingPath);
            } else if (gameState.relics.length >= 2) {
                showEnding('ascension');
            } else if (gameState.romance.elena.level >= 5) {
                showEnding('balance');
            } else {
                // Default to game over
                screens.game.classList.remove('active');
                screens.gameover.classList.add('active');
                
                let html = `<p class="game-over">ETERNAL DARKNESS</p>`;
                html += `<p>You return to your castle, your quest unfinished.</p>`;
                html += `<p>The hunger remains. The darkness persists.</p>`;
                html += `<p>Another century passes in lonely isolation.</p>`;
                html += `<p class="game-over">GAME OVER</p>`;
                
                document.getElementById('gameover-text').innerHTML = html;
            }
        }
        
        // Game Over
        function gameOver(reason) {
            screens.game.classList.remove('active');
            screens.combat.classList.remove('active');
            screens.gameover.classList.add('active');
            
            let html = `<p class="game-over">GAME OVER</p>`;
            html += `<p>${reason}</p>`;
            html += `<p>Your quest ends in darkness.</p>`;
            html += `<p>Perhaps in another century, you may try again...</p>`;
            
            document.getElementById('gameover-text').innerHTML = html;
        }
        
        // Restart Game
        function restartGame() {
            // Reset game state
            gameState.screen = 'start';
            gameState.stats = {
                charisma: 4,
                perception: 4,
                willpower: 4,
                maxPoints: 12,
                points: 0
            };
            gameState.health = 10;
            gameState.maxHealth = 10;
            gameState.bloodPoints = 0;
            gameState.inventory = [];
            gameState.relics = [];
            gameState.selectedBackground = null;
            gameState.currentLocation = 'village_square';
            gameState.encounters = [];
            gameState.gameOver = false;
            gameState.victory = false;
            gameState.day = 1;
            gameState.time = 'night';
            gameState.activeQuests = [];
            gameState.completedQuests = [];
            gameState.romance = {
                elena: { level: 0, status: 'unknown' },
                alchemist: { level: 0, status: 'unknown' }
            };
            gameState.combat = {
                inCombat: false,
                enemy: null,
                playerActions: [],
                enemyHealth: 0
            };
            gameState.endingPath = null;
            gameState.factionStanding = {
                church: 0,
                villagers: 0,
                vampires: 5,
                werewolves: 0
            };
            
            // Reset powers
            Object.keys(gameState.powers).forEach(branch => {
                gameState.powers[branch].forEach(power => {
                    power.unlocked = false;
                });
            });
            
            // Reset NPCs
            Object.keys(npcs).forEach(npcId => {
                npcs[npcId].discovered = false;
            });
            
            // Reset locations
            Object.keys(locations).forEach(locId => {
                locations[locId].discovered = locId === 'village_square';
            });
            
            // Hide all ending screens
            document.getElementById('redemption-screen').classList.remove('active');
            document.getElementById('ascension-screen').classList.remove('active');
            document.getElementById('balance-screen').classList.remove('active');
            document.getElementById('destruction-screen').classList.remove('active');
            document.getElementById('betrayal-screen').classList.remove('active');
            
            // Show start screen
            screens.gameover.classList.remove('active');
            screens.gameover.classList.remove('active');
            screens.start.classList.add('active');
            
            // Reset character screen
            document.getElementById('charisma-value').textContent = '4';
            document.getElementById('perception-value').textContent = '4';
            document.getElementById('willpower-value').textContent = '4';
            updatePointsDisplay();
            updateBeginButtonState();
            
            console.log("Game restarted");
        }
        
        // Update Game Stats Display
        function updateGameStats() {
            document.getElementById('game-charisma').textContent = gameState.stats.charisma;
            document.getElementById('game-perception').textContent = gameState.stats.perception;
            document.getElementById('game-willpower').textContent = gameState.stats.willpower;
            document.getElementById('health').textContent = gameState.health;
            document.getElementById('max-health').textContent = gameState.maxHealth;
            document.getElementById('blood-points').textContent = gameState.bloodPoints;
            
            // Update health bar
            const healthPercent = (gameState.health / gameState.maxHealth) * 100;
            document.getElementById('health-fill').style.width = `${healthPercent}%`;
        }
        
        // Initialize the game when page loads
        window.onload = initGame;
    </script>
</body>
</html>
