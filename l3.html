<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASTLE OF THE UNDEAD - Level 3: The Castle Gates</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Gothic Purple/Black/White theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(60, 0, 80, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(60, 0, 80, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #8040a0;
            background-color: #000;
            box-shadow: 0 0 20px rgba(128, 64, 160, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(60, 0, 80, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #8040a0;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #c080ff;
            text-shadow: 0 0 5px #a040ff;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #8040a0;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #500;
            color: #ff0;
            border-color: #ff0;
        }
        
        .level-number.current {
            background-color: #8040a0;
            color: #fff;
            border-color: #c080ff;
            box-shadow: 0 0 8px #a040ff;
            text-shadow: 0 0 2px #000;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #c080ff;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #c080ff;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #8040a0;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #c080ff;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #c080ff;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #8040a0;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8040a0;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #c080ff;
            border-color: #c080ff;
            box-shadow: 0 0 10px rgba(128, 64, 255, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #8040a0;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #c080ff;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8040a0;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #c080ff;
            border-color: #c080ff;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #221133;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #c080ff;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #332244;
            border: 1px solid #c080ff;
            padding: 10px;
            margin: 10px 0;
            color: #c080ff;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #6ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8040a0;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #8040a0;
            color: #fff;
            border-color: #c080ff;
            box-shadow: 0 0 15px #a040ff;
        }
        
        /* Gate Puzzle */
        .gate-puzzle {
            background-color: #221133;
            border: 1px solid #8040a0;
            padding: 15px;
            margin: 15px 0;
        }
        
        .puzzle-title {
            color: #c080ff;
            font-weight: bold;
            margin-bottom: 10px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .puzzle-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .puzzle-option {
            background-color: #332244;
            border: 1px solid #8040a0;
            padding: 10px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .puzzle-option:hover {
            background-color: #443355;
            border-color: #c080ff;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #8040a0;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #8040a0;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #c080ff;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CASTLE OF THE UNDEAD</h1>
            <h2>LEVEL 3: THE CASTLE GATES</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number completed">2</div>
            <div class="level-number current">3</div>
            <div class="level-number">4</div>
            <div class="level-number">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Level Intro Screen -->
        <div id="screen-intro" class="screen active-screen">
            <h2>THE CASTLE GATES</h2>
            <div class="story-text">
                <p>You stand before CASTLE VORLAK. The massive stone structure looms over you, its dark spires piercing the stormy sky. The air here is thick with ancient magic and the scent of decay.</p>
                <p>The castle gates are enormous - twenty feet tall and made of black iron reinforced with silver. Strange symbols are etched into the metal, glowing with a faint violet light.</p>
                <p>Between you and the gates lies a drawbridge over a moat filled not with water, but with a dark, viscous liquid that bubbles ominously.</p>
                <p>Two stone gargoyles flank the gates, their eyes glowing with red light. Are they merely statues, or something more?</p>
                <p>Your quest to destroy the vampire lord has brought you to his doorstep. Now you must find a way inside.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="intro-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="intro-stat-health" class="stat-value">0</span>/<span id="intro-stat-maxhealth" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="intro-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="intro-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="startLevel3()">APPROACH THE CASTLE GATES</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>CASTLE VORLAK GATES</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Gate Puzzle Screen -->
        <div id="screen-puzzle" class="screen">
            <h2>GATE MECHANISM PUZZLE</h2>
            <div class="story-text">
                <p>You examine the gate mechanism. It consists of three concentric rings, each with ancient symbols. The rings must be aligned in the correct sequence to unlock the gates.</p>
                <p>The symbols are: <span class="item">Moon</span>, <span class="item">Bat</span>, <span class="item">Wolf</span>, <span class="item">Coffin</span>, and <span class="item">Blood Drop</span>.</p>
                <p>You recall the old hermit's words: "<span class="npc">The vampire's power waxes with the moon, he commands bats and wolves, rests in a coffin, and thirsts for blood.</span>"</p>
                
                <div class="gate-puzzle">
                    <div class="puzzle-title">INNER RING (Center):</div>
                    <div class="puzzle-options">
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('moon')">MOON</div>
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('bat')">BAT</div>
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('wolf')">WOLF</div>
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('coffin')">COFFIN</div>
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('blood')">BLOOD DROP</div>
                    </div>
                    
                    <div class="puzzle-title" style="margin-top: 15px;">MIDDLE RING:</div>
                    <div class="puzzle-options">
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('moon')">MOON</div>
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('bat')">BAT</div>
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('wolf')">WOLF</div>
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('coffin')">COFFIN</div>
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('blood')">BLOOD DROP</div>
                    </div>
                    
                    <div class="puzzle-title" style="margin-top: 15px;">OUTER RING:</div>
                    <div class="puzzle-options">
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('moon')">MOON</div>
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('bat')">BAT</div>
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('wolf')">WOLF</div>
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('coffin')">COFFIN</div>
                        <div class="puzzle-option" onclick="selectPuzzleSymbol('blood')">BLOOD DROP</div>
                    </div>
                </div>
                
                <div id="puzzle-feedback" style="margin-top: 15px; padding: 10px; background-color: #221133; border: 1px solid #8040a0; display: none;">
                    <p>Current selection: <span id="puzzle-selection">None</span></p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="tryPuzzle()" id="try-puzzle-btn">TRY COMBINATION</button>
                <button class="action-btn" onclick="cancelPuzzle()">CANCEL (RETURN TO GATES)</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL 3 COMPLETE!</h2>
            <div class="story-text">
                <p>You have breached the Castle Gates! The massive iron doors groan open, revealing the courtyard beyond.</p>
                <p>The castle's interior is even more foreboding than the exterior. Torches flicker with unnatural green flame, casting dancing shadows on stone walls adorned with ancient tapestries.</p>
                <p>You can hear distant sounds echoing through the halls - the flutter of bat wings, faint whispers, and something that might be mournful singing.</p>
                <p>The vampire lord awaits somewhere within these walls. Your quest continues into the castle's keep.</p>
                <p>All your stats, gold, and inventory will carry over to Level 4.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #221133; border: 1px solid #8040a0;">
                    <h3 style="color: #c080ff; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">ENTER THE CASTLE - LEVEL 4: INSIDE THE KEEP</button>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE UNDEAD - A Retro Vampire Hunt Adventure<br>
            Level 3: The Castle Gates
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'gate':
                    playBeep(150, 0.5, 'sine');
                    setTimeout(() => playBeep(100, 0.5, 'sine'), 500);
                    break;
                case 'castle':
                    playBeep(200, 0.3, 'sawtooth');
                    setTimeout(() => playBeep(180, 0.3, 'sawtooth'), 300);
                    break;
                case 'puzzle':
                    playBeep(600, 0.1, 'square');
                    setTimeout(() => playBeep(700, 0.1, 'square'), 100);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - loaded from Level 2
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Rusty Sword',
            equippedArmor: 'Leather Armor',
            currentSection: 1,
            gameComplete: false,
            level: 3,
            // Level 3 specific flags
            gateGuardsDefeated: false,
            drawbridgeLowered: false,
            gargoylesAwakened: false,
            foundSecretEntrance: false,
            solvedGatePuzzle: false,
            gateOpened: false
        };
        
        // Gate puzzle state
        let puzzleState = {
            innerRing: '',
            middleRing: '',
            outerRing: '',
            attempts: 0
        };
        
        // Correct puzzle solution
        const puzzleSolution = {
            innerRing: 'coffin',
            middleRing: 'moon',
            outerRing: 'blood'
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1
        };
        
        // Game story sections for Level 3
        const storySections = {
            1: {
                text: "You stand before the massive gates of Castle Vorlak. The drawbridge is raised, and the moat below contains a dark, bubbling liquid that smells of sulfur and decay. Two stone gargoyles flank the gates, their eyes glowing faintly.",
                choices: [
                    {text: "Examine the drawbridge mechanism", nextSection: 2, skillCheck: false},
                    {text: "Inspect the gargoyles", nextSection: 3, skillCheck: false},
                    {text: "Search for another entrance", nextSection: 4, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Approach the gates directly", nextSection: 5, skillCheck: false}
                ]
            },
            2: {
                text: "The drawbridge mechanism is on your side of the moat. It consists of a large winch with a rusted chain. The winch looks like it hasn't been used in centuries, but might still work.",
                choices: [
                    {text: "Try to lower the drawbridge", nextSection: 6, skillCheck: true, checkType: 'strength', difficulty: 16},
                    {text: "Examine the chain more closely", nextSection: 7, skillCheck: false},
                    {text: "Return to the gates", nextSection: 1, skillCheck: false}
                ]
            },
            3: {
                text: "The gargoyles are intricately carved from black stone. Their eyes glow with a faint red light. As you approach, you notice they're not exactly symmetrical - one holds a sword, the other a shield.",
                choices: [
                    {text: "Touch the gargoyle with the sword", nextSection: 8, skillCheck: false},
                    {text: "Touch the gargoyle with the shield", nextSection: 9, skillCheck: false},
                    {text: "Examine them from a distance", nextSection: 10, skillCheck: false},
                    {text: "Return to the gates", nextSection: 1, skillCheck: false}
                ]
            },
            4: {
                text: "You search along the castle walls, looking for a hidden entrance or weak point.",
                choices: [
                    {text: "Continue searching", nextSection: 11, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.foundSecretEntrance = true;
                        playSound('success');
                        return "You find a hidden drainage tunnel partially concealed by ivy! It's small, but you might be able to squeeze through.";
                    } else {
                        playSound('failure');
                        return "You search the walls thoroughly but find no alternative entrance. The castle's defenses are formidable.";
                    }
                }
            },
            5: {
                text: "You approach the massive iron gates directly. As you get within ten feet, the gargoyles' eyes glow brighter, and they begin to move! Stone grinds against stone as they awaken.",
                choices: [
                    {text: "Prepare for combat!", nextSection: 12, skillCheck: false},
                    {text: "Try to communicate", nextSection: 13, skillCheck: false},
                    {text: "Retreat quickly", nextSection: 14, skillCheck: true, checkType: 'agility', difficulty: 12}
                ]
            },
            6: {
                text: "You grasp the winch handle and attempt to turn it. The mechanism is stiff with age and disuse.",
                choices: [
                    {text: "Continue trying to turn the winch", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.drawbridgeLowered = true;
                        playSound('success');
                        return "With a great heave, the winch turns! Chains rattle, and the drawbridge begins to lower with a loud groan. It settles across the moat with a thud.";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The winch won't budge! You strain against it and pull a muscle, taking " + damage + " damage.";
                    }
                }
            },
            7: {
                text: "The chain is thick and rusted, but you notice something odd - one of the links is made of silver, not iron. It's engraved with a symbol: a crescent moon.",
                choices: [
                    {text: "Examine the silver link", nextSection: 16, skillCheck: false},
                    {text: "Try the winch again", nextSection: 6, skillCheck: true, checkType: 'strength', difficulty: 14},
                    {text: "Return to the gates", nextSection: 1, skillCheck: false}
                ]
            },
            8: {
                text: "As you touch the gargoyle holding the sword, its eyes flare bright red! The statue animates, raising its stone sword menacingly.",
                choices: [
                    {text: "Fight the gargoyle", nextSection: 17, skillCheck: false},
                    {text: "Quickly retreat", nextSection: 18, skillCheck: true, checkType: 'agility', difficulty: 13}
                ]
            },
            9: {
                text: "You touch the gargoyle holding the shield. Its eyes glow blue instead of red, and it doesn't animate. Instead, a section of the wall beside it slides open, revealing a hidden alcove!",
                choices: [
                    {text: "Investigate the alcove", nextSection: 19, skillCheck: false},
                    {text: "Touch the other gargoyle", nextSection: 8, skillCheck: false}
                ]
            },
            10: {
                text: "From a distance, you notice something interesting about the gargoyles. The one with the sword has its eyes fixed on the gate, while the one with the shield seems to be looking at the ground near the wall.",
                choices: [
                    {text: "Touch the shield gargoyle", nextSection: 9, skillCheck: false},
                    {text: "Touch the sword gargoyle", nextSection: 8, skillCheck: false},
                    {text: "Return to the gates", nextSection: 1, skillCheck: false}
                ]
            },
            11: {
                text: "You've found a hidden drainage tunnel! It's dark and narrow, but it appears to lead under the castle walls.",
                choices: [
                    {text: "Enter the tunnel", nextSection: 20, skillCheck: false},
                    {text: "Return to the main gates", nextSection: 1, skillCheck: false}
                ]
            },
            12: {
                text: "Both gargoyles fully animate, stone wings spreading as they step down from their pedestals. They move with surprising speed for creatures of stone!",
                choices: [
                    {text: "Fight the guardian gargoyles", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Guardian Gargoyles (2)";
                    combatState.enemyHealth = 70;
                    combatState.enemyCurrentHealth = 70;
                    combatState.enemyStrength = 12;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 22;
                    combatState.round = 1;
                    
                    playSound('castle');
                    return "<span class='enemy'>Guardian Gargoyles (2)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            13: {
                text: "You hold up your hands in a peaceful gesture. \"I mean no harm. I seek audience with the lord of the castle,\" you say. The gargoyles pause, their glowing eyes studying you.",
                choices: [
                    {text: "Continue speaking", nextSection: 23, skillCheck: false},
                    {text: "Show a holy symbol if you have one", nextSection: 24, skillCheck: false, requirement: 'Silver Cross'},
                    {text: "Prepare to fight", nextSection: 12, skillCheck: false}
                ]
            },
            14: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 25, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You retreat quickly before the gargoyles fully animate. They return to their positions, eyes dimming.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You're not fast enough! One of the gargoyles strikes you as you retreat, dealing " + damage + " damage.";
                    }
                }
            },
            15: {
                text: "With the drawbridge lowered, you can now cross the moat safely. The gates themselves remain closed, but you're closer than ever.",
                choices: [
                    {text: "Cross the drawbridge", nextSection: 26, skillCheck: false},
                    {text: "Examine the gates up close", nextSection: 27, skillCheck: false}
                ]
            },
            16: {
                text: "The silver link is cool to the touch. The crescent moon symbol is exquisitely detailed. This might be important for opening the gates.",
                choices: [
                    {text: "Try to remove the silver link", nextSection: 28, skillCheck: false},
                    {text: "Leave it and try the winch", nextSection: 6, skillCheck: true, checkType: 'strength', difficulty: 12},
                    {text: "Return to the gates", nextSection: 1, skillCheck: false}
                ]
            },
            17: {
                text: "The sword gargoyle attacks! Its stone blade moves with surprising speed.",
                choices: [
                    {text: "Fight the gargoyle", nextSection: 29, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Sword Gargoyle";
                    combatState.enemyHealth = 40;
                    combatState.enemyCurrentHealth = 40;
                    combatState.enemyStrength = 11;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 30;
                    combatState.round = 1;
                    
                    playSound('castle');
                    return "<span class='enemy'>Sword Gargoyle</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            18: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 31, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You leap back just as the gargoyle's sword swings through where you were standing. It returns to its pedestal, eyes dimming.";
                    } else {
                        const damage = rollDice(1, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The gargoyle's sword clips you as you retreat, dealing " + damage + " damage.";
                    }
                }
            },
            19: {
                text: "Inside the alcove, you find a small chest. It's not locked, and inside are several interesting items.",
                choices: [
                    {text: "Take the contents", nextSection: 32, skillCheck: false},
                    {text: "Leave it and return to the gates", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    addToInventory('Silver Key');
                    addToInventory('Scroll of Stone to Flesh');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span>, a <span class='item'>Silver Key</span>, and a <span class='item'>Scroll of Stone to Flesh</span>!";
                }
            },
            20: {
                text: "The drainage tunnel is dark, damp, and cramped. You have to crawl on your hands and knees. After what feels like an eternity, you see light ahead.",
                choices: [
                    {text: "Continue through the tunnel", nextSection: 33, skillCheck: false},
                    {text: "Turn back", nextSection: 1, skillCheck: false}
                ]
            },
            21: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 34, skillCheck: false}
                ]
            },
            22: {
                text: "With the gargoyles defeated, the gates are unguarded. You approach them and examine the locking mechanism.",
                choices: [
                    {text: "Examine the gate mechanism", nextSection: 35, skillCheck: false},
                    {text: "Try to force the gates open", nextSection: 36, skillCheck: true, checkType: 'strength', difficulty: 20}
                ]
            },
            23: {
                text: "\"The master does not receive uninvited guests,\" a grinding, stone-like voice echoes in your mind. \"But you have passed the tests of forest and mountain. Perhaps you are... expected.\" The gargoyles step aside.",
                choices: [
                    {text: "Approach the gates", nextSection: 37, skillCheck: false}
                ]
            },
            24: {
                text: "You show your silver cross. The gargoyles hiss and step back. \"That symbol... it has power here. Very well. You may pass. But the master will not be so easily impressed.\"",
                choices: [
                    {text: "Approach the gates", nextSection: 37, skillCheck: false}
                ]
            },
            25: {
                text: "Back at a safe distance from the gates, you consider your next move.",
                choices: [
                    {text: "Try a different approach", nextSection: 1, skillCheck: false}
                ]
            },
            26: {
                text: "You cross the drawbridge. The dark liquid in the moat bubbles ominously below. Reaching the gates, you can now see the intricate carvings up close.",
                choices: [
                    {text: "Examine the gate carvings", nextSection: 38, skillCheck: false},
                    {text: "Look for a way to open the gates", nextSection: 35, skillCheck: false},
                    {text: "Knock on the gates", nextSection: 39, skillCheck: false}
                ]
            },
            27: {
                text: "Up close, the gates are even more imposing. The iron is cold to the touch, and the silver reinforcements gleam despite the lack of direct sunlight.",
                choices: [
                    {text: "Examine the locking mechanism", nextSection: 35, skillCheck: false},
                    {text: "Look for keyholes or openings", nextSection: 40, skillCheck: false},
                    {text: "Return to the drawbridge", nextSection: 15, skillCheck: false}
                ]
            },
            28: {
                text: "You manage to pry the silver link free. It comes off surprisingly easily, as if it was meant to be removed.",
                choices: [
                    {text: "Examine the link", nextSection: 41, skillCheck: false},
                    {text: "Try the winch now", nextSection: 42, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Silver Crescent Link');
                    playSound('item');
                    return "You now have a <span class='item'>Silver Crescent Link</span>. It might be useful for opening the gates.";
                }
            },
            29: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 43, skillCheck: false}
                ]
            },
            30: {
                text: "With the sword gargoyle defeated, you approach the gates. The shield gargoyle remains inactive, its eyes glowing a steady blue.",
                choices: [
                    {text: "Touch the shield gargoyle", nextSection: 9, skillCheck: false},
                    {text: "Examine the gates", nextSection: 35, skillCheck: false}
                ]
            },
            31: {
                text: "Having narrowly escaped the gargoyle, you return to a safer distance.",
                choices: [
                    {text: "Try a different approach", nextSection: 1, skillCheck: false}
                ]
            },
            32: {
                text: "With your newfound items, you return to the main gates.",
                choices: [
                    {text: "Examine the gates", nextSection: 35, skillCheck: false}
                ]
            },
            33: {
                text: "You emerge from the tunnel into a dank, dark chamber within the castle walls. You're inside! But this appears to be a storage cellar or dungeon area. A stone staircase leads upward.",
                choices: [
                    {text: "Ascend the staircase", nextSection: 44, skillCheck: false},
                    {text: "Explore the chamber", nextSection: 45, skillCheck: false}
                ]
            },
            34: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 21, skillCheck: false}
                ]
            },
            35: {
                text: "The gate mechanism is complex. In the center of the gates is a circular device with three concentric rings, each marked with different symbols. The rings can be rotated to align the symbols.",
                choices: [
                    {text: "Try to solve the puzzle", nextSection: 46, skillCheck: false},
                    {text: "Look for another way in", nextSection: 47, skillCheck: false},
                    {text: "Try the silver key if you have it", nextSection: 48, skillCheck: false, requirement: 'Silver Key'},
                    {text: "Try the silver crescent link if you have it", nextSection: 49, skillCheck: false, requirement: 'Silver Crescent Link'}
                ]
            },
            36: {
                text: "You put your shoulder to the massive gates and push with all your might...",
                choices: [
                    {text: "Continue", nextSection: 50, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "Incredibly, the gates groan open! You've forced them through sheer strength! The way into Castle Vorlak is open.";
                    } else {
                        const damage = rollDice(2, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        
                        if (gameState.health <= 0) {
                            return "The gates don't budge, and you strain yourself terribly, taking " + damage + " fatal damage!";
                        } else {
                            return "The gates are immovable. You strain against them and injure yourself, taking " + damage + " damage.";
                        }
                    }
                }
            },
            37: {
                text: "With the gargoyles' permission, you approach the gates. They remain closed, but now you can examine them without threat of attack.",
                choices: [
                    {text: "Examine the gate mechanism", nextSection: 35, skillCheck: false}
                ]
            },
            38: {
                text: "The carvings depict scenes of ancient battles, vampires feasting, and dark rituals. One recurring motif is a noble-looking vampire wearing a crown - likely Valerius himself.",
                choices: [
                    {text: "Examine the locking mechanism", nextSection: 35, skillCheck: false},
                    {text: "Look for hidden switches or levers", nextSection: 51, skillCheck: true, checkType: 'agility', difficulty: 15}
                ]
            },
            39: {
                text: "You knock firmly on the gates. The sound echoes hollowly. After a moment, a small viewing slit opens at eye level. A pair of glowing red eyes peers out at you.",
                choices: [
                    {text: "\"I seek audience with Lord Valerius\"", nextSection: 52, skillCheck: false},
                    {text: "Attack through the viewing slit", nextSection: 53, skillCheck: false},
                    {text: "Step back and prepare for combat", nextSection: 54, skillCheck: false}
                ]
            },
            40: {
                text: "You find three keyholes arranged in a triangle pattern. They're shaped differently: one crescent-shaped, one star-shaped, and one shaped like a droplet.",
                choices: [
                    {text: "Try the silver key", nextSection: 48, skillCheck: false, requirement: 'Silver Key'},
                    {text: "Examine the puzzle mechanism", nextSection: 35, skillCheck: false},
                    {text: "Return to the drawbridge", nextSection: 15, skillCheck: false}
                ]
            },
            41: {
                text: "The silver crescent link is beautifully crafted. The crescent moon symbol is identical to the one on the gate mechanism.",
                choices: [
                    {text: "Try it on the gate mechanism", nextSection: 49, skillCheck: false},
                    {text: "Keep it for now", nextSection: 1, skillCheck: false}
                ]
            },
            42: {
                text: "With the silver link removed, the winch turns easily! The drawbridge lowers smoothly.",
                choices: [
                    {text: "Cross the drawbridge", nextSection: 26, skillCheck: false}
                ],
                action: function() {
                    gameState.drawbridgeLowered = true;
                    playSound('success');
                    return "The drawbridge lowers! Removing the silver link was the key.";
                }
            },
            43: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 29, skillCheck: false}
                ]
            },
            44: {
                text: "You ascend the staircase and emerge into a dimly lit corridor. Torches in sconces burn with green flame. You can hear distant footsteps echoing.",
                choices: [
                    {text: "Proceed cautiously down the corridor", nextSection: 55, skillCheck: false},
                    {text: "Hide and listen", nextSection: 56, skillCheck: true, checkType: 'agility', difficulty: 12}
                ]
            },
            45: {
                text: "The chamber is filled with crates, barrels, and old furniture covered in dust. You search through the debris.",
                choices: [
                    {text: "Search thoroughly", nextSection: 57, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(2, 8);
                    gameState.gold += goldFound;
                    addToInventory('Castle Servant Uniform');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Castle Servant Uniform</span> that might help you blend in.";
                }
            },
            46: {
                text: "The puzzle mechanism has three rings with five symbols each: Moon, Bat, Wolf, Coffin, and Blood Drop. They need to be aligned in the correct sequence.",
                choices: [
                    {text: "Attempt to solve the puzzle", nextSection: 58, skillCheck: false},
                    {text: "Look for clues", nextSection: 59, skillCheck: false},
                    {text: "Try a different approach", nextSection: 47, skillCheck: false}
                ]
            },
            47: {
                text: "You look for another way to bypass the gates.",
                choices: [
                    {text: "Search for hidden passages", nextSection: 60, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Try to climb the walls", nextSection: 61, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Return to the puzzle", nextSection: 46, skillCheck: false}
                ]
            },
            48: {
                text: "You try the silver key in the crescent-shaped keyhole. It fits perfectly! With a satisfying click, the gates unlock and begin to open.",
                choices: [
                    {text: "Enter the castle", nextSection: 62, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Silver Key');
                    playSound('success');
                    return "The <span class='item'>Silver Key</span> unlocks the gates! They swing open with a deep groan.";
                }
            },
            49: {
                text: "You place the silver crescent link into the crescent-shaped depression on the gate mechanism. It fits perfectly and begins to glow.",
                choices: [
                    {text: "Rotate the rings", nextSection: 63, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Silver Crescent Link');
                    playSound('item');
                    return "The <span class='item'>Silver Crescent Link</span> activates the mechanism! The rings now turn easily.";
                }
            },
            50: {
                text: "Whether you succeeded or failed in forcing the gates, you now stand before them.",
                choices: [
                    {text: "Examine the mechanism", nextSection: 35, skillCheck: false}
                ]
            },
            51: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 64, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        addToInventory('Hidden Lever');
                        playSound('success');
                        return "You find a hidden lever disguised as part of the carving! Pulling it might open the gates.";
                    } else {
                        playSound('failure');
                        return "You search thoroughly but find no hidden mechanisms.";
                    }
                }
            },
            52: {
                text: "\"The master is... occupied,\" a raspy voice replies. \"But he did say to expect a visitor. Very well. The gates will open. Enter at your own peril.\" The viewing slit closes, and the gates begin to open.",
                choices: [
                    {text: "Enter the castle", nextSection: 62, skillCheck: false}
                ]
            },
            53: {
                text: "You thrust your weapon through the viewing slit! There's a gurgling cry, and then silence. After a moment, the gates begin to open slowly, seemingly of their own accord.",
                choices: [
                    {text: "Enter cautiously", nextSection: 65, skillCheck: false}
                ]
            },
            54: {
                text: "As you step back, the gates swing open suddenly! Two armored skeletons charge out, weapons raised!",
                choices: [
                    {text: "Fight the skeleton guards", nextSection: 66, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Skeleton Guards (2)";
                    combatState.enemyHealth = 50;
                    combatState.enemyCurrentHealth = 50;
                    combatState.enemyStrength = 10;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 67;
                    combatState.round = 1;
                    
                    playSound('castle');
                    return "<span class='enemy'>Skeleton Guards (2)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            55: {
                text: "You proceed down the corridor. It's eerily silent except for the crackling of the green torches. Ahead, you see a junction.",
                choices: [
                    {text: "Go left", nextSection: 68, skillCheck: false},
                    {text: "Go right", nextSection: 69, skillCheck: false},
                    {text: "Continue straight", nextSection: 70, skillCheck: false}
                ]
            },
            56: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 71, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You hear footsteps approaching from the left passage. You hide in a shadowy alcove as two skeleton guards march past, unaware of your presence.";
                    } else {
                        playSound('failure');
                        return "You're not quiet enough! The skeleton guards hear you and attack!";
                    }
                }
            },
            57: {
                text: "After searching the chamber, you decide to ascend the staircase.",
                choices: [
                    {text: "Ascend the staircase", nextSection: 44, skillCheck: false}
                ]
            },
            58: {
                text: "You study the puzzle mechanism. The rings need to be aligned in a specific sequence. What could it be?",
                choices: [],
                action: function() {
                    showScreen('screen-puzzle');
                    return "";
                }
            },
            59: {
                text: "You search for clues around the gates. In the stonework near the gargoyles, you find an inscription: 'By night he rules, by day he rests, his thirst eternal, never suppressed.'",
                choices: [
                    {text: "Attempt the puzzle with this clue", nextSection: 58, skillCheck: false},
                    {text: "Search for more clues", nextSection: 72, skillCheck: false}
                ]
            },
            60: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 73, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.foundSecretEntrance = true;
                        playSound('success');
                        return "You find a loose stone that reveals a hidden passage! It leads into the castle walls.";
                    } else {
                        playSound('failure');
                        return "You find no hidden passages. The gates are the only obvious entrance.";
                    }
                }
            },
            61: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 74, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(1, 10);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        playSound('success');
                        return "You manage to climb to a high window! Inside, you find a small room with <span class='gold'>" + goldFound + " Gold</span> on a table.";
                    } else {
                        const damage = rollDice(3, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        
                        if (gameState.health <= 0) {
                            return "You fall from the wall, taking " + damage + " fatal damage!";
                        } else {
                            return "You slip and fall, taking " + damage + " damage. Climbing the walls is too dangerous.";
                        }
                    }
                }
            },
            62: {
                text: "The gates swing open fully, revealing a courtyard beyond. Torches flicker with green flame, casting eerie shadows. The castle's inner keep looms ahead.",
                choices: [
                    {text: "Enter the courtyard", nextSection: 75, skillCheck: false}
                ]
            },
            63: {
                text: "With the mechanism activated, the rings turn easily. Now to solve the puzzle.",
                choices: [
                    {text: "Attempt the puzzle", nextSection: 58, skillCheck: false}
                ]
            },
            64: {
                text: "You've found a hidden lever! Pulling it might open the gates.",
                choices: [
                    {text: "Pull the lever", nextSection: 76, skillCheck: false}
                ]
            },
            65: {
                text: "You enter cautiously. The gatekeeper lies dead by the door, a pool of dark liquid spreading around him. The courtyard beyond is empty.",
                choices: [
                    {text: "Proceed into the courtyard", nextSection: 75, skillCheck: false}
                ]
            },
            66: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 77, skillCheck: false}
                ]
            },
            67: {
                text: "With the skeleton guards defeated, the gates stand open. The courtyard beyond beckons.",
                choices: [
                    {text: "Enter the courtyard", nextSection: 75, skillCheck: false}
                ]
            },
            68: {
                text: "The left passage leads to a kitchen area. It's deserted, but fresh blood stains one of the tables. A door leads further into the castle.",
                choices: [
                    {text: "Search the kitchen", nextSection: 78, skillCheck: false},
                    {text: "Continue through the door", nextSection: 79, skillCheck: false},
                    {text: "Return to the junction", nextSection: 55, skillCheck: false}
                ]
            },
            69: {
                text: "The right passage leads to a barracks room. Empty armor stands in rows, and the air smells of rust and decay. A staircase leads upward.",
                choices: [
                    {text: "Search the barracks", nextSection: 80, skillCheck: false},
                    {text: "Ascend the staircase", nextSection: 81, skillCheck: false},
                    {text: "Return to the junction", nextSection: 55, skillCheck: false}
                ]
            },
            70: {
                text: "Continuing straight, you reach a large wooden door. It's slightly ajar, and you can see torchlight beyond.",
                choices: [
                    {text: "Enter through the door", nextSection: 82, skillCheck: false},
                    {text: "Listen at the door", nextSection: 83, skillCheck: false},
                    {text: "Return to the junction", nextSection: 55, skillCheck: false}
                ]
            },
            71: {
                text: "After the guards pass, you continue down the corridor.",
                choices: [
                    {text: "Go to the junction", nextSection: 55, skillCheck: false}
                ]
            },
            72: {
                text: "You find another inscription near the drawbridge mechanism: 'Three phases of the night, three aspects of his might.'",
                choices: [
                    {text: "Attempt the puzzle", nextSection: 58, skillCheck: false}
                ]
            },
            73: {
                text: "You've found a secret passage! It leads into the castle walls.",
                choices: [
                    {text: "Enter the passage", nextSection: 20, skillCheck: false}
                ]
            },
            74: {
                text: "After your climbing attempt, you return to the gates.",
                choices: [
                    {text: "Examine the gate mechanism", nextSection: 35, skillCheck: false}
                ]
            },
            75: {
                text: "YOU HAVE ENTERED CASTLE VORLAK! The courtyard is vast, with a central fountain that runs with dark liquid instead of water. The main keep stands before you, its doors massive and foreboding.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 4;
                    saveGame();
                    
                    return "";
                }
            },
            76: {
                text: "You pull the lever. With a grinding sound, the gates begin to open!",
                choices: [
                    {text: "Enter the castle", nextSection: 62, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Hidden Lever');
                    playSound('success');
                    return "The hidden lever opens the gates!";
                }
            },
            77: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 66, skillCheck: false}
                ]
            },
            78: {
                text: "You search the kitchen. Among the usual kitchen implements, you find a large silver knife and some preserved food that might still be edible.",
                choices: [
                    {text: "Take the items", nextSection: 84, skillCheck: false},
                    {text: "Continue through the door", nextSection: 79, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Silver Kitchen Knife');
                    addToInventory('Preserved Meat');
                    playSound('item');
                    return "You find a <span class='item'>Silver Kitchen Knife</span> and some <span class='item'>Preserved Meat</span>.";
                }
            },
            79: {
                text: "The door from the kitchen leads to a dining hall. A long table is set for a feast, but the food has long since rotted. At the far end, double doors lead to what might be the main hall.",
                choices: [
                    {text: "Enter the dining hall", nextSection: 85, skillCheck: false},
                    {text: "Return to the kitchen", nextSection: 68, skillCheck: false}
                ]
            },
            80: {
                text: "Searching the barracks, you find some useful items in a footlocker.",
                choices: [
                    {text: "Take the items", nextSection: 86, skillCheck: false},
                    {text: "Ascend the staircase", nextSection: 81, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(2, 10);
                    gameState.gold += goldFound;
                    addToInventory('Chainmail Shirt');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Chainmail Shirt</span> that could provide better protection.";
                }
            },
            81: {
                text: "You ascend the staircase and emerge in a guard tower. From here, you can see the entire courtyard and the gates you entered through. Another staircase leads back down into the keep.",
                choices: [
                    {text: "Descend into the keep", nextSection: 87, skillCheck: false},
                    {text: "Return to the barracks", nextSection: 69, skillCheck: false}
                ]
            },
            82: {
                text: "You enter a grand hall. Tapestries depicting vampire lords line the walls, and a red carpet leads to a throne at the far end. The throne is empty.",
                choices: [
                    {text: "Approach the throne", nextSection: 88, skillCheck: false},
                    {text: "Examine the tapestries", nextSection: 89, skillCheck: false},
                    {text: "Return to the corridor", nextSection: 70, skillCheck: false}
                ]
            },
            83: {
                text: "You listen at the door. You can hear faint music - a mournful melody played on some stringed instrument.",
                choices: [
                    {text: "Enter cautiously", nextSection: 82, skillCheck: false},
                    {text: "Return to the junction", nextSection: 55, skillCheck: false}
                ]
            },
            84: {
                text: "With your new items, you continue through the door.",
                choices: [
                    {text: "Enter the dining hall", nextSection: 85, skillCheck: false}
                ]
            },
            85: {
                text: "The dining hall is vast and eerie. At the far end, double doors stand partially open, revealing the courtyard beyond. You've found another way to the main castle!",
                choices: [
                    {text: "Enter the courtyard", nextSection: 75, skillCheck: false}
                ]
            },
            86: {
                text: "With your new items, you ascend the staircase.",
                choices: [
                    {text: "Ascend to the guard tower", nextSection: 81, skillCheck: false}
                ]
            },
            87: {
                text: "Descending from the guard tower, you find yourself in a different part of the keep. You hear music coming from a nearby room.",
                choices: [
                    {text: "Follow the music", nextSection: 90, skillCheck: false},
                    {text: "Search for the courtyard", nextSection: 91, skillCheck: false}
                ]
            },
            88: {
                text: "As you approach the throne, the doors behind you slam shut! A voice echoes through the hall: 'So, the hunter has entered the lion's den.'",
                choices: [
                    {text: "Prepare for combat", nextSection: 92, skillCheck: false},
                    {text: "Answer the voice", nextSection: 93, skillCheck: false}
                ]
            },
            89: {
                text: "The tapestries show the history of the vampire lords. One in particular shows Valerius defeating a group of knights who look remarkably like your order, if you are a knight.",
                choices: [
                    {text: "Continue examining", nextSection: 94, skillCheck: false},
                    {text: "Approach the throne", nextSection: 88, skillCheck: false}
                ]
            },
            90: {
                text: "You follow the music to a room where a ghostly figure plays a violin. It doesn't seem to notice you.",
                choices: [
                    {text: "Approach the musician", nextSection: 95, skillCheck: false},
                    {text: "Leave quietly", nextSection: 96, skillCheck: false}
                ]
            },
            91: {
                text: "You search for the courtyard and eventually find a door that leads outside. You're in the castle courtyard!",
                choices: [
                    {text: "Enter the courtyard", nextSection: 75, skillCheck: false}
                ]
            },
            92: {
                text: "From the shadows steps a tall figure in elegant black robes - a VAMPIRE NOBLE!",
                choices: [
                    {text: "Fight the vampire noble", nextSection: 97, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Vampire Noble";
                    combatState.enemyHealth = 80;
                    combatState.enemyCurrentHealth = 80;
                    combatState.enemyStrength = 14;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 98;
                    combatState.round = 1;
                    
                    playSound('castle');
                    return "<span class='vampire'>Vampire Noble</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            93: {
                text: "\"I seek Valerius,\" you say. The voice laughs. \"The master is not receiving guests. But I, Lord Silas, shall entertain you in his stead.\" A vampire noble steps from the shadows.",
                choices: [
                    {text: "Fight Lord Silas", nextSection: 97, skillCheck: false},
                    {text: "Try to negotiate", nextSection: 99, skillCheck: false}
                ]
            },
            94: {
                text: "Another tapestry shows Valerius being struck by sunlight and turning to ash, only to reform from shadow. It seems he cannot be permanently destroyed by conventional means.",
                choices: [
                    {text: "Approach the throne", nextSection: 88, skillCheck: false}
                ]
            },
            95: {
                text: "As you approach, the ghostly musician turns to face you. \"Welcome, living one,\" it says in a whispery voice. \"The master awaits in the throne room. Follow the red carpet.\"",
                choices: [
                    {text: "Thank the ghost and follow its directions", nextSection: 100, skillCheck: false},
                    {text: "Attack the ghost", nextSection: 101, skillCheck: false}
                ]
            },
            96: {
                text: "You leave the musician undisturbed and continue searching for the courtyard.",
                choices: [
                    {text: "Search for the courtyard", nextSection: 91, skillCheck: false}
                ]
            },
            97: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 102, skillCheck: false}
                ]
            },
            98: {
                text: "With the vampire noble defeated, the doors unlock. You can now access the courtyard through a side entrance.",
                choices: [
                    {text: "Enter the courtyard", nextSection: 75, skillCheck: false}
                ]
            },
            99: {
                text: "\"I have no quarrel with you,\" you say. \"I seek only Valerius.\" The vampire noble smiles coldly. \"Then we do have a quarrel. No one disturbs the master's rest.\" He attacks!",
                choices: [
                    {text: "Fight Lord Silas", nextSection: 97, skillCheck: false}
                ]
            },
            100: {
                text: "You follow the red carpet as directed. It leads through several rooms before finally emerging into the castle courtyard.",
                choices: [
                    {text: "Enter the courtyard", nextSection: 75, skillCheck: false}
                ]
            },
            101: {
                text: "You attack the ghost, but your weapon passes through it harmlessly. The ghost laughs. \"Foolish mortal. You cannot harm what is already dead. Now leave me to my music.\"",
                choices: [
                    {text: "Leave", nextSection: 96, skillCheck: false}
                ]
            },
            102: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 97, skillCheck: false}
                ]
            }
        };
        
        // Initialize game for Level 3
        function initGame() {
            // Load game state from Level 2
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 3 (coming from Level 2)
                if (savedState.level === 3) {
                    Object.assign(gameState, savedState);
                    
                    // Update intro screen with loaded stats
                    document.getElementById('intro-stat-strength').textContent = gameState.strength;
                    document.getElementById('intro-stat-health').textContent = gameState.health;
                    document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('intro-stat-agility').textContent = gameState.agility;
                    document.getElementById('intro-stat-gold').textContent = gameState.gold;
                    
                    showScreen('screen-intro');
                    return;
                } else if (savedState.level === 2) {
                    // If coming directly from Level 2 without completing it
                    alert("You must complete Level 2 first!");
                    window.location.href = 'l2.html';
                    return;
                }
            } else {
                // No saved game found
                alert("No saved game found. Starting from Level 1.");
                window.location.href = 'level1.html';
                return;
            }
        }
        
        function startLevel3() {
            playSound('click');
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item)) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Gate puzzle functions
        function selectPuzzleSymbol(symbol) {
            playSound('puzzle');
            
            // Update selection based on which rings have been selected
            if (puzzleState.innerRing === '') {
                puzzleState.innerRing = symbol;
            } else if (puzzleState.middleRing === '') {
                puzzleState.middleRing = symbol;
            } else if (puzzleState.outerRing === '') {
                puzzleState.outerRing = symbol;
            } else {
                // All rings selected, start over
                puzzleState.innerRing = symbol;
                puzzleState.middleRing = '';
                puzzleState.outerRing = '';
            }
            
            // Update display
            let selectionText = '';
            if (puzzleState.innerRing) selectionText += `Inner: ${puzzleState.innerRing.toUpperCase()} `;
            if (puzzleState.middleRing) selectionText += `Middle: ${puzzleState.middleRing.toUpperCase()} `;
            if (puzzleState.outerRing) selectionText += `Outer: ${puzzleState.outerRing.toUpperCase()}`;
            
            document.getElementById('puzzle-selection').textContent = selectionText || 'None';
            document.getElementById('puzzle-feedback').style.display = 'block';
            
            // Enable try button when all rings are selected
            if (puzzleState.innerRing && puzzleState.middleRing && puzzleState.outerRing) {
                document.getElementById('try-puzzle-btn').disabled = false;
            }
        }
        
        function tryPuzzle() {
            playSound('puzzle');
            puzzleState.attempts++;
            
            const correctInner = (puzzleState.innerRing === puzzleSolution.innerRing);
            const correctMiddle = (puzzleState.middleRing === puzzleSolution.middleRing);
            const correctOuter = (puzzleState.outerRing === puzzleSolution.outerRing);
            
            if (correctInner && correctMiddle && correctOuter) {
                // Puzzle solved!
                playSound('success');
                gameState.solvedGatePuzzle = true;
                showScreen('screen-game');
                loadSection(62); // Gates open
                
                // Reset puzzle
                puzzleState.innerRing = '';
                puzzleState.middleRing = '';
                puzzleState.outerRing = '';
                puzzleState.attempts = 0;
            } else {
                // Puzzle failed
                playSound('failure');
                let feedback = "The mechanism rumbles but doesn't unlock. ";
                
                if (correctInner) feedback += "The inner ring seems correct. ";
                if (correctMiddle) feedback += "The middle ring seems correct. ";
                if (correctOuter) feedback += "The outer ring seems correct. ";
                
                if (!correctInner && !correctMiddle && !correctOuter) {
                    feedback += "None of the rings are in the correct position.";
                }
                
                document.getElementById('story-text').innerHTML = `<p>${feedback}</p><div class='blinking-cursor'></div>`;
                
                // Reset for another attempt
                puzzleState.innerRing = '';
                puzzleState.middleRing = '';
                puzzleState.outerRing = '';
                document.getElementById('try-puzzle-btn').disabled = true;
                document.getElementById('puzzle-feedback').style.display = 'none';
            }
        }
        
        function cancelPuzzle() {
            playSound('click');
            showScreen('screen-game');
            loadSection(35); // Return to gate mechanism
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Potion' || item === 'Mountain Potion') {
                const healAmount = item === 'Mountain Potion' ? rollDice(3, 6) + 10 : rollDice(2, 6) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Preserved Meat' || item === 'Goat Cheese' || item === 'Iron Rations') {
                const healAmount = rollDice(2, 6);
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You eat the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Scroll of Stone to Flesh') {
                message = "The <span class='item'>Scroll of Stone to Flesh</span> contains powerful magic that could reverse petrification. It might be useful against stone creatures.";
            } else if (item === 'Silver Cross') {
                message = "The <span class='item'>Silver Cross</span> glows with holy energy. It might repel undead creatures.";
            } else if (item === 'Chainmail Shirt') {
                gameState.equippedArmor = 'Chainmail Shirt';
                updateInventoryDisplay();
                message = "You equip the <span class='item'>Chainmail Shirt</span>. It offers better protection than your current armor.";
            } else if (item === 'Silver Kitchen Knife') {
                gameState.equippedWeapon = 'Silver Kitchen Knife';
                updateInventoryDisplay();
                message = "You equip the <span class='item'>Silver Kitchen Knife</span>. Silver weapons are effective against vampires.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Sword' && 
                gameState.equippedArmor === 'Leather Armor') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor})" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 21 || sectionId === 29 || sectionId === 34 || sectionId === 43 || 
                                   sectionId === 66 || sectionId === 77 || sectionId === 97 || sectionId === 102);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    const goldReward = Math.floor(Math.random() * 30) + 20;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find <span class="gold">${goldReward} Gold</span> on the remains.`;
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue examining the gates";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                let weaponType = gameState.equippedWeapon;
                
                if (weaponType.includes('Silver')) {
                    // Silver weapons deal extra damage to undead/vampires
                    damage = rollDice(2, 6) + 3;
                    if (combatState.enemyName.includes('Vampire')) {
                        damage += 5; // Extra vs vampires
                        resultText += `<span class="item">Your silver weapon is especially effective!</span><br>`;
                    }
                } else if (weaponType === 'Ice Axe') {
                    damage = rollDice(2, 6) + 2;
                } else if (weaponType === 'Ancient Bone Dagger') {
                    damage = rollDice(2, 6) + 1;
                } else {
                    damage = rollDice(2, 6);
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                const enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('castleUndeadGameState');
                        window.location.href = 'level1.html';
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You find a hidden path around an obstacle!",
                    "You dodge a trap!",
                    "You move silently past a guard."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip and take 3 damage!",
                    "You make noise and alert nearby guards.",
                    "You get tangled in vines or debris."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 3;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 3 (this page)
                if (savedState.level === 3) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 3.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 4 with updated level
            gameState.level = 4;
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            // Redirect to level 4 (Inside the Keep)
            window.location.href = 'l4.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
