<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHAMBERS OF FEAR - Level 3: The Fungal Cavern</title>
    <style>
        /* Retro 80s DOS computer style - Green/Yellow/White/Black theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #0f0;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(0, 20, 0, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 20, 0, 0.3) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #0f0;
            background-color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 20, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #0f0;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            color: #ff0;
            text-shadow: 0 0 5px #ff0;
            font-size: 32px;
            margin: 10px 0;
            letter-spacing: 3px;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        h2 {
            color: #fff;
            border-bottom: 1px solid #0f0;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
        }
        
        .level-number.completed {
            background-color: #220;
            color: #ff0;
            border-color: #ff0;
        }
        
        .level-number.current {
            background-color: #0f0;
            color: #000;
            border-color: #ff0;
            box-shadow: 0 0 8px #0f0;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #ff0;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #ff0;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #0f0;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #ff0;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "âœ“";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff0;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #111;
            border: 1px solid #0f0;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #ff0;
            border-color: #ff0;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #0f0;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #ff0;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #ff0;
            border-color: #ff0;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #112211;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ff0;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #221100;
            border: 1px solid #ff0;
            padding: 10px;
            margin: 10px 0;
            color: #ff0;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f00;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f00;
        }
        
        .success {
            color: #0f0;
            font-weight: bold;
        }
        
        .damage {
            color: #f00;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9900;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #0ff;
            font-weight: bold;
        }
        
        .warning {
            color: #ff0;
            font-weight: bold;
        }
        
        .poison {
            color: #af0;
            font-weight: bold;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #113311;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 15px 30px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #0f0;
            color: #000;
            border-color: #ff0;
            box-shadow: 0 0 15px #0f0;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color = #0f0;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #0f0;
            color: #0f0;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
        }
        
        .sound-toggle:hover {
            background: #222;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CHAMBERS OF FEAR</h1>
            <h2>LEVEL 3: THE FUNGAL CAVERN</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number completed">2</div>
            <div class="level-number current">3</div>
            <div class="level-number">4</div>
            <div class="level-number">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">SKILL:</span> <span id="stat-skill" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">STAMINA:</span> <span id="stat-stamina" class="stat-value">0</span>/<span id="stat-maxstamina" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">LUCK:</span> <span id="stat-luck" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/10</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>CHAMBER 3: THE FUNGAL CAVERN</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useLuck()">TEST LUCK</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL COMPLETE!</h2>
            <div class="story-text">
                <p>You have survived the Fungal Cavern of the Chambers of Fear!</p>
                <p>Beyond the chamber, you find a winding staircase leading upward. The air grows slightly warmer and drier as you ascend.</p>
                <p>Your journey continues into Chamber 4... All your stats, gold, and inventory will carry over.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">SKILL:</span> <span id="next-stat-skill" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">STAMINA:</span> <span id="next-stat-stamina" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">LUCK:</span> <span id="next-stat-luck" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO CHAMBER 4</button>
            </div>
        </div>
        
        <div class="footer">
            CHAMBERS OF FEAR - A Retro Gamebook Adventure<br>
            Level 3: The Fungal Cavern
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects using the beep generator
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    // Multiple beeps for dice roll
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    // Ascending beeps for level completion
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'trap':
                    playBeep(150, 0.3, 'sawtooth');
                    break;
                case 'poison':
                    playBeep(100, 0.4, 'sawtooth');
                    break;
                case 'heal':
                    playBeep(700, 0.3, 'sine');
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            // Play a test sound when turning on
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - loaded from localStorage
        const gameState = {
            playerClass: '',
            skill: 0,
            maxStamina: 0,
            stamina: 0,
            luck: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Rusty Dagger',
            equippedArmor: 'Leather Tunic',
            currentSection: 1,
            gameComplete: false,
            level: 3,
            persistentItems: [],
            // Level 3 specific state
            sporesEncountered: false,
            giantSpiderDefeated: false,
            cureFound: false,
            bridgeCrossed: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyStamina: 0,
            enemyCurrentStamina: 0,
            enemySkill: 0,
            nextSection: 0,
            round: 1
        };
        
        // Game story sections for Level 3
        const storySections = {
            1: {
                text: "You enter a vast cavern illuminated by thousands of bioluminescent fungi. The air is thick with the scent of damp earth and decay. Strange mushrooms of all sizes and colors cover every surface. The ground is soft with moss, and you can hear water dripping somewhere in the distance. The chamber is divided by a deep chasm with a rickety-looking rope bridge spanning it.",
                choices: [
                    {text: "Examine the glowing fungi", nextSection: 2, skillCheck: false},
                    {text: "Approach the rope bridge cautiously", nextSection: 3, skillCheck: false},
                    {text: "Search for a safe path around the chasm", nextSection: 4, skillCheck: true, checkType: 'skill', difficulty: 11}
                ]
            },
            2: {
                text: "The fungi emit a soft, pulsating light. Some are small and delicate, others are as large as trees. You notice several types: blue ones that seem to pulse in rhythm, red ones with a sweet smell, and purple ones that release puffs of sparkling spores when touched. A particularly large mushroom has what looks like a door carved into its stem.",
                choices: [
                    {text: "Touch the purple mushroom to see the spores", nextSection: 5, skillCheck: false},
                    {text: "Investigate the mushroom with the door", nextSection: 6, skillCheck: false},
                    {text: "Collect some of the red mushrooms", nextSection: 7, skillCheck: false},
                    {text: "Return to examining the bridge", nextSection: 3, skillCheck: false}
                ]
            },
            3: {
                text: "The rope bridge spans a deep chasm. You can't see the bottom. The bridge looks old and poorly maintained - some planks are missing, and the ropes are frayed. On the other side, you can see a large stone door. Something large and shadowy moves among the fungi on the far side.",
                choices: [
                    {text: "Test the bridge's stability", nextSection: 8, skillCheck: false},
                    {text: "Cross the bridge carefully", nextSection: 9, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Look for another way across", nextSection: 4, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Call out to see if anything responds", nextSection: 10, skillCheck: false}
                ]
            },
            4: {
                text: "You search for an alternative route around the chasm...",
                choices: [
                    {text: "Continue", nextSection: 11, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You find a narrow ledge along the cavern wall! It's treacherous but might allow you to bypass the bridge entirely.";
                    } else {
                        playSound('failure');
                        return "The chasm seems to stretch the entire width of the cavern. The bridge appears to be the only way across.";
                    }
                }
            },
            5: {
                text: "You touch the purple mushroom. It releases a cloud of sparkling spores that swirl around you. The spores have a sweet, cloying smell that makes you feel lightheaded.",
                choices: [
                    {text: "Inhale deeply to see what happens", nextSection: 12, skillCheck: false},
                    {text: "Hold your breath and back away", nextSection: 13, skillCheck: true, checkType: 'skill', difficulty: 9},
                    {text: "Cover your mouth and examine further", nextSection: 14, skillCheck: false}
                ]
            },
            6: {
                text: "The mushroom door is intricately carved with symbols. It's about four feet high and appears to be functional. There's no handle, but there's a circular indentation in the center that might be a lock of some kind.",
                choices: [
                    {text: "Try to open the door", nextSection: 15, skillCheck: false},
                    {text: "Look for a key or mechanism", nextSection: 16, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Knock on the door", nextSection: 17, skillCheck: false}
                ]
            },
            7: {
                text: "You carefully collect some of the sweet-smelling red mushrooms. They're firm and cool to the touch.",
                choices: [
                    {text: "Taste a small piece", nextSection: 18, skillCheck: false},
                    {text: "Put them in your inventory for later", nextSection: 19, skillCheck: false},
                    {text: "Examine them more closely", nextSection: 20, skillCheck: false}
                ]
            },
            8: {
                text: "You test the bridge's stability by putting weight on the first few planks. They creak alarmingly but hold. The ropes groan under the strain. You notice some of the planks are rotten through.",
                choices: [
                    {text: "Attempt to repair the bridge with materials", nextSection: 21, skillCheck: false},
                    {text: "Cross anyway, avoiding bad planks", nextSection: 22, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Look for materials to make repairs", nextSection: 23, skillCheck: false}
                ]
            },
            9: {
                text: "You attempt to cross the rickety bridge...",
                choices: [
                    {text: "Continue", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.bridgeCrossed = true;
                        playSound('success');
                        return "You cross the bridge with careful precision, stepping only on secure planks and holding tightly to the ropes. You make it safely to the other side!";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        
                        if (gameState.stamina <= 0) {
                            return "A plank breaks beneath you! You fall into the chasm, taking " + damage + " damage from the impact. Everything goes black.";
                        } else {
                            return "A plank breaks beneath you! You barely catch yourself on the ropes, dangling over the chasm before pulling yourself up. You take " + damage + " damage from the strain.";
                        }
                    }
                }
            },
            10: {
                text: "You call out into the cavern. Your voice echoes strangely. From the far side of the chasm, you hear a chittering sound and see multiple glowing eyes appear in the darkness. Something is definitely over there.",
                choices: [
                    {text: "Prepare for possible combat", nextSection: 25, skillCheck: false},
                    {text: "Stay quiet and observe", nextSection: 26, skillCheck: true, checkType: 'skill', difficulty: 8},
                    {text: "Throw something to distract whatever it is", nextSection: 27, skillCheck: false}
                ]
            },
            11: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Attempt to cross via the ledge", nextSection: 28, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Return to the bridge", nextSection: 3, skillCheck: false}
                ]
            },
            12: {
                text: "You inhale the sparkling spores deeply. They taste sweet but leave a bitter aftertaste. Almost immediately, you feel strange - your vision blurs, and you feel dizzy and nauseated.",
                choices: [
                    {text: "Try to fight off the effects", nextSection: 29, skillCheck: true, checkType: 'stamina', difficulty: 10},
                    {text: "Search for an antidote among the fungi", nextSection: 30, skillCheck: false}
                ],
                action: function() {
                    gameState.sporesEncountered = true;
                    const poisonDamage = rollDice(1, 4);
                    gameState.stamina -= poisonDamage;
                    updateStatsDisplay();
                    playSound('poison');
                    return "You've been poisoned by the spores! You take " + poisonDamage + " damage and feel weak. You'll need to find a cure or suffer more damage over time.";
                }
            },
            13: {
                text: "You hold your breath and back away from the spore cloud...",
                choices: [
                    {text: "Continue", nextSection: 31, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully avoid inhaling the spores. Wise decision - they looked dangerous.";
                    } else {
                        gameState.sporesEncountered = true;
                        const minorDamage = rollDice(1, 2);
                        gameState.stamina -= minorDamage;
                        updateStatsDisplay();
                        playSound('poison');
                        return "You inhale a small amount of spores before you can retreat. You take " + minorDamage + " damage and feel slightly ill.";
                    }
                }
            },
            14: {
                text: "You cover your mouth with cloth and examine the purple mushroom more closely. The spores seem to be attracted to light. You notice that blue mushrooms growing nearby seem to repel the spores.",
                choices: [
                    {text: "Collect some blue mushrooms", nextSection: 32, skillCheck: false},
                    {text: "Experiment with the spore reaction to light", nextSection: 33, skillCheck: false},
                    {text: "Return to the bridge area", nextSection: 3, skillCheck: false}
                ]
            },
            15: {
                text: "You try to open the mushroom door. It doesn't budge. The circular indentation seems to be some kind of lock that requires a specific item.",
                choices: [
                    {text: "Try using items from your inventory", nextSection: 34, skillCheck: false},
                    {text: "Search the area for a key", nextSection: 16, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Force the door open", nextSection: 35, skillCheck: true, checkType: 'skill', difficulty: 16}
                ]
            },
            16: {
                text: "You search for a key or mechanism to open the mushroom door...",
                choices: [
                    {text: "Continue", nextSection: 36, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        addToInventory('Fungal Key');
                        playSound('item');
                        return "You find a strange, organic-looking key made of hardened fungus hidden under a rock! It looks like it might fit the mushroom door.";
                    } else {
                        playSound('failure');
                        return "You search thoroughly but find no key. The mechanism remains a mystery.";
                    }
                }
            },
            17: {
                text: "You knock on the mushroom door. To your surprise, it opens a crack! A small, hunched creature with glowing eyes peers out. 'Who disturbs the Mycologist?' it croaks.",
                choices: [
                    {text: "Apologize and ask for help", nextSection: 37, skillCheck: false},
                    {text: "Attack the creature", nextSection: 38, skillCheck: false},
                    {text: "Offer a gift or trade", nextSection: 39, skillCheck: false}
                ]
            },
            18: {
                text: "You taste a small piece of the red mushroom. It's surprisingly sweet and filling. You immediately feel revitalized!",
                choices: [
                    {text: "Eat more of the mushroom", nextSection: 40, skillCheck: false},
                    {text: "Save the rest for later", nextSection: 41, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(2, 4);
                    const oldStamina = gameState.stamina;
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                    const actualHeal = gameState.stamina - oldStamina;
                    updateStatsDisplay();
                    playSound('heal');
                    return "The red mushroom has healing properties! You restore " + actualHeal + " Stamina.";
                }
            },
            19: {
                text: "You store the red mushrooms in your inventory. They might be useful later.",
                choices: [
                    {text: "Continue exploring", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Red Healing Mushrooms');
                    playSound('item');
                    return "You acquire <span class='item'>Red Healing Mushrooms</span>! They might have medicinal properties.";
                }
            },
            20: {
                text: "You examine the red mushrooms closely. They have a velvety texture and emit a faint, pleasant warmth. Tiny golden specks dot their caps. These are definitely magical healing mushrooms.",
                choices: [
                    {text: "Collect them for your inventory", nextSection: 19, skillCheck: false},
                    {text: "Leave them and continue", nextSection: 2, skillCheck: false}
                ]
            },
            21: {
                text: "You look through your inventory for materials to repair the bridge...",
                choices: [
                    {text: "Use rope if you have any", nextSection: 42, skillCheck: false},
                    {text: "Use planks or wood", nextSection: 43, skillCheck: false},
                    {text: "Use spider silk if you have it", nextSection: 44, skillCheck: false, requirement: 'Giant Spider Silk'},
                    {text: "You have nothing suitable", nextSection: 45, skillCheck: false}
                ]
            },
            22: {
                text: "You attempt to cross the bridge by carefully avoiding the rotten planks...",
                choices: [
                    {text: "Continue", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.bridgeCrossed = true;
                        playSound('success');
                        return "With incredible balance and care, you navigate the treacherous bridge, stepping only on solid planks. You reach the other side safely!";
                    } else {
                        const damage = rollDice(1, 8);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        
                        if (gameState.stamina <= 0) {
                            return "You misstep! A plank gives way, and you plummet into the chasm, taking " + damage + " damage. The fall is fatal.";
                        } else {
                            return "You misstep! A plank cracks beneath you, but you manage to grab a rope and haul yourself to the next plank. You take " + damage + " damage from the close call.";
                        }
                    }
                }
            },
            23: {
                text: "You search for materials to repair the bridge. You find some vines that could serve as rope, but they're not very strong. There are also some large, flat mushrooms that might work as temporary planks.",
                choices: [
                    {text: "Gather vines for rope", nextSection: 47, skillCheck: false},
                    {text: "Harvest mushroom caps as planks", nextSection: 48, skillCheck: false},
                    {text: "Look for better materials", nextSection: 49, skillCheck: true, checkType: 'skill', difficulty: 12}
                ]
            },
            24: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue exploring the far side", nextSection: 50, skillCheck: false}
                ]
            },
            25: {
                text: "You draw your weapon and prepare for combat. The glowing eyes approach the edge of the chasm. In the fungal light, you can now see it's a GIANT SPIDER the size of a horse! It skitters toward the bridge.",
                choices: [
                    {text: "Attack the spider before it crosses", nextSection: 51, skillCheck: false},
                    {text: "Cut the bridge ropes to prevent it crossing", nextSection: 52, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Retreat and find another way", nextSection: 53, skillCheck: false}
                ]
            },
            26: {
                text: "You stay perfectly still and quiet, observing the creature on the far side...",
                choices: [
                    {text: "Continue", nextSection: 54, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You observe carefully without being noticed. It's a Giant Spider guarding its territory. It hasn't spotted you yet. You notice it seems sensitive to bright light.";
                    } else {
                        playSound('failure');
                        return "The creature senses your presence! It turns toward you, its multiple eyes glowing with malevolent intelligence.";
                    }
                }
            },
            27: {
                text: "You throw a stone to the far side of the chasm. It lands with a thud. The shadowy creature immediately scurries toward the sound, revealing itself as a Giant Spider!",
                choices: [
                    {text: "Use this distraction to cross the bridge", nextSection: 55, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Prepare to fight the spider", nextSection: 51, skillCheck: false}
                ]
            },
            28: {
                text: "You attempt to cross the chasm using the narrow ledge...",
                choices: [
                    {text: "Continue", nextSection: 56, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.bridgeCrossed = true;
                        playSound('success');
                        return "With incredible balance, you inch along the narrow ledge, pressing yourself against the cavern wall. After a tense minute, you reach the other side safely!";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        
                        if (gameState.stamina <= 0) {
                            return "You lose your footing on the treacherous ledge! You fall into the chasm, taking " + damage + " damage from the impact.";
                        } else {
                            return "You slip on the ledge but manage to catch yourself. You dangle over the chasm before pulling yourself back up. You take " + damage + " damage from the strain and continue carefully.";
                        }
                    }
                }
            },
            29: {
                text: "You try to fight off the effects of the spores...",
                choices: [
                    {text: "Continue", nextSection: 57, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "Through sheer willpower, you overcome the worst of the poisoning! You still feel weak but the effects are diminishing.";
                    } else {
                        const moreDamage = rollDice(1, 4);
                        gameState.stamina -= moreDamage;
                        updateStatsDisplay();
                        playSound('poison');
                        return "The poisoning worsens! You take an additional " + moreDamage + " damage and feel extremely ill. You need to find a cure soon.";
                    }
                }
            },
            30: {
                text: "You search among the fungi for something that might counteract the spores...",
                choices: [
                    {text: "Continue", nextSection: 58, skillCheck: true, checkType: 'skill', difficulty: 12}
                ]
            },
            31: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue exploring", nextSection: 2, skillCheck: false}
                ]
            },
            32: {
                text: "You collect some of the blue mushrooms. They feel cool and slightly damp. When you hold them near the purple mushroom, the spores seem to avoid them.",
                choices: [
                    {text: "Test if they cure spore poisoning", nextSection: 59, skillCheck: false},
                    {text: "Put them in your inventory", nextSection: 60, skillCheck: false}
                ]
            },
            33: {
                text: "You experiment with the spores' reaction to light. The spores are attracted to the green torch light but repelled by the blue mushroom glow. You also notice they avoid the Silver Amulet's light if you have one.",
                choices: [
                    {text: "Use this knowledge to safely collect spores", nextSection: 61, skillCheck: false},
                    {text: "Continue to the bridge", nextSection: 3, skillCheck: false}
                ]
            },
            34: {
                text: "You try various items from your inventory on the mushroom door lock...",
                choices: [
                    {text: "Try the Fungal Key if you have it", nextSection: 62, skillCheck: false, requirement: 'Fungal Key'},
                    {text: "Try the Silver Amulet if you have it", nextSection: 63, skillCheck: false, requirement: 'Silver Amulet'},
                    {text: "Try the Small Silver Key if you have it", nextSection: 64, skillCheck: false, requirement: 'Small Silver Key'},
                    {text: "Nothing works", nextSection: 65, skillCheck: false}
                ]
            },
            35: {
                text: "You try to force the mushroom door open...",
                choices: [
                    {text: "Continue", nextSection: 66, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With tremendous effort, you break the door open! It splinters inward, revealing a small chamber within the giant mushroom.";
                    } else {
                        const damage = rollDice(1, 3);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The door is tougher than it looks! You strain yourself and take " + damage + " damage. The door remains firmly shut.";
                    }
                }
            },
            36: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Try the key on the door", nextSection: 62, skillCheck: false},
                    {text: "Continue searching", nextSection: 67, skillCheck: false}
                ]
            },
            37: {
                text: "'Forgive my intrusion,' you say. 'I'm an adventurer passing through. I mean no harm.' The creature studies you with its glowing eyes. 'The caverns are dangerous. I am Mycon, keeper of the fungal gardens. What do you seek?'",
                choices: [
                    {text: "Ask for safe passage across the chasm", nextSection: 68, skillCheck: false},
                    {text: "Ask about the Giant Spider", nextSection: 69, skillCheck: false},
                    {text: "Ask for a cure for spore poisoning", nextSection: 70, skillCheck: false},
                    {text: "Attack and rob the creature", nextSection: 71, skillCheck: false}
                ]
            },
            38: {
                text: "You attack the mushroom creature! It shrieks in surprise and raises spore-covered arms to defend itself.",
                choices: [
                    {text: "Begin the battle!", nextSection: 72, skillCheck: false}
                ]
            },
            39: {
                text: "You offer a gift to the mushroom creature. What do you offer?",
                choices: [
                    {text: "Offer gold", nextSection: 73, skillCheck: false},
                    {text: "Offer a Healing Herb if you have one", nextSection: 74, skillCheck: false, requirement: 'Healing Herb'},
                    {text: "Offer the Silver Amulet if you have one", nextSection: 75, skillCheck: false, requirement: 'Silver Amulet'},
                    {text: "You have nothing to offer", nextSection: 76, skillCheck: false}
                ]
            },
            40: {
                text: "You eat more of the red mushroom. It continues to heal you, but you start to feel uncomfortably full.",
                choices: [
                    {text: "Stop eating and save the rest", nextSection: 77, skillCheck: false}
                ],
                action: function() {
                    const additionalHeal = rollDice(1, 4);
                    const oldStamina = gameState.stamina;
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + additionalHeal);
                    const actualHeal = gameState.stamina - oldStamina;
                    updateStatsDisplay();
                    playSound('heal');
                    return "The additional mushroom heals you for " + actualHeal + " more Stamina, but you shouldn't eat any more.";
                }
            },
            41: {
                text: "You save the remaining red mushrooms for when you really need them.",
                choices: [
                    {text: "Continue exploring", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Red Healing Mushrooms');
                    playSound('item');
                    return "You acquire <span class='item'>Red Healing Mushrooms</span>! They have strong healing properties.";
                }
            },
            42: {
                text: "You look for rope in your inventory...",
                choices: [
                    {text: "Continue", nextSection: 78, skillCheck: false}
                ],
                action: function() {
                    // Check if player has rope-like items
                    if (gameState.inventory.includes('Spider Silk') || gameState.inventory.includes('Giant Spider Silk')) {
                        playSound('success');
                        return "You use spider silk from your inventory to reinforce the bridge ropes! The bridge is now much safer.";
                    } else {
                        playSound('failure');
                        return "You have no suitable rope in your inventory. The bridge remains unsafe.";
                    }
                }
            },
            43: {
                text: "You look for planks or wood in your inventory...",
                choices: [
                    {text: "Continue", nextSection: 79, skillCheck: false}
                ],
                action: function() {
                    // Check if player has wood-like items
                    if (gameState.inventory.includes('Chamber Map') || gameState.inventory.includes('Ancient Journal')) {
                        playSound('success');
                        return "You use some wooden items from your inventory to replace rotten planks! The bridge is now somewhat safer.";
                    } else {
                        playSound('failure');
                        return "You have no suitable materials to repair the planks. The bridge remains unsafe.";
                    }
                }
            },
            44: {
                text: "You use the Giant Spider Silk to repair the bridge...",
                choices: [
                    {text: "Continue", nextSection: 80, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Giant Spider Silk');
                    playSound('success');
                    return "The Giant Spider Silk is incredibly strong! You use it to reinforce the bridge ropes, making the bridge as safe as new.";
                }
            },
            45: {
                text: "You have no suitable materials to repair the bridge.",
                choices: [
                    {text: "Attempt to cross anyway", nextSection: 22, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Look for materials in the cavern", nextSection: 23, skillCheck: false}
                ]
            },
            46: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Explore the far side", nextSection: 50, skillCheck: false}
                ]
            },
            47: {
                text: "You gather vines to use as rope. They're not ideal but better than nothing.",
                choices: [
                    {text: "Use them to repair the bridge", nextSection: 81, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Look for better materials", nextSection: 49, skillCheck: true, checkType: 'skill', difficulty: 12}
                ]
            },
            48: {
                text: "You harvest large, flat mushroom caps to use as makeshift planks.",
                choices: [
                    {text: "Use them to repair the bridge", nextSection: 82, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Look for better materials", nextSection: 49, skillCheck: true, checkType: 'skill', difficulty: 12}
                ]
            },
            49: {
                text: "You search for better materials to repair the bridge...",
                choices: [
                    {text: "Continue", nextSection: 83, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        addToInventory('Strong Vines');
                        playSound('item');
                        return "You find some exceptionally strong, fibrous vines! These would make excellent bridge repairs.";
                    } else {
                        playSound('failure');
                        return "You can't find anything better than what you already have.";
                    }
                }
            },
            50: {
                text: "You're now on the far side of the chasm. The fungal growth is even denser here. The Giant Spider you saw earlier is nowhere in sight, but you can see its web stretching between several large mushrooms. There's a stone door ahead, partially obscured by fungal growth.",
                choices: [
                    {text: "Investigate the spider web", nextSection: 84, skillCheck: false},
                    {text: "Approach the stone door", nextSection: 85, skillCheck: false},
                    {text: "Search the area for treasure", nextSection: 86, skillCheck: true, checkType: 'skill', difficulty: 12}
                ]
            },
            51: {
                text: "The Giant Spider charges across the bridge! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 510, skillCheck: false}
                ]
            },
            510: {
                text: "You face the Giant Spider! Roll for initiative!",
                choices: [
                    {text: "Attack!", nextSection: 511, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for Giant Spider
                    combatState.active = true;
                    combatState.enemyName = "Giant Spider";
                    combatState.enemyStamina = 16;
                    combatState.enemyCurrentStamina = 16;
                    combatState.enemySkill = 9;
                    combatState.nextSection = 87;
                    combatState.round = 1;
                    
                    playSound('combat');
                    return "<span class='enemy'>Giant Spider</span>: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            52: {
                text: "You try to cut the bridge ropes before the spider can cross...",
                choices: [
                    {text: "Continue", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You sever the ropes just as the spider steps onto the bridge! It falls into the chasm with an angry shriek. The bridge is now destroyed, but the spider is defeated.";
                    } else {
                        playSound('failure');
                        return "You fail to cut the ropes in time! The spider reaches your side of the chasm and attacks!";
                    }
                }
            },
            53: {
                text: "You retreat from the bridge area to reconsider your approach.",
                choices: [
                    {text: "Search for another way across", nextSection: 4, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Try to deal with the spider differently", nextSection: 89, skillCheck: false}
                ]
            },
            54: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Try to sneak past while it's distracted", nextSection: 90, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Attack while it's unaware", nextSection: 91, skillCheck: false}
                ]
            },
            55: {
                text: "You use the distraction to attempt crossing the bridge...",
                choices: [
                    {text: "Continue", nextSection: 92, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.bridgeCrossed = true;
                        playSound('success');
                        return "While the spider investigates the noise, you quickly and quietly cross the bridge! You reach the other side undetected.";
                    } else {
                        playSound('failure');
                        return "The spider notices you crossing! It abandons the distraction and rushes toward you on the bridge!";
                    }
                }
            },
            56: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Explore the far side", nextSection: 50, skillCheck: false}
                ]
            },
            57: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Search for a cure", nextSection: 30, skillCheck: true, checkType: 'skill', difficulty: 12}
                ]
            },
            58: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue", nextSection: 93, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.cureFound = true;
                        addToInventory('Antidote Mushrooms');
                        playSound('item');
                        return "You find some small white mushrooms with silver specks. They seem to counteract the purple spores. You collect them as an antidote!";
                    } else {
                        const moreDamage = rollDice(1, 3);
                        gameState.stamina -= moreDamage;
                        updateStatsDisplay();
                        playSound('poison');
                        return "You can't find an antidote. The poisoning continues to weaken you, dealing " + moreDamage + " more damage.";
                    }
                }
            },
            59: {
                text: "You test if the blue mushrooms cure spore poisoning...",
                choices: [
                    {text: "Continue", nextSection: 94, skillCheck: false}
                ],
                action: function() {
                    if (gameState.sporesEncountered) {
                        gameState.cureFound = true;
                        const healAmount = rollDice(1, 6);
                        const oldStamina = gameState.stamina;
                        gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                        const actualHeal = gameState.stamina - oldStamina;
                        updateStatsDisplay();
                        playSound('heal');
                        return "The blue mushrooms counteract the spores! You feel much better and restore " + actualHeal + " Stamina.";
                    } else {
                        playSound('success');
                        return "The blue mushrooms seem to have purifying properties. They might work as an antidote if you ever get poisoned.";
                    }
                }
            },
            60: {
                text: "You store the blue mushrooms in your inventory.",
                choices: [
                    {text: "Continue exploring", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Blue Purifying Mushrooms');
                    playSound('item');
                    return "You acquire <span class='item'>Blue Purifying Mushrooms</span>! They might counteract poison.";
                }
            },
            61: {
                text: "Using your knowledge of the spores, you safely collect some in a container. They might be useful as a weapon or tool.",
                choices: [
                    {text: "Continue", nextSection: 95, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Purple Spores');
                    playSound('item');
                    return "You acquire <span class='item'>Purple Spores</span>! Handle with care - they're poisonous.";
                }
            },
            62: {
                text: "You use the Fungal Key on the mushroom door. It fits perfectly! The door swings open silently.",
                choices: [
                    {text: "Enter the mushroom chamber", nextSection: 96, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Fungal Key');
                    playSound('success');
                    return "The <span class='item'>Fungal Key</span> unlocks the door!";
                }
            },
            63: {
                text: "You hold the Silver Amulet up to the door. It glows, and the door opens!",
                choices: [
                    {text: "Enter the mushroom chamber", nextSection: 96, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The <span class='item'>Silver Amulet</span>'s light opens the door magically!";
                }
            },
            64: {
                text: "You try the Small Silver Key. It doesn't fit. This lock requires something more... organic.",
                choices: [
                    {text: "Try something else", nextSection: 65, skillCheck: false}
                ],
                action: function() {
                    playSound('failure');
                    return "The <span class='item'>Small Silver Key</span> doesn't fit this lock.";
                }
            },
            65: {
                text: "None of your items seem to work on the mushroom door.",
                choices: [
                    {text: "Try to force it open", nextSection: 35, skillCheck: true, checkType: 'skill', difficulty: 16},
                    {text: "Search for the correct key", nextSection: 16, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Return to the bridge", nextSection: 3, skillCheck: false}
                ]
            },
            66: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Enter the broken door", nextSection: 96, skillCheck: false}
                ]
            },
            67: {
                text: "You continue searching the area around the mushroom door.",
                choices: [
                    {text: "Search more thoroughly", nextSection: 97, skillCheck: true, checkType: 'skill', difficulty: 15},
                    {text: "Give up and return to the bridge", nextSection: 3, skillCheck: false}
                ]
            },
            68: {
                text: "'Safe passage?' Mycon chuckles. 'The spider guards the bridge. It fears bright light. Use that to your advantage. Also, take this.' He hands you a glowing mushroom.",
                choices: [
                    {text: "Take the mushroom and thank him", nextSection: 98, skillCheck: false},
                    {text: "Ask more questions", nextSection: 99, skillCheck: false}
                ]
            },
            69: {
                text: "'The spider is ancient,' Mycon says. 'It came with the darkness. It spins webs of shadow and fear. But it fears the light of the blue mushrooms.'",
                choices: [
                    {text: "Ask for help against the spider", nextSection: 100, skillCheck: false},
                    {text: "Ask about the bridge", nextSection: 68, skillCheck: false}
                ]
            },
            70: {
                text: "'Spore poisoning? You must have touched the purple fungi. Take this blue mushroom - it will cure you.' Mycon hands you a cluster of blue mushrooms.",
                choices: [
                    {text: "Take the cure", nextSection: 101, skillCheck: false},
                    {text: "Ask for more information", nextSection: 102, skillCheck: false}
                ]
            },
            71: {
                text: "You attack the defenseless mushroom creature! It tries to defend itself with spores.",
                choices: [
                    {text: "Begin the battle!", nextSection: 72, skillCheck: false}
                ]
            },
            72: {
                text: "You face Mycon the Mycologist! Roll for initiative!",
                choices: [
                    {text: "Attack!", nextSection: 720, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for Mycon
                    combatState.active = true;
                    combatState.enemyName = "Mycon the Mycologist";
                    combatState.enemyStamina = 8;
                    combatState.enemyCurrentStamina = 8;
                    combatState.enemySkill = 5;
                    combatState.nextSection = 103;
                    combatState.round = 1;
                    
                    playSound('combat');
                    return "<span class='enemy'>Mycon the Mycologist</span>: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            73: {
                text: "You offer gold to Mycon. He examines it curiously. 'Shiny metal. Useless to me. But I appreciate the gesture. Take this in return.' He hands you a strange mushroom.",
                choices: [
                    {text: "Take the mushroom", nextSection: 104, skillCheck: false}
                ],
                action: function() {
                    gameState.gold -= 10;
                    updateStatsDisplay();
                    playSound('item');
                    return "You give 10 Gold and receive a <span class='item'>Strange Mushroom</span>.";
                }
            },
            74: {
                text: "You offer a Healing Herb to Mycon. He sniffs it appreciatively. 'Ah, surface greenery! A rare treat. In return, take this key - it opens my door.'",
                choices: [
                    {text: "Take the key", nextSection: 105, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Healing Herb');
                    addToInventory('Fungal Key');
                    playSound('item');
                    return "You trade a <span class='item'>Healing Herb</span> for a <span class='item'>Fungal Key</span>!";
                }
            },
            75: {
                text: "You show Mycon the Silver Amulet. He recoils slightly. 'Silver light! Too bright for my eyes. Keep it away. But I can give you this for your journey.' He hands you a pouch of glowing powder.",
                choices: [
                    {text: "Take the powder", nextSection: 106, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Glowing Fungal Powder');
                    playSound('item');
                    return "You receive <span class='item'>Glowing Fungal Powder</span>! It might have special properties.";
                }
            },
            76: {
                text: "'You have nothing to offer?' Mycon sounds disappointed. 'Then I have nothing to give. Leave me in peace.'",
                choices: [
                    {text: "Apologize and leave", nextSection: 107, skillCheck: false},
                    {text: "Attack anyway", nextSection: 71, skillCheck: false}
                ]
            },
            77: {
                text: "You stop eating and save the rest of the mushrooms. You feel completely healed but very full.",
                choices: [
                    {text: "Continue exploring", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Red Healing Mushrooms');
                    playSound('item');
                    return "You save the remaining <span class='item'>Red Healing Mushrooms</span>. You're at full health!";
                }
            },
            78: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Cross the repaired bridge", nextSection: 108, skillCheck: false}
                ]
            },
            79: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Cross the repaired bridge", nextSection: 108, skillCheck: false}
                ]
            },
            80: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Cross the repaired bridge", nextSection: 108, skillCheck: false}
                ]
            },
            81: {
                text: "You attempt to repair the bridge with vines...",
                choices: [
                    {text: "Continue", nextSection: 109, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully reinforce the bridge with vines! It's not perfect, but much safer than before.";
                    } else {
                        playSound('failure');
                        return "The vines are too weak or you tie them poorly. The bridge remains unsafe.";
                    }
                }
            },
            82: {
                text: "You attempt to repair the bridge with mushroom cap planks...",
                choices: [
                    {text: "Continue", nextSection: 110, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "The mushroom caps work surprisingly well as planks! The bridge is now safer to cross.";
                    } else {
                        playSound('failure');
                        return "The mushroom caps are too soft and break under pressure. The bridge remains unsafe.";
                    }
                }
            },
            83: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Use the strong vines to repair the bridge", nextSection: 111, skillCheck: true, checkType: 'skill', difficulty: 9}
                ]
            },
            84: {
                text: "You approach the Giant Spider's web. It's enormous, stretching between three giant mushrooms. Caught in the web are several skeletons and some intact items: a shield, a backpack, and a sword. The spider itself is nowhere to be seen.",
                choices: [
                    {text: "Retrieve items from the web", nextSection: 112, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Search for the spider", nextSection: 113, skillCheck: false},
                    {text: "Continue to the stone door", nextSection: 85, skillCheck: false}
                ]
            },
            85: {
                text: "You approach the stone door. It's covered in fungal growth, but you can see carvings beneath: a sun, a moon, and a star. There's a circular mechanism with three slots that might correspond to the symbols.",
                choices: [
                    {text: "Try to open the door", nextSection: 114, skillCheck: false},
                    {text: "Clear the fungal growth to see better", nextSection: 115, skillCheck: false},
                    {text: "Look for items to place in the slots", nextSection: 116, skillCheck: false}
                ]
            },
            86: {
                text: "You search the area for treasure...",
                choices: [
                    {text: "Continue", nextSection: 117, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.gold += 50;
                        addToInventory('Silver Dagger');
                        updateStatsDisplay();
                        playSound('item');
                        return "You find a hidden cache under a mushroom! It contains <span class='gold'>50 Gold</span> and a finely crafted <span class='item'>Silver Dagger</span>!";
                    } else {
                        playSound('failure');
                        return "You search thoroughly but find nothing of value.";
                    }
                }
            },
            87: {
                text: "", // Will be filled by combat results
                choices: [
                    {text: "Continue", nextSection: 118, skillCheck: false}
                ]
            },
            88: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Find another way across", nextSection: 4, skillCheck: true, checkType: 'skill', difficulty: 12}
                ]
            },
            89: {
                text: "You consider other ways to deal with the Giant Spider...",
                choices: [
                    {text: "Use fire or bright light to scare it", nextSection: 119, skillCheck: false},
                    {text: "Try to poison it with purple spores", nextSection: 120, skillCheck: false},
                    {text: "Attempt to sneak past while it sleeps", nextSection: 121, skillCheck: true, checkType: 'skill', difficulty: 14}
                ]
            },
            90: {
                text: "You attempt to sneak past the spider while it's distracted...",
                choices: [
                    {text: "Continue", nextSection: 122, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.bridgeCrossed = true;
                        playSound('success');
                        return "You move with perfect stealth while the spider is looking away! You cross the bridge undetected and reach the other side.";
                    } else {
                        playSound('failure');
                        return "The spider senses your movement! It turns and charges toward you!";
                    }
                }
            },
            91: {
                text: "You attack the spider while it's unaware! You get a surprise round.",
                choices: [
                    {text: "Begin the battle with advantage!", nextSection: 123, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat with surprise advantage
                    combatState.active = true;
                    combatState.enemyName = "Giant Spider";
                    combatState.enemyStamina = 16;
                    combatState.enemyCurrentStamina = 12; // Start with damage from surprise attack
                    combatState.enemySkill = 9;
                    combatState.nextSection = 87;
                    combatState.round = 1;
                    
                    playSound('combat');
                    return "<span class='enemy'>Giant Spider</span>: You surprise it! It starts with only 12 Stamina instead of 16. Skill " + combatState.enemySkill;
                }
            },
            92: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Explore the far side", nextSection: 50, skillCheck: false}
                ]
            },
            93: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Use the antidote if poisoned", nextSection: 124, skillCheck: false},
                    {text: "Continue exploring", nextSection: 2, skillCheck: false}
                ]
            },
            94: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue exploring", nextSection: 2, skillCheck: false}
                ]
            },
            95: {
                text: "You now have purple spores in your inventory. Use them carefully!",
                choices: [
                    {text: "Continue exploring", nextSection: 2, skillCheck: false}
                ]
            },
            96: {
                text: "You enter the mushroom chamber. It's a cozy space filled with strange fungi, glowing crystals, and odd trinkets. Mycon's home contains a workbench with various fungal concoctions.",
                choices: [
                    {text: "Search the chamber for useful items", nextSection: 125, skillCheck: false},
                    {text: "Examine the fungal concoctions", nextSection: 126, skillCheck: false},
                    {text: "Leave and return to the bridge", nextSection: 3, skillCheck: false}
                ]
            },
            97: {
                text: "You search more thoroughly around the mushroom door...",
                choices: [
                    {text: "Continue", nextSection: 127, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        addToInventory('Fungal Key');
                        playSound('item');
                        return "You find the Fungal Key hidden in a patch of glowing moss!";
                    } else {
                        playSound('failure');
                        return "Your thorough search yields nothing new.";
                    }
                }
            },
            98: {
                text: "Mycon gives you a glowing blue mushroom. 'This will repel the spider. Hold it high as you cross.'",
                choices: [
                    {text: "Take the mushroom and thank him", nextSection: 128, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Spider-Repellent Mushroom');
                    playSound('item');
                    return "You receive a <span class='item'>Spider-Repellent Mushroom</span>! It glows with a light that spiders fear.";
                }
            },
            99: {
                text: "'What else can you tell me?' you ask. Mycon considers. 'The stone door requires three symbols: sun, moon, star. Find items that match these. And beware - the spider is not the only danger here.'",
                choices: [
                    {text: "Ask about the symbols", nextSection: 129, skillCheck: false},
                    {text: "Ask about other dangers", nextSection: 130, skillCheck: false},
                    {text: "Thank him and leave", nextSection: 107, skillCheck: false}
                ]
            },
            100: {
                text: "'I cannot fight the spider,' Mycon says. 'But I can give you this.' He hands you a pouch of glowing powder. 'Throw it at the spider - the light will blind it temporarily.'",
                choices: [
                    {text: "Take the powder", nextSection: 131, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Blinding Fungal Powder');
                    playSound('item');
                    return "You receive <span class='item'>Blinding Fungal Powder</span>! It might give you an advantage in combat against the spider.";
                }
            },
            101: {
                text: "You take the blue mushrooms from Mycon and eat them. Immediately, you feel the poison leaving your body!",
                choices: [
                    {text: "Thank him and ask more questions", nextSection: 99, skillCheck: false}
                ],
                action: function() {
                    gameState.cureFound = true;
                    const healAmount = rollDice(2, 6);
                    const oldStamina = gameState.stamina;
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                    const actualHeal = gameState.stamina - oldStamina;
                    updateStatsDisplay();
                    playSound('heal');
                    return "The blue mushrooms cure your poisoning! You restore " + actualHeal + " Stamina.";
                }
            },
            102: {
                text: "'The purple fungi release poisonous spores,' Mycon explains. 'The blue fungi counteract them. The red fungi heal wounds. Remember these things - they may save your life.'",
                choices: [
                    {text: "Ask about other fungi", nextSection: 132, skillCheck: false},
                    {text: "Ask for some blue mushrooms", nextSection: 101, skillCheck: false}
                ]
            },
            103: {
                text: "", // Will be filled by combat results
                choices: [
                    {text: "Continue", nextSection: 133, skillCheck: false}
                ]
            },
            104: {
                text: "Mycon gives you a strange, lumpy mushroom with a faint golden glow.",
                choices: [
                    {text: "Take the mushroom", nextSection: 134, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Golden Lump Mushroom');
                    playSound('item');
                    return "You receive a <span class='item'>Golden Lump Mushroom</span>! Its purpose is unclear.";
                }
            },
            105: {
                text: "Mycon gives you a fungal key that looks like it's grown rather than carved.",
                choices: [
                    {text: "Thank him and try the key", nextSection: 62, skillCheck: false}
                ]
            },
            106: {
                text: "Mycon gives you a pouch of glowing fungal powder.",
                choices: [
                    {text: "Thank him and examine the powder", nextSection: 135, skillCheck: false}
                ]
            },
            107: {
                text: "You thank Mycon for his help and leave him in peace.",
                choices: [
                    {text: "Return to the bridge area", nextSection: 3, skillCheck: false}
                ]
            },
            108: {
                text: "With the bridge repaired, you cross safely to the other side.",
                choices: [
                    {text: "Explore the far side", nextSection: 50, skillCheck: false}
                ],
                action: function() {
                    gameState.bridgeCrossed = true;
                    playSound('success');
                    return "The repaired bridge holds firm! You cross safely to the other side of the chasm.";
                }
            },
            109: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Cross the vine-repaired bridge", nextSection: 136, skillCheck: true, checkType: 'skill', difficulty: 9}
                ]
            },
            110: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Cross the mushroom-plank bridge", nextSection: 137, skillCheck: true, checkType: 'skill', difficulty: 10}
                ]
            },
            111: {
                text: "You use the strong vines to repair the bridge...",
                choices: [
                    {text: "Continue", nextSection: 138, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        removeFromInventory('Strong Vines');
                        playSound('success');
                        return "You expertly weave the strong vines into the bridge structure, creating a much safer crossing!";
                    } else {
                        playSound('failure');
                        return "You struggle to properly use the vines. The bridge is slightly improved but still risky.";
                    }
                }
            },
            112: {
                text: "You attempt to retrieve items from the spider web without getting caught...",
                choices: [
                    {text: "Continue", nextSection: 139, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.equippedWeapon = 'Web-Reclaimed Sword';
                        addToInventory('Tattered Backpack');
                        updateInventoryDisplay();
                        playSound('item');
                        return "You carefully retrieve a fine sword and a backpack from the web! The sword is better than your current weapon. The backpack contains 30 Gold.";
                    } else {
                        playSound('failure');
                        return "You get tangled in the web! It takes precious minutes to free yourself, and the noise might alert the spider.";
                    }
                }
            },
            113: {
                text: "You search for the Giant Spider. You find it sleeping in a large silk cocoon hanging from the ceiling. It's vulnerable!",
                choices: [
                    {text: "Attack the sleeping spider", nextSection: 123, skillCheck: false},
                    {text: "Sneak past it to the stone door", nextSection: 140, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Return to the web to retrieve items", nextSection: 112, skillCheck: true, checkType: 'skill', difficulty: 13}
                ]
            },
            114: {
                text: "You try to open the stone door. It doesn't budge. The three slots need to be filled with something.",
                choices: [
                    {text: "Try items from your inventory", nextSection: 141, skillCheck: false},
                    {text: "Search for matching items", nextSection: 142, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Try to force the door open", nextSection: 143, skillCheck: true, checkType: 'skill', difficulty: 18}
                ]
            },
            115: {
                text: "You clear the fungal growth from the stone door. The carvings are clearer now: a radiant sun, a crescent moon, and a five-pointed star. Each symbol has a slot beneath it. You also notice small inscriptions: 'Light of day', 'Queen of night', 'Guide in darkness'.",
                choices: [
                    {text: "Try to interpret the inscriptions", nextSection: 144, skillCheck: false},
                    {text: "Look for items matching the symbols", nextSection: 142, skillCheck: true, checkType: 'skill', difficulty: 14}
                ]
            },
            116: {
                text: "You search for items that might fit the sun, moon, and star slots...",
                choices: [
                    {text: "Continue", nextSection: 145, skillCheck: false}
                ],
                action: function() {
                    // Check if player already has some of the items
                    const hasSunItem = gameState.inventory.includes('Golden Lump Mushroom') || gameState.gold >= 100;
                    const hasMoonItem = gameState.inventory.includes('Silver Amulet') || gameState.inventory.includes('Silver Dagger') || gameState.inventory.includes('Silver Ring');
                    const hasStarItem = gameState.inventory.includes('Glowing Medallion') || gameState.inventory.includes('Star-shaped Crystal');
                    
                    if (hasSunItem || hasMoonItem || hasStarItem) {
                        let message = "You might already have some items that could work:";
                        if (hasSunItem) message += "<br>- Something golden for the sun";
                        if (hasMoonItem) message += "<br>- Something silver for the moon";
                        if (hasStarItem) message += "<br>- Something star-shaped";
                        return message;
                    } else {
                        return "You don't seem to have any items that obviously match the symbols. You'll need to search the cavern or use your creativity.";
                    }
                }
            },
            117: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue exploring", nextSection: 50, skillCheck: false}
                ]
            },
            118: {
                text: "After defeating the Giant Spider, you search its body. You find some valuable items!",
                choices: [
                    {text: "Continue to the stone door", nextSection: 85, skillCheck: false}
                ],
                action: function() {
                    gameState.giantSpiderDefeated = true;
                    gameState.gold += 75;
                    addToInventory('Giant Spider Silk');
                    updateStatsDisplay();
                    playSound('item');
                    return "You search the spider's body and find <span class='gold'>75 Gold</span> and a bundle of incredibly strong <span class='item'>Giant Spider Silk</span>!";
                }
            },
            119: {
                text: "You consider using fire or bright light to scare the spider...",
                choices: [
                    {text: "Use your Green Torch if you have one", nextSection: 146, skillCheck: false, requirement: 'Green Torch'},
                    {text: "Use the Silver Amulet if you have one", nextSection: 147, skillCheck: false, requirement: 'Silver Amulet'},
                    {text: "Make a torch from materials", nextSection: 148, skillCheck: false}
                ]
            },
            120: {
                text: "You consider poisoning the spider with purple spores...",
                choices: [
                    {text: "Use Purple Spores if you have them", nextSection: 149, skillCheck: false, requirement: 'Purple Spores'},
                    {text: "Collect fresh spores from purple mushrooms", nextSection: 150, skillCheck: false}
                ]
            },
            121: {
                text: "You wait until the spider seems to be sleeping, then attempt to sneak past...",
                choices: [
                    {text: "Continue", nextSection: 151, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.bridgeCrossed = true;
                        playSound('success');
                        return "You move with absolute silence while the spider sleeps! You cross the bridge without disturbing it.";
                    } else {
                        playSound('failure');
                        return "You make a noise! The spider wakes and immediately attacks!";
                    }
                }
            },
            122: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Explore the far side", nextSection: 50, skillCheck: false}
                ]
            },
            123: {
                text: "You attack the sleeping Giant Spider! Prepare for combat with advantage!",
                choices: [
                    {text: "Begin the battle!", nextSection: 152, skillCheck: false}
                ]
            },
            124: {
                text: "If you're poisoned, you can use the antidote mushrooms now.",
                choices: [
                    {text: "Use Antidote Mushrooms if poisoned", nextSection: 153, skillCheck: false},
                    {text: "Continue exploring", nextSection: 2, skillCheck: false}
                ]
            },
            125: {
                text: "You search Mycon's chamber. You find various interesting items: vials of glowing liquid, bundles of dried mushrooms, and some strange tools.",
                choices: [
                    {text: "Take the glowing liquid vials", nextSection: 154, skillCheck: false},
                    {text: "Take the dried mushrooms", nextSection: 155, skillCheck: false},
                    {text: "Examine the strange tools", nextSection: 156, skillCheck: false},
                    {text: "Leave everything and exit", nextSection: 107, skillCheck: false}
                ]
            },
            126: {
                text: "You examine Mycon's fungal concoctions. There are three main ones: a blue glowing potion, a red bubbling brew, and a purple misty liquid.",
                choices: [
                    {text: "Sample the blue potion", nextSection: 157, skillCheck: false},
                    {text: "Sample the red brew", nextSection: 158, skillCheck: false},
                    {text: "Sample the purple liquid", nextSection: 159, skillCheck: false},
                    {text: "Take all three for later", nextSection: 160, skillCheck: false}
                ]
            },
            127: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Try the key on the door", nextSection: 62, skillCheck: false}
                ]
            },
            128: {
                text: "You thank Mycon and take the spider-repellent mushroom.",
                choices: [
                    {text: "Use it to cross the bridge safely", nextSection: 161, skillCheck: false}
                ]
            },
            129: {
                text: "'The symbols represent elements needed to proceed,' Mycon explains. 'Sun for light, moon for reflection, star for guidance. Find items that embody these concepts.'",
                choices: [
                    {text: "Ask for examples", nextSection: 162, skillCheck: false},
                    {text: "Thank him and leave", nextSection: 107, skillCheck: false}
                ]
            },
            130: {
                text: "'Other dangers?' Mycon looks around nervously. 'The spores can poison. Some fungi are explosive if touched with metal. And... there are things that live deeper in the fungus. Things that were once people.'",
                choices: [
                    {text: "Ask about the 'things that were once people'", nextSection: 163, skillCheck: false},
                    {text: "Thank him for the warning", nextSection: 107, skillCheck: false}
                ]
            },
            131: {
                text: "You take the blinding fungal powder from Mycon.",
                choices: [
                    {text: "Use it against the spider", nextSection: 164, skillCheck: false},
                    {text: "Save it for later", nextSection: 165, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Blinding Fungal Powder');
                    playSound('item');
                    return "You receive <span class='item'>Blinding Fungal Powder</span>!";
                }
            },
            132: {
                text: "'There are many fungi here,' Mycon says. 'Yellow ones that glow without heat. White ones that can clean water. Black ones that absorb light. Each has its purpose.'",
                choices: [
                    {text: "Ask about the door symbols again", nextSection: 129, skillCheck: false},
                    {text: "Thank him for the knowledge", nextSection: 107, skillCheck: false}
                ]
            },
            133: {
                text: "After defeating Mycon, you search his chamber. You find his collection of rare fungi and some valuable items.",
                choices: [
                    {text: "Take everything valuable", nextSection: 166, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 100;
                    addToInventory('Assorted Rare Mushrooms');
                    addToInventory('Fungal Key');
                    updateStatsDisplay();
                    playSound('item');
                    return "You loot Mycon's chamber, finding <span class='gold'>100 Gold</span>, <span class='item'>Assorted Rare Mushrooms</span>, and a <span class='item'>Fungal Key</span>!";
                }
            },
            134: {
                text: "You examine the Golden Lump Mushroom. It's heavy for its size and seems to pulse with a warm, golden light.",
                choices: [
                    {text: "Keep it for now", nextSection: 107, skillCheck: false}
                ]
            },
            135: {
                text: "You examine the Glowing Fungal Powder. It emits a soft blue light and feels cool to the touch.",
                choices: [
                    {text: "Keep it for later use", nextSection: 107, skillCheck: false}
                ]
            },
            136: {
                text: "You attempt to cross the vine-repaired bridge...",
                choices: [
                    {text: "Continue", nextSection: 167, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.bridgeCrossed = true;
                        playSound('success');
                        return "The vines hold! You cross safely to the other side.";
                    } else {
                        const damage = rollDice(1, 4);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "A vine snaps! You barely catch yourself and continue across, taking " + damage + " damage from the close call.";
                    }
                }
            },
            137: {
                text: "You attempt to cross the mushroom-plank bridge...",
                choices: [
                    {text: "Continue", nextSection: 168, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.bridgeCrossed = true;
                        playSound('success');
                        return "The mushroom planks hold firm! You cross safely to the other side.";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "A mushroom plank crumbles under your weight! You manage to jump to the next plank but take " + damage + " damage.";
                    }
                }
            },
            138: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Cross the vine-reinforced bridge", nextSection: 169, skillCheck: true, checkType: 'skill', difficulty: 8}
                ]
            },
            139: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue to the stone door", nextSection: 85, skillCheck: false}
                ]
            },
            140: {
                text: "You attempt to sneak past the sleeping spider to reach the stone door...",
                choices: [
                    {text: "Continue", nextSection: 170, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You move with perfect silence past the sleeping spider! You reach the stone door without disturbing it.";
                    } else {
                        playSound('failure');
                        return "You step on a dry mushroom cap! The crunching sound wakes the spider, which immediately attacks!";
                    }
                }
            },
            141: {
                text: "You try various items from your inventory in the door slots...",
                choices: [
                    {text: "Try golden items for the sun slot", nextSection: 171, skillCheck: false},
                    {text: "Try silver items for the moon slot", nextSection: 172, skillCheck: false},
                    {text: "Try star-shaped items for the star slot", nextSection: 173, skillCheck: false}
                ]
            },
            142: {
                text: "You search the cavern for items matching the sun, moon, and star symbols...",
                choices: [
                    {text: "Continue", nextSection: 174, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        addToInventory('Sunstone');
                        addToInventory('Moon Crystal');
                        addToInventory('Star Fragment');
                        playSound('item');
                        return "You find three hidden items in the cavern! A <span class='item'>Sunstone</span> that glows warmly, a <span class='item'>Moon Crystal</span> that reflects light, and a <span class='item'>Star Fragment</span> that twinkles!";
                    } else {
                        playSound('failure');
                        return "You can't find any items that perfectly match the symbols. You'll need to be creative with what you have.";
                    }
                }
            },
            143: {
                text: "You try to force the stone door open...",
                choices: [
                    {text: "Continue", nextSection: 175, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With incredible strength, you force the stone door open! It grinds against the floor, revealing the passage beyond.";
                    } else {
                        const damage = rollDice(1, 4);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The door doesn't budge. You strain yourself and take " + damage + " damage.";
                    }
                }
            },
            144: {
                text: "You study the inscriptions: 'Light of day' (sun), 'Queen of night' (moon), 'Guide in darkness' (star). You need items that represent these concepts.",
                choices: [
                    {text: "Look for such items in your inventory", nextSection: 141, skillCheck: false},
                    {text: "Search the cavern for matching items", nextSection: 142, skillCheck: true, checkType: 'skill', difficulty: 14}
                ]
            },
            145: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Try using what you have", nextSection: 141, skillCheck: false}
                ]
            },
            146: {
                text: "You raise your Green Torch high. Its eerie green light seems to discomfort the spider! It hesitates to approach.",
                choices: [
                    {text: "Use this advantage to cross the bridge", nextSection: 176, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The Green Torch's unnatural light repels the spider! It backs away, allowing you to approach the bridge.";
                }
            },
            147: {
                text: "You hold up the Silver Amulet. Its silver light seems to pain the spider! It shrieks and retreats.",
                choices: [
                    {text: "Use this advantage to cross the bridge", nextSection: 177, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The Silver Amulet's light is painful to the spider! It retreats into the shadows, giving you a clear path to the bridge.";
                }
            },
            148: {
                text: "You try to make a torch from available materials...",
                choices: [
                    {text: "Continue", nextSection: 178, skillCheck: true, checkType: 'skill', difficulty: 11}
                ]
            },
            149: {
                text: "You prepare to use Purple Spores against the spider...",
                choices: [
                    {text: "Continue", nextSection: 179, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Purple Spores');
                    playSound('poison');
                    return "You throw the Purple Spores at the spider! It inhales them and becomes sluggish and disoriented. This might give you an advantage!";
                }
            },
            150: {
                text: "You collect fresh spores from a purple mushroom...",
                choices: [
                    {text: "Continue", nextSection: 180, skillCheck: true, checkType: 'skill', difficulty: 12}
                ]
            },
            151: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Explore the far side", nextSection: 50, skillCheck: false}
                ]
            },
            152: {
                text: "You face the Giant Spider, caught by surprise! Roll for initiative!",
                choices: [
                    {text: "Attack!", nextSection: 511, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat with sleeping spider advantage
                    combatState.active = true;
                    combatState.enemyName = "Giant Spider";
                    combatState.enemyStamina = 16;
                    combatState.enemyCurrentStamina = 10; // Start with damage from surprise attack
                    combatState.enemySkill = 9;
                    combatState.nextSection = 87;
                    combatState.round = 1;
                    
                    playSound('combat');
                    return "<span class='enemy'>Giant Spider</span>: You caught it sleeping! It starts with only 10 Stamina instead of 16. Skill " + combatState.enemySkill;
                }
            },
            153: {
                text: "If you're poisoned by spores, you can use Antidote Mushrooms to cure yourself.",
                choices: [
                    {text: "Use them now", nextSection: 181, skillCheck: false},
                    {text: "Save them for later", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    if (gameState.sporesEncountered) {
                        removeFromInventory('Antidote Mushrooms');
                        const healAmount = rollDice(2, 6);
                        const oldStamina = gameState.stamina;
                        gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                        const actualHeal = gameState.stamina - oldStamina;
                        updateStatsDisplay();
                        playSound('heal');
                        return "The Antidote Mushrooms cure your poisoning! You restore " + actualHeal + " Stamina.";
                    } else {
                        return "You're not poisoned, so you save the antidote for when you might need it.";
                    }
                }
            },
            154: {
                text: "You take vials of glowing liquid from Mycon's chamber.",
                choices: [
                    {text: "Continue", nextSection: 182, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Glowing Fungal Potions');
                    playSound('item');
                    return "You acquire <span class='item'>Glowing Fungal Potions</span>! Their effects are unknown.";
                }
            },
            155: {
                text: "You take bundles of dried mushrooms from Mycon's chamber.",
                choices: [
                    {text: "Continue", nextSection: 183, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Dried Medicinal Mushrooms');
                    playSound('item');
                    return "You acquire <span class='item'>Dried Medicinal Mushrooms</span>! They might have healing properties.";
                }
            },
            156: {
                text: "You examine Mycon's strange tools. They appear to be for harvesting and preparing fungi. One tool looks like it could be useful as a weapon or tool.",
                choices: [
                    {text: "Take the most useful-looking tool", nextSection: 184, skillCheck: false},
                    {text: "Leave the tools", nextSection: 125, skillCheck: false}
                ]
            },
            157: {
                text: "You sample the blue glowing potion. It tastes like mint and cold water. You feel refreshed and alert!",
                choices: [
                    {text: "Continue", nextSection: 185, skillCheck: false}
                ],
                action: function() {
                    gameState.luck += 2;
                    updateStatsDisplay();
                    playSound('heal');
                    return "The blue potion sharpens your mind! Your Luck increases by 2.";
                }
            },
            158: {
                text: "You sample the red bubbling brew. It's spicy and warm. You feel stronger!",
                choices: [
                    {text: "Continue", nextSection: 186, skillCheck: false}
                ],
                action: function() {
                    gameState.skill += 1;
                    updateStatsDisplay();
                    playSound('heal');
                    return "The red brew strengthens your body! Your Skill increases by 1.";
                }
            },
            159: {
                text: "You sample the purple misty liquid. It tastes bitter and makes your head swim. You feel strange...",
                choices: [
                    {text: "Continue", nextSection: 187, skillCheck: false}
                ],
                action: function() {
                    const effect = Math.random();
                    if (effect > 0.5) {
                        gameState.maxStamina += 3;
                        gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 3);
                        updateStatsDisplay();
                        playSound('heal');
                        return "The purple liquid enhances your vitality! Your maximum Stamina increases by 3, and you're healed by 3.";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('poison');
                        return "The purple liquid is toxic! You take " + damage + " damage.";
                    }
                }
            },
            160: {
                text: "You take all three of Mycon's concoctions for later use.",
                choices: [
                    {text: "Continue", nextSection: 188, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Blue Mind Potion');
                    addToInventory('Red Strength Brew');
                    addToInventory('Purple Vitality Liquid');
                    playSound('item');
                    return "You acquire all three fungal concoctions: <span class='item'>Blue Mind Potion</span>, <span class='item'>Red Strength Brew</span>, and <span class='item'>Purple Vitality Liquid</span>!";
                }
            },
            161: {
                text: "You hold the Spider-Repellent Mushroom high as you approach the bridge. The spider backs away, hissing but not attacking.",
                choices: [
                    {text: "Cross the bridge while protected", nextSection: 189, skillCheck: false}
                ]
            },
            162: {
                text: "'Examples?' Mycon thinks. 'Gold shines like the sun. Silver reflects like the moon. A guiding star... perhaps something that glows with direction.'",
                choices: [
                    {text: "Thank him for the clues", nextSection: 107, skillCheck: false}
                ]
            },
            163: {
                text: "'Fungal zombies,' Mycon whispers. 'People who breathed too many spores. Their minds gone, bodies taken over by fungus. They wander deeper chambers. Be careful.'",
                choices: [
                    {text: "Ask how to avoid or fight them", nextSection: 190, skillCheck: false},
                    {text: "Thank him for the warning", nextSection: 107, skillCheck: false}
                ]
            },
            164: {
                text: "You use the Blinding Fungal Powder against the spider...",
                choices: [
                    {text: "Continue", nextSection: 191, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Blinding Fungal Powder');
                    playSound('success');
                    return "You throw the Blinding Fungal Powder at the spider! It shrieks as the powder gets in its many eyes, temporarily blinding it!";
                }
            },
            165: {
                text: "You decide to save the Blinding Fungal Powder for a more critical moment.",
                choices: [
                    {text: "Return to dealing with the spider", nextSection: 25, skillCheck: false}
                ]
            },
            166: {
                text: "With Mycon defeated, you take everything of value from his chamber.",
                choices: [
                    {text: "Continue to the bridge", nextSection: 3, skillCheck: false}
                ]
            },
            167: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Explore the far side", nextSection: 50, skillCheck: false}
                ]
            },
            168: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Explore the far side", nextSection: 50, skillCheck: false}
                ]
            },
            169: {
                text: "You attempt to cross the vine-reinforced bridge...",
                choices: [
                    {text: "Continue", nextSection: 192, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.bridgeCrossed = true;
                        playSound('success');
                        return "The strong vines hold perfectly! You cross safely to the other side.";
                    } else {
                        const damage = rollDice(1, 3);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You slip but catch yourself on the vines. You take " + damage + " minor damage but continue across.";
                    }
                }
            },
            170: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Try to open the stone door", nextSection: 114, skillCheck: false}
                ]
            },
            171: {
                text: "You try golden items in the sun slot...",
                choices: [
                    {text: "Continue", nextSection: 193, skillCheck: false}
                ],
                action: function() {
                    // Check for golden items
                    if (gameState.inventory.includes('Golden Lump Mushroom') || gameState.gold >= 100) {
                        if (gameState.inventory.includes('Golden Lump Mushroom')) {
                            removeFromInventory('Golden Lump Mushroom');
                        } else {
                            gameState.gold -= 100;
                            updateStatsDisplay();
                        }
                        gameState.sunSlotFilled = true;
                        playSound('success');
                        return "A golden item fits perfectly in the sun slot! It glows warmly.";
                    } else {
                        playSound('failure');
                        return "You have no suitable golden items for the sun slot.";
                    }
                }
            },
            172: {
                text: "You try silver items in the moon slot...",
                choices: [
                    {text: "Continue", nextSection: 194, skillCheck: false}
                ],
                action: function() {
                    // Check for silver items
                    if (gameState.inventory.includes('Silver Amulet') || gameState.inventory.includes('Silver Dagger') || gameState.inventory.includes('Silver Ring')) {
                        // Remove the first silver item found
                        if (gameState.inventory.includes('Silver Amulet')) {
                            removeFromInventory('Silver Amulet');
                        } else if (gameState.inventory.includes('Silver Dagger')) {
                            removeFromInventory('Silver Dagger');
                        } else if (gameState.inventory.includes('Silver Ring')) {
                            removeFromInventory('Silver Ring');
                        }
                        gameState.moonSlotFilled = true;
                        playSound('success');
                        return "A silver item fits perfectly in the moon slot! It reflects the light.";
                    } else {
                        playSound('failure');
                        return "You have no suitable silver items for the moon slot.";
                    }
                }
            },
            173: {
                text: "You try star-shaped items in the star slot...",
                choices: [
                    {text: "Continue", nextSection: 195, skillCheck: false}
                ],
                action: function() {
                    // Check for star-shaped items
                    if (gameState.inventory.includes('Star Fragment') || gameState.inventory.includes('Glowing Medallion')) {
                        if (gameState.inventory.includes('Star Fragment')) {
                            removeFromInventory('Star Fragment');
                        } else if (gameState.inventory.includes('Glowing Medallion')) {
                            removeFromInventory('Glowing Medallion');
                        }
                        gameState.starSlotFilled = true;
                        playSound('success');
                        return "A star-shaped item fits perfectly in the star slot! It twinkles brightly.";
                    } else {
                        playSound('failure');
                        return "You have no suitable star-shaped items for the star slot.";
                    }
                }
            },
            174: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Try the found items in the door", nextSection: 196, skillCheck: false}
                ]
            },
            175: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Enter through the forced door", nextSection: 100, skillCheck: false}
                ]
            },
            176: {
                text: "With the spider repelled by the Green Torch, you cross the bridge...",
                choices: [
                    {text: "Continue", nextSection: 197, skillCheck: false}
                ],
                action: function() {
                    gameState.bridgeCrossed = true;
                    playSound('success');
                    return "Holding the Green Torch high, you cross the bridge while the spider watches from a distance, unwilling to approach the light.";
                }
            },
            177: {
                text: "With the spider repelled by the Silver Amulet, you cross the bridge...",
                choices: [
                    {text: "Continue", nextSection: 198, skillCheck: false}
                ],
                action: function() {
                    gameState.bridgeCrossed = true;
                    playSound('success');
                    return "Holding the Silver Amulet high, you cross the bridge. The spider retreats from the silver light, allowing you safe passage.";
                }
            },
            178: {
                text: "You attempt to make a torch...",
                choices: [
                    {text: "Continue", nextSection: 199, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        addToInventory('Makeshift Torch');
                        playSound('item');
                        return "You successfully create a Makeshift Torch! It might help against the spider.";
                    } else {
                        playSound('failure');
                        return "You fail to create a proper torch. The materials aren't suitable.";
                    }
                }
            },
            179: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Attack the weakened spider", nextSection: 200, skillCheck: false}
                ]
            },
            180: {
                text: "You attempt to collect fresh purple spores...",
                choices: [
                    {text: "Continue", nextSection: 201, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        addToInventory('Fresh Purple Spores');
                        playSound('item');
                        return "You successfully collect Fresh Purple Spores without poisoning yourself!";
                    } else {
                        gameState.sporesEncountered = true;
                        const damage = rollDice(1, 4);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('poison');
                        return "You inhale some spores while collecting them! You take " + damage + " damage and feel ill.";
                    }
                }
            },
            181: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue exploring", nextSection: 2, skillCheck: false}
                ]
            },
            182: {
                text: "You now have Glowing Fungal Potions. Their effects are unknown.",
                choices: [
                    {text: "Continue searching the chamber", nextSection: 125, skillCheck: false}
                ]
            },
            183: {
                text: "You now have Dried Medicinal Mushrooms. They might heal you if eaten.",
                choices: [
                    {text: "Continue searching the chamber", nextSection: 125, skillCheck: false}
                ]
            },
            184: {
                text: "You take a strange fungal harvesting tool that looks like it could be useful.",
                choices: [
                    {text: "Continue", nextSection: 202, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Fungal Harvesting Tool');
                    playSound('item');
                    return "You acquire a <span class='item'>Fungal Harvesting Tool</span>! It might be useful for collecting rare fungi.";
                }
            },
            185: {
                text: "The blue potion has increased your Luck!",
                choices: [
                    {text: "Try another potion", nextSection: 126, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 107, skillCheck: false}
                ]
            },
            186: {
                text: "The red brew has increased your Skill!",
                choices: [
                    {text: "Try another potion", nextSection: 126, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 107, skillCheck: false}
                ]
            },
            187: {
                text: "The purple liquid has had an effect on you!",
                choices: [
                    {text: "Try another potion", nextSection: 126, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 107, skillCheck: false}
                ]
            },
            188: {
                text: "You now have all three of Mycon's special concoctions!",
                choices: [
                    {text: "Leave the chamber", nextSection: 107, skillCheck: false}
                ]
            },
            189: {
                text: "Holding the Spider-Repellent Mushroom high, you cross the bridge safely while the spider watches from a distance.",
                choices: [
                    {text: "Continue exploring the far side", nextSection: 50, skillCheck: false}
                ],
                action: function() {
                    gameState.bridgeCrossed = true;
                    playSound('success');
                    return "The mushroom's glow keeps the spider at bay! You cross the bridge without incident.";
                }
            },
            190: {
                text: "'Fire and light hurt them,' Mycon advises. 'They fear purification. Keep your wits about you - they can release confusion spores.'",
                choices: [
                    {text: "Thank him for the advice", nextSection: 107, skillCheck: false}
                ]
            },
            191: {
                text: "With the spider temporarily blinded, you have an opportunity!",
                choices: [
                    {text: "Attack it while it's vulnerable", nextSection: 203, skillCheck: false},
                    {text: "Cross the bridge while it's distracted", nextSection: 204, skillCheck: false}
                ]
            },
            192: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Explore the far side", nextSection: 50, skillCheck: false}
                ]
            },
            193: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Try the moon slot next", nextSection: 172, skillCheck: false},
                    {text: "Try the star slot next", nextSection: 173, skillCheck: false}
                ]
            },
            194: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Try the sun slot next", nextSection: 171, skillCheck: false},
                    {text: "Try the star slot next", nextSection: 173, skillCheck: false}
                ]
            },
            195: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Try the sun slot next", nextSection: 171, skillCheck: false},
                    {text: "Try the moon slot next", nextSection: 172, skillCheck: false}
                ]
            },
            196: {
                text: "You use the Sunstone, Moon Crystal, and Star Fragment in their respective slots.",
                choices: [
                    {text: "Continue", nextSection: 205, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Sunstone');
                    removeFromInventory('Moon Crystal');
                    removeFromInventory('Star Fragment');
                    playSound('success');
                    return "All three items fit perfectly! The door glows with combined light and swings open!";
                }
            },
            197: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Explore the far side", nextSection: 50, skillCheck: false}
                ]
            },
            198: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Explore the far side", nextSection: 50, skillCheck: false}
                ]
            },
            199: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Use the torch against the spider", nextSection: 206, skillCheck: false}
                ]
            },
            200: {
                text: "The spider is weakened by the spores! Prepare for combat with advantage!",
                choices: [
                    {text: "Begin the battle!", nextSection: 207, skillCheck: false}
                ]
            },
            201: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Use the spores against the spider", nextSection: 179, skillCheck: false}
                ]
            },
            202: {
                text: "You now have a Fungal Harvesting Tool.",
                choices: [
                    {text: "Continue searching the chamber", nextSection: 125, skillCheck: false}
                ]
            },
            203: {
                text: "You attack the blinded spider! Prepare for combat with advantage!",
                choices: [
                    {text: "Begin the battle!", nextSection: 208, skillCheck: false}
                ]
            },
            204: {
                text: "You use the spider's blindness to cross the bridge safely.",
                choices: [
                    {text: "Continue", nextSection: 209, skillCheck: false}
                ],
                action: function() {
                    gameState.bridgeCrossed = true;
                    playSound('success');
                    return "While the spider stumbles around blindly, you quickly cross the bridge to safety!";
                }
            },
            205: {
                text: "The stone door opens, revealing a passage beyond.",
                choices: [
                    {text: "Enter the passage", nextSection: 100, skillCheck: false}
                ]
            },
            206: {
                text: "You wave the Makeshift Torch at the spider. It hesitates, unsure about the fire.",
                choices: [
                    {text: "Use this moment to cross the bridge", nextSection: 210, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The spider is wary of the torch's flame! It keeps its distance, giving you an opportunity.";
                }
            },
            207: {
                text: "You face the Giant Spider, weakened by spores! Roll for initiative!",
                choices: [
                    {text: "Attack!", nextSection: 511, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat with weakened spider
                    combatState.active = true;
                    combatState.enemyName = "Giant Spider";
                    combatState.enemyStamina = 16;
                    combatState.enemyCurrentStamina = 12; // Start weakened
                    combatState.enemySkill = 8; // Reduced skill due to poisoning
                    combatState.nextSection = 87;
                    combatState.round = 1;
                    
                    playSound('combat');
                    return "<span class='enemy'>Giant Spider</span>: Weakened by spores! Starts with 12 Stamina and Skill 8 instead of 16 and 9.";
                }
            },
            208: {
                text: "You face the blinded Giant Spider! Roll for initiative!",
                choices: [
                    {text: "Attack!", nextSection: 511, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat with blinded spider
                    combatState.active = true;
                    combatState.enemyName = "Giant Spider";
                    combatState.enemyStamina = 16;
                    combatState.enemyCurrentStamina = 16;
                    combatState.enemySkill = 6; // Reduced skill due to blindness
                    combatState.nextSection = 87;
                    combatState.round = 1;
                    
                    playSound('combat');
                    return "<span class='enemy'>Giant Spider</span>: Blinded! Skill reduced to 6 instead of 9.";
                }
            },
            209: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Explore the far side", nextSection: 50, skillCheck: false}
                ]
            },
            210: {
                text: "While the spider is wary of the torch, you cross the bridge...",
                choices: [
                    {text: "Continue", nextSection: 211, skillCheck: false}
                ],
                action: function() {
                    gameState.bridgeCrossed = true;
                    playSound('success');
                    return "You cross the bridge quickly while keeping the torch between you and the spider. It watches but doesn't attack.";
                }
            },
            211: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Explore the far side", nextSection: 50, skillCheck: false}
                ]
            },
            // Combat sections
            511: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 512, skillCheck: false}
                ]
            },
            512: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 511, skillCheck: false}
                ]
            },
            720: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 721, skillCheck: false}
                ]
            },
            721: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 720, skillCheck: false}
                ]
            },
            100: {
                text: "Congratulations! You have survived the Fungal Cavern of the Chambers of Fear. The stone door leads to a winding staircase ascending into darkness. You can now continue your journey to Chamber 4.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-skill').textContent = gameState.skill;
                    document.getElementById('next-stat-stamina').textContent = gameState.stamina;
                    document.getElementById('next-stat-luck').textContent = gameState.luck;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 4;
                    saveGame();
                    
                    return "";
                }
            }
        };
        
        // Initialize game
        function initGame() {
            // Check for saved game from Level 2
            const savedGame = localStorage.getItem('chambersOfFearGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 3 (coming from level 2)
                if (savedState.level === 3) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(1);
                    return;
                } else if (savedState.level === 2) {
                    // Player hasn't completed level 2 yet
                    alert("You must complete Level 2 first!");
                    window.location.href = 'level2.html';
                    return;
                } else if (savedState.level < 2) {
                    // Player hasn't completed level 1 yet
                    alert("You must complete Level 1 first!");
                    window.location.href = 'level1.html';
                    return;
                }
            } else {
                // No saved game at all
                alert("No saved game found. Starting from Level 1.");
                window.location.href = 'level1.html';
                return;
            }
            
            // Otherwise start the game
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-skill').textContent = gameState.skill;
            document.getElementById('stat-stamina').textContent = gameState.stamina;
            document.getElementById('stat-maxstamina').textContent = gameState.maxStamina;
            document.getElementById('stat-luck').textContent = gameState.luck;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item)) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/10`;
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Herb' || item === 'Red Healing Mushrooms' || item === 'Dried Medicinal Mushrooms') {
                const healAmount = item === 'Red Healing Mushrooms' ? rollDice(2, 6) : 
                                  item === 'Dried Medicinal Mushrooms' ? rollDice(1, 6) : rollDice(1, 6);
                const oldStamina = gameState.stamina;
                gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                const actualHeal = gameState.stamina - oldStamina;
                removeFromInventory(item);
                playSound('heal');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Stamina!`;
                updateStatsDisplay();
            } else if (item === 'Antidote Mushrooms' || item === 'Blue Purifying Mushrooms') {
                if (gameState.sporesEncountered) {
                    const healAmount = rollDice(2, 6);
                    const oldStamina = gameState.stamina;
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                    const actualHeal = gameState.stamina - oldStamina;
                    removeFromInventory(item);
                    gameState.sporesEncountered = false;
                    playSound('heal');
                    message = `The <span class='item'>${item}</span> cure your poisoning! You restore ${actualHeal} Stamina.`;
                    updateStatsDisplay();
                } else {
                    message = `The <span class='item'>${item}</span> have purifying properties. They could cure poison if needed.`;
                }
            } else if (item === 'Blue Mind Potion') {
                gameState.luck += 2;
                removeFromInventory(item);
                playSound('heal');
                message = "You drink the <span class='item'>Blue Mind Potion</span>! Your Luck increases by 2.";
                updateStatsDisplay();
            } else if (item === 'Red Strength Brew') {
                gameState.skill += 1;
                removeFromInventory(item);
                playSound('heal');
                message = "You drink the <span class='item'>Red Strength Brew</span>! Your Skill increases by 1.";
                updateStatsDisplay();
            } else if (item === 'Purple Vitality Liquid') {
                const effect = Math.random();
                if (effect > 0.5) {
                    gameState.maxStamina += 3;
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 3);
                    removeFromInventory(item);
                    playSound('heal');
                    message = "You drink the <span class='item'>Purple Vitality Liquid</span>! Your maximum Stamina increases by 3, and you're healed by 3.";
                } else {
                    const damage = rollDice(1, 6);
                    gameState.stamina -= damage;
                    removeFromInventory(item);
                    playSound('poison');
                    message = "The <span class='item'>Purple Vitality Liquid</span> is toxic! You take " + damage + " damage.";
                }
                updateStatsDisplay();
            } else if (item === 'Purple Spores' || item === 'Fresh Purple Spores') {
                message = "<span class='warning'>Poisonous spores!</span> Handle with care. Could be used as a weapon.";
            } else if (item === 'Spider-Repellent Mushroom') {
                message = "The <span class='item'>Spider-Repellent Mushroom</span> glows with a light that spiders fear.";
            } else if (item === 'Blinding Fungal Powder' || item === 'Glowing Fungal Powder') {
                message = "<span class='item'>" + item + "</span>. Could be thrown at enemies to blind or distract them.";
            } else if (item.includes('Key') || item.includes('Amulet') || item.includes('Tool')) {
                message = `You examine the <span class='item'>${item}</span>. It might be useful for solving puzzles.`;
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Dagger' && 
                gameState.equippedArmor === 'Leather Tunic') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 511 || sectionId === 512 || sectionId === 720 || sectionId === 721);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    const goldReward = Math.floor(Math.random() * 30) + 15;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find <span class="gold">${goldReward} Gold</span> on the remains.`;
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue exploring the cavern";
                    button.onclick = function() {
                        loadSection(50); // Go to the far side section
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add skill to dice rolls
            const playerTotal = playerRoll + gameState.skill;
            const enemyTotal = enemyRoll + combatState.enemySkill;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Stamina: ${gameState.stamina}, Enemy Stamina: ${combatState.enemyCurrentStamina}<br>`;
            resultText += `You roll ${playerRoll} + Skill ${gameState.skill} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Skill ${combatState.enemySkill} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                if (gameState.equippedWeapon === 'Rusty Dagger') damage = rollDice(1, 6);
                else if (gameState.equippedWeapon === 'Steel Longsword') damage = rollDice(2, 6);
                else if (gameState.equippedWeapon === 'Web-Reclaimed Sword') damage = rollDice(2, 6);
                else if (gameState.equippedWeapon === 'Silver Dagger') damage = rollDice(1, 8);
                else damage = rollDice(1, 6); // Default
                
                combatState.enemyCurrentStamina -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentStamina <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                let enemyDamage = rollDice(1, 6);
                // Giant Spider does more damage
                if (combatState.enemyName === "Giant Spider") enemyDamage = rollDice(2, 4);
                
                gameState.stamina -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.stamina <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('chambersOfFearGameState');
                        location.reload();
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Luck
        function useLuck() {
            playSound('click');
            if (gameState.luck <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Luck left!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.luck;
            
            gameState.luck -= 1;
            updateStatsDisplay();
            
            let resultText = `You test your Luck... Roll: ${diceRoll}, Luck: ${gameState.luck + 1}. `;
            resultText += success ? 
                `<span class="success">Lucky!</span> Something good happens.` : 
                `<span class="damage">Unlucky!</span> Something bad happens.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Apply Luck effect
            if (success) {
                // Good effect
                const goodEffects = [
                    "You find 5 Gold on the ground!",
                    "You feel a surge of energy! Restore 3 Stamina.",
                    "You spot a hidden path that might be useful."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Gold")) {
                    gameState.gold += 5;
                } else if (effect.includes("Stamina")) {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 3);
                }
            } else {
                // Bad effect
                const badEffects = [
                    "You trip and take 2 damage!",
                    "You drop 3 Gold!",
                    "You feel weaker. Lose 1 Skill until next rest."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.stamina -= 2;
                    playSound('damage');
                } else if (effect.includes("Gold")) {
                    gameState.gold = Math.max(0, gameState.gold - 3);
                } else if (effect.includes("Skill")) {
                    gameState.skill = Math.max(1, gameState.skill - 1);
                }
            }
            
            updateStatsDisplay();
            updateInventoryDisplay();
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('chambersOfFearGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('chambersOfFearGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 3 (this page)
                if (savedState.level === 3) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 3.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 4 with updated level
            gameState.level = 4;
            localStorage.setItem('chambersOfFearGameState', JSON.stringify(gameState));
            // Redirect to level 4
            window.location.href = 'level4.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
