<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle of the Dammed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        body {
            background-color: #0c0c0c;
            color: #c0c0c0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            padding: 10px;
            background-image: radial-gradient(#2a0a0a 15%, transparent 16%),
                              radial-gradient(#2a0a0a 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }
        
        .header {
            text-align: center;
            padding: 10px;
            border-bottom: 1px solid #5c0000;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        
        h1 {
            color: #ff0000;
            font-size: 1.8rem;
            margin-bottom: 5px;
            text-shadow: 0 0 5px #ff0000;
        }
        
        .subtitle {
            color: #a0a0a0;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .game-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            gap: 15px;
            min-height: 0;
        }
        
        .main-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
            border: 1px solid #5c0000;
            border-radius: 5px;
            background-color: rgba(10, 0, 0, 0.9);
            box-shadow: 0 0 15px rgba(100, 0, 0, 0.5);
            min-height: 0;
        }
        
        .info-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #5c0000;
            border-radius: 5px;
            background-color: rgba(10, 0, 0, 0.9);
            box-shadow: 0 0 15px rgba(100, 0, 0, 0.5);
            padding: 10px;
            overflow-y: auto;
            min-height: 0;
        }
        
        .game-output-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            min-height: 0;
        }
        
        .game-output {
            line-height: 1.5;
            font-size: 1rem;
            min-height: 100%;
        }
        
        .game-input {
            border-top: 1px solid #5c0000;
            padding: 15px;
            display: flex;
            flex-shrink: 0;
            background-color: rgba(10, 0, 0, 0.9);
        }
        
        .prompt {
            color: #ff0000;
            margin-right: 10px;
            font-weight: bold;
            line-height: 35px;
            flex-shrink: 0;
        }
        
        #user-input {
            flex: 1;
            background-color: #111;
            border: 1px solid #5c0000;
            color: #c0c0c0;
            padding: 8px;
            font-size: 1rem;
            border-radius: 3px;
            height: 35px;
        }
        
        #user-input:focus {
            outline: none;
            border-color: #ff0000;
            box-shadow: 0 0 5px #ff0000;
        }
        
        .info-title {
            color: #ff0000;
            font-size: 1.1rem;
            margin-bottom: 10px;
            border-bottom: 1px solid #5c0000;
            padding-bottom: 5px;
        }
        
        .info-content {
            flex: 1;
            font-size: 0.9rem;
            line-height: 1.4;
            min-height: 0;
        }
        
        .command-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 10px;
        }
        
        .command-item {
            color: #a0a0a0;
            font-size: 0.8rem;
            padding: 3px;
        }
        
        .inventory {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #5c0000;
        }
        
        .inventory-title {
            color: #ffd700;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .inventory-items {
            font-size: 0.85rem;
            color: #a0a0a0;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 8px;
            background-color: #111;
            border-radius: 3px;
            border: 1px solid #5c0000;
            font-size: 0.85rem;
            flex-shrink: 0;
        }
        
        .footer {
            text-align: center;
            padding: 10px;
            margin-top: 10px;
            border-top: 1px solid #5c0000;
            font-size: 0.8rem;
            color: #666;
            flex-shrink: 0;
        }
        
        .keyboard-hint {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #666;
        }
        
        .welcome-text {
            color: #ff0000;
            margin-bottom: 15px;
        }
        
        .location-title {
            color: #ffd700;
            margin-bottom: 10px;
            border-bottom: 1px dashed #5c0000;
            padding-bottom: 5px;
        }
        
        .game-text {
            margin-bottom: 10px;
        }
        
        .exit-item {
            color: #87ceeb;
            margin-left: 20px;
        }
        
        .response {
            color: #dda0dd;
            margin-top: 10px;
            margin-bottom: 10px;
            font-style: italic;
        }
        
        .combat-text {
            color: #ff4444;
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        
        .npc-text {
            color: #44ff44;
            font-style: italic;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        
        .health-bar {
            width: 100%;
            height: 10px;
            background-color: #330000;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .health-fill {
            height: 100%;
            background-color: #ff0000;
            border-radius: 5px;
            transition: width 0.3s;
        }
        
        .equipped-item {
            color: #ffaa00;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
            }
            
            .info-panel {
                max-height: 200px;
            }
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #111;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #5c0000;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #880000;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-bat"></i> CASTLE OF THE DAMMED</h1>
        <div class="subtitle">A Gothic Horror Adventure • Based on Bram Stoker's Dracula</div>
    </div>
    
    <div class="game-container">
        <div class="main-panel">
            <div class="game-output-container" id="game-output-container">
                <div class="game-output" id="game-output">
                    <!-- Game text will appear here -->
                </div>
            </div>
            <div class="game-input">
                <span class="prompt">></span>
                <input type="text" id="user-input" autocomplete="off" autofocus>
            </div>
        </div>
        
        <div class="info-panel">
            <div class="info-title"><i class="fas fa-info-circle"></i> ADVENTURE INFO</div>
            <div class="info-content">
                <p>You are a vampire hunter at Castle Dracula. Find and destroy the Count!</p>
                
                <div class="status-bar">
                    <div>Health: <span id="health">100</span>/100</div>
                    <div>Gold: <span id="gold">10</span></div>
                </div>
                
                <div class="health-bar">
                    <div class="health-fill" id="health-fill" style="width: 100%"></div>
                </div>
                
                <div class="inventory">
                    <div class="inventory-title"><i class="fas fa-backpack"></i> YOUR INVENTORY</div>
                    <div class="inventory-items" id="inventory">
                        Empty
                    </div>
                </div>
                
                <div class="inventory">
                    <div class="inventory-title"><i class="fas fa-gavel"></i> EQUIPPED WEAPON</div>
                    <div class="inventory-items" id="equipped">
                        None
                    </div>
                </div>
                
                <div class="status-bar">
                    <div>Score: <span id="score">0</span></div>
                    <div>Moves: <span id="moves">0</span></div>
                    <div>Location: <span id="location">Outside Castle</span></div>
                </div>
                
                <div class="keyboard-hint">
                    <p><i class="fas fa-keyboard"></i> Press <kbd>Enter</kbd> to submit command. Use <kbd>↑</kbd> and <kbd>↓</kbd> for command history.</p>
                </div>
            </div>
            
            <div class="info-title" style="margin-top: 15px;"><i class="fas fa-gamepad"></i> COMMAND REFERENCE</div>
            <div class="command-list">
                <div class="command-item">GO [direction]</div>
                <div class="command-item">LOOK</div>
                <div class="command-item">TAKE [item]</div>
                <div class="command-item">READ [item]</div>
                <div class="command-item">TALK [npc]</div>
                <div class="command-item">ATTACK [enemy]</div>
                <div class="command-item">EQUIP [weapon]</div>
                <div class="command-item">BUY [item]</div>
                <div class="command-item">SELL [item]</div>
                <div class="command-item">LIST</div>
                <div class="command-item">INVENTORY</div>
                <div class="command-item">EXAMINE</div>
                <div class="command-item">HELP</div>
                <div class="command-item">SCORE</div>
                <div class="command-item">QUIT</div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>A Gothic horror text adventure based on Bram Stoker's Dracula | Commands: N, S, E, W, U, D, NE, NW, SE, SW</p>
    </div>

    <script>
        // Game state
        const gameState = {
            score: 0,
            moves: 0,
            health: 100,
            maxHealth: 100,
            gold: 10,
            inventory: [],
            location: 'outside_castle',
            gameActive: true,
            commandHistory: [],
            historyIndex: -1,
            awaitingInstructions: false, // Changed to false to start immediately
            equippedWeapon: null,
            inCombat: false,
            currentEnemy: null,
            playerDamage: 5,
            visitedLocations: []
        };

        // Game locations
        const locations = {
            outside_castle: {
                name: "Outside Castle Dracula",
                description: "You stand before the massive gates of Castle Dracula. The stone walls loom ominously against the moonlit sky. A cold wind whispers through the dead trees. The gate is slightly ajar. To the east, a small village lies in the distance.",
                exits: {n: "courtyard", e: "village_road", s: "forest_path"},
                items: ["iron_key"],
                npcs: [],
                enemies: [],
                seen: false
            },
            courtyard: {
                name: "Castle Courtyard",
                description: "You're in a desolate courtyard. Dead ivy clings to the castle walls. A stone fountain in the center contains murky water. The main doors of the castle stand before you.",
                exits: {s: "outside_castle", n: "main_hall", w: "stables", e: "chapel"},
                items: ["rusty_dagger"],
                npcs: [],
                enemies: ["giant_bat"],
                seen: false
            },
            main_hall: {
                name: "Main Hall",
                description: "A vast hall with a vaulted ceiling. Tattered banners hang from the walls. A grand staircase leads upward. An enormous fireplace dominates the west wall.",
                exits: {s: "courtyard", u: "upper_gallery", w: "library", e: "dining_hall"},
                items: ["candle"],
                npcs: [],
                enemies: [],
                seen: false
            },
            library: {
                name: "Castle Library",
                description: "Shelves of ancient books line the walls. Dust hangs thick in the air. A large desk sits in the center with a leather-bound journal.",
                exits: {e: "main_hall", s: "study"},
                items: ["old_journal", "silver_cross"],
                npcs: ["librarian_ghost"],
                enemies: [],
                seen: false
            },
            study: {
                name: "Private Study",
                description: "A small, cluttered room. Maps of Transylvania cover the walls. A secret door stands slightly ajar to the east.",
                exits: {n: "library", e: "secret_passage"},
                items: ["stake", "garlic"],
                npcs: [],
                enemies: [],
                seen: false
            },
            secret_passage: {
                name: "Secret Passage",
                description: "A narrow, winding passage hidden behind the study walls. The air is damp and cold.",
                exits: {w: "study", d: "crypt"},
                items: [],
                npcs: [],
                enemies: ["rat_swarm"],
                seen: false
            },
            crypt: {
                name: "Family Crypt",
                description: "A chilling chamber filled with stone coffins. One coffin lies open, revealing red velvet lining.",
                exits: {u: "secret_passage", e: "draculas_lair"},
                items: ["holy_water"],
                npcs: [],
                enemies: ["vampire_spawn"],
                seen: false
            },
            draculas_lair: {
                name: "Dracula's Lair",
                description: "The innermost chamber of the castle. A massive coffin dominates the room, lid slightly ajar. The air is icy cold.",
                exits: {w: "crypt"},
                items: [],
                npcs: [],
                enemies: ["dracula"],
                seen: false
            },
            dining_hall: {
                name: "Dining Hall",
                description: "A long table set for a feast that will never come. Cobwebs drape from a crystal chandelier. Silverware glints in the dim light.",
                exits: {w: "main_hall", n: "kitchen"},
                items: ["silver_fork"],
                npcs: [],
                enemies: [],
                seen: false
            },
            kitchen: {
                name: "Castle Kitchen",
                description: "A massive kitchen with cold iron stoves. Unidentifiable meat hangs from hooks. A large butcher's block stands in the center.",
                exits: {s: "dining_hall"},
                items: ["butcher_knife"],
                npcs: ["mad_chef"],
                enemies: [],
                seen: false
            },
            upper_gallery: {
                name: "Upper Gallery",
                description: "A balcony overlooking the main hall. Portraits of pale nobles watch you with dead eyes. A door to the north leads to private quarters.",
                exits: {d: "main_hall", n: "bedchamber"},
                items: ["gold_coins"],
                npcs: [],
                enemies: [],
                seen: false
            },
            bedchamber: {
                name: "Master Bedchamber",
                description: "An opulent bedroom with a four-poster bed. Heavy curtains block all light. A diary sits on the nightstand.",
                exits: {s: "upper_gallery"},
                items: ["vampire_diary"],
                npcs: [],
                enemies: [],
                seen: false
            },
            chapel: {
                name: "Castle Chapel",
                description: "A desecrated chapel. The altar is overturned, and inverted crosses hang on the walls. Stained glass windows are shattered.",
                exits: {w: "courtyard"},
                items: ["bible"],
                npcs: ["priest_ghost"],
                enemies: [],
                seen: false
            },
            stables: {
                name: "Abandoned Stables",
                description: "Empty horse stalls line the walls. Hay is scattered across the floor. A carriage sits in the corner.",
                exits: {e: "courtyard"},
                items: ["horse_shoe"],
                npcs: [],
                enemies: ["wild_wolf"],
                seen: false
            },
            village_road: {
                name: "Village Road",
                description: "A muddy road leading to a small village. The villagers fear the castle and rarely approach.",
                exits: {w: "outside_castle", e: "village"},
                items: [],
                npcs: ["traveler"],
                enemies: [],
                seen: false
            },
            village: {
                name: "Village Market",
                description: "A small, frightened village. The villagers eye you with suspicion. A merchant has set up a stall.",
                exits: {w: "village_road", n: "village_inn"},
                items: [],
                npcs: ["merchant", "villager"],
                enemies: [],
                seen: false
            },
            village_inn: {
                name: "Village Inn",
                description: "A cozy inn with a roaring fireplace. Locals whisper about the castle over mugs of ale.",
                exits: {s: "village"},
                items: ["healing_potion"],
                npcs: ["innkeeper"],
                enemies: [],
                seen: false
            },
            forest_path: {
                name: "Forest Path",
                description: "A dark path through the Transylvanian forest. Howls echo in the distance.",
                exits: {n: "outside_castle", s: "gypsy_camp"},
                items: ["wooden_stake"],
                npcs: [],
                enemies: ["werewolf"],
                seen: false
            },
            gypsy_camp: {
                name: "Gypsy Camp",
                description: "A camp of Romani travelers. They speak of ancient curses and offer strange wares.",
                exits: {n: "forest_path"},
                items: [],
                npcs: ["gypsy_elder", "gypsy_fortune_teller"],
                enemies: [],
                seen: false
            }
        };

        // Item definitions
        const items = {
            "iron_key": {
                name: "iron key",
                description: "A heavy iron key. It might unlock something in the castle.",
                points: 10,
                portable: true,
                value: 5,
                type: "key"
            },
            "rusty_dagger": {
                name: "rusty dagger",
                description: "A rusty but sharp dagger. Damage: 8",
                points: 15,
                portable: true,
                value: 10,
                type: "weapon",
                damage: 8
            },
            "candle": {
                name: "candle",
                description: "A beeswax candle. It provides light in dark places.",
                points: 5,
                portable: true,
                value: 2,
                type: "light"
            },
            "old_journal": {
                name: "old journal",
                description: "A journal belonging to a previous vampire hunter. It contains useful information.",
                points: 20,
                portable: true,
                value: 1,
                type: "readable",
                content: "The journal describes weaknesses of vampires: sunlight, garlic, holy symbols, and wooden stakes through the heart."
            },
            "silver_cross": {
                name: "silver cross",
                description: "A silver cross that glows faintly. It might protect against evil.",
                points: 25,
                portable: true,
                value: 50,
                type: "holy"
            },
            "stake": {
                name: "wooden stake",
                description: "A sharpened wooden stake. Perfect for vampire hunting. Damage: 15",
                points: 30,
                portable: true,
                value: 20,
                type: "weapon",
                damage: 15
            },
            "garlic": {
                name: "garlic cluster",
                description: "A cluster of pungent garlic. Vampires hate the smell.",
                points: 10,
                portable: true,
                value: 5,
                type: "consumable"
            },
            "holy_water": {
                name: "vial of holy water",
                description: "Water blessed by a priest. Burns the undead. Damage: 20",
                points: 40,
                portable: true,
                value: 30,
                type: "weapon",
                damage: 20,
                consumable: true
            },
            "silver_fork": {
                name: "silver fork",
                description: "An ornate silver fork. Could be used as a weapon. Damage: 5",
                points: 10,
                portable: true,
                value: 15,
                type: "weapon",
                damage: 5
            },
            "butcher_knife": {
                name: "butcher knife",
                description: "A sharp kitchen knife. Damage: 10",
                points: 15,
                portable: true,
                value: 8,
                type: "weapon",
                damage: 10
            },
            "vampire_diary": {
                name: "vampire's diary",
                description: "A diary written in an ancient language. It might contain secrets.",
                points: 50,
                portable: true,
                value: 5,
                type: "readable",
                content: "The diary speaks of Dracula's plans to spread his curse to London. It mentions his resting places and weaknesses."
            },
            "bible": {
                name: "old bible",
                description: "A leather-bound bible. The words glow with holy power.",
                points: 30,
                portable: true,
                value: 25,
                type: "holy"
            },
            "horse_shoe": {
                name: "iron horse shoe",
                description: "A lucky horse shoe. Might bring good fortune.",
                points: 5,
                portable: true,
                value: 3,
                type: "misc"
            },
            "gold_coins": {
                name: "gold coins",
                description: "A small pouch of gold coins. Worth 25 gold pieces.",
                points: 25,
                portable: true,
                value: 25,
                type: "money"
            },
            "healing_potion": {
                name: "healing potion",
                description: "A red potion that restores health.",
                points: 20,
                portable: true,
                value: 15,
                type: "consumable",
                heal: 30
            },
            "wooden_stake": {
                name: "crude wooden stake",
                description: "A roughly carved wooden stake. Damage: 12",
                points: 20,
                portable: true,
                value: 10,
                type: "weapon",
                damage: 12
            }
        };

        // NPC definitions
        const npcs = {
            "librarian_ghost": {
                name: "Ghost of the Librarian",
                description: "A translucent figure floating among the bookshelves.",
                dialogue: [
                    "The Count's secrets are hidden in his diary...",
                    "Beware the crypt below... the spawn are restless...",
                    "Silver and wood can harm the undead..."
                ],
                shopItems: [],
                buyItems: ["old_journal", "silver_cross"]
            },
            "mad_chef": {
                name: "Mad Chef",
                description: "A deranged man wielding a cleaver.",
                dialogue: [
                    "Fresh meat! Always need fresh meat!",
                    "The Master prefers his meals... lively...",
                    "Stay out of my kitchen!"
                ],
                shopItems: ["butcher_knife"],
                buyItems: []
            },
            "priest_ghost": {
                name: "Ghost of the Priest",
                description: "A sorrowful spirit in tattered vestments.",
                dialogue: [
                    "This place has been cursed for centuries...",
                    "Take this bible, it may protect you...",
                    "Only faith can defeat the darkness..."
                ],
                shopItems: ["bible"],
                buyItems: []
            },
            "merchant": {
                name: "Village Merchant",
                description: "A shrewd-looking man with a cart of goods.",
                dialogue: [
                    "What do you need? I have wares for vampire hunters.",
                    "The castle is no place for the living...",
                    "Silver bullets? Holy water? I have it all... for a price."
                ],
                shopItems: ["healing_potion", "wooden_stake", "silver_cross"],
                buyItems: ["gold_coins", "horse_shoe", "rusty_dagger"]
            },
            "villager": {
                name: "Frightened Villager",
                description: "A peasant who looks terrified.",
                dialogue: [
                    "Don't go to the castle! It's cursed!",
                    "At night, we hear screams from the battlements...",
                    "The gypsies know more about the Count..."
                ],
                shopItems: [],
                buyItems: []
            },
            "innkeeper": {
                name: "Innkeeper",
                description: "A burly man wiping a mug.",
                dialogue: [
                    "Need a room for the night? 5 gold pieces.",
                    "We don't get many visitors since the Count arrived...",
                    "The forest is dangerous after dark."
                ],
                shopItems: ["healing_potion"],
                buyItems: []
            },
            "traveler": {
                name: "Wandering Traveler",
                description: "A cloaked figure on the road.",
                dialogue: [
                    "I wouldn't go to that castle if I were you.",
                    "They say Dracula can transform into a bat or wolf...",
                    "The gypsies are loyal to him, be careful."
                ],
                shopItems: [],
                buyItems: []
            },
            "gypsy_elder": {
                name: "Gypsy Elder",
                description: "An old Romani man with wise eyes.",
                dialogue: [
                    "The Master is not what he seems...",
                    "We serve the Count, but not all of us willingly...",
                    "Break the curse before the next full moon."
                ],
                shopItems: [],
                buyItems: []
            },
            "gypsy_fortune_teller": {
                name: "Gypsy Fortune Teller",
                description: "A woman gazing into a crystal ball.",
                dialogue: [
                    "I see death in your future... but also hope.",
                    "The key to defeating him lies in his own lair...",
                    "Trust not the shadows, for they hide his children."
                ],
                shopItems: ["healing_potion", "wooden_stake"],
                buyItems: []
            }
        };

        // Enemy definitions
        const enemies = {
            "giant_bat": {
                name: "Giant Bat",
                description: "A bat with a wingspan of six feet. Its eyes glow red.",
                health: 30,
                damage: 5,
                points: 25,
                drops: ["bat_wing"],
                weakTo: ["fire", "silver"]
            },
            "rat_swarm": {
                name: "Rat Swarm",
                description: "Hundreds of diseased rats moving as one.",
                health: 20,
                damage: 3,
                points: 15,
                drops: [],
                weakTo: ["fire"]
            },
            "vampire_spawn": {
                name: "Vampire Spawn",
                description: "A pale humanoid with fangs and clawed hands.",
                health: 50,
                damage: 10,
                points: 50,
                drops: ["vampire_dust"],
                weakTo: ["holy", "wood", "garlic"]
            },
            "dracula": {
                name: "Count Dracula",
                description: "The Lord of Vampires himself. Pale, aristocratic, and deadly.",
                health: 100,
                damage: 20,
                points: 500,
                drops: ["draculas_ring"],
                weakTo: ["holy", "wood", "garlic", "sunlight"]
            },
            "wild_wolf": {
                name: "Wild Wolf",
                description: "A large, savage wolf with frothing jaws.",
                health: 25,
                damage: 8,
                points: 20,
                drops: ["wolf_pelt"],
                weakTo: ["silver"]
            },
            "werewolf": {
                name: "Werewolf",
                description: "A hulking man-wolf hybrid under the full moon.",
                health: 60,
                damage: 15,
                points: 75,
                drops: ["silver_amulet"],
                weakTo: ["silver"]
            }
        };

        // Direction mapping
        const directionMap = {
            "n": "north", "north": "north",
            "s": "south", "south": "south",
            "e": "east", "east": "east",
            "w": "west", "west": "west",
            "ne": "northeast", "northeast": "northeast",
            "nw": "northwest", "northwest": "northwest",
            "se": "southeast", "southeast": "southeast",
            "sw": "southwest", "southwest": "southwest",
            "u": "up", "up": "up",
            "d": "down", "down": "down"
        };

        // DOM elements
        const gameOutput = document.getElementById('game-output');
        const gameOutputContainer = document.getElementById('game-output-container');
        const userInput = document.getElementById('user-input');
        const scoreElement = document.getElementById('score');
        const movesElement = document.getElementById('moves');
        const locationElement = document.getElementById('location');
        const inventoryElement = document.getElementById('inventory');
        const healthElement = document.getElementById('health');
        const goldElement = document.getElementById('gold');
        const healthFillElement = document.getElementById('health-fill');
        const equippedElement = document.getElementById('equipped');

        // Initialize game
        function initGame() {
            gameOutput.innerHTML = '';
            addToOutput('<div class="welcome-text">CASTLE OF THE DAMMED</div>');
            addToOutput('<div class="game-text">A Gothic Horror Adventure Based on Dracula</div>');
            addToOutput('<div class="game-text">You have come to Transylvania to destroy Count Dracula!</div>');
            addToOutput('<div class="game-text">Type LOOK to see your surroundings, or HELP for commands.</div>');
            
            // Show starting location immediately
            look();
            
            userInput.focus();
            
            // Set up event listeners
            userInput.addEventListener('keydown', handleKeyDown);
            
            // No instructions question - start immediately
            gameState.awaitingInstructions = false;
            updateUI();
        }

        // Handle keyboard input
        function handleKeyDown(event) {
            if (event.key === 'Enter') {
                const command = userInput.value.trim();
                userInput.value = '';
                processCommand(command);
                gameState.historyIndex = -1;
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                if (gameState.commandHistory.length > 0) {
                    if (gameState.historyIndex < gameState.commandHistory.length - 1) {
                        gameState.historyIndex++;
                    }
                    userInput.value = gameState.commandHistory[gameState.commandHistory.length - 1 - gameState.historyIndex] || '';
                }
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                if (gameState.historyIndex > 0) {
                    gameState.historyIndex--;
                    userInput.value = gameState.commandHistory[gameState.commandHistory.length - 1 - gameState.historyIndex] || '';
                } else {
                    gameState.historyIndex = -1;
                    userInput.value = '';
                }
            }
        }

        // Process player command
        function processCommand(command) {
            if (!command) return;
            
            // Add to command history
            gameState.commandHistory.push(command);
            if (gameState.commandHistory.length > 50) {
                gameState.commandHistory.shift();
            }
            
            // Handle special game states
            if (!gameState.gameActive) {
                if (command.toLowerCase() === 'y' || command.toLowerCase() === 'yes') {
                    resetGame();
                } else {
                    addToOutput('<div class="response">Thanks for playing Castle of the Dammed!</div>');
                }
                return;
            }
            
            // Increment moves
            gameState.moves++;
            
            // Parse command
            const parts = command.toLowerCase().split(' ');
            const verb = parts[0];
            const obj = parts.slice(1).join(' ');
            
            // Handle combat state
            if (gameState.inCombat) {
                handleCombatCommand(verb, obj);
                updateUI();
                return;
            }
            
            // Process different commands
            switch(verb) {
                case 'go':
                case 'move':
                case 'walk':
                case 'run':
                    goDirection(obj);
                    break;
                case 'n':
                case 's':
                case 'e':
                case 'w':
                case 'ne':
                case 'nw':
                case 'se':
                case 'sw':
                case 'u':
                case 'd':
                case 'north':
                case 'south':
                case 'east':
                case 'west':
                case 'northeast':
                case 'northwest':
                case 'southeast':
                case 'southwest':
                case 'up':
                case 'down':
                    goDirection(verb);
                    break;
                case 'look':
                case 'l':
                    look();
                    break;
                case 'take':
                case 'get':
                case 'grab':
                    takeItem(obj);
                    break;
                case 'drop':
                case 'discard':
                    dropItem(obj);
                    break;
                case 'inventory':
                case 'i':
                    showInventory();
                    break;
                case 'examine':
                case 'x':
                case 'inspect':
                    examineItem(obj);
                    break;
                case 'read':
                    readItem(obj);
                    break;
                case 'talk':
                    talkToNPC(obj);
                    break;
                case 'attack':
                    attackEnemy(obj);
                    break;
                case 'equip':
                    equipWeapon(obj);
                    break;
                case 'buy':
                    buyItem(obj);
                    break;
                case 'sell':
                    sellItem(obj);
                    break;
                case 'list':
                    listShopItems();
                    break;
                case 'use':
                    useItem(obj);
                    break;
                case 'score':
                    showScore();
                    break;
                case 'help':
                case 'h':
                    showHelp();
                    break;
                case 'quit':
                case 'q':
                    quitGame();
                    break;
                case 'yes':
                case 'no':
                    addToOutput('<div class="response">Type HELP for commands or LOOK to see your surroundings.</div>');
                    break;
                default:
                    addToOutput('<div class="response">I don\'t understand "' + command + '". Try HELP for commands.</div>');
            }
            
            updateUI();
        }

        // Move in a direction
        function goDirection(dir) {
            const direction = directionMap[dir];
            
            if (!direction) {
                addToOutput('<div class="response">I don\'t know that direction. Try N, S, E, W, U, D, etc.</div>');
                return;
            }
            
            const currentLoc = locations[gameState.location];
            const exit = currentLoc.exits[dir];
            
            if (!exit) {
                addToOutput('<div class="response">You can\'t go that way.</div>');
                return;
            }
            
            // Check if location has been visited
            if (!gameState.visitedLocations.includes(exit)) {
                gameState.visitedLocations.push(exit);
                gameState.score += 10;
            }
            
            gameState.location = exit;
            look();
        }

        // Look at current location
        function look() {
            const loc = locations[gameState.location];
            
            let output = `<div class="location-title">${loc.name}</div>`;
            output += `<div class="game-text">${loc.description}</div>`;
            
            // Show items in location
            if (loc.items.length > 0) {
                output += '<div class="game-text">You see: ' + loc.items.map(item => items[item].name).join(', ') + '</div>';
            }
            
            // Show NPCs
            if (loc.npcs.length > 0) {
                output += '<div class="game-text">People here: ' + loc.npcs.map(npc => npcs[npc].name).join(', ') + '</div>';
            }
            
            // Show enemies
            if (loc.enemies.length > 0) {
                output += '<div class="combat-text">Enemies here: ' + loc.enemies.map(enemy => enemies[enemy].name).join(', ') + '</div>';
            }
            
            // Show exits
            const exitList = Object.keys(loc.exits).map(dir => {
                const fullDir = directionMap[dir];
                return `<span class="exit-item">${fullDir}</span>`;
            }).join(' ');
            
            output += `<div class="game-text">Exits: ${exitList}</div>`;
            
            addToOutput(output);
            
            // Mark location as seen
            loc.seen = true;
            updateUI();
        }

        // Take an item
        function takeItem(itemName) {
            if (!itemName) {
                addToOutput('<div class="response">Take what?</div>');
                return;
            }
            
            const loc = locations[gameState.location];
            const itemKey = findItemInLocation(itemName);
            
            if (!itemKey) {
                addToOutput('<div class="response">I don\'t see that here.</div>');
                return;
            }
            
            const item = items[itemKey];
            
            if (!item.portable) {
                addToOutput(`<div class="response">The ${item.name} cannot be taken.</div>`);
                return;
            }
            
            // Remove from location, add to inventory
            const index = loc.items.indexOf(itemKey);
            loc.items.splice(index, 1);
            gameState.inventory.push(itemKey);
            
            // Add points
            gameState.score += item.points;
            addToOutput(`<div class="response">You take the ${item.name}. Score: +${item.points} points.</div>`);
            
            // If it's gold coins, add to gold
            if (itemKey === 'gold_coins') {
                gameState.gold += item.value;
                addToOutput(`<div class="response">You now have ${gameState.gold} gold pieces.</div>`);
            }
            
            updateUI();
        }

        // Drop an item
        function dropItem(itemName) {
            if (!itemName) {
                addToOutput('<div class="response">Drop what?</div>');
                return;
            }
            
            const itemKey = findItemInInventory(itemName);
            
            if (!itemKey) {
                addToOutput('<div class="response">You\'re not carrying that.</div>');
                return;
            }
            
            const item = items[itemKey];
            
            // Remove from inventory, add to location
            const index = gameState.inventory.indexOf(itemKey);
            gameState.inventory.splice(index, 1);
            locations[gameState.location].items.push(itemKey);
            
            // If dropping equipped weapon, unequip it
            if (gameState.equippedWeapon === itemKey) {
                gameState.equippedWeapon = null;
                gameState.playerDamage = 5;
                addToOutput(`<div class="response">You unequip the ${item.name}.</div>`);
            }
            
            addToOutput(`<div class="response">You drop the ${item.name}.</div>`);
            
            updateUI();
        }

        // Show inventory
        function showInventory() {
            if (gameState.inventory.length === 0) {
                addToOutput('<div class="response">You are empty-handed.</div>');
            } else {
                const itemList = gameState.inventory.map(key => {
                    const item = items[key];
                    return item.name + (gameState.equippedWeapon === key ? " (equipped)" : "");
                }).join(', ');
                addToOutput(`<div class="response">You are carrying: ${itemList}</div>`);
                addToOutput(`<div class="response">Gold: ${gameState.gold} pieces</div>`);
            }
        }

        // Examine an item
        function examineItem(itemName) {
            if (!itemName) {
                addToOutput('<div class="response">Examine what?</div>');
                return;
            }
            
            // Check inventory first
            let itemKey = findItemInInventory(itemName);
            let location = "inventory";
            
            // Then check current location
            if (!itemKey) {
                itemKey = findItemInLocation(itemName);
                location = "here";
            }
            
            // Then check NPCs
            if (!itemKey) {
                const npcKey = findNPC(itemName);
                if (npcKey) {
                    const npc = npcs[npcKey];
                    addToOutput(`<div class="npc-text">${npc.name}: ${npc.description}</div>`);
                    return;
                }
            }
            
            // Then check enemies
            if (!itemKey) {
                const enemyKey = findEnemy(itemName);
                if (enemyKey) {
                    const enemy = enemies[enemyKey];
                    addToOutput(`<div class="combat-text">${enemy.name}: ${enemy.description}</div>`);
                    return;
                }
            }
            
            if (!itemKey) {
                addToOutput('<div class="response">I don\'t see that.</div>');
                return;
            }
            
            const item = items[itemKey];
            addToOutput(`<div class="response">You examine the ${item.name} (${location}): ${item.description}</div>`);
        }

        // Read an item
        function readItem(itemName) {
            if (!itemName) {
                addToOutput('<div class="response">Read what?</div>');
                return;
            }
            
            const itemKey = findItemInInventory(itemName);
            
            if (!itemKey) {
                addToOutput('<div class="response">You\'re not carrying that.</div>');
                return;
            }
            
            const item = items[itemKey];
            
            if (item.type !== "readable") {
                addToOutput(`<div class="response">There\'s nothing to read on the ${item.name}.</div>`);
                return;
            }
            
            addToOutput(`<div class="response">You read the ${item.name}:</div>`);
            addToOutput(`<div class="response">"${item.content}"</div>`);
            
            // Add points for reading important documents
            if (!item.hasBeenRead) {
                gameState.score += 10;
                item.hasBeenRead = true;
            }
        }

        // Talk to an NPC
        function talkToNPC(npcName) {
            if (!npcName) {
                addToOutput('<div class="response">Talk to whom?</div>');
                return;
            }
            
            const loc = locations[gameState.location];
            const npcKey = findNPCInLocation(npcName);
            
            if (!npcKey) {
                addToOutput('<div class="response">I don\'t see that person here.</div>');
                return;
            }
            
            const npc = npcs[npcKey];
            
            // Random dialogue from NPC
            const dialogue = npc.dialogue[Math.floor(Math.random() * npc.dialogue.length)];
            addToOutput(`<div class="npc-text">${npc.name}: "${dialogue}"</div>`);
            
            // If NPC is a merchant, mention they have items for sale
            if (npc.shopItems.length > 0) {
                addToOutput(`<div class="npc-text">${npc.name}: "I have items for sale. Use LIST to see what I have."</div>`);
            }
        }

        // Attack an enemy
        function attackEnemy(enemyName) {
            if (!enemyName) {
                addToOutput('<div class="response">Attack what?</div>');
                return;
            }
            
            const loc = locations[gameState.location];
            const enemyKey = findEnemyInLocation(enemyName);
            
            if (!enemyKey) {
                addToOutput('<div class="response">I don\'t see that enemy here.</div>');
                return;
            }
            
            const enemy = enemies[enemyKey];
            addToOutput(`<div class="combat-text">You attack the ${enemy.name}!</div>`);
            
            // Start combat
            gameState.inCombat = true;
            gameState.currentEnemy = enemyKey;
            
            // First attack
            playerAttack();
        }

        // Handle combat commands
        function handleCombatCommand(verb, obj) {
            if (verb === 'attack' || verb === 'a') {
                playerAttack();
            } else if (verb === 'flee' || verb === 'run') {
                fleeCombat();
            } else if (verb === 'use') {
                useItemInCombat(obj);
            } else {
                addToOutput('<div class="combat-text">In combat, you can only ATTACK, FLEE, or USE items.</div>');
            }
        }

        // Player attack in combat
        function playerAttack() {
            const enemy = enemies[gameState.currentEnemy];
            const damage = gameState.playerDamage;
            
            addToOutput(`<div class="combat-text">You hit the ${enemy.name} for ${damage} damage!</div>`);
            enemy.health -= damage;
            
            if (enemy.health <= 0) {
                enemyDefeated();
                return;
            }
            
            // Enemy attacks back
            enemyAttack();
        }

        // Enemy attack in combat
        function enemyAttack() {
            const enemy = enemies[gameState.currentEnemy];
            
            addToOutput(`<div class="combat-text">The ${enemy.name} attacks you for ${enemy.damage} damage!</div>`);
            gameState.health -= enemy.damage;
            
            updateHealth();
            
            if (gameState.health <= 0) {
                playerDefeated();
                return;
            }
            
            addToOutput(`<div class="combat-text">Your health: ${gameState.health}/${gameState.maxHealth}. Enemy health: ${enemy.health}</div>`);
            addToOutput('<div class="combat-text">What will you do? (ATTACK or FLEE)</div>');
        }

        // Enemy defeated
        function enemyDefeated() {
            const enemy = enemies[gameState.currentEnemy];
            
            addToOutput(`<div class="combat-text">You have defeated the ${enemy.name}! +${enemy.points} points!</div>`);
            gameState.score += enemy.points;
            
            // Remove enemy from location
            const loc = locations[gameState.location];
            const index = loc.enemies.indexOf(gameState.currentEnemy);
            if (index > -1) {
                loc.enemies.splice(index, 1);
            }
            
            // Drop loot
            if (enemy.drops.length > 0) {
                enemy.drops.forEach(drop => {
                    if (items[drop]) {
                        loc.items.push(drop);
                        addToOutput(`<div class="combat-text">The ${enemy.name} dropped a ${items[drop].name}!</div>`);
                    }
                });
            }
            
            // Check if Dracula was defeated
            if (gameState.currentEnemy === 'dracula') {
                gameWon();
            }
            
            // End combat
            gameState.inCombat = false;
            gameState.currentEnemy = null;
        }

        // Player defeated
        function playerDefeated() {
            addToOutput('<div class="combat-text">You have been defeated by the forces of darkness!</div>');
            addToOutput('<div class="combat-text">GAME OVER</div>');
            addToOutput('<div class="response">Play again? (YES/NO)</div>');
            gameState.gameActive = false;
            gameState.inCombat = false;
        }

        // Flee from combat
        function fleeCombat() {
            addToOutput('<div class="combat-text">You flee from combat!</div>');
            gameState.inCombat = false;
            gameState.currentEnemy = null;
            
            // Take damage while fleeing
            gameState.health -= 5;
            updateHealth();
            
            if (gameState.health <= 0) {
                playerDefeated();
            }
        }

        // Equip a weapon
        function equipWeapon(itemName) {
            if (!itemName) {
                addToOutput('<div class="response">Equip what?</div>');
                return;
            }
            
            const itemKey = findItemInInventory(itemName);
            
            if (!itemKey) {
                addToOutput('<div class="response">You don\'t have that.</div>');
                return;
            }
            
            const item = items[itemKey];
            
            if (item.type !== "weapon") {
                addToOutput(`<div class="response">The ${item.name} is not a weapon.</div>`);
                return;
            }
            
            gameState.equippedWeapon = itemKey;
            gameState.playerDamage = item.damage;
            addToOutput(`<div class="response">You equip the ${item.name}. Damage: ${item.damage}</div>`);
            
            updateUI();
        }

        // Buy an item from NPC
        function buyItem(itemName) {
            if (!itemName) {
                addToOutput('<div class="response">Buy what?</div>');
                return;
            }
            
            // Find NPC with shop items in current location
            const loc = locations[gameState.location];
            let shopNPC = null;
            
            for (const npcKey of loc.npcs) {
                const npc = npcs[npcKey];
                if (npc.shopItems.length > 0) {
                    shopNPC = npc;
                    shopNPC.key = npcKey;
                    break;
                }
            }
            
            if (!shopNPC) {
                addToOutput('<div class="response">There\'s no one here to buy from.</div>');
                return;
            }
            
            // Find item in shop
            const itemKey = findItemInList(itemName, shopNPC.shopItems);
            
            if (!itemKey) {
                addToOutput('<div class="response">That person doesn\'t sell that.</div>');
                return;
            }
            
            const item = items[itemKey];
            
            if (gameState.gold < item.value) {
                addToOutput(`<div class="response">You don't have enough gold. You need ${item.value} gold.</div>`);
                return;
            }
            
            // Buy item
            gameState.gold -= item.value;
            gameState.inventory.push(itemKey);
            addToOutput(`<div class="response">You buy the ${item.name} for ${item.value} gold.</div>`);
            
            updateUI();
        }

        // Sell an item to NPC
        function sellItem(itemName) {
            if (!itemName) {
                addToOutput('<div class="response">Sell what?</div>');
                return;
            }
            
            // Find NPC that buys items in current location
            const loc = locations[gameState.location];
            let buyNPC = null;
            
            for (const npcKey of loc.npcs) {
                const npc = npcs[npcKey];
                if (npc.buyItems.length > 0) {
                    buyNPC = npc;
                    buyNPC.key = npcKey;
                    break;
                }
            }
            
            if (!buyNPC) {
                addToOutput('<div class="response">There\'s no one here interested in buying.</div>');
                return;
            }
            
            // Check if player has item
            const itemKey = findItemInInventory(itemName);
            
            if (!itemKey) {
                addToOutput('<div class="response">You don\'t have that.</div>');
                return;
            }
            
            const item = items[itemKey];
            
            // Check if NPC buys this type of item
            if (!buyNPC.buyItems.includes(itemKey)) {
                addToOutput(`<div class="response">${buyNPC.name} isn't interested in that.</div>`);
                return;
            }
            
            // Sell item
            const sellPrice = Math.floor(item.value * 0.7); // 70% of value
            const index = gameState.inventory.indexOf(itemKey);
            gameState.inventory.splice(index, 1);
            gameState.gold += sellPrice;
            
            // If selling equipped weapon, unequip it
            if (gameState.equippedWeapon === itemKey) {
                gameState.equippedWeapon = null;
                gameState.playerDamage = 5;
            }
            
            addToOutput(`<div class="response">You sell the ${item.name} to ${buyNPC.name} for ${sellPrice} gold.</div>`);
            
            updateUI();
        }

        // List shop items
        function listShopItems() {
            const loc = locations[gameState.location];
            let shopNPC = null;
            
            for (const npcKey of loc.npcs) {
                const npc = npcs[npcKey];
                if (npc.shopItems.length > 0) {
                    shopNPC = npc;
                    shopNPC.key = npcKey;
                    break;
                }
            }
            
            if (!shopNPC) {
                addToOutput('<div class="response">There\'s no shop here.</div>');
                return;
            }
            
            addToOutput(`<div class="npc-text">${shopNPC.name} has for sale:</div>`);
            
            shopNPC.shopItems.forEach(itemKey => {
                const item = items[itemKey];
                addToOutput(`<div class="response">- ${item.name}: ${item.value} gold (${item.description})</div>`);
            });
            
            if (shopNPC.buyItems.length > 0) {
                addToOutput(`<div class="npc-text">${shopNPC.name} will buy: ${shopNPC.buyItems.map(key => items[key].name).join(', ')}</div>`);
            }
        }

        // Use an item
        function useItem(itemName) {
            if (!itemName) {
                addToOutput('<div class="response">Use what?</div>');
                return;
            }
            
            const itemKey = findItemInInventory(itemName);
            
            if (!itemKey) {
                addToOutput('<div class="response">You don\'t have that.</div>');
                return;
            }
            
            const item = items[itemKey];
            
            if (item.type === "consumable" && item.heal) {
                gameState.health = Math.min(gameState.maxHealth, gameState.health + item.heal);
                addToOutput(`<div class="response">You use the ${item.name} and heal ${item.heal} health.</div>`);
                
                // Remove from inventory
                const index = gameState.inventory.indexOf(itemKey);
                gameState.inventory.splice(index, 1);
                
                updateHealth();
            } else if (item.type === "weapon") {
                equipWeapon(itemName);
            } else {
                addToOutput(`<div class="response">You can't use the ${item.name} that way.</div>`);
            }
        }

        // Use item in combat
        function useItemInCombat(itemName) {
            if (!itemName) {
                addToOutput('<div class="response">Use what?</div>');
                return;
            }
            
            const itemKey = findItemInInventory(itemName);
            
            if (!itemKey) {
                addToOutput('<div class="response">You don\'t have that.</div>');
                return;
            }
            
            const item = items[itemKey];
            const enemy = enemies[gameState.currentEnemy];
            
            // Check if item is effective against enemy
            if (item.type === "holy" && enemy.weakTo.includes("holy")) {
                addToOutput(`<div class="combat-text">The ${item.name} glows with holy power! The ${enemy.name} takes 15 extra damage!</div>`);
                enemy.health -= 15;
                
                if (enemy.health <= 0) {
                    enemyDefeated();
                } else {
                    enemyAttack();
                }
            } else if (item.name.includes("garlic") && enemy.weakTo.includes("garlic")) {
                addToOutput(`<div class="combat-text">The ${enemy.name} recoils from the garlic! It takes 10 extra damage!</div>`);
                enemy.health -= 10;
                
                if (enemy.health <= 0) {
                    enemyDefeated();
                } else {
                    enemyAttack();
                }
            } else {
                addToOutput(`<div class="combat-text">The ${item.name} has no special effect on the ${enemy.name}.</div>`);
                enemyAttack();
            }
        }

        // Game won
        function gameWon() {
            addToOutput('<div class="welcome-text">CONGRATULATIONS!</div>');
            addToOutput('<div class="game-text">You have defeated Count Dracula and saved Transylvania!</div>');
            gameState.score += 1000;
            addToOutput(`<div class="game-text">Final Score: ${gameState.score}</div>`);
            addToOutput('<div class="response">Play again? (YES/NO)</div>');
            gameState.gameActive = false;
        }

        // Show score
        function showScore() {
            addToOutput(`<div class="response">Score: ${gameState.score} | Health: ${gameState.health}/${gameState.maxHealth} | Gold: ${gameState.gold} | Moves: ${gameState.moves}</div>`);
        }

        // Show help
        function showHelp() {
            addToOutput('<div class="response">Available commands:</div>');
            addToOutput('<div class="response">GO/LOOK/TAKE/DROP/EXAMINE/INVENTORY</div>');
            addToOutput('<div class="response">READ/TALK/ATTACK/EQUIP/BUY/SELL/LIST/USE</div>');
            addToOutput('<div class="response">Directions: N, S, E, W, NE, NW, SE, SW, U, D</div>');
            addToOutput('<div class="response">SCORE/HELP/QUIT</div>');
            addToOutput('<div class="response">In combat: ATTACK, FLEE, USE [item]</div>');
            addToOutput('<div class="response">Example: GO NORTH, TAKE KEY, TALK MERCHANT</div>');
        }

        // Quit game
        function quitGame() {
            addToOutput(`<div class="response">Your final score: ${gameState.score} in ${gameState.moves} moves.</div>`);
            addToOutput('<div class="response">Thanks for playing Castle of the Dammed!</div>');
            addToOutput('<div class="response">Play again? (YES/NO)</div>');
            gameState.gameActive = false;
        }

        // Update health display
        function updateHealth() {
            const healthPercent = (gameState.health / gameState.maxHealth) * 100;
            healthFillElement.style.width = `${healthPercent}%`;
            healthElement.textContent = gameState.health;
            
            if (gameState.health <= 20) {
                healthFillElement.style.backgroundColor = '#ff4444';
            } else {
                healthFillElement.style.backgroundColor = '#ff0000';
            }
        }

        // Reset game
        function resetGame() {
            // Reset game state
            gameState.score = 0;
            gameState.moves = 0;
            gameState.health = 100;
            gameState.maxHealth = 100;
            gameState.gold = 10;
            gameState.inventory = [];
            gameState.location = 'outside_castle';
            gameState.gameActive = true;
            gameState.commandHistory = [];
            gameState.historyIndex = -1;
            gameState.equippedWeapon = null;
            gameState.playerDamage = 5;
            gameState.inCombat = false;
            gameState.currentEnemy = null;
            gameState.visitedLocations = ['outside_castle'];
            gameState.awaitingInstructions = false;
            
            // Reset locations
            for (const key in locations) {
                locations[key].seen = false;
            }
            
            // Reset items to starting locations
            locations['outside_castle'].items = ['iron_key'];
            locations['courtyard'].items = ['rusty_dagger'];
            locations['courtyard'].enemies = ['giant_bat'];
            locations['main_hall'].items = ['candle'];
            locations['library'].items = ['old_journal', 'silver_cross'];
            locations['library'].npcs = ['librarian_ghost'];
            locations['study'].items = ['stake', 'garlic'];
            locations['secret_passage'].enemies = ['rat_swarm'];
            locations['crypt'].items = ['holy_water'];
            locations['crypt'].enemies = ['vampire_spawn'];
            locations['draculas_lair'].enemies = ['dracula'];
            locations['dining_hall'].items = ['silver_fork'];
            locations['kitchen'].items = ['butcher_knife'];
            locations['kitchen'].npcs = ['mad_chef'];
            locations['upper_gallery'].items = ['gold_coins'];
            locations['bedchamber'].items = ['vampire_diary'];
            locations['chapel'].items = ['bible'];
            locations['chapel'].npcs = ['priest_ghost'];
            locations['stables'].items = ['horse_shoe'];
            locations['stables'].enemies = ['wild_wolf'];
            locations['village_road'].npcs = ['traveler'];
            locations['village'].npcs = ['merchant', 'villager'];
            locations['village_inn'].items = ['healing_potion'];
            locations['village_inn'].npcs = ['innkeeper'];
            locations['forest_path'].items = ['wooden_stake'];
            locations['forest_path'].enemies = ['werewolf'];
            locations['gypsy_camp'].npcs = ['gypsy_elder', 'gypsy_fortune_teller'];
            
            // Reset enemies health
            for (const key in enemies) {
                if (key === 'giant_bat') enemies[key].health = 30;
                if (key === 'rat_swarm') enemies[key].health = 20;
                if (key === 'vampire_spawn') enemies[key].health = 50;
                if (key === 'dracula') enemies[key].health = 100;
                if (key === 'wild_wolf') enemies[key].health = 25;
                if (key === 'werewolf') enemies[key].health = 60;
            }
            
            gameOutput.innerHTML = '';
            addToOutput('<div class="welcome-text">NEW GAME STARTED!</div>');
            addToOutput('<div class="game-text">Type LOOK to see your surroundings, or HELP for commands.</div>');
            
            updateUI();
            updateHealth();
            look();
        }

        // Helper functions
        function findItemInLocation(itemName) {
            const loc = locations[gameState.location];
            for (const itemKey of loc.items) {
                if (items[itemKey].name.includes(itemName) || itemKey.includes(itemName)) {
                    return itemKey;
                }
            }
            return null;
        }

        function findItemInInventory(itemName) {
            for (const itemKey of gameState.inventory) {
                if (items[itemKey].name.includes(itemName) || itemKey.includes(itemName)) {
                    return itemKey;
                }
            }
            return null;
        }

        function findItemInList(itemName, itemList) {
            for (const itemKey of itemList) {
                if (items[itemKey].name.includes(itemName) || itemKey.includes(itemName)) {
                    return itemKey;
                }
            }
            return null;
        }

        function findNPC(npcName) {
            for (const npcKey in npcs) {
                if (npcs[npcKey].name.toLowerCase().includes(npcName) || npcKey.includes(npcName)) {
                    return npcKey;
                }
            }
            return null;
        }

        function findNPCInLocation(npcName) {
            const loc = locations[gameState.location];
            for (const npcKey of loc.npcs) {
                if (npcs[npcKey].name.toLowerCase().includes(npcName) || npcKey.includes(npcName)) {
                    return npcKey;
                }
            }
            return null;
        }

        function findEnemy(enemyName) {
            for (const enemyKey in enemies) {
                if (enemies[enemyKey].name.toLowerCase().includes(enemyName) || enemyKey.includes(enemyName)) {
                    return enemyKey;
                }
            }
            return null;
        }

        function findEnemyInLocation(enemyName) {
            const loc = locations[gameState.location];
            for (const enemyKey of loc.enemies) {
                if (enemies[enemyKey].name.toLowerCase().includes(enemyName) || enemyKey.includes(enemyName)) {
                    return enemyKey;
                }
            }
            return null;
        }

        function addToOutput(html) {
            gameOutput.innerHTML += html;
            // Scroll to bottom after adding content
            setTimeout(() => {
                gameOutputContainer.scrollTop = gameOutputContainer.scrollHeight;
            }, 10);
        }

        function updateUI() {
            scoreElement.textContent = gameState.score;
            movesElement.textContent = gameState.moves;
            locationElement.textContent = locations[gameState.location].name;
            goldElement.textContent = gameState.gold;
            
            // Update inventory display
            if (gameState.inventory.length === 0) {
                inventoryElement.textContent = "Empty";
            } else {
                inventoryElement.textContent = gameState.inventory.map(key => {
                    const item = items[key];
                    return item.name;
                }).join(", ");
            }
            
            // Update equipped weapon display
            if (gameState.equippedWeapon) {
                equippedElement.textContent = items[gameState.equippedWeapon].name + ` (Damage: ${gameState.playerDamage})`;
            } else {
                equippedElement.textContent = "None (Damage: 5)";
            }
        }

        // Initialize the game when page loads
        window.onload = initGame;
    </script>
</body>
</html>
