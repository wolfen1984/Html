<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hollowlands</title>
<style>
body {
    color: #fff;
    font-family: 'Courier New', monospace;
    margin: 0;
    padding: 0;
    overflow-x: auto;
    text-shadow: 0 0 5px rgba(255,255,255,0.3);
    background-image: url('title.jpg');
    background-size: 100% 100%;  /* Forces exact dimensions */
    background-repeat: no-repeat;
    background-color: rgba(17, 17, 17, 0);
    }

#game-container {
    max-width: 100px;
    margin: 0 auto;
    position: relative;
    background: url(title.jpg') no-repeat center center fixed;
    background-size: cover;
    border-radius: 5px;
    padding: 15px;
}

#game-title {
    color: #ff0000;
    text-align: center;
    font-size: 36px;
    margin-bottom: 15px;
    text-shadow: 0 0 15px #f00, 0 0 25px #f00;
    border-bottom: 1px solid #ff0000;
    padding-bottom: 10px;
    font-weight: bold;
    letter-spacing: 3px;
    text-transform: uppercase;
    font-family: 'Arial Black', sans-serif;
}

#game-screen {
    border: 1px solid #333;
    padding: 15px;
    min-height: 150px;
    margin-bottom: 10px;
    overflow-y: auto;
    max-height: 250px;
    background-color: rgba(17, 17, 17, 0);
    font-size: 18px;
    line-height: 1.5;
    border-radius: 5px;
}

#player-stats {
    border: 1px solid #333;
    padding: 10px;
    margin-bottom: 10px;
    background-color: rgba(17, 17, 17, 0.5);
    font-size: 18px;
    border-radius: 5px;
}

.button-row {
    display: flex;
    flex-wrap: wrap;
    margin-bottom: 5px;
    gap: 5px;
    background-color: rgba(17, 17, 17, 0);
}

.game-button {
    background-color: rgba(17, 17, 17, 0.5);
    color: #fff;
    border: 1px solid #444;
    padding: 10px;
    margin: 0;
    flex-grow: 1;
    min-width: 100px;
    cursor: pointer;
    font-family: 'Courier New', monospace;
    font-size: 16px;
    font-weight: bold;
    border-radius: 4px;
    transition: all 0.2s;
}

.game-button:hover {
    background-color: rgba(17, 17, 17, 0.5);
    color: #f00;
    background-color: #333;
    transform: translateY(-2px);
}

.game-button:active {
    transform: translateY(0);
}

.game-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.selected {
    color: #f00;
    border-color: #f00;
}

.important {
    color: #ff0;
    font-weight: bold;
}

.enemy {
    color: #f55;
    font-size: 20px;
    font-weight: bold;
}

.item {
    color: #5f5;
}

.gold {
    color: #ff0;
}

.health {
    color: #f55;
}

.mana {
    color: #55f;
}

.xp {
    color: #5af;
}

.damage {
    color: #f55;
}

.heal {
    color: #5f5;
}

.critical {
    color: #f80;
    font-weight: bold;
    text-shadow: 0 0 5px #f80;
}

.debuff {
    color: #a5a;
}

#inventory-screen, #character-screen, #shop-screen, #combat-screen, #quests-screen, #class-select-screen {
    display: none;
}

.item-info {
    border: 1px solid #333;
    padding: 10px;
    margin-top: 10px;
    background-color: #111;
    border-radius: 5px;
}

.class-warrior {
    color: #f55;
}

.class-mage {
    color: #55f;
}

.class-rogue {
    color: #5f5;
}

/* CRT effect */
body::after {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(rgba(18, 16, 16, 0.1) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    z-index: 100;
    pointer-events: none;
}

/* Scanlines */
body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom,
    transparent 0%,
    rgba(0, 0, 0, 0.2) 50%,
    transparent 100%);
    background-size: 100% 4px;
    z-index: 101;
    pointer-events: none;
    animation: scanline 8s linear infinite;
}

@keyframes scanline {
    0% { background-position: 0 0; }
    100% { background-position: 0 100%; }
}

/* Tooltip styles */
.tooltip {
    position: relative;
    display: inline-block;
}

.tooltip .tooltiptext {
    visibility: hidden;
    width: 200px;
    background-color: #111;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    border: 1px solid #f00;
    padding: 5px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -100px;
    opacity: 0;
    transition: opacity 0.3s;
}

.tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
}

/* Progress bar styles */
.progress-container {
    width: 100%;
    background-color: #222;
    margin: 5px 0;
    border-radius: 3px;
    overflow: hidden;
}

.progress-bar {
    height: 10px;
    background-color: #f55;
    text-align: center;
    line-height: 10px;
    color: white;
    transition: width 0.3s;
}

.health-bar {
    background-color: #f55;
}

.mana-bar {
    background-color: #55f;
}

.xp-bar {
    background-color: #5af;
}

/* Enemy health bar */
.enemy-health-container {
    width: 100%;
    background-color: #222;
    margin: 5px 0;
    border-radius: 3px;
    overflow: hidden;
}

.enemy-health-bar {
    height: 10px;
    background-color: #f55;
    text-align: center;
    line-height: 10px;
    color: white;
    transition: width 0.3s;
}

/* Status effect icons */
.status-effect {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 5px;
    vertical-align: middle;
}

.poison {
    background-color: #5f0;
}

.strength {
    background-color: #f55;
}

.weakness {
    background-color: #aaf;
}

.stun {
    background-color: #ff0;
}

.regen {
    background-color: #0f0;
}

.stealth {
    background-color: #555;
}

/* Quest styles */
.quest {
    border: 1px solid #333;
    padding: 10px;
    margin: 10px 0;
    background-color: #111;
    border-radius: 5px;
}

.quest-active {
    border-left: 4px solid #ff0;
}

.quest-completed {
    border-left: 4px solid #0f0;
    opacity: 0.7;
}

/* Combat animations */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-5px); }
    40%, 80% { transform: translateX(5px); }
}

.combat-shake {
    animation: shake 0.5s;
}

@keyframes flash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.combat-flash {
    animation: flash 0.3s;
}

/* Area transition animation */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.fade-in {
    animation: fadeIn 0.5s;
}

/* Class selection screen */
#class-select-screen {
    text-align: center;
    padding: 20px;
}

.class-description {
    margin: 20px 0;
    padding: 15px;
    background-color: rgba(17, 17, 17, 0.5);
    border-radius: 5px;
    border: 1px solid #333;
}

.class-button {
    min-width: 150px;
    font-size: 18px;
    padding: 15px;
    margin: 5px;
}

/* Responsive adjustments */
@media (max-width: 600px) {
    .game-button {
        min-width: 80px;
        font-size: 14px;
        padding: 8px;
    }
    
    #game-title {
        font-size: 28px;
    }
    
    #game-screen, #player-stats {
        font-size: 16px;
    }
}

/* Achievement toast */
.achievement-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #222;
    border-left: 4px solid #ff0;
    padding: 15px;
    border-radius: 4px;
    box-shadow: 0 0 10px rgba(255,255,0,0.5);
    z-index: 1000;
    transform: translateX(200%);
    transition: transform 0.3s ease-out;
}

.achievement-toast.show {
    transform: translateX(0);
}

.achievement-title {
    color: #ff0;
    font-weight: bold;
    margin-bottom: 5px;
}

/* Save/Load buttons */
.save-load-buttons {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
}

.save-load-buttons button {
    padding: 5px 10px;
    font-size: 12px;
    background-color: #333;
    border: 1px solid #444;
    color: #fff;
    border-radius: 3px;
    cursor: pointer;
}

.save-load-buttons button:hover {
    background-color: #444;
}

/* Music controls */
.music-controls {
    position: absolute;
    top: 10px;
    left: 10px;
}

.music-controls button {
    padding: 5px 10px;
    font-size: 12px;
    background-color: #333;
    border: 1px solid #444;
    color: #fff;
    border-radius: 3px;
    cursor: pointer;
}

.music-controls button:hover {
    background-color: #444;
}

/* Tutorial highlight */
.tutorial-highlight {
    position: relative;
    z-index: 10;
}

.tutorial-highlight::after {
    content: "";
    position: absolute;
    top: -5px;
    left: -5px;
    right: -5px;
    bottom: -5px;
    border: 2px solid #ff0;
    border-radius: 5px;
    animation: pulse 2s infinite;
    pointer-events: none;
}

@keyframes pulse {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}
</style>
</head>
<body>
<div id="game-container">
    <div class="save-load-buttons">
        <button onclick="saveGame()">SAVE</button>
        <button onclick="loadGame()">LOAD</button>
    </div>
    
    <div class="music-controls">
        <button onclick="toggleMusic()">TOGGLE MUSIC</button>
    </div>
    
    <div id="game-title">HOLLOWLANDS</div>

    <!-- Main Game Screen -->
    <div id="game-screen"></div>

    <!-- Player Stats -->
    <div id="player-stats"></div>

    <!-- Main Menu Buttons -->
    <div id="main-buttons" class="button-row" style="display: none;">
        <button class="game-button tutorial-highlight" onclick="showScreen('explore')">EXPLORE</button>
        <button class="game-button" onclick="showScreen('character')">CHARACTER</button>
        <button class="game-button" onclick="showScreen('inventory')">INVENTORY</button>
        <button class="game-button" onclick="showScreen('shop')">SHOP</button>
        <button class="game-button" onclick="showScreen('quests')">QUESTS</button>
    </div>

    <!-- Explore Screen -->
    <div id="explore-screen" style="display: none;">
        <div class="button-row">
            <button class="game-button" onclick="exploreArea()">EXPLORE</button>
            <button class="game-button" onclick="rest()">REST</button>
            <button class="game-button" onclick="changeArea()">MOVE AREA</button>
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Character Screen -->
    <div id="character-screen">
        <div id="character-info"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Inventory Screen -->
    <div id="inventory-screen">
        <div id="inventory-items"></div>
        <div id="item-details"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Shop Screen -->
    <div id="shop-screen">
        <div id="shop-items"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
            <button class="game-button" onclick="refreshShop()">REFRESH (50G)</button>
        </div>
    </div>

    <!-- Combat Screen -->
    <div id="combat-screen">
        <div id="combat-info"></div>
        <div id="combat-actions" class="button-row"></div>
    </div>

    <!-- Quests Screen -->
    <div id="quests-screen">
        <div id="active-quests"></div>
        <div id="completed-quests"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Class Selection Screen (Initial) -->
    <div id="class-select-screen">
        <h2>Choose Your Class</h2>
        <div class="button-row">
            <button class="game-button class-warrior class-button" onclick="selectClass('warrior')">WARRIOR</button>
            <button class="game-button class-mage class-button" onclick="selectClass('mage')">MAGE</button>
            <button class="game-button class-rogue class-button" onclick="selectClass('rogue')">ROGUE</button>
        </div>
        <div id="class-description" class="class-description">Hover over a class to see details</div>
    </div>
</div>

<!-- Achievement Toast -->
<div id="achievement-toast" class="achievement-toast">
    <div class="achievement-title">ACHIEVEMENT UNLOCKED!</div>
    <div id="achievement-desc"></div>
</div>

<!-- Audio Elements -->
<audio id="background-music" loop>
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>
<audio id="combat-sound">
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" type="audio/mpeg">
</audio>
<audio id="victory-sound">
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" type="audio/mpeg">
</audio>

<script>
// Game State
const gameState = {
    player: {
        name: "Adventurer",
        class: null,
        level: 1,
        xp: 0,
        xpToNextLevel: 100,
        health: 100,
        maxHealth: 100,
        mana: 50,
        maxMana: 50,
        strength: 10,
        dexterity: 10,
        intelligence: 10,
        constitution: 10,
        gold: 50,
        equippedWeapon: null,
        equippedArmor: null,
        inventory: [],
        skills: [],
        currentArea: "Forest",
        inCombat: false,
        currentEnemy: null,
        buffs: [],
        debuffs: [],
        quests: {
            active: [],
            completed: []
        },
        stealth: false,
        stealthTurns: 0,
        achievements: []
    },
    areas: [
        { name: "Forest", minLevel: 1, unlocked: true, description: "A dense forest filled with low-level creatures." },
        { name: "Caves", minLevel: 3, unlocked: false, description: "Dark caves with tougher enemies and valuable minerals." },
        { name: "Ruins", minLevel: 6, unlocked: false, description: "Ancient ruins haunted by undead creatures." },
        { name: "Dungeon", minLevel: 9, unlocked: false, description: "A dangerous dungeon filled with deadly foes." },
        { name: "Abyss", minLevel: 12, unlocked: false, description: "A bottomless pit leading to the underworld." },
        { name: "Volcano", minLevel: 15, unlocked: false, description: "A fiery mountain with lava and fire creatures." },
        { name: "Sky Temple", minLevel: 18, unlocked: false, description: "A floating temple in the clouds guarded by celestial beings." }
    ],
    enemies: {
        Forest: [
            { name: "Goblin", health: 40, maxHealth: 40, damage: "8-12", xp: 25, gold: "10-20", level: 1, critChance: 0.05 },
            { name: "Wolf", health: 35, maxHealth: 35, damage: "10-14", xp: 30, gold: "15-25", level: 1, critChance: 0.1 },
            { name: "Bandit", health: 50, maxHealth: 50, damage: "12-16", xp: 40, gold: "25-35", level: 2, critChance: 0.1 },
            { name: "Giant Spider", health: 60, maxHealth: 60, damage: "15-18", xp: 45, gold: "20-30", level: 2, poisonChance: 0.4, poisonDamage: 3 },
            { name: "Treant Sapling", health: 80, maxHealth: 80, damage: "10-15", xp: 50, gold: "15-25", level: 3, regen: 3 }
        ],
        Caves: [
            { name: "Cave Spider", health: 70, maxHealth: 70, damage: "15-20", xp: 60, gold: "30-40", level: 3, poisonChance: 0.3, poisonDamage: 3 },
            { name: "Skeleton", health: 80, maxHealth: 80, damage: "18-22", xp: 70, gold: "40-50", level: 4, armor: 5 },
            { name: "Troll", health: 120, maxHealth: 120, damage: "20-25", xp: 90, gold: "60-70", level: 5, regen: 5 },
            { name: "Dark Acolyte", health: 90, maxHealth: 90, damage: "15-18", xp: 80, gold: "50-60", level: 4, magicDamage: 15 },
            { name: "Cave Bear", health: 150, maxHealth: 150, damage: "25-30", xp: 100, gold: "70-80", level: 5 }
        ],
        Ruins: [
            { name: "Wraith", health: 100, maxHealth: 100, damage: "25-30", xp: 120, gold: "80-90", level: 6, magicResist: 15 },
            { name: "Stone Golem", health: 180, maxHealth: 180, damage: "30-35", xp: 150, gold: "100-120", level: 7, armor: 15 },
            { name: "Necromancer", health: 110, maxHealth: 110, damage: "35-40", xp: 180, gold: "120-140", level: 8, magicDamage: 20 },
            { name: "Death Knight", health: 200, maxHealth: 200, damage: "40-45", xp: 200, gold: "150-170", level: 9, lifesteal: 0.1 },
            { name: "Ancient Guardian", health: 250, maxHealth: 250, damage: "35-40", xp: 220, gold: "180-200", level: 10, armor: 20 }
        ],
        Dungeon: [
            { name: "Hellhound", health: 150, maxHealth: 150, damage: "40-45", xp: 220, gold: "150-170", level: 9, fireDamage: 10 },
            { name: "Dark Knight", health: 250, maxHealth: 250, damage: "45-50", xp: 280, gold: "200-220", level: 10, armor: 20 },
            { name: "Demon Spawn", health: 300, maxHealth: 300, damage: "50-60", xp: 350, gold: "250-270", level: 12, lifesteal: 0.2 },
            { name: "Succubus", health: 200, maxHealth: 200, damage: "30-40", xp: 300, gold: "180-200", level: 11, charmChance: 0.3 },
            { name: "Beholder", health: 350, maxHealth: 350, damage: "55-65", xp: 400, gold: "300-350", level: 13, magicDamage: 30 }
        ],
        Abyss: [
            { name: "Elder Demon", health: 600, maxHealth: 600, damage: "60-70", xp: 600, gold: "500-600", level: 15, magicResist: 30, armor: 25 },
            { name: "Abyssal Horror", health: 1000, maxHealth: 1000, damage: "70-80", xp: 900, gold: "800-900", level: 20, regen: 20 },
            { name: "Lord of Darkness", health: 1500, maxHealth: 1500, damage: "80-100", xp: 1500, gold: "1200-1400", level: 25, lifesteal: 0.3 },
            { name: "Voidwalker", health: 800, maxHealth: 800, damage: "65-75", xp: 700, gold: "600-700", level: 18, magicDamage: 40 },
            { name: "Dread Titan", health: 2000, maxHealth: 2000, damage: "90-110", xp: 2000, gold: "1500-1800", level: 30, armor: 30 }
        ],
        Volcano: [
            { name: "Fire Elemental", health: 700, maxHealth: 700, damage: "70-80", xp: 800, gold: "700-800", level: 20, fireDamage: 25 },
            { name: "Lava Giant", health: 1200, maxHealth: 1200, damage: "80-90", xp: 1000, gold: "900-1000", level: 22, armor: 25 },
            { name: "Magma Wyrm", health: 1500, maxHealth: 1500, damage: "90-100", xp: 1200, gold: "1100-1300", level: 25, fireDamage: 30 },
            { name: "Phoenix", health: 1800, maxHealth: 1800, damage: "100-120", xp: 1500, gold: "1400-1600", level: 28, regen: 50 }
        ],
        "Sky Temple": [
            { name: "Storm Drake", health: 2000, maxHealth: 2000, damage: "110-130", xp: 1800, gold: "1600-1800", level: 30, lightningDamage: 40 },
            { name: "Celestial Guardian", health: 2500, maxHealth: 2500, damage: "120-140", xp: 2200, gold: "2000-2200", level: 35, armor: 35 },
            { name: "Archon", health: 3000, maxHealth: 3000, damage: "140-160", xp: 2500, gold: "2300-2500", level: 40, magicDamage: 50 },
            { name: "Elder Dragon", health: 5000, maxHealth: 5000, damage: "180-200", xp: 3000, gold: "3000-3500", level: 50, fireDamage: 60 }
        ]
    },
    items: {
        weapons: [
            { id: 1, name: "Rusty Sword", type: "weapon", damage: "8-12", value: 15, level: 1 },
            { id: 2, name: "Iron Axe", type: "weapon", damage: "12-16", value: 35, level: 2 },
            { id: 3, name: "Steel Longsword", type: "weapon", damage: "16-20", value: 70, level: 3 },
            { id: 4, name: "Enchanted Blade", type: "weapon", damage: "22-28", value: 150, level: 5, critChance: 0.1 },
            { id: 5, name: "Demon Edge", type: "weapon", damage: "35-45", value: 300, level: 8, lifesteal: 0.1 },
            { id: 6, name: "Staff of Fire", type: "weapon", damage: "12-18", magicDamage: 20, value: 80, level: 3 },
            { id: 7, name: "Arcane Scepter", type: "weapon", damage: "8-14", magicDamage: 30, value: 150, level: 5, manaRegen: 5 },
            { id: 8, name: "Dagger", type: "weapon", damage: "6-10", critChance: 0.25, value: 25, level: 1 },
            { id: 9, name: "Assassin's Blade", type: "weapon", damage: "14-18", critChance: 0.35, value: 120, level: 4, poisonDamage: 5 },
            { id: 20, name: "Frostbrand", type: "weapon", damage: "30-40", value: 250, level: 7, frostDamage: 15, slowChance: 0.3 },
            { id: 21, name: "Dragonbone Bow", type: "weapon", damage: "25-35", value: 200, level: 6, critChance: 0.2, armorPen: 10 },
            { id: 22, name: "Voidreaver", type: "weapon", damage: "50-60", value: 400, level: 10, voidDamage: 25, lifesteal: 0.15 },
            { id: 23, name: "Staff of Storms", type: "weapon", damage: "15-20", magicDamage: 40, value: 300, level: 8, lightningDamage: 20 },
            { id: 24, name: "Bloodthirster", type: "weapon", damage: "45-55", value: 350, level: 9, lifesteal: 0.25, critChance: 0.15 },
            { id: 25, name: "Titan's Hammer", type: "weapon", damage: "60-70", value: 450, level: 12, stunChance: 0.2, armorPen: 15 }
        ],
        armor: [
            { id: 10, name: "Leather Armor", type: "armor", defense: 8, value: 30, level: 1 },
            { id: 11, name: "Chainmail", type: "armor", defense: 15, value: 70, level: 2 },
            { id: 12, name: "Plate Armor", type: "armor", defense: 25, value: 150, level: 4, blockChance: 0.1 },
            { id: 13, name: "Mage Robes", type: "armor", defense: 12, magicResist: 20, value: 90, level: 3, manaRegen: 3 },
            { id: 14, name: "Shadow Cloak", type: "armor", defense: 10, dodgeChance: 0.2, value: 120, level: 4 },
            { id: 26, name: "Dragon Scale Armor", type: "armor", defense: 35, value: 300, level: 8, fireResist: 25 },
            { id: 27, name: "Celestial Plate", type: "armor", defense: 40, value: 400, level: 10, magicResist: 30, healthRegen: 5 },
            { id: 28, name: "Voidwalker Mantle", type: "armor", defense: 25, value: 350, level: 9, dodgeChance: 0.3, stealthBonus: 0.2 },
            { id: 29, name: "Titan's Cuirass", type: "armor", defense: 50, value: 500, level: 12, blockChance: 0.2, strengthBonus: 5 },
            { id: 30, name: "Archmage's Vestments", type: "armor", defense: 20, value: 450, level: 11, magicResist: 40, manaRegen: 10 }
        ],
        consumables: [
            { id: 15, name: "Health Potion", type: "consumable", effect: { health: 50 }, value: 30 },
            { id: 16, name: "Mana Potion", type: "consumable", effect: { mana: 40 }, value: 35 },
            { id: 17, name: "Elixir of Strength", type: "consumable", effect: { strength: 5 }, duration: 5, value: 70 },
            { id: 18, name: "Scroll of Fireball", type: "consumable", effect: { damage: 60 }, value: 60 },
            { id: 19, name: "Potion of Vitality", type: "consumable", effect: { maxHealth: 20 }, permanent: true, value: 100 },
            { id: 31, name: "Elixir of Dexterity", type: "consumable", effect: { dexterity: 5 }, duration: 5, value: 70 },
            { id: 32, name: "Elixir of Intelligence", type: "consumable", effect: { intelligence: 5 }, duration: 5, value: 70 },
            { id: 33, name: "Potion of Invisibility", type: "consumable", effect: { stealth: 3 }, value: 120 },
            { id: 34, name: "Scroll of Lightning", type: "consumable", effect: { damage: 80 }, value: 80 },
            { id: 35, name: "Phoenix Down", type: "consumable", effect: { revive: true }, value: 200 }
        ],
        questItems: [
            { id: 36, name: "Goblin Ear", type: "quest", value: 5, description: "Proof of a goblin slain" },
            { id: 37, name: "Wolf Pelt", type: "quest", value: 10, description: "Fur from a forest wolf" },
            { id: 38, name: "Ancient Relic", type: "quest", value: 100, description: "Mysterious artifact from the ruins" },
            { id: 39, name: "Demon Heart", type: "quest", value: 150, description: "Still beating with dark energy" },
            { id: 40, name: "Dragon Scale", type: "quest", value: 200, description: "Hardened scale from a mighty dragon" }
        ]
    },
    shopItems: [],
    gameLog: [], // Empty array to start
    classDescriptions: {
        warrior: "The Warrior excels in close combat with high health and strength. Can wear heavy armor and wield powerful weapons. Starts with higher health and strength but lower mana. Skills include Taunt and Battle Cry.",
        mage: "The Mage harnesses arcane power to cast devastating spells. High intelligence boosts magical damage. Starts with powerful spells but lower health and armor. Skills include Fireball and Mana Shield.",
        rogue: "The Rogue relies on speed and precision. High dexterity increases critical hit chance and dodge. Starts with high crit chance and evasion but lower defense. Skills include Backstab and Smoke Bomb."
    },
    classSkills: {
        warrior: [
            { name: "Taunt", cost: 10, description: "Forces enemy to focus on you, reducing their damage by 30% for 3 turns" },
            { name: "Battle Cry", cost: 15, description: "Increases your strength by 5 for 5 turns" }
        ],
        mage: [
            { name: "Fireball", cost: 20, damage: 40, description: "Hurls a fiery projectile at the enemy" },
            { name: "Mana Shield", cost: 25, description: "Absorbs 50% of damage with mana for 3 turns" }
        ],
        rogue: [
            { name: "Backstab", cost: 15, damageMultiplier: 2, requiresStealth: true, description: "Deals double damage when stealthed" },
            { name: "Smoke Bomb", cost: 20, description: "Grants stealth for 3 turns" }
        ]
    },
    quests: [
        { 
            id: 1, 
            name: "Goblin Menace", 
            description: "Defeat 5 Goblins in the Forest", 
            objective: { type: "kill", target: "Goblin", count: 5, current: 0 }, 
            reward: { gold: 100, xp: 150, item: 15 }, 
            area: "Forest", 
            level: 1 
        },
        { 
            id: 2, 
            name: "Wolf Pelt Collection", 
            description: "Collect 3 Wolf Pelts (drops from Wolves)", 
            objective: { type: "collect", target: "Wolf Pelt", count: 3, current: 0 }, 
            reward: { gold: 150, xp: 200, item: 17 }, 
            area: "Forest", 
            level: 2 
        },
        { 
            id: 3, 
            name: "Bandit Patrol", 
            description: "Eliminate 4 Bandits in the Forest", 
            objective: { type: "kill", target: "Bandit", count: 4, current: 0 }, 
            reward: { gold: 200, xp: 300, item: 11 }, 
            area: "Forest", 
            level: 3 
        },
        { 
            id: 4, 
            name: "Cave Exploration", 
            description: "Defeat 3 Cave Spiders and 2 Skeletons", 
            objective: { type: "kill", target: ["Cave Spider", "Skeleton"], count: [3, 2], current: [0, 0] }, 
            reward: { gold: 300, xp: 400, item: 26 }, 
            area: "Caves", 
            level: 4 
        },
        { 
            id: 5, 
            name: "Ancient Relics", 
            description: "Recover 2 Ancient Relics from the Ruins", 
            objective: { type: "collect", target: "Ancient Relic", count: 2, current: 0 }, 
            reward: { gold: 500, xp: 600, item: 22 }, 
            area: "Ruins", 
            level: 7 
        },
        { 
            id: 6, 
            name: "Demon Slayer", 
            description: "Defeat the Elder Demon in the Abyss", 
            objective: { type: "kill", target: "Elder Demon", count: 1, current: 0 }, 
            reward: { gold: 1000, xp: 1500, item: 29 }, 
            area: "Abyss", 
            level: 15 
        }
    ],
    bosses: {
        "Forest": { name: "Ancient Treant", health: 300, maxHealth: 300, damage: "30-40", xp: 500, gold: "400-500", level: 5, regen: 10, area: "Forest" },
        "Caves": { name: "Cave Dragon", health: 500, maxHealth: 500, damage: "40-50", xp: 800, gold: "700-800", level: 8, fireDamage: 20, area: "Caves" },
        "Ruins": { name: "Lich King", health: 800, maxHealth: 800, damage: "50-60", xp: 1200, gold: "1000-1200", level: 12, magicDamage: 30, area: "Ruins" },
        "Dungeon": { name: "Dungeon Overlord", health: 1200, maxHealth: 1200, damage: "60-70", xp: 1800, gold: "1500-1700", level: 16, armor: 30, area: "Dungeon" },
        "Abyss": { name: "Lord of Darkness", health: 1500, maxHealth: 1500, damage: "80-100", xp: 2500, gold: "2000-2500", level: 25, lifesteal: 0.3, area: "Abyss" }
    },
    bossDefeated: {},
    achievements: [
        { id: 1, name: "First Blood", description: "Defeat your first enemy", unlocked: false },
        { id: 2, name: "Novice Adventurer", description: "Reach level 5", unlocked: false },
        { id: 3, name: "Master Adventurer", description: "Reach level 10", unlocked: false },
        { id: 4, name: "Legendary Hero", description: "Reach level 20", unlocked: false },
        { id: 5, name: "Treasure Hunter", description: "Collect 10,000 gold", unlocked: false },
        { id: 6, name: "Bane of the Forest", description: "Defeat the Ancient Treant", unlocked: false },
        { id: 7, name: "Dragon Slayer", description: "Defeat the Cave Dragon", unlocked: false },
        { id: 8, name: "Undead Destroyer", description: "Defeat the Lich King", unlocked: false },
        { id: 9, name: "Dungeon Delver", description: "Defeat the Dungeon Overlord", unlocked: false },
        { id: 10, name: "Darkness Vanquished", description: "Defeat the Lord of Darkness", unlocked: false }
    ]
};

// Audio elements
const bgMusic = document.getElementById("background-music");
const combatSound = document.getElementById("combat-sound");
const victorySound = document.getElementById("victory-sound");

// Initialize the game
function initGame() {
    updateGameScreen();
    generateShopItems();
    generateQuests();
    
    // Try to play background music (may be blocked by browser autoplay policies)
    try {
        bgMusic.volume = 0.3;
        bgMusic.play().catch(e => console.log("Autoplay prevented:", e));
    } catch (e) {
        console.log("Audio error:", e);
    }
}

// Toggle background music
function toggleMusic() {
    if (bgMusic.paused) {
        bgMusic.play();
        addToGameLog("Music enabled");
    } else {
        bgMusic.pause();
        addToGameLog("Music disabled");
    }
}

// Save game to localStorage
function saveGame() {
    try {
        localStorage.setItem("hollowlands_save", JSON.stringify(gameState));
        addToGameLog("Game saved successfully!");
        showAchievement("Game Saved", "Your progress has been saved");
    } catch (e) {
        addToGameLog("Failed to save game: " + e.message);
    }
}

// Load game from localStorage
function loadGame() {
    try {
        const savedGame = localStorage.getItem("hollowlands_save");
        if (savedGame) {
            const parsed = JSON.parse(savedGame);
            Object.assign(gameState, parsed);
            addToGameLog("Game loaded successfully!");
            updateGameScreen();
            showAchievement("Game Loaded", "Your progress has been restored");
        } else {
            addToGameLog("No saved game found");
        }
    } catch (e) {
        addToGameLog("Failed to load game: " + e.message);
    }
}

// Show achievement notification
function showAchievement(title, description) {
    const toast = document.getElementById("achievement-toast");
    const desc = document.getElementById("achievement-desc");
    
    toast.querySelector(".achievement-title").textContent = title;
    desc.textContent = description;
    
    toast.classList.add("show");
    
    setTimeout(() => {
        toast.classList.remove("show");
    }, 3000);
}

// Check for achievements
function checkAchievements() {
    const player = gameState.player;
    
    // First Blood
    if (!gameState.achievements[0].unlocked && player.quests.completed.length > 0) {
        gameState.achievements[0].unlocked = true;
        showAchievement("First Blood", "Defeat your first enemy");
    }
    
    // Level-based achievements
    if (!gameState.achievements[1].unlocked && player.level >= 5) {
        gameState.achievements[1].unlocked = true;
        showAchievement("Novice Adventurer", "Reached level 5");
    }
    
    if (!gameState.achievements[2].unlocked && player.level >= 10) {
        gameState.achievements[2].unlocked = true;
        showAchievement("Master Adventurer", "Reached level 10");
    }
    
    if (!gameState.achievements[3].unlocked && player.level >= 20) {
        gameState.achievements[3].unlocked = true;
        showAchievement("Legendary Hero", "Reached level 20");
    }
    
    // Gold achievement
    if (!gameState.achievements[4].unlocked && player.gold >= 10000) {
        gameState.achievements[4].unlocked = true;
        showAchievement("Treasure Hunter", "Collected 10,000 gold");
    }
    
    // Boss achievements
    if (!gameState.achievements[5].unlocked && gameState.bossDefeated["Forest"]) {
        gameState.achievements[5].unlocked = true;
        showAchievement("Bane of the Forest", "Defeated the Ancient Treant");
    }
    
    if (!gameState.achievements[6].unlocked && gameState.bossDefeated["Caves"]) {
        gameState.achievements[6].unlocked = true;
        showAchievement("Dragon Slayer", "Defeated the Cave Dragon");
    }
    
    if (!gameState.achievements[7].unlocked && gameState.bossDefeated["Ruins"]) {
        gameState.achievements[7].unlocked = true;
        showAchievement("Undead Destroyer", "Defeated the Lich King");
    }
    
    if (!gameState.achievements[8].unlocked && gameState.bossDefeated["Dungeon"]) {
        gameState.achievements[8].unlocked = true;
        showAchievement("Dungeon Delver", "Defeated the Dungeon Overlord");
    }
    
    if (!gameState.achievements[9].unlocked && gameState.bossDefeated["Abyss"]) {
        gameState.achievements[9].unlocked = true;
        showAchievement("Darkness Vanquished", "Defeated the Lord of Darkness");
    }
}

// Update the main game screen with the game log
function updateGameScreen() {
    const gameScreen = document.getElementById("game-screen");
    gameScreen.innerHTML = gameState.gameLog.slice(-10).join("<br>");
    gameScreen.scrollTop = gameScreen.scrollHeight;

    updatePlayerStats();
}

// Update player stats display
function updatePlayerStats() {
    const statsElement = document.getElementById("player-stats");
    const player = gameState.player;

    let statsHTML = `[${player.name}] <span class="class-${player.class}">${player.class ? player.class.toUpperCase() : ''}</span> Lvl:${player.level} `;
    statsHTML += `<span class="health">HP:${player.health}/${player.maxHealth}</span> `;

    if (player.class === 'mage' || player.class === 'warrior') {
        statsHTML += `<span class="mana">MP:${player.mana}/${player.maxMana}</span> `;
    }

    statsHTML += `<span class="xp">XP:${player.xp}/${player.xpToNextLevel}</span> `;
    statsHTML += `<span class="gold">Gold:${player.gold}</span>`;

    // Add progress bars
    statsHTML += `<div class="progress-container"><div class="progress-bar health-bar" style="width: ${(player.health / player.maxHealth) * 100}%"></div></div>`;

    if (player.class === 'mage' || player.class === 'warrior') {
        statsHTML += `<div class="progress-container"><div class="progress-bar mana-bar" style="width: ${(player.mana / player.maxMana) * 100}%"></div></div>`;
    }

    statsHTML += `<div class="progress-container"><div class="progress-bar xp-bar" style="width: ${(player.xp / player.xpToNextLevel) * 100}%"></div></div>`;

    if (player.equippedWeapon) {
        statsHTML += `<br>Weapon: <span class="item">${player.equippedWeapon.name}</span> (${player.equippedWeapon.damage})`;
    }

    if (player.equippedArmor) {
        statsHTML += ` | Armor: <span class="item">${player.equippedArmor.name}</span> (Def:${player.equippedArmor.defense})`;
    }

    // Show active buffs/debuffs
    if (player.buffs.length > 0 || player.debuffs.length > 0) {
        statsHTML += `<br>Status: `;
        player.buffs.forEach(buff => {
            statsHTML += `<span class="heal">${buff.name}</span> (${buff.duration}), `;
        });
        player.debuffs.forEach(debuff => {
            statsHTML += `<span class="debuff">${debuff.name}</span> (${debuff.duration}), `;
        });
        statsHTML = statsHTML.slice(0, -2); // Remove trailing comma
    }

    statsElement.innerHTML = statsHTML;
}

// Show different game screens
function showScreen(screen) {
    document.getElementById("explore-screen").style.display = "none";
    document.getElementById("character-screen").style.display = "none";
    document.getElementById("inventory-screen").style.display = "none";
    document.getElementById("shop-screen").style.display = "none";
    document.getElementById("combat-screen").style.display = "none";
    document.getElementById("quests-screen").style.display = "none";
    document.getElementById("main-buttons").style.display = "flex";

    if (screen === "explore") {
        document.getElementById("explore-screen").style.display = "block";
        addToGameLog(`You are exploring the ${gameState.player.currentArea}.`);
    } else if (screen === "character") {
        document.getElementById("character-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showCharacterScreen();
    } else if (screen === "inventory") {
        document.getElementById("inventory-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showInventory();
    } else if (screen === "shop") {
        document.getElementById("shop-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showShop();
    } else if (screen === "main") {
        // Already handled by hiding others
    } else if (screen === "combat") {
        document.getElementById("combat-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        updateCombatScreen();
    } else if (screen === "quests") {
        document.getElementById("quests-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showQuests();
    }

    updateGameScreen();
}

// Add message to game log
function addToGameLog(message) {
    gameState.gameLog.push(message);
    if (gameState.gameLog.length > 50) {
        gameState.gameLog.shift();
    }
    updateGameScreen();
}

// Explore area function
function exploreArea() {
    const player = gameState.player;

    // Check for boss spawn (5% chance if not already defeated)
    if (!gameState.bossDefeated[player.currentArea] && Math.random() < 0.05) {
        startBossFight();
        return;
    }

    // Chance to find combat, items, or nothing
    const roll = Math.random();

    if (roll < 0.7) { // 70% chance for combat
        startCombat();
    } else if (roll < 0.9) { // 20% chance to find item
        findItem();
    } else { // 10% chance to find nothing
        addToGameLog("You explore the area but find nothing of interest.");
    }
}

// Start a boss fight
function startBossFight() {
    const player = gameState.player;
    const boss = {...gameState.bosses[player.currentArea]};

    // Scale boss stats based on player level
    const levelDiff = player.level - boss.level;
    if (levelDiff > 0) {
        boss.health = Math.floor(boss.health * (1 + levelDiff * 0.1));
        boss.maxHealth = boss.health;
        const damageRange = boss.damage.split("-").map(Number);
        damageRange[0] = Math.floor(damageRange[0] * (1 + levelDiff * 0.1));
        damageRange[1] = Math.floor(damageRange[1] * (1 + levelDiff * 0.1));
        boss.damage = damageRange.join("-");
    }

    gameState.player.inCombat = true;
    gameState.player.currentEnemy = boss;

    addToGameLog(`<span class="enemy">A terrifying ${boss.name} (Lvl ${boss.level}) appears!</span>`);
    addToGameLog("<span class='important'>BOSS FIGHT!</span>");
    
    // Play combat music
    try {
        bgMusic.pause();
        combatSound.currentTime = 0;
        combatSound.play();
    } catch (e) {
        console.log("Audio error:", e);
    }
    
    showScreen("combat");
}

function changeArea() {
    const player = gameState.player;
    const availableAreas = gameState.areas.filter(area => area.unlocked && area.name !== player.currentArea);

    if (availableAreas.length === 0) {
        addToGameLog("No other areas are available yet. Keep leveling up!");
        return;
    }

    // Create a container for the area selection
    const areaSelection = document.createElement("div");
    areaSelection.innerHTML = "<h3>Available Areas:</h3>";
    
    availableAreas.forEach(area => {
        const areaBtn = document.createElement("button");
        areaBtn.className = "game-button";
        areaBtn.style.textAlign = "left";
        areaBtn.style.margin = "2px 0";
        areaBtn.style.padding = "5px";
        areaBtn.innerHTML = `${area.name} (Recommended Level: ${area.minLevel})<br><small>${area.description}</small>`;
        areaBtn.onclick = function() { travelToArea(area.name); };
        areaSelection.appendChild(areaBtn);
        areaSelection.appendChild(document.createElement("br"));
    });

    // Replace the explore screen content while preserving the button row
    const exploreScreen = document.getElementById("explore-screen");
    exploreScreen.innerHTML = "";
    exploreScreen.appendChild(areaSelection);
    
    // Re-add the button row
    const buttonRow = document.createElement("div");
    buttonRow.className = "button-row";
    buttonRow.innerHTML = `
        <button class="game-button" onclick="showScreen('explore')">BACK</button>
    `;
    exploreScreen.appendChild(buttonRow);
}

function travelToArea(areaName) {
    const player = gameState.player;
    player.currentArea = areaName;
    addToGameLog(`You travel to the ${areaName}.`);
    
    // Restore the original explore screen content
    document.getElementById("explore-screen").innerHTML = `
        <div class="button-row">
            <button class="game-button" onclick="exploreArea()">EXPLORE</button>
            <button class="game-button" onclick="rest()">REST</button>
            <button class="game-button" onclick="changeArea()">MOVE AREA</button>
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    `;
    
    // Add visual feedback
    document.getElementById("game-screen").classList.add("fade-in");
    setTimeout(() => {
        document.getElementById("game-screen").classList.remove("fade-in");
    }, 500);
}

// Start combat with random enemy
function startCombat() {
    const player = gameState.player;
    const areaEnemies = gameState.enemies[player.currentArea];
    const randomEnemy = {...areaEnemies[Math.floor(Math.random() * areaEnemies.length)]};

    // Scale enemy stats based on player level
    const levelDiff = player.level - randomEnemy.level;
    if (levelDiff > 0) {
        randomEnemy.health = Math.floor(randomEnemy.health * (1 + levelDiff * 0.1));
        randomEnemy.maxHealth = randomEnemy.health;
        const damageRange = randomEnemy.damage.split("-").map(Number);
        damageRange[0] = Math.floor(damageRange[0] * (1 + levelDiff * 0.1));
        damageRange[1] = Math.floor(damageRange[1] * (1 + levelDiff * 0.1));
        randomEnemy.damage = damageRange.join("-");
    }

    gameState.player.inCombat = true;
    gameState.player.currentEnemy = randomEnemy;

    addToGameLog(`<span class="enemy">A ${randomEnemy.name} (Lvl ${randomEnemy.level}) appears!</span>`);
    
    // Play combat music
    try {
        bgMusic.pause();
        combatSound.currentTime = 0;
        combatSound.play();
    } catch (e) {
        console.log("Audio error:", e);
    }
    
    showScreen("combat");
}

// Update combat screen
function updateCombatScreen() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    if (!enemy) return;

    let combatHTML = `<span class="enemy">${enemy.name} (Lvl ${enemy.level})</span><br>`;
    combatHTML += `<span class="health">HP: ${enemy.health}/${enemy.maxHealth}</span>`;
    combatHTML += `<div class="enemy-health-container"><div class="enemy-health-bar" style="width: ${(enemy.health / enemy.maxHealth) * 100}%"></div></div><br>`;

    // Show enemy special abilities
    if (enemy.poisonChance) {
        combatHTML += `<span class="debuff">Poisonous</span> `;
    }
    if (enemy.regen) {
        combatHTML += `<span class="heal">Regenerates</span> `;
    }
    if (enemy.lifesteal) {
        combatHTML += `<span class="damage">Lifesteal</span> `;
    }
    if (enemy.armor) {
        combatHTML += `<span class="important">Armored</span> `;
    }

    combatHTML += `<br><br>What will you do?`;

    document.getElementById("combat-info").innerHTML = combatHTML;

    // Create combat actions
    const actionsDiv = document.getElementById("combat-actions");
    actionsDiv.innerHTML = "";

    // Basic attack
    const attackBtn = document.createElement("button");
    attackBtn.className = "game-button";
    attackBtn.textContent = "ATTACK";
    attackBtn.onclick = function() { playerAttack(); };
    actionsDiv.appendChild(attackBtn);

    // Class skills
    player.skills.forEach(skill => {
        const skillBtn = document.createElement("button");
        skillBtn.className = "game-button";
        skillBtn.textContent = skill.name.toUpperCase();
        skillBtn.onclick = function() { useSkill(skill); };

        // Disable if not enough mana or requires stealth
        if (player.mana < skill.cost) {
            skillBtn.disabled = true;
        }
        if (skill.requiresStealth && !player.stealth) {
            skillBtn.disabled = true;
        }

        actionsDiv.appendChild(skillBtn);
    });

    // Flee button
    const fleeBtn = document.createElement("button");
    fleeBtn.className = "game-button";
    fleeBtn.textContent = "FLEE";
    fleeBtn.onclick = function() { attemptFlee(); };
    actionsDiv.appendChild(fleeBtn);

    // Use item button
    const itemsBtn = document.createElement("button");
    itemsBtn.className = "game-button";
    itemsBtn.textContent = "ITEMS";
    itemsBtn.onclick = function() { showCombatItems(); };
    actionsDiv.appendChild(itemsBtn);
}

// Player attack in combat
function playerAttack() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    if (!enemy) return;

    let damage = 5; // Base damage

    // Calculate damage based on weapon
    if (player.equippedWeapon) {
        const damageRange = player.equippedWeapon.damage.split("-").map(Number);
        damage = Math.floor(Math.random() * (damageRange[1] - damageRange[0] + 1)) + damageRange[0];

        // Add strength bonus for physical attacks
        if (player.class === 'warrior' || player.class === 'rogue') {
            damage += Math.floor(player.strength / 2);
        }

        // Check for critical hit (rogue has higher chance)
        let critChance = 0.1; // Base 10% chance
        if (player.equippedWeapon.critChance) {
            critChance += player.equippedWeapon.critChance;
        }
        if (player.class === 'rogue') {
            critChance += player.dexterity / 100;
        }
        if (player.stealth) {
            critChance += 0.3; // Bonus crit chance from stealth
        }

        if (Math.random() < critChance) {
            damage *= 2;
            addToGameLog(`<span class="critical">Critical hit!</span> You attack the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
        } else {
            addToGameLog(`You attack the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
        }

        // Check for weapon special effects
        if (player.equippedWeapon.poisonDamage) {
            addToGameLog(`<span class="debuff">Your weapon poisons the enemy for ${player.equippedWeapon.poisonDamage} damage!</span>`);
            enemy.health -= player.equippedWeapon.poisonDamage;
        }
        if (player.equippedWeapon.frostDamage && Math.random() < 0.3) {
            addToGameLog(`<span class="debuff">Your weapon slows the enemy!</span>`);
        }
    } else {
        // Bare hands
        damage += Math.floor(player.strength / 3);
        addToGameLog(`You punch the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
    }

    // Apply enemy armor reduction
    if (enemy.armor) {
        const armorPen = player.equippedWeapon?.armorPen || 0;
        damage = Math.max(1, damage - Math.max(0, enemy.armor - armorPen));
    }

    enemy.health -= damage;

    // Check for lifesteal
    if (player.equippedWeapon && player.equippedWeapon.lifesteal) {
        const healAmount = Math.floor(damage * player.equippedWeapon.lifesteal);
        player.health = Math.min(player.maxHealth, player.health + healAmount);
        addToGameLog(`You steal <span class="heal">${healAmount}</span> health!`);
    }

    // Check if enemy is defeated
    if (enemy.health <= 0) {
        enemy.health = 0;
        defeatEnemy();
    } else {
        // Enemy attacks back
        enemyAttack();
    }

    // Break stealth after attacking
    if (player.stealth) {
        player.stealth = false;
        addToGameLog("<span class='debuff'>You are no longer stealthed!</span>");
    }

    // Add visual feedback
    document.getElementById("combat-info").classList.add("combat-shake");
    setTimeout(() => {
        document.getElementById("combat-info").classList.remove("combat-shake");
    }, 500);
    
    updateCombatScreen();
}

// Use skill in combat
function useSkill(skill) {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    if (!enemy) return;

    // Deduct mana cost
    player.mana -= skill.cost;

    // Handle different skills
    if (skill.damageMultiplier) {
        let damage = 5; // Base damage

        if (player.equippedWeapon) {
            const damageRange = player.equippedWeapon.damage.split("-").map(Number);
            damage = Math.floor(Math.random() * (damageRange[1] - damageRange[0] + 1)) + damageRange[0];
        }

        damage = Math.floor(damage * skill.damageMultiplier);

        // Add stat bonuses
        if (player.class === 'warrior') {
            damage += Math.floor(player.strength / 2);
        } else if (player.class === 'rogue') {
            damage += Math.floor(player.dexterity / 2);
        } else if (player.class === 'mage') {
            damage += Math.floor(player.intelligence);
        }

        addToGameLog(`You use <span class="important">${skill.name}</span> on the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
        enemy.health -= damage;
    } else if (skill.damage) {
        let damage = skill.damage;

        // Mage spells scale with intelligence
        if (player.class === 'mage') {
            damage += Math.floor(player.intelligence * 1.5);
        }

        addToGameLog(`You use <span class="important">${skill.name}</span> on the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
        enemy.health -= damage;
    } else if (skill.effect) {
        addToGameLog(`You use <span class="important">${skill.name}</span>: ${skill.description}`);

        // Handle specific effects
        if (skill.name === "Taunt") {
            // Apply debuff to enemy
            if (!enemy.debuffs) enemy.debuffs = [];
            enemy.debuffs.push({
                name: "Taunted",
                duration: 3,
                effect: "damageReduction",
                amount: 0.3
            });
        } else if (skill.name === "Battle Cry") {
            // Apply buff to player
            player.buffs.push({
                name: "Battle Cry",
                duration: 5,
                effect: "strength",
                amount: 5
            });
            player.strength += 5;
        } else if (skill.name === "Mana Shield") {
            player.buffs.push({
                name: "Mana Shield",
                duration: 3,
                effect: "manaShield"
            });
        } else if (skill.name === "Smoke Bomb") {
            player.stealth = true;
            player.stealthTurns = 3;
        }
    }

    // Check for freeze effect
    if (skill.freezeChance && Math.random() < skill.freezeChance) {
        addToGameLog(`<span class="debuff">The ${enemy.name} is frozen!</span>`);
        if (!enemy.debuffs) enemy.debuffs = [];
        enemy.debuffs.push({
            name: "Frozen",
            duration: 1,
            effect: "stun"
        });
    }

    // Check if enemy is defeated
    if (enemy.health <= 0) {
        enemy.health = 0;
        defeatEnemy();
        return;
    }

    // Break stealth after using skill (unless it's a stealth skill)
    if (player.stealth && skill.name !== "Smoke Bomb") {
        player.stealth = false;
        addToGameLog("<span class='debuff'>You are no longer stealthed!</span>");
    }

    // Enemy attacks back
    enemyAttack();

    // Add visual feedback
    document.getElementById("combat-info").classList.add("combat-flash");
    setTimeout(() => {
        document.getElementById("combat-info").classList.remove("combat-flash");
    }, 300);
    
    updateCombatScreen();
}

// Enemy attack in combat
function enemyAttack() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    if (!enemy) return;

    // Check if enemy is stunned
    if (enemy.debuffs && enemy.debuffs.some(d => d.effect === "stun")) {
        addToGameLog(`<span class="important">The ${enemy.name} is stunned and can't attack!</span>`);
        // Reduce stun duration
        enemy.debuffs.forEach(debuff => {
            if (debuff.effect === "stun") debuff.duration--;
        });
        enemy.debuffs = enemy.debuffs.filter(d => d.duration > 0);
        return;
    }

    // Check if player is stealthed (enemy might miss)
    if (player.stealth && Math.random() < 0.5) {
        addToGameLog(`<span class="important">The ${enemy.name} can't find you in the shadows!</span>`);
        return;
    }

    // Calculate enemy damage
    let damage;
    if (typeof enemy.damage === "string") {
        const damageRange = enemy.damage.split("-").map(Number);
        damage = Math.floor(Math.random() * (damageRange[1] - damageRange[0] + 1)) + damageRange[0];
    } else {
        damage = enemy.damage;
    }

    // Apply damage reduction if taunted
    if (enemy.debuffs && enemy.debuffs.some(d => d.effect === "damageReduction")) {
        const reduction = enemy.debuffs.find(d => d.effect === "damageReduction").amount;
        damage = Math.floor(damage * (1 - reduction));
    }

    // Check for enemy critical hit
    if (enemy.critChance && Math.random() < enemy.critChance) {
        damage *= 2;
        addToGameLog(`<span class="critical">The ${enemy.name} lands a critical hit!</span>`);
    }

    // Add any special damage types
    if (enemy.fireDamage) {
        damage += enemy.fireDamage;
        addToGameLog(`<span class="debuff">The attack burns you for ${enemy.fireDamage} extra damage!</span>`);
    }
    if (enemy.poisonDamage && Math.random() < enemy.poisonChance) {
        addToGameLog(`<span class="debuff">You are poisoned for ${enemy.poisonDamage} damage per turn!</span>`);
        if (!player.debuffs) player.debuffs = [];
        player.debuffs.push({
            name: "Poison",
            duration: 3,
            effect: "damage",
            amount: enemy.poisonDamage
        });
    }
    if (enemy.charmChance && Math.random() < enemy.charmChance) {
        addToGameLog(`<span class="debuff">You are charmed and can't attack next turn!</span>`);
        player.debuffs.push({
            name: "Charmed",
            duration: 1,
            effect: "stun"
        });
    }

    // Reduce damage by armor if equipped
    if (player.equippedArmor) {
        damage -= player.equippedArmor.defense;
        if (damage < 1) damage = 1; // Minimum 1 damage

        // Check for block chance
        if (player.equippedArmor.blockChance && Math.random() < player.equippedArmor.blockChance) {
            damage = 0;
            addToGameLog(`<span class="important">Your armor blocks the attack!</span>`);
        }
    }

    // Rogue has chance to dodge
    if (player.class === 'rogue') {
        const dodgeChance = 0.1 + (player.dexterity / 200);
        if (player.equippedArmor && player.equippedArmor.dodgeChance) {
            dodgeChance += player.equippedArmor.dodgeChance;
        }

        if (Math.random() < dodgeChance) {
            addToGameLog(`<span class="important">You dodge the ${enemy.name}'s attack!</span>`);
            return;
        }
    }

    // Check for mana shield
    if (player.buffs.some(b => b.effect === "manaShield")) {
        const manaDamage = Math.floor(damage / 2);
        if (player.mana >= manaDamage) {
            player.mana -= manaDamage;
            damage = Math.floor(damage / 2);
            addToGameLog(`<span class="important">Your mana shield absorbs some damage!</span>`);
        } else {
            player.buffs = player.buffs.filter(b => b.effect !== "manaShield");
            addToGameLog(`<span class="debuff">Your mana shield breaks!</span>`);
        }
    }

    player.health -= damage;
    addToGameLog(`The ${enemy.name} attacks you for <span class="damage">${damage}</span> damage!`);

    // Check for enemy lifesteal
    if (enemy.lifesteal) {
        const enemyHeal = Math.floor(damage * enemy.lifesteal);
        enemy.health = Math.min(enemy.maxHealth, enemy.health + enemyHeal);
        addToGameLog(`The ${enemy.name} heals for <span class="heal">${enemyHeal}</span> health!`);
    }

    // Check for enemy regen
    if (enemy.regen) {
        enemy.health = Math.min(enemy.maxHealth, enemy.health + enemy.regen);
    }

    // Apply poison/DoT effects
    if (player.debuffs && player.debuffs.length > 0) {
        player.debuffs.forEach(debuff => {
            if (debuff.effect === "damage") {
                player.health -= debuff.amount;
                addToGameLog(`<span class="debuff">You take ${debuff.amount} damage from ${debuff.name}!</span>`);
            }
            debuff.duration--;
        });
        player.debuffs = player.debuffs.filter(d => d.duration > 0);
    }

    // Apply buff/debuff expiration
    player.buffs.forEach(buff => buff.duration--);
    player.buffs = player.buffs.filter(b => b.duration > 0);

    // Check if player is defeated
    if (player.health <= 0) {
        player.health = 0;
        addToGameLog(`<span class="enemy">You have been defeated by the ${enemy.name}!</span>`);
        addToGameLog("You wake up back at camp, having lost some gold and items...");

        // Lose some gold and items
        let goldLost;
        if (typeof enemy.gold === "string") {
            const goldRange = enemy.gold.split("-").map(Number);
            goldLost = Math.floor(Math.random() * (goldRange[1] - goldRange[0] + 1)) + goldRange[0];
        } else {
            goldLost = Math.floor(enemy.gold * 0.5);
        }

        player.gold -= goldLost;
        if (player.gold < 0) player.gold = 0;

        // Lose a random item (10% chance for each item)
        for (let i = player.inventory.length - 1; i >= 0; i--) {
            if (Math.random() < 0.1) {
                addToGameLog(`You lost your ${player.inventory[i].name} in the fight!`);
                player.inventory.splice(i, 1);
            }
        }

        // Reset health
        player.health = Math.floor(player.maxHealth / 3);
        if (player.class === 'mage' || player.class === 'warrior') {
            player.mana = Math.floor(player.maxMana / 3);
        }

        // End combat
        gameState.player.inCombat = false;
        gameState.player.currentEnemy = null;
        
        // Stop combat music, resume background
        try {
            combatSound.pause();
            bgMusic.currentTime = 0;
            bgMusic.play();
        } catch (e) {
            console.log("Audio error:", e);
        }
        
        showScreen("main");
    }
    
    // Add visual feedback
    document.getElementById("player-stats").classList.add("combat-shake");
    setTimeout(() => {
        document.getElementById("player-stats").classList.remove("combat-shake");
    }, 500);
}

// Attempt to flee from combat
function attemptFlee() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    // Rogue has higher chance to flee
    let fleeChance = 0.4;
    if (player.class === 'rogue') {
        fleeChance = 0.6;
    }

    // Reduce chance if enemy is faster
    if (enemy.level > player.level) {
        fleeChance -= 0.1 * (enemy.level - player.level);
    }

    if (Math.random() < fleeChance) {
        addToGameLog(`You successfully flee from the ${enemy.name}!`);
        gameState.player.inCombat = false;
        gameState.player.currentEnemy = null;
        
        // Stop combat music, resume background
        try {
            combatSound.pause();
            bgMusic.currentTime = 0;
            bgMusic.play();
        } catch (e) {
            console.log("Audio error:", e);
        }
        
        showScreen("main");
    } else {
        addToGameLog(`You fail to flee from the ${enemy.name}!`);
        enemyAttack();
    }
}

// Show items during combat
function showCombatItems() {
    const player = gameState.player;
    const consumables = player.inventory.filter(item => item.type === "consumable");

    const actionsDiv = document.getElementById("combat-actions");
    actionsDiv.innerHTML = "";

    if (consumables.length === 0) {
        const noItemsBtn = document.createElement("button");
        noItemsBtn.className = "game-button";
        noItemsBtn.textContent = "NO ITEMS";
        noItemsBtn.disabled = true;
        actionsDiv.appendChild(noItemsBtn);
    } else {
        consumables.forEach(item => {
            const itemBtn = document.createElement("button");
            itemBtn.className = "game-button";
            itemBtn.textContent = item.name.toUpperCase();
            itemBtn.onclick = function() { useItem(item); };
            actionsDiv.appendChild(itemBtn);
        });
    }

    const backBtn = document.createElement("button");
    backBtn.className = "game-button";
    backBtn.textContent = "BACK";
    backBtn.onclick = function() { updateCombatScreen(); };
    actionsDiv.appendChild(backBtn);
}

// Use item during combat
function useItem(item) {
    const player = gameState.player;

    if (item.effect.health) {
        player.health += item.effect.health;
        if (player.health > player.maxHealth) player.health = player.maxHealth;
        addToGameLog(`You use ${item.name} and restore <span class="heal">${item.effect.health}</span> health!`);
    } else if (item.effect.mana) {
        player.mana += item.effect.mana;
        if (player.mana > player.maxMana) player.mana = player.maxMana;
        addToGameLog(`You use ${item.name} and restore <span class="heal">${item.effect.mana}</span> mana!`);
    } else if (item.effect.damage) {
        const enemy = gameState.player.currentEnemy;
        enemy.health -= item.effect.damage;
        addToGameLog(`You use ${item.name} and deal <span class="damage">${item.effect.damage}</span> damage to the ${enemy.name}!`);

        if (enemy.health <= 0) {
            enemy.health = 0;
            defeatEnemy();
            return;
        }
    } else if (item.effect.stealth) {
        player.stealth = true;
        player.stealthTurns = item.effect.stealth;
        addToGameLog(`You use ${item.name} and vanish into the shadows for ${item.effect.stealth} turns!`);
    }

    // Remove item from inventory
    const itemIndex = player.inventory.findIndex(i => i.id === item.id);
    if (itemIndex !== -1) {
        player.inventory.splice(itemIndex, 1);
    }

    // Enemy still gets an attack
    enemyAttack();

    updateCombatScreen();
}

// Defeat enemy in combat
function defeatEnemy() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    addToGameLog(`<span class="important">You defeated the ${enemy.name}!</span>`);

    // Check if this was a boss
    if (gameState.bosses[player.currentArea]?.name === enemy.name) {
        gameState.bossDefeated[player.currentArea] = true;
        addToGameLog(`<span class="important">You have defeated the ${player.currentArea} boss!</span>`);
        
        // Play victory sound
        try {
            combatSound.pause();
            victorySound.currentTime = 0;
            victorySound.play();
            setTimeout(() => {
                bgMusic.currentTime = 0;
                bgMusic.play();
            }, 3000);
        } catch (e) {
            console.log("Audio error:", e);
        }
    } else {
        // Resume normal music
        try {
            combatSound.pause();
            bgMusic.currentTime = 0;
            bgMusic.play();
        } catch (e) {
            console.log("Audio error:", e);
        }
    }

    // Gain XP
    const xpGain = enemy.xp;
    player.xp += xpGain;
    addToGameLog(`You gain <span class="xp">${xpGain} XP</span>!`);

    // Gain gold
    let goldGain;
    if (typeof enemy.gold === "string") {
        const goldRange = enemy.gold.split("-").map(Number);
        goldGain = Math.floor(Math.random() * (goldRange[1] - goldRange[0] + 1)) + goldRange[0];
    } else {
        goldGain = enemy.gold;
    }
    player.gold += goldGain;
    addToGameLog(`You find <span class="gold">${goldGain} gold</span> on the ${enemy.name}.`);

    // Check for quest progress
    updateQuestProgress(enemy.name);

    // Small chance to find item
    if (Math.random() < 0.4) {
        findItem(enemy.name);
    }

    // Check for level up
    checkLevelUp();

    // Check for area unlocks
    checkAreaUnlocks();
    
    // Check for achievements
    checkAchievements();

    // End combat
    gameState.player.inCombat = false;
    gameState.player.currentEnemy = null;
    showScreen("main");
}

// Check if player levels up
function checkLevelUp() {
    const player = gameState.player;

    if (player.xp >= player.xpToNextLevel) {
        player.level++;
        player.xp -= player.xpToNextLevel;
        player.xpToNextLevel = Math.floor(player.xpToNextLevel * 1.5);

        // Increase stats based on class
        if (player.class === 'warrior') {
            player.maxHealth += 25;
            player.health += 25;
            player.strength += 4;
            player.constitution += 3;
            player.dexterity += 1;
            player.maxMana += 5;
            player.mana += 5;
        } else if (player.class === 'mage') {
            player.maxHealth += 12;
            player.health += 12;
            player.maxMana += 20;
            player.mana += 20;
            player.intelligence += 5;
            player.dexterity += 1;
        } else if (player.class === 'rogue') {
            player.maxHealth += 18;
            player.health += 18;
            player.dexterity += 4;
            player.strength += 2;
            player.constitution += 2;
        }

        addToGameLog(`<span class="important">You leveled up to level ${player.level}!</span>`);
        addToGameLog(`Your stats have improved!`);

        // Check for another level up (unlikely but possible)
        checkLevelUp();
    }
}

// Check if new areas should be unlocked
function checkAreaUnlocks() {
    const player = gameState.player;
    gameState.areas.forEach(area => {
        if (!area.unlocked && player.level >= area.minLevel) {
            area.unlocked = true;
            addToGameLog(`<span class="important">New area unlocked: ${area.name}!</span>`);
        }
    });
}

// Find random item
function findItem(source) {
    const player = gameState.player;
    const allItems = [...gameState.items.weapons, ...gameState.items.armor, ...gameState.items.consumables, ...gameState.items.questItems];
    const randomItem = {...allItems[Math.floor(Math.random() * allItems.length)]};

    // Only find items appropriate for player level
    if (randomItem.level && randomItem.level > player.level) {
        // Try again for a lower level item
        return findItem(source);
    }

    // Special drops from certain enemies
    if (source === "Goblin" && Math.random() < 0.3) {
        const questItem = {...gameState.items.questItems.find(i => i.name === "Goblin Ear")};
        player.inventory.push(questItem);
        addToGameLog(`You found a <span class="item">${questItem.name}</span>!`);
        return;
    } else if (source === "Wolf" && Math.random() < 0.3) {
        const questItem = {...gameState.items.questItems.find(i => i.name === "Wolf Pelt")};
        player.inventory.push(questItem);
        addToGameLog(`You found a <span class="item">${questItem.name}</span>!`);
        return;
    } else if (source === "Ancient Treant" && Math.random() < 0.8) {
        const specialItem = {...gameState.items.consumables.find(i => i.id === 19)};
        player.inventory.push(specialItem);
        addToGameLog(`You found a <span class="item">${specialItem.name}</span>!`);
        return;
    }

    player.inventory.push(randomItem);
    addToGameLog(`You found a <span class="item">${randomItem.name}</span>!`);
}

// Rest to recover health and mana
function rest() {
    const player = gameState.player;

    const healthRecovered = Math.floor(player.maxHealth * 0.5);
    player.health = Math.min(player.maxHealth, player.health + healthRecovered);

    if (player.class === 'mage' || player.class === 'warrior') {
        const manaRecovered = Math.floor(player.maxMana * 0.5);
        player.mana = Math.min(player.maxMana, player.mana + manaRecovered);
    }

    // Apply regen from armor
    if (player.equippedArmor?.healthRegen) {
        player.health = Math.min(player.maxHealth, player.health + player.equippedArmor.healthRegen);
    }
    if (player.equippedArmor?.manaRegen) {
        player.mana = Math.min(player.maxMana, player.mana + player.equippedArmor.manaRegen);
    }

    addToGameLog(`You rest and recover <span class="heal">${healthRecovered}</span> health.`);
    updatePlayerStats();
}

// Show character screen
function showCharacterScreen() {
    const player = gameState.player;
    let charHTML = `<span class="class-${player.class}">${player.class.toUpperCase()}</span> Level: ${player.level}<br>`;
    charHTML += `XP: ${player.xp}/${player.xpToNextLevel}<br><br>`;
    charHTML += `<span class="health">Health: ${player.health}/${player.maxHealth}</span><br>`;

    if (player.class === 'mage' || player.class === 'warrior') {
        charHTML += `<span class="mana">Mana: ${player.mana}/${player.maxMana}</span><br>`;
    }

    charHTML += `<br><strong>Stats:</strong><br>`;
    charHTML += `Strength: ${player.strength}<br>`;
    charHTML += `Dexterity: ${player.dexterity}<br>`;
    charHTML += `Intelligence: ${player.intelligence}<br>`;
    charHTML += `Constitution: ${player.constitution}<br><br>`;

    charHTML += `<strong>Equipment:</strong><br>`;
    charHTML += `Weapon: ${player.equippedWeapon ? player.equippedWeapon.name : "None"}<br>`;
    charHTML += `Armor: ${player.equippedArmor ? player.equippedArmor.name : "None"}<br><br>`;

    charHTML += `<strong>Current Area:</strong> ${player.currentArea}<br>`;
    charHTML += `<strong>Unlocked Areas:</strong> `;
    charHTML += gameState.areas.filter(a => a.unlocked).map(a => a.name).join(", ");

    document.getElementById("character-info").innerHTML = charHTML;
}

// Show inventory
function showInventory() {
    const player = gameState.player;
    const inventoryDiv = document.getElementById("inventory-items");

    if (player.inventory.length === 0) {
        inventoryDiv.innerHTML = "Your inventory is empty.";
        document.getElementById("item-details").innerHTML = "";
        return;
    }

    let inventoryHTML = "<h3>Inventory:</h3>";
    inventoryHTML += `<span class="gold">Gold: ${player.gold}</span><br><br>`;

    // Group items by type
    const weapons = player.inventory.filter(item => item.type === "weapon");
    const armor = player.inventory.filter(item => item.type === "armor");
    const consumables = player.inventory.filter(item => item.type === "consumable");
    const questItems = player.inventory.filter(item => item.type === "quest");

    if (weapons.length > 0) {
        inventoryHTML += "<strong>Weapons:</strong><br>";
        weapons.forEach(weapon => {
            inventoryHTML += `<button class="game-button" onclick="showItemDetails(${weapon.id})" style="text-align:left;margin:2px 0;padding:5px;">${weapon.name} (${weapon.damage})</button><br>`;
        });
    }

    if (armor.length > 0) {
        inventoryHTML += "<br><strong>Armor:</strong><br>";
        armor.forEach(armorItem => {
            inventoryHTML += `<button class="game-button" onclick="showItemDetails(${armorItem.id})" style="text-align:left;margin:2px 0;padding:5px;">${armorItem.name} (Def:${armorItem.defense})</button><br>`;
        });
    }

    if (consumables.length > 0) {
        inventoryHTML += "<br><strong>Consumables:</strong><br>";
        consumables.forEach(consumable => {
            inventoryHTML += `<button class="game-button" onclick="showItemDetails(${consumable.id})" style="text-align:left;margin:2px 0;padding:5px;">${consumable.name}</button><br>`;
        });
    }

    if (questItems.length > 0) {
        inventoryHTML += "<br><strong>Quest Items:</strong><br>";
        questItems.forEach(questItem => {
            inventoryHTML += `<button class="game-button" onclick="showItemDetails(${questItem.id})" style="text-align:left;margin:2px 0;padding:5px;">${questItem.name}</button><br>`;
        });
    }

    inventoryDiv.innerHTML = inventoryHTML;
}

// Show item details
function showItemDetails(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);

    if (!item) return;

    let detailsHTML = `<div class="item-info"><h3>${item.name}</h3>`;

    if (item.type === "weapon") {
        detailsHTML += `Type: Weapon<br>`;
        detailsHTML += `Damage: ${item.damage}<br>`;
        if (item.magicDamage) {
            detailsHTML += `Magic Damage: +${item.magicDamage}<br>`;
        }
        if (item.critChance) {
            detailsHTML += `Crit Chance: +${Math.floor(item.critChance * 100)}%<br>`;
        }
        if (item.lifesteal) {
            detailsHTML += `Lifesteal: ${Math.floor(item.lifesteal * 100)}%<br>`;
        }
        if (item.poisonDamage) {
            detailsHTML += `Poison Damage: ${item.poisonDamage}<br>`;
        }
        if (item.frostDamage) {
            detailsHTML += `Frost Damage: ${item.frostDamage}<br>`;
        }
        if (item.armorPen) {
            detailsHTML += `Armor Penetration: ${item.armorPen}<br>`;
        }
        detailsHTML += `Level: ${item.level}<br>`;
        detailsHTML += `Value: ${item.value} gold<br><br>`;

        // Equip button if not already equipped
        if (player.equippedWeapon && player.equippedWeapon.id === item.id) {
            detailsHTML += `<button class="game-button" disabled>EQUIPPED</button> `;
        } else {
            detailsHTML += `<button class="game-button" onclick="equipItem(${item.id})">EQUIP</button> `;
        }
    } else if (item.type === "armor") {
        detailsHTML += `Type: Armor<br>`;
        detailsHTML += `Defense: ${item.defense}<br>`;
        if (item.magicResist) {
            detailsHTML += `Magic Resist: +${item.magicResist}<br>`;
        }
        if (item.dodgeChance) {
            detailsHTML += `Dodge Chance: +${Math.floor(item.dodgeChance * 100)}%<br>`;
        }
        if (item.blockChance) {
            detailsHTML += `Block Chance: +${Math.floor(item.blockChance * 100)}%<br>`;
        }
        if (item.manaRegen) {
            detailsHTML += `Mana Regen: +${item.manaRegen}/turn<br>`;
        }
        if (item.healthRegen) {
            detailsHTML += `Health Regen: +${item.healthRegen}/turn<br>`;
        }
        if (item.strengthBonus) {
            detailsHTML += `Strength Bonus: +${item.strengthBonus}<br>`;
        }
        detailsHTML += `Level: ${item.level}<br>`;
        detailsHTML += `Value: ${item.value} gold<br><br>`;

        // Equip button if not already equipped
        if (player.equippedArmor && player.equippedArmor.id === item.id) {
            detailsHTML += `<button class="game-button" disabled>EQUIPPED</button> `;
        } else {
            detailsHTML += `<button class="game-button" onclick="equipItem(${item.id})">EQUIP</button> `;
        }
    } else if (item.type === "consumable") {
        detailsHTML += `Type: Consumable<br>`;
        if (item.effect.health) {
            detailsHTML += `Restores ${item.effect.health} health<br>`;
        } else if (item.effect.mana) {
            detailsHTML += `Restores ${item.effect.mana} mana<br>`;
        } else if (item.effect.damage) {
            detailsHTML += `Deals ${item.effect.damage} damage<br>`;
        } else if (item.effect.strength) {
            detailsHTML += `+${item.effect.strength} Strength for ${item.duration} turns<br>`;
        } else if (item.effect.maxHealth) {
            detailsHTML += `Permanently increases max health by ${item.effect.maxHealth}<br>`;
        } else if (item.effect.stealth) {
            detailsHTML += `Grants stealth for ${item.effect.stealth} turns<br>`;
        } else if (item.effect.revive) {
            detailsHTML += `Revives with 50% health when defeated<br>`;
        }
        detailsHTML += `Value: ${item.value} gold<br><br>`;

        detailsHTML += `<button class="game-button" onclick="useInventoryItem(${item.id})">USE</button> `;
    } else if (item.type === "quest") {
        detailsHTML += `Type: Quest Item<br>`;
        detailsHTML += `${item.description}<br>`;
        detailsHTML += `Value: ${item.value} gold<br><br>`;
    }

    if (item.type !== "quest") {
        detailsHTML += `<button class="game-button" onclick="sellItem(${item.id})">SELL</button>`;
    } else {
        detailsHTML += `<button class="game-button" disabled>CAN'T SELL</button>`;
    }
    detailsHTML += `</div>`;

    document.getElementById("item-details").innerHTML = detailsHTML;
}

// Equip item
function equipItem(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);

    if (!item) return;

    if (item.type === "weapon") {
        // Check level requirement
        if (item.level > player.level) {
            addToGameLog(`You need to be level ${item.level} to equip this weapon!`);
            return;
        }

        // Unequip current weapon if any
        if (player.equippedWeapon) {
            player.inventory.push(player.equippedWeapon);
        }
        player.equippedWeapon = item;

        // Remove from inventory
        const itemIndex = player.inventory.findIndex(i => i.id === item.id);
        if (itemIndex !== -1) {
            player.inventory.splice(itemIndex, 1);
        }

        addToGameLog(`You equipped the ${item.name}.`);
    } else if (item.type === "armor") {
        // Check level requirement
        if (item.level > player.level) {
            addToGameLog(`You need to be level ${item.level} to equip this armor!`);
            return;
        }

        // Unequip current armor if any
        if (player.equippedArmor) {
            player.inventory.push(player.equippedArmor);
        }
        player.equippedArmor = item;

        // Remove from inventory
        const itemIndex = player.inventory.findIndex(i => i.id === item.id);
        if (itemIndex !== -1) {
            player.inventory.splice(itemIndex, 1);
        }

        addToGameLog(`You equipped the ${item.name}.`);
    }

    showInventory();
    updatePlayerStats();
}

// Use item from inventory (outside combat)
function useInventoryItem(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);

    if (!item) return;

    if (item.effect.health) {
        player.health += item.effect.health;
        if (player.health > player.maxHealth) player.health = player.maxHealth;
        addToGameLog(`You use ${item.name} and restore <span class="heal">${item.effect.health}</span> health!`);
    } else if (item.effect.mana) {
        player.mana += item.effect.mana;
        if (player.mana > player.maxMana) player.mana = player.maxMana;
        addToGameLog(`You use ${item.name} and restore <span class="heal">${item.effect.mana}</span> mana!`);
    } else if (item.effect.maxHealth) {
        player.maxHealth += item.effect.maxHealth;
        player.health += item.effect.maxHealth;
        addToGameLog(`You use ${item.name} and permanently increase your max health by <span class="heal">${item.effect.maxHealth}</span>!`);
    } else if (item.effect.strength) {
        player.strength += item.effect.strength;
        player.buffs.push({
            name: "Strength Potion",
            duration: item.duration,
            effect: "strength",
            amount: item.effect.strength
        });
        addToGameLog(`You use ${item.name} and gain <span class="heal">+${item.effect.strength} Strength</span> for ${item.duration} turns!`);
    } else if (item.effect.revive) {
        addToGameLog(`You save the ${item.name} for when you might need it.`);
    }

    // Remove item from inventory if not permanent
    if (!item.effect.revive) {
        const itemIndex = player.inventory.findIndex(i => i.id === item.id);
        if (itemIndex !== -1) {
            player.inventory.splice(itemIndex, 1);
        }
    }

    showInventory();
    updatePlayerStats();
}

// Sell item
function sellItem(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);

    if (!item) return;

    // Can't sell equipped items
    if ((player.equippedWeapon && player.equippedWeapon.id === item.id) ||
        (player.equippedArmor && player.equippedArmor.id === item.id)) {
        addToGameLog("You can't sell equipped items!");
        return;
    }

    const sellValue = Math.floor(item.value * 0.75);
    player.gold += sellValue;

    // Remove from inventory
    const itemIndex = player.inventory.findIndex(i => i.id === item.id);
    if (itemIndex !== -1) {
        player.inventory.splice(itemIndex, 1);
    }

    addToGameLog(`You sold ${item.name} for <span class="gold">${sellValue} gold</span>.`);
    showInventory();
    updatePlayerStats();
}

// Generate shop items
function generateShopItems() {
    const player = gameState.player;
    gameState.shopItems = [];

    // Generate 3 weapons, 2 armor, and 3 consumables
    const allWeapons = gameState.items.weapons.filter(w => w.level <= player.level + 2);
    const allArmor = gameState.items.armor.filter(a => a.level <= player.level + 2);
    const allConsumables = gameState.items.consumables;

    // Add random weapons
    for (let i = 0; i < 3; i++) {
        if (allWeapons.length > 0) {
            const randomWeapon = {...allWeapons[Math.floor(Math.random() * allWeapons.length)]};
            gameState.shopItems.push(randomWeapon);
        }
    }

    // Add random armor
    for (let i = 0; i < 2; i++) {
        if (allArmor.length > 0) {
            const randomArmor = {...allArmor[Math.floor(Math.random() * allArmor.length)]};
            gameState.shopItems.push(randomArmor);
        }
    }

    // Add random consumables
    for (let i = 0; i < 3; i++) {
        if (allConsumables.length > 0) {
            const randomConsumable = {...allConsumables[Math.floor(Math.random() * allConsumables.length)]};
            gameState.shopItems.push(randomConsumable);
        }
    }
}

// Show shop
function showShop() {
    const player = gameState.player;
    const shopDiv = document.getElementById("shop-items");

    if (gameState.shopItems.length === 0) {
        shopDiv.innerHTML = "The shop is currently empty.";
        return;
    }

    let shopHTML = "<h3>Shop:</h3>";
    shopHTML += `<span class="gold">Your gold: ${player.gold}</span><br><br>`;

    gameState.shopItems.forEach(item => {
        shopHTML += `<div style="margin-bottom:10px;border-bottom:1px solid #333;padding-bottom:5px;">`;
        shopHTML += `<strong>${item.name}</strong> - ${item.value} gold<br>`;

        if (item.type === "weapon") {
            shopHTML += `Damage: ${item.damage} `;
            if (item.magicDamage) shopHTML += `+ ${item.magicDamage} magic `;
            if (item.critChance) shopHTML += `(${Math.floor(item.critChance * 100)}% crit) `;
            if (item.lifesteal) shopHTML += `(${Math.floor(item.lifesteal * 100)}% lifesteal) `;
            shopHTML += `| Level: ${item.level}`;
        } else if (item.type === "armor") {
            shopHTML += `Defense: ${item.defense} `;
            if (item.magicResist) shopHTML += `Magic Resist: ${item.magicResist} `;
            if (item.dodgeChance) shopHTML += `Dodge: ${Math.floor(item.dodgeChance * 100)}% `;
            if (item.blockChance) shopHTML += `Block: ${Math.floor(item.blockChance * 100)}% `;
            shopHTML += `| Level: ${item.level}`;
        } else if (item.type === "consumable") {
            if (item.effect.health) {
                shopHTML += `Restores ${item.effect.health} health `;
            } else if (item.effect.mana) {
                shopHTML += `Restores ${item.effect.mana} mana `;
            } else if (item.effect.damage) {
                shopHTML += `Deals ${item.effect.damage} damage `;
            } else if (item.effect.maxHealth) {
                shopHTML += `+${item.effect.maxHealth} max HP `;
            } else if (item.effect.stealth) {
                shopHTML += `Grants stealth for ${item.effect.stealth} turns `;
            }
        }

        shopHTML += `<br><button class="game-button" onclick="buyItem(${item.id})" ${player.gold < item.value ? "disabled" : ""}>BUY</button>`;
        shopHTML += `</div>`;
    });

    shopDiv.innerHTML = shopHTML;
}

// Refresh shop items
function refreshShop() {
    const player = gameState.player;
    if (player.gold < 50) {
        addToGameLog("You need 50 gold to refresh the shop!");
        return;
    }

    player.gold -= 50;
    generateShopItems();
    showShop();
    addToGameLog("The shopkeeper brings out new items... (-50 gold)");
    updatePlayerStats();
}

// Buy item from shop
function buyItem(itemId) {
    const player = gameState.player;
    const item = gameState.shopItems.find(i => i.id === itemId);

    if (!item) return;

    if (player.gold >= item.value) {
        player.gold -= item.value;
        player.inventory.push({...item});

        // Remove from shop
        const itemIndex = gameState.shopItems.findIndex(i => i.id === item.id);
        if (itemIndex !== -1) {
            gameState.shopItems.splice(itemIndex, 1);
        }

        addToGameLog(`You bought ${item.name} for <span class="gold">${item.value} gold</span>.`);
        showShop();
        updatePlayerStats();
    } else {
        addToGameLog("Not enough gold!");
    }
}

// Generate quests
function generateQuests() {
    const player = gameState.player;
    const availableQuests = gameState.quests.filter(q => q.level <= player.level && 
        !gameState.player.quests.active.some(aq => aq.id === q.id) &&
        !gameState.player.quests.completed.some(cq => cq.id === q.id));

    // Add up to 3 available quests
    for (let i = 0; i < Math.min(3, availableQuests.length); i++) {
        const quest = {...availableQuests[i]};
        gameState.player.quests.active.push(quest);
        addToGameLog(`New quest available: ${quest.name}`);
    }
}

// Show quests screen
function showQuests() {
    const player = gameState.player;
    const activeQuestsDiv = document.getElementById("active-quests");
    const completedQuestsDiv = document.getElementById("completed-quests");

    let activeHTML = "<h3>Active Quests:</h3>";
    if (player.quests.active.length === 0) {
        activeHTML += "No active quests.<br>";
    } else {
        player.quests.active.forEach(quest => {
            activeHTML += `<div class="quest quest-active">`;
            activeHTML += `<strong>${quest.name}</strong><br>`;
            activeHTML += `${quest.description}<br>`;

            if (quest.objective.type === "kill") {
                if (Array.isArray(quest.objective.target)) {
                    quest.objective.target.forEach((target, idx) => {
                        activeHTML += `${target}: ${quest.objective.current[idx]}/${quest.objective.count[idx]}<br>`;
                    });
                } else {
                    activeHTML += `${quest.objective.target}: ${quest.objective.current}/${quest.objective.count}<br>`;
                }
            } else if (quest.objective.type === "collect") {
                activeHTML += `${quest.objective.target}: ${quest.objective.current}/${quest.objective.count}<br>`;
            }

            activeHTML += `Reward: ${quest.reward.gold} gold, ${quest.reward.xp} XP`;
            if (quest.reward.item) {
                const item = gameState.items.weapons.concat(gameState.items.armor, gameState.items.consumables)
                    .find(i => i.id === quest.reward.item);
                if (item) {
                    activeHTML += `, ${item.name}`;
                }
            }
            activeHTML += `</div>`;
        });
    }

    let completedHTML = "<h3>Completed Quests:</h3>";
    if (player.quests.completed.length === 0) {
        completedHTML += "No completed quests.<br>";
    } else {
        player.quests.completed.forEach(quest => {
            completedHTML += `<div class="quest quest-completed">`;
            completedHTML += `<strong>${quest.name}</strong><br>`;
            completedHTML += `${quest.description}<br>`;
            completedHTML += `Reward: ${quest.reward.gold} gold, ${quest.reward.xp} XP`;
            if (quest.reward.item) {
                const item = gameState.items.weapons.concat(gameState.items.armor, gameState.items.consumables)
                    .find(i => i.id === quest.reward.item);
                if (item) {
                    completedHTML += `, ${item.name}`;
                }
            }
            completedHTML += `</div>`;
        });
    }

    activeQuestsDiv.innerHTML = activeHTML;
    completedQuestsDiv.innerHTML = completedHTML;
}

// Update quest progress
function updateQuestProgress(enemyName) {
    const player = gameState.player;

    player.quests.active.forEach(quest => {
        if (quest.objective.type === "kill") {
            if (Array.isArray(quest.objective.target)) {
                const targetIndex = quest.objective.target.indexOf(enemyName);
                if (targetIndex !== -1 && quest.objective.current[targetIndex] < quest.objective.count[targetIndex]) {
                    quest.objective.current[targetIndex]++;
                    addToGameLog(`Quest progress: ${quest.name} (${quest.objective.current[targetIndex]}/${quest.objective.count[targetIndex]} ${enemyName}s)`);
                }
            } else if (quest.objective.target === enemyName && quest.objective.current < quest.objective.count) {
                quest.objective.current++;
                addToGameLog(`Quest progress: ${quest.name} (${quest.objective.current}/${quest.objective.count} ${enemyName}s)`);
            }
        }
    });

    // Check for completed quests
    for (let i = player.quests.active.length - 1; i >= 0; i--) {
        const quest = player.quests.active[i];
        let isComplete = false;

        if (quest.objective.type === "kill") {
            if (Array.isArray(quest.objective.target)) {
                isComplete = quest.objective.target.every((_, idx) => 
                    quest.objective.current[idx] >= quest.objective.count[idx]);
            } else {
                isComplete = quest.objective.current >= quest.objective.count;
            }
        } else if (quest.objective.type === "collect") {
            // Check inventory for collected items
            const itemCount = player.inventory.filter(i => i.name === quest.objective.target).length;
            isComplete = itemCount >= quest.objective.count;
        }

        if (isComplete) {
            completeQuest(i);
        }
    }
}

// Complete a quest
function completeQuest(index) {
    const player = gameState.player;
    const quest = player.quests.active[index];

    // Give rewards
    player.gold += quest.reward.gold;
    player.xp += quest.reward.xp;
    addToGameLog(`<span class="important">Quest completed: ${quest.name}!</span>`);
    addToGameLog(`You received ${quest.reward.gold} gold and ${quest.reward.xp} XP!`);

    // Give item reward if any
    if (quest.reward.item) {
        const item = {...gameState.items.weapons.concat(gameState.items.armor, gameState.items.consumables)
            .find(i => i.id === quest.reward.item)};
        player.inventory.push(item);
        addToGameLog(`You received a <span class="item">${item.name}</span>!`);
    }

    // Remove collected items if needed
    if (quest.objective.type === "collect") {
        const itemsToRemove = quest.objective.count;
        let removed = 0;
        for (let i = player.inventory.length - 1; i >= 0 && removed < itemsToRemove; i--) {
            if (player.inventory[i].name === quest.objective.target) {
                player.inventory.splice(i, 1);
                removed++;
            }
        }
    }

    // Move to completed
    player.quests.completed.push(quest);
    player.quests.active.splice(index, 1);

    // Check for level up
    checkLevelUp();

    // Generate new quests if needed
    if (player.quests.active.length < 3) {
        generateQuests();
    }
}

// Class selection functions
function selectClass(className) {
    const player = gameState.player;
    player.class = className;

    // Set class-specific stats
    if (className === 'warrior') {
        player.maxHealth = 150;
        player.health = 150;
        player.maxMana = 40;
        player.mana = 40;
        player.strength = 18;
        player.dexterity = 8;
        player.intelligence = 5;
        player.constitution = 15;

        // Starting equipment
        player.equippedWeapon = {...gameState.items.weapons.find(w => w.id === 1)}; // Rusty Sword
        player.equippedArmor = {...gameState.items.armor.find(a => a.id === 10)}; // Leather Armor
        player.skills = [...gameState.classSkills.warrior];
    } else if (className === 'mage') {
        player.maxHealth = 90;
        player.health = 90;
        player.maxMana = 100;
        player.mana = 100;
        player.strength = 5;
        player.dexterity = 8;
        player.intelligence = 18;
        player.constitution = 8;

        // Starting equipment
        player.equippedWeapon = {...gameState.items.weapons.find(w => w.id === 6)}; // Staff of Fire
        player.equippedArmor = {...gameState.items.armor.find(a => a.id === 13)}; // Mage Robes
        player.skills = [...gameState.classSkills.mage];
    } else if (className === 'rogue') {
        player.maxHealth = 120;
        player.health = 120;
        player.strength = 8;
        player.dexterity = 18;
        player.intelligence = 8;
        player.constitution = 10;

        // Starting equipment
        player.equippedWeapon = {...gameState.items.weapons.find(w => w.id === 8)}; // Dagger
        player.equippedArmor = {...gameState.items.armor.find(a => a.id === 14)}; // Shadow Cloak
        player.skills = [...gameState.classSkills.rogue];
    }

    // Hide class selection and show main game
    document.getElementById("class-select-screen").style.display = "none";
    document.getElementById("main-buttons").style.display = "flex";

    addToGameLog(`You have chosen the path of the ${className}. Your adventure begins!`);
    updatePlayerStats();

    // Generate initial quests
    generateQuests();
    
    // Initialize the rest of the game
    initGame();
}

// Show class description when hovering over class button
function showClassDescription(className) {
    document.getElementById("class-description").innerHTML = gameState.classDescriptions[className];
}

// Initialize class selection screen
function initClassSelection() {
    document.getElementById("main-buttons").style.display = "none";
    document.getElementById("class-select-screen").style.display = "block";

addToGameLog("Welcome to the Hollowlands! Choose your class to begin...");

    // Add event listeners for class buttons
    document.querySelector(".class-warrior").addEventListener("mouseover", function() { showClassDescription('warrior'); });
    document.querySelector(".class-mage").addEventListener("mouseover", function() { showClassDescription('mage'); });
    document.querySelector(".class-rogue").addEventListener("mouseover", function() { showClassDescription('rogue'); });
}

// Initialize the game when page loads
window.onload = function() {
    initClassSelection();
};
</script>
</body>
</html>
