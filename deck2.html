<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vampires vs Werewolves - Enhanced ASCII Edition</title>
<style>
    body {
        background-color: #111;
        color: #0f0;
        font-family: 'Courier New', monospace;
        margin: 0;
        padding: 20px;
        line-height: 1.4;
        touch-action: manipulation;
    }
    
    #game-container {
        max-width: 90ch;
        margin: 0 auto;
        border: 2px solid #0f0;
        padding: 20px;
        background-color: #000;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
    }
    
    h1, h2, h3 {
        color: #0f0;
        text-align: center;
        border-bottom: 1px solid #0f0;
        padding-bottom: 5px;
    }
    
    h1 {
        font-size: 1.8em;
        margin-top: 0;
        text-shadow: 0 0 5px #0f0;
    }
    
    button {
        background-color: #000;
        color: #0f0;
        border: 1px solid #0f0;
        padding: 8px 15px;
        margin: 5px;
        font-family: 'Courier New', monospace;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9em;
    }
    
    button:hover {
        background-color: #0f0;
        color: #000;
    }
    
    button:active {
        background-color: #090;
        transform: scale(0.98);
    }
    
    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .hidden {
        display: none;
    }
    
    .card {
        border: 1px solid #0f0;
        padding: 12px;
        margin: 8px;
        width: 30ch;
        display: inline-block;
        vertical-align: top;
        transition: all 0.2s;
        position: relative;
        cursor: pointer;
    }
    
    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }
    
    .card h4 {
        margin-top: 0;
        color: #0f0;
        font-size: 1.2em;
    }
    
    .card p {
        margin-bottom: 5px;
        font-size: 0.9em;
    }
    
    .health-bar {
        width: 100%;
        height: 1.2em;
        border: 1px solid #0f0;
        margin: 8px 0;
        position: relative;
        overflow: hidden;
    }
    
    .health-fill {
        height: 100%;
        background-color: #0f0;
        transition: width 0.3s;
    }
    
    .health-text {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        text-align: center;
        line-height: 1.2em;
    }
    
    .energy-orb {
        display: inline-block;
        width: 1.2em;
        height: 1.2em;
        border: 1px solid #0f0;
        margin-right: 5px;
        border-radius: 50%;
    }
    
    .energy-orb.filled {
        background-color: #0f0;
        box-shadow: 0 0 5px #0f0;
    }
    
    #battle-log {
        height: 150px;
        overflow-y: auto;
        border: 1px solid #0f0;
        padding: 8px;
        margin: 15px 0;
        background-color: rgba(0, 20, 0, 0.3);
    }
    
    #battle-log p {
        margin: 8px 0;
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .common { color: #aaa; border-color: #aaa; }
    .rare { color: #55f; border-color: #55f; }
    .epic { color: #f55; border-color: #f55; }
    .legendary { color: #ff5; border-color: #ff5; }
    .ancient { color: #a5f; border-color: #a5f; }
    
    .buff { color: #5f5; }
    .debuff { color: #f55; }
    .bleed { color: #a55; }
    .block { color: #55f; }
    .fire { color: #f80; }
    .holy { color: #ff0; }
    .shadow { color: #a0a; }
    
    .vampire { color: #f55; }
    .werewolf { color: #55f; }
    
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 100;
    }
    
    .modal-content {
        background-color: #000;
        border: 2px solid #0f0;
        padding: 20px;
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
        position: relative;
    }
    
    .close-modal {
        position: absolute;
        top: 5px;
        right: 10px;
        font-size: 1.5em;
        cursor: pointer;
    }
    
    .enemy-avatar {
        font-size: 3em;
        text-align: center;
        margin: 10px 0;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .damage-popup {
        position: absolute;
        color: #f55;
        font-weight: bold;
        animation: floatUp 1s forwards;
        pointer-events: none;
        font-size: 1.2em;
    }
    
    @keyframes floatUp {
        0% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-30px); }
    }
    
    .heal-popup {
        position: absolute;
        color: #5f5;
        font-weight: bold;
        animation: floatUp 1s forwards;
        pointer-events: none;
        font-size: 1.2em;
    }
    
    .shake {
        animation: shake 0.5s;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20%, 60% { transform: translateX(-5px); }
        40%, 80% { transform: translateX(5px); }
    }
    
    .combo-meter {
        height: 5px;
        background-color: #333;
        margin: 10px 0;
        position: relative;
    }
    
    .combo-fill {
        height: 100%;
        background-color: #ff0;
        width: 0%;
        transition: width 0.3s;
    }
    
    .tooltip {
        position: relative;
        display: inline-block;
        cursor: help;
    }
    
    .tooltip .tooltiptext {
        visibility: hidden;
        width: 200px;
        background-color: #000;
        color: #fff;
        text-align: center;
        border: 1px solid #0f0;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }
    
    .talent-node {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 2px solid #0f0;
        border-radius: 50%;
        margin: 10px;
        text-align: center;
        line-height: 40px;
        cursor: pointer;
        position: relative;
    }
    
    .talent-node.unlocked {
        background-color: #0f0;
        color: #000;
    }
    
    .talent-node.locked {
        opacity: 0.5;
    }
    
    .talent-connector {
        position: absolute;
        height: 2px;
        background-color: #0f0;
        top: 50%;
        z-index: -1;
    }
    
    .achievement {
        border: 1px solid #0f0;
        padding: 10px;
        margin: 5px;
        opacity: 0.5;
    }
    
    .achievement.unlocked {
        opacity: 1;
        box-shadow: 0 0 10px #0f0;
    }
    
    .achievement-icon {
        font-size: 2em;
        text-align: center;
        margin-bottom: 5px;
    }
    
    @media (max-width: 768px) {
        .card {
            width: 100%;
            display: block;
        }
        
        #game-container {
            padding: 10px;
        }
        
        button {
            padding: 10px;
            width: 100%;
            margin: 5px 0;
        }
    }
    
    /* Colorblind modes */
    .colorblind-protanopia .common { color: #8dd3c7; border-color: #8dd3c7; }
    .colorblind-protanopia .rare { color: #ffffb3; border-color: #ffffb3; }
    .colorblind-protanopia .epic { color: #bebada; border-color: #bebada; }
    .colorblind-protanopia .legendary { color: #fb8072; border-color: #fb8072; }
    .colorblind-protanopia .ancient { color: #80b1d3; border-color: #80b1d3; }
    
    .colorblind-tritanopia .common { color: #d8b365; border-color: #d8b365; }
    .colorblind-tritanopia .rare { color: #f5f5f5; border-color: #f5f5f5; }
    .colorblind-tritanopia .epic { color: #5ab4ac; border-color: #5ab4ac; }
    .colorblind-tritanopia .legendary { color: #d53e4f; border-color: #d53e4f; }
    .colorblind-tritanopia .ancient { color: #9e0142; border-color: #9e0142; }
</style>
</head>
<body>
<div id="game-container">
    <h1>VAMPIRES vs WEREWOLVES - ENHANCED EDITION</h1>
    
    <!-- SETTINGS SCREEN -->
    <div id="settings-screen">
        <h2>GAME SETTINGS</h2>
        <div style="margin: 20px 0;">
            <h3>ACCESSIBILITY</h3>
            <div>
                <label>Colorblind Mode:</label>
                <select id="colorblind-mode">
                    <option value="none">None</option>
                    <option value="protanopia">Protanopia (Red-Weak)</option>
                    <option value="tritanopia">Tritanopia (Blue-Weak)</option>
                </select>
            </div>
            <div style="margin-top: 10px;">
                <label>Font Size:</label>
                <select id="font-size">
                    <option value="small">Small</option>
                    <option value="medium" selected>Medium</option>
                    <option value="large">Large</option>
                </select>
            </div>
        </div>
        <button onclick="startGame()">START GAME</button>
    </div>

    <!-- CLASS SELECTION -->
    <div id="class-selection" class="hidden">
        <p>Choose your faction:</p>
        <button class="vampire" onclick="chooseClass('Vampire')">VAMPIRE</button>
        <button class="werewolf" onclick="chooseClass('Werewolf')">WEREWOLF</button>
        
        <div style="display: flex; flex-wrap: wrap; justify-content: space-around; margin: 20px 0;">
            <div style="text-align: left; width: 45%; min-width: 300px;">
                <h3 class="vampire">VAMPIRES</h3>
                <ul style="list-style-type: none; padding: 0;">
                    <li>+ Lifesteal abilities</li>
                    <li>+ Shadow magic</li>
                    <li>+ Lower health but higher evasion</li>
                    <li>+ Blood-based powers</li>
                    <li>+ Combo: Shadow Arts (3+ cards: +2 damage per card)</li>
                </ul>
            </div>
            <div style="text-align: left; width: 45%; min-width: 300px;">
                <h3 class="werewolf">WEREWOLVES</h3>
                <ul style="list-style-type: none; padding: 0;">
                    <li>+ Higher health and damage</li>
                    <li>+ Stronger physical attacks</li>
                    <li>+ Pack tactics and regeneration</li>
                    <li>+ Combo: Primal Fury (3+ attacks: +3 damage per attack)</li>
                </ul>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <button onclick="showSettings()">SETTINGS</button>
        </div>
    </div>

    <!-- PLAYER STATS -->
    <div id="stats" class="hidden">
        <h2 id="class-name"></h2>
        
        <div class="health-bar">
            <div class="health-fill" id="player-health-fill"></div>
            <div class="health-text" id="player-health-text"></div>
        </div>
        
        <div style="margin: 10px 0;">
            <span style="color: #ff0;">GOLD: <span id="gold-display">0</span></span>
            <span style="margin-left: 20px; color: #0ff;">LEVEL: <span id="level-display">1</span></span>
            <span style="margin-left: 20px; color: #f0f;">XP: <span id="xp-display">0</span>/<span id="xp-needed">20</span></span>
        </div>
        
        <div class="combo-meter">
            <div class="combo-fill" id="combo-fill"></div>
        </div>
        <div id="combo-text" style="text-align: center; margin-bottom: 10px;"></div>
        
        <div id="status-effects" style="margin: 10px 0;"></div>
        
        <div style="display: flex; flex-wrap: wrap; justify-content: center;">
            <button class="vampire" onclick="startBattle()">START BATTLE</button>
            <button class="werewolf" onclick="enterShop()">ENTER SHOP</button>
            <button style="color: #ff0;" onclick="viewDeck()">VIEW DECK</button>
            <button style="color: #0ff;" onclick="viewTalents()">TALENTS</button>
            <button style="color: #f0f;" onclick="viewAchievements()">ACHIEVEMENTS</button>
        </div>
        
        <div id="deck-info" style="margin-top: 10px;">
            <p>DECK: <span id="deck-count">0</span> | DISCARD: <span id="discard-count">0</span></p>
            <p>NEXT ENEMY: <span id="next-enemy">Hunter</span> <span class="tooltip">(?)
                <span class="tooltiptext" id="next-enemy-tooltip">Basic enemy with no special abilities</span>
            </span></p>
            <p>GAME MODE: <span id="game-mode">Standard</span> <button onclick="toggleGameMode()" style="padding: 2px 5px; font-size: 0.8em;">SWITCH</button></p>
        </div>
    </div>

    <!-- BATTLE SCREEN -->
    <div id="battle" class="hidden">
        <h2 id="battle-title"></h2>
        
        <div class="enemy-avatar" id="enemy-avatar"></div>
        
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap;">
            <div style="text-align: left; min-width: 150px;">
                <h3>YOU</h3>
                <div class="health-bar">
                    <div class="health-fill" id="battle-player-health-fill"></div>
                    <div class="health-text" id="battle-player-health-text"></div>
                </div>
                <div id="battle-status-effects"></div>
            </div>
            
            <div style="text-align: right; min-width: 150px;">
                <h3 id="enemy-name">ENEMY</h3>
                <div class="health-bar">
                    <div class="health-fill" id="enemy-health-fill"></div>
                    <div class="health-text" id="enemy-health-text"></div>
                </div>
                <div id="enemy-status-effects"></div>
            </div>
        </div>
        
        <div class="energy-display" id="energy-display"></div>
        <div class="combo-meter">
            <div class="combo-fill" id="battle-combo-fill"></div>
        </div>
        <div id="battle-combo-text" style="text-align: center; margin-bottom: 10px;"></div>

        <div id="hand" style="margin: 10px 0; display: flex; flex-wrap: wrap; justify-content: center;"></div>

        <div style="display: flex; flex-wrap: wrap; justify-content: center;">
            <button class="vampire" onclick="endTurn()">END TURN</button>
            <button class="werewolf" onclick="toggleInventory()">INVENTORY (<span id="inventory-count">0</span>)</button>
            <button onclick="viewDiscard()">VIEW DISCARD</button>
            <button onclick="fleeBattle()">FLEE</button>
        </div>

        <div id="inventory" class="hidden"></div>
        <div id="game-over-message" class="hidden" style="text-align: center; color: #f55; font-size: 1.5em; margin: 10px 0;"></div>
        <div id="victory-message" class="hidden" style="text-align: center; color: #0f0; font-size: 1.5em; margin: 10px 0;"></div>
        <div id="battle-log"></div>
    </div>

    <!-- REWARD SCREEN -->
    <div id="reward-screen" class="hidden">
        <h2>CHOOSE A REWARD:</h2>
        <div style="margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: center;">
            <button onclick="skipReward()">SKIP REWARD</button>
            <button onclick="getRandomCardReward()">RANDOM CARD (3 CHOICES)</button>
            <button onclick="getGoldReward()">TAKE <span id="gold-reward-amount">50</span> GOLD</button>
            <button onclick="getPotionReward()">RECEIVE POTIONS</button>
            <button onclick="getTalentPoint()">TALENT POINT</button>
        </div>
        <div id="reward-cards" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
    </div>

    <!-- SHOP -->
    <div id="shop" class="hidden">
        <h2>SHOP - (GOLD: <span id="gold" style="color: #ff0;">0</span>)</h2>
        
        <div style="margin: 15px 0; display: flex; flex-wrap: wrap; justify-content: center;">
            <button onclick="buyPotion()">HEALTH POTION (15 GOLD)</button>
            <button onclick="buyEnergyPotion()">ENERGY POTION (20 GOLD)</button>
            <button onclick="upgradeMaxHP()">UPGRADE MAX HP (25 GOLD)</button>
            <button onclick="upgradeEnergy()">UPGRADE MAX ENERGY (30 GOLD)</button>
            <button onclick="removeCard()">REMOVE CARD (25 GOLD)</button>
            <button onclick="buyRandomCard()">RANDOM CARD (20-150 GOLD)</button>
        </div>
        
        <h3>CARDS FOR SALE:</h3>
        <div id="shop-cards" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
        
        <div style="margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: center;">
            <button onclick="exitShop()">EXIT SHOP</button>
            <button onclick="rerollShop()">REROLL SHOP (<span id="reroll-cost">10</span> GOLD)</button>
        </div>
    </div>

    <!-- TALENTS SCREEN -->
    <div id="talents-screen" class="hidden">
        <h2>TALENT TREE - <span id="talent-points">0</span> POINTS AVAILABLE</h2>
        <div id="talents-tree" style="text-align: center;"></div>
        <div style="margin-top: 20px;">
            <button onclick="closeTalents()">BACK</button>
        </div>
    </div>

    <!-- ACHIEVEMENTS SCREEN -->
    <div id="achievements-screen" class="hidden">
        <h2>ACHIEVEMENTS</h2>
        <div id="achievements-list" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
        <div style="margin-top: 20px;">
            <button onclick="closeAchievements()">BACK</button>
        </div>
    </div>
</div>

<!-- DECK VIEW MODAL -->
<div id="deck-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('deck-modal')">×</button>
        <h2>YOUR DECK (<span id="modal-deck-count">0</span> CARDS)</h2>
        <div style="margin-bottom: 10px;">
            <button onclick="sortDeck('name')">SORT BY NAME</button>
            <button onclick="sortDeck('cost')">SORT BY COST</button>
            <button onclick="sortDeck('rarity')">SORT BY RARITY</button>
            <button onclick="sortDeck('type')">SORT BY TYPE</button>
        </div>
        <div id="modal-deck"></div>
    </div>
</div>

<!-- DISCARD VIEW MODAL -->
<div id="discard-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('discard-modal')">×</button>
        <h2>DISCARD PILE (<span id="modal-discard-count">0</span> CARDS)</h2>
        <div id="modal-discard"></div>
    </div>
</div>

<script>
// Game State
let player = {
    class: "",
    maxHP: 0,
    hp: 0,
    inventory: [],
    deck: [],
    level: 1,
    xp: 0,
    maxEnergy: 2,
    buffs: [],
    talents: [],
    talentPoints: 0,
    achievements: [],
    runHistory: [],
    gameMode: "standard" // "standard" or "endless"
};

let deck = [];
let hand = [];
let discard = [];
let energy = 0;
let gold = 50;
let buffedAttack = 0;
let block = 0;
let evadeNextAttack = false;
let enemyBleedStacks = 0;
let enemyBleedDamage = 0;
let shopRerollCost = 10;
let energyCarryover = 0;
let comboCount = 0;
let comboType = "";
let currentEnemyIndex = 0;
let enemiesDefeated = 0;
let damageDealt = 0;
let damageTaken = 0;
let cardsPlayed = 0;
let turnsTaken = 0;
let gameSettings = {
    colorblindMode: "none",
    fontSize: "medium"
};

// Card Database
const vampireCards = [
    {name:"BITE", cost:1, effect:"attack", value:8, rarity:"common", description:"Deal 8 damage", class:"Vampire", type:"attack"},
    {name:"BLOOD DRAIN", cost:2, effect:"lifesteal", value:6, rarity:"rare", description:"Deal 6 damage and heal for 6", class:"Vampire", type:"attack"},
    {name:"DARK MIST", cost:1, effect:"buff", value:3, rarity:"common", description:"Gain +3 attack next turn", class:"Vampire", type:"buff"},
    {name:"NIGHT SLASH", cost:2, effect:"attack", value:10, rarity:"epic", description:"Deal 10 damage", class:"Vampire", type:"attack"},
    {name:"VAMPIRIC TOUCH", cost:3, effect:"lifesteal", value:12, rarity:"epic", description:"Deal 12 damage and heal for 12", class:"Vampire", type:"attack"},
    {name:"SHADOW STEP", cost:1, effect:"evade", value:0, rarity:"rare", description:"Avoid next enemy attack", class:"Vampire", type:"skill"},
    {name:"BLOOD FRENZY", cost:2, effect:"multistrike", value:5, rarity:"rare", description:"Deal 5 damage twice", class:"Vampire", type:"attack"},
    {name:"MOONLIGHT", cost:0, effect:"heal", value:5, rarity:"common", description:"Heal 5 HP", class:"Vampire", type:"heal"},
    {name:"SANGUINE SHIELD", cost:2, effect:"block", value:8, rarity:"rare", description:"Gain 8 block", class:"Vampire", type:"defense"},
    {name:"HEMORRHAGE", cost:3, effect:"bleed", value:4, rarity:"epic", description:"Enemy takes 4 damage each turn for 3 turns", class:"Vampire", type:"attack"},
    {name:"BLOOD PACT", cost:1, effect:"sacrifice", value:5, rarity:"rare", description:"Lose 5 HP, draw 2 cards", class:"Vampire", type:"skill"},
    {name:"NOSFERATU'S KISS", cost:4, effect:"lifesteal", value:15, rarity:"legendary", description:"Deal 15 damage and heal for 15", class:"Vampire", type:"attack"},
    {name:"SHADOW VEIL", cost:2, effect:"evade", value:0, rarity:"epic", description:"Avoid next 2 enemy attacks", class:"Vampire", type:"skill"},
    {name:"CRIMSON RITUAL", cost:3, effect:"buff", value:5, rarity:"rare", description:"Gain +5 attack next 2 turns", class:"Vampire", type:"buff"},
    {name:"BLOOD MOON", cost:4, effect:"aoe", value:10, rarity:"legendary", description:"Deal 10 damage to all enemies", class:"Vampire", type:"attack"},
    {name:"ETERNAL THIRST", cost:2, effect:"lifesteal", value:8, rarity:"epic", description:"Deal 8 damage and heal for 8", class:"Vampire", type:"attack"},
    {name:"SOUL SIPHON", cost:3, effect:"drain", value:10, rarity:"ancient", description:"Deal 10 damage, heal for half", class:"Vampire", type:"attack"},
    {name:"SHADOW STRIKE", cost:1, effect:"attack", value:6, rarity:"common", description:"Deal 6 damage. Combo: +2 damage per combo", class:"Vampire", type:"attack"},
    {name:"DARK EMBRACE", cost:2, effect:"heal", value:8, rarity:"rare", description:"Heal 8 HP. Combo: +2 HP per combo", class:"Vampire", type:"heal"},
    {name:"NIGHTFALL", cost:3, effect:"buff", value:0, rarity:"epic", description:"Next 3 attacks gain lifesteal", class:"Vampire", type:"buff"}
];

const werewolfCards = [
    {name:"CLAW SWIPE", cost:1, effect:"attack", value:7, rarity:"common", description:"Deal 7 damage", class:"Werewolf", type:"attack"},
    {name:"HOWL", cost:1, effect:"buff", value:4, rarity:"common", description:"Gain +4 attack next turn", class:"Werewolf", type:"buff"},
    {name:"REGENERATE", cost:2, effect:"heal", value:8, rarity:"rare", description:"Heal 8 HP", class:"Werewolf", type:"heal"},
    {name:"REND", cost:2, effect:"attack", value:12, rarity:"epic", description:"Deal 12 damage", class:"Werewolf", type:"attack"},
    {name:"SAVAGE STRIKE", cost:3, effect:"attack", value:18, rarity:"epic", description:"Deal 18 damage", class:"Werewolf", type:"attack"},
    {name:"PACK TACTICS", cost:1, effect:"draw", value:1, rarity:"rare", description:"Draw 1 card", class:"Werewolf", type:"skill"},
    {name:"FERAL ROAR", cost:2, effect:"buff", value:6, rarity:"rare", description:"Gain +6 attack next turn", class:"Werewolf", type:"buff"},
    {name:"POUNCE", cost:1, effect:"attack", value:5, rarity:"common", description:"Deal 5 damage", class:"Werewolf", type:"attack"},
    {name:"TOUGH HIDE", cost:2, effect:"block", value:10, rarity:"rare", description:"Gain 10 block", class:"Werewolf", type:"defense"},
    {name:"MOON FRENZY", cost:3, effect:"multistrike", value:8, rarity:"legendary", description:"Deal 8 damage three times", class:"Werewolf", type:"attack"},
    {name:"ALPHA HOWL", cost:2, effect:"buff", value:8, rarity:"epic", description:"Gain +8 attack next turn", class:"Werewolf", type:"buff"},
    {name:"LUNAR BLESSING", cost:3, effect:"heal", value:15, rarity:"epic", description:"Heal 15 HP", class:"Werewolf", type:"heal"},
    {name:"PACK LEADER", cost:2, effect:"draw", value:2, rarity:"rare", description:"Draw 2 cards", class:"Werewolf", type:"skill"},
    {name:"FURY SWIPES", cost:1, effect:"multistrike", value:4, rarity:"common", description:"Deal 4 damage twice", class:"Werewolf", type:"attack"},
    {name:"MOON'S WRATH", cost:4, effect:"attack", value:25, rarity:"legendary", description:"Deal 25 damage", class:"Werewolf", type:"attack"},
    {name:"PRIMAL ROAR", cost:3, effect:"aoe", value:12, rarity:"legendary", description:"Deal 12 damage to all enemies", class:"Werewolf", type:"attack"},
    {name:"ECLIPSE STRIKE", cost:5, effect:"attack", value:30, rarity:"ancient", description:"Deal 30 damage", class:"Werewolf", type:"attack"},
    {name:"PRIMAL STRIKE", cost:1, effect:"attack", value:6, rarity:"common", description:"Deal 6 damage. Combo: +2 damage per combo", class:"Werewolf", type:"attack"},
    {name:"PACK HEAL", cost:2, effect:"heal", value:8, rarity:"rare", description:"Heal 8 HP. Combo: +2 HP per combo", class:"Werewolf", type:"heal"},
    {name:"BERSERK", cost:3, effect:"buff", value:0, rarity:"epic", description:"Next 3 attacks deal +5 damage", class:"Werewolf", type:"buff"}
];

const neutralCards = [
    {name:"QUICK STRIKE", cost:0, effect:"attack", value:3, rarity:"common", description:"Deal 3 damage", type:"attack"},
    {name:"DEFEND", cost:1, effect:"block", value:5, rarity:"common", description:"Gain 5 block", type:"defense"},
    {name:"POWER UP", cost:1, effect:"energy", value:1, rarity:"rare", description:"Gain 1 energy", type:"skill"},
    {name:"SECOND WIND", cost:1, effect:"heal", value:4, rarity:"common", description:"Heal 4 HP", type:"heal"},
    {name:"PRECISION STRIKE", cost:2, effect:"attack", value:9, rarity:"rare", description:"Deal 9 damage", type:"attack"},
    {name:"ADRENALINE", cost:0, effect:"draw", value:1, rarity:"rare", description:"Draw 1 card", type:"skill"},
    {name:"COUNTER", cost:2, effect:"counter", value:6, rarity:"epic", description:"Deal 6 damage when attacked", type:"skill"},
    {name:"TAUNT", cost:1, effect:"taunt", value:0, rarity:"common", description:"Enemy is more likely to attack next turn", type:"skill"},
    {name:"DODGE", cost:1, effect:"evade", value:0, rarity:"rare", description:"50% chance to avoid next attack", type:"skill"},
    {name:"REJUVENATE", cost:2, effect:"heal", value:8, rarity:"rare", description:"Heal 8 HP", type:"heal"},
    {name:"DOUBLE STRIKE", cost:2, effect:"multistrike", value:5, rarity:"epic", description:"Deal 5 damage twice", type:"attack"},
    {name:"LAST STAND", cost:3, effect:"laststand", value:15, rarity:"legendary", description:"Deal 15 damage when below 25% HP", type:"attack"},
    {name:"FIRE STRIKE", cost:2, effect:"attack", value:7, rarity:"rare", description:"Deal 7 fire damage", type:"attack", element:"fire"},
    {name:"HOLY LIGHT", cost:2, effect:"heal", value:10, rarity:"rare", description:"Heal 10 HP", type:"heal", element:"holy"},
    {name:"SHADOW BOLT", cost:2, effect:"attack", value:8, rarity:"rare", description:"Deal 8 shadow damage", type:"attack", element:"shadow"}
];

const talents = {
    vampire: [
        {id: "v1", name: "Bloodlust", description: "Lifesteal effects heal +2 more", cost: 1, requires: [], x: 0, y: 0},
        {id: "v2", name: "Shadow Affinity", description: "Shadow cards cost 1 less energy", cost: 2, requires: ["v1"], x: 1, y: 0},
        {id: "v3", name: "Hemomancy", description: "Bleed effects last +1 turn", cost: 1, requires: ["v1"], x: 1, y: 1},
        {id: "v4", name: "Nightborn", description: "+5 Max HP", cost: 1, requires: [], x: 0, y: 2},
        {id: "v5", name: "Sanguine Mastery", description: "Blood cards deal +2 damage", cost: 2, requires: ["v2", "v3"], x: 2, y: 0.5},
        {id: "v6", name: "Eternal Night", description: "Start combat with +1 energy", cost: 3, requires: ["v5"], x: 3, y: 0.5},
        {id: "v7", name: "Moonlight Veil", description: "Evade effects last +1 turn", cost: 2, requires: ["v4"], x: 1, y: 2},
        {id: "v8", name: "Ancient Bloodline", description: "Heal 5 HP at start of turn", cost: 3, requires: ["v7"], x: 2, y: 2}
    ],
    werewolf: [
        {id: "w1", name: "Primal Strength", description: "Attack cards deal +2 damage", cost: 1, requires: [], x: 0, y: 0},
        {id: "w2", name: "Pack Leader", description: "Draw +1 card at start of turn", cost: 2, requires: ["w1"], x: 1, y: 0},
        {id: "w3", name: "Thick Hide", description: "Block effects are +3 stronger", cost: 1, requires: ["w1"], x: 1, y: 1},
        {id: "w4", name: "Moon Frenzy", description: "+5 Max HP", cost: 1, requires: [], x: 0, y: 2},
        {id: "w5", name: "Alpha Howl", description: "Buff effects are +2 stronger", cost: 2, requires: ["w2", "w3"], x: 2, y: 0.5},
        {id: "w6", name: "Eclipse Power", description: "Start combat with +1 energy", cost: 3, requires: ["w5"], x: 3, y: 0.5},
        {id: "w7", name: "Regeneration", description: "Heal 3 HP at start of turn", cost: 2, requires: ["w4"], x: 1, y: 2},
        {id: "w8", name: "Primal Rage", description: "When below 50% HP, deal +3 damage", cost: 3, requires: ["w7"], x: 2, y: 2}
    ]
};

const achievements = [
    {id: "first_blood", name: "First Blood", description: "Defeat your first enemy", icon: "🩸", unlocked: false},
    {id: "shopaholic", name: "Shopaholic", description: "Spend 200 gold in shops", icon: "🛍️", unlocked: false},
    {id: "combo_master", name: "Combo Master", description: "Reach a 5-card combo", icon: "🌀", unlocked: false},
    {id: "perfect_victory", name: "Perfect Victory", description: "Win a battle without taking damage", icon: "✨", unlocked: false},
    {id: "deck_builder", name: "Deck Builder", description: "Have 20 cards in your deck", icon: "🃏", unlocked: false},
    {id: "legendary_collector", name: "Legendary Collector", description: "Obtain 3 legendary cards", icon: "🌟", unlocked: false},
    {id: "vampire_master", name: "Vampire Master", description: "Complete the game as Vampire", icon: "🧛", unlocked: false},
    {id: "werewolf_master", name: "Werewolf Master", description: "Complete the game as Werewolf", icon: "🐺", unlocked: false},
    {id: "endless_champion", name: "Endless Champion", description: "Reach wave 10 in endless mode", icon: "♾️", unlocked: false},
    {id: "talent_legend", name: "Talent Legend", description: "Unlock all talents", icon: "🎓", unlocked: false}
];

let enemies = [
    { name:"HUNTER", hp:40, maxHP:40, attack:6, ability:"buff", reward:15, description:"Gains strength each turn", avatar:"🧑‍🌾", tooltip:"Gains +2 attack each turn"},
    { name:"PALADIN", hp:60, maxHP:60, attack:8, ability:"smite", reward:25, description:"Occasionally smites for massive damage", avatar:"🧑‍⚖️", tooltip:"30% chance to smite for +5 damage"},
    { name:"DEMON LORD", hp:100, maxHP:100, attack:12, ability:"fireball", reward:40, description:"Casts devastating fire spells", avatar:"👹", tooltip:"40% chance to cast fireball for 10 damage"},
    { name:"UNDEAD HORDE", hp:80, maxHP:80, attack:10, ability:"summon", reward:30, description:"Summons reinforcements", avatar:"🧟", tooltip:"25% chance to heal 10 HP"},
    { name:"DARK SORCERER", hp:70, maxHP:70, attack:15, ability:"curse", reward:35, description:"Inflicts debilitating curses", avatar:"🧙‍♂️", tooltip:"30% chance to curse you for 5 damage"},
    { name:"DRAGON", hp:120, maxHP:120, attack:20, ability:"firebreath", reward:50, description:"Breathes fire every turn", avatar:"🐲", tooltip:"Deals 8 fire damage each turn"},
    { name:"NECROMANCER", hp:90, maxHP:90, attack:12, ability:"raise", reward:45, description:"Raises fallen enemies", avatar:"🧟‍♂️", tooltip:"May revive defeated enemies"},
    { name:"VAMPIRE HUNTER", hp:75, maxHP:75, attack:18, ability:"silver", reward:40, description:"Specialized against vampires", avatar:"🧛‍♀️", tooltip:"Deals +3 damage to vampires"},
    { name:"WEREWOLF HUNTER", hp:85, maxHP:85, attack:16, ability:"silver", reward:40, description:"Specialized against werewolves", avatar:"🐺‍🗡️", tooltip:"Deals +3 damage to werewolves"},
    { name:"ANCIENT LICH", hp:150, maxHP:150, attack:25, ability:"darkmagic", reward:75, description:"Master of dark arts", avatar:"💀", tooltip:"Casts dark magic for 15 damage"}
];

// Endless mode enemies (scaled versions of regular enemies)
const endlessEnemies = [
    { name:"HUNTER PACK", hp:60, maxHP:60, attack:9, ability:"buff", reward:20, description:"Gains strength each turn", avatar:"🧑‍🌾🧑‍🌾", tooltip:"Gains +3 attack each turn"},
    { name:"HOLY PALADIN", hp:90, maxHP:90, attack:12, ability:"smite", reward:35, description:"Frequently smites for massive damage", avatar:"🧑‍⚖️✨", tooltip:"40% chance to smite for +7 damage"},
    { name:"INFERNAL LORD", hp:150, maxHP:150, attack:18, ability:"fireball", reward:60, description:"Casts powerful fire spells", avatar:"👹🔥", tooltip:"50% chance to cast fireball for 15 damage"},
    { name:"LEGION OF UNDEAD", hp:120, maxHP:120, attack:15, ability:"summon", reward:45, description:"Constantly summons reinforcements", avatar:"🧟🧟🧟", tooltip:"35% chance to heal 15 HP"},
    { name:"ARCHNECROMANCER", hp:135, maxHP:135, attack:18, ability:"raise", reward:65, description:"Raises powerful fallen enemies", avatar:"🧟‍♂️👑", tooltip:"May revive multiple enemies"},
    { name:"ANCIENT DRAGON", hp:180, maxHP:180, attack:30, ability:"firebreath", reward:75, description:"Breathes intense fire every turn", avatar:"🐲🔥", tooltip:"Deals 12 fire damage each turn"},
    { name:"VAMPIRE SLAYER", hp:110, maxHP:110, attack:27, ability:"silver", reward:60, description:"Expert vampire hunter", avatar:"🧛‍♀️⚔️", tooltip:"Deals +5 damage to vampires"},
    { name:"WEREWOLF SLAYER", hp:125, maxHP:125, attack:24, ability:"silver", reward:60, description:"Expert werewolf hunter", avatar:"🐺‍🗡️⚔️", tooltip:"Deals +5 damage to werewolves"},
    { name:"LICH KING", hp:225, maxHP:225, attack:35, ability:"darkmagic", reward:100, description:"Supreme master of dark arts", avatar:"💀👑", tooltip:"Casts dark magic for 20 damage"}
];

let enemy = {};
let currentBattleEffects = [];
let enemyEffects = [];
let gameState = "settings"; // "settings", "class", "game", "battle", "shop", "reward"

// Initialize the game
window.onload = function() {
    loadGame();
    applySettings();
    document.getElementById('settings-screen').classList.remove('hidden');
    document.getElementById('class-selection').classList.add('hidden');
    document.getElementById('stats').classList.add('hidden');
    document.getElementById('battle').classList.add('hidden');
    document.getElementById('reward-screen').classList.add('hidden');
    document.getElementById('shop').classList.add('hidden');
    document.getElementById('talents-screen').classList.add('hidden');
    document.getElementById('achievements-screen').classList.add('hidden');
    
    document.getElementById('deck-modal').style.display = 'none';
    document.getElementById('discard-modal').style.display = 'none';
};

function loadGame() {
    const savedGame = localStorage.getItem('vampiresVsWerewolvesSave');
    if (savedGame) {
        const parsed = JSON.parse(savedGame);
        if (parsed.settings) gameSettings = parsed.settings;
        if (parsed.achievements) achievements = parsed.achievements;
    }
}

function saveGame() {
    const gameData = {
        settings: gameSettings,
        achievements: achievements
    };
    localStorage.setItem('vampiresVsWerewolvesSave', JSON.stringify(gameData));
}

function applySettings() {
    document.body.className = gameSettings.colorblindMode !== "none" ? `colorblind-${gameSettings.colorblindMode}` : "";
    document.body.style.fontSize = gameSettings.fontSize === "small" ? "14px" : 
                                 gameSettings.fontSize === "large" ? "18px" : "16px";
}

function showSettings() {
    document.getElementById('class-selection').classList.add('hidden');
    document.getElementById('settings-screen').classList.remove('hidden');
    document.getElementById('colorblind-mode').value = gameSettings.colorblindMode;
    document.getElementById('font-size').value = gameSettings.fontSize;
}

function startGame() {
    gameSettings.colorblindMode = document.getElementById('colorblind-mode').value;
    gameSettings.fontSize = document.getElementById('font-size').value;
    applySettings();
    saveGame();
    
    document.getElementById('settings-screen').classList.add('hidden');
    document.getElementById('class-selection').classList.remove('hidden');
}

// Game Functions
function chooseClass(chosenClass) {
    if (chosenClass === "Vampire") {
        player = { 
            class: "Vampire", 
            maxHP: 60,
            hp: 60,
            inventory: ["Health Potion", "Energy Potion"],
            deck: [
                getCardByName("BITE"),
                getCardByName("BLOOD DRAIN"),
                getCardByName("DARK MIST"),
                getCardByName("MOONLIGHT"),
                getCardByName("QUICK STRIKE"),
                getCardByName("DEFEND")
            ],
            level: 1,
            xp: 0,
            maxEnergy: 2,
            talents: [],
            talentPoints: 0,
            achievements: [],
            runHistory: [],
            gameMode: player.gameMode || "standard"
        };
    } else {
        player = { 
            class: "Werewolf", 
            maxHP: 70,
            hp: 70,
            inventory: ["Health Potion", "Energy Potion"],
            deck: [
                getCardByName("CLAW SWIPE"),
                getCardByName("HOWL"),
                getCardByName("REGENERATE"),
                getCardByName("POUNCE"),
                getCardByName("DEFEND"),
                getCardByName("QUICK STRIKE")
            ],
            level: 1,
            xp: 0,
            maxEnergy: 2,
            talents: [],
            talentPoints: 0,
            achievements: [],
            runHistory: [],
            gameMode: player.gameMode || "standard"
        };
    }

    deck = [...player.deck];
    shuffleDeck(deck);
    document.getElementById("class-selection").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
    document.getElementById("class-name").innerText = `YOU ARE A ${player.class.toUpperCase()}`;
    document.getElementById("game-mode").innerText = player.gameMode === "endless" ? "Endless" : "Standard";
    
    updatePlayerStats();
    updateDeckInfo();
    updateNextEnemy();
    renderTalents();
    renderAchievements();
}

function toggleGameMode() {
    player.gameMode = player.gameMode === "standard" ? "endless" : "standard";
    document.getElementById("game-mode").innerText = player.gameMode === "endless" ? "Endless" : "Standard";
    currentEnemyIndex = 0;
    updateNextEnemy();
}

function getCardByName(name) {
    for (let card of vampireCards) {
        if (card.name === name) return {...card};
    }
    
    for (let card of werewolfCards) {
        if (card.name === name) return {...card};
    }
    
    for (let card of neutralCards) {
        if (card.name === name) return {...card};
    }
    
    return null;
}

function shuffleDeck(deck) {
    for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
    }
}

function updatePlayerStats() {
    const healthPercent = (player.hp / player.maxHP) * 100;
    document.getElementById("player-health-fill").style.width = `${healthPercent}%`;
    document.getElementById("player-health-text").innerText = `${player.hp}/${player.maxHP}`;
    document.getElementById("battle-player-health-fill").style.width = `${healthPercent}%`;
    document.getElementById("battle-player-health-text").innerText = `${player.hp}/${player.maxHP}`;
    document.getElementById("gold-display").innerText = gold;
    document.getElementById("level-display").innerText = player.level;
    document.getElementById("xp-display").innerText = player.xp;
    document.getElementById("xp-needed").innerText = player.level * 20;
    document.getElementById("inventory-count").innerText = player.inventory.length;
    
    updateStatusEffects();
    updateComboMeter();
}

function updateStatusEffects() {
    const effectsDiv = document.getElementById("status-effects");
    const battleEffectsDiv = document.getElementById("battle-status-effects");
    effectsDiv.innerHTML = "";
    battleEffectsDiv.innerHTML = "";
    
    if (buffedAttack > 0) {
        effectsDiv.innerHTML += `<span class="buff">+${buffedAttack} ATK</span> `;
        battleEffectsDiv.innerHTML += `<span class="buff">+${buffedAttack} ATK</span> `;
    }
    
    if (block > 0) {
        effectsDiv.innerHTML += `<span class="block">${block} BLK</span> `;
        battleEffectsDiv.innerHTML += `<span class="block">${block} BLK</span> `;
    }
    
    if (evadeNextAttack) {
        const evadeText = typeof evadeNextAttack === 'number' ? 
                         `EVADE (${evadeNextAttack})` : "EVADE";
        effectsDiv.innerHTML += `<span class="buff">${evadeText}</span> `;
        battleEffectsDiv.innerHTML += `<span class="buff">${evadeText}</span> `;
    }
}

function updateComboMeter() {
    const comboPercent = comboCount > 0 ? Math.min(100, comboCount * 20) : 0;
    document.getElementById("combo-fill").style.width = `${comboPercent}%`;
    document.getElementById("battle-combo-fill").style.width = `${comboPercent}%`;
    
    const comboText = comboCount > 0 ? 
        `${comboCount}-CARD ${comboType.toUpperCase()} COMBO!` : "";
    document.getElementById("combo-text").innerText = comboText;
    document.getElementById("battle-combo-text").innerText = comboText;
}

function updateEnemyStatusEffects() {
    const effectsDiv = document.getElementById("enemy-status-effects");
    effectsDiv.innerHTML = "";
    
    if (enemyBleedStacks > 0) {
        effectsDiv.innerHTML += `<span class="bleed">BLEED (${enemyBleedStacks})</span> `;
    }
}

function updateDeckInfo() {
    document.getElementById("deck-count").innerText = deck.length;
    document.getElementById("discard-count").innerText = discard.length;
    document.getElementById("modal-deck-count").innerText = deck.length + hand.length;
    document.getElementById("modal-discard-count").innerText = discard.length;
}

function updateNextEnemy() {
    if (player.gameMode === "endless") {
        const endlessIndex = currentEnemyIndex % endlessEnemies.length;
        const wave = Math.floor(currentEnemyIndex / endlessEnemies.length) + 1;
        const enemyData = endlessEnemies[endlessIndex];
        document.getElementById("next-enemy").innerText = `${enemyData.name} (WAVE ${wave})`;
        document.getElementById("next-enemy-tooltip").innerText = enemyData.tooltip;
    } else {
        if (currentEnemyIndex < enemies.length) {
            const enemyData = enemies[currentEnemyIndex];
            document.getElementById("next-enemy").innerText = enemyData.name;
            document.getElementById("next-enemy-tooltip").innerText = enemyData.tooltip;
        } else {
            document.getElementById("next-enemy").innerText = "FINAL BOSS";
            document.getElementById("next-enemy-tooltip").innerText = "The ultimate challenge";
        }
    }
}

function startBattle() {
    if (player.gameMode === "endless") {
        const endlessIndex = currentEnemyIndex % endlessEnemies.length;
        const wave = Math.floor(currentEnemyIndex / endlessEnemies.length) + 1;
        enemy = {...endlessEnemies[endlessIndex]};
        enemy.hp = Math.floor(enemy.hp * (1 + (wave-1)*0.1));
        enemy.maxHP = enemy.hp;
        enemy.attack = Math.floor(enemy.attack * (1 + (wave-1)*0.1));
        enemy.reward = Math.floor(enemy.reward * (1 + (wave-1)*0.2));
    } else {
        if (currentEnemyIndex < enemies.length) {
            enemy = {...enemies[currentEnemyIndex]};
        } else {
            // Final boss is a powered-up Ancient Lich
            enemy = {
                name: "ANCIENT LICH KING",
                hp: 200,
                maxHP: 200,
                attack: 30,
                ability: "darkmagic",
                reward: 100,
                description: "The supreme master of dark arts",
                avatar: "💀👑",
                tooltip: "Casts devastating dark magic for 20 damage"
            };
        }
    }
    
    document.getElementById("stats").classList.add("hidden");
    document.getElementById("battle").classList.remove("hidden");
    const battleTitle = player.gameMode === "endless" ? 
        `BATTLE ${currentEnemyIndex+1} (WAVE ${Math.floor(currentEnemyIndex / endlessEnemies.length) + 1}): ${enemy.name}` : 
        `BATTLE ${currentEnemyIndex+1}: ${enemy.name}`;
    document.getElementById("battle-title").innerText = battleTitle;
    document.getElementById("enemy-name").innerText = enemy.name;
    document.getElementById("enemy-avatar").innerText = enemy.avatar;
    document.getElementById("game-over-message").classList.add("hidden");
    document.getElementById("victory-message").classList.add("hidden");
    
    // Apply talent effects
    let startEnergy = player.maxEnergy;
    if (player.class === "Vampire" && player.talents.includes("v6")) {
        startEnergy += 1;
    }
    if (player.class === "Werewolf" && player.talents.includes("w6")) {
        startEnergy += 1;
    }
    
    block = 0;
    evadeNextAttack = false;
    buffedAttack = 0;
    enemyBleedStacks = 0;
    enemyBleedDamage = 0;
    currentBattleEffects = [];
    enemyEffects = [];
    energyCarryover = 0;
    comboCount = 0;
    comboType = "";
    
    updateEnemyStats();
    energy = startEnergy;
    updateEnergyDisplay();
    drawCards(5);
    renderInventory();
    log(`A WILD ${enemy.name} APPEARS! ${enemy.description}`);
    
    // Enable all buttons in case they were disabled from previous game
    document.querySelectorAll("#battle button").forEach(button => {
        button.disabled = false;
    });
    
    // Apply talent effects at start of combat
    if (player.class === "Vampire" && player.talents.includes("v8")) {
        player.hp = Math.min(player.hp + 5, player.maxHP);
        log("ANCIENT BLOODLINE: Healed 5 HP at start of turn");
    }
    if (player.class === "Werewolf" && player.talents.includes("w7")) {
        player.hp = Math.min(player.hp + 3, player.maxHP);
        log("REGENERATION: Healed 3 HP at start of turn");
    }
    
    updatePlayerStats();
}

function updateEnemyStats() {
    const healthPercent = (enemy.hp / enemy.maxHP) * 100;
    document.getElementById("enemy-health-fill").style.width = `${healthPercent}%`;
    document.getElementById("enemy-health-text").innerText = `${enemy.hp}/${enemy.maxHP}`;
    updateEnemyStatusEffects();
}

function updateEnergyDisplay() {
    let energyDiv = document.getElementById("energy-display");
    energyDiv.innerHTML = "ENERGY: ";
    for (let i = 0; i < energy; i++) {
        const orb = document.createElement("span");
        orb.className = "energy-orb filled";
        energyDiv.appendChild(orb);
    }
    for (let i = energy; i < player.maxEnergy; i++) {
        const orb = document.createElement("span");
        orb.className = "energy-orb";
        energyDiv.appendChild(orb);
    }
}

function drawCards(amount = 5) {
    // Apply talent effects
    let drawAmount = amount;
    if (player.class === "Werewolf" && player.talents.includes("w2")) {
        drawAmount += 1;
    }
    
    if (deck.length === 0) {
        if (discard.length === 0) {
            log("NO CARDS LEFT TO DRAW!");
            return;
        }
        deck = [...discard];
        discard = [];
        shuffleDeck(deck);
        log("SHUFFLED DISCARD PILE INTO DECK!");
    }
    
    let cardsDrawn = 0;
    for (let i = 0; i < drawAmount && deck.length > 0; i++) {
        let card = deck.shift();
        if (card) {
            hand.push(card);
            cardsDrawn++;
        }
    }
    
    if (cardsDrawn > 0) {
        log(`DREW ${cardsDrawn} CARD${cardsDrawn > 1 ? 'S' : ''}`);
        if (drawAmount > amount) {
            log("PACK LEADER: Drew an extra card!");
        }
    }
    
    renderHand();
    updateDeckInfo();
}

function renderHand() {
    let handDiv = document.getElementById("hand");
    handDiv.innerHTML = "";
    
    hand.forEach((card, index) => {
        const cardElement = document.createElement("div");
        cardElement.className = `card ${card.rarity}`;
        cardElement.onclick = () => playCard(index);
        
        const cardName = document.createElement("h4");
        cardName.textContent = card.name;
        
        const cardEffect = document.createElement("p");
        cardEffect.textContent = card.description;
        
        const cardCost = document.createElement("p");
        cardCost.textContent = `COST: ${getCardActualCost(card)}`;
        cardCost.style.color = "#0f0";
        
        cardElement.appendChild(cardName);
        cardElement.appendChild(cardEffect);
        cardElement.appendChild(cardCost);
        
        handDiv.appendChild(cardElement);
    });
}

function getCardActualCost(card) {
    // Apply talent discounts
    if (player.class === "Vampire" && player.talents.includes("v2") && 
        (card.element === "shadow" || card.class === "Vampire")) {
        return Math.max(0, card.cost - 1);
    }
    return card.cost;
}

function playCard(index) {
    if (index >= hand.length) return;
    
    let card = hand[index];
    const actualCost = getCardActualCost(card);
    if (energy < actualCost) {
        log("NOT ENOUGH ENERGY!");
        return;
    }
    
    energy -= actualCost;
    updateEnergyDisplay();
    
    // Update combo
    if (comboCount === 0) {
        // Start new combo
        comboCount = 1;
        if (card.effect === "attack" || card.effect === "lifesteal" || card.effect === "multistrike" || card.effect === "bleed") {
            comboType = "attack";
        } else if (card.effect === "heal") {
            comboType = "heal";
        } else {
            comboType = "skill";
        }
    } else {
        // Continue combo if same type
        let cardType = "";
        if (card.effect === "attack" || card.effect === "lifesteal" || card.effect === "multistrike" || card.effect === "bleed") {
            cardType = "attack";
        } else if (card.effect === "heal") {
            cardType = "heal";
        } else {
            cardType = "skill";
        }
        
        if (cardType === comboType) {
            comboCount++;
            checkAchievement("combo_master", comboCount >= 5);
        } else {
            // Break combo
            comboCount = 0;
            comboType = "";
        }
    }
    updateComboMeter();

    let effectApplied = false;
    let totalDamage = 0;
    
    // Apply talent bonuses
    let attackBonus = buffedAttack;
    if (player.class === "Vampire" && player.talents.includes("v5") && 
        (card.name.includes("BLOOD") || card.name.includes("SANGUINE"))) {
        attackBonus += 2;
    }
    if (player.class === "Werewolf" && player.talents.includes("w1") && 
        (card.effect === "attack" || card.effect === "lifesteal" || card.effect === "multistrike")) {
        attackBonus += 2;
    }
    if (player.class === "Werewolf" && player.talents.includes("w8") && player.hp <= player.maxHP / 2) {
        attackBonus += 3;
    }
    
    // Apply combo bonuses
    let comboBonus = 0;
    if (comboCount >= 3) {
        if (player.class === "Vampire" && comboType === "attack") {
            comboBonus = (comboCount - 2) * 2;
        }
        if (player.class === "Werewolf" && comboType === "attack") {
            comboBonus = (comboCount - 2) * 3;
        }
    }
    
    if (card.effect === "attack") {
        totalDamage = card.value + attackBonus + comboBonus;
        enemy.hp -= totalDamage;
        createDamagePopup(enemy.avatar, totalDamage);
        log(`${card.name} DEALS ${totalDamage} DAMAGE!`);
        effectApplied = true;
        damageDealt += totalDamage;
    } 
    else if (card.effect === "lifesteal") {
        totalDamage = card.value + attackBonus + comboBonus;
        enemy.hp -= totalDamage;
        let healAmount = totalDamage;
        
        // Apply talent bonuses
        if (player.class === "Vampire" && player.talents.includes("v1")) {
            healAmount += 2;
        }
        
        player.hp = Math.min(player.hp + healAmount, player.maxHP);
        createDamagePopup(enemy.avatar, totalDamage);
        createHealPopup("YOU", healAmount);
        log(`${card.name} DRAINS ${totalDamage} HP AND HEALS ${healAmount} HP!`);
        effectApplied = true;
        damageDealt += totalDamage;
    } 
    else if (card.effect === "buff") {
        let buffValue = card.value;
        
        // Apply talent bonuses
        if (player.class === "Werewolf" && player.talents.includes("w5")) {
            buffValue += 2;
        }
        
        buffedAttack += buffValue;
        log(`${card.name} POWERS YOU UP (+${buffValue} ATK NEXT TURN)!`);
        effectApplied = true;
    } 
    else if (card.effect === "heal") {
        let healValue = card.value;
        
        // Apply combo bonuses
        if (comboCount >= 3 && comboType === "heal") {
            healValue += (comboCount - 2) * 2;
        }
        
        player.hp = Math.min(player.hp + healValue, player.maxHP);
        createHealPopup("YOU", healValue);
        log(`${card.name} HEALS ${healValue} HP`);
        effectApplied = true;
    }
    else if (card.effect === "evade") {
        if (card.name === "DODGE") {
            evadeNextAttack = Math.random() < 0.5;
            if (evadeNextAttack) {
                log(`${card.name} - YOU MAY DODGE THE NEXT ATTACK!`);
            } else {
                log(`${card.name} - FAILED TO DODGE!`);
            }
        } else {
            evadeNextAttack = true;
            if (card.name === "SHADOW VEIL") {
                evadeNextAttack = 2;
                // Apply talent bonus
                if (player.class === "Vampire" && player.talents.includes("v7")) {
                    evadeNextAttack += 1;
                    log("MOONLIGHT VEIL: Evade lasts +1 turn!");
                }
            }
            log(`${card.name} - NEXT ENEMY ATTACK WILL MISS!`);
        }
        effectApplied = true;
    }
    else if (card.effect === "multistrike") {
        const hits = card.name === "MOON FRENZY" ? 3 : 
                    card.name === "BLOOD FRENZY" ? 2 : 
                    card.name === "FURY SWIPES" ? 2 : 2;
        totalDamage = (card.value + attackBonus + comboBonus) * hits;
        enemy.hp -= totalDamage;
        createDamagePopup(enemy.avatar, totalDamage);
        log(`${card.name} HITS ${hits} TIMES FOR ${card.value + attackBonus + comboBonus} DAMAGE EACH (${totalDamage} TOTAL)!`);
        effectApplied = true;
        damageDealt += totalDamage;
    }
    else if (card.effect === "block") {
        let blockValue = card.value;
        
        // Apply talent bonuses
        if (player.class === "Werewolf" && player.talents.includes("w3")) {
            blockValue += 3;
        }
        
        block += blockValue;
        log(`${card.name} GIVES YOU ${blockValue} BLOCK`);
        effectApplied = true;
    }
    else if (card.effect === "energy") {
        energy += card.value;
        updateEnergyDisplay();
        log(`${card.name} GIVES YOU ${card.value} ENERGY`);
        effectApplied = true;
    }
    else if (card.effect === "draw") {
        drawCards(card.value);
        log(`${card.name} LETS YOU DRAW ${card.value} CARD${card.value > 1 ? 'S' : ''}`);
        effectApplied = true;
    }
    else if (card.effect === "bleed") {
        enemyBleedStacks = 3;
        enemyBleedDamage = card.value;
        
        // Apply talent bonus
        if (player.class === "Vampire" && player.talents.includes("v3")) {
            enemyBleedStacks += 1;
            log("HEMOMANCY: Bleed lasts +1 turn!");
        }
        
        log(`${card.name} MAKES ENEMY BLEED FOR ${card.value} DAMAGE FOR ${enemyBleedStacks} TURNS`);
        effectApplied = true;
    }
    else if (card.effect === "sacrifice") {
        player.hp -= card.value;
        drawCards(2);
        createDamagePopup("YOU", card.value);
        log(`${card.name} - LOSE ${card.value} HP TO DRAW 2 CARDS`);
        effectApplied = true;
        damageTaken += card.value;
    }
    else if (card.effect === "aoe") {
        totalDamage = card.value + attackBonus + comboBonus;
        enemy.hp -= totalDamage;
        createDamagePopup(enemy.avatar, totalDamage);
        log(`${card.name} DEALS ${totalDamage} DAMAGE TO ALL ENEMIES!`);
        effectApplied = true;
        damageDealt += totalDamage;
    }
    else if (card.effect === "drain") {
        const damage = card.value + attackBonus + comboBonus;
        enemy.hp -= damage;
        let healAmount = Math.floor(damage/2);
        player.hp = Math.min(player.hp + healAmount, player.maxHP);
        createDamagePopup(enemy.avatar, damage);
        createHealPopup("YOU", healAmount);
        log(`${card.name} DEALS ${damage} DAMAGE AND HEALS FOR ${healAmount}`);
        effectApplied = true;
        damageDealt += damage;
    }
    else if (card.effect === "laststand" && player.hp <= Math.floor(player.maxHP * 0.25)) {
        totalDamage = card.value + attackBonus + comboBonus;
        enemy.hp -= totalDamage;
        createDamagePopup(enemy.avatar, totalDamage);
        log(`${card.name} - LAST STAND DEALS ${totalDamage} DAMAGE!`);
        effectApplied = true;
        damageDealt += totalDamage;
    }
    else if (card.effect === "counter") {
        currentBattleEffects.push({type: "counter", value: card.value + comboBonus});
        log(`${card.name} - WILL COUNTER NEXT ATTACK FOR ${card.value + comboBonus} DAMAGE`);
        effectApplied = true;
    }
    
    if (effectApplied) {
        discard.push(card);
        hand.splice(index, 1);
        renderHand();
        updateDeckInfo();
        
        updatePlayerStats();
        updateEnemyStats();
        cardsPlayed++;
        
        if (enemy.hp <= 0) {
            enemy.hp = 0;
            updateEnemyStats();
            victory();
            return;
        }
    }
}

function createDamagePopup(target, amount) {
    const popup = document.createElement("div");
    popup.className = "damage-popup";
    popup.textContent = `-${amount}`;
    
    if (target === "YOU") {
        const playerElement = document.getElementById("battle-player-health-text");
        popup.style.left = `${playerElement.offsetLeft + playerElement.offsetWidth/2}px`;
        popup.style.top = `${playerElement.offsetTop}px`;
    } else {
        const enemyElement = document.getElementById("enemy-health-text");
        popup.style.left = `${enemyElement.offsetLeft + enemyElement.offsetWidth/2}px`;
        popup.style.top = `${enemyElement.offsetTop}px`;
    }
    
    document.getElementById("battle").appendChild(popup);
    setTimeout(() => popup.remove(), 1000);
    
    // Shake effect for large damage
    if (amount >= 15) {
        const avatar = document.getElementById("enemy-avatar");
        avatar.classList.add("shake");
        setTimeout(() => avatar.classList.remove("shake"), 500);
    }
}

function createHealPopup(target, amount) {
    const popup = document.createElement("div");
    popup.className = "heal-popup";
    popup.textContent = `+${amount}`;
    
    if (target === "YOU") {
        const playerElement = document.getElementById("battle-player-health-text");
        popup.style.left = `${playerElement.offsetLeft + playerElement.offsetWidth/2}px`;
        popup.style.top = `${playerElement.offsetTop}px`;
    } else {
        const enemyElement = document.getElementById("enemy-health-text");
        popup.style.left = `${enemyElement.offsetLeft + enemyElement.offsetWidth/2}px`;
        popup.style.top = `${enemyElement.offsetTop}px`;
    }
    
    document.getElementById("battle").appendChild(popup);
    setTimeout(() => popup.remove(), 1000);
}

function enemyTurn() {
    turnsTaken++;
    
    if (enemyBleedStacks > 0) {
        enemy.hp -= enemyBleedDamage;
        enemyBleedStacks--;
        createDamagePopup(enemy.avatar, enemyBleedDamage);
        log(`ENEMY BLEEDS FOR ${enemyBleedDamage} DAMAGE! (${enemyBleedStacks} TURNS LEFT)`);
        updateEnemyStats();
        damageDealt += enemyBleedDamage;
        
        if (enemy.hp <= 0) {
            enemy.hp = 0;
            updateEnemyStats();
            victory();
            return;
        }
    }
    
    if (evadeNextAttack) {
        if (typeof evadeNextAttack === 'number') {
            evadeNextAttack--;
            if (evadeNextAttack <= 0) {
                evadeNextAttack = false;
                log(`YOU EVADE THE ENEMY'S ATTACK! (NO MORE EVADES LEFT)`);
            } else {
                log(`YOU EVADE THE ENEMY'S ATTACK! (${evadeNextAttack} EVADES REMAINING)`);
            }
        } else {
            log(`YOU EVADE THE ENEMY'S ATTACK!`);
            evadeNextAttack = false;
        }
        return;
    }
    
    let damageTaken = 0;
    let attackDamage = enemy.attack;
    
    if (enemy.ability === "buff") {
        attackDamage += 2;
        enemy.attack = attackDamage;
        log(`${enemy.name} ENRAGES! ATTACK +2 (NOW ${enemy.attack})`);
    } 
    else if (enemy.ability === "smite" && Math.random() < 0.3) {
        attackDamage += 5;
        log(`☄️ ${enemy.name} CHANNELS HOLY ENERGY...`);
    } 
    else if (enemy.ability === "fireball" && Math.random() < 0.4) {
        attackDamage = 10;
        log(`🔥 ${enemy.name} GATHERS FIREBALL ENERGY...`);
    }
    else if (enemy.ability === "summon" && Math.random() < 0.25) {
        const healAmount = 10;
        enemy.hp = Math.min(enemy.hp + healAmount, enemy.maxHP);
        createHealPopup(enemy.avatar, healAmount);
        log(`${enemy.name} SUMMONS REINFORCEMENTS! +${healAmount} HP`);
        updateEnemyStats();
    }
    else if (enemy.ability === "curse" && Math.random() < 0.3) {
        attackDamage = 5;
        log(`☠️ ${enemy.name} CASTS A CURSE...`);
    }
    else if (enemy.ability === "firebreath") {
        attackDamage = 8;
        log(`🔥 ${enemy.name} TAKES A DEEP BREATH...`);
    }
    else if (enemy.ability === "silver") {
        attackDamage += 3;
        log(`⚔️ ${enemy.name} BRANDISHES SILVER WEAPONS...`);
    }
    else if (enemy.ability === "darkmagic") {
        attackDamage = 15;
        log(`☠️ ${enemy.name} CHANNELS DARK MAGIC...`);
    }
    
    damageTaken = Math.max(0, attackDamage - block);
    block = Math.max(0, block - attackDamage);
    player.hp -= damageTaken;
    
    if (enemy.ability === "smite" && attackDamage > enemy.attack) {
        log(`☄️ ${enemy.name} USES SMITE! DEALS ${attackDamage} DAMAGE (${block > 0 ? `${block} BLOCKED` : ''})`);
    } else if (enemy.ability === "fireball" && attackDamage === 10) {
        log(`🔥 ${enemy.name} CASTS FIREBALL! DEALS ${attackDamage} DAMAGE (${block > 0 ? `${block} BLOCKED` : ''})`);
    } else if (enemy.ability === "firebreath") {
        log(`🔥 ${enemy.name} BREATHES FIRE! DEALS ${attackDamage} DAMAGE (${block > 0 ? `${block} BLOCKED` : ''})`);
    } else if (enemy.ability === "darkmagic") {
        log(`☠️ ${enemy.name} CASTS DARK MAGIC! DEALS ${attackDamage} DAMAGE (${block > 0 ? `${block} BLOCKED` : ''})`);
    } else if (enemy.ability === "silver" && attackDamage > enemy.attack) {
        log(`⚔️ ${enemy.name} USES SILVER WEAPONS! DEALS ${attackDamage} DAMAGE (${block > 0 ? `${block} BLOCKED` : ''})`);
    } else {
        log(`${enemy.name} ATTACKS FOR ${attackDamage} DAMAGE (${block > 0 ? `${block} BLOCKED` : ''})`);
    }
    
    if (damageTaken > 0) {
        createDamagePopup("YOU", damageTaken);
        damageTaken += damageTaken;
    }
    
    // Check for counter effects
    if (damageTaken > 0 && currentBattleEffects.some(e => e.type === "counter")) {
        const counterEffect = currentBattleEffects.find(e => e.type === "counter");
        enemy.hp -= counterEffect.value;
        createDamagePopup(enemy.avatar, counterEffect.value);
        log(`⚔️ COUNTER ATTACK HITS FOR ${counterEffect.value} DAMAGE!`);
        currentBattleEffects = currentBattleEffects.filter(e => e.type !== "counter");
        updateEnemyStats();
        damageDealt += counterEffect.value;
        
        if (enemy.hp <= 0) {
            enemy.hp = 0;
            updateEnemyStats();
            victory();
            return;
        }
    }
    
    block = 0;
    
    updatePlayerStats();
    if (player.hp <= 0) {
        player.hp = 0;
        updatePlayerStats();
        endGame(false);
    }
}

function endTurn() {
    log("--- END OF TURN ---");
    
    if (buffedAttack > 0) {
        log(`YOUR ATTACK BONUS FADES`);
        buffedAttack = 0;
    }
    
    if (energy > 0) {
        energyCarryover = Math.min(energy, 10);
        log(`YOU HAVE ${energyCarryover} UNUSED ENERGY THAT WILL CARRY OVER TO NEXT TURN`);
    } else {
        energyCarryover = 0;
    }
    
    comboCount = 0;
    comboType = "";
    updateComboMeter();
    
    if (enemy.hp > 0) {
        enemyTurn();
    }
    
    energy = player.maxEnergy + energyCarryover;
    if (energy > 10) {
        energy = 10;
    }
    updateEnergyDisplay();
    discard.push(...hand);
    hand = [];
    drawCards(5);
    
    log("--- NEW TURN ---");
    
    // Apply talent effects at start of turn
    if (player.class === "Vampire" && player.talents.includes("v8")) {
        player.hp = Math.min(player.hp + 5, player.maxHP);
        createHealPopup("YOU", 5);
        log("ANCIENT BLOODLINE: Healed 5 HP at start of turn");
    }
    if (player.class === "Werewolf" && player.talents.includes("w7")) {
        player.hp = Math.min(player.hp + 3, player.maxHP);
        createHealPopup("YOU", 3);
        log("REGENERATION: Healed 3 HP at start of turn");
    }
    
    updatePlayerStats();
}

function fleeBattle() {
    if (confirm("Are you sure you want to flee? You'll lose some gold and return to town.")) {
        gold = Math.max(0, gold - 10);
        document.getElementById("battle").classList.add("hidden");
        document.getElementById("stats").classList.remove("hidden");
        log("You fled the battle and lost 10 gold!");
        updatePlayerStats();
    }
}

function toggleInventory() {
    document.getElementById("inventory").classList.toggle("hidden");
}

function renderInventory() {
    let invDiv = document.getElementById("inventory");
    invDiv.innerHTML = "<h3>INVENTORY</h3>";
    
    if (player.inventory.length === 0) {
        invDiv.innerHTML += "<p>YOUR INVENTORY IS EMPTY</p>";
        return;
    }
    
    player.inventory.forEach((item, index) => {
        const itemElement = document.createElement("div");
        itemElement.className = "card";
        itemElement.textContent = item;
        itemElement.onclick = () => useItem(index);
        invDiv.appendChild(itemElement);
    });
}

function useItem(index) {
    if (index >= player.inventory.length) return;
    
    let item = player.inventory[index];
    
    if (item === "Health Potion") {
        const healAmount = 20;
        player.hp = Math.min(player.hp + healAmount, player.maxHP);
        createHealPopup("YOU", healAmount);
        log("USED HEALTH POTION! +20 HP");
    } 
    else if (item === "Energy Potion") {
        energy = player.maxEnergy;
        updateEnergyDisplay();
        log("USED ENERGY POTION! ENERGY RESTORED");
    }
    
    player.inventory.splice(index, 1);
    updatePlayerStats();
    renderInventory();
}

function victory() {
    checkAchievement("first_blood", enemiesDefeated === 0);
    enemiesDefeated++;
    
    const xpGain = 10 + currentEnemyIndex * 5;
    player.xp += xpGain;
    gold += enemy.reward;
    
    const xpNeeded = player.level * 20;
    if (player.xp >= xpNeeded) {
        player.level++;
        player.xp = 0;
        player.maxHP += 5;
        player.hp = player.maxHP;
        player.talentPoints++;
        log(`LEVEL UP! YOU ARE NOW LEVEL ${player.level}! +5 MAX HP AND 1 TALENT POINT`);
    }
    
    // Check for perfect victory achievement
    if (damageTaken === 0) {
        checkAchievement("perfect_victory", true);
    }
    
    log(`VICTORY! YOU DEFEATED ${enemy.name} AND EARNED ${enemy.reward} GOLD AND ${xpGain} XP!`);
    
    setTimeout(() => {
        currentEnemyIndex++;
        
        if (player.gameMode === "endless" || currentEnemyIndex <= enemies.length) {
            rewardScreen();
        } else {
            endGame(true);
        }
    }, 1500);
}

function rewardScreen() {
    document.getElementById("battle").classList.add("hidden");
    document.getElementById("reward-screen").classList.remove("hidden");
    document.getElementById("gold-reward-amount").textContent = Math.floor(enemy.reward * 1.5);
    
    document.getElementById("reward-cards").innerHTML = "";
    updatePlayerStats();
    updateNextEnemy();
}

function getRandomCardReward() {
    let rewardDiv = document.getElementById("reward-cards");
    rewardDiv.innerHTML = "";
    
    let classCards = player.class === "Vampire" ? vampireCards : werewolfCards;
    let allCards = [...classCards, ...neutralCards];
    
    let rewards = [];
    for (let i = 0; i < 3; i++) {
        let rarityRoll = Math.random();
        let rarity;
        
        if (rarityRoll < 0.5) rarity = "common";
        else if (rarityRoll < 0.8) rarity = "rare";
        else if (rarityRoll < 0.95) rarity = "epic";
        else if (rarityRoll < 0.99) rarity = "legendary";
        else rarity = "ancient";
        
        let eligibleCards = allCards.filter(card => card.rarity === rarity);
        if (eligibleCards.length === 0) {
            eligibleCards = allCards;
        }
        
        let card = {...eligibleCards[Math.floor(Math.random() * eligibleCards.length)]};
        rewards.push(card);
    }
    
    rewards.forEach(card => {
        const cardElement = document.createElement("div");
        cardElement.className = `card ${card.rarity}`;
        cardElement.onclick = () => chooseReward(card);
        
        const cardName = document.createElement("h4");
        cardName.textContent = card.name;
        
        const cardEffect = document.createElement("p");
        cardEffect.textContent = card.description;
        
        cardElement.appendChild(cardName);
        cardElement.appendChild(cardEffect);
        
        rewardDiv.appendChild(cardElement);
    });
}

function getGoldReward() {
    const goldAmount = Math.floor(enemy.reward * 1.5);
    gold += goldAmount;
    log(`YOU RECEIVED ${goldAmount} GOLD!`);
    document.getElementById("reward-screen").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
    updatePlayerStats();
}

function getPotionReward() {
    player.inventory.push("Health Potion", "Energy Potion");
    log(`YOU RECEIVED HEALTH POTION AND ENERGY POTION!`);
    document.getElementById("reward-screen").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
    updatePlayerStats();
}

function getTalentPoint() {
    player.talentPoints++;
    log(`YOU RECEIVED 1 TALENT POINT!`);
    document.getElementById("reward-screen").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
    updatePlayerStats();
}

function chooseReward(card) {
    deck.push({...card});
    log(`ADDED ${card.name} TO YOUR DECK!`);
    
    // Check for legendary collector achievement
    if (card.rarity === "legendary") {
        const legendaryCount = [...deck, ...hand, ...discard].filter(c => c.rarity === "legendary").length;
        checkAchievement("legendary_collector", legendaryCount >= 3);
    }
    
    // Check for deck builder achievement
    checkAchievement("deck_builder", deck.length + hand.length + discard.length >= 20);
    
    document.getElementById("reward-screen").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
    updatePlayerStats();
    updateDeckInfo();
}

function skipReward() {
    document.getElementById("reward-screen").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
}

function enterShop() {
    document.getElementById("stats").classList.add("hidden");
    document.getElementById("shop").classList.remove("hidden");
    document.getElementById("gold").innerText = gold;
    document.getElementById("reroll-cost").innerText = shopRerollCost;
    renderShop();
}

function renderShop() {
    let shopDiv = document.getElementById("shop-cards");
    shopDiv.innerHTML = "";
    
    let classCards = player.class === "Vampire" ? vampireCards : werewolfCards;
    let allCards = [...classCards, ...neutralCards];
    
    let shopOffers = [];
    for (let i = 0; i < 6; i++) {
        let rarityRoll = Math.random();
        let rarity;
        
        if (rarityRoll < 0.6) rarity = "common";
        else if (rarityRoll < 0.85) rarity = "rare";
        else if (rarityRoll < 0.97) rarity = "epic";
        else if (rarityRoll < 0.99) rarity = "legendary";
        else rarity = "ancient";
        
        let eligibleCards = allCards.filter(card => card.rarity === rarity);
        if (eligibleCards.length === 0) {
            eligibleCards = allCards;
        }
        
        let card = {...eligibleCards[Math.floor(Math.random() * eligibleCards.length)]};
        shopOffers.push(card);
    }
    
    shopOffers.forEach(card => {
        const cardElement = document.createElement("div");
        cardElement.className = `card ${card.rarity}`;
        cardElement.onclick = () => buyCard(card);
        
        const cardName = document.createElement("h4");
        cardName.textContent = card.name;
        
        const cardEffect = document.createElement("p");
        cardEffect.textContent = card.description;
        
        const cardPrice = document.createElement("p");
        cardPrice.textContent = `${getCardCost(card)} GOLD`;
        cardPrice.style.color = "#ff0";
        
        cardElement.appendChild(cardName);
        cardElement.appendChild(cardEffect);
        cardElement.appendChild(cardPrice);
        
        shopDiv.appendChild(cardElement);
    });
}

function getCardCost(card) {
    switch(card.rarity) {
        case "common": return 20;
        case "rare": return 35;
        case "epic": return 60;
        case "legendary": return 100;
        case "ancient": return 150;
        default: return 25;
    }
}

function buyCard(card) {
    const cost = getCardCost(card);
    if (gold < cost) {
        log("NOT ENOUGH GOLD! NEED " + cost + " GOLD.");
        return;
    }
    
    deck.push({...card});
    gold -= cost;
    document.getElementById("gold").innerText = gold;
    updatePlayerStats();
    log(`PURCHASED ${card.name} FOR ${cost} GOLD!`);
    
    // Check for legendary collector achievement
    if (card.rarity === "legendary") {
        const legendaryCount = [...deck, ...hand, ...discard].filter(c => c.rarity === "legendary").length;
        checkAchievement("legendary_collector", legendaryCount >= 3);
    }
    
    // Check for deck builder achievement
    checkAchievement("deck_builder", deck.length + hand.length + discard.length >= 20);
    
    renderShop();
}

function buyRandomCard() {
    let classCards = player.class === "Vampire" ? vampireCards : werewolfCards;
    let allCards = [...classCards, ...neutralCards];
    
    let rarityRoll = Math.random();
    let rarity;
    
    if (rarityRoll < 0.6) rarity = "common";
    else if (rarityRoll < 0.85) rarity = "rare";
    else if (rarityRoll < 0.97) rarity = "epic";
    else if (rarityRoll < 0.99) rarity = "legendary";
    else rarity = "ancient";
    
    let eligibleCards = allCards.filter(card => card.rarity === rarity);
    if (eligibleCards.length === 0) {
        eligibleCards = allCards;
    }
    
    let card = {...eligibleCards[Math.floor(Math.random() * eligibleCards.length)]};
    const cost = getCardCost(card);
    
    if (gold < cost) {
        log("NOT ENOUGH GOLD! NEED " + cost + " GOLD.");
        return;
    }
    
    deck.push(card);
    gold -= cost;
    document.getElementById("gold").innerText = gold;
    updatePlayerStats();
    log(`PURCHASED RANDOM ${card.rarity.toUpperCase()} CARD (${card.name}) FOR ${cost} GOLD!`);
    
    // Check for legendary collector achievement
    if (card.rarity === "legendary") {
        const legendaryCount = [...deck, ...hand, ...discard].filter(c => c.rarity === "legendary").length;
        checkAchievement("legendary_collector", legendaryCount >= 3);
    }
    
    // Check for deck builder achievement
    checkAchievement("deck_builder", deck.length + hand.length + discard.length >= 20);
    
    renderShop();
}

function buyPotion() {
    if (gold < 15) {
        log("NOT ENOUGH GOLD! NEED 15 GOLD.");
        return;
    }
    
    player.inventory.push("Health Potion");
    gold -= 15;
    document.getElementById("gold").innerText = gold;
    updatePlayerStats();
    log(`PURCHASED HEALTH POTION FOR 15 GOLD!`);
    renderShop();
}

function buyEnergyPotion() {
    if (gold < 20) {
        log("NOT ENOUGH GOLD! NEED 20 GOLD.");
        return;
    }
    
    player.inventory.push("Energy Potion");
    gold -= 20;
    document.getElementById("gold").innerText = gold;
    updatePlayerStats();
    log(`PURCHASED ENERGY POTION FOR 20 GOLD!`);
    renderShop();
}

function upgradeMaxHP() {
    if (gold < 25) {
        log("NOT ENOUGH GOLD! NEED 25 GOLD.");
        return;
    }
    
    player.maxHP += 10;
    player.hp += 10;
    gold -= 25;
    document.getElementById("gold").innerText = gold;
    updatePlayerStats();
    log(`UPGRADED MAX HP BY 10 FOR 25 GOLD!`);
    renderShop();
}

function upgradeEnergy() {
    if (gold < 30) {
        log("NOT ENOUGH GOLD! NEED 30 GOLD.");
        return;
    }
    
    player.maxEnergy += 1;
    gold -= 30;
    document.getElementById("gold").innerText = gold;
    updatePlayerStats();
    log(`UPGRADED MAX ENERGY TO ${player.maxEnergy} FOR 30 GOLD!`);
    renderShop();
}

function removeCard() {
    if (gold < 25) {
        log("NOT ENOUGH GOLD! NEED 25 GOLD.");
        return;
    }
    
    if (deck.length + hand.length <= 5) {
        log("YOUR DECK IS TOO SMALL TO REMOVE CARDS!");
        return;
    }
    
    showDeckForRemoval();
}

function showDeckForRemoval() {
    document.getElementById("deck-modal").style.display = 'flex';
    
    const modalDeck = document.getElementById("modal-deck");
    modalDeck.innerHTML = "";
    
    const allCards = [...deck, ...hand];
    
    if (allCards.length === 0) {
        modalDeck.innerHTML = "<p>NO CARDS TO REMOVE</p>";
        return;
    }
    
    allCards.forEach((card, index) => {
        const cardElement = document.createElement("div");
        cardElement.className = `card ${card.rarity}`;
        cardElement.onclick = () => removeCardFromDeck(index, card);
        
        const cardName = document.createElement("h4");
        cardName.textContent = card.name;
        
        const cardEffect = document.createElement("p");
        cardEffect.textContent = card.description;
        
        cardElement.appendChild(cardName);
        cardElement.appendChild(cardEffect);
        
        modalDeck.appendChild(cardElement);
    });
}

function removeCardFromDeck(index, card) {
    if (index < deck.length) {
        deck.splice(index, 1);
    } else {
        hand.splice(index - deck.length, 1);
    }
    
    gold -= 25;
    document.getElementById("gold").innerText = gold;
    updatePlayerStats();
    updateDeckInfo();
    log(`REMOVED ${card.name} FROM YOUR DECK FOR 25 GOLD`);
    closeModal("deck-modal");
}

function rerollShop() {
    if (gold < shopRerollCost) {
        log(`NOT ENOUGH GOLD! NEED ${shopRerollCost} GOLD.`);
        return;
    }
    
    gold -= shopRerollCost;
    shopRerollCost += 5;
    document.getElementById("gold").innerText = gold;
    document.getElementById("reroll-cost").innerText = shopRerollCost;
    renderShop();
    log(`REROLLED SHOP FOR ${shopRerollCost-5} GOLD (NEXT REROLL: ${shopRerollCost} GOLD)`);
    updatePlayerStats();
}

function exitShop() {
    shopRerollCost = 10;
    document.getElementById("shop").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
}

function viewDeck() {
    document.getElementById("deck-modal").style.display = 'flex';
    
    const modalDeck = document.getElementById("modal-deck");
    modalDeck.innerHTML = "";
    
    const allCards = [...deck, ...hand];
    
    if (allCards.length === 0) {
        modalDeck.innerHTML = "<p>YOUR DECK IS EMPTY</p>";
        return;
    }
    
    // Default sort by name
    sortDeck('name');
}

function sortDeck(sortBy) {
    const modalDeck = document.getElementById("modal-deck");
    modalDeck.innerHTML = "";
    
    const allCards = [...deck, ...hand];
    let sortedCards = [];
    
    switch(sortBy) {
        case 'name':
            sortedCards = [...allCards].sort((a, b) => a.name.localeCompare(b.name));
            break;
        case 'cost':
            sortedCards = [...allCards].sort((a, b) => a.cost - b.cost);
            break;
        case 'rarity':
            const rarityOrder = {common: 0, rare: 1, epic: 2, legendary: 3, ancient: 4};
            sortedCards = [...allCards].sort((a, b) => rarityOrder[b.rarity] - rarityOrder[a.rarity]);
            break;
        case 'type':
            sortedCards = [...allCards].sort((a, b) => {
                if (a.type === b.type) return a.name.localeCompare(b.name);
                return a.type.localeCompare(b.type);
            });
            break;
        default:
            sortedCards = allCards;
    }
    
    if (sortBy === 'type') {
        // Group by type when sorting by type
        const cardGroups = {};
        sortedCards.forEach(card => {
            if (!cardGroups[card.type]) cardGroups[card.type] = [];
            cardGroups[card.type].push(card);
        });
        
        for (const [type, cards] of Object.entries(cardGroups)) {
            const groupHeader = document.createElement("h3");
            groupHeader.textContent = `${type.toUpperCase()} CARDS`;
            groupHeader.style.marginTop = "20px";
            modalDeck.appendChild(groupHeader);
            
            cards.forEach(card => {
                const cardElement = createCardElement(card);
                modalDeck.appendChild(cardElement);
            });
        }
    } else {
        sortedCards.forEach(card => {
            const cardElement = createCardElement(card);
            modalDeck.appendChild(cardElement);
        });
    }
}

function createCardElement(card) {
    const cardElement = document.createElement("div");
    cardElement.className = `card ${card.rarity}`;
    
    const cardName = document.createElement("h4");
    cardName.textContent = card.name;
    
    const cardEffect = document.createElement("p");
    cardEffect.textContent = card.description;
    
    const cardInfo = document.createElement("p");
    cardInfo.innerHTML = `COST: ${card.cost} | TYPE: ${card.type}`;
    cardInfo.style.fontSize = "0.8em";
    cardInfo.style.color = "#aaa";
    
    cardElement.appendChild(cardName);
    cardElement.appendChild(cardEffect);
    cardElement.appendChild(cardInfo);
    
    return cardElement;
}

function viewDiscard() {
    document.getElementById("discard-modal").style.display = 'flex';
    
    const modalDiscard = document.getElementById("modal-discard");
    modalDiscard.innerHTML = "";
    
    if (discard.length === 0) {
        modalDiscard.innerHTML = "<p>YOUR DISCARD PILE IS EMPTY</p>";
        return;
    }
    
    discard.forEach(card => {
        const cardElement = document.createElement("div");
        cardElement.className = `card ${card.rarity}`;
        
        const cardName = document.createElement("h4");
        cardName.textContent = card.name;
        
        const cardEffect = document.createElement("p");
        cardEffect.textContent = card.description;
        
        cardElement.appendChild(cardName);
        cardElement.appendChild(cardEffect);
        
        modalDiscard.appendChild(cardElement);
    });
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function log(message) {
    let logDiv = document.getElementById("battle-log");
    logDiv.innerHTML += `<p>${message}</p>`;
    logDiv.scrollTop = logDiv.scrollHeight;
}

function renderTalents() {
    const talentsDiv = document.getElementById("talents-tree");
    talentsDiv.innerHTML = "";
    
    const talentList = player.class === "Vampire" ? talents.vampire : talents.werewolf;
    const talentSize = 60;
    const padding = 30;
    
    // Find max x and y to determine canvas size
    let maxX = 0, maxY = 0;
    talentList.forEach(talent => {
        maxX = Math.max(maxX, talent.x);
        maxY = Math.max(maxY, talent.y);
    });
    
    talentsDiv.style.position = "relative";
    talentsDiv.style.height = `${(maxY + 1) * (talentSize + padding)}px`;
    talentsDiv.style.width = `${(maxX + 1) * (talentSize + padding)}px`;
    
    // Draw connectors first so they're behind the nodes
    talentList.forEach(talent => {
        if (talent.requires && talent.requires.length > 0) {
            talent.requires.forEach(reqId => {
                const reqTalent = talentList.find(t => t.id === reqId);
                if (reqTalent) {
                    const connector = document.createElement("div");
                    connector.className = "talent-connector";
                    
                    const startX = reqTalent.x * (talentSize + padding) + talentSize/2;
                    const startY = reqTalent.y * (talentSize + padding) + talentSize/2;
                    const endX = talent.x * (talentSize + padding) + talentSize/2;
                    const endY = talent.y * (talentSize + padding) + talentSize/2;
                    
                    const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                    const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                    
                    connector.style.width = `${length}px`;
                    connector.style.left = `${startX}px`;
                    connector.style.top = `${startY}px`;
                    connector.style.transform = `rotate(${angle}deg)`;
                    connector.style.transformOrigin = "0 0";
                    
                    talentsDiv.appendChild(connector);
                }
            });
        }
    });
    
    // Draw talent nodes
    talentList.forEach(talent => {
        const talentNode = document.createElement("div");
        talentNode.className = "talent-node";
        
        if (player.talents.includes(talent.id)) {
            talentNode.classList.add("unlocked");
            talentNode.title = talent.description;
        } else {
            const canUnlock = talent.requires.every(req => player.talents.includes(req)) && 
                             player.talentPoints >= talent.cost;
            talentNode.classList.add(canUnlock ? "" : "locked");
            talentNode.title = canUnlock ? 
                `${talent.description}\nClick to unlock (Cost: ${talent.cost})` : 
                `Requires: ${talent.requires.map(req => talentList.find(t => t.id === req).name).join(", ")}\nCost: ${talent.cost}`;
            
            if (canUnlock) {
                talentNode.onclick = () => unlockTalent(talent);
            }
        }
        
        talentNode.style.left = `${talent.x * (talentSize + padding)}px`;
        talentNode.style.top = `${talent.y * (talentSize + padding)}px`;
        talentNode.textContent = talent.name.split(" ").map(w => w[0]).join("");
        
        talentsDiv.appendChild(talentNode);
    });
    
    document.getElementById("talent-points").textContent = player.talentPoints;
}

function unlockTalent(talent) {
    if (player.talentPoints >= talent.cost && 
        talent.requires.every(req => player.talents.includes(req))) {
        player.talentPoints -= talent.cost;
        player.talents.push(talent.id);
        log(`UNLOCKED TALENT: ${talent.name}! ${talent.description}`);
        renderTalents();
        updatePlayerStats();
        
        // Check for talent legend achievement
        const talentList = player.class === "Vampire" ? talents.vampire : talents.werewolf;
        checkAchievement("talent_legend", player.talents.length === talentList.length);
    }
}

function viewTalents() {
    document.getElementById("stats").classList.add("hidden");
    document.getElementById("talents-screen").classList.remove("hidden");
    renderTalents();
}

function closeTalents() {
    document.getElementById("talents-screen").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
}

function renderAchievements() {
    const achievementsDiv = document.getElementById("achievements-list");
    achievementsDiv.innerHTML = "";
    
    achievements.forEach(achievement => {
        const achievementElement = document.createElement("div");
        achievementElement.className = `achievement ${achievement.unlocked ? "unlocked" : ""}`;
        
        const icon = document.createElement("div");
        icon.className = "achievement-icon";
        icon.textContent = achievement.icon;
        
        const name = document.createElement("h3");
        name.textContent = achievement.name;
        
        const desc = document.createElement("p");
        desc.textContent = achievement.description;
        
        achievementElement.appendChild(icon);
        achievementElement.appendChild(name);
        achievementElement.appendChild(desc);
        
        achievementsDiv.appendChild(achievementElement);
    });
}

function checkAchievement(id, condition) {
    const achievement = achievements.find(a => a.id === id);
    if (achievement && !achievement.unlocked && condition) {
        achievement.unlocked = true;
        log(`ACHIEVEMENT UNLOCKED: ${achievement.name}!`);
        saveGame();
        
        if (id === "vampire_master" || id === "werewolf_master" || id === "endless_champion") {
            // These are major achievements that should be shown prominently
            const messageDiv = document.getElementById("victory-message");
            messageDiv.innerHTML = `ACHIEVEMENT UNLOCKED: ${achievement.name}!`;
            messageDiv.classList.remove("hidden");
        }
    }
}

function viewAchievements() {
    document.getElementById("stats").classList.add("hidden");
    document.getElementById("achievements-screen").classList.remove("hidden");
    renderAchievements();
}

function closeAchievements() {
    document.getElementById("achievements-screen").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
}

function endGame(victory) {
    const messageDiv = document.getElementById("game-over-message");
    messageDiv.classList.remove("hidden");
    
    if (victory) {
        if (player.gameMode === "endless") {
            messageDiv.innerHTML = `CONGRATULATIONS! You reached wave ${Math.floor(currentEnemyIndex / endlessEnemies.length) + 1} in endless mode!`;
            checkAchievement("endless_champion", Math.floor(currentEnemyIndex / endlessEnemies.length) + 1 >= 10);
        } else {
            messageDiv.innerHTML = `CONGRATULATIONS! YOU DEFEATED ALL ENEMIES AND WON THE GAME WITH ${gold} GOLD AT LEVEL ${player.level}!`;
            if (player.class === "Vampire") {
                checkAchievement("vampire_master", true);
            } else {
                checkAchievement("werewolf_master", true);
            }
        }
        messageDiv.style.color = "#0f0";
    } else {
        messageDiv.innerHTML = "GAME OVER - YOU WERE DEFEATED IN BATTLE";
        messageDiv.style.color = "#f55";
    }
    
    // Record run history
    player.runHistory.push({
        class: player.class,
        level: player.level,
        gold: gold,
        enemiesDefeated: enemiesDefeated,
        damageDealt: damageDealt,
        damageTaken: damageTaken,
        cardsPlayed: cardsPlayed,
        turnsTaken: turnsTaken,
        victory: victory,
        timestamp: new Date().toISOString()
    });
    
    // Disable all action buttons
    document.querySelectorAll("#battle button").forEach(button => {
        button.disabled = true;
    });
    
    // Add restart button
    const restartButton = document.createElement("button");
    restartButton.textContent = "RESTART GAME";
    restartButton.style.margin = "10px auto";
    restartButton.style.display = "block";
    restartButton.onclick = () => location.reload();
    messageDiv.appendChild(document.createElement("br"));
    messageDiv.appendChild(restartButton);
}
</script>
</body>
</html>
