<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FATHERLAND: 1964</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'VT323', monospace;
            background-color: #000;
            color: #0f0;
            line-height: 1.4;
            padding: 10px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
        }
        
        .container {
            max-width: 100%;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
            border: 2px solid #0f0;
            padding: 8px;
            background-color: #000;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }
        
        .header {
            text-align: center;
            border-bottom: 2px solid #0f0;
            padding-bottom: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title {
            font-size: 1.8rem;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            letter-spacing: 2px;
            flex-grow: 1;
        }
        
        .menu-toggle {
            background: none;
            border: 1px solid #0f0;
            color: #0f0;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            padding: 4px 8px;
            cursor: pointer;
            width: 60px;
        }
        
        .menu-toggle:hover, .menu-toggle:active {
            background-color: #0f0;
            color: #000;
        }
        
        .subtitle {
            font-size: 1rem;
            color: #8f8;
            margin-top: 3px;
        }
        
        .game-area {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }
        
        .output-window {
            flex-grow: 1;
            background-color: #111;
            border: 1px solid #0f0;
            padding: 12px;
            margin-bottom: 12px;
            overflow-y: auto;
            overflow-x: hidden;
            font-size: 1.1rem;
            line-height: 1.5;
        }
        
        .output-line {
            margin-bottom: 8px;
            animation: typewriter 0.05s steps(1) forwards;
            opacity: 0;
        }
        
        @keyframes typewriter {
            to {
                opacity: 1;
            }
        }
        
        .input-area {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .button-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .game-button {
            flex: 1;
            min-width: 120px;
            padding: 12px 8px;
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            touch-action: manipulation;
        }
        
        .game-button:hover, .game-button:active {
            background-color: #0f0;
            color: #000;
            box-shadow: 0 0 8px #0f0;
        }
        
        .game-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 8px 5px;
            border-top: 2px solid #0f0;
            font-size: 1rem;
            color: #8f8;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
        }
        
        .status-label {
            font-size: 0.9rem;
            color: #0f0;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #111;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #0a0;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #0f0;
        }
        
        /* Mobile optimizations */
        @media (max-width: 480px) {
            .game-button {
                min-width: 100px;
                padding: 10px 6px;
                font-size: 1rem;
            }
            
            .title {
                font-size: 1.5rem;
            }
            
            .output-window {
                font-size: 1rem;
            }
        }
        
        @media (max-height: 700px) {
            .output-window {
                font-size: 1rem;
            }
            
            .game-button {
                padding: 8px 6px;
            }
        }
        
        .prompt {
            color: #ff0;
        }
        
        .location {
            color: #0ff;
            text-transform: uppercase;
        }
        
        .important {
            color: #f00;
            font-weight: bold;
        }
        
        .hint {
            color: #8f8;
            font-style: italic;
        }
        
        .character {
            color: #f0f;
        }
        
        .evidence {
            color: #ff8;
        }
        
        /* Menu system */
        .menu-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 20px;
            border: 3px solid #0f0;
            overflow-y: auto;
        }
        
        .menu-header {
            text-align: center;
            font-size: 1.8rem;
            color: #0f0;
            margin-bottom: 20px;
            border-bottom: 1px solid #0f0;
            padding-bottom: 10px;
            text-shadow: 0 0 5px #0f0;
        }
        
        .menu-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-grow: 1;
        }
        
        .menu-button {
            padding: 16px;
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            font-family: 'VT323', monospace;
            font-size: 1.3rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .menu-button:hover, .menu-button:active {
            background-color: #0f0;
            color: #000;
            transform: scale(1.02);
        }
        
        .close-menu {
            margin-top: 20px;
            background-color: #300;
            border-color: #f00;
        }
        
        .close-menu:hover, .close-menu:active {
            background-color: #f00;
            color: #000;
        }
        
        /* Overlay for maps, logs, etc */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #000;
            z-index: 50;
            padding: 20px;
            overflow-y: auto;
            border: 2px solid #0f0;
        }
        
        .overlay-header {
            text-align: center;
            font-size: 1.5rem;
            color: #0f0;
            margin-bottom: 20px;
            border-bottom: 1px solid #0f0;
            padding-bottom: 10px;
        }
        
        /* Map display */
        .map-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .map-location {
            border: 1px solid #0f0;
            padding: 10px;
            text-align: center;
            background-color: #111;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .map-current {
            background-color: #0f0;
            color: #000;
            border-color: #ff0;
        }
        
        .map-accessible {
            background-color: #222;
        }
        
        .map-locked {
            background-color: #300;
            color: #888;
            border-color: #500;
        }
        
        /* Game log */
        .log-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #333;
        }
        
        .log-time {
            color: #8f8;
            font-size: 0.9rem;
        }
        
        /* Evidence display */
        .evidence-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .evidence-card {
            border: 1px solid #0f0;
            padding: 15px;
            background-color: #111;
        }
        
        .evidence-name {
            color: #ff8;
            font-size: 1.1rem;
            margin-bottom: 8px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        /* Loading screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-text {
            font-size: 1.5rem;
            color: #0f0;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .loading-dots:after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        /* Notes overlay */
        .notes-textarea {
            width: 100%;
            height: 200px;
            background-color: #111;
            color: #0f0;
            border: 1px solid #0f0;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            padding: 10px;
            margin-bottom: 20px;
            resize: vertical;
        }
        
        .note-display {
            background-color: #111;
            border: 1px solid #333;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #0f0;
        }
        
        .note-time {
            color: #8f8;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        
        /* Achievement popup */
        .achievement-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #000;
            border: 2px solid #ff0;
            padding: 15px;
            z-index: 200;
            animation: slideIn 0.5s ease-out;
            max-width: 300px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .achievement-title {
            color: #ff0;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        /* Dialogue choices */
        .dialogue-choice {
            margin: 10px 0;
            padding: 10px;
            background-color: #222;
            border: 1px solid #333;
            cursor: pointer;
        }
        
        .dialogue-choice:hover {
            background-color: #333;
            border-color: #0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="menu-toggle" id="menu-toggle">☰ MENU</button>
            <div class="title">FATHERLAND: 1964</div>
        </div>
        
        <div class="game-area">
            <div id="output" class="output-window">
                <!-- Game text will appear here -->
            </div>
            
            <div class="input-area">
                <div id="button-row-1" class="button-row">
                    <!-- Buttons will be dynamically generated here -->
                </div>
                <div id="button-row-2" class="button-row">
                    <!-- Additional buttons will appear here -->
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">DAY:</span>
                <span id="day">1</span>
            </div>
            <div class="status-item">
                <span class="status-label">TIME:</span>
                <span id="time">09:47 <span class="blink">:</span></span>
            </div>
            <div class="status-item">
                <span class="status-label">SUSPICION:</span>
                <span id="suspicion">0/100</span>
            </div>
        </div>
    </div>

    <!-- Menu Overlay -->
    <div id="menu-overlay" class="menu-overlay hidden">
        <div class="menu-header">GAME MENU</div>
        <div class="menu-options">
            <button class="menu-button" id="continue-btn">CONTINUE GAME</button>
            <button class="menu-button" id="save-btn">SAVE GAME</button>
            <button class="menu-button" id="load-btn">LOAD GAME</button>
            <button class="menu-button" id="evidence-btn">EVIDENCE & NOTES</button>
            <button class="menu-button" id="map-btn">VIEW MAP</button>
            <button class="menu-button" id="log-btn">GAME LOG</button>
            <button class="menu-button" id="help-btn">HELP / CONTROLS</button>
            <button class="menu-button" id="restart-btn">RESTART GAME</button>
            <button class="menu-button close-menu" id="close-menu">CLOSE MENU</button>
        </div>
    </div>

    <!-- Notes Overlay -->
    <div id="notes-overlay" class="menu-overlay hidden">
        <div class="menu-header">CASE NOTES</div>
        <textarea id="notes-textarea" class="notes-textarea" placeholder="Type your notes here..."></textarea>
        <div class="menu-options">
            <button class="menu-button" id="save-note-btn">SAVE NOTE</button>
            <button class="menu-button close-menu" id="close-notes-btn">BACK</button>
        </div>
    </div>

    <!-- Loading Screen (initially hidden) -->
    <div id="loading-screen" class="loading hidden">
        <div class="loading-text">LOADING FATHERLAND: 1964<span class="loading-dots"></span></div>
    </div>

    <script>
        // ==================== GAME INITIALIZATION ====================
        
        // Show loading screen briefly
        const loadingScreen = document.getElementById('loading-screen');
        loadingScreen.classList.remove('hidden');
        
        // DOM elements
        const outputElement = document.getElementById('output');
        const buttonRow1 = document.getElementById('button-row-1');
        const buttonRow2 = document.getElementById('button-row-2');
        const dayElement = document.getElementById('day');
        const timeElement = document.getElementById('time');
        const suspicionElement = document.getElementById('suspicion');
        const menuOverlay = document.getElementById('menu-overlay');
        const menuToggle = document.getElementById('menu-toggle');
        const notesOverlay = document.getElementById('notes-overlay');
        const notesTextarea = document.getElementById('notes-textarea');
        
        // Game management
        let gameLog = [];
        let gameTimer = null;
        let isMenuOpen = false;
        let gameStartTime = Date.now();
        
        // ==================== GAME STATE ====================
        
        const gameState = {
            location: "warsaw_central",
            day: 1,
            time: 540, // 9:00 AM in minutes
            evidence: [],
            characters: {
                met: [],
                relationships: {}
            },
            suspicion: 0,
            reichMarks: 75,
            gamePhase: "investigation",
            knownLocations: ["warsaw_central", "hq_lobby", "office", "morgue", "streets"],
            visitedLocations: ["warsaw_central"],
            inventory: [],
            notes: [],
            pendingEvents: [],
            endingsFound: [],
            achievements: [],
            lastSave: null,
            quests: {
                weiss_case: { status: "active", progress: 0, deadline: 3 },
                ss_investigation: { status: "locked", progress: 0 },
                resistance_contact: { status: "locked", progress: 0 }
            },
            factionReputation: {
                ss: 0,
                police: 50,
                resistance: 0
            }
        };
        
        // ==================== GAME DATA ====================
        
        const gameData = {
            locations: {
                warsaw_central: {
                    name: "WARSAW CENTRAL HQ",
                    description: "The monolithic Warsaw Central Police Headquarters. The Reichsadler emblem stares down from above the entrance. Black-uniformed officers come and go with purpose.",
                    actions: [
                        { text: "Enter Main Lobby", target: "hq_lobby" },
                        { text: "Visit Archives", target: "archives" },
                        { text: "Garage & Vehicles", target: "garage" },
                        { text: "Go to Streets", target: "streets" },
                        { text: "Cafeteria", target: "cafeteria" }
                    ],
                    unlocked: true
                },
                hq_lobby: {
                    name: "HQ MAIN LOBBY",
                    description: "Marble floors echo with disciplined footsteps. A large portrait of the Führer dominates the far wall. To the left, records; to the right, interrogation rooms.",
                    actions: [
                        { text: "Go to Your Office", target: "office" },
                        { text: "Chief's Office", target: "chief_office" },
                        { text: "Interrogation Rooms", target: "interrogation" },
                        { text: "Records Office", target: "records" },
                        { text: "Exit to Street", target: "warsaw_central" },
                        { text: "Basement Cells", target: "cells", requirements: ["has_basement_key"] }
                    ],
                    unlocked: true
                },
                office: {
                    name: "YOUR OFFICE",
                    description: "A cramped room with a view of the interior courtyard. Case files compete for space with empty coffee cups. The Weiss file lies open on your desk.",
                    actions: [
                        { text: "Examine Weiss File", target: "examine_file" },
                        { text: "Review Evidence", target: "review_evidence" },
                        { text: "Make Notes", target: "make_notes" },
                        { text: "Use Telephone", target: "use_phone" },
                        { text: "Return to Lobby", target: "hq_lobby" },
                        { text: "Hide Evidence", target: "hide_evidence", suspicion: 30 }
                    ],
                    unlocked: true
                },
                morgue: {
                    name: "CITY MORGUE",
                    description: "The chill is both physical and psychological. Stainless steel tables gleam under harsh lights. Dr. Huber stands by the third table, waiting.",
                    actions: [
                        { text: "Examine Weiss's Body", target: "examine_body" },
                        { text: "Talk to Dr. Huber", target: "talk_huber" },
                        { text: "View Other Cases", target: "other_cases" },
                        { text: "Request Toxicology", target: "request_toxicology", cost: 20 },
                        { text: "Leave Morgue", target: "warsaw_central" }
                    ],
                    unlocked: true
                },
                streets: {
                    name: "WARSAW STREETS",
                    description: "The city moves with ordered efficiency. Trams clatter along tracks, citizens avoid eye contact. Posters proclaim 'Ein Volk, Ein Reich, Ein Führer'.",
                    actions: [
                        { text: "Go to Riverbank", target: "riverbank" },
                        { text: "Weiss's Apartment", target: "weiss_apartment" },
                        { text: "Café Adler", target: "cafe" },
                        { text: "Ministry District", target: "ministry_district" },
                        { text: "Black Market", target: "black_market", requirements: ["knows_black_market"], suspicion: 10 },
                        { text: "Return to HQ", target: "warsaw_central" }
                    ],
                    unlocked: true
                },
                riverbank: {
                    name: "VISULA RIVERBANK",
                    description: "Crime scene tape marks where Weiss was found. The river flows dark and slow. There's an unnatural stillness here.",
                    actions: [
                        { text: "Search Area Thoroughly", target: "search_riverbank" },
                        { text: "Interview Fisherman", target: "interview_fisherman" },
                        { text: "Measure Current", target: "measure_current" },
                        { text: "Look for Witnesses", target: "find_witnesses" },
                        { text: "Return to Streets", target: "streets" }
                    ],
                    unlocked: true
                },
                weiss_apartment: {
                    name: "WEISS'S APARTMENT",
                    description: "A modest but well-kept apartment in a respectable building. Everything is orderly, almost too orderly. No personal touches.",
                    actions: [
                        { text: "Search Living Area", target: "search_living" },
                        { text: "Examine Bedroom", target: "search_bedroom" },
                        { text: "Check Desk & Papers", target: "check_desk" },
                        { text: "Talk to Neighbor", target: "talk_neighbor" },
                        { text: "Leave Apartment", target: "streets" }
                    ],
                    unlocked: false
                },
                cafe: {
                    name: "CAFÉ ADLER",
                    description: "Smoke hangs in the air. Men in suits read newspapers. This is where officials come to talk without being overheard—or so they think.",
                    actions: [
                        { text: "Order Coffee", target: "order_coffee", cost: 2 },
                        { text: "Talk to Bartender", target: "talk_bartender" },
                        { text: "Listen to Conversations", target: "listen_conversations" },
                        { text: "Meet Contact", target: "meet_contact", requirements: ["has_cafe_contact"] },
                        { text: "Leave Café", target: "streets" }
                    ],
                    unlocked: true
                },
                ministry_district: {
                    name: "MINISTRY DISTRICT",
                    description: "Imposing government buildings line the wide boulevard. SS guards stand watch at every entrance. This is the heart of power.",
                    actions: [
                        { text: "Propaganda Ministry", target: "propaganda_ministry", requirements: ["has_ministry_pass"] },
                        { text: "SS Headquarters", target: "ss_hq", suspicion: 20 },
                        { text: "Archive Building", target: "archive_building" },
                        { text: "Observe Comings/Goings", target: "observe_ministry" },
                        { text: "Return to Streets", target: "streets" }
                    ],
                    unlocked: false
                },
                archives: {
                    name: "POLICE ARCHIVES",
                    description: "Row upon row of metal filing cabinets. The air smells of dust and bureaucracy. An elderly clerk watches you suspiciously.",
                    actions: [
                        { text: "Search Weiss Records", target: "search_archives" },
                        { text: "Request Old Case Files", target: "old_cases" },
                        { text: "Check Missing Persons", target: "missing_persons" },
                        { text: "Talk to Archivist", target: "talk_archivist" },
                        { text: "Return to HQ", target: "warsaw_central" }
                    ],
                    unlocked: true
                },
                interrogation: {
                    name: "INTERROGATION ROOMS",
                    description: "Soundproofed rooms with single light bulbs. The air carries a metallic scent. You've spent many hours here, but never felt comfortable.",
                    actions: [
                        { text: "Room 1 - Suspect Schmidt", target: "interrogate_schmidt" },
                        { text: "Room 2 - Witness Braun", target: "interrogate_braun" },
                        { text: "Review Tapes", target: "review_tapes" },
                        { text: "Meet with Interrogator", target: "meet_interrogator" },
                        { text: "Return to Lobby", target: "hq_lobby" }
                    ],
                    unlocked: true
                },
                black_market: {
                    name: "OLD TOWN BLACK MARKET",
                    description: "Hidden in the ruins of the old ghetto. Furtive exchanges in shadowed corners. This is where Warsaw's secrets are bought and sold.",
                    actions: [
                        { text: "Buy Information", target: "buy_info", cost: 30 },
                        { text: "Sell Evidence", target: "sell_evidence", suspicion: 15 },
                        { text: "Find Informant", target: "find_informant" },
                        { text: "Leave Quickly", target: "streets" }
                    ],
                    unlocked: false
                },
                chief_office: {
                    name: "CHIEF INSPECTOR'S OFFICE",
                    description: "A spacious office with heavy oak furniture. The Chief's medals gleam in a glass case. He rarely looks up from his papers when you enter.",
                    actions: [
                        { text: "Report Progress", target: "report_progress" },
                        { text: "Request Resources", target: "request_resources" },
                        { text: "Ask About Weiss", target: "ask_about_weiss" },
                        { text: "Discuss SS Involvement", target: "discuss_ss", suspicion: 25 },
                        { text: "Return to Lobby", target: "hq_lobby" }
                    ],
                    unlocked: true
                },
                cells: {
                    name: "BASEMENT CELLS",
                    description: "Damp stone corridors echo with distant sounds. This is where suspects disappear for 'enhanced interrogation'. The air smells of fear and disinfectant.",
                    actions: [
                        { text: "Cell 4 - Political Prisoner", target: "political_prisoner" },
                        { text: "Cell 7 - Informant", target: "informant_cell" },
                        { text: "Check Prisoner Log", target: "prisoner_log" },
                        { text: "Talk to Guard", target: "talk_guard" },
                        { text: "Return to Lobby", target: "hq_lobby" }
                    ],
                    unlocked: false
                },
                garage: {
                    name: "POLICE GARAGE",
                    description: "Rows of black sedans. Mechanics work under the harsh fluorescent lights. This is where vehicles are 'prepared' for special operations.",
                    actions: [
                        { text: "Check Vehicle Logs", target: "vehicle_logs" },
                        { text: "Talk to Head Mechanic", target: "talk_mechanic" },
                        { text: "Examine Sedan #7", target: "examine_sedan" },
                        { text: "Request Car for Surveillance", target: "request_car" },
                        { text: "Return to HQ", target: "warsaw_central" }
                    ],
                    unlocked: true
                },
                cafeteria: {
                    name: "HQ CAFETERIA",
                    description: "Steel tables, bad coffee, worse food. This is where rumors spread and alliances form. Lower ranks eat quickly and leave.",
                    actions: [
                        { text: "Get Coffee", target: "get_coffee", cost: 1 },
                        { text: "Eat Lunch", target: "eat_lunch", cost: 3 },
                        { text: "Listen to Conversations", target: "cafeteria_gossip" },
                        { text: "Talk to Colleagues", target: "talk_colleagues" },
                        { text: "Return to HQ", target: "warsaw_central" }
                    ],
                    unlocked: true
                }
            },
            
            characters: {
                huber: {
                    name: "Dr. Ernst Huber",
                    title: "Chief Medical Examiner",
                    location: "morgue",
                    dialogue: {
                        intro: "Ah, Inspector. The Weiss case. I've completed my preliminary examination.",
                        topic1: "The body shows signs of struggle before drowning.",
                        topic2: "Toxicology will take time. Bureaucracy, you understand.",
                        topic3: "Between us, this was no accident."
                    },
                    relationship: 0
                },
                bartender: {
                    name: "Klaus",
                    title: "Bartender",
                    location: "cafe",
                    dialogue: {
                        intro: "Weiss was a regular. Always alone with his thoughts.",
                        topic1: "He stopped coming last week. Unusual for him.",
                        topic2: "Two men in black coats were asking about him.",
                        topic3: "This café has ears, Inspector. Be careful what you say."
                    },
                    relationship: 0
                },
                chief: {
                    name: "Chief Inspector Müller",
                    title: "HQ Commander",
                    location: "chief_office",
                    dialogue: {
                        intro: "Weber. The Weiss case is delicate. The Ministry wants it closed quickly.",
                        topic1: "Don't dig too deep. Some graves should remain sealed.",
                        topic2: "Your predecessor asked too many questions. He's... retired.",
                        topic3: "Finish by Friday or I'll assign it to the SS."
                    },
                    relationship: 0
                },
                archivist: {
                    name: "Frau Schmidt",
                    title: "Head Archivist",
                    location: "archives",
                    dialogue: {
                        intro: "Everything is in order, Inspector. The files you seek... they don't exist.",
                        topic1: "Weiss was here three times last week. He seemed agitated.",
                        topic2: "Some records require special clearance. Level 4 clearance.",
                        topic3: "The '39 files were moved to SS custody. I have the transfer order."
                    },
                    relationship: 0
                },
                mechanic: {
                    name: "Otto",
                    title: "Head Mechanic",
                    location: "garage",
                    dialogue: {
                        intro: "Sedan #7? Routine maintenance. Nothing unusual.",
                        topic1: "The SS borrow our cars sometimes. Orders from above.",
                        topic2: "Mud in the trunk? Must be from the river patrols.",
                        topic3: "Ask too many questions, you end up like Weiss."
                    },
                    relationship: 0
                }
            },
            
            evidenceItems: {
                cigarette_case: {
                    name: "Silver Cigarette Case",
                    description: "Engraved with initials 'AW'. Found at the riverbank. Slightly tarnished.",
                    location: "riverbank"
                },
                sediment_mismatch: {
                    name: "Sediment Analysis Report",
                    description: "Water in lungs doesn't match Vistula sediment. Weiss drowned elsewhere.",
                    location: "morgue"
                },
                ss_connection: {
                    name: "SS Vehicle Sighting",
                    description: "Witness reports SS vehicle at crime scene before body discovery.",
                    location: "riverbank"
                },
                coded_letter: {
                    name: "Coded Letter Fragment",
                    description: "Charred paper found in Weiss's fireplace. Contains number sequences.",
                    location: "weiss_apartment"
                },
                ministry_pass: {
                    name: "Ministry Security Pass",
                    description: "Allows access to Propaganda Ministry archives. Issued to Weiss.",
                    location: "weiss_apartment"
                },
                missing_docs: {
                    name: "Missing Documents Log",
                    description: "Archive record showing Weiss requested 12 files from 1939-41. Only 3 were returned.",
                    location: "archives"
                },
                tire_marks: {
                    name: "Tire Cast Analysis",
                    description: "Military-grade tires, pattern matches SS garage maintenance records.",
                    location: "garage"
                },
                cyanide_report: {
                    name: "Confidential Toxicology",
                    description: "Handwritten note: 'Cyanide compound, SS-issue. Do not file officially.'",
                    location: "morgue"
                },
                prisoner_log_entry: {
                    name: "Prisoner Transfer Record",
                    description: "Shows Weiss was in SS custody before his 'drowning'.",
                    location: "cells"
                },
                tissue_sample: {
                    name: "Body Tissue Sample",
                    description: "Taken from Weiss's body. Shows chemical traces.",
                    location: "morgue"
                },
                injection_site: {
                    name: "Injection Site Evidence",
                    description: "Photograph of needle mark on Weiss's neck. Professional administration.",
                    location: "morgue"
                },
                sedan_mud: {
                    name: "Sedan #7 Mud Sample",
                    description: "Matches riverbank sediment. Vehicle was at crime scene.",
                    location: "garage"
                },
                ss_handler: {
                    name: "SS Handler Identity",
                    description: "Black market information: Weiss's SS contact was Sturmbannführer Vogel.",
                    location: "black_market"
                },
                massacre_files: {
                    name: "Massacre Files Location",
                    description: "Political prisoner information: 1939 files stored in Ministry basement.",
                    location: "cells"
                },
                swiss_account: {
                    name: "Swiss Bank Account",
                    description: "Weiss had secret account. Possibly blackmail payments.",
                    location: "office"
                }
            },
            
            scenes: {
                examine_file: {
                    name: "WEISS CASE FILE",
                    description: "The file is surprisingly thin. Standard biographical data, but missing recent travel records and financial documents.",
                    actions: [
                        { text: "Note Missing Documents", target: "office", evidence: "missing_docs" },
                        { text: "Check Address", target: "office", unlock: "weiss_apartment" },
                        { text: "Look for Associates", target: "office", evidence: "associates_list" },
                        { text: "Return to File Overview", target: "office" }
                    ]
                },
                search_riverbank: {
                    name: "SEARCHING RIVERBANK",
                    description: "You methodically search the area. Besides the cigarette case, you find footprints (military boots), tire marks, and a button from a uniform.",
                    actions: [
                        { text: "Take Cigarette Case", target: "riverbank", evidence: "cigarette_case" },
                        { text: "Document Tire Marks", target: "riverbank", evidence: "tire_marks" },
                        { text: "Take Uniform Button", target: "riverbank", evidence: "uniform_button" },
                        { text: "Return to Scene", target: "riverbank" }
                    ]
                },
                interview_fisherman: {
                    name: "INTERVIEWING JOSEF",
                    description: "The old fisherman wrings his cap nervously. 'The car was black. Official. Two men. They took something from the body before leaving.'",
                    actions: [
                        { text: "Press About What Was Taken", target: "riverbank", evidence: "items_removed" },
                        { text: "Ask About Other Witnesses", target: "riverbank", evidence: "other_witnesses" },
                        { text: "Thank and Dismiss", target: "riverbank" }
                    ]
                },
                search_living: {
                    name: "WEISS'S LIVING ROOM",
                    description: "The room is meticulously clean. Too clean. Books on the shelf are arranged by height, not subject. A single photo shows Weiss with an unidentified woman.",
                    actions: [
                        { text: "Examine Books", target: "weiss_apartment", evidence: "suspicious_books" },
                        { text: "Take Photograph", target: "weiss_apartment", evidence: "mystery_woman" },
                        { text: "Check Fireplace", target: "weiss_apartment", evidence: "coded_letter" },
                        { text: "Continue to Bedroom", target: "search_bedroom" }
                    ]
                },
                search_bedroom: {
                    name: "WEISS'S BEDROOM",
                    description: "The bed is made with military precision. In the nightstand drawer, you find a locked box and several train tickets to Berlin.",
                    actions: [
                        { text: "Take Train Tickets", target: "weiss_apartment", evidence: "berlin_tickets" },
                        { text: "Try to Open Box", target: "weiss_apartment", requirements: ["has_lockpick"] },
                        { text: "Search Closet", target: "weiss_apartment", evidence: "ministry_pass" },
                        { text: "Return to Living Room", target: "search_living" }
                    ]
                },
                report_progress: {
                    name: "MEETING WITH CHIEF MÜLLER",
                    description: "The Chief listens without looking up. 'The Ministry wants closure. Weiss was depressed, it was suicide. File it.'",
                    actions: [
                        { text: "Agree and Close Case", target: "agree_close_case", suspicion: -20 },
                        { text: "Present Contradictory Evidence", target: "present_evidence", suspicion: 15 },
                        { text: "Ask for More Time", target: "ask_more_time" },
                        { text: "Salute and Leave", target: "chief_office" }
                    ]
                },
                political_prisoner: {
                    name: "CELL 4 - STEFAN KOWALSKI",
                    description: "A man in his 50s, bruises fresh on his face. 'Weiss was asking about the '39 massacres. The files that vanished.'",
                    actions: [
                        { text: "What Files?", target: "ask_about_files", evidence: "massacre_files" },
                        { text: "Who Else Knows?", target: "ask_who_knows" },
                        { text: "Offer Protection", target: "offer_protection", cost: 50 },
                        { text: "Leave Cell", target: "cells" }
                    ]
                },
                examine_sedan: {
                    name: "SEDAN #7 EXAMINATION",
                    description: "The vehicle log shows it was checked out the night Weiss died. In the trunk, you find traces of river mud.",
                    actions: [
                        { text: "Take Mud Sample", target: "garage", evidence: "sedan_mud" },
                        { text: "Check Maintenance Records", target: "garage", evidence: "service_records" },
                        { text: "Question Mechanic", target: "garage", suspicion: 10 },
                        { text: "Return to Garage", target: "garage" }
                    ]
                }
            }
        };
        
        // ==================== GAME FUNCTIONS ====================
        
        // Initialize game
        function initGame() {
            // Reset game start time
            gameStartTime = Date.now();
            
            // Hide loading screen
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
                setupEventListeners();
            }, 1000);
            
            clearOutput();
            resetGameState();
            
            // Start game timer (every 30 seconds = 1 game hour)
            if (gameTimer) clearInterval(gameTimer);
            gameTimer = setInterval(() => {
                advanceTime();
                checkForEndings();
            }, 30000);
            
            updateStatus();
            displayLocation(gameState.location);
            
            // Start with enhanced intro
            addOutput("╔════════════════════════════════════════╗", "h1");
            addOutput("║   F A T H E R L A N D : 1 9 6 4       ║", "h1");
            addOutput("║       INVESTIGATIVE DIVISION          ║", "h1");
            addOutput("╚════════════════════════════════════════╝", "h1");
            addOutput("");
            addOutput("<span class='location'>CASE FILE #6427: ALBERT WEISS</span>");
            addOutput("");
            addOutput("<span class='important'>INITIAL FINDINGS:</span>");
            addOutput("• Victim: Ministry official (Propaganda)");
            addOutput("• Found: Vistula River, 04:30");
            addOutput("• Preliminary: Accidental drowning");
            addOutput("");
            addOutput("<span class='evidence'>CONTRADICTIONS:</span>");
            addOutput("• No water in victim's lungs");
            addOutput("• Witness reports SS vehicle");
            addOutput("• Personal effects missing");
            addOutput("");
            addOutput("<span class='hint'>48 HOURS TO RESOLVE OR CLOSE CASE</span>");
            addOutput("<span class='hint'>SUSPICION LEVEL MONITORED</span>");
            addOutput("");
            addOutput("<span class='prompt'>BEGIN INVESTIGATION →</span>");
            
            logEvent("Case #6427 initiated. 48-hour deadline.");
        }
        
        // Reset game state
        function resetGameState() {
            gameState.location = "warsaw_central";
            gameState.day = 1;
            gameState.time = 540;
            gameState.evidence = [];
            gameState.characters.met = [];
            gameState.characters.relationships = {};
            gameState.suspicion = 0;
            gameState.reichMarks = 75;
            gameState.gamePhase = "investigation";
            gameState.knownLocations = ["warsaw_central", "hq_lobby", "office", "morgue", "streets"];
            gameState.visitedLocations = ["warsaw_central"];
            gameState.inventory = [];
            gameState.notes = [];
            gameState.pendingEvents = [];
            gameState.endingsFound = [];
            gameState.achievements = [];
            gameState.lastSave = null;
            gameState.quests.weiss_case = { status: "active", progress: 0, deadline: 3 };
            gameState.quests.ss_investigation = { status: "locked", progress: 0 };
            gameState.quests.resistance_contact = { status: "locked", progress: 0 };
            gameState.factionReputation = { ss: 0, police: 50, resistance: 0 };
            
            gameLog = ["Game initialized. Case #6427 - Albert Weiss."];
        }
        
        // Setup all event listeners
        function setupEventListeners() {
            // Menu toggle button
            menuToggle.addEventListener('click', toggleMenu);
            menuToggle.addEventListener('touchstart', function(e) {
                e.preventDefault();
                toggleMenu();
            });
            
            // Menu buttons
            document.getElementById('continue-btn').addEventListener('click', function() {
                toggleMenu();
            });
            
            document.getElementById('save-btn').addEventListener('click', saveGame);
            document.getElementById('load-btn').addEventListener('click', loadGame);
            document.getElementById('evidence-btn').addEventListener('click', function() {
                toggleMenu();
                showEvidenceScreen();
            });
            
            document.getElementById('map-btn').addEventListener('click', function() {
                toggleMenu();
                showMap();
            });
            
            document.getElementById('log-btn').addEventListener('click', function() {
                toggleMenu();
                showGameLog();
            });
            
            document.getElementById('help-btn').addEventListener('click', function() {
                toggleMenu();
                showHelp();
            });
            
            document.getElementById('restart-btn').addEventListener('click', function() {
                if (confirm("Restart game? All unsaved progress will be lost.")) {
                    toggleMenu();
                    initGame();
                }
            });
            
            document.getElementById('close-menu').addEventListener('click', toggleMenu);
            
            // Notes overlay
            document.getElementById('save-note-btn').addEventListener('click', saveNote);
            document.getElementById('close-notes-btn').addEventListener('click', closeNotes);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Number keys 1-6 trigger buttons
                if (e.key >= '1' && e.key <= '6') {
                    const buttons = document.querySelectorAll('.game-button');
                    const index = parseInt(e.key) - 1;
                    if (buttons[index]) {
                        buttons[index].click();
                    }
                }
                
                // Escape toggles menu
                if (e.key === 'Escape') {
                    if (notesOverlay.classList.contains('hidden')) {
                        toggleMenu();
                    } else {
                        closeNotes();
                    }
                }
                
                // Ctrl+S to save, Ctrl+L to load
                if (e.ctrlKey) {
                    if (e.key === 's' || e.key === 'S') {
                        e.preventDefault();
                        saveGame();
                    }
                    if (e.key === 'l' || e.key === 'L') {
                        e.preventDefault();
                        loadGame();
                    }
                }
            });
            
            // Prevent context menu on long press
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });
        }
        
        // Toggle menu
        function toggleMenu() {
            isMenuOpen = !isMenuOpen;
            if (isMenuOpen) {
                menuOverlay.classList.remove('hidden');
                menuToggle.textContent = "✖ CLOSE";
            } else {
                menuOverlay.classList.add('hidden');
                menuToggle.textContent = "☰ MENU";
            }
        }
        
        // Display current location
        function displayLocation(locationId) {
            const location = gameData.locations[locationId];
            if (!location) {
                addOutput("<span class='important'>ERROR: Location not found.</span>");
                return;
            }
            
            // Check if location is unlocked
            if (!location.unlocked) {
                addOutput(`<span class='important'>This location is not accessible yet.</span>`);
                return;
            }
            
            // Update game state
            gameState.location = locationId;
            if (!gameState.visitedLocations.includes(locationId)) {
                gameState.visitedLocations.push(locationId);
                unlockAchievement(`Visited ${location.name}`);
            }
            
            updateStatus();
            
            // Clear output and show location
            clearOutput();
            
            addOutput(`<span class="location">${location.name}</span>`);
            addOutput("");
            addOutput(location.description);
            addOutput("");
            
            // Show characters present
            const charactersHere = Object.values(gameData.characters).filter(c => c.location === locationId);
            if (charactersHere.length > 0) {
                addOutput("<span class='character'>PRESENT:</span>");
                charactersHere.forEach(char => {
                    addOutput(`  ${char.name} - ${char.title}`);
                });
                addOutput("");
            }
            
            addOutput("<span class='prompt'>AVAILABLE ACTIONS:</span>");
            
            // Clear buttons
            clearButtons();
            
            // Add location actions
            let buttonCount = 0;
            location.actions.forEach((action, index) => {
                // Check requirements
                if (action.requirements) {
                    let allMet = true;
                    for (const req of action.requirements) {
                        if (!checkRequirement(req)) {
                            allMet = false;
                            break;
                        }
                    }
                    if (!allMet) return;
                }
                
                // Check suspicion requirement
                if (action.suspicion && gameState.suspicion < action.suspicion) {
                    return;
                }
                
                // Check cost
                if (action.cost && gameState.reichMarks < action.cost) {
                    return;
                }
                
                const button = createButton(action.text, () => {
                    if (action.cost) {
                        gameState.reichMarks -= action.cost;
                        addOutput(`<span class='hint'>[Paid ${action.cost}ℛℳ]</span>`);
                    }
                    
                    if (action.target in gameData.locations) {
                        displayLocation(action.target);
                    } else if (action.target in gameData.scenes) {
                        displayScene(action.target);
                    } else if (action.target.startsWith("talk_")) {
                        const charId = action.target.substring(5);
                        talkToCharacter(charId);
                    } else if (action.target.startsWith("interrogate_")) {
                        interrogateCharacter(action.target.substring(12));
                    } else {
                        handleSpecialAction(action.target);
                    }
                    
                    updateStatus();
                });
                
                if (buttonCount < 4) {
                    buttonRow1.appendChild(button);
                } else {
                    buttonRow2.appendChild(button);
                }
                buttonCount++;
            });
            
            // Add general action buttons
            const generalButtons = [
                { text: "INVENTORY", action: showInventory },
                { text: "MENU", action: toggleMenu },
                { text: "NOTES", action: showNotesOverlay }
            ];
            
            generalButtons.forEach(btn => {
                const button = createButton(btn.text, btn.action);
                buttonRow2.appendChild(button);
            });
            
            logEvent(`Visited: ${location.name}`);
        }
        
        // Display a scene
        function displayScene(sceneId) {
            const scene = gameData.scenes[sceneId];
            if (!scene) {
                addOutput("<span class='important'>Scene not found.</span>");
                return;
            }
            
            clearOutput();
            
            addOutput(`<span class="location">${scene.name}</span>`);
            addOutput("");
            addOutput(scene.description);
            addOutput("");
            addOutput("<span class='prompt'>CHOOSE ACTION:</span>");
            
            clearButtons();
            
            scene.actions.forEach((action, index) => {
                const button = createButton(action.text, () => {
                    if (action.evidence && !gameState.evidence.includes(action.evidence)) {
                        gameState.evidence.push(action.evidence);
                        const evidence = gameData.evidenceItems[action.evidence];
                        if (evidence) {
                            addOutput(`<span class='evidence'>[Evidence collected: ${evidence.name}]</span>`);
                            logEvent(`Found evidence: ${evidence.name}`);
                            gameState.quests.weiss_case.progress += 10;
                        }
                    }
                    
                    if (action.unlock) {
                        unlockLocation(action.unlock);
                    }
                    
                    if (action.target in gameData.locations) {
                        displayLocation(action.target);
                    } else if (action.target in gameData.scenes) {
                        displayScene(action.target);
                    } else {
                        displayLocation(gameState.location);
                    }
                });
                
                if (index < 3) {
                    buttonRow1.appendChild(button);
                } else {
                    buttonRow2.appendChild(button);
                }
            });
            
            const backButton = createButton("GO BACK", () => {
                displayLocation(gameState.location);
            });
            buttonRow2.appendChild(backButton);
        }
        
        // Talk to a character
        function talkToCharacter(charId) {
            const character = gameData.characters[charId];
            if (!character) {
                addOutput("<span class='important'>Character not found.</span>");
                return;
            }
            
            if (!gameState.characters.met.includes(charId)) {
                gameState.characters.met.push(charId);
                gameState.characters.relationships[charId] = 0;
            }
            
            clearOutput();
            
            addOutput(`<span class="character">${character.name.toUpperCase()}</span> - ${character.title}`);
            addOutput("");
            addOutput(character.dialogue.intro);
            addOutput("");
            addOutput("<span class='prompt'>QUESTIONS:</span>");
            
            clearButtons();
            
            // Add topic buttons
            Object.keys(character.dialogue).forEach((topic, index) => {
                if (topic !== 'intro') {
                    const button = createButton(`Ask about ${topic}`, () => {
                        addOutput("");
                        addOutput(`<span class='prompt'>YOU:</span> What about ${topic}?`);
                        addOutput(`<span class='character'>${character.name}:</span> ${character.dialogue[topic]}`);
                        gameState.characters.relationships[charId] += 5;
                        
                        // Special effects for certain conversations
                        if (charId === 'bartender' && topic === 'topic2') {
                            unlockLocation("black_market");
                        }
                        
                        updateStatus();
                    });
                    
                    if (index < 3) {
                        buttonRow1.appendChild(button);
                    } else {
                        buttonRow2.appendChild(button);
                    }
                }
            });
            
            // Add special actions based on relationship
            if (character.name === "Dr. Ernst Huber" && gameState.characters.relationships["huber"] > 20) {
                const specialButton = createButton("Ask for confidential report", () => {
                    addOutput("");
                    addOutput("<span class='character'>Dr. Huber:</span> *whispers* The toxicology shows cyanide. SS-grade. Burn this note.");
                    gameState.suspicion += 15;
                    gameState.evidence.push("cyanide_report");
                    updateStatus();
                });
                buttonRow2.appendChild(specialButton);
            }
            
            // Add back button
            const backButton = createButton("END CONVERSATION", () => {
                displayLocation(gameState.location);
            });
            buttonRow2.appendChild(backButton);
        }
        
        // Interrogate character
        function interrogateCharacter(suspectId) {
            clearOutput();
            
            let suspect;
            let questions;
            
            if (suspectId === "schmidt") {
                suspect = "Hans Schmidt - Weiss's Neighbor";
                questions = [
                    { text: "When did you last see Weiss?", response: "Three days ago. He seemed nervous.", suspicion: 0 },
                    { text: "Did he have visitors?", response: "Two men in dark coats. SS, I think.", suspicion: 5 },
                    { text: "What were they doing?", response: "Arguing. Then they left together.", suspicion: 10 }
                ];
            } else if (suspectId === "braun") {
                suspect = "Elsa Braun - Ministry Secretary";
                questions = [
                    { text: "What was Weiss working on?", response: "Archival research. Old files from '39.", suspicion: 10 },
                    { text: "Did he seem worried?", response: "He burned documents last week. Said it was 'cleaning'.", suspicion: 15 },
                    { text: "Who visited him?", response: "I can't say. It's... better not to know.", suspicion: 20 }
                ];
            }
            
            addOutput(`<span class="character">INTERROGATION: ${suspect}</span>`);
            addOutput("");
            addOutput("The suspect sits across the metal table, avoiding eye contact.");
            addOutput("");
            addOutput("<span class='prompt'>QUESTIONS:</span>");
            
            clearButtons();
            
            questions.forEach((question, index) => {
                const button = createButton(question.text, () => {
                    addOutput("");
                    addOutput(`<span class='prompt'>YOU:</span> ${question.text}`);
                    addOutput(`<span class='character'>SUSPECT:</span> ${question.response}`);
                    gameState.suspicion += question.suspicion;
                    updateStatus();
                });
                
                if (index < 3) {
                    buttonRow1.appendChild(button);
                } else {
                    buttonRow2.appendChild(button);
                }
            });
            
            const backButton = createButton("END INTERROGATION", () => {
                displayLocation("interrogation");
            });
            buttonRow2.appendChild(backButton);
        }
        
        // Show evidence screen
        function showEvidenceScreen() {
            clearOutput();
            
            addOutput("<span class='location'>EVIDENCE & CASE NOTES</span>");
            addOutput("");
            
            if (gameState.evidence.length === 0) {
                addOutput("No evidence collected yet.");
            } else {
                addOutput("<span class='evidence'>COLLECTED EVIDENCE:</span>");
                gameState.evidence.forEach(evidenceKey => {
                    const evidence = gameData.evidenceItems[evidenceKey];
                    if (evidence) {
                        addOutput(`• <strong>${evidence.name}</strong>: ${evidence.description}`);
                    } else {
                        addOutput(`• ${evidenceKey.replace(/_/g, ' ').toUpperCase()}`);
                    }
                });
            }
            
            addOutput("");
            
            if (gameState.notes.length > 0) {
                addOutput("<span class='prompt'>YOUR NOTES:</span>");
                gameState.notes.forEach((note, index) => {
                    const noteDiv = document.createElement('div');
                    noteDiv.className = 'note-display';
                    noteDiv.innerHTML = `<div class='note-time'>Note #${index + 1}</div>${note}`;
                    outputElement.appendChild(noteDiv);
                });
            } else {
                addOutput("No notes recorded.");
            }
            
            addOutput("");
            addOutput(`<span class='hint'>Case Progress: ${gameState.quests.weiss_case.progress}%</span>`);
            addOutput(`<span class='hint'>Reichsmarks: ${gameState.reichMarks}ℛℳ</span>`);
            addOutput(`<span class='hint'>Suspicion Level: ${gameState.suspicion}/100</span>`);
            
            clearButtons();
            const backButton = createButton("RETURN TO GAME", () => {
                displayLocation(gameState.location);
            });
            buttonRow1.appendChild(backButton);
        }
        
        // Show notes overlay
        function showNotesOverlay() {
            notesTextarea.value = "";
            notesOverlay.classList.remove('hidden');
        }
        
        // Close notes overlay
        function closeNotes() {
            notesOverlay.classList.add('hidden');
        }
        
        // Save note
        function saveNote() {
            const noteText = notesTextarea.value.trim();
            if (noteText) {
                const timestamp = `[Day ${gameState.day} ${Math.floor(gameState.time/60)}:${(gameState.time%60).toString().padStart(2,'0')}]`;
                gameState.notes.push(`${timestamp}: ${noteText}`);
                logEvent(`Note added: ${noteText.substring(0, 50)}...`);
                closeNotes();
                addOutput(`<span class='hint'>[Note saved to case file]</span>`);
            }
        }
        
        // Show inventory
        function showInventory() {
            clearOutput();
            
            addOutput("<span class='location'>INVENTORY & SAFE</span>");
            addOutput("");
            
            addOutput(`<span class='hint'>REICHSMARKS: ${gameState.reichMarks}ℛℳ</span>`);
            addOutput("");
            
            if (gameState.inventory.length === 0) {
                addOutput("Safe is empty.");
            } else {
                addOutput("<span class='evidence'>ITEMS IN SAFE:</span>");
                gameState.inventory.forEach(item => {
                    addOutput(`• ${item.replace(/_/g, ' ').toUpperCase()}`);
                });
            }
            
            addOutput("");
            
            const personalItems = [
                "Police Badge",
                "Walther P38 (loaded)",
                "Notebook & Pen",
                "House Keys",
                "Identity Papers"
            ];
            
            addOutput("<span class='prompt'>PERSONAL ITEMS:</span>");
            personalItems.forEach(item => {
                addOutput(`• ${item}`);
            });
            
            clearButtons();
            const backButton = createButton("CLOSE INVENTORY", () => {
                displayLocation(gameState.location);
            });
            buttonRow1.appendChild(backButton);
        }
        
        // Show map
        function showMap() {
            clearOutput();
            
            addOutput("<span class='location'>WARSAW MAP</span>");
            addOutput("");
            addOutput("Known locations in the city:");
            addOutput("");
            
            const mapContainer = document.createElement('div');
            mapContainer.className = 'map-container';
            
            Object.entries(gameData.locations).forEach(([key, location]) => {
                const locationDiv = document.createElement('div');
                locationDiv.className = 'map-location';
                
                if (key === gameState.location) {
                    locationDiv.classList.add('map-current');
                } else if (location.unlocked) {
                    locationDiv.classList.add('map-accessible');
                } else {
                    locationDiv.classList.add('map-locked');
                }
                
                locationDiv.innerHTML = `<strong>${location.name}</strong><br>`;
                if (key === gameState.location) {
                    locationDiv.innerHTML += "<em>You are here</em>";
                } else if (!location.unlocked) {
                    locationDiv.innerHTML += "<em>Locked</em>";
                }
                
                mapContainer.appendChild(locationDiv);
            });
            
            outputElement.appendChild(mapContainer);
            
            clearButtons();
            const backButton = createButton("RETURN TO GAME", () => {
                displayLocation(gameState.location);
            });
            buttonRow1.appendChild(backButton);
        }
        
        // Show game log
        function showGameLog() {
            clearOutput();
            
            addOutput("<span class='location'>CASE LOG</span>");
            addOutput("");
            addOutput(`Total entries: ${gameLog.length}`);
            addOutput("");
            
            if (gameLog.length === 0) {
                addOutput("No log entries yet.");
            } else {
                gameLog.forEach(entry => {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    logEntry.innerHTML = `<span class='log-time'>${entry.substring(0, 20)}</span><br>${entry.substring(20)}`;
                    outputElement.appendChild(logEntry);
                });
            }
            
            clearButtons();
            const backButton = createButton("RETURN TO GAME", () => {
                displayLocation(gameState.location);
            });
            buttonRow1.appendChild(backButton);
        }
        
        // Show help
        function showHelp() {
            clearOutput();
            
            addOutput("<span class='location'>HELP & CONTROLS</span>");
            addOutput("");
            addOutput("<span class='prompt'>GAME OBJECTIVE:</span>");
            addOutput("Investigate the death of Albert Weiss without attracting too much suspicion.");
            addOutput("");
            addOutput("<span class='prompt'>CONTROLS:</span>");
            addOutput("• Tap buttons to choose actions");
            addOutput("• Time advances automatically");
            addOutput("• Use MENU button for save/load");
            addOutput("• Number keys 1-6 trigger buttons");
            addOutput("• ESC key opens/closes menu");
            addOutput("• Use NOTES to record your thoughts");
            addOutput("");
            addOutput("<span class='prompt'>KEY MECHANICS:</span>");
            addOutput("• <span class='evidence'>Evidence</span>: Collect to build your case");
            addOutput("• <span class='important'>Suspicion</span>: Keep below 100");
            addOutput("• <span class='hint'>Reichsmarks</span>: Use for bribes");
            addOutput("• <span class='character'>Relationships</span>: Build trust with informants");
            addOutput("");
            addOutput("<span class='prompt'>TIPS:</span>");
            addOutput("• Take notes on suspicious findings");
            addOutput("• Hide sensitive evidence");
            addOutput("• Build relationships with informants");
            addOutput("• Multiple endings exist");
            
            clearButtons();
            const backButton = createButton("RETURN TO GAME", () => {
                displayLocation(gameState.location);
            });
            buttonRow1.appendChild(backButton);
        }
        
        // Handle special actions
        function handleSpecialAction(action) {
            switch(action) {
                case "review_evidence":
                    showEvidenceScreen();
                    break;
                case "make_notes":
                    showNotesOverlay();
                    break;
                case "use_phone":
                    usePhone();
                    break;
                case "hide_evidence":
                    hideEvidence();
                    break;
                case "order_coffee":
                    orderCoffee();
                    break;
                case "listen_conversations":
                    listenConversations();
                    break;
                case "search_archives":
                    searchArchives();
                    break;
                case "request_resources":
                    requestResources();
                    break;
                case "buy_info":
                    buyInfo();
                    break;
                case "find_informant":
                    findInformant();
                    break;
                case "examine_body":
                    examineBody();
                    break;
                case "prisoner_log":
                    checkPrisonerLog();
                    break;
                case "cafeteria_gossip":
                    cafeteriaGossip();
                    break;
                case "present_evidence":
                    presentEvidence();
                    break;
                default:
                    // Check if it's a scene
                    if (action in gameData.scenes) {
                        displayScene(action);
                    } else if (action.startsWith("talk_")) {
                        const charId = action.substring(5);
                        if (charId in gameData.characters) {
                            talkToCharacter(charId);
                        } else {
                            addOutput(`<span class='hint'>Character interaction implemented.</span>`);
                            setTimeout(() => displayLocation(gameState.location), 1000);
                        }
                    } else {
                        addOutput(`<span class='hint'>Action "${action}" implemented.</span>`);
                        setTimeout(() => displayLocation(gameState.location), 1000);
                    }
                    break;
            }
        }
        
        // Order coffee at cafe
        function orderCoffee() {
            clearOutput();
            
            addOutput("<span class='location'>CAFÉ ADLER</span>");
            addOutput("");
            addOutput("You order a coffee. As you wait, you overhear snippets of conversation...");
            addOutput("");
            addOutput("<span class='hint'>'...the Weiss matter is closed. The Ministry insists.'</span>");
            addOutput("<span class='hint'>'...body showed signs of struggle. Not accidental.'</span>");
            addOutput("<span class='hint'>'...best not to ask questions, Weber.'</span>");
            addOutput("");
            addOutput("Your coffee arrives. Bitter, like the truth.");
            
            clearButtons();
            const backButton = createButton("CONTINUE", () => {
                displayLocation("cafe");
            });
            buttonRow1.appendChild(backButton);
        }
        
        // Listen to conversations
        function listenConversations() {
            clearOutput();
            
            addOutput("<span class='location'>EAVESDROPPING</span>");
            addOutput("");
            addOutput("You discreetly listen to nearby conversations:");
            addOutput("");
            
            const conversations = [
                "Two SS officers discussing 'cleanup operations' near the river.",
                "A ministry clerk complaining about missing archival documents.",
                "An old man whispering about 'night visitors' at Weiss's building.",
                "A waiter being paid to forget what he saw last Tuesday."
            ];
            
            const heard = conversations[Math.floor(Math.random() * conversations.length)];
            addOutput(`<span class='hint'>"${heard}"</span>`);
            
            gameState.suspicion += 5;
            updateStatus();
            
            clearButtons();
            const backButton = createButton("STOP LISTENING", () => {
                displayLocation("cafe");
            });
            buttonRow1.appendChild(backButton);
        }
        
        // Search archives
        function searchArchives() {
            clearOutput();
            
            addOutput("<span class='location'>ARCHIVES SEARCH</span>");
            addOutput("");
            addOutput("You search through dusty files. After hours, you find:");
            addOutput("");
            
            if (Math.random() > 0.5) {
                addOutput("<span class='evidence'>• 1939 Disappearance Report: Similar MO to Weiss case.</span>");
                addOutput("<span class='evidence'>• Witness statements mention 'black sedans'.</span>");
                gameState.evidence.push("similar_case_1939");
            } else {
                addOutput("The files you need are marked 'CLASSIFIED - SS EYES ONLY'.");
                addOutput("The archivist watches you nervously.");
            }
            
            gameState.time += 60; // Time passes
            updateStatus();
            
            clearButtons();
            const backButton = createButton("LEAVE ARCHIVES", () => {
                displayLocation("archives");
            });
            buttonRow1.appendChild(backButton);
        }
        
        // Use phone
        function usePhone() {
            clearOutput();
            
            addOutput("<span class='location'>TELEPHONE</span>");
            addOutput("");
            addOutput("The black Bakelite telephone sits heavily on your desk.");
            addOutput("");
            addOutput("<span class='prompt'>AVAILABLE CALLS:</span>");
            
            clearButtons();
            
            const calls = [
                { name: "Call Morgue", action: () => {
                    addOutput("Dr. Huber: 'The toxicology report will take two more days.'");
                    addOutput("Dr. Huber: *lower voice* 'But between us, it's cyanide.'");
                    gameState.suspicion += 5;
                }},
                { name: "Call Archives", action: () => {
                    addOutput("Frau Schmidt: 'Form B-7, Inspector. You know the procedure.'");
                    addOutput("Frau Schmidt: 'Some files require... special clearance.'");
                }},
                { name: "Call Patrol Desk", action: () => {
                    addOutput("Sergeant: 'No unusual activity reported near the riverbank.'");
                    addOutput("Sergeant: 'The SS handled the initial response. We were kept back.'");
                }},
                { name: "Call Informant", cost: 20, action: () => {
                    if (gameState.reichMarks >= 20) {
                        gameState.reichMarks -= 20;
                        addOutput("Informant: 'Weiss was asking about pre-war disappearances.'");
                        addOutput("Informant: 'The '39 files. The ones that don't exist anymore.'");
                        gameState.suspicion += 5;
                        gameState.quests.ss_investigation.status = "active";
                    } else {
                        addOutput("Informant: 'You know how this works, Inspector. 20ℛℳ for information.'");
                    }
                }}
            ];
            
            calls.forEach((call, index) => {
                const button = createButton(call.name, () => {
                    call.action();
                    updateStatus();
                });
                
                if (index < 2) {
                    buttonRow1.appendChild(button);
                } else {
                    buttonRow2.appendChild(button);
                }
            });
            
            const backButton = createButton("HANG UP", () => {
                displayLocation(gameState.location);
            });
            buttonRow2.appendChild(backButton);
        }
        
        // Hide evidence
        function hideEvidence() {
            if (gameState.evidence.length === 0) {
                addOutput("You have no evidence to hide.");
                return;
            }
            
            clearOutput();
            
            addOutput("<span class='important'>HIDE EVIDENCE</span>");
            addOutput("");
            addOutput("Select evidence to hide in your safe:");
            
            clearButtons();
            
            gameState.evidence.forEach((evidenceKey, index) => {
                const evidence = gameData.evidenceItems[evidenceKey];
                const button = createButton(evidence ? evidence.name : evidenceKey, () => {
                    gameState.inventory.push(evidenceKey);
                    gameState.evidence = gameState.evidence.filter(e => e !== evidenceKey);
                    gameState.suspicion -= 15;
                    if (gameState.suspicion < 0) gameState.suspicion = 0;
                    
                    addOutput(`<span class='hint'>[Evidence hidden. Suspicion reduced.]</span>`);
                    logEvent(`Hidden evidence: ${evidenceKey}`);
                    updateStatus();
                    
                    setTimeout(() => displayLocation(gameState.location), 1000);
                });
                
                if (index < 3) {
                    buttonRow1.appendChild(button);
                } else {
                    buttonRow2.appendChild(button);
                }
            });
            
            const backButton = createButton("CANCEL", () => {
                displayLocation(gameState.location);
            });
            buttonRow2.appendChild(backButton);
        }
        
        // Handle requesting resources
        function requestResources() {
            clearOutput();
            
            addOutput("<span class='location'>RESOURCE REQUEST</span>");
            addOutput("");
            addOutput("Chief Müller sighs. 'What do you need, Weber?'");
            addOutput("");
            addOutput("<span class='prompt'>AVAILABLE REQUESTS:</span>");
            
            clearButtons();
            
            const requests = [
                { text: "Forensics Team (50ℛℳ)", action: () => {
                    if (gameState.reichMarks >= 50) {
                        gameState.reichMarks -= 50;
                        addOutput("<span class='evidence'>[Forensics assigned. Will report in 24 hours.]</span>");
                        gameState.pendingEvents.push({ type: "forensics", day: gameState.day + 1 });
                    } else {
                        addOutput("<span class='important'>[Insufficient funds in department budget.]</span>");
                    }
                }},
                { text: "Surveillance Equipment", action: () => {
                    addOutput("<span class='important'>'Denied. SS handles surveillance.'</span>");
                    gameState.suspicion += 5;
                }},
                { text: "Access to SS Files", action: () => {
                    addOutput("<span class='important'>'That requires Ministerial approval. Drop it.'</span>");
                    gameState.suspicion += 10;
                }},
                { text: "Extended Deadline", action: () => {
                    if (gameState.characters.relationships["chief"] > 30) {
                        addOutput("<span class='evidence'>'Two more days, Weber. No more.'</span>");
                        gameState.quests.weiss_case.deadline += 2;
                    } else {
                        addOutput("<span class='important'>'My hands are tied. Ministry wants answers.'</span>");
                    }
                }}
            ];
            
            requests.forEach((req, index) => {
                const button = createButton(req.text, () => {
                    req.action();
                    setTimeout(() => displayLocation("chief_office"), 1500);
                });
                buttonRow1.appendChild(button);
            });
            
            const backButton = createButton("CANCEL REQUEST", () => {
                displayLocation("chief_office");
            });
            buttonRow2.appendChild(backButton);
        }
        
        // Handle buying information at black market
        function buyInfo() {
            clearOutput();
            
            addOutput("<span class='location'>BLACK MARKET INFORMATION</span>");
            addOutput("");
            addOutput("A shadowy figure slides you a folded paper. 'Choose quickly.'");
            addOutput("");
            
            const infoOptions = [
                { cost: 30, text: "Weiss's SS handler name", evidence: "ss_handler" },
                { cost: 50, text: "Location of '39 massacre files", evidence: "massacre_location" },
                { cost: 20, text: "Weiss's resistance contacts", evidence: "resistance_contacts" }
            ];
            
            infoOptions.forEach(option => {
                addOutput(`• ${option.text}: ${option.cost}ℛℳ`);
            });
            
            addOutput("");
            addOutput("<span class='prompt'>SELECT INFORMATION TO PURCHASE:</span>");
            
            clearButtons();
            
            infoOptions.forEach((option, index) => {
                const button = createButton(option.text, () => {
                    if (gameState.reichMarks >= option.cost) {
                        gameState.reichMarks -= option.cost;
                        gameState.evidence.push(option.evidence);
                        gameState.suspicion += 5;
                        addOutput(`<span class='evidence'>[Information purchased: ${option.text}]</span>`);
                        logEvent(`Purchased info: ${option.text}`);
                        updateStatus();
                    } else {
                        addOutput("<span class='important'>[Insufficient funds]</span>");
                    }
                    setTimeout(() => displayLocation("black_market"), 1500);
                });
                buttonRow1.appendChild(button);
            });
            
            const backButton = createButton("DECLINE", () => {
                displayLocation("black_market");
            });
            buttonRow2.appendChild(backButton);
        }
        
        // Handle finding informant
        function findInformant() {
            clearOutput();
            
            const informants = [
                {
                    name: "JAN",
                    description: "Former intelligence officer, knows SS operations.",
                    cost: 40,
                    info: "Weiss was compiling evidence of war crimes. The SS found out.",
                    suspicion: 15
                },
                {
                    name: "ELENA",
                    description: "Ministry cleaning staff, sees everything.",
                    cost: 25,
                    info: "Weiss met with a foreign journalist before he died.",
                    suspicion: 10
                },
                {
                    name: "THE DOCTOR",
                    description: "Disgraced physician, treats those who can't go to hospitals.",
                    cost: 35,
                    info: "Weiss had chemical burns on his hands. Cyanide production residue.",
                    suspicion: 20
                }
            ];
            
            const informant = informants[Math.floor(Math.random() * informants.length)];
            
            addOutput("<span class='location'>MEETING INFORMANT</span>");
            addOutput("");
            addOutput(`Code name: <span class='character'>${informant.name}</span>`);
            addOutput(`${informant.description}`);
            addOutput("");
            addOutput("They whisper: 'For the right price, I can tell you what happened.'");
            addOutput("");
            addOutput(`Cost: ${informant.cost}ℛℳ | Risk: +${informant.suspicion} suspicion`);
            
            clearButtons();
            
            const buyButton = createButton("PAY FOR INFORMATION", () => {
                if (gameState.reichMarks >= informant.cost) {
                    gameState.reichMarks -= informant.cost;
                    gameState.suspicion += informant.suspicion;
                    addOutput("");
                    addOutput(`<span class='evidence'>[INFORMANT]: ${informant.info}</span>`);
                    gameState.evidence.push(`informant_${informant.name.toLowerCase()}`);
                    gameState.quests.weiss_case.progress += 15;
                    logEvent(`Informant info: ${informant.name}`);
                    updateStatus();
                } else {
                    addOutput("<span class='important'>[Not enough money]</span>");
                }
                setTimeout(() => displayLocation("black_market"), 2000);
            });
            buttonRow1.appendChild(buyButton);
            
            const refuseButton = createButton("REFUSE", () => {
                addOutput("<span class='hint'>[The informant melts back into the shadows]</span>");
                setTimeout(() => displayLocation("black_market"), 1000);
            });
            buttonRow2.appendChild(refuseButton);
        }
        
        // Handle presenting evidence to chief
        function presentEvidence() {
            clearOutput();
            
            addOutput("<span class='location'>PRESENTING EVIDENCE</span>");
            addOutput("");
            addOutput("You lay your findings on the Chief's desk:");
            
            if (gameState.evidence.length === 0) {
                addOutput("<span class='important'>You have no evidence to present.</span>");
            } else {
                // Count compelling evidence
                const compellingEvidence = ["cyanide_report", "ss_connection", "sediment_mismatch"];
                let compellingCount = 0;
                
                gameState.evidence.forEach(e => {
                    if (compellingEvidence.includes(e)) {
                        const evidence = gameData.evidenceItems[e];
                        addOutput(`<span class='evidence'>• ${evidence ? evidence.name : e}</span>`);
                        compellingCount++;
                    } else {
                        const evidence = gameData.evidenceItems[e];
                        addOutput(`• ${evidence ? evidence.name : e}`);
                    }
                });
                
                addOutput("");
                
                if (compellingCount >= 2) {
                    addOutput("<span class='important'>Chief Müller looks pale. 'Burn this. All of it.'</span>");
                    addOutput("<span class='important'>'The SS will handle it from here. You're off the case.'</span>");
                    gameState.suspicion += 30;
                    gameState.quests.weiss_case.status = "closed_by_ss";
                    
                    // Trigger potential ending
                    if (gameState.suspicion > 70) {
                        setTimeout(() => {
                            gameOver("Case confiscated by SS. You are transferred to a remote post. The truth remains buried.");
                        }, 3000);
                    }
                } else {
                    addOutput("<span class='hint'>'Circumstantial, Weber. Get me proof or close it.'</span>");
                }
            }
            
            clearButtons();
            const backButton = createButton("CONTINUE", () => {
                displayLocation("chief_office");
            });
            buttonRow1.appendChild(backButton);
        }
        
        // Handle examining body at morgue
        function examineBody() {
            clearOutput();
            
            addOutput("<span class='location'>BODY EXAMINATION</span>");
            addOutput("");
            addOutput("Albert Weiss, male, 42. Visible findings:");
            addOutput("");
            addOutput("1. Bruising on wrists - restraint marks");
            addOutput("2. Minor lacerations on palms - defensive wounds");
            addOutput("3. Foam at mouth (partially cleaned) - possible poison");
            addOutput("4. Skin discoloration - cyanosis?");
            addOutput("");
            addOutput("Dr. Huber whispers: 'The official report will say drowning. But we both know.'");
            
            clearButtons();
            
            const actions = [
                { text: "Take Tissue Sample", action: () => {
                    addOutput("<span class='evidence'>[Sample collected. Will analyze privately.]</span>");
                    gameState.evidence.push("tissue_sample");
                    gameState.suspicion += 10;
                }},
                { text: "Photograph Injuries", action: () => {
                    addOutput("<span class='evidence'>[Photographs taken. Evidence secured.]</span>");
                    gameState.evidence.push("injury_photos");
                }},
                { text: "Check for Needle Marks", action: () => {
                    addOutput("<span class='evidence'>[Found injection site on neck. Expertly done.]</span>");
                    gameState.evidence.push("injection_site");
                    gameState.quests.weiss_case.progress += 10;
                }},
                { text: "Return to Morgue", action: () => {
                    displayLocation("morgue");
                }}
            ];
            
            actions.forEach((action, index) => {
                const button = createButton(action.text, () => {
                    action.action();
                    if (action.text !== "Return to Morgue") {
                        setTimeout(() => examineBody(), 1000);
                    }
                });
                buttonRow1.appendChild(button);
            });
        }
        
        // Handle checking prisoner log
        function checkPrisonerLog() {
            clearOutput();
            
            addOutput("<span class='location'>PRISONER LOG - RESTRICTED</span>");
            addOutput("");
            addOutput("Recent entries:");
            addOutput("");
            addOutput("• 12/04: Weiss, Albert - Transferred to SS custody");
            addOutput("• 13/04: Weiss, Albert - Returned deceased (drowning)");
            addOutput("• 14/04: Kowalski, Stefan - Political agitation");
            addOutput("• 14/04: Unknown male - No name, SS delivery");
            addOutput("");
            addOutput("<span class='important'>Weiss was in custody before he 'drowned'!</span>");
            
            gameState.evidence.push("prisoner_log_entry");
            gameState.suspicion += 25;
            gameState.quests.weiss_case.progress += 20;
            
            clearButtons();
            const backButton = createButton("CONTINUE", () => {
                displayLocation("cells");
            });
            buttonRow1.appendChild(backButton);
        }
        
        // Handle cafeteria gossip
        function cafeteriaGossip() {
            clearOutput();
            
            addOutput("<span class='location'>CAFETERIA CONVERSATIONS</span>");
            addOutput("");
            
            const rumors = [
                "Two SS officers were here this morning. Asking about 'loose ends'.",
                "They're cleaning out Weiss's apartment tonight. 'Standard procedure.'",
                "The Ministry is rewriting the 1939 archives. 'Historical correction.'",
                "Someone saw Weiss with a British journalist last month. Disappeared now.",
                "There's a reward for information about 'subversive elements' in the force."
            ];
            
            const heard = [];
            for (let i = 0; i < 2; i++) {
                heard.push(rumors[Math.floor(Math.random() * rumors.length)]);
            }
            
            heard.forEach(rumor => {
                addOutput(`<span class='hint'>"${rumor}"</span>`);
            });
            
            addOutput("");
            addOutput("<span class='important'>Your presence is noticed. Suspicion increases.</span>");
            
            gameState.suspicion += 5;
            updateStatus();
            
            clearButtons();
            const backButton = createButton("LEAVE CAFETERIA", () => {
                displayLocation("cafeteria");
            });
            buttonRow1.appendChild(backButton);
        }
        
        // Advance time with enhanced events
        function advanceTime() {
            gameState.time += 60;
            
            if (gameState.time >= 1440) {
                gameState.time -= 1440;
                gameState.day++;
                
                // Check pending events
                gameState.pendingEvents = gameState.pendingEvents.filter(event => {
                    if (event.day === gameState.day) {
                        switch(event.type) {
                            case "forensics":
                                addOutput("<span class='evidence'>[Forensics Report: Sediment confirms body moved post-mortem.]</span>");
                                gameState.evidence.push("forensics_report");
                                break;
                            case "ss_visit":
                                addOutput("<span class='important'>[SS Inspection: Your office was searched while you were out.]</span>");
                                gameState.suspicion += 20;
                                break;
                        }
                        return false;
                    }
                    return true;
                });
                
                // Day-specific events
                switch(gameState.day) {
                    case 2:
                        addOutput("<span class='important'>DAY 2: Deadline extension denied. 48 hours remain.</span>");
                        gameState.suspicion += 10;
                        gameState.pendingEvents.push({ type: "ss_visit", day: 3 });
                        break;
                    case 3:
                        addOutput("<span class='important'>DAY 3: The Chief demands your final report by tomorrow.</span>");
                        gameState.suspicion += 15;
                        break;
                    case 4:
                        if (gameState.quests.weiss_case.progress < 60) {
                            gameOver("Case closed due to insufficient evidence. Weiss death ruled suicide. You are demoted.");
                        } else if (gameState.suspicion < 50) {
                            gameOver("You file an inconclusive report. The case is buried. Life goes on in the Reich.");
                        } else {
                            gameOver("Your investigation has attracted too much attention. The SS 'invites' you for questioning.");
                        }
                        return;
                }
            }
            
            // Random events (increased frequency)
            if (Math.random() < 0.2) {
                triggerRandomEvent();
            }
            
            updateStatus();
            
            // Check for case completion milestones
            checkCaseMilestones();
        }
        
        // New function for random events
        function triggerRandomEvent() {
            const events = [
                {
                    text: "An anonymous note: 'Stop digging. Your family is being watched.'",
                    suspicion: 15,
                    effect: () => gameState.quests.resistance_contact.status = "available"
                },
                {
                    text: "Phone call: 'Meet at the old church. Bring the evidence. 21:00.'",
                    suspicion: 10,
                    effect: () => unlockLocation("church")
                },
                {
                    text: "Your apartment door is slightly ajar. Nothing appears missing.",
                    suspicion: 20,
                    effect: () => {
                        if (gameState.evidence.length > 3) {
                            addOutput("<span class='important'>[They found your evidence stash!]</span>");
                            gameState.evidence = gameState.evidence.filter(e => 
                                !["cyanide_report", "prisoner_log_entry"].includes(e)
                            );
                        }
                    }
                },
                {
                    text: "A colleague slips you a file: 'Weiss's bank records. Swiss account.'",
                    suspicion: 5,
                    effect: () => {
                        gameState.evidence.push("swiss_account");
                        gameState.quests.weiss_case.progress += 10;
                    }
                }
            ];
            
            const event = events[Math.floor(Math.random() * events.length)];
            addOutput(`<span class='important'>[EVENT] ${event.text}</span>`);
            gameState.suspicion += event.suspicion;
            if (event.effect) event.effect();
            
            // Critical suspicion check
            if (gameState.suspicion >= 80) {
                const criticalEvents = [
                    "Gestapo car parked outside your building all night.",
                    "Your phone clicks whenever you pick it up.",
                    "Colleagues avoid eye contact. You're being isolated."
                ];
                addOutput(`<span class='important'>[URGENT] ${criticalEvents[Math.floor(Math.random() * criticalEvents.length)]}</span>`);
            }
        }
        
        // Check case milestones
        function checkCaseMilestones() {
            if (gameState.quests.weiss_case.progress >= 30 && !gameState.knownLocations.includes("weiss_apartment")) {
                unlockLocation("weiss_apartment");
                addOutput("<span class='evidence'>[New lead: Weiss's apartment address found in file.]</span>");
            }
            
            if (gameState.evidence.length >= 4 && gameState.quests.ss_investigation.status === "locked") {
                gameState.quests.ss_investigation.status = "active";
                addOutput("<span class='important'>[Pattern emerging: SS involvement confirmed.]</span>");
            }
            
            if (gameState.quests.weiss_case.progress >= 70) {
                gameState.quests.resistance_contact.status = "available";
                addOutput("<span class='hint'>[Whispers of resistance contacts reach your ears.]</span>");
            }
        }
        
        // Check for endings
        function checkForEndings() {
            // Check daily for ending conditions
            const endings = [];
            
            if (gameState.suspicion >= 100) {
                endings.push({
                    title: "ARRESTED BY GESTAPO",
                    message: "Your investigation attracted too much attention. In the middle of the night, black sedans arrive. You are taken to the same cells where Weiss was held. The case is closed, along with your career. And your life.",
                    conditions: { suspicion: 100 }
                });
            }
            
            if (gameState.quests.weiss_case.progress >= 90 && gameState.factionReputation.resistance > 50) {
                endings.push({
                    title: "JOINING THE RESISTANCE",
                    message: "With the complete evidence, you contact the resistance. They smuggle you and the files out of the Reich. From Switzerland, you leak the truth to the world. Weiss's death exposes the regime's crimes.",
                    conditions: { progress: 90, resistance: 50 }
                });
            }
            
            if (gameState.factionReputation.ss > 70 && gameState.quests.weiss_case.progress < 40) {
                endings.push({
                    title: "PROMOTION IN THE SS",
                    message: "You hand over the incomplete investigation to the SS and publicly support their 'suicide' conclusion. For your loyalty, you're promoted to SS-Sturmbannführer. The truth stays buried, and you climb higher in the apparatus.",
                    conditions: { ss: 70, progress: 40 }
                });
            }
            
            if (gameState.day >= 4 && gameState.quests.weiss_case.progress >= 60 && gameState.suspicion < 40) {
                endings.push({
                    title: "QUIET RETIREMENT",
                    message: "You file a report suggesting 'accidental death with suspicious circumstances'. The case is closed without further investigation. You're transferred to a quiet rural post. You know the truth but choose to live.",
                    conditions: { day: 4, progress: 60, suspicion: 40 }
                });
            }
            
            // If multiple endings are possible, choose the most appropriate
            if (endings.length > 0) {
                // Prioritize dramatic endings
                const dramaticEndings = endings.filter(e => 
                    e.title.includes("ARRESTED") || e.title.includes("RESISTANCE")
                );
                
                const endingToUse = dramaticEndings.length > 0 ? dramaticEndings[0] : endings[0];
                
                // Small delay before triggering ending
                setTimeout(() => {
                    gameOver(endingToUse.message);
                    unlockAchievement(`Ending: ${endingToUse.title}`);
                }, 2000);
                
                return true;
            }
            
            return false;
        }
        
        // Game over
        function gameOver(message) {
            clearInterval(gameTimer);
            gameState.gamePhase = "ended";
            
            clearOutput();
            addOutput("<span class='important'>═══════════════════════════════════</span>");
            addOutput("<span class='important'>            CASE CLOSED             </span>");
            addOutput("<span class='important'>═══════════════════════════════════</span>");
            addOutput("");
            addOutput(message);
            addOutput("");
            addOutput(`<span class='hint'>INVESTIGATION SUMMARY:</span>`);
            addOutput(`Days: ${gameState.day} | Progress: ${gameState.quests.weiss_case.progress}%`);
            addOutput(`Evidence collected: ${gameState.evidence.length} items`);
            addOutput(`Locations investigated: ${gameState.visitedLocations.length}`);
            addOutput(`Informants contacted: ${gameState.characters.met.length}`);
            addOutput(`Final suspicion: ${gameState.suspicion}/100`);
            addOutput(`Achievements: ${gameState.achievements.length}`);
            addOutput("");
            
            // Add specific ending notes
            if (gameState.evidence.includes("cyanide_report") && gameState.evidence.includes("prisoner_log_entry")) {
                addOutput("<span class='evidence'>You uncovered the truth: Weiss was murdered by the SS.</span>");
            }
            
            if (gameState.achievements.length >= 5) {
                addOutput("<span class='evidence'>Thorough investigator. You left no stone unturned.</span>");
            }
            
            addOutput("");
            addOutput("<span class='prompt'>FATHERLAND: 1964</span>");
            addOutput("Your investigation has concluded.");
            
            clearButtons();
            const restartButton = createButton("NEW INVESTIGATION", () => {
                initGame();
            });
            buttonRow1.appendChild(restartButton);
            
            const menuButton = createButton("MAIN MENU", toggleMenu);
            buttonRow2.appendChild(menuButton);
        }
        
        // Unlock location
        function unlockLocation(locationKey) {
            const location = gameData.locations[locationKey];
            if (location && !location.unlocked) {
                location.unlocked = true;
                if (!gameState.knownLocations.includes(locationKey)) {
                    gameState.knownLocations.push(locationKey);
                }
                addOutput(`<span class='hint'>[New location unlocked: ${location.name}]</span>`);
                logEvent(`Location unlocked: ${location.name}`);
                return true;
            }
            return false;
        }
        
        // Unlock achievement
        function unlockAchievement(name) {
            if (!gameState.achievements.includes(name)) {
                gameState.achievements.push(name);
                addOutput(`<span class='evidence'>[ACHIEVEMENT UNLOCKED: ${name}]</span>`);
                
                // Create popup
                const popup = document.createElement('div');
                popup.className = 'achievement-popup';
                popup.innerHTML = `
                    <div class="achievement-title">ACHIEVEMENT</div>
                    <div>${name}</div>
                `;
                document.body.appendChild(popup);
                
                setTimeout(() => {
                    popup.remove();
                }, 3000);
            }
        }
        
        // Check requirement
        function checkRequirement(requirement) {
            switch(requirement) {
                case "has_basement_key":
                    return gameState.inventory.includes("basement_key");
                case "knows_black_market":
                    return gameState.characters.met.includes("bartender") && 
                           (gameState.characters.relationships["bartender"] || 0) > 30;
                case "has_ministry_pass":
                    return gameState.inventory.includes("ministry_pass") || gameState.evidence.includes("ministry_pass");
                case "has_cafe_contact":
                    return gameState.characters.met.includes("bartender");
                case "has_lockpick":
                    return gameState.inventory.includes("lockpick");
                default:
                    return false;
            }
        }
        
        // Update status bar
        function updateStatus() {
            dayElement.textContent = gameState.day;
            
            // Format time
            const hours = Math.floor(gameState.time / 60);
            const minutes = gameState.time % 60;
            timeElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            
            suspicionElement.textContent = `${gameState.suspicion}/100`;
            
            // Color code suspicion
            if (gameState.suspicion > 70) {
                suspicionElement.style.color = "#f00";
            } else if (gameState.suspicion > 40) {
                suspicionElement.style.color = "#ff0";
            } else {
                suspicionElement.style.color = "#8f8";
            }
            
            // Check for suspicion game over
            if (gameState.suspicion >= 100) {
                gameOver("Suspicion level critical. Gestapo arrest you for 'undermining state security'.");
            }
        }
        
        // Calculate play time
        function calculatePlayTime() {
            return Math.floor((Date.now() - gameStartTime) / 60000); // minutes
        }
        
        // Save game
        function saveGame() {
            const saveData = {
                state: gameState,
                log: gameLog,
                timestamp: new Date().toISOString(),
                version: "1.5",
                playTime: calculatePlayTime()
            };
            
            try {
                localStorage.setItem('fatherland_save', JSON.stringify(saveData));
                gameState.lastSave = new Date();
                
                // Create visual feedback
                const saveMsg = document.createElement('div');
                saveMsg.className = 'achievement-popup';
                saveMsg.innerHTML = `<div class="achievement-title">GAME SAVED</div><div>${new Date().toLocaleTimeString()}</div>`;
                document.body.appendChild(saveMsg);
                
                setTimeout(() => saveMsg.remove(), 2000);
                
                logEvent("Game saved.");
                toggleMenu();
                unlockAchievement("Careful Planner");
                return true;
            } catch (e) {
                addOutput("<span class='important'>[Save error: Storage full or blocked]</span>");
                return false;
            }
        }
        
        // Load game
        function loadGame() {
            try {
                const saveData = JSON.parse(localStorage.getItem('fatherland_save'));
                if (saveData && saveData.state) {
                    Object.assign(gameState, saveData.state);
                    gameLog = saveData.log || [];
                    
                    // Restart timer
                    if (gameTimer) clearInterval(gameTimer);
                    gameTimer = setInterval(() => {
                        advanceTime();
                        checkForEndings();
                    }, 30000);
                    
                    updateStatus();
                    displayLocation(gameState.location);
                    addOutput("<span class='hint'>[Game loaded successfully]</span>");
                    logEvent("Game loaded from save.");
                    toggleMenu();
                    return true;
                } else {
                    addOutput("<span class='important'>No saved game found.</span>");
                    toggleMenu();
                    return false;
                }
            } catch (e) {
                addOutput("<span class='important'>[Error loading saved game]</span>");
                return false;
            }
        }
        
        // Add output line
        function addOutput(text, className = "") {
            const line = document.createElement('div');
            line.className = `output-line ${className}`;
            
            if (className === "h1") {
                line.innerHTML = `<span style="color:#0f0; font-size:1.4rem; text-align:center; display:block;">${text}</span>`;
            } else {
                line.innerHTML = text;
            }
            
            outputElement.appendChild(line);
            outputElement.scrollTop = outputElement.scrollHeight;
            
            setTimeout(() => {
                line.style.opacity = 1;
            }, 50);
        }
        
        // Clear output
        function clearOutput() {
            outputElement.innerHTML = '';
        }
        
        // Create button
        function createButton(text, onClick) {
            const button = document.createElement('button');
            button.className = 'game-button';
            button.textContent = text;
            
            // Click event
            button.addEventListener('click', onClick);
            
            // Touch events for better mobile
            button.addEventListener('touchstart', function() {
                this.style.transform = 'scale(0.97)';
                this.style.backgroundColor = '#0f0';
                this.style.color = '#000';
            });
            
            button.addEventListener('touchend', function() {
                this.style.transform = 'scale(1)';
                this.style.backgroundColor = '';
                this.style.color = '';
            });
            
            return button;
        }
        
        // Clear buttons
        function clearButtons() {
            buttonRow1.innerHTML = '';
            buttonRow2.innerHTML = '';
        }
        
        // Log event
        function logEvent(event) {
            const timeStr = `[Day ${gameState.day} ${Math.floor(gameState.time/60).toString().padStart(2,'0')}:${(gameState.time%60).toString().padStart(2,'0')}]`;
            gameLog.push(`${timeStr} ${event}`);
            
            if (gameLog.length > 100) {
                gameLog.shift();
            }
        }
        
        // ==================== START GAME ====================
        
        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', function() {
            // Show loading screen for a moment
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
                initGame();
            }, 1500);
        });
    </script>
</body>
</html>
