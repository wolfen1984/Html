<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Castle of the Undead - Text Adventure</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'VT323', monospace;
            background-color: #000;
            color: #0f0;
            line-height: 1.4;
            height: 100vh;
            overflow: hidden;
            touch-action: pan-x pan-y;
            padding: 5px;
        }
        
        .container {
            max-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 2px solid #0f0;
            background-color: #000;
            padding: 8px;
            gap: 8px;
        }
        
        .header {
            text-align: center;
            padding: 8px 5px;
            border-bottom: 1px dashed #0f0;
            flex-shrink: 0;
        }
        
        .game-title {
            font-size: 1.8rem;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            margin-bottom: 5px;
        }
        
        .level-title {
            font-size: 1.2rem;
            color: #0f0;
        }
        
        .screen {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #0f0;
            padding: 12px;
            background-color: #111;
            font-size: 1.1rem;
            line-height: 1.5;
            min-height: 0;
            scroll-behavior: smooth;
        }
        
        .screen::-webkit-scrollbar {
            width: 8px;
        }
        
        .screen::-webkit-scrollbar-thumb {
            background-color: #0f0;
        }
        
        .output-text {
            margin-bottom: 8px;
            animation: typing 0.05s steps(1, end);
            word-wrap: break-word;
        }
        
        .npc-text {
            color: #0af;
        }
        
        .merchant-text {
            color: #ffa500;
        }
        
        .skeleton-text {
            color: #8a2be2;
        }
        
        .player-text {
            color: #8f8;
        }
        
        .important-text {
            color: #ff0;
            font-weight: bold;
        }
        
        .danger-text {
            color: #f00;
        }
        
        .success-text {
            color: #0f0;
        }
        
        .gold-text {
            color: #ffd700;
            text-shadow: 0 0 3px #ffd700;
        }
        
        .action-panel {
            display: none;
            border: 1px solid #0f0;
            padding: 10px;
            background-color: #111;
            flex-shrink: 0;
        }
        
        .action-title {
            color: #0f0;
            margin-bottom: 10px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .action-choices {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .button {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 14px 8px;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.1s;
            touch-action: manipulation;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
        }
        
        .button:active {
            background-color: #0f0;
            color: #000;
        }
        
        .command-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            flex-shrink: 0;
        }
        
        .command-button {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 14px 5px;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.1s;
            touch-action: manipulation;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .command-button:active {
            background-color: #0f0;
            color: #000;
        }
        
        .code-input {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border: 1px solid #0f0;
            background-color: #111;
            margin-top: 10px;
        }
        
        .code-display {
            font-size: 1.8rem;
            letter-spacing: 8px;
            margin-bottom: 15px;
            padding: 5px 15px;
            border: 1px solid #0f0;
            min-width: 200px;
            text-align: center;
        }
        
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .keypad-button {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }
        
        .keypad-controls {
            display: flex;
            gap: 10px;
        }
        
        .keypad-control-button {
            padding: 10px 15px;
            min-width: 80px;
        }
        
        .inventory-panel {
            display: none;
            border: 1px solid #0f0;
            padding: 10px;
            background-color: #111;
            flex-shrink: 0;
        }
        
        .inventory-title {
            color: #0f0;
            margin-bottom: 10px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            border: 1px dashed #0f0;
            padding: 8px 10px;
            font-size: 1rem;
            min-width: 100px;
            text-align: center;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 8px 5px;
            border-top: 1px dashed #0f0;
            flex-shrink: 0;
            font-size: 0.9rem;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        @keyframes typing {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Responsive adjustments */
        @media (max-height: 700px) {
            .button, .command-button {
                padding: 10px 5px;
                font-size: 1rem;
                min-height: 40px;
            }
            
            .game-title {
                font-size: 1.5rem;
            }
            
            .level-title {
                font-size: 1rem;
            }
        }
        
        @media (max-height: 600px) {
            .screen {
                font-size: 1rem;
                padding: 8px;
            }
            
            .button, .command-button {
                padding: 8px 4px;
                min-height: 36px;
            }
            
            .keypad-button {
                width: 50px;
                height: 50px;
            }
        }
        
        .conversation-log {
            border-top: 1px dashed #0f0;
            margin-top: 10px;
            padding-top: 10px;
        }
        
        .conversation-title {
            color: #0f0;
            font-size: 1rem;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="game-title">CASTLE OF THE UNDEAD</div>
            <div class="level-title" id="levelTitle">TEXT ADVENTURE - CASTLE GATES</div>
        </div>
        
        <div class="screen" id="gameScreen">
            <div class="output-text">CASTLE OF THE UNDEAD - Enhanced Text Adventure</div>
            <div class="output-text">Copyright (C) 1985 Nightfall Productions</div>
            <div class="output-text">Loading game data... OK</div>
            <div class="output-text">Initializing conversation system... OK</div>
            <div class="output-text">Initializing economy system... OK</div>
            <div class="output-text">Initializing auto-scroll... OK</div>
            <div class="output-text">----------------------------------------</div>
            <div class="output-text" id="currentOutput">You stand before the ominous CASTLE OF THE UNDEAD. The massive iron gates are sealed shut with a heavy chain and padlock. Cold wind howls through the stone archway. To your left, a flickering lantern casts eerie shadows. To your right, a skeletal guard leans against the wall, motionless. A weathered stone plaque is embedded in the wall next to the gate.</div>
        </div>
        
        <!-- Action Panel for choices -->
        <div class="action-panel" id="actionPanel">
            <div class="action-title" id="actionTitle">Select Action</div>
            <div class="action-choices" id="actionChoices">
                <!-- Dynamic buttons will be inserted here -->
            </div>
        </div>
        
        <!-- Code Input Interface -->
        <div class="code-input" id="codeInput">
            <div class="code-display" id="codeDisplay">____</div>
            <div class="keypad">
                <!-- Keypad buttons will be generated by JavaScript -->
            </div>
            <div class="keypad-controls">
                <button class="button keypad-control-button" id="enterCodeBtn">ENTER</button>
                <button class="button keypad-control-button" id="clearCodeBtn">CLEAR</button>
                <button class="button keypad-control-button" id="cancelCodeBtn">CANCEL</button>
            </div>
        </div>
        
        <!-- Main Command Buttons -->
        <div class="command-buttons">
            <button class="command-button" id="lookBtn">LOOK</button>
            <button class="command-button" id="interactBtn">INTERACT</button>
            <button class="command-button" id="inventoryBtn">INVENTORY</button>
            <button class="command-button" id="talkBtn">TALK</button>
            <button class="command-button" id="useBtn">USE ITEM</button>
            <button class="command-button" id="moveBtn">MOVE</button>
            <button class="command-button" id="examineBtn">EXAMINE</button>
            <button class="command-button" id="helpBtn">HELP</button>
        </div>
        
        <!-- Inventory Panel -->
        <div class="inventory-panel" id="inventoryPanel">
            <div class="inventory-title">INVENTORY</div>
            <div class="inventory-items" id="inventoryItems">
                <div class="inventory-item">Empty</div>
            </div>
        </div>
        
        <div class="status-bar">
            <div>Location: <span id="locationValue">CASTLE GATES</span></div>
            <div>Health: <span id="healthValue">100</span>%</div>
            <div>Gold: <span class="gold-text" id="goldValue">0</span></div>
            <div>Score: <span id="scoreValue">0</span></div>
        </div>
    </div>

    <script>
        // Game state variables
        let gameState = {
            currentLocation: "castleGates",
            inventory: [],
            score: 0,
            health: 100,
            gold: 0,
            gateLocked: true,
            plaqueRead: false,
            guardSpoken: false,
            lanternLit: true,
            codeKnown: false,
            codeEntered: false,
            guardHelpful: false,
            guardFriendly: false,
            guardHostile: false,
            riddleSolved: false,
            hasNote: false,
            hasKey: false,
            hasTorch: false,
            hasCoinPurse: false,
            guardBribed: false,
            guardInfoBought: false,
            guardServiceBought: false,
            conversationHistory: [],
            // Level 2 variables
            merchantSpoken: false,
            hoodedSkeletonSpoken: false,
            hasSilverLocket: false,
            locketGivenToSkeleton: false,
            merchantScammed: false,
            boughtCursedItem: false,
            courtyardExamined: false,
            // New: Level completion tracking
            level2Complete: false
        };
        
        // DOM elements
        const gameScreen = document.getElementById('gameScreen');
        const actionPanel = document.getElementById('actionPanel');
        const actionTitle = document.getElementById('actionTitle');
        const actionChoices = document.getElementById('actionChoices');
        const codeInput = document.getElementById('codeInput');
        const codeDisplay = document.getElementById('codeDisplay');
        const inventoryPanel = document.getElementById('inventoryPanel');
        const inventoryItems = document.getElementById('inventoryItems');
        const healthValue = document.getElementById('healthValue');
        const scoreValue = document.getElementById('scoreValue');
        const goldValue = document.getElementById('goldValue');
        const locationValue = document.getElementById('locationValue');
        const levelTitle = document.getElementById('levelTitle');
        
        // Current code input
        let currentCode = "";
        
        // Auto-scroll functionality
        let autoScrollEnabled = true;
        let userScrolledUp = false;
        
        // Setup scroll tracking
        gameScreen.addEventListener('scroll', function() {
            // Check if user is scrolled to bottom (within 50px)
            const isAtBottom = gameScreen.scrollHeight - gameScreen.clientHeight - gameScreen.scrollTop <= 50;
            userScrolledUp = !isAtBottom;
        });
        
        // Initialize the game
        function initGame() {
            updateStatus();
            addToOutput("Touch commands to play. Goal: Enter the castle.", "important-text");
            addToOutput("Tip: Talking to the skeleton guard may provide helpful information or services... for a price.", "npc-text");
            setupKeypad();
            setupEventListeners();
        }
        
        // Set up event listeners for buttons
        function setupEventListeners() {
            // Command buttons
            document.getElementById('lookBtn').addEventListener('click', handleLook);
            document.getElementById('interactBtn').addEventListener('click', handleInteract);
            document.getElementById('inventoryBtn').addEventListener('click', handleInventory);
            document.getElementById('talkBtn').addEventListener('click', handleTalk);
            document.getElementById('useBtn').addEventListener('click', handleUseItem);
            document.getElementById('moveBtn').addEventListener('click', handleMove);
            document.getElementById('examineBtn').addEventListener('click', handleExamine);
            document.getElementById('helpBtn').addEventListener('click', handleHelp);
            
            // Code input buttons
            document.getElementById('enterCodeBtn').addEventListener('click', checkCode);
            document.getElementById('clearCodeBtn').addEventListener('click', clearCode);
            document.getElementById('cancelCodeBtn').addEventListener('click', hideCodeInput);
        }
        
        // Set up the keypad for code entry
        function setupKeypad() {
            const keypad = document.querySelector('.keypad');
            keypad.innerHTML = '';
            
            // Create buttons 1-9
            for (let i = 1; i <= 9; i++) {
                const button = document.createElement('button');
                button.className = 'button keypad-button';
                button.textContent = i;
                button.addEventListener('click', () => addToCode(i.toString()));
                keypad.appendChild(button);
            }
            
            // Add 0 button at the end
            const zeroButton = document.createElement('button');
            zeroButton.className = 'button keypad-button';
            zeroButton.textContent = '0';
            zeroButton.addEventListener('click', () => addToCode('0'));
            keypad.appendChild(zeroButton);
        }
        
        // Add text to the game screen with auto-scroll
        function addToOutput(text, className = "") {
            const newLine = document.createElement("div");
            newLine.className = `output-text ${className}`;
            newLine.textContent = text;
            gameScreen.appendChild(newLine);
            
            // Auto-scroll if enabled and user hasn't manually scrolled up
            if (!userScrolledUp) {
                gameScreen.scrollTop = gameScreen.scrollHeight;
            }
        }
        
        // Add conversation to log
        function addConversation(speaker, text, npcType = "guard") {
            let speakerName, speakerClass;
            
            switch(speaker) {
                case "player":
                    speakerName = "You";
                    speakerClass = "player-text";
                    break;
                case "guard":
                    speakerName = "Skeleton Guard";
                    speakerClass = "npc-text";
                    break;
                case "merchant":
                    speakerName = "Merchant";
                    speakerClass = "merchant-text";
                    break;
                case "skeleton":
                    speakerName = "Hooded Skeleton";
                    speakerClass = "skeleton-text";
                    break;
                default:
                    speakerName = speaker;
                    speakerClass = "npc-text";
            }
            
            addToOutput(`${speakerName}: ${text}`, speakerClass);
            
            // Add to conversation history
            gameState.conversationHistory.push({speaker, text});
        }
        
        // Update status display
        function updateStatus() {
            healthValue.textContent = gameState.health;
            scoreValue.textContent = gameState.score;
            goldValue.textContent = gameState.gold;
            
            // Update location display
            if (gameState.currentLocation === "castleGates") {
                locationValue.textContent = "CASTLE GATES";
                levelTitle.textContent = "TEXT ADVENTURE - CASTLE GATES";
            } else if (gameState.currentLocation === "castleCourtyard") {
                locationValue.textContent = "CASTLE COURTYARD";
                levelTitle.textContent = "TEXT ADVENTURE - CASTLE COURTYARD";
            }
        }
        
        // Show action panel with choices
        function showActionPanel(title, choices, callback) {
            actionTitle.textContent = title;
            actionChoices.innerHTML = '';
            
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'button';
                button.textContent = choice.text;
                button.addEventListener('click', () => {
                    hideActionPanel();
                    callback(choice.value, choice.text);
                });
                actionChoices.appendChild(button);
            });
            
            actionPanel.style.display = 'block';
        }
        
        // Hide action panel
        function hideActionPanel() {
            actionPanel.style.display = 'none';
        }
        
        // Show code input interface
        function showCodeInput() {
            codeInput.style.display = 'flex';
            currentCode = "";
            updateCodeDisplay();
        }
        
        // Hide code input interface
        function hideCodeInput() {
            codeInput.style.display = 'none';
        }
        
        // Add digit to code
        function addToCode(digit) {
            if (currentCode.length < 4) {
                currentCode += digit;
                updateCodeDisplay();
            }
        }
        
        // Update code display
        function updateCodeDisplay() {
            let display = currentCode;
            for (let i = currentCode.length; i < 4; i++) {
                display += "_";
            }
            codeDisplay.textContent = display;
        }
        
        // Clear code input
        function clearCode() {
            currentCode = "";
            updateCodeDisplay();
        }
        
        // Check entered code
        function checkCode() {
            if (currentCode === "1492") {
                addToOutput("You hear a loud CLICK. The padlock opens and the chain falls away!", "success-text");
                addToOutput("The gates slowly creak open, revealing the castle courtyard beyond.", "success-text");
                gameState.gateLocked = false;
                gameState.score += 50;
                updateStatus();
                hideCodeInput();
            } else {
                addToOutput("The lock remains stubbornly shut. The code appears to be incorrect.", "danger-text");
                gameState.health -= 10;
                updateStatus();
                
                if (gameState.health <= 0) {
                    addToOutput("Your health has reached zero! GAME OVER.", "danger-text");
                    // Disable all buttons
                    document.querySelectorAll('.button, .command-button').forEach(btn => btn.disabled = true);
                }
            }
        }
        
        // Update inventory display
        function updateInventory() {
            inventoryItems.innerHTML = "";
            
            if (gameState.inventory.length === 0) {
                const emptyItem = document.createElement("div");
                emptyItem.className = "inventory-item";
                emptyItem.textContent = "Empty";
                inventoryItems.appendChild(emptyItem);
            } else {
                gameState.inventory.forEach(item => {
                    const itemElement = document.createElement("div");
                    itemElement.className = "inventory-item";
                    itemElement.textContent = item.toUpperCase();
                    inventoryItems.appendChild(itemElement);
                });
            }
        }
        
        // Save game state to localStorage and redirect to c2.html
        function saveGameAndRedirect() {
            // Save the entire game state to localStorage
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            
            // Show transition message
            addToOutput("Game state saved successfully!", "success-text");
            addToOutput("Preparing to enter the castle interior...", "important-text");
            
            // Redirect to c2.html after a short delay
            setTimeout(() => {
                window.location.href = 'c2.html';
            }, 3000);
        }
        
        // Look command
        function handleLook() {
            if (gameState.currentLocation === "castleGates") {
                addToOutput("You stand before the ominous CASTLE OF THE UNDEAD. The massive iron gates are sealed shut with a heavy chain and padlock. Cold wind howls through the stone archway. To your left, a flickering lantern casts eerie shadows. To your right, a skeletal guard leans against the wall, motionless. A weathered stone plaque is embedded in the wall next to the gate.");
            } else if (gameState.currentLocation === "castleCourtyard") {
                addToOutput("You are in the castle courtyard. The air is cold and damp with a thick mist clinging to the ground. To the north, the main castle doors stand imposing and locked. To your left, a shady-looking merchant has set up a makeshift stall. To your right, a hooded skeleton figure leans against the wall, watching you intently.");
                
                if (!gameState.courtyardExamined) {
                    addToOutput("Scattered around the courtyard are broken statues, overgrown weeds, and the remnants of old battles.", "important-text");
                    gameState.courtyardExamined = true;
                }
            }
        }
        
        // Interact command
        function handleInteract() {
            if (gameState.currentLocation === "castleGates") {
                showActionPanel("INTERACT WITH:", [
                    {text: "LANTERN", value: "lantern"},
                    {text: "SKELETAL GUARD", value: "guard"},
                    {text: "STONE PLAQUE", value: "plaque"},
                    {text: "GATE LOCK", value: "lock"},
                    {text: "SEARCH GROUND", value: "ground"}
                ], handleInteractChoice);
            } else if (gameState.currentLocation === "castleCourtyard") {
                showActionPanel("INTERACT WITH:", [
                    {text: "MERCHANT'S STALL", value: "merchant_stall"},
                    {text: "HOODED SKELETON", value: "hooded_skeleton"},
                    {text: "SEARCH COURTYARD", value: "search_courtyard"},
                    {text: "CASTLE DOORS", value: "castle_doors"},
                    {text: "BROKEN STATUES", value: "statues"}
                ], handleCourtyardInteractChoice);
            }
        }
        
        // Handle interact choice for courtyard
        function handleCourtyardInteractChoice(choice) {
            switch(choice) {
                case "merchant_stall":
                    addToOutput("You approach the merchant's stall. It's filled with strange trinkets, potions, and odd artifacts. The merchant eyes you suspiciously.", "merchant-text");
                    break;
                    
                case "hooded_skeleton":
                    addToOutput("The hooded skeleton watches you approach but says nothing. Its empty eye sockets seem to peer right through you.", "skeleton-text");
                    break;
                    
                case "search_courtyard":
                    if (!gameState.hasSilverLocket) {
                        const findChance = Math.random();
                        if (findChance > 0.5) {
                            addToOutput("You search through the overgrown weeds and rubble...", "important-text");
                            addToOutput("You find a SILVER LOCKET WITH A SKULL ENGRAVING! It's tarnished but appears valuable.", "success-text");
                            gameState.inventory.push("silver locket");
                            gameState.hasSilverLocket = true;
                            gameState.score += 25;
                            updateInventory();
                            updateStatus();
                            addToOutput("The hooded skeleton seems to take notice of your discovery.", "skeleton-text");
                        } else {
                            addToOutput("You search the courtyard but find nothing of value.", "important-text");
                        }
                    } else {
                        addToOutput("You've already searched the courtyard thoroughly.");
                    }
                    break;
                    
                case "castle_doors":
                    addToOutput("The main castle doors are massive and ornately carved. They're sealed with a magical barrier that shimmers faintly. You'll need a special key or spell to enter.");
                    break;
                    
                case "statues":
                    addToOutput("The broken statues depict ancient warriors and nobles. Most are missing heads or limbs. One statue's hand seems to be pointing toward the merchant's stall.");
                    break;
            }
        }
        
        // Handle interact choice for gates
        function handleInteractChoice(choice) {
            switch(choice) {
                case "lantern":
                    if (!gameState.hasNote) {
                        addToOutput("You reach into the lantern and retrieve a rolled-up piece of parchment.", "success-text");
                        addToOutput("You obtained a NOTE!", "important-text");
                        gameState.inventory.push("note");
                        gameState.hasNote = true;
                        gameState.score += 10;
                        updateInventory();
                        updateStatus();
                    } else {
                        addToOutput("You already took the note from the lantern.");
                    }
                    break;
                    
                case "guard":
                    addToOutput("The guard doesn't respond to touch. Maybe try TALKING to it.");
                    break;
                    
                case "plaque":
                    addToOutput("You examine the plaque more closely.", "important-text");
                    addToOutput("The stone plaque is covered in moss. You wipe it clean to reveal an inscription: 'Only those who know the number of the night may enter.' Below is a numeric keypad with buttons 0-9.");
                    if (gameState.hasNote) {
                        addToOutput("You recall the note from the lantern mentions: 'The number you seek is the year the castle fell: 1492'", "important-text");
                        gameState.codeKnown = true;
                    }
                    break;
                    
                case "lock":
                    if (gameState.gateLocked) {
                        addToOutput("The gate is locked with a 4-digit code. You need to enter the correct combination.");
                        showCodeInput();
                    } else {
                        addToOutput("The gate is already unlocked!");
                    }
                    break;
                    
                case "ground":
                    if (!gameState.hasCoinPurse) {
                        addToOutput("You search the ground near the gates.", "important-text");
                        addToOutput("You find a small leather coin purse! It contains 25 gold coins.", "gold-text");
                        gameState.gold += 25;
                        gameState.hasCoinPurse = true;
                        gameState.score += 15;
                        updateStatus();
                    } else {
                        addToOutput("You already found the coin purse here.");
                    }
                    break;
            }
        }
        
        // Inventory command
        function handleInventory() {
            if (inventoryPanel.style.display === "block") {
                inventoryPanel.style.display = "none";
            } else {
                inventoryPanel.style.display = "block";
                updateInventory();
            }
        }
        
        // Talk command
        function handleTalk() {
            if (gameState.currentLocation === "castleGates") {
                handleGuardTalk();
            } else if (gameState.currentLocation === "castleCourtyard") {
                showActionPanel("TALK TO:", [
                    {text: "MERCHANT", value: "merchant"},
                    {text: "HOODED SKELETON", value: "hooded_skeleton"}
                ], handleCourtyardTalkChoice);
            }
        }
        
        // Handle courtyard talk choice
        function handleCourtyardTalkChoice(choice) {
            if (choice === "merchant") {
                handleMerchantTalk();
            } else if (choice === "hooded_skeleton") {
                handleHoodedSkeletonTalk();
            }
        }
        
        // Handle merchant talk
        function handleMerchantTalk() {
            if (!gameState.merchantSpoken) {
                addConversation("merchant", "Well, well, a living soul in this cursed place! Care to browse my wares, traveler? I have potions, trinkets, and... special items for those with the coin.");
                gameState.merchantSpoken = true;
                
                setTimeout(() => {
                    showActionPanel("RESPOND TO MERCHANT:", [
                        {text: "What do you sell?", value: "ask_wares"},
                        {text: "Who are you?", value: "ask_who"},
                        {text: "What about that hooded figure?", value: "ask_about_skeleton"},
                        {text: "I'm not interested", value: "not_interested"}
                    ], handleMerchantResponse);
                }, 500);
            } else {
                showActionPanel("TALK TO MERCHANT:", [
                    {text: "Show me your wares", value: "ask_wares"},
                    {text: "Tell me about the hooded skeleton", value: "ask_about_skeleton"},
                    {text: "Buy something", value: "buy_item"},
                    {text: "Goodbye", value: "goodbye"}
                ], handleMerchantResponse);
            }
        }
        
        // Handle merchant responses
        function handleMerchantResponse(choice) {
            switch(choice) {
                case "ask_wares":
                    addConversation("player", "What do you sell?");
                    addConversation("merchant", "I have healing potions (25 gold), a 'Lucky Charm' that brings fortune (50 gold), and a mysterious 'Cursed Dagger' that's said to be powerful but... temperamental (100 gold).");
                    break;
                    
                case "ask_who":
                    addConversation("player", "Who are you?");
                    addConversation("merchant", "I'm just a humble merchant trying to make a living in these dark times. I travel between realms, buying and selling. These undead may not need much, but occasionally living adventurers like yourself come through.");
                    break;
                    
                case "ask_about_skeleton":
                    addConversation("player", "What about that hooded figure over there?");
                    addConversation("merchant", "Ah, him. He's a thief and a liar that cons people out of things so he can gain. He should be avoided at all costs. He's been trying to steal from my stall for weeks! Don't believe anything he says about me.");
                    break;
                    
                case "buy_item":
                    showActionPanel("BUY FROM MERCHANT:", [
                        {text: "Healing Potion (25 gold)", value: "buy_potion"},
                        {text: "Lucky Charm (50 gold)", value: "buy_charm"},
                        {text: "Cursed Dagger (100 gold)", value: "buy_dagger"},
                        {text: "Never mind", value: "cancel"}
                    ], handleMerchantBuy);
                    break;
                    
                case "not_interested":
                case "goodbye":
                    addConversation("player", "I'm not interested.");
                    addConversation("merchant", "Suit yourself. But don't say I didn't offer you protection in this dangerous place.");
                    break;
                    
                case "cancel":
                    addConversation("merchant", "Changed your mind? That's fine. Come back when you have more gold.");
                    break;
            }
        }
        
        // Handle merchant purchases
        function handleMerchantBuy(choice) {
            switch(choice) {
                case "buy_potion":
                    if (gameState.gold >= 25) {
                        gameState.gold -= 25;
                        addConversation("player", "I'll take a healing potion.");
                        addConversation("merchant", "Excellent choice! This will restore 50 health when used.");
                        gameState.inventory.push("healing potion");
                        updateInventory();
                        updateStatus();
                        addToOutput("You obtained a HEALING POTION!", "important-text");
                    } else {
                        addConversation("merchant", "You don't have enough gold for that.");
                    }
                    break;
                    
                case "buy_charm":
                    if (gameState.gold >= 50) {
                        gameState.gold -= 50;
                        addConversation("player", "I'll take the lucky charm.");
                        addConversation("merchant", "A wise investment! This charm will... um... definitely bring you good fortune. Maybe.");
                        gameState.inventory.push("lucky charm");
                        updateInventory();
                        updateStatus();
                        addToOutput("You obtained a LUCKY CHARM!", "important-text");
                        gameState.merchantScammed = true;
                    } else {
                        addConversation("merchant", "You can't afford such luxury items.");
                    }
                    break;
                    
                case "buy_dagger":
                    if (gameState.gold >= 100) {
                        gameState.gold -= 100;
                        addConversation("player", "I'll take the cursed dagger.");
                        addConversation("merchant", "Bold choice! This dagger is... special. Handle it with care.");
                        gameState.inventory.push("cursed dagger");
                        updateInventory();
                        updateStatus();
                        addToOutput("You obtained a CURSED DAGGER!", "important-text");
                        gameState.boughtCursedItem = true;
                        gameState.health -= 20; // The curse takes effect
                        updateStatus();
                        addToOutput("You feel a dark energy from the dagger sapping your vitality!", "danger-text");
                    } else {
                        addConversation("merchant", "You lack the funds for such a powerful artifact.");
                    }
                    break;
            }
        }
        
        // Handle hooded skeleton talk
        function handleHoodedSkeletonTalk() {
            if (!gameState.hoodedSkeletonSpoken) {
                addConversation("skeleton", "...You are new here. Listen carefully, living one. Be careful what you acquire from the merchant as he's been known to trade sell items that are not what they seem or don't do what they appear to be.");
                gameState.hoodedSkeletonSpoken = true;
                
                setTimeout(() => {
                    addConversation("skeleton", "If you find a silver locket with a skull engraving bring it to me as it belongs to me and don't trade or sell or give it to the merchant as he can't be trusted.");
                    
                    setTimeout(() => {
                        showActionPanel("RESPOND TO HOODED SKELETON:", [
                            {text: "Why should I trust you?", value: "ask_trust"},
                            {text: "I have the locket", value: "has_locket"},
                            {text: "What's so special about it?", value: "ask_locket"},
                            {text: "I don't believe you", value: "dont_believe"}
                        ], handleSkeletonResponse);
                    }, 800);
                }, 800);
            } else {
                showActionPanel("TALK TO HOODED SKELETON:", [
                    {text: "I have the silver locket", value: "has_locket"},
                    {text: "Tell me about the merchant", value: "ask_merchant"},
                    {text: "Who are you really?", value: "ask_identity"},
                    {text: "Goodbye", value: "goodbye"}
                ], handleSkeletonResponse);
            }
        }
        
        // Handle skeleton responses
        function handleSkeletonResponse(choice) {
            switch(choice) {
                case "ask_trust":
                    addConversation("player", "Why should I trust you over the merchant?");
                    addConversation("skeleton", "The merchant sells cursed items and false promises. He sold my locket after I was... indisposed. It contains a fragment of my soul. Without it, I cannot rest.");
                    break;
                    
                case "has_locket":
                    if (gameState.hasSilverLocket && !gameState.locketGivenToSkeleton) {
                        addConversation("player", "I found a silver locket with a skull engraving.");
                        addConversation("skeleton", "You have it! Please, return it to me. It is rightfully mine. In return, I will give you something useful.");
                        
                        setTimeout(() => {
                            showActionPanel("GIVE LOOKET TO SKELETON?", [
                                {text: "Yes, here it is", value: "give_locket"},
                                {text: "No, I'm keeping it", value: "keep_locket"}
                            ], handleLocketDecision);
                        }, 500);
                    } else if (gameState.locketGivenToSkeleton) {
                        addConversation("skeleton", "Thank you again for returning my locket. I am in your debt.");
                    } else {
                        addConversation("skeleton", "You do not have it yet. Search the courtyard thoroughly. It must be here somewhere.");
                    }
                    break;
                    
                case "ask_locket":
                    addConversation("player", "What's so special about this locket?");
                    addConversation("skeleton", "It was a gift from my beloved before I was cursed to this form. It holds sentimental value... and a fragment of my soul. The merchant stole it from my remains.");
                    break;
                    
                case "ask_merchant":
                    addConversation("player", "Tell me more about the merchant.");
                    addConversation("skeleton", "He preys on the desperate. His 'lucky charms' are worthless, his potions are diluted, and his cursed items are truly cursed. He cares only for gold.");
                    break;
                    
                case "ask_identity":
                    addConversation("player", "Who are you really?");
                    addConversation("skeleton", "I was once a knight of this castle, Sir Alistair. When the curse fell, I became... this. The merchant arrived after the fall, looting the dead.");
                    break;
                    
                case "dont_believe":
                    addConversation("player", "I don't believe you.");
                    addConversation("skeleton", "Then you will learn the hard way. The merchant's greed has doomed many.");
                    break;
                    
                case "goodbye":
                    addConversation("player", "Goodbye.");
                    addConversation("skeleton", "Farewell. Remember my warning.");
                    break;
                    
                case "keep_locket":
                    addConversation("player", "No, I think I'll keep it.");
                    addConversation("skeleton", "You make a grave mistake. That locket will bring you no joy.");
                    break;
            }
        }
        
        // Handle locket decision
        function handleLocketDecision(choice) {
            if (choice === "give_locket") {
                addConversation("player", "Here, take it. It's yours.");
                addConversation("skeleton", "Thank you, kind stranger! You have returned a piece of my soul to me. Please, take this as a token of my gratitude.");
                
                // Remove locket from inventory
                const locketIndex = gameState.inventory.indexOf("silver locket");
                if (locketIndex > -1) {
                    gameState.inventory.splice(locketIndex, 1);
                }
                gameState.hasSilverLocket = false;
                gameState.locketGivenToSkeleton = true;
                
                // Add reward to inventory
                gameState.inventory.push("skeleton key");
                addToOutput("The hooded skeleton gives you a SKELETON KEY!", "success-text");
                addToOutput("The skeleton key glows with a faint blue light. It might unlock the castle doors.", "important-text");
                
                gameState.score += 100;
                updateInventory();
                updateStatus();
                
                addConversation("skeleton", "That key will open the castle doors. Be careful inside... not all who wander there are as friendly as I.");
            }
        }
        
        // Handle guard talk (original from level 1)
        function handleGuardTalk() {
            if (gameState.guardHostile) {
                addConversation("guard", "'Leave me be, intruder!' The guard turns away from you.");
                return;
            }
            
            if (!gameState.guardSpoken) {
                addConversation("guard", "The skeletal guard's jaw creaks open: 'Who dares approach the Castle of the Undead? State your business, mortal.'");
                gameState.guardSpoken = true;
                
                // Show initial conversation choices
                setTimeout(() => {
                    showActionPanel("WHAT DO YOU SAY?", [
                        {text: "I seek entry to the castle.", value: "seek_entry"},
                        {text: "Who are you?", value: "who_are_you"},
                        {text: "Can you help me get inside?", value: "ask_help"},
                        {text: "I mean no harm.", value: "no_harm"}
                    ], handleGuardConversation);
                }, 500);
            } else {
                // Continue conversation
                showActionPanel("TALK TO SKELETON GUARD:", [
                    {text: "Ask about the castle", value: "about_castle"},
                    {text: "Ask about the gate code", value: "gate_code"},
                    {text: "Ask for help with the riddle", value: "ask_riddle"},
                    {text: "Offer gold for information", value: "offer_gold"},
                    {text: "Offer gold for service", value: "offer_service"},
                    {text: "Just passing through", value: "goodbye"}
                ], handleGuardConversation);
            }
        }
        
        // Handle guard conversation (original from level 1)
        function handleGuardConversation(choice, choiceText) {
            addConversation("player", choiceText, "guard");
            
            switch(choice) {
                case "seek_entry":
                case "ask_help":
                    if (!gameState.guardBribed && !gameState.guardFriendly) {
                        addConversation("guard", "'Entry is forbidden to the living! However... I might be persuaded to overlook certain rules... for a price. 50 gold should suffice.'");
                        gameState.guardFriendly = true;
                        
                        // Show response options
                        setTimeout(() => {
                            showActionPanel("RESPOND:", [
                                {text: "Pay 50 gold", value: "pay_bribe"},
                                {text: "I don't have that much", value: "no_gold"},
                                {text: "I'll find another way", value: "refuse"}
                            ], handleGuardConversation);
                        }, 500);
                    } else if (gameState.guardBribed) {
                        addConversation("guard", "'You've already paid. The code is 1492. Now leave me be.'");
                    } else {
                        addConversation("guard", "'Have you reconsidered my offer? 50 gold for the gate code.'");
                        
                        setTimeout(() => {
                            showActionPanel("RESPOND:", [
                                {text: "Pay 50 gold", value: "pay_bribe"},
                                {text: "Not interested", value: "refuse"}
                            ], handleGuardConversation);
                        }, 500);
                    }
                    break;
                    
                case "who_are_you":
                    addConversation("guard", "'I am Valerius, last of the castle guardians. For three centuries I've stood this post, long after my flesh turned to dust.'");
                    
                    setTimeout(() => {
                        showActionPanel("RESPOND:", [
                            {text: "That's a long time", value: "long_time"},
                            {text: "Why do you still guard it?", value: "why_guard"}
                        ], handleGuardConversation);
                    }, 500);
                    break;
                    
                case "no_harm":
                    addConversation("guard", "'Your intentions matter not. The castle is sealed to all but those who know the secret.'");
                    gameState.guardFriendly = true;
                    break;
                    
                case "about_castle":
                    if (gameState.guardFriendly || gameState.guardBribed) {
                        addConversation("guard", "'The castle fell in the year 1492, when the great curse was laid upon it. All within perished in a single night.'");
                        gameState.score += 5;
                        updateStatus();
                    } else {
                        addConversation("guard", "'That is not your concern, mortal.'");
                    }
                    break;
                    
                case "gate_code":
                    if (gameState.guardBribed) {
                        addConversation("guard", "'I already told you: 1492, the year the castle fell.'");
                        gameState.codeKnown = true;
                    } else if (gameState.guardFriendly) {
                        addConversation("guard", "'The code is the year the castle fell. I could tell you which year... for 30 gold.'");
                        
                        setTimeout(() => {
                            showActionPanel("RESPOND:", [
                                {text: "Pay 30 gold for the year", value: "pay_info"},
                                {text: "Too expensive", value: "refuse_info"}
                            ], handleGuardConversation);
                        }, 500);
                    } else {
                        addConversation("guard", "'The code? That would be telling. And I don't work for free.'");
                    }
                    break;
                    
                case "ask_riddle":
                    if (!gameState.riddleSolved) {
                        addConversation("guard", "'Ah, you wish to prove your wit? Answer this: What has keys but opens no locks?'");
                        
                        setTimeout(() => {
                            showActionPanel("ANSWER THE RIDDLE:", [
                                {text: "PIANO", value: "piano"},
                                {text: "MAP", value: "map"},
                                {text: "COMPUTER", value: "computer"},
                                {text: "SKELETON", value: "skeleton"}
                            ], handleRiddleAnswer);
                        }, 500);
                    } else {
                        addConversation("guard", "'You already solved my riddle. You have your reward.'");
                    }
                    break;
                    
                case "offer_gold":
                    addConversation("guard", "'Gold speaks loudly in these silent halls. What information do you seek?'");
                    
                    setTimeout(() => {
                        showActionPanel("ASK ABOUT:", [
                            {text: "Gate code (30 gold)", value: "pay_info"},
                            {text: "Castle history (10 gold)", value: "pay_history"},
                            {text: "Secret passages (50 gold)", value: "pay_secret"}
                        ], handleGuardConversation);
                    }, 500);
                    break;
                    
                case "offer_service":
                    addConversation("guard", "'My services are limited, but available. What do you need?'");
                    
                    setTimeout(() => {
                        showActionPanel("REQUEST:", [
                            {text: "Unlock the gate (50 gold)", value: "pay_bribe"},
                            {text: "Give me a weapon (75 gold)", value: "buy_weapon"},
                            {text: "Heal my wounds (25 gold)", value: "buy_heal"}
                        ], handleGuardConversation);
                    }, 500);
                    break;
                    
                case "pay_bribe":
                    if (gameState.gold >= 50) {
                        gameState.gold -= 50;
                        gameState.guardBribed = true;
                        gameState.codeKnown = true;
                        addConversation("guard", "'A wise investment. The code is 1492, the year the castle fell. You may enter.'");
                        addToOutput("You paid 50 gold to the guard.", "gold-text");
                        gameState.score += 20;
                        updateStatus();
                    } else {
                        addConversation("guard", "'You don't have enough gold. Return when you do.'");
                    }
                    break;
                    
                case "pay_info":
                    if (gameState.gold >= 30) {
                        gameState.gold -= 30;
                        gameState.guardInfoBought = true;
                        gameState.codeKnown = true;
                        addConversation("guard", "'The castle fell in the year 1492. That is the number you seek.'");
                        addToOutput("You paid 30 gold for information.", "gold-text");
                        gameState.score += 15;
                        updateStatus();
                    } else {
                        addConversation("guard", "'You lack the required gold.'");
                    }
                    break;
                    
                case "pay_history":
                    if (gameState.gold >= 10) {
                        gameState.gold -= 10;
                        addConversation("guard", "'The lord of this castle sought immortality. He achieved it... after a fashion. Now all within are cursed to eternal undeath.'");
                        addToOutput("You paid 10 gold for information.", "gold-text");
                        gameState.score += 5;
                        updateStatus();
                    } else {
                        addConversation("guard", "'You cannot afford this knowledge.'");
                    }
                    break;
                    
                case "pay_secret":
                    if (gameState.gold >= 50) {
                        gameState.gold -= 50;
                        addConversation("guard", "'There is a hidden passage in the courtyard behind the third statue. It bypasses the main hall guards. Use it wisely.'");
                        addToOutput("You paid 50 gold for a secret.", "gold-text");
                        gameState.score += 25;
                        updateStatus();
                    } else {
                        addConversation("guard", "'Such valuable secrets don't come cheap.'");
                    }
                    break;
                    
                case "buy_weapon":
                    if (gameState.gold >= 75) {
                        gameState.gold -= 75;
                        if (!gameState.inventory.includes("rusty sword")) {
                            gameState.inventory.push("rusty sword");
                            addConversation("guard", "'Take this old blade. It's seen better days, but it will serve.'");
                            addToOutput("You obtained a RUSTY SWORD!", "important-text");
                            addToOutput("You paid 75 gold for the weapon.", "gold-text");
                            gameState.score += 30;
                            updateInventory();
                            updateStatus();
                        } else {
                            addConversation("guard", "'You already have a weapon.'");
                            gameState.gold += 75; // Refund
                        }
                    } else {
                        addConversation("guard", "'You cannot afford my weapons.'");
                    }
                    break;
                    
                case "buy_heal":
                    if (gameState.gold >= 25 && gameState.health < 100) {
                        gameState.gold -= 25;
                        gameState.health = Math.min(100, gameState.health + 30);
                        addConversation("guard", "'Take this healing draught. It will restore your vitality.'");
                        addToOutput("You recovered 30 health!", "success-text");
                        addToOutput("You paid 25 gold for healing.", "gold-text");
                        gameState.score += 10;
                        updateStatus();
                    } else if (gameState.health >= 100) {
                        addConversation("guard", "'You are already at full health.'");
                    } else {
                        addConversation("guard", "'You don't have enough gold for healing.'");
                    }
                    break;
                    
                case "long_time":
                    addConversation("guard", "'Time means little when you're already dead. Now, do you have business here or not?'");
                    gameState.guardFriendly = true;
                    break;
                    
                case "why_guard":
                    addConversation("guard", "'A curse binds me to this post until the castle knows a living master again. Now leave me to my eternal vigil.'");
                    gameState.guardHostile = true;
                    break;
                    
                case "no_gold":
                    addConversation("guard", "'Then our conversation is at an end.'");
                    gameState.guardHostile = true;
                    break;
                    
                case "refuse":
                case "refuse_info":
                    addConversation("guard", "'Very well. Find your own way then.'");
                    break;
                    
                case "goodbye":
                    addConversation("guard", "'Farewell, mortal. May your death be swift.'");
                    break;
                    
                default:
                    addConversation("guard", "'What was that? Speak clearly.'");
                    break;
            }
        }
        
        // Handle riddle answer (original from level 1)
        function handleRiddleAnswer(answer, answerText) {
            addConversation("player", answerText, "guard");
            
            if (answer === "piano") {
                addConversation("guard", "'Correct! A piano has keys but opens no locks. For your wisdom, take this.'");
                if (!gameState.inventory.includes("rusty key")) {
                    gameState.inventory.push("rusty key");
                    addToOutput("The guard hands you a RUSTY KEY.", "success-text");
                    addToOutput("You obtained a RUSTY KEY!", "important-text");
                    gameState.guardHelpful = true;
                    gameState.riddleSolved = true;
                    gameState.score += 30;
                    updateInventory();
                    updateStatus();
                } else {
                    addConversation("guard", "'But you already have a key. Keep it.'");
                }
            } else {
                addConversation("guard", "'Incorrect. Perhaps gold would open my lips instead.'");
                gameState.guardFriendly = true;
            }
        }
        
        // Use item command
        function handleUseItem() {
            if (gameState.inventory.length === 0) {
                addToOutput("Your inventory is empty. There's nothing to use.");
                return;
            }
            
            const choices = gameState.inventory.map((item, index) => ({
                text: item.toUpperCase(),
                value: item
            }));
            
            showActionPanel("USE WHICH ITEM?", choices, handleUseItemChoice);
        }
        
        // Handle use item choice
        function handleUseItemChoice(item) {
            addToOutput(`You try to use the ${item.toUpperCase()}.`, "important-text");
            
            switch(item) {
                case "note":
                    addToOutput("The note reads: 'The number you seek is the year the castle fell: 1492'. Now you know the code!", "success-text");
                    gameState.codeKnown = true;
                    break;
                    
                case "rusty key":
                    if (gameState.gateLocked) {
                        addToOutput("The rusty key doesn't fit the padlock. It requires a code, not a key.", "danger-text");
                    } else {
                        addToOutput("The gate is already open. No need for the key now.");
                    }
                    break;
                    
                case "rusty sword":
                    addToOutput("You swing the rusty sword through the air. It feels unbalanced but serviceable.");
                    break;
                    
                case "healing potion":
                    if (gameState.health < 100) {
                        gameState.health = Math.min(100, gameState.health + 50);
                        addToOutput("You drink the healing potion and feel revitalized! (+50 health)", "success-text");
                        // Remove from inventory
                        const potionIndex = gameState.inventory.indexOf("healing potion");
                        if (potionIndex > -1) {
                            gameState.inventory.splice(potionIndex, 1);
                        }
                        updateInventory();
                        updateStatus();
                    } else {
                        addToOutput("You're already at full health. Save the potion for later.");
                    }
                    break;
                    
                case "lucky charm":
                    addToOutput("You rub the lucky charm. Nothing happens. Maybe it needs time to work?", "important-text");
                    break;
                    
                case "cursed dagger":
                    addToOutput("The cursed dagger pulses with dark energy. Using it makes you feel weaker.", "danger-text");
                    gameState.health -= 5;
                    updateStatus();
                    break;
                    
                case "skeleton key":
                    if (gameState.currentLocation === "castleCourtyard") {
                        addToOutput("You approach the castle doors with the skeleton key. The key glows brighter as you get closer.", "important-text");
                        addToOutput("The key fits perfectly into the lock. The magical barrier dissipates!", "success-text");
                        addToOutput("The castle doors creak open, revealing the dark interior beyond.", "success-text");
                        addToOutput("LEVEL 2 COMPLETE! Preparing to enter the castle interior...", "important-text");
                        addToOutput("Saving game state...", "success-text");
                        
                        // Mark level 2 as complete
                        gameState.level2Complete = true;
                        gameState.score += 200;
                        updateStatus();
                        
                        // Save game and redirect to c2.html
                        saveGameAndRedirect();
                    } else {
                        addToOutput("This key doesn't seem to fit anything here.");
                    }
                    break;
                    
                default:
                    addToOutput("Nothing happens.");
                    break;
            }
        }
        
        // Move command
        function handleMove() {
            if (gameState.currentLocation === "castleGates") {
                if (!gameState.gateLocked) {
                    addToOutput("You pass through the gates into the castle courtyard. The air grows colder...", "important-text");
                    addToOutput("You enter LEVEL 2: CASTLE COURTYARD", "success-text");
                    gameState.currentLocation = "castleCourtyard";
                    gameState.score += 100;
                    
                    // Bonus for having certain items/info
                    if (gameState.inventory.includes("rusty sword")) {
                        addToOutput("Bonus: Having a weapon will help in the courtyard!", "success-text");
                        gameState.score += 25;
                    }
                    
                    if (gameState.guardInfoBought) {
                        addToOutput("Bonus: The guard's secret about the hidden passage will be valuable!", "success-text");
                        gameState.score += 50;
                    }
                    
                    updateStatus();
                    
                    // Show courtyard description
                    setTimeout(() => {
                        addToOutput("You are in the castle courtyard. The air is cold and damp with a thick mist clinging to the ground. To the north, the main castle doors stand imposing and locked. To your left, a shady-looking merchant has set up a makeshift stall. To your right, a hooded skeleton figure leans against the wall, watching you intently.");
                    }, 500);
                } else {
                    addToOutput("The gate is locked. You need to find a way to open it first.");
                }
            } else if (gameState.currentLocation === "castleCourtyard") {
                showActionPanel("MOVE WHERE?", [
                    {text: "APPROACH CASTLE DOORS", value: "castle_doors"},
                    {text: "GO TO MERCHANT'S STALL", value: "merchant"},
                    {text: "APPROACH HOODED SKELETON", value: "skeleton"},
                    {text: "RETURN TO CASTLE GATES", value: "gates"}
                ], handleMoveChoice);
            }
        }
        
        // Handle move choice in courtyard
        function handleMoveChoice(choice) {
            switch(choice) {
                case "castle_doors":
                    addToOutput("You approach the massive castle doors. They're sealed with a magical barrier that shimmers faintly.");
                    if (gameState.inventory.includes("skeleton key")) {
                        addToOutput("Your skeleton key glows in proximity to the doors.", "important-text");
                    }
                    break;
                    
                case "merchant":
                    addToOutput("You walk over to the merchant's stall. He gives you a sly smile.", "merchant-text");
                    break;
                    
                case "skeleton":
                    addToOutput("The hooded skeleton watches you approach but says nothing.", "skeleton-text");
                    break;
                    
                case "gates":
                    addToOutput("You return to the castle gates. The skeletal guard is still there.", "important-text");
                    gameState.currentLocation = "castleGates";
                    updateStatus();
                    break;
            }
        }
        
        // Examine command
        function handleExamine() {
            if (gameState.currentLocation === "castleGates") {
                showActionPanel("EXAMINE WHAT?", [
                    {text: "LANTERN", value: "lantern"},
                    {text: "SKELETAL GUARD", value: "guard"},
                    {text: "STONE PLAQUE", value: "plaque"},
                    {text: "GATE", value: "gate"},
                    {text: "GUARD'S POSSESSIONS", value: "guard_stuff"}
                ], handleExamineChoice);
            } else if (gameState.currentLocation === "castleCourtyard") {
                showActionPanel("EXAMINE WHAT?", [
                    {text: "MERCHANT'S STALL", value: "merchant_stall"},
                    {text: "HOODED SKELETON", value: "hooded_skeleton"},
                    {text: "CASTLE DOORS", value: "castle_doors"},
                    {text: "BROKEN STATUES", value: "statues"},
                    {text: "COURTYARD GROUND", value: "ground"}
                ], handleCourtyardExamineChoice);
            }
        }
        
        // Handle examine choice for courtyard
        function handleCourtyardExamineChoice(choice) {
            switch(choice) {
                case "merchant_stall":
                    addToOutput("The merchant's stall is makeshift but well-stocked. You see various bottles, trinkets, and mysterious items. Some look genuine, others look like cheap imitations.");
                    if (gameState.merchantScammed) {
                        addToOutput("You notice the 'lucky charms' he sells are identical to cheap trinkets you saw at the castle gates.", "danger-text");
                    }
                    break;
                    
                case "hooded_skeleton":
                    addToOutput("The hooded skeleton wears tattered robes that might have once been fine clothing. Under the hood, you can see the glint of bone. He seems melancholy rather than threatening.");
                    break;
                    
                case "castle_doors":
                    addToOutput("The castle doors are made of dark oak reinforced with iron bands. Strange runes are carved around the edges, glowing with a faint blue light. A keyhole shaped like a skull is at the center.");
                    break;
                    
                case "statues":
                    addToOutput("The broken statues depict knights and nobles from the castle's past. One statue's hand points toward the merchant's stall. Another seems to be pointing at a particular patch of ground in the courtyard.");
                    break;
                    
                case "ground":
                    addToOutput("The courtyard ground is uneven with cracked flagstones. Weeds grow between the stones. In one area, the ground looks recently disturbed.");
                    break;
            }
        }
        
        // Handle examine choice for gates
        function handleExamineChoice(choice) {
            switch(choice) {
                case "lantern":
                    addToOutput("The lantern flickers with a faint blue flame. Inside, you notice a small rolled-up piece of parchment.");
                    if (!gameState.hasNote) {
                        addToOutput("There appears to be something inside the lantern.", "important-text");
                    }
                    break;
                    
                case "guard":
                    addToOutput("The skeletal guard appears long dead, yet its hollow eye sockets seem to follow your movements. It wears tattered remnants of a guard uniform and carries a rusty sword at its side.");
                    if (gameState.guardBribed || gameState.guardHelpful) {
                        addToOutput("The guard seems more receptive to conversation now.");
                    }
                    break;
                    
                case "plaque":
                    addToOutput("The stone plaque is covered in moss. You wipe it clean to reveal an inscription: 'Only those who know the number of the night may enter.' Below is a numeric keypad with buttons 0-9.");
                    if (gameState.hasNote) {
                        addToOutput("You recall the note from the lantern mentions: 'The number you seek is the year the castle fell: 1492'", "important-text");
                        gameState.codeKnown = true;
                    }
                    break;
                    
                case "gate":
                    addToOutput("The iron gates are thick and formidable. A heavy chain with a large padlock secures them shut. The lock has a 4-digit keypad.");
                    if (gameState.codeKnown) {
                        addToOutput("You know the code is 1492.", "important-text");
                    }
                    break;
                    
                case "guard_stuff":
                    addToOutput("You notice the guard has a small pouch at its belt. It also carries a rusty but serviceable sword.");
                    if (gameState.gold > 0 && !gameState.guardHostile) {
                        addToOutput("Perhaps the guard would be willing to trade...", "npc-text");
                    }
                    break;
            }
        }
        
        // Help command
        function handleHelp() {
            addToOutput("AVAILABLE COMMANDS:", "important-text");
            addToOutput("LOOK - Describe your surroundings");
            addToOutput("INTERACT - Interact with objects in the environment");
            addToOutput("INVENTORY - View your inventory");
            addToOutput("TALK - Speak with characters (important for progression)");
            addToOutput("USE ITEM - Use an item from your inventory");
            addToOutput("MOVE - Move to a new location");
            addToOutput("EXAMINE - Closely examine an object");
            addToOutput("HELP - Show this help message");
            addToOutput("", "important-text");
            addToOutput("GAME FEATURES:", "success-text");
            addToOutput(" Auto-scroll keeps text visible when new messages appear");
            addToOutput(" Multiple NPCs with unique dialogues and agendas");
            addToOutput(" Inventory system with usable items");
            addToOutput(" Gold economy for trading and bargaining");
            addToOutput(" Multiple levels with different challenges");
            addToOutput(" Progress is automatically saved between levels", "important-text");
        }
        
        // Initialize the game
        initGame();
    </script>
</body>
</html>
