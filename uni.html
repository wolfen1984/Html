<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal Monsters: Nightmare Collection</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #0a080a;
            color: #8b0000;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(139, 0, 0, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(47, 79, 79, 0.1) 0%, transparent 20%),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 1px,
                    rgba(0, 0, 0, 0.1) 1px,
                    rgba(0, 0, 0, 0.1) 2px
                );
        }
        
        #game-container {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            max-height: 900px;
            position: relative;
            border: 4px solid #8b0000;
            box-shadow: 
                0 0 20px rgba(139, 0, 0, 0.7),
                inset 0 0 20px rgba(139, 0, 0, 0.3);
            overflow: hidden;
            background-color: #110a11;
        }
        
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            padding: 15px;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .active {
            display: flex;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px dashed #8b0000;
        }
        
        .title {
            font-size: 22px;
            color: #dc143c;
            text-shadow: 0 0 10px #8b0000;
            margin-bottom: 5px;
            letter-spacing: 1px;
        }
        
        .subtitle {
            font-size: 12px;
            color: #dda0dd;
            margin-bottom: 10px;
        }
        
        .player-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(47, 79, 79, 0.7);
            border: 2px solid #2f4f4f;
            border-radius: 4px;
            font-size: 10px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            color: #ff6347;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 15px;
            background-color: rgba(25, 25, 35, 0.8);
            border: 2px solid #8b0000;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.6;
        }
        
        /* Scrollbar styling */
        .content-area::-webkit-scrollbar {
            width: 8px;
        }
        
        .content-area::-webkit-scrollbar-track {
            background: rgba(47, 79, 79, 0.5);
        }
        
        .content-area::-webkit-scrollbar-thumb {
            background: #8b0000;
            border-radius: 4px;
        }
        
        .buttons-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .button {
            background-color: #2f0000;
            color: #ff6347;
            border: 2px solid #8b0000;
            border-radius: 4px;
            padding: 12px 5px;
            font-family: 'Press Start 2P', cursive;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.1s;
            text-align: center;
            text-shadow: 0 0 5px #8b0000;
        }
        
        .button:active {
            background-color: #8b0000;
            color: #ffffff;
            transform: scale(0.98);
        }
        
        .button-primary {
            background-color: #4b0082;
            border-color: #9400d3;
            color: #dda0dd;
            text-shadow: 0 0 5px #9400d3;
        }
        
        .button-primary:active {
            background-color: #9400d3;
        }
        
        .button-danger {
            background-color: #330000;
            border-color: #dc143c;
            color: #ff6347;
            text-shadow: 0 0 5px #dc143c;
        }
        
        .button-danger:active {
            background-color: #880000;
        }
        
        .button-success {
            background-color: #003300;
            border-color: #228b22;
            color: #90ee90;
            text-shadow: 0 0 5px #228b22;
        }
        
        .button-success:active {
            background-color: #008800;
        }
        
        .location-info {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(47, 79, 79, 0.5);
            border: 1px solid #5f9ea0;
            border-radius: 4px;
        }
        
        .area-description {
            font-size: 11px;
            color: #b0c4de;
            margin-top: 5px;
            line-height: 1.5;
        }
        
        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            background-color: rgba(47, 79, 79, 0.7);
            border: 1px solid #5f9ea0;
            border-radius: 4px;
        }
        
        .item-name {
            color: #ffd700;
        }
        
        .item-count {
            color: #ff6347;
            font-size: 14px;
        }
        
        .crafting-recipe {
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(75, 0, 130, 0.7);
            border: 1px solid #9400d3;
            border-radius: 4px;
        }
        
        .recipe-title {
            color: #dda0dd;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .recipe-stats {
            color: #ffff88;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .recipe-materials {
            font-size: 10px;
            color: #90ee90;
            margin-bottom: 10px;
        }
        
        /* Player display in combat */
        .player-display {
            text-align: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(0, 40, 0, 0.7);
            border: 2px solid #228b22;
            border-radius: 4px;
        }
        
        .player-name {
            color: #90ee90;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .player-combat-stats {
            display: flex;
            justify-content: space-around;
            font-size: 10px;
            margin-bottom: 5px;
        }
        
        .enemy-display {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: rgba(80, 0, 0, 0.7);
            border: 2px solid #dc143c;
            border-radius: 4px;
        }
        
        .enemy-name {
            color: #ff6347;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .enemy-stats {
            display: flex;
            justify-content: space-around;
            font-size: 11px;
            margin-bottom: 10px;
        }
        
        .combat-log {
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 15px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 1px solid #ffd700;
            border-radius: 4px;
            font-size: 11px;
            display: flex;
            flex-direction: column;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px dotted rgba(255, 215, 0, 0.3);
        }
        
        .player-log {
            color: #90ee90;
        }
        
        .enemy-log {
            color: #ff6347;
        }
        
        .event-log {
            color: #b0c4de;
        }
        
        .critical-log {
            color: #dc143c;
            text-shadow: 0 0 5px #dc143c;
            animation: criticalFlash 0.3s;
        }
        
        .holy-log {
            color: #ffd700;
            text-shadow: 0 0 5px #ffd700;
        }
        
        @keyframes criticalFlash {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .game-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(25, 25, 35, 0.95);
            border: 3px solid #8b0000;
            padding: 20px;
            border-radius: 8px;
            z-index: 100;
            text-align: center;
            max-width: 90%;
            display: none;
        }
        
        .message-text {
            font-size: 14px;
            margin-bottom: 15px;
            color: #ff6347;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .nav-button {
            width: 32%;
            padding: 10px 5px;
            font-size: 10px;
        }
        
        .hp-bar-container, .sanity-bar-container, .time-bar-container {
            width: 100%;
            height: 10px;
            background-color: #220000;
            border: 1px solid #8b0000;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .hp-bar, .sanity-bar, .time-bar {
            height: 100%;
            transition: width 0.5s;
        }
        
        .hp-bar {
            background-color: #dc143c;
        }
        
        .sanity-bar {
            background-color: #4b0082;
        }
        
        .time-bar {
            background-color: #2f4f4f;
        }
        
        /* Combat HP bars */
        .combat-hp-bar-container {
            width: 100%;
            height: 8px;
            background-color: #220000;
            border: 1px solid #dc143c;
            border-radius: 2px;
            margin-top: 3px;
            overflow: hidden;
        }
        
        .combat-hp-bar {
            height: 100%;
            background-color: #dc143c;
            transition: width 0.3s;
        }
        
        .combat-player-hp-bar-container {
            width: 100%;
            height: 8px;
            background-color: #002200;
            border: 1px solid #228b22;
            border-radius: 2px;
            margin-top: 3px;
            overflow: hidden;
        }
        
        .combat-player-hp-bar {
            height: 100%;
            background-color: #228b22;
            transition: width 0.3s;
        }
        
        .game-area-image {
            text-align: center;
            margin: 15px 0;
            font-size: 40px;
        }
        
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #2f0000;
            border: 2px solid #8b0000;
            color: #ff6347;
            font-size: 16px;
            cursor: pointer;
            z-index: 10;
        }
        
        .category-tabs {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            border-bottom: 2px solid #9400d3;
        }
        
        .category-tab {
            flex: 1;
            padding: 8px;
            text-align: center;
            background-color: rgba(75, 0, 130, 0.5);
            border: none;
            border-bottom: 2px solid transparent;
            color: #dda0dd;
            font-family: 'Press Start 2P', cursive;
            font-size: 9px;
            cursor: pointer;
        }
        
        .category-tab.active {
            background-color: rgba(75, 0, 130, 0.8);
            border-bottom: 2px solid #9400d3;
            color: #e6e6fa;
        }
        
        .skill-points-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #4b0082;
            border: 2px solid #9400d3;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #dda0dd;
            font-size: 12px;
            z-index: 10;
            display: none;
        }
        
        .skill-button {
            margin: 5px 0;
            padding: 8px;
            font-size: 10px;
            background-color: #004400;
            border: 2px solid #00aa00;
            color: #88ff88;
        }
        
        .skill-button.unlocked {
            background-color: #006600;
            border-color: #00ff00;
            color: #ffffff;
        }
        
        .skill-button.locked {
            background-color: #442200;
            border-color: #885500;
            color: #888888;
        }
        
        .save-slot {
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(47, 79, 79, 0.7);
            border: 2px solid #5f9ea0;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .save-slot:hover {
            background-color: rgba(47, 79, 79, 0.9);
        }
        
        .save-info {
            color: #b0c4de;
            font-size: 10px;
        }
        
        .save-level {
            color: #ffd700;
            font-size: 12px;
        }
        
        /* Skill tree styling */
        .skill-tree {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .skill-node {
            padding: 10px;
            background-color: rgba(47, 79, 79, 0.7);
            border: 2px solid #5f9ea0;
            border-radius: 4px;
            text-align: center;
        }
        
        .skill-node.unlocked {
            background-color: rgba(75, 0, 130, 0.9);
            border-color: #9400d3;
            box-shadow: 0 0 10px rgba(148, 0, 211, 0.5);
        }
        
        .skill-node.locked {
            background-color: rgba(40, 40, 40, 0.7);
            border-color: #555555;
            color: #888888;
        }
        
        .skill-node.maxed {
            background-color: rgba(139, 0, 0, 0.9);
            border-color: #dc143c;
            box-shadow: 0 0 10px rgba(220, 20, 60, 0.5);
        }
        
        .skill-cost {
            color: #ffd700;
            font-size: 10px;
            margin-top: 5px;
        }
        
        .skill-level {
            color: #b0c4de;
            font-size: 9px;
            margin-top: 3px;
        }
        
        /* Monster weakness indicators */
        .weakness-indicator {
            display: inline-block;
            margin: 2px;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 8px;
        }
        
        .weakness-holy { background-color: #4b0082; color: #dda0dd; }
        .weakness-silver { background-color: #c0c0c0; color: #000000; }
        .weakness-fire { background-color: #dc143c; color: #ffffff; }
        .weakness-wood { background-color: #8b4513; color: #ffffff; }
        
        @media (max-width: 500px) {
            .title {
                font-size: 18px;
            }
            
            .button {
                font-size: 9px;
                padding: 10px 5px;
            }
            
            .content-area {
                font-size: 10px;
            }
            
            .recipe-title {
                font-size: 12px;
            }
            
            .category-tab {
                font-size: 8px;
                padding: 6px 2px;
            }
            
            .skill-tree {
                grid-template-columns: 1fr;
            }
        }
        
        /* Animation for critical hits */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .critical-hit {
            animation: shake 0.3s;
        }
        
        /* Damage numbers */
        .damage-number {
            position: absolute;
            color: #dc143c;
            font-weight: bold;
            font-size: 14px;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 0 0 3px #000000;
        }
        
        .heal-number {
            color: #90ee90;
        }
        
        .holy-number {
            color: #ffd700;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }
        
        /* Time of day indicator */
        .time-indicator {
            position: absolute;
            top: 10px;
            right: 50px;
            background-color: rgba(47, 79, 79, 0.7);
            border: 2px solid #2f4f4f;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 10px;
            color: #b0c4de;
            z-index: 10;
        }
        
        /* Sanity warning */
        .sanity-low {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Exit combat button - NEW */
        .exit-combat-button {
            display: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Sound toggle button -->
        <button class="sound-toggle" id="sound-toggle">üîä</button>
        
        <!-- Time indicator -->
        <div class="time-indicator" id="time-indicator">üåô NIGHT</div>
        
        <!-- Skill points indicator -->
        <div class="skill-points-indicator" id="skill-points-indicator">0</div>
        
        <!-- Main Menu Screen -->
        <div id="main-menu" class="screen active">
            <div class="header">
                <h1 class="title">UNIVERSAL MONSTERS</h1>
                <div class="subtitle">NIGHTMARE COLLECTION</div>
                <div class="subtitle">A RETRO HORROR SURVIVAL</div>
            </div>
            
            <div class="content-area" style="justify-content: center; align-items: center; display: flex; flex-direction: column;">
                <div class="game-area-image">
                    üßõ‚Äç‚ôÇÔ∏èüê∫‚ö∞Ô∏èüßü‚Äç‚ôÇÔ∏è
                </div>
                <div style="text-align: center; margin-bottom: 30px;">
                    <p>1931-1954</p>
                    <p>The monsters are real.</p>
                    <p>Classic horrors awaken.</p>
                    <p>Survive the night...</p>
                </div>
                <div style="color: #ff6347; font-size: 10px; text-align: center;">
                    <p>FEATURING:</p>
                    <p>DRACULA ‚Ä¢ WOLFMAN ‚Ä¢ FRANKENSTEIN</p>
                    <p>THE MUMMY ‚Ä¢ CREATURE ‚Ä¢ PHANTOM</p>
                </div>
            </div>
            
            <div class="buttons-container">
                <button class="button button-primary" onclick="startGame()">NEW HUNT</button>
                <button class="button" onclick="showScreen('save-screen')">CONTINUE</button>
            </div>
            
            <div class="navigation">
                <button class="button nav-button" onclick="showScreen('skills-screen')">HUNTER TRAINING</button>
                <button class="button nav-button" onclick="showScreen('instructions')">INSTRUCTIONS</button>
                <button class="button nav-button" onclick="showScreen('credits')">CREDITS</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="header">
                <h2 class="title">MONSTER HUNTER'S LODGE</h2>
                <div class="player-stats">
                    <div class="stat">
                        <div>LEVEL</div>
                        <div id="player-level" class="stat-value">1</div>
                    </div>
                    <div class="stat">
                        <div>HEALTH</div>
                        <div id="player-hp" class="stat-value">50/50</div>
                    </div>
                    <div class="stat">
                        <div>SANITY</div>
                        <div id="player-sanity" class="stat-value">100/100</div>
                    </div>
                    <div class="stat">
                        <div>TIME</div>
                        <div id="current-time" class="stat-value">üåô NIGHT</div>
                    </div>
                </div>
                
                <div class="location-info">
                    <div id="location-name">Van Helsing's Study</div>
                    <div id="location-description" class="area-description">Candlelit room filled with ancient tomes and monster hunting gear. The grandfather clock ticks ominously.</div>
                </div>
            </div>
            
            <div class="content-area" id="game-content">
                <p>Welcome, Monster Hunter. The classic horrors have awakened.</p>
                <p>Use the buttons below to prepare for your hunts.</p>
                <p id="time-warning" style="color: #ff6347; display: none;">‚ö†Ô∏è NIGHTFALL APPROACHES - Monsters grow stronger! ‚ö†Ô∏è</p>
            </div>
            
            <div class="buttons-container">
                <button class="button" onclick="goToGathering()">SCOUT AREA</button>
                <button class="button" onclick="goToCrafting()">PREPARE GEAR</button>
                <button class="button" onclick="goToCombat()">HUNT MONSTER</button>
                <button class="button" onclick="showScreen('skills-screen')">TRAINING</button>
            </div>
            
            <div class="navigation">
                <button class="button nav-button" onclick="saveGameToSlot(1)">SAVE PROGRESS</button>
                <button class="button nav-button" onclick="changeArea('transylvania')">TRANSYLVANIA</button>
                <button class="button nav-button" onclick="changeArea('london')">LONDON</button>
                <button class="button nav-button" onclick="changeArea('egypt')">EGYPT</button>
            </div>
        </div>
        
        <!-- Gathering Screen -->
        <div id="gathering-screen" class="screen">
            <div class="header">
                <h2 class="title">SCOUTING AREA</h2>
                <div class="subtitle" id="gather-area">Searching for resources...</div>
            </div>
            
            <div class="content-area" id="gather-content">
                <p>Search the area for resources and clues.</p>
                <p>Different monsters require different tools to defeat.</p>
                <div id="gather-results"></div>
            </div>
            
            <div class="buttons-container">
                <button class="button button-primary" onclick="gatherMaterials()">SEARCH AREA</button>
                <button class="button" onclick="showScreen('game-screen')">RETURN</button>
            </div>
            
            <div class="navigation">
                <button class="button nav-button" onclick="changeGatherArea('transylvania')">CASTLE</button>
                <button class="button nav-button" onclick="changeGatherArea('london')">MOORS</button>
                <button class="button nav-button" onclick="changeGatherArea('egypt')">TOMB</button>
                <button class="button nav-button" onclick="changeGatherArea('lab')">LAB</button>
                <button class="button nav-button" onclick="changeGatherArea('lagoon')">LAGOON</button>
            </div>
        </div>
        
        <!-- Crafting Screen -->
        <div id="crafting-screen" class="screen">
            <div class="header">
                <h2 class="title">MONSTER HUNTING GEAR</h2>
                <div class="subtitle">Prepare tools for specific monsters</div>
            </div>
            
            <div class="category-tabs">
                <button class="category-tab active" onclick="showCraftingCategory('holy')">HOLY ITEMS</button>
                <button class="category-tab" onclick="showCraftingCategory('silver')">SILVER WEAPONS</button>
                <button class="category-tab" onclick="showCraftingCategory('medical')">MEDICAL</button>
                <button class="category-tab" onclick="showCraftingCategory('traps')">TRAPS</button>
            </div>
            
            <div class="content-area" id="crafting-content">
                <p>Different monsters require different weaknesses exploited.</p>
                <div id="crafting-recipes"></div>
            </div>
            
            <div class="buttons-container">
                <button class="button" onclick="showScreen('game-screen')">RETURN</button>
            </div>
        </div>
        
        <!-- Combat Screen -->
        <div id="combat-screen" class="screen">
            <div class="header">
                <h2 class="title">MONSTER CONFRONTATION</h2>
                <div class="subtitle" id="combat-area">Face the Horror!</div>
            </div>
            
            <div class="content-area">
                <!-- Player display -->
                <div class="player-display">
                    <div class="player-name" id="player-combat-name">VAN HELSING</div>
                    <div class="player-combat-stats">
                        <div>HP: <span id="player-combat-hp">50</span>/<span id="player-combat-max-hp">50</span></div>
                        <div>SANITY: <span id="player-combat-sanity">100</span></div>
                        <div>ATK: <span id="player-combat-atk">5</span></div>
                        <div>DEF: <span id="player-combat-def">2</span></div>
                    </div>
                    <div class="combat-player-hp-bar-container">
                        <div id="player-combat-hp-bar" class="combat-player-hp-bar" style="width: 100%"></div>
                    </div>
                </div>
                
                <div class="enemy-display">
                    <div class="enemy-name" id="enemy-name">FOREST CREATURE</div>
                    <div class="enemy-stats">
                        <div>HP: <span id="enemy-hp">30</span>/<span id="enemy-max-hp">30</span></div>
                        <div>THREAT: <span id="enemy-threat">MEDIUM</span></div>
                        <div>WEAK TO: <span id="enemy-weakness">SILVER</span></div>
                    </div>
                    <div class="combat-hp-bar-container">
                        <div id="enemy-hp-bar" class="combat-hp-bar" style="width: 100%"></div>
                    </div>
                    <div id="enemy-image" class="game-area-image">üëπ</div>
                    <div id="enemy-special" style="font-size: 10px; color: #ff6347;"></div>
                </div>
                
                <div class="combat-log" id="combat-log">
                    <div class="log-entry event-log">You face a monster from the Universal archives!</div>
                </div>
            </div>
            
            <div class="buttons-container">
                <button class="button button-danger" onclick="playerAttack()">ATTACK</button>
                <button class="button" onclick="useHolyItem()">USE HOLY ITEM</button>
                <button class="button" onclick="useSpecialWeapon()">SPECIAL WEAPON</button>
                <!-- Exit Combat Button - appears when combat ends -->
                <button class="button button-success exit-combat-button" id="exit-combat-btn" onclick="exitCombat()">RETURN TO LODGE</button>
            </div>
            
            <div class="navigation">
                <button class="button nav-button" onclick="attemptEscape()">RETREAT</button>
                <button class="button nav-button" onclick="useMedkit()">USE MEDKIT</button>
                <button class="button nav-button" onclick="useSanityPotion()">CALM NERVES</button>
            </div>
        </div>
        
        <!-- Skills Screen -->
        <div id="skills-screen" class="screen">
            <div class="header">
                <h2 class="title">HUNTER'S TRAINING</h2>
                <div class="subtitle">Master monster hunting techniques</div>
            </div>
            
            <div class="content-area" id="skills-content">
                <div style="text-align: center; margin-bottom: 10px;">
                    <p>Spend experience to learn monster hunting techniques.</p>
                    <p id="skill-points-display">Training Points: <span id="available-skill-points" style="color: #ffd700;">0</span></p>
                </div>
                <div class="skill-tree" id="skill-tree"></div>
            </div>
            
            <div class="buttons-container">
                <button class="button button-success" onclick="resetSkills()" id="reset-skills-btn">RETAINER (Cost: 100 gold)</button>
                <button class="button" onclick="showScreen('game-screen')">RETURN</button>
            </div>
        </div>
        
        <!-- Save/Load Screen -->
        <div id="save-screen" class="screen">
            <div class="header">
                <h2 class="title">HUNTER'S JOURNAL</h2>
                <div class="subtitle">Save your progress</div>
            </div>
            
            <div class="content-area" id="save-content">
                <p>Record your hunts in the journal.</p>
                <div id="save-slots"></div>
            </div>
            
            <div class="buttons-container">
                <button class="button button-primary" onclick="showScreen('main-menu')">RETURN</button>
                <button class="button" onclick="deleteAllSaves()">BURN JOURNALS</button>
            </div>
        </div>
        
        <!-- Instructions Screen -->
        <div id="instructions" class="screen">
            <div class="header">
                <h2 class="title">HOW TO SURVIVE</h2>
            </div>
            
            <div class="content-area">
                <p><strong>UNIVERSAL MONSTERS</strong></p>
                <p><strong>MONSTER WEAKNESSES:</strong></p>
                <p>üßõ‚Äç‚ôÇÔ∏è <strong>DRACULA:</strong> Holy items, sunlight, wooden stakes</p>
                <p>üê∫ <strong>WOLFMAN:</strong> Silver weapons, wolfsbane</p>
                <p>üßü‚Äç‚ôÇÔ∏è <strong>FRANKENSTEIN:</strong> Fire, electricity (weakness)</p>
                <p>‚ö∞Ô∏è <strong>THE MUMMY:</strong> Fire, ancient spells</p>
                <p>üêü <strong>CREATURE:</strong> Electricity, depth charges</p>
                <p>üé≠ <strong>PHANTOM:</strong> Light, unmasking</p>
                
                <p><strong>STATS:</strong></p>
                <p>HEALTH: Your physical condition</p>
                <p>SANITY: Mental fortitude (drains when facing horrors)</p>
                <p>TIME: Monsters grow stronger at night!</p>
                
                <p><strong>GATHER:</strong> Collect resources in monster territories</p>
                <p><strong>CRAFT:</strong> Create specific weapons for each monster</p>
                <p><strong>HUNT:</strong> Face the monsters directly</p>
                <p><strong>TRAIN:</strong> Improve your hunting skills</p>
                
                <p style="margin-top: 15px; color: #dc143c;">SANITY LOW: Hallucinations may occur!</p>
                <p style="color: #ffd700;">NIGHTTIME: All monsters become more dangerous!</p>
                <p style="color: #90ee90;">CORRECT WEAKNESS: Deal double damage!</p>
            </div>
            
            <div class="buttons-container">
                <button class="button button-primary" onclick="showScreen('main-menu')">RETURN</button>
            </div>
        </div>
        
        <!-- Credits Screen -->
        <div id="credits" class="screen">
            <div class="header">
                <h2 class="title">CREDITS</h2>
            </div>
            
            <div class="content-area">
                <p><strong>UNIVERSAL MONSTERS</strong></p>
                <p>NIGHTMARE COLLECTION</p>
                <p>A tribute to classic horror cinema</p>
                <p>1931-1954</p>
                
                <p style="margin-top: 20px; color: #ffd700;">MONSTERS FEATURED:</p>
                <p>‚Ä¢ Dracula (1931)</p>
                <p>‚Ä¢ Frankenstein (1931)</p>
                <p>‚Ä¢ The Mummy (1932)</p>
                <p>‚Ä¢ The Invisible Man (1933)</p>
                <p>‚Ä¢ The Wolf Man (1941)</p>
                <p>‚Ä¢ The Phantom of the Opera (1943)</p>
                <p>‚Ä¢ Creature from the Black Lagoon (1954)</p>
                
                <p style="margin-top: 20px; color: #dda0dd;">GAME DESIGN:</p>
                <p>Retro Horror Survival System</p>
                <p>Classic Monster Weaknesses</p>
                <p>Time & Sanity Mechanics</p>
                <p>Universal Studios Inspired</p>
                
                <p style="margin-top: 20px; color: #b0c4de;">¬© 2023 CLASSIC HORROR STUDIOS</p>
                <p style="font-size: 10px;">This is a fan tribute. Universal Monsters‚Ñ¢ is a trademark of Universal Studios.</p>
            </div>
            
            <div class="buttons-container">
                <button class="button button-primary" onclick="showScreen('main-menu')">RETURN</button>
            </div>
        </div>
        
        <!-- Game Message Modal -->
        <div id="game-message" class="game-message">
            <div class="message-text" id="message-text">Message goes here</div>
            <button class="button" onclick="hideMessage()">UNDERSTOOD</button>
        </div>
    </div>

    <script>
        // Universal Monsters Survival Horror Game State
        const gameState = {
            player: {
                name: "Van Helsing",
                level: 1,
                xp: 0,
                xpToNextLevel: 100,
                hp: 50,
                maxHp: 50,
                sanity: 100,
                maxSanity: 100,
                attack: 5,
                defense: 2,
                gold: 100,
                skillPoints: 0,
                criticalChance: 5,
                criticalMultiplier: 1.5,
                weapon: { name: "Hunting Knife", damage: "3-5", type: "basic", weakness: "none" },
                armor: { name: "Leather Coat", defense: 2, type: "armor" },
                medkits: 3,
                sanityPotions: 2,
                currentTime: "night", // day, dusk, night, midnight
                timeCounter: 0,
                monstersDefeated: {
                    dracula: false,
                    wolfman: false,
                    frankenstein: false,
                    mummy: false,
                    creature: false,
                    phantom: false
                }
            },
            skills: {
                vampireHunter: { level: 0, maxLevel: 3, description: "+25% damage vs Vampires", cost: 2 },
                werewolfExpert: { level: 0, maxLevel: 3, description: "+25% damage vs Werewolves", cost: 2 },
                occultScholar: { level: 0, maxLevel: 5, description: "+10 max Sanity per level", cost: 1 },
                silverSmith: { level: 0, maxLevel: 3, description: "Silver weapons deal +2 damage", cost: 2 },
                holyWarrior: { level: 0, maxLevel: 3, description: "Holy items last +1 turn", cost: 2 },
                quickReflexes: { level: 0, maxLevel: 3, description: "+10% dodge chance per level", cost: 2 },
                sturdyConstitution: { level: 0, maxLevel: 5, description: "+10 max HP per level", cost: 1 },
                monsterAnatomist: { level: 0, maxLevel: 3, description: "+5% critical chance vs monsters", cost: 2 },
                fieldMedic: { level: 0, maxLevel: 3, description: "Medkits heal +25% more", cost: 2 },
                nightVision: { level: 0, maxLevel: 3, description: "-25% night penalty per level", cost: 2 },
                trapExpert: { level: 0, maxLevel: 3, description: "Traps deal +50% more damage", cost: 2 },
                fearless: { level: 0, maxLevel: 3, description: "Sanity drains 25% slower", cost: 2 }
            },
            inventory: {
                // Basic resources
                herbs: 0,
                wood: 0,
                silverOre: 0,
                holyWater: 0,
                garlic: 0,
                wolfsbane: 0,
                
                // Monster-specific items
                vampireDust: 0,
                werewolfFur: 0,
                frankensteinParts: 0,
                mummyBandages: 0,
                creatureScales: 0,
                phantomMask: 0,
                
                // Special items
                ancientScrolls: 0,
                medicalSupplies: 0,
                electricalParts: 0,
                gunpowder: 0
            },
            currentArea: "transylvania",
            combatActive: false,
            enemy: null,
            craftingCategory: "holy",
            gameTime: 0,
            stats: {
                monstersDefeated: 0,
                resourcesGathered: 0,
                itemsCrafted: 0,
                goldEarned: 0,
                damageDealt: 0,
                damageTaken: 0,
                sanityLost: 0,
                nightsSurvived: 0
            },
            // New: Time system
            timeOfDay: {
                day: { name: "‚òÄÔ∏è DAY", monsterBonus: 0.5, description: "Monsters are weaker during daylight" },
                dusk: { name: "üåÜ DUSK", monsterBonus: 0.8, description: "Monsters begin to awaken" },
                night: { name: "üåô NIGHT", monsterBonus: 1.2, description: "Monsters are at full strength" },
                midnight: { name: "‚è∞ MIDNIGHT", monsterBonus: 1.5, description: "Witching hour - extreme danger!" }
            }
        };

        // Save System
        const SAVE_SLOTS = 5;
        const SAVE_KEY_PREFIX = "universal_monsters_save_";
        
        // Universal Monsters Game Data
        const gameData = {
            areas: {
                transylvania: {
                    name: "Castle Dracula",
                    description: "A foreboding castle perched on a Carpathian mountain. Bats flutter in the moonlit sky.",
                    materials: ["herbs", "wood", "garlic", "silverOre", "vampireDust"],
                    enemies: ["Vampire Spawn", "Vampire Bride", "Renfield", "Count Dracula"],
                    enemyStats: {
                        "Vampire Spawn": { 
                            hp: 30, maxHp: 30, attack: "4-7", xp: 25, gold: "10-20",
                            special: "blood_drain", weakTo: ["holy", "wood"], resistance: "piercing",
                            description: "A newly turned vampire. Hungry for blood."
                        },
                        "Vampire Bride": { 
                            hp: 40, maxHp: 40, attack: "5-9", xp: 35, gold: "15-30",
                            special: "charm", weakTo: ["holy", "wood"], resistance: "slashing",
                            description: "One of Dracula's eternal brides."
                        },
                        "Renfield": { 
                            hp: 20, maxHp: 20, attack: "2-4", xp: 15, gold: "5-15",
                            special: "summon_bats", weakTo: ["holy"], resistance: "none",
                            description: "Dracula's insane servant."
                        },
                        "Count Dracula": {
                            hp: 100, maxHp: 100, attack: "10-18", xp: 200, gold: "100-200",
                            special: "transform_bat", weakTo: ["holy", "wood", "sunlight"], resistance: "all",
                            description: "The Lord of Vampires himself."
                        }
                    }
                },
                london: {
                    name: "London Moors",
                    description: "Foggy English moors under a full moon. Howls echo in the distance.",
                    materials: ["herbs", "wood", "wolfsbane", "silverOre", "werewolfFur"],
                    enemies: ["Wolf", "Werewolf", "Gypsy Werewolf", "The Wolf Man"],
                    enemyStats: {
                        "Wolf": { 
                            hp: 25, maxHp: 25, attack: "3-6", xp: 20, gold: "8-18",
                            special: "pack_attack", weakTo: ["silver"], resistance: "none",
                            description: "Natural wolf drawn by the werewolf's presence."
                        },
                        "Werewolf": { 
                            hp: 45, maxHp: 45, attack: "7-12", xp: 50, gold: "20-40",
                            special: "moonrage", weakTo: ["silver", "wolfsbane"], resistance: "physical",
                            description: "A man transformed by the curse."
                        },
                        "Gypsy Werewolf": { 
                            hp: 60, maxHp: 60, attack: "8-14", xp: 70, gold: "30-60",
                            special: "curse", weakTo: ["silver"], resistance: "magic",
                            description: "Ancient werewolf from gypsy folklore."
                        },
                        "The Wolf Man": {
                            hp: 80, maxHp: 80, attack: "10-16", xp: 150, gold: "80-150",
                            special: "regeneration", weakTo: ["silver"], resistance: "physical",
                            description: "Lawrence Talbot, cursed by the bite."
                        }
                    }
                },
                egypt: {
                    name: "Ancient Egyptian Tomb",
                    description: "Dusty catacombs filled with hieroglyphs and the scent of incense.",
                    materials: ["ancientScrolls", "mummyBandages", "herbs", "wood"],
                    enemies: ["Mummy Guard", "Scarab Swarm", "High Priest", "The Mummy"],
                    enemyStats: {
                        "Mummy Guard": { 
                            hp: 35, maxHp: 35, attack: "4-8", xp: 30, gold: "12-25",
                            special: "sandstorm", weakTo: ["fire"], resistance: "piercing",
                            description: "Animated guardian of the tomb."
                        },
                        "Scarab Swarm": { 
                            hp: 20, maxHp: 20, attack: "1-3", xp: 15, gold: "5-10",
                            special: "infest", weakTo: ["fire"], resistance: "slashing",
                            description: "Flesh-eating beetles awakened."
                        },
                        "High Priest": { 
                            hp: 50, maxHp: 50, attack: "6-10", xp: 60, gold: "25-50",
                            special: "curse", weakTo: ["holy"], resistance: "magic",
                            description: "Ancient priest wielding dark magic."
                        },
                        "The Mummy": {
                            hp: 90, maxHp: 90, attack: "9-15", xp: 180, gold: "90-180",
                            special: "ressurect", weakTo: ["fire"], resistance: "physical",
                            description: "Imhotep, awakened from eternal sleep."
                        }
                    }
                },
                lab: {
                    name: "Frankenstein's Laboratory",
                    description: "A castle laboratory filled with electrical equipment and body parts.",
                    materials: ["electricalParts", "medicalSupplies", "frankensteinParts", "gunpowder"],
                    enemies: ["Lab Assistant", "The Monster", "Igor", "Dr. Frankenstein"],
                    enemyStats: {
                        "Lab Assistant": { 
                            hp: 25, maxHp: 25, attack: "2-5", xp: 20, gold: "8-15",
                            special: "throw_chemical", weakTo: ["physical"], resistance: "none",
                            description: "Mad scientist's helper."
                        },
                        "The Monster": { 
                            hp: 70, maxHp: 70, attack: "8-14", xp: 80, gold: "40-80",
                            special: "lightning_charge", weakTo: ["fire"], resistance: "electric",
                            description: "The creature brought to life."
                        },
                        "Igor": { 
                            hp: 30, maxHp: 30, attack: "3-6", xp: 25, gold: "10-20",
                            special: "trip", weakTo: ["physical"], resistance: "none",
                            description: "The hunchbacked servant."
                        },
                        "Dr. Frankenstein": {
                            hp: 60, maxHp: 60, attack: "6-11", xp: 100, gold: "50-100",
                            special: "create_monster", weakTo: ["fire"], resistance: "electric",
                            description: "The mad scientist himself."
                        }
                    }
                },
                lagoon: {
                    name: "Black Lagoon",
                    description: "A murky, prehistoric lagoon deep in the Amazon. Something moves beneath the surface.",
                    materials: ["creatureScales", "herbs", "wood", "gunpowder"],
                    enemies: ["Giant Eel", "Creature Spawn", "The Gill-man", "The Creature"],
                    enemyStats: {
                        "Giant Eel": { 
                            hp: 30, maxHp: 30, attack: "4-7", xp: 25, gold: "10-20",
                            special: "constrict", weakTo: ["electric"], resistance: "water",
                            description: "Primordial predator of the lagoon."
                        },
                        "Creature Spawn": { 
                            hp: 40, maxHp: 40, attack: "5-9", xp: 35, gold: "15-30",
                            special: "ambush", weakTo: ["electric"], resistance: "water",
                            description: "Younger specimen of the species."
                        },
                        "The Gill-man": { 
                            hp: 65, maxHp: 65, attack: "7-13", xp: 70, gold: "35-70",
                            special: "dive_attack", weakTo: ["electric"], resistance: "water",
                            description: "The missing link between man and fish."
                        },
                        "The Creature": {
                            hp: 85, maxHp: 85, attack: "9-16", xp: 160, gold: "80-160",
                            special: "abyssal_rage", weakTo: ["electric", "fire"], resistance: "water",
                            description: "The last of its kind, protecting its home."
                        }
                    }
                }
            },
            craftingRecipes: {
                holy: [
                    { 
                        name: "Wooden Stake", 
                        materials: { wood: 2 },
                        result: { name: "Wooden Stake", damage: "8-12", type: "weapon", weakness: "vampire" },
                        description: "Classic vampire slaying tool. Effective against Dracula.",
                        tier: 1,
                        requiredLevel: 1
                    },
                    { 
                        name: "Holy Water Grenade", 
                        materials: { holyWater: 1, glass: 1 },
                        result: { name: "Holy Water Grenade", damage: "10-18", type: "consumable", weakness: "undead" },
                        description: "Shatters on impact, damaging undead creatures.",
                        tier: 2,
                        requiredLevel: 3
                    },
                    { 
                        name: "Silver Cross", 
                        materials: { silverOre: 2, wood: 1 },
                        result: { name: "Silver Cross", type: "tool", effect: "repels vampires" },
                        description: "Wards off vampire attacks. Reduces their accuracy.",
                        tier: 2,
                        requiredLevel: 3
                    },
                    { 
                        name: "Garlic Garland", 
                        materials: { garlic: 3, herbs: 1 },
                        result: { name: "Garlic Garland", type: "tool", effect: "area protection" },
                        description: "Creates a safe zone against vampires.",
                        tier: 1,
                        requiredLevel: 2
                    }
                ],
                silver: [
                    { 
                        name: "Silver Dagger", 
                        materials: { silverOre: 2, wood: 1 },
                        result: { name: "Silver Dagger", damage: "6-10", type: "weapon", weakness: "werewolf" },
                        description: "Essential for werewolf hunting.",
                        tier: 2,
                        requiredLevel: 2
                    },
                    { 
                        name: "Silver Bullets", 
                        materials: { silverOre: 1, gunpowder: 1 },
                        result: { name: "Silver Bullets", damage: "12-20", type: "consumable", weakness: "werewolf" },
                        description: "Six silver bullets. Use wisely.",
                        tier: 3,
                        requiredLevel: 5
                    },
                    { 
                        name: "Silver-coated Sword", 
                        materials: { silverOre: 3, wood: 2 },
                        result: { name: "Silver Sword", damage: "10-16", type: "weapon", weakness: "lycanthrope" },
                        description: "A sword coated in pure silver.",
                        tier: 3,
                        requiredLevel: 5
                    }
                ],
                medical: [
                    { 
                        name: "Medical Kit", 
                        materials: { medicalSupplies: 2, herbs: 1 },
                        result: { name: "Medical Kit", heal: 30, type: "medkit" },
                        description: "Restores 30 HP when used.",
                        tier: 1,
                        requiredLevel: 1
                    },
                    { 
                        name: "Sanity Tonic", 
                        materials: { herbs: 2, ancientScrolls: 1 },
                        result: { name: "Sanity Tonic", sanity: 25, type: "sanity" },
                        description: "Restores 25 Sanity. Essential after monster encounters.",
                        tier: 2,
                        requiredLevel: 3
                    },
                    { 
                        name: "Anti-Venom", 
                        materials: { herbs: 3, medicalSupplies: 1 },
                        result: { name: "Anti-Venom", type: "cure", effect: "removes poison" },
                        description: "Cures poison from creature attacks.",
                        tier: 2,
                        requiredLevel: 4
                    },
                    { 
                        name: "Wolfsbane Extract", 
                        materials: { wolfsbane: 2, herbs: 1 },
                        result: { name: "Wolfsbane Extract", type: "potion", effect: "werewolf weakness" },
                        description: "Temporarily weakens werewolves.",
                        tier: 2,
                        requiredLevel: 4
                    }
                ],
                traps: [
                    { 
                        name: "Bear Trap", 
                        materials: { wood: 2, metal: 1 },
                        result: { name: "Bear Trap", damage: "15-25", type: "trap", effect: "immobilize" },
                        description: "Damages and immobilizes monsters.",
                        tier: 2,
                        requiredLevel: 3
                    },
                    { 
                        name: "Holy Ground", 
                        materials: { holyWater: 2, herbs: 1 },
                        result: { name: "Holy Ground", type: "trap", effect: "repels undead" },
                        description: "Creates an area harmful to undead.",
                        tier: 3,
                        requiredLevel: 5
                    },
                    { 
                        name: "Electrical Fence", 
                        materials: { electricalParts: 3, metal: 2 },
                        result: { name: "Electrical Fence", damage: "20-30", type: "trap", weakness: "creature" },
                        description: "Especially effective against the Creature.",
                        tier: 3,
                        requiredLevel: 6
                    }
                ]
            },
            monsterWeaknesses: {
                "vampire": ["holy", "wood", "sunlight"],
                "werewolf": ["silver", "wolfsbane"],
                "frankenstein": ["fire", "electricity"],
                "mummy": ["fire", "ancient"],
                "creature": ["electric", "fire"],
                "phantom": ["light", "unmasking"]
            }
        };

        // Sound System
        const soundSystem = {
            audioContext: null,
            soundEnabled: true,
            
            init() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            },
            
            playBeep(frequency, duration, type = 'sine') {
                if (!this.soundEnabled || !this.audioContext) return;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = type;
                    
                    gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    console.log("Sound error:", e);
                }
            },
            
            playButtonClick() {
                this.playBeep(600, 0.05, 'square');
            },
            
            playSuccess() {
                this.playBeep(800, 0.1, 'sine');
                setTimeout(() => this.playBeep(1000, 0.1, 'sine'), 100);
            },
            
            playCombatHit() {
                this.playBeep(300, 0.1, 'sawtooth');
            },
            
            playMonsterGrowl() {
                this.playBeep(150, 0.3, 'sawtooth');
                setTimeout(() => this.playBeep(100, 0.2, 'sawtooth'), 200);
            },
            
            playVampireHiss() {
                this.playBeep(500, 0.2, 'sawtooth');
                setTimeout(() => this.playBeep(400, 0.3, 'sawtooth'), 150);
            },
            
            playWerewolfHowl() {
                this.playBeep(200, 0.5, 'sine');
                setTimeout(() => this.playBeep(300, 0.4, 'sine'), 300);
            },
            
            playHolySound() {
                this.playBeep(1000, 0.3, 'sine');
                setTimeout(() => this.playBeep(1200, 0.2, 'sine'), 200);
                setTimeout(() => this.playBeep(1500, 0.1, 'sine'), 400);
            },
            
            playSanityLoss() {
                this.playBeep(400, 0.5, 'triangle');
            },
            
            playTimeChange() {
                this.playBeep(700, 0.2, 'sine');
                setTimeout(() => this.playBeep(600, 0.2, 'sine'), 200);
            },
            
            playCritical() {
                this.playBeep(800, 0.1, 'square');
                setTimeout(() => this.playBeep(1200, 0.2, 'square'), 100);
            },
            
            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                document.getElementById('sound-toggle').textContent = this.soundEnabled ? 'üîä' : 'üîá';
                
                if (this.soundEnabled && !this.audioContext) {
                    this.init();
                }
                
                if (this.soundEnabled) {
                    setTimeout(() => this.playButtonClick(), 100);
                }
            }
        };

        // ==================== TIME SYSTEM ====================
        function updateTime() {
            gameState.player.timeCounter++;
            
            // Change time of day every 5 minutes of game time
            if (gameState.player.timeCounter >= 300) { // 300 seconds = 5 minutes
                gameState.player.timeCounter = 0;
                
                // Cycle through times: day -> dusk -> night -> midnight -> day
                const times = ["day", "dusk", "night", "midnight"];
                const currentIndex = times.indexOf(gameState.player.currentTime);
                const nextIndex = (currentIndex + 1) % times.length;
                gameState.player.currentTime = times[nextIndex];
                
                const timeInfo = gameState.timeOfDay[gameState.player.currentTime];
                document.getElementById('current-time').textContent = timeInfo.name;
                document.getElementById('time-indicator').textContent = timeInfo.name;
                
                // Play time change sound
                soundSystem.playTimeChange();
                
                // Show warning for dangerous times
                if (gameState.player.currentTime === "night" || gameState.player.currentTime === "midnight") {
                    showMessage(`${timeInfo.name}: ${timeInfo.description}`);
                    
                    // Update warning on game screen
                    const warning = document.getElementById('time-warning');
                    if (warning) {
                        warning.style.display = 'block';
                        warning.textContent = `‚ö†Ô∏è ${timeInfo.name.toUpperCase()} - MONSTERS ARE STRONGER! ‚ö†Ô∏è`;
                    }
                } else {
                    const warning = document.getElementById('time-warning');
                    if (warning) warning.style.display = 'none';
                }
                
                // Count nights survived
                if (gameState.player.currentTime === "midnight") {
                    gameState.stats.nightsSurvived++;
                }
            }
        }
        
        function getTimeBonus() {
            return gameState.timeOfDay[gameState.player.currentTime].monsterBonus;
        }
        
        // ==================== SANITY SYSTEM ====================
        function updateSanity(amount) {
            const oldSanity = gameState.player.sanity;
            gameState.player.sanity = Math.max(0, Math.min(gameState.player.maxSanity, gameState.player.sanity + amount));
            
            if (amount < 0) {
                gameState.stats.sanityLost += Math.abs(amount);
                soundSystem.playSanityLoss();
                
                // Check for sanity effects
                if (gameState.player.sanity < 30 && oldSanity >= 30) {
                    showMessage("Your sanity is low! Hallucinations may occur...");
                    document.getElementById('player-sanity').classList.add('sanity-low');
                }
                
                if (gameState.player.sanity === 0) {
                    gameOver("Your mind has shattered. You become one of the monsters...");
                }
            }
            
            // Update display
            document.getElementById('player-sanity').textContent = `${gameState.player.sanity}/${gameState.player.maxSanity}`;
            const sanityPercent = (gameState.player.sanity / gameState.player.maxSanity) * 100;
            
            // Update sanity bar if it exists
            const sanityBarContainer = document.querySelector('#player-sanity').previousElementSibling;
            if (sanityBarContainer) {
                const sanityBar = sanityBarContainer.querySelector('.sanity-bar');
                if (sanityBar) sanityBar.style.width = `${sanityPercent}%`;
            }
            
            // Update combat display if in combat
            if (gameState.combatActive) {
                document.getElementById('player-combat-sanity').textContent = gameState.player.sanity;
            }
        }
        
        // ==================== SAVE SYSTEM ====================
        function saveGameToSlot(slotNumber, showNotification = true) {
            try {
                const saveData = {
                    timestamp: Date.now(),
                    gameState: JSON.parse(JSON.stringify(gameState)),
                    version: "1.0"
                };
                
                localStorage.setItem(`${SAVE_KEY_PREFIX}${slotNumber}`, JSON.stringify(saveData));
                
                // Auto-save to slot 1
                if (slotNumber === 1) {
                    localStorage.setItem(`${SAVE_KEY_PREFIX}auto`, JSON.stringify(saveData));
                }
                
                if (showNotification) {
                    showMessage(`Progress saved to journal ${slotNumber}!`);
                    soundSystem.playSuccess();
                }
                return true;
            } catch (error) {
                console.error("Save error:", error);
                if (showNotification) {
                    showMessage("Failed to save progress!");
                }
                return false;
            }
        }
        
        function loadGameFromSlot(slotNumber) {
            try {
                const saveData = localStorage.getItem(`${SAVE_KEY_PREFIX}${slotNumber}`);
                if (!saveData) {
                    showMessage(`No saved progress in journal ${slotNumber}`);
                    soundSystem.playButtonClick();
                    return false;
                }
                
                const parsedData = JSON.parse(saveData);
                Object.assign(gameState, parsedData.gameState);
                
                showMessage(`Loaded progress from journal ${slotNumber}!`);
                soundSystem.playSuccess();
                
                updateGameScreen();
                updateSkillsScreen();
                showScreen('game-screen');
                return true;
            } catch (error) {
                console.error("Load error:", error);
                showMessage("Failed to load progress!");
                return false;
            }
        }
        
        function updateSaveScreen() {
            const content = document.getElementById('save-slots');
            let html = '';
            
            for (let i = 1; i <= SAVE_SLOTS; i++) {
                const saveData = localStorage.getItem(`${SAVE_KEY_PREFIX}${i}`);
                
                if (saveData) {
                    try {
                        const parsed = JSON.parse(saveData);
                        const date = new Date(parsed.timestamp);
                        const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        html += `
                            <div class="save-slot" onclick="loadGameFromSlot(${i})">
                                <div class="save-level">Journal ${i}: Level ${parsed.gameState.player.level} Hunter</div>
                                <div class="save-info">${timeStr}</div>
                                <div class="save-info">Monsters Defeated: ${parsed.gameState.stats.monstersDefeated} | Gold: ${parsed.gameState.player.gold}</div>
                                <div style="margin-top: 5px;">
                                    <button class="button button-danger" style="padding: 5px; font-size: 9px;" onclick="event.stopPropagation(); deleteSaveSlot(${i})">BURN</button>
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        html += `<div class="save-slot">Journal ${i}: Damaged</div>`;
                    }
                } else {
                    html += `
                        <div class="save-slot" onclick="saveGameToSlot(${i}); updateSaveScreen();">
                            <div class="save-level">Journal ${i}: Empty</div>
                            <div class="save-info">Click to record current hunt</div>
                        </div>
                    `;
                }
            }
            
            content.innerHTML = html;
        }
        
        function deleteSaveSlot(slotNumber) {
            if (confirm(`Burn journal ${slotNumber}? This cannot be undone!`)) {
                localStorage.removeItem(`${SAVE_KEY_PREFIX}${slotNumber}`);
                if (slotNumber === 1) {
                    localStorage.removeItem(`${SAVE_KEY_PREFIX}auto`);
                }
                showMessage(`Journal ${slotNumber} burned!`);
                updateSaveScreen();
                soundSystem.playButtonClick();
            }
        }
        
        function deleteAllSaves() {
            if (confirm("Burn ALL journals? All progress will be lost!")) {
                for (let i = 1; i <= SAVE_SLOTS; i++) {
                    localStorage.removeItem(`${SAVE_KEY_PREFIX}${i}`);
                }
                localStorage.removeItem(`${SAVE_KEY_PREFIX}auto`);
                showMessage("All journals burned!");
                updateSaveScreen();
                soundSystem.playButtonClick();
            }
        }
        
        // ==================== SKILL SYSTEM ====================
        function updateSkillsScreen() {
            const content = document.getElementById('skill-tree');
            const pointsDisplay = document.getElementById('available-skill-points');
            
            pointsDisplay.textContent = gameState.player.skillPoints;
            
            const indicator = document.getElementById('skill-points-indicator');
            if (gameState.player.skillPoints > 0) {
                indicator.textContent = gameState.player.skillPoints;
                indicator.style.display = 'flex';
            } else {
                indicator.style.display = 'none';
            }
            
            let html = '';
            
            const skillCategories = {
                "Vampire Hunting": ["vampireHunter", "holyWarrior"],
                "Werewolf Expertise": ["werewolfExpert", "silverSmith"],
                "Survival Skills": ["occultScholar", "sturdyConstitution", "fearless"],
                "Combat Training": ["quickReflexes", "monsterAnatomist"],
                "Field Craft": ["fieldMedic", "trapExpert", "nightVision"]
            };
            
            for (const [category, skillIds] of Object.entries(skillCategories)) {
                html += `<div style="grid-column: 1 / -1; color: #ffd700; margin-top: 10px; margin-bottom: 5px; border-bottom: 1px solid #8b0000;">${category}</div>`;
                
                for (const skillId of skillIds) {
                    const skill = gameState.skills[skillId];
                    const canAfford = gameState.player.skillPoints >= skill.cost;
                    const canUpgrade = skill.level < skill.maxLevel;
                    const isMaxed = skill.level === skill.maxLevel;
                    const skillName = skillId.charAt(0).toUpperCase() + skillId.slice(1).replace(/([A-Z])/g, ' $1');
                    
                    let nodeClass = "skill-node";
                    if (isMaxed) {
                        nodeClass += " maxed";
                    } else if (skill.level > 0) {
                        nodeClass += " unlocked";
                    } else if (!canAfford) {
                        nodeClass += " locked";
                    }
                    
                    html += `
                        <div class="${nodeClass}" onclick="${canUpgrade && canAfford ? `upgradeSkill('${skillId}')` : ''}">
                            <div style="font-size: 10px; color: ${isMaxed ? '#ff6347' : (skill.level > 0 ? '#90ee90' : '#aaaaaa')}">
                                ${skillName}
                            </div>
                            <div class="skill-level">Level ${skill.level}/${skill.maxLevel}</div>
                            <div class="skill-cost">Cost: ${skill.cost} TP</div>
                            <div style="font-size: 8px; margin-top: 5px; color: #b0c4de;">
                                ${skill.description}
                            </div>
                            ${isMaxed ? '<div style="font-size: 8px; color: #ffd700; margin-top: 3px;">MASTERED</div>' : ''}
                        </div>
                    `;
                }
            }
            
            content.innerHTML = html;
            
            document.getElementById('reset-skills-btn').style.display = 
                Object.values(gameState.skills).some(s => s.level > 0) ? 'block' : 'none';
        }
        
        function upgradeSkill(skillId) {
            const skill = gameState.skills[skillId];
            
            if (!skill || skill.level >= skill.maxLevel) {
                showMessage("Skill already mastered!");
                soundSystem.playButtonClick();
                return;
            }
            
            if (gameState.player.skillPoints < skill.cost) {
                showMessage("Not enough training points!");
                soundSystem.playButtonClick();
                return;
            }
            
            gameState.player.skillPoints -= skill.cost;
            skill.level++;
            
            // Apply skill effects
            applySkillEffects();
            
            updateSkillsScreen();
            updateGameScreen();
            showMessage(`${skillId.replace(/([A-Z])/g, ' $1').toUpperCase()} mastered!`);
            soundSystem.playSuccess();
            
            setTimeout(saveGameToSlot, 100, 1, false);
        }
        
        function applySkillEffects() {
            const skills = gameState.skills;
            
            // Apply HP bonus
            gameState.player.maxHp = 50 + (skills.sturdyConstitution.level * 10);
            
            // Apply sanity bonus
            gameState.player.maxSanity = 100 + (skills.occultScholar.level * 10);
            
            // Ensure current values don't exceed max
            if (gameState.player.hp > gameState.player.maxHp) {
                gameState.player.hp = gameState.player.maxHp;
            }
            if (gameState.player.sanity > gameState.player.maxSanity) {
                gameState.player.sanity = gameState.player.maxSanity;
            }
            
            // Update combat display if in combat
            if (gameState.combatActive) {
                updatePlayerCombatDisplay();
            }
        }
        
        function awardSkillPoint() {
            if (gameState.player.level % 2 === 0) {
                gameState.player.skillPoints++;
                showMessage(`You earned a training point! Total: ${gameState.player.skillPoints}`);
                updateSkillsScreen();
                soundSystem.playSuccess();
            }
        }
        
        // ==================== GAME FUNCTIONS ====================
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.getElementById(screenId).classList.add('active');
            soundSystem.playButtonClick();
            
            if (screenId === 'game-screen') {
                updateGameScreen();
            } else if (screenId === 'gathering-screen') {
                updateGatheringScreen();
            } else if (screenId === 'crafting-screen') {
                updateCraftingScreen();
            } else if (screenId === 'skills-screen') {
                updateSkillsScreen();
            } else if (screenId === 'save-screen') {
                updateSaveScreen();
            } else if (screenId === 'combat-screen') {
                if (!gameState.combatActive) {
                    startCombat();
                }
            }
        }

        // NEW FUNCTION: Exit combat and return to game screen
        function exitCombat() {
            if (!gameState.combatActive) {
                showScreen('game-screen');
                return;
            }
            
            // If combat is still active, ask for confirmation
            if (gameState.enemy && gameState.enemy.hp > 0) {
                if (confirm("Are you sure you want to retreat? This will end combat.")) {
                    gameState.combatActive = false;
                    gameState.enemy = null;
                    showScreen('game-screen');
                    showMessage("You retreat from combat!");
                }
            } else {
                // Combat already finished, just exit
                gameState.combatActive = false;
                gameState.enemy = null;
                showScreen('game-screen');
            }
            soundSystem.playButtonClick();
        }

        // UPDATED FUNCTION: Modified retreat button
        function attemptEscape() {
            soundSystem.playButtonClick();
            
            if (!gameState.combatActive || !gameState.enemy) {
                // If combat is already over, just exit
                exitCombat();
                return;
            }
            
            const escapeChance = 0.4; // 40% chance to escape
            
            if (Math.random() < escapeChance) {
                addCombatLog(`You successfully retreat from combat!`, "event");
                gameState.combatActive = false;
                gameState.enemy = null;
                soundSystem.playSuccess();
                
                // Lose some sanity from fleeing
                updateSanity(-10);
                
                // Hide combat buttons, show exit button
                showExitCombatButton();
                
                // Return to game screen after delay
                setTimeout(() => {
                    showScreen('game-screen');
                }, 1500);
            } else {
                addCombatLog(`You failed to escape!`, "event");
                soundSystem.playCombatHit();
                
                setTimeout(() => {
                    monsterAttack();
                }, 500);
            }
        }

        // NEW FUNCTION: Show exit combat button when combat ends
        function showExitCombatButton() {
            const exitBtn = document.getElementById('exit-combat-btn');
            const attackBtn = document.querySelector('.button-danger');
            const holyBtn = document.querySelector('button[onclick="useHolyItem()"]');
            const specialBtn = document.querySelector('button[onclick="useSpecialWeapon()"]');
            
            if (exitBtn) {
                exitBtn.style.display = 'block';
            }
            if (attackBtn) {
                attackBtn.style.display = 'none';
            }
            if (holyBtn) {
                holyBtn.style.display = 'none';
            }
            if (specialBtn) {
                specialBtn.style.display = 'none';
            }
        }

        // NEW FUNCTION: Hide exit combat button when combat starts
        function hideExitCombatButton() {
            const exitBtn = document.getElementById('exit-combat-btn');
            const attackBtn = document.querySelector('.button-danger');
            const holyBtn = document.querySelector('button[onclick="useHolyItem()"]');
            const specialBtn = document.querySelector('button[onclick="useSpecialWeapon()"]');
            
            if (exitBtn) {
                exitBtn.style.display = 'none';
            }
            if (attackBtn) {
                attackBtn.style.display = 'block';
            }
            if (holyBtn) {
                holyBtn.style.display = 'block';
            }
            if (specialBtn) {
                specialBtn.style.display = 'block';
            }
        }

        function startGame() {
            gameState.player = {
                name: "Van Helsing",
                level: 1,
                xp: 0,
                xpToNextLevel: 100,
                hp: 50,
                maxHp: 50,
                sanity: 100,
                maxSanity: 100,
                attack: 5,
                defense: 2,
                gold: 100,
                skillPoints: 0,
                criticalChance: 5,
                criticalMultiplier: 1.5,
                weapon: { name: "Hunting Knife", damage: "3-5", type: "basic", weakness: "none" },
                armor: { name: "Leather Coat", defense: 2, type: "armor" },
                medkits: 3,
                sanityPotions: 2,
                currentTime: "dusk",
                timeCounter: 0,
                monstersDefeated: {
                    dracula: false,
                    wolfman: false,
                    frankenstein: false,
                    mummy: false,
                    creature: false,
                    phantom: false
                }
            };
            
            for (const skillId in gameState.skills) {
                gameState.skills[skillId].level = 0;
            }
            
            gameState.inventory = {
                herbs: 5,
                wood: 3,
                silverOre: 2,
                holyWater: 1,
                garlic: 2,
                wolfsbane: 1,
                vampireDust: 0,
                werewolfFur: 0,
                frankensteinParts: 0,
                mummyBandages: 0,
                creatureScales: 0,
                phantomMask: 0,
                ancientScrolls: 0,
                medicalSupplies: 3,
                electricalParts: 0,
                gunpowder: 1
            };
            
            gameState.currentArea = "transylvania";
            gameState.combatActive = false;
            gameState.enemy = null;
            gameState.gameTime = 0;
            gameState.stats = {
                monstersDefeated: 0,
                resourcesGathered: 0,
                itemsCrafted: 0,
                goldEarned: 0,
                damageDealt: 0,
                damageTaken: 0,
                sanityLost: 0,
                nightsSurvived: 0
            };
            
            applySkillEffects();
            showScreen('game-screen');
            showMessage("Welcome, Monster Hunter! The classic horrors have awakened. Use specific weaknesses to defeat each monster!");
            soundSystem.playSuccess();
            
            setTimeout(() => saveGameToSlot(1, false), 500);
        }

        function updateGameScreen() {
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('player-hp').textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
            document.getElementById('player-sanity').textContent = `${gameState.player.sanity}/${gameState.player.maxSanity}`;
            
            const hpPercent = (gameState.player.hp / gameState.player.maxHp) * 100;
            const hpBarContainer = document.querySelector('#player-hp').previousElementSibling;
            if (hpBarContainer) {
                hpBarContainer.innerHTML = `<div class="hp-bar" style="width: ${hpPercent}%"></div>`;
            }
            
            const sanityPercent = (gameState.player.sanity / gameState.player.maxSanity) * 100;
            const sanityBarContainer = document.querySelector('#player-sanity').previousElementSibling;
            if (sanityBarContainer) {
                sanityBarContainer.innerHTML = `<div class="sanity-bar" style="width: ${sanityPercent}%"></div>`;
            }
            
            const area = gameData.areas[gameState.currentArea];
            document.getElementById('location-name').textContent = area.name;
            document.getElementById('location-description').textContent = area.description;
            
            const content = document.getElementById('game-content');
            const timeInfo = gameState.timeOfDay[gameState.player.currentTime];
            
            content.innerHTML = `
                <p>Location: <strong>${area.name}</strong></p>
                <p>Time: <strong>${timeInfo.name}</strong> - ${timeInfo.description}</p>
                <p><strong>Gold:</strong> ${gameState.player.gold} coins</p>
                <p><strong>Current Weapon:</strong> ${gameState.player.weapon.name} (DMG: ${gameState.player.weapon.damage})</p>
                <p><strong>Medkits:</strong> ${gameState.player.medkits} | <strong>Sanity Tonics:</strong> ${gameState.player.sanityPotions}</p>
                <div style="margin-top: 15px;">
                    <p><strong>Monsters Defeated:</strong> ${gameState.stats.monstersDefeated}</p>
                    <p><strong>Nights Survived:</strong> ${gameState.stats.nightsSurvived}</p>
                </div>
                <div style="margin-top: 15px;">
                    <p><strong>Inventory:</strong></p>
                    ${Object.entries(gameState.inventory).map(([item, count]) => 
                        count > 0 ? `<div class="inventory-item"><span class="item-name">${item.charAt(0).toUpperCase() + item.slice(1).replace(/([A-Z])/g, ' $1')}</span><span class="item-count">${count}</span></div>` : ''
                    ).join('')}
                </div>
                ${gameState.player.sanity < 50 ? '<p style="color: #ff6347; margin-top: 10px;">‚ö†Ô∏è Your sanity is wavering...</p>' : ''}
            `;
        }

        function changeArea(area) {
            gameState.currentArea = area;
            updateGameScreen();
            
            // Lose some sanity when traveling to monster territories
            updateSanity(-5);
            
            showMessage(`You travel to ${gameData.areas[area].name}. The air grows colder...`);
            soundSystem.playButtonClick();
            
            setTimeout(() => saveGameToSlot(1, false), 100);
        }

        function goToGathering() {
            showScreen('gathering-screen');
        }

        function updateGatheringScreen() {
            const area = gameData.areas[gameState.currentArea];
            document.getElementById('gather-area').textContent = `Scouting: ${area.name}`;
            
            const content = document.getElementById('gather-content');
            content.innerHTML = `
                <p>Searching ${area.name} for resources.</p>
                <p>Available here: ${area.materials.map(m => m.charAt(0).toUpperCase() + m.slice(1).replace(/([A-Z])/g, ' $1')).join(', ')}</p>
                <p style="color: #ff6347; font-size: 10px;">Warning: Searching may attract monsters!</p>
                <div id="gather-results"></div>
            `;
        }

        function changeGatherArea(area) {
            gameState.currentArea = area;
            updateGatheringScreen();
            soundSystem.playButtonClick();
        }

        function gatherMaterials() {
            soundSystem.playButtonClick();
            
            const area = gameData.areas[gameState.currentArea];
            const materials = area.materials;
            
            // Base materials found (1-3)
            const baseMaterials = Math.floor(Math.random() * 3) + 1;
            
            const foundMaterials = {};
            let totalFound = 0;
            
            for (let i = 0; i < baseMaterials; i++) {
                const material = materials[Math.floor(Math.random() * materials.length)];
                gameState.inventory[material]++;
                foundMaterials[material] = (foundMaterials[material] || 0) + 1;
                totalFound++;
            }
            
            gameState.stats.resourcesGathered += totalFound;
            
            const resultsDiv = document.getElementById('gather-results');
            resultsDiv.innerHTML = `
                <p>You search the area and find:</p>
                ${Object.entries(foundMaterials).map(([material, count]) => 
                    `<p><strong>${material.charAt(0).toUpperCase() + material.slice(1).replace(/([A-Z])/g, ' $1')}</strong> x${count}</p>`
                ).join('')}
                <p style="margin-top: 10px;">Added to inventory.</p>
            `;
            
            soundSystem.playSuccess();
            
            // Lose sanity while gathering in dangerous areas
            updateSanity(-3);
            
            // Chance of monster encounter (higher at night)
            let encounterChance = 0.3;
            if (gameState.player.currentTime === "night" || gameState.player.currentTime === "midnight") {
                encounterChance = 0.5;
            }
            
            if (Math.random() < encounterChance) {
                setTimeout(() => {
                    showMessage("A monster has found you!");
                    soundSystem.playMonsterGrowl();
                    goToCombat();
                }, 1000);
            }
            
            setTimeout(() => saveGameToSlot(1, false), 100);
        }

        function goToCrafting() {
            showScreen('crafting-screen');
        }

        function updateCraftingScreen() {
            showCraftingCategory(gameState.craftingCategory);
        }

        function showCraftingCategory(category) {
            gameState.craftingCategory = category;
            
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const recipes = gameData.craftingRecipes[category];
            const content = document.getElementById('crafting-content');
            
            if (!recipes) {
                content.innerHTML = `<p>No recipes available.</p>`;
                return;
            }
            
            const availableRecipes = recipes.filter(recipe => 
                gameState.player.level >= recipe.requiredLevel
            );
            
            let recipeHTML = '';
            
            availableRecipes.forEach(recipe => {
                const canCraft = Object.entries(recipe.materials).every(([material, amount]) => 
                    gameState.inventory[material] >= amount
                );
                
                recipeHTML += `
                    <div class="crafting-recipe">
                        <div class="recipe-title">${recipe.name} (Level ${recipe.requiredLevel}+)</div>
                        <div class="recipe-stats">${recipe.description}</div>
                        <div class="recipe-materials">
                            <p style="font-size: 9px;">Requires: ${Object.entries(recipe.materials).map(([material, amount]) => 
                                `<span style="color: ${gameState.inventory[material] >= amount ? '#90ee90' : '#ff6347'}">${material.charAt(0).toUpperCase() + material.slice(1).replace(/([A-Z])/g, ' $1')} x${amount}</span>`
                            ).join(', ')}</p>
                        </div>
                        <button class="button ${canCraft ? 'button-primary' : ''}" 
                                onclick="craftItem('${category}', '${recipe.name}')"
                                ${!canCraft ? 'disabled' : ''}>
                            ${canCraft ? 'CRAFT' : 'NEED MATERIALS'}
                        </button>
                    </div>
                `;
            });
            
            if (recipeHTML === '') {
                recipeHTML = `<p>Level up to unlock more crafting recipes!</p>`;
            }
            
            content.innerHTML = `
                <p>Crafting ${category.toUpperCase()} items:</p>
                ${recipeHTML}
            `;
        }

        function craftItem(category, itemName) {
            soundSystem.playButtonClick();
            
            const recipes = gameData.craftingRecipes[category];
            const recipe = recipes.find(r => r.name === itemName);
            
            if (!recipe) {
                showMessage("Recipe not found!");
                return;
            }
            
            if (gameState.player.level < recipe.requiredLevel) {
                showMessage(`You need to be level ${recipe.requiredLevel} to craft this!`);
                soundSystem.playButtonClick();
                return;
            }
            
            const canCraft = Object.entries(recipe.materials).every(([material, amount]) => 
                gameState.inventory[material] >= amount
            );
            
            if (!canCraft) {
                showMessage(`Not enough materials to craft ${itemName}.`);
                soundSystem.playButtonClick();
                return;
            }
            
            Object.entries(recipe.materials).forEach(([material, amount]) => {
                gameState.inventory[material] -= amount;
            });
            
            const result = recipe.result;
            
            if (category === 'holy' || category === 'silver') {
                if (result.type === "weapon") {
                    gameState.player.weapon = result;
                    showMessage(`You crafted ${itemName}! Effective against ${result.weakness || 'monsters'}.`);
                } else if (result.type === "consumable") {
                    // Add to appropriate inventory
                    if (itemName.includes("Bullet")) {
                        gameState.player.silverBullets = (gameState.player.silverBullets || 0) + 6;
                    } else if (itemName.includes("Grenade")) {
                        gameState.player.holyGrenades = (gameState.player.holyGrenades || 0) + 1;
                    }
                    showMessage(`You crafted ${itemName}!`);
                } else if (result.type === "tool") {
                    showMessage(`You crafted ${itemName}! ${result.effect}`);
                }
            } else if (category === 'medical') {
                if (result.type === "medkit") {
                    gameState.player.medkits++;
                    showMessage(`You crafted a Medical Kit! Heals ${result.heal} HP.`);
                } else if (result.type === "sanity") {
                    gameState.player.sanityPotions++;
                    showMessage(`You crafted a Sanity Tonic! Restores ${result.sanity} Sanity.`);
                } else {
                    showMessage(`You crafted ${itemName}!`);
                }
            } else if (category === 'traps') {
                gameState.player.traps = (gameState.player.traps || 0) + 1;
                showMessage(`You crafted ${itemName}!`);
            }
            
            gameState.stats.itemsCrafted++;
            soundSystem.playSuccess();
            
            updateCraftingScreen();
            updateGameScreen();
            
            setTimeout(() => saveGameToSlot(1, false), 100);
        }

        function goToCombat() {
            // Hide exit button when starting combat
            hideExitCombatButton();
            showScreen('combat-screen');
        }

        function updatePlayerCombatDisplay() {
            document.getElementById('player-combat-hp').textContent = gameState.player.hp;
            document.getElementById('player-combat-max-hp').textContent = gameState.player.maxHp;
            document.getElementById('player-combat-sanity').textContent = gameState.player.sanity;
            document.getElementById('player-combat-atk').textContent = gameState.player.attack;
            document.getElementById('player-combat-def').textContent = gameState.player.defense;
            
            const playerHpPercent = (gameState.player.hp / gameState.player.maxHp) * 100;
            document.getElementById('player-combat-hp-bar').style.width = `${playerHpPercent}%`;
        }

        function startCombat() {
            gameState.combatActive = true;
            
            const area = gameData.areas[gameState.currentArea];
            const enemies = area.enemies;
            
            // Select enemy based on player level and time of day
            let enemyIndex;
            if (gameState.player.level < 3) {
                enemyIndex = 0; // Weakest enemy
            } else if (gameState.player.level < 6) {
                enemyIndex = Math.floor(Math.random() * 2); // First two enemies
            } else if (gameState.player.level < 10) {
                enemyIndex = Math.floor(Math.random() * 3); // First three enemies
            } else {
                enemyIndex = Math.floor(Math.random() * enemies.length); // Any enemy
            }
            
            const enemyName = enemies[enemyIndex];
            const enemyStats = area.enemyStats[enemyName];
            
            // Scale enemy stats based on player level and time of day
            const timeBonus = getTimeBonus();
            const scaleFactor = (1 + (gameState.player.level - 1) * 0.1) * timeBonus;
            
            const scaledHp = Math.floor(enemyStats.hp * scaleFactor);
            const scaledMaxHp = Math.floor(enemyStats.maxHp * scaleFactor);
            const scaledXp = Math.floor(enemyStats.xp * scaleFactor);
            
            const damageRange = enemyStats.attack.split('-').map(Number);
            const scaledMinDmg = Math.floor(damageRange[0] * scaleFactor);
            const scaledMaxDmg = Math.floor(damageRange[1] * scaleFactor);
            const scaledAttack = `${scaledMinDmg}-${scaledMaxDmg}`;
            
            const goldRange = enemyStats.gold.split('-').map(Number);
            const minGold = Math.floor(goldRange[0] * scaleFactor);
            const maxGold = Math.floor(goldRange[1] * scaleFactor);
            
            gameState.enemy = {
                name: enemyName,
                hp: scaledHp,
                maxHp: scaledMaxHp,
                attack: scaledAttack,
                xp: scaledXp,
                gold: `${minGold}-${maxGold}`,
                special: enemyStats.special,
                weakTo: enemyStats.weakTo,
                resistance: enemyStats.resistance,
                description: enemyStats.description,
                type: enemyName.toLowerCase().includes("vampire") ? "vampire" :
                      enemyName.toLowerCase().includes("wolf") ? "werewolf" :
                      enemyName.toLowerCase().includes("mummy") ? "mummy" :
                      enemyName.toLowerCase().includes("franken") ? "frankenstein" :
                      enemyName.toLowerCase().includes("creature") ? "creature" : "phantom"
            };
            
            updateCombatScreen();
            updatePlayerCombatDisplay();
            
            const combatLog = document.getElementById('combat-log');
            combatLog.innerHTML = `<div class="log-entry event-log">${enemyStats.description}</div>`;
            
            // Play appropriate monster sound
            if (gameState.enemy.type === "vampire") {
                soundSystem.playVampireHiss();
            } else if (gameState.enemy.type === "werewolf") {
                soundSystem.playWerewolfHowl();
            } else {
                soundSystem.playMonsterGrowl();
            }
            
            scrollCombatLogToBottom();
        }

        function updateCombatScreen() {
            if (!gameState.enemy) return;
            
            const enemy = gameState.enemy;
            document.getElementById('enemy-name').textContent = enemy.name;
            document.getElementById('enemy-hp').textContent = enemy.hp;
            document.getElementById('enemy-max-hp').textContent = enemy.maxHp;
            document.getElementById('enemy-threat').textContent = 
                enemy.hp > 70 ? "HIGH" : enemy.hp > 40 ? "MEDIUM" : "LOW";
            
            // Show weaknesses with colored indicators
            const weaknessHTML = enemy.weakTo.map(w => 
                `<span class="weakness-indicator weakness-${w}">${w.toUpperCase()}</span>`
            ).join(' ');
            document.getElementById('enemy-weakness').innerHTML = weaknessHTML;
            
            const enemyHpPercent = (enemy.hp / enemy.maxHp) * 100;
            document.getElementById('enemy-hp-bar').style.width = `${enemyHpPercent}%`;
            
            // Set monster emoji
            const enemyImage = document.getElementById('enemy-image');
            if (enemy.type === "vampire") enemyImage.textContent = "üßõ‚Äç‚ôÇÔ∏è";
            else if (enemy.type === "werewolf") enemyImage.textContent = "üê∫";
            else if (enemy.type === "mummy") enemyImage.textContent = "‚ö∞Ô∏è";
            else if (enemy.type === "frankenstein") enemyImage.textContent = "üßü‚Äç‚ôÇÔ∏è";
            else if (enemy.type === "creature") enemyImage.textContent = "üêü";
            else enemyImage.textContent = "üé≠";
            
            if (enemy.special) {
                document.getElementById('enemy-special').textContent = `Special: ${enemy.special.replace(/_/g, ' ')}`;
            }
            
            document.getElementById('combat-area').textContent = `${gameData.areas[gameState.currentArea].name}`;
            
            updatePlayerCombatDisplay();
        }

        function scrollCombatLogToBottom() {
            const combatLog = document.getElementById('combat-log');
            combatLog.scrollTop = combatLog.scrollHeight;
        }

        function addCombatLog(text, type = "event", isHoly = false) {
            const combatLog = document.getElementById('combat-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}-log ${isHoly ? 'holy-log' : ''}`;
            entry.textContent = text;
            combatLog.appendChild(entry);
            scrollCombatLogToBottom();
        }

        function playerAttack() {
            if (!gameState.combatActive || !gameState.enemy) return;
            
            soundSystem.playButtonClick();
            
            const combatLog = document.getElementById('combat-log');
            
            // Calculate damage
            const weaponDamage = gameState.player.weapon.damage.split('-').map(Number);
            const baseDamage = Math.floor(Math.random() * (weaponDamage[1] - weaponDamage[0] + 1)) + weaponDamage[0];
            const attackBonus = gameState.player.attack;
            let totalDamage = baseDamage + attackBonus;
            
            // Check for skill bonuses against specific monster types
            if (gameState.enemy.type === "vampire" && gameState.skills.vampireHunter.level > 0) {
                totalDamage = Math.floor(totalDamage * (1 + 0.25 * gameState.skills.vampireHunter.level));
            }
            if (gameState.enemy.type === "werewolf" && gameState.skills.werewolfExpert.level > 0) {
                totalDamage = Math.floor(totalDamage * (1 + 0.25 * gameState.skills.werewolfExpert.level));
            }
            
            // Check for weapon weakness match
            const weaponWeakness = gameState.player.weapon.weakness;
            let weaknessBonus = 1;
            if (weaponWeakness && weaponWeakness !== "none") {
                if (gameState.enemy.weakTo.includes(weaponWeakness)) {
                    weaknessBonus = 2; // Double damage for correct weakness
                    addCombatLog(`CORRECT WEAKNESS! ${weaponWeakness.toUpperCase()} is effective!`, "event", true);
                }
            }
            
            // Check for critical hit
            let isCritical = false;
            let criticalBonus = gameState.skills.monsterAnatomist.level * 0.05;
            if (Math.random() * 100 < (gameState.player.criticalChance + criticalBonus * 100)) {
                totalDamage = Math.floor(totalDamage * gameState.player.criticalMultiplier);
                isCritical = true;
                gameState.stats.criticalHits++;
                soundSystem.playCritical();
            }
            
            totalDamage = Math.floor(totalDamage * weaknessBonus);
            gameState.enemy.hp -= totalDamage;
            gameState.stats.damageDealt += totalDamage;
            
            if (isCritical) {
                addCombatLog(`CRITICAL HIT! You attack for ${totalDamage} damage!`, "player");
            } else if (weaknessBonus > 1) {
                addCombatLog(`Effective attack! You deal ${totalDamage} damage!`, "player", true);
            } else {
                addCombatLog(`You attack for ${totalDamage} damage!`, "player");
            }
            
            soundSystem.playCombatHit();
            
            updateCombatScreen();
            
            if (gameState.enemy.hp <= 0) {
                enemyDefeated();
                return;
            }
            
            // Monster attacks
            setTimeout(() => {
                monsterAttack();
            }, 500);
        }

        function monsterAttack() {
            const enemy = gameState.enemy;
            
            const enemyDamageRange = enemy.attack.split('-').map(Number);
            const enemyAttack = Math.floor(Math.random() * (enemyDamageRange[1] - enemyDamageRange[0] + 1)) + enemyDamageRange[0];
            
            // Check for dodge from skills
            const dodgeChance = gameState.skills.quickReflexes.level * 10;
            if (Math.random() * 100 < dodgeChance) {
                addCombatLog(`${enemy.name} attacks but you dodge!`, "event");
                soundSystem.playButtonClick();
            } else {
                const damageTaken = Math.max(1, enemyAttack - gameState.player.defense);
                gameState.player.hp -= damageTaken;
                gameState.stats.damageTaken += damageTaken;
                
                addCombatLog(`${enemy.name} attacks for ${damageTaken} damage!`, "enemy");
                soundSystem.playCombatHit();
                
                // Lose sanity from monster attack
                updateSanity(-5);
                
                updatePlayerCombatDisplay();
                
                if (gameState.player.hp <= 0) {
                    gameState.player.hp = 0;
                    addCombatLog(`You have been defeated!`, "event");
                    
                    setTimeout(() => {
                        showMessage("You wake up hours later, injured but alive...");
                        gameState.player.hp = Math.floor(gameState.player.maxHp / 4);
                        gameState.player.sanity = Math.max(20, gameState.player.sanity - 20);
                        gameState.combatActive = false;
                        gameState.enemy = null;
                        updatePlayerCombatDisplay();
                        showExitCombatButton(); // Show exit button when defeated
                        showMessage("Press 'RETURN TO LODGE' to continue");
                        soundSystem.playButtonClick();
                    }, 2000);
                }
            }
            
            updateCombatScreen();
        }

        function enemyDefeated() {
            const enemy = gameState.enemy;
            enemy.hp = 0;
            
            addCombatLog(`You defeated the ${enemy.name}!`, "event");
            
            // Award XP
            gameState.player.xp += enemy.xp;
            addCombatLog(`You gained ${enemy.xp} experience!`, "event");
            
            // Award gold
            const goldRange = enemy.gold.split('-').map(Number);
            const gold = Math.floor(Math.random() * (goldRange[1] - goldRange[0] + 1)) + goldRange[0];
            gameState.player.gold += gold;
            gameState.stats.goldEarned += gold;
            
            addCombatLog(`You found ${gold} gold!`, "event");
            
            // Award monster-specific item
            let lootItem = "";
            if (enemy.type === "vampire") {
                gameState.inventory.vampireDust++;
                lootItem = "Vampire Dust";
            } else if (enemy.type === "werewolf") {
                gameState.inventory.werewolfFur++;
                lootItem = "Werewolf Fur";
            } else if (enemy.type === "mummy") {
                gameState.inventory.mummyBandages++;
                lootItem = "Mummy Bandages";
            } else if (enemy.type === "frankenstein") {
                gameState.inventory.frankensteinParts++;
                lootItem = "Frankenstein Parts";
            } else if (enemy.type === "creature") {
                gameState.inventory.creatureScales++;
                lootItem = "Creature Scales";
            }
            
            if (lootItem) {
                addCombatLog(`You collected ${lootItem}!`, "event");
            }
            
            // Update stats
            gameState.stats.monstersDefeated++;
            
            // Mark major monsters as defeated
            if (enemy.name.includes("Dracula")) gameState.player.monstersDefeated.dracula = true;
            if (enemy.name.includes("Wolf Man")) gameState.player.monstersDefeated.wolfman = true;
            if (enemy.name.includes("Frankenstein")) gameState.player.monstersDefeated.frankenstein = true;
            if (enemy.name.includes("Mummy")) gameState.player.monstersDefeated.mummy = true;
            if (enemy.name.includes("Creature")) gameState.player.monstersDefeated.creature = true;
            
            // Check for level up
            checkLevelUp();
            
            // Restore some sanity for victory
            updateSanity(10);
            
            gameState.combatActive = false;
            updateCombatScreen();
            soundSystem.playSuccess();
            
            // Show exit combat button
            showExitCombatButton();
            addCombatLog("Combat finished! Press 'RETURN TO LODGE' to continue.", "event");
            
            setTimeout(() => saveGameToSlot(1, false), 100);
        }

        function useHolyItem() {
            soundSystem.playButtonClick();
            
            if (!gameState.combatActive || !gameState.enemy) return;
            
            // Check if player has holy items
            if (gameState.inventory.holyWater <= 0 && !gameState.player.weapon.name.includes("Holy")) {
                addCombatLog("You don't have any holy items!", "event");
                return;
            }
            
            // Holy items are especially effective against vampires and undead
            let holyDamage = 15;
            if (gameState.enemy.type === "vampire" || gameState.enemy.type === "mummy") {
                holyDamage = 30;
                addCombatLog("HOLY POWER! The monster recoils in pain!", "event", true);
                soundSystem.playHolySound();
            }
            
            gameState.enemy.hp -= holyDamage;
            
            if (gameState.inventory.holyWater > 0) {
                gameState.inventory.holyWater--;
                addCombatLog(`You use Holy Water for ${holyDamage} damage!`, "player", true);
            } else {
                addCombatLog(`Your holy weapon deals ${holyDamage} damage!`, "player", true);
            }
            
            updateCombatScreen();
            
            if (gameState.enemy.hp <= 0) {
                enemyDefeated();
                return;
            }
            
            setTimeout(() => {
                monsterAttack();
            }, 500);
        }

        function useSpecialWeapon() {
            soundSystem.playButtonClick();
            
            if (!gameState.combatActive || !gameState.enemy) return;
            
            // Check what special weapon player has equipped
            const weapon = gameState.player.weapon;
            
            if (weapon.name.includes("Silver") && gameState.enemy.type === "werewolf") {
                addCombatLog("SILVER EFFECT! The werewolf howls in agony!", "event", true);
                const silverDamage = 25;
                gameState.enemy.hp -= silverDamage;
                addCombatLog(`Silver weapon deals ${silverDamage} damage!`, "player");
            } else if (weapon.name.includes("Wooden") && gameState.enemy.type === "vampire") {
                addCombatLog("WOODEN STAKE! Perfect for vampires!", "event", true);
                const stakeDamage = 35;
                gameState.enemy.hp -= stakeDamage;
                addCombatLog(`Wooden stake deals ${stakeDamage} damage!`, "player");
            } else {
                addCombatLog("Your weapon has no special effect against this monster.", "event");
                // Still do normal attack
                playerAttack();
                return;
            }
            
            updateCombatScreen();
            
            if (gameState.enemy.hp <= 0) {
                enemyDefeated();
                return;
            }
            
            setTimeout(() => {
                monsterAttack();
            }, 500);
        }

        function useMedkit() {
            soundSystem.playButtonClick();
            
            if (gameState.player.medkits <= 0) {
                addCombatLog("You don't have any medkits!", "event");
                return;
            }
            
            gameState.player.medkits--;
            const healAmount = 30 + (gameState.skills.fieldMedic.level * 7.5); // +25% per level
            gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
            
            addCombatLog(`You use a medkit and heal ${Math.floor(healAmount)} HP!`, "event");
            soundSystem.playSuccess();
            
            updatePlayerCombatDisplay();
            updateCombatScreen();
            
            setTimeout(() => {
                monsterAttack();
            }, 500);
        }

        function useSanityPotion() {
            soundSystem.playButtonClick();
            
            if (gameState.player.sanityPotions <= 0) {
                addCombatLog("You don't have any sanity tonics!", "event");
                return;
            }
            
            gameState.player.sanityPotions--;
            updateSanity(25);
            
            addCombatLog("You drink a sanity tonic. Your mind clears.", "event");
            soundSystem.playSuccess();
            
            // Remove low sanity warning if applicable
            if (gameState.player.sanity >= 30) {
                document.getElementById('player-sanity').classList.remove('sanity-low');
            }
            
            setTimeout(() => {
                monsterAttack();
            }, 500);
        }

        function checkLevelUp() {
            while (gameState.player.xp >= gameState.player.xpToNextLevel) {
                gameState.player.level++;
                gameState.player.xp -= gameState.player.xpToNextLevel;
                gameState.player.xpToNextLevel = Math.floor(gameState.player.xpToNextLevel * 1.4);
                
                // Heal on level up
                gameState.player.hp = gameState.player.maxHp;
                updateSanity(20);
                
                // Apply skill effects
                applySkillEffects();
                
                // Award skill point every 2 levels
                awardSkillPoint();
                
                addCombatLog(`You leveled up! You are now level ${gameState.player.level}!`, "event");
                addCombatLog(`Max HP: ${gameState.player.maxHp} | Max Sanity: ${gameState.player.maxSanity}`, "event");
                soundSystem.playSuccess();
                
                updatePlayerCombatDisplay();
            }
        }

        function showMessage(text) {
            document.getElementById('message-text').textContent = text;
            document.getElementById('game-message').style.display = 'block';
            soundSystem.playButtonClick();
        }

        function hideMessage() {
            document.getElementById('game-message').style.display = 'none';
            soundSystem.playButtonClick();
        }

        function gameOver(reason) {
            showMessage(`GAME OVER: ${reason}`);
            setTimeout(() => {
                showScreen('main-menu');
            }, 3000);
        }

        function resetSkills() {
            if (gameState.player.gold < 100) {
                showMessage("You need 100 gold for a retainer!");
                soundSystem.playButtonClick();
                return;
            }
            
            if (confirm("Reset all skills for 100 gold? This will refund all training points.")) {
                let totalPoints = 0;
                for (const [skillId, skill] of Object.entries(gameState.skills)) {
                    totalPoints += skill.level * skill.cost;
                    skill.level = 0;
                }
                
                gameState.player.skillPoints += totalPoints;
                gameState.player.gold -= 100;
                
                applySkillEffects();
                
                updateSkillsScreen();
                updateGameScreen();
                showMessage(`Skills reset! ${totalPoints} training points refunded.`);
                soundSystem.playSuccess();
                
                setTimeout(() => saveGameToSlot(1, false), 100);
            }
        }

        // Initialize the game
        document.addEventListener('DOMContentLoaded', () => {
            soundSystem.init();
            
            document.getElementById('sound-toggle').addEventListener('click', () => {
                soundSystem.toggleSound();
            });
            
            document.getElementById('sound-toggle').textContent = soundSystem.soundEnabled ? 'üîä' : 'üîá';
            
            // Set up stat bars
            const hpBarContainer = document.querySelector('#player-hp').previousElementSibling;
            if (hpBarContainer) {
                hpBarContainer.innerHTML = '<div class="hp-bar" style="width: 100%"></div>';
            }
            
            const sanityBarContainer = document.querySelector('#player-sanity').previousElementSibling;
            if (sanityBarContainer) {
                sanityBarContainer.innerHTML = '<div class="sanity-bar" style="width: 100%"></div>';
            }
            
            // Make buttons responsive
            document.querySelectorAll('.button').forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.transform = 'scale(1)';
                });
                
                button.addEventListener('click', function() {
                    soundSystem.playButtonClick();
                });
            });
            
            // Set up category tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.category-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            
            // Check for auto-save
            const autoSave = localStorage.getItem(`${SAVE_KEY_PREFIX}auto`);
            if (autoSave) {
                document.querySelector('button[onclick="showScreen(\'save-screen\')"]').textContent = "CONTINUE HUNT";
            }
            
            // Initialize the exit combat button
            hideExitCombatButton();
            
            // Game time and update loop
            setInterval(() => {
                gameState.gameTime++;
                updateTime();
                
                // Auto-save every 2 minutes
                if (gameState.gameTime % 120 === 0 && gameState.player.level > 1) {
                    saveGameToSlot(1, false);
                }
            }, 1000);
        });
    </script>
</body>
</html>
