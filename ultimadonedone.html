<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eternal Dominion: Legacy of the Shattered Orb</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: white;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            padding: 20px;
            line-height: 1.4;
            overflow: hidden;
            height: 100vh;
        }
        
        .game-container {
            max-width: 800px;
            margin: 0 auto;
            border: 2px solid white;
            padding: 10px;
            background-color: #000;
            height: 95vh;
            display: flex;
            flex-direction: column;
        }
        
        .game-header {
            text-align: center;
            border-bottom: 1px solid white;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .game-title {
            font-size: 24px;
            color: white;
            text-shadow: 0 0 5px yellow;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .game-subtitle {
            font-size: 14px;
            color: white;
            margin-bottom: 10px;
        }
        
        .game-screen {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid white;
            padding: 10px;
            margin-bottom: 10px;
            height: 60vh;
            background-color: #000;
        }
        
        .game-text {
            margin-bottom: 10px;
        }
        
        .prompt {
            color: white;
        }
        
        .input-line {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .cursor {
            background-color: white;
            width: 8px;
            height: 16px;
            animation: blink 1s infinite;
            margin-right: 5px;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .dos-button {
            background-color: #000;
            color: white;
            border: 1px solid white;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .dos-button:hover {
            background-color: #0f0;
            color: #000;
        }
        
        .dos-button:active {
            background-color: #0a0;
            color: #000;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            border-top: 1px solid white;
            padding-top: 10px;
            font-size: 14px;
        }
        
        .player-stats {
            display: flex;
            gap: 15px;
        }
        
        .stat {
            color: #0ff;
        }
        
        .game-over {
            color: #f00;
            text-shadow: 0 0 5px #f00;
        }
        
        .combat-text {
            color: #f00;
        }
        
        .item-text {
            color: #ff0;
        }
        
        .location-text {
            color: #0af;
        }
        
        .command {
            color: white;
            font-weight: bold;
        }
        
        .xp-text {
            color: #f0f;
        }
        
        .inventory-item {
            color: #ff9d00;
        }
        
        .ability-text {
            color: #9dff00;
        }
        
        .achievement-text {
            color: #ff6bff;
            text-shadow: 0 0 3px #ff00ff;
        }
        
        .npc-text {
            color: #00ffaa;
        }
        
        .mini-game-text {
            color: #ffff00;
        }
        
        /* Sound Controls */
        .sound-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }
        
        .sound-btn {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 2px 5px;
            font-size: 10px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
        }
        
        .sound-btn:hover {
            background-color: #0f0;
            color: #000;
        }
        
        /* Scrollbar styling */
        .game-screen::-webkit-scrollbar {
            width: 10px;
        }
        
        .game-screen::-webkit-scrollbar-track {
            background: #000;
        }
        
        .game-screen::-webkit-scrollbar-thumb {
            background: #0a0;
            border: 1px solid #0f0;
        }
        
        .game-screen::-webkit-scrollbar-thumb:hover {
            background: #0f0;
        }
        
        @media (max-width: 850px) {
            .game-container {
                max-width: 95%;
                height: 90vh;
            }
            
            .button-container {
                flex-direction: column;
            }
            
            .dos-button {
                width: 100%;
            }
        }
        
        /* Fade animation for achievement notifications */
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Sound Controls -->
    <div class="sound-controls">
        <button class="sound-btn" id="musicToggle">MUSIC: ON</button>
        <button class="sound-btn" id="soundToggle">SFX: ON</button>
    </div>
    
    <div class="game-container">
        <div class="game-header">
            <div class="game-title">ETERNAL DOMINION</div>
            <div class="game-subtitle">Legacy of the Shattered Orb</div>
            <div>───────────────</div>
        </div>
        
        <div class="game-screen" id="gameScreen">
            <div class="game-text">Welcome to ETERNAL DOMINION: Legacy of the Shattered Orb</div>
            <div class="game-text">An age of despair in the realm of MYTHDRASIL.</div>
            <div class="game-text">ZYLON the Arch-Magus has forged the ORB OF PERPETUITY,</div>
            <div class="game-text">enshrouding the world in endless twilight.</div>
            <div class="game-text">Only a champion of destiny can overthrow him and reclaim the dawn.</div>
            <br>
            <div class="game-text prompt">Press START to begin your quest...</div>
        </div>
        
        <div class="button-container" id="buttonContainer">
            <button class="dos-button" id="startBtn">START GAME</button>
            <button class="dos-button" id="helpBtn">HELP</button>
            <button class="dos-button" id="creditsBtn">CREDITS</button>
        </div>
        
        <div class="status-bar" id="statusBar">
            <div class="player-stats">
                <div>Health: <span class="stat" id="health">100</span></div>
                <div>Strength: <span class="stat" id="strength">10</span></div>
                <div>Level: <span class="stat" id="level">1</span></div>
                <div>Gold: <span class="stat" id="gold">50</span></div>
            </div>
            <div>Location: <span class="stat" id="location">Title Screen</span></div>
        </div>
    </div>

    <script>
        // Sound System
        class GameAudio {
            constructor() {
                this.audioContext = null;
                this.musicEnabled = true;
                this.sfxEnabled = true;
                this.mainThemeSource = null;
                this.mainThemePlaying = false;
                
                this.initAudioContext();
                this.setupEventListeners();
            }
            
            initAudioContext() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log("Web Audio API is not supported in this browser");
                }
            }
            
            setupEventListeners() {
                const musicToggle = document.getElementById('musicToggle');
                const soundToggle = document.getElementById('soundToggle');
                
                musicToggle.addEventListener('click', () => {
                    this.musicEnabled = !this.musicEnabled;
                    musicToggle.textContent = `MUSIC: ${this.musicEnabled ? 'ON' : 'OFF'}`;
                    
                    if (!this.musicEnabled && this.mainThemePlaying) {
                        this.stopMainTheme();
                    } else if (this.musicEnabled && gameState.screen === "title" && !this.mainThemePlaying) {
                        this.playMainTheme();
                    }
                });
                
                soundToggle.addEventListener('click', () => {
                    this.sfxEnabled = !this.sfxEnabled;
                    soundToggle.textContent = `SFX: ${this.sfxEnabled ? 'ON' : 'OFF'}`;
                });
            }
            
            // Button click sound
            playButtonClick() {
                if (!this.sfxEnabled || !this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'square';
                
                gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
                
                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + 0.1);
            }
            
            // Notification sound (achievements, level up, etc.)
            playNotification(type = 'generic') {
                if (!this.sfxEnabled || !this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                switch(type) {
                    case 'achievement':
                        oscillator.frequency.setValueAtTime(523.25, this.audioContext.currentTime); // C5
                        oscillator.frequency.setValueAtTime(659.25, this.audioContext.currentTime + 0.1); // E5
                        oscillator.frequency.setValueAtTime(783.99, this.audioContext.currentTime + 0.2); // G5
                        oscillator.type = 'sine';
                        break;
                    case 'level':
                        oscillator.frequency.setValueAtTime(392.00, this.audioContext.currentTime); // G4
                        oscillator.frequency.setValueAtTime(523.25, this.audioContext.currentTime + 0.1); // C5
                        oscillator.frequency.setValueAtTime(659.25, this.audioContext.currentTime + 0.2); // E5
                        oscillator.frequency.setValueAtTime(783.99, this.audioContext.currentTime + 0.3); // G5
                        oscillator.type = 'sawtooth';
                        break;
                    case 'item':
                        oscillator.frequency.setValueAtTime(659.25, this.audioContext.currentTime); // E5
                        oscillator.frequency.setValueAtTime(830.61, this.audioContext.currentTime + 0.05); // G#5
                        oscillator.type = 'triangle';
                        break;
                    default:
                        oscillator.frequency.value = 1000;
                        oscillator.type = 'sine';
                }
                
                gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.4);
                
                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + 0.4);
            }
            
            // Combat sounds
            playCombatSound(type) {
                if (!this.sfxEnabled || !this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                switch(type) {
                    case 'attack':
                        oscillator.frequency.value = 200 + Math.random() * 100;
                        oscillator.type = 'sawtooth';
                        gainNode.gain.setValueAtTime(0.15, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
                        oscillator.start();
                        oscillator.stop(this.audioContext.currentTime + 0.2);
                        break;
                        
                    case 'power_attack':
                        oscillator.frequency.value = 150;
                        oscillator.frequency.exponentialRampToValueAtTime(400, this.audioContext.currentTime + 0.3);
                        oscillator.type = 'sawtooth';
                        gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                        oscillator.start();
                        oscillator.stop(this.audioContext.currentTime + 0.3);
                        break;
                        
                    case 'enemy_attack':
                        oscillator.frequency.value = 80 + Math.random() * 50;
                        oscillator.type = 'square';
                        gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                        oscillator.start();
                        oscillator.stop(this.audioContext.currentTime + 0.3);
                        break;
                        
                    case 'hit':
                        oscillator.frequency.value = 100 + Math.random() * 50;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.25, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
                        oscillator.start();
                        oscillator.stop(this.audioContext.currentTime + 0.1);
                        break;
                        
                    case 'defend':
                        oscillator.frequency.value = 300;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
                        oscillator.start();
                        oscillator.stop(this.audioContext.currentTime + 0.5);
                        break;
                        
                    case 'victory':
                        // Play a victory fanfare
                        const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                        let time = this.audioContext.currentTime;
                        
                        notes.forEach((freq, index) => {
                            setTimeout(() => {
                                const osc = this.audioContext.createOscillator();
                                const gain = this.audioContext.createGain();
                                osc.connect(gain);
                                gain.connect(this.audioContext.destination);
                                osc.frequency.value = freq;
                                osc.type = 'sine';
                                gain.gain.setValueAtTime(0.2, this.audioContext.currentTime);
                                gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
                                osc.start();
                                osc.stop(this.audioContext.currentTime + 0.2);
                            }, index * 100);
                        });
                        break;
                        
                    case 'defeat':
                        oscillator.frequency.value = 110;
                        oscillator.type = 'sawtooth';
                        gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 1);
                        oscillator.start();
                        oscillator.stop(this.audioContext.currentTime + 1);
                        break;
                }
            }
            
            // Main theme music (plays only on title screen)
            playMainTheme() {
                if (!this.musicEnabled || !this.audioContext || this.mainThemePlaying) return;
                
                this.mainThemePlaying = true;
                const oscillator1 = this.audioContext.createOscillator();
                const oscillator2 = this.audioContext.createOscillator();
                const gainNode1 = this.audioContext.createGain();
                const gainNode2 = this.audioContext.createGain();
                
                oscillator1.connect(gainNode1);
                oscillator2.connect(gainNode2);
                gainNode1.connect(this.audioContext.destination);
                gainNode2.connect(this.audioContext.destination);
                
                // Epic fantasy theme using two oscillators
                oscillator1.type = 'sawtooth';
                oscillator2.type = 'triangle';
                
                // Store source for stopping
                this.mainThemeSource = { osc1: oscillator1, osc2: oscillator2, gain1: gainNode1, gain2: gainNode2 };
                
                // Melody pattern
                const melody = [
                    { freq: 261.63, duration: 0.5 }, // C4
                    { freq: 329.63, duration: 0.5 }, // E4
                    { freq: 392.00, duration: 0.5 }, // G4
                    { freq: 523.25, duration: 0.5 }, // C5
                    { freq: 392.00, duration: 0.5 }, // G4
                    { freq: 329.63, duration: 0.5 }, // E4
                    { freq: 261.63, duration: 1.0 }  // C4
                ];
                
                // Bass pattern
                const bass = [
                    { freq: 130.81, duration: 0.5 }, // C3
                    { freq: 164.81, duration: 0.5 }, // E3
                    { freq: 196.00, duration: 0.5 }, // G3
                    { freq: 130.81, duration: 0.5 }, // C3
                    { freq: 164.81, duration: 0.5 }, // E3
                    { freq: 196.00, duration: 0.5 }, // G3
                    { freq: 130.81, duration: 1.0 }  // C3
                ];
                
                let currentTime = this.audioContext.currentTime;
                
                // Schedule the melody to loop
                const playMelody = () => {
                    melody.forEach((note, index) => {
                        const startTime = currentTime + (index * 0.5);
                        oscillator1.frequency.setValueAtTime(note.freq, startTime);
                    });
                    
                    bass.forEach((note, index) => {
                        const startTime = currentTime + (index * 0.5);
                        oscillator2.frequency.setValueAtTime(note.freq, startTime);
                    });
                    
                    // Loop after melody completes
                    currentTime += 3.5; // Total duration of melody
                    setTimeout(() => {
                        if (this.mainThemePlaying) {
                            playMelody();
                        }
                    }, 3500);
                };
                
                // Start with gain at 0 and fade in
                gainNode1.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode1.gain.linearRampToValueAtTime(0.05, this.audioContext.currentTime + 1);
                
                gainNode2.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode2.gain.linearRampToValueAtTime(0.03, this.audioContext.currentTime + 1);
                
                oscillator1.start();
                oscillator2.start();
                playMelody();
            }
            
            stopMainTheme() {
                if (this.mainThemeSource && this.mainThemePlaying) {
                    // Fade out before stopping
                    this.mainThemeSource.gain1.gain.setValueAtTime(this.mainThemeSource.gain1.gain.value, this.audioContext.currentTime);
                    this.mainThemeSource.gain1.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 1);
                    
                    this.mainThemeSource.gain2.gain.setValueAtTime(this.mainThemeSource.gain2.gain.value, this.audioContext.currentTime);
                    this.mainThemeSource.gain2.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 1);
                    
                    setTimeout(() => {
                        if (this.mainThemeSource) {
                            this.mainThemeSource.osc1.stop();
                            this.mainThemeSource.osc2.stop();
                            this.mainThemePlaying = false;
                            this.mainThemeSource = null;
                        }
                    }, 1000);
                }
            }
            
            // Pause/resume main theme based on screen
            updateMusicForScreen(screen) {
                if (screen === "title" && !this.mainThemePlaying && this.musicEnabled) {
                    this.playMainTheme();
                } else if (screen !== "title" && this.mainThemePlaying) {
                    this.stopMainTheme();
                }
            }
        }

        // Initialize audio system
        const gameAudio = new GameAudio();

        // Game state
        const gameState = {
            screen: "title",
            player: {
                name: "",
                health: 100,
                maxHealth: 100,
                strength: 10,
                dexterity: 10,
                intelligence: 10,
                gold: 50,
                experience: 0,
                nextLevelExp: 100,
                level: 1,
                weapon: "Iron Dagger",
                armor: "Leather Jerkin",
                location: "Kingsreach",
                quest: 0,
                inventory: ["Healing Salve", "Healing Salve", "Oil Lamp"],
                inventoryLimit: 10,
                abilities: [],
                combatStance: "balanced",
                achievements: [],
                milestones: {
                    levelsReached: [],
                    questsCompleted: 0,
                    dungeonsCleared: 0,
                    townsVisited: ["Kingsreach"],
                    enemiesDefeated: 0,
                    miniGamesWon: 0,
                    fishingAttempts: 0,
                    gamblingAttempts: 0,
                    huntingAttempts: 0,
                    arenaFights: 0
                },
                counterReady: false,
                defenseBoost: false
            },
            // NPC System
            npcs: [
                { 
                    name: "Captain Alden", 
                    location: "Kingsreach", 
                    relationship: 10,
                    questsGiven: 0,
                    shopDiscount: 0,
                    specialOffers: ["Royal Saber", "Imperial Armor"],
                    dialogue: [
                        "Hail, traveler! The kingdom needs brave souls like you.",
                        "I've heard reports of bandits on the eastern road.",
                        "If you prove yourself, I might have a special reward for you.",
                        "Strength and honor, friend. Strength and honor."
                    ]
                },
                { 
                    name: "Merchant Galen", 
                    location: "Tradewind", 
                    relationship: 5,
                    questsGiven: 0,
                    shopDiscount: 0,
                    specialOffers: ["Rare Elixir", "Magic Compass"],
                    dialogue: [
                        "Fine wares for fine folk! What can I interest you in?",
                        "Business is good, but competition is fierce.",
                        "I remember when trade flowed freely across the realm.",
                        "A shrewd investor could make a fortune in these times."
                    ]
                },
                { 
                    name: "Old Seer Mara", 
                    location: "Highpeak", 
                    relationship: 0,
                    questsGiven: 0,
                    shopDiscount: 0,
                    specialOffers: ["Vision Crystal", "Prophetic Scroll"],
                    dialogue: [
                        "The stars whisper of your coming...",
                        "I see darkness in your path, but also great light.",
                        "Bring me a vision crystal and I shall reveal more.",
                        "The Orb's power corrupts all it touches."
                    ]
                },
                { 
                    name: "Smuggler Finn", 
                    location: "Cutlass Bay", 
                    relationship: -10,
                    questsGiven: 0,
                    shopDiscount: 0,
                    specialOffers: ["Lockpicks", "Smuggled Goods"],
                    dialogue: [
                        "What's yer business here? Keep it quiet.",
                        "I might have work for someone discreet.",
                        "The guards don't bother me... for a price.",
                        "Seen anything valuable on your travels?"
                    ]
                },
                { 
                    name: "Archivist Lorne", 
                    location: "Moonstone", 
                    relationship: 15,
                    questsGiven: 0,
                    shopDiscount: 5,
                    specialOffers: ["Ancient Tome", "Scholar's Quill"],
                    dialogue: [
                        "Knowledge is the true power in this world.",
                        "Have you visited the ruins near Elderwood?",
                        "The Orb's history is recorded in our oldest texts.",
                        "A curious mind is a treasure beyond gold."
                    ]
                }
            ],
            // Mini-Games System
            miniGames: {
                fishing: {
                    availableIn: ["Seahaven", "Cutlass Bay"],
                    difficulty: 5,
                    rewards: [
                        { name: "Common Fish", chance: 60, value: 5 },
                        { name: "Rare Fish", chance: 25, value: 20 },
                        { name: "Golden Fish", chance: 10, value: 50 },
                        { name: "Old Boot", chance: 5, value: 1 }
                    ]
                },
                gambling: {
                    availableIn: ["Cutlass Bay", "Tradewind", "Ashenport"],
                    games: ["Dice Game", "Card Game", "Shell Game"],
                    minBet: 10,
                    maxBet: 100
                },
                hunting: {
                    availableIn: ["Elderwood", "Harvestide", "Wyrm's Rest"],
                    requiredStats: { strength: 8, dexterity: 10 },
                    prey: ["Deer", "Boar", "Mystical Beast"],
                    rewards: ["Venison", "Boar Hide", "Mystic Antler"]
                },
                arena: {
                    availableIn: ["Valor's Keep", "Bulwark"],
                    entryFee: 25,
                    rewards: [50, 100, 200],
                    opponents: ["Novice Warrior", "Seasoned Fighter", "Champion"]
                }
            },
            // Achievements System
            achievements: [
                { 
                    id: "first_blood", 
                    name: "First Blood", 
                    description: "Defeat your first enemy",
                    reward: "+2 Strength",
                    unlocked: false,
                    condition: (state) => state.player.milestones.enemiesDefeated >= 1
                },
                { 
                    id: "explorer", 
                    name: "Wanderer", 
                    description: "Visit 5 different towns",
                    reward: "+10% travel speed",
                    unlocked: false,
                    condition: (state) => state.player.milestones.townsVisited.length >= 5
                },
                { 
                    id: "merchant", 
                    name: "Merchant Apprentice", 
                    description: "Accumulate 500 gold",
                    reward: "5% discount in all shops",
                    unlocked: false,
                    condition: (state) => state.player.gold >= 500
                },
                { 
                    id: "dungeon_master", 
                    name: "Dungeon Delver", 
                    description: "Clear 3 dungeons",
                    reward: "+10 Health",
                    unlocked: false,
                    condition: (state) => state.player.milestones.dungeonsCleared >= 3
                },
                { 
                    id: "quest_complete", 
                    name: "Questing Knight", 
                    description: "Complete 5 town quests",
                    reward: "+5 to all stats",
                    unlocked: false,
                    condition: (state) => state.player.milestones.questsCompleted >= 5
                },
                { 
                    id: "dragon_slayer", 
                    name: "Dragon Slayer", 
                    description: "Defeat the Scale Drake",
                    reward: "Dragon's Blessing",
                    unlocked: false,
                    condition: (state) => state.player.achievements.includes("dragon_slayer")
                },
                { 
                    id: "town_hero", 
                    name: "Town Hero", 
                    description: "Reach 50 relationship with 3 NPCs",
                    reward: "Hero's Welcome",
                    unlocked: false,
                    condition: (state) => {
                        const highRelations = state.npcs.filter(npc => npc.relationship >= 50);
                        return highRelations.length >= 3;
                    }
                },
                { 
                    id: "mini_gamer", 
                    name: "Games Master", 
                    description: "Win at 3 different mini-games",
                    reward: "+10 Luck",
                    unlocked: false,
                    condition: (state) => state.player.milestones.miniGamesWon >= 3
                }
            ],
            // Milestone Rewards
            milestoneRewards: {
                levels: {
                    5: { reward: "Skill Point", message: "Reached Level 5! Gain +1 to any stat." },
                    10: { reward: "Master's Training", message: "Reached Level 10! Learn a new ability." },
                    15: { reward: "Legendary Item", message: "Reached Level 15! Choose a legendary item." }
                },
                quests: {
                    10: { reward: "Questmaster's Seal", message: "Completed 10 quests! Gain permanent +5% gold from quests." },
                    25: { reward: "Adventurer's Badge", message: "Completed 25 quests! All towns offer better rewards." }
                },
                dungeons: {
                    3: { reward: "Delver's Lantern", message: "Cleared 3 dungeons! Dungeon loot is now better." },
                    7: { reward: "Master Delver", message: "Cleared all dungeons! Become immune to dungeon traps." }
                }
            },
            world: {
                towns: [
                    { name: "Kingsreach", type: "imperial", shops: ["inn", "weapons", "armor", "arcane"], quest: "monarch", features: ["npc"] },
                    { name: "Moonstone", type: "scholarly", shops: ["inn", "arcane", "scriptorium"], quest: "archivist", features: ["npc"] },
                    { name: "Elderwood", type: "ancient", shops: ["inn", "weapons"], quest: "dendrite", features: ["hunting"] },
                    { name: "Ironhaven", type: "foundry", shops: ["inn", "armor", "forge"], quest: "smith", features: [] },
                    { name: "Valor's Keep", type: "chivalric", shops: ["inn", "weapons", "armor", "dojo"], quest: "paladin", features: ["arena"] },
                    { name: "Seahaven", type: "maritime", shops: ["inn", "fishing"], quest: "tidespeaker", features: ["fishing"] },
                    { name: "Ashenport", type: "ruined", shops: ["inn"], quest: "survivor", features: ["gambling"] },
                    { name: "Harvestide", type: "agrarian", shops: ["inn", "provisions"], quest: "yeoman", features: ["hunting"] },
                    { name: "Cutlass Bay", type: "corsair", shops: ["inn", "weapons", "grogshop"], quest: "privateer", features: ["fishing", "gambling", "npc"] },
                    { name: "Tradewind", type: "mercantile", shops: ["inn", "weapons", "armor", "arcane", "emporium"], quest: "factor", features: ["gambling", "npc"] },
                    { name: "Misthaven", type: "secluded", shops: ["inn", "curios"], quest: "anchorite", features: [] },
                    { name: "Highpeak", type: "aerie", shops: ["inn"], quest: "seer", features: ["npc"] },
                    { name: "Anchorhold", type: "naval", shops: ["inn", "ships", "weapons"], quest: "commodore", features: [] },
                    { name: "Bulwark", type: "bastion", shops: ["inn", "armor", "dojo"], quest: "marshal", features: ["arena"] },
                    { name: "Wyrm's Rest", type: "warrior", shops: ["inn", "weapons", "dojo"], quest: "champion", features: ["hunting"] }
                ],
                dungeons: [
                    { name: "Deception's Maw", level: 1, location: "near Elderwood", boss: "Stone Gorgon", reward: "Argent Blade" },
                    { name: "Contempt's Den", level: 2, location: "near Kingsreach", boss: "Bone Lich", reward: "Aegis of Warding" },
                    { name: "Avarice's Hold", level: 3, location: "far north", boss: "Scale Drake", reward: "Dragonhide Cuirass" },
                    { name: "Envy's Gullet", level: 2, location: "east of Ironhaven", boss: "Venom Weave", reward: "Spider-silk Mantle" },
                    { name: "Hubris' Fall", level: 4, location: "mountain pass", boss: "Shadow Balrog", reward: "Demonforged Claymore" },
                    { name: "Malice's Warren", level: 3, location: "boglands", boss: "Multi-headed Hydra", reward: "Hydra Crown" },
                    { name: "Perdition's Heart", level: 5, location: "isle of cinders", boss: "Zylon", reward: "Orb of Perpetuity" }
                ],
                wildernessEncounters: [
                    "marauders", "timber wolves", "dire rats", "fanghounds", "cave bears",
                    "road agents", "harpy flock", "serpent wyrms", "tusked boars", "wraiths"
                ]
            },
            enemies: [
                { name: "Gnasher", health: 20, maxHealth: 20, strength: 5, dexterity: 8, gold: 10, exp: 20, abilities: ["skewer"] },
                { name: "Brute", health: 35, maxHealth: 35, strength: 8, dexterity: 5, gold: 20, exp: 35, abilities: ["sunder"] },
                { name: "Cave Troll", health: 50, maxHealth: 50, strength: 12, dexterity: 3, gold: 35, exp: 50, abilities: ["mend flesh"] },
                { name: "Bonesoldier", health: 30, maxHealth: 30, strength: 10, dexterity: 6, gold: 25, exp: 30, abilities: ["calcify"] },
                { name: "Highwayman", health: 25, maxHealth: 25, strength: 7, dexterity: 9, gold: 15, exp: 25, abilities: ["sand throw"] },
                { name: "Spellweaver", health: 40, maxHealth: 40, strength: 5, dexterity: 7, gold: 40, exp: 45, abilities: ["arc bolt", "mend"] },
                { name: "Black Knight", health: 60, maxHealth: 60, strength: 15, dexterity: 10, gold: 50, exp: 60, abilities: ["shield slam", "fortify"] },
                { name: "Scale Drake", health: 120, maxHealth: 120, strength: 25, dexterity: 12, gold: 200, exp: 150, abilities: ["cinder breath", "tail lash", "terrify"] },
                { name: "Zylon", health: 150, maxHealth: 150, strength: 30, dexterity: 15, gold: 500, exp: 300, abilities: ["void lance", "soul siphon", "conjure thrall", "immortal guise"] }
            ],
            items: {
                weapons: [
                    { name: "Iron Dagger", price: 10, strength: 2, type: "weapon" },
                    { name: "Short Sword", price: 25, strength: 4, type: "weapon" },
                    { name: "Long Sword", price: 50, strength: 7, type: "weapon" },
                    { name: "Broad Sword", price: 80, strength: 10, type: "weapon" },
                    { name: "Argent Blade", price: 150, strength: 15, type: "weapon", special: "bans undead" },
                    { name: "Runeblade", price: 300, strength: 20, type: "weapon", special: "arcane edge" },
                    { name: "Drake Tooth", price: 500, strength: 25, type: "weapon", special: "flame tongue" }
                ],
                armors: [
                    { name: "Leather Jerkin", price: 15, defense: 5, type: "armor" },
                    { name: "Chain Hauberk", price: 40, defense: 10, type: "armor" },
                    { name: "Plate Cuirass", price: 100, defense: 15, type: "armor" },
                    { name: "Mageweave Robes", price: 120, defense: 12, type: "armor", special: "warding" },
                    { name: "Dragonhide Cuirass", price: 400, defense: 25, type: "armor", special: "cinderproof" }
                ],
                consumables: [
                    { name: "Healing Salve", price: 15, effect: "heal", value: 30, type: "consumable" },
                    { name: "Strength Elixir", price: 25, effect: "strength", value: 5, duration: 3, type: "consumable" },
                    { name: "Antivenom", price: 10, effect: "cure", value: 1, type: "consumable" },
                    { name: "Mana Draught", price: 30, effect: "mana", value: 20, type: "consumable" },
                    { name: "Smoke Puff", price: 20, effect: "escape", value: 90, type: "consumable" }
                ],
                questItems: [
                    { name: "Orb of Perpetuity", type: "quest", value: 1000 },
                    { name: "Royal Sigil", type: "quest", value: 100 },
                    { name: "Archivist's Codex", type: "quest", value: 200 },
                    { name: "Elderroot", type: "quest", value: 150 }
                ],
                giftItems: [
                    { name: "Fine Wine", price: 25, type: "gift", appeal: ["Captain Alden", "Merchant Galen"] },
                    { name: "Ancient Coin", price: 50, type: "gift", appeal: ["Archivist Lorne", "Old Seer Mara"] },
                    { name: "Smuggled Rum", price: 15, type: "gift", appeal: ["Smuggler Finn"] },
                    { name: "Herbal Tea", price: 10, type: "gift", appeal: ["Old Seer Mara", "Archivist Lorne"] }
                ]
            },
            currentEnemy: null,
            inCombat: false,
            buffs: [],
            currentGame: null
        };

        // DOM elements
        const gameScreen = document.getElementById('gameScreen');
        const buttonContainer = document.getElementById('buttonContainer');
        const statusBar = document.getElementById('statusBar');
        const healthElement = document.getElementById('health');
        const strengthElement = document.getElementById('strength');
        const levelElement = document.getElementById('level');
        const goldElement = document.getElementById('gold');
        const locationElement = document.getElementById('location');
        
        // Buttons
        const startBtn = document.getElementById('startBtn');
        const helpBtn = document.getElementById('helpBtn');
        const creditsBtn = document.getElementById('creditsBtn');
        
        // Initialize game
        function init() {
            // Add click sounds to all existing buttons
            startBtn.addEventListener('click', () => {
                gameAudio.playButtonClick();
                startGame();
            });
            helpBtn.addEventListener('click', () => {
                gameAudio.playButtonClick();
                showHelp();
            });
            creditsBtn.addEventListener('click', () => {
                gameAudio.playButtonClick();
                showCredits();
            });
            
            // Start main theme on title screen
            gameAudio.updateMusicForScreen("title");
            
            updateStatusBar();
        }
        
        // Update status bar with player stats
        function updateStatusBar() {
            healthElement.textContent = `${gameState.player.health}/${gameState.player.maxHealth}`;
            strengthElement.textContent = gameState.player.strength;
            levelElement.textContent = gameState.player.level;
            goldElement.textContent = gameState.player.gold;
            locationElement.textContent = gameState.player.location;
        }
        
        // Add text to game screen
        function addText(text, className = "") {
            const textElement = document.createElement('div');
            textElement.className = `game-text ${className}`;
            textElement.textContent = text;
            gameScreen.appendChild(textElement);
            gameScreen.scrollTop = gameScreen.scrollHeight;
        }
        
        // Clear the game screen
        function clearScreen() {
            gameScreen.innerHTML = '';
        }
        
        // Clear buttons
        function clearButtons() {
            buttonContainer.innerHTML = '';
        }
        
        // Add a button
        function addButton(text, action, id = "") {
            const button = document.createElement('button');
            button.className = 'dos-button';
            button.textContent = text;
            button.id = id;
            
            // Add click sound to button
            button.addEventListener('click', () => {
                gameAudio.playButtonClick();
                action();
            });
            
            buttonContainer.appendChild(button);
        }
        
        // Start the game
        function startGame() {
            clearScreen();
            clearButtons();
            gameState.screen = "character";
            
            // Stop main theme when leaving title screen
            gameAudio.updateMusicForScreen("character");
            
            addText("CHARACTER CREATION", "prompt");
            addText("What is your name, champion?");
            addText("(Type your name and press Enter)");
            
            // Create input field for character name
            const inputLine = document.createElement('div');
            inputLine.className = 'input-line';
            
            const cursor = document.createElement('div');
            cursor.className = 'cursor';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.style.background = 'black';
            input.style.color = '#0f0';
            input.style.border = 'none';
            input.style.outline = 'none';
            input.style.fontFamily = "'Courier New', monospace";
            input.style.fontSize = '16px';
            input.style.width = '200px';
            
            inputLine.appendChild(cursor);
            inputLine.appendChild(input);
            gameScreen.appendChild(inputLine);
            
            input.focus();
            
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    if (input.value.trim() !== "") {
                        gameState.player.name = input.value.trim();
                        gameAudio.playNotification('item');
                        createCharacter();
                    }
                }
            });
        }
        
        // Create character
        function createCharacter() {
            clearScreen();
            clearButtons();
            
            addText(`Hail, ${gameState.player.name}!`, "prompt");
            addText("You stand in the imperial city of Kingsreach, capital of Mythdrasil.");
            addText("The people whisper of Zylon's corruption spreading across the realm.");
            addText("The monarch has summoned heroes to seek the Orb of Perpetuity");
            addText("and overthrow the arch-magus Zylon.");
            addText("");
            addText("What would you like to do?");
            
            addButton("TOWN SQUARE", townSquare);
            addButton("INVENTORY", showInventory);
            addButton("CHARACTER", showCharacter);
            addButton("TRAVEL", travel);
            addButton("QUESTS", questInfo);
            addButton("ACHIEVEMENTS", showAchievements);
            
            gameState.screen = "main";
            updateStatusBar();
        }
        
        // Town square main hub
        function townSquare() {
            clearScreen();
            clearButtons();
            
            const currentTown = gameState.world.towns.find(t => t.name === gameState.player.location);
            
            addText(`${gameState.player.location.toUpperCase()} TOWN SQUARE`, "location-text");
            addText(`You are in the ${currentTown.type} town of ${gameState.player.location}.`);
            addText("");
            
            // Check for new town achievement
            if (!gameState.player.milestones.townsVisited.includes(gameState.player.location)) {
                gameState.player.milestones.townsVisited.push(gameState.player.location);
                checkAchievements();
            }
            
            // Show available shops based on town type
            currentTown.shops.forEach(shop => {
                switch(shop) {
                    case 'inn':
                        addButton("VISIT INN", visitInn);
                        break;
                    case 'weapons':
                        addButton("WEAPONSMITH", visitWeaponShop);
                        break;
                    case 'armor':
                        addButton("ARMORER", visitArmorShop);
                        break;
                    case 'arcane':
                        addButton("ARCANE BAZAAR", visitMagicShop);
                        break;
                    case 'dojo':
                        addButton("TRAINING DOJO", visitTraining);
                        break;
                    case 'emporium':
                        addButton("EMPORIUM", visitGeneralStore);
                        break;
                    case 'scriptorium':
                        addButton("SCRIPTORIUM", visitLibrary);
                        break;
                    case 'grogshop':
                        addButton("GROGSHOP", visitTavern);
                        break;
                    case 'fishing':
                        addButton("FISHING DOCK", visitFishingDock);
                        break;
                    case 'provisions':
                        addButton("PROVISIONS", visitProvisions);
                        break;
                    case 'curios':
                        addButton("CURIOS SHOP", visitCuriosShop);
                        break;
                    case 'ships':
                        addButton("SHIPYARD", visitShipyard);
                        break;
                    case 'forge':
                        addButton("FORGE", visitForge);
                        break;
                }
            });
            
            // Special town features (Mini-games & NPCs)
            if (currentTown.features && currentTown.features.length > 0) {
                currentTown.features.forEach(feature => {
                    switch(feature) {
                        case 'npc':
                            addButton("MEET LOCALS", showLocalNPCs);
                            break;
                        case 'fishing':
                            addButton("GO FISHING", startFishing);
                            break;
                        case 'gambling':
                            addButton("GAMBLING HALL", startGambling);
                            break;
                        case 'hunting':
                            addButton("HUNTING GROUNDS", startHunting);
                            break;
                        case 'arena':
                            addButton("FIGHTING ARENA", startArena);
                            break;
                    }
                });
            }
            
            // Special town quest
            addButton("TOWN QUEST", function() {
                startTownQuest(currentTown.quest);
            });
            
            addButton("EXPLORE DUNGEON", exploreDungeon);
            addButton("RETURN", createCharacter);
        }
        
        // Show local NPCs
        function showLocalNPCs() {
            clearScreen();
            clearButtons();
            
            const localNPCs = gameState.npcs.filter(npc => npc.location === gameState.player.location);
            
            if (localNPCs.length === 0) {
                addText("No notable locals here.", "npc-text");
                addButton("BACK", townSquare);
                return;
            }
            
            addText("LOCAL PERSONALITIES", "npc-text");
            addText("──────────────────");
            
            localNPCs.forEach(npc => {
                // Display relationship status
                let relationStatus = "Neutral";
                if (npc.relationship >= 50) relationStatus = "Friendly";
                else if (npc.relationship >= 20) relationStatus = "Acquainted";
                else if (npc.relationship <= -20) relationStatus = "Hostile";
                else if (npc.relationship <= -10) relationStatus = "Suspicious";
                
                addText(`${npc.name} - ${relationStatus} (${npc.relationship})`);
                
                addButton(`TALK TO ${npc.name.split(' ')[0]}`, function() {
                    talkToNPC(npc);
                });
            });
            
            addButton("BACK", townSquare);
        }
        
        // Talk to NPC
        function talkToNPC(npc) {
            clearScreen();
            clearButtons();
            
            addText(`CONVERSATION WITH ${npc.name.toUpperCase()}`, "npc-text");
            addText("─────────────────────────────");
            
            // Random dialogue based on relationship
            let dialogueIndex;
            if (npc.relationship >= 50) {
                dialogueIndex = 3; // Friendly dialogue
            } else if (npc.relationship >= 20) {
                dialogueIndex = 2; // Acquainted dialogue
            } else if (npc.relationship <= -20) {
                dialogueIndex = 1; // Hostile dialogue
            } else {
                dialogueIndex = Math.floor(Math.random() * npc.dialogue.length);
            }
            
            addText(`"${npc.dialogue[dialogueIndex]}"`);
            addText("");
            
            // Small relationship increase for talking
            if (npc.relationship < 50) {
                npc.relationship += 2;
                addText(`Relationship with ${npc.name} increased slightly.`, "npc-text");
            }
            
            // Options based on relationship
            addButton("CONTINUE TALKING", function() {
                continueTalking(npc);
            });
            
            if (npc.relationship >= 20) {
                addButton("ASK ABOUT SPECIAL ITEMS", function() {
                    showSpecialOffers(npc);
                });
            }
            
            if (npc.relationship >= 10 && npc.name !== "Smuggler Finn") {
                addButton("OFFER GIFT", function() {
                    offerGift(npc);
                });
            }
            
            if (npc.relationship >= 30 && npc.questsGiven < 3) {
                addButton("ASK FOR WORK", function() {
                    npcQuest(npc);
                });
            }
            
            addButton("END CONVERSATION", showLocalNPCs);
            
            checkAchievements();
        }
        
        // Continue talking with NPC
        function continueTalking(npc) {
            clearScreen();
            clearButtons();
            
            addText(`CONVERSATION WITH ${npc.name.toUpperCase()}`, "npc-text");
            addText("─────────────────────────────");
            
            // Get another random dialogue line
            const usedDialogue = [];
            let newDialogue;
            do {
                newDialogue = npc.dialogue[Math.floor(Math.random() * npc.dialogue.length)];
            } while (usedDialogue.includes(newDialogue) && usedDialogue.length < npc.dialogue.length - 1);
            
            addText(`"${newDialogue}"`);
            addText("");
            
            // Relationship increase
            npc.relationship += 1;
            addText(`Relationship with ${npc.name} improved.`, "npc-text");
            
            addButton("CONTINUE", function() {
                talkToNPC(npc);
            });
            addButton("END", showLocalNPCs);
        }
        
        // Show special offers from NPC
        function showSpecialOffers(npc) {
            clearScreen();
            clearButtons();
            
            addText(`${npc.name}'S SPECIAL OFFERS`, "npc-text");
            addText("─────────────────────────");
            
            if (npc.specialOffers.length === 0) {
                addText("I have nothing special at the moment.");
                addButton("BACK", function() {
                    talkToNPC(npc);
                });
                return;
            }
            
            npc.specialOffers.forEach(offer => {
                addText(`• ${offer}`);
            });
            
            addText("");
            addText(`Your relationship: ${npc.relationship}/100`);
            
            if (npc.relationship >= 75) {
                addText("You can purchase these items with a 15% discount!", "item-text");
            } else if (npc.relationship >= 50) {
                addText("You get a 10% discount on all purchases.", "item-text");
            }
            
            addButton("PURCHASE ITEM", function() {
                purchaseFromNPC(npc);
            });
            
            addButton("BACK", function() {
                talkToNPC(npc);
            });
        }
        
        // Purchase from NPC
        function purchaseFromNPC(npc) {
            clearScreen();
            clearButtons();
            
            addText("PURCHASE SPECIAL ITEM", "npc-text");
            
            npc.specialOffers.forEach((offer, index) => {
                const basePrice = 100 + (index * 50);
                const discount = npc.relationship >= 75 ? 0.15 : npc.relationship >= 50 ? 0.10 : 0;
                const finalPrice = Math.floor(basePrice * (1 - discount));
                
                addText(`${offer}: ${finalPrice} gold`);
                
                addButton(`BUY ${offer}`, function() {
                    if (gameState.player.gold >= finalPrice) {
                        gameState.player.gold -= finalPrice;
                        
                        if (!gameState.player.inventory.includes(offer) && 
                            gameState.player.inventory.length < gameState.player.inventoryLimit) {
                            gameState.player.inventory.push(offer);
                            addText(`You purchased ${offer} from ${npc.name}.`, "item-text");
                            npc.relationship += 5;
                            gameAudio.playNotification('item');
                        } else {
                            addText("Your inventory is full!", "combat-text");
                            gameState.player.gold += finalPrice;
                        }
                        
                        updateStatusBar();
                        setTimeout(() => showSpecialOffers(npc), 1500);
                    } else {
                        addText("Not enough gold!", "combat-text");
                        setTimeout(() => showSpecialOffers(npc), 1500);
                    }
                });
            });
            
            addButton("BACK", function() {
                showSpecialOffers(npc);
            });
        }
        
        // Offer gift to NPC
        function offerGift(npc) {
            clearScreen();
            clearButtons();
            
            addText("SELECT A GIFT FOR " + npc.name.toUpperCase(), "npc-text");
            addText("─────────────────────────────");
            
            const availableGifts = gameState.items.giftItems.filter(gift => 
                gift.appeal.includes(npc.name)
            );
            
            if (availableGifts.length === 0) {
                addText("You have no suitable gifts for this person.");
                addButton("BACK", function() {
                    talkToNPC(npc);
                });
                return;
            }
            
            // Check what gifts player has
            const playerGifts = [];
            gameState.player.inventory.forEach(item => {
                const gift = availableGifts.find(g => g.name === item);
                if (gift) playerGifts.push(gift);
            });
            
            if (playerGifts.length === 0) {
                addText("You don't have any gifts that this person would appreciate.");
                addButton("BACK", function() {
                    talkToNPC(npc);
                });
                return;
            }
            
            playerGifts.forEach(gift => {
                addButton(`GIVE ${gift.name}`, function() {
                    // Remove from inventory
                    const index = gameState.player.inventory.indexOf(gift.name);
                    if (index > -1) {
                        gameState.player.inventory.splice(index, 1);
                    }
                    
                    // Calculate relationship boost
                    let boost = 10;
                    if (npc.relationship < 0) boost = 20;
                    
                    npc.relationship += boost;
                    addText(`${npc.name} appreciates your gift!`, "npc-text");
                    addText(`Relationship increased by ${boost}.`, "npc-text");
                    
                    gameAudio.playNotification('item');
                    
                    setTimeout(() => talkToNPC(npc), 1500);
                });
            });
            
            addButton("BACK", function() {
                talkToNPC(npc);
            });
        }
        
        // NPC Quest
        function npcQuest(npc) {
            clearScreen();
            clearButtons();
            
            addText(`${npc.name.toUpperCase()}'S REQUEST`, "npc-text");
            addText("─────────────────────");
            
            npc.questsGiven++;
            
            const quests = {
                "Captain Alden": {
                    description: "Patrol the outskirts of town and deal with any threats.",
                    reward: 75,
                    enemy: "Highwayman",
                    relationshipReward: 15
                },
                "Merchant Galen": {
                    description: "Escort a trade caravan to the next town.",
                    reward: 100,
                    enemy: "Brute",
                    relationshipReward: 10
                },
                "Old Seer Mara": {
                    description: "Retrieve a vision crystal from the nearby caves.",
                    reward: 60,
                    enemy: "Spellweaver",
                    relationshipReward: 20
                },
                "Smuggler Finn": {
                    description: "Deliver a 'package' without getting caught.",
                    reward: 150,
                    enemy: "Gnasher",
                    relationshipReward: 25
                },
                "Archivist Lorne": {
                    description: "Recover ancient texts from a ruined library.",
                    reward: 80,
                    enemy: "Bonesoldier",
                    relationshipReward: 10
                }
            };
            
            const quest = quests[npc.name] || quests["Captain Alden"];
            
            addText(quest.description);
            addText("");
            addText(`Reward: ${quest.reward} gold`);
            addText(`Relationship Bonus: +${quest.relationshipReward}`);
            
            addButton("ACCEPT QUEST", function() {
                addText("");
                addText("You accept the quest...");
                
                // Start combat with quest enemy
                const enemyTemplate = gameState.enemies.find(e => e.name === quest.enemy);
                gameState.currentEnemy = {...enemyTemplate};
                gameState.inCombat = true;
                gameState.currentEnemy.npcQuest = true;
                gameState.currentEnemy.questReward = quest.reward;
                gameState.currentEnemy.relationshipReward = quest.relationshipReward;
                gameState.currentEnemy.questGiver = npc;
                
                setTimeout(() => {
                    clearScreen();
                    addText(`While completing the quest, you encounter a ${gameState.currentEnemy.name}!`, "combat-text");
                    addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                    showCombatOptions();
                }, 1500);
            });
            
            addButton("DECLINE", function() {
                npc.relationship -= 5;
                addText(`${npc.name} is disappointed.`, "npc-text");
                setTimeout(() => talkToNPC(npc), 1500);
            });
        }
        
        // Start fishing mini-game
        function startFishing() {
            clearScreen();
            clearButtons();
            
            gameState.currentGame = "fishing";
            gameState.player.milestones.fishingAttempts++;
            
            addText("FISHING MINI-GAME", "mini-game-text");
            addText("─────────────────");
            addText("You cast your line into the water...");
            addText("");
            addText("Press the button when you feel a bite!");
            
            // Random wait time
            const waitTime = Math.floor(Math.random() * 3000) + 1000;
            
            addButton("WAIT FOR BITE", function() {
                clearScreen();
                addText("Waiting for a bite...", "mini-game-text");
                
                setTimeout(() => {
                    clearScreen();
                    addText("A BITE! Quick, reel it in!", "mini-game-text");
                    
                    // Quick time event
                    const reelTime = Date.now();
                    
                    addButton("REEL IN!", function() {
                        const reactionTime = Date.now() - reelTime;
                        
                        clearScreen();
                        
                        if (reactionTime < 800) {
                            // Success
                            const reward = getFishingReward();
                            addText("Success! You caught something!", "mini-game-text");
                            addText(`You caught: ${reward.name}`, "item-text");
                            
                            if (reward.name !== "Old Boot") {
                                if (gameState.player.inventory.length < gameState.player.inventoryLimit) {
                                    gameState.player.inventory.push(reward.name);
                                }
                                gameState.player.gold += reward.value;
                                gameState.player.milestones.miniGamesWon++;
                                checkAchievements();
                                gameAudio.playNotification('item');
                            }
                            
                            updateStatusBar();
                        } else {
                            addText("Too slow! The fish got away.", "mini-game-text");
                        }
                        
                        addButton("FISH AGAIN", startFishing);
                        addButton("STOP FISHING", townSquare);
                    });
                }, waitTime);
            });
            
            addButton("STOP FISHING", townSquare);
        }
        
        // Get fishing reward
        function getFishingReward() {
            const rand = Math.random() * 100;
            let cumulative = 0;
            
            for (const reward of gameState.miniGames.fishing.rewards) {
                cumulative += reward.chance;
                if (rand <= cumulative) {
                    return reward;
                }
            }
            
            return gameState.miniGames.fishing.rewards[0];
        }
        
        // Start gambling mini-game
        function startGambling() {
            clearScreen();
            clearButtons();
            
            gameState.currentGame = "gambling";
            gameState.player.milestones.gamblingAttempts++;
            
            addText("GAMBLING HALL", "mini-game-text");
            addText("──────────────");
            addText(`You have ${gameState.player.gold} gold.`);
            addText("Choose a game:");
            
            gameState.miniGames.gambling.games.forEach(game => {
                addButton(game.toUpperCase(), function() {
                    selectBet(game);
                });
            });
            
            addButton("LEAVE", townSquare);
        }
        
        // Select bet amount
        function selectBet(game) {
            clearScreen();
            clearButtons();
            
            addText(game.toUpperCase(), "mini-game-text");
            addText("──────────");
            addText(`You have ${gameState.player.gold} gold.`);
            addText(`Minimum bet: ${gameState.miniGames.gambling.minBet} gold`);
            addText(`Maximum bet: ${gameState.miniGames.gambling.maxBet} gold`);
            
            // Common bet amounts
            const betAmounts = [10, 25, 50, 100].filter(amount => 
                amount <= gameState.miniGames.gambling.maxBet && 
                amount >= gameState.miniGames.gambling.minBet
            );
            
            betAmounts.forEach(amount => {
                if (gameState.player.gold >= amount) {
                    addButton(`BET ${amount} GOLD`, function() {
                        playGamblingGame(game, amount);
                    });
                }
            });
            
            addButton("BACK", startGambling);
        }
        
        // Play gambling game
        function playGamblingGame(game, bet) {
            clearScreen();
            clearButtons();
            
            addText(`Playing ${game}`, "mini-game-text");
            addText(`Bet: ${bet} gold`, "mini-game-text");
            addText("");
            
            // Simple game logic
            const playerRoll = Math.floor(Math.random() * 20) + 1;
            const houseRoll = Math.floor(Math.random() * 18) + 1;
            
            addText(`Your roll: ${playerRoll}`);
            addText(`House roll: ${houseRoll}`);
            
            if (playerRoll > houseRoll) {
                const winnings = bet * 2;
                gameState.player.gold += winnings;
                addText(`You win ${winnings} gold!`, "item-text");
                gameState.player.milestones.miniGamesWon++;
                checkAchievements();
                gameAudio.playNotification('item');
            } else if (playerRoll === houseRoll) {
                addText("It's a tie! Your bet is returned.", "mini-game-text");
            } else {
                gameState.player.gold -= bet;
                addText(`You lose ${bet} gold.`, "combat-text");
            }
            
            updateStatusBar();
            
            addButton("PLAY AGAIN", function() {
                if (gameState.player.gold >= gameState.miniGames.gambling.minBet) {
                    selectBet(game);
                } else {
                    addText("You don't have enough gold to play.");
                    addButton("LEAVE", townSquare);
                }
            });
            
            addButton("CASH OUT", startGambling);
        }
        
        // Start hunting mini-game
        function startHunting() {
            clearScreen();
            clearButtons();
            
            // Check if player has required stats
            if (gameState.player.strength < 8 || gameState.player.dexterity < 10) {
                addText("HUNTING GROUNDS", "mini-game-text");
                addText("───────────────");
                addText("You're not strong or agile enough to hunt.");
                addText("Come back when you're stronger (Str 8, Dex 10).");
                addButton("BACK", townSquare);
                return;
            }
            
            gameState.currentGame = "hunting";
            gameState.player.milestones.huntingAttempts++;
            
            addText("HUNTING GROUNDS", "mini-game-text");
            addText("───────────────");
            addText("You track prey through the wilderness...");
            
            addButton("TRACK PREY", function() {
                clearScreen();
                addText("You spot a target!", "mini-game-text");
                
                const prey = gameState.miniGames.hunting.prey[Math.floor(Math.random() * gameState.miniGames.hunting.prey.length)];
                addText(`You see a ${prey} in the distance.`);
                
                // Hunting challenge
                const huntDifficulty = 10;
                const playerSkill = Math.floor((gameState.player.strength + gameState.player.dexterity) / 2);
                
                addButton("TAKE THE SHOT", function() {
                    clearScreen();
                    
                    const successChance = (playerSkill / huntDifficulty) * 100;
                    const roll = Math.random() * 100;
                    
                    if (roll <= successChance) {
                        const preyIndex = gameState.miniGames.hunting.prey.indexOf(prey);
                        const reward = gameState.miniGames.hunting.rewards[preyIndex];
                        addText("Excellent shot! You hit your target.", "mini-game-text");
                        addText(`You harvest: ${reward}`, "item-text");
                        
                        if (gameState.player.inventory.length < gameState.player.inventoryLimit) {
                            gameState.player.inventory.push(reward);
                        }
                        
                        // Can sell for good money
                        const goldReward = 15 * (preyIndex + 1);
                        gameState.player.gold += goldReward;
                        addText(`You can sell this for ${goldReward} gold.`, "item-text");
                        
                        gameState.player.milestones.miniGamesWon++;
                        checkAchievements();
                        gameAudio.playNotification('item');
                        
                        updateStatusBar();
                    } else {
                        addText("You missed! The prey escapes.", "mini-game-text");
                    }
                    
                    addButton("HUNT AGAIN", startHunting);
                    addButton("STOP HUNTING", townSquare);
                });
                
                addButton("LET IT GO", function() {
                    addText("You let the animal go.", "mini-game-text");
                    addButton("HUNT AGAIN", startHunting);
                    addButton("STOP HUNTING", townSquare);
                });
            });
            
            addButton("STOP HUNTING", townSquare);
        }
        
        // Start arena mini-game
        function startArena() {
            clearScreen();
            clearButtons();
            
            gameState.currentGame = "arena";
            
            addText("FIGHTING ARENA", "mini-game-text");
            addText("───────────────");
            addText("Prove your worth in combat!");
            addText(`Entry fee: ${gameState.miniGames.arena.entryFee} gold`);
            
            if (gameState.player.gold < gameState.miniGames.arena.entryFee) {
                addText("You don't have enough gold for the entry fee.");
                addButton("BACK", townSquare);
                return;
            }
            
            gameState.miniGames.arena.opponents.forEach((opponent, index) => {
                const reward = gameState.miniGames.arena.rewards[index];
                addButton(`FIGHT ${opponent} (Win: ${reward} gold)`, function() {
                    confirmArenaFight(index);
                });
            });
            
            addButton("BACK", townSquare);
        }
        
        // Confirm arena fight
        function confirmArenaFight(opponentIndex) {
            clearScreen();
            clearButtons();
            
            const opponent = gameState.miniGames.arena.opponents[opponentIndex];
            const reward = gameState.miniGames.arena.rewards[opponentIndex];
            
            addText(`CHALLENGE: ${opponent}`, "mini-game-text");
            addText(`Entry fee: ${gameState.miniGames.arena.entryFee} gold`);
            addText(`Potential reward: ${reward} gold`);
            
            addButton("ACCEPT CHALLENGE", function() {
                if (gameState.player.gold >= gameState.miniGames.arena.entryFee) {
                    gameState.player.gold -= gameState.miniGames.arena.entryFee;
                    updateStatusBar();
                    
                    // Start arena combat
                    startArenaCombat(opponentIndex);
                } else {
                    addText("You don't have enough gold.");
                    addButton("BACK", startArena);
                }
            });
            
            addButton("BACK", startArena);
        }
        
        // Start arena combat
        function startArenaCombat(opponentIndex) {
            clearScreen();
            
            const opponent = gameState.miniGames.arena.opponents[opponentIndex];
            const reward = gameState.miniGames.arena.rewards[opponentIndex];
            
            // Create arena enemy based on opponent
            let enemyTemplate;
            switch(opponentIndex) {
                case 0:
                    enemyTemplate = gameState.enemies.find(e => e.name === "Gnasher");
                    break;
                case 1:
                    enemyTemplate = gameState.enemies.find(e => e.name === "Black Knight");
                    break;
                case 2:
                    enemyTemplate = gameState.enemies.find(e => e.name === "Scale Drake");
                    break;
                default:
                    enemyTemplate = gameState.enemies[0];
            }
            
            gameState.currentEnemy = {...enemyTemplate};
            gameState.currentEnemy.arenaOpponent = true;
            gameState.currentEnemy.arenaReward = reward;
            gameState.currentEnemy.arenaIndex = opponentIndex;
            gameState.inCombat = true;
            
            addText(`ARENA FIGHT: ${opponent}`, "mini-game-text");
            addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
            
            showCombatOptions();
        }
        
        // Show achievements
        function showAchievements() {
            clearScreen();
            clearButtons();
            
            addText("ACHIEVEMENTS", "achievement-text");
            addText("───────────");
            
            const unlocked = gameState.achievements.filter(a => a.unlocked);
            const locked = gameState.achievements.filter(a => !a.unlocked);
            
            if (unlocked.length > 0) {
                addText("UNLOCKED:", "achievement-text");
                unlocked.forEach(achievement => {
                    addText(`✓ ${achievement.name}: ${achievement.description}`);
                    addText(`  Reward: ${achievement.reward}`);
                });
                addText("");
            }
            
            if (locked.length > 0) {
                addText("LOCKED:", "achievement-text");
                locked.forEach(achievement => {
                    addText(`□ ${achievement.name}: ${achievement.description}`);
                });
            }
            
            addText("");
            addText("MILESTONES:");
            addText(`Level: ${gameState.player.level}`);
            addText(`Towns Visited: ${gameState.player.milestones.townsVisited.length}/15`);
            addText(`Quests Completed: ${gameState.player.milestones.questsCompleted}`);
            addText(`Dungeons Cleared: ${gameState.player.milestones.dungeonsCleared}`);
            addText(`Enemies Defeated: ${gameState.player.milestones.enemiesDefeated}`);
            addText(`Mini-Games Won: ${gameState.player.milestones.miniGamesWon}`);
            
            addButton("BACK", createCharacter);
        }
        
        // Check and unlock achievements
        function checkAchievements() {
            let newAchievements = false;
            
            gameState.achievements.forEach(achievement => {
                if (!achievement.unlocked && achievement.condition(gameState)) {
                    achievement.unlocked = true;
                    
                    if (!gameState.player.achievements.includes(achievement.id)) {
                        gameState.player.achievements.push(achievement.id);
                        
                        // Play achievement sound
                        gameAudio.playNotification('achievement');
                        
                        // Show achievement notification
                        setTimeout(() => {
                            const notification = document.createElement('div');
                            notification.className = 'game-text achievement-text';
                            notification.textContent = `ACHIEVEMENT UNLOCKED: ${achievement.name}`;
                            notification.style.textAlign = 'center';
                            notification.style.border = '1px solid #ff6bff';
                            notification.style.padding = '5px';
                            notification.style.marginTop = '10px';
                            notification.style.animation = 'fadeOut 3s forwards';
                            
                            gameScreen.appendChild(notification);
                            gameScreen.scrollTop = gameScreen.scrollHeight;
                            
                            // Remove after animation
                            setTimeout(() => {
                                if (notification.parentNode) {
                                    notification.parentNode.removeChild(notification);
                                }
                            }, 3000);
                        }, 100);
                        
                        newAchievements = true;
                        
                        // Apply achievement rewards
                        applyAchievementReward(achievement);
                    }
                }
            });
            
            // Check milestone rewards
            checkMilestoneRewards();
            
            return newAchievements;
        }
        
        // Apply achievement reward
        function applyAchievementReward(achievement) {
            switch(achievement.id) {
                case "first_blood":
                    gameState.player.strength += 2;
                    addText(`You gained +2 Strength from ${achievement.name}!`, "ability-text");
                    break;
                case "dungeon_master":
                    gameState.player.maxHealth += 10;
                    gameState.player.health += 10;
                    addText(`You gained +10 Health from ${achievement.name}!`, "ability-text");
                    break;
                case "quest_complete":
                    gameState.player.strength += 5;
                    gameState.player.dexterity += 5;
                    gameState.player.intelligence += 5;
                    addText(`You gained +5 to all stats from ${achievement.name}!`, "ability-text");
                    break;
            }
            updateStatusBar();
        }
        
        // Check milestone rewards
        function checkMilestoneRewards() {
            // Level milestones
            Object.keys(gameState.milestoneRewards.levels).forEach(level => {
                const lvl = parseInt(level);
                if (gameState.player.level >= lvl && !gameState.player.milestones.levelsReached.includes(lvl)) {
                    gameState.player.milestones.levelsReached.push(lvl);
                    const reward = gameState.milestoneRewards.levels[lvl];
                    
                    // Play level up sound
                    gameAudio.playNotification('level');
                    
                    // Show milestone notification
                    setTimeout(() => {
                        const notification = document.createElement('div');
                        notification.className = 'game-text xp-text';
                        notification.textContent = `MILESTONE: ${reward.message}`;
                        notification.style.textAlign = 'center';
                        notification.style.border = '1px solid #f0f';
                        notification.style.padding = '5px';
                        notification.style.marginTop = '10px';
                        
                        gameScreen.appendChild(notification);
                        gameScreen.scrollTop = gameScreen.scrollHeight;
                    }, 100);
                }
            });
        }
        
        // Show inventory
        function showInventory() {
            clearScreen();
            clearButtons();
            
            addText("INVENTORY", "prompt");
            addText("────────────────");
            
            if (gameState.player.inventory.length === 0) {
                addText("Your inventory is empty.");
            } else {
                addText(`Items (${gameState.player.inventory.length}/${gameState.player.inventoryLimit}):`);
                gameState.player.inventory.forEach((item, index) => {
                    addText(`${index + 1}. ${item}`, "inventory-item");
                });
            }
            
            addText("");
            addText("Equipped:");
            addText(`Weapon: ${gameState.player.weapon}`);
            addText(`Armor: ${gameState.player.armor}`);
            
            addButton("USE ITEM", useItem);
            addButton("DISCARD ITEM", dropItem);
            addButton("RETURN", createCharacter);
        }
        
        // Use item from inventory
        function useItem() {
            clearScreen();
            clearButtons();
            
            addText("USE ITEM", "prompt");
            addText("Select an item to use:");
            
            gameState.player.inventory.forEach((item, index) => {
                if (item.includes("Salve") || item.includes("Antivenom") || item.includes("Puff")) {
                    addButton(`${item}`, function() {
                        if (item === "Healing Salve") {
                            gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + 30);
                            addText(`You apply the ${item}, healing 30 health.`, "item-text");
                            removeFromInventory(item);
                            gameAudio.playNotification('item');
                        } else if (item === "Strength Elixir") {
                            gameState.player.strength += 5;
                            addText(`You drink the ${item}, gaining +5 strength!`, "item-text");
                            gameState.buffs.push({ type: "strength", value: 5, duration: 3 });
                            removeFromInventory(item);
                            gameAudio.playNotification('item');
                        } else if (item === "Smoke Puff") {
                            if (gameState.inCombat) {
                                addText("You deploy a smoke puff and evade!", "item-text");
                                gameState.inCombat = false;
                                removeFromInventory(item);
                                setTimeout(createCharacter, 1000);
                                return;
                            } else {
                                addText("No need for that now.", "item-text");
                            }
                        }
                        updateStatusBar();
                        setTimeout(showInventory, 1500);
                    });
                }
            });
            
            addButton("CANCEL", showInventory);
        }
        
        // Drop item from inventory
        function dropItem() {
            clearScreen();
            clearButtons();
            
            addText("DISCARD ITEM", "prompt");
            addText("Select an item to discard:");
            
            gameState.player.inventory.forEach((item, index) => {
                addButton(`${item}`, function() {
                    removeFromInventory(item);
                    addText(`You discarded ${item}.`, "item-text");
                    setTimeout(showInventory, 1000);
                });
            });
            
            addButton("CANCEL", showInventory);
        }
        
        // Remove item from inventory
        function removeFromInventory(itemName) {
            const index = gameState.player.inventory.indexOf(itemName);
            if (index > -1) {
                gameState.player.inventory.splice(index, 1);
            }
        }
        
        // Show character sheet
        function showCharacter() {
            clearScreen();
            clearButtons();
            
            addText("CHARACTER SHEET", "prompt");
            addText("────────────────");
            addText(`Name: ${gameState.player.name}`);
            addText(`Level: ${gameState.player.level}`);
            addText(`Experience: ${gameState.player.experience}/${gameState.player.nextLevelExp}`);
            addText("");
            addText("Stats:");
            addText(`Health: ${gameState.player.health}/${gameState.player.maxHealth}`);
            addText(`Strength: ${gameState.player.strength}`);
            addText(`Dexterity: ${gameState.player.dexterity}`);
            addText(`Intelligence: ${gameState.player.intelligence}`);
            addText("");
            addText("Techniques:");
            if (gameState.player.abilities.length === 0) {
                addText("None learned yet.");
            } else {
                gameState.player.abilities.forEach(ability => {
                    addText(`• ${ability}`, "ability-text");
                });
            }
            
            addText("");
            addText("Active Augments:");
            if (gameState.buffs.length === 0) {
                addText("None");
            } else {
                gameState.buffs.forEach(buff => {
                    addText(`• ${buff.type} +${buff.value} (${buff.duration} turns)`);
                });
            }
            
            addButton("RETURN", createCharacter);
        }
        
        // Visit inn
        function visitInn() {
            clearScreen();
            clearButtons();
            
            addText(`${gameState.player.location.toUpperCase()} INN`, "location-text");
            addText("The innkeeper greets you warmly.");
            addText("'A room for the night will cost 10 gold pieces.'");
            addText("You currently have " + gameState.player.gold + " gold.");
            
            if (gameState.player.health < gameState.player.maxHealth) {
                addText("Resting will restore your health.");
            }
            
            addButton("REST (10 GOLD)", function() {
                if (gameState.player.gold >= 10) {
                    gameState.player.gold -= 10;
                    gameState.player.health = gameState.player.maxHealth;
                    // Clear temporary buffs when resting
                    gameState.buffs = gameState.buffs.filter(buff => buff.duration > 10);
                    addText("You rest peacefully and feel refreshed.");
                    updateStatusBar();
                    gameAudio.playNotification('item');
                } else {
                    addText("You don't have enough gold for a room.");
                }
                setTimeout(visitInn, 1500);
            });
            
            addButton("LISTEN FOR RUMORS", function() {
                const rumors = [
                    "I heard there's a scale drake in the northern crags.",
                    "The monarch is offering a bounty for brave souls.",
                    "Strange glow has been seen in the ancient barrows.",
                    "Road agents are ambushing travelers on the eastern pass.",
                    "A powerful relic was lost in the Deception's Maw dungeon."
                ];
                addText("");
                addText(`Innkeeper: "${rumors[Math.floor(Math.random() * rumors.length)]}"`);
            });
            
            addButton("LEAVE INN", townSquare);
        }
        
        // Visit weapon shop
        function visitWeaponShop() {
            clearScreen();
            clearButtons();
            
            addText("WEAPONSMITH", "location-text");
            addText("The blacksmith shows you his wares:");
            
            gameState.items.weapons.forEach(weapon => {
                if (weapon.price <= gameState.player.gold * 3) {
                    const currentBonus = weapon.name === gameState.player.weapon ? " (EQUIPPED)" : "";
                    addText(`${weapon.name}: ${weapon.price} gold - Strength +${weapon.strength}${currentBonus}`);
                }
            });
            
            addText("");
            addText(`You have ${gameState.player.gold} gold.`);
            
            gameState.items.weapons.forEach(weapon => {
                if (weapon.price <= gameState.player.gold && weapon.name !== gameState.player.weapon) {
                    addButton(`BUY ${weapon.name}`, function() {
                        if (gameState.player.gold >= weapon.price) {
                            gameState.player.gold -= weapon.price;
                            gameState.player.weapon = weapon.name;
                            gameState.player.strength += weapon.strength;
                            if (weapon.special) {
                                addText(`This ${weapon.name} has a special property: ${weapon.special}!`, "item-text");
                            }
                            addText(`You purchase a ${weapon.name}.`, "item-text");
                            gameAudio.playNotification('item');
                            updateStatusBar();
                            setTimeout(visitWeaponShop, 1500);
                        }
                    });
                }
            });
            
            addButton("SELL CURRENT WEAPON", function() {
                if (gameState.player.weapon !== "Iron Dagger") {
                    const currentWeapon = gameState.items.weapons.find(w => w.name === gameState.player.weapon);
                    const sellPrice = Math.floor(currentWeapon.price * 0.5);
                    gameState.player.gold += sellPrice;
                    gameState.player.strength -= currentWeapon.strength;
                    gameState.player.weapon = "Iron Dagger";
                    addText(`You sold your ${currentWeapon.name} for ${sellPrice} gold.`, "item-text");
                    gameAudio.playNotification('item');
                    updateStatusBar();
                    setTimeout(visitWeaponShop, 1500);
                } else {
                    addText("You can't sell your starting dagger.");
                }
            });
            
            addButton("LEAVE SHOP", townSquare);
        }
        
        // Visit armor shop
        function visitArmorShop() {
            clearScreen();
            clearButtons();
            
            addText("ARMORER", "location-text");
            addText("The armorer presents his armor:");
            
            gameState.items.armors.forEach(armor => {
                if (armor.price <= gameState.player.gold * 3) {
                    const currentBonus = armor.name === gameState.player.armor ? " (EQUIPPED)" : "";
                    addText(`${armor.name}: ${armor.price} gold - Defense +${armor.defense}${currentBonus}`);
                }
            });
            
            addText("");
            addText(`You have ${gameState.player.gold} gold.`);
            
            gameState.items.armors.forEach(armor => {
                if (armor.price <= gameState.player.gold && armor.name !== gameState.player.armor) {
                    addButton(`BUY ${armor.name}`, function() {
                        if (gameState.player.gold >= armor.price) {
                            gameState.player.gold -= armor.price;
                            gameState.player.armor = armor.name;
                            gameState.player.maxHealth += armor.defense * 2;
                            gameState.player.health += armor.defense * 2;
                            if (armor.special) {
                                addText(`This ${armor.name} has a special property: ${armor.special}!`, "item-text");
                            }
                            addText(`You purchase ${armor.name}.`, "item-text");
                            gameAudio.playNotification('item');
                            updateStatusBar();
                            setTimeout(visitArmorShop, 1500);
                        }
                    });
                }
            });
            
            addButton("LEAVE SHOP", townSquare);
        }
        
        // Visit magic shop
        function visitMagicShop() {
            clearScreen();
            clearButtons();
            
            addText("ARCANE BAZAAR", "location-text");
            addText("The mage shows you magical items:");
            
            gameState.items.consumables.forEach(item => {
                if (item.price <= gameState.player.gold * 2) {
                    addText(`${item.name}: ${item.price} gold - ${item.effect}`);
                }
            });
            
            addText("");
            addText(`You have ${gameState.player.gold} gold.`);
            
            gameState.items.consumables.forEach(item => {
                if (item.price <= gameState.player.gold) {
                    addButton(`BUY ${item.name}`, function() {
                        if (gameState.player.gold >= item.price) {
                            if (gameState.player.inventory.length < gameState.player.inventoryLimit) {
                                gameState.player.gold -= item.price;
                                gameState.player.inventory.push(item.name);
                                addText(`You purchase a ${item.name}.`, "item-text");
                                gameAudio.playNotification('item');
                                updateStatusBar();
                            } else {
                                addText("Your inventory is full!");
                            }
                            setTimeout(visitMagicShop, 1500);
                        }
                    });
                }
            });
            
            addButton("LEARN TECHNIQUE", function() {
                if (gameState.player.gold >= 100) {
                    gameState.player.gold -= 100;
                    const abilities = ["Power Lunge", "Twin Strikes", "Riposte", "Shield Wall", "Evade"];
                    const newAbility = abilities[Math.floor(Math.random() * abilities.length)];
                    if (!gameState.player.abilities.includes(newAbility)) {
                        gameState.player.abilities.push(newAbility);
                        addText(`You learned ${newAbility}!`, "ability-text");
                        gameAudio.playNotification('achievement');
                    } else {
                        addText("You already know that technique.");
                        gameState.player.gold += 100;
                    }
                    updateStatusBar();
                    setTimeout(visitMagicShop, 1500);
                } else {
                    addText("You need 100 gold to learn a technique.");
                }
            });
            
            addButton("LEAVE SHOP", townSquare);
        }
        
        // Visit general store
        function visitGeneralStore() {
            clearScreen();
            clearButtons();
            
            addText("EMPORIUM", "location-text");
            addText("The shopkeeper offers various supplies:");
            
            const supplies = [
                { name: "Oil Lamp", price: 5, desc: "Lights dark areas" },
                { name: "Hemp Rope", price: 10, desc: "Useful for climbing" },
                { name: "Journeybread", price: 3, desc: "Sustenance for traveling" },
                { name: "Water Flask", price: 8, desc: "Holds water" }
            ];
            
            supplies.forEach(supply => {
                addText(`${supply.name}: ${supply.price} gold - ${supply.desc}`);
            });
            
            addButton("BUY OIL LAMP", function() {
                if (gameState.player.gold >= 5) {
                    gameState.player.gold -= 5;
                    gameState.player.inventory.push("Oil Lamp");
                    addText("You buy an oil lamp.", "item-text");
                    gameAudio.playNotification('item');
                    updateStatusBar();
                }
            });
            
            addButton("LEAVE SHOP", townSquare);
        }
        
        // Visit training hall
        function visitTraining() {
            clearScreen();
            clearButtons();
            
            addText("TRAINING DOJO", "location-text");
            addText("The trainer can help you improve your skills:");
            
            addText(`Current Strength: ${gameState.player.strength}`);
            addText(`Current Dexterity: ${gameState.player.dexterity}`);
            addText("");
            addText("Training costs 50 gold per stat point.");
            
            addButton("TRAIN STRENGTH (50 GOLD)", function() {
                if (gameState.player.gold >= 50) {
                    gameState.player.gold -= 50;
                    gameState.player.strength += 1;
                    addText("You train your strength. +1 Strength!", "ability-text");
                    updateStatusBar();
                    setTimeout(visitTraining, 1500);
                } else {
                    addText("You need 50 gold to train.");
                }
            });
            
            addButton("TRAIN DEXTERITY (50 GOLD)", function() {
                if (gameState.player.gold >= 50) {
                    gameState.player.gold -= 50;
                    gameState.player.dexterity += 1;
                    addText("You train your dexterity. +1 Dexterity!", "ability-text");
                    updateStatusBar();
                    setTimeout(visitTraining, 1500);
                } else {
                    addText("You need 50 gold to train.");
                }
            });
            
            addButton("LEAVE", townSquare);
        }
        
        // Visit library
        function visitLibrary() {
            clearScreen();
            clearButtons();
            
            addText("SCRIPTORIUM", "location-text");
            addText("The archivist greets you among the ancient tomes.");
            addText("'Knowledge is power, adventurer. What do you seek?'");
            
            addButton("STUDY HISTORY", function() {
                addText("");
                addText("You learn about the rise of Zylon and the Orb of Perpetuity.");
                addText("The archivist suggests checking the ruins near Elderwood.");
            });
            
            addButton("STUDY MONSTERS", function() {
                addText("");
                addText("You learn about various creatures:");
                addText("- Gnashers fear fire");
                addText("- Bonesoldiers can be banished with silver");
                addText("- Scale Drakes are vulnerable to ice");
            });
            
            addButton("LEAVE", townSquare);
        }
        
        // Visit tavern
        function visitTavern() {
            clearScreen();
            clearButtons();
            
            addText("GROGSHOP", "location-text");
            addText("The air is thick with the smell of ale and sea salt.");
            addText("Sailors and pirates murmur in the dim light.");
            
            addButton("BUY GROG (5 GOLD)", function() {
                if (gameState.player.gold >= 5) {
                    gameState.player.gold -= 5;
                    addText("You drink some grog. It's strong but refreshing.");
                    updateStatusBar();
                } else {
                    addText("You don't have enough gold for grog.");
                }
            });
            
            addButton("LISTEN TO TALES", function() {
                addText("");
                const tales = [
                    "A sailor speaks of hidden treasure in Cutlass Bay.",
                    "A pirate whispers about a ghost ship near Seahaven.",
                    "An old sailor claims to have seen Zylon's fortress.",
                    "Rumors say there's a secret passage in the Deception's Maw."
                ];
                addText(tales[Math.floor(Math.random() * tales.length)]);
            });
            
            addButton("LEAVE", townSquare);
        }
        
        // Visit fishing dock
        function visitFishingDock() {
            clearScreen();
            clearButtons();
            
            addText("FISHING DOCK", "location-text");
            addText("Fishermen mend their nets as gulls cry overhead.");
            addText("The salty breeze carries the scent of the sea.");
            
            addButton("BUY FISH (3 GOLD)", function() {
                if (gameState.player.gold >= 3) {
                    gameState.player.gold -= 3;
                    if (gameState.player.inventory.length < gameState.player.inventoryLimit) {
                        gameState.player.inventory.push("Dried Fish");
                        addText("You buy some dried fish. It could be useful.", "item-text");
                        gameAudio.playNotification('item');
                    } else {
                        addText("Your inventory is full!");
                        gameState.player.gold += 3;
                    }
                    updateStatusBar();
                } else {
                    addText("You don't have enough gold.");
                }
            });
            
            addButton("HEAR FISHING TALES", function() {
                addText("");
                addText("An old fisherman speaks:");
                addText("'I once saw a sea serpent near the Isle of Cinders.'");
                addText("'They say it guards the entrance to Perdition's Heart.'");
            });
            
            addButton("LEAVE", townSquare);
        }
        
        // Visit provisions
        function visitProvisions() {
            clearScreen();
            clearButtons();
            
            addText("PROVISIONS SHOP", "location-text");
            addText("The shop smells of dried herbs and grains.");
            addText("Basic supplies for travelers are available.");
            
            const provisions = [
                { name: "Travel Rations", price: 2, desc: "Food for the road" },
                { name: "Waterskin", price: 5, desc: "Carries water" },
                { name: "Bedroll", price: 8, desc: "For camping" },
                { name: "Fire Starter", price: 3, desc: "Lights campfires" }
            ];
            
            provisions.forEach(item => {
                addText(`${item.name}: ${item.price} gold - ${item.desc}`);
            });
            
            addButton("BUY TRAVEL RATIONS", function() {
                if (gameState.player.gold >= 2) {
                    gameState.player.gold -= 2;
                    if (gameState.player.inventory.length < gameState.player.inventoryLimit) {
                        gameState.player.inventory.push("Travel Rations");
                        addText("You buy travel rations.", "item-text");
                        gameAudio.playNotification('item');
                    } else {
                        addText("Your inventory is full!");
                        gameState.player.gold += 2;
                    }
                    updateStatusBar();
                }
            });
            
            addButton("LEAVE", townSquare);
        }
        
        // Visit curios shop
        function visitCuriosShop() {
            clearScreen();
            clearButtons();
            
            addText("CURIOS SHOP", "location-text");
            addText("Strange artifacts line the shelves of this mysterious shop.");
            addText("The proprietor watches you with curious eyes.");
            
            addButton("EXAMINE ARTIFACTS", function() {
                addText("");
                addText("You see various oddities:");
                addText("- A crystal that glows in the dark");
                addText("- A map with moving ink");
                addText("- A compass that points to magic");
                addText("- A feather that never falls");
            });
            
            addButton("BUY MYSTERY ITEM (25 GOLD)", function() {
                if (gameState.player.gold >= 25) {
                    gameState.player.gold -= 25;
                    const mysteryItems = ["Glowing Stone", "Odd Coin", "Strange Feather", "Ancient Key"];
                    const mysteryItem = mysteryItems[Math.floor(Math.random() * mysteryItems.length)];
                    
                    if (gameState.player.inventory.length < gameState.player.inventoryLimit) {
                        gameState.player.inventory.push(mysteryItem);
                        addText(`You buy a ${mysteryItem}. Who knows what it does?`, "item-text");
                        gameAudio.playNotification('item');
                    } else {
                        addText("Your inventory is full!");
                        gameState.player.gold += 25;
                    }
                    updateStatusBar();
                } else {
                    addText("You don't have enough gold.");
                }
            });
            
            addButton("LEAVE", townSquare);
        }
        
        // Visit shipyard
        function visitShipyard() {
            clearScreen();
            clearButtons();
            
            addText("SHIPYARD", "location-text");
            addText("Workers repair ships as the sea crashes against the docks.");
            addText("The smell of tar and saltwater fills the air.");
            
            addButton("INQUIRE ABOUT PASSAGE", function() {
                addText("");
                addText("The shipmaster says:");
                addText("'Passage to the Isle of Cinders costs 100 gold.'");
                addText("'But first you must prove yourself worthy.'");
            });
            
            addButton("HELP WITH REPAIRS", function() {
                if (gameState.player.strength >= 12) {
                    addText("");
                    addText("You help repair a ship and earn 20 gold.");
                    gameState.player.gold += 20;
                    gameAudio.playNotification('item');
                    updateStatusBar();
                } else {
                    addText("");
                    addText("The work is too heavy for you. Come back when you're stronger.");
                }
            });
            
            addButton("LEAVE", townSquare);
        }
        
        // Visit forge
        function visitForge() {
            clearScreen();
            clearButtons();
            
            addText("FORGE", "location-text");
            addText("The heat from the forges is intense.");
            addText("Blacksmiths hammer glowing metal into shape.");
            
            addButton("COMMISSION WORK", function() {
                addText("");
                addText("The master smith examines you:");
                addText("'I could make you better armor, but I need special materials.'");
                addText("'Bring me dragon scales from Avarice's Hold.'");
            });
            
            addButton("SHARPEN WEAPON (15 GOLD)", function() {
                if (gameState.player.gold >= 15) {
                    gameState.player.gold -= 15;
                    gameState.player.strength += 1;
                    addText("The smith sharpens your weapon. +1 Strength!", "ability-text");
                    updateStatusBar();
                } else {
                    addText("You don't have enough gold.");
                }
            });
            
            addButton("LEAVE", townSquare);
        }
        
        // Start town quest
        function startTownQuest(questType) {
            clearScreen();
            clearButtons();
            
            addText("TOWN QUEST", "location-text");
            
            const quests = {
                monarch: { 
                    title: "The Monarch's Decree",
                    desc: "The monarch needs you to clear road agents from the nearby pass.",
                    reward: 100,
                    enemy: "Highwayman"
                },
                archivist: {
                    title: "Archivist's Research",
                    desc: "A local archivist needs rare tomes from the ruins.",
                    reward: 75,
                    enemy: "Gnasher"
                },
                dendrite: {
                    title: "Dendrite's Request",
                    desc: "The elder druid needs protection while gathering herbs.",
                    reward: 60,
                    enemy: "Brute"
                },
                smith: {
                    title: "Smith's Ore Delivery",
                    desc: "Escort a shipment of precious ore to the forge.",
                    reward: 80,
                    enemy: "Highwayman"
                },
                paladin: {
                    title: "Paladin's Trial",
                    desc: "Prove your worth by defeating a training knight.",
                    reward: 50,
                    enemy: "Black Knight"
                },
                tidespeaker: {
                    title: "Tidespeaker's Favor",
                    desc: "Recover a lost relic from the coastal caves.",
                    reward: 70,
                    enemy: "Bonesoldier"
                },
                survivor: {
                    title: "Survivor's Plea",
                    desc: "Clear specters from the ruined town.",
                    reward: 90,
                    enemy: "Spellweaver"
                },
                yeoman: {
                    title: "Yeoman's Problem",
                    desc: "Protect the fields from giant pests.",
                    reward: 40,
                    enemy: "Gnasher"
                },
                privateer: {
                    title: "Privateer's Bounty",
                    desc: "Hunt down a dangerous sea creature.",
                    reward: 110,
                    enemy: "Cave Troll"
                },
                factor: {
                    title: "Factor's Escort",
                    desc: "Escort a merchant caravan safely to the next town.",
                    reward: 80,
                    enemy: "Highwayman"
                },
                anchorite: {
                    title: "Anchorite's Vision",
                    desc: "Retrieve a vision crystal from the misty caves.",
                    reward: 65,
                    enemy: "Bonesoldier"
                },
                seer: {
                    title: "Seer's Prophecy",
                    desc: "Climb the peak to witness an omen.",
                    reward: 55,
                    enemy: "Brute"
                },
                commodore: {
                    title: "Commodore's Mission",
                    desc: "Inspect a reportedly haunted ship.",
                    reward: 95,
                    enemy: "Spellweaver"
                },
                marshal: {
                    title: "Marshal's Orders",
                    desc: "Train with the fortress guards.",
                    reward: 45,
                    enemy: "Black Knight"
                },
                champion: {
                    title: "Champion's Challenge",
                    desc: "Defeat the arena champion in honorable combat.",
                    reward: 120,
                    enemy: "Black Knight"
                }
            };
            
            const quest = quests[questType] || quests.monarch;
            
            addText(quest.title);
            addText(quest.desc);
            addText("");
            addText(`Reward: ${quest.reward} gold`);
            
            addButton("ACCEPT QUEST", function() {
                addText("");
                addText("You set out on your quest...");
                // Start combat with quest enemy
                const enemyTemplate = gameState.enemies.find(e => e.name === quest.enemy);
                gameState.currentEnemy = {...enemyTemplate};
                gameState.inCombat = true;
                gameState.currentEnemy.questEnemy = true;
                gameState.currentEnemy.questReward = quest.reward;
                
                setTimeout(() => {
                    clearScreen();
                    addText(`You encounter a ${gameState.currentEnemy.name}!`, "combat-text");
                    addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                    showCombatOptions();
                }, 1500);
            });
            
            addButton("DECLINE", townSquare);
        }
        
        // Explore dungeon
        function exploreDungeon() {
            clearScreen();
            clearButtons();
            
            addText("DUNGEON ENTRANCE", "location-text");
            addText("You stand before a dark dungeon entrance.");
            
            // Show available dungeons based on player level
            const availableDungeons = gameState.world.dungeons.filter(d => d.level <= gameState.player.level);
            
            if (availableDungeons.length === 0) {
                addText("No dungeons are accessible at your level.");
                addButton("RETURN", townSquare);
                return;
            }
            
            availableDungeons.forEach(dungeon => {
                addButton(`ENTER ${dungeon.name} (Level ${dungeon.level})`, function() {
                    enterDungeon(dungeon);
                });
            });
            
            addButton("RETURN", townSquare);
        }
        
        // Enter dungeon
        function enterDungeon(dungeon) {
            clearScreen();
            clearButtons();
            
            addText(`ENTERING ${dungeon.name.toUpperCase()}`, "location-text");
            addText(`This dungeon is located ${dungeon.location}.`);
            addText(`Legend says a ${dungeon.boss} guards ${dungeon.reward}.`);
            
            // Multiple encounters in dungeon
            const encounterCount = 2 + Math.floor(Math.random() * 3);
            
            addText("");
            addText("You venture deep into the dungeon...");
            
            setTimeout(() => {
                startDungeonEncounter(dungeon, encounterCount, 1);
            }, 2000);
        }
        
        // Dungeon encounter sequence
        function startDungeonEncounter(dungeon, totalEncounters, currentEncounter) {
            clearScreen();
            
            if (currentEncounter > totalEncounters) {
                // Boss fight
                addText("You reach the deepest chamber of the dungeon!", "location-text");
                addText(`Before you stands the ${dungeon.boss}!`, "combat-text");
                
                const bossEnemy = gameState.enemies.find(e => e.name === dungeon.boss) || gameState.enemies[2];
                gameState.currentEnemy = {...bossEnemy};
                gameState.currentEnemy.health *= 1.5;
                gameState.currentEnemy.strength += 5;
                gameState.currentEnemy.dungeonBoss = true;
                gameState.currentEnemy.dungeonReward = dungeon.reward;
                gameState.currentEnemy.dungeon = dungeon;
                
                gameState.inCombat = true;
                
                setTimeout(() => {
                    addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                    showCombatOptions();
                }, 1500);
                
                return;
            }
            
            addText(`Dungeon Chamber ${currentEncounter}/${totalEncounters}`, "location-text");
            
            // Regular encounter
            const regularEnemies = gameState.enemies.filter(e => !["Scale Drake", "Zylon"].includes(e.name));
            const enemyTemplate = {...regularEnemies[Math.floor(Math.random() * regularEnemies.length)]};
            gameState.currentEnemy = enemyTemplate;
            gameState.currentEnemy.health = Math.floor(enemyTemplate.health * (0.8 + currentEncounter * 0.2));
            gameState.currentEnemy.strength = Math.floor(enemyTemplate.strength * (0.9 + currentEncounter * 0.1));
            gameState.currentEnemy.dungeonEncounter = currentEncounter;
            gameState.currentEnemy.totalEncounters = totalEncounters;
            gameState.currentEnemy.dungeon = dungeon;
            gameState.inCombat = true;
            
            setTimeout(() => {
                addText(`A ${gameState.currentEnemy.name} blocks your path!`, "combat-text");
                addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                showCombatOptions();
            }, 1500);
        }
        
        // Travel to different location
        function travel() {
            clearScreen();
            clearButtons();
            
            addText("TRAVEL", "location-text");
            addText("Where would you like to travel?");
            addText("");
            
            // Group towns by region
            const regions = {
                "Central Mythdrasil": ["Kingsreach", "Valor's Keep", "Harvestide", "Ironhaven"],
                "Eastern Reaches": ["Moonstone", "Tradewind", "Misthaven"],
                "Western Coast": ["Seahaven", "Cutlass Bay", "Anchorhold"],
                "Northern Frontiers": ["Elderwood", "Bulwark", "Highpeak", "Wyrm's Rest"],
                "Southern Ruins": ["Ashenport"]
            };
            
            Object.entries(regions).forEach(([region, towns]) => {
                addText(`${region}:`);
                towns.forEach(town => {
                    if (town !== gameState.player.location) {
                        addButton(town, function() {
                            gameState.player.location = town;
                            
                            // Random encounter chance
                            const encounterChance = Math.random();
                            
                            clearScreen();
                            clearButtons();
                            
                            addText(`You travel to ${town}.`, "location-text");
                            
                            if (encounterChance < 0.4) {
                                // Combat encounter
                                startWildernessEncounter();
                            } else {
                                addText("The journey is uneventful.");
                                addButton("CONTINUE", createCharacter);
                            }
                            
                            updateStatusBar();
                        });
                    }
                });
                addText("");
            });
            
            addButton("CANCEL", createCharacter);
        }
        
        // Start wilderness encounter
        function startWildernessEncounter() {
            const encounterType = gameState.world.wildernessEncounters[Math.floor(Math.random() * gameState.world.wildernessEncounters.length)];
            
            addText(`You encounter ${encounterType}!`, "combat-text");
            
            // Map encounter to enemy type
            let enemyType;
            switch(encounterType) {
                case "marauders":
                case "road agents":
                    enemyType = "Highwayman";
                    break;
                case "timber wolves":
                case "fanghounds":
                    enemyType = "Gnasher";
                    break;
                case "dire rats":
                    enemyType = "Gnasher";
                    break;
                case "cave bears":
                case "tusked boars":
                    enemyType = "Brute";
                    break;
                case "harpy flock":
                    enemyType = "Bonesoldier";
                    break;
                case "serpent wyrms":
                    enemyType = "Cave Troll";
                    break;
                case "wraiths":
                    enemyType = "Spellweaver";
                    break;
                default:
                    enemyType = "Gnasher";
            }
            
            const enemyTemplate = gameState.enemies.find(e => e.name === enemyType);
            gameState.currentEnemy = {...enemyTemplate};
            gameState.inCombat = true;
            
            setTimeout(() => {
                addText(`A wild ${gameState.currentEnemy.name} attacks!`, "combat-text");
                addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                showCombatOptions();
            }, 1500);
        }
        
        // Quest information
        function questInfo() {
            clearScreen();
            clearButtons();
            
            addText("QUEST INFORMATION", "prompt");
            
            if (gameState.player.quest === 0) {
                addText("The monarch has tasked you with finding the Orb of Perpetuity.");
                addText("Rumors say it's hidden in a dungeon near the town of Elderwood.");
                addText("Travel to different towns to gather information and supplies.");
                addText("");
                addText("Main Objective: Find the Orb of Perpetuity");
                addText("Current Task: Gain strength and explore dungeons");
                gameState.player.quest = 1;
            } else if (gameState.player.quest === 1) {
                addText("You've learned the Orb is guarded by powerful creatures.");
                addText("You'll need to be strong to defeat them.");
                addText("Some say Zylon himself protects the orb in his fortress.");
                addText("");
                addText("Main Objective: Find the Orb of Perpetuity");
                addText("Current Task: Explore the Perdition's Heart dungeon");
            } else if (gameState.player.quest === 2) {
                addText("You have the Orb of Perpetuity!");
                addText("Now you must confront Zylon in his fortress.");
                addText("Travel to the far north to find his lair.");
                addText("");
                addText("Main Objective: Defeat Zylon");
                addText("Current Task: Challenge Zylon in Perdition's Heart");
            }
            
            // Show side quests if any
            addText("");
            addText("Available in current town:");
            const currentTown = gameState.world.towns.find(t => t.name === gameState.player.location);
            addText(`- ${currentTown.quest} quest at the town square`);
            
            addButton("CONTINUE", createCharacter);
        }
        
        // Show combat options with expanded depth
        function showCombatOptions() {
            clearButtons();
            
            addButton("ATTACK", playerAttack);
            addButton("POWER LUNGE", powerAttack);
            addButton("DEFEND", playerDefend);
            addButton("USE ITEM", combatUseItem);
            
            // Show learned abilities
            gameState.player.abilities.forEach(ability => {
                addButton(ability.toUpperCase(), function() {
                    useAbility(ability);
                });
            });
            
            addButton("FLEE", attemptFlee);
            
            // Show combat stance option
            addButton(`STANCE: ${gameState.player.combatStance.toUpperCase()}`, changeStance);
        }
        
        // Change combat stance
        function changeStance() {
            clearScreen();
            
            const stances = ["balanced", "aggressive", "defensive"];
            const currentIndex = stances.indexOf(gameState.player.combatStance);
            gameState.player.combatStance = stances[(currentIndex + 1) % stances.length];
            
            addText(`You change to ${gameState.player.combatStance} stance.`, "combat-text");
            
            setTimeout(() => {
                addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                showCombatOptions();
            }, 1000);
        }
        
        // Player regular attack
        function playerAttack() {
            clearScreen();
            
            let damage = Math.floor(Math.random() * gameState.player.strength) + 5;
            
            // Stance modifiers
            if (gameState.player.combatStance === "aggressive") {
                damage = Math.floor(damage * 1.3);
            } else if (gameState.player.combatStance === "defensive") {
                damage = Math.floor(damage * 0.8);
            }
            
            // Dexterity affects hit chance
            const hitChance = 70 + gameState.player.dexterity;
            if (Math.random() * 100 > hitChance) {
                addText(`You miss the ${gameState.currentEnemy.name}!`, "combat-text");
            } else {
                gameState.currentEnemy.health -= damage;
                addText(`You attack the ${gameState.currentEnemy.name} for ${damage} damage!`, "combat-text");
                gameAudio.playCombatSound('attack');
                gameAudio.playCombatSound('hit');
            }
            
            if (gameState.currentEnemy.health <= 0) {
                endCombat(true);
                return;
            }
            
            addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
            
            // Enemy attacks back
            enemyAttack();
        }
        
        // Power attack (uses more energy but deals more damage)
        function powerAttack() {
            clearScreen();
            
            let damage = Math.floor(Math.random() * gameState.player.strength * 1.5) + 10;
            
            // Higher miss chance for power attack
            const hitChance = 50 + gameState.player.dexterity;
            if (Math.random() * 100 > hitChance) {
                addText(`Your power lunge misses the ${gameState.currentEnemy.name}!`, "combat-text");
            } else {
                gameState.currentEnemy.health -= damage;
                addText(`You power lunge at the ${gameState.currentEnemy.name} for ${damage} damage!`, "combat-text");
                gameAudio.playCombatSound('power_attack');
                gameAudio.playCombatSound('hit');
            }
            
            if (gameState.currentEnemy.health <= 0) {
                endCombat(true);
                return;
            }
            
            addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
            
            // Enemy gets a free attack (power attack leaves you open)
            enemyAttack();
        }
        
        // Use ability in combat
        function useAbility(ability) {
            clearScreen();
            
            switch(ability) {
                case "Twin Strikes":
                    let damage1 = Math.floor(Math.random() * gameState.player.strength * 0.7) + 3;
                    let damage2 = Math.floor(Math.random() * gameState.player.strength * 0.7) + 3;
                    gameState.currentEnemy.health -= (damage1 + damage2);
                    addText(`You strike twice for ${damage1} and ${damage2} damage!`, "ability-text");
                    gameAudio.playCombatSound('attack');
                    gameAudio.playCombatSound('attack');
                    gameAudio.playCombatSound('hit');
                    break;
                    
                case "Riposte":
                    addText("You prepare to counter the enemy's attack...", "ability-text");
                    gameState.player.counterReady = true;
                    gameAudio.playCombatSound('defend');
                    break;
                    
                case "Shield Wall":
                    addText("You raise your defense, reducing next damage by 50%", "ability-text");
                    gameState.player.defenseBoost = true;
                    gameAudio.playCombatSound('defend');
                    break;
                    
                default:
                    addText(`You use ${ability}!`, "ability-text");
                    let damage = Math.floor(Math.random() * gameState.player.strength) + 8;
                    gameState.currentEnemy.health -= damage;
                    addText(`You deal ${damage} damage!`, "ability-text");
                    gameAudio.playCombatSound('attack');
                    gameAudio.playCombatSound('hit');
            }
            
            if (gameState.currentEnemy.health <= 0) {
                endCombat(true);
                return;
            }
            
            addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
            
            // Enemy attacks
            enemyAttack();
        }
        
        // Enemy attacks with abilities
        function enemyAttack() {
            // Check for counter attack
            if (gameState.player.counterReady) {
                const counterDamage = Math.floor(Math.random() * gameState.player.strength) + 5;
                gameState.currentEnemy.health -= counterDamage;
                addText(`You riposte for ${counterDamage} damage!`, "ability-text");
                gameState.player.counterReady = false;
                
                if (gameState.currentEnemy.health <= 0) {
                    endCombat(true);
                    return;
                }
                
                addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                gameAudio.playCombatSound('attack');
                gameAudio.playCombatSound('hit');
                showCombatOptions();
                return;
            }
            
            let damage = Math.floor(Math.random() * gameState.currentEnemy.strength) + 3;
            
            // Apply defense boost if active
            if (gameState.player.defenseBoost) {
                damage = Math.floor(damage * 0.5);
                gameState.player.defenseBoost = false;
                addText("Your shield wall reduces the damage!", "ability-text");
            }
            
            // Stance modifiers
            if (gameState.player.combatStance === "defensive") {
                damage = Math.floor(damage * 0.7);
            } else if (gameState.player.combatStance === "aggressive") {
                damage = Math.floor(damage * 1.2);
            }
            
            // Check for enemy abilities
            if (gameState.currentEnemy.abilities && Math.random() < 0.3) {
                const ability = gameState.currentEnemy.abilities[Math.floor(Math.random() * gameState.currentEnemy.abilities.length)];
                
                switch(ability) {
                    case "arc bolt":
                        damage = Math.floor(damage * 1.5);
                        addText(`The ${gameState.currentEnemy.name} casts Arc Bolt!`, "combat-text");
                        break;
                    case "mend flesh":
                        const heal = Math.floor(gameState.currentEnemy.maxHealth * 0.1);
                        gameState.currentEnemy.health = Math.min(gameState.currentEnemy.maxHealth, gameState.currentEnemy.health + heal);
                        addText(`The ${gameState.currentEnemy.name} mends ${heal} health!`, "combat-text");
                        break;
                    case "soul siphon":
                        const drain = Math.floor(damage * 0.5);
                        gameState.currentEnemy.health += drain;
                        addText(`The ${gameState.currentEnemy.name} siphons your soul, healing ${drain} health!`, "combat-text");
                        break;
                }
            }
            
            gameState.player.health -= damage;
            
            addText(`The ${gameState.currentEnemy.name} attacks you for ${damage} damage!`, "combat-text");
            addText(`Your Health: ${gameState.player.health}/${gameState.player.maxHealth}`, "combat-text");
            
            gameAudio.playCombatSound('enemy_attack');
            gameAudio.playCombatSound('hit');
            
            updateStatusBar();
            
            if (gameState.player.health <= 0) {
                endCombat(false);
                return;
            }
            
            // Update buff durations
            gameState.buffs = gameState.buffs.filter(buff => {
                buff.duration--;
                return buff.duration > 0;
            });
            
            showCombatOptions();
        }
        
        // Player defends
        function playerDefend() {
            clearScreen();
            
            let damage = Math.floor(Math.random() * gameState.currentEnemy.strength * 0.5);
            
            // Extra defense in defensive stance
            if (gameState.player.combatStance === "defensive") {
                damage = Math.floor(damage * 0.5);
            }
            
            gameState.player.health -= damage;
            
            addText(`You brace for impact. The ${gameState.currentEnemy.name} attacks you for ${damage} damage!`, "combat-text");
            addText(`Your Health: ${gameState.player.health}/${gameState.player.maxHealth}`, "combat-text");
            
            // Heal a small amount when defending
            const heal = Math.floor(gameState.player.maxHealth * 0.05);
            gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + heal);
            addText(`You recover ${heal} health while defending.`, "combat-text");
            
            gameAudio.playCombatSound('defend');
            if (damage > 0) gameAudio.playCombatSound('hit');
            
            updateStatusBar();
            
            if (gameState.player.health <= 0) {
                endCombat(false);
                return;
            }
            
            showCombatOptions();
        }
        
        // Use item in combat
        function combatUseItem() {
            clearScreen();
            clearButtons();
            
            addText("USE ITEM IN COMBAT", "prompt");
            
            const combatItems = gameState.player.inventory.filter(item => 
                item.includes("Salve") || item.includes("Antivenom") || item.includes("Puff")
            );
            
            if (combatItems.length === 0) {
                addText("No usable items in inventory.");
                addButton("BACK", function() {
                    addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                    showCombatOptions();
                });
                return;
            }
            
            combatItems.forEach(item => {
                addButton(`${item}`, function() {
                    if (item === "Healing Salve") {
                        gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + 30);
                        addText(`You apply a Healing Salve, restoring 30 health.`, "item-text");
                        removeFromInventory(item);
                        gameAudio.playNotification('item');
                    } else if (item === "Strength Elixir") {
                        gameState.player.strength += 5;
                        addText(`You drink a Strength Elixir, gaining +5 strength!`, "item-text");
                        gameState.buffs.push({ type: "strength", value: 5, duration: 3 });
                        removeFromInventory(item);
                        gameAudio.playNotification('item');
                    } else if (item === "Smoke Puff") {
                        addText("You deploy a smoke puff and evade!", "item-text");
                        gameState.inCombat = false;
                        removeFromInventory(item);
                        setTimeout(createCharacter, 1500);
                        return;
                    }
                    
                    updateStatusBar();
                    
                    // Enemy still attacks
                    setTimeout(() => {
                        addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                        enemyAttack();
                    }, 1000);
                });
            });
            
            addButton("BACK", function() {
                addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                showCombatOptions();
            });
        }
        
        // Attempt to flee
        function attemptFlee() {
            clearScreen();
            
            // Base flee chance is 50%, increased by dexterity
            const fleeChance = 50 + gameState.player.dexterity;
            
            if (Math.random() * 100 < fleeChance) {
                addText("You successfully flee from battle!", "combat-text");
                gameState.inCombat = false;
                
                // Take some damage while fleeing
                const fleeDamage = Math.floor(Math.random() * gameState.currentEnemy.strength);
                gameState.player.health -= fleeDamage;
                if (fleeDamage > 0) {
                    addText(`You take ${fleeDamage} damage while fleeing.`, "combat-text");
                    gameAudio.playCombatSound('hit');
                }
                
                updateStatusBar();
                
                if (gameState.player.health <= 0) {
                    endCombat(false);
                    return;
                }
                
                addButton("CONTINUE", createCharacter);
            } else {
                addText("You failed to flee!", "combat-text");
                enemyAttack();
            }
        }
        
        // End combat with expanded rewards
        function endCombat(playerWon) {
            clearButtons();
            
            if (playerWon) {
                const goldEarned = gameState.currentEnemy.gold;
                const expEarned = gameState.currentEnemy.exp;
                
                gameState.player.gold += goldEarned;
                gameState.player.experience += expEarned;
                gameState.player.milestones.enemiesDefeated++;
                
                addText(`You defeated the ${gameState.currentEnemy.name}!`, "combat-text");
                addText(`You earned ${goldEarned} gold and ${expEarned} experience.`, "item-text");
                
                // Play victory sound
                gameAudio.playCombatSound('victory');
                
                // Special rewards
                if (gameState.currentEnemy.questEnemy) {
                    const questReward = gameState.currentEnemy.questReward;
                    gameState.player.gold += questReward;
                    addText(`Quest completed! You earn an additional ${questReward} gold.`, "item-text");
                    gameState.player.milestones.questsCompleted++;
                }
                
                if (gameState.currentEnemy.npcQuest) {
                    const npc = gameState.currentEnemy.questGiver;
                    const relationshipReward = gameState.currentEnemy.relationshipReward;
                    npc.relationship += relationshipReward;
                    addText(`${npc.name} is impressed! Relationship +${relationshipReward}.`, "npc-text");
                }
                
                if (gameState.currentEnemy.dungeonBoss) {
                    const dungeonReward = gameState.currentEnemy.dungeonReward;
                    addText(`You found ${dungeonReward}!`, "item-text");
                    
                    // Add reward to inventory if it's an item
                    if (!gameState.player.inventory.includes(dungeonReward) && 
                        gameState.player.inventory.length < gameState.player.inventoryLimit) {
                        gameState.player.inventory.push(dungeonReward);
                    }
                    
                    // Increase dungeon count
                    gameState.player.milestones.dungeonsCleared++;
                    
                    // Check if this is the Orb of Perpetuity
                    if (dungeonReward === "Orb of Perpetuity") {
                        gameState.player.quest = 2;
                        addText("You now possess the Orb of Perpetuity!", "prompt");
                        addText("Now you must defeat Zylon himself!", "prompt");
                    }
                    
                    // Check if this is the Scale Drake
                    if (gameState.currentEnemy.name === "Scale Drake") {
                        gameState.player.achievements.push("dragon_slayer");
                        checkAchievements();
                    }
                }
                
                if (gameState.currentEnemy.arenaOpponent) {
                    const arenaReward = gameState.currentEnemy.arenaReward;
                    gameState.player.gold += arenaReward;
                    addText(`Arena victory! You win ${arenaReward} gold!`, "item-text");
                    gameState.player.milestones.arenaFights++;
                    gameState.player.milestones.miniGamesWon++;
                    checkAchievements();
                }
                
                // Check for level up
                checkLevelUp();
                
                // Check for achievements
                checkAchievements();
                
                // Special for Zylon
                if (gameState.currentEnemy.name === "Zylon") {
                    addText("", "prompt");
                    addText("╔══════════════════════════════════════╗", "prompt");
                    addText("║      C O N G R A T U L A T I O N S   ║", "prompt");
                    addText("╚══════════════════════════════════════╝", "prompt");
                    addText("You have defeated Zylon and saved Mythdrasil!", "prompt");
                    addText("The Orb of Perpetuity is shattered and dawn returns.", "prompt");
                    addText("You are now hailed as the savior of the realm!", "prompt");
                    addText("Thank you for playing ETERNAL DOMINION!", "prompt");
                    
                    addButton("PLAY AGAIN", function() {
                        location.reload();
                    });
                    
                    return;
                }
                
                // Continue dungeon if in one
                if (gameState.currentEnemy.dungeonBoss) {
                    addButton("LEAVE DUNGEON", createCharacter);
                } else if (gameState.currentEnemy.dungeonEncounter) {
                    // Continue to next dungeon encounter
                    const nextEncounter = gameState.currentEnemy.dungeonEncounter + 1;
                    const totalEncounters = gameState.currentEnemy.totalEncounters;
                    const dungeon = gameState.currentEnemy.dungeon;
                    
                    addButton("CONTINUE EXPLORING", function() {
                        startDungeonEncounter(dungeon, totalEncounters, nextEncounter);
                    });
                } else {
                    addButton("CONTINUE", createCharacter);
                }
            } else {
                addText("You have been defeated...", "game-over");
                addText("Your adventure ends here.", "game-over");
                
                // Play defeat sound
                gameAudio.playCombatSound('defeat');
                
                // Show final stats
                addText("");
                addText("Final Statistics:", "prompt");
                addText(`Level: ${gameState.player.level}`);
                addText(`Gold Collected: ${gameState.player.gold}`);
                addText(`Experience: ${gameState.player.experience}`);
                addText(`Achievements Unlocked: ${gameState.player.achievements.length}`);
                addText(`Towns Visited: ${gameState.player.milestones.townsVisited.length}`);
                
                addButton("NEW GAME", function() {
                    location.reload();
                });
            }
            
            gameState.inCombat = false;
            updateStatusBar();
        }
        
        // Check for level up
        function checkLevelUp() {
            while (gameState.player.experience >= gameState.player.nextLevelExp) {
                gameState.player.level++;
                gameState.player.experience -= gameState.player.nextLevelExp;
                gameState.player.nextLevelExp = Math.floor(gameState.player.nextLevelExp * 1.5);
                
                // Stat increases
                gameState.player.maxHealth += 20 + gameState.player.level;
                gameState.player.health = gameState.player.maxHealth;
                gameState.player.strength += 2;
                gameState.player.dexterity += 1;
                gameState.player.intelligence += 1;
                
                addText(`╔══════════════════════════╗`, "xp-text");
                addText(`║  LEVEL UP: ${gameState.player.level.toString().padStart(2, ' ')}        ║`, "xp-text");
                addText(`╚══════════════════════════╝`, "xp-text");
                addText(`Health increased to ${gameState.player.maxHealth}`, "xp-text");
                addText(`Strength increased to ${gameState.player.strength}`, "xp-text");
                
                // Play level up notification
                gameAudio.playNotification('level');
                
                // Check milestone rewards
                checkMilestoneRewards();
                
                // Learn new ability every 3 levels
                if (gameState.player.level % 3 === 0) {
                    const newAbilities = ["Crippling Blow", "Whirlwind", "Second Wind", "Battle Cry", "Precision Strike"];
                    const availableAbilities = newAbilities.filter(a => !gameState.player.abilities.includes(a));
                    
                    if (availableAbilities.length > 0) {
                        const newAbility = availableAbilities[Math.floor(Math.random() * availableAbilities.length)];
                        gameState.player.abilities.push(newAbility);
                        addText(`Learned new technique: ${newAbility}!`, "ability-text");
                    }
                }
            }
        }
        
        // Show help
        function showHelp() {
            clearScreen();
            clearButtons();
            
            addText("ETERNAL DOMINION - HELP", "prompt");
            addText("════════════════════════════════");
            addText("");
            addText("OBJECTIVE: Defeat the arch-magus Zylon by finding");
            addText("the Orb of Perpetuity and confronting him.");
            addText("");
            addText("CORE SYSTEMS:");
            addText("- INVENTORY: Carry items, salves, and equipment");
            addText("- CHARACTER PROGRESSION: Gain XP, level up, learn techniques");
            addText("- EXPANDED WORLD: 15 towns, 7 dungeons, wilderness encounters");
            addText("- COMBAT DEPTH: Stances, techniques, enemy skills");
            addText("");
            addText("NEW SYSTEMS:");
            addText("- NPC INTERACTIONS: Talk to locals, build relationships");
            addText("- MINI-GAMES: Fishing, gambling, hunting, arena fights");
            addText("- ACHIEVEMENTS: Complete challenges for permanent rewards");
            addText("");
            addText("COMBAT ACTIONS:");
            addText("- ATTACK: Basic attack");
            addText("- POWER LUNGE: High damage, lower accuracy");
            addText("- DEFEND: Reduce damage, heal slightly");
            addText("- TECHNIQUES: Special moves learned through leveling");
            addText("- STANCES: Change between balanced/aggressive/defensive");
            addText("");
            addText("PROGRESSION:");
            addText("- Gain XP from defeating enemies");
            addText("- Level up to increase stats and learn techniques");
            addText("- Complete town quests for gold and rewards");
            addText("- Explore dungeons for powerful artifacts");
            addText("- Unlock achievements for permanent bonuses");
            
            addButton("BACK", function() {
                if (gameState.screen === "title") {
                    clearScreen();
                    clearButtons();
                    
                    addText("Welcome to ETERNAL DOMINION: Legacy of the Shattered Orb");
                    addText("An age of despair in the realm of MYTHDRASIL.");
                    addText("ZYLON the Arch-Magus has forged the ORB OF PERPETUITY,");
                    addText("enshrouding the world in endless twilight.");
                    addText("Only a champion of destiny can overthrow him and reclaim the dawn.");
                    addText("");
                    addText("Press START to begin your quest...");
                    
                    addButton("START GAME", startGame);
                    addButton("HELP", showHelp);
                    addButton("CREDITS", showCredits);
                    
                    // Restart main theme if returning to title
                    gameAudio.updateMusicForScreen("title");
                } else {
                    createCharacter();
                }
            });
        }
        
        // Show credits
        function showCredits() {
            clearScreen();
            clearButtons();
            
            addText("ETERNAL DOMINION - CREDITS", "prompt");
            addText("════════════════════════════════");
            addText("");
            addText("Game Design:");
            addText("Inspired by classic RPGs of the 1980s");
            addText("");
            addText("Original Framework:");
            addText("Based on Ultima I concepts");
            addText("");
            addText("This Enhanced Web Adaptation:");
            addText("Created for educational purposes");
            addText("");
            addText("New Systems Added:");
            addText("- NPC Relationship System");
            addText("- Mini-Games (Fishing, Gambling, Hunting, Arena)");
            addText("- Achievement & Progression System");
            addText("- Expanded World Interactions");
            addText("");
            addText("Inspired by the classic RPGs");
            addText("that defined the computer RPG genre.");
            
            addButton("BACK", function() {
                if (gameState.screen === "title") {
                    clearScreen();
                    clearButtons();
                    
                    addText("Welcome to ETERNAL DOMINION: Legacy of the Shattered Orb");
                    addText("An age of despair in the realm of MYTHDRASIL.");
                    addText("ZYLON the Arch-Magus has forged the ORB OF PERPETUITY,");
                    addText("enshrouding the world in endless twilight.");
                    addText("Only a champion of destiny can overthrow him and reclaim the dawn.");
                    addText("");
                    addText("Press START to begin your quest...");
                    
                    addButton("START GAME", startGame);
                    addButton("HELP", showHelp);
                    addButton("CREDITS", showCredits);
                    
                    // Restart main theme if returning to title
                    gameAudio.updateMusicForScreen("title");
                } else {
                    createCharacter();
                }
            });
        }
        
        // Initialize the game when page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
