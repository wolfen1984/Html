<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DreadWood: Bloodstone Keep</title>
    <style>
        /* EXACT SAME STYLE as previous levels */
        body {
            font-family: 'Courier New', monospace;
            background-color: #0a0a2a;
            color: #33ff33;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            border: 2px solid #33ff33;
            background-color: #000;
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #33ff33;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #ff33ff;
            text-shadow: 0 0 5px #ff33ff;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
        }
        
        h2 {
            color: #33ccff;
            border-bottom: 1px solid #33ccff;
            padding-bottom: 5px;
            margin-top: 25px;
        }
        
        .screen {
            display: none;
        }
        
        .active-screen {
            display: block;
        }
        
        .stats-bar {
            background-color: #111133;
            border: 1px solid #33ff33;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-value {
            color: #ffff33;
            font-weight: bold;
        }
        
        .inventory {
            background-color: #111122;
            border: 1px solid #ff33ff;
            padding: 10px;
            margin: 15px 0;
            min-height: 60px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222244;
            border: 1px solid #33ccff;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
        }
        
        .story-text {
            background-color: #111111;
            border: 1px solid #33ff33;
            padding: 15px;
            margin: 20px 0;
            min-height: 150px;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222244;
            color: #33ff33;
            border: 2px solid #33ff33;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333366;
            color: #ffff33;
            border-color: #ffff33;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #330033;
            color: #ff33ff;
            border: 2px solid #ff33ff;
            padding: 10px 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #550055;
            color: #ff99ff;
        }
        
        .dice-roll {
            background-color: #223322;
            border: 1px solid #33ff33;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ffff33;
        }
        
        .game-over {
            color: #ff3333;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #ff3333;
        }
        
        .success {
            color: #33ff33;
            font-weight: bold;
        }
        
        .damage {
            color: #ff3333;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9933;
            font-weight: bold;
        }
        
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #003333;
            color: #33ff99;
            border: 2px solid #33ff99;
            padding: 15px 30px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #005555;
            color: #99ffcc;
        }
        
        .retro-notice {
            text-align: center;
            color: #888888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333333;
            padding-top: 10px;
        }
        
        .warning-dialog {
            background-color: #332222;
            border: 2px solid #ff3333;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .warning-text {
            color: #ff9933;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .dialog-btn {
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid;
        }
        
        .dialog-btn-yes {
            background-color: #223322;
            color: #33ff33;
            border-color: #33ff33;
        }
        
        .dialog-btn-no {
            background-color: #332222;
            color: #ff3333;
            border-color: #ff3333;
        }
        
        .bloodstone-decoration {
            color: #ff3333;
            font-style: italic;
        }
        
        .fortress-decoration {
            color: #993333;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 10px;
                font-size: 14px;
            }
            
            .dialog-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DREADWOOD</h1>
            <h2>BLOODSTONE KEEP</h2>
            <div class="retro-notice">Level 4 - Your Adventure Continues</div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item">SKILL: <span id="stat-skill" class="stat-value">0</span></div>
                <div class="stat-item">STAMINA: <span id="stat-stamina" class="stat-value">0</span>/<span id="stat-maxstamina" class="stat-value">0</span></div>
                <div class="stat-item">LUCK: <span id="stat-luck" class="stat-value">0</span></div>
                <div class="stat-item">GOLD: <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <h2>INVENTORY</h2>
            <div class="inventory" id="inventory">
                <!-- Inventory will be loaded from saved game -->
            </div>
            
            <h2>THE ADVENTURE</h2>
            <div class="story-text" id="story-text">
                <p>You stand before <span class="bloodstone-decoration">BLOODSTONE KEEP</span>, a fortress of dark stone that seems to bleed crimson in the fading light. The air is cold and carries the scent of iron and decay. From within, you hear the distant echo of steel on steel and ominous chanting. Your journey through this haunted fortress begins now...</p>
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <button class="choice-btn" onclick="loadSection(1)">Approach the main gates</button>
                <button class="choice-btn" onclick="loadSection(2)">Search for a hidden entrance</button>
                <button class="choice-btn" onclick="loadSection(3)">Scale the outer walls</button>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useLuck()">TEST LUCK</button>
                <button class="action-btn" onclick="checkInventory()">INVENTORY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="showNewGameWarning()">START NEW GAME</button>
            </div>
        </div>
        
        <!-- Warning Dialog for New Game -->
        <div id="warning-dialog" class="screen">
            <div class="warning-dialog">
                <div class="warning-text">WARNING: Starting a new game will delete ALL your current progress!</div>
                <p>Your current character, stats, inventory, and gold will be permanently erased.</p>
                <p>You will return to the beginning of the game to create a new character.</p>
                <div class="dialog-buttons">
                    <button class="dialog-btn dialog-btn-yes" onclick="startNewGame()">YES, START NEW GAME</button>
                    <button class="dialog-btn dialog-btn-no" onclick="cancelNewGame()">NO, KEEP MY CHARACTER</button>
                </div>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>VICTORY!</h2>
            <div class="story-text">
                <p>You have conquered <span class="bloodstone-decoration">BLOODSTONE KEEP</span>!</p>
                <p>After battling through the fortress and defeating its dark master, you emerge victorious. Beyond the keep stretches the <span class="enemy">ASHEN WASTES</span>, a barren desert of black sand and ash where nothing grows and the very air burns the lungs.</p>
                <p>Your journey continues... All your stats, gold, and inventory will carry over to the next chapter.</p>
                <div class="stats-bar">
                    <div class="stat-item">SKILL: <span id="next-stat-skill" class="stat-value">0</span></div>
                    <div class="stat-item">STAMINA: <span id="next-stat-stamina" class="stat-value">0</span></div>
                    <div class="stat-item">LUCK: <span id="next-stat-luck" class="stat-value">0</span></div>
                    <div class="stat-item">GOLD: <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO ASHEN WASTES</button>
            </div>
        </div>
        
        <div class="retro-notice">
            DREADWOOD - A Retro Gamebook Adventure<br>
            Level 4: Bloodstone Keep
        </div>
    </div>

    <script>
        // Game state (loaded from localStorage)
        let gameState = JSON.parse(localStorage.getItem('dreadwoodGameState')) || {
            playerClass: 'warrior',
            skill: 10,
            maxStamina: 18,
            stamina: 18,
            luck: 10,
            gold: 20,
            inventory: ['Dagger', 'Leather Armor'],
            weapons: [{name: 'Dagger', damage: '1d6'}],
            armor: [{name: 'Leather Armor', defense: 1}],
            currentWeaponIndex: 0,
            currentArmorIndex: 0,
            currentSection: 0,
            gameComplete: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyStamina: 0,
            enemyCurrentStamina: 0,
            enemySkill: 0,
            nextSection: 0,
            round: 1
        };
        
        // Reset currentSection when starting a new level
        if (gameState.currentSection === 200 || gameState.gameComplete) {
            gameState.currentSection = 0;
            gameState.gameComplete = false;
        }
        
        // Ensure indices exist
        if (gameState.currentWeaponIndex === undefined) {
            gameState.currentWeaponIndex = gameState.weapons.length - 1;
        }
        if (gameState.currentArmorIndex === undefined) {
            gameState.currentArmorIndex = gameState.armor.length - 1;
        }
        
        // Level 4 story sections - BLOODSTONE KEEP
        const storySections = {
            0: {
                text: "You stand before <span class='bloodstone-decoration'>BLOODSTONE KEEP</span>, a fortress of dark stone that seems to bleed crimson in the fading light. The air is cold and carries the scent of iron and decay. From within, you hear the distant echo of steel on steel and ominous chanting. Your journey through this haunted fortress begins now...",
                choices: [
                    {text: "Approach the main gates", nextSection: 1, skillCheck: false},
                    {text: "Search for a hidden entrance", nextSection: 2, skillCheck: false},
                    {text: "Scale the outer walls", nextSection: 3, skillCheck: false}
                ]
            },
            1: {
                text: "You approach the massive iron-banded gates of Bloodstone Keep. Two armored guards stand watch, their armor stained with what looks like dried blood. 'Halt! None may enter without the Master's permission!' one growls.",
                choices: [
                    {text: "Try to bluff your way in", nextSection: 4, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Attack the guards", nextSection: 101, skillCheck: false},
                    {text: "Bribe the guards", nextSection: 5, skillCheck: false},
                    {text: "Back away and find another way", nextSection: 2, skillCheck: false}
                ]
            },
            2: {
                text: "You circle around the keep, searching for an alternative entrance. You find a narrow crevice in the stone wall, partially hidden by thorny vines.",
                choices: [
                    {text: "Squeeze through the crevice", nextSection: 6, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Clear the vines first", nextSection: 7, skillCheck: false},
                    {text: "Look for another hidden entrance", nextSection: 8, skillCheck: false}
                ]
            },
            3: {
                text: "You find a section of the outer wall with enough handholds to attempt climbing. The stone is rough and cold to the touch.",
                choices: [
                    {text: "Attempt to climb the wall", nextSection: 9, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Look for climbing equipment", nextSection: 10, skillCheck: false},
                    {text: "Abandon the climbing attempt", nextSection: 2, skillCheck: false}
                ]
            },
            4: {
                text: "You attempt to bluff your way past the guards...",
                choices: [
                    {text: "Continue", nextSection: 11, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "'The Master is expecting me,' you say confidently. The guards look at each other, then step aside. 'Proceed.'";
                    } else {
                        gameState.stamina -= 3;
                        updateStatsDisplay();
                        return "'Liar!' the guard shouts. 'No one enters without the password!' He strikes you with the butt of his spear, dealing 3 damage.";
                    }
                }
            },
            5: {
                text: "'Perhaps we can come to an arrangement,' you say, reaching for your gold pouch.",
                choices: [
                    {text: "Offer 20 Gold", nextSection: 12, skillCheck: false},
                    {text: "Offer 50 Gold", nextSection: 13, skillCheck: false},
                    {text: "Decide not to bribe them", nextSection: 1, skillCheck: false}
                ]
            },
            6: {
                text: window.checkResult ? 
                    "You successfully squeeze through the narrow crevice, emerging in a dark storage room filled with barrels and crates." : 
                    "You get stuck in the crevice! After struggling free, you take 4 damage from scraping against the rough stone.",
                choices: [
                    window.checkResult ? 
                        {text: "Explore the storage room", nextSection: 14, skillCheck: false} :
                        {text: "Try a different approach", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult) {
                        gameState.stamina -= 4;
                        updateStatsDisplay();
                    }
                }
            },
            7: {
                text: "You clear away the thorny vines, getting scratched in the process (lose 2 Stamina). Behind them, you find not just a crevice, but a small, hidden door.",
                choices: [
                    {text: "Enter through the hidden door", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina -= 2;
                    updateStatsDisplay();
                }
            },
            8: {
                text: "You continue searching and find a drainage grate at the base of the wall. It's rusty but might be pried open.",
                choices: [
                    {text: "Try to pry open the grate", nextSection: 16, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Return to the main gates", nextSection: 1, skillCheck: false}
                ]
            },
            9: {
                text: window.checkResult ? 
                    "You scale the wall skillfully, pulling yourself onto a deserted parapet overlooking the keep's courtyard." : 
                    "You slip and fall from halfway up! You take 8 damage from the fall.",
                choices: [
                    window.checkResult ? 
                        {text: "Explore the parapet", nextSection: 17, skillCheck: false} :
                        {text: "Try a different approach", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult) {
                        gameState.stamina -= 8;
                        updateStatsDisplay();
                        if (gameState.stamina <= 0) {
                            return "You fall to your death. Game Over.";
                        }
                    }
                }
            },
            10: {
                text: "You search the area and find a discarded rope with a grappling hook attached! This will make climbing much easier.",
                choices: [
                    {text: "Use the grappling hook to climb", nextSection: 18, skillCheck: false},
                    {text: "Take it and try another approach", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Grappling Hook");
                    updateInventoryDisplay();
                }
            },
            11: {
                text: window.checkResult ? 
                    "The guards let you pass. You enter the main courtyard of Bloodstone Keep. The place is eerily quiet." : 
                    "After being struck, you decide to find another way in.",
                choices: [
                    window.checkResult ? 
                        {text: "Explore the courtyard", nextSection: 19, skillCheck: false} :
                        {text: "Find another entrance", nextSection: 2, skillCheck: false}
                ]
            },
            12: {
                text: "You offer 20 Gold to the guards. They take it but shake their heads. 'Not enough. The Master pays us more than that to stay loyal.'",
                choices: [
                    {text: "Offer more", nextSection: 13, skillCheck: false},
                    {text: "Attack them", nextSection: 101, skillCheck: false},
                    {text: "Retreat", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 20) {
                        gameState.gold -= 20;
                        updateStatsDisplay();
                    }
                }
            },
            13: {
                text: gameState.gold >= 50 ? 
                    "You offer 50 Gold. The guards' eyes light up. 'Very well. But if the Master asks, we never saw you.' They open the gates just enough for you to slip through." : 
                    "You don't have enough gold for such a bribe.",
                choices: [
                    gameState.gold >= 50 ? 
                        {text: "Enter the keep", nextSection: 19, skillCheck: false} :
                        {text: "Try a different approach", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 50) {
                        gameState.gold -= 50;
                        updateStatsDisplay();
                    }
                }
            },
            14: {
                text: "You're in a dark storage room. Barrels of what smells like salted meat and crates of supplies line the walls. A single door leads out.",
                choices: [
                    {text: "Search the room for useful items", nextSection: 20, skillCheck: false},
                    {text: "Leave through the door", nextSection: 21, skillCheck: false},
                    {text: "Hide and listen for sounds", nextSection: 22, skillCheck: false}
                ]
            },
            15: {
                text: "The hidden door opens into a narrow passageway that smells of damp earth and mildew. Torches flicker in sconces along the wall.",
                choices: [
                    {text: "Follow the passageway", nextSection: 23, skillCheck: false},
                    {text: "Take a torch", nextSection: 24, skillCheck: false},
                    {text: "Close the door and find another way", nextSection: 2, skillCheck: false}
                ]
            },
            16: {
                text: window.checkResult ? 
                    "You pry open the rusty grate and slip into a drainage tunnel that leads into the keep's lower levels." : 
                    "The grate won't budge. It's rusted shut.",
                choices: [
                    window.checkResult ? 
                        {text: "Follow the drainage tunnel", nextSection: 25, skillCheck: false} :
                        {text: "Return to searching", nextSection: 2, skillCheck: false}
                ]
            },
            17: {
                text: "You're on a deserted parapet overlooking the keep's interior. Below, you see guards patrolling and, in the center courtyard, a strange altar stained dark red.",
                choices: [
                    {text: "Descend into the courtyard", nextSection: 26, skillCheck: false},
                    {text: "Follow the parapet around the keep", nextSection: 27, skillCheck: false},
                    {text: "Look for a way down into the keep itself", nextSection: 28, skillCheck: false}
                ]
            },
            18: {
                text: "Using the grappling hook, you easily scale the wall and land quietly on a deserted parapet.",
                choices: [
                    {text: "Explore the parapet", nextSection: 17, skillCheck: false}
                ]
            },
            19: {
                text: "You're in the main courtyard of Bloodstone Keep. The altar in the center seems to be the source of the dark energy you feel. Three paths lead from the courtyard.",
                choices: [
                    {text: "Approach the altar", nextSection: 29, skillCheck: false},
                    {text: "Take the left path toward the barracks", nextSection: 30, skillCheck: false},
                    {text: "Take the center path toward the main keep", nextSection: 31, skillCheck: false},
                    {text: "Take the right path toward the dungeons", nextSection: 32, skillCheck: false}
                ]
            },
            20: {
                text: "You search the storage room. Among the supplies, you find a small chest hidden behind some barrels.",
                choices: [
                    {text: "Open the chest", nextSection: 33, skillCheck: false},
                    {text: "Ignore it and leave", nextSection: 21, skillCheck: false}
                ]
            },
            21: {
                text: "You leave the storage room through the door, emerging in a dimly lit corridor. You can hear footsteps approaching from the left.",
                choices: [
                    {text: "Hide in a nearby alcove", nextSection: 34, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Prepare to fight", nextSection: 35, skillCheck: false},
                    {text: "Run in the opposite direction", nextSection: 36, skillCheck: false}
                ]
            },
            22: {
                text: "You hide and listen. You hear two guards talking as they pass by the storage room door: '...the ritual is almost complete. The Master will be pleased when the blood moon rises.'",
                choices: [
                    {text: "Wait for them to pass, then leave", nextSection: 37, skillCheck: false},
                    {text: "Ambush the guards", nextSection: 35, skillCheck: false},
                    {text: "Follow them", nextSection: 38, skillCheck: true, checkType: 'skill', difficulty: 12}
                ]
            },
            23: {
                text: "The passageway leads to a junction. The air grows colder, and you hear chanting coming from the right.",
                choices: [
                    {text: "Follow the chanting", nextSection: 39, skillCheck: false},
                    {text: "Take the left passage", nextSection: 40, skillCheck: false},
                    {text: "Continue straight ahead", nextSection: 41, skillCheck: false}
                ]
            },
            24: {
                text: "You take a torch from the wall. The light reveals markings on the walls - ancient runes that seem to pulse with dark energy.",
                choices: [
                    {text: "Follow the passageway", nextSection: 42, skillCheck: false},
                    {text: "Study the runes", nextSection: 43, skillCheck: true, checkType: 'skill', difficulty: 13}
                ]
            },
            25: {
                text: "The drainage tunnel is wet and foul-smelling. It ends at a metal grate overlooking a chamber below. You can see cultists performing a ritual around a bound prisoner.",
                choices: [
                    {text: "Break through the grate and attack", nextSection: 44, skillCheck: false},
                    {text: "Wait and observe", nextSection: 45, skillCheck: false},
                    {text: "Look for another way around", nextSection: 46, skillCheck: false}
                ]
            },
            26: {
                text: "You climb down from the parapet into the courtyard. As your feet touch the ground, two guards spot you!",
                choices: [
                    {text: "Fight the guards", nextSection: 2601, skillCheck: false},
                    {text: "Try to talk your way out", nextSection: 47, skillCheck: true, checkType: 'luck', difficulty: 11},
                    {text: "Run toward the nearest building", nextSection: 48, skillCheck: false}
                ]
            },
            2601: {
                text: "You face the Courtyard Guards! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 2602, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Courtyard Guards";
                    combatState.enemyStamina = 16;
                    combatState.enemyCurrentStamina = 16;
                    combatState.enemySkill = 9;
                    combatState.nextSection = 49;
                    combatState.round = 1;
                    
                    return "Courtyard Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            27: {
                text: "You follow the parapet around the keep. It leads to a tower with an open window.",
                choices: [
                    {text: "Enter through the window", nextSection: 50, skillCheck: false},
                    {text: "Continue along the parapet", nextSection: 51, skillCheck: false},
                    {text: "Return to where you climbed up", nextSection: 17, skillCheck: false}
                ]
            },
            28: {
                text: "You find a trapdoor on the parapet that leads down into the keep. It's locked.",
                choices: [
                    {text: "Try to pick the lock", nextSection: 52, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Force it open", nextSection: 53, skillCheck: false},
                    {text: "Look for another way down", nextSection: 26, skillCheck: false}
                ]
            },
            29: {
                text: "You approach the dark altar. The stone is stained a deep crimson, and strange symbols are carved into its surface. A sense of dread washes over you.",
                choices: [
                    {text: "Examine the symbols", nextSection: 54, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Search around the altar", nextSection: 55, skillCheck: false},
                    {text: "Destroy the altar", nextSection: 56, skillCheck: false},
                    {text: "Leave it alone", nextSection: 19, skillCheck: false}
                ]
            },
            30: {
                text: "You approach the barracks. Through an open door, you see guards resting and playing cards. Weapons and armor are stacked along the walls.",
                choices: [
                    {text: "Sneak past the barracks", nextSection: 57, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Attack the guards in the barracks", nextSection: 58, skillCheck: false},
                    {text: "Try to steal some equipment", nextSection: 59, skillCheck: false},
                    {text: "Return to the courtyard", nextSection: 19, skillCheck: false}
                ]
            },
            31: {
                text: "You approach the main keep, a towering structure of black stone. The massive doors are adorned with iron spikes and the same crimson stains as the altar.",
                choices: [
                    {text: "Try to open the doors", nextSection: 60, skillCheck: false},
                    {text: "Look for another entrance", nextSection: 61, skillCheck: false},
                    {text: "Return to the courtyard", nextSection: 19, skillCheck: false}
                ]
            },
            32: {
                text: "The path to the dungeons descends into darkness. The air grows cold and damp, and you hear faint moans from below.",
                choices: [
                    {text: "Descend into the dungeons", nextSection: 62, skillCheck: false},
                    {text: "Return to the courtyard", nextSection: 19, skillCheck: false}
                ]
            },
            33: {
                text: "You open the chest and find 40 Gold and a vial of crimson liquid that glows with inner light.",
                choices: [
                    {text: "Take the items and leave", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 40;
                    gameState.inventory.push("Crimson Elixir");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    return "You find 40 Gold and a Crimson Elixir!";
                }
            },
            34: {
                text: window.checkResult ? 
                    "You hide successfully as two guards pass by, discussing their shift change. They don't notice you." : 
                    "You're spotted! The guards draw their weapons!",
                choices: [
                    window.checkResult ? 
                        {text: "Continue down the corridor", nextSection: 63, skillCheck: false} :
                        {text: "Fight the guards", nextSection: 3501, skillCheck: false}
                ]
            },
            35: {
                text: "You prepare to fight the approaching guards!",
                choices: [
                    {text: "Begin the battle!", nextSection: 3501, skillCheck: false}
                ]
            },
            3501: {
                text: "You face the Keep Guards! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 3502, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Keep Guards";
                    combatState.enemyStamina = 14;
                    combatState.enemyCurrentStamina = 14;
                    combatState.enemySkill = 8;
                    combatState.nextSection = 64;
                    combatState.round = 1;
                    
                    return "Keep Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            36: {
                text: "You run in the opposite direction, turning down a side corridor. You find yourself in a small chapel with stained glass windows depicting dark rituals.",
                choices: [
                    {text: "Search the chapel", nextSection: 65, skillCheck: false},
                    {text: "Hide in the chapel", nextSection: 66, skillCheck: false},
                    {text: "Continue running", nextSection: 67, skillCheck: false}
                ]
            },
            37: {
                text: "After the guards pass, you quietly leave the storage room and head down the corridor.",
                choices: [
                    {text: "Follow the direction the guards came from", nextSection: 68, skillCheck: false},
                    {text: "Go in the opposite direction", nextSection: 63, skillCheck: false}
                ]
            },
            38: {
                text: window.checkResult ? 
                    "You successfully follow the guards at a distance. They lead you to a heavily guarded door where they're relieved by two other guards." : 
                    "The guards hear you following! They turn and attack!",
                choices: [
                    window.checkResult ? 
                        {text: "Observe the door", nextSection: 69, skillCheck: false} :
                        {text: "Fight the guards", nextSection: 3501, skillCheck: false}
                ]
            },
            39: {
                text: "The chanting grows louder. You peer around a corner and see cultists in red robes performing a ritual in a circular chamber. In the center floats a glowing red crystal.",
                choices: [
                    {text: "Attack the cultists", nextSection: 3901, skillCheck: false},
                    {text: "Observe from hiding", nextSection: 70, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Try to steal the crystal", nextSection: 71, skillCheck: false},
                    {text: "Retreat", nextSection: 72, skillCheck: false}
                ]
            },
            3901: {
                text: "You face the Bloodstone Cultists! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 3902, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Bloodstone Cultists";
                    combatState.enemyStamina = 20;
                    combatState.enemyCurrentStamina = 20;
                    combatState.enemySkill = 10;
                    combatState.nextSection = 73;
                    combatState.round = 1;
                    
                    return "Bloodstone Cultists: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            40: {
                text: "The left passage leads to a library filled with ancient tomes and scrolls. Dust covers everything, but one book on a pedestal seems clean and recently used.",
                choices: [
                    {text: "Examine the book", nextSection: 74, skillCheck: false},
                    {text: "Search the library", nextSection: 75, skillCheck: false},
                    {text: "Leave the library", nextSection: 76, skillCheck: false}
                ]
            },
            41: {
                text: "Continuing straight ahead, you come to a staircase leading up. You can hear voices from above.",
                choices: [
                    {text: "Ascend the staircase", nextSection: 77, skillCheck: false},
                    {text: "Return to the junction", nextSection: 23, skillCheck: false}
                ]
            },
            42: {
                text: "With torch in hand, you follow the passageway. The runes on the walls seem to react to the light, glowing faintly.",
                choices: [
                    {text: "Continue following the passage", nextSection: 78, skillCheck: false},
                    {text: "Study the runes more closely", nextSection: 43, skillCheck: true, checkType: 'skill', difficulty: 13}
                ]
            },
            43: {
                text: window.checkResult ? 
                    "You decipher some of the runes: 'Blood... power... eternal... sacrifice...' They seem to be part of a ritual to summon or empower something dark." : 
                    "The runes are in an ancient language you can't decipher, but they feel ominous.",
                choices: [
                    {text: "Continue down the passage", nextSection: 78, skillCheck: false}
                ]
            },
            44: {
                text: "You break through the grate and drop into the chamber, surprising the cultists!",
                choices: [
                    {text: "Attack immediately", nextSection: 3901, skillCheck: false},
                    {text: "Free the prisoner first", nextSection: 79, skillCheck: false}
                ]
            },
            45: {
                text: "You watch as the cultists complete their ritual. The prisoner screams as dark energy flows from him into the crystal. The lead cultist takes the now-glowing crystal and leaves.",
                choices: [
                    {text: "Follow the lead cultist", nextSection: 80, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: Help the dying prisoner", nextSection: 81, skillCheck: false},
                    {text: "Attack the remaining cultists", nextSection: 3901, skillCheck: false}
                ]
            },
            46: {
                text: "You backtrack and find another tunnel branch. It leads to a ladder going up.",
                choices: [
                    {text: "Climb the ladder", nextSection: 82, skillCheck: false}
                ]
            },
            47: {
                text: window.checkResult ? 
                    "'I'm here for the ritual,' you say quickly. The guards look at each other. 'Very well. The Master is in the main keep.' They let you pass." : 
                    "'You're no cultist!' the guard shouts. 'Get him!'",
                choices: [
                    window.checkResult ? 
                        {text: "Head toward the main keep", nextSection: 31, skillCheck: false} :
                        {text: "Fight the guards", nextSection: 2601, skillCheck: false}
                ]
            },
            48: {
                text: "You run toward the nearest building and slip inside just as the guards give chase. You're in an armory filled with weapons and armor.",
                choices: [
                    {text: "Barricade the door", nextSection: 83, skillCheck: false},
                    {text: "Grab a weapon and prepare to fight", nextSection: 84, skillCheck: false},
                    {text: "Look for another exit", nextSection: 85, skillCheck: false}
                ]
            },
            49: {
                text: "After defeating the guards, you search them and find a key and 25 Gold.",
                choices: [
                    {text: "Take the key and gold, then explore", nextSection: 86, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 25;
                    gameState.inventory.push("Guard's Key");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                }
            },
            50: {
                text: "You climb through the window into a tower room. It's a wizard's study, with alchemical equipment and spellbooks everywhere. A large crystal ball dominates one table.",
                choices: [
                    {text: "Examine the crystal ball", nextSection: 87, skillCheck: false},
                    {text: "Search the spellbooks", nextSection: 88, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Take any useful items", nextSection: 89, skillCheck: false},
                    {text: "Leave the study", nextSection: 90, skillCheck: false}
                ]
            },
            51: {
                text: "Continuing along the parapet, you reach a dead end. However, there's a good view of the courtyard below.",
                choices: [
                    {text: "Observe the courtyard", nextSection: 91, skillCheck: false},
                    {text: "Return to the tower window", nextSection: 50, skillCheck: false}
                ]
            },
            52: {
                text: window.checkResult ? 
                    "You successfully pick the lock. The trapdoor opens to reveal a ladder descending into darkness." : 
                    "The lock is too complex. You can't pick it.",
                choices: [
                    window.checkResult ? 
                        {text: "Descend the ladder", nextSection: 92, skillCheck: false} :
                        {text: "Force it open", nextSection: 53, skillCheck: false}
                ]
            },
            53: {
                text: "You force the trapdoor open with a loud crack! The noise will surely attract attention.",
                choices: [
                    {text: "Descend quickly", nextSection: 92, skillCheck: false},
                    {text: "Wait and see if anyone comes", nextSection: 93, skillCheck: false}
                ]
            },
            54: {
                text: window.checkResult ? 
                    "The symbols are part of a blood magic ritual designed to empower a 'Lord of Blood.' The final ritual requires a 'heart of stone' during a blood moon." : 
                    "The symbols make no sense to you, but they radiate malevolent energy.",
                choices: [
                    {text: "Search around the altar", nextSection: 55, skillCheck: false},
                    {text: "Destroy the altar", nextSection: 56, skillCheck: false},
                    {text: "Leave", nextSection: 19, skillCheck: false}
                ]
            },
            55: {
                text: "You search around the altar and find a hidden compartment containing a blood-red gem and a ritual dagger.",
                choices: [
                    {text: "Take the items", nextSection: 94, skillCheck: false},
                    {text: "Leave them", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Blood Ruby", "Ritual Dagger");
                    gameState.weapons.push({name: 'Ritual Dagger', damage: '1d6+1'});
                    updateInventoryDisplay();
                }
            },
            56: {
                text: "You attack the altar! As your weapon strikes the stone, a wave of dark energy erupts, throwing you back! You take 10 damage and alert every guard in the keep!",
                choices: [
                    {text: "Fight the approaching guards", nextSection: 5601, skillCheck: false},
                    {text: "Run for your life", nextSection: 95, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina -= 10;
                    updateStatsDisplay();
                    if (gameState.stamina <= 0) {
                        return "The dark energy kills you instantly. Game Over.";
                    }
                }
            },
            5601: {
                text: "You face the Enraged Keep Guards! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 5602, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Enraged Keep Guards";
                    combatState.enemyStamina = 24;
                    combatState.enemyCurrentStamina = 24;
                    combatState.enemySkill = 11;
                    combatState.nextSection = 96;
                    combatState.round = 1;
                    
                    return "Enraged Keep Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            57: {
                text: window.checkResult ? 
                    "You successfully sneak past the barracks without being noticed." : 
                    "A guard spots you! 'Intruder!' he shouts, alerting the others.",
                choices: [
                    window.checkResult ? 
                        {text: "Continue past the barracks", nextSection: 97, skillCheck: false} :
                        {text: "Fight the alerted guards", nextSection: 5801, skillCheck: false}
                ]
            },
            58: {
                text: "You attack the guards in the barracks!",
                choices: [
                    {text: "Begin the battle!", nextSection: 5801, skillCheck: false}
                ]
            },
            5801: {
                text: "You face the Barracks Guards! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 5802, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Barracks Guards";
                    combatState.enemyStamina = 18;
                    combatState.enemyCurrentStamina = 18;
                    combatState.enemySkill = 9;
                    combatState.nextSection = 98;
                    combatState.round = 1;
                    
                    return "Barracks Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            59: {
                text: "You try to steal equipment while the guards are distracted.",
                choices: [
                    {text: "Steal a better weapon", nextSection: 99, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Steal armor", nextSection: 100, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Take gold from their belongings", nextSection: 101, skillCheck: true, checkType: 'skill', difficulty: 10}
                ]
            },
            60: {
                text: "You try to open the massive doors of the main keep. They're locked, but you notice a keyhole shaped like a drop of blood.",
                choices: [
                    {text: "Try to pick the lock", nextSection: 102, skillCheck: true, checkType: 'skill', difficulty: 15},
                    {text: "Look for the key", nextSection: 103, skillCheck: false},
                    {text: "Force the doors", nextSection: 104, skillCheck: false}
                ]
            },
            61: {
                text: "You circle around the main keep and find a servants' entrance. It's unguarded but likely trapped.",
                choices: [
                    {text: "Enter through the servants' entrance", nextSection: 105, skillCheck: true, checkType: 'luck', difficulty: 12},
                    {text: "Return to the courtyard", nextSection: 19, skillCheck: false}
                ]
            },
            62: {
                text: "You descend into the dungeons. The moans grow louder. Cells line the corridor, most occupied by emaciated prisoners.",
                choices: [
                    {text: "Free the prisoners", nextSection: 106, skillCheck: false},
                    {text: "Question a prisoner", nextSection: 107, skillCheck: false},
                    {text: "Search for the jailer", nextSection: 108, skillCheck: false},
                    {text: "Return to the courtyard", nextSection: 19, skillCheck: false}
                ]
            },
            63: {
                text: "You continue down the corridor. It ends at a T-junction. To the left, you hear clanging metal. To the right, there's silence.",
                choices: [
                    {text: "Go left toward the sound", nextSection: 109, skillCheck: false},
                    {text: "Go right into the silence", nextSection: 110, skillCheck: false}
                ]
            },
            64: {
                text: "After defeating the guards, you search the corridor. One of them had a map of the keep's lower levels.",
                choices: [
                    {text: "Take the map and continue", nextSection: 111, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Keep Map");
                    updateInventoryDisplay();
                }
            },
            65: {
                text: "You search the dark chapel. Behind the altar, you find a hidden compartment containing a holy symbol that glows with pure light.",
                choices: [
                    {text: "Take the holy symbol", nextSection: 112, skillCheck: false},
                    {text: "Leave it", nextSection: 113, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Holy Symbol");
                    updateInventoryDisplay();
                }
            },
            66: {
                text: "You hide in the chapel as the guards run past outside. After they pass, you can leave safely.",
                choices: [
                    {text: "Leave the chapel", nextSection: 114, skillCheck: false}
                ]
            },
            67: {
                text: "You continue running and burst through a door into a kitchen. A surprised cook stares at you, ladle in hand.",
                choices: [
                    {text: "Attack the cook", nextSection: 115, skillCheck: false},
                    {text: "Try to bluff", nextSection: 116, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Run through the kitchen", nextSection: 117, skillCheck: false}
                ]
            },
            68: {
                text: "You follow the direction the guards came from. The corridor leads to a stairwell going both up and down.",
                choices: [
                    {text: "Go up", nextSection: 118, skillCheck: false},
                    {text: "Go down", nextSection: 119, skillCheck: false}
                ]
            },
            69: {
                text: "You observe the heavily guarded door. It must be important. Four elite guards stand watch.",
                choices: [
                    {text: "Try to sneak past", nextSection: 120, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Attack the guards", nextSection: 121, skillCheck: false},
                    {text: "Create a distraction", nextSection: 122, skillCheck: false},
                    {text: "Leave and find another way", nextSection: 123, skillCheck: false}
                ]
            },
            70: {
                text: window.checkResult ? 
                    "You observe unseen. The ritual is almost complete. The lead cultist chants: 'With this sacrifice, the Blood Lord shall rise!'" : 
                    "You're spotted! The cultists turn toward you!",
                choices: [
                    window.checkResult ? 
                        {text: "Attack before they complete the ritual", nextSection: 3901, skillCheck: false} :
                        {text: "Fight the cultists", nextSection: 3901, skillCheck: false}
                ]
            },
            71: {
                text: "You try to steal the glowing crystal while the cultists are focused on their ritual.",
                choices: [
                    {text: "Attempt the theft", nextSection: 124, skillCheck: true, checkType: 'skill', difficulty: 13}
                ]
            },
            72: {
                text: "You retreat from the chanting and return to the junction.",
                choices: [
                    {text: "Take the left passage", nextSection: 40, skillCheck: false},
                    {text: "Continue straight ahead", nextSection: 41, skillCheck: false}
                ]
            },
            73: {
                text: "After defeating the cultists, the glowing crystal falls to the ground. The bound prisoner, barely alive, whispers: 'Thank you... the Master... in the tower... stop him...'",
                choices: [
                    {text: "Take the crystal", nextSection: 125, skillCheck: false},
                    {text: "Free the prisoner", nextSection: 126, skillCheck: false},
                    {text: "Search the chamber", nextSection: 127, skillCheck: false}
                ]
            },
            74: {
                text: "The book is titled 'Rituals of Blood and Stone.' It details the exact ritual being performed in the keep. The final page mentions a weakness: 'Pure light disrupts the blood magic.'",
                choices: [
                    {text: "Take the book", nextSection: 128, skillCheck: false},
                    {text: "Search the library", nextSection: 75, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Ritual Book");
                    updateInventoryDisplay();
                }
            },
            75: {
                text: "You search the library and find a hidden panel behind a bookcase. Behind it is a small treasure chest.",
                choices: [
                    {text: "Open the chest", nextSection: 129, skillCheck: false},
                    {text: "Leave it", nextSection: 76, skillCheck: false}
                ]
            },
            76: {
                text: "You leave the library and return to the junction.",
                choices: [
                    {text: "Follow the chanting", nextSection: 39, skillCheck: false},
                    {text: "Continue straight ahead", nextSection: 41, skillCheck: false}
                ]
            },
            77: {
                text: "You ascend the staircase and find yourself in a corridor overlooking the courtyard below. Two guards stand at attention nearby.",
                choices: [
                    {text: "Attack the guards", nextSection: 130, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 131, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Return down the staircase", nextSection: 41, skillCheck: false}
                ]
            },
            78: {
                text: "The passageway ends at a heavy wooden door. You can hear voices arguing on the other side.",
                choices: [
                    {text: "Listen at the door", nextSection: 132, skillCheck: false},
                    {text: "Open the door", nextSection: 133, skillCheck: false},
                    {text: "Return the way you came", nextSection: 23, skillCheck: false}
                ]
            },
            79: {
                text: "You free the prisoner first. He collapses, weak from the ritual. 'Thank you... the crystal... it must be destroyed... or the Blood Lord will rise...'",
                choices: [
                    {text: "Attack the cultists", nextSection: 3901, skillCheck: false},
                    {text: "Ask the prisoner more questions", nextSection: 134, skillCheck: false}
                ]
            },
            80: {
                text: window.checkResult ? 
                    "You successfully follow the lead cultist as he carries the glowing crystal through winding corridors to a heavily guarded tower." : 
                    "The cultist hears you following! He turns and attacks with dark magic!",
                choices: [
                    window.checkResult ? 
                        {text: "Observe the tower entrance", nextSection: 135, skillCheck: false} :
                        {text: "Fight the cultist", nextSection: 136, skillCheck: false}
                ]
            },
            81: {
                text: "You rush to help the dying prisoner. He gasps: 'Too late for me... stop the ritual... the Heart of Bloodstone... in the highest tower...' He dies in your arms.",
                choices: [
                    {text: "Take his belongings", nextSection: 137, skillCheck: false},
                    {text: "Leave him in peace", nextSection: 138, skillCheck: false}
                ]
            },
            82: {
                text: "You climb the ladder and emerge in a pantry filled with food stores. A door leads out to a kitchen.",
                choices: [
                    {text: "Enter the kitchen", nextSection: 139, skillCheck: false},
                    {text: "Hide in the pantry", nextSection: 140, skillCheck: false}
                ]
            },
            // Combat sections (similar to previous levels)
            101: {
                text: "You attack the gate guards!",
                choices: [
                    {text: "Begin the battle!", nextSection: 10101, skillCheck: false}
                ]
            },
            10101: {
                text: "You face the Gate Guards! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 10102, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Gate Guards";
                    combatState.enemyStamina = 18;
                    combatState.enemyCurrentStamina = 18;
                    combatState.enemySkill = 10;
                    combatState.nextSection = 141;
                    combatState.round = 1;
                    
                    return "Gate Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            // More sections would continue the story...
            // Final victory section
            200: {
                text: "You have conquered <span class='bloodstone-decoration'>BLOODSTONE KEEP</span>! After battling through the fortress and defeating the Blood Lord, the dark energy dissipates. The stones stop their crimson bleeding, and the keep falls silent. Beyond lies the <span class='enemy'>ASHEN WASTES</span>, your next challenge.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-skill').textContent = gameState.skill;
                    document.getElementById('next-stat-stamina').textContent = gameState.stamina;
                    document.getElementById('next-stat-luck').textContent = gameState.luck;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    return "You've completed Level 4: Bloodstone Keep! Your journey continues to the Ashen Wastes...";
                }
            }
        };

        // Initialize game
        function initGame() {
            updateStatsDisplay();
            updateInventoryDisplay();
            
            if (gameState.currentSection > 0) {
                loadSection(gameState.currentSection);
            } else {
                loadSection(0);
            }
        }
        
        // Show warning dialog for new game
        function showNewGameWarning() {
            document.getElementById('screen-game').classList.remove('active-screen');
            document.getElementById('warning-dialog').classList.add('active-screen');
        }
        
        // Cancel new game and return to game screen
        function cancelNewGame() {
            document.getElementById('warning-dialog').classList.remove('active-screen');
            document.getElementById('screen-game').classList.add('active-screen');
        }
        
        // Start new game - reset everything
        function startNewGame() {
            localStorage.removeItem('dreadwoodGameState');
            gameState = {
                playerClass: '',
                skill: 0,
                maxStamina: 0,
                stamina: 0,
                luck: 0,
                gold: 0,
                inventory: [],
                weapons: [],
                armor: [],
                currentWeaponIndex: 0,
                currentArmorIndex: 0,
                currentSection: 0,
                gameComplete: false
            };
            window.location.href = 'level1.html';
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-skill').textContent = gameState.skill;
            document.getElementById('stat-stamina').textContent = gameState.stamina;
            document.getElementById('stat-maxstamina').textContent = gameState.maxStamina;
            document.getElementById('stat-luck').textContent = gameState.luck;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Show current equipped weapon
            if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                const weapon = gameState.weapons[gameState.currentWeaponIndex];
                const weaponSpan = document.createElement('span');
                weaponSpan.className = 'inventory-item';
                weaponSpan.id = 'inv-weapon';
                weaponSpan.textContent = `${weapon.name} (${weapon.damage})`;
                inventoryDiv.appendChild(weaponSpan);
            }
            
            // Show current equipped armor
            if (gameState.armor && gameState.armor.length > 0 && gameState.currentArmorIndex >= 0) {
                const armor = gameState.armor[gameState.currentArmorIndex];
                const armorSpan = document.createElement('span');
                armorSpan.className = 'inventory-item';
                armorSpan.id = 'inv-armor';
                armorSpan.textContent = `${armor.name} (${armor.defense} DEF)`;
                inventoryDiv.appendChild(armorSpan);
            }
            
            // Show gold
            const goldSpan = document.createElement('span');
            goldSpan.className = 'inventory-item';
            goldSpan.textContent = `${gameState.gold} Gold`;
            inventoryDiv.appendChild(goldSpan);
            
            // Show other inventory items
            if (gameState.inventory) {
                gameState.inventory.forEach(item => {
                    // Don't show items that are currently equipped as weapons/armor
                    const isCurrentWeapon = gameState.weapons[gameState.currentWeaponIndex] && 
                        gameState.weapons[gameState.currentWeaponIndex].name === item;
                    const isCurrentArmor = gameState.armor[gameState.currentArmorIndex] && 
                        gameState.armor[gameState.currentArmorIndex].name === item;
                    
                    if (!isCurrentWeapon && !isCurrentArmor) {
                        const itemSpan = document.createElement('span');
                        itemSpan.className = 'inventory-item';
                        itemSpan.textContent = item;
                        inventoryDiv.appendChild(itemSpan);
                    }
                });
            }
        }
        
        // Load story section
        function loadSection(sectionId) {
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                // For any missing sections, provide a default continuation
                document.getElementById('story-text').innerHTML = "<p>You continue through Bloodstone Keep, battling its defenders and navigating its treacherous corridors. The dark energy grows stronger as you approach the heart of the fortress. You know you must confront the Blood Lord to complete your quest.</p>";
                document.getElementById('choice-buttons').innerHTML = `
                    <button class="choice-btn" onclick="loadSection(200)">Confront the Blood Lord</button>
                    <button class="choice-btn" onclick="loadSection(0)">Return to Keep Entrance</button>
                `;
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 10102 || sectionId === 10103 || 
                                 sectionId === 2602 || sectionId === 2603 ||
                                 sectionId === 3502 || sectionId === 3503 ||
                                 sectionId === 3902 || sectionId === 3903 ||
                                 sectionId === 5602 || sectionId === 5603 ||
                                 sectionId === 5802 || sectionId === 5803);
            
            if (isCombatRound && combatState.active) {
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                if (!combatState.active) {
                    const goldReward = Math.floor(Math.random() * 30) + 10;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find ${goldReward} Gold on the body.`;
                    
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                section.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    button.onclick = function() {
                        if (choice.skillCheck) {
                            performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                        } else {
                            loadSection(choice.nextSection);
                        }
                    };
                    choiceButtons.appendChild(button);
                });
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDiceHelper(2, 6);
            const enemyRoll = rollDiceHelper(2, 6);
            
            // Add skill to dice rolls
            const playerTotal = playerRoll + gameState.skill;
            const enemyTotal = enemyRoll + combatState.enemySkill;
            
            let resultText = `<span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Stamina: ${gameState.stamina}, Enemy Stamina: ${combatState.enemyCurrentStamina}<br>`;
            resultText += `You roll ${playerRoll} + Skill ${gameState.skill} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Skill ${combatState.enemySkill} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                    const weapon = gameState.weapons[gameState.currentWeaponIndex];
                    if (weapon.damage === '1d6') damage = rollDiceHelper(1, 6);
                    else if (weapon.damage === '2d4') damage = rollDiceHelper(2, 4);
                    else if (weapon.damage === '3d6') damage = rollDiceHelper(3, 6);
                    else damage = rollDiceHelper(1, 6); // Default fallback
                } else {
                    damage = rollDiceHelper(1, 6);
                }
                
                combatState.enemyCurrentStamina -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                
                if (combatState.enemyCurrentStamina <= 0) {
                    combatState.active = false;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                const enemyDamage = rollDiceHelper(1, 6); // Enemy always uses 1d6 damage
                gameState.stamina -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                
                // Check if player died
                if (gameState.stamina <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated by the ${combatState.enemyName}! Game Over.</span>`;
                    setTimeout(() => {
                        localStorage.removeItem('dreadwoodGameState');
                        location.reload();
                    }, 3000);
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            const diceRoll = rollDiceHelper(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Luck
        function useLuck() {
            if (gameState.luck <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Luck left!</div>`;
                return;
            }
            
            const diceRoll = rollDiceHelper(2, 6);
            const success = diceRoll <= gameState.luck;
            
            gameState.luck -= 1;
            updateStatsDisplay();
            
            let resultText = `You test your Luck... Roll: ${diceRoll}, Luck: ${gameState.luck + 1}. `;
            resultText += success ? 
                `<span class="success">Lucky!</span> Something good happens.` : 
                `<span class="damage">Unlucky!</span> Something bad happens.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            // Apply Luck effect
            if (success) {
                const goodEffects = [
                    "You find 10 Gold dropped by a guard!",
                    "You spot a hidden passage!",
                    "A guard trips and drops his weapon!",
                    "You find a healing potion on a table!",
                    "You avoid a patrol at the last moment!"
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Gold")) {
                    gameState.gold += 10;
                } else if (effect.includes("potion")) {
                    gameState.inventory.push("Healing Potion");
                    updateInventoryDisplay();
                }
            } else {
                const badEffects = [
                    "You alert a guard!",
                    "You drop 5 Gold!",
                    "You trip and take 3 damage!",
                    "Your weapon gets stuck in your scabbard!",
                    "You walk into a patrol!"
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.stamina -= 3;
                    if (gameState.stamina <= 0) {
                        document.getElementById('story-text').innerHTML += `<div class="game-over">You have been defeated! Game Over.</div>`;
                        setTimeout(() => {
                            localStorage.removeItem('dreadwoodGameState');
                            location.reload();
                        }, 3000);
                    }
                } else if (effect.includes("Gold")) {
                    gameState.gold = Math.max(0, gameState.gold - 5);
                } else if (effect.includes("alert") || effect.includes("patrol")) {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">Guards approach!</div>`;
                    setTimeout(() => {
                        combatState.active = true;
                        combatState.enemyName = "Alerted Guards";
                        combatState.enemyStamina = 12;
                        combatState.enemyCurrentStamina = 12;
                        combatState.enemySkill = 8;
                        combatState.nextSection = gameState.currentSection;
                        combatState.round = 0;
                        loadSection(3502);
                    }, 1000);
                }
            }
            
            updateStatsDisplay();
            updateInventoryDisplay();
        }
        
        // Use Item function
        function useItem() {
            const usableItems = gameState.inventory.filter(item => {
                const isWeapon = gameState.weapons.some(w => w.name === item);
                const isArmor = gameState.armor.some(a => a.name === item);
                return !isWeapon && !isArmor;
            });
            
            if (usableItems.length === 0) {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory!</div>`;
                return;
            }
            
            let itemText = "<h3>Select an item to use:</h3>";
            
            usableItems.forEach((item, index) => {
                itemText += `<p>${item} `;
                
                if (item === "Healing Potion" || item === "Crimson Elixir") {
                    itemText += `<button onclick="useHealingItem('${item}')" style="font-size:12px; padding:3px 8px;">Use (Restore Stamina)</button>`;
                } else if (item === "Holy Symbol") {
                    itemText += `<button onclick="useHolySymbol()" style="font-size:12px; padding:3px 8px;">Use (Against Undead)</button>`;
                } else if (item === "Blood Ruby") {
                    itemText += `<button onclick="useBloodRuby()" style="font-size:12px; padding:3px 8px;">Use (Dark Power)</button>`;
                } else if (item === "Ritual Book") {
                    itemText += `<button onclick="useRitualBook()" style="font-size:12px; padding:3px 8px;">Read</button>`;
                } else {
                    itemText += `<button onclick="useGenericItem('${item}')" style="font-size:12px; padding:3px 8px;">Use</button>`;
                }
                
                itemText += `</p>`;
            });
            
            itemText += `<p><button onclick="cancelItemUse()" style="font-size:12px; padding:3px 8px; margin-top:10px;">Cancel</button></p>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${itemText}</div>`;
        }
        
        // Use Healing Item
        function useHealingItem(itemName) {
            const itemIndex = gameState.inventory.indexOf(itemName);
            if (itemIndex !== -1) {
                gameState.inventory.splice(itemIndex, 1);
                
                let healAmount = 0;
                if (itemName === "Healing Potion") {
                    healAmount = 6;
                } else if (itemName === "Crimson Elixir") {
                    healAmount = 10;
                } else {
                    healAmount = 4;
                }
                
                const oldStamina = gameState.stamina;
                gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                const actualHeal = gameState.stamina - oldStamina;
                
                updateInventoryDisplay();
                updateStatsDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You use the ${itemName} and restore ${actualHeal} Stamina!</span></div>`;
            }
        }
        
        // Use Holy Symbol
        function useHolySymbol() {
            const symbolIndex = gameState.inventory.indexOf("Holy Symbol");
            if (symbolIndex !== -1) {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">The Holy Symbol glows with pure light! It will be especially effective against undead or dark creatures.</span></div>`;
                
                // Holy symbol could be used in specific story sections against undead
                gameState.hasHolySymbol = true;
            }
        }
        
        // Use Blood Ruby
        function useBloodRuby() {
            const rubyIndex = gameState.inventory.indexOf("Blood Ruby");
            if (rubyIndex !== -1) {
                gameState.inventory.splice(rubyIndex, 1);
                updateInventoryDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You channel the dark power of the Blood Ruby! Your Skill increases by 2, but you lose 3 Stamina from the strain!</span></div>`;
                
                gameState.skill += 2;
                gameState.stamina -= 3;
                updateStatsDisplay();
            }
        }
        
        // Use Ritual Book
        function useRitualBook() {
            const bookIndex = gameState.inventory.indexOf("Ritual Book");
            if (bookIndex !== -1) {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You read from the Ritual Book: 'Pure light disrupts the blood magic. The Heart of Bloodstone must be shattered with a weapon blessed by light.' This knowledge might be crucial!</span></div>`;
            }
        }
        
        // Use Generic Item
        function useGenericItem(itemName) {
            const itemIndex = gameState.inventory.indexOf(itemName);
            if (itemIndex !== -1) {
                gameState.inventory.splice(itemIndex, 1);
                updateInventoryDisplay();
                
                let effectText = "";
                if (itemName.includes("Potion") || itemName.includes("Elixir")) {
                    const healAmount = rollDiceHelper(1, 4) + 2;
                    const oldStamina = gameState.stamina;
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                    const actualHeal = gameState.stamina - oldStamina;
                    effectText = `You use the ${itemName} and restore ${actualHeal} Stamina!`;
                    updateStatsDisplay();
                } else if (itemName.includes("Key")) {
                    effectText = `You examine the ${itemName}. It might unlock something important.`;
                    gameState.inventory.push(itemName);
                    updateInventoryDisplay();
                    return;
                } else {
                    effectText = `You use the ${itemName}.`;
                }
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">${effectText}</span></div>`;
            }
        }
        
        // Cancel Item Use
        function cancelItemUse() {
            document.getElementById('story-text').innerHTML += 
                `<div class="dice-roll">You decide not to use an item.</div>`;
        }
        
        // Check inventory
        function checkInventory() {
            let inventoryText = "<h3>Your Inventory:</h3>";
            
            if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                const weapon = gameState.weapons[gameState.currentWeaponIndex];
                inventoryText += `<p><strong>Equipped Weapon:</strong> ${weapon.name} (${weapon.damage} damage)</p>`;
            }
            
            inventoryText += "<p><strong>Available Weapons:</strong><br>";
            gameState.weapons.forEach((weapon, index) => {
                const isEquipped = index === gameState.currentWeaponIndex;
                inventoryText += `${isEquipped ? " " : ""}${weapon.name} (${weapon.damage})`;
                if (!isEquipped) {
                    inventoryText += ` <button onclick="equipWeapon(${index})" style="font-size:10px; padding:2px 5px;">Equip</button>`;
                }
                inventoryText += "<br>";
            });
            inventoryText += "</p>";
            
            inventoryText += "<p><strong>Armor:</strong><br>";
            gameState.armor.forEach((armor, index) => {
                const isEquipped = index === gameState.currentArmorIndex;
                inventoryText += `${isEquipped ? " " : ""}${armor.name} (${armor.defense} DEF)`;
                if (!isEquipped) {
                    inventoryText += ` <button onclick="equipArmor(${index})" style="font-size:10px; padding:2px 5px;">Equip</button>`;
                }
                inventoryText += "<br>";
            });
            inventoryText += "</p>";
            
            inventoryText += `<p><strong>Gold:</strong> ${gameState.gold}</p>`;
            
            if (gameState.inventory && gameState.inventory.length > 0) {
                inventoryText += `<p><strong>Usable Items:</strong><br>`;
                const usableItems = gameState.inventory.filter(item => {
                    const isWeapon = gameState.weapons.some(w => w.name === item);
                    const isArmor = gameState.armor.some(a => a.name === item);
                    return !isWeapon && !isArmor;
                });
                
                if (usableItems.length > 0) {
                    usableItems.forEach(item => {
                        inventoryText += `${item} `;
                        
                        if (item === "Healing Potion" || item === "Crimson Elixir") {
                            inventoryText += `<button onclick="useHealingItem('${item}')" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Holy Symbol") {
                            inventoryText += `<button onclick="useHolySymbol()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Blood Ruby") {
                            inventoryText += `<button onclick="useBloodRuby()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Ritual Book") {
                            inventoryText += `<button onclick="useRitualBook()" style="font-size:10px; padding:2px 5px;">Read</button>`;
                        } else {
                            inventoryText += `<button onclick="useGenericItem('${item}')" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        }
                        
                        inventoryText += `<br>`;
                    });
                } else {
                    inventoryText += "None";
                }
                inventoryText += `</p>`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${inventoryText}</div>`;
        }
        
        // Equip weapon function
        function equipWeapon(index) {
            if (index >= 0 && index < gameState.weapons.length) {
                gameState.currentWeaponIndex = index;
                updateInventoryDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped ${gameState.weapons[index].name}!</div>`;
                saveGame();
            }
        }
        
        // Equip armor function
        function equipArmor(index) {
            if (index >= 0 && index < gameState.armor.length) {
                gameState.currentArmorIndex = index;
                updateInventoryDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped ${gameState.armor[index].name}!</div>`;
                saveGame();
            }
        }
        
        // Save game
        function saveGame() {
            if (gameState.currentWeaponIndex >= gameState.weapons.length) {
                gameState.currentWeaponIndex = gameState.weapons.length - 1;
            }
            if (gameState.currentArmorIndex >= gameState.armor.length) {
                gameState.currentArmorIndex = gameState.armor.length - 1;
            }
            
            localStorage.setItem('dreadwoodGameState', JSON.stringify(gameState));
        }
        
        // Go to next level (Ashen Wastes)
        function goToNextLevel() {
            localStorage.setItem('dreadwoodGameState', JSON.stringify(gameState));
            window.location.href = 'level5.html';
        }
        
        // Utility function to roll dice
        function rollDiceHelper(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
    </script>
</body>
</html>
