<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DreadWood: Ashen Wastes</title>
    <style>
        /* STYLE with ashen/desolate theme colors */
        body {
            font-family: 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #cccccc;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            border: 2px solid #999999;
            background-color: #000;
            box-shadow: 0 0 15px rgba(153, 153, 153, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #999999;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #cccccc;
            text-shadow: 0 0 5px #cccccc;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
        }
        
        h2 {
            color: #aaaaaa;
            border-bottom: 1px solid #aaaaaa;
            padding-bottom: 5px;
            margin-top: 25px;
        }
        
        .screen {
            display: none;
        }
        
        .active-screen {
            display: block;
        }
        
        .stats-bar {
            background-color: #222222;
            border: 1px solid #999999;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-value {
            color: #ffff99;
            font-weight: bold;
        }
        
        .inventory {
            background-color: #222222;
            border: 1px solid #aaaaaa;
            padding: 10px;
            margin: 15px 0;
            min-height: 60px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #333333;
            border: 1px solid #aaaaaa;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
        }
        
        .story-text {
            background-color: #111111;
            border: 1px solid #999999;
            padding: 15px;
            margin: 20px 0;
            min-height: 150px;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #333333;
            color: #cccccc;
            border: 2px solid #999999;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #444444;
            color: #ffffff;
            border-color: #cccccc;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222222;
            color: #aaaaaa;
            border: 2px solid #777777;
            padding: 10px 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333333;
            color: #cccccc;
        }
        
        .dice-roll {
            background-color: #332222;
            border: 1px solid #999999;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ffff99;
        }
        
        .game-over {
            color: #ff6666;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #ff6666;
        }
        
        .success {
            color: #99ff99;
            font-weight: bold;
        }
        
        .damage {
            color: #ff6666;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9966;
            font-weight: bold;
        }
        
        .treasure {
            color: #ffcc66;
            font-weight: bold;
        }
        
        .secret {
            color: #cc99ff;
            font-weight: bold;
        }
        
        .ash {
            color: #cccccc;
            font-style: italic;
        }
        
        .heat {
            color: #ff9966;
            font-weight: bold;
        }
        
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #333333;
            color: #cccccc;
            border: 2px solid #999999;
            padding: 15px 30px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #444444;
            color: #ffffff;
        }
        
        .retro-notice {
            text-align: center;
            color: #666666;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333333;
            padding-top: 10px;
        }
        
        .warning-dialog {
            background-color: #332222;
            border: 2px solid #ff6666;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .warning-text {
            color: #ff9966;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .dialog-btn {
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid;
        }
        
        .dialog-btn-yes {
            background-color: #333333;
            color: #cccccc;
            border-color: #999999;
        }
        
        .dialog-btn-no {
            background-color: #333333;
            color: #cccccc;
            border-color: #999999;
        }
        
        .wastes-map {
            background-color: #111111;
            border: 1px solid #999999;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre;
            font-size: 12px;
            overflow-x: auto;
            color: #cccccc;
        }
        
        .environment-effect {
            background-color: #222222;
            border: 1px solid #ff9966;
            padding: 8px;
            margin: 5px 0;
            font-size: 13px;
            color: #ff9966;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 10px;
                font-size: 14px;
            }
            
            .dialog-buttons {
                flex-direction: column;
            }
            
            .wastes-map {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DREADWOOD</h1>
            <h2>ASHEN WASTES</h2>
            <div class="retro-notice">Level 5 - The Land of Ash and Memory</div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item">SKILL: <span id="stat-skill" class="stat-value">0</span></div>
                <div class="stat-item">STAMINA: <span id="stat-stamina" class="stat-value">0</span>/<span id="stat-maxstamina" class="stat-value">0</span></div>
                <div class="stat-item">LUCK: <span id="stat-luck" class="stat-value">0</span></div>
                <div class="stat-item">GOLD: <span id="stat-gold" class="stat-value">0</span></div>
                <div class="stat-item">WATER: <span id="stat-water" class="stat-value">0</span></div>
            </div>
            
            <h2>INVENTORY</h2>
            <div class="inventory" id="inventory">
                <!-- Inventory will be loaded from saved game -->
            </div>
            
            <h2>THE ADVENTURE</h2>
            <div class="story-text" id="story-text">
                <p>The ASHEN WASTES stretch before you - an endless desert of grey ash under a blood-red sky. The air is hot and thick with the smell of cinders. Nothing grows here but twisted, petrified trees. Whispers on the wind speak of forgotten civilizations buried beneath the ash. To reach the NECROPOLIS OF BONES, you must cross this desolate land.</p>
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <button class="choice-btn" onclick="loadSection(1)">Follow the Ancient Road</button>
                <button class="choice-btn" onclick="loadSection(2)">Search for Water Sources</button>
                <button class="choice-btn" onclick="loadSection(3)">Head Toward Distant Mountains</button>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useLuck()">TEST LUCK</button>
                <button class="action-btn" onclick="checkInventory()">INVENTORY</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="showNewGameWarning()">START NEW GAME</button>
            </div>
        </div>
        
        <!-- Warning Dialog for New Game -->
        <div id="warning-dialog" class="screen">
            <div class="warning-dialog">
                <div class="warning-text">WARNING: Starting a new game will delete ALL your current progress!</div>
                <p>Your current character, stats, inventory, and gold will be permanently erased.</p>
                <p>You will return to the beginning of the game to create a new character.</p>
                <div class="dialog-buttons">
                    <button class="dialog-btn dialog-btn-yes" onclick="startNewGame()">YES, START NEW GAME</button>
                    <button class="dialog-btn dialog-btn-no" onclick="cancelNewGame()">NO, KEEP MY CHARACTER</button>
                </div>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>VICTORY!</h2>
            <div class="story-text">
                <p>You have survived the ASHEN WASTES!</p>
                <p>Through scorching days and freezing nights, past ash storms and buried dangers, you've crossed the desolate expanse. Before you now rises the NECROPOLIS OF BONES - a city built from the remains of countless beings, where your journey continues.</p>
                <p>All your stats, gold, and inventory will carry over to the next chapter.</p>
                <div class="stats-bar">
                    <div class="stat-item">SKILL: <span id="next-stat-skill" class="stat-value">0</span></div>
                    <div class="stat-item">STAMINA: <span id="next-stat-stamina" class="stat-value">0</span></div>
                    <div class="stat-item">LUCK: <span id="next-stat-luck" class="stat-value">0</span></div>
                    <div class="stat-item">GOLD: <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO NECROPOLIS OF BONES</button>
            </div>
        </div>
        
        <div class="retro-notice">
            DREADWOOD - A Retro Gamebook Adventure<br>
            Level 5: Ashen Wastes
        </div>
    </div>

    <script>
        // Game state (loaded from localStorage)
        let gameState = JSON.parse(localStorage.getItem('dreadwoodGameState')) || {
            playerClass: 'warrior',
            skill: 10,
            maxStamina: 18,
            stamina: 18,
            luck: 10,
            gold: 150,
            inventory: ['Dagger', 'Leather Armor'],
            weapons: [{name: 'Dagger', damage: '1d6'}],
            armor: [{name: 'Leather Armor', defense: 1}],
            currentSection: 0,
            gameComplete: false
        };
        
        // Wastes-specific conditions and resources
        let wastesConditions = {
            water: 5, // Starting water supply
            hasMap: false,
            foundShelter: false,
            ashStorm: false,
            heatExhaustion: false,
            foundOasis: false,
            discoveredRuins: false
        };
        
        // Level 5 story sections - ASHEN WASTES
        const storySections = {
            0: {
                text: "The ASHEN WASTES stretch before you - an endless desert of grey ash under a blood-red sky. The air is hot and thick with the smell of cinders. Nothing grows here but twisted, petrified trees. Whispers on the wind speak of forgotten civilizations buried beneath the ash. To reach the NECROPOLIS OF BONES, you must cross this desolate land.",
                choices: [
                    {text: "Follow the remains of an ancient road", nextSection: 1, skillCheck: false},
                    {text: "Search for water sources first", nextSection: 2, skillCheck: false},
                    {text: "Head toward distant mountains on the horizon", nextSection: 3, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            1: {
                text: "You follow what remains of an ancient stone road, now mostly buried in ash. The going is easier here, but the path is exposed. After several hours, you come to a crossroads where the road splits three ways.",
                choices: [
                    {text: "Take the left fork heading northeast", nextSection: 4, skillCheck: false},
                    {text: "Take the center fork continuing straight", nextSection: 5, skillCheck: false},
                    {text: "Take the right fork heading southeast", nextSection: 6, skillCheck: false},
                    {text: "Leave the road and strike out across the ash", nextSection: 7, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            2: {
                text: "You search for water, knowing survival in the wastes depends on it. The ash is deep and shifting, making travel difficult. You spot several possibilities:",
                choices: [
                    {text: "Investigate a cluster of petrified trees", nextSection: 8, skillCheck: false},
                    {text: "Follow some strange bird-like creatures", nextSection: 9, skillCheck: false},
                    {text: "Head toward a depression that might collect water", nextSection: 10, skillCheck: false},
                    {text: "Dig in a spot where the ash looks different", nextSection: 11, skillCheck: true, checkType: 'luck', difficulty: 12}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            3: {
                text: "You head toward distant purple mountains on the horizon. The ash is deep here, and progress is slow. The heat is intense, and you're already sweating through your water supply.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 12, skillCheck: false},
                    {text: "Look for shelter from the sun", nextSection: 13, skillCheck: false},
                    {text: "Turn back and try a different route", nextSection: 0, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    // Extra water consumption for mountain route
                    wastesConditions.water -= 1;
                    updateWaterDisplay();
                    return "<div class='environment-effect'>The mountain route is steep! You consume extra water.</div>";
                }
            },
            4: {
                text: "The northeast fork leads through a canyon of ash. The walls rise high on either side, providing some shade from the relentless sun. You find carvings on the stone walls depicting ancient people.",
                choices: [
                    {text: "Examine the carvings", nextSection: 14, skillCheck: false},
                    {text: "Continue through the canyon", nextSection: 15, skillCheck: false},
                    {text: "Search for water in the canyon", nextSection: 16, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            5: {
                text: "The center fork continues straight across the flat wastes. The road is better preserved here, and you make good time. Ahead, you see what looks like the ruins of a waystation.",
                choices: [
                    {text: "Investigate the ruins", nextSection: 17, skillCheck: false},
                    {text: "Bypass the ruins and continue", nextSection: 18, skillCheck: false},
                    {text: "Search the area around the ruins", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            6: {
                text: "The southeast fork descends into a valley filled with strange, glass-like formations. The ground crunches underfoot, and rainbows dance in the air from light refracting through the glass.",
                choices: [
                    {text: "Explore the glass valley", nextSection: 20, skillCheck: false},
                    {text: "Collect some of the glass formations", nextSection: 21, skillCheck: false},
                    {text: "Leave the valley quickly", nextSection: 22, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            7: {
                text: "Leaving the road, you strike out across the deep ash. It's exhausting work - each step sinks to your knees. After an hour, you're already tired and thirsty.",
                choices: [
                    {text: "Continue through the deep ash", nextSection: 23, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Look for firmer ground", nextSection: 24, skillCheck: false},
                    {text: "Return to the road", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    // Extra stamina cost for ash travel
                    gameState.stamina -= 2;
                    updateStatsDisplay();
                    return "<div class='environment-effect'>Travel through deep ash is exhausting! You lose 2 Stamina.</div>";
                }
            },
            8: {
                text: "The petrified trees stand like skeletal sentinels. Among them, you find a small depression where water might collect after the rare rains. It's dry now, but you notice animal tracks leading away.",
                choices: [
                    {text: "Follow the animal tracks", nextSection: 25, skillCheck: false},
                    {text: "Dig in the depression", nextSection: 26, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Search the petrified trees", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            9: {
                text: "The strange bird-creatures have leathery wings and long necks. They seem to be heading somewhere with purpose. Following them is difficult as they fly, but they occasionally land.",
                choices: [
                    {text: "Continue following the creatures", nextSection: 28, skillCheck: true, checkType: 'luck', difficulty: 11},
                    {text: "Try to catch one", nextSection: 29, skillCheck: false},
                    {text: "Give up and search elsewhere", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            10: {
                text: "The depression is wide and shallow. As you approach, you notice the ash here is darker and damper. There might be water just beneath the surface.",
                choices: [
                    {text: "Dig for water", nextSection: 30, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Search the edges of the depression", nextSection: 31, skillCheck: false},
                    {text: "Wait to see if creatures come here", nextSection: 32, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            11: {
                text: "You dig where the ash looks different...",
                choices: [
                    {text: "Continue", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    if (window.checkResult) {
                        wastesConditions.water += 3;
                        updateWaterDisplay();
                        return "You find a small seep of brackish water! You collect 3 units of water.";
                    } else {
                        gameState.stamina -= 2;
                        updateStatsDisplay();
                        return "You dig for hours but find only dry ash. You lose 2 Stamina from the effort.";
                    }
                }
            },
            12: {
                text: "The mountains seem no closer despite hours of walking - a common illusion in the flat wastes. Your water is running low, and the heat is punishing.",
                choices: [
                    {text: "Press on toward the mountains", nextSection: 34, skillCheck: false},
                    {text: "Find shelter and rest", nextSection: 35, skillCheck: false},
                    {text: "Change direction", nextSection: 36, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    wastesConditions.water -= 1;
                    updateWaterDisplay();
                    return "<div class='environment-effect'>The mountain mirage taunts you. Water consumed.</div>";
                }
            },
            13: {
                text: "You search for shelter from the relentless sun. The only shade comes from a large rock formation or the deep ash itself.",
                choices: [
                    {text: "Shelter under the rock formation", nextSection: 37, skillCheck: false},
                    {text: "Dig a shelter in the ash", nextSection: 38, skillCheck: false},
                    {text: "Keep moving despite the heat", nextSection: 39, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            14: {
                text: "The carvings show ancient people living in these wastes when they were fertile. One panel shows a great catastrophe - fire from the sky turning the land to ash. Another shows a route to 'the City of Bones'.",
                choices: [
                    {text: "Study the route to the City of Bones", nextSection: 40, skillCheck: false},
                    {text: "Continue through the canyon", nextSection: 15, skillCheck: false},
                    {text: "Make a copy of the carvings", nextSection: 41, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            15: {
                text: "The canyon winds for miles, providing blessed shade. You make good progress until you come to a section where the canyon walls have collapsed, blocking the way.",
                choices: [
                    {text: "Try to climb over the collapse", nextSection: 42, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Dig through the rubble", nextSection: 43, skillCheck: false},
                    {text: "Go back and find another route", nextSection: 44, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            16: {
                text: "Searching for water in the canyon, you find several dark, cool crevices where moisture might collect.",
                choices: [
                    {text: "Search the deepest crevice", nextSection: 45, skillCheck: false},
                    {text: "Look for dripping water on the walls", nextSection: 46, skillCheck: true, checkType: 'luck', difficulty: 13},
                    {text: "Give up and continue", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            17: {
                text: "The waystation ruins consist of crumbling stone walls and a partially intact roof. Inside, you find evidence of recent occupation - ashes from a fire, discarded containers.",
                choices: [
                    {text: "Search the ruins thoroughly", nextSection: 47, skillCheck: false},
                    {text: "Rest in the shade of the ruins", nextSection: 48, skillCheck: false},
                    {text: "Continue quickly - someone might return", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    wastesConditions.foundShelter = true;
                    return "<div class='environment-effect'>You find shelter from the sun!</div>";
                }
            },
            18: {
                text: "Bypassing the ruins, you continue along the ancient road. The ash here is thinner, and you can see the original stone pavement in places.",
                choices: [
                    {text: "Follow the visible pavement", nextSection: 49, skillCheck: false},
                    {text: "Search for markers or signs", nextSection: 50, skillCheck: false},
                    {text: "Pick up the pace", nextSection: 51, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            19: {
                text: "Around the ruins, you find several interesting things: a broken wagon, a dried-up well, and what might be graves marked with stone.",
                choices: [
                    {text: "Examine the broken wagon", nextSection: 52, skillCheck: false},
                    {text: "Investigate the dry well", nextSection: 53, skillCheck: false},
                    {text: "Look at the stone markers", nextSection: 54, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            20: {
                text: "The glass valley is eerily beautiful. The formations range from tiny shards to towering spires. As you walk, you notice some formations contain shapes - like frozen moments in time.",
                choices: [
                    {text: "Examine a formation with shapes inside", nextSection: 55, skillCheck: false},
                    {text: "Continue through the valley", nextSection: 56, skillCheck: false},
                    {text: "Listen - the glass sings in the wind", nextSection: 57, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            21: {
                text: "You collect some of the glass formations. They're sharp and beautiful, catching the light in rainbow patterns.",
                choices: [
                    {text: "Take the glass and continue", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    gameState.inventory.push("Rainbow Glass Shards");
                    updateInventoryDisplay();
                    return "You collect some rainbow glass shards. They might be valuable or useful.";
                }
            },
            22: {
                text: "Something about the glass valley feels wrong. You leave quickly, returning to the road.",
                choices: [
                    {text: "Take a different fork", nextSection: 59, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            23: {
                text: "You continue through the deep ash...",
                choices: [
                    {text: "Continue", nextSection: 60, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    if (window.checkResult) {
                        return "You find a technique for walking in ash - sliding steps rather than lifting. You make decent progress.";
                    } else {
                        gameState.stamina -= 3;
                        updateStatsDisplay();
                        return "The ash drags at your legs, exhausting you. You lose 3 Stamina.";
                    }
                }
            },
            24: {
                text: "Looking for firmer ground, you spot a ridge where the ash seems shallower. Heading toward it, you find the remains of an ancient wall or foundation.",
                choices: [
                    {text: "Follow the ancient foundation", nextSection: 61, skillCheck: false},
                    {text: "Search the area", nextSection: 62, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            25: {
                text: "The animal tracks lead to a cave entrance in a rocky outcrop. From within, you hear dripping water!",
                choices: [
                    {text: "Enter the cave", nextSection: 63, skillCheck: false},
                    {text: "Call out first", nextSection: 64, skillCheck: false},
                    {text: "Wait and observe", nextSection: 65, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            26: {
                text: "You dig in the depression...",
                choices: [
                    {text: "Continue", nextSection: 66, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    if (window.checkResult) {
                        wastesConditions.water += 2;
                        updateWaterDisplay();
                        return "After digging several feet, you find damp earth and eventually collect 2 units of muddy water.";
                    } else {
                        gameState.stamina -= 3;
                        updateStatsDisplay();
                        return "You dig until exhausted but find only dry earth. You lose 3 Stamina.";
                    }
                }
            },
            27: {
                text: "Searching among the petrified trees, you find something unexpected - a cache of supplies hidden in a hollow tree!",
                choices: [
                    {text: "Examine the cache", nextSection: 67, skillCheck: false},
                    {text: "Take what you need and leave", nextSection: 68, skillCheck: false},
                    {text: "Leave it untouched", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            28: {
                text: "You continue following the bird-creatures...",
                choices: [
                    {text: "Continue", nextSection: 70, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    if (window.checkResult) {
                        wastesConditions.foundOasis = true;
                        wastesConditions.water += 5;
                        updateWaterDisplay();
                        return "The creatures lead you to a hidden oasis! Clear water bubbles from a spring surrounded by strange, grey plants. You refill your water supply (+5 water).";
                    } else {
                        gameState.stamina -= 2;
                        wastesConditions.water -= 1;
                        updateStatsDisplay();
                        updateWaterDisplay();
                        return "You lose the creatures in the ash. The pursuit costs you 2 Stamina and 1 water.";
                    }
                }
            },
            29: {
                text: "You attempt to catch one of the bird-creatures. They're surprisingly fast and agile!",
                choices: [
                    {text: "Continue the chase", nextSection: 71, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Give up", nextSection: 72, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            30: {
                text: "You dig for water in the depression...",
                choices: [
                    {text: "Continue", nextSection: 73, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    if (window.checkResult) {
                        wastesConditions.water += 4;
                        updateWaterDisplay();
                        return "Success! You hit a small underground stream and collect 4 units of fresh water.";
                    } else {
                        gameState.stamina -= 3;
                        updateStatsDisplay();
                        return "You dig until exhausted but the ground remains dry. You lose 3 Stamina.";
                    }
                }
            },
            31: {
                text: "Searching the edges of the depression, you find several burrow entrances. Small creatures probably live here and might lead to water.",
                choices: [
                    {text: "Investigate a burrow", nextSection: 74, skillCheck: false},
                    {text: "Wait to see what emerges", nextSection: 75, skillCheck: false},
                    {text: "Set a trap", nextSection: 76, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            32: {
                text: "You wait patiently, observing the depression. After an hour, several small, six-legged creatures emerge and begin digging in a specific spot.",
                choices: [
                    {text: "Scare them away and dig where they were digging", nextSection: 77, skillCheck: false},
                    {text: "Try to catch one", nextSection: 78, skillCheck: false},
                    {text: "Continue waiting", nextSection: 79, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    wastesConditions.water -= 1;
                    updateWaterDisplay();
                    return "<div class='environment-effect'>Waiting consumes water. Water -1.</div>";
                }
            },
            33: {
                text: window.checkResult ? 
                    "You found water! With your supply replenished, you continue your journey." : 
                    "No water found. You continue your search.",
                choices: [
                    {text: "Continue through the wastes", nextSection: 80, skillCheck: false}
                ]
            },
            34: {
                text: "Pressing on toward the mountains, you realize they're not mountains at all but a massive bank of ash clouds on the horizon. An ash storm is coming!",
                choices: [
                    {text: "Seek shelter immediately", nextSection: 81, skillCheck: false},
                    {text: "Try to outrun the storm", nextSection: 82, skillCheck: false},
                    {text: "Continue toward it (dangerous!)", nextSection: 83, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    wastesConditions.ashStorm = true;
                    return "<div class='environment-effect'>ASH STORM APPROACHING! The sky darkens with choking ash.</div>";
                }
            },
            35: {
                text: "You find a shallow cave in a rock formation and rest. The break from the sun helps, but your water is critically low.",
                choices: [
                    {text: "Rest until nightfall", nextSection: 84, skillCheck: false},
                    {text: "Search the cave for water", nextSection: 85, skillCheck: false},
                    {text: "Continue after a short rest", nextSection: 86, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    wastesConditions.foundShelter = true;
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 4);
                    updateStatsDisplay();
                    return "<div class='environment-effect'>You rest in shelter, recovering 4 Stamina.</div>";
                }
            },
            36: {
                text: "Realizing the mountains are a futile goal, you change direction toward what looks like darker ground - possibly indicating moisture or different terrain.",
                choices: [
                    {text: "Head toward the dark ground", nextSection: 87, skillCheck: false},
                    {text: "Return to the ancient road", nextSection: 1, skillCheck: false},
                    {text: "Look for other landmarks", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    applyEnvironmentalEffects();
                    return "";
                }
            },
            // VICTORY SECTION - Player crosses the wastes
            200: {
                text: "After days of struggle through the Ashen Wastes, you finally see it on the horizon: the NECROPOLIS OF BONES. The city of the dead rises from the ash, a monument to mortality and your next challenge. You've survived Level 5!",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-skill').textContent = gameState.skill;
                    document.getElementById('next-stat-stamina').textContent = gameState.stamina;
                    document.getElementById('next-stat-luck').textContent = gameState.luck;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Clear wastes conditions
                    wastesConditions.water = 5;
                    wastesConditions.hasMap = false;
                    wastesConditions.foundShelter = false;
                    wastesConditions.ashStorm = false;
                    wastesConditions.heatExhaustion = false;
                    wastesConditions.foundOasis = false;
                    wastesConditions.discoveredRuins = false;
                    
                    return "You've completed Level 5: Ashen Wastes!";
                }
            }
        };
        
        // Add more sections to reach victory
        storySections[37] = {text: "The rock formation provides good shade. While resting, you notice carvings showing a map of the wastes!", choices: [{text: "Study the map and follow it to safety", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.hasMap = true; }};
        storySections[38] = {text: "You dig a shelter in the ash. It's cool but unstable. While digging, you find an ancient artifact - a compass that points toward the Necropolis!", choices: [{text: "Take the compass and follow its direction", nextSection: 200, skillCheck: false}], action: function() { gameState.inventory.push("Necropolis Compass"); updateInventoryDisplay(); }};
        storySections[39] = {text: "You keep moving despite the heat and eventually find a caravan trail leading to the wastes' edge!", choices: [{text: "Follow the caravan trail to safety", nextSection: 200, skillCheck: false}]};
        storySections[40] = {text: "The carving shows a clear route through the wastes to the Necropolis. Following it, you avoid dangers and find water sources.", choices: [{text: "Follow the ancient route to the Necropolis", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.hasMap = true; }};
        storySections[41] = {text: "You make a rubbing of the carvings to guide you.", choices: [{text: "Use the rubbing to navigate", nextSection: 200, skillCheck: false}], action: function() { gameState.inventory.push("Ancient Carving Rubbing"); updateInventoryDisplay(); wastesConditions.hasMap = true; }};
        storySections[42] = {text: window.checkResult ? "You climb over the collapse successfully." : "You slip and fall during the climb.", choices: [window.checkResult ? {text: "Continue through the canyon", nextSection: 89, skillCheck: false} : {text: "Try another approach", nextSection: 43, skillCheck: false}], action: function() { if(!window.checkResult) { gameState.stamina -= 4; updateStatsDisplay(); } }};
        storySections[43] = {text: "You dig through the rubble, finding a passage that leads to the other side.", choices: [{text: "Continue through the canyon", nextSection: 89, skillCheck: false}], action: function() { gameState.stamina -= 2; updateStatsDisplay(); }};
        storySections[44] = {text: "Going back, you find another route that bypasses the canyon entirely.", choices: [{text: "Take the alternate route", nextSection: 200, skillCheck: false}]};
        storySections[45] = {text: "In the deepest crevice, you find a small pool of water and ancient coins worth 75 Gold!", choices: [{text: "Take the water and treasure, then continue", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.water += 3; gameState.gold += 75; updateWaterDisplay(); updateStatsDisplay(); }};
        storySections[46] = {text: window.checkResult ? "You find a seep of water on the canyon wall!" : "No water found here.", choices: [window.checkResult ? {text: "Collect water and continue", nextSection: 90, skillCheck: false} : {text: "Continue without water", nextSection: 15, skillCheck: false}], action: function() { if(window.checkResult) { wastesConditions.water += 2; updateWaterDisplay(); } }};
        storySections[47] = {text: "Searching the ruins, you find a map, preserved rations, and 50 Gold left by previous travelers.", choices: [{text: "Take the supplies and use the map", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.hasMap = true; gameState.gold += 50; gameState.inventory.push("Preserved Rations"); updateStatsDisplay(); updateInventoryDisplay(); }};
        storySections[48] = {text: "Resting in the ruins, you recover strength and find a journal detailing a safe route through the wastes.", choices: [{text: "Follow the journal's route", nextSection: 200, skillCheck: false}], action: function() { gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 6); updateStatsDisplay(); wastesConditions.hasMap = true; }};
        storySections[49] = {text: "Following the visible pavement, you make excellent progress. The road leads directly to the edge of the wastes!", choices: [{text: "Follow the road to safety", nextSection: 200, skillCheck: false}]};
        storySections[50] = {text: "You find stone markers showing distances to the 'City of Bones'. Following them, you navigate efficiently.", choices: [{text: "Follow the markers to the Necropolis", nextSection: 200, skillCheck: false}]};
        storySections[51] = {text: "Picking up the pace, you cover ground quickly and soon see the dark outline of the Necropolis on the horizon.", choices: [{text: "Head toward the Necropolis", nextSection: 200, skillCheck: false}]};
        storySections[52] = {text: "The broken wagon contains supplies: water skins (3 water), a functional compass, and 40 Gold.", choices: [{text: "Take the supplies and continue", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.water += 3; gameState.gold += 40; gameState.inventory.push("Functional Compass"); updateWaterDisplay(); updateStatsDisplay(); updateInventoryDisplay(); }};
        storySections[53] = {text: "The well is dry but has a ladder. Descending, you find a hidden chamber with treasure and a tunnel that leads under the wastes!", choices: [{text: "Take the tunnel to bypass the wastes", nextSection: 200, skillCheck: false}], action: function() { gameState.gold += 100; updateStatsDisplay(); }};
        storySections[54] = {text: "The stone markers are graves. One has an inscription: 'Here lies the guide who knew the safe paths.' Buried with him is a map!", choices: [{text: "Take the map and follow its paths", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.hasMap = true; }};
        storySections[55] = {text: "The glass formation contains the image of a humanoid figure pointing toward the Necropolis. Other formations show dangers to avoid.", choices: [{text: "Use the glass visions to guide you", nextSection: 200, skillCheck: false}]};
        storySections[56] = {text: "Continuing through the valley, you find it leads to a pass through hills that border the wastes - a shortcut!", choices: [{text: "Take the shortcut to the Necropolis", nextSection: 200, skillCheck: false}]};
        storySections[57] = {text: "The glass sings with knowledge of the wastes. Listening carefully, you learn the safest route to your destination.", choices: [{text: "Follow the glass song's guidance", nextSection: 200, skillCheck: false}]};
        storySections[58] = {text: "With the glass shards, you continue. They seem to glow when pointed toward the Necropolis.", choices: [{text: "Follow the glowing glass to your destination", nextSection: 200, skillCheck: false}]};
        storySections[59] = {text: "Taking a different fork, you find a path that leads safely through the wastes.", choices: [{text: "Follow the safe path", nextSection: 200, skillCheck: false}]};
        storySections[60] = {text: window.checkResult ? "You master ash-walking and find a route that avoids the deepest drifts." : "Exhausted, you stumble upon an easier path by accident.", choices: [{text: "Take the easier path forward", nextSection: 200, skillCheck: false}]};
        storySections[61] = {text: "Following the ancient foundation, you discover it's part of an old aqueduct that leads to the wastes' edge.", choices: [{text: "Follow the aqueduct to safety", nextSection: 200, skillCheck: false}]};
        storySections[62] = {text: "Searching the area, you find a buried cache with a map and supplies left by ancient travelers.", choices: [{text: "Use the map and supplies to cross the wastes", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.hasMap = true; wastesConditions.water += 2; updateWaterDisplay(); }};
        storySections[63] = {text: "The cave contains a fresh water spring and carvings showing the way to the Necropolis!", choices: [{text: "Drink your fill and follow the carvings", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.water += 5; updateWaterDisplay(); wastesConditions.hasMap = true; }};
        storySections[64] = {text: "Your call echoes in the cave. From within, a friendly hermit emerges who shares water and directions.", choices: [{text: "Take the hermit's directions to the Necropolis", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.water += 3; updateWaterDisplay(); }};
        storySections[65] = {text: "Waiting, you see animals come to drink. Observing their paths, you deduce the safest route through the wastes.", choices: [{text: "Follow the animal paths to safety", nextSection: 200, skillCheck: false}]};
        storySections[66] = {text: window.checkResult ? "With water secured, you can plan your route better." : "Thirsty but determined, you press on.", choices: [{text: "Continue your journey", nextSection: 91, skillCheck: false}]};
        storySections[67] = {text: "The cache contains a detailed map of the wastes, water, preserved food, and 60 Gold!", choices: [{text: "Take the supplies and use the map", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.hasMap = true; wastesConditions.water += 4; gameState.gold += 60; updateWaterDisplay(); updateStatsDisplay(); }};
        storySections[68] = {text: "You take what you need from the cache - enough to safely cross the wastes.", choices: [{text: "Use the supplies to reach the Necropolis", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.water += 3; gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 5); updateWaterDisplay(); updateStatsDisplay(); }};
        storySections[69] = {text: "Respecting the cache's owner, you leave it untouched and continue your search for water.", choices: [{text: "Search elsewhere", nextSection: 2, skillCheck: false}]};
        storySections[70] = {text: window.checkResult ? "The oasis provides everything you need to cross the wastes safely." : "You continue searching for water.", choices: [window.checkResult ? {text: "Rest at the oasis then continue", nextSection: 200, skillCheck: false} : {text: "Try another water source", nextSection: 2, skillCheck: false}]};
        storySections[71] = {text: window.checkResult ? "You catch a bird-creature! It leads you to water before escaping." : "The creature escapes.", choices: [window.checkResult ? {text: "Take the water and continue", nextSection: 92, skillCheck: false} : {text: "Give up the chase", nextSection: 72, skillCheck: false}], action: function() { if(window.checkResult) { wastesConditions.water += 2; updateWaterDisplay(); } }};
        storySections[72] = {text: "You give up chasing the creatures and look for water elsewhere.", choices: [{text: "Search elsewhere", nextSection: 2, skillCheck: false}]};
        storySections[73] = {text: window.checkResult ? "With fresh water, your chances of survival improve dramatically." : "Still thirsty, you must find water soon.", choices: [{text: "Continue your journey", nextSection: 93, skillCheck: false}]};
        storySections[74] = {text: "The burrow leads to an underground chamber with a small pool. It also contains shiny stones worth 45 Gold.", choices: [{text: "Take water and treasure, then continue", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.water += 3; gameState.gold += 45; updateWaterDisplay(); updateStatsDisplay(); }};
        storySections[75] = {text: "Waiting reveals that the creatures emerge at dawn to drink from a hidden source. You follow them at first light.", choices: [{text: "Follow the creatures to water at dawn", nextSection: 200, skillCheck: false}]};
        storySections[76] = {text: "You set a simple trap and catch one of the creatures. It leads you to water when released.", choices: [{text: "Follow to the water source", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.water += 3; updateWaterDisplay(); }};
        storySections[77] = {text: "Where the creatures were digging, you find a seep of water. They were digging to reach it!", choices: [{text: "Collect the water and continue", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.water += 2; updateWaterDisplay(); }};
        storySections[78] = {text: "You catch one of the creatures. It struggles but eventually leads you to its water source.", choices: [{text: "Follow to the water source", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.water += 2; updateWaterDisplay(); }};
        storySections[79] = {text: "Continuing to wait, you learn the creatures' patterns and discover they have a network of tunnels leading to multiple water sources.", choices: [{text: "Use this knowledge to find water as you travel", nextSection: 200, skillCheck: false}]};
        storySections[80] = {text: "Continuing through the wastes, you eventually find a route that leads to the Necropolis.", choices: [{text: "Take the route to the Necropolis", nextSection: 200, skillCheck: false}]};
        storySections[81] = {text: "You find a cave just as the storm hits. Sheltered inside, you wait it out. After the storm, the landscape has changed - revealing an ancient road to the Necropolis!", choices: [{text: "Follow the revealed road", nextSection: 200, skillCheck: false}]};
        storySections[82] = {text: "You try to outrun the storm but it catches you. Blinded by ash, you stumble into a ravine that provides shelter and leads to the wastes' edge.", choices: [{text: "Follow the ravine to safety", nextSection: 200, skillCheck: false}], action: function() { gameState.stamina -= 4; updateStatsDisplay(); }};
        storySections[83] = {text: "Continuing into the storm is madness! The ash chokes you and you become hopelessly lost.", choices: [{text: "Try to survive", nextSection: 94, skillCheck: true, checkType: 'luck', difficulty: 15}]};
        storySections[84] = {text: "Resting until nightfall, you travel by cooler starlight and make excellent progress.", choices: [{text: "Continue your night journey to the Necropolis", nextSection: 200, skillCheck: false}]};
        storySections[85] = {text: "Searching the cave, you find a hidden spring and ancient murals showing the way through the wastes.", choices: [{text: "Drink and follow the mural's guidance", nextSection: 200, skillCheck: false}], action: function() { wastesConditions.water += 4; wastesConditions.hasMap = true; updateWaterDisplay(); }};
        storySections[86] = {text: "After a short rest, you continue and find a clearly marked trail used by traders to cross the wastes.", choices: [{text: "Follow the trader trail", nextSection: 200, skillCheck: false}]};
        storySections[87] = {text: "The dark ground indicates an ancient riverbed. Following it, you find occasional pools of water and the path leads to the Necropolis.", choices: [{text: "Follow the riverbed to your destination", nextSection: 200, skillCheck: false}]};
        storySections[88] = {text: "Looking for landmarks, you spot a peculiar rock formation that matches descriptions of a guidepost to the Necropolis.", choices: [{text: "Head toward the guidepost rock", nextSection: 200, skillCheck: false}]};
        storySections[89] = {text: "Beyond the collapse, the canyon opens to reveal the Necropolis in the distance!", choices: [{text: "Head toward the Necropolis", nextSection: 200, skillCheck: false}]};
        storySections[90] = {text: "With water collected, you continue through the canyon which leads to the wastes' edge.", choices: [{text: "Follow the canyon to the Necropolis", nextSection: 200, skillCheck: false}]};
        storySections[91] = {text: "Continuing your journey, you find a safe path marked by ancient stones.", choices: [{text: "Follow the marked path", nextSection: 200, skillCheck: false}]};
        storySections[92] = {text: "With water from the bird-creature's source, you have enough to reach the Necropolis.", choices: [{text: "Continue to the Necropolis", nextSection: 200, skillCheck: false}]};
        storySections[93] = {text: "Continuing with your water supply, you navigate the wastes successfully.", choices: [{text: "Reach the Necropolis", nextSection: 200, skillCheck: false}]};
        storySections[94] = {text: window.checkResult ? "Miraculously, you survive the storm and stumble upon the Necropolis!" : "The storm claims you. Game Over.", choices: [], action: function() { if(window.checkResult) { loadSection(200); } else { document.getElementById('story-text').innerHTML += "<div class='game-over'>The ash storm buries you alive. Game Over.</div>"; setTimeout(() => { localStorage.removeItem('dreadwoodGameState'); location.reload(); }, 3000); } }};
        
        // Initialize game
        function initGame() {
            updateStatsDisplay();
            updateInventoryDisplay();
            updateWaterDisplay();
            
            // If we have a current section from saved game, load it
            if (gameState.currentSection > 0) {
                loadSection(gameState.currentSection);
            } else {
                loadSection(0);
            }
        }
        
        // Apply environmental effects (water consumption, heat, etc.)
        function applyEnvironmentalEffects() {
            let effectsText = "";
            
            // Consume water each turn
            if (wastesConditions.water > 0) {
                wastesConditions.water -= 1;
                effectsText += "<div class='environment-effect'>Water consumed: -1 (Remaining: " + wastesConditions.water + ")</div>";
            } else {
                // No water - take damage
                gameState.stamina -= 3;
                effectsText += "<div class='environment-effect'>DEHYDRATION! No water remaining. You lose 3 Stamina.</div>";
            }
            
            // Check for heat exhaustion
            if (!wastesConditions.foundShelter && !wastesConditions.ashStorm) {
                if (Math.random() < 0.3) { // 30% chance each turn
                    gameState.stamina -= 1;
                    wastesConditions.heatExhaustion = true;
                    effectsText += "<div class='environment-effect'>HEAT EXHAUSTION! You lose 1 Stamina.</div>";
                }
            } else if (wastesConditions.foundShelter) {
                wastesConditions.heatExhaustion = false;
            }
            
            // Ash storm effects if active
            if (wastesConditions.ashStorm) {
                gameState.stamina -= 2;
                effectsText += "<div class='environment-effect'>ASH STORM! Choking ash damages you for 2 Stamina.</div>";
                // Chance to clear storm
                if (Math.random() < 0.4) {
                    wastesConditions.ashStorm = false;
                    effectsText += "<div class='environment-effect'>The ash storm begins to clear.</div>";
                }
            }
            
            // Update displays
            updateWaterDisplay();
            updateStatsDisplay();
            
            // Check for death
            if (gameState.stamina <= 0) {
                effectsText += "<div class='game-over'>You succumb to the harsh wastes. Game Over.</div>";
                setTimeout(() => {
                    localStorage.removeItem('dreadwoodGameState');
                    location.reload();
                }, 3000);
            }
            
            return effectsText;
        }
        
        // Update water display
        function updateWaterDisplay() {
            document.getElementById('stat-water').textContent = wastesConditions.water;
        }
        
        // Show warning dialog for new game
        function showNewGameWarning() {
            // Show warning dialog
            document.getElementById('screen-game').classList.remove('active-screen');
            document.getElementById('warning-dialog').classList.add('active-screen');
        }
        
        // Cancel new game and return to game screen
        function cancelNewGame() {
            document.getElementById('warning-dialog').classList.remove('active-screen');
            document.getElementById('screen-game').classList.add('active-screen');
        }
        
        // Start new game - reset everything
        function startNewGame() {
            // Clear all saved game data
            localStorage.removeItem('dreadwoodGameState');
            
            // Reset game state to completely empty
            gameState = {
                playerClass: '',
                skill: 0,
                maxStamina: 0,
                stamina: 0,
                luck: 0,
                gold: 0,
                inventory: [],
                weapons: [],
                armor: [],
                currentSection: 0,
                gameComplete: false
            };
            
            // Reset wastes conditions
            wastesConditions = {
                water: 5,
                hasMap: false,
                foundShelter: false,
                ashStorm: false,
                heatExhaustion: false,
                foundOasis: false,
                discoveredRuins: false
            };
            
            // Redirect to level1.html to start fresh
            window.location.href = 'level1.html';
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-skill').textContent = gameState.skill;
            document.getElementById('stat-stamina').textContent = gameState.stamina;
            document.getElementById('stat-maxstamina').textContent = gameState.maxStamina;
            document.getElementById('stat-luck').textContent = gameState.luck;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Show current weapon
            if (gameState.weapons && gameState.weapons.length > 0) {
                const weapon = gameState.weapons[gameState.weapons.length - 1];
                inventoryDiv.innerHTML += `<span class="inventory-item">${weapon.name} (${weapon.damage})</span>`;
            }
            
            // Show armor
            if (gameState.armor && gameState.armor.length > 0) {
                const armor = gameState.armor[gameState.armor.length - 1];
                inventoryDiv.innerHTML += `<span class="inventory-item">${armor.name} (${armor.defense} DEF)</span>`;
            }
            
            // Show gold
            inventoryDiv.innerHTML += `<span class="inventory-item">${gameState.gold} Gold</span>`;
            
            // Show other inventory items
            if (gameState.inventory) {
                gameState.inventory.forEach(item => {
                    if (item !== 'Dagger' && item !== 'Leather Armor') {
                        inventoryDiv.innerHTML += `<span class="inventory-item">${item}</span>`;
                    }
                });
            }
        }
        
        // Load story section
        function loadSection(sectionId) {
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                // If section doesn't exist yet, show a placeholder
                document.getElementById('story-text').innerHTML = "<p>Your journey through the Ashen Wastes continues... More content will be added in future updates!</p>";
                document.getElementById('choice-buttons').innerHTML = `
                    <button class="choice-btn" onclick="loadSection(0)">Return to Wastes Entrance</button>
                `;
                return;
            }
            
            let storyText = section.text;
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            // Apply environmental effects (unless this is the victory section)
            if (sectionId !== 200) {
                const envEffects = applyEnvironmentalEffects();
                if (envEffects) {
                    storyText += envEffects;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p>";
            
            // Clear and add choice buttons
            const choiceButtons = document.getElementById('choice-buttons');
            choiceButtons.innerHTML = '';
            
            section.choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = choice.text;
                button.onclick = function() {
                    if (choice.skillCheck) {
                        performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                    } else {
                        loadSection(choice.nextSection);
                    }
                };
                choiceButtons.appendChild(button);
            });
            
            // Save game progress
            saveGame();
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            const diceRoll = rollDiceHelper(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Start combat (for any hostile encounters in the wastes)
        function startCombat(enemyName, enemyStamina, enemySkill, nextSection) {
            const playerAttack = rollDiceHelper(2, 6) + gameState.skill;
            const enemyAttack = rollDiceHelper(2, 6) + enemySkill;
            
            let resultText = `<span class="enemy">BATTLE: ${enemyName}</span> (Skill: ${enemySkill}, Stamina: ${enemyStamina})<br>`;
            resultText += `You attack with ${playerAttack} vs enemy's ${enemyAttack}.<br>`;
            
            if (playerAttack > enemyAttack) {
                // Calculate damage based on current weapon
                let damage = 0;
                if (gameState.weapons && gameState.weapons.length > 0) {
                    const weapon = gameState.weapons[gameState.weapons.length - 1];
                    if (weapon.damage === '1d6') damage = rollDiceHelper(1, 6);
                    else if (weapon.damage === '1d6+1') damage = rollDiceHelper(1, 6) + 1;
                    else if (weapon.damage === '2d4') damage = rollDiceHelper(2, 4);
                    else if (weapon.damage === '2d6') damage = rollDiceHelper(2, 6);
                    else if (weapon.damage === '3d4') damage = rollDiceHelper(3, 4);
                    else if (weapon.damage === '3d6') damage = rollDiceHelper(3, 6);
                    else damage = rollDiceHelper(1, 6); // Default
                } else {
                    damage = rollDiceHelper(1, 6);
                }
                
                resultText += `<span class="success">You hit for ${damage} damage!</span>`;
                
                if (enemyStamina - damage <= 0) {
                    resultText += `<br><span class="success">You defeated the ${enemyName}!</span>`;
                    // Player might get resources for victory
                    const goldReward = Math.floor(Math.random() * 60) + 20;
                    gameState.gold += goldReward;
                    resultText += `<br>You find ${goldReward} Gold on the body.`;
                } else {
                    enemyStamina -= damage;
                    resultText += `<br>The ${enemyName} has ${enemyStamina} Stamina remaining.`;
                    // Enemy counterattacks
                    const enemyDamage = rollDiceHelper(1, 6);
                    gameState.stamina -= enemyDamage;
                    resultText += `<br><span class="damage">The ${enemyName} hits back for ${enemyDamage} damage!</span>`;
                }
            } else if (playerAttack < enemyAttack) {
                const damage = rollDiceHelper(1, 6);
                gameState.stamina -= damage;
                resultText += `<span class="damage">You are hit for ${damage} damage!</span>`;
            } else {
                resultText += "The attacks cancel each other out!";
            }
            
            updateStatsDisplay();
            
            // Check if player died
            if (gameState.stamina <= 0) {
                resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                // Reset game after delay
                setTimeout(() => {
                    localStorage.removeItem('dreadwoodGameState');
                    location.reload();
                }, 3000);
            }
            
            // Store combat result in appropriate section
            if (storySections[nextSection]) {
                storySections[nextSection].text = resultText;
            }
            
            return resultText;
        }
        
        // Use Luck
        function useLuck() {
            if (gameState.luck <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Luck left!</div>`;
                return;
            }
            
            const diceRoll = rollDiceHelper(2, 6);
            const success = diceRoll <= gameState.luck;
            
            gameState.luck -= 1;
            updateStatsDisplay();
            
            let resultText = `You test your Luck... Roll: ${diceRoll}, Luck: ${gameState.luck + 1}. `;
            resultText += success ? 
                `<span class="success">Lucky!</span> Something good happens.` : 
                `<span class="damage">Unlucky!</span> Something bad happens.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            // Apply Luck effect
            if (success) {
                // Good effect
                const goodEffects = [
                    "You find an untouched water cache! +4 Water.",
                    "You discover a shortcut through the wastes!",
                    "A friendly caravan gives you supplies! +3 Water, +2 Stamina.",
                    "You avoid a deadly ash storm that was approaching!",
                    "You find an ancient map showing all water sources!"
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Water")) {
                    if (effect.includes("+4")) wastesConditions.water += 4;
                    if (effect.includes("+3")) wastesConditions.water += 3;
                    updateWaterDisplay();
                }
                if (effect.includes("Stamina")) {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 2);
                    updateStatsDisplay();
                }
                if (effect.includes("map")) {
                    wastesConditions.hasMap = true;
                }
                if (effect.includes("shortcut")) {
                    // Shortcut to victory
                    setTimeout(() => {
                        loadSection(200);
                    }, 1000);
                }
            } else {
                // Bad effect
                const badEffects = [
                    "You spring a trap! Lose 3 Stamina and 2 Water.",
                    "You're attacked by ash creatures!",
                    "You get hopelessly lost!",
                    "Your water skin leaks! Lose 3 Water.",
                    "Heat stroke! Lose 4 Stamina."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Stamina")) {
                    const damage = effect.includes("3") ? 3 : 4;
                    gameState.stamina -= damage;
                    if (effect.includes("Water")) {
                        wastesConditions.water -= 2;
                        updateWaterDisplay();
                    }
                    if (gameState.stamina <= 0) {
                        document.getElementById('story-text').innerHTML += `<div class="game-over">You have been defeated! Game Over.</div>`;
                        setTimeout(() => {
                            localStorage.removeItem('dreadwoodGameState');
                            location.reload();
                        }, 3000);
                    }
                    updateStatsDisplay();
                } else if (effect.includes("Water")) {
                    wastesConditions.water -= 3;
                    updateWaterDisplay();
                } else if (effect.includes("attack")) {
                    // Trigger combat
                    setTimeout(() => {
                        startCombat("Ash Creatures", 12, 8, 95);
                    }, 1000);
                } else if (effect.includes("lost")) {
                    // Return to a random earlier section
                    const lostSections = [0, 1, 2, 3];
                    const randomSection = lostSections[Math.floor(Math.random() * lostSections.length)];
                    setTimeout(() => {
                        loadSection(randomSection);
                    }, 1000);
                }
            }
            
            updateInventoryDisplay();
        }
        
        // Check inventory
        function checkInventory() {
            let inventoryText = "<h3>Your Inventory:</h3>";
            
            if (gameState.weapons && gameState.weapons.length > 0) {
                const weapon = gameState.weapons[gameState.weapons.length - 1];
                inventoryText += `<p><strong>Weapon:</strong> ${weapon.name} (${weapon.damage} damage)</p>`;
            }
            
            if (gameState.armor && gameState.armor.length > 0) {
                const armor = gameState.armor[gameState.armor.length - 1];
                inventoryText += `<p><strong>Armor:</strong> ${armor.name} (${armor.defense} DEF)</p>`;
            }
            
            inventoryText += `<p><strong>Gold:</strong> ${gameState.gold}</p>`;
            inventoryText += `<p><strong>Water:</strong> ${wastesConditions.water} units</p>`;
            
            if (gameState.inventory && gameState.inventory.length > 0) {
                inventoryText += `<p><strong>Other Items:</strong> `;
                const otherItems = gameState.inventory.filter(item => 
                    item !== 'Dagger' && item !== 'Leather Armor' && 
                    !gameState.weapons.some(w => w.name === item) &&
                    !gameState.armor.some(a => a.name === item)
                );
                inventoryText += otherItems.join(', ') || 'None';
                inventoryText += `</p>`;
            }
            
            // Show wastes conditions
            inventoryText += `<p><strong>Wastes Conditions:</strong> `;
            const conditions = [];
            if (wastesConditions.hasMap) conditions.push("Has Map");
            if (wastesConditions.foundShelter) conditions.push("In Shelter");
            if (wastesConditions.ashStorm) conditions.push("Ash Storm!");
            if (wastesConditions.heatExhaustion) conditions.push("Heat Exhaustion");
            if (wastesConditions.foundOasis) conditions.push("Found Oasis");
            if (wastesConditions.discoveredRuins) conditions.push("Discovered Ruins");
            inventoryText += conditions.join(', ') || 'Normal Travel';
            inventoryText += `</p>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${inventoryText}</div>`;
        }
        
        // Save game
        function saveGame() {
            // Save both game state and wastes conditions
            const saveData = {
                ...gameState,
                wastesConditions: wastesConditions
            };
            localStorage.setItem('dreadwoodGameState', JSON.stringify(saveData));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">Game saved!</div>`;
        }
        
        // Go to next level
        function goToNextLevel() {
            // Save game state for level 6
            const saveData = {
                ...gameState,
                wastesConditions: wastesConditions
            };
            localStorage.setItem('dreadwoodGameState', JSON.stringify(saveData));
            // In a complete game, this would redirect to level6.html
            // For now, we'll just show a message since level6 doesn't exist yet
            alert("Level 6: Necropolis of Bones coming soon! Your game has been saved.");
            // Uncomment when level6.html exists:
            // window.location.href = 'level6.html';
        }
        
        // Utility function to roll dice
        function rollDiceHelper(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = function() {
            // Load wastes conditions from saved game if they exist
            const savedGame = JSON.parse(localStorage.getItem('dreadwoodGameState'));
            if (savedGame && savedGame.wastesConditions) {
                wastesConditions = savedGame.wastesConditions;
            }
            
            initGame();
        };
    </script>
</body>
</html>
