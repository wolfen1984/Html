<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASTLE OF THE UNDEAD - Level 1: The Tavern & Forest of Dread</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Red/Yellow/White/Black theme with proper contrast */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(50, 0, 0, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(50, 0, 0, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #c00;
            background-color: #000;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(50, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #c00;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #ff0;
            text-shadow: 0 0 5px #f00;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #c00;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #c00;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.current {
            background-color: #c00;
            color: #ff0;
            border-color: #ff0;
            box-shadow: 0 0 8px #f00;
            text-shadow: 0 0 2px #000;
        }
        
        .level-number.completed {
            background-color: #500;
            color: #ff0;
            border-color: #ff0;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #c00;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #ff0;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #c00;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #ff0;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #c00;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #ff0;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff0;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #c00;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #c00;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #ff0;
            border-color: #ff0;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #c00;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #ff0;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #c00;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #ff0;
            border-color: #ff0;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #111;
            border: 1px solid #c00;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ff0;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #222;
            border: 1px solid #ff0;
            padding: 10px;
            margin: 10px 0;
            color: #ff0;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f00;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f00;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #0f0;
            font-weight: bold;
        }
        
        .damage {
            color: #f00;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9900;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #0ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #c00;
            font-weight: bold;
            text-shadow: 0 0 3px #f00;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #c00;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #c00;
            color: #ff0;
            border-color: #ff0;
            box-shadow: 0 0 15px #f00;
        }
        
        /* Merchant Item Display */
        .merchant-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .merchant-item {
            background-color: #222;
            border: 1px solid #c00;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: #fff;
        }
        
        .merchant-item:hover {
            background-color: #333;
            border-color: #ff0;
        }
        
        .merchant-item h3 {
            color: #ff0;
            margin: 0 0 5px 0;
            font-size: 16px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .merchant-item p {
            color: #fff;
            font-size: 14px;
            margin: 0;
        }
        
        .merchant-cost {
            color: #ff0;
            font-weight: bold;
            margin-top: 5px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #c00;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #c00;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #ff0;
        }
        
        /* Character Creation Stats */
        .char-stats {
            background-color: #111;
            border: 1px solid #c00;
            padding: 15px;
            margin: 15px 0;
        }
        
        .stat-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            color: #fff;
        }
        
        .stat-name {
            color: #ff0;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .merchant-items {
                grid-template-columns: 1fr;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CASTLE OF THE UNDEAD</h1>
            <h2>LEVEL 1: THE TAVERN & FOREST OF DREAD</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number current">1</div>
            <div class="level-number">2</div>
            <div class="level-number">3</div>
            <div class="level-number">4</div>
            <div class="level-number">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Character Creation Screen -->
        <div id="screen-creation" class="screen active-screen">
            <h2>YOUR QUEST BEGINS</h2>
            <div class="story-text">
                <p>The village of Ravenwood lies under the shadow of Castle Vorlak, home to the <span class="vampire">VAMPIRE LORD VALERIUS</span>.</p>
                <p>For decades, he has cursed the land, turning villagers into his undead thralls at night. Crops wither, hope fades, and fear reigns.</p>
                <p>You sit in "The Weary Traveler" tavern. Old Gregor, the village elder, approaches you with desperate eyes.</p>
                <p>"Brave soul," he whispers. "Our only hope is to destroy Valerius. But first, you must survive the journey to his castle."</p>
                <p>He places 50 gold coins on the table. "Buy what you need from the merchant upstairs. Choose wisely - you can only take one special item on your quest."</p>
                <p>What kind of hero are you?</p>
                
                <div class="char-stats">
                    <div class="stat-line">
                        <span class="stat-name">KNIGHT</span>
                        <span>+4 Strength, +30 Health, +1 Agility</span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-name">HUNTER</span>
                        <span>+3 Strength, +25 Health, +3 Agility</span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-name">SCOUT</span>
                        <span>+2 Strength, +20 Health, +5 Agility</span>
                    </div>
                </div>
                
                <p>You will roll 2d6 for each base attribute, then add your class bonus.</p>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="selectClass('knight')">BECOME A KNIGHT</button>
                <button class="choice-btn" onclick="selectClass('hunter')">BECOME A HUNTER</button>
                <button class="choice-btn" onclick="selectClass('scout')">BECOME A SCOUT</button>
            </div>
        </div>
        
        <!-- Dice Roll Screen -->
        <div id="screen-dice" class="screen">
            <h2>CHARACTER ATTRIBUTES</h2>
            <div class="story-text">
                <p>You have chosen the path of a <span id="selected-class" class="enemy"></span>.</p>
                <p>Now roll the dice for your attributes:</p>
                <p><strong>Strength:</strong> 2 dice + class bonus (determines combat ability)</p>
                <p><strong>Health:</strong> 2 dice + class bonus (your vitality)</p>
                <p><strong>Agility:</strong> 2 dice + class bonus (helps in dangerous situations)</p>
                <div id="dice-results"></div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="rollCharacterStats()">ROLL DICE</button>
                <button class="action-btn" onclick="proceedToMerchant()" id="proceed-btn" disabled>CONTINUE TO MERCHANT</button>
            </div>
        </div>
        
        <!-- Merchant Screen -->
        <div id="screen-merchant" class="screen">
            <h2>THE TAVERN'S SECRET MERCHANT</h2>
            <div class="story-text">
                <p>You climb the creaky stairs to the attic. A hooded figure sits behind a table covered with strange items.</p>
                <p>"Ah, another fool seeking to challenge the night," the merchant chuckles. "My wares are expensive, but they might save your life. Choose ONE item to aid your journey."</p>
                <p>You have <span class="gold" id="merchant-gold">50</span> gold.</p>
                
                <div class="merchant-items">
                    <div class="merchant-item" onclick="selectMerchantItem('holy_water')">
                        <h3>HOLY WATER</h3>
                        <p>Blessed by the high priest. Effective against undead.</p>
                        <div class="merchant-cost">Cost: 25 Gold</div>
                    </div>
                    <div class="merchant-item" onclick="selectMerchantItem('silver_dagger')">
                        <h3>SILVER DAGGER</h3>
                        <p>Pure silver blade. Vampires fear silver.</p>
                        <div class="merchant-cost">Cost: 40 Gold</div>
                    </div>
                    <div class="merchant-item" onclick="selectMerchantItem('garlic_charm')">
                        <h3>GARLIC CHARM</h3>
                        <p>Woven garlic bulbs. Repels lesser undead.</p>
                        <div class="merchant-cost">Cost: 15 Gold</div>
                    </div>
                    <div class="merchant-item" onclick="selectMerchantItem('healing_potion')">
                        <h3>HEALING POTION</h3>
                        <p>Restores 2d10+10 health when injured.</p>
                        <div class="merchant-cost">Cost: 20 Gold</div>
                    </div>
                    <div class="merchant-item" onclick="selectMerchantItem('stake')">
                        <h3>OAK STAKE</h3>
                        <p>For the final blow to a vampire's heart.</p>
                        <div class="merchant-cost">Cost: 10 Gold</div>
                    </div>
                    <div class="merchant-item" onclick="selectMerchantItem('lantern')">
                        <h3>EVERBURN LANTERN</h3>
                        <p>Never goes out. Light is safety in dark woods.</p>
                        <div class="merchant-cost">Cost: 30 Gold</div>
                    </div>
                </div>
                
                <div id="selected-item-display" style="display: none; margin-top: 15px; padding: 10px; background-color: #111; border: 1px solid #c00;">
                    <p>Selected: <span id="selected-item-name" class="item"></span></p>
                    <p id="selected-item-desc"></p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="confirmMerchantItem()" id="confirm-item-btn" disabled>CONFIRM SELECTION</button>
                <button class="action-btn" onclick="skipMerchant()">TAKE NOTHING (KEEP GOLD)</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>THE FOREST OF DREAD</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL 1 COMPLETE!</h2>
            <div class="story-text">
                <p>You have survived the Forest of Dread!</p>
                <p>As you emerge from the twisted trees, you see the Mountains of Moor rising before you. The castle lies somewhere at their peak, shrouded in perpetual storm clouds.</p>
                <p>The forest behind you whispers with malevolent energy, but you cannot turn back. The villagers' hope rests with you.</p>
                <p>All your stats, gold, and inventory will carry over to Level 2.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #111; border: 1px solid #c00;">
                    <h3 style="color: #ff0; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO LEVEL 2: MOUNTAINS OF MOOR</button>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE UNDEAD - A Retro Vampire Hunt Adventure<br>
            Level 1: The Tavern & Forest of Dread
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'vampire':
                    playBeep(150, 0.3, 'sawtooth');
                    setTimeout(() => playBeep(100, 0.3, 'sawtooth'), 300);
                    break;
                case 'forest':
                    playBeep(300, 0.2, 'sine');
                    setTimeout(() => playBeep(250, 0.2, 'sine'), 200);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - will be saved to localStorage
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 50, // Starting gold
            inventory: [],
            equippedWeapon: 'Rusty Sword',
            equippedArmor: 'Leather Armor',
            currentSection: 1,
            gameComplete: false,
            level: 1,
            merchantItem: null,
            forestCleared: false
        };
        
        // Merchant items data
        const merchantItems = {
            holy_water: {
                name: 'Vial of Holy Water',
                description: 'Blessed water that burns undead creatures',
                cost: 25,
                effect: 'Deals double damage to undead'
            },
            silver_dagger: {
                name: 'Silver Dagger',
                description: 'Pure silver blade effective against vampires',
                cost: 40,
                effect: '+3 damage vs vampires, can be equipped'
            },
            garlic_charm: {
                name: 'Garlic Charm',
                description: 'Woven garlic bulbs that repel lesser undead',
                cost: 15,
                effect: 'Zombies and ghouls avoid you'
            },
            healing_potion: {
                name: 'Healing Potion',
                description: 'Restores health when consumed',
                cost: 20,
                effect: 'Restores 2d10+10 health'
            },
            stake: {
                name: 'Sharpened Oak Stake',
                description: 'For driving through a vampire\'s heart',
                cost: 10,
                effect: 'Instant kill on sleeping vampires'
            },
            lantern: {
                name: 'Everburning Lantern',
                description: 'Magical lantern that never extinguishes',
                cost: 30,
                effect: 'Lights dark areas, reveals hidden paths'
            }
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1
        };
        
        // Game story sections for Level 1
        const storySections = {
            1: {
                text: "You leave 'The Weary Traveler' tavern as night falls. The village gates creak shut behind you. Before you stretches the Forest of Dread - a twisted, shadowy wood where few who enter ever return. Moonlight filters through skeletal branches, casting eerie shadows. The path forks ahead.",
                choices: [
                    {text: "Take the main path (safer but longer)", nextSection: 2, skillCheck: false},
                    {text: "Cut through the dense woods (shorter but dangerous)", nextSection: 3, skillCheck: false},
                    {text: "Follow the creek bed (might avoid creatures)", nextSection: 4, skillCheck: true, checkType: 'agility', difficulty: 12}
                ]
            },
            2: {
                text: "You follow the main path. The trees loom like silent sentinels. Suddenly, you hear rustling in the bushes ahead. Two glowing red eyes appear in the darkness.",
                choices: [
                    {text: "Draw your weapon and prepare to fight", nextSection: 5, skillCheck: false},
                    {text: "Hide behind a tree and wait", nextSection: 6, skillCheck: true, checkType: 'agility', difficulty: 10},
                    {text: "Throw a rock to distract it", nextSection: 7, skillCheck: false}
                ]
            },
            5: {
                text: "A wolf-like creature with matted fur and glowing eyes emerges from the bushes. It's no ordinary wolf - its flesh is partially decayed. A FOREST GHOUL!",
                choices: [
                    {text: "Fight the forest ghoul", nextSection: 8, skillCheck: false},
                    {text: "Try to scare it away with fire", nextSection: 9, skillCheck: false, requirement: 'Everburning Lantern'},
                    {text: "Use holy water if you have it", nextSection: 10, skillCheck: false, requirement: 'Vial of Holy Water'}
                ]
            },
            6: {
                text: "You hide behind a large oak tree, holding your breath. The creature sniffs the air...",
                choices: [
                    {text: "Continue waiting", nextSection: 11, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "The creature doesn't notice you. After a few tense minutes, it moves away, deeper into the forest. You can continue safely.";
                    } else {
                        playSound('failure');
                        return "You step on a twig! The creature whirls around and spots you. It prepares to attack!";
                    }
                }
            },
            7: {
                text: "You throw a rock into the distance. The creature's head snaps toward the sound...",
                choices: [
                    {text: "Sneak past while it's distracted", nextSection: 12, skillCheck: true, checkType: 'agility', difficulty: 8}
                ]
            },
            8: {
                text: "The forest ghoul attacks with surprising speed! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 13, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Forest Ghoul";
                    combatState.enemyHealth = 25;
                    combatState.enemyCurrentHealth = 25;
                    combatState.enemyStrength = 8;
                    combatState.enemyDamageDice = 1;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 14;
                    combatState.round = 1;
                    
                    playSound('forest');
                    return "<span class='enemy'>Forest Ghoul</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            9: {
                text: "You raise your everburning lantern high. The bright light makes the ghoul hiss and retreat into the shadows!",
                choices: [
                    {text: "Continue on the path", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The <span class='item'>Everburning Lantern</span> saves you from combat! The ghoul cannot stand the bright light.";
                }
            },
            10: {
                text: "You sprinkle holy water toward the creature. It shrieks as the blessed liquid burns its undead flesh!",
                choices: [
                    {text: "Finish it off while it's wounded", nextSection: 16, skillCheck: false},
                    {text: "Escape while it's distracted", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    // Holy water does initial damage
                    const holyDamage = rollDice(2, 6) + 5;
                    combatState.enemyCurrentHealth -= holyDamage;
                    playSound('item');
                    return "You use your <span class='item'>Vial of Holy Water</span>! The ghoul takes " + holyDamage + " holy damage!";
                }
            },
            11: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue along the path", nextSection: 15, skillCheck: false}
                ]
            },
            12: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip past the creature unnoticed and continue down the path.";
                    } else {
                        playSound('failure');
                        return "The creature notices you moving and attacks!";
                    }
                }
            },
            13: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 17, skillCheck: false}
                ]
            },
            14: {
                text: "", // After combat
                choices: [
                    {text: "Search the remains", nextSection: 18, skillCheck: false},
                    {text: "Continue along the path", nextSection: 15, skillCheck: false}
                ]
            },
            15: {
                text: "You continue along the forest path. The trees begin to thin slightly. You can see moonlight ahead - the edge of the forest!",
                choices: [
                    {text: "Hurry toward the forest edge", nextSection: 19, skillCheck: false},
                    {text: "Proceed cautiously", nextSection: 20, skillCheck: false}
                ]
            },
            16: {
                text: "The ghoul is badly wounded from the holy water. It staggers back, smoke rising from its burns.",
                choices: [
                    {text: "Finish it with your weapon", nextSection: 21, skillCheck: false}
                ]
            },
            17: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 13, skillCheck: false}
                ]
            },
            18: {
                text: "Searching the ghoul's remains, you find a tattered pouch containing gold coins and a strange bone talisman.",
                choices: [
                    {text: "Take the items", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 8);
                    gameState.gold += goldFound;
                    addToInventory('Bone Talisman');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Bone Talisman</span> on the ghoul's remains.";
                }
            },
            19: {
                text: "You run toward the forest edge. Just as you're about to break through the tree line, a shadow drops from above! A VAMPIRE BAT the size of a large dog blocks your path!",
                choices: [
                    {text: "Fight the giant bat", nextSection: 22, skillCheck: false},
                    {text: "Try to dodge past it", nextSection: 23, skillCheck: true, checkType: 'agility', difficulty: 15}
                ]
            },
            20: {
                text: "You move cautiously toward the forest edge. The moonlight reveals the Mountains of Moor in the distance. You're almost through the forest!",
                choices: [
                    {text: "Step into the moonlight", nextSection: 100, skillCheck: false}
                ]
            },
            21: {
                text: "You strike the wounded ghoul, finishing it off. It collapses into dust and decayed flesh.",
                choices: [
                    {text: "Search the remains", nextSection: 18, skillCheck: false},
                    {text: "Continue along the path", nextSection: 15, skillCheck: false}
                ]
            },
            22: {
                text: "The giant vampire bat screeches and attacks with sharp claws and teeth!",
                choices: [
                    {text: "Fight the vampire bat", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Giant Vampire Bat";
                    combatState.enemyHealth = 35;
                    combatState.enemyCurrentHealth = 35;
                    combatState.enemyStrength = 10;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 25;
                    combatState.round = 1;
                    
                    playSound('vampire');
                    return "<span class='enemy'>Giant Vampire Bat</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            23: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 26, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You dive under the bat's swooping attack and roll past it! You reach the forest edge!";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The bat's wing strikes you as you try to dodge. You take " + damage + " damage and fall to the ground.";
                    }
                }
            },
            24: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 27, skillCheck: false}
                ]
            },
            25: {
                text: "", // After combat
                choices: [
                    {text: "Collect bat fangs as trophy", nextSection: 28, skillCheck: false},
                    {text: "Continue to forest edge", nextSection: 100, skillCheck: false}
                ]
            },
            26: {
                text: "Whether you dodged successfully or not, you're at the forest's edge now. The Mountains of Moor rise before you.",
                choices: [
                    {text: "Leave the forest", nextSection: 100, skillCheck: false}
                ]
            },
            27: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 24, skillCheck: false}
                ]
            },
            28: {
                text: "You collect the bat's sharp fangs. They might be useful or valuable.",
                choices: [
                    {text: "Continue to forest edge", nextSection: 100, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Vampire Bat Fangs');
                    playSound('item');
                    return "You collect <span class='item'>Vampire Bat Fangs</span>. They're sharp and cold to the touch.";
                }
            },
            100: {
                text: "CONGRATULATIONS! You have survived the Forest of Dread. You stand at the edge of the woods, looking up at the Mountains of Moor. Castle Vorlak awaits somewhere in those peaks.",
                choices: [],
                action: function() {
                    gameState.forestCleared = true;
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 2;
                    saveGame();
                    
                    return "";
                }
            }
        };
        
        // Initialize game
        function initGame() {
            // Check for saved game
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 1 (this page)
                if (savedState.level === 1) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    return;
                }
            }
            
            // Otherwise start with character creation
            showScreen('screen-creation');
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Select character class
        function selectClass(className) {
            playSound('click');
            gameState.playerClass = className;
            document.getElementById('selected-class').textContent = className.toUpperCase();
            showScreen('screen-dice');
        }
        
        // Roll dice for character stats
        function rollCharacterStats() {
            playSound('roll');
            
            // Base rolls (2d6 each)
            const strengthRoll = rollDice(2, 6);
            const healthRoll = rollDice(2, 6);
            const agilityRoll = rollDice(2, 6);
            
            // Apply class bonuses
            let strengthBonus = 0, healthBonus = 0, agilityBonus = 0;
            
            switch(gameState.playerClass) {
                case 'knight':
                    strengthBonus = 4;
                    healthBonus = 30;
                    agilityBonus = 1;
                    break;
                case 'hunter':
                    strengthBonus = 3;
                    healthBonus = 25;
                    agilityBonus = 3;
                    break;
                case 'scout':
                    strengthBonus = 2;
                    healthBonus = 20;
                    agilityBonus = 5;
                    break;
            }
            
            gameState.strength = strengthRoll + strengthBonus;
            gameState.maxHealth = healthRoll + healthBonus;
            gameState.health = gameState.maxHealth;
            gameState.agility = agilityRoll + agilityBonus;
            
            // Starting equipment
            gameState.inventory = ['Torch', 'Rope', 'Whetstone', 'Iron Rations'];
            gameState.equippedWeapon = 'Rusty Sword';
            gameState.equippedArmor = 'Leather Armor';
            
            document.getElementById('dice-results').innerHTML = `
                <div class="dice-roll">
                    Strength: ${strengthRoll} + ${strengthBonus} = <span class="stat-value">${gameState.strength}</span>
                </div>
                <div class="dice-roll">
                    Health: ${healthRoll} + ${healthBonus} = <span class="stat-value">${gameState.maxHealth}</span>
                </div>
                <div class="dice-roll">
                    Agility: ${agilityRoll} + ${agilityBonus} = <span class="stat-value">${gameState.agility}</span>
                </div>
            `;
            
            document.getElementById('proceed-btn').disabled = false;
        }
        
        function proceedToMerchant() {
            playSound('click');
            document.getElementById('merchant-gold').textContent = gameState.gold;
            showScreen('screen-merchant');
        }
        
        // Merchant item selection
        let selectedMerchantItem = null;
        
        function selectMerchantItem(itemKey) {
            playSound('click');
            selectedMerchantItem = itemKey;
            const item = merchantItems[itemKey];
            
            document.getElementById('selected-item-name').textContent = item.name;
            document.getElementById('selected-item-desc').innerHTML = 
                `<span class="item">${item.name}</span>: ${item.description}<br>Effect: ${item.effect}`;
            document.getElementById('selected-item-display').style.display = 'block';
            
            // Enable confirm button if player has enough gold
            if (gameState.gold >= item.cost) {
                document.getElementById('confirm-item-btn').disabled = false;
            } else {
                document.getElementById('confirm-item-btn').disabled = true;
            }
        }
        
        function confirmMerchantItem() {
            if (!selectedMerchantItem) return;
            
            const item = merchantItems[selectedMerchantItem];
            
            if (gameState.gold >= item.cost) {
                playSound('item');
                gameState.gold -= item.cost;
                addToInventory(item.name);
                gameState.merchantItem = item.name;
                
                // Special handling for silver dagger (can be equipped)
                if (selectedMerchantItem === 'silver_dagger') {
                    gameState.equippedWeapon = 'Silver Dagger';
                }
                
                updateStatsDisplay();
                updateInventoryDisplay();
                startGame();
            }
        }
        
        function skipMerchant() {
            playSound('click');
            startGame();
        }
        
        function startGame() {
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item)) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Potion') {
                const healAmount = rollDice(2, 10) + 10;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory('Healing Potion');
                playSound('item');
                message = `You drink the <span class='item'>Healing Potion</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Torch') {
                message = "The <span class='item'>Torch</span> provides light in dark areas. It will eventually burn out.";
            } else if (item === 'Vial of Holy Water') {
                message = "The <span class='item'>Vial of Holy Water</span> is blessed water that burns undead creatures. It can be used in combat against undead.";
            } else if (item === 'Garlic Charm') {
                message = "The <span class='item'>Garlic Charm</span> repels lesser undead like zombies and ghouls. They avoid the strong scent.";
            } else if (item === 'Sharpened Oak Stake') {
                message = "The <span class='item'>Sharpened Oak Stake</span> is for driving through a vampire's heart. It's useless against other enemies.";
            } else if (item === 'Everburning Lantern') {
                message = "The <span class='item'>Everburning Lantern</span> provides constant light that never goes out. Useful in dark forests and caves.";
            } else if (item === 'Iron Rations') {
                const healAmount = rollDice(1, 6) + 3;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory('Iron Rations');
                playSound('item');
                message = `You eat the <span class='item'>Iron Rations</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Sword' && 
                gameState.equippedArmor === 'Leather Armor') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 13 || sectionId === 17 || sectionId === 24 || sectionId === 27);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    const goldReward = Math.floor(Math.random() * 20) + 10;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find <span class="gold">${goldReward} Gold</span> on the remains.`;
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue through the forest";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                if (gameState.equippedWeapon === 'Rusty Sword') damage = rollDice(2, 6);
                else if (gameState.equippedWeapon === 'Silver Dagger') damage = rollDice(2, 6) + 3; // Bonus vs undead
                else damage = rollDice(2, 6); // Default
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                const enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('castleUndeadGameState');
                        location.reload();
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You spot a hidden path!",
                    "You dodge an unseen hazard!",
                    "You move silently past a sleeping creature."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip and take 2 damage!",
                    "You make noise and alert nearby creatures.",
                    "You get tangled in vines."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 2;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 1 (this page)
                if (savedState.level === 1) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 1.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 2 with updated level
            gameState.level = 2;
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            // Redirect to level 2 (you'll need to create l2.html)
            window.location.href = 'l2.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
