<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chambers of Fear - Level 1</title>
    <style>
        /* Retro 80s computer game style - Improved UI */
        :root {
            --primary-color: #00ff00;
            --secondary-color: #ff00ff;
            --accent-color: #00ccff;
            --danger-color: #ff3333;
            --warning-color: #ffff00;
            --bg-dark: #0a0a0a;
            --bg-medium: #111122;
            --bg-light: #1a1a2a;
            --text-color: #cccccc;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background-color: var(--bg-dark);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 40, 80, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(80, 0, 40, 0.1) 0%, transparent 20%);
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 3px solid var(--primary-color);
            background-color: rgba(0, 0, 20, 0.9);
            box-shadow: 
                0 0 20px rgba(0, 255, 0, 0.3),
                inset 0 0 20px rgba(0, 40, 80, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 0, 0.03) 0px,
                rgba(0, 255, 0, 0.03) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            border-bottom: 3px double var(--primary-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }
        
        h1 {
            color: var(--secondary-color);
            text-shadow: 
                0 0 10px var(--secondary-color),
                0 0 20px rgba(255, 0, 255, 0.5);
            font-size: 36px;
            margin: 10px 0;
            letter-spacing: 3px;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        .subtitle {
            color: var(--accent-color);
            font-size: 18px;
            margin: 5px 0 15px;
            letter-spacing: 2px;
        }
        
        .level-indicator {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 5px;
            margin: 15px 0;
            padding: 10px;
            background-color: rgba(0, 20, 40, 0.7);
            border: 1px solid var(--accent-color);
            border-radius: 5px;
        }
        
        .level-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #333355;
            border: 1px solid #555577;
        }
        
        .level-dot.active {
            background-color: var(--primary-color);
            box-shadow: 0 0 8px var(--primary-color);
            border-color: #ffffff;
        }
        
        .level-dot.completed {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        h2 {
            color: var(--accent-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 8px;
            margin-top: 25px;
            text-shadow: 0 0 5px rgba(0, 204, 255, 0.5);
            font-size: 22px;
            position: relative;
            z-index: 2;
        }
        
        h2::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100px;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-color), transparent);
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 2;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .stats-bar {
            background-color: var(--bg-medium);
            border: 2px solid var(--primary-color);
            padding: 12px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 16px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
        }
        
        .stat-item {
            margin: 5px 10px;
            display: flex;
            align-items: center;
        }
        
        .stat-label {
            margin-right: 5px;
            color: var(--accent-color);
        }
        
        .stat-value {
            color: var(--warning-color);
            font-weight: bold;
            font-size: 18px;
            text-shadow: 0 0 5px rgba(255, 255, 0, 0.3);
        }
        
        .inventory-section {
            background-color: var(--bg-medium);
            border: 2px solid var(--secondary-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.2);
        }
        
        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            min-height: 60px;
        }
        
        .inventory-item {
            display: inline-flex;
            align-items: center;
            background-color: var(--bg-light);
            border: 1px solid var(--accent-color);
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: rgba(0, 204, 255, 0.1);
            border-color: var(--warning-color);
            transform: translateY(-2px);
        }
        
        .item-count {
            background-color: var(--secondary-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .story-text {
            background-color: rgba(10, 10, 20, 0.8);
            border: 2px solid var(--primary-color);
            padding: 20px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 400px;
            border-radius: 5px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
            line-height: 1.6;
        }
        
        .story-text::-webkit-scrollbar {
            width: 8px;
        }
        
        .story-text::-webkit-scrollbar-track {
            background: rgba(0, 20, 40, 0.5);
        }
        
        .story-text::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 25px 0;
        }
        
        .choice-btn {
            background-color: var(--bg-medium);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .choice-btn::before {
            content: ">";
            position: absolute;
            left: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .choice-btn:hover::before, .choice-btn:active::before {
            opacity: 1;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: rgba(0, 255, 0, 0.1);
            color: var(--warning-color);
            border-color: var(--warning-color);
            transform: translateX(5px);
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.3);
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 25px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: rgba(80, 0, 80, 0.7);
            color: var(--secondary-color);
            border: 2px solid var(--secondary-color);
            padding: 12px 18px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            border-radius: 5px;
            transition: all 0.2s;
            min-width: 140px;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: rgba(120, 0, 120, 0.9);
            color: #ff99ff;
            border-color: #ff99ff;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
        }
        
        .dice-roll {
            background-color: rgba(20, 40, 20, 0.7);
            border: 2px solid var(--primary-color);
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            color: var(--warning-color);
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
        }
        
        .combat-log {
            background-color: rgba(40, 20, 20, 0.7);
            border: 2px solid var(--danger-color);
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.2);
        }
        
        .game-over {
            color: var(--danger-color);
            font-weight: bold;
            text-align: center;
            font-size: 28px;
            margin: 20px;
            text-shadow: 0 0 10px var(--danger-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .success {
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .damage {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9933;
            font-weight: bold;
        }
        
        .loot {
            color: var(--warning-color);
            font-weight: bold;
        }
        
        .next-level {
            text-align: center;
            margin-top: 30px;
            padding: 25px;
            background-color: rgba(0, 40, 80, 0.5);
            border: 3px solid var(--accent-color);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 204, 255, 0.3);
        }
        
        .next-level-btn {
            background-color: rgba(0, 60, 120, 0.8);
            color: var(--accent-color);
            border: 3px solid var(--accent-color);
            padding: 18px 35px;
            font-family: 'Courier New', monospace;
            font-size: 22px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 8px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: rgba(0, 100, 180, 0.9);
            color: #99ffff;
            border-color: #99ffff;
            box-shadow: 0 0 25px rgba(0, 204, 255, 0.7);
            transform: scale(1.05);
        }
        
        .footer {
            text-align: center;
            color: #666688;
            font-size: 14px;
            margin-top: 30px;
            border-top: 1px solid #333355;
            padding-top: 15px;
            position: relative;
            z-index: 2;
        }
        
        .sound-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 20, 40, 0.7);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            z-index: 10;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 28px;
            }
            
            .stats-bar {
                font-size: 14px;
                padding: 10px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 16px;
            }
            
            .action-btn {
                min-width: 120px;
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .sound-toggle {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 10px;
                display: inline-block;
            }
        }
        
        /* CRT Screen Effect */
        .crt::after {
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 999;
        }
    </style>
</head>
<body class="crt">
    <div class="container">
        <button class="sound-toggle" onclick="toggleSound()">SOUND: ON</button>
        
        <div class="header">
            <h1>CHAMBERS OF FEAR</h1>
            <div class="subtitle">A RETRO GAMEBOOK ADVENTURE</div>
            
            <div class="level-indicator">
                <div class="level-dot active" title="Level 1: The Entry Hall"></div>
                <div class="level-dot" title="Level 2: Corridors of Mist"></div>
                <div class="level-dot" title="Level 3: The Crypt"></div>
                <div class="level-dot" title="Level 4: Library of Lost Souls"></div>
                <div class="level-dot" title="Level 5: The Gauntlet"></div>
                <div class="level-dot" title="Level 6: Hall of Mirrors"></div>
                <div class="level-dot" title="Level 7: Pit of Despair"></div>
                <div class="level-dot" title="Level 8: Throne Room"></div>
                <div class="level-dot" title="Level 9: Dungeon Core"></div>
                <div class="level-dot" title="Level 10: Final Confrontation"></div>
            </div>
        </div>
        
        <!-- Character Creation Screen -->
        <div id="screen-creation" class="screen active-screen">
            <h2>CHARACTER CREATION</h2>
            <div class="story-text">
                <p>Welcome to the CHAMBERS OF FEAR, adventurer. Ten levels of peril await you in this cursed dungeon. Few have survived its depths, and none have reached the final chamber.</p>
                <p>First, choose your class. Each has unique strengths:</p>
                <p><span class="enemy">WARRIOR</span>: +3 Skill, +6 Stamina, +0 Luck</p>
                <p><span class="enemy">ROGUE</span>: +4 Skill, +4 Stamina, +2 Luck</p>
                <p><span class="enemy">MAGE</span>: +2 Skill, +3 Stamina, +4 Luck</p>
                <p><span class="enemy">RANGER</span>: +3 Skill, +5 Stamina, +1 Luck</p>
                <p>After choosing, roll dice for your attributes. Skill determines combat prowess, Stamina your health, and Luck can help in desperate situations.</p>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="selectClass('warrior')">BECOME A WARRIOR</button>
                <button class="choice-btn" onclick="selectClass('rogue')">BECOME A ROGUE</button>
                <button class="choice-btn" onclick="selectClass('mage')">BECOME A MAGE</button>
                <button class="choice-btn" onclick="selectClass('ranger')">BECOME A RANGER</button>
            </div>
            
            <div id="dice-roll-section" style="display: none;">
                <h2>ROLL YOUR STATS</h2>
                <div class="story-text">
                    <p>You have chosen to be a <span id="selected-class" class="enemy"></span>.</p>
                    <p>Roll 2 dice for each attribute:</p>
                    <p><strong>Skill:</strong> 2 dice + class bonus</p>
                    <p><strong>Stamina:</strong> 2 dice + class bonus</p>
                    <p><strong>Luck:</strong> 2 dice + class bonus</p>
                    <div id="dice-results"></div>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn" onclick="rollCharacterStats()">ROLL DICE</button>
                    <button class="action-btn" onclick="confirmStats()" id="confirm-btn" disabled>ENTER THE CHAMBERS</button>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">SKILL:</span> <span id="stat-skill" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">STAMINA:</span> <span id="stat-stamina" class="stat-value">0</span>/<span id="stat-maxstamina" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">LUCK:</span> <span id="stat-luck" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">LEVEL:</span> <span id="stat-level" class="stat-value">1</span></div>
            </div>
            
            <div class="inventory-section">
                <h2>INVENTORY</h2>
                <div class="inventory-items" id="inventory">
                    <!-- Inventory items will be inserted here -->
                </div>
            </div>
            
            <h2>THE CHAMBERS</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useLuck()">TEST LUCK</button>
                <button class="action-btn" onclick="checkInventory()">INVENTORY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL COMPLETE!</h2>
            <div class="story-text">
                <p>You have survived <span class="enemy">LEVEL 1: THE ENTRY HALL</span>!</p>
                <p>Beyond the heavy oak door, you hear echoes from deeper within the Chambers. The air grows colder, and strange whispers seem to call your name.</p>
                <p>Your journey continues to Level 2... All your stats, gold, and inventory will carry over.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">SKILL:</span> <span id="next-stat-skill" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">STAMINA:</span> <span id="next-stat-stamina" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">LUCK:</span> <span id="next-stat-luck" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO LEVEL 2</button>
                <p style="margin-top: 15px; color: #aaa;">The Chambers of Fear await...</p>
            </div>
        </div>
        
        <div class="footer">
            CHAMBERS OF FEAR - A RETRO GAMEBOOK ADVENTURE<br>
            LEVEL 1: THE ENTRY HALL | SAVE OFTEN!
        </div>
    </div>

    <!-- Audio elements for sound effects -->
    <audio id="clickSound" src="https://assets.mixkit.co/active_storage/sfx/286/286-preview.mp3" preload="auto"></audio>
    <audio id="diceSound" src="https://assets.mixkit.co/active_storage/sfx/248/248-preview.mp3" preload="auto"></audio>
    <audio id="combatSound" src="https://assets.mixkit.co/active_storage/sfx/251/251-preview.mp3" preload="auto"></audio>
    <audio id="itemSound" src="https://assets.mixkit.co/active_storage/sfx/222/222-preview.mp3" preload="auto"></audio>
    <audio id="levelUpSound" src="https://assets.mixkit.co/active_storage/sfx/257/257-preview.mp3" preload="auto"></audio>

    <script>
        // Game state - Will be saved to localStorage
        const gameState = {
            gameName: "ChambersOfFear",
            playerClass: '',
            skill: 0,
            maxStamina: 0,
            stamina: 0,
            luck: 0,
            gold: 0,
            level: 1,
            inventory: [],
            weapons: [{id: 'dagger', name: 'Iron Dagger', damage: '1d6', equipped: true}],
            armor: [{id: 'leather', name: 'Leather Armor', defense: 1, equipped: true}],
            consumables: [
                {id: 'pot_heal', name: 'Healing Potion', type: 'heal', value: 4, count: 1},
                {id: 'pot_luck', name: 'Luck Elixir', type: 'luck', value: 2, count: 1}
            ],
            currentSection: 1,
            gameComplete: false,
            levelsCompleted: [1] // Tracks completed levels
        };
        
        // Sound settings
        let soundEnabled = true;
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyStamina: 0,
            enemyCurrentStamina: 0,
            enemySkill: 0,
            nextSection: 0,
            round: 1
        };
        
        // Game story sections for Level 1
        const storySections = {
            1: {
                text: "You stand before the entrance to the Chambers of Fear. The massive stone door groans open, revealing a dark hallway lit by flickering torches. The air smells of damp earth and something... metallic. Which way will you go?",
                choices: [
                    {text: "Follow the left passage", nextSection: 2, skillCheck: false},
                    {text: "Take the right corridor", nextSection: 3, skillCheck: false},
                    {text: "Examine the entrance hall first", nextSection: 4, skillCheck: false}
                ]
            },
            2: {
                text: "You follow the left passage. The torches become fewer, and shadows dance on the walls. Ahead, you see a skeletal figure guarding a treasure chest.",
                choices: [
                    {text: "Attack the skeleton guardian", nextSection: 5, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 6, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Attempt to reason with it", nextSection: 7, skillCheck: true, checkType: 'luck', difficulty: 10}
                ]
            },
            3: {
                text: "The right corridor leads to a library. Dusty tomes line the shelves, and a large book lies open on a pedestal. Strange symbols glow on its pages.",
                choices: [
                    {text: "Read the open book", nextSection: 8, skillCheck: false},
                    {text: "Search the library for useful items", nextSection: 9, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Leave the library quickly", nextSection: 10, skillCheck: false}
                ]
            },
            4: {
                text: "You examine the entrance hall carefully. Under a loose stone, you find a hidden compartment containing 15 Gold coins and a mysterious key.",
                choices: [
                    {text: "Take the items and go left", nextSection: 2, skillCheck: false},
                    {text: "Take the items and go right", nextSection: 3, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 15;
                    addToInventory('Mysterious Key');
                    playSound('itemSound');
                    updateStatsDisplay();
                    return "<span class='loot'>You found 15 Gold and a Mysterious Key!</span>";
                }
            },
            5: {
                text: "The skeleton turns its hollow eye sockets toward you and draws a rusty sword. Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 501, skillCheck: false}
                ]
            },
            501: {
                text: "You face the Skeleton Guardian!",
                choices: [
                    {text: "Attack!", nextSection: 502, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for Skeleton Guardian
                    combatState.active = true;
                    combatState.enemyName = "Skeleton Guardian";
                    combatState.enemyStamina = 7;
                    combatState.enemyCurrentStamina = 7;
                    combatState.enemySkill = 6;
                    combatState.nextSection = 11;
                    combatState.round = 1;
                    
                    playSound('combatSound');
                    return "<span class='enemy'>Skeleton Guardian: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill + "</span>";
                }
            },
            6: {
                text: "You attempt to sneak past the skeleton...",
                choices: [
                    {text: "Continue", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    // Skill check was already performed, result is in checkResult
                    if (window.checkResult) {
                        return "<span class='success'>You successfully sneak past the skeleton without being noticed!</span>";
                    } else {
                        return "<span class='damage'>The skeleton spots you! It attacks with surprise!</span>";
                    }
                }
            },
            7: {
                text: "You attempt to reason with the skeletal guardian...",
                choices: [
                    {text: "Continue", nextSection: 13, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.gold += 10;
                        updateStatsDisplay();
                        return "<span class='success'>The skeleton nods and steps aside, pointing to a small pile of gold. You gain 10 Gold!</span>";
                    } else {
                        return "<span class='damage'>The skeleton ignores your pleas and attacks!</span>";
                    }
                }
            },
            8: {
                text: "You read the glowing book. The text is in an ancient language, but as you read, you feel knowledge flowing into your mind.",
                choices: [
                    {text: "Continue reading", nextSection: 14, skillCheck: false},
                    {text: "Close the book quickly", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    const effect = Math.random() > 0.5;
                    if (effect) {
                        gameState.skill += 1;
                        updateStatsDisplay();
                        return "<span class='success'>You gain +1 Skill from the ancient knowledge!</span>";
                    } else {
                        gameState.stamina -= 2;
                        updateStatsDisplay();
                        return "<span class='damage'>The text drains your life force! You lose 2 Stamina.</span>";
                    }
                }
            },
            9: {
                text: "You search the library...",
                choices: [
                    {text: "Continue", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        addToInventory('Scroll of Protection');
                        playSound('itemSound');
                        return "<span class='loot'>You find a Scroll of Protection hidden behind a bookshelf!</span>";
                    } else {
                        return "Your search reveals nothing but dust and cobwebs.";
                    }
                }
            },
            10: {
                text: "You leave the library and continue down the corridor. You come to a heavy oak door with a keyhole. Do you have the right key?",
                choices: [
                    {text: "Try the Mysterious Key", nextSection: 16, skillCheck: false, requirement: 'Mysterious Key'},
                    {text: "Try to break down the door", nextSection: 17, skillCheck: false},
                    {text: "Look for another way", nextSection: 18, skillCheck: true, checkType: 'skill', difficulty: 13}
                ]
            },
            11: {
                text: "", // Will be filled by combat results
                choices: [
                    {text: "Continue", nextSection: 19, skillCheck: false}
                ]
            },
            12: {
                text: "You successfully sneak past the skeleton and find a small alcove with a locked chest.",
                choices: [
                    {text: "Try to open the chest", nextSection: 20, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Leave the chest and continue", nextSection: 10, skillCheck: false}
                ]
            },
            13: {
                text: "The skeleton lets you pass. Beyond its post, you find an armory with various weapons.",
                choices: [
                    {text: "Take a better weapon", nextSection: 21, skillCheck: false},
                    {text: "Leave the weapons and continue", nextSection: 10, skillCheck: false}
                ]
            },
            14: {
                text: "As you finish reading, the book bursts into flames! You jump back just in time.",
                choices: [
                    {text: "Continue down the corridor", nextSection: 10, skillCheck: false}
                ]
            },
            15: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Leave the library", nextSection: 10, skillCheck: false}
                ]
            },
            16: {
                text: "The Mysterious Key fits perfectly! The door unlocks with a satisfying click.",
                choices: [
                    {text: "Enter the next chamber", nextSection: 100, skillCheck: false}
                ],
                action: function() {
                    // Remove key from inventory
                    const keyIndex = gameState.inventory.indexOf('Mysterious Key');
                    if (keyIndex !== -1) {
                        gameState.inventory.splice(keyIndex, 1);
                        updateInventoryDisplay();
                    }
                    return "<span class='success'>The Mysterious Key works! The door swings open.</span>";
                }
            },
            17: {
                text: "You try to break down the door...",
                choices: [
                    {text: "Continue", nextSection: 22, skillCheck: false}
                ],
                action: function() {
                    const damage = rollDiceHelper(1, 4);
                    gameState.stamina -= damage;
                    updateStatsDisplay();
                    
                    if (gameState.stamina <= 0) {
                        return "<span class='damage'>The door doesn't budge, and you exhaust yourself. You collapse!</span>";
                    } else {
                        return `<span class='damage'>The door is too strong. You take ${damage} damage from the effort.</span>`;
                    }
                }
            },
            18: {
                text: "You search for another way around...",
                choices: [
                    {text: "Continue", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "<span class='success'>You find a hidden passage that bypasses the door!</span>";
                    } else {
                        return "You can't find any alternative path. You'll have to deal with the door.";
                    }
                }
            },
            19: {
                text: "After defeating the skeleton, you search its post and find 20 Gold and a Healing Potion.",
                choices: [
                    {text: "Take the items and continue", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 20;
                    // Add healing potion
                    const potion = gameState.consumables.find(c => c.id === 'pot_heal');
                    if (potion) {
                        potion.count += 1;
                    } else {
                        gameState.consumables.push({id: 'pot_heal', name: 'Healing Potion', type: 'heal', value: 4, count: 1});
                    }
                    playSound('itemSound');
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    return "<span class='loot'>You find 20 Gold and a Healing Potion on the skeleton!</span>";
                }
            },
            20: {
                text: "You attempt to open the chest...",
                choices: [
                    {text: "Continue", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.weapons.push({id: 'shortsword', name: 'Short Sword', damage: '2d4', equipped: false});
                        updateInventoryDisplay();
                        playSound('itemSound');
                        return "<span class='loot'>You pick the lock! Inside you find a Short Sword (2d4 damage)!</span>";
                    } else {
                        return "The lock is too complex. You'll need a key or more skill.";
                    }
                }
            },
            21: {
                text: "You examine the weapons in the armory. Most are rusted beyond use, but one short sword looks serviceable.",
                choices: [
                    {text: "Take the Short Sword", nextSection: 25, skillCheck: false},
                    {text: "Leave it and continue", nextSection: 10, skillCheck: false}
                ]
            },
            22: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Try something else", nextSection: 10, skillCheck: false}
                ]
            },
            23: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Try the hidden passage", nextSection: 100, skillCheck: false}
                ]
            },
            24: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue", nextSection: 10, skillCheck: false}
                ]
            },
            25: {
                text: "You take the Short Sword. It's better balanced than your dagger.",
                choices: [
                    {text: "Equip it and continue", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    gameState.weapons.push({id: 'shortsword', name: 'Short Sword', damage: '2d4', equipped: true});
                    // Unequip dagger
                    const dagger = gameState.weapons.find(w => w.id === 'dagger');
                    if (dagger) dagger.equipped = false;
                    
                    updateInventoryDisplay();
                    return "<span class='loot'>You equip the Short Sword (2d4 damage)!</span>";
                }
            },
            // Combat sections
            502: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 503, skillCheck: false}
                ]
            },
            503: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 502, skillCheck: false}
                ]
            },
            100: {
                text: "Congratulations! You have survived Level 1 of the Chambers of Fear. The door leads to a descending staircase, taking you deeper into the dungeon.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    playSound('levelUpSound');
                    showScreen('screen-next');
                    document.getElementById('next-stat-skill').textContent = gameState.skill;
                    document.getElementById('next-stat-stamina').textContent = gameState.stamina;
                    document.getElementById('next-stat-luck').textContent = gameState.luck;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    return "<span class='success'>You have completed Level 1! Your progress has been saved.</span>";
                }
            }
        };
        
        // Initialize game
        function initGame() {
            // Check for saved game
            const savedGame = localStorage.getItem(gameState.gameName);
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                Object.assign(gameState, savedState);
                
                // If coming from previous level, update level indicator
                if (gameState.level > 1) {
                    updateLevelIndicator();
                }
                
                updateStatsDisplay();
                updateInventoryDisplay();
                showScreen('screen-game');
                loadSection(gameState.currentSection);
            } else {
                showScreen('screen-creation');
            }
            
            // Update level indicator
            document.getElementById('stat-level').textContent = gameState.level;
        }
        
        // Update level indicator dots
        function updateLevelIndicator() {
            const dots = document.querySelectorAll('.level-dot');
            dots.forEach((dot, index) => {
                if (index < gameState.level - 1) {
                    dot.classList.add('completed');
                    dot.classList.remove('active');
                } else if (index === gameState.level - 1) {
                    dot.classList.add('active');
                    dot.classList.remove('completed');
                } else {
                    dot.classList.remove('active', 'completed');
                }
            });
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Select character class
        function selectClass(className) {
            gameState.playerClass = className;
            document.getElementById('selected-class').textContent = className.toUpperCase();
            document.getElementById('dice-roll-section').style.display = 'block';
            playSound('clickSound');
        }
        
        // Roll dice for character stats
        function rollCharacterStats() {
            playSound('diceSound');
            
            const skillRoll = rollDiceHelper(2, 6);
            const staminaRoll = rollDiceHelper(2, 6);
            const luckRoll = rollDiceHelper(2, 6);
            
            // Apply class bonuses
            let skillBonus = 0, staminaBonus = 0, luckBonus = 0;
            
            switch(gameState.playerClass) {
                case 'warrior':
                    skillBonus = 3;
                    staminaBonus = 6;
                    luckBonus = 0;
                    break;
                case 'rogue':
                    skillBonus = 4;
                    staminaBonus = 4;
                    luckBonus = 2;
                    break;
                case 'mage':
                    skillBonus = 2;
                    staminaBonus = 3;
                    luckBonus = 4;
                    break;
                case 'ranger':
                    skillBonus = 3;
                    staminaBonus = 5;
                    luckBonus = 1;
                    break;
            }
            
            gameState.skill = skillRoll + skillBonus;
            gameState.maxStamina = staminaRoll + staminaBonus;
            gameState.stamina = gameState.maxStamina;
            gameState.luck = luckRoll + luckBonus;
            gameState.gold = 10; // Starting gold
            
            document.getElementById('dice-results').innerHTML = `
                <div class="dice-roll">Skill Roll: ${skillRoll} + ${skillBonus} = <span class="stat-value">${gameState.skill}</span></div>
                <div class="dice-roll">Stamina Roll: ${staminaRoll} + ${staminaBonus} = <span class="stat-value">${gameState.maxStamina}</span></div>
                <div class="dice-roll">Luck Roll: ${luckRoll} + ${luckBonus} = <span class="stat-value">${gameState.luck}</span></div>
            `;
            
            document.getElementById('confirm-btn').disabled = false;
        }
        
        // Confirm stats and start game
        function confirmStats() {
            playSound('clickSound');
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
            saveGame(); // Save initial state
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-skill').textContent = gameState.skill;
            document.getElementById('stat-stamina').textContent = gameState.stamina;
            document.getElementById('stat-maxstamina').textContent = gameState.maxStamina;
            document.getElementById('stat-luck').textContent = gameState.luck;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Show equipped weapon
            const equippedWeapon = gameState.weapons.find(w => w.equipped);
            if (equippedWeapon) {
                const weaponSpan = createInventoryItem(equippedWeapon.name, 'weapon');
                inventoryDiv.appendChild(weaponSpan);
            }
            
            // Show equipped armor
            const equippedArmor = gameState.armor.find(a => a.equipped);
            if (equippedArmor) {
                const armorSpan = createInventoryItem(equippedArmor.name, 'armor');
                inventoryDiv.appendChild(armorSpan);
            }
            
            // Show consumables
            gameState.consumables.forEach(consumable => {
                if (consumable.count > 0) {
                    const consumableSpan = createInventoryItem(consumable.name, 'consumable', consumable.count);
                    inventoryDiv.appendChild(consumableSpan);
                }
            });
            
            // Show other inventory items
            gameState.inventory.forEach(item => {
                const itemSpan = createInventoryItem(item, 'item');
                inventoryDiv.appendChild(itemSpan);
            });
            
            // Show gold
            const goldSpan = createInventoryItem(`${gameState.gold} Gold`, 'gold');
            inventoryDiv.appendChild(goldSpan);
        }
        
        // Create an inventory item element
        function createInventoryItem(name, type, count = null) {
            const span = document.createElement('span');
            span.className = 'inventory-item';
            span.textContent = name;
            
            // Add icon or styling based on type
            if (type === 'weapon') {
                span.style.borderColor = 'var(--warning-color)';
            } else if (type === 'armor') {
                span.style.borderColor = 'var(--accent-color)';
            } else if (type === 'consumable') {
                span.style.borderColor = 'var(--primary-color)';
            } else if (type === 'gold') {
                span.style.borderColor = 'var(--warning-color)';
                span.style.backgroundColor = 'rgba(255, 215, 0, 0.1)';
            }
            
            // Add count badge for consumables
            if (count && count > 1) {
                const countBadge = document.createElement('span');
                countBadge.className = 'item-count';
                countBadge.textContent = count;
                span.appendChild(countBadge);
            }
            
            return span;
        }
        
        // Add item to inventory
        function addToInventory(itemName) {
            if (!gameState.inventory.includes(itemName)) {
                gameState.inventory.push(itemName);
            }
        }
        
        // Load story section
        function loadSection(sectionId) {
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 502 || sectionId === 503);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended, show victory
                    const goldReward = Math.floor(Math.random() * 15) + 5;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br><span class="loot">You find ${goldReward} Gold on the remains.</span>`;
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2500);
                    return;
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                section.choices.forEach(choice => {
                    // Check if player has requirement for this choice
                    let canShow = true;
                    if (choice.requirement) {
                        canShow = gameState.inventory.includes(choice.requirement);
                    }
                    
                    if (canShow) {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            playSound('clickSound');
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    }
                });
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            playSound('combatSound');
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDiceHelper(2, 6);
            const enemyRoll = rollDiceHelper(2, 6);
            
            // Add skill to dice rolls
            const playerTotal = playerRoll + gameState.skill;
            const enemyTotal = enemyRoll + combatState.enemySkill;
            
            let resultText = `<div class="combat-log">`;
            resultText += `<span class="enemy">ROUND ${combatState.round} vs ${combatState.enemyName}</span><br>`;
            resultText += `Your Stamina: ${gameState.stamina}, Enemy Stamina: ${combatState.enemyCurrentStamina}<br>`;
            resultText += `You roll ${playerRoll} + Skill ${gameState.skill} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Skill ${combatState.enemySkill} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                const equippedWeapon = gameState.weapons.find(w => w.equipped);
                let damage = 0;
                
                if (equippedWeapon) {
                    if (equippedWeapon.damage === '1d6') damage = rollDiceHelper(1, 6);
                    else if (equippedWeapon.damage === '2d4') damage = rollDiceHelper(2, 4);
                    else damage = rollDiceHelper(1, 6); // Default
                } else {
                    damage = rollDiceHelper(1, 6);
                }
                
                combatState.enemyCurrentStamina -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                
                if (combatState.enemyCurrentStamina <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                const enemyDamage = rollDiceHelper(1, 6);
                gameState.stamina -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                
                // Check if player died
                if (gameState.stamina <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated by the ${combatState.enemyName}! Game Over.</span>`;
                    resultText += `</div>`;
                    setTimeout(() => {
                        localStorage.removeItem(gameState.gameName);
                        location.reload();
                    }, 4000);
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('diceSound');
            const diceRoll = rollDiceHelper(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `<div class="dice-roll">You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span></div>`;
            
            document.getElementById('story-text').innerHTML += resultText;
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Luck
        function useLuck() {
            playSound('clickSound');
            if (gameState.luck <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Luck left!</div>`;
                return;
            }
            
            const diceRoll = rollDiceHelper(2, 6);
            const success = diceRoll <= gameState.luck;
            
            gameState.luck -= 1;
            updateStatsDisplay();
            
            let resultText = `You test your Luck... Roll: ${diceRoll}, Luck: ${gameState.luck + 1}. `;
            resultText += success ? 
                `<span class="success">Lucky!</span> Something good happens.` : 
                `<span class="damage">Unlucky!</span> Something bad happens.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            // Apply Luck effect
            if (success) {
                // Good effect
                const goodEffects = [
                    {text: "You find 5 Gold on the ground!", effect: () => gameState.gold += 5},
                    {text: "You feel a surge of energy! Restore 3 Stamina.", effect: () => gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 3)},
                    {text: "You notice a hidden weakness in your enemy!", effect: () => {}}
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect.text}</div>`;
                effect.effect();
            } else {
                // Bad effect
                const badEffects = [
                    {text: "You trip and take 2 damage!", effect: () => gameState.stamina -= 2},
                    {text: "You drop 3 Gold!", effect: () => gameState.gold = Math.max(0, gameState.gold - 3)},
                    {text: "Your weapon slips! Lose 1 Skill until next rest.", effect: () => gameState.skill = Math.max(1, gameState.skill - 1)}
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect.text}</div>`;
                effect.effect();
            }
            
            updateStatsDisplay();
            updateInventoryDisplay();
        }
        
        // Check inventory
        function checkInventory() {
            playSound('clickSound');
            let inventoryText = "<h3>INVENTORY DETAILS:</h3>";
            
            // Show current equipped weapon
            const equippedWeapon = gameState.weapons.find(w => w.equipped);
            if (equippedWeapon) {
                inventoryText += `<p><strong>Equipped Weapon:</strong> ${equippedWeapon.name} (${equippedWeapon.damage} damage)</p>`;
            }
            
            // Show all available weapons
            if (gameState.weapons.length > 1) {
                inventoryText += "<p><strong>Available Weapons:</strong><br>";
                gameState.weapons.forEach((weapon, index) => {
                    if (!weapon.equipped) {
                        inventoryText += `${weapon.name} (${weapon.damage})`;
                        inventoryText += ` <button onclick="equipWeapon('${weapon.id}')" style="font-size:12px; padding:3px 8px; margin-left:10px;">Equip</button>`;
                        inventoryText += "<br>";
                    }
                });
                inventoryText += "</p>";
            }
            
            // Show armor
            const equippedArmor = gameState.armor.find(a => a.equipped);
            if (equippedArmor) {
                inventoryText += `<p><strong>Armor:</strong> ${equippedArmor.name} (${equippedArmor.defense} DEF)</p>`;
            }
            
            // Show consumables with use buttons
            inventoryText += `<p><strong>Usable Items:</strong><br>`;
            let hasConsumables = false;
            gameState.consumables.forEach(consumable => {
                if (consumable.count > 0) {
                    hasConsumables = true;
                    inventoryText += `${consumable.name} (x${consumable.count}) `;
                    
                    // Add use button
                    inventoryText += `<button onclick="useConsumable('${consumable.id}')" style="font-size:12px; padding:3px 8px;">Use</button><br>`;
                }
            });
            
            if (!hasConsumables) {
                inventoryText += "None<br>";
            }
            inventoryText += `</p>`;
            
            // Show other items
            if (gameState.inventory.length > 0) {
                inventoryText += `<p><strong>Other Items:</strong><br>`;
                gameState.inventory.forEach(item => {
                    inventoryText += `${item}<br>`;
                });
                inventoryText += `</p>`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${inventoryText}</div>`;
        }
        
        // Use item function
        function useItem() {
            playSound('clickSound');
            // Check if we have any consumables
            const hasConsumables = gameState.consumables.some(c => c.count > 0);
            
            if (!hasConsumables) {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory!</div>`;
                return;
            }
            
            let itemText = "<h3>SELECT ITEM TO USE:</h3>";
            
            gameState.consumables.forEach(consumable => {
                if (consumable.count > 0) {
                    itemText += `<p>${consumable.name} (x${consumable.count}) `;
                    
                    // Add use button with appropriate effect
                    if (consumable.type === 'heal') {
                        itemText += `<button onclick="useConsumable('${consumable.id}')" style="font-size:14px; padding:4px 10px; margin-left:10px;">Drink (Heal ${consumable.value})</button>`;
                    } else if (consumable.type === 'luck') {
                        itemText += `<button onclick="useConsumable('${consumable.id}')" style="font-size:14px; padding:4px 10px; margin-left:10px;">Drink (+${consumable.value} Luck)</button>`;
                    }
                    
                    itemText += `</p>`;
                }
            });
            
            itemText += `<p><button onclick="cancelItemUse()" style="font-size:14px; padding:4px 10px; margin-top:10px;">Cancel</button></p>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${itemText}</div>`;
        }
        
        // Use consumable item
        function useConsumable(id) {
            playSound('itemSound');
            const consumable = gameState.consumables.find(c => c.id === id);
            if (!consumable || consumable.count <= 0) return;
            
            consumable.count -= 1;
            
            let effectText = "";
            if (consumable.type === 'heal') {
                const oldStamina = gameState.stamina;
                gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + consumable.value);
                const actualHeal = gameState.stamina - oldStamina;
                effectText = `You drink the ${consumable.name} and restore ${actualHeal} Stamina!`;
            } else if (consumable.type === 'luck') {
                gameState.luck += consumable.value;
                effectText = `You drink the ${consumable.name} and gain ${consumable.value} Luck!`;
            }
            
            updateInventoryDisplay();
            updateStatsDisplay();
            
            document.getElementById('story-text').innerHTML += 
                `<div class="dice-roll"><span class="success">${effectText}</span></div>`;
        }
        
        // Cancel item use
        function cancelItemUse() {
            playSound('clickSound');
            document.getElementById('story-text').innerHTML += 
                `<div class="dice-roll">You decide not to use an item.</div>`;
        }
        
        // Equip weapon function
        function equipWeapon(id) {
            playSound('clickSound');
            // Unequip current weapon
            gameState.weapons.forEach(weapon => {
                weapon.equipped = (weapon.id === id);
            });
            
            const weapon = gameState.weapons.find(w => w.id === id);
            if (weapon) {
                updateInventoryDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped ${weapon.name}!</div>`;
                saveGame();
            }
        }
        
        // Save game
        function saveGame() {
            localStorage.setItem(gameState.gameName, JSON.stringify(gameState));
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('clickSound');
            // Update level for next page
            gameState.level = 2;
            gameState.currentSection = 1; // Reset to first section of next level
            
            // Save game state for level 2
            saveGame();
            
            // Redirect to level 2
            setTimeout(() => {
                window.location.href = 'level2.html';
            }, 500);
        }
        
        // Utility function to roll dice
        function rollDiceHelper(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Sound functions
        function playSound(soundId) {
            if (!soundEnabled) return;
            
            const sound = document.getElementById(soundId);
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("Audio play failed:", e));
            }
        }
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const toggleBtn = document.querySelector('.sound-toggle');
            toggleBtn.textContent = `SOUND: ${soundEnabled ? 'ON' : 'OFF'}`;
        }
        
        // Initialize on load
        window.onload = initGame;
    </script>
</body>
</html>
