<DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dungeon Hunter RPG</title>
    <style>
        :root {
            --bg-color: black;
            --panel-color: black;
            --highlight-color: #2a2a4a;
            --text-color: #e0e0ff;
            --text-dim: #a0a0c0;
            --hp-color: #e05050;
            --mp-color: #5080e0;
            --xp-color: #50e050;
            --gold-color: #e0e050;
            --buff-color: #a0e0a0;
            --debuff-color: #e0a0a0;
            --damage-color: #ff6060;
            --heal-color: #60ff60;
            --enemy-color: #ff8080;
            --rare-color: #e0a050;
            --legendary-color: #e050e0;
            --fire-color: #ff6a00;
            --ice-color: #00ccff;
            --poison-color: #aa00ff;
            --lightning-color: #ffee00;
            --enemy-hp-color: #ff4040;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: black;
            color: var(--text-color);
            height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            touch-action: none;
        }
        
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 8px;
            gap: 8px;
            height: 100%;
        }
        
        .panel {
            background-color: black;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            border: 1px solid white;
        }
        
        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            flex-shrink: 0;
            height: 70px; /* Taller header */
    min-height: 70px;
        }
        
        .stat {
            display: flex;
            align-items: center;
            font-size: 18px;
        }
        
        .stat-bar {
            width: 60px;
            height: 6px;
            background-color: white;
            border-radius: 3px;
            overflow: hidden;
            margin-left: 5px;
            position: relative;
        }
        
        .stat-fill {
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
        }
        
        .hp-fill {
            background-color: var(--hp-color);
            width: 100%;
        }
        
        .mp-fill {
            background-color: var(--mp-color);
            width: 100%;
        }
        
        .xp-fill {
            background-color: red;
            width: 0%;
        }
        
        #level-display {
            background-color: var(--highlight-color);
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 18px;
        }
        
        #gold-display {
            color: var(--gold-color);
            font-weight: bold;
        }
        
        #main-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        #message-log {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            max-height: 30vh;
        }
        
        .message {
            margin-bottom: 8px;
            animation: fadeIn 0.3s;
            word-wrap: break-word;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #combat-display {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 8px;
        }
        
        .enemy-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .enemy-name {
            font-weight: bold;
            color: var(--enemy-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .enemy-hp-bar {
            width: 100%;
            height: 8px;
            background-color: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .enemy-hp-fill {
            height: 100%;
            background-color: var(--enemy-hp-color);
            width: 100%;
            transition: width 0.3s;
        }
        
        .enemy-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-dim);
        }
        
        #floor-display {
            text-align: center;
            font-weight: bold;
            margin-top: 5px;
            color: var(--text-dim);
            font-size: 14px;
            flex-shrink: 0;
        }
        
        #controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            background-color: black;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            border: 1px solid white;
        }
        
        .btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .btn-primary {
            background-color: black;
        }
        
        .btn-danger {
            background-color: #6a3a3a;
        }
        
        .btn-success {
            background-color: black;
        }
        
        .btn-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        #skills {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            flex-shrink: 0;
        }
        
        .skill-btn {
            position: relative;
            overflow: hidden;
            padding: 10px 5px;
            font-size: 14px;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .skill-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .skill-cost {
            font-size: 12px;
            color: var(--text-dim);
        }
        
        .skill-cooldown {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        .enemy {
            color: var(--enemy-color);
            font-weight: bold;
        }
        
        .damage {
            color: var(--damage-color);
        }
        
        .heal {
            color: var(--heal-color);
        }
        
        .buff {
            color: var(--buff-color);
        }
        
        .debuff {
            color: var(--debuff-color);
        }
        
        .rare {
            color: var(--rare-color);
        }
        
        .legendary {
            color: var(--legendary-color);
        }
        
        .fire {
            color: var(--fire-color);
        }
        
        .ice {
            color: var(--ice-color);
        }
        
        .poison {
            color: var(--poison-color);
        }
        
        .lightning {
            color: var(--lightning-color);
        }
        
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }
        
        .modal {
            background-color: var(--panel-color);
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 2px solid white;
        }
        
        .modal-header {
            padding: 15px;
            background-color: black;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .modal-footer {
            padding: 10px;
            display: flex;
            justify-content: flex-end;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
        }
        
        .item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            border-left: 3px solid var(--highlight-color);
        }
        
        .item-rare {
            border-left-color: var(--rare-color);
        }
        
        .item-legendary {
            border-left-color: var(--legendary-color);
        }
        
        .item-fire {
            border-left-color: var(--fire-color);
        }
        
        .item-ice {
            border-left-color: var(--ice-color);
        }
        
        .item-poison {
            border-left-color: var(--poison-color);
        }
        
        .item-lightning {
            border-left-color: var(--lightning-color);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .item-name {
            font-weight: bold;
        }
        
        .item-rarity {
            font-size: 12px;
            color: var(--text-dim);
        }
        
        .item-desc {
            font-size: 13px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }
        
        .item-actions {
            display: flex;
            gap: 5px;
        }
        
        .item-btn {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 3px;
            background-color: var(--highlight-color);
            }
        
        #character-screen {
            display: none;
        }
        
        .character-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
            }
        
        .stat-card {
            background-color: black;
            padding: 10px;
            border-radius: 5px;
            border: 2px solid white;
        }
        
        .stat-label {
            font-size: 12px;
            color: black;
            margin-bottom: 3px;
        }
        
        .stat-value {
            font-weight: bold;
            font-size: 16px;
        }
        
        #equipment-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            }
        
        .equipment-slot {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 2px solid white;
        }
        
        .slot-label {
            font-size: 12px;
            color: var(--text-dim);
        }
        
        .slot-item {
            font-size: 14px;
            font-weight: bold;
        }
        
        .empty-slot {
            font-size: 12px;
            color: var(--text-dim);
            font-style: italic;
        }
        
        #status-effects {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .status-effect {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .positive-effect {
            background-color: rgba(100, 255, 100, 0.1);
            color: var(--buff-color);
        }
        
        .negative-effect {
            background-color: rgba(255, 100, 100, 0.1);
            color: var(--debuff-color);
        }
        
        .fire-effect {
            background-color: rgba(255, 100, 50, 0.1);
            color: var(--fire-color);
        }
        
        .ice-effect {
            background-color: rgba(100, 200, 255, 0.1);
            color: var(--ice-color);
        }
        
        .poison-effect {
            background-color: rgba(170, 0, 255, 0.1);
            color: var(--poison-color);
        }
        
        .lightning-effect {
            background-color: rgba(255, 255, 100, 0.1);
            color: var(--lightning-color);
        }
        
        #combat-log {
            display: none;
        }
        
        .log-entry {
            margin-bottom: 5px;
            font-size: 13px;
        }
        
        #tab-bar {
            display: flex;
            border-bottom: 1px solid black;
            margin-bottom: 10px;
        }
        
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom: 2px black;
            font-weight: bold;
        }
        
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        #loading-bar {
            width: 80%;
            max-width: 300px;
            height: 10px;
            background-color: white;
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        #loading-progress {
            height: 100%;
            width: 0%;
            background-color: red;
            transition: width 0.3s;
        }
        
        #game-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: red;
            text-shadow: 0 0 10px rgba(80, 128, 224, 0.5);
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--highlight-color);
            border-radius: 5px;
        }
        
        #death-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }
        
        .death-modal {
            background-color: var(--panel-color);
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            padding: 20px;
            text-align: center;
        }
        
        .death-title {
            color: var(--damage-color);
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .death-message {
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        .death-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div id="game-title">DUNGEON HUNTER</div>
        <div class="pulse">Loading...</div>
        <div id="loading-bar">
            <div id="loading-progress"></div>
        </div>
    </div>
    
    <div id="game-container" style="display: none;">
        <div class="panel" id="header">
            <div class="stat">
                <span>HP</span>
                <div class="stat-bar">
                    <div class="stat-fill hp-fill"></div>
                </div>
            </div>
            <div class="stat">
                <span>MP</span>
                <div class="stat-bar">
                    <div class="stat-fill mp-fill"></div>
                </div>
            </div>
            <div id="level-display">Lv.1</div>
            <div class="stat">
                <span>XP</span>
                <div class="stat-bar">
                    <div class="stat-fill xp-fill"></div>
                </div>
            </div>
            <div id="gold-display">0G</div>
        </div>
        
        <div class="panel" id="main-display">
            <div id="combat-display">
                <!-- Enemy info will be inserted here -->
            </div>
            <div id="message-log">
                <div class="message">Welcome to the dungeon...</div>
            </div>
            <div id="floor-display">Floor 1</div>
        </div>
        
        <div id="controls">
            <button id="explore-btn" class="btn btn-primary">Explore</button>
            <button id="rest-btn" class="btn btn-success">Rest</button>
        </div>
        
        <div id="skills">
            <button class="skill-btn btn" id="skill1">
                <div class="skill-name">Attack</div>
                <div class="skill-cost">No cost</div>
            </button>
            <button class="skill-btn btn" id="skill2">
                <div class="skill-name">Fireball</div>
                <div class="skill-cost">10 MP</div>
            </button>
            <button class="skill-btn btn" id="skill3">
                <div class="skill-name">Heal</div>
                <div class="skill-cost">15 MP</div>
            </button>
            <button class="skill-btn btn" id="skill4">
                <div class="skill-name">Poison</div>
                <div class="skill-cost">5 MP</div>
            </button>
            <button class="skill-btn btn" id="skill5">
                <div class="skill-name">Shield</div>
                <div class="skill-cost">10 MP</div>
            </button>
            <button class="btn" id="character-btn">Character</button>
        </div>
    </div>
    
    <!-- Character Screen Modal -->
    <div id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span id="modal-title">Character</span>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="tab-bar">
                    <div class="tab active" data-tab="character">Character</div>
                    <div class="tab" data-tab="inventory">Inventory</div>
                    <div class="tab" data-tab="combat-log">Combat Log</div>
                </div>
                
                <div id="character-screen">
                    <div class="character-stats">
                        <div class="stat-card">
                            <div class="stat-label">Attack</div>
                            <div class="stat-value" id="stat-attack">10</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Defense</div>
                            <div class="stat-value" id="stat-defense">5</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Critical</div>
                            <div class="stat-value" id="stat-critical">5%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Dodge</div>
                            <div class="stat-value" id="stat-dodge">5%</div>
                        </div>
                    </div>
                    
                    <h3>Equipment</h3>
                    <div id="equipment-slots">
                        <div class="equipment-slot">
                            <div class="slot-label">Weapon</div>
                            <div class="slot-item" id="weapon-slot">
                                <div class="empty-slot">Empty</div>
                            </div>
                        </div>
                        <div class="equipment-slot">
                            <div class="slot-label">Armor</div>
                            <div class="slot-item" id="armor-slot">
                                <div class="empty-slot">Empty</div>
                            </div>
                        </div>
                        <div class="equipment-slot">
                            <div class="slot-label">Accessory</div>
                            <div class="slot-item" id="accessory-slot">
                                <div class="empty-slot">Empty</div>
                            </div>
                        </div>
                    </div>
                    
                    <h3>Status Effects</h3>
                    <div id="status-effects">
                        <!-- Status effects will appear here -->
                    </div>
                </div>
                
                <div id="inventory-screen" style="display: none;">
                    <div id="inventory-items">
                        <!-- Items will appear here -->
                    </div>
                </div>
                
                <div id="combat-log" style="display: none;">
                    <div id="log-entries">
                        <!-- Combat log entries will appear here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="close-modal">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Death Screen -->
    <div id="death-screen">
        <div class="death-modal">
            <div class="death-title">You Have Died</div>
            <div class="death-message" id="death-message">You were defeated on floor 1.</div>
            <div class="death-buttons">
                <button class="btn btn-primary" id="new-game-btn">New Game</button>
                <button class="btn btn-danger" id="quit-btn">Quit</button>
            </div>
        </div>
    </div>
    
    <script>
        // Game initialization
        function initGame() {
            // Game state
            const gameState = {
                player: {
                    name: "Adventurer",
                    maxHp: 100,
                    hp: 100,
                    maxMp: 50,
                    mp: 50,
                    level: 1,
                    xp: 0,
                    xpToNext: 100,
                    gold: 0,
                    baseAttack: 10,
                    attack: 10,
                    baseDefense: 5,
                    defense: 5,
                    criticalChance: 5,
                    dodgeChance: 5,
                    skills: {
                        attack: { name: "Attack", cooldown: 0, maxCooldown: 0 },
                        fireball: { name: "Fireball", cost: 10, baseDamage: 25, cooldown: 0, maxCooldown: 2 },
                        heal: { name: "Heal", cost: 15, baseAmount: 30, cooldown: 0, maxCooldown: 3 },
                        poison: { name: "Poison", cost: 5, baseDamage: 5, duration: 3, cooldown: 0, maxCooldown: 4 },
                        shield: { name: "Shield", cost: 10, baseDefense: 10, duration: 2, cooldown: 0, maxCooldown: 4 }
                    },
                    buffs: [],
                    inventory: [],
                    equipment: {
                        weapon: null,
                        armor: null,
                        accessory: null
                    },
                    elementalDamage: {
                        fire: 0,
                        ice: 0,
                        poison: 0,
                        lightning: 0
                    }
                },
                currentFloor: 1,
                inCombat: false,
                currentEnemy: null,
                enemyTypes: [
                    { name: "Goblin", hp: 30, attack: 8, defense: 2, xp: 20, gold: 10, resistances: [], weaknesses: [] },
                    { name: "Skeleton", hp: 40, attack: 10, defense: 3, xp: 30, gold: 15, resistances: ['poison'], weaknesses: ['fire'] },
                    { name: "Orc", hp: 60, attack: 12, defense: 5, xp: 40, gold: 20, resistances: [], weaknesses: [] },
                    { name: "Ghost", hp: 50, attack: 15, defense: 1, xp: 35, gold: 25, resistances: ['physical'], weaknesses: ['lightning'] },
                    { name: "Troll", hp: 80, attack: 18, defense: 8, xp: 60, gold: 40, resistances: [], weaknesses: ['fire'] },
                    { name: "Dark Knight", hp: 100, attack: 20, defense: 10, xp: 80, gold: 60, resistances: ['fire', 'ice'], weaknesses: ['lightning'] },
                    { name: "Dragon", hp: 150, attack: 25, defense: 15, xp: 120, gold: 100, resistances: ['fire'], weaknesses: ['ice'] },
                    { name: "Lich", hp: 90, attack: 22, defense: 5, xp: 100, gold: 80, resistances: ['poison', 'ice'], weaknesses: ['fire', 'lightning'] },
                    { name: "Minotaur", hp: 110, attack: 24, defense: 12, xp: 90, gold: 70, resistances: [], weaknesses: [] },
                    { name: "Vampire", hp: 95, attack: 20, defense: 8, xp: 85, gold: 65, resistances: ['poison'], weaknesses: ['fire', 'lightning'] },
                    { name: "Demon", hp: 120, attack: 26, defense: 10, xp: 110, gold: 90, resistances: ['fire'], weaknesses: ['ice', 'lightning'] },
                    { name: "Elemental", hp: 70, attack: 18, defense: 6, xp: 70, gold: 50, resistances: ['fire', 'ice', 'lightning'], weaknesses: ['physical'] }
                ],
                items: [
                    // Common items
                    { name: "Health Potion", description: "Restores 30 HP", type: "consumable", effect: "heal", amount: 30, rarity: "common" },
                    { name: "Mana Potion", description: "Restores 20 MP", type: "consumable", effect: "mana", amount: 20, rarity: "common" },
                    
                    // Uncommon items
                    { name: "Iron Sword", description: "+5 Attack", type: "equipment", slot: "weapon", stat: "attack", amount: 5, rarity: "uncommon" },
                    { name: "Steel Shield", description: "+5 Defense", type: "equipment", slot: "armor", stat: "defense", amount: 5, rarity: "uncommon" },
                    { name: "Leather Armor", description: "+3 Defense", type: "equipment", slot: "armor", stat: "defense", amount: 3, rarity: "uncommon" },
                    { name: "Bronze Dagger", description: "+3 Attack", type: "equipment", slot: "weapon", stat: "attack", amount: 3, rarity: "uncommon" },
                    
                    // Rare items
                    { name: "Silver Ring", description: "+3% Critical", type: "equipment", slot: "accessory", stat: "criticalChance", amount: 3, rarity: "rare" },
                    { name: "Dragon Slayer", description: "+10 Attack, +5% vs Dragons", type: "equipment", slot: "weapon", stat: "attack", amount: 10, rarity: "rare", special: "dragon_slayer" },
                    { name: "Elixir of Life", description: "Fully restores HP and MP", type: "consumable", effect: "full_restore", rarity: "rare" },
                    { name: "Scroll of Identification", description: "Reveals hidden properties", type: "consumable", effect: "identify", rarity: "rare" },
                    { name: "Fire Sword", description: "+8 Attack, +2 Fire Damage", type: "equipment", slot: "weapon", stat: "attack", amount: 8, rarity: "rare", element: "fire", elementAmount: 2 },
                    { name: "Frost Blade", description: "+7 Attack, +3 Ice Damage", type: "equipment", slot: "weapon", stat: "attack", amount: 7, rarity: "rare", element: "ice", elementAmount: 3 },
                    { name: "Venomous Dagger", description: "+5 Attack, +4 Poison Damage", type: "equipment", slot: "weapon", stat: "attack", amount: 5, rarity: "rare", element: "poison", elementAmount: 4 },
                    { name: "Storm Hammer", description: "+6 Attack, +5 Lightning Damage", type: "equipment", slot: "weapon", stat: "attack", amount: 6, rarity: "rare", element: "lightning", elementAmount: 5 },
                    { name: "Phoenix Armor", description: "+8 Defense, +10 Fire Resist", type: "equipment", slot: "armor", stat: "defense", amount: 8, rarity: "rare", resistances: ["fire"] },
                    
                    // Legendary items
                    { name: "Phoenix Feather", description: "Revive with 50% HP when defeated", type: "equipment", slot: "accessory", rarity: "legendary", special: "phoenix_feather" },
                    { name: "Excalibur", description: "+15 Attack, +5% Critical", type: "equipment", slot: "weapon", stat: "attack", amount: 15, rarity: "legendary", special: "excalibur" },
                    { name: "Aegis Shield", description: "+12 Defense, +5% Dodge", type: "equipment", slot: "armor", stat: "defense", amount: 12, rarity: "legendary", special: "aegis" },
                    { name: "Amulet of Power", description: "+5 to all stats", type: "equipment", slot: "accessory", rarity: "legendary", special: "power_amulet" },
                    { name: "Inferno Blade", description: "+12 Attack, +5 Fire Damage", type: "equipment", slot: "weapon", stat: "attack", amount: 12, rarity: "legendary", element: "fire", elementAmount: 5 },
                    { name: "Glacial Greatsword", description: "+10 Attack, +7 Ice Damage", type: "equipment", slot: "weapon", stat: "attack", amount: 10, rarity: "legendary", element: "ice", elementAmount: 7 },
                    { name: "Plaguebringer", description: "+8 Attack, +10 Poison Damage", type: "equipment", slot: "weapon", stat: "attack", amount: 8, rarity: "legendary", element: "poison", elementAmount: 10 },
                    { name: "Thunderfury", description: "+14 Attack, +8 Lightning Damage", type: "equipment", slot: "weapon", stat: "attack", amount: 14, rarity: "legendary", element: "lightning", elementAmount: 8 }
                ],
                combatLog: [],
                gameLoaded: true
            };

            // DOM elements
            const elements = {
                hpFill: document.querySelector('.hp-fill'),
                mpFill: document.querySelector('.mp-fill'),
                xpFill: document.querySelector('.xp-fill'),
                levelDisplay: document.getElementById('level-display'),
                goldDisplay: document.getElementById('gold-display'),
                floorDisplay: document.getElementById('floor-display'),
                messageLog: document.getElementById('message-log'),
                combatDisplay: document.getElementById('combat-display'),
                exploreBtn: document.getElementById('explore-btn'),
                restBtn: document.getElementById('rest-btn'),
                characterBtn: document.getElementById('character-btn'),
                skillBtns: {
                    skill1: document.getElementById('skill1'),
                    skill2: document.getElementById('skill2'),
                    skill3: document.getElementById('skill3'),
                    skill4: document.getElementById('skill4'),
                    skill5: document.getElementById('skill5')
                },
                modalOverlay: document.getElementById('modal-overlay'),
                modalTitle: document.getElementById('modal-title'),
                closeModal: document.getElementById('close-modal'),
                tabBar: document.getElementById('tab-bar'),
                tabs: document.querySelectorAll('.tab'),
                characterScreen: document.getElementById('character-screen'),
                inventoryScreen: document.getElementById('inventory-screen'),
                combatLogScreen: document.getElementById('combat-log'),
                inventoryItems: document.getElementById('inventory-items'),
                logEntries: document.getElementById('log-entries'),
                statAttack: document.getElementById('stat-attack'),
                statDefense: document.getElementById('stat-defense'),
                statCritical: document.getElementById('stat-critical'),
                statDodge: document.getElementById('stat-dodge'),
                weaponSlot: document.getElementById('weapon-slot'),
                armorSlot: document.getElementById('armor-slot'),
                accessorySlot: document.getElementById('accessory-slot'),
                statusEffects: document.getElementById('status-effects'),
                deathScreen: document.getElementById('death-screen'),
                deathMessage: document.getElementById('death-message'),
                newGameBtn: document.getElementById('new-game-btn'),
                quitBtn: document.getElementById('quit-btn')
            };

            // Game functions
            function addMessage(text, className = '') {
                const message = document.createElement('div');
                message.className = `message ${className}`;
                message.textContent = text;
                elements.messageLog.appendChild(message);
                message.scrollIntoView({ behavior: 'smooth' });
                
                // Add to combat log
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${className}`;
                logEntry.textContent = text;
                elements.logEntries.appendChild(logEntry);
                gameState.combatLog.push(text);
                
                // Limit log size
                if (gameState.combatLog.length > 100) {
                    gameState.combatLog.shift();
                    if (elements.logEntries.firstChild) {
                        elements.logEntries.removeChild(elements.logEntries.firstChild);
                    }
                }
            }

            function updateEnemyDisplay() {
                if (!gameState.inCombat || !gameState.currentEnemy) {
                    elements.combatDisplay.style.display = 'none';
                    return;
                }
                
                elements.combatDisplay.style.display = 'flex';
                elements.combatDisplay.innerHTML = '';
                
                const enemy = gameState.currentEnemy;
                const hpPercent = (enemy.hp / enemy.maxHp) * 100;
                
                const enemyInfo = document.createElement('div');
                enemyInfo.className = 'enemy-info';
                
                const nameRow = document.createElement('div');
                nameRow.className = 'enemy-name';
                
                const nameText = document.createElement('span');
                nameText.textContent = enemy.isBoss ? `BOSS: ${enemy.name}` : enemy.name;
                if (enemy.isBoss) nameText.classList.add('legendary');
                
                const hpText = document.createElement('span');
                hpText.textContent = `${Math.max(0, enemy.hp)}/${enemy.maxHp} HP`;
                
                nameRow.appendChild(nameText);
                nameRow.appendChild(hpText);
                
                const hpBar = document.createElement('div');
                hpBar.className = 'enemy-hp-bar';
                
                const hpFill = document.createElement('div');
                hpFill.className = 'enemy-hp-fill';
                hpFill.style.width = `${hpPercent}%`;
                
                hpBar.appendChild(hpFill);
                
                const statsRow = document.createElement('div');
                statsRow.className = 'enemy-stats';
                
                const attackText = document.createElement('span');
                attackText.textContent = `ATK: ${enemy.attack}`;
                
                const defenseText = document.createElement('span');
                defenseText.textContent = `DEF: ${enemy.defense}`;
                
                statsRow.appendChild(attackText);
                statsRow.appendChild(defenseText);
                
                enemyInfo.appendChild(nameRow);
                enemyInfo.appendChild(hpBar);
                enemyInfo.appendChild(statsRow);
                
                elements.combatDisplay.appendChild(enemyInfo);
            }

            function updateStats() {
                // Update HP/MP/XP bars
                const hpPercent = (gameState.player.hp / gameState.player.maxHp) * 100;
                const mpPercent = (gameState.player.mp / gameState.player.maxMp) * 100;
                const xpPercent = (gameState.player.xp / gameState.player.xpToNext) * 100;
                
                elements.hpFill.style.width = `${hpPercent}%`;
                elements.mpFill.style.width = `${mpPercent}%`;
                elements.xpFill.style.width = `${xpPercent}%`;
                
                // Update text displays
                elements.levelDisplay.textContent = `Lv.${gameState.player.level}`;
                elements.goldDisplay.textContent = `${gameState.player.gold}G`;
                elements.floorDisplay.textContent = `Floor ${gameState.currentFloor}`;
                
                // Update character screen stats
                elements.statAttack.textContent = gameState.player.attack;
                elements.statDefense.textContent = gameState.player.defense;
                elements.statCritical.textContent = `${gameState.player.criticalChance}%`;
                elements.statDodge.textContent = `${gameState.player.dodgeChance}%`;
                
                // Update enemy display if in combat
                if (gameState.inCombat) {
                    updateEnemyDisplay();
                }
            }

            function generateEnemy() {
                const floorMod = Math.floor((gameState.currentFloor - 1) / 5);
                const enemyPool = gameState.enemyTypes.filter((_, index) => index <= Math.min(gameState.currentFloor + 2, gameState.enemyTypes.length - 1));
                
                // 5% chance for boss (higher floor enemies)
                const isBoss = Math.random() < 0.05;
                let enemyIndex;
                
                if (isBoss) {
                    enemyIndex = Math.min(
                        Math.floor(Math.random() * (gameState.currentFloor + 3)), 
                        gameState.enemyTypes.length - 1
                    );
                    if (enemyIndex < 0) enemyIndex = 0;
                } else {
                    enemyIndex = Math.floor(Math.random() * enemyPool.length);
                }
                
                const enemyType = gameState.enemyTypes[enemyIndex];
                
                // Scale enemy stats with floor
                const scaleFactor = 1 + (floorMod * 0.3) + ((gameState.currentFloor % 5) * 0.05);
                
                const enemy = {
                    name: enemyType.name,
                    maxHp: Math.floor(enemyType.hp * scaleFactor),
                    hp: Math.floor(enemyType.hp * scaleFactor),
                    attack: Math.floor(enemyType.attack * scaleFactor),
                    defense: Math.floor(enemyType.defense * scaleFactor),
                    xp: Math.floor(enemyType.xp * scaleFactor),
                    gold: Math.floor(enemyType.gold * scaleFactor),
                    buffs: [],
                    isBoss: isBoss,
                    resistances: [...enemyType.resistances],
                    weaknesses: [...enemyType.weaknesses]
                };
                
                return enemy;
            }

            function explore() {
                if (gameState.inCombat) return;
                
                const encounterChance = Math.random();
                
                if (encounterChance < 0.65) {
                    // Enemy encounter
                    gameState.currentEnemy = generateEnemy();
                    gameState.inCombat = true;
                    
                    if (gameState.currentEnemy.isBoss) {
                        addMessage(`A terrifying ${gameState.currentEnemy.name} appears!`, 'enemy legendary');
                    } else {
                        addMessage(`You encounter a ${gameState.currentEnemy.name}!`, 'enemy');
                    }
                    
                    updateControls();
                    updateEnemyDisplay();
                } else if (encounterChance < 0.9) {
                    // Find item or gold
                    if (Math.random() < 0.6) {
                        // Find item
                        let itemPool = [...gameState.items];
                        
                        // Higher chance for better items on deeper floors
                        const floorMod = Math.min(Math.floor(gameState.currentFloor / 10), 3);
                        const rareChance = 0.05 + (floorMod * 0.05);
                        const legendaryChance = 0.01 + (floorMod * 0.01);
                        
                        let selectedItem;
                        if (Math.random() < legendaryChance) {
                            // Legendary item
                            const legendaries = itemPool.filter(item => item.rarity === 'legendary');
                            if (legendaries.length > 0) {
                                selectedItem = {...legendaries[Math.floor(Math.random() * legendaries.length)]};
                            }
                        }
                        
                        if (!selectedItem && Math.random() < rareChance) {
                            // Rare item
                            const rares = itemPool.filter(item => item.rarity === 'rare');
                            if (rares.length > 0) {
                                selectedItem = {...rares[Math.floor(Math.random() * rares.length)]};
                            }
                        }
                        
                        if (!selectedItem) {
                            // Common or uncommon item
                            const commons = itemPool.filter(item => item.rarity === 'common' || item.rarity === 'uncommon');
                            selectedItem = {...commons[Math.floor(Math.random() * commons.length)]};
                        }
                        
                        // Randomize consumable amounts
                        if (selectedItem.type === 'consumable') {
                            selectedItem.amount = Math.floor(selectedItem.amount * (0.8 + Math.random() * 0.4));
                        }
                        
                        gameState.player.inventory.push(selectedItem);
                        
                        let rarityClass = '';
                        if (selectedItem.rarity === 'rare') rarityClass = 'rare';
                        if (selectedItem.rarity === 'legendary') rarityClass = 'legendary';
                        
                        // Elemental item classes
                        if (selectedItem.element) {
                            rarityClass += ` ${selectedItem.element}`;
                        }
                        
                        addMessage(`You found a ${selectedItem.name}!`, `buff ${rarityClass}`);
                        updateInventory();
                    } else {
                        // Find gold
                        const goldFound = 5 + Math.floor(Math.random() * (gameState.currentFloor * 3));
                        gameState.player.gold += goldFound;
                        addMessage(`You found ${goldFound} gold!`, 'buff');
                    }
                    
                    updateStats();
                } else {
                    // Special event (healing fountain, trap, etc.)
                    const eventRoll = Math.random();
                    if (eventRoll < 0.4) {
                        // Healing fountain
                        const hpHealed = Math.floor(gameState.player.maxHp * 0.5);
                        const mpHealed = Math.floor(gameState.player.maxMp * 0.5);
                        
                        gameState.player.hp = Math.min(gameState.player.hp + hpHealed, gameState.player.maxHp);
                        gameState.player.mp = Math.min(gameState.player.mp + mpHealed, gameState.player.maxMp);
                        
                        addMessage(`You find a healing fountain! Restored ${hpHealed} HP and ${mpHealed} MP.`, 'heal');
                        updateStats();
                    } else if (eventRoll < 0.7) {
                        // Trap
                        const damage = Math.floor(Math.random() * 15) + 5;
                        gameState.player.hp -= damage;
                        addMessage(`You trigger a trap and take ${damage} damage!`, 'damage');
                        
                        if (gameState.player.hp <= 0) {
                            gameOver();
                        } else {
                            updateStats();
                        }
                    } else {
                        // Empty room
                        addMessage("You find an empty room...", 'text-dim');
                    }
                }
            }

            function rest() {
                if (gameState.inCombat) return;
                
                const hpRecovered = Math.floor(gameState.player.maxHp * 0.3);
                const mpRecovered = Math.floor(gameState.player.maxMp * 0.3);
                
                gameState.player.hp = Math.min(gameState.player.hp + hpRecovered, gameState.player.maxHp);
                gameState.player.mp = Math.min(gameState.player.mp + mpRecovered, gameState.player.maxMp);
                
                addMessage(`You rest and recover ${hpRecovered} HP and ${mpRecovered} MP.`, 'heal');
                updateStats();
                
                // Process buffs/debuffs
                processBuffs();
                
                // Cooldowns
                updateSkills();
            }

            function attack() {
                if (!gameState.inCombat) return;
                
                // Check for critical hit
                const isCritical = Math.random() * 100 < gameState.player.criticalChance;
                let playerAttack = Math.max(1, gameState.player.attack - gameState.currentEnemy.defense);
                
                // Check for physical resistance
                if (gameState.currentEnemy.resistances.includes('physical')) {
                    playerAttack = Math.floor(playerAttack * 0.5);
                    addMessage(`The ${gameState.currentEnemy.name} resists physical damage!`, 'debuff');
                }
                
                if (isCritical) {
                    playerAttack = Math.floor(playerAttack * 1.5);
                    addMessage(`Critical hit!`, 'damage legendary');
                }
                
                // Apply elemental damage from weapons
                let elementalDamage = 0;
                if (gameState.player.equipment.weapon && gameState.player.equipment.weapon.element) {
                    const weapon = gameState.player.equipment.weapon;
                    const element = weapon.element;
                    const amount = weapon.elementAmount;
                    
                    // Check for resistances/weaknesses
                    if (gameState.currentEnemy.resistances.includes(element)) {
                        elementalDamage = Math.floor(amount * 0.5);
                        addMessage(`The ${gameState.currentEnemy.name} resists ${element} damage!`, 'debuff');
                    } else if (gameState.currentEnemy.weaknesses.includes(element)) {
                        elementalDamage = Math.floor(amount * 1.5);
                        addMessage(`The ${gameState.currentEnemy.name} is weak to ${element}!`, 'buff');
                    } else {
                        elementalDamage = amount;
                    }
                    
                    addMessage(`Your ${weapon.name} deals ${elementalDamage} ${element} damage!`, element);
                }
                
                const totalDamage = playerAttack + elementalDamage;
                gameState.currentEnemy.hp -= totalDamage;
                
                addMessage(`You attack the ${gameState.currentEnemy.name} for ${totalDamage} damage!`, 'damage');
                updateEnemyDisplay();
                
                if (gameState.currentEnemy.hp <= 0) {
                    enemyDefeated();
                } else {
                    enemyTurn();
                }
            }

            function useSkill(skill) {
                if (!gameState.inCombat) return;
                if (gameState.player.skills[skill].cooldown > 0) return;
                
                const skillData = gameState.player.skills[skill];
                
                if (skillData.cost && gameState.player.mp < skillData.cost) {
                    addMessage("Not enough MP!", 'debuff');
                    return;
                }
                
                if (skillData.cost) {
                    gameState.player.mp -= skillData.cost;
                }
                
                switch (skill) {
                    case 'fireball':
                        let fireDamage = skillData.baseDamage;
                        
                        // Check for fire resistance/weakness
                        if (gameState.currentEnemy.resistances.includes('fire')) {
                            fireDamage = Math.floor(fireDamage * 0.5);
                            addMessage(`The ${gameState.currentEnemy.name} resists fire damage!`, 'debuff');
                        } else if (gameState.currentEnemy.weaknesses.includes('fire')) {
                            fireDamage = Math.floor(fireDamage * 1.5);
                            addMessage(`The ${gameState.currentEnemy.name} is weak to fire!`, 'buff');
                        }
                        
                        gameState.currentEnemy.hp -= fireDamage;
                        addMessage(`You cast Fireball on the ${gameState.currentEnemy.name} for ${fireDamage} damage!`, 'fire');
                        break;
                        
                    case 'heal':
                        const healAmount = skillData.baseAmount;
                        gameState.player.hp = Math.min(gameState.player.hp + healAmount, gameState.player.maxHp);
                        addMessage(`You heal yourself for ${healAmount} HP!`, 'heal');
                        break;
                        
                    case 'poison':
                        let poisonDamage = skillData.baseDamage;
                        
                        // Check for poison resistance
                        if (gameState.currentEnemy.resistances.includes('poison')) {
                            poisonDamage = Math.floor(poisonDamage * 0.5);
                            addMessage(`The ${gameState.currentEnemy.name} resists poison!`, 'debuff');
                        }
                        
                        gameState.currentEnemy.buffs.push({
                            type: 'poison',
                            damage: poisonDamage,
                            duration: skillData.duration,
                            source: 'player'
                        });
                        addMessage(`You poison the ${gameState.currentEnemy.name}! It will take ${poisonDamage} damage per turn for ${skillData.duration} turns.`, 'poison');
                        break;
                        
                    case 'shield':
                        gameState.player.buffs.push({
                            type: 'shield',
                            defense: skillData.baseDefense,
                            duration: skillData.duration,
                            source: 'player'
                        });
                        addMessage(`You raise a shield, increasing your defense by ${skillData.baseDefense} for ${skillData.duration} turns!`, 'buff');
                        updateStats(); // Defense might change displayed stats
                        break;
                }
                
                // Set cooldown
                gameState.player.skills[skill].cooldown = gameState.player.skills[skill].maxCooldown;
                updateSkills();
                updateStats();
                updateEnemyDisplay();
                
                if (gameState.currentEnemy.hp <= 0) {
                    enemyDefeated();
                } else {
                    enemyTurn();
                }
            }

            function processBuffs() {
                // Process player buffs
                let playerBuffs = [];
                for (const buff of gameState.player.buffs) {
                    buff.duration--;
                    if (buff.duration > 0) {
                        playerBuffs.push(buff);
                    } else {
                        if (buff.type === 'shield') {
                            addMessage(`Your shield wears off.`, 'debuff');
                        }
                    }
                }
                gameState.player.buffs = playerBuffs;
                
                // Process enemy buffs (if in combat)
                if (gameState.inCombat && gameState.currentEnemy) {
                    let enemyBuffs = [];
                    for (const buff of gameState.currentEnemy.buffs) {
                        buff.duration--;
                        if (buff.type === 'poison' && buff.duration >= 0) {
                            gameState.currentEnemy.hp -= buff.damage;
                            addMessage(`The ${gameState.currentEnemy.name} takes ${buff.damage} poison damage!`, 'poison');
                            updateEnemyDisplay();
                        }
                        
                        if (buff.duration > 0) {
                            enemyBuffs.push(buff);
                        }
                    }
                    gameState.currentEnemy.buffs = enemyBuffs;
                }
                
                // Update status effects display
                updateStatusEffects();
            }

            function enemyTurn() {
                if (!gameState.inCombat) return;
                
                // Process buffs/debuffs
                processBuffs();
                
                // Check if enemy died from poison
                if (gameState.currentEnemy.hp <= 0) {
                    enemyDefeated();
                    return;
                }
                
                // Check for player dodge
                if (Math.random() * 100 < gameState.player.dodgeChance) {
                    addMessage(`You dodge the ${gameState.currentEnemy.name}'s attack!`, 'buff');
                    
                    // Update cooldowns
                    updateCooldowns();
                    return;
                }
                
                // Enemy attack
                let playerDefense = gameState.player.defense;
                for (const buff of gameState.player.buffs) {
                    if (buff.type === 'shield') {
                        playerDefense += buff.defense;
                    }
                }
                
                const enemyDamage = Math.max(1, gameState.currentEnemy.attack - playerDefense);
                gameState.player.hp -= enemyDamage;
                
                addMessage(`The ${gameState.currentEnemy.name} attacks you for ${enemyDamage} damage!`, 'damage');
                updateStats();
                
                // Check if player died
                if (gameState.player.hp <= 0) {
                    // Check for phoenix feather
                    const phoenixFeather = gameState.player.equipment.accessory && 
                                          gameState.player.equipment.accessory.special === 'phoenix_feather';
                    
                    if (phoenixFeather) {
                        gameState.player.hp = Math.floor(gameState.player.maxHp * 0.5);
                        addMessage(`The Phoenix Feather revives you with 50% HP!`, 'heal legendary');
                        gameState.player.equipment.accessory = null;
                        updateEquipment();
                        updateStats();
                    } else {
                        gameOver();
                    }
                    return;
                }
                
                // Update cooldowns
                updateCooldowns();
            }

            function updateCooldowns() {
                for (const skill in gameState.player.skills) {
                    if (gameState.player.skills[skill].cooldown > 0) {
                        gameState.player.skills[skill].cooldown--;
                    }
                }
                
                updateSkills();
            }

            function enemyDefeated() {
                let xpGained = gameState.currentEnemy.xp;
                let goldGained = gameState.currentEnemy.gold;
                
                // Bonus for bosses
                if (gameState.currentEnemy.isBoss) {
                    xpGained = Math.floor(xpGained * 1.5);
                    goldGained = Math.floor(goldGained * 2);
                    addMessage(`You defeated the boss ${gameState.currentEnemy.name}!`, 'buff legendary');
                    
                    // Bosses always drop rare or better loot
                    const rareOrBetter = gameState.items.filter(item => item.rarity === 'rare' || item.rarity === 'legendary');
                    if (rareOrBetter.length > 0) {
                        const loot = {...rareOrBetter[Math.floor(Math.random() * rareOrBetter.length)]};
                        gameState.player.inventory.push(loot);
                        
                        let rarityClass = loot.rarity === 'legendary' ? 'legendary' : 'rare';
                        if (loot.element) {
                            rarityClass += ` ${loot.element}`;
                        }
                        
                        addMessage(`The boss dropped a ${loot.name}!`, `buff ${rarityClass}`);
                        updateInventory();
                    }
                } else {
                    addMessage(`You defeated the ${gameState.currentEnemy.name}!`, 'buff');
                    
                    // Chance for regular enemy to drop loot (30%)
                    if (Math.random() < 0.3) {
                        const floorMod = Math.min(Math.floor(gameState.currentFloor / 10), 3);
                        const rareChance = 0.05 + (floorMod * 0.05);
                        
                        let itemPool = [...gameState.items];
                        let selectedItem;
                        
                        if (Math.random() < rareChance) {
                            // Rare item
                            const rares = itemPool.filter(item => item.rarity === 'rare');
                            if (rares.length > 0) {
                                selectedItem = {...rares[Math.floor(Math.random() * rares.length)]};
                            }
                        } else {
                            // Common or uncommon item
                            const commons = itemPool.filter(item => item.rarity === 'common' || item.rarity === 'uncommon');
                            selectedItem = {...commons[Math.floor(Math.random() * commons.length)]};
                        }
                        
                        if (selectedItem) {
                            gameState.player.inventory.push(selectedItem);
                            
                            let rarityClass = '';
                            if (selectedItem.rarity === 'rare') rarityClass = 'rare';
                            if (selectedItem.rarity === 'legendary') rarityClass = 'legendary';
                            
                            if (selectedItem.element) {
                                rarityClass += ` ${selectedItem.element}`;
                            }
                            
                            addMessage(`The enemy dropped a ${selectedItem.name}!`, `buff ${rarityClass}`);
                            updateInventory();
                        }
                    }
                }
                
                // Gain XP and gold
                gameState.player.xp += xpGained;
                gameState.player.gold += goldGained;
                
                addMessage(`Gained ${xpGained} XP and ${goldGained} gold!`, 'buff');
                
                // Check for level up
                if (gameState.player.xp >= gameState.player.xpToNext) {
                    levelUp();
                }
                
                gameState.inCombat = false;
                gameState.currentEnemy = null;
                updateStats();
                updateControls();
                updateEnemyDisplay();
                
                // Chance to go deeper
                if (Math.random() < 0.4) {
                    gameState.currentFloor++;
                    addMessage(`You descend to floor ${gameState.currentFloor}...`);
                    updateStats();
                }
            }

            function levelUp() {
                gameState.player.level++;
                gameState.player.xp -= gameState.player.xpToNext;
                gameState.player.xpToNext = Math.floor(gameState.player.xpToNext * 1.5);
                
                // Stat increases
                gameState.player.maxHp += 20 + Math.floor(gameState.player.level / 2);
                gameState.player.hp = gameState.player.maxHp;
                gameState.player.maxMp += 10 + Math.floor(gameState.player.level / 3);
                gameState.player.mp = gameState.player.maxMp;
                gameState.player.baseAttack += 2;
                gameState.player.baseDefense += 1;
                gameState.player.criticalChance += 0.5;
                gameState.player.dodgeChance += 0.5;
                
                // Recalculate stats in case equipment changed
                calculateStats();
                
                addMessage(`Level up! You are now level ${gameState.player.level}!`, 'heal legendary');
                updateStats();
            }

            function calculateStats() {
                // Start with base stats
                gameState.player.attack = gameState.player.baseAttack;
                gameState.player.defense = gameState.player.baseDefense;
                gameState.player.criticalChance = 5 + (gameState.player.level * 0.5);
                gameState.player.dodgeChance = 5 + (gameState.player.level * 0.5);
                
                // Reset elemental damage
                gameState.player.elementalDamage = {
                    fire: 0,
                    ice: 0,
                    poison: 0,
                    lightning: 0
                };
                
                // Apply equipment bonuses
                for (const slot in gameState.player.equipment) {
                    const item = gameState.player.equipment[slot];
                    if (item) {
                        if (item.stat) {
                            gameState.player[item.stat] += item.amount;
                        }
                        
                        // Special item effects
                        if (item.special) {
                            switch (item.special) {
                                case 'excalibur':
                                    gameState.player.criticalChance += 5;
                                    break;
                                case 'aegis':
                                    gameState.player.dodgeChance += 5;
                                    break;
                                case 'power_amulet':
                                    gameState.player.attack += 5;
                                    gameState.player.defense += 5;
                                    gameState.player.criticalChance += 5;
                                    gameState.player.dodgeChance += 5;
                                    break;
                                case 'dragon_slayer':
                                    // Bonus handled in attack calculation
                                    break;
                            }
                        }
                        
                        // Elemental damage
                        if (item.element && item.elementAmount) {
                            gameState.player.elementalDamage[item.element] += item.elementAmount;
                        }
                    }
                }
            }

            function gameOver() {
                addMessage("You have been defeated...", 'damage');
                addMessage("Game Over", 'damage');
                
                // Show death screen
                elements.deathMessage.textContent = `You were defeated on floor ${gameState.currentFloor}.`;
                elements.deathScreen.style.display = 'flex';
            }

            function resetGame() {
                gameState.player = {
                    name: "Adventurer",
                    maxHp: 100,
                    hp: 100,
                    maxMp: 50,
                    mp: 50,
                    level: 1,
                    xp: 0,
                    xpToNext: 100,
                    gold: 0,
                    baseAttack: 10,
                    attack: 10,
                    baseDefense: 5,
                    defense: 5,
                    criticalChance: 5,
                    dodgeChance: 5,
                    skills: {
                        attack: { name: "Attack", cooldown: 0, maxCooldown: 0 },
                        fireball: { name: "Fireball", cost: 10, baseDamage: 25, cooldown: 0, maxCooldown: 2 },
                        heal: { name: "Heal", cost: 15, baseAmount: 30, cooldown: 0, maxCooldown: 3 },
                        poison: { name: "Poison", cost: 5, baseDamage: 5, duration: 3, cooldown: 0, maxCooldown: 4 },
                        shield: { name: "Shield", cost: 10, baseDefense: 10, duration: 2, cooldown: 0, maxCooldown: 4 }
                    },
                    buffs: [],
                    inventory: [],
                    equipment: {
                        weapon: null,
                        armor: null,
                        accessory: null
                    },
                    elementalDamage: {
                        fire: 0,
                        ice: 0,
                        poison: 0,
                        lightning: 0
                    }
                };
                gameState.currentFloor = 1;
                gameState.inCombat = false;
                gameState.currentEnemy = null;
                
                elements.messageLog.innerHTML = '<div class="message">Welcome to the dungeon...</div>';
                elements.logEntries.innerHTML = '';
                gameState.combatLog = [];
                elements.deathScreen.style.display = 'none';
                
                updateStats();
                updateControls();
                updateSkills();
                updateInventory();
                updateEquipment();
                updateStatusEffects();
                updateEnemyDisplay();
            }

            function updateControls() {
                if (gameState.inCombat) {
                    elements.exploreBtn.classList.add('btn-disabled');
                    elements.restBtn.classList.add('btn-disabled');
                } else {
                    elements.exploreBtn.classList.remove('btn-disabled');
                    elements.restBtn.classList.remove('btn-disabled');
                }
            }

            function updateSkills() {
                for (const skill in gameState.player.skills) {
                    const btn = elements.skillBtns[`skill${Object.keys(gameState.player.skills).indexOf(skill) + 1}`];
                    if (!btn) continue;
                    
                    const skillData = gameState.player.skills[skill];
                    
                    // Clear previous content
                    btn.innerHTML = '';
                    
                    // Add skill name
                    const nameEl = document.createElement('div');
                    nameEl.className = 'skill-name';
                    nameEl.textContent = skillData.name;
                    btn.appendChild(nameEl);
                    
                    // Add skill cost if applicable
                    if (skillData.cost) {
                        const costEl = document.createElement('div');
                        costEl.className = 'skill-cost';
                        costEl.textContent = `${skillData.cost} MP`;
                        btn.appendChild(costEl);
                    }
                    
                    // Add cooldown if active
                    if (skillData.cooldown > 0) {
                        const cooldownEl = document.createElement('div');
                        cooldownEl.className = 'skill-cooldown';
                        cooldownEl.textContent = skillData.cooldown;
                        btn.appendChild(cooldownEl);
                    }
                }
            }

            function updateInventory() {
                elements.inventoryItems.innerHTML = '';
                
                if (gameState.player.inventory.length === 0) {
                    elements.inventoryItems.innerHTML = '<div class="message">Your inventory is empty</div>';
                    return;
                }
                
                gameState.player.inventory.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    
                    // Set item class based on rarity and element
                    let itemClass = 'item';
                    if (item.rarity === 'rare') itemClass += ' item-rare';
                    if (item.rarity === 'legendary') itemClass += ' item-legendary';
                    if (item.element) itemClass += ` item-${item.element}`;
                    
                    itemElement.className = itemClass;
                    
                    const header = document.createElement('div');
                    header.className = 'item-header';
                    
                    const name = document.createElement('div');
                    name.className = 'item-name';
                    name.textContent = item.name;
                    
                    const rarity = document.createElement('div');
                    rarity.className = 'item-rarity';
                    rarity.textContent = item.rarity.charAt(0).toUpperCase() + item.rarity.slice(1);
                    
                    header.appendChild(name);
                    header.appendChild(rarity);
                    
                    const desc = document.createElement('div');
                    desc.className = 'item-desc';
                    desc.textContent = item.description;
                    
                    const actions = document.createElement('div');
                    actions.className = 'item-actions';
                    
                    if (item.type === 'consumable') {
                        const useBtn = document.createElement('button');
                        useBtn.className = 'item-btn';
                        useBtn.textContent = 'Use';
                        useBtn.addEventListener('click', () => useItem(index));
                        actions.appendChild(useBtn);
                    }
                    
                    if (item.type === 'equipment') {
                        const equipBtn = document.createElement('button');
                        equipBtn.className = 'item-btn';
                        equipBtn.textContent = 'Equip';
                        equipBtn.addEventListener('click', () => equipItem(index));
                        actions.appendChild(equipBtn);
                    }
                    
                    itemElement.appendChild(header);
                    itemElement.appendChild(desc);
                    itemElement.appendChild(actions);
                    
                    elements.inventoryItems.appendChild(itemElement);
                });
            }

            function updateEquipment() {
                // Clear all slots first
                elements.weaponSlot.innerHTML = '<div class="empty-slot">Empty</div>';
                elements.armorSlot.innerHTML = '<div class="empty-slot">Empty</div>';
                elements.accessorySlot.innerHTML = '<div class="empty-slot">Empty</div>';
                
                // Update weapon slot
                if (gameState.player.equipment.weapon) {
                    elements.weaponSlot.innerHTML = '';
                    const weaponName = document.createElement('div');
                    weaponName.textContent = gameState.player.equipment.weapon.name;
                    elements.weaponSlot.appendChild(weaponName);
                    
                    const unequipBtn = document.createElement('button');
                    unequipBtn.className = 'item-btn';
                    unequipBtn.textContent = 'Unequip';
                    unequipBtn.style.marginTop = '5px';
                    unequipBtn.addEventListener('click', () => unequipItem('weapon'));
                    elements.weaponSlot.appendChild(unequipBtn);
                }
                
                // Update armor slot
                if (gameState.player.equipment.armor) {
                    elements.armorSlot.innerHTML = '';
                    const armorName = document.createElement('div');
                    armorName.textContent = gameState.player.equipment.armor.name;
                    elements.armorSlot.appendChild(armorName);
                    
                    const unequipBtn = document.createElement('button');
                    unequipBtn.className = 'item-btn';
                    unequipBtn.textContent = 'Unequip';
                    unequipBtn.style.marginTop = '5px';
                    unequipBtn.addEventListener('click', () => unequipItem('armor'));
                    elements.armorSlot.appendChild(unequipBtn);
                }
                
                // Update accessory slot
                if (gameState.player.equipment.accessory) {
                    elements.accessorySlot.innerHTML = '';
                    const accessoryName = document.createElement('div');
                    accessoryName.textContent = gameState.player.equipment.accessory.name;
                    elements.accessorySlot.appendChild(accessoryName);
                    
                    const unequipBtn = document.createElement('button');
                    unequipBtn.className = 'item-btn';
                    unequipBtn.textContent = 'Unequip';
                    unequipBtn.style.marginTop = '5px';
                    unequipBtn.addEventListener('click', () => unequipItem('accessory'));
                    elements.accessorySlot.appendChild(unequipBtn);
                }
                
                // Recalculate stats after equipment change
                calculateStats();
                updateStats();
            }

            function updateStatusEffects() {
                elements.statusEffects.innerHTML = '';
                
                if (gameState.player.buffs.length === 0) {
                    elements.statusEffects.innerHTML = '<div class="message">No active effects</div>';
                    return;
                }
                
                gameState.player.buffs.forEach(buff => {
                    const effectEl = document.createElement('div');
                    
                    let effectClass = 'status-effect ';
                    if (buff.type === 'poison') effectClass += 'negative-effect poison-effect';
                    else if (buff.type === 'shield') effectClass += 'positive-effect';
                    
                    effectEl.className = effectClass;
                    
                    let effectText = '';
                    switch (buff.type) {
                        case 'shield':
                            effectText = `Shield +${buff.defense} (${buff.duration}t)`;
                            break;
                        case 'poison':
                            effectText = `Poison -${buff.damage}/t (${buff.duration}t)`;
                            break;
                        default:
                            effectText = `${buff.type} (${buff.duration}t)`;
                    }
                    
                    effectEl.textContent = effectText;
                    elements.statusEffects.appendChild(effectEl);
                });
            }

            function useItem(index) {
                const item = gameState.player.inventory[index];
                
                switch (item.effect) {
                    case 'heal':
                        gameState.player.hp = Math.min(gameState.player.hp + item.amount, gameState.player.maxHp);
                        addMessage(`You used ${item.name} and recovered ${item.amount} HP!`, 'heal');
                        break;
                        
                    case 'mana':
                        gameState.player.mp = Math.min(gameState.player.mp + item.amount, gameState.player.maxMp);
                        addMessage(`You used ${item.name} and recovered ${item.amount} MP!`, 'heal');
                        break;
                        
                    case 'full_restore':
                        gameState.player.hp = gameState.player.maxHp;
                        gameState.player.mp = gameState.player.maxMp;
                        addMessage(`You used ${item.name} and fully restored HP and MP!`, 'heal legendary');
                        break;
                        
                    case 'identify':
                        addMessage(`You used ${item.name}, but there's nothing to identify yet.`, 'buff');
                        break;
                }
                
                // Remove item from inventory
                gameState.player.inventory.splice(index, 1);
                
                updateStats();
                updateInventory();
            }

            function equipItem(index) {
                const item = gameState.player.inventory[index];
                
                // Check if slot is already occupied
                if (gameState.player.equipment[item.slot]) {
                    // Swap items
                    const oldItem = gameState.player.equipment[item.slot];
                    gameState.player.equipment[item.slot] = item;
                    gameState.player.inventory[index] = oldItem;
                } else {
                    // Equip new item
                    gameState.player.equipment[item.slot] = item;
                    gameState.player.inventory.splice(index, 1);
                }
                
                addMessage(`You equipped ${item.name}.`, 'buff');
                updateInventory();
                updateEquipment();
            }

            function unequipItem(slot) {
                const item = gameState.player.equipment[slot];
                
                if (gameState.player.inventory.length >= 20) {
                    addMessage("Inventory is full! Can't unequip.", 'debuff');
                    return;
                }
                
                gameState.player.inventory.push(item);
                gameState.player.equipment[slot] = null;
                
                addMessage(`You unequipped ${item.name}.`, 'buff');
                updateInventory();
                updateEquipment();
            }

            // Event listeners
            elements.exploreBtn.addEventListener('click', explore);
            elements.restBtn.addEventListener('click', rest);
            elements.characterBtn.addEventListener('click', () => {
                elements.modalTitle.textContent = 'Character';
                elements.modalOverlay.style.display = 'flex';
                switchTab('character');
            });
            
            elements.closeModal.addEventListener('click', () => {
                elements.modalOverlay.style.display = 'none';
            });
            
            // Skill buttons
            elements.skillBtns.skill1.addEventListener('click', attack);
            elements.skillBtns.skill2.addEventListener('click', () => useSkill('fireball'));
            elements.skillBtns.skill3.addEventListener('click', () => useSkill('heal'));
            elements.skillBtns.skill4.addEventListener('click', () => useSkill('poison'));
            elements.skillBtns.skill5.addEventListener('click', () => useSkill('shield'));
            
            // Tab switching
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // Death screen buttons
            elements.newGameBtn.addEventListener('click', resetGame);
            elements.quitBtn.addEventListener('click', () => {
                elements.deathScreen.style.display = 'none';
                addMessage("Game ended. Refresh to play again.", 'text-dim');
            });
            
            function switchTab(tabName) {
                // Update active tab
                elements.tabs.forEach(tab => {
                    if (tab.getAttribute('data-tab') === tabName) {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });
                
                // Show corresponding content
                elements.characterScreen.style.display = 'none';
                elements.inventoryScreen.style.display = 'none';
                elements.combatLogScreen.style.display = 'none';
                
                switch (tabName) {
                    case 'character':
                        elements.characterScreen.style.display = 'block';
                        elements.modalTitle.textContent = 'Character';
                        break;
                    case 'inventory':
                        elements.inventoryScreen.style.display = 'block';
                        elements.modalTitle.textContent = 'Inventory';
                        updateInventory();
                        break;
                    case 'combat-log':
                        elements.combatLogScreen.style.display = 'block';
                        elements.modalTitle.textContent = 'Combat Log';
                        break;
                }
            }
            
            // Simulate loading
            setTimeout(() => {
                document.getElementById('loading-progress').style.width = '25%';
                setTimeout(() => {
                    document.getElementById('loading-progress').style.width = '60%';
                    setTimeout(() => {
                        document.getElementById('loading-progress').style.width = '100%';
                        setTimeout(() => {
                            document.getElementById('loading-screen').style.display = 'none';
                            document.getElementById('game-container').style.display = 'flex';
                            
                            // Initialize game
                            updateStats();
                            updateSkills();
                            updateEquipment();
                        }, 300);
                    }, 300);
                }, 300);
            }, 300);
        }
        
        // Initialize the game when the page loads
        window.onload = initGame;
    </script>
</body>
</html>
