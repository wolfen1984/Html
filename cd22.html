<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle of the Dammed 1982 - Castle Tower</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            overflow-x: hidden;
        }
        
        .game-container {
            border: 2px solid #fff;
            padding: 20px;
            margin-top: 20px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px dashed #fff;
            padding-bottom: 10px;
        }
        
        .game-title {
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #fff;
        }
        
        .game-subtitle {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }
        
        .game-output {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
            border: 1px solid #333;
            padding: 15px;
            background-color: #111;
        }
        
        .game-output p {
            margin-bottom: 10px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .game-output .location {
            color: #ffff00;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .game-output .hint {
            color: #888;
            font-style: italic;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .game-output .enemy {
            color: #ff5555;
        }
        
        .game-output .npc {
            color: #55ff55;
        }
        
        .game-output .combat {
            color: #ff4444;
            font-weight: bold;
        }
        
        .game-output .player {
            color: #55ffff;
        }
        
        .game-output .health {
            color: #ff6666;
        }
        
        .game-output .damage {
            color: #ff9966;
        }
        
        .game-output .victory {
            color: #ffff55;
            font-weight: bold;
        }
        
        .game-output .defeat {
            color: #ff5555;
            font-weight: bold;
        }
        
        .game-output .gold {
            color: #ffd700;
        }
        
        .game-output .shop {
            color: #ffaa00;
        }
        
        .game-output .magic {
            color: #ff66ff;
        }
        
        .game-output .item {
            color: #55ff55;
        }
        
        .game-output .secret {
            color: #ff66ff;
            font-style: italic;
        }
        
        .game-output .trap {
            color: #ff0000;
            font-weight: bold;
        }
        
        .game-input-container {
            display: flex;
            align-items: center;
            border-top: 1px dashed #fff;
            padding-top: 15px;
        }
        
        .game-prompt {
            margin-right: 10px;
            color: #00ff00;
        }
        
        #game-input {
            background-color: #000;
            color: #fff;
            border: 1px solid #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            padding: 10px;
            flex-grow: 1;
            outline: none;
        }
        
        #game-input:focus {
            box-shadow: 0 0 5px #fff;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Scrollbar styling */
        .game-output::-webkit-scrollbar {
            width: 10px;
        }
        
        .game-output::-webkit-scrollbar-track {
            background: #111;
        }
        
        .game-output::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 5px;
        }
        
        .game-output::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
        
        /* Status bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #222;
            border: 1px solid #444;
            font-size: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
        }
        
        .health-bar {
            width: 100px;
            height: 12px;
            background-color: #333;
            margin-left: 5px;
            border: 1px solid #555;
        }
        
        .health-fill {
            height: 100%;
            background-color: #ff5555;
            transition: width 0.3s;
        }
        
        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                font-size: 14px;
                padding: 10px;
            }
            
            .game-title {
                font-size: 18px;
            }
            
            .game-container {
                padding: 10px;
            }
            
            #game-input {
                font-size: 12px;
                padding: 8px;
            }
            
            .status-bar {
                font-size: 10px;
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1 class="game-title">CASTLE OF THE DAMMED</h1>
        <p class="game-subtitle">Â© 1982 Dark Castle Software</p>
        <p class="game-subtitle">Text Adventure v3.3 - CASTLE TOWER ADDED</p>
    </div>
    
    <div class="status-bar" id="status-bar">
        <div class="status-item">
            HP: <span id="player-hp-text">25/25</span>
            <div class="health-bar">
                <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
            </div>
        </div>
        <div class="status-item">
            Weapon: <span id="player-weapon">Fists</span>
        </div>
        <div class="status-item">
            Gold: <span id="player-gold">10</span>
        </div>
        <div class="status-item">
            Enemy HP: <span id="enemy-hp-text">-</span>
            <div class="health-bar">
                <div class="health-fill" id="enemy-health-fill" style="width: 0%; background-color: #ff9966;"></div>
            </div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="game-output" id="game-output">
            <!-- Game text will appear here -->
        </div>
        
        <div class="game-input-container">
            <span class="game-prompt">&gt;</span>
            <input type="text" id="game-input" placeholder="Type your command..." autocomplete="off">
        </div>
    </div>

    <script>
        // ==================== COMBAT SYSTEM ====================
        
        // Player stats - WILL BE LOADED FROM SAVE
        let player = {
            maxHP: 25,
            currentHP: 25,
            gold: 10,
            weapon: {
                name: "Fists",
                minDamage: 4,
                maxDamage: 6
            },
            inventory: [],
            spells: [],
            hasAmuletOfDawn: false
        };
        
        // Enemy types - INCLUDES TOWER ENEMIES
        const enemies = {
            // Original enemies
            goblin: {
                name: "Forest Goblin",
                maxHP: 10,
                currentHP: 10,
                minDamage: 2,
                maxDamage: 4,
                description: "A small, green-skinned goblin with sharp teeth and beady red eyes.",
                defeatMessage: "The goblin squeals and runs off into the forest!",
                loot: "crude dagger"
            },
            wolf: {
                name: "Hungry Wolf",
                maxHP: 12,
                currentHP: 12,
                minDamage: 3,
                maxDamage: 5,
                description: "A lean, gray wolf with bared teeth and hungry eyes.",
                defeatMessage: "The wolf yelps and retreats into the woods!",
                loot: "wolf pelt"
            },
            rat: {
                name: "Giant Black Rat",
                maxHP: 8,
                currentHP: 8,
                minDamage: 2,
                maxDamage: 4,
                description: "A massive, black-furred rat with beady red eyes and sharp yellow teeth.",
                defeatMessage: "The giant rat squeals and scurries back down the well!",
                loot: null
            },
            skeletalHorse: {
                name: "Skeletal Horse",
                maxHP: 18,
                currentHP: 18,
                minDamage: 4,
                maxDamage: 7,
                description: "A terrifying undead horse with glowing red eyes in its empty sockets.",
                defeatMessage: "The skeletal horse collapses into a pile of bones!",
                loot: null
            },
            
            // NEW TOWER ENEMIES
            shadowCreature: {
                name: "Shadow Creature",
                maxHP: 15,
                currentHP: 15,
                minDamage: 4,
                maxDamage: 7,
                description: "A shifting mass of darkness with glowing red eyes.",
                defeatMessage: "The shadow creature dissipates into mist!",
                loot: "shadow essence"
            },
            gargoyle: {
                name: "Stone Gargoyle",
                maxHP: 20,
                currentHP: 20,
                minDamage: 5,
                maxDamage: 8,
                description: "A grotesque stone statue that has come to life.",
                defeatMessage: "The gargoyle crumbles into rubble!",
                loot: "stone shard"
            },
            spectralKnight: {
                name: "Spectral Knight",
                maxHP: 25,
                currentHP: 25,
                minDamage: 6,
                maxDamage: 9,
                description: "A ghostly knight in tattered armor, wielding a phantom sword.",
                defeatMessage: "The spectral knight fades away with a mournful wail!",
                loot: "spectral gauntlet"
            }
        };
        
        // Current combat state
        let combatActive = false;
        let currentEnemy = null;
        
        // ==================== GAME STATE ====================
        let gameState = {
            currentLocation: 'towerEntrance',
            inventory: [],
            visitedLocations: ['towerEntrance'],
            gameEnded: false,
            // Tower-specific states
            towerMapExplored: {
                entrance: false,
                stairs: false,
                hallway: false,
                library: false
            },
            scrollRead: false,
            tomeExamined: false,
            robeTaken: false,
            gargoyleDefeated: false,
            shadowCreaturesDefeated: 0,
            foundHiddenChamber: false,
            secretDoorFound: false
        };
        
        // ==================== TOWER LOCATIONS ====================
        const locations = {
            towerEntrance: {
                name: "CASTLE TOWER ENTRANCE",
                description: function() {
                    let desc = "You stand in the grand entrance hall of the castle tower. ";
                    desc += "A massive stone staircase spirals UPWARD into darkness. ";
                    desc += "Tattered tapestries hang from the walls, depicting scenes of ancient battles. ";
                    desc += "To the EAST, the oak door leads back to the COURTYARD.";
                    
                    if (!gameState.towerMapExplored.entrance) {
                        gameState.towerMapExplored.entrance = true;
                        if (gameState.inventory.includes("cursed map")) {
                            desc += " This location has been added to your cursed map!";
                        }
                    }
                    
                    // Check for secret door (only if player has examined walls)
                    if (gameState.secretDoorFound) {
                        desc += " You notice a HIDDEN DOOR behind one of the tapestries.";
                    }
                    
                    return desc;
                },
                items: [],
                exits: {
                    east: "courtyard",
                    up: "towerStairs",
                    north: gameState.secretDoorFound ? "hiddenChamber" : null,
                    south: null,
                    west: null
                },
                visited: true,
                enemy: null
            },
            
            towerStairs: {
                name: "SPIRAL STAIRCASE",
                description: function() {
                    let desc = "You climb the ancient stone staircase. ";
                    desc += "The steps are worn smooth by centuries of use. ";
                    desc += "Torch brackets line the walls, but no torches remain. ";
                    desc += "The staircase continues UPWARD and DOWN.";
                    
                    // Random chance for shadow creature encounter
                    if (!this.visited && Math.random() < 0.4 && !combatActive) {
                        desc += " A SHADOW CREATURE materializes on the stairs!";
                        this.enemy = "shadowCreature";
                    } else {
                        this.enemy = null;
                    }
                    
                    if (!gameState.towerMapExplored.stairs) {
                        gameState.towerMapExplored.stairs = true;
                        if (gameState.inventory.includes("cursed map")) {
                            desc += " This location has been added to your cursed map!";
                        }
                    }
                    
                    return desc;
                },
                items: ["dusty scroll"],
                exits: {
                    up: "towerHallway",
                    down: "towerEntrance",
                    north: null,
                    south: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            towerHallway: {
                name: "UPPER HALLWAY",
                description: function() {
                    let desc = "You reach the top of the staircase. ";
                    desc += "A long hallway stretches before you, with doors on either side. ";
                    desc += "Most doors are rotted or barred shut. ";
                    desc += "One door to the NORTH looks recently used.";
                    
                    if (!this.visited && !gameState.gargoyleDefeated) {
                        desc += " A STONE GARGOYLE perches above the northern door!";
                        this.enemy = "gargoyle";
                    } else {
                        this.enemy = null;
                    }
                    
                    if (!gameState.towerMapExplored.hallway) {
                        gameState.towerMapExplored.hallway = true;
                        if (gameState.inventory.includes("cursed map")) {
                            desc += " This location has been added to your cursed map!";
                        }
                    }
                    
                    return desc;
                },
                items: [],
                exits: {
                    down: "towerStairs",
                    north: "library",
                    south: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            library: {
                name: "FORBIDDEN LIBRARY",
                description: function() {
                    let desc = "You enter what was once the castle library. ";
                    desc += "Rows of empty bookshelves line the walls, coated in thick dust. ";
                    desc += "A single ANCIENT TOME rests on a central pedestal. ";
                    desc += "In one corner, a DUSTY ROBE hangs from a hook. ";
                    desc += "The door to the SOUTH leads back to the hallway.";
                    
                    if (!gameState.towerMapExplored.library) {
                        gameState.towerMapExplored.library = true;
                        if (gameState.inventory.includes("cursed map")) {
                            desc += " This location has been added to your cursed map!";
                        }
                    }
                    
                    if (this.items.length > 0) {
                        desc += " On the ground, you see: " + this.items.map(item => item.toUpperCase()).join(", ") + ". ";
                    }
                    
                    return desc;
                },
                items: ["ancient tome", "dusty robe"],
                exits: {
                    south: "towerHallway",
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            hiddenChamber: {
                name: "HIDDEN CHAMBER",
                description: function() {
                    let desc = "You've discovered a secret chamber behind the tapestry! ";
                    desc += "The room is small and circular, with a single stone altar in the center. ";
                    desc += "On the altar rests a glowing AMULET OF DAWN. ";
                    desc += "The way SOUTH leads back to the tower entrance.";
                    
                    if (this.items.length > 0) {
                        desc += " On the altar, you see: " + this.items.map(item => item.toUpperCase()).join(", ") + ". ";
                    }
                    
                    return desc;
                },
                items: ["amulet of dawn"],
                exits: {
                    south: "towerEntrance",
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            }
        };
        
        // Object descriptions for tower objects
        const objectDescriptions = {
            // Tower objects
            "tower": "The main castle tower, a massive stone structure that looms over the courtyard.",
            "staircase": "A spiral stone staircase that winds up through the tower.",
            "tapestry": "Ancient tapestries depicting battles from the castle's history.",
            "shadow creature": "A creature of pure darkness, its form constantly shifting.",
            "stone gargoyle": "A grotesque stone statue that watches the hallway with malevolent eyes.",
            "dusty scroll": "An ancient scroll covered in dust. The writing is faded but might be readable.",
            "ancient tome": "A massive book bound in leather. It feels heavy with magical energy.",
            "dusty robe": "A wizard's robe, dusty but otherwise intact. It might have protective properties.",
            "amulet of dawn": "A golden amulet with a sun symbol. It radiates powerful magical energy.",
            "shadow essence": "A vial of swirling darkness. It feels cold to the touch.",
            "stone shard": "A piece of the gargoyle. It might have magical properties.",
            "spectral gauntlet": "A ghostly gauntlet that phases in and out of existence.",
            "hidden door": "A cleverly concealed door behind one of the tapestries.",
            "altar": "A stone altar with ancient runes carved into its surface."
        };
        
        // Game commands
        const commands = {
            'north': 'north',
            'n': 'north',
            'south': 'south',
            's': 'south',
            'east': 'east',
            'e': 'east',
            'west': 'west',
            'w': 'west',
            'up': 'up',
            'u': 'up',
            'down': 'down',
            'd': 'down',
            'look': 'look',
            'l': 'look',
            'inventory': 'inventory',
            'i': 'inventory',
            'take': 'take',
            'get': 'take',
            'grab': 'take',
            'drop': 'drop',
            'examine': 'examine',
            'x': 'examine',
            'use': 'use',
            'open': 'open',
            'read': 'read',
            'talk': 'talk',
            'speak': 'talk',
            'ask': 'talk',
            'give': 'give',
            'attack': 'attack',
            'fight': 'attack',
            'kill': 'attack',
            'light': 'light',
            'repair': 'repair',
            'fix': 'repair',
            'eat': 'eat',
            'drink': 'drink',
            'buy': 'buy',
            'purchase': 'buy',
            'sell': 'sell',
            'shop': 'shop',
            'list': 'shop',
            'cast': 'cast',
            'wear': 'wear',
            'equip': 'wear',
            'remove': 'remove',
            'unequip': 'remove',
            'help': 'help',
            'h': 'help',
            'quit': 'quit',
            'q': 'quit'
        };
        
        // DOM elements
        const gameOutput = document.getElementById('game-output');
        const gameInput = document.getElementById('game-input');
        
        // ==================== GAME FUNCTIONS ====================
        
        // Update status display
        function updateStatus() {
            document.getElementById('player-hp-text').textContent = 
                `${player.currentHP}/${player.maxHP}`;
            
            const playerHealthPercent = (player.currentHP / player.maxHP) * 100;
            document.getElementById('player-health-fill').style.width = 
                `${Math.max(0, playerHealthPercent)}%`;
            
            document.getElementById('player-weapon').textContent = player.weapon.name;
            document.getElementById('player-gold').textContent = player.gold;
            
            if (currentEnemy && combatActive) {
                document.getElementById('enemy-hp-text').textContent = 
                    `${currentEnemy.currentHP}/${currentEnemy.maxHP}`;
                
                const enemyHealthPercent = (currentEnemy.currentHP / currentEnemy.maxHP) * 100;
                document.getElementById('enemy-health-fill').style.width = 
                    `${Math.max(0, enemyHealthPercent)}%`;
                document.getElementById('enemy-health-fill').style.display = 'block';
            } else {
                document.getElementById('enemy-hp-text').textContent = '-';
                document.getElementById('enemy-health-fill').style.display = 'none';
            }
        }
        
        // Combat functions
        function startCombat(enemyType) {
            currentEnemy = JSON.parse(JSON.stringify(enemies[enemyType])); // Clone enemy
            combatActive = true;
            updateStatus();
            
            addToOutput(`A ${currentEnemy.name} appears!`, "enemy");
            addToOutput("COMBAT STARTED! Use ATTACK to fight!", "combat");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP} | ${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "combat");
        }
        
        function playerAttack() {
            if (!combatActive || !currentEnemy) {
                addToOutput("There's nothing to attack here.");
                return;
            }
            
            const playerDamage = Math.floor(
                Math.random() * (player.weapon.maxDamage - player.weapon.minDamage + 1)
            ) + player.weapon.minDamage;
            
            currentEnemy.currentHP -= playerDamage;
            currentEnemy.currentHP = Math.max(0, currentEnemy.currentHP);
            
            addToOutput(`You attack with your ${player.weapon.name} and deal ${playerDamage} damage!`, "player");
            addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
            
            if (currentEnemy.currentHP <= 0) {
                endCombat(true);
                return;
            }
            
            enemyAttack();
            updateStatus();
        }
        
        function enemyAttack() {
            const enemyDamage = Math.floor(
                Math.random() * (currentEnemy.maxDamage - currentEnemy.minDamage + 1)
            ) + currentEnemy.minDamage;
            
            player.currentHP -= enemyDamage;
            player.currentHP = Math.max(0, player.currentHP);
            
            addToOutput(`${currentEnemy.name} attacks you for ${enemyDamage} damage!`, "enemy");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP}`, "health");
            
            if (player.currentHP <= 0) {
                endCombat(false);
            }
        }
        
        function endCombat(playerWon) {
            if (playerWon) {
                addToOutput(currentEnemy.defeatMessage, "victory");
                
                if (currentEnemy.loot && !gameState.inventory.includes(currentEnemy.loot)) {
                    gameState.inventory.push(currentEnemy.loot);
                    addToOutput(`You found a ${currentEnemy.loot}!`);
                    
                    if (currentEnemy.loot === "shadow essence") {
                        addToOutput("The shadow essence feels cold and pulsating.", "item");
                        gameState.shadowCreaturesDefeated++;
                    } else if (currentEnemy.loot === "stone shard") {
                        addToOutput("The stone shard glows faintly with residual magic.", "item");
                        gameState.gargoyleDefeated = true;
                        locations.towerHallway.enemy = null;
                    }
                }
                
                if (currentEnemy.name === "Shadow Creature") {
                    gameState.shadowCreaturesDefeated++;
                } else if (currentEnemy.name === "Stone Gargoyle") {
                    gameState.gargoyleDefeated = true;
                    locations.towerHallway.enemy = null;
                    addToOutput("With the gargoyle defeated, you can now safely enter the library.", "hint");
                }
            } else {
                addToOutput("You have been defeated!", "defeat");
                addToOutput("GAME OVER - Refresh the page to try again.", "defeat");
                gameState.gameEnded = true;
                gameInput.disabled = true;
            }
            
            combatActive = false;
            currentEnemy = null;
            updateStatus();
        }
        
        // Add text to game output
        function addToOutput(text, className = '') {
            const p = document.createElement('p');
            p.textContent = text;
            if (className) {
                p.className = className;
            }
            gameOutput.appendChild(p);
            
            gameOutput.scrollTop = gameOutput.scrollHeight;
        }
        
        // Show current location
        function showLocation() {
            const loc = locations[gameState.currentLocation];
            
            addToOutput(loc.name, "location");
            
            const description = loc.description();
            addToOutput(description);
            
            if (!loc.visited) {
                loc.visited = true;
                gameState.visitedLocations.push(gameState.currentLocation);
            }
            
            if (loc.enemy && !combatActive) {
                if (loc.enemy === "shadowCreature") {
                    startCombat(loc.enemy);
                } else if (loc.enemy === "gargoyle" && !gameState.gargoyleDefeated) {
                    startCombat(loc.enemy);
                }
            }
            
            const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
            if (exits.length > 0) {
                addToOutput("Exits: " + exits.map(exit => exit.toUpperCase()).join(", "));
            }
        }
        
        // Initialize game
        function initGame() {
            // Try to load saved game from cd1.html
            const savedGame = localStorage.getItem('castleDamnedSave');
            
            if (savedGame) {
                try {
                    const saveData = JSON.parse(savedGame);
                    
                    // Load player data
                    player = saveData.player;
                    gameState = saveData.gameState;
                    combatActive = saveData.combatActive || false;
                    currentEnemy = saveData.currentEnemy || null;
                    
                    // Ensure we start in tower entrance
                    gameState.currentLocation = 'towerEntrance';
                    
                    // Initialize visited locations if needed
                    if (!gameState.visitedLocations.includes('towerEntrance')) {
                        gameState.visitedLocations.push('towerEntrance');
                    }
                    
                    // Clear save to prevent re-loading
                    localStorage.removeItem('castleDamnedSave');
                    
                    // Initialize game output
                    gameOutput.innerHTML = '';
                    addToOutput("CASTLE OF THE DAMMED - CASTLE TOWER", "title");
                    addToOutput("Your adventure continues in the castle tower...", "story");
                    addToOutput(" ");
                    addToOutput("Game state loaded successfully!", "victory");
                    addToOutput(`HP: ${player.currentHP}/${player.maxHP} | Gold: ${player.gold} | Weapon: ${player.weapon.name}`, "player");
                    addToOutput(" ");
                    
                    // Show inventory if not empty
                    if (gameState.inventory.length > 0) {
                        addToOutput("Inventory: " + gameState.inventory.map(item => item.toUpperCase()).join(", "));
                        addToOutput(" ");
                    }
                    
                } catch (error) {
                    console.error("Error loading save:", error);
                    startNewGame();
                }
            } else {
                startNewGame();
            }
            
            updateStatus();
            showLocation();
            gameInput.focus();
            
            gameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processCommand(this.value);
                    this.value = '';
                }
            });
        }
        
        function startNewGame() {
            gameOutput.innerHTML = '';
            addToOutput("CASTLE OF THE DAMMED - CASTLE TOWER", "title");
            addToOutput("No saved game found. Starting new tower adventure.", "hint");
            addToOutput(" ");
            addToOutput("You find yourself in the castle tower entrance.", "story");
            addToOutput("It seems you entered without your previous possessions.", "hint");
            addToOutput(" ");
            
            // Set up new game in tower
            gameState.currentLocation = 'towerEntrance';
            gameState.visitedLocations = ['towerEntrance'];
        }
        
        // Process player command
        function processCommand(input) {
            if (gameState.gameEnded) {
                addToOutput("The game has ended. Refresh the page to try again.", "hint");
                return;
            }
            
            const command = input.trim().toLowerCase();
            if (!command) return;
            
            const parts = command.split(' ');
            const verb = parts[0];
            const object = parts.slice(1).join(' ');
            
            if (!commands[verb]) {
                addToOutput(`I don't understand "${verb}".`);
                return;
            }
            
            const action = commands[verb];
            
            switch(action) {
                case 'north':
                case 'south':
                case 'east':
                case 'west':
                case 'up':
                case 'down':
                    movePlayer(action);
                    break;
                case 'look':
                    lookAround();
                    break;
                case 'inventory':
                    showInventory();
                    break;
                case 'take':
                    takeItem(object);
                    break;
                case 'drop':
                    dropItem(object);
                    break;
                case 'examine':
                    examineObject(object);
                    break;
                case 'use':
                    useItem(object);
                    break;
                case 'open':
                    openObject(object);
                    break;
                case 'read':
                    readObject(object);
                    break;
                case 'talk':
                    talkTo(object);
                    break;
                case 'give':
                    giveItem(object);
                    break;
                case 'attack':
                    if (combatActive) {
                        playerAttack();
                    } else {
                        attackEnemy(object);
                    }
                    break;
                case 'light':
                    lightLantern();
                    break;
                case 'cast':
                    castSpell(object);
                    break;
                case 'wear':
                    wearItem(object);
                    break;
                case 'remove':
                    removeItem(object);
                    break;
                case 'help':
                    showHelp();
                    break;
                case 'quit':
                    quitGame();
                    break;
                default:
                    addToOutput(`Command "${verb}" not implemented yet.`);
            }
        }
        
        // Move player
        function movePlayer(direction) {
            if (combatActive) {
                addToOutput("You can't run from combat! You must FIGHT!", "combat");
                return;
            }
            
            const currentLoc = locations[gameState.currentLocation];
            let newLocation = currentLoc.exits[direction];
            
            // Handle going back to courtyard (transfer back to cd1.html)
            if (gameState.currentLocation === "towerEntrance" && direction === 'east') {
                addToOutput("Returning to the courtyard...", "location");
                
                // Save game state for cd1.html
                const saveData = {
                    player: player,
                    gameState: gameState,
                    combatActive: combatActive,
                    currentEnemy: currentEnemy
                };
                
                localStorage.setItem('castleDamnedSaveToCD1', JSON.stringify(saveData));
                
                setTimeout(() => {
                    window.location.href = 'cd1.html';
                }, 1500);
                return;
            }
            
            if (!newLocation) {
                addToOutput(`You can't go ${direction}.`);
                return;
            }
            
            gameState.currentLocation = newLocation;
            addToOutput(`You go ${direction}.`);
            showLocation();
        }
        
        // Look around
        function lookAround() {
            const loc = locations[gameState.currentLocation];
            
            addToOutput(loc.name, "location");
            
            const description = loc.description();
            addToOutput(description);
            
            const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
            if (exits.length > 0) {
                addToOutput("Exits: " + exits.map(exit => exit.toUpperCase()).join(", "));
            }
        }
        
        // Show inventory
        function showInventory() {
            if (gameState.inventory.length === 0) {
                addToOutput("You are carrying nothing.");
            } else {
                addToOutput("You are carrying: " + gameState.inventory.map(item => item.toUpperCase()).join(", "));
            }
            
            if (player.spells.length > 0) {
                addToOutput("Known spells: " + player.spells.map(spell => spell.toUpperCase()).join(", "), "magic");
            }
            
            addToOutput(`Equipped weapon: ${player.weapon.name} (${player.weapon.minDamage}-${player.weapon.maxDamage} damage)`, "player");
            addToOutput(`HP: ${player.currentHP}/${player.maxHP}`, "health");
            addToOutput(`Gold: ${player.gold}`, "gold");
        }
        
        // Take item
        function takeItem(itemName) {
            if (!itemName) {
                addToOutput("Take what?");
                return;
            }
            
            const loc = locations[gameState.currentLocation];
            const itemIndex = loc.items.findIndex(item => item.toLowerCase().includes(itemName.toLowerCase()));
            
            if (itemIndex === -1) {
                addToOutput(`I don't see a ${itemName} here.`);
                return;
            }
            
            const item = loc.items[itemIndex];
            
            if (item === "amulet of dawn") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                player.hasAmuletOfDawn = true;
                addToOutput(`You take the amulet of dawn!`, "magic");
                addToOutput("You feel magical energy coursing through you!", "magic");
                addToOutput("You can now cast spells from your spellbook!", "hint");
            } else if (item === "dusty robe") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                gameState.robeTaken = true;
                addToOutput(`You take the dusty robe!`, "item");
                addToOutput("The robe might offer some protection.", "hint");
            } else if (item === "ancient tome") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                addToOutput(`You take the ancient tome!`, "item");
                addToOutput("The book feels incredibly heavy with ancient knowledge.", "hint");
            } else if (item === "dusty scroll") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                addToOutput(`You take the dusty scroll!`, "item");
                addToOutput("The parchment feels fragile in your hands.", "hint");
            } else {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                addToOutput(`You take the ${item}.`);
            }
        }
        
        // Drop item
        function dropItem(itemName) {
            if (!itemName) {
                addToOutput("Drop what?");
                return;
            }
            
            const itemIndex = gameState.inventory.findIndex(item => item.toLowerCase().includes(itemName.toLowerCase()));
            
            if (itemIndex === -1) {
                addToOutput(`You're not carrying a ${itemName}.`);
                return;
            }
            
            const item = gameState.inventory[itemIndex];
            
            gameState.inventory.splice(itemIndex, 1);
            locations[gameState.currentLocation].items.push(item);
            
            if (item === "amulet of dawn") {
                player.hasAmuletOfDawn = false;
            }
            
            addToOutput(`You drop the ${item}.`);
        }
        
        // Examine object
        function examineObject(objectName) {
            if (!objectName) {
                addToOutput("Examine what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            const loc = locations[gameState.currentLocation];
            
            // Check inventory
            const inventoryItem = gameState.inventory.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (inventoryItem) {
                if (objectDescriptions[inventoryItem]) {
                    addToOutput(objectDescriptions[inventoryItem]);
                } else {
                    addToOutput(`You examine the ${inventoryItem}. It's in your inventory.`);
                }
                return;
            }
            
            // Check location items
            const locationItem = loc.items.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (locationItem) {
                if (objectDescriptions[locationItem]) {
                    addToOutput(objectDescriptions[locationItem]);
                } else {
                    addToOutput(`You examine the ${locationItem}.`);
                }
                return;
            }
            
            // Special tower examinations
            if (objectLower.includes("tapestry") && gameState.currentLocation === "towerEntrance") {
                addToOutput("You examine the ancient tapestries closely.");
                addToOutput("They depict battles between knights and dark creatures.");
                
                if (!gameState.secretDoorFound) {
                    addToOutput("Behind one tapestry, you notice a HIDDEN DOOR!", "secret");
                    gameState.secretDoorFound = true;
                    locations.towerEntrance.exits.north = "hiddenChamber";
                    addToOutput("You can now go NORTH to explore the hidden chamber!", "hint");
                }
                return;
            }
            
            if (objectLower.includes("wall") && gameState.currentLocation === "towerEntrance") {
                addToOutput("The stone walls are cold to the touch. Ancient torches once hung here.");
                addToOutput("You notice the TAPESTRIES might be worth examining more closely.", "hint");
                return;
            }
            
            // Check object descriptions
            if (objectDescriptions[objectLower]) {
                addToOutput(objectDescriptions[objectLower]);
                return;
            }
            
            // Partial matches
            for (const [objKey, description] of Object.entries(objectDescriptions)) {
                if (objKey.includes(objectLower) || objectLower.includes(objKey)) {
                    addToOutput(description);
                    return;
                }
            }
            
            // Direction check
            if (['north', 'south', 'east', 'west', 'up', 'down'].includes(objectLower)) {
                const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
                if (exits.includes(objectLower)) {
                    addToOutput(`You look ${objectLower}. You can go that way.`);
                } else {
                    addToOutput(`You look ${objectLower}. You cannot go that way.`);
                }
                return;
            }
            
            addToOutput(`You don't see a ${objectName} here.`);
        }
        
        // Use item
        function useItem(objectName) {
            if (!objectName) {
                addToOutput("Use what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Check if using amulet of dawn
            if (objectLower.includes("amulet") && gameState.inventory.includes("amulet of dawn")) {
                if (player.hasAmuletOfDawn) {
                    addToOutput("The amulet of dawn is already active. You feel its magic.", "magic");
                } else {
                    player.hasAmuletOfDawn = true;
                    addToOutput("You activate the amulet of dawn. Magic courses through you!", "magic");
                    addToOutput("You can now cast spells from your spellbook!", "hint");
                }
                return;
            }
            
            addToOutput(`You're not sure how to use the ${objectName} here.`);
        }
        
        // Open object
        function openObject(objectName) {
            if (!objectName) {
                addToOutput("Open what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            if (objectLower.includes("door") && gameState.currentLocation === "towerHallway") {
                if (!gameState.gargoyleDefeated) {
                    addToOutput("The gargoyle blocks the door! You must defeat it first.");
                } else {
                    addToOutput("The door opens easily now that the gargoyle is gone.");
                }
                return;
            }
            
            addToOutput(`You can't open the ${objectName}.`);
        }
        
        // Read object
        function readObject(objectName) {
            if (!objectName) {
                addToOutput("Read what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Read dusty scroll
            if (objectLower.includes("scroll") && gameState.inventory.includes("dusty scroll")) {
                if (!gameState.scrollRead) {
                    gameState.scrollRead = true;
                    addToOutput("You carefully unroll the dusty scroll and read:", "item");
                    addToOutput(" ");
                    addToOutput("'To the one who finds this...", "item");
                    addToOutput("The tower holds many secrets, but beware the guardian", "item");
                    addToOutput("that watches the library door. Only through strength", "item");
                    addToOutput("or cunning may you pass.'", "item");
                    addToOutput(" ");
                    addToOutput("The scroll crumbles to dust in your hands.", "hint");
                    
                    // Remove scroll from inventory
                    const scrollIndex = gameState.inventory.indexOf("dusty scroll");
                    if (scrollIndex > -1) {
                        gameState.inventory.splice(scrollIndex, 1);
                    }
                } else {
                    addToOutput("The scroll has already crumbled to dust.");
                }
                return;
            }
            
            // Read ancient tome
            if (objectLower.includes("tome") && gameState.inventory.includes("ancient tome")) {
                if (!gameState.tomeExamined) {
                    gameState.tomeExamined = true;
                    addToOutput("You open the ancient tome. The pages are filled with:", "magic");
                    addToOutput(" ");
                    addToOutput("- Rituals for summoning and banishing", "magic");
                    addToOutput("- Diagrams of magical circles", "magic");
                    addToOutput("- Spells of protection and warding", "magic");
                    addToOutput("- A chapter on 'The Amulet of Dawn'", "magic");
                    addToOutput(" ");
                    addToOutput("You learn the spell 'Ward of Protection'!", "magic");
                    
                    // Add spell to player's known spells
                    if (!player.spells.includes("ward of protection")) {
                        player.spells.push("ward of protection");
                    }
                } else {
                    addToOutput("You've already read the ancient tome.");
                }
                return;
            }
            
            // Read cursed map if player has it
            if (objectLower.includes("map") && gameState.inventory.includes("cursed map")) {
                addToOutput("You examine the cursed map of the castle tower:", "item");
                addToOutput(" ");
                
                // Show explored tower locations
                const explored = Object.entries(gameState.towerMapExplored)
                    .filter(([loc, explored]) => explored)
                    .map(([loc]) => loc.toUpperCase().replace('_', ' '));
                
                if (explored.length > 0) {
                    addToOutput("Explored locations:", "item");
                    explored.forEach(loc => addToOutput(`- ${loc}`, "item"));
                } else {
                    addToOutput("No tower locations explored yet.", "item");
                }
                
                addToOutput(" ");
                addToOutput("The map continues to update as you explore.", "hint");
                return;
            }
            
            addToOutput(`There's nothing to read on the ${objectName}.`);
        }
        
        // Talk to NPC
        function talkTo(objectName) {
            if (!objectName) {
                addToOutput("Talk to who?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            if ((objectLower.includes("gargoyle") || objectLower.includes("statue")) && 
                gameState.currentLocation === "towerHallway" && !gameState.gargoyleDefeated) {
                addToOutput("You speak to the stone gargoyle.", "player");
                addToOutput("The gargoyle's eyes glow red as it speaks in a gravelly voice:", "npc");
                addToOutput("'None shall pass to the forbidden library while I stand guard.'", "npc");
                addToOutput("'Turn back now, or face my stone wrath.'", "npc");
                return;
            }
            
            if ((objectLower.includes("shadow") || objectLower.includes("creature")) && combatActive) {
                addToOutput("The shadow creature only whispers incomprehensible dark words.", "enemy");
                return;
            }
            
            addToOutput("There's no one here to talk to.");
        }
        
        // Give item
        function giveItem(objectName) {
            if (!objectName) {
                addToOutput("Give what?");
                return;
            }
            
            const parts = objectName.toLowerCase().split(' to ');
            if (parts.length < 2) {
                addToOutput("Give what to whom?");
                return;
            }
            
            addToOutput("There's no one here to give anything to.");
        }
        
        // Attack enemy
        function attackEnemy(objectName) {
            if (!objectName) {
                addToOutput("Attack what?");
                return;
            }
            
            if (combatActive) {
                playerAttack();
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            if ((objectLower.includes("shadow") || objectLower.includes("creature")) && 
                gameState.currentLocation === "towerStairs" && loc.enemy === "shadowCreature") {
                startCombat("shadowCreature");
                return;
            }
            
            if ((objectLower.includes("gargoyle") || objectLower.includes("stone")) && 
                gameState.currentLocation === "towerHallway" && !gameState.gargoyleDefeated) {
                startCombat("gargoyle");
                return;
            }
            
            addToOutput("There's nothing to attack here.");
        }
        
        // Light lantern
        function lightLantern() {
            if (!gameState.inventory.includes("lantern")) {
                addToOutput("You don't have a lantern to light.");
                return;
            }
            
            addToOutput("You light the lantern. It casts a warm, flickering light.");
        }
        
        // Cast spell
        function castSpell(spellName) {
            if (!spellName) {
                addToOutput("Cast what spell?");
                return;
            }
            
            const spellLower = spellName.toLowerCase();
            
            // Check if player knows the spell
            const knownSpell = player.spells.find(spell => 
                spell.toLowerCase().includes(spellLower) || 
                spellLower.includes(spell.toLowerCase())
            );
            
            if (!knownSpell) {
                addToOutput(`You don't know the spell '${spellName}'.`, "magic");
                return;
            }
            
            // Check if player has amulet of dawn
            if (!player.hasAmuletOfDawn) {
                addToOutput(`Without the amulet of dawn you have no magical ability to spellcast.`, "magic");
                return;
            }
            
            // If player has amulet, implement spell effects
            addToOutput(`You cast ${knownSpell.toUpperCase()}!`, "magic");
            
            // Spell effects
            switch(knownSpell.toLowerCase()) {
                case "blood drain":
                    if (combatActive && currentEnemy) {
                        const drainAmount = Math.floor(Math.random() * 5) + 3;
                        currentEnemy.currentHP -= drainAmount;
                        player.currentHP = Math.min(player.maxHP, player.currentHP + Math.floor(drainAmount / 2));
                        addToOutput(`You drain ${drainAmount} HP from ${currentEnemy.name}!`, "magic");
                        addToOutput(`You heal ${Math.floor(drainAmount / 2)} HP.`, "health");
                        
                        if (currentEnemy.currentHP <= 0) {
                            endCombat(true);
                        } else {
                            addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
                        }
                        updateStatus();
                    } else {
                        addToOutput("The spell has no effect here.", "magic");
                    }
                    break;
                case "moon rising":
                    addToOutput("Moonlight fills the area, revealing hidden details.", "magic");
                    // Could reveal hidden items or paths
                    break;
                case "night glare":
                    if (combatActive && currentEnemy) {
                        addToOutput(`A flash of dark light blinds ${currentEnemy.name}!`, "magic");
                        addToOutput("The enemy is stunned and misses its next turn!", "magic");
                    } else {
                        addToOutput("The spell has no effect here.", "magic");
                    }
                    break;
                case "mist of souls":
                    addToOutput("A protective mist of lost souls swirls around you.", "magic");
                    addToOutput("You feel protected from harm.", "magic");
                    break;
                case "ward of protection":
                    addToOutput("A shimmering ward forms around you.", "magic");
                    addToOutput("You feel magically protected.", "magic");
                    // Could implement temporary damage reduction
                    break;
                default:
                    addToOutput(`The spell ${knownSpell} has no effect here.`, "magic");
            }
        }
        
        // Wear item
        function wearItem(itemName) {
            if (!itemName) {
                addToOutput("Wear what?");
                return;
            }
            
            const objectLower = itemName.toLowerCase();
            
            if ((objectLower.includes("robe") || objectLower.includes("dusty")) && 
                gameState.inventory.includes("dusty robe")) {
                addToOutput("You put on the dusty robe.", "player");
                addToOutput("It offers minimal protection but makes you look more wizardly.", "hint");
                return;
            }
            
            if (objectLower.includes("amulet") && gameState.inventory.includes("amulet of dawn")) {
                useItem("amulet of dawn");
                return;
            }
            
            addToOutput(`You can't wear ${itemName}.`);
        }
        
        // Remove item
        function removeItem(itemName) {
            if (!itemName) {
                addToOutput("Remove what?");
                return;
            }
            
            const objectLower = itemName.toLowerCase();
            
            if (objectLower.includes("amulet") && player.hasAmuletOfDawn) {
                player.hasAmuletOfDawn = false;
                addToOutput("You remove the amulet of dawn. The magical energy fades.", "magic");
                return;
            }
            
            addToOutput(`You're not wearing ${itemName}.`);
        }
        
        // Show help
        function showHelp() {
            addToOutput("CASTLE TOWER - COMMANDS", "location");
            addToOutput("Movement: NORTH, SOUTH, EAST, WEST, UP, DOWN (or N, S, E, W, U, D)");
            addToOutput("Basic: LOOK, EXAMINE [object], TAKE [item], DROP [item], INVENTORY");
            addToOutput("Interactive: USE [item], OPEN [object], READ [object], TALK [NPC]");
            addToOutput("Magic: CAST [spell name] (requires spellbook and amulet of dawn)", "magic");
            addToOutput("Equipment: WEAR [item], REMOVE [item]");
            addToOutput("COMBAT: ATTACK (in combat)", "combat");
            addToOutput("Other: HELP, QUIT");
            addToOutput(" ");
            addToOutput("TOWER EXPLORATION TIPS:", "hint");
            addToOutput("- Examine everything carefully, especially tapestries", "hint");
            addToOutput("- Defeat enemies to progress through the tower", "hint");
            addToOutput("- Find the amulet of dawn to unlock spellcasting", "magic");
            addToOutput("- Read scrolls and tomes for clues and new spells", "hint");
            addToOutput("- The map updates as you explore new areas", "item");
        }
        
        // Quit game
        function quitGame() {
            addToOutput("Are you sure you want to quit? (Y/N)");
            
            const originalEventHandler = gameInput.onkeypress;
            
            gameInput.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    const answer = this.value.trim().toLowerCase();
                    if (answer === 'y' || answer === 'yes') {
                        addToOutput("Thanks for exploring the Castle Tower!");
                        gameState.gameEnded = true;
                    } else {
                        addToOutput("Resuming game...");
                    }
                    
                    gameInput.onkeypress = originalEventHandler;
                    gameInput.value = '';
                    gameInput.focus();
                }
            };
        }
        
        window.onload = initGame;
    </script>
</body>
</html>
