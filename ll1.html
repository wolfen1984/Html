<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASTLE OF THE DAMNED - Level 1: Outside the Castle Gates</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Outside Castle theme (Dark Green/Black/Gray) */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(30, 60, 30, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 60, 30, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #80ff80;
            background-color: #000;
            box-shadow: 0 0 20px rgba(0, 128, 0, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(30, 60, 30, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #006600;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #80ff80;
            text-shadow: 0 0 5px #006600;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #80ff80;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #80ff80;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #003300;
            color: #80ff80;
            border-color: #80ff80;
        }
        
        .level-number.current {
            background-color: #006600;
            color: #fff;
            border-color: #80ff80;
            box-shadow: 0 0 8px #006600;
            text-shadow: 0 0 2px #000;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #80ff80;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #80ff80;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #80ff80;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #80ff80;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #80ff80;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #80ff80;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #80ff80;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #80ff80;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #80ff80;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #80ff80;
            border-color: #80ff80;
            box-shadow: 0 0 10px rgba(128, 255, 128, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #006600;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #80ff80;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #80ff80;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #80ff80;
            border-color: #80ff80;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #002200;
            border: 1px solid #006600;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #80ff80;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #003300;
            border: 1px solid #80ff80;
            padding: 10px;
            margin: 10px 0;
            color: #80ff80;
        }
        
        /* Class Selection */
        .class-selection {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        .class-option {
            background-color: #111;
            border: 2px solid #006600;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .class-option:hover, .class-option.selected {
            background-color: #222;
            border-color: #80ff80;
            box-shadow: 0 0 10px rgba(128, 255, 128, 0.3);
        }
        
        .class-name {
            color: #80ff80;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .class-desc {
            color: #ccc;
            font-size: 14px;
            line-height: 1.4;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #8ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        .ghost {
            color: #aaf;
            font-weight: bold;
            text-shadow: 0 0 3px #aaf;
        }
        
        .wolf {
            color: #aaa;
            font-weight: bold;
            text-shadow: 0 0 3px #aaa;
        }
        
        .zombie {
            color: #8f8;
            font-weight: bold;
            text-shadow: 0 0 3px #8f8;
        }
        
        .skeleton {
            color: #ccc;
            font-weight: bold;
            text-shadow: 0 0 3px #ccc;
        }
        
        .wraith {
            color: #8af;
            font-weight: bold;
            text-shadow: 0 0 3px #8af;
        }
        
        .lich {
            color: #6f6;
            font-weight: bold;
            text-shadow: 0 0 3px #6f6;
        }
        
        .bandit {
            color: #f90;
            font-weight: bold;
        }
        
        .farmer {
            color: #cc9;
            font-weight: bold;
        }
        
        .merchant {
            color: #fc6;
            font-weight: bold;
        }
        
        .guard {
            color: #69f;
            font-weight: bold;
        }
        
        .knight {
            color: #fff;
            font-weight: bold;
            text-shadow: 0 0 3px #fff;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #006600;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            fontSize: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #006600;
            color: #fff;
            border-color: #80ff80;
            box-shadow: 0 0 15px #006600;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #006600;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #006600;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #80ff80;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
        
        /* Character Stats Display */
        .character-stats-display {
            background-color: #111;
            border: 1px solid #006600;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }
        
        .character-stats-display.show {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #80ff80;
            font-weight: bold;
        }
        
        .stat-value {
            color: #fff;
            font-weight: bold;
        }
        
        .confirm-button {
            display: none;
            background-color: #006600;
            color: #fff;
            border: 2px solid #80ff80;
            padding: 15px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            margin: 20px 0;
            text-align: center;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
        }
        
        .confirm-button:hover, .confirm-button:active {
            background-color: #80ff80;
            color: #000;
            border-color: #fff;
            box-shadow: 0 0 15px #80ff80;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CASTLE OF THE DAMNED</h1>
            <h2>LEVEL 1: OUTSIDE THE CASTLE GATES</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number current">1</div>
            <div class="level-number">2</div>
            <div class="level-number">3</div>
            <div class="level-number">4</div>
            <div class="level-number">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Character Creation Screen -->
        <div id="screen-character" class="screen active-screen">
            <h2>CHARACTER CREATION</h2>
            <div class="story-text">
                <p>Welcome to CASTLE OF THE DAMNED. For generations, Castle Vorlak has loomed over the valley, a place of dread and dark legends. Its master, the vampire lord Valerius, has grown powerful and cruel.</p>
                <p>Recently, entire villages have gone silent. Travelers disappear on the mountain road. The dead no longer rest peacefully in their graves.</p>
                <p>You have come to end the terror. Choose your path:</p>
                
                <div class="class-selection">
                    <div class="class-option" onclick="selectClass('warrior')" id="warrior-option">
                        <div class="class-name">WARRIOR</div>
                        <div class="class-desc">A battle-hardened veteran skilled with blade and shield. Warriors have high strength and health, making them formidable in combat but less agile. Starts with a Longsword and Iron Armor.</div>
                    </div>
                    <div class="class-option" onclick="selectClass('rogue')" id="rogue-option">
                        <div class="class-name">ROGUE</div>
                        <div class="class-desc">A stealthy opportunist with quick reflexes and a knack for finding valuable items. Rogues have high agility and start with more gold, but lower strength. Starts with Dual Daggers and Leather Armor.</div>
                    </div>
                    <div class="class-option" onclick="selectClass('hunter')" id="hunter-option">
                        <div class="class-name">HUNTER</div>
                        <div class="class-desc">A wilderness tracker skilled with bow and trap. Hunters are balanced between strength and agility, with a keen eye for opportunity. Starts with a Hunting Bow and Studded Leather Armor.</div>
                    </div>
                    <div class="class-option" onclick="selectClass('priest')" id="priest-option">
                        <div class="class-name">PRIEST</div>
                        <div class="class-desc">A holy warrior devoted to driving back the darkness. Priests have abilities that harm the undead and can heal themselves, but are weaker in physical combat. Starts with a Mace and Chainmail Armor.</div>
                    </div>
                </div>
                
                <!-- Character Stats Display (hidden by default) -->
                <div class="character-stats-display" id="character-stats">
                    <div class="stat-row">
                        <span class="stat-label">CLASS:</span>
                        <span class="stat-value" id="selected-class-name">None</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">STRENGTH:</span>
                        <span class="stat-value" id="selected-strength">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">AGILITY:</span>
                        <span class="stat-value" id="selected-agility">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">HEALTH:</span>
                        <span class="stat-value" id="selected-health">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">STARTING GOLD:</span>
                        <span class="stat-value" id="selected-gold">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">WEAPON:</span>
                        <span class="stat-value" id="selected-weapon">None</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">ARMOR:</span>
                        <span class="stat-value" id="selected-armor">None</span>
                    </div>
                </div>
                
                <p id="selection-instruction">Click on a class to select it, then confirm your choice.</p>
                
                <!-- Confirm Button (hidden by default) -->
                <button class="confirm-button" id="confirm-button" onclick="confirmClassSelection()">CONFIRM CHARACTER SELECTION</button>
            </div>
        </div>
        
        <!-- Game Intro Screen -->
        <div id="screen-intro" class="screen">
            <h2>OUTSIDE THE CASTLE GATES</h2>
            <div class="story-text">
                <p>The road to Castle Vorlak winds through the dark forest, the trees growing increasingly twisted and gnarled as you approach. An unnatural chill hangs in the air, despite the midday sun struggling through thick clouds.</p>
                <p>You stand before the massive, rusted iron gates of the castle grounds. The gates hang partially open, creaking ominously in the wind. Beyond, you can see the path leading to the castle itself, a monstrous structure of black stone that seems to absorb the light around it.</p>
                <p>The grounds are overgrown with thorny vines and pale, sickly-looking plants. No birds sing here. The only sounds are the wind and the distant howling of what might be wolves... or something worse.</p>
                <p>You've heard the stories. The missing villagers. The cursed ground. The vampire lord Valerius who rules from within. You've come prepared, but nothing could fully prepare you for the palpable evil that radiates from this place.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="intro-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="intro-stat-health" class="stat-value">0</span>/<span id="intro-stat-maxhealth" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="intro-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="intro-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="startGame()">ENTER THE CASTLE GROUNDS</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>CASTLE GROUNDS</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL 1 COMPLETE!</h2>
            <div class="story-text">
                <p>You have braved the dangers outside Castle Vorlak and found your way to the entrance!</p>
                <p>The massive oak doors of the castle loom before you, carved with disturbing scenes of torment and bloodshed. A cold wind seems to whisper from within, carrying the scent of dust, decay, and something metallic.</p>
                <p>This is just the beginning. Within these walls lie horrors beyond imagination, traps set for the unwary, and the vampire lord Valerius himself.</p>
                <p>All your stats, gold, and inventory will carry over to Level 2: The Grand Entrance Hall.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #002200; border: 1px solid #006600;">
                    <h3 style="color: #80ff80; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">ENTER THE CASTLE - LEVEL 2</button>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE DAMNED - A Retro Vampire Hunt Adventure<br>
            Level 1: Outside the Castle Gates
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'forest':
                    playBeep(300, 0.5, 'sine');
                    setTimeout(() => playBeep(200, 0.5, 'sine'), 500);
                    break;
                case 'wolf':
                    playBeep(150, 0.3, 'sawtooth');
                    setTimeout(() => playBeep(100, 0.3, 'sawtooth'), 300);
                    break;
                case 'bandit':
                    playBeep(500, 0.2, 'square');
                    setTimeout(() => playBeep(400, 0.2, 'square'), 200);
                    break;
                case 'zombie':
                    playBeep(100, 0.4, 'sawtooth');
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'None',
            equippedArmor: 'None',
            currentSection: 1,
            gameComplete: false,
            level: 1,
            // Level 1 specific flags
            gateOpened: false,
            guardhouseSearched: false,
            merchantHelped: false,
            banditsDefeated: false,
            cryptExplored: false,
            zombieDefeated: false,
            // Special items
            hasGateKey: false,
            hasHealingPotion: false,
            hasSilverCross: false,
            hasGuardhouseNote: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            isGroup: false,
            groupCount: 0
        };
        
        // Class definitions
        const classes = {
            warrior: {
                name: 'Warrior',
                strength: 18,
                agility: 12,
                maxHealth: 40,
                gold: 20,
                weapon: 'Longsword',
                armor: 'Iron Armor',
                description: 'Battle-hardened veteran skilled with blade and shield.'
            },
            rogue: {
                name: 'Rogue',
                strength: 14,
                agility: 18,
                maxHealth: 30,
                gold: 50,
                weapon: 'Dual Daggers',
                armor: 'Leather Armor',
                description: 'Stealthy opportunist with quick reflexes.'
            },
            hunter: {
                name: 'Hunter',
                strength: 16,
                agility: 16,
                maxHealth: 35,
                gold: 30,
                weapon: 'Hunting Bow',
                armor: 'Studded Leather Armor',
                description: 'Wilderness tracker skilled with bow and trap.'
            },
            priest: {
                name: 'Priest',
                strength: 15,
                agility: 14,
                maxHealth: 35,
                gold: 25,
                weapon: 'Mace',
                armor: 'Chainmail Armor',
                description: 'Holy warrior devoted to driving back darkness.'
            }
        };
        
        // Track selected class
        let selectedClass = null;
        
        // Initialize game
        function initGame() {
            // Check for saved game
            const savedGame = localStorage.getItem('castleDamnedGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // If saved level is 1, load it
                if (savedState.level === 1) {
                    Object.assign(gameState, savedState);
                    
                    // Update intro screen with loaded stats
                    document.getElementById('intro-stat-strength').textContent = gameState.strength;
                    document.getElementById('intro-stat-health').textContent = gameState.health;
                    document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('intro-stat-agility').textContent = gameState.agility;
                    document.getElementById('intro-stat-gold').textContent = gameState.gold;
                    
                    // If character already created, show intro screen
                    if (gameState.playerClass) {
                        showScreen('screen-intro');
                    } else {
                        showScreen('screen-character');
                    }
                    return;
                } else {
                    // If saved level is not 1, redirect to appropriate level
                    window.location.href = 'l' + savedState.level + '.html';
                    return;
                }
            } else {
                // No saved game, start fresh
                showScreen('screen-character');
            }
        }
        
        // Select character class
        function selectClass(className) {
            playSound('click');
            const classInfo = classes[className];
            selectedClass = className;
            
            // Remove selected class from all options
            document.querySelectorAll('.class-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            document.getElementById(className + '-option').classList.add('selected');
            
            // Update character stats display
            document.getElementById('selected-class-name').textContent = classInfo.name;
            document.getElementById('selected-strength').textContent = classInfo.strength;
            document.getElementById('selected-agility').textContent = classInfo.agility;
            document.getElementById('selected-health').textContent = classInfo.maxHealth;
            document.getElementById('selected-gold').textContent = classInfo.gold;
            document.getElementById('selected-weapon').textContent = classInfo.weapon;
            document.getElementById('selected-armor').textContent = classInfo.armor;
            
            // Show stats display
            document.getElementById('character-stats').classList.add('show');
            
            // Update instruction text
            document.getElementById('selection-instruction').innerHTML = 
                `Selected: <span style="color:#80ff80">${classInfo.name}</span>. Click "Confirm" to proceed.`;
            
            // Show confirm button
            document.getElementById('confirm-button').style.display = 'block';
        }
        
        // Confirm class selection
        function confirmClassSelection() {
            if (!selectedClass) {
                alert("Please select a class first!");
                return;
            }
            
            playSound('click');
            const classInfo = classes[selectedClass];
            
            // Update game state with selected class
            gameState.playerClass = selectedClass;
            gameState.strength = classInfo.strength;
            gameState.agility = classInfo.agility;
            gameState.maxHealth = classInfo.maxHealth;
            gameState.health = classInfo.maxHealth;
            gameState.gold = classInfo.gold;
            gameState.equippedWeapon = classInfo.weapon;
            gameState.equippedArmor = classInfo.armor;
            
            // Add starting equipment to inventory
            addToInventory(classInfo.weapon);
            addToInventory(classInfo.armor);
            
            // Save the character creation
            saveGame();
            
            // Show intro screen
            showScreen('screen-intro');
            
            // Update intro screen stats display
            document.getElementById('intro-stat-strength').textContent = gameState.strength;
            document.getElementById('intro-stat-health').textContent = gameState.health;
            document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('intro-stat-agility').textContent = gameState.agility;
            document.getElementById('intro-stat-gold').textContent = gameState.gold;
        }
        
        function startGame() {
            playSound('click');
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
            
            // Scroll to top when changing screens
            window.scrollTo(0, 0);
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item) && item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            if (gameState.equippedWeapon !== 'None') {
                const equippedWeapon = document.createElement('div');
                equippedWeapon.className = 'inventory-item equipped';
                equippedWeapon.textContent = gameState.equippedWeapon;
                equippedWeapon.onclick = () => {
                    playSound('click');
                    document.getElementById('story-text').innerHTML += 
                        `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
                };
                inventoryDiv.appendChild(equippedWeapon);
            }
            
            if (gameState.equippedArmor !== 'None') {
                const equippedArmor = document.createElement('div');
                equippedArmor.className = 'inventory-item equipped';
                equippedArmor.textContent = gameState.equippedArmor;
                equippedArmor.onclick = () => {
                    playSound('click');
                    document.getElementById('story-text').innerHTML += 
                        `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
                };
                inventoryDiv.appendChild(equippedArmor);
            }
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 
                (gameState.equippedWeapon !== 'None' ? 1 : 0) + 
                (gameState.equippedArmor !== 'None' ? 1 : 0);
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item.includes('Healing Potion') || item === 'Medicinal Herbs') {
                let healAmount = 0;
                
                if (item === 'Healing Potion (Half Full)') {
                    healAmount = rollDice(2, 6) + 2;
                    removeFromInventory(item);
                    gameState.hasHealingPotion = false;
                } else if (item === 'Medicinal Herbs') {
                    healAmount = rollDice(1, 6) + 1;
                    removeFromInventory(item);
                }
                
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                
                updateStatsDisplay();
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
            } else if (item.includes('Silver Cross')) {
                message = "The <span class='item'>" + item + "</span> feels warm in your hand. It should offer protection against undead creatures.";
            } else if (item === 'Rusty Iron Key') {
                message = "The <span class='item'>Rusty Iron Key</span> is heavy and cold. It might unlock the castle doors.";
            } else if (item === 'Silver Bat Amulet') {
                message = "The <span class='item'>Silver Bat Amulet</span> is beautifully crafted. Bats are associated with vampires - this might have significance inside the castle.";
            } else if (item === 'Discarded Adventurer Pack' || item === 'Bandit Loot Collection' || item === 'Old Storage Crate Contents') {
                message = `The <span class='item'>${item}</span> contains various useful supplies and items.`;
            } else if (item === 'Captain Vorlak\'s Note') {
                message = "The note reads: 'The dead walk. The gates are barred. I can hear them scratching at the doors. May God have mercy on our souls. - Last entry of Captain Vorlak'";
            } else if (item === 'Knowledge of Vorlak Family') {
                message = "You recall the Vorlak family history: an ancient noble line that fell to vampirism centuries ago.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'None' && 
                gameState.equippedArmor === 'None') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            if (gameState.equippedWeapon !== 'None' || gameState.equippedArmor !== 'None') {
                itemText += `<br><strong>Equipped:</strong><br>`;
                if (gameState.equippedWeapon !== 'None') {
                    itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
                }
                if (gameState.equippedArmor !== 'None') {
                    itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
                }
            }
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Game story sections for Level 1
        const storySections = {
            1: {
                text: "You stand before the rusted iron gates of Castle Vorlak. The gates hang partially open, but something heavy blocks them from opening further. The path beyond winds through overgrown gardens toward the castle itself. To your left, a small guardhouse sits crumbling. To your right, a path leads toward what looks like a family crypt.",
                choices: [
                    {text: "Try to force the gates open", nextSection: 2, skillCheck: false},
                    {text: "Investigate the guardhouse", nextSection: 3, skillCheck: false},
                    {text: "Follow the path to the crypt", nextSection: 4, skillCheck: false},
                    {text: "Search the immediate area around the gates", nextSection: 5, skillCheck: false}
                ],
                action: function() {
                    playSound('forest');
                    return "A cold wind whispers through the gates, carrying the scent of decay.";
                }
            },
            2: {
                text: "You push against the heavy iron gates. They groan in protest but don't budge. Looking closer, you see they're blocked from the inside by a heavy wooden beam.",
                choices: [
                    {text: "Try to break the beam from this side", nextSection: 6, skillCheck: true, checkType: 'strength', difficulty: 16},
                    {text: "Look for another way past the gates", nextSection: 7, skillCheck: false},
                    {text: "Check the guardhouse for tools", nextSection: 3, skillCheck: false},
                    {text: "Return to examining the area", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('forest');
                    return "The gates are old but still sturdy. The beam looks like it was placed recently.";
                }
            },
            3: {
                text: "The guardhouse is small and mostly collapsed. The roof has caved in, and vines have overtaken the walls. Inside, you see the remains of furniture and what might have been a weapon rack.",
                choices: [
                    {text: "Search the guardhouse thoroughly", nextSection: 8, skillCheck: false},
                    {text: "Return to the gates", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('forest');
                    return "Something glints in the rubble...";
                }
            },
            4: {
                text: "You follow the overgrown path to a small family crypt. The stone building is covered in moss and ivy. The iron door stands slightly ajar.",
                choices: [
                    {text: "Enter the crypt", nextSection: 9, skillCheck: false},
                    {text: "Examine the outside of the crypt", nextSection: 10, skillCheck: false},
                    {text: "Return to the gates", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('forest');
                    return "The air grows colder as you approach the crypt.";
                }
            },
            5: {
                text: "You search the area around the gates. Among the weeds and dead leaves, you find signs of recent activity: footprints, broken branches, and the remains of a campfire.",
                choices: [
                    {text: "Follow the footprints", nextSection: 11, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Examine the campfire remains", nextSection: 12, skillCheck: false},
                    {text: "Return to the gates", nextSection: 1, skillCheck: false}
                ]
            },
            6: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 13, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.gateOpened = true;
                        return "With a mighty heave, you break the wooden beam! The gates swing open with a tortured screech of rusted metal.";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You strain against the beam but it doesn't give. You pull a muscle in the attempt, taking " + damage + " damage.";
                    }
                }
            },
            7: {
                text: "You look for another way past the gates. The walls are too high to climb, and the iron spikes atop them look deadly sharp. However, you notice a section of the wall to the left of the gates where the stones have crumbled, creating a possible climbing point.",
                choices: [
                    {text: "Try to climb the damaged wall", nextSection: 14, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Return to forcing the gates", nextSection: 2, skillCheck: false},
                    {text: "Check the guardhouse", nextSection: 3, skillCheck: false}
                ],
                action: function() {
                    return "The climb looks treacherous but possible for someone agile.";
                }
            },
            8: {
                text: "You search through the rubble of the guardhouse. Under broken furniture and fallen stones, you find several items of interest.",
                choices: [
                    {text: "Take the iron key", nextSection: 15, skillCheck: false},
                    {text: "Take the healing potion", nextSection: 16, skillCheck: false},
                    {text: "Take the note", nextSection: 17, skillCheck: false},
                    {text: "Take everything", nextSection: 18, skillCheck: false},
                    {text: "Leave the guardhouse", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.guardhouseSearched = true;
                    playSound('item');
                    return "You find: <br>- A rusty iron key<br>- A cracked vial of red liquid (healing potion)<br>- A faded note";
                }
            },
            9: {
                text: "You push open the crypt door and step inside. The air is cold and still, heavy with the smell of damp earth and decay. The crypt contains several stone sarcophagi. One lies open, its contents missing.",
                choices: [
                    {text: "Search the crypt", nextSection: 19, skillCheck: false},
                    {text: "Examine the open sarcophagus", nextSection: 20, skillCheck: false},
                    {text: "Leave the crypt quickly", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('forest');
                    return "Your footsteps echo ominously in the small stone chamber.";
                }
            },
            10: {
                text: "You examine the outside of the crypt. The stonework is ancient but well-crafted. Carvings depict a noble family - the Vorlaks. One carving shows a lord receiving guests, another shows a burial ceremony. The most recent stone has dates from just a few years ago.",
                choices: [
                    {text: "Enter the crypt", nextSection: 9, skillCheck: false},
                    {text: "Return to the gates", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Knowledge of Vorlak Family');
                    return "You gain knowledge about the Vorlak family history.";
                }
            },
            11: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You follow the footprints quietly. They lead to a small clearing where you spot a figure huddled by a tree...";
                    } else {
                        playSound('failure');
                        return "You lose the trail in the thick undergrowth. The footprints disappear into the forest.";
                    }
                }
            },
            12: {
                text: "You examine the campfire remains. The ashes are cold but not ancient - someone camped here within the last few days. Among the ashes, you find a broken silver cross and a few copper coins.",
                choices: [
                    {text: "Take the silver cross", nextSection: 22, skillCheck: false},
                    {text: "Take the copper coins", nextSection: 23, skillCheck: false},
                    {text: "Follow the footprints", nextSection: 11, skillCheck: false}
                ],
                action: function() {
                    const goldFound = 5;
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find " + goldFound + " gold in copper coins.";
                }
            },
            13: {
                text: "With the gates now open, you can proceed into the castle grounds. The path beyond winds through overgrown gardens toward the massive oak doors of the castle itself.",
                choices: [
                    {text: "Proceed up the path", nextSection: 24, skillCheck: false},
                    {text: "Search the area first", nextSection: 25, skillCheck: false}
                ]
            },
            14: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 26, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.gateOpened = true;
                        return "You carefully climb the damaged section of wall and drop down on the other side. You're now inside the castle grounds!";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You slip while climbing and fall, taking " + damage + " damage. The wall is too difficult to climb.";
                    }
                }
            },
            15: {
                text: "You take the rusty iron key. It feels cold and heavy in your hand.",
                choices: [
                    {text: "Take the healing potion", nextSection: 16, skillCheck: false},
                    {text: "Take the note", nextSection: 17, skillCheck: false},
                    {text: "Leave the guardhouse", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.hasGateKey = true;
                    addToInventory('Rusty Iron Key');
                    playSound('item');
                    return "You take the <span class='item'>Rusty Iron Key</span>. It might unlock something.";
                }
            },
            16: {
                text: "You take the cracked vial of red liquid. It sloshes gently - about half full.",
                choices: [
                    {text: "Take the iron key", nextSection: 15, skillCheck: false},
                    {text: "Take the note", nextSection: 17, skillCheck: false},
                    {text: "Leave the guardhouse", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.hasHealingPotion = true;
                    addToInventory('Healing Potion (Half Full)');
                    playSound('item');
                    return "You take the <span class='item'>Healing Potion (Half Full)</span>. It might restore some health.";
                }
            },
            17: {
                text: "You take the faded note and try to read it. The handwriting is rushed and panicked: 'The dead walk. The gates are barred. I can hear them scratching at the doors. May God have mercy on our souls. - Last entry of Captain Vorlak'",
                choices: [
                    {text: "Take the iron key", nextSection: 15, skillCheck: false},
                    {text: "Take the healing potion", nextSection: 16, skillCheck: false},
                    {text: "Leave the guardhouse", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.hasGuardhouseNote = true;
                    addToInventory('Captain Vorlak\'s Note');
                    playSound('item');
                    return "You take <span class='item'>Captain Vorlak's Note</span>. It tells a grim story.";
                }
            },
            18: {
                text: "You take everything from the guardhouse.",
                choices: [
                    {text: "Leave the guardhouse", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.hasGateKey = true;
                    gameState.hasHealingPotion = true;
                    gameState.hasGuardhouseNote = true;
                    addToInventory('Rusty Iron Key');
                    addToInventory('Healing Potion (Half Full)');
                    addToInventory('Captain Vorlak\'s Note');
                    playSound('item');
                    return "You take everything: <span class='item'>Rusty Iron Key</span>, <span class='item'>Healing Potion (Half Full)</span>, and <span class='item'>Captain Vorlak's Note</span>.";
                }
            },
            19: {
                text: "You search the crypt thoroughly. Aside from the stone sarcophagi, you find burial offerings on a small altar: a silver goblet, some tarnished jewelry, and a few old coins.",
                choices: [
                    {text: "Take the silver goblet", nextSection: 27, skillCheck: false},
                    {text: "Take the jewelry", nextSection: 28, skillCheck: false},
                    {text: "Examine the open sarcophagus", nextSection: 20, skillCheck: false}
                ],
                action: function() {
                    gameState.cryptExplored = true;
                    const goldFound = rollDice(2, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find " + goldFound + " gold in old coins on the altar.";
                }
            },
            20: {
                text: "You examine the open sarcophagus. The stone lid lies broken on the floor. Inside, you see the remains of burial shrouds, but the body is missing. Deep scratch marks cover the inside of the stone coffin.",
                choices: [
                    {text: "Search the sarcophagus", nextSection: 29, skillCheck: false},
                    {text: "Back away slowly", nextSection: 9, skillCheck: false}
                ],
                action: function() {
                    playSound('forest');
                    return "The scratch marks look like they were made from the inside...";
                }
            },
            21: {
                text: "You come upon a small clearing. A wounded man leans against a tree, clutching his side. He wears tattered merchant's clothes and looks pale from blood loss.",
                choices: [
                    {text: "Approach the wounded man", nextSection: 30, skillCheck: false},
                    {text: "Watch from a distance", nextSection: 31, skillCheck: false},
                    {text: "Leave quietly", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    return "<span class='merchant'>Wounded Merchant:</span> 'Who... who's there? Help me... please...'";
                }
            },
            22: {
                text: "You take the broken silver cross. Even broken, it feels warm in your hand.",
                choices: [
                    {text: "Take the copper coins", nextSection: 23, skillCheck: false},
                    {text: "Follow the footprints", nextSection: 11, skillCheck: false}
                ],
                action: function() {
                    gameState.hasSilverCross = true;
                    addToInventory('Broken Silver Cross');
                    playSound('item');
                    return "You take the <span class='item'>Broken Silver Cross</span>. It might have protective properties against the undead.";
                }
            },
            23: {
                text: "You take the copper coins from the ashes.",
                choices: [
                    {text: "Take the silver cross", nextSection: 22, skillCheck: false},
                    {text: "Follow the footprints", nextSection: 11, skillCheck: false}
                ],
                action: function() {
                    const goldFound = 8;
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find " + goldFound + " gold in copper coins.";
                }
            },
            24: {
                text: "You follow the path through the overgrown gardens. Statues of grotesque creatures line the path, their stone features twisted in agony or rage. The castle looms larger with every step.",
                choices: [
                    {text: "Continue toward the castle", nextSection: 32, skillCheck: false},
                    {text: "Examine the statues", nextSection: 33, skillCheck: false},
                    {text: "Search the gardens", nextSection: 34, skillCheck: false}
                ],
                action: function() {
                    playSound('forest');
                    return "The castle seems to watch your approach, its dark windows like empty eye sockets.";
                }
            },
            25: {
                text: "You search the area just inside the gates. Among the weeds, you find a discarded pack. It contains some supplies and a small amount of gold.",
                choices: [
                    {text: "Proceed up the path", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    addToInventory('Discarded Adventurer Pack');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find a <span class='item'>Discarded Adventurer Pack</span> containing " + goldFound + " gold and basic supplies.";
                }
            },
            26: {
                text: "After climbing the wall, you find yourself inside the castle grounds.",
                choices: [
                    {text: "Proceed up the path", nextSection: 24, skillCheck: false},
                    {text: "Search the area first", nextSection: 25, skillCheck: false}
                ]
            },
            27: {
                text: "You take the silver goblet from the altar. It's heavy and ornate, worth a good amount.",
                choices: [
                    {text: "Take the jewelry", nextSection: 28, skillCheck: false},
                    {text: "Examine the open sarcophagus", nextSection: 20, skillCheck: false},
                    {text: "Leave the crypt", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Silver Goblet');
                    playSound('item');
                    return "You take the <span class='item'>Silver Goblet</span>. It's valuable but heavy.";
                }
            },
            28: {
                text: "You take the tarnished jewelry from the altar.",
                choices: [
                    {text: "Take the silver goblet", nextSection: 27, skillCheck: false},
                    {text: "Examine the open sarcophagus", nextSection: 20, skillCheck: false},
                    {text: "Leave the crypt", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Tarnished Burial Jewelry');
                    const goldFound = rollDice(1, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You take <span class='item'>Tarnished Burial Jewelry</span> worth " + goldFound + " gold.";
                }
            },
            29: {
                text: "You reach into the sarcophagus to search for anything valuable. Your hand brushes against something cold and soft... and then something grabs your wrist! A pale, rotting hand emerges from the shadows of the coffin!",
                choices: [
                    {text: "Fight the creature", nextSection: 35, skillCheck: false},
                    {text: "Try to pull free and run", nextSection: 36, skillCheck: true, checkType: 'agility', difficulty: 16}
                ],
                action: function() {
                    playSound('zombie');
                    return "<span class='zombie'>A zombie rises from the shadows of the crypt!</span>";
                }
            },
            30: {
                text: "<span class='merchant'>'Thank goodness...'</span> the merchant gasps. <span class='merchant'>'Bandits attacked my caravan... I barely escaped. They took everything... even my silver cross for protection.'</span>",
                choices: [
                    {text: "Offer to help him", nextSection: 37, skillCheck: false},
                    {text: "Ask about the bandits", nextSection: 38, skillCheck: false},
                    {text: "Give him your healing potion if you have one", nextSection: 39, skillCheck: false, requirement: function() { 
                        return gameState.hasHealingPotion || gameState.inventory.some(item => item.includes('Healing Potion'));
                    }},
                    {text: "Leave him", nextSection: 1, skillCheck: false}
                ]
            },
            31: {
                text: "You watch from a distance. The wounded man seems genuine, but you can't be sure. After a few minutes, he slumps over, unconscious or dead.",
                choices: [
                    {text: "Approach cautiously", nextSection: 40, skillCheck: false},
                    {text: "Leave quietly", nextSection: 1, skillCheck: false}
                ]
            },
            32: {
                text: "You reach the massive oak doors of Castle Vorlak. They're twice your height and banded with iron. Strange symbols are carved into the dark wood. The doors are shut tight.",
                choices: [
                    {text: "Try to open the doors", nextSection: 41, skillCheck: false},
                    {text: "Examine the carvings", nextSection: 42, skillCheck: false},
                    {text: "Search for another entrance", nextSection: 43, skillCheck: false},
                    {text: "Return to the gardens", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    playSound('forest');
                    return "The castle seems to loom over you, radiating malice.";
                }
            },
            33: {
                text: "You examine the statues lining the path. They depict grotesque creatures - part bat, part wolf, part human. The craftsmanship is exquisite but disturbing. One statue has a loose piece at its base.",
                choices: [
                    {text: "Try to loosen the piece", nextSection: 44, skillCheck: false},
                    {text: "Continue toward the castle", nextSection: 32, skillCheck: false},
                    {text: "Search the gardens", nextSection: 34, skillCheck: false}
                ],
                action: function() {
                    return "The statues seem to follow you with their stone eyes.";
                }
            },
            34: {
                text: "You search the overgrown gardens. Among the dead plants and weeds, you find the remains of what was once a beautiful garden. A small, withered herb garden still grows some usable plants.",
                choices: [
                    {text: "Gather some herbs", nextSection: 45, skillCheck: false},
                    {text: "Continue toward the castle", nextSection: 32, skillCheck: false},
                    {text: "Examine the statues", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The herbs might have medicinal properties.";
                }
            },
            35: {
                text: "A zombie climbs out of the sarcophagus! Its flesh is pale and rotting, its eyes milky white. It shambles toward you with outstretched arms.",
                choices: [
                    {text: "Fight the zombie", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Crypt Zombie";
                    combatState.enemyHealth = 25;
                    combatState.enemyCurrentHealth = 25;
                    combatState.enemyStrength = 12;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 4;
                    combatState.nextSection = 47;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('zombie');
                    return "<span class='zombie'>Crypt Zombie</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            36: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 48, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You wrench your arm free and bolt from the crypt, slamming the door behind you! The zombie's angry moans echo from within.";
                    } else {
                        // Zombie attacks
                        combatState.active = true;
                        combatState.enemyName = "Angry Crypt Zombie";
                        combatState.enemyHealth = 30;
                        combatState.enemyCurrentHealth = 30;
                        combatState.enemyStrength = 13;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 49;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('zombie');
                        return "You can't break free! The zombie pulls you closer...<br><br><span class='zombie'>Angry Crypt Zombie</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            37: {
                text: "<span class='merchant'>'The bandits... they camp in the old stables behind the guardhouse,'</span> the merchant says. <span class='merchant'>'Three of them. They have my silver cross... it was blessed. Might protect against... what's in there.'</span> He gestures weakly toward the castle.",
                choices: [
                    {text: "Promise to deal with the bandits", nextSection: 50, skillCheck: false},
                    {text: "Ask about the castle", nextSection: 51, skillCheck: false},
                    {text: "Give him a healing potion if you have one", nextSection: 39, skillCheck: false}
                ],
                action: function() {
                    gameState.merchantHelped = true;
                    return "";
                }
            },
            38: {
                text: "<span class='merchant'>'Three of them,'</span> the merchant coughs. <span class='merchant'>'Led by a brute named Gor. They've been preying on anyone who comes near the castle. Taking advantage of the... situation.'</span>",
                choices: [
                    {text: "Offer to help him", nextSection: 37, skillCheck: false},
                    {text: "Ask about the castle", nextSection: 51, skillCheck: false}
                ]
            },
            39: {
                text: "You give the merchant your healing potion. He drinks it gratefully, color returning to his face.",
                choices: [
                    {text: "Ask about the bandits", nextSection: 38, skillCheck: false},
                    {text: "Ask about the castle", nextSection: 51, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Healing Potion (Half Full)');
                    gameState.hasHealingPotion = false;
                    const goldReward = rollDice(3, 10);
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    playSound('item');
                    return "<span class='merchant'>'Thank you... thank you!'</span> he says. <span class='merchant'>'Here, take this. It's all I have left.'</span> He gives you " + goldReward + " gold.";
                }
            },
            40: {
                text: "You approach the unconscious merchant. He's still breathing but barely. You search his pockets and find a small purse.",
                choices: [
                    {text: "Take the purse", nextSection: 52, skillCheck: false},
                    {text: "Try to wake him", nextSection: 53, skillCheck: false},
                    {text: "Leave him", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    return "The merchant doesn't respond to your touch.";
                }
            },
            41: {
                text: "You push against the massive oak doors. They don't budge. They're locked or barred from within.",
                choices: [
                    {text: "Try the Rusty Iron Key if you have it", nextSection: 54, skillCheck: false, requirement: 'Rusty Iron Key'},
                    {text: "Look for another way in", nextSection: 43, skillCheck: false},
                    {text: "Examine the carvings", nextSection: 42, skillCheck: false},
                    {text: "Try to force the doors", nextSection: 55, skillCheck: true, checkType: 'strength', difficulty: 20}
                ]
            },
            42: {
                text: "The carvings on the doors depict scenes of torment and suffering. Vampires feasting on victims, demons torturing souls, and at the center, a crowned vampire lord receiving tribute. The craftsmanship is masterful but deeply disturbing.",
                choices: [
                    {text: "Try to open the doors", nextSection: 41, skillCheck: false},
                    {text: "Search for another entrance", nextSection: 43, skillCheck: false}
                ],
                action: function() {
                    return "The carvings seem to tell the story of Castle Vorlak's descent into darkness.";
                }
            },
            43: {
                text: "You search for another entrance. The castle walls are sheer and smooth, with no obvious alternative doors. However, you notice a section where ivy has grown thick up the wall, potentially providing a way to a second-floor window.",
                choices: [
                    {text: "Try to climb the ivy", nextSection: 56, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Return to the main doors", nextSection: 32, skillCheck: false}
                ],
                action: function() {
                    return "The ivy looks old and sturdy, but the climb would be dangerous.";
                }
            },
            44: {
                text: "You work the loose piece free from the statue's base. It's a small stone panel that conceals a hidden compartment!",
                choices: [
                    {text: "Reach into the compartment", nextSection: 57, skillCheck: false},
                    {text: "Continue toward the castle", nextSection: 32, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The compartment is dark and dusty.";
                }
            },
            45: {
                text: "You gather some of the less withered herbs from the garden. They might have medicinal properties.",
                choices: [
                    {text: "Continue toward the castle", nextSection: 32, skillCheck: false},
                    {text: "Examine the statues", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Medicinal Herbs');
                    playSound('item');
                    return "You gather <span class='item'>Medicinal Herbs</span>. They might help with healing.";
                }
            },
            46: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 58, skillCheck: false}
                ]
            },
            47: {
                text: "With the zombie defeated, it collapses into a pile of rotting flesh and bone. The crypt falls silent again.",
                choices: [
                    {text: "Search the zombie's remains", nextSection: 59, skillCheck: false},
                    {text: "Search the rest of the crypt", nextSection: 19, skillCheck: false},
                    {text: "Leave the crypt", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.zombieDefeated = true;
                    const goldFound = rollDice(2, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the zombie! You find " + goldFound + " gold on its remains.";
                }
            },
            48: {
                text: "You escape the crypt and slam the door shut behind you. From inside, you hear angry moans and scratching.",
                choices: [
                    {text: "Return to the gates", nextSection: 1, skillCheck: false}
                ]
            },
            49: {
                text: "With the zombie defeated, you stand alone in the crypt.",
                choices: [
                    {text: "Search the zombie's remains", nextSection: 59, skillCheck: false},
                    {text: "Search the rest of the crypt", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    gameState.zombieDefeated = true;
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the zombie! You find " + goldFound + " gold on its remains.";
                }
            },
            50: {
                text: "<span class='merchant'>'Thank you,'</span> the merchant says weakly. <span class='merchant'>'Be careful. Gor is dangerous, and his men are desperate. The old stables are behind the guardhouse.'</span>",
                choices: [
                    {text: "Go to the old stables", nextSection: 60, skillCheck: false},
                    {text: "Ask about the castle first", nextSection: 51, skillCheck: false},
                    {text: "Return to the gates", nextSection: 1, skillCheck: false}
                ]
            },
            51: {
                text: "<span class='merchant'>'The castle...'</span> the merchant shudders. <span class='merchant'>'No one who goes in comes out. Not alive anyway. The vampire lord Valerius rules there. They say he's centuries old. He... changes people. Makes them into monsters.'</span>",
                choices: [
                    {text: "Promise to deal with the bandits", nextSection: 50, skillCheck: false},
                    {text: "Give him a healing potion if you have one", nextSection: 39, skillCheck: false},
                    {text: "Leave him", nextSection: 1, skillCheck: false}
                ]
            },
            52: {
                text: "You take the merchant's purse. It contains a modest amount of gold.",
                choices: [
                    {text: "Try to wake him", nextSection: 53, skillCheck: false},
                    {text: "Leave him", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You take the merchant's purse containing " + goldFound + " gold.";
                }
            },
            53: {
                text: "You try to wake the merchant. He stirs slightly but doesn't regain consciousness. His breathing is shallow.",
                choices: [
                    {text: "Take his purse", nextSection: 52, skillCheck: false},
                    {text: "Leave him", nextSection: 1, skillCheck: false}
                ]
            },
            54: {
                text: "You try the Rusty Iron Key in the lock. It fits perfectly! With a satisfying click, the lock turns. The massive oak doors swing inward silently.",
                choices: [
                    {text: "Enter the castle", nextSection: 61, skillCheck: false}
                ],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 2;
                    saveGame();
                    
                    return "";
                }
            },
            55: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 62, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.gameComplete = true;
                        showScreen('screen-next');
                        document.getElementById('next-stat-strength').textContent = gameState.strength;
                        document.getElementById('next-stat-health').textContent = gameState.health;
                        document.getElementById('next-stat-agility').textContent = gameState.agility;
                        document.getElementById('next-stat-gold').textContent = gameState.gold;
                        
                        // Display inventory that will carry over
                        const inventoryDisplay = document.getElementById('next-inventory-display');
                        inventoryDisplay.innerHTML = '';
                        
                        // Show equipped items
                        const equippedDiv = document.createElement('div');
                        equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                        inventoryDisplay.appendChild(equippedDiv);
                        
                        // Show other inventory
                        if (gameState.inventory.length > 0) {
                            const invDiv = document.createElement('div');
                            invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                            inventoryDisplay.appendChild(invDiv);
                        }
                        
                        playSound('level');
                        
                        // Save completed level state
                        gameState.level = 2;
                        saveGame();
                        
                        return "";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The doors don't budge. You strain yourself in the attempt, taking " + damage + " damage.";
                    }
                }
            },
            56: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 63, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.gameComplete = true;
                        showScreen('screen-next');
                        document.getElementById('next-stat-strength').textContent = gameState.strength;
                        document.getElementById('next-stat-health').textContent = gameState.health;
                        document.getElementById('next-stat-agility').textContent = gameState.agility;
                        document.getElementById('next-stat-gold').textContent = gameState.gold;
                        
                        // Display inventory that will carry over
                        const inventoryDisplay = document.getElementById('next-inventory-display');
                        inventoryDisplay.innerHTML = '';
                        
                        // Show equipped items
                        const equippedDiv = document.createElement('div');
                        equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                        inventoryDisplay.appendChild(equippedDiv);
                        
                        // Show other inventory
                        if (gameState.inventory.length > 0) {
                            const invDiv = document.createElement('div');
                            invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                            inventoryDisplay.appendChild(invDiv);
                        }
                        
                        playSound('level');
                        
                        // Save completed level state
                        gameState.level = 2;
                        saveGame();
                        
                        return "";
                    } else {
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The ivy gives way! You fall to the ground, taking " + damage + " damage.";
                    }
                }
            },
            57: {
                text: "You reach into the hidden compartment and pull out a small, ornate box. Inside is a silver amulet shaped like a bat.",
                choices: [
                    {text: "Take the amulet", nextSection: 64, skillCheck: false},
                    {text: "Continue toward the castle", nextSection: 32, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Silver Bat Amulet');
                    playSound('item');
                    return "You take the <span class='item'>Silver Bat Amulet</span>. It might have significance in the castle.";
                }
            },
            58: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 46, skillCheck: false}
                ]
            },
            59: {
                text: "You search the zombie's remains. Among the rotting flesh, you find a few items the creature might have taken from previous victims.",
                choices: [
                    {text: "Search the rest of the crypt", nextSection: 19, skillCheck: false},
                    {text: "Leave the crypt", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(1, 10);
                    gameState.gold += goldFound;
                    addToInventory('Zombie\'s Tattered Cloak');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find " + goldFound + " gold and a <span class='item'>Zombie's Tattered Cloak</span>.";
                }
            },
            60: {
                text: "You find the old stables behind the guardhouse. The building is dilapidated, but you can hear voices from within. Three rough-looking bandits are gathered around a small fire, arguing over loot.",
                choices: [
                    {text: "Confront the bandits", nextSection: 65, skillCheck: false},
                    {text: "Try to sneak past them to the castle", nextSection: 66, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Set up an ambush", nextSection: 67, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Return to the merchant", nextSection: 50, skillCheck: false}
                ],
                action: function() {
                    playSound('bandit');
                    return "<span class='bandit'>Bandit Leader Gor:</span> 'I say we take what we have and get out of this cursed place!'";
                }
            },
            61: {
                text: "YOU HAVE ENTERED CASTLE VORLAK! The doors swing shut behind you with a final-sounding thud. You stand in a grand entrance hall, darkness stretching before you.",
                choices: [],
                action: function() {
                    // This is handled in section 54
                    return "";
                }
            },
            62: {
                text: "After trying to force the doors, you consider other options.",
                choices: [
                    {text: "Try the Rusty Iron Key if you have it", nextSection: 54, skillCheck: false},
                    {text: "Look for another way in", nextSection: 43, skillCheck: false},
                    {text: "Examine the carvings", nextSection: 42, skillCheck: false}
                ]
            },
            63: {
                text: "After attempting to climb the ivy, you return to the doors.",
                choices: [
                    {text: "Try to open the doors", nextSection: 41, skillCheck: false},
                    {text: "Examine the carvings", nextSection: 42, skillCheck: false}
                ]
            },
            64: {
                text: "With the amulet in hand, you continue toward the castle.",
                choices: [
                    {text: "Continue toward the castle", nextSection: 32, skillCheck: false}
                ]
            },
            65: {
                text: "You step into the stable, confronting the bandits. They spring to their feet, weapons drawn.",
                choices: [
                    {text: "Fight the bandits", nextSection: 68, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Bandits";
                    combatState.enemyHealth = 60;
                    combatState.enemyCurrentHealth = 60;
                    combatState.enemyStrength = 14;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 69;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 3;
                    
                    playSound('bandit');
                    return "<span class='bandit'>Bandits (3)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            66: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 70, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip past the bandits unnoticed and make your way back to the castle path.";
                    } else {
                        // Bandits notice and attack
                        combatState.active = true;
                        combatState.enemyName = "Alerted Bandits";
                        combatState.enemyHealth = 50;
                        combatState.enemyCurrentHealth = 50;
                        combatState.enemyStrength = 13;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 71;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 2;
                        
                        playSound('bandit');
                        return "The bandits notice you!<br><br><span class='bandit'>Alerted Bandits (2)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            67: {
                text: "You set up an ambush, waiting for one of the bandits to step outside. When a bandit comes out to relieve himself, you strike!",
                choices: [
                    {text: "Attack the isolated bandit", nextSection: 72, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Isolated Bandit";
                    combatState.enemyHealth = 25;
                    combatState.enemyCurrentHealth = 25;
                    combatState.enemyStrength = 12;
                    combatState.enemyDamageDice = 1;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 73;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('bandit');
                    return "<span class='bandit'>Isolated Bandit</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            68: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 74, skillCheck: false}
                ]
            },
            69: {
                text: "With the bandits defeated, the stables fall silent. You search their camp.",
                choices: [
                    {text: "Search the bandit camp", nextSection: 75, skillCheck: false},
                    {text: "Return to the castle path", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    gameState.banditsDefeated = true;
                    const goldFound = rollDice(8, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the bandits! You find " + goldFound + " gold in their loot.";
                }
            },
            70: {
                text: "Having slipped past the bandits, you return to the castle path.",
                choices: [
                    {text: "Continue toward the castle", nextSection: 32, skillCheck: false}
                ]
            },
            71: {
                text: "With the alerted bandits defeated, you can continue.",
                choices: [
                    {text: "Search the bandit camp", nextSection: 75, skillCheck: false},
                    {text: "Return to the castle path", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    gameState.banditsDefeated = true;
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the bandits and find " + goldFound + " gold.";
                }
            },
            72: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 76, skillCheck: false}
                ]
            },
            73: {
                text: "With the isolated bandit defeated, the other two come rushing out!",
                choices: [
                    {text: "Fight the remaining bandits", nextSection: 77, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Remaining Bandits";
                    combatState.enemyHealth = 40;
                    combatState.enemyCurrentHealth = 40;
                    combatState.enemyStrength = 13;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 78;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 2;
                    
                    playSound('bandit');
                    return "<span class='bandit'>Remaining Bandits (2)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            74: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 65, skillCheck: false}
                ]
            },
            75: {
                text: "You search the bandit camp thoroughly. Among their loot, you find the merchant's silver cross, various stolen goods, and their collected gold.",
                choices: [
                    {text: "Take the silver cross", nextSection: 79, skillCheck: false},
                    {text: "Take everything valuable", nextSection: 80, skillCheck: false},
                    {text: "Return to the castle path", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "You find: <br>- The merchant's silver cross (unbroken)<br>- Various stolen jewelry and trinkets<br>- A pouch of gold";
                }
            },
            76: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 72, skillCheck: false}
                ]
            },
            77: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 81, skillCheck: false}
                ]
            },
            78: {
                text: "With all the bandits defeated, you search their camp.",
                choices: [
                    {text: "Search the bandit camp", nextSection: 75, skillCheck: false},
                    {text: "Return to the castle path", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    gameState.banditsDefeated = true;
                    const goldFound = rollDice(6, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat all the bandits! You find " + goldFound + " gold in their camp.";
                }
            },
            79: {
                text: "You take the merchant's silver cross. It feels warm and comforting in your hand.",
                choices: [
                    {text: "Take the other valuables", nextSection: 80, skillCheck: false},
                    {text: "Return to the castle path", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    gameState.hasSilverCross = true;
                    addToInventory('Silver Cross (Blessed)');
                    playSound('item');
                    return "You take the <span class='item'>Silver Cross (Blessed)</span>. It should offer protection against undead.";
                }
            },
            80: {
                text: "You take everything valuable from the bandit camp.",
                choices: [
                    {text: "Return to the castle path", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    gameState.hasSilverCross = true;
                    const goldFound = rollDice(10, 10);
                    gameState.gold += goldFound;
                    addToInventory('Silver Cross (Blessed)');
                    addToInventory('Bandit Loot Collection');
                    updateStatsDisplay();
                    playSound('item');
                    return "You take everything: <span class='item'>Silver Cross (Blessed)</span>, <span class='item'>Bandit Loot Collection</span>, and " + goldFound + " gold.";
                }
            },
            81: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 77, skillCheck: false}
                ]
            }
        };
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 46 || sectionId === 58 || sectionId === 65 || 
                                   sectionId === 68 || sectionId === 72 || sectionId === 74 || 
                                   sectionId === 76 || sectionId === 77 || sectionId === 81);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    let goldReward = 0;
                    
                    if (combatState.enemyName.includes("Zombie")) {
                        goldReward = Math.floor(Math.random() * 20) + 10;
                        gameState.zombieDefeated = true;
                    } else if (combatState.enemyName.includes("Bandit")) {
                        goldReward = Math.floor(Math.random() * 30) + 15;
                        gameState.banditsDefeated = true;
                    }
                    
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    
                    if (goldReward > 0) {
                        storyText += `<br>You find <span class="gold">${goldReward} Gold</span> on the remains.`;
                    }
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    if (typeof choice.requirement === 'function') {
                        return choice.requirement();
                    }
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Return to the castle gates";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                let weaponType = gameState.equippedWeapon;
                
                // Special weapon bonuses
                if (weaponType.includes('Silver') || weaponType.includes('Mace')) {
                    // Silver/Mace weapons deal extra damage to undead
                    damage = rollDice(2, 6) + 2;
                    if (combatState.enemyName.includes('Zombie') || combatState.enemyName.includes('undead')) {
                        damage += 3; // Extra vs undead
                        resultText += `<span class="item">Your weapon is especially effective against undead!</span><br>`;
                    }
                } else if (weaponType === 'Hunting Bow') {
                    damage = rollDice(2, 6) + 1; // Bow damage
                    if (combatState.enemyName.includes('Bandit')) {
                        damage += 2; // Extra vs humanoids at range
                        resultText += `<span class="item">Your bow gives you an advantage at range!</span><br>`;
                    }
                } else if (weaponType === 'Dual Daggers') {
                    damage = rollDice(3, 4) + 1; // Multiple attacks
                    resultText += `<span class="item">Your dual daggers strike multiple times!</span><br>`;
                } else {
                    damage = rollDice(2, 6);
                }
                
                // Item bonuses
                if (gameState.hasSilverCross && combatState.enemyName.includes('Zombie')) {
                    damage += 4;
                    resultText += `<span class="item">The silver cross glows, burning the undead!</span><br>`;
                }
                
                // Priest special against undead
                if (gameState.playerClass === 'priest' && combatState.enemyName.includes('Zombie')) {
                    damage += 5;
                    resultText += `<span class="item">Your holy powers are especially effective against undead!</span><br>`;
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                let enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                
                // Group enemies attack together
                if (combatState.isGroup && combatState.enemyName.includes('Bandit')) {
                    enemyDamage += Math.floor(combatState.groupCount * 1.5); // Extra damage for group
                    if (combatState.groupCount > 1) {
                        resultText += `The bandits attack as a group!<br>`;
                    }
                }
                
                // Zombie special attack
                if (combatState.enemyName.includes('Zombie')) {
                    if (Math.random() > 0.7) {
                        enemyDamage += rollDice(1, 4); // Extra rotting damage
                        resultText += `The zombie's rotting touch sickens you!<br>`;
                    }
                }
                
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('castleDamnedGameState');
                        window.location.reload();
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You dodge a falling branch trap!",
                    "You move silently past a sleeping creature.",
                    "You climb a difficult wall to bypass an obstacle.",
                    "You slip through a narrow crack others would miss."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip and take 3 damage!",
                    "You make noise and alert nearby creatures.",
                    "You get tangled in vines or debris.",
                    "You knock over some bones, making a loud clatter."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 3;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('castleDamnedGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('castleDamnedGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 1 (this page)
                if (savedState.level === 1) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 1.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 2 with updated level
            gameState.level = 2;
            localStorage.setItem('castleDamnedGameState', JSON.stringify(gameState));
            // Redirect to level 2 (The Grand Entrance Hall)
            window.location.href = 'l2.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
            
            // Add click sound to class options
            const classOptions = document.querySelectorAll('.class-option');
            classOptions.forEach(option => {
                option.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
