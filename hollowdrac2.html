
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Legacy of the Night</title>
<style>
body {
    color: #e0e0e0;
    font-family: 'Courier New', monospace;
    margin: 0;
    padding: 0;
    overflow-x: auto;
    text-shadow: 0 0 5px rgba(255, 0, 0, 0.3);
    background: #1a1a1a;
    background-size: 100% 100%;
    background-repeat: no-repeat;
    display: flex;
    flex-direction: column;
}

#game-container {
    max-width: 900px;
    min-height: 100vh;
    margin: 0 auto;
    position: relative;
    padding: 10px;
}

#game-title {
    color: #c62828;
    text-align: center;
    font-size: 36px;
    margin-bottom: 15px;
    text-shadow: 0 0 15px #c62828, 0 0 25px #c62828;
    border-bottom: 1px solid #c62828;
    padding-bottom: 10px;
    font-weight: bold;
    letter-spacing: 3px;
    text-transform: uppercase;
    font-family: 'Arial Black', sans-serif;
}

/* Screen Headers */
.screen-header {
    color: #ff6f00;
    border-bottom: 1px solid #c62828;
    padding-bottom: 8px;
    margin-bottom: 15px;
    font-size: 24px;
    text-align: center;
}

.screen-section {
    background: rgba(40, 40, 40, 0.7);
    border: 1px solid #333;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 15px;
}

.grid-layout {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin: 15px 0;
}

/* Improved Game Screen */
#game-screen {
    border: 1px solid #333;
    padding: 15px;
    min-height: 200px;
    margin-bottom: 10px;
    overflow-y: auto;
    max-height: 300px;
    background: rgba(10, 10, 10, 0.9);
    font-size: 16px;
    line-height: 1.6;
    border-radius: 8px;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
}

/* Custom scrollbar for game screen */
#game-screen::-webkit-scrollbar {
    width: 8px;
}

#game-screen::-webkit-scrollbar-track {
    background: #1a1a1a;
}

#game-screen::-webkit-scrollbar-thumb {
    background: #c62828;
    border-radius: 4px;
}

/* Improved Player Stats */
#player-stats {
    border: 1px solid #333;
    padding: 15px;
    margin-bottom: 15px;
    background: rgba(26, 26, 26, 0.8);
    font-size: 14px;
    border-radius: 8px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid #333;
}

.stat-value {
    font-weight: bold;
    color: #ff6f00;
}

/* Improved Button Styling */
.button-row {
    display: flex;
    flex-wrap: wrap;
    margin-bottom: 5px;
    gap: 5px;
    background-color: rgba(26, 26, 26, 0);
}

.game-button {
    background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
    color: #e0e0e0;
    border: 1px solid #444;
    padding: 12px 8px;
    margin: 2px;
    flex-grow: 1;
    min-width: 120px;
    cursor: pointer;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    font-weight: bold;
    border-radius: 6px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.game-button:hover {
    background: linear-gradient(145deg, #333, #222);
    border-color: #c62828;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(198, 40, 40, 0.3);
}

.game-button:active {
    transform: translateY(0);
}

.game-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
}

.game-button:hover::before {
    left: 100%;
}

.game-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.game-button:disabled:hover {
    background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
    border-color: #444;
    box-shadow: none;
}

.selected {
    color: #c62828;
    border-color: #c62828;
}

/* Tab System */
.tab-container {
    display: flex;
    margin-bottom: 15px;
    border-bottom: 1px solid #333;
    flex-wrap: wrap;
}

.tab-button {
    background: #1a1a1a;
    border: 1px solid #333;
    border-bottom: none;
    padding: 10px 15px;
    margin-right: 5px;
    cursor: pointer;
    border-radius: 5px 5px 0 0;
    transition: all 0.3s;
    color: #e0e0e0;
    font-family: 'Courier New', monospace;
    font-weight: bold;
}

.tab-button.active {
    background: #c62828;
    border-color: #c62828;
}

/* Tooltip System */
.tooltip {
    position: relative;
    cursor: help;
}

.tooltip::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: #e0e0e0;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    border: 1px solid #c62828;
    z-index: 1000;
}

.tooltip:hover::after {
    opacity: 1;
}

/* Loading Animation */
.loading {
    opacity: 0.7;
    pointer-events: none;
    position: relative;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #c62828;
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.important {
    color: #ff6f00;
    font-weight: bold;
}

.enemy {
    color: #c62828;
    font-size: 20px;
    font-weight: bold;
    background-color: rgba(26, 26, 26, 0.5);
}

.item {
    color: #4caf50;
}

.gold {
    color: #ff6f00;
}

.health {
    color: #c62828;
}

#combat-screen .health {
    font-size: 20px;
    font-weight: bold;
}
    
.blood {
    color: #c62828;
}

.rage {
    color: #ff6f00;
}

.lightning {
    color: #4caf50;
}

.souls {
    color: #6a1b9a;
}

.xp {
    color: #5af;
}

.damage {
    color: #c62828;
}

.heal {
    color: #4caf50;
}

.critical {
    color: #ff6f00;
    font-weight: bold;
    text-shadow: 0 0 5px #ff6f00;
}

.debuff {
    color: #6a1b9a;
}

#inventory-screen, #character-screen, #shop-screen, #combat-screen, #quests-screen, #class-select-screen, #talent-screen, #challenges-screen, #endgame-screen, #pets-screen, #lore-screen {
    display: none;
}

.item-info {
    border: 1px solid #333;
    padding: 10px;
    margin-top: 10px;
    background-color: rgba(26, 26, 26, 1);
    border-radius: 5px;
}

.class-vampire {
    color: #c62828;
}

.class-werewolf {
    color: #ff6f00;
}

.class-reanimated {
    color: #4caf50;
}

.class-necromancer {
    color: #6a1b9a;
}

.class-hybrid {
    color: #9c27b0;
}

/* CRT effect */
body::after {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0), rgba(0, 255, 0, 0), rgba(0, 0, 255, 0));
    z-index: 100;
    pointer-events: none;
}

/* Scanlines */
body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom,
    transparent 0%,
    rgba(0, 0, 0, 0.2) 50%,
    transparent 100%);
    background-size: 100% 4px;
    z-index: 101;
    pointer-events: none;
    animation: scanline 8s linear infinite;
}

@keyframes scanline {
    0% { background-position: 0 0; }
    100% { background-position: 0 100%; }
}

/* Progress bar styles */
.progress-container {
    width: 100%;
    background-color: #222;
    margin: 5px 0;
    border-radius: 3px;
    overflow: hidden;
}

.progress-bar {
    height: 10px;
    background-color: #c62828;
    text-align: center;
    line-height: 10px;
    color: white;
    transition: width 0.3s;
}

.health-bar {
    background-color: #c62828;
}

.blood-bar {
    background-color: #c62828;
}

.rage-bar {
    background-color: #ff6f00;
}

.lightning-bar {
    background-color: #4caf50;
}

.souls-bar {
    background-color: #6a1b9a;
}

.xp-bar {
    background-color: #5af;
}

/* Enemy health bar */
.enemy-health-container {
    width: 100%;
    background-color: #222;
    margin: 5px 0;
    border-radius: 3px;
    overflow: hidden;
}

.enemy-health-bar {
    height: 10px;
    background-color: #c62828;
    text-align: center;
    line-height: 10px;
    color: white;
    transition: width 0.3s;
}

/* Status effect icons */
.status-effect {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 5px;
    vertical-align: middle;
}

.poison {
    background-color: #4caf50;
}

.strength {
    background-color: #c62828;
}

.weakness {
    background-color: #5af;
}

.stun {
    background-color: #ff6f00;
}

.regen {
    background-color: #4caf50;
}

/* Quest styles */
.quest {
    border: 1px solid #333;
    padding: 10px;
    margin: 10px 0;
    background-color: #1a1a1a;
    border-radius: 5px;
}

.quest-active {
    border-left: 4px solid #ff6f00;
    background-color: rgba(26, 26, 26, 0.5);
}

.quest-completed {
    border-left: 4px solid #4caf50;
    opacity: 0.7;
}

/* Combat animations */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-5px); }
    40%, 80% { transform: translateX(5px); }
}

.combat-shake {
    animation: shake 0.5s;
}

@keyframes flash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.combat-flash {
    animation: flash 0.3s;
}

/* Area transition animation */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.fade-in {
    animation: fadeIn 0.5s;
}

/* Class selection screen */
#class-select-screen {
    text-align: center;
    padding: 20px;
}

.class-description {
    margin: 20px 0;
    padding: 15px;
    background-color: rgba(26, 26, 26, 0.5);
    border-radius: 5px;
    border: 1px solid #333;
}

.class-button {
    min-width: 150px;
    font-size: 18px;
    padding: 15px;
    margin: 5px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    #game-container {
        padding: 10px;
    }
    
    .button-row {
        flex-direction: column;
    }
    
    .game-button {
        min-width: 100%;
        margin: 2px 0;
        padding: 15px 10px;
    }
    
    .tab-container {
        flex-wrap: wrap;
    }
    
    .tab-button {
        flex: 1;
        min-width: 80px;
        font-size: 12px;
        padding: 8px 5px;
    }
    
    #player-stats {
        grid-template-columns: 1fr;
        font-size: 12px;
    }
    
    #game-title {
        font-size: 28px;
    }
    
    #game-screen, #player-stats {
        font-size: 16px;
    }
}

@media (max-width: 480px) {
    #game-title {
        font-size: 24px;
    }
    
    .game-button {
        padding: 12px 8px;
        font-size: 12px;
    }
    
    .quick-bar {
        bottom: 5px;
    }
    
    .quick-slot {
        width: 35px;
        height: 35px;
        font-size: 10px;
    }
    
    .save-load-buttons {
        position: relative;
        top: 0;
        right: 0;
        justify-content: center;
        margin-bottom: 10px;
    }
    
    .moon-phase, .time-display, .difficulty-indicator {
        position: relative;
        top: 0;
        left: 0;
        margin: 5px 0;
    }
}

/* Achievement toast */
.achievement-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #222;
    border-left: 4px solid #ff6f00;
    padding: 15px;
    border-radius: 4px;
    box-shadow: 0 0 10px rgba(255,111,0,0.5);
    z-index: 1000;
    transform: translateX(200%);
    transition: transform 0.3s ease-out;
}

.achievement-toast.show {
    transform: translateX(0);
}

.achievement-title {
    color: #ff6f00;
    font-weight: bold;
    margin-bottom: 5px;
}

/* Save/Load buttons */
.save-load-buttons {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.save-load-buttons button {
    padding: 5px 15px;
    font-size: 12px;
    background-color: #333;
    border: 1px solid #444;
    color: #e0e0e0;
    border-radius: 3px;
    cursor: pointer;
}

.save-load-buttons button:hover {
    background-color: #444;
}

/* Music controls */
.music-controls, .save-load-controls {
    display: flex;
    justify-content: left;
    gap: 10px;
    margin-bottom: 10px;
}

.music-controls button, .save-load-controls button {
    padding: 5px 15px;
    font-size: 12px;
    background-color: #333;
    border: 1px solid #444;
    color: #e0e0e0;
    border-radius: 3px;
    cursor: pointer;
    font-family: 'Courier New', monospace;
}

h1 {
    text-align: left;
    color: #e0e0e0;
    margin: 10px 0;
}

.music-controls button:hover {
    background-color: #444;
}

/* Class selection highlight */
.class-selected {
    transform: scale(1.05);
    box-shadow: 0 0 10px rgba(255,255,255,0.5);
}

/* Select button */
.select-button {
    min-width: 200px;
    font-size: 20px;
    padding: 15px;
    margin: 20px auto;
    display: none;
}

/* Transformation effects */
.transforming {
    animation: transformGlow 1s ease-in-out;
}

@keyframes transformGlow {
    0% { box-shadow: 0 0 5px currentColor; }
    50% { box-shadow: 0 0 20px currentColor; }
    100% { box-shadow: 0 0 5px currentColor; }
}

.moon-phase {
    position: absolute;
    top: 10px;
    left: 10px;
    font-size: 12px;
    color: #ff6f00;
}

.time-display {
    position: absolute;
    top: 30px;
    left: 10px;
    font-size: 12px;
    color: #5af;
}

/* Quick action bar */
.quick-bar {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 5px;
    z-index: 10;
}

.quick-slot {
    width: 40px;
    height: 40px;
    border: 2px solid #c62828;
    background: rgba(26, 26, 26, 0.8);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.quick-slot:hover {
    background: rgba(198, 40, 40, 0.3);
}

/* Difficulty indicator */
.difficulty-indicator {
    position: absolute;
    top: 50px;
    right: 10px;
    font-size: 12px;
    color: #ff6f00;
}

/* Combo meter */
.combo-meter {
    height: 5px;
    background: linear-gradient(90deg, #c62828, #ff6f00, #4caf50);
    margin: 5px 0;
    border-radius: 3px;
    transition: width 0.3s;
}

/* Prestige badge */
.prestige-badge {
    display: inline-block;
    background: linear-gradient(45deg, #ff6f00, #c62828);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    margin-left: 5px;
    vertical-align: super;
}

/* Auto-save indicator */
.auto-save-indicator {
    position: fixed;
    bottom: 10px;
    left: 10px;
    background: #4caf50;
    color: white;
    padding: 5px 10px;
    border-radius: 3px;
    font-size: 12px;
    z-index: 1000;
}
</style>
</head>
<body>
<div id="game-container">
    <div class="save-load-buttons">
        <button onclick="saveGame()">SAVE</button>
        <button onclick="loadGame()">LOAD</button>
    </div>
    
    <div class="moon-phase" id="moon-phase"></div>
    <div class="time-display" id="time-display"></div>
    <div class="difficulty-indicator" id="difficulty-indicator"></div>
    
    <div class="music-controls">
        <button onclick="toggleMusic()">TOGGLE MUSIC</button>
        <button onclick="toggleDifficulty()">DIFFICULTY: NORMAL</button>
    </div>
    
    <div id="game-title">LEGACY OF THE NIGHT</div>

    <!-- Tab Navigation -->
    <div id="navigation-tabs" class="tab-container">
        <button class="tab-button active" onclick="switchTab('main')">MAIN</button>
        <button class="tab-button" onclick="switchTab('character')">CHARACTER</button>
        <button class="tab-button" onclick="switchTab('inventory')">INVENTORY</button>
        <button class="tab-button" onclick="switchTab('talent')">TALENTS</button>
        <button class="tab-button" onclick="switchTab('quests')">QUESTS</button>
    </div>

    <!-- Main Game Screen -->
    <div id="game-screen"></div>

    <!-- Player Stats -->
    <div id="player-stats"></div>

    <!-- Main Menu Buttons -->
    <div id="main-buttons" class="button-row" style="display: none;">
        <button class="game-button tooltip" data-tooltip="Search for enemies and treasure" onclick="showScreen('explore')">EXPLORE</button>
        <button class="game-button tooltip" data-tooltip="View your character details" onclick="showScreen('character')">CHARACTER</button>
        <button class="game-button tooltip" data-tooltip="Manage your items and equipment" onclick="showScreen('inventory')">INVENTORY</button>
        <button class="game-button tooltip" data-tooltip="Buy and sell items" onclick="showScreen('shop')">SHOP</button>
        <button class="game-button tooltip" data-tooltip="View active and completed quests" onclick="showScreen('quests')">QUESTS</button>
        <button class="game-button tooltip" data-tooltip="Spend talent points" onclick="showScreen('talent')">TALENTS</button>
        <button class="game-button tooltip" data-tooltip="Endgame challenges" onclick="showScreen('endgame')">ENDGAME</button>
        <button class="game-button tooltip" data-tooltip="Prestige for permanent bonuses" onclick="showScreen('prestige')">PRESTIGE</button>
    </div>

    <!-- Explore Screen -->
    <div id="explore-screen" style="display: none;">
        <div class="screen-header">HUNTING GROUNDS</div>
        <div class="button-row">
            <button class="game-button tooltip" data-tooltip="Search for enemies and treasure" onclick="exploreArea()">HUNT</button>
            <button class="game-button tooltip" data-tooltip="Rest to recover health and resources" onclick="rest()">REST</button>
            <button class="game-button tooltip" data-tooltip="Travel to different areas" onclick="changeArea()">TRAVEL</button>
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Character Screen -->
    <div id="character-screen">
        <div class="screen-header">CHARACTER</div>
        <div id="character-info"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Inventory Screen -->
    <div id="inventory-screen">
        <div class="screen-header">INVENTORY</div>
        <div id="inventory-items"></div>
        <div id="item-details"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Shop Screen -->
    <div id="shop-screen">
        <div class="screen-header">DARK MARKET</div>
        <div id="shop-items"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
            <button class="game-button" onclick="refreshShop()">REFRESH (50G)</button>
        </div>
    </div>

    <!-- Combat Screen -->
    <div id="combat-screen">
        <div class="screen-header">COMBAT</div>
        <div id="combat-info"></div>
        <div id="combat-actions" class="button-row"></div>
    </div>

    <!-- Quests Screen -->
    <div id="quests-screen">
        <div class="screen-header">QUESTS</div>
        <div id="active-quests"></div>
        <div id="completed-quests"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Talent Screen -->
    <div id="talent-screen">
        <div class="screen-header">DARK TALENTS</div>
        <div id="talent-info"></div>
        <div id="talent-tree"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Endgame Screen -->
    <div id="endgame-screen">
        <div class="screen-header">LEGENDARY HUNTS</div>
        <div id="endgame-content"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
            <button class="game-button" onclick="enterInfiniteDungeon()">INFINITE DUNGEON</button>
            <button class="game-button" onclick="startBossRush()">BOSS RUSH</button>
        </div>
    </div>

    <!-- Prestige Screen -->
    <div id="prestige-screen" style="display: none;">
        <div class="screen-header">PRESTIGE SYSTEM</div>
        <div id="prestige-content"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
            <button class="game-button" onclick="prestigeReset()" id="prestige-button">PRESTIGE RESET</button>
        </div>
    </div>

    <!-- Class Selection Screen (Initial) -->
    <div id="class-select-screen">
        <h2>Choose Your Monster Form</h2>
        <div class="button-row">
            <button class="game-button class-vampire class-button tooltip" data-tooltip="Master of blood and shadows" onclick="showClassDetails('vampire')">VAMPIRE LORD</button>
            <button class="game-button class-werewolf class-button tooltip" data-tooltip="Primal force of nature" onclick="showClassDetails('werewolf')">LYCANTHROPE</button>
            <button class="game-button class-reanimated class-button tooltip" data-tooltip="Unstoppable force of science" onclick="showClassDetails('reanimated')">REANIMATED</button>
            <button class="game-button class-necromancer class-button tooltip" data-tooltip="Commander of the dead" onclick="showClassDetails('necromancer')">NECROMANCER</button>
            <button class="game-button class-hybrid class-button tooltip" data-tooltip="Combines traits from multiple monsters" onclick="showClassDetails('hybrid')">HYBRID MONSTER</button>
        </div>
        <div id="class-description" class="class-description">Click on a monster type to see details</div>
        <button id="select-class-button" class="game-button select-button" onclick="selectClass()">EMBRACE DARKNESS</button>
    </div>
</div>

<!-- Quick Action Bar -->
<div class="quick-bar">
    <div class="quick-slot tooltip" data-tooltip="Quick Slot 1" onclick="useQuickSlot(0)">1</div>
    <div class="quick-slot tooltip" data-tooltip="Quick Slot 2" onclick="useQuickSlot(1)">2</div>
    <div class="quick-slot tooltip" data-tooltip="Quick Slot 3" onclick="useQuickSlot(2)">3</div>
    <div class="quick-slot tooltip" data-tooltip="Quick Slot 4" onclick="useQuickSlot(3)">4</div>
</div>

<!-- Achievement Toast -->
<div id="achievement-toast" class="achievement-toast">
    <div class="achievement-title">ACHIEVEMENT UNLOCKED!</div>
    <div id="achievement-desc"></div>
</div>

<!-- Audio Elements -->
<audio id="background-music" loop>
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>
<audio id="combat-sound">
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" type="audio/mpeg">
</audio>
<audio id="victory-sound">
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" type="audio/mpeg">
</audio>

<script>
// Game State
const gameState = {
    player: {
        name: "Monster",
        class: null,
        level: 1,
        xp: 0,
        xpToNextLevel: 100,
        health: 100,
        maxHealth: 100,
        // Class-specific resources
        blood: 100,
        maxBlood: 100,
        rage: 0,
        maxRage: 100,
        lightning: 100,
        maxLightning: 100,
        souls: 0,
        maxSouls: 5,
        // Stats
        strength: 10,
        dexterity: 10,
        intelligence: 10,
        constitution: 10,
        gold: 50,
        equippedWeapon: null,
        equippedArmor: null,
        inventory: [],
        skills: [],
        currentArea: "Transylvania Village",
        inCombat: false,
        currentEnemy: null,
        buffs: [],
        debuffs: [],
        quests: {
            active: [],
            completed: []
        },
        achievements: [],
        talentPoints: 0,
        talents: {},
        // Monster-specific states
        transformed: false,
        transformationTurns: 0,
        minions: [],
        reputation: 0, // -100 to 100 (feared to respected)
        // Time and moon
        isDaytime: false,
        moonPhase: "Full", // Full, Waning, New, Waxing
        // New progression systems
        prestigeLevel: 0,
        comboCounter: 0,
        comboMultiplier: 1,
        infiniteDungeonLevel: 0,
        bossRushLevel: 0,
        hybridForm: null,
        quickSlots: [null, null, null, null],
        difficulty: "normal"
    },
    areas: [
        { name: "Transylvania Village", minLevel: 1, unlocked: true, description: "A superstitious village living in fear of the night." },
        { name: "Castle Dracula", minLevel: 3, unlocked: false, description: "The ancient fortress of the vampire lords." },
        { name: "Black Forest", minLevel: 5, unlocked: false, description: "A cursed forest where beasts roam freely." },
        { name: "Frankenstein's Lab", minLevel: 7, unlocked: false, description: "A mad scientist's laboratory of horrors." },
        { name: "Ancient Crypts", minLevel: 9, unlocked: false, description: "Tombs filled with restless dead." },
        { name: "Shadow Realm", minLevel: 12, unlocked: false, description: "A dimension between life and death." },
        { name: "Infinite Dungeon", minLevel: 15, unlocked: false, description: "An endless labyrinth of challenges." }
    ],
    enemies: {
        "Transylvania Village": [
            { name: "Torch-wielding Villager", health: 40, maxHealth: 40, damage: "8-12", xp: 25, gold: "10-20", level: 1, fireDamage: 5 },
            { name: "Village Guard", health: 50, maxHealth: 50, damage: "10-15", xp: 30, gold: "15-25", level: 1, armor: 5 },
            { name: "Priest", health: 35, maxHealth: 35, damage: "6-10", xp: 35, gold: "20-30", level: 2, holyDamage: 10 },
            { name: "Mob Leader", health: 60, maxHealth: 60, damage: "12-18", xp: 40, gold: "25-35", level: 2, critChance: 0.1 }
        ],
        "Castle Dracula": [
            { name: "Vampire Spawn", health: 70, maxHealth: 70, damage: "15-20", xp: 60, gold: "30-40", level: 3, lifesteal: 0.1 },
            { name: "Ghoul Servant", health: 80, maxHealth: 80, damage: "12-16", xp: 50, gold: "25-35", level: 3, poisonChance: 0.3 },
            { name: "Shadow Bat", health: 40, maxHealth: 40, damage: "18-22", xp: 45, gold: "20-30", level: 4, dodgeChance: 0.2 },
            { name: "Blood Guardian", health: 100, maxHealth: 100, damage: "20-25", xp: 70, gold: "40-50", level: 4, armor: 10 }
        ],
        "Black Forest": [
            { name: "Rabid Wolf", health: 60, maxHealth: 60, damage: "16-20", xp: 55, gold: "30-40", level: 5, bleedChance: 0.2 },
            { name: "Cursed Hunter", health: 80, maxHealth: 80, damage: "18-24", xp: 65, gold: "35-45", level: 5, silverDamage: 5 },
            { name: "Forest Spirit", health: 70, maxHealth: 70, damage: "14-18", xp: 60, gold: "40-50", level: 6, magicDamage: 10 },
            { name: "Lesser Werewolf", health: 90, maxHealth: 90, damage: "22-28", xp: 75, gold: "45-55", level: 6, rage: 0.1 }
        ],
        "Frankenstein's Lab": [
            { name: "Failed Experiment", health: 100, maxHealth: 100, damage: "20-25", xp: 80, gold: "50-60", level: 7, shockDamage: 8 },
            { name: "Laboratory Assistant", health: 60, maxHealth: 60, damage: "15-20", xp: 70, gold: "40-50", level: 7, acidDamage: 5 },
            { name: "Electric Golem", health: 120, maxHealth: 120, damage: "25-30", xp: 90, gold: "60-70", level: 8, stunChance: 0.2 },
            { name: "Mutated Beast", health: 110, maxHealth: 110, damage: "22-27", xp: 85, gold: "55-65", level: 8, regen: 5 }
        ],
        "Ancient Crypts": [
            { name: "Skeletal Warrior", health: 90, maxHealth: 90, damage: "24-30", xp: 95, gold: "70-80", level: 9, armor: 15 },
            { name: "Wraith", health: 80, maxHealth: 80, damage: "26-32", xp: 100, gold: "75-85", level: 9, magicResist: 20 },
            { name: "Gravekeeper", health: 110, maxHealth: 110, damage: "28-34", xp: 110, gold: "80-90", level: 10, holyDamage: 15 },
            { name: "Ancient Lich", health: 130, maxHealth: 130, damage: "30-36", xp: 120, gold: "90-100", level: 10, soulDrain: 0.1 }
        ],
        "Shadow Realm": [
            { name: "Shadow Beast", health: 150, maxHealth: 150, damage: "35-42", xp: 140, gold: "100-120", level: 12, shadowDamage: 15 },
            { name: "Soul Reaper", health: 120, maxHealth: 120, damage: "38-45", xp: 150, gold: "110-130", level: 12, lifesteal: 0.2 },
            { name: "Void Walker", health: 180, maxHealth: 180, damage: "32-38", xp: 160, gold: "120-140", level: 13, voidDamage: 20 },
            { name: "Eternal Guardian", health: 200, maxHealth: 200, damage: "40-48", xp: 180, gold: "140-160", level: 13, magicResist: 30 }
        ],
        "Infinite Dungeon": []
    },
    bosses: {
        "Transylvania Village": { name: "Village Elder", health: 200, maxHealth: 200, damage: "25-35", xp: 300, gold: "200-250", level: 5, holyDamage: 20 },
        "Castle Dracula": { name: "Count Dracula", health: 400, maxHealth: 400, damage: "40-50", xp: 600, gold: "400-500", level: 8, lifesteal: 0.3, batSwarm: true },
        "Black Forest": { name: "Alpha Werewolf", health: 500, maxHealth: 500, damage: "45-55", xp: 800, gold: "500-600", level: 10, rage: 0.4, howl: true },
        "Frankenstein's Lab": { name: "The Creature", health: 600, maxHealth: 600, damage: "50-60", xp: 1000, gold: "600-700", level: 12, shockAura: true, unstoppable: true },
        "Ancient Crypts": { name: "Death Knight", health: 700, maxHealth: 700, damage: "55-65", xp: 1200, gold: "700-800", level: 14, soulSteal: true, undeadArmy: true },
        "Shadow Realm": { name: "Shadow King", health: 1000, maxHealth: 1000, damage: "70-80", xp: 2000, gold: "1000-1200", level: 20, shadowMastery: true, phaseShift: true }
    },
    items: {
        weapons: [
            // Vampire Weapons
            { id: 1, name: "Bloodied Dagger", type: "weapon", damage: "10-15", value: 30, level: 1, lifesteal: 0.1, class: "vampire" },
            { id: 2, name: "Ancient Rapier", type: "weapon", damage: "18-24", value: 80, level: 3, critChance: 0.15, class: "vampire" },
            { id: 3, name: "Vampire's Kiss", type: "weapon", damage: "25-32", value: 150, level: 5, lifesteal: 0.2, bloodDrain: 5, class: "vampire" },
            { id: 13, name: "Crimson Blade", type: "weapon", damage: "35-42", value: 250, level: 8, lifesteal: 0.25, bloodDrain: 8, class: "vampire" },
            
            // Werewolf Weapons
            { id: 4, name: "Silver Claws", type: "weapon", damage: "12-18", value: 35, level: 1, armorPen: 5, class: "werewolf" },
            { id: 5, name: "Wolf Fang Gauntlets", type: "weapon", damage: "20-26", value: 90, level: 3, bleedChance: 0.2, class: "werewolf" },
            { id: 6, name: "Alpha's Fury", type: "weapon", damage: "28-35", value: 160, level: 5, rageGain: 10, critChance: 0.2, class: "werewolf" },
            { id: 14, name: "Moonrend Claws", type: "weapon", damage: "38-46", value: 280, level: 8, rageGain: 15, lunarPower: true, class: "werewolf" },
            
            // Reanimated Weapons
            { id: 7, name: "Rusty Pipes", type: "weapon", damage: "15-20", value: 40, level: 1, shockDamage: 5, class: "reanimated" },
            { id: 8, name: "Lightning Rod", type: "weapon", damage: "22-28", value: 100, level: 3, stunChance: 0.15, class: "reanimated" },
            { id: 9, name: "The Monster's Fist", type: "weapon", damage: "30-38", value: 180, level: 5, shockAura: 10, armorPen: 10, class: "reanimated" },
            { id: 15, name: "Thunderfist Gauntlets", type: "weapon", damage: "40-48", value: 300, level: 8, shockDamage: 15, overload: true, class: "reanimated" },
            
            // Necromancer Weapons
            { id: 10, name: "Bone Staff", type: "weapon", damage: "8-12", magicDamage: 10, value: 45, level: 1, soulGain: 1, class: "necromancer" },
            { id: 11, name: "Skull Scepter", type: "weapon", damage: "15-20", magicDamage: 15, value: 110, level: 3, minionDamage: 5, class: "necromancer" },
            { id: 12, name: "Lich's Staff", type: "weapon", damage: "20-25", magicDamage: 25, value: 200, level: 5, soulSteal: 0.1, undeadMastery: true, class: "necromancer" },
            { id: 16, name: "Soul Harvester", type: "weapon", damage: "25-32", magicDamage: 30, value: 320, level: 8, soulSteal: 0.2, deathMagic: true, class: "necromancer" },
            
            // Hybrid Weapons
            { id: 17, name: "Bloodmoon Claws", type: "weapon", damage: "30-38", value: 400, level: 10, lifesteal: 0.15, rageGain: 10, class: "hybrid" },
            { id: 18, name: "Abomination's Grasp", type: "weapon", damage: "35-42", value: 450, level: 12, shockDamage: 10, soulGain: 1, class: "hybrid" },
            
            // Legendary Weapons
            { id: 50, name: "Dracula's Blade", type: "weapon", damage: "40-50", value: 500, level: 10, lifesteal: 0.3, batSummon: true, legendary: true },
            { id: 51, name: "Moonfang", type: "weapon", damage: "45-55", value: 550, level: 10, rageGain: 20, lunarPower: true, legendary: true },
            { id: 52, name: "The Spark of Life", type: "weapon", damage: "50-60", value: 600, level: 10, shockDamage: 25, resurrection: true, legendary: true },
            { id: 53, name: "Soul Reaver", type: "weapon", damage: "35-45", magicDamage: 30, value: 650, level: 10, soulArmy: true, deathMagic: true, legendary: true },
            { id: 54, name: "Nightmare's Edge", type: "weapon", damage: "55-65", value: 800, level: 15, allStats: 5, darknessAura: true, legendary: true }
        ],
        armor: [
            // Vampire Armor
            { id: 20, name: "Cloak of Shadows", type: "armor", defense: 8, value: 40, level: 1, stealthBonus: 1, class: "vampire" },
            { id: 21, name: "Noble's Attire", type: "armor", defense: 15, value: 90, level: 3, bloodRegen: 5, class: "vampire" },
            { id: 22, name: "Count's Regalia", type: "armor", defense: 25, value: 180, level: 5, lifesteal: 0.1, mistForm: true, class: "vampire" },
            { id: 32, name: "Ancient Vampire Lord Armor", type: "armor", defense: 35, value: 350, level: 8, bloodRegen: 10, nightForm: true, class: "vampire" },
            
            // Werewolf Armor
            { id: 23, name: "Wolf Pelt", type: "armor", defense: 10, value: 45, level: 1, rageGain: 5, class: "werewolf" },
            { id: 24, name: "Hunter's Garb", type: "armor", defense: 18, value: 100, level: 3, dodgeChance: 0.1, class: "werewolf" },
            { id: 25, name: "Alpha's Hide", type: "armor", defense: 28, value: 190, level: 5, transformationBonus: 2, packLeader: true, class: "werewolf" },
            { id: 33, name: "Prime Werewolf Fur", type: "armor", defense: 38, value: 380, level: 8, rageGain: 15, primalRage: true, class: "werewolf" },
            
            // Reanimated Armor
            { id: 26, name: "Stitched Leather", type: "armor", defense: 12, value: 50, level: 1, shockResist: 10, class: "reanimated" },
            { id: 27, name: "Galvanic Plate", type: "armor", defense: 20, value: 110, level: 3, lightningRegen: 5, class: "reanimated" },
            { id: 28, name: "The Monster's Frame", type: "armor", defense: 30, value: 200, level: 5, unstoppable: true, shockAura: 5, class: "reanimated" },
            { id: 34, name: "Perfected Creation Armor", type: "armor", defense: 40, value: 400, level: 8, lightningRegen: 10, overloadProtection: true, class: "reanimated" },
            
            // Necromancer Armor
            { id: 29, name: "Necromancer's Robes", type: "armor", defense: 6, value: 55, level: 1, soulCapacity: 1, class: "necromancer" },
            { id: 30, name: "Death Weaver Garb", type: "armor", defense: 16, value: 120, level: 3, minionHealth: 10, class: "necromancer" },
            { id: 31, name: "Lich King Armor", type: "armor", defense: 22, value: 210, level: 5, soulSteal: 0.1, undeadCommand: true, class: "necromancer" },
            { id: 35, name: "Archlich Regalia", type: "armor", defense: 28, value: 420, level: 8, soulCapacity: 2, deathAura: true, class: "necromancer" },
            
            // Hybrid Armor
            { id: 36, name: "Chimera Hide", type: "armor", defense: 32, value: 500, level: 10, allResist: 15, adaptiveForm: true, class: "hybrid" },
            { id: 37, name: "Abyssal Carapace", type: "armor", defense: 38, value: 600, level: 12, damageReflect: 0.1, voidProtection: true, class: "hybrid" },
            
            // Legendary Armor
            { id: 60, name: "Shadow Monarch Plate", type: "armor", defense: 45, value: 800, level: 15, allStats: 3, shadowForm: true, legendary: true }
        ],
        consumables: [
            { id: 40, name: "Blood Vial", type: "consumable", effect: { blood: 50 }, value: 30, class: "vampire" },
            { id: 41, name: "Rage Potion", type: "consumable", effect: { rage: 50 }, value: 35, class: "werewolf" },
            { id: 42, name: "Lightning Cell", type: "consumable", effect: { lightning: 50 }, value: 40, class: "reanimated" },
            { id: 43, name: "Soul Shard", type: "consumable", effect: { souls: 1 }, value: 50, class: "necromancer" },
            { id: 44, name: "Health Potion", type: "consumable", effect: { health: 50 }, value: 25 },
            { id: 45, name: "Elixir of Darkness", type: "consumable", effect: { allResources: 25 }, value: 60 },
            { id: 46, name: "Potion of Transformation", type: "consumable", effect: { transform: true }, value: 100 },
            { id: 47, name: "Greater Blood Vial", type: "consumable", effect: { blood: 100 }, value: 60, class: "vampire" },
            { id: 48, name: "Primal Rage Elixir", type: "consumable", effect: { rage: 100 }, value: 70, class: "werewolf" },
            { id: 49, name: "Overcharge Cell", type: "consumable", effect: { lightning: 100 }, value: 80, class: "reanimated" },
            { id: 55, name: "Soul Crystal", type: "consumable", effect: { souls: 2 }, value: 100, class: "necromancer" },
            { id: 56, name: "Potion of Ultimate Power", type: "consumable", effect: { allStats: 5 }, value: 200, duration: 10 }
        ],
        crafting: [
            { id: 70, name: "Moonstone Shard", type: "material", value: 25, description: "Used for crafting lunar items" },
            { id: 71, name: "Ancient Blood Crystal", type: "material", value: 30, description: "Used for crafting vampire items" },
            { id: 72, name: "Storm Core", type: "material", value: 35, description: "Used for crafting reanimated items" },
            { id: 73, name: "Soul Essence", type: "material", value: 40, description: "Used for crafting necromancer items" }
        ]
    },
    shopItems: [],
    gameLog: [],
    classDescriptions: {
        vampire: "The Vampire Lord commands the night with elegance and thirst. Uses Blood to power abilities and can transform into mist. Weak to sunlight but gains power from darkness. Master of lifesteal and hypnotic powers.",
        werewolf: "The Lycanthrope is a primal force of nature. Builds Rage in combat to unleash devastating transformations. Strongest during full moons. Excels in physical combat with savage claws and terrifying howls.",
        reanimated: "The Reanimated is an unstoppable force of science gone wrong. Uses Lightning energy to power abilities and can absorb massive damage. Slow but incredibly resilient with shocking attacks.",
        necromancer: "The Necromancer commands the dead with dark magic. Collects Souls to raise undead minions and cast powerful death spells. Frail but supported by an army of the dead.",
        hybrid: "The Hybrid Monster combines traits from multiple monster types. Starts weaker but can evolve into unique forms. Gains bonus talent points and can mix abilities from different classes."
    },
    classSkills: {
        vampire: [
            { name: "Blood Drain", cost: 20, damage: 25, description: "Drain enemy blood to heal yourself", lifesteal: 0.5 },
            { name: "Hypnotic Gaze", cost: 15, description: "Charm enemy to skip their turn", charmChance: 0.4 },
            { name: "Mist Form", cost: 30, description: "Become intangible for 2 turns, avoiding damage" },
            { name: "Children of the Night", cost: 25, description: "Summon bats to distract all enemies" },
            { name: "Blood Fury", cost: 40, description: "Enter a blood frenzy, increasing damage by 50% for 3 turns" }
        ],
        werewolf: [
            { name: "Claw Swipe", cost: 15, damageMultiplier: 1.5, description: "Savage attack that causes bleeding", bleedChance: 0.3 },
            { name: "Primal Howl", cost: 20, description: "Fear all enemies, reducing their damage", fearChance: 0.5 },
            { name: "Lunar Transformation", cost: 50, description: "Transform into werewolf form for 3 turns", requiresRage: 50 },
            { name: "Hunter's Senses", cost: 10, description: "Increase critical chance for 3 turns" },
            { name: "Pack Alpha", cost: 35, description: "Summon spectral wolves to fight alongside you" }
        ],
        reanimated: [
            { name: "Lightning Strike", cost: 20, damage: 30, description: "Electrocute enemy with shocking power", stunChance: 0.2 },
            { name: "Unyielding Flesh", cost: 25, description: "Reduce all damage by 50% for 2 turns" },
            { name: "Shock Aura", cost: 30, description: "Create an electric field that damages all enemies each turn", duration: 3 },
            { name: "Overload", cost: 40, description: "Release all stored energy for massive damage", damageMultiplier: 2 },
            { name: "Chain Lightning", cost: 35, description: "Lightning that jumps between multiple enemies" }
        ],
        necromancer: [
            { name: "Raise Dead", cost: 1, description: "Summon a skeletal warrior to fight for you", requiresSouls: 1 },
            { name: "Soul Drain", cost: 0, damage: 20, description: "Drain enemy life force to gain souls", soulGain: 0.3 },
            { name: "Death Curse", cost: 2, description: "Curse all enemies to take damage over time", requiresSouls: 2 },
            { name: "Army of the Dead", cost: 3, description: "Summon multiple undead minions at once", requiresSouls: 3 },
            { name: "Necrotic Blast", cost: 25, description: "Powerful death magic that ignores armor" }
        ],
        hybrid: [
            { name: "Adaptive Strike", cost: 20, description: "Attack that changes type based on your current form" },
            { name: "Monstrous Evolution", cost: 0, description: "Switch between different monster forms", transform: true },
            { name: "Hybrid Resilience", cost: 25, description: "Gain resistance to all damage types for 3 turns" },
            { name: "Chaos Surge", cost: 40, description: "Unleash raw chaotic energy on all enemies" }
        ]
    },
    talentTrees: {
        vampire: {
            "Blood Mastery": { maxPoints: 5, effect: "Increases lifesteal by 2% per point", currentPoints: 0 },
            "Shadow Arts": { maxPoints: 3, effect: "Increases stealth and dodge chance by 3% per point", currentPoints: 0 },
            "Ancient Power": { maxPoints: 5, effect: "Increases all damage by 3% per point", currentPoints: 0 },
            "Mist Form Mastery": { maxPoints: 1, effect: "Mist Form now also heals you each turn", currentPoints: 0 },
            "Night Lord": { maxPoints: 1, effect: "Unlocks ultimate vampire form", currentPoints: 0 }
        },
        werewolf: {
            "Savage Fury": { maxPoints: 5, effect: "Increases critical damage by 10% per point", currentPoints: 0 },
            "Lunar Bond": { maxPoints: 3, effect: "Gain bonus rage during full moons", currentPoints: 0 },
            "Primal Resilience": { maxPoints: 5, effect: "Increases health by 5% per point", currentPoints: 0 },
            "Alpha Presence": { maxPoints: 1, effect: "Your howls now also buff your minions", currentPoints: 0 },
            "Prime Werewolf": { maxPoints: 1, effect: "Unlocks ultimate werewolf form", currentPoints: 0 }
        },
        reanimated: {
            "Lightning Conduit": { maxPoints: 5, effect: "Increases shock damage by 4% per point", currentPoints: 0 },
            "Unbreakable": { maxPoints: 3, effect: "Reduces all damage taken by 3% per point", currentPoints: 0 },
            "Energy Storage": { maxPoints: 5, effect: "Increases maximum lightning by 10 per point", currentPoints: 0 },
            "Living Battery": { maxPoints: 1, effect: "Overload now stuns all enemies", currentPoints: 0 },
            "Perfect Creation": { maxPoints: 1, effect: "Unlocks ultimate reanimated form", currentPoints: 0 }
        },
        necromancer: {
            "Death Magic": { maxPoints: 5, effect: "Increases minion damage by 5% per point", currentPoints: 0 },
            "Soul Harvest": { maxPoints: 3, effect: "Increases soul gain by 10% per point", currentPoints: 0 },
            "Dark Resilience": { maxPoints: 5, effect: "Increases magic resistance by 4% per point", currentPoints: 0 },
            "Master of Death": { maxPoints: 1, effect: "Your minions can now be resurrected once", currentPoints: 0 },
            "Archlich": { maxPoints: 1, effect: "Unlocks ultimate necromancer form", currentPoints: 0 }
        },
        hybrid: {
            "Adaptive Evolution": { maxPoints: 5, effect: "Increases all stats by 1 per point", currentPoints: 0 },
            "Monstrous Fusion": { maxPoints: 3, effect: "Unlocks new hybrid forms", currentPoints: 0 },
            "Chaos Mastery": { maxPoints: 5, effect: "Increases all damage by 2% per point", currentPoints: 0 },
            "Perfect Hybrid": { maxPoints: 1, effect: "Unlocks ultimate hybrid form", currentPoints: 0 }
        }
    },
    quests: [
        { id: 1, name: "First Blood", description: "Defeat 3 villagers in Transylvania", objective: { type: "kill", target: "Torch-wielding Villager", count: 3, current: 0 }, reward: { gold: 100, xp: 150, item: 40 }, area: "Transylvania Village", level: 1 },
        { id: 2, name: "Night Hunter", description: "Collect 5 wolf pelts from the Black Forest", objective: { type: "collect", target: "Wolf Pelt", count: 5, current: 0 }, reward: { gold: 200, xp: 300, item: 41 }, area: "Black Forest", level: 5 },
        { id: 3, name: "Castle Invader", description: "Defeat Count Dracula", objective: { type: "kill", target: "Count Dracula", count: 1, current: 0 }, reward: { gold: 500, xp: 800, item: 50 }, area: "Castle Dracula", level: 8 },
        { id: 4, name: "Mad Science", description: "Survive Frankenstein's experiments", objective: { type: "kill", target: "The Creature", count: 1, current: 0 }, reward: { gold: 600, xp: 1000, item: 52 }, area: "Frankenstein's Lab", level: 12 },
        { id: 5, name: "King of Shadows", description: "Defeat the Shadow King", objective: { type: "kill", target: "Shadow King", count: 1, current: 0 }, reward: { gold: 1000, xp: 2000, item: 53 }, area: "Shadow Realm", level: 20 }
    ],
    bossDefeated: {},
    achievements: [
        { id: 1, name: "First Hunt", description: "Defeat your first human", unlocked: false },
        { id: 2, name: "Night Creature", description: "Reach level 5", unlocked: false },
        { id: 3, name: "Monster Lord", description: "Reach level 10", unlocked: false },
        { id: 4, name: "Legend of the Night", description: "Reach level 20", unlocked: false },
        { id: 5, name: "Dracula's Bane", description: "Defeat Count Dracula", unlocked: false },
        { id: 6, name: "Alpha Slayer", description: "Defeat the Alpha Werewolf", unlocked: false },
        { id: 7, name: "Creation's End", description: "Defeat The Creature", unlocked: false },
        { id: 8, name: "Shadow Vanquisher", description: "Defeat the Shadow King", unlocked: false },
        { id: 9, name: "Prestigious Monster", description: "Reach Prestige Level 1", unlocked: false },
        { id: 10, name: "Dungeon Delver", description: "Reach Infinite Dungeon Level 10", unlocked: false },
        { id: 11, name: "Boss Slayer", description: "Complete Boss Rush", unlocked: false },
        { id: 12, name: "Hybrid Horror", description: "Unlock all hybrid forms", unlocked: false }
    ],
    timeCycle: 0, // 0-23, 18-5 is night
    moonPhases: ["Full", "Waning", "New", "Waxing"],
    currentMoonPhase: 0,
    // New systems
    infiniteDungeon: {
        currentLevel: 0,
        enemies: [],
        rewards: []
    },
    bossRush: {
        currentBoss: 0,
        bosses: [],
        completed: false
    },
    prestigeBonuses: [
        { level: 1, bonus: "Permanent +10% to all stats" },
        { level: 2, bonus: "Permanent +1 talent point per level" },
        { level: 3, bonus: "Permanent +20% gold and XP gain" },
        { level: 4, bonus: "Unlock legendary starting items" },
        { level: 5, bonus: "Permanent +25% to all stats" }
    ],
    hybridForms: {
        "Vampire-Werewolf": { name: "Vampwolf", description: "Combines vampire elegance with werewolf savagery" },
        "Werewolf-Reanimated": { name: "Thunderwolf", description: "Electricity-enhanced primal fury" },
        "Reanimated-Necromancer": { name: "Death Golem", description: "Animated construct with death magic" },
        "Necromancer-Vampire": { name: "Blood Lich", description: "Undead master of blood and souls" },
        "All Forms": { name: "True Abomination", description: "The ultimate fusion of all monster types" }
    },
    difficultySettings: {
        easy: { enemyHealth: 0.7, enemyDamage: 0.7, xpMultiplier: 0.8, goldMultiplier: 0.8 },
        normal: { enemyHealth: 1.0, enemyDamage: 1.0, xpMultiplier: 1.0, goldMultiplier: 1.0 },
        hard: { enemyHealth: 1.3, enemyDamage: 1.3, xpMultiplier: 1.2, goldMultiplier: 1.2 },
        nightmare: { enemyHealth: 1.7, enemyDamage: 1.7, xpMultiplier: 1.5, goldMultiplier: 1.5 }
    }
};

// Audio elements
const bgMusic = document.getElementById("background-music");
const combatSound = document.getElementById("combat-sound");
const victorySound = document.getElementById("victory-sound");

// Initialize the game
function initGame() {
    updateGameScreen();
    generateShopItems();
    generateQuests();
    updateTimeAndMoon();
    updateDifficultyIndicator();
    addTooltips();
    updateQuickSlots();
    
    // Start background music
    try {
        bgMusic.volume = 0.3;
        bgMusic.play().catch(e => console.log("Autoplay prevented:", e));
    } catch (e) {
        console.log("Audio error:", e);
    }
    
    // Start auto-save
    setInterval(autoSave, 120000);
}

// Auto-save feature
function autoSave() {
    if (gameState.player.class) { // Only if game has started
        saveGame();
        // Show subtle auto-save indicator
        const indicator = document.createElement('div');
        indicator.className = 'auto-save-indicator';
        indicator.textContent = 'Auto-saved';
        document.body.appendChild(indicator);
        setTimeout(() => indicator.remove(), 2000);
    }
}

// Add tooltips to elements
function addTooltips() {
    // Tooltips are now added via HTML data-tooltip attribute
    // This function can be expanded to add dynamic tooltips
}

// Switch between tabs
function switchTab(tabName) {
    // Update active tab
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Show corresponding screen
    showScreen(tabName);
}

// Update time and moon phase
function updateTimeAndMoon() {
    gameState.timeCycle = (gameState.timeCycle + 1) % 24;
    gameState.player.isDaytime = gameState.timeCycle >= 6 && gameState.timeCycle <= 17;
    
    // Update moon phase every 6 hours
    if (gameState.timeCycle % 6 === 0) {
        gameState.currentMoonPhase = (gameState.currentMoonPhase + 1) % 4;
        gameState.player.moonPhase = gameState.moonPhases[gameState.currentMoonPhase];
    }
    
    // Update display
    document.getElementById("moon-phase").textContent = `Moon: ${gameState.player.moonPhase}`;
    document.getElementById("time-display").textContent = `Time: ${gameState.timeCycle}:00 ${gameState.player.isDaytime ? '' : ''}`;
    
    // Apply time-based effects
    applyTimeEffects();
}

// Apply effects based on time and moon
function applyTimeEffects() {
    const player = gameState.player;
    
    // Vampire day/night effects
    if (player.class === 'vampire') {
        if (player.isDaytime) {
            player.health = Math.max(1, player.health - 5);
            addToGameLog("<span class='debuff'>The sunlight weakens you!</span>");
        }
    }
    
    // Werewolf moon effects
    if (player.class === 'werewolf' && player.moonPhase === "Full") {
        player.rage += 10;
        addToGameLog("<span class='important'>The full moon empowers you!</span>");
    }
}

// Toggle background music
function toggleMusic() {
    if (bgMusic.paused) {
        bgMusic.play();
        addToGameLog("Music enabled");
    } else {
        bgMusic.pause();
        addToGameLog("Music disabled");
    }
}

// Toggle difficulty
function toggleDifficulty() {
    const difficulties = Object.keys(gameState.difficultySettings);
    const currentIndex = difficulties.indexOf(gameState.player.difficulty);
    const nextIndex = (currentIndex + 1) % difficulties.length;
    gameState.player.difficulty = difficulties[nextIndex];
    
    document.querySelector('.music-controls button:nth-child(2)').textContent = 
        `DIFFICULTY: ${gameState.player.difficulty.toUpperCase()}`;
    
    updateDifficultyIndicator();
    addToGameLog(`Difficulty set to ${gameState.player.difficulty.toUpperCase()}`);
}

// Update difficulty indicator
function updateDifficultyIndicator() {
    const indicator = document.getElementById("difficulty-indicator");
    const difficulty = gameState.player.difficulty;
    let color = "#4caf50"; // Easy - green
    
    if (difficulty === "normal") color = "#ff6f00"; // Normal - orange
    if (difficulty === "hard") color = "#c62828"; // Hard - red
    if (difficulty === "nightmare") color = "#6a1b9a"; // Nightmare - purple
    
    indicator.textContent = `DIFFICULTY: ${difficulty.toUpperCase()}`;
    indicator.style.color = color;
}

// Save game to localStorage
function saveGame() {
    try {
        localStorage.setItem("legacy_of_night_save", JSON.stringify(gameState));
        addToGameLog("Game saved successfully!");
        showAchievement("Game Saved", "Your dark progress has been preserved");
    } catch (e) {
        addToGameLog("Failed to save game: " + e.message);
    }
}

// Load game from localStorage
function loadGame() {
    try {
        const savedGame = localStorage.getItem("legacy_of_night_save");
        if (savedGame) {
            const parsed = JSON.parse(savedGame);
            Object.assign(gameState, parsed);
            addToGameLog("Game loaded successfully!");
            updateGameScreen();
            showAchievement("Game Loaded", "Your dark legacy continues");
        } else {
            addToGameLog("No saved game found");
        }
    } catch (e) {
        addToGameLog("Failed to load game: " + e.message);
    }
}

// Show achievement notification
function showAchievement(title, description) {
    const toast = document.getElementById("achievement-toast");
    const desc = document.getElementById("achievement-desc");
    
    toast.querySelector(".achievement-title").textContent = title;
    desc.textContent = description;
    
    toast.classList.add("show");
    
    setTimeout(() => {
        toast.classList.remove("show");
    }, 3000);
}

// Check for achievements
function checkAchievements() {
    const player = gameState.player;
    
    // First Hunt
    if (!gameState.achievements[0].unlocked && player.quests.completed.length > 0) {
        gameState.achievements[0].unlocked = true;
        showAchievement("First Hunt", "Defeat your first human");
    }
    
    // Level-based achievements
    if (!gameState.achievements[1].unlocked && player.level >= 5) {
        gameState.achievements[1].unlocked = true;
        showAchievement("Night Creature", "Reached level 5");
    }
    
    if (!gameState.achievements[2].unlocked && player.level >= 10) {
        gameState.achievements[2].unlocked = true;
        showAchievement("Monster Lord", "Reached level 10");
    }
    
    if (!gameState.achievements[3].unlocked && player.level >= 20) {
        gameState.achievements[3].unlocked = true;
        showAchievement("Legend of the Night", "Reached level 20");
    }
    
    // Boss achievements
    if (!gameState.achievements[4].unlocked && gameState.bossDefeated["Castle Dracula"]) {
        gameState.achievements[4].unlocked = true;
        showAchievement("Dracula's Bane", "Defeated Count Dracula");
    }
    
    if (!gameState.achievements[5].unlocked && gameState.bossDefeated["Black Forest"]) {
        gameState.achievements[5].unlocked = true;
        showAchievement("Alpha Slayer", "Defeated the Alpha Werewolf");
    }
    
    if (!gameState.achievements[6].unlocked && gameState.bossDefeated["Frankenstein's Lab"]) {
        gameState.achievements[6].unlocked = true;
        showAchievement("Creation's End", "Defeated The Creature");
    }
    
    if (!gameState.achievements[7].unlocked && gameState.bossDefeated["Shadow Realm"]) {
        gameState.achievements[7].unlocked = true;
        showAchievement("Shadow Vanquisher", "Defeated the Shadow King");
    }
    
    // New achievements
    if (!gameState.achievements[8].unlocked && player.prestigeLevel >= 1) {
        gameState.achievements[8].unlocked = true;
        showAchievement("Prestigious Monster", "Reached Prestige Level 1");
    }
    
    if (!gameState.achievements[9].unlocked && player.infiniteDungeonLevel >= 10) {
        gameState.achievements[9].unlocked = true;
        showAchievement("Dungeon Delver", "Reached Infinite Dungeon Level 10");
    }
    
    if (!gameState.achievements[10].unlocked && player.bossRushLevel > 0) {
        gameState.achievements[10].unlocked = true;
        showAchievement("Boss Slayer", "Completed Boss Rush");
    }
    
    if (!gameState.achievements[11].unlocked && player.class === 'hybrid' && 
        Object.keys(gameState.hybridForms).every(form => player.hybridForm === form || player.hybridFormsUnlocked?.includes(form))) {
        gameState.achievements[11].unlocked = true;
        showAchievement("Hybrid Horror", "Unlocked all hybrid forms");
    }
}

// Update the main game screen with the game log
function updateGameScreen() {
    const gameScreen = document.getElementById("game-screen");
    gameScreen.innerHTML = gameState.gameLog.slice(-10).join("<br>");
    gameScreen.scrollTop = gameScreen.scrollHeight;

    updatePlayerStats();
}

// Update player stats display with improved layout
function updatePlayerStats() {
    const statsElement = document.getElementById("player-stats");
    const player = gameState.player;

    let statsHTML = "";
    
    // Basic info
    statsHTML += `<div class="stat-item"><span>Class:</span><span class="stat-value class-${player.class}">${player.class ? player.class.toUpperCase() : ''}</span></div>`;
    
    // Add prestige badge if applicable
    if (player.prestigeLevel > 0) {
        statsHTML += `<div class="stat-item"><span>Prestige:</span><span class="prestige-badge">P${player.prestigeLevel}</span></div>`;
    }
    
    statsHTML += `<div class="stat-item"><span>Level:</span><span class="stat-value">${player.level}</span></div>`;
    statsHTML += `<div class="stat-item"><span>Health:</span><span class="stat-value health">${player.health}/${player.maxHealth}</span></div>`;

    // Class-specific resource
    if (player.class === 'vampire') {
        statsHTML += `<div class="stat-item"><span>Blood:</span><span class="stat-value blood">${player.blood}/${player.maxBlood}</span></div>`;
    } else if (player.class === 'werewolf') {
        statsHTML += `<div class="stat-item"><span>Rage:</span><span class="stat-value rage">${player.rage}/${player.maxRage}</span></div>`;
    } else if (player.class === 'reanimated') {
        statsHTML += `<div class="stat-item"><span>Energy:</span><span class="stat-value lightning">${player.lightning}/${player.maxLightning}</span></div>`;
    } else if (player.class === 'necromancer') {
        statsHTML += `<div class="stat-item"><span>Souls:</span><span class="stat-value souls">${player.souls}/${player.maxSouls}</span></div>`;
    } else if (player.class === 'hybrid') {
        statsHTML += `<div class="stat-item"><span>Form:</span><span class="stat-value souls">${player.hybridForm || 'Base'}</span></div>`;
    }

    statsHTML += `<div class="stat-item"><span>XP:</span><span class="stat-value xp">${player.xp}/${player.xpToNextLevel}</span></div>`;
    statsHTML += `<div class="stat-item"><span>Gold:</span><span class="stat-value gold">${player.gold}</span></div>`;

    // Add progress bars
    statsHTML += `<div class="progress-container"><div class="progress-bar health-bar" style="width: ${(player.health / player.maxHealth) * 100}%"></div></div>`;

    // Class-specific resource bar
    if (player.class === 'vampire') {
        statsHTML += `<div class="progress-container"><div class="progress-bar blood-bar" style="width: ${(player.blood / player.maxBlood) * 100}%"></div></div>`;
    } else if (player.class === 'werewolf') {
        statsHTML += `<div class="progress-container"><div class="progress-bar rage-bar" style="width: ${(player.rage / player.maxRage) * 100}%"></div></div>`;
    } else if (player.class === 'reanimated') {
        statsHTML += `<div class="progress-container"><div class="progress-bar lightning-bar" style="width: ${(player.lightning / player.maxLightning) * 100}%"></div></div>`;
    } else if (player.class === 'necromancer') {
        statsHTML += `<div class="progress-container"><div class="progress-bar souls-bar" style="width: ${(player.souls / player.maxSouls) * 100}%"></div></div>`;
    }

    statsHTML += `<div class="progress-container"><div class="progress-bar xp-bar" style="width: ${(player.xp / player.xpToNextLevel) * 100}%"></div></div>`;
    
    // Combo meter
    if (player.comboCounter > 0) {
        statsHTML += `<div class="combo-meter" style="width: ${Math.min(100, player.comboCounter * 10)}%"></div>`;
        statsHTML += `<div class="stat-item"><span>Combo:</span><span class="stat-value important">x${player.comboMultiplier.toFixed(1)}</span></div>`;
    }

    if (player.equippedWeapon) {
        statsHTML += `<div class="stat-item"><span>Weapon:</span><span class="stat-value item">${player.equippedWeapon.name}</span></div>`;
    }

    if (player.equippedArmor) {
        statsHTML += `<div class="stat-item"><span>Armor:</span><span class="stat-value item">${player.equippedArmor.name}</span></div>`;
    }

    // Show transformation status
    if (player.transformed) {
        statsHTML += `<div class="stat-item"><span>Status:</span><span class="stat-value important">TRANSFORMED! (${player.transformationTurns} turns)</span></div>`;
    }

    // Show minions for necromancer
    if (player.class === 'necromancer' && player.minions.length > 0) {
        statsHTML += `<div class="stat-item"><span>Minions:</span><span class="stat-value heal">${player.minions.length}</span></div>`;
    }

    statsElement.innerHTML = statsHTML;
}

// Show different game screens
function showScreen(screen) {
    document.getElementById("explore-screen").style.display = "none";
    document.getElementById("character-screen").style.display = "none";
    document.getElementById("inventory-screen").style.display = "none";
    document.getElementById("shop-screen").style.display = "none";
    document.getElementById("combat-screen").style.display = "none";
    document.getElementById("quests-screen").style.display = "none";
    document.getElementById("talent-screen").style.display = "none";
    document.getElementById("endgame-screen").style.display = "none";
    document.getElementById("prestige-screen").style.display = "none";
    document.getElementById("main-buttons").style.display = "flex";

    if (screen === "explore") {
        document.getElementById("explore-screen").style.display = "block";
        addToGameLog(`You are stalking the ${gameState.player.currentArea}.`);
    } else if (screen === "character") {
        document.getElementById("character-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showCharacterScreen();
    } else if (screen === "inventory") {
        document.getElementById("inventory-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showInventory();
    } else if (screen === "shop") {
        document.getElementById("shop-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showShop();
    } else if (screen === "main") {
        // Already handled by hiding others
    } else if (screen === "combat") {
        document.getElementById("combat-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        updateCombatScreen();
    } else if (screen === "quests") {
        document.getElementById("quests-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showQuests();
    } else if (screen === "talent") {
        document.getElementById("talent-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showTalentTree();
    } else if (screen === "endgame") {
        document.getElementById("endgame-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showEndgameScreen();
    } else if (screen === "prestige") {
        document.getElementById("prestige-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showPrestigeScreen();
    }

    updateGameScreen();
}

// Add message to game log
function addToGameLog(message) {
    gameState.gameLog.push(message);
    if (gameState.gameLog.length > 50) {
        gameState.gameLog.shift();
    }
    updateGameScreen();
}

// Explore area function
function exploreArea() {
    const player = gameState.player;

    // Update time
    updateTimeAndMoon();

    // Check for boss spawn (5% chance if not already defeated)
    if (!gameState.bossDefeated[player.currentArea] && Math.random() < 0.05) {
        startBossFight();
        return;
    }

    // Chance to find combat, items, or nothing
    const roll = Math.random();

    if (roll < 0.7) { // 70% chance for combat
        startCombat();
    } else if (roll < 0.9) { // 20% chance to find item
        findItem();
    } else { // 10% chance to find nothing
        addToGameLog("You stalk the shadows but find nothing worthy of your attention.");
    }
}

// Start a boss fight
function startBossFight() {
    const player = gameState.player;
    const boss = {...gameState.bosses[player.currentArea]};
    
    // Apply difficulty scaling
    const difficulty = gameState.difficultySettings[player.difficulty];
    boss.health = Math.floor(boss.health * difficulty.enemyHealth);
    boss.maxHealth = boss.health;

    gameState.player.inCombat = true;
    gameState.player.currentEnemy = boss;

    addToGameLog(`<span class="enemy">${boss.name} (Lvl ${boss.level}) challenges you!</span>`);
    addToGameLog("<span class='important'>BOSS FIGHT!</span>");
    
    // Play combat music
    try {
        bgMusic.pause();
        combatSound.currentTime = 0;
        combatSound.play();
    } catch (e) {
        console.log("Audio error:", e);
    }
    
    showScreen("combat");
}

function changeArea() {
    const player = gameState.player;
    const availableAreas = gameState.areas.filter(area => area.unlocked && area.name !== player.currentArea);

    if (availableAreas.length === 0) {
        addToGameLog("No other hunting grounds are available yet. Grow stronger!");
        return;
    }

    // Create a container for the area selection
    const areaSelection = document.createElement("div");
    areaSelection.innerHTML = "<h3>Available Hunting Grounds:</h3>";
    
    availableAreas.forEach(area => {
        const areaBtn = document.createElement("button");
        areaBtn.className = "game-button";
        areaBtn.style.textAlign = "left";
        areaBtn.style.margin = "2px 0";
        areaBtn.style.padding = "5px";
        areaBtn.innerHTML = `${area.name} (Level ${area.minLevel}+)<br><small>${area.description}</small>`;
        areaBtn.onclick = function() { travelToArea(area.name); };
        areaSelection.appendChild(areaBtn);
        areaSelection.appendChild(document.createElement("br"));
    });

    // Replace the explore screen content while preserving the button row
    const exploreScreen = document.getElementById("explore-screen");
    exploreScreen.innerHTML = "";
    exploreScreen.appendChild(areaSelection);
    
    // Re-add the button row
    const buttonRow = document.createElement("div");
    buttonRow.className = "button-row";
    buttonRow.innerHTML = `
        <button class="game-button" onclick="showScreen('explore')">BACK</button>
    `;
    exploreScreen.appendChild(buttonRow);
}

function travelToArea(areaName) {
    const player = gameState.player;
    player.currentArea = areaName;
    addToGameLog(`You travel to the ${areaName}.`);
    
    // Restore the original explore screen content
    document.getElementById("explore-screen").innerHTML = `
        <div class="button-row">
            <button class="game-button" onclick="exploreArea()">HUNT</button>
            <button class="game-button" onclick="rest()">REST</button>
            <button class="game-button" onclick="changeArea()">TRAVEL</button>
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    `;
    
    // Add visual feedback
    document.getElementById("game-screen").classList.add("fade-in");
    setTimeout(() => {
        document.getElementById("game-screen").classList.remove("fade-in");
    }, 500);
}

// Start combat with random enemy
function startCombat() {
    const player = gameState.player;
    const areaEnemies = gameState.enemies[player.currentArea];
    const randomEnemy = {...areaEnemies[Math.floor(Math.random() * areaEnemies.length)]};
    
    // Apply difficulty scaling
    const difficulty = gameState.difficultySettings[player.difficulty];
    randomEnemy.health = Math.floor(randomEnemy.health * difficulty.enemyHealth);
    randomEnemy.maxHealth = randomEnemy.health;

    gameState.player.inCombat = true;
    gameState.player.currentEnemy = randomEnemy;

    addToGameLog(`<span class="enemy">A ${randomEnemy.name} (Lvl ${randomEnemy.level}) confronts you!</span>`);
    
    // Play combat music
    try {
        bgMusic.pause();
        combatSound.currentTime = 0;
        combatSound.play();
    } catch (e) {
        console.log("Audio error:", e);
    }
    
    showScreen("combat");
}

// Update combat screen
function updateCombatScreen() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    if (!enemy) return;

    let combatHTML = `<span class="enemy">${enemy.name} (Lvl ${enemy.level})</span><br>`;
    combatHTML += `<span class="health">HP: ${enemy.health}/${enemy.maxHealth}</span>`;
    combatHTML += `<div class="enemy-health-container"><div class="enemy-health-bar" style="width: ${(enemy.health / enemy.maxHealth) * 100}%"></div></div><br>`;

    combatHTML += `<br><br>What dark power will you unleash?`;

    document.getElementById("combat-info").innerHTML = combatHTML;

    // Create combat actions
    const actionsDiv = document.getElementById("combat-actions");
    actionsDiv.innerHTML = "";

    // Basic attack
    const attackBtn = document.createElement("button");
    attackBtn.className = "game-button";
    attackBtn.textContent = "ATTACK";
    attackBtn.onclick = function() { playerAttack(); };
    actionsDiv.appendChild(attackBtn);

    // Class skills
    player.skills.forEach(skill => {
        const skillBtn = document.createElement("button");
        skillBtn.className = "game-button";
        skillBtn.textContent = skill.name.toUpperCase();
        skillBtn.onclick = function() { useSkill(skill); };

        // Disable if not enough resource
        let canUse = true;
        if (player.class === 'vampire' && player.blood < skill.cost) canUse = false;
        if (player.class === 'werewolf' && player.rage < skill.cost) canUse = false;
        if (player.class === 'reanimated' && player.lightning < skill.cost) canUse = false;
        if (player.class === 'necromancer' && skill.requiresSouls && player.souls < skill.requiresSouls) canUse = false;
        if (player.class === 'hybrid' && player.blood < skill.cost && player.rage < skill.cost && player.lightning < skill.cost) canUse = false;

        if (!canUse) {
            skillBtn.disabled = true;
        }

        actionsDiv.appendChild(skillBtn);
    });

    // Flee button
    const fleeBtn = document.createElement("button");
    fleeBtn.className = "game-button";
    fleeBtn.textContent = "FLEE";
    fleeBtn.onclick = function() { attemptFlee(); };
    actionsDiv.appendChild(fleeBtn);

    // Use item button
    const itemsBtn = document.createElement("button");
    itemsBtn.className = "game-button";
    itemsBtn.textContent = "ITEMS";
    itemsBtn.onclick = function() { showCombatItems(); };
    actionsDiv.appendChild(itemsBtn);
}

// Player attack in combat
function playerAttack() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    if (!enemy) return;

    let damage = 5; // Base damage

    // Calculate damage based on weapon
    if (player.equippedWeapon) {
        const damageRange = player.equippedWeapon.damage.split("-").map(Number);
        damage = Math.floor(Math.random() * (damageRange[1] - damageRange[0] + 1)) + damageRange[0];

        // Add stat bonuses based on class
        if (player.class === 'vampire' || player.class === 'werewolf') {
            damage += Math.floor(player.strength / 2);
        } else if (player.class === 'necromancer') {
            damage += Math.floor(player.intelligence / 2);
        } else if (player.class === 'hybrid') {
            damage += Math.floor((player.strength + player.intelligence) / 3);
        }

        // Apply combo multiplier
        damage = Math.floor(damage * player.comboMultiplier);

        // Check for critical hit
        let critChance = 0.1; // Base 10% chance
        if (player.equippedWeapon.critChance) {
            critChance += player.equippedWeapon.critChance;
        }

        if (Math.random() < critChance) {
            damage *= 2;
            addToGameLog(`<span class="critical">Critical hit!</span> You attack the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
        } else {
            addToGameLog(`You attack the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
        }

        // Check for weapon special effects
        if (player.equippedWeapon.lifesteal) {
            const healAmount = Math.floor(damage * player.equippedWeapon.lifesteal);
            player.health = Math.min(player.maxHealth, player.health + healAmount);
            addToGameLog(`You steal <span class="heal">${healAmount}</span> health!`);
        }
    } else {
        // Bare hands
        damage += Math.floor(player.strength / 3);
        // Apply combo multiplier
        damage = Math.floor(damage * player.comboMultiplier);
        addToGameLog(`You strike the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
    }

    // Apply enemy armor reduction
    if (enemy.armor) {
        damage = Math.max(1, damage - enemy.armor);
    }

    enemy.health -= damage;

    // Update combo
    updateCombo();

    // Check if enemy is defeated
    if (enemy.health <= 0) {
        enemy.health = 0;
        defeatEnemy();
    } else {
        enemyAttack();
    }

    updateCombatScreen();
}

// Update combo system
function updateCombo() {
    const player = gameState.player;
    player.comboCounter++;
    player.comboMultiplier = 1 + (player.comboCounter * 0.1);
    
    if (player.comboCounter > 0) {
        addToGameLog(`<span class="important">Combo x${player.comboMultiplier.toFixed(1)}!</span>`);
    }
}

// Reset combo
function resetCombo() {
    gameState.player.comboCounter = 0;
    gameState.player.comboMultiplier = 1;
}

// Use skill in combat
function useSkill(skill) {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    if (!enemy) return;

    // Deduct resource cost
    if (player.class === 'vampire') {
        player.blood -= skill.cost;
    } else if (player.class === 'werewolf') {
        player.rage -= skill.cost;
    } else if (player.class === 'reanimated') {
        player.lightning -= skill.cost;
    } else if (player.class === 'necromancer' && skill.requiresSouls) {
        player.souls -= skill.requiresSouls;
    } else if (player.class === 'hybrid') {
        // Hybrid can use any resource
        if (player.blood >= skill.cost) {
            player.blood -= skill.cost;
        } else if (player.rage >= skill.cost) {
            player.rage -= skill.cost;
        } else if (player.lightning >= skill.cost) {
            player.lightning -= skill.cost;
        }
    }

    // Handle different skills
    if (skill.damageMultiplier) {
        let damage = 5; // Base damage

        if (player.equippedWeapon) {
            const damageRange = player.equippedWeapon.damage.split("-").map(Number);
            damage = Math.floor(Math.random() * (damageRange[1] - damageRange[0] + 1)) + damageRange[0];
        }

        damage = Math.floor(damage * skill.damageMultiplier);

        // Add stat bonuses
        if (player.class === 'vampire' || player.class === 'werewolf') {
            damage += Math.floor(player.strength / 2);
        } else if (player.class === 'necromancer') {
            damage += Math.floor(player.intelligence);
        } else if (player.class === 'hybrid') {
            damage += Math.floor((player.strength + player.intelligence) / 2);
        }

        // Apply combo multiplier
        damage = Math.floor(damage * player.comboMultiplier);

        addToGameLog(`You use <span class="important">${skill.name}</span> on the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
        enemy.health -= damage;
    } else if (skill.damage) {
        let damage = skill.damage;

        // Scale with stats
        if (player.class === 'vampire' || player.class === 'werewolf') {
            damage += Math.floor(player.strength);
        } else if (player.class === 'necromancer') {
            damage += Math.floor(player.intelligence * 1.5);
        } else if (player.class === 'hybrid') {
            damage += Math.floor((player.strength + player.intelligence) / 1.5);
        }

        // Apply combo multiplier
        damage = Math.floor(damage * player.comboMultiplier);

        addToGameLog(`You use <span class="important">${skill.name}</span> on the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
        enemy.health -= damage;
    } else if (skill.description) {
        addToGameLog(`You use <span class="important">${skill.name}</span>: ${skill.description}`);

        // Handle specific effects
        if (skill.name === "Blood Drain" && skill.lifesteal) {
            const healAmount = Math.floor(damage * skill.lifesteal);
            player.health = Math.min(player.maxHealth, player.health + healAmount);
            addToGameLog(`You drain <span class="heal">${healAmount}</span> health!`);
        } else if (skill.name === "Mist Form") {
            player.buffs.push({
                name: "Mist Form",
                duration: 2,
                effect: "dodge"
            });
        } else if (skill.name === "Lunar Transformation") {
            player.transformed = true;
            player.transformationTurns = 3;
            player.strength += 10;
            addToGameLog("<span class='important'>You transform into a fearsome werewolf!</span>");
        } else if (skill.name === "Raise Dead") {
            player.minions.push({
                name: "Skeletal Warrior",
                health: 50,
                damage: "10-15"
            });
            addToGameLog("<span class='heal'>A skeletal warrior rises to serve you!</span>");
        } else if (skill.name === "Monstrous Evolution" && player.class === 'hybrid') {
            // Hybrid transformation
            const forms = Object.keys(gameState.hybridForms);
            if (!player.hybridForm) {
                player.hybridForm = forms[0];
            } else {
                const currentIndex = forms.indexOf(player.hybridForm);
                player.hybridForm = forms[(currentIndex + 1) % forms.length];
            }
            addToGameLog(`<span class='important'>You transform into a ${gameState.hybridForms[player.hybridForm].name}!</span>`);
        }
    }

    // Update combo
    updateCombo();

    // Check if enemy is defeated
    if (enemy.health <= 0) {
        enemy.health = 0;
        defeatEnemy();
        return;
    }

    enemyAttack();
    
    updateCombatScreen();
}

// Enemy attack in combat
function enemyAttack() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    if (!enemy) return;

    // Check if player is in mist form
    if (player.buffs.some(b => b.effect === "dodge") && Math.random() < 0.8) {
        addToGameLog(`<span class="important">The ${enemy.name}'s attack passes through your mist form!</span>`);
        resetCombo();
        return;
    }

    // Calculate enemy damage
    let damage;
    if (typeof enemy.damage === "string") {
        const damageRange = enemy.damage.split("-").map(Number);
        damage = Math.floor(Math.random() * (damageRange[1] - damageRange[0] + 1)) + damageRange[0];
    } else {
        damage = enemy.damage;
    }

    // Apply difficulty scaling
    const difficulty = gameState.difficultySettings[player.difficulty];
    damage = Math.floor(damage * difficulty.enemyDamage);

    // Add any special damage types
    if (enemy.fireDamage) {
        damage += enemy.fireDamage;
        addToGameLog(`<span class="debuff">The torch burns you for ${enemy.fireDamage} extra damage!</span>`);
    }
    if (enemy.holyDamage && (player.class === 'vampire' || player.class === 'necromancer')) {
        damage += enemy.holyDamage;
        addToGameLog(`<span class="debuff">Holy power smites you for ${enemy.holyDamage} extra damage!</span>`);
    }

    // Reduce damage by armor if equipped
    if (player.equippedArmor) {
        damage -= player.equippedArmor.defense;
        if (damage < 1) damage = 1; // Minimum 1 damage
    }

    player.health -= damage;
    addToGameLog(`The ${enemy.name} attacks you for <span class="damage">${damage}</span> damage!`);

    // Check for enemy lifesteal
    if (enemy.lifesteal) {
        const enemyHeal = Math.floor(damage * enemy.lifesteal);
        enemy.health = Math.min(enemy.maxHealth, enemy.health + enemyHeal);
        addToGameLog(`The ${enemy.name} heals for <span class="heal">${enemyHeal}</span> health!`);
    }

    // Reset combo when hit
    resetCombo();

    // Check if player is defeated
    if (player.health <= 0) {
        player.health = 0;
        addToGameLog(`<span class="enemy">You have been defeated by the ${enemy.name}!</span>`);
        addToGameLog("You awaken later, having lost some gold...");

        // Lose some gold
        let goldLost;
        if (typeof enemy.gold === "string") {
            const goldRange = enemy.gold.split("-").map(Number);
            goldLost = Math.floor(Math.random() * (goldRange[1] - goldRange[0] + 1)) + goldRange[0];
        } else {
            goldLost = Math.floor(enemy.gold * 0.5);
        }

        player.gold -= goldLost;
        if (player.gold < 0) player.gold = 0;

        // Reset health and resources
        player.health = Math.floor(player.maxHealth / 3);
        player.blood = Math.floor(player.maxBlood / 3);
        player.rage = 0;
        player.lightning = Math.floor(player.maxLightning / 3);
        player.souls = 0;

        // End combat
        gameState.player.inCombat = false;
        gameState.player.currentEnemy = null;
        
        // Stop combat music, resume background
        try {
            combatSound.pause();
            bgMusic.currentTime = 0;
            bgMusic.play();
        } catch (e) {
            console.log("Audio error:", e);
        }
        
        showScreen("main");
    }
    
    // Add visual feedback
    document.getElementById("player-stats").classList.add("combat-shake");
    setTimeout(() => {
        document.getElementById("player-stats").classList.remove("combat-shake");
    }, 500);
}

// Attempt to flee from combat
function attemptFlee() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    let fleeChance = 0.6; // Base 60% chance for monsters

    if (Math.random() < fleeChance) {
        addToGameLog(`You vanish into the darkness, escaping the ${enemy.name}!`);
        resetCombo();
        gameState.player.inCombat = false;
        gameState.player.currentEnemy = null;
        
        // Stop combat music, resume background
        try {
            combatSound.pause();
            bgMusic.currentTime = 0;
            bgMusic.play();
        } catch (e) {
            console.log("Audio error:", e);
        }
        
        showScreen("main");
    } else {
        addToGameLog(`The ${enemy.name} blocks your escape!`);
        enemyAttack();
    }
}

// Show items during combat
function showCombatItems() {
    const player = gameState.player;
    const consumables = player.inventory.filter(item => item.type === "consumable");

    const actionsDiv = document.getElementById("combat-actions");
    actionsDiv.innerHTML = "";

    if (consumables.length === 0) {
        const noItemsBtn = document.createElement("button");
        noItemsBtn.className = "game-button";
        noItemsBtn.textContent = "NO ITEMS";
        noItemsBtn.disabled = true;
        actionsDiv.appendChild(noItemsBtn);
    } else {
        consumables.forEach(item => {
            const itemBtn = document.createElement("button");
            itemBtn.className = "game-button";
            itemBtn.textContent = item.name.toUpperCase();
            itemBtn.onclick = function() { useItem(item); };
            actionsDiv.appendChild(itemBtn);
        });
    }

    const backBtn = document.createElement("button");
    backBtn.className = "game-button";
    backBtn.textContent = "BACK";
    backBtn.onclick = function() { updateCombatScreen(); };
    actionsDiv.appendChild(backBtn);
}

// Use item during combat
function useItem(item) {
    const player = gameState.player;

    if (item.effect.health) {
        player.health += item.effect.health;
        if (player.health > player.maxHealth) player.health = player.maxHealth;
        addToGameLog(`You use ${item.name} and restore <span class="heal">${item.effect.health}</span> health!`);
    } else if (item.effect.blood) {
        player.blood += item.effect.blood;
        if (player.blood > player.maxBlood) player.blood = player.maxBlood;
        addToGameLog(`You use ${item.name} and restore <span class="blood">${item.effect.blood}</span> blood!`);
    } else if (item.effect.rage) {
        player.rage += item.effect.rage;
        if (player.rage > player.maxRage) player.rage = player.maxRage;
        addToGameLog(`You use ${item.name} and gain <span class="rage">${item.effect.rage}</span> rage!`);
    } else if (item.effect.lightning) {
        player.lightning += item.effect.lightning;
        if (player.lightning > player.maxLightning) player.lightning = player.maxLightning;
        addToGameLog(`You use ${item.name} and restore <span class="lightning">${item.effect.lightning}</span> energy!`);
    } else if (item.effect.souls) {
        player.souls += item.effect.souls;
        if (player.souls > player.maxSouls) player.souls = player.maxSouls;
        addToGameLog(`You use ${item.name} and gain <span class="souls">${item.effect.souls}</span> souls!`);
    } else if (item.effect.transform) {
        if (player.class === 'werewolf') {
            player.transformed = true;
            player.transformationTurns = 3;
            player.strength += 10;
            addToGameLog("<span class='important'>You transform into a fearsome werewolf!</span>");
        }
    } else if (item.effect.allStats) {
        player.strength += item.effect.allStats;
        player.dexterity += item.effect.allStats;
        player.intelligence += item.effect.allStats;
        player.constitution += item.effect.allStats;
        addToGameLog(`<span class='important'>All your stats increase by ${item.effect.allStats} for ${item.duration} turns!</span>`);
    }

    // Remove item from inventory
    const itemIndex = player.inventory.findIndex(i => i.id === item.id);
    if (itemIndex !== -1) {
        player.inventory.splice(itemIndex, 1);
    }

    enemyAttack();
    updateCombatScreen();
}

// Defeat enemy in combat
function defeatEnemy() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    addToGameLog(`<span class="important">You defeated the ${enemy.name}!</span>`);

    // Check if this was a boss
    if (gameState.bosses[player.currentArea]?.name === enemy.name) {
        gameState.bossDefeated[player.currentArea] = true;
        addToGameLog(`<span class="important">You have conquered ${player.currentArea}!</span>`);
        
        // Play victory sound
        try {
            combatSound.pause();
            victorySound.currentTime = 0;
            victorySound.play();
            setTimeout(() => {
                bgMusic.currentTime = 0;
                bgMusic.play();
            }, 3000);
        } catch (e) {
            console.log("Audio error:", e);
        }
    } else {
        // Resume normal music
        try {
            combatSound.pause();
            bgMusic.currentTime = 0;
            bgMusic.play();
        } catch (e) {
            console.log("Audio error:", e);
        }
    }

    // Apply difficulty XP and gold multipliers
    const difficulty = gameState.difficultySettings[player.difficulty];
    
    // Gain XP
    const xpGain = Math.floor(enemy.xp * difficulty.xpMultiplier);
    player.xp += xpGain;
    addToGameLog(`You gain <span class="xp">${xpGain} XP</span>!`);

    // Gain gold
    let goldGain;
    if (typeof enemy.gold === "string") {
        const goldRange = enemy.gold.split("-").map(Number);
        goldGain = Math.floor(Math.random() * (goldRange[1] - goldRange[0] + 1)) + goldRange[0];
    } else {
        goldGain = enemy.gold;
    }
    goldGain = Math.floor(goldGain * difficulty.goldMultiplier);
    player.gold += goldGain;
    addToGameLog(`You collect <span class="gold">${goldGain} gold</span> from the ${enemy.name}.`);

    // Gain class-specific resource
    if (player.class === 'werewolf') {
        player.rage += 10;
        if (player.rage > player.maxRage) player.rage = player.maxRage;
    } else if (player.class === 'necromancer') {
        player.souls += 0.5;
        if (player.souls > player.maxSouls) player.souls = player.maxSouls;
    }

    // Check for quest progress
    updateQuestProgress(enemy.name);

    // Small chance to find item
    if (Math.random() < 0.3) {
        findItem();
    }

    // Check for level up
    checkLevelUp();

    // Check for area unlocks
    checkAreaUnlocks();
    
    // Check for achievements
    checkAchievements();

    // End combat
    gameState.player.inCombat = false;
    gameState.player.currentEnemy = null;
    showScreen("main");
}

// Check if player levels up
function checkLevelUp() {
    const player = gameState.player;

    if (player.xp >= player.xpToNextLevel) {
        player.level++;
        player.xp -= player.xpToNextLevel;
        player.xpToNextLevel = Math.floor(player.xpToNextLevel * 1.5);

        // Increase stats based on class
        if (player.class === 'vampire') {
            player.maxHealth += 20;
            player.health += 20;
            player.maxBlood += 10;
            player.blood += 10;
            player.strength += 3;
            player.dexterity += 2;
            player.intelligence += 2;
        } else if (player.class === 'werewolf') {
            player.maxHealth += 25;
            player.health += 25;
            player.strength += 4;
            player.constitution += 3;
            player.dexterity += 1;
        } else if (player.class === 'reanimated') {
            player.maxHealth += 30;
            player.health += 30;
            player.maxLightning += 15;
            player.lightning += 15;
            player.strength += 3;
            player.constitution += 4;
        } else if (player.class === 'necromancer') {
            player.maxHealth += 15;
            player.health += 15;
            player.maxSouls += 0.5;
            player.intelligence += 4;
            player.dexterity += 2;
            player.constitution += 1;
        } else if (player.class === 'hybrid') {
            player.maxHealth += 22;
            player.health += 22;
            player.maxBlood += 8;
            player.blood += 8;
            player.maxRage += 8;
            player.maxLightning += 8;
            player.maxSouls += 0.3;
            player.strength += 2;
            player.dexterity += 2;
            player.intelligence += 2;
            player.constitution += 2;
        }

        // Gain talent point every 3 levels
        if (player.level % 3 === 0) {
            player.talentPoints++;
            addToGameLog(`<span class="important">You gained a talent point! You now have ${player.talentPoints} talent points.</span>`);
        }

        // Hybrid gets bonus talent points
        if (player.class === 'hybrid' && player.level % 2 === 0) {
            player.talentPoints++;
            addToGameLog(`<span class="important">Your hybrid nature grants an extra talent point!</span>`);
        }

        addToGameLog(`<span class="important">You leveled up to level ${player.level}!</span>`);
        addToGameLog(`Your monstrous power grows!`);

        // Check for another level up
        checkLevelUp();
    }
}

// Check if new areas should be unlocked
function checkAreaUnlocks() {
    const player = gameState.player;
    gameState.areas.forEach(area => {
        if (!area.unlocked && player.level >= area.minLevel) {
            area.unlocked = true;
            addToGameLog(`<span class="important">New hunting ground unlocked: ${area.name}!</span>`);
        }
    });
}

// Find random item
function findItem() {
    const player = gameState.player;
    
    // Filter items by class and level
    const classItems = [...gameState.items.weapons, ...gameState.items.armor, ...gameState.items.consumables]
        .filter(item => (!item.class || item.class === player.class) && (!item.level || item.level <= player.level));
    
    if (classItems.length === 0) return;
    
    const randomItem = {...classItems[Math.floor(Math.random() * classItems.length)]};
    player.inventory.push(randomItem);
    addToGameLog(`You found a <span class="item">${randomItem.name}</span>!`);
}

// Rest to recover health and resources
function rest() {
    const player = gameState.player;

    // Update time (resting takes time)
    for (let i = 0; i < 6; i++) {
        updateTimeAndMoon();
    }

    const healthRecovered = Math.floor(player.maxHealth * 0.3);
    player.health = Math.min(player.maxHealth, player.health + healthRecovered);

    // Recover class-specific resources
    if (player.class === 'vampire') {
        player.blood = player.maxBlood;
    } else if (player.class === 'werewolf') {
        player.rage = 0; // Rage dissipates
    } else if (player.class === 'reanimated') {
        player.lightning = player.maxLightning;
    } else if (player.class === 'necromancer') {
        // Souls persist through rest
    } else if (player.class === 'hybrid') {
        player.blood = player.maxBlood;
        player.lightning = player.maxLightning;
        // Rage still dissipates for hybrid
    }

    addToGameLog(`You rest in the darkness, recovering <span class="heal">${healthRecovered}</span> health.`);
    updatePlayerStats();
}

// Show character screen
function showCharacterScreen() {
    const player = gameState.player;
    let charHTML = `<div class="screen-section">`;
    charHTML += `<span class="class-${player.class}">${player.class.toUpperCase()}</span> `;
    
    // Add prestige badge if applicable
    if (player.prestigeLevel > 0) {
        charHTML += `<span class="prestige-badge">Prestige ${player.prestigeLevel}</span> `;
    }
    
    charHTML += `<div class="stat-item"><span>Level:</span><span class="stat-value">${player.level}</span></div>`;
    charHTML += `<div class="stat-item"><span>XP:</span><span class="stat-value">${player.xp}/${player.xpToNextLevel}</span></div>`;
    charHTML += `<div class="stat-item"><span>Health:</span><span class="stat-value health">${player.health}/${player.maxHealth}</span></div>`;

    // Class-specific resource
    if (player.class === 'vampire') {
        charHTML += `<div class="stat-item"><span>Blood:</span><span class="stat-value blood">${player.blood}/${player.maxBlood}</span></div>`;
    } else if (player.class === 'werewolf') {
        charHTML += `<div class="stat-item"><span>Rage:</span><span class="stat-value rage">${player.rage}/${player.maxRage}</span></div>`;
    } else if (player.class === 'reanimated') {
        charHTML += `<div class="stat-item"><span>Energy:</span><span class="stat-value lightning">${player.lightning}/${player.maxLightning}</span></div>`;
    } else if (player.class === 'necromancer') {
        charHTML += `<div class="stat-item"><span>Souls:</span><span class="stat-value souls">${player.souls}/${player.maxSouls}</span></div>`;
    } else if (player.class === 'hybrid') {
        charHTML += `<div class="stat-item"><span>Blood:</span><span class="stat-value blood">${player.blood}/${player.maxBlood}</span></div>`;
        charHTML += `<div class="stat-item"><span>Rage:</span><span class="stat-value rage">${player.rage}/${player.maxRage}</span></div>`;
        charHTML += `<div class="stat-item"><span>Energy:</span><span class="stat-value lightning">${player.lightning}/${player.maxLightning}</span></div>`;
        charHTML += `<div class="stat-item"><span>Souls:</span><span class="stat-value souls">${player.souls}/${player.maxSouls}</span></div>`;
    }
    charHTML += `</div>`;

    charHTML += `<div class="screen-section">`;
    charHTML += `<h3>Stats</h3>`;
    charHTML += `<div class="stat-item"><span>Strength:</span><span class="stat-value">${player.strength}</span></div>`;
    charHTML += `<div class="stat-item"><span>Dexterity:</span><span class="stat-value">${player.dexterity}</span></div>`;
    charHTML += `<div class="stat-item"><span>Intelligence:</span><span class="stat-value">${player.intelligence}</span></div>`;
    charHTML += `<div class="stat-item"><span>Constitution:</span><span class="stat-value">${player.constitution}</span></div>`;
    charHTML += `</div>`;

    charHTML += `<div class="screen-section">`;
    charHTML += `<h3>Equipment</h3>`;
    charHTML += `<div class="stat-item"><span>Weapon:</span><span class="stat-value">${player.equippedWeapon ? player.equippedWeapon.name : "None"}</span></div>`;
    charHTML += `<div class="stat-item"><span>Armor:</span><span class="stat-value">${player.equippedArmor ? player.equippedArmor.name : "None"}</span></div>`;
    charHTML += `</div>`;

    charHTML += `<div class="screen-section">`;
    charHTML += `<h3>Location</h3>`;
    charHTML += `<div class="stat-item"><span>Current Area:</span><span class="stat-value">${player.currentArea}</span></div>`;
    charHTML += `<div class="stat-item"><span>Unlocked Areas:</span><span class="stat-value">${gameState.areas.filter(a => a.unlocked).map(a => a.name).join(", ")}</span></div>`;
    charHTML += `</div>`;

    // Show talent points
    if (player.talentPoints > 0) {
        charHTML += `<div class="screen-section">`;
        charHTML += `<h3>Talent Points</h3>`;
        charHTML += `<div class="stat-item"><span>Available:</span><span class="stat-value xp">${player.talentPoints}</span></div>`;
        charHTML += `</div>`;
    }

    // Show transformation status
    if (player.transformed) {
        charHTML += `<div class="screen-section">`;
        charHTML += `<h3>Transformation</h3>`;
        charHTML += `<div class="stat-item"><span>Status:</span><span class="stat-value important">TRANSFORMED! (${player.transformationTurns} turns remaining)</span></div>`;
        charHTML += `</div>`;
    }

    // Show hybrid form
    if (player.class === 'hybrid' && player.hybridForm) {
        charHTML += `<div class="screen-section">`;
        charHTML += `<h3>Hybrid Form</h3>`;
        charHTML += `<div class="stat-item"><span>Current Form:</span><span class="stat-value important">${gameState.hybridForms[player.hybridForm].name}</span></div>`;
        charHTML += `<div class="stat-item"><span>Description:</span><span class="stat-value">${gameState.hybridForms[player.hybridForm].description}</span></div>`;
        charHTML += `</div>`;
    }

    // Show minions for necromancer
    if (player.class === 'necromancer' && player.minions.length > 0) {
        charHTML += `<div class="screen-section">`;
        charHTML += `<h3>Minions</h3>`;
        charHTML += `<div class="stat-item"><span>Count:</span><span class="stat-value heal">${player.minions.length} skeletal warriors</span></div>`;
        charHTML += `</div>`;
    }

    // Show infinite dungeon progress
    if (player.infiniteDungeonLevel > 0) {
        charHTML += `<div class="screen-section">`;
        charHTML += `<h3>Infinite Dungeon</h3>`;
        charHTML += `<div class="stat-item"><span>Current Level:</span><span class="stat-value">${player.infiniteDungeonLevel}</span></div>`;
        charHTML += `</div>`;
    }

    // Show boss rush progress
    if (player.bossRushLevel > 0) {
        charHTML += `<div class="screen-section">`;
        charHTML += `<h3>Boss Rush</h3>`;
        charHTML += `<div class="stat-item"><span>Current Level:</span><span class="stat-value">${player.bossRushLevel}</span></div>`;
        charHTML += `</div>`;
    }

    document.getElementById("character-info").innerHTML = charHTML;
}

// Show inventory
function showInventory() {
    const player = gameState.player;
    const inventoryDiv = document.getElementById("inventory-items");

    if (player.inventory.length === 0) {
        inventoryDiv.innerHTML = "<div class='screen-section'>Your inventory is empty.</div>";
        document.getElementById("item-details").innerHTML = "";
        return;
    }

    let inventoryHTML = "<div class='screen-section'>";
    inventoryHTML += "<h3>Inventory</h3>";
    inventoryHTML += `<div class="stat-item"><span>Gold:</span><span class="stat-value gold">${player.gold}</span></div>`;
    inventoryHTML += "</div>";

    // Group items by type
    const weapons = player.inventory.filter(item => item.type === "weapon");
    const armor = player.inventory.filter(item => item.type === "armor");
    const consumables = player.inventory.filter(item => item.type === "consumable");
    const materials = player.inventory.filter(item => item.type === "material");

    if (weapons.length > 0) {
        inventoryHTML += "<div class='screen-section'>";
        inventoryHTML += "<h3>Weapons</h3>";
        weapons.forEach(weapon => {
            let itemClass = "";
            if (player.equippedWeapon && player.equippedWeapon.id === weapon.id) {
                itemClass = "selected";
            }
            inventoryHTML += `<button class="game-button ${itemClass}" onclick="showItemDetails(${weapon.id})" style="text-align:left;margin:2px 0;padding:5px;">${weapon.name} (${weapon.damage})</button><br>`;
        });
        inventoryHTML += "</div>";
    }

    if (armor.length > 0) {
        inventoryHTML += "<div class='screen-section'>";
        inventoryHTML += "<h3>Armor</h3>";
        armor.forEach(armorItem => {
            let itemClass = "";
            if (player.equippedArmor && player.equippedArmor.id === armorItem.id) {
                itemClass = "selected";
            }
            inventoryHTML += `<button class="game-button ${itemClass}" onclick="showItemDetails(${armorItem.id})" style="text-align:left;margin:2px 0;padding:5px;">${armorItem.name} (Def:${armorItem.defense})</button><br>`;
        });
        inventoryHTML += "</div>";
    }

    if (consumables.length > 0) {
        inventoryHTML += "<div class='screen-section'>";
        inventoryHTML += "<h3>Consumables</h3>";
        consumables.forEach(consumable => {
            inventoryHTML += `<button class="game-button" onclick="showItemDetails(${consumable.id})" style="text-align:left;margin:2px 0;padding:5px;">${consumable.name}</button><br>`;
        });
        inventoryHTML += "</div>";
    }

    if (materials.length > 0) {
        inventoryHTML += "<div class='screen-section'>";
        inventoryHTML += "<h3>Crafting Materials</h3>";
        materials.forEach(material => {
            inventoryHTML += `<button class="game-button" onclick="showItemDetails(${material.id})" style="text-align:left;margin:2px 0;padding:5px;">${material.name}</button><br>`;
        });
        inventoryHTML += "</div>";
    }

    inventoryDiv.innerHTML = inventoryHTML;
}

// Show item details
function showItemDetails(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);

    if (!item) return;

    let detailsHTML = `<div class="item-info"><h3>${item.name}</h3>`;

    if (item.type === "weapon") {
        detailsHTML += `Type: Weapon<br>`;
        detailsHTML += `Damage: ${item.damage}<br>`;
        if (item.magicDamage) {
            detailsHTML += `Magic Damage: +${item.magicDamage}<br>`;
        }
        if (item.critChance) {
            detailsHTML += `Crit Chance: +${Math.floor(item.critChance * 100)}%<br>`;
        }
        if (item.lifesteal) {
            detailsHTML += `Lifesteal: ${Math.floor(item.lifesteal * 100)}%<br>`;
        }
        if (item.bloodDrain) {
            detailsHTML += `Blood Drain: +${item.bloodDrain}<br>`;
        }
        if (item.rageGain) {
            detailsHTML += `Rage Gain: +${item.rageGain}<br>`;
        }
        if (item.soulGain) {
            detailsHTML += `Soul Gain: +${item.soulGain}<br>`;
        }
        detailsHTML += `Level: ${item.level}<br>`;
        detailsHTML += `Value: ${item.value} gold<br><br>`;

        // Equip button if not already equipped
        if (player.equippedWeapon && player.equippedWeapon.id === item.id) {
            detailsHTML += `<button class="game-button" disabled>EQUIPPED</button> `;
        } else {
            detailsHTML += `<button class="game-button" onclick="equipItem(${item.id})">EQUIP</button> `;
        }
    } else if (item.type === "armor") {
        detailsHTML += `Type: Armor<br>`;
        detailsHTML += `Defense: ${item.defense}<br>`;
        if (item.bloodRegen) {
            detailsHTML += `Blood Regen: +${item.bloodRegen}<br>`;
        }
        if (item.stealthBonus) {
            detailsHTML += `Stealth Bonus: +${item.stealthBonus}<br>`;
        }
        if (item.transformationBonus) {
            detailsHTML += `Transformation Bonus: +${item.transformationBonus} turns<br>`;
        }
        if (item.shockResist) {
            detailsHTML += `Shock Resist: +${item.shockResist}<br>`;
        }
        if (item.soulCapacity) {
            detailsHTML += `Soul Capacity: +${item.soulCapacity}<br>`;
        }
        detailsHTML += `Level: ${item.level}<br>`;
        detailsHTML += `Value: ${item.value} gold<br><br>`;

        // Equip button if not already equipped
        if (player.equippedArmor && player.equippedArmor.id === item.id) {
            detailsHTML += `<button class="game-button" disabled>EQUIPPED</button> `;
        } else {
            detailsHTML += `<button class="game-button" onclick="equipItem(${item.id})">EQUIP</button> `;
        }
    } else if (item.type === "consumable") {
        detailsHTML += `Type: Consumable<br>`;
        if (item.effect.health) {
            detailsHTML += `Restores ${item.effect.health} health<br>`;
        } else if (item.effect.blood) {
            detailsHTML += `Restores ${item.effect.blood} blood<br>`;
        } else if (item.effect.rage) {
            detailsHTML += `Grants ${item.effect.rage} rage<br>`;
        } else if (item.effect.lightning) {
            detailsHTML += `Restores ${item.effect.lightning} energy<br>`;
        } else if (item.effect.souls) {
            detailsHTML += `Grants ${item.effect.souls} soul<br>`;
        } else if (item.effect.transform) {
            detailsHTML += `Triggers transformation<br>`;
        } else if (item.effect.allStats) {
            detailsHTML += `Increases all stats by ${item.effect.allStats} for ${item.duration} turns<br>`;
        }
        detailsHTML += `Value: ${item.value} gold<br><br>`;

        detailsHTML += `<button class="game-button" onclick="useInventoryItem(${item.id})">USE</button> `;
        detailsHTML += `<button class="game-button" onclick="assignToQuickSlot(${item.id})">QUICK SLOT</button>`;
    } else if (item.type === "material") {
        detailsHTML += `Type: Crafting Material<br>`;
        detailsHTML += `${item.description}<br>`;
        detailsHTML += `Value: ${item.value} gold<br><br>`;
    }

    if (item.type !== "consumable" && item.type !== "material") {
        detailsHTML += `<button class="game-button" onclick="sellItem(${item.id})">SELL</button>`;
    }
    detailsHTML += `</div>`;

    document.getElementById("item-details").innerHTML = detailsHTML;
}

// Assign item to quick slot
function assignToQuickSlot(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);
    
    if (!item || item.type !== "consumable") {
        addToGameLog("Only consumables can be assigned to quick slots!");
        return;
    }
    
    // Find first empty slot or cycle through slots
    let slotIndex = player.quickSlots.findIndex(slot => slot === null);
    if (slotIndex === -1) {
        // If all slots are full, use the first slot
        slotIndex = 0;
    }
    
    player.quickSlots[slotIndex] = itemId;
    updateQuickSlots();
    addToGameLog(`Assigned ${item.name} to quick slot ${slotIndex + 1}`);
}

// Update quick slots display
function updateQuickSlots() {
    const player = gameState.player;
    const quickSlots = document.querySelectorAll('.quick-slot');
    
    player.quickSlots.forEach((itemId, index) => {
        if (itemId) {
            const item = player.inventory.find(i => i.id === itemId);
            if (item) {
                quickSlots[index].textContent = item.name.substring(0, 3);
                quickSlots[index].title = item.name;
            }
        } else {
            quickSlots[index].textContent = index + 1;
            quickSlots[index].title = "Empty Slot";
        }
    });
}

// Use quick slot item
function useQuickSlot(slotIndex) {
    const player = gameState.player;
    const itemId = player.quickSlots[slotIndex];
    
    if (!itemId) {
        addToGameLog(`Quick slot ${slotIndex + 1} is empty!`);
        return;
    }
    
    const item = player.inventory.find(i => i.id === itemId);
    if (!item) {
        addToGameLog("Item not found in inventory!");
        player.quickSlots[slotIndex] = null;
        updateQuickSlots();
        return;
    }
    
    if (player.inCombat) {
        useItem(item);
    } else {
        useInventoryItem(itemId);
    }
    
    // Remove from quick slot if it was consumed
    if (!player.inventory.some(i => i.id === itemId)) {
        player.quickSlots[slotIndex] = null;
        updateQuickSlots();
    }
}

// Equip item
function equipItem(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);

    if (!item) return;

    // Check if item is for this class
    if (item.class && item.class !== player.class) {
        addToGameLog("This item is not meant for your kind!");
        return;
    }

    // Check level requirement
    if (item.level > player.level) {
        addToGameLog(`You need to be level ${item.level} to equip this!`);
        return;
    }

    if (item.type === "weapon") {
        // Unequip current weapon if any
        if (player.equippedWeapon) {
            player.inventory.push(player.equippedWeapon);
        }
        player.equippedWeapon = item;

        // Remove from inventory
        const itemIndex = player.inventory.findIndex(i => i.id === item.id);
        if (itemIndex !== -1) {
            player.inventory.splice(itemIndex, 1);
        }

        addToGameLog(`You equipped the ${item.name}.`);
    } else if (item.type === "armor") {
        // Unequip current armor if any
        if (player.equippedArmor) {
            player.inventory.push(player.equippedArmor);
        }
        player.equippedArmor = item;

        // Remove from inventory
        const itemIndex = player.inventory.findIndex(i => i.id === item.id);
        if (itemIndex !== -1) {
            player.inventory.splice(itemIndex, 1);
        }

        addToGameLog(`You equipped the ${item.name}.`);
    }

    showInventory();
    updatePlayerStats();
}

// Use item from inventory (outside combat)
function useInventoryItem(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);

    if (!item) return;

    if (item.effect.health) {
        player.health += item.effect.health;
        if (player.health > player.maxHealth) player.health = player.maxHealth;
        addToGameLog(`You use ${item.name} and restore <span class="heal">${item.effect.health}</span> health!`);
    } else if (item.effect.blood) {
        player.blood += item.effect.blood;
        if (player.blood > player.maxBlood) player.blood = player.maxBlood;
        addToGameLog(`You use ${item.name} and restore <span class="blood">${item.effect.blood}</span> blood!`);
    } else if (item.effect.rage) {
        player.rage += item.effect.rage;
        if (player.rage > player.maxRage) player.rage = player.maxRage;
        addToGameLog(`You use ${item.name} and gain <span class="rage">${item.effect.rage}</span> rage!`);
    } else if (item.effect.lightning) {
        player.lightning += item.effect.lightning;
        if (player.lightning > player.maxLightning) player.lightning = player.maxLightning;
        addToGameLog(`You use ${item.name} and restore <span class="lightning">${item.effect.lightning}</span> energy!`);
    } else if (item.effect.souls) {
        player.souls += item.effect.souls;
        if (player.souls > player.maxSouls) player.souls = player.maxSouls;
        addToGameLog(`You use ${item.name} and gain <span class="souls">${item.effect.souls}</span> souls!`);
    } else if (item.effect.transform) {
        if (player.class === 'werewolf') {
            player.transformed = true;
            player.transformationTurns = 3;
            player.strength += 10;
            addToGameLog("<span class='important'>You transform into a fearsome werewolf!</span>");
        }
    } else if (item.effect.allStats) {
        player.strength += item.effect.allStats;
        player.dexterity += item.effect.allStats;
        player.intelligence += item.effect.allStats;
        player.constitution += item.effect.allStats;
        addToGameLog(`<span class='important'>All your stats increase by ${item.effect.allStats} for ${item.duration} turns!</span>`);
    }

    // Remove item from inventory
    const itemIndex = player.inventory.findIndex(i => i.id === item.id);
    if (itemIndex !== -1) {
        player.inventory.splice(itemIndex, 1);
    }

    showInventory();
    updatePlayerStats();
}

// Sell item
function sellItem(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);

    if (!item) return;

    // Can't sell equipped items
    if ((player.equippedWeapon && player.equippedWeapon.id === item.id) ||
        (player.equippedArmor && player.equippedArmor.id === item.id)) {
        addToGameLog("You can't sell equipped items!");
        return;
    }

    const sellValue = Math.floor(item.value * 0.75);
    player.gold += sellValue;

    // Remove from inventory
    const itemIndex = player.inventory.findIndex(i => i.id === item.id);
    if (itemIndex !== -1) {
        player.inventory.splice(itemIndex, 1);
    }

    addToGameLog(`You sold ${item.name} for <span class="gold">${sellValue} gold</span>.`);
    showInventory();
    updatePlayerStats();
}

// Generate shop items
function generateShopItems() {
    const player = gameState.player;
    gameState.shopItems = [];

    // Generate items appropriate for player level and class
    const allItems = [...gameState.items.weapons, ...gameState.items.armor, ...gameState.items.consumables, ...gameState.items.crafting]
        .filter(item => (!item.class || item.class === player.class) && (!item.level || item.level <= player.level + 2));

    // Add 5 random items to shop
    for (let i = 0; i < 5; i++) {
        if (allItems.length > 0) {
            const randomItem = {...allItems[Math.floor(Math.random() * allItems.length)]};
            gameState.shopItems.push(randomItem);
        }
    }
}

// Show shop
function showShop() {
    const player = gameState.player;
    const shopDiv = document.getElementById("shop-items");

    if (gameState.shopItems.length === 0) {
        shopDiv.innerHTML = "<div class='screen-section'>The dark market has nothing to offer.</div>";
        return;
    }

    let shopHTML = "<div class='screen-section'>";
    shopHTML += "<h3>Dark Market</h3>";
    shopHTML += `<div class="stat-item"><span>Your Gold:</span><span class="stat-value gold">${player.gold}</span></div>`;
    shopHTML += "</div>";

    gameState.shopItems.forEach(item => {
        shopHTML += `<div class="screen-section" style="margin-bottom:10px;">`;
        shopHTML += `<h4>${item.name}</h4>`;
        shopHTML += `<div class="stat-item"><span>Price:</span><span class="stat-value gold">${item.value} gold</span></div>`;

        if (item.type === "weapon") {
            shopHTML += `<div class="stat-item"><span>Damage:</span><span class="stat-value">${item.damage}</span></div>`;
            if (item.magicDamage) shopHTML += `<div class="stat-item"><span>Magic Damage:</span><span class="stat-value">+${item.magicDamage}</span></div>`;
            if (item.critChance) shopHTML += `<div class="stat-item"><span>Crit Chance:</span><span class="stat-value">+${Math.floor(item.critChance * 100)}%</span></div>`;
            if (item.lifesteal) shopHTML += `<div class="stat-item"><span>Lifesteal:</span><span class="stat-value">${Math.floor(item.lifesteal * 100)}%</span></div>`;
            shopHTML += `<div class="stat-item"><span>Level:</span><span class="stat-value">${item.level}</span></div>`;
        } else if (item.type === "armor") {
            shopHTML += `<div class="stat-item"><span>Defense:</span><span class="stat-value">${item.defense}</span></div>`;
            if (item.bloodRegen) shopHTML += `<div class="stat-item"><span>Blood Regen:</span><span class="stat-value">+${item.bloodRegen}</span></div>`;
            if (item.stealthBonus) shopHTML += `<div class="stat-item"><span>Stealth:</span><span class="stat-value">+${item.stealthBonus}</span></div>`;
            shopHTML += `<div class="stat-item"><span>Level:</span><span class="stat-value">${item.level}</span></div>`;
        } else if (item.type === "consumable") {
            if (item.effect.health) {
                shopHTML += `<div class="stat-item"><span>Effect:</span><span class="stat-value">Restores ${item.effect.health} health</span></div>`;
            } else if (item.effect.blood) {
                shopHTML += `<div class="stat-item"><span>Effect:</span><span class="stat-value">Restores ${item.effect.blood} blood</span></div>`;
            } else if (item.effect.rage) {
                shopHTML += `<div class="stat-item"><span>Effect:</span><span class="stat-value">Grants ${item.effect.rage} rage</span></div>`;
            } else if (item.effect.transform) {
                shopHTML += `<div class="stat-item"><span>Effect:</span><span class="stat-value">Triggers transformation</span></div>`;
            } else if (item.effect.allStats) {
                shopHTML += `<div class="stat-item"><span>Effect:</span><span class="stat-value">+${item.effect.allStats} all stats</span></div>`;
            }
        } else if (item.type === "material") {
            shopHTML += `<div class="stat-item"><span>Description:</span><span class="stat-value">${item.description}</span></div>`;
        }

        shopHTML += `<br><button class="game-button" onclick="buyItem(${item.id})" ${player.gold < item.value ? "disabled" : ""}>PURCHASE</button>`;
        shopHTML += `</div>`;
    });

    shopDiv.innerHTML = shopHTML;
}

// Refresh shop items
function refreshShop() {
    const player = gameState.player;
    if (player.gold < 50) {
        addToGameLog("You need 50 gold to refresh the dark market!");
        return;
    }

    player.gold -= 50;
    generateShopItems();
    showShop();
    addToGameLog("The dark merchant brings out new wares... (-50 gold)");
    updatePlayerStats();
}

// Buy item from shop
function buyItem(itemId) {
    const player = gameState.player;
    const item = gameState.shopItems.find(i => i.id === itemId);

    if (!item) return;

    if (player.gold >= item.value) {
        player.gold -= item.value;
        player.inventory.push({...item});

        // Remove from shop
        const itemIndex = gameState.shopItems.findIndex(i => i.id === item.id);
        if (itemIndex !== -1) {
            gameState.shopItems.splice(itemIndex, 1);
        }

        addToGameLog(`You purchased ${item.name} for <span class="gold">${item.value} gold</span>.`);
        showShop();
        updatePlayerStats();
    } else {
        addToGameLog("Not enough gold!");
    }
}

// Generate quests
function generateQuests() {
    const player = gameState.player;
    const availableQuests = gameState.quests.filter(q => q.level <= player.level && 
        !gameState.player.quests.active.some(aq => aq.id === q.id) &&
        !gameState.player.quests.completed.some(cq => cq.id === q.id));

    // Add up to 3 available quests
    for (let i = 0; i < Math.min(3, availableQuests.length); i++) {
        const quest = {...availableQuests[i]};
        gameState.player.quests.active.push(quest);
        addToGameLog(`New quest available: ${quest.name}`);
    }
}

// Show quests screen
function showQuests() {
    const player = gameState.player;
    const activeQuestsDiv = document.getElementById("active-quests");
    const completedQuestsDiv = document.getElementById("completed-quests");

    let activeHTML = "<div class='screen-section'><h3>Active Quests</h3>";
    if (player.quests.active.length === 0) {
        activeHTML += "No active quests.<br>";
    } else {
        player.quests.active.forEach(quest => {
            activeHTML += `<div class="quest quest-active">`;
            activeHTML += `<h4>${quest.name}</h4>`;
            activeHTML += `<p>${quest.description}</p>`;
            activeHTML += `<div class="stat-item"><span>Progress:</span><span class="stat-value">${quest.objective.current}/${quest.objective.count} ${quest.objective.target}</span></div>`;
            activeHTML += `<div class="stat-item"><span>Reward:</span><span class="stat-value">${quest.reward.gold} gold, ${quest.reward.xp} XP`;
            if (quest.reward.item) {
                const item = gameState.items.weapons.concat(gameState.items.armor, gameState.items.consumables)
                    .find(i => i.id === quest.reward.item);
                if (item) {
                    activeHTML += `, ${item.name}`;
                }
            }
            activeHTML += `</span></div>`;
            activeHTML += `</div>`;
        });
    }
    activeHTML += "</div>";

    let completedHTML = "<div class='screen-section'><h3>Completed Quests</h3>";
    if (player.quests.completed.length === 0) {
        completedHTML += "No completed quests.<br>";
    } else {
        player.quests.completed.forEach(quest => {
            completedHTML += `<div class="quest quest-completed">`;
            completedHTML += `<h4>${quest.name}</h4>`;
            completedHTML += `<p>${quest.description}</p>`;
            completedHTML += `<div class="stat-item"><span>Reward:</span><span class="stat-value">${quest.reward.gold} gold, ${quest.reward.xp} XP`;
            if (quest.reward.item) {
                const item = gameState.items.weapons.concat(gameState.items.armor, gameState.items.consumables)
                    .find(i => i.id === quest.reward.item);
                if (item) {
                    completedHTML += `, ${item.name}`;
                }
            }
            completedHTML += `</span></div>`;
            completedHTML += `</div>`;
        });
    }
    completedHTML += "</div>";

    activeQuestsDiv.innerHTML = activeHTML;
    completedQuestsDiv.innerHTML = completedHTML;
}

// Update quest progress
function updateQuestProgress(enemyName) {
    const player = gameState.player;

    player.quests.active.forEach(quest => {
        if (quest.objective.type === "kill" && quest.objective.target === enemyName && quest.objective.current < quest.objective.count) {
            quest.objective.current++;
            addToGameLog(`Quest progress: ${quest.name} (${quest.objective.current}/${quest.objective.count} ${enemyName}s)`);
        }
    });

    // Check for completed quests
    for (let i = player.quests.active.length - 1; i >= 0; i--) {
        const quest = player.quests.active[i];
        if (quest.objective.current >= quest.objective.count) {
            completeQuest(i);
        }
    }
}

// Complete a quest
function completeQuest(index) {
    const player = gameState.player;
    const quest = player.quests.active[index];

    // Give rewards
    player.gold += quest.reward.gold;
    player.xp += quest.reward.xp;
    addToGameLog(`<span class="important">Quest completed: ${quest.name}!</span>`);
    addToGameLog(`You received ${quest.reward.gold} gold and ${quest.reward.xp} XP!`);

    // Give item reward if any
    if (quest.reward.item) {
        const item = {...gameState.items.weapons.concat(gameState.items.armor, gameState.items.consumables)
            .find(i => i.id === quest.reward.item)};
        player.inventory.push(item);
        addToGameLog(`You received a <span class="item">${item.name}</span>!`);
    }

    // Move to completed
    player.quests.completed.push(quest);
    player.quests.active.splice(index, 1);

    // Check for level up
    checkLevelUp();

    // Generate new quests if needed
    if (player.quests.active.length < 3) {
        generateQuests();
    }
}

// Show talent tree
function showTalentTree() {
    const player = gameState.player;
    const talentDiv = document.getElementById("talent-tree");
    
    if (!player.class) {
        talentDiv.innerHTML = "<div class='screen-section'>You need to choose your monster form first!</div>";
        return;
    }
    
    let talentHTML = `<div class="screen-section">`;
    talentHTML += `<h3>Dark Talents - ${player.class.toUpperCase()}</h3>`;
    talentHTML += `<div class="stat-item"><span>Talent Points Available:</span><span class="stat-value xp">${player.talentPoints}</span></div>`;
    talentHTML += `</div>`;
    
    const talentTree = gameState.talentTrees[player.class];
    const talentNames = Object.keys(talentTree);
    
    talentHTML += `<div class="screen-section">`;
    talentHTML += `<div class="grid-layout">`;
    
    talentNames.forEach(talentName => {
        const talent = talentTree[talentName];
        const isUnlocked = talent.currentPoints > 0;
        const isMaxed = talent.currentPoints >= talent.maxPoints;
        const canUpgrade = player.talentPoints > 0 && !isMaxed;
        
        let buttonClass = "game-button";
        if (isUnlocked) buttonClass += " selected";
        
        talentHTML += `<div class="talent-item">`;
        talentHTML += `<button class="${buttonClass}" onclick="upgradeTalent('${talentName}')" ${!canUpgrade && !isMaxed ? "disabled" : ""}>`;
        talentHTML += `${talentName}<br>${talent.currentPoints}/${talent.maxPoints}`;
        talentHTML += `</button>`;
        talentHTML += `<div class="talent-description">${talent.effect}</div>`;
        talentHTML += `</div>`;
    });
    
    talentHTML += `</div></div>`;
    
    talentDiv.innerHTML = talentHTML;
}

// Upgrade a talent
function upgradeTalent(talentName) {
    const player = gameState.player;
    
    if (!player.class) return;
    
    const talentTree = gameState.talentTrees[player.class];
    const talent = talentTree[talentName];
    
    if (!talent) return;
    
    // Check if we can upgrade this talent
    if (player.talentPoints <= 0) {
        addToGameLog("You don't have any talent points!");
        return;
    }
    
    if (talent.currentPoints >= talent.maxPoints) {
        addToGameLog("This talent is already maxed out!");
        return;
    }
    
    // Upgrade the talent
    talent.currentPoints++;
    player.talentPoints--;
    
    addToGameLog(`<span class="important">You upgraded ${talentName} to ${talent.currentPoints}/${talent.maxPoints}!</span>`);
    
    // Apply talent effects
    applyTalentEffects(talentName);
    
    // Update the talent screen
    showTalentTree();
    updatePlayerStats();
}

// Apply talent effects
function applyTalentEffects(talentName) {
    const player = gameState.player;
    const talent = gameState.talentTrees[player.class][talentName];
    
    // This is where you would apply permanent stat bonuses from talents
    // For now, we'll just log the effect
    addToGameLog(`Talent effect applied: ${talent.effect}`);
}

// Show endgame screen
function showEndgameScreen() {
    const player = gameState.player;
    const endgameDiv = document.getElementById("endgame-content");
    
    let endgameHTML = "<div class='screen-section'>";
    endgameHTML += "<h3>Legendary Hunts</h3>";
    endgameHTML += `<p>Face the most powerful creatures in the night.</p>`;
    endgameHTML += "</div>";
    
    // Show boss progression
    endgameHTML += `<div class="screen-section">`;
    endgameHTML += `<h4>Great Beasts Defeated</h4>`;
    Object.keys(gameState.bosses).forEach(area => {
        const boss = gameState.bosses[area];
        const isDefeated = gameState.bossDefeated[area];
        
        endgameHTML += `<div class="boss-item" style="margin: 10px 0; padding: 10px; border: 1px solid #333; background: ${isDefeated ? 'rgba(76, 175, 80, 0.1)' : 'rgba(198, 40, 40, 0.1)'};">`;
        endgameHTML += `<div class="stat-item"><span>Boss:</span><span class="stat-value">${boss.name}</span></div>`;
        endgameHTML += `<div class="stat-item"><span>Location:</span><span class="stat-value">${area}</span></div>`;
        endgameHTML += `<div class="stat-item"><span>Level:</span><span class="stat-value">${boss.level}</span></div>`;
        endgameHTML += `<div class="stat-item"><span>Health:</span><span class="stat-value">${boss.health}</span></div>`;
        endgameHTML += `<div class="stat-item"><span>Status:</span><span class="stat-value" style="color: ${isDefeated ? '#4caf50' : '#c62828'}">${isDefeated ? 'DEFEATED' : 'STILL HUNTING'}</span></div>`;
        endgameHTML += `</div>`;
    });
    endgameHTML += `</div>`;
    
    // Show completion status
    const totalBosses = Object.keys(gameState.bosses).length;
    const defeatedBosses = Object.values(gameState.bossDefeated).filter(b => b).length;
    
    endgameHTML += `<div class="screen-section" style="border: 2px solid #ff6f00; text-align: center;">`;
    endgameHTML += `<h3>Nightmare Progress</h3>`;
    endgameHTML += `<div class="stat-item"><span>Bosses Defeated:</span><span class="stat-value">${defeatedBosses}/${totalBosses}</span></div>`;
    if (defeatedBosses === totalBosses) {
        endgameHTML += `<div class="stat-item"><span>Achievement:</span><span class="stat-value important">YOU HAVE MASTERED THE NIGHT!</span></div>`;
    }
    endgameHTML += `</div>`;
    
    // Show infinite dungeon progress
    endgameHTML += `<div class="screen-section">`;
    endgameHTML += `<h4>Infinite Dungeon</h4>`;
    endgameHTML += `<div class="stat-item"><span>Current Level:</span><span class="stat-value">${player.infiniteDungeonLevel}</span></div>`;
    endgameHTML += `<p>An endless labyrinth that grows more challenging with each level.</p>`;
    endgameHTML += `</div>`;
    
    // Show boss rush progress
    endgameHTML += `<div class="screen-section">`;
    endgameHTML += `<h4>Boss Rush</h4>`;
    endgameHTML += `<div class="stat-item"><span>Current Level:</span><span class="stat-value">${player.bossRushLevel}</span></div>`;
    endgameHTML += `<p>Face all bosses in sequence with no rest between fights.</p>`;
    endgameHTML += `</div>`;
    
    endgameDiv.innerHTML = endgameHTML;
}

// Enter infinite dungeon
function enterInfiniteDungeon() {
    const player = gameState.player;
    
    if (player.level < 15) {
        addToGameLog("You must be at least level 15 to enter the Infinite Dungeon!");
        return;
    }
    
    player.infiniteDungeonLevel++;
    player.currentArea = "Infinite Dungeon";
    
    // Generate dungeon level
    generateDungeonLevel();
    
    addToGameLog(`<span class="important">You enter the Infinite Dungeon - Level ${player.infiniteDungeonLevel}!</span>`);
    startCombat();
}

// Generate dungeon level
function generateDungeonLevel() {
    const player = gameState.player;
    const level = player.infiniteDungeonLevel;
    
    // Clear previous enemies
    gameState.enemies["Infinite Dungeon"] = [];
    
    // Generate enemies based on dungeon level
    const enemyCount = 3 + Math.floor(level / 5);
    const baseLevel = 10 + Math.floor(level / 2);
    
    for (let i = 0; i < enemyCount; i++) {
        const enemyTypes = ["Spectral Horror", "Dungeon Crawler", "Void Spawn", "Abyssal Beast"];
        const enemyType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
        
        const enemy = {
            name: `${enemyType} (Level ${level})`,
            health: 100 + (level * 20),
            maxHealth: 100 + (level * 20),
            damage: `${15 + level}-${25 + level}`,
            xp: 50 + (level * 10),
            gold: `${30 + level}-${50 + level}`,
            level: baseLevel + i,
            armor: Math.floor(level / 2),
            special: `Dungeon Level ${level}`
        };
        
        gameState.enemies["Infinite Dungeon"].push(enemy);
    }
}

// Start boss rush
function startBossRush() {
    const player = gameState.player;
    
    if (player.level < 20) {
        addToGameLog("You must be at least level 20 to attempt the Boss Rush!");
        return;
    }
    
    player.bossRushLevel = 1;
    player.currentArea = "Boss Rush";
    
    // Start with first boss
    const firstBossArea = Object.keys(gameState.bosses)[0];
    const boss = {...gameState.bosses[firstBossArea]};
    
    // Scale boss for boss rush
    boss.health = Math.floor(boss.health * 1.5);
    boss.maxHealth = boss.health;
    
    gameState.player.inCombat = true;
    gameState.player.currentEnemy = boss;
    
    addToGameLog(`<span class="important">Boss Rush begins! First boss: ${boss.name}</span>`);
    showScreen("combat");
}

// Show prestige screen
function showPrestigeScreen() {
    const player = gameState.player;
    const prestigeDiv = document.getElementById("prestige-content");
    
    let prestigeHTML = "<div class='screen-section'>";
    prestigeHTML += "<h3>Prestige System</h3>";
    prestigeHTML += `<p>Reset your progress for permanent bonuses and new challenges.</p>`;
    prestigeHTML += "</div>";
    
    prestigeHTML += `<div class="screen-section" style="border: 2px solid #ff6f00;">`;
    prestigeHTML += `<h4>Current Prestige Level: ${player.prestigeLevel}</h4>`;
    
    if (player.prestigeLevel > 0) {
        prestigeHTML += `<p>Active Bonuses:</p>`;
        for (let i = 0; i < player.prestigeLevel; i++) {
            prestigeHTML += `<div class="stat-item"><span>Prestige ${i+1}:</span><span class="stat-value">${gameState.prestigeBonuses[i].bonus}</span></div>`;
        }
    }
    prestigeHTML += `</div>`;
    
    prestigeHTML += `<div class="screen-section" style="border: 2px solid #c62828;">`;
    prestigeHTML += `<h4>Next Prestige Bonus</h4>`;
    if (player.prestigeLevel < gameState.prestigeBonuses.length) {
        prestigeHTML += `<div class="stat-item"><span>Bonus:</span><span class="stat-value">${gameState.prestigeBonuses[player.prestigeLevel].bonus}</span></div>`;
    } else {
        prestigeHTML += `<div class="stat-item"><span>Status:</span><span class="stat-value">You have reached the maximum prestige level!</span></div>`;
    }
    prestigeHTML += `</div>`;
    
    prestigeHTML += `<div class="screen-section">`;
    prestigeHTML += `<h4>Prestige Requirements</h4>`;
    prestigeHTML += `<div class="stat-item"><span>Reach level 25:</span><span class="stat-value">${player.level >= 25 ? '' : ''}</span></div>`;
    prestigeHTML += `<div class="stat-item"><span>Defeat all main bosses:</span><span class="stat-value">${Object.values(gameState.bossDefeated).filter(b => b).length === Object.keys(gameState.bosses).length ? '' : ''}</span></div>`;
    prestigeHTML += `<div class="stat-item"><span>Have at least 10,000 gold:</span><span class="stat-value">${player.gold >= 10000 ? '' : ''}</span></div>`;
    
    const canPrestige = player.level >= 25 && 
                       Object.values(gameState.bossDefeated).filter(b => b).length === Object.keys(gameState.bosses).length &&
                       player.gold >= 10000;
    
    if (canPrestige) {
        prestigeHTML += `<div class="stat-item"><span>Status:</span><span class="stat-value" style="color: #4caf50">You are ready to prestige!</span></div>`;
        document.getElementById("prestige-button").disabled = false;
    } else {
        prestigeHTML += `<div class="stat-item"><span>Status:</span><span class="stat-value" style="color: #c62828">You are not yet ready to prestige.</span></div>`;
        document.getElementById("prestige-button").disabled = true;
    }
    prestigeHTML += `</div>`;
    
    prestigeDiv.innerHTML = prestigeHTML;
}

// Prestige reset
function prestigeReset() {
    const player = gameState.player;
    
    // Check requirements
    if (player.level < 25 || 
        Object.values(gameState.bossDefeated).filter(b => b).length !== Object.keys(gameState.bosses).length ||
        player.gold < 10000) {
        addToGameLog("You do not meet the prestige requirements!");
        return;
    }
    
    // Increase prestige level
    player.prestigeLevel++;
    
    // Apply prestige bonus
    const bonus = gameState.prestigeBonuses[player.prestigeLevel - 1];
    addToGameLog(`<span class="important">Prestige ${player.prestigeLevel} achieved!</span>`);
    addToGameLog(`<span class="important">Bonus: ${bonus.bonus}</span>`);
    
    // Reset player progress (but keep some benefits)
    const keptGold = Math.floor(player.gold * 0.1); // Keep 10% of gold
    const keptItems = player.inventory.filter(item => item.legendary); // Keep legendary items
    
    // Full reset
    player.level = 1;
    player.xp = 0;
    player.xpToNextLevel = 100;
    player.health = 100;
    player.maxHealth = 100;
    player.blood = 100;
    player.maxBlood = 100;
    player.rage = 0;
    player.maxRage = 100;
    player.lightning = 100;
    player.maxLightning = 100;
    player.souls = 0;
    player.maxSouls = 5;
    player.strength = 10;
    player.dexterity = 10;
    player.intelligence = 10;
    player.constitution = 10;
    player.gold = keptGold;
    player.equippedWeapon = null;
    player.equippedArmor = null;
    player.inventory = keptItems;
    player.currentArea = "Transylvania Village";
    player.inCombat = false;
    player.currentEnemy = null;
    player.buffs = [];
    player.debuffs = [];
    player.quests = { active: [], completed: [] };
    player.talentPoints = 0;
    player.transformed = false;
    player.transformationTurns = 0;
    player.minions = [];
    player.comboCounter = 0;
    player.comboMultiplier = 1;
    player.infiniteDungeonLevel = 0;
    player.bossRushLevel = 0;
    
    // Reset talents but keep prestige bonuses
    Object.keys(player.talents).forEach(talent => {
        player.talents[talent].currentPoints = 0;
    });
    
    // Reset areas
    gameState.areas.forEach(area => {
        area.unlocked = area.minLevel === 1;
    });
    
    // Reset bosses (but keep prestige progress)
    Object.keys(gameState.bossDefeated).forEach(area => {
        gameState.bossDefeated[area] = false;
    });
    
    // Generate new quests
    generateQuests();
    
    addToGameLog("You have been reborn with newfound power!");
    addToGameLog(`You kept ${keptGold} gold and your legendary items.`);
    
    showScreen("main");
    updatePlayerStats();
}

// Show class details when clicked
function showClassDetails(className) {
    // Remove selected class from all buttons
    document.querySelectorAll('.class-button').forEach(btn => {
        btn.classList.remove('class-selected');
    });
    
    // Add selected class to clicked button
    event.target.classList.add('class-selected');
    
    // Show the class description
    document.getElementById("class-description").innerHTML = gameState.classDescriptions[className];
    
    // Store the selected class in gameState temporarily
    gameState.tempSelectedClass = className;
    
    // Show the select button
    document.getElementById("select-class-button").style.display = "block";
}

// Select the chosen class
function selectClass() {
    if (!gameState.tempSelectedClass) {
        addToGameLog("Please select your monstrous form first!");
        return;
    }
    
    const className = gameState.tempSelectedClass;
    const player = gameState.player;
    player.class = className;

    // Set class-specific stats and starting equipment
    if (className === 'vampire') {
        player.maxHealth = 120;
        player.health = 120;
        player.maxBlood = 100;
        player.blood = 100;
        player.strength = 12;
        player.dexterity = 14;
        player.intelligence = 10;
        player.constitution = 10;

        player.equippedWeapon = {...gameState.items.weapons.find(w => w.id === 1)}; // Bloodied Dagger
        player.equippedArmor = {...gameState.items.armor.find(a => a.id === 20)}; // Cloak of Shadows
        player.skills = [...gameState.classSkills.vampire];
        player.talents = {...gameState.talentTrees.vampire};
        
    } else if (className === 'werewolf') {
        player.maxHealth = 150;
        player.health = 150;
        player.maxRage = 100;
        player.rage = 0;
        player.strength = 16;
        player.dexterity = 12;
        player.intelligence = 8;
        player.constitution = 14;

        player.equippedWeapon = {...gameState.items.weapons.find(w => w.id === 4)}; // Silver Claws
        player.equippedArmor = {...gameState.items.armor.find(a => a.id === 23)}; // Wolf Pelt
        player.skills = [...gameState.classSkills.werewolf];
        player.talents = {...gameState.talentTrees.werewolf};
        
    } else if (className === 'reanimated') {
        player.maxHealth = 180;
        player.health = 180;
        player.maxLightning = 100;
        player.lightning = 100;
        player.strength = 14;
        player.dexterity = 8;
        player.intelligence = 12;
        player.constitution = 16;

        player.equippedWeapon = {...gameState.items.weapons.find(w => w.id === 7)}; // Rusty Pipes
        player.equippedArmor = {...gameState.items.armor.find(a => a.id === 26)}; // Stitched Leather
        player.skills = [...gameState.classSkills.reanimated];
        player.talents = {...gameState.talentTrees.reanimated};
        
    } else if (className === 'necromancer') {
        player.maxHealth = 100;
        player.health = 100;
        player.maxSouls = 3;
        player.souls = 0;
        player.strength = 8;
        player.dexterity = 10;
        player.intelligence = 16;
        player.constitution = 8;

        player.equippedWeapon = {...gameState.items.weapons.find(w => w.id === 10)}; // Bone Staff
        player.equippedArmor = {...gameState.items.armor.find(a => a.id === 29)}; // Necromancer's Robes
        player.skills = [...gameState.classSkills.necromancer];
        player.talents = {...gameState.talentTrees.necromancer};
        
    } else if (className === 'hybrid') {
        player.maxHealth = 130;
        player.health = 130;
        player.maxBlood = 80;
        player.blood = 80;
        player.maxRage = 80;
        player.rage = 0;
        player.maxLightning = 80;
        player.lightning = 80;
        player.maxSouls = 2;
        player.souls = 0;
        player.strength = 11;
        player.dexterity = 11;
        player.intelligence = 11;
        player.constitution = 11;

        player.equippedWeapon = {...gameState.items.weapons.find(w => w.id === 17)}; // Bloodmoon Claws
        player.equippedArmor = {...gameState.items.armor.find(a => a.id === 36)}; // Chimera Hide
        player.skills = [...gameState.classSkills.hybrid];
        player.talents = {...gameState.talentTrees.hybrid};
        player.hybridForm = "Vampire-Werewolf";
    }

    // Add starting consumables
    player.inventory.push({...gameState.items.consumables.find(c => c.id === 44)}); // Health Potion
    if (className === 'vampire') {
        player.inventory.push({...gameState.items.consumables.find(c => c.id === 40)}); // Blood Vial
    } else if (className === 'werewolf') {
        player.inventory.push({...gameState.items.consumables.find(c => c.id === 41)}); // Rage Potion
    } else if (className === 'reanimated') {
        player.inventory.push({...gameState.items.consumables.find(c => c.id === 42)}); // Lightning Cell
    } else if (className === 'necromancer') {
        player.inventory.push({...gameState.items.consumables.find(c => c.id === 43)}); // Soul Shard
    } else if (className === 'hybrid') {
        player.inventory.push({...gameState.items.consumables.find(c => c.id === 40)}); // Blood Vial
        player.inventory.push({...gameState.items.consumables.find(c => c.id === 41)}); // Rage Potion
        player.inventory.push({...gameState.items.consumables.find(c => c.id === 42)}); // Lightning Cell
    }

    // Hide class selection and show main game
    document.getElementById("class-select-screen").style.display = "none";
    document.getElementById("main-buttons").style.display = "flex";

    addToGameLog(`You have embraced the darkness as a ${className}. Your reign of terror begins!`);
    updatePlayerStats();

    // Generate initial quests
    generateQuests();
    
    // Initialize the rest of the game
    initGame();
}

// Initialize the game when page loads
window.onload = function() {
    document.getElementById("class-select-screen").style.display = "block";
    document.getElementById("main-buttons").style.display = "none";
    document.getElementById("select-class-button").style.display = "none";
    addToGameLog("The night calls to you... Choose your monstrous form and begin your legacy!");
};
</script>
</body>
</html>
