<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Island of Lost Souls - Level 1: Entering Village of the Damned</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Green/Black/White theme with proper contrast */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(0, 50, 0, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 50, 0, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #0a0;
            background-color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 50, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #0a0;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #0f0;
            text-shadow: 0 0 5px #0a0;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #0a0;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #0a0;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.current {
            background-color: #0a0;
            color: #fff;
            border-color: #0f0;
            box-shadow: 0 0 8px #0f0;
            text-shadow: 0 0 2px #000;
        }
        
        .level-number.completed {
            background-color: #050;
            color: #0f0;
            border-color: #0f0;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #0a0;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #0f0;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #0a0;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #0f0;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #0a0;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #0f0;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #0f0;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #0a0;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #0a0;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #0f0;
            border-color: #0f0;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #0a0;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #0f0;
        }
        
        /* New Game Button */
.new-game-btn {
    background-color: #222;
    color: #fff;
    border: 2px solid #a00;
    padding: 10px 15px;
    font-family: 'Source Code Pro', 'Courier New', monospace;
    font-size: 14px;
    cursor: pointer;
    flex-grow: 1;
    text-align: center;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
}

.new-game-btn:hover, .new-game-btn:active {
    background-color: #500;
    color: #f00;
    border-color: #f00;
    box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
}

.new-game-btn::after {
    content: "!";
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #a00;
    font-weight: bold;
}

.new-game-btn:hover::after {
    color: #f00;
}

/* Top Controls */
.top-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 10px;
    z-index: 10;
}

.top-control-btn {
    background: #111;
    border: 1px solid #0a0;
    color: #fff;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 12px;
    font-family: 'Source Code Pro', 'Courier New', monospace;
    transition: all 0.2s;
}

.top-control-btn:hover {
    background: #222;
    color: #0f0;
}
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #0a0;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #0f0;
            border-color: #0f0;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #111;
            border: 1px solid #0a0;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #0f0;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #222;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
            color: #0f0;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f00;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f00;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #0f0;
            font-weight: bold;
        }
        
        .damage {
            color: #f00;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9900;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #0ff;
            font-weight: bold;
        }
        
        .cursed {
            color: #a0f;
            font-weight: bold;
            text-shadow: 0 0 3px #f0f;
        }
        
        .magic {
            color: #0cf;
            font-weight: bold;
            text-shadow: 0 0 3px #0ff;
        }
        
        .undead {
            color: #8b8;
            font-weight: bold;
            text-shadow: 0 0 3px #0f0;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #0a0;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #0a0;
            color: #fff;
            border-color: #0f0;
            box-shadow: 0 0 15px #0f0;
        }
        
        /* Merchant Item Display */
        .merchant-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .merchant-item {
            background-color: #222;
            border: 1px solid #0a0;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: #fff;
        }
        
        .merchant-item:hover {
            background-color: #333;
            border-color: #0f0;
        }
        
        .merchant-item h3 {
            color: #0f0;
            margin: 0 0 5px 0;
            font-size: 16px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .merchant-item p {
            color: #fff;
            font-size: 14px;
            margin: 0;
        }
        
        .merchant-cost {
            color: #ff0;
            font-weight: bold;
            margin-top: 5px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #0a0;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #0a0;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #0f0;
        }
        
        /* Character Creation Stats */
        .char-stats {
            background-color: #111;
            border: 1px solid #0a0;
            padding: 15px;
            margin: 15px 0;
        }
        
        .stat-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            color: #fff;
        }
        
        .stat-name {
            color: #0f0;
        }
        
        /* Class specific colors */
        .wizard {
            color: #0cf;
        }
        
        .warrior {
            color: #f00;
        }
        
        .necromancer {
            color: #a0f;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .merchant-items {
                grid-template-columns: 1fr;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound <!-- Top Controls -->
<div class="top-controls">
    <div class="top-control-btn" onclick="toggleSound()">
        SOUND: <span id="sound-status">ON</span>
    </div>
    <div class="top-control-btn" onclick="newGame()">
        NEW GAME
    </div>
</div>
        
        <div class="header">
            <h1>ISLAND OF LOST SOULS</h1>
            <h2>LEVEL 1: ENTERING VILLAGE OF THE DAMNED</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number current">1</div>
            <div class="level-number">2</div>
            <div class="level-number">3</div>
            <div class="level-number">4</div>
            <div class="level-number">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Character Creation Screen -->
        <div id="screen-creation" class="screen active-screen">
            <h2>YOUR QUEST BEGINS</h2>
            <div class="story-text">
                <p>The Island of Lost Souls is shrouded in eternal mist, a cursed place where the damned wander for eternity. Your ship has crashed upon its rocky shores, and you are the sole survivor.</p>
                <p>Before you lies the Village of the Damned, its buildings crumbling under the weight of centuries-old curses. The air is thick with the scent of decay and ancient magic.</p>
                <p>You must navigate through this accursed settlement to reach the Forest of Dreadwood beyond. But first, you must choose your path. What kind of soul are you?</p>
                
                <div class="char-stats">
                    <div class="stat-line">
                        <span class="stat-name wizard">WIZARD</span>
                        <span>+5 Magic, +20 Health, +2 Agility, +1 Strength</span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-name warrior">WARRIOR</span>
                        <span>+6 Strength, +35 Health, +1 Agility, +0 Magic</span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-name necromancer">NECROMANCER</span>
                        <span>+4 Magic, +25 Health, +1 Agility, +3 Dark Power</span>
                    </div>
                </div>
                
                <p>Each class has unique abilities that will help you survive. Wizards can cast spells, Warriors are combat masters, and Necromancers can control the undead.</p>
                <p>You will roll 2d6 for each base attribute, then add your class bonus.</p>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="selectClass('wizard')">BECOME A WIZARD</button>
                <button class="choice-btn" onclick="selectClass('warrior')">BECOME A WARRIOR</button>
                <button class="choice-btn" onclick="selectClass('necromancer')">BECOME A NECROMANCER</button>
            </div>
        </div>
        
        <!-- Dice Roll Screen -->
        <div id="screen-dice" class="screen">
            <h2>CHARACTER ATTRIBUTES</h2>
            <div class="story-text">
                <p>You have chosen the path of a <span id="selected-class" class="enemy"></span>.</p>
                <p>Now roll the dice for your attributes:</p>
                <p><strong>Strength:</strong> 2 dice + class bonus (determines physical power)</p>
                <p><strong>Health:</strong> 2 dice + class bonus (your vitality)</p>
                <p><strong>Agility:</strong> 2 dice + class bonus (helps in avoiding dangers)</p>
                <p><strong>Magic:</strong> 2 dice + class bonus (arcane power for spells)</p>
                <div id="dice-results"></div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="rollCharacterStats()">ROLL DICE</button>
                <button class="action-btn" onclick="proceedToShipwreck()" id="proceed-btn" disabled>BEGIN YOUR JOURNEY</button>
            </div>
        </div>
        
        <!-- Shipwreck Scene -->
        <div id="screen-shipwreck" class="screen">
            <h2>THE SHIPWRECK</h2>
            <div class="story-text">
                <p>You wake up on a rocky beach, the wreckage of your ship scattered around you. The storm that brought you here has passed, leaving only an eerie silence.</p>
                <p>Among the debris, you find some useful items. You can take what you can carry.</p>
                <p>You have <span class="gold" id="shipwreck-gold">15</span> gold from your personal belongings.</p>
                
                <div class="merchant-items">
                    <div class="merchant-item" onclick="selectShipwreckItem('waterlogged_spellbook')">
                        <h3>WATERLOGGED SPELLBOOK</h3>
                        <p>Contains basic spells. Some pages are still legible.</p>
                        <div class="merchant-cost">Requires: Wizard or Necromancer</div>
                    </div>
                    <div class="merchant-item" onclick="selectShipwreckItem('broken_sword')">
                        <h3>BROKEN SWORD</h3>
                        <p>Damaged but still sharp enough to be dangerous.</p>
                        <div class="merchant-cost">Requires: Warrior</div>
                    </div>
                    <div class="merchant-item" onclick="selectShipwreckItem('healing_herbs')">
                        <h3>HEALING HERBS</h3>
                        <p>Can be used to restore 1d10+5 health when injured.</p>
                        <div class="merchant-cost">Any class</div>
                    </div>
                    <div class="merchant-item" onclick="selectShipwreckItem('lantern')">
                        <h3>SHIP'S LANTERN</h3>
                        <p>Still has oil. Light may keep creatures at bay.</p>
                        <div class="merchant-cost">Any class</div>
                    </div>
                    <div class="merchant-item" onclick="selectShipwreckItem('rope')">
                        <h3>LENGTH OF ROPE</h3>
                        <p>Useful for climbing or securing things.</p>
                        <div class="merchant-cost">Any class</div>
                    </div>
                    <div class="merchant-item" onclick="selectShipwreckItem('lockpicks')">
                        <h3>LOCKPICKS</h3>
                        <p>May help with locked doors or chests.</p>
                        <div class="merchant-cost">Any class</div>
                    </div>
                </div>
                
                <div id="selected-shipwreck-item-display" style="display: none; margin-top: 15px; padding: 10px; background-color: #111; border: 1px solid #0a0;">
                    <p>Selected: <span id="selected-shipwreck-item-name" class="item"></span></p>
                    <p id="selected-shipwreck-item-desc"></p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="confirmShipwreckItem()" id="confirm-shipwreck-btn" disabled>TAKE THIS ITEM</button>
                <button class="action-btn" onclick="skipShipwreckItem()">TAKE NOTHING (CONTINUE)</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">MAGIC:</span> <span id="stat-magic" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>VILLAGE OF THE DAMNED</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useClassAbility()">CLASS ABILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                 <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
<button class="new-game-btn" onclick="newGame()">NEW GAME</button>            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL 1 COMPLETE!</h2>
            <div class="story-text">
                <p>You have survived the Village of the Damned!</p>
                <p>As you leave the crumbling village behind, the dark, twisted trees of the Forest of Dreadwood loom before you. The path ahead is even more treacherous, but you cannot turn back.</p>
                <p>All your stats, gold, and inventory will carry over to Level 2: Forest of Dreadwood.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">MAGIC:</span> <span id="next-stat-magic" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #111; border: 1px solid #0a0;">
                    <h3 style="color: #0f0; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO LEVEL 2: FOREST OF DREADWOOD</button>
            </div>
        </div>
        
        <div class="footer">
            ISLAND OF LOST SOULS - A Cursed Island Adventure<br>
            Level 1: Entering Village of the Damned
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'magic':
                    playBeep(900, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.2, 'sine'), 150);
                    break;
                case 'cursed':
                    playBeep(150, 0.4, 'sawtooth');
                    setTimeout(() => playBeep(100, 0.4, 'sawtooth'), 400);
                    break;
                case 'undead':
                    playBeep(300, 0.2, 'sine');
                    setTimeout(() => playBeep(250, 0.2, 'sine'), 200);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - will be saved to localStorage
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            magic: 0,
            darkPower: 0, // Only for necromancer
            gold: 15, // Starting gold
            inventory: [],
            equippedWeapon: 'Fists',
            equippedArmor: 'Tattered Clothes',
            currentSection: 1,
            gameComplete: false,
            level: 1,
            shipwreckItem: null,
            villageCleared: false
        };
        
        // Shipwreck items data
        const shipwreckItems = {
            waterlogged_spellbook: {
                name: 'Waterlogged Spellbook',
                description: 'Contains basic spells. Some pages are still legible',
                classRestriction: ['wizard', 'necromancer'],
                effect: '+2 to magic checks when casting known spells'
            },
            broken_sword: {
                name: 'Broken Sword',
                description: 'Damaged but still sharp enough to be dangerous',
                classRestriction: ['warrior'],
                effect: 'Can be equipped as a weapon'
            },
            healing_herbs: {
                name: 'Healing Herbs',
                description: 'Can be used to restore 1d10+5 health when injured',
                classRestriction: ['wizard', 'warrior', 'necromancer'],
                effect: 'Restores health when consumed'
            },
            lantern: {
                name: 'Ship\'s Lantern',
                description: 'Still has oil. Light may keep creatures at bay',
                classRestriction: ['wizard', 'warrior', 'necromancer'],
                effect: 'Light keeps some creatures away'
            },
            rope: {
                name: 'Length of Rope',
                description: 'Useful for climbing or securing things',
                classRestriction: ['wizard', 'warrior', 'necromancer'],
                effect: 'Helpful in certain situations'
            },
            lockpicks: {
                name: 'Lockpicks',
                description: 'May help with locked doors or chests',
                classRestriction: ['wizard', 'warrior', 'necromancer'],
                effect: '+2 to agility checks involving locks'
            }
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            enemyType: '' // 'undead', 'cursed', 'human'
        };
        
        // Game story sections for Level 1
        const storySections = {
            1: {
                text: "You stand at the edge of the Village of the Damned. Crumbling stone buildings line muddy streets. Flickering, ghostly lights dance in windows, and a low moaning seems to come from everywhere at once. The main street lies ahead, but you notice two alleyways branching off.",
                choices: [
                    {text: "Take the main street (most direct path)", nextSection: 2, skillCheck: false},
                    {text: "Sneak through the left alley (quieter but darker)", nextSection: 3, skillCheck: true, checkType: 'agility', difficulty: 12},
                    {text: "Check the right alley (might find supplies)", nextSection: 4, skillCheck: true, checkType: 'agility', difficulty: 10}
                ]
            },
            2: {
                text: "You walk cautiously down the main street. Cobblestones are cracked and overgrown with sickly-looking moss. Ahead, you see a shadowy figure standing motionless in the middle of the road. It hasn't noticed you yet.",
                choices: [
                    {text: "Approach the figure cautiously", nextSection: 5, skillCheck: false},
                    {text: "Try to sneak around it", nextSection: 6, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Call out to it", nextSection: 7, skillCheck: false}
                ]
            },
            3: {
                text: "You slip into the dark alley. The buildings here are in even worse repair. You hear scuttling sounds from the shadows. Something is moving in the darkness ahead.",
                choices: [
                    {text: "Continue forward carefully", nextSection: 8, skillCheck: true, checkType: 'agility', difficulty: 10},
                    {text: "Use your lantern if you have one", nextSection: 9, skillCheck: false, requirement: "Ship's Lantern"},
                    {text: "Retreat to the main street", nextSection: 1, skillCheck: false}
                ]
            },
            4: {
                text: "The right alley is cluttered with debris and broken crates. You might find something useful here if you search carefully.",
                choices: [
                    {text: "Search the debris", nextSection: 10, skillCheck: false},
                    {text: "Continue down the alley", nextSection: 11, skillCheck: false}
                ]
            },
            5: {
                text: "As you approach, the figure turns slowly. Its face is pale and expressionless, eyes hollow and dark. It's one of the DAMNED VILLAGERS - a cursed soul trapped forever on this island.",
                choices: [
                    {text: "Attempt to communicate", nextSection: 12, skillCheck: false},
                    {text: "Prepare for a fight", nextSection: 13, skillCheck: false},
                    {text: "Try to intimidate it", nextSection: 14, skillCheck: true, checkType: 'strength', difficulty: 15}
                ]
            },
            6: {
                text: "You try to sneak past the figure, keeping to the shadows...",
                choices: [
                    {text: "Continue sneaking", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully slip past the Damned Villager without being noticed. You continue down the main street.";
                    } else {
                        playSound('failure');
                        return "You step on a loose stone! The Damned Villager turns toward you with a low groan and begins to shuffle in your direction!";
                    }
                }
            },
            7: {
                text: "You call out to the figure. It turns slowly, its movements jerky and unnatural. It doesn't respond with words, only a low, mournful moan.",
                choices: [
                    {text: "Approach slowly", nextSection: 16, skillCheck: false},
                    {text: "Prepare to defend yourself", nextSection: 13, skillCheck: false},
                    {text: "Back away slowly", nextSection: 17, skillCheck: true, checkType: 'agility', difficulty: 10}
                ]
            },
            8: {
                text: "You move forward in the dark alley. The scuttling sounds grow louder. Suddenly, three RAT-LIKE CREATURES with glowing red eyes emerge from the shadows! They're larger than normal rats and look hungry.",
                choices: [
                    {text: "Fight the creatures", nextSection: 18, skillCheck: false},
                    {text: "Try to scare them away", nextSection: 19, skillCheck: false},
                    {text: "Use magic if you can", nextSection: 20, skillCheck: false, requirement: 'magic', minValue: 8}
                ]
            },
            9: {
                text: "You light your lantern. The sudden brightness reveals the alley clearly and sends the scuttling creatures scrambling away into deeper shadows. The path ahead is now clear.",
                choices: [
                    {text: "Continue down the alley", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The <span class='item'>Ship's Lantern</span> saves you from an encounter! The light keeps the creatures at bay.";
                }
            },
            10: {
                text: "You search through the debris, moving broken crates and rotten sacks.",
                choices: [
                    {text: "Continue searching", nextSection: 22, skillCheck: false}
                ],
                action: function() {
                    const findChance = Math.random();
                    if (findChance > 0.7) {
                        const goldFound = rollDice(2, 10);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        playSound('item');
                        return "You find a small, rusted strongbox hidden under debris! Inside are <span class='gold'>" + goldFound + " Gold</span> coins.";
                    } else if (findChance > 0.4) {
                        addToInventory('Old Healing Potion');
                        playSound('item');
                        return "You find an <span class='item'>Old Healing Potion</span> tucked away in a broken crate. It might still work.";
                    } else {
                        playSound('failure');
                        return "You search thoroughly but find nothing of value. Just rotten wood and broken pottery.";
                    }
                }
            },
            11: {
                text: "You continue down the alley, which eventually opens into a small courtyard. In the center stands a weathered stone well. A faint whispering seems to come from it.",
                choices: [
                    {text: "Approach the well", nextSection: 23, skillCheck: false},
                    {text: "Ignore it and continue", nextSection: 24, skillCheck: false},
                    {text: "Throw something into the well", nextSection: 25, skillCheck: false}
                ]
            },
            12: {
                text: "You speak to the Damned Villager, asking who it is and what happened here. It opens its mouth but only a hollow, echoing whisper emerges: 'Cursed... all cursed... cannot leave...'",
                choices: [
                    {text: "Ask how to leave the village", nextSection: 26, skillCheck: false},
                    {text: "Offer to help break the curse", nextSection: 27, skillCheck: false},
                    {text: "Back away slowly", nextSection: 17, skillCheck: true, checkType: 'agility', difficulty: 10}
                ]
            },
            13: {
                text: "The Damned Villager shambles toward you, arms outstretched. Its touch is said to drain the life from the living!",
                choices: [
                    {text: "Fight the Damned Villager", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Damned Villager";
                    combatState.enemyHealth = 30;
                    combatState.enemyCurrentHealth = 30;
                    combatState.enemyStrength = 9;
                    combatState.enemyDamageDice = 1;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 29;
                    combatState.round = 1;
                    combatState.enemyType = 'undead';
                    
                    playSound('undead');
                    return "<span class='undead'>Damned Villager</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            14: {
                text: "You roar and brandish your weapon, trying to intimidate the creature...",
                choices: [
                    {text: "See if it worked", nextSection: 30, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "The Damned Villager seems to hesitate, then slowly backs away into the shadows. You've intimidated it!";
                    } else {
                        playSound('failure');
                        return "Your display of aggression only seems to anger it! It lunges toward you!";
                    }
                }
            },
            15: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue down the street", nextSection: 31, skillCheck: false}
                ]
            },
            16: {
                text: "You approach the Damned Villager slowly. As you get closer, you can see the sorrow in its hollow eyes. It reaches out a hand toward you, not aggressively, but almost... pleadingly.",
                choices: [
                    {text: "Take its hand", nextSection: 32, skillCheck: false},
                    {text: "Step back", nextSection: 33, skillCheck: false},
                    {text: "Ask what it wants", nextSection: 34, skillCheck: false}
                ]
            },
            17: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue down the street", nextSection: 31, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You back away slowly and the Damned Villager doesn't follow. You slip away down a side street.";
                    } else {
                        playSound('failure');
                        return "The Damned Villager shambles after you as you retreat! You'll have to face it!";
                    }
                }
            },
            18: {
                text: "The rat-like creatures attack with surprising speed! Their teeth look sharp and possibly venomous.",
                choices: [
                    {text: "Fight the creatures", nextSection: 35, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Cursed Rats";
                    combatState.enemyHealth = 20;
                    combatState.enemyCurrentHealth = 20;
                    combatState.enemyStrength = 5;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 4;
                    combatState.nextSection = 36;
                    combatState.round = 1;
                    combatState.enemyType = 'cursed';
                    
                    playSound('cursed');
                    return "<span class='cursed'>Cursed Rats</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            19: {
                text: "You shout and stomp your feet, trying to scare the creatures away.",
                choices: [
                    {text: "See if it worked", nextSection: 37, skillCheck: false}
                ],
                action: function() {
                    const scareChance = Math.random();
                    if (scareChance > 0.5) {
                        playSound('success');
                        return "The creatures hesitate, then scurry back into the shadows. You've scared them off!";
                    } else {
                        playSound('failure');
                        return "The creatures aren't frightened! They attack!";
                    }
                }
            },
            20: {
                text: "You call upon your magical powers...",
                choices: [
                    {text: "Cast a spell", nextSection: 38, skillCheck: false}
                ],
                action: function() {
                    if (gameState.magic >= 8) {
                        playSound('magic');
                        if (gameState.playerClass === 'wizard') {
                            return "You cast a minor fire spell! The creatures shriek and scatter from the flames!";
                        } else if (gameState.playerClass === 'necromancer') {
                            return "You channel dark energy! The creatures sense your power and flee in terror!";
                        }
                    } else {
                        playSound('failure');
                        return "You try to cast a spell but your magic isn't strong enough yet. The creatures attack!";
                    }
                }
            },
            21: {
                text: "The alley opens into a small square with a dilapidated shrine at its center. The shrine is dedicated to some forgotten deity. A faint magical aura surrounds it.",
                choices: [
                    {text: "Examine the shrine", nextSection: 39, skillCheck: false},
                    {text: "Continue through the square", nextSection: 40, skillCheck: false},
                    {text: "Rest at the shrine", nextSection: 41, skillCheck: false}
                ]
            },
            22: {
                text: "You've finished searching the debris.",
                choices: [
                    {text: "Continue down the alley", nextSection: 11, skillCheck: false}
                ]
            },
            23: {
                text: "You approach the stone well. The whispering grows louder but remains indistinct. Looking down, you see only darkness. Something glints at the bottom.",
                choices: [
                    {text: "Lower the bucket", nextSection: 42, skillCheck: false},
                    {text: "Peer deeper into the well", nextSection: 43, skillCheck: false},
                    {text: "Ignore it and move on", nextSection: 24, skillCheck: false}
                ]
            },
            24: {
                text: "You leave the courtyard and continue through the village. The buildings begin to thin, and you can see the edge of the village ahead. The dark trees of the Forest of Dreadwood loom in the distance.",
                choices: [
                    {text: "Head toward the forest", nextSection: 100, skillCheck: false}
                ]
            },
            25: {
                text: "You pick up a stone and toss it into the well. You hear it clatter against the sides, then a distant splash. The whispering stops abruptly.",
                choices: [
                    {text: "Wait to see what happens", nextSection: 44, skillCheck: false},
                    {text: "Leave quickly", nextSection: 24, skillCheck: false}
                ]
            },
            26: {
                text: "'Leave...' the Damned Villager whispers. 'Only through the forest... past the guardian...' It points a trembling finger toward the far end of the village.",
                choices: [
                    {text: "Ask about the guardian", nextSection: 45, skillCheck: false},
                    {text: "Thank it and continue", nextSection: 46, skillCheck: false},
                    {text: "Offer to free it", nextSection: 47, skillCheck: false}
                ]
            },
            27: {
                text: "'Cannot be free...' it whispers sadly. 'Curse is eternal... unless the Heart of the Island is destroyed... in the castle...'",
                choices: [
                    {text: "Ask about the castle", nextSection: 48, skillCheck: false},
                    {text: "Promise to try", nextSection: 49, skillCheck: false},
                    {text: "Ask for a blessing", nextSection: 50, skillCheck: false}
                ]
            },
            28: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 51, skillCheck: false}
                ]
            },
            29: {
                text: "", // After combat
                choices: [
                    {text: "Search the remains", nextSection: 52, skillCheck: false},
                    {text: "Continue down the street", nextSection: 31, skillCheck: false}
                ]
            },
            30: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue down the street", nextSection: 31, skillCheck: false}
                ]
            },
            31: {
                text: "You continue down the main street. The village seems to be coming to an end. You can see a broken archway ahead that marks the village exit. But something is blocking the way...",
                choices: [
                    {text: "Approach the exit", nextSection: 53, skillCheck: false},
                    {text: "Look for another way around", nextSection: 54, skillCheck: true, checkType: 'agility', difficulty: 12}
                ]
            },
            32: {
                text: "You reach out and take the Damned Villager's hand. It's cold as ice. A vision floods your mind: the village in its prime, then a dark curse falling, souls trapped for eternity. You understand their suffering.",
                choices: [
                    {text: "Release the hand", nextSection: 55, skillCheck: false}
                ],
                action: function() {
                    playSound('cursed');
                    const healthLoss = rollDice(1, 6);
                    gameState.health -= healthLoss;
                    updateStatsDisplay();
                    addToInventory('Ghostly Insight');
                    return "The vision costs you <span class='damage'>" + healthLoss + " Health</span>, but you gain <span class='item'>Ghostly Insight</span>. You now understand the curse better.";
                }
            },
            33: {
                text: "You step back from the Damned Villager. It seems to understand and doesn't follow. Instead, it points down a side street, as if showing you a safer path.",
                choices: [
                    {text: "Take the suggested path", nextSection: 56, skillCheck: false},
                    {text: "Continue on the main street", nextSection: 31, skillCheck: false}
                ]
            },
            34: {
                text: "'Freedom...' it whispers. 'End the curse... destroy the Heart...' It then points toward the end of the village before fading into mist.",
                choices: [
                    {text: "Head toward where it pointed", nextSection: 57, skillCheck: false},
                    {text: "Continue down the street", nextSection: 31, skillCheck: false}
                ]
            },
            35: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 58, skillCheck: false}
                ]
            },
            36: {
                text: "", // After combat
                choices: [
                    {text: "Search the area", nextSection: 59, skillCheck: false},
                    {text: "Continue down the alley", nextSection: 21, skillCheck: false}
                ]
            },
            37: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue down the alley", nextSection: 21, skillCheck: false}
                ]
            },
            38: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue down the alley", nextSection: 21, skillCheck: false}
                ]
            },
            39: {
                text: "The shrine is dedicated to 'Aeloria, Guardian of Lost Souls'. The stone statue is cracked but still radiates a faint protective magic. An offering bowl lies at its feet with a few old coins.",
                choices: [
                    {text: "Take the coins", nextSection: 60, skillCheck: false},
                    {text: "Make an offering", nextSection: 61, skillCheck: false},
                    {text: "Pray at the shrine", nextSection: 62, skillCheck: false}
                ]
            },
            40: {
                text: "You pass through the square and find yourself back on the main street, closer to the village exit.",
                choices: [
                    {text: "Continue toward the exit", nextSection: 31, skillCheck: false}
                ]
            },
            41: {
                text: "You sit at the shrine to rest. The protective magic soothes your wounds slightly.",
                choices: [
                    {text: "Continue your journey", nextSection: 40, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 8) + 2;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    playSound('magic');
                    return "The shrine's magic heals you for " + actualHeal + " Health.";
                }
            },
            42: {
                text: "You lower the wooden bucket into the well. After a moment, you hear it hit water. When you pull it up, the bucket contains not water, but shimmering, silvery liquid that glows faintly.",
                choices: [
                    {text: "Take the liquid", nextSection: 63, skillCheck: false},
                    {text: "Pour it back", nextSection: 64, skillCheck: false}
                ]
            },
            43: {
                text: "You peer deeper into the well. In the darkness, you see two glowing points of light looking back at you. Something is down there!",
                choices: [
                    {text: "Step back quickly", nextSection: 65, skillCheck: false},
                    {text: "Call out", nextSection: 66, skillCheck: false}
                ]
            },
            44: {
                text: "You wait. For a moment, nothing happens. Then a cold wind blows up from the well, carrying with it a mournful sigh. The whispering begins again, louder this time.",
                choices: [
                    {text: "Leave immediately", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    playSound('cursed');
                    return "You feel a chill run down your spine. It's time to leave this place.";
                }
            },
            45: {
                text: "'Guardian... at the bridge... tests those who pass...' the Damned Villager whispers. 'Must be worthy... or join us...'",
                choices: [
                    {text: "Ask how to pass the test", nextSection: 67, skillCheck: false},
                    {text: "Thank it for the warning", nextSection: 46, skillCheck: false}
                ]
            },
            46: {
                text: "You thank the Damned Villager. It nods slowly, then fades into mist. You continue down the street with new knowledge.",
                choices: [
                    {text: "Continue", nextSection: 31, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Knowledge of the Guardian');
                    playSound('success');
                    return "You gained <span class='item'>Knowledge of the Guardian</span>. This may help you pass the test at the bridge.";
                }
            },
            47: {
                text: "'Cannot be free...' it repeats sadly. 'But you... can end this...' It places a cold hand on your shoulder. You feel a surge of energy.",
                choices: [
                    {text: "Accept the energy", nextSection: 68, skillCheck: false}
                ],
                action: function() {
                    playSound('magic');
                    if (gameState.playerClass === 'necromancer') {
                        gameState.darkPower += 3;
                        return "As a Necromancer, you absorb the dark energy! Your <span class='necromancer'>Dark Power</span> increases by 3!";
                    } else {
                        gameState.magic += 2;
                        updateStatsDisplay();
                        return "You feel magical energy surge through you! Your <span class='magic'>Magic</span> increases by 2!";
                    }
                }
            },
            48: {
                text: "'Castle... in the mountains... beyond the forest...' it whispers. 'Heart of the Island is there... guarded by the Master...'",
                choices: [
                    {text: "Ask about the Master", nextSection: 69, skillCheck: false},
                    {text: "Thank it and continue", nextSection: 46, skillCheck: false}
                ]
            },
            49: {
                text: "You promise to try to break the curse. The Damned Villager seems to smile faintly. 'May Aeloria guide you...' it whispers before fading away.",
                choices: [
                    {text: "Continue", nextSection: 31, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Blessing of the Damned');
                    playSound('magic');
                    return "You receive a <span class='item'>Blessing of the Damned</span>. The cursed souls wish you success.";
                }
            },
            50: {
                text: "You ask for a blessing. The Damned Villager places both hands on your head. A cold sensation spreads through you, but it feels protective rather than harmful.",
                choices: [
                    {text: "Thank it", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    playSound('magic');
                    gameState.maxHealth += 5;
                    gameState.health += 5;
                    updateStatsDisplay();
                    return "You receive a protective blessing! Your <span class='success'>maximum Health increases by 5</span>!";
                }
            },
            51: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 28, skillCheck: false}
                ]
            },
            52: {
                text: "Searching the remains of the Damned Villager, you find a few personal items that turned to dust at your touch, but one item remains solid: a silver locket with a faded portrait inside.",
                choices: [
                    {text: "Take the locket", nextSection: 31, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(2, 8);
                    gameState.gold += goldFound;
                    addToInventory('Silver Locket');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Silver Locket</span>. The portrait inside shows a happy couple, now long lost.";
                }
            },
            53: {
                text: "As you approach the village exit, you see what's blocking the way: a massive, spectral GUARDIAN OF THE BRIDGE. It stands before a stone bridge that leads to the Forest of Dreadwood. The guardian turns its hollow eyes toward you.",
                choices: [
                    {text: "Approach the guardian", nextSection: 70, skillCheck: false},
                    {text: "Try to find another way", nextSection: 71, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Use your knowledge of the guardian if you have it", nextSection: 72, skillCheck: false, requirement: 'Knowledge of the Guardian'}
                ]
            },
            54: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 73, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You find a hidden path around the village outskirts! You bypass the main exit entirely.";
                    } else {
                        playSound('failure');
                        return "You can't find another way around. You'll have to face whatever is at the main exit.";
                    }
                }
            },
            55: {
                text: "You release the Damned Villager's hand. It nods to you gratefully before fading away. You now understand the true tragedy of this place.",
                choices: [
                    {text: "Continue down the street", nextSection: 31, skillCheck: false}
                ]
            },
            56: {
                text: "You take the side street indicated by the Damned Villager. It winds through quiet, empty lanes and eventually brings you to the village outskirts, near the exit.",
                choices: [
                    {text: "Continue to the exit", nextSection: 53, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The Damned Villager's guidance was true! You've avoided several dangers.";
                }
            },
            57: {
                text: "You follow the direction the Damned Villager pointed. The path leads you through a quiet part of the village and emerges near the exit.",
                choices: [
                    {text: "Continue to the exit", nextSection: 53, skillCheck: false}
                ]
            },
            58: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 35, skillCheck: false}
                ]
            },
            59: {
                text: "Searching the area where you fought the creatures, you find their nest. Among the bones and debris, you discover a few useful items.",
                choices: [
                    {text: "Take what you can", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(1, 10);
                    gameState.gold += goldFound;
                    
                    const itemChance = Math.random();
                    if (itemChance > 0.7) {
                        addToInventory('Cursed Rat Teeth');
                        playSound('item');
                        return "You find <span class='gold'>" + goldFound + " Gold</span> and some <span class='item'>Cursed Rat Teeth</span> that might be useful as components or trophies.";
                    } else {
                        playSound('item');
                        return "You find <span class='gold'>" + goldFound + " Gold</span> in the nest.";
                    }
                }
            },
            60: {
                text: "You take the old coins from the offering bowl. As your fingers touch them, you feel a slight chill but nothing more.",
                choices: [
                    {text: "Leave the shrine", nextSection: 40, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(1, 12) + 5;
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You take <span class='gold'>" + goldFound + " Gold</span> from the offering bowl. You hope the deity understands.";
                }
            },
            61: {
                text: "You place some of your gold in the offering bowl as a sign of respect.",
                choices: [
                    {text: "Leave the shrine", nextSection: 40, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 10) {
                        gameState.gold -= 10;
                        updateStatsDisplay();
                        playSound('magic');
                        gameState.health = gameState.maxHealth; // Full heal
                        return "You offer <span class='gold'>10 Gold</span> to the shrine. A warm light envelops you, healing all your wounds!";
                    } else {
                        playSound('failure');
                        return "You don't have enough gold to make a proper offering.";
                    }
                }
            },
            62: {
                text: "You kneel and pray at the shrine. A sense of peace washes over you, and you feel slightly strengthened.",
                choices: [
                    {text: "Leave the shrine", nextSection: 40, skillCheck: false}
                ],
                action: function() {
                    playSound('magic');
                    const statBoost = Math.floor(Math.random() * 3);
                    if (statBoost === 0) {
                        gameState.strength += 1;
                        updateStatsDisplay();
                        return "You feel physically strengthened! <span class='success'>Strength +1</span>";
                    } else if (statBoost === 1) {
                        gameState.agility += 1;
                        updateStatsDisplay();
                        return "You feel more nimble! <span class='success'>Agility +1</span>";
                    } else {
                        gameState.magic += 1;
                        updateStatsDisplay();
                        return "Your magical senses are heightened! <span class='success'>Magic +1</span>";
                    }
                }
            },
            63: {
                text: "You carefully pour the shimmering liquid into a flask from your supplies. It continues to glow with a soft light.",
                choices: [
                    {text: "Leave the well", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Moonwell Water');
                    playSound('magic');
                    return "You collect the <span class='item'>Moonwell Water</span>. It radiates powerful magic and may have special properties.";
                }
            },
            64: {
                text: "You pour the liquid back into the well. As it disappears into the darkness, the whispering stops completely. The well seems... peaceful now.",
                choices: [
                    {text: "Leave the well", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    playSound('magic');
                    return "You've returned the magical water to its source. You feel you've done the right thing.";
                }
            },
            65: {
                text: "You step back from the well quickly. The glowing eyes in the darkness blink once, then disappear. You decide it's best to leave this place.",
                choices: [
                    {text: "Leave the courtyard", nextSection: 24, skillCheck: false}
                ]
            },
            66: {
                text: "You call out into the well. 'Hello?' Your voice echoes strangely. After a moment, a voice echoes back: 'Leave... this place...' It sounds ancient and tired.",
                choices: [
                    {text: "Ask who's there", nextSection: 74, skillCheck: false},
                    {text: "Heed the warning and leave", nextSection: 24, skillCheck: false}
                ]
            },
            67: {
                text: "'Answer its question... truthfully...' the Damned Villager whispers. 'Guardian knows lies...'",
                choices: [
                    {text: "Thank it for the advice", nextSection: 46, skillCheck: false}
                ]
            },
            68: {
                text: "The energy courses through you, strengthening your resolve. The Damned Villager fades away with what might be a smile.",
                choices: [
                    {text: "Continue down the street", nextSection: 31, skillCheck: false}
                ]
            },
            69: {
                text: "'The Master... ruler of this island... powerful... cruel...' it whispers fearfully. 'Broke our souls... made us this...'",
                choices: [
                    {text: "Ask how to defeat the Master", nextSection: 75, skillCheck: false},
                    {text: "Thank it for the information", nextSection: 46, skillCheck: false}
                ]
            },
            70: {
                text: "The guardian is a towering spectral figure in ancient armor. It speaks in a voice that echoes like stones grinding together: 'WHO SEEKS TO PASS? ONLY THOSE WHO ANSWER TRUE MAY CROSS.'",
                choices: [
                    {text: "Answer: 'I seek to leave this village'", nextSection: 76, skillCheck: false},
                    {text: "Answer: 'I seek to break the island's curse'", nextSection: 77, skillCheck: false},
                    {text: "Answer: 'I seek power and treasure'", nextSection: 78, skillCheck: false},
                    {text: "Try to fight the guardian", nextSection: 79, skillCheck: false}
                ]
            },
            71: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 80, skillCheck: false}
                ]
            },
            72: {
                text: "Remembering what the Damned Villager told you, you know you must answer the guardian's question truthfully. You approach confidently.",
                choices: [
                    {text: "Face the guardian", nextSection: 81, skillCheck: false}
                ]
            },
            73: {
                text: "", // Filled by action
                choices: [
                    {text: "Approach the forest", nextSection: 100, skillCheck: false}
                ]
            },
            74: {
                text: "'I AM THE WELL SPIRIT... GUARDIAN OF THIS WATER...' the voice echoes. 'TAKE NOT THE WATER UNLESS YOU MEAN TO USE IT WELL...'",
                choices: [
                    {text: "Promise to use it well", nextSection: 82, skillCheck: false},
                    {text: "Ask what it wants", nextSection: 83, skillCheck: false},
                    {text: "Leave", nextSection: 24, skillCheck: false}
                ]
            },
            75: {
                text: "'Destroy the Heart... in the castle...' it whispers. 'Only then... Master can be defeated...'",
                choices: [
                    {text: "Thank it and continue", nextSection: 46, skillCheck: false}
                ]
            },
            76: {
                text: "The guardian regards you silently for a moment. 'TRUTH, BUT NOT THE WHOLE TRUTH. YOU MAY PASS, BUT YOU WILL FACE DIFFICULTY IN THE FOREST.' The guardian steps aside.",
                choices: [
                    {text: "Cross the bridge", nextSection: 100, skillCheck: false}
                ],
                action: function() {
                    playSound('magic');
                    return "The guardian allows you to pass! You cross the bridge toward the Forest of Dreadwood.";
                }
            },
            77: {
                text: "The guardian's spectral eyes glow brighter. 'A NOBLE GOAL. YOU SPEAK TRUTH. YOU MAY PASS, AND THE FOREST WILL BE LESS HOSTILE TO YOU.' The guardian steps aside respectfully.",
                choices: [
                    {text: "Cross the bridge", nextSection: 100, skillCheck: false}
                ],
                action: function() {
                    playSound('magic');
                    addToInventory('Guardian\'s Favor');
                    return "The guardian is impressed by your goal! You receive the <span class='item'>Guardian's Favor</span> and may pass.";
                }
            },
            78: {
                text: "The guardian's form darkens. 'GREED CORRUPTS. YOU WILL NOT PASS THIS WAY.' It raises a spectral weapon.",
                choices: [
                    {text: "Prepare for combat", nextSection: 79, skillCheck: false},
                    {text: "Try a different answer", nextSection: 70, skillCheck: false}
                ]
            },
            79: {
                text: "You prepare to fight the guardian! This will not be easy.",
                choices: [
                    {text: "Begin the battle!", nextSection: 84, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Bridge Guardian";
                    combatState.enemyHealth = 50;
                    combatState.enemyCurrentHealth = 50;
                    combatState.enemyStrength = 12;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 85;
                    combatState.round = 1;
                    combatState.enemyType = 'undead';
                    
                    playSound('undead');
                    return "<span class='undead'>Bridge Guardian</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            80: {
                text: "", // Filled by action
                choices: [
                    {text: "Approach the forest", nextSection: 100, skillCheck: false}
                ]
            },
            81: {
                text: "The guardian regards you. 'YOU HAVE LEARNED FROM THE DAMNED. WISE. WHAT IS YOUR TRUE PURPOSE HERE?'",
                choices: [
                    {text: "'To survive and escape this island'", nextSection: 86, skillCheck: false},
                    {text: "'To break the curse and free the souls'", nextSection: 87, skillCheck: false},
                    {text: "'To discover the island's secrets'", nextSection: 88, skillCheck: false}
                ]
            },
            82: {
                text: "'THEN TAKE IT, AND USE IT WELL...' the voice echoes. The glowing eyes disappear.",
                choices: [
                    {text: "Take the water", nextSection: 63, skillCheck: false},
                    {text: "Leave", nextSection: 24, skillCheck: false}
                ]
            },
            83: {
                text: "'I WANT REST... RELEASE... THE CURSE BINDS ME HERE AS IT BINDS ALL...' the voice echoes mournfully.",
                choices: [
                    {text: "Promise to try to break the curse", nextSection: 89, skillCheck: false},
                    {text: "Leave", nextSection: 24, skillCheck: false}
                ]
            },
            84: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 90, skillCheck: false}
                ]
            },
            85: {
                text: "", // After combat
                choices: [
                    {text: "Cross the bridge", nextSection: 100, skillCheck: false}
                ]
            },
            86: {
                text: "The guardian nods slowly. 'HONEST. SURVIVAL IS THE FIRST LAW. YOU MAY PASS.' It steps aside.",
                choices: [
                    {text: "Cross the bridge", nextSection: 100, skillCheck: false}
                ]
            },
            87: {
                text: "The guardian's form brightens. 'THE NOBLEST GOAL. MAY YOU SUCCEED WHERE OTHERS HAVE FAILED. PASS, AND KNOW YOU HAVE MY BLESSING.' It not only steps aside but bows slightly.",
                choices: [
                    {text: "Cross the bridge", nextSection: 100, skillCheck: false}
                ],
                action: function() {
                    playSound('magic');
                    gameState.maxHealth += 10;
                    gameState.health += 10;
                    updateStatsDisplay();
                    addToInventory('Guardian\'s Ultimate Blessing');
                    return "The guardian is deeply moved by your goal! You receive a powerful blessing: <span class='success'>Maximum Health +10</span> and the <span class='item'>Guardian's Ultimate Blessing</span>!";
                }
            },
            88: {
                text: "The guardian considers. 'CURIOSITY IS A DOUBLE-EDGED SWORD. YOU MAY PASS, BUT BEWARE WHAT YOU LEARN.' It steps aside.",
                choices: [
                    {text: "Cross the bridge", nextSection: 100, skillCheck: false}
                ]
            },
            89: {
                text: "'THEN GO WITH MY HOPE...' the voice echoes, growing fainter. 'AND IF YOU FIND THE HEART... REMEMBER THE WELL...'",
                choices: [
                    {text: "Take the water", nextSection: 63, skillCheck: false},
                    {text: "Leave", nextSection: 24, skillCheck: false}
                ]
            },
            90: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 84, skillCheck: false}
                ]
            },
            100: {
                text: "CONGRATULATIONS! You have survived the Village of the Damned. You stand on the other side of the bridge, looking into the dark, twisted trees of the Forest of Dreadwood. Your journey is only beginning.",
                choices: [],
                action: function() {
                    gameState.villageCleared = true;
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-magic').textContent = gameState.magic;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    // Show special stats for necromancer
                    if (gameState.playerClass === 'necromancer' && gameState.darkPower > 0) {
                        const darkDiv = document.createElement('div');
                        darkDiv.innerHTML = `<strong>Dark Power:</strong> ${gameState.darkPower}`;
                        darkDiv.style.color = '#a0f';
                        inventoryDisplay.appendChild(darkDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 2;
                    saveGame();
                    
                    return "";
                }
            }
        };
        
        // Initialize game
        function initGame() {
            // Check for saved game
            const savedGame = localStorage.getItem('islandLostSoulsGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 1 (this page)
                if (savedState.level === 1) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    return;
                }
            }
            
            // Otherwise start with character creation
            showScreen('screen-creation');
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Select character class
        function selectClass(className) {
            playSound('click');
            gameState.playerClass = className;
            
            // Set class color for display
            let classDisplay = className.toUpperCase();
            if (className === 'wizard') classDisplay = '<span class="wizard">WIZARD</span>';
            else if (className === 'warrior') classDisplay = '<span class="warrior">WARRIOR</span>';
            else if (className === 'necromancer') classDisplay = '<span class="necromancer">NECROMANCER</span>';
            
            document.getElementById('selected-class').innerHTML = classDisplay;
            showScreen('screen-dice');
        }
        
        // Roll dice for character stats
        function rollCharacterStats() {
            playSound('roll');
            
            // Base rolls (2d6 each)
            const strengthRoll = rollDice(2, 6);
            const healthRoll = rollDice(2, 6);
            const agilityRoll = rollDice(2, 6);
            const magicRoll = rollDice(2, 6);
            
            // Apply class bonuses
            let strengthBonus = 0, healthBonus = 0, agilityBonus = 0, magicBonus = 0;
            
            switch(gameState.playerClass) {
                case 'wizard':
                    strengthBonus = 1;
                    healthBonus = 20;
                    agilityBonus = 2;
                    magicBonus = 5;
                    break;
                case 'warrior':
                    strengthBonus = 6;
                    healthBonus = 35;
                    agilityBonus = 1;
                    magicBonus = 0;
                    break;
                case 'necromancer':
                    strengthBonus = 0;
                    healthBonus = 25;
                    agilityBonus = 1;
                    magicBonus = 4;
                    gameState.darkPower = 3; // Starting dark power for necromancer
                    break;
            }
            
            gameState.strength = strengthRoll + strengthBonus;
            gameState.maxHealth = healthRoll + healthBonus;
            gameState.health = gameState.maxHealth;
            gameState.agility = agilityRoll + agilityBonus;
            gameState.magic = magicRoll + magicBonus;
            
            // Starting equipment based on class
            if (gameState.playerClass === 'warrior') {
                gameState.equippedWeapon = 'Broken Sword';
                gameState.inventory = ['Torch', 'Rations', 'Whetstone'];
            } else if (gameState.playerClass === 'wizard') {
                gameState.equippedWeapon = 'Staff';
                gameState.inventory = ['Torch', 'Rations', 'Basic Spell Components'];
            } else if (gameState.playerClass === 'necromancer') {
                gameState.equippedWeapon = 'Ritual Dagger';
                gameState.inventory = ['Torch', 'Rations', 'Bone Dust', 'Black Candles'];
            }
            
            gameState.equippedArmor = 'Tattered Clothes';
            
            let resultsHTML = `
                <div class="dice-roll">
                    Strength: ${strengthRoll} + ${strengthBonus} = <span class="stat-value">${gameState.strength}</span>
                </div>
                <div class="dice-roll">
                    Health: ${healthRoll} + ${healthBonus} = <span class="stat-value">${gameState.maxHealth}</span>
                </div>
                <div class="dice-roll">
                    Agility: ${agilityRoll} + ${agilityBonus} = <span class="stat-value">${gameState.agility}</span>
                </div>
                <div class="dice-roll">
                    Magic: ${magicRoll} + ${magicBonus} = <span class="stat-value">${gameState.magic}</span>
                </div>
            `;
            
            // Add dark power for necromancer
            if (gameState.playerClass === 'necromancer') {
                resultsHTML += `
                <div class="dice-roll">
                    Dark Power: <span class="necromancer">${gameState.darkPower}</span> (special necromancer ability)
                </div>`;
            }
            
            document.getElementById('dice-results').innerHTML = resultsHTML;
            
            document.getElementById('proceed-btn').disabled = false;
        }
        
        function proceedToShipwreck() {
            playSound('click');
            document.getElementById('shipwreck-gold').textContent = gameState.gold;
            showScreen('screen-shipwreck');
        }
        
        // Shipwreck item selection
        let selectedShipwreckItem = null;
        
        function selectShipwreckItem(itemKey) {
            playSound('click');
            selectedShipwreckItem = itemKey;
            const item = shipwreckItems[itemKey];
            
            document.getElementById('selected-shipwreck-item-name').textContent = item.name;
            document.getElementById('selected-shipwreck-item-desc').innerHTML = 
                `<span class="item">${item.name}</span>: ${item.description}<br>Effect: ${item.effect}<br>Class: ${item.classRestriction.join(', ')}`;
            document.getElementById('selected-shipwreck-item-display').style.display = 'block';
            
            // Enable confirm button if player's class matches restriction
            if (item.classRestriction.includes(gameState.playerClass)) {
                document.getElementById('confirm-shipwreck-btn').disabled = false;
            } else {
                document.getElementById('confirm-shipwreck-btn').disabled = true;
            }
        }
        
        function confirmShipwreckItem() {
            if (!selectedShipwreckItem) return;
            
            const item = shipwreckItems[selectedShipwreckItem];
            
            if (item.classRestriction.includes(gameState.playerClass)) {
                playSound('item');
                addToInventory(item.name);
                gameState.shipwreckItem = item.name;
                
                // Special handling for broken sword (can be equipped)
                if (selectedShipwreckItem === 'broken_sword' && gameState.playerClass === 'warrior') {
                    gameState.equippedWeapon = 'Broken Sword';
                }
                // Special handling for spellbook
                else if (selectedShipwreckItem === 'waterlogged_spellbook' && 
                        (gameState.playerClass === 'wizard' || gameState.playerClass === 'necromancer')) {
                    gameState.magic += 2;
                }
                
                updateStatsDisplay();
                updateInventoryDisplay();
                startGame();
            }
        }
        
        function skipShipwreckItem() {
            playSound('click');
            startGame();
        }
        
        function startGame() {
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-magic').textContent = gameState.magic;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item)) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Herbs' || item === 'Old Healing Potion') {
                const healAmount = rollDice(1, 10) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Ship\'s Lantern') {
                message = "The <span class='item'>Ship's Lantern</span> provides light in dark areas. Some creatures fear the light.";
            } else if (item === 'Length of Rope') {
                message = "The <span class='item'>Length of Rope</span> could be useful for climbing or securing things.";
            } else if (item === 'Lockpicks') {
                message = "The <span class='item'>Lockpicks</span> might help with locked doors or chests. You're not very skilled with them though.";
            } else if (item === 'Waterlogged Spellbook') {
                message = "The <span class='item'>Waterlogged Spellbook</span> contains basic spells. Some pages are still legible. It helps with magic.";
            } else if (item === 'Moonwell Water') {
                const healAmount = rollDice(2, 8) + 10;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory('Moonwell Water');
                playSound('magic');
                message = `You drink the <span class='item'>Moonwell Water</span> and restore ${actualHeal} Health! You also feel magically refreshed.`;
                gameState.magic += 2;
                updateStatsDisplay();
            } else if (item === 'Ghostly Insight') {
                message = "Your <span class='item'>Ghostly Insight</span> gives you understanding of the cursed souls on this island. You feel their suffering.";
            } else if (item === 'Blessing of the Damned') {
                message = "The <span class='item'>Blessing of the Damned</span> protects you slightly. Cursed creatures may be less hostile.";
            } else if (item === 'Guardian\'s Favor' || item === 'Guardian\'s Ultimate Blessing') {
                message = `The <span class='item'>${item}</span> marks you as one approved by the Bridge Guardian. It may help you in the forest.`;
            } else if (item === 'Knowledge of the Guardian') {
                message = "Your <span class='item'>Knowledge of the Guardian</span> tells you that the Bridge Guardian values truth above all else.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Fists' && 
                gameState.equippedArmor === 'Tattered Clothes') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Use class ability
        function useClassAbility() {
            playSound('click');
            
            let abilityText = "<div class='dice-roll'>";
            
            if (gameState.playerClass === 'wizard') {
                abilityText += "<strong>Wizard Abilities:</strong><br>";
                abilityText += "You can attempt to cast spells using your Magic stat.<br>";
                abilityText += `<button onclick="castSpell('light')" class="action-btn" style="margin: 5px;">Cast Light</button> `;
                abilityText += `<button onclick="castSpell('shield')" class="action-btn" style="margin: 5px;">Cast Shield</button> `;
                abilityText += `<button onclick="castSpell('detect_magic')" class="action-btn" style="margin: 5px;">Detect Magic</button>`;
            } else if (gameState.playerClass === 'warrior') {
                abilityText += "<strong>Warrior Abilities:</strong><br>";
                abilityText += "You can use combat techniques.<br>";
                abilityText += `<button onclick="warriorAbility('intimidate')" class="action-btn" style="margin: 5px;">Intimidate Foe</button> `;
                abilityText += `<button onclick="warriorAbility('power_attack')" class="action-btn" style="margin: 5px;">Power Attack</button> `;
                abilityText += `<button onclick="warriorAbility('second_wind')" class="action-btn" style="margin: 5px;">Second Wind</button>`;
            } else if (gameState.playerClass === 'necromancer') {
                abilityText += "<strong>Necromancer Abilities:</strong><br>";
                abilityText += "You can use dark powers to control or communicate with undead.<br>";
                abilityText += `<button onclick="necromancerAbility('command_undead')" class="action-btn" style="margin: 5px;">Command Undead</button> `;
                abilityText += `<button onclick="necromancerAbility('sense_death')" class="action-btn" style="margin: 5px;">Sense Death</button> `;
                abilityText += `<button onclick="necromancerAbility('dark_healing')" class="action-btn" style="margin: 5px;">Dark Healing</button>`;
            }
            
            abilityText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Ability use cancelled.</div>'" class="action-btn">Cancel</button>`;
            abilityText += "</div>";
            
            document.getElementById('story-text').innerHTML += abilityText;
        }
        
        // Wizard spells
        function castSpell(spell) {
            playSound('magic');
            let message = "";
            const magicCheck = rollDice(2, 6);
            
            if (magicCheck <= gameState.magic) {
                // Success
                playSound('success');
                if (spell === 'light') {
                    message = `You successfully cast Light! The area around you brightens. Some creatures may avoid the light.`;
                } else if (spell === 'shield') {
                    message = `You successfully cast Shield! A magical barrier surrounds you, providing temporary protection.`;
                    // In a full game, this would add temporary HP
                } else if (spell === 'detect_magic') {
                    message = `You successfully cast Detect Magic! You sense magical auras in the area.`;
                }
            } else {
                // Failure
                playSound('failure');
                message = `You fail to cast the spell properly. The magic fizzles.`;
                // Minor backlash
                gameState.health -= 1;
                updateStatsDisplay();
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Warrior abilities
        function warriorAbility(ability) {
            playSound('combat');
            let message = "";
            
            if (ability === 'intimidate') {
                const strengthCheck = rollDice(2, 6);
                if (strengthCheck <= gameState.strength) {
                    playSound('success');
                    message = `You roar and intimidate your foes! They may think twice before attacking.`;
                } else {
                    playSound('failure');
                    message = `Your attempt to intimidate fails. The foes are unimpressed.`;
                }
            } else if (ability === 'power_attack') {
                message = `You prepare for a powerful attack. Your next combat strike will be stronger.`;
                // In a full game, this would set a flag for next attack
            } else if (ability === 'second_wind') {
                const healAmount = rollDice(1, 6) + Math.floor(gameState.strength / 2);
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                playSound('success');
                message = `You catch your second wind and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Necromancer abilities
        function necromancerAbility(ability) {
            playSound('cursed');
            let message = "";
            
            if (ability === 'command_undead') {
                if (gameState.darkPower >= 2) {
                    gameState.darkPower -= 2;
                    playSound('success');
                    message = `You exert your will over undead creatures! Lesser undead may obey your commands.`;
                } else {
                    playSound('failure');
                    message = `You don't have enough Dark Power to command undead.`;
                }
            } else if (ability === 'sense_death') {
                message = `You attune yourself to the presence of death. You can sense undead and areas of great suffering.`;
                playSound('success');
            } else if (ability === 'dark_healing') {
                if (gameState.darkPower >= 1) {
                    const healAmount = rollDice(1, 8) + gameState.darkPower;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    gameState.darkPower -= 1;
                    playSound('success');
                    message = `You drain life energy from your surroundings and restore ${actualHeal} Health!`;
                    updateStatsDisplay();
                } else {
                    playSound('failure');
                    message = `You don't have enough Dark Power for dark healing.`;
                }
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 28 || sectionId === 51 || sectionId === 35 || 
                                  sectionId === 58 || sectionId === 84 || sectionId === 90);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    const goldReward = Math.floor(Math.random() * 30) + 10;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find <span class="gold">${goldReward} Gold</span> on the remains.`;
                    
                    // Class-specific combat rewards
                    if (gameState.playerClass === 'necromancer' && combatState.enemyType === 'undead') {
                        gameState.darkPower += 2;
                        storyText += `<br><span class="necromancer">You absorb dark energy from the undead! Dark Power +2</span>`;
                    }
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    // Check for item requirements
                    if (choice.requirement) {
                        if (choice.requirement === 'magic') {
                            return gameState.magic >= choice.minValue;
                        }
                        return gameState.inventory.includes(choice.requirement) || 
                               gameState.equippedWeapon === choice.requirement ||
                               gameState.equippedArmor === choice.requirement;
                    }
                    return true;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue through the village";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add appropriate stat to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                if (gameState.equippedWeapon === 'Fists') damage = rollDice(1, 4) + Math.floor(gameState.strength / 3);
                else if (gameState.equippedWeapon === 'Broken Sword') damage = rollDice(1, 8) + Math.floor(gameState.strength / 2);
                else if (gameState.equippedWeapon === 'Staff') damage = rollDice(1, 6) + Math.floor(gameState.strength / 3);
                else if (gameState.equippedWeapon === 'Ritual Dagger') damage = rollDice(1, 4) + Math.floor(gameState.strength / 3);
                else damage = rollDice(1, 6) + Math.floor(gameState.strength / 3); // Default
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                const enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('islandLostSoulsGameState');
                        location.reload();
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }

        // New Game function
function newGame() {
    playSound('click');
    
    if (confirm("Are you sure you want to start a new game? All current progress will be lost!")) {
        // Clear the saved game from localStorage
        localStorage.removeItem('islandLostSoulsGameState');
        
        // Reset game state to initial values
        const resetGameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            magic: 0,
            darkPower: 0,
            gold: 15,
            inventory: [],
            equippedWeapon: 'Fists',
            equippedArmor: 'Tattered Clothes',
            currentSection: 1,
            gameComplete: false,
            level: 1,
            shipwreckItem: null,
            villageCleared: false
        };
        
        // Clear combat state
        combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            enemyType: ''
        };
        
        // Reset any global check result
        if (window.checkResult !== undefined) {
            window.checkResult = null;
        }
        
        // Show creation screen
        showScreen('screen-creation');
        
        // Update the sound status display
        document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
        
        // Add confirmation message
        if (document.getElementById('story-text')) {
            document.getElementById('story-text').innerHTML = 
                `<div class="dice-roll"><span class="success">New game started! Return to the beginning.</span></div>`;
        }
        
        playSound('success');
    }
}
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('islandLostSoulsGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('islandLostSoulsGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 1 (this page)
                if (savedState.level === 1) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 1.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 2 with updated level
            gameState.level = 2;
            localStorage.setItem('islandLostSoulsGameState', JSON.stringify(gameState));
            // Redirect to level 2
            window.location.href = 'lvl2.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
