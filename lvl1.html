<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LAND OF THE DAMMED - Level 1: The Moors of Dredd</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro terminal style - Green/Black/White theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #0f0;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(0, 20, 0, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 20, 0, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #0f0;
            background-color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 30, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #0f0;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #0f0;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #111;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.current {
            background-color: #0f0;
            color: #000;
            border-color: #0f0;
            box-shadow: 0 0 8px #0f0;
            text-shadow: 0 0 2px #000;
        }
        
        .level-number.completed {
            background-color: #050;
            color: #0f0;
            border-color: #0f0;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #0f0;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #0f0;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #111;
            border: 1px solid #0f0;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #222;
            border-color: #0f0;
            transform: translateY(-2px);
            box-shadow: 0 0 5px #0f0;
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #0f0;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #0f0;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #0f0;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #111;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #222;
            color: #0f0;
            border-color: #0f0;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #0f0;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #0f0;
            text-shadow: 0 0 3px #0f0;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #111;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #222;
            color: #0f0;
            border-color: #0f0;
            box-shadow: 0 0 8px #0f0;
        }
        
        /* Reset Button */
        .reset-btn {
            background-color: #300;
            color: #f00;
            border: 2px solid #f00;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            margin-top: 10px;
        }
        
        .reset-btn:hover, .reset-btn:active {
            background-color: #500;
            color: #f00;
            border-color: #f00;
            box-shadow: 0 0 8px #f00;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #111;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #0f0;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #111;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
            color: #0f0;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f00;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f00;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #0f0;
            font-weight: bold;
        }
        
        .damage {
            color: #f00;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9900;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #0ff;
            font-weight: bold;
        }
        
        .ghost {
            color: #a0a0ff;
            font-weight: bold;
            text-shadow: 0 0 3px #00f;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #111;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #050;
            color: #0f0;
            border-color: #0f0;
            box-shadow: 0 0 15px #0f0;
        }
        
        /* Merchant Item Display */
        .merchant-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .merchant-item {
            background-color: #111;
            border: 1px solid #0f0;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: #0f0;
        }
        
        .merchant-item:hover {
            background-color: #222;
            border-color: #0f0;
            box-shadow: 0 0 5px #0f0;
        }
        
        .merchant-item h3 {
            color: #0f0;
            margin: 0 0 5px 0;
            font-size: 16px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .merchant-item p {
            color: #0f0;
            font-size: 14px;
            margin: 0;
        }
        
        .merchant-cost {
            color: #ff0;
            font-weight: bold;
            margin-top: 5px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #080;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #050;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #0f0;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #0f0;
            color: #0f0;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #0f0;
        }
        
        /* Character Creation Stats */
        .char-stats {
            background-color: #111;
            border: 1px solid #0f0;
            padding: 15px;
            margin: 15px 0;
        }
        
        .stat-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            color: #0f0;
        }
        
        .stat-name {
            color: #0f0;
            font-weight: bold;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .merchant-items {
                grid-template-columns: 1fr;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <!-- Reset Button -->
        <button class="reset-btn" onclick="resetGame()" style="position: absolute; top: 10px; left: 10px; z-index: 10;">
            RESET GAME
        </button>
        
        <div class="header">
            <h1>LAND OF THE DAMMED</h1>
            <h2>LEVEL 1: THE MOORS OF DREDD</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number current">1</div>
            <div class="level-number">2</div>
            <div class="level-number">3</div>
            <div class="level-number">4</div>
            <div class="level-number">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Character Creation Screen -->
        <div id="screen-creation" class="screen active-screen">
            <h2>THE MOORS AWAIT</h2>
            <div class="story-text">
                <p>The Moors of Dredd are a cursed, fog-shrouded landscape where the dead walk and the living fear to tread.</p>
                <p>For centuries, a dark curse has afflicted this land. Spirits of the unjustly dead rise from the mist, seeking to drag the living into their eternal torment.</p>
                <p>You stand at the edge of the moors, in the last outpost of civilization: the village of Duskhaven. The villagers huddle behind their walls as night approaches.</p>
                <p>Old Man Harker, the village elder, approaches you with a lantern. "You're either brave or foolish to venture into the moors. The Deadwood Mountains beyond are said to hold the source of the curse."</p>
                <p>He hands you a small pouch. "Take these 40 silver pieces. Visit the old hermit at the edge of town - he sells things that might help against... what's out there."</p>
                <p>What kind of soul ventures into the damned lands?</p>
                
                <div class="char-stats">
                    <div class="stat-line">
                        <span class="stat-name">WARRIOR</span>
                        <span>+4 Strength, +30 Health, +1 Agility</span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-name">EXPLORER</span>
                        <span>+2 Strength, +25 Health, +4 Agility</span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-name">MYSTIC</span>
                        <span>+1 Strength, +20 Health, +3 Agility, +2 Spirit</span>
                    </div>
                </div>
                
                <p>You will roll 2d6 for each base attribute, then add your class bonus.</p>
                <p>Spirit helps with ghostly encounters and mystical items.</p>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="selectClass('warrior')">BECOME A WARRIOR</button>
                <button class="choice-btn" onclick="selectClass('explorer')">BECOME AN EXPLORER</button>
                <button class="choice-btn" onclick="selectClass('mystic')">BECOME A MYSTIC</button>
            </div>
        </div>
        
        <!-- Dice Roll Screen -->
        <div id="screen-dice" class="screen">
            <h2>CHARACTER ATTRIBUTES</h2>
            <div class="story-text">
                <p>You have chosen the path of a <span id="selected-class" class="enemy"></span>.</p>
                <p>Now roll the dice for your attributes:</p>
                <p><strong>Strength:</strong> 2 dice + class bonus (determines combat ability)</p>
                <p><strong>Health:</strong> 2 dice + class bonus (your vitality)</p>
                <p><strong>Agility:</strong> 2 dice + class bonus (helps in dangerous situations)</p>
                <p><strong>Spirit:</strong> 2 dice + class bonus (mystics only - helps with ghosts)</p>
                <div id="dice-results"></div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="rollCharacterStats()">ROLL DICE</button>
                <button class="action-btn" onclick="proceedToHermit()" id="proceed-btn" disabled>CONTINUE TO HERMIT</button>
            </div>
        </div>
        
        <!-- Hermit (Merchant) Screen -->
        <div id="screen-hermit" class="screen">
            <h2>THE HERMIT'S HUT</h2>
            <div class="story-text">
                <p>You find the hermit's hut at the edge of the village, surrounded by strange charms and wards. The old man eyes you suspiciously before letting you in.</p>
                <p>"So you're the fool heading into the moors," he mutters. "I've items that might keep you alive a bit longer. But they don't come cheap."</p>
                <p>You have <span class="gold" id="hermit-silver">40</span> silver pieces.</p>
                
                <div class="merchant-items">
                    <div class="merchant-item" onclick="selectHermitItem('ghost_salt')">
                        <h3>GHOST SALT</h3>
                        <p>Blessed salt from the northern mines. Disrupts spectral forms.</p>
                        <div class="merchant-cost">Cost: 15 Silver</div>
                    </div>
                    <div class="merchant-item" onclick="selectHermitItem('iron_charm')">
                        <h3>IRON WARD CHARM</h3>
                        <p>Cold iron inscribed with protective runes. Spirits fear iron.</p>
                        <div class="merchant-cost">Cost: 25 Silver</div>
                    </div>
                    <div class="merchant-item" onclick="selectHermitItem('moors_map')">
                        <h3>MOORS MAP</h3>
                        <p>Crude map showing safe paths through the boggy terrain.</p>
                        <div class="merchant-cost">Cost: 10 Silver</div>
                    </div>
                    <div class="merchant-item" onclick="selectHermitItem('healing_herb')">
                        <h3>HEALING HERBS</h3>
                        <p>Rare herbs that restore 2d8+8 health when used.</p>
                        <div class="merchant-cost">Cost: 12 Silver</div>
                    </div>
                    <div class="merchant-item" onclick="selectHermitItem('silvered_knife')">
                        <h3>SILVERED KNIFE</h3>
                        <p>Blade coated in silver. Effective against certain spirits.</p>
                        <div class="merchant-cost">Cost: 30 Silver</div>
                    </div>
                    <div class="merchant-item" onclick="selectHermitItem('warded_lantern')">
                        <h3>WARDED LANTERN</h3>
                        <p>Lantern with protective wards. Light keeps weaker spirits at bay.</p>
                        <div class="merchant-cost">Cost: 20 Silver</div>
                    </div>
                </div>
                
                <div id="selected-item-display" style="display: none; margin-top: 15px; padding: 10px; background-color: #111; border: 1px solid #0f0;">
                    <p>Selected: <span id="selected-item-name" class="item"></span></p>
                    <p id="selected-item-desc"></p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="confirmHermitItem()" id="confirm-item-btn" disabled>CONFIRM SELECTION</button>
                <button class="action-btn" onclick="skipHermit()">TAKE NOTHING (KEEP SILVER)</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">SPIRIT:</span> <span id="stat-spirit" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">SILVER:</span> <span id="stat-silver" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>THE MOORS OF DREDD</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL 1 COMPLETE!</h2>
            <div class="story-text">
                <p>You have survived the Moors of Dredd!</p>
                <p>As you emerge from the treacherous bog, the Deadwood Mountains rise before you - jagged peaks shrouded in perpetual gloom. The source of the curse is said to lie somewhere within those foreboding slopes.</p>
                <p>The moors behind you whisper with ghostly voices, but you cannot turn back. The fate of Duskhaven rests with you.</p>
                <p>All your stats, silver, and inventory will carry over to Level 2.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">SPIRIT:</span> <span id="next-stat-spirit" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">SILVER:</span> <span id="next-stat-silver" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #111; border: 1px solid #0f0;">
                    <h3 style="color: #0f0; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO LEVEL 2: DEADWOOD MOUNTAINS</button>
            </div>
        </div>
        
        <div class="footer">
            LAND OF THE DAMMED - A Retro Ghost-Hunting Adventure<br>
            Level 1: The Moors of Dredd
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'ghost':
                    playBeep(150, 0.3, 'sine');
                    setTimeout(() => playBeep(100, 0.3, 'sine'), 300);
                    break;
                case 'moors':
                    playBeep(300, 0.2, 'sine');
                    setTimeout(() => playBeep(250, 0.2, 'sine'), 200);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Reset game function
        function resetGame() {
            playSound('click');
            if (confirm("Are you sure you want to reset the game? All progress will be lost.")) {
                localStorage.removeItem('landOfTheDammedGameState');
                location.reload();
            }
        }
        
        // Game state object - will be saved to localStorage
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            spirit: 0,
            silver: 40, // Starting silver
            inventory: [],
            equippedWeapon: 'Rusty Sword',
            equippedArmor: 'Leather Armor',
            currentSection: 1,
            gameComplete: false,
            level: 1,
            hermitItem: null,
            moorsCleared: false
        };
        
        // Hermit items data
        const hermitItems = {
            ghost_salt: {
                name: 'Ghost Salt',
                description: 'Blessed salt that disrupts spectral forms',
                cost: 15,
                effect: 'Deals damage to ghosts and spirits'
            },
            iron_charm: {
                name: 'Iron Ward Charm',
                description: 'Cold iron inscribed with protective runes',
                cost: 25,
                effect: 'Spirits are less likely to attack you'
            },
            moors_map: {
                name: 'Moors Map',
                description: 'Map showing safer paths through the moors',
                cost: 10,
                effect: 'Helps avoid dangerous areas in the moors'
            },
            healing_herb: {
                name: 'Healing Herbs',
                description: 'Rare herbs that restore health',
                cost: 12,
                effect: 'Restores 2d8+8 health when used'
            },
            silvered_knife: {
                name: 'Silvered Knife',
                description: 'Blade coated in silver, effective against spirits',
                cost: 30,
                effect: '+3 damage vs spirits, can be equipped'
            },
            warded_lantern: {
                name: 'Warded Lantern',
                description: 'Lantern with protective wards',
                cost: 20,
                effect: 'Light keeps weaker spirits at bay'
            }
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            isSpirit: false
        };
        
        // Game story sections for Level 1
        const storySections = {
            1: {
                text: "You step beyond the village wards and into the Moors of Dredd. Thick fog rolls across the boggy ground, obscuring vision beyond a few feet. Strange lights flicker in the distance. The ground squelches beneath your boots as you follow what might be a path.",
                choices: [
                    {text: "Follow the flickering lights (might be will-o-wisps)", nextSection: 2, skillCheck: false},
                    {text: "Stick to what seems like solid ground", nextSection: 3, skillCheck: false},
                    {text: "Use the Moors Map if you have one", nextSection: 4, skillCheck: false, requirement: 'Moors Map'}
                ]
            },
            2: {
                text: "You follow the flickering lights through the fog. They dance just ahead of you, leading you deeper into the moors. Suddenly, the ground gives way beneath you!",
                choices: [
                    {text: "Grab for something to hold onto", nextSection: 5, skillCheck: true, checkType: 'agility', difficulty: 12},
                    {text: "Try to swim through the bog", nextSection: 6, skillCheck: false}
                ]
            },
            3: {
                text: "You carefully pick your way across what seems like solid ground. The fog is so thick you can barely see your own feet. From the mist ahead, you hear a faint weeping sound.",
                choices: [
                    {text: "Investigate the weeping", nextSection: 7, skillCheck: false},
                    {text: "Avoid the sound and change direction", nextSection: 8, skillCheck: true, checkType: 'agility', difficulty: 10},
                    {text: "Prepare your weapon", nextSection: 9, skillCheck: false}
                ]
            },
            4: {
                text: "You consult the Moors Map. It shows a relatively safe path marked with ancient standing stones. Following the map, you navigate around several dangerous bog areas.",
                choices: [
                    {text: "Continue following the map", nextSection: 10, skillCheck: false},
                    {text: "Leave the path to investigate something", nextSection: 11, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The <span class='item'>Moors Map</span> guides you safely through treacherous ground.";
                }
            },
            5: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You grab a root just in time! You pull yourself out of the bog, covered in muck but alive.";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You sink into the bog before managing to scramble out. You take " + damage + " damage from the struggle and are now soaked and cold.";
                    }
                }
            },
            6: {
                text: "The bog water is icy cold and thick with mud. Something brushes against your leg beneath the surface!",
                choices: [
                    {text: "Swim faster", nextSection: 13, skillCheck: true, checkType: 'strength', difficulty: 10},
                    {text: "Fight whatever is in the water", nextSection: 14, skillCheck: false}
                ]
            },
            7: {
                text: "You push through the fog toward the weeping sound. A spectral figure in tattered clothes floats just above the ground, crying softly. It's a WEEPING SPIRIT!",
                choices: [
                    {text: "Attempt to communicate", nextSection: 15, skillCheck: true, checkType: 'spirit', difficulty: 12},
                    {text: "Attack the spirit", nextSection: 16, skillCheck: false},
                    {text: "Use Ghost Salt if you have it", nextSection: 17, skillCheck: false, requirement: 'Ghost Salt'},
                    {text: "Show the Iron Ward Charm if you have it", nextSection: 18, skillCheck: false, requirement: 'Iron Ward Charm'}
                ]
            },
            8: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue through the moors", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip quietly away from the weeping sound without being noticed.";
                    } else {
                        playSound('failure');
                        return "You trip over a root! The weeping stops abruptly, replaced by an angry wail!";
                    }
                }
            },
            9: {
                text: "You draw your weapon as the weeping grows louder. The fog parts to reveal a translucent figure with hollow eyes.",
                choices: [
                    {text: "Fight the weeping spirit", nextSection: 16, skillCheck: false}
                ]
            },
            10: {
                text: "Following the map, you reach one of the standing stones marked on it. The stone is covered in ancient runes that glow faintly in the fog.",
                choices: [
                    {text: "Examine the runes", nextSection: 20, skillCheck: false},
                    {text: "Continue along the path", nextSection: 21, skillCheck: false}
                ]
            },
            11: {
                text: "You leave the safe path to investigate a dim light in the fog. It's an ancient tombstone, partially sunken into the bog.",
                choices: [
                    {text: "Examine the tombstone", nextSection: 22, skillCheck: false},
                    {text: "Return to the path", nextSection: 10, skillCheck: false}
                ]
            },
            12: {
                text: "Back on solid ground, you realize the flickering lights have disappeared. You're lost in the thick fog.",
                choices: [
                    {text: "Try to find your bearings", nextSection: 23, skillCheck: true, checkType: 'agility', difficulty: 8},
                    {text: "Wait for the fog to clear", nextSection: 24, skillCheck: false}
                ]
            },
            13: {
                text: "", // Filled by action
                choices: [
                    {text: "Climb out of the bog", nextSection: 25, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You swim powerfully through the bog and reach solid ground, leaving whatever was in the water behind.";
                    } else {
                        const damage = rollDice(2, 4);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "Something bites your leg! You scramble out of the water, taking " + damage + " damage.";
                    }
                }
            },
            14: {
                text: "You thrash in the water, trying to fight whatever is beneath the surface. A skeletal hand reaches up from the bog!",
                choices: [
                    {text: "Fight the bog skeleton", nextSection: 26, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Bog Skeleton";
                    combatState.enemyHealth = 20;
                    combatState.enemyCurrentHealth = 20;
                    combatState.enemyStrength = 7;
                    combatState.enemyDamageDice = 1;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 27;
                    combatState.round = 1;
                    combatState.isSpirit = false;
                    
                    playSound('combat');
                    return "<span class='enemy'>Bog Skeleton</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            15: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        const silverFound = rollDice(2, 8);
                        gameState.silver += silverFound;
                        updateStatsDisplay();
                        return "The spirit calms at your gentle words. It was a traveler lost in the moors long ago. Grateful, it points you toward safe passage before fading away. You find <span class='gold'>" + silverFound + " Silver</span> where it vanished.";
                    } else {
                        playSound('failure');
                        return "Your attempts to communicate only anger the spirit! It lets out a piercing wail and attacks!";
                    }
                }
            },
            16: {
                text: "The weeping spirit's form solidifies, its hollow eyes fixing on you with malice. Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 29, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Weeping Spirit";
                    combatState.enemyHealth = 30;
                    combatState.enemyCurrentHealth = 30;
                    combatState.enemyStrength = 9;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 4;
                    combatState.nextSection = 30;
                    combatState.round = 1;
                    combatState.isSpirit = true;
                    
                    playSound('ghost');
                    return "<span class='ghost'>Weeping Spirit</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            17: {
                text: "You throw Ghost Salt at the spirit. It shrieks as the blessed substance burns its spectral form!",
                choices: [
                    {text: "Finish it off while it's wounded", nextSection: 31, skillCheck: false},
                    {text: "Escape while it's distracted", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    // Ghost salt does initial damage
                    const saltDamage = rollDice(2, 6) + 5;
                    combatState.enemyCurrentHealth -= saltDamage;
                    removeFromInventory('Ghost Salt');
                    playSound('item');
                    return "You use your <span class='item'>Ghost Salt</span>! The spirit takes " + saltDamage + " damage!";
                }
            },
            18: {
                text: "You hold up the Iron Ward Charm. The spirit recoils from the cold iron, hissing in pain and fear!",
                choices: [
                    {text: "Advance with the charm", nextSection: 32, skillCheck: false},
                    {text: "Retreat while it's distracted", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The <span class='item'>Iron Ward Charm</span> forces the spirit back! It cannot approach you while you hold the charm.";
                }
            },
            19: {
                text: "You continue through the moors. The fog seems to be thinning slightly. In the distance, you can make out the silhouette of the Deadwood Mountains.",
                choices: [
                    {text: "Head toward the mountains", nextSection: 33, skillCheck: false},
                    {text: "Search for a safer path", nextSection: 34, skillCheck: true, checkType: 'agility', difficulty: 11}
                ]
            },
            20: {
                text: "The runes on the standing stone glow brighter as you approach. They seem to be protective wards against spirits. Touching the stone fills you with warmth and strength.",
                choices: [
                    {text: "Absorb the stone's energy", nextSection: 35, skillCheck: false},
                    {text: "Continue on your way", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 8) + 4;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    playSound('item');
                    return "The standing stone's energy flows into you, restoring " + actualHeal + " Health!";
                }
            },
            21: {
                text: "You continue along the path marked on the map. The fog continues to thin. You can see the edge of the moors ahead!",
                choices: [
                    {text: "Hurry toward the edge", nextSection: 36, skillCheck: false},
                    {text: "Stay cautious", nextSection: 37, skillCheck: false}
                ]
            },
            22: {
                text: "The tombstone is ancient, the inscription nearly worn away. You can barely make out the words: 'Here lies Alistair, taken by the bog.' As you examine it, a cold hand grabs your ankle!",
                choices: [
                    {text: "Fight the bog wraith", nextSection: 38, skillCheck: false},
                    {text: "Try to break free", nextSection: 39, skillCheck: true, checkType: 'strength', difficulty: 13}
                ]
            },
            23: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 40, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You spot a familiar landmark - a twisted dead tree you passed earlier. You regain your bearings and continue in the right direction.";
                    } else {
                        playSound('failure');
                        return "You're completely turned around. The fog seems to be getting thicker. Strange whispers echo around you.";
                    }
                }
            },
            24: {
                text: "You wait for what feels like hours, but the fog doesn't clear. Instead, it grows colder. Shapes move in the mist around you.",
                choices: [
                    {text: "Move anyway, despite the fog", nextSection: 41, skillCheck: false},
                    {text: "Light the Warded Lantern if you have one", nextSection: 42, skillCheck: false, requirement: 'Warded Lantern'}
                ]
            },
            25: {
                text: "You pull yourself out of the bog, soaked and shivering. The experience has drained your strength.",
                choices: [
                    {text: "Rest to recover", nextSection: 43, skillCheck: false},
                    {text: "Keep moving to stay warm", nextSection: 44, skillCheck: false}
                ],
                action: function() {
                    const fatigueDamage = 3;
                    gameState.health -= fatigueDamage;
                    updateStatsDisplay();
                    playSound('damage');
                    return "The icy bog water saps your strength. You take " + fatigueDamage + " damage from cold and fatigue.";
                }
            },
            26: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 45, skillCheck: false}
                ]
            },
            27: {
                text: "", // After combat
                choices: [
                    {text: "Search the bog", nextSection: 46, skillCheck: false},
                    {text: "Get out of the water as fast as possible", nextSection: 25, skillCheck: false}
                ]
            },
            28: {
                text: "With the spirit gone, you find yourself on a relatively dry path through the moors.",
                choices: [
                    {text: "Follow the path", nextSection: 19, skillCheck: false}
                ]
            },
            29: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 47, skillCheck: false}
                ]
            },
            30: {
                text: "", // After combat
                choices: [
                    {text: "Search where the spirit vanished", nextSection: 48, skillCheck: false},
                    {text: "Continue through the moors", nextSection: 19, skillCheck: false}
                ]
            },
            31: {
                text: "The spirit is badly wounded from the Ghost Salt. It flickers weakly, its form unstable.",
                choices: [
                    {text: "Finish it with your weapon", nextSection: 49, skillCheck: false}
                ]
            },
            32: {
                text: "Advancing with the Iron Ward Charm, you force the spirit back until it's pressed against a standing stone. Trapped, it lets out one final wail before dissipating.",
                choices: [
                    {text: "Search the area", nextSection: 50, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    const silverFound = rollDice(3, 6);
                    gameState.silver += silverFound;
                    updateStatsDisplay();
                    return "The spirit is destroyed! Searching the area, you find <span class='gold'>" + silverFound + " Silver</span> that it had collected from previous victims.";
                }
            },
            33: {
                text: "You make good progress toward the mountains. The ground becomes firmer underfoot. You're nearly through the moors!",
                choices: [
                    {text: "Press on toward the mountain pass", nextSection: 100, skillCheck: false}
                ]
            },
            34: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 51, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You find a hidden animal trail that provides solid footing and avoids the worst of the bog.";
                    } else {
                        playSound('failure');
                        return "You stumble into another boggy area. The ground threatens to give way beneath you!";
                    }
                }
            },
            35: {
                text: "Feeling refreshed from the standing stone's energy, you continue your journey with renewed vigor.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 33, skillCheck: false}
                ]
            },
            36: {
                text: "You hurry toward the edge of the moors. Just as you're about to reach solid ground, a final obstacle appears - a BRIDGE OF BONES spanning a deep chasm!",
                choices: [
                    {text: "Cross the Bridge of Bones", nextSection: 52, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Find another way around", nextSection: 53, skillCheck: false}
                ]
            },
            37: {
                text: "You proceed cautiously toward the edge of the moors. The Bridge of Bones appears before you, but you have time to examine it first.",
                choices: [
                    {text: "Examine the bridge carefully", nextSection: 54, skillCheck: false},
                    {text: "Cross slowly and carefully", nextSection: 55, skillCheck: true, checkType: 'agility', difficulty: 10}
                ]
            },
            38: {
                text: "A skeletal figure rises from the bog, its bones stained dark by peat. It's a BOG WRAITH!",
                choices: [
                    {text: "Fight the bog wraith", nextSection: 56, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Bog Wraith";
                    combatState.enemyHealth = 35;
                    combatState.enemyCurrentHealth = 35;
                    combatState.enemyStrength = 11;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 57;
                    combatState.round = 1;
                    combatState.isSpirit = true;
                    
                    playSound('ghost');
                    return "<span class='ghost'>Bog Wraith</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            39: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You wrench your ankle free and stumble back from the tombstone!";
                    } else {
                        playSound('failure');
                        const damage = rollDice(1, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "The skeletal hand tightens its grip, bony fingers digging into your flesh! You take " + damage + " damage!";
                    }
                }
            },
            40: {
                text: "Whether you found your bearings or not, you press onward through the moors.",
                choices: [
                    {text: "Continue the trek", nextSection: 19, skillCheck: false}
                ]
            },
            41: {
                text: "You push forward through the thick fog. The temperature drops suddenly, and you hear whispers all around you.",
                choices: [
                    {text: "Run!", nextSection: 59, skillCheck: true, checkType: 'agility', difficulty: 13},
                    {text: "Stand your ground", nextSection: 60, skillCheck: false}
                ]
            },
            42: {
                text: "You light the Warded Lantern. Its protective glow pushes back the fog and the whispering shapes retreat from the light.",
                choices: [
                    {text: "Continue with the lantern lighting your way", nextSection: 61, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The <span class='item'>Warded Lantern</span> protects you from the spirits in the fog. They cannot approach the lantern's blessed light.";
                }
            },
            43: {
                text: "You find a relatively dry spot to rest. As you catch your breath, you notice something glinting in the bog nearby.",
                choices: [
                    {text: "Investigate the glint", nextSection: 62, skillCheck: false},
                    {text: "Rest longer to recover health", nextSection: 63, skillCheck: false}
                ]
            },
            44: {
                text: "You keep moving to generate warmth. The exercise helps, but you're still dangerously cold.",
                choices: [
                    {text: "Find shelter", nextSection: 64, skillCheck: false},
                    {text: "Keep moving toward the mountains", nextSection: 65, skillCheck: false}
                ]
            },
            45: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 26, skillCheck: false}
                ]
            },
            46: {
                text: "Searching the bog where the skeleton emerged, you find a waterlogged pouch tied to its ribs.",
                choices: [
                    {text: "Take the pouch", nextSection: 25, skillCheck: false}
                ],
                action: function() {
                    const silverFound = rollDice(2, 10);
                    gameState.silver += silverFound;
                    addToInventory('Ancient Coin');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + silverFound + " Silver</span> and an <span class='item'>Ancient Coin</span> in the skeleton's pouch.";
                }
            },
            47: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 29, skillCheck: false}
                ]
            },
            48: {
                text: "Where the spirit vanished, you find a few personal effects that have survived the years.",
                choices: [
                    {text: "Take the items", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    const silverFound = rollDice(1, 12);
                    gameState.silver += silverFound;
                    addToInventory('Tarnished Locket');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + silverFound + " Silver</span> and a <span class='item'>Tarnished Locket</span> with a faded portrait inside.";
                }
            },
            49: {
                text: "You strike the weakened spirit, finishing it off. It dissipates with a final, sorrowful sigh.",
                choices: [
                    {text: "Search where it vanished", nextSection: 48, skillCheck: false},
                    {text: "Continue through the moors", nextSection: 19, skillCheck: false}
                ]
            },
            50: {
                text: "With the spirit gone, you can continue safely. The standing stone seems to mark the beginning of a safer path.",
                choices: [
                    {text: "Follow the path", nextSection: 21, skillCheck: false}
                ]
            },
            51: {
                text: "The trail leads you through increasingly firm ground. The fog is definitely thinning now.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 33, skillCheck: false}
                ]
            },
            52: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 66, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You navigate the treacherous bridge with amazing agility, reaching the other side safely!";
                    } else {
                        const damage = rollDice(2, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "A bone gives way beneath your foot! You fall partway through the bridge, taking " + damage + " damage before pulling yourself up and across.";
                    }
                }
            },
            53: {
                text: "You search for another way around the chasm. It takes time, but you find a narrow path that winds down one side and up the other.",
                choices: [
                    {text: "Take the long way around", nextSection: 67, skillCheck: false}
                ],
                action: function() {
                    // Time cost - encounter something
                    const encounter = Math.random();
                    if (encounter > 0.7) {
                        return "Taking the long way around, you encounter a lost traveler's spirit. It points you toward safety before fading away.";
                    } else if (encounter > 0.4) {
                        const silverFound = rollDice(1, 10);
                        gameState.silver += silverFound;
                        updateStatsDisplay();
                        return "On the path, you find <span class='gold'>" + silverFound + " Silver</span> dropped by some previous traveler.";
                    } else {
                        return "The path is long but safe. You reach the other side of the chasm without incident.";
                    }
                }
            },
            54: {
                text: "Examining the Bridge of Bones, you notice that some bones are more secure than others. You carefully plot a safe route across.",
                choices: [
                    {text: "Cross using your planned route", nextSection: 68, skillCheck: true, checkType: 'agility', difficulty: 8}
                ]
            },
            55: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You cross the Bridge of Bones slowly and carefully, testing each step. You make it safely to the other side.";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "Even with caution, a bone slips beneath your weight. You tumble but manage to catch yourself, taking " + damage + " damage.";
                    }
                }
            },
            56: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 70, skillCheck: false}
                ]
            },
            57: {
                text: "", // After combat
                choices: [
                    {text: "Search the wraith's remains", nextSection: 71, skillCheck: false},
                    {text: "Get away from the tombstone", nextSection: 10, skillCheck: false}
                ]
            },
            58: {
                text: "Free from the skeletal hand, you back away from the tombstone. The ground around it begins to tremble!",
                choices: [
                    {text: "Run!", nextSection: 72, skillCheck: true, checkType: 'agility', difficulty: 12},
                    {text: "Stand and fight whatever emerges", nextSection: 73, skillCheck: false}
                ]
            },
            59: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 74, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You sprint through the fog, leaving the whispering shapes behind!";
                    } else {
                        const damage = rollDice(2, 4);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You trip in the fog and fall! Cold hands grasp at you before you scramble up and continue running. You take " + damage + " damage.";
                    }
                }
            },
            60: {
                text: "You stand your ground as the whispering shapes approach. They're faint spectral forms, curious but not immediately hostile.",
                choices: [
                    {text: "Try to communicate", nextSection: 75, skillCheck: true, checkType: 'spirit', difficulty: 14},
                    {text: "Swing your weapon to drive them off", nextSection: 76, skillCheck: false}
                ]
            },
            61: {
                text: "With the Warded Lantern lighting your way, you make good progress. The spirits keep their distance from the protective light.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 33, skillCheck: false}
                ]
            },
            62: {
                text: "You wade into the bog to investigate the glint. It's a silver pendant on a chain!",
                choices: [
                    {text: "Take the pendant", nextSection: 77, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Silver Pendant');
                    playSound('item');
                    return "You retrieve a <span class='item'>Silver Pendant</span>. It feels warm to the touch, as if holding some protective energy.";
                }
            },
            63: {
                text: "Resting helps you recover slightly from your ordeal in the bog.",
                choices: [
                    {text: "Continue your journey", nextSection: 44, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 4) + 2;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    return "Resting restores " + actualHeal + " Health.";
                }
            },
            64: {
                text: "You find a small, dry cave in a rocky outcropping. It's empty except for some old bones in the corner.",
                choices: [
                    {text: "Rest in the cave", nextSection: 78, skillCheck: false},
                    {text: "Search the cave", nextSection: 79, skillCheck: false}
                ]
            },
            65: {
                text: "You press on through the cold. Your determination keeps you moving despite the chill.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    // Small chance of finding something
                    if (Math.random() > 0.8) {
                        const silverFound = rollDice(1, 8);
                        gameState.silver += silverFound;
                        updateStatsDisplay();
                        return "As you walk, you spot <span class='gold'>" + silverFound + " Silver</span> glinting in a patch of moss.";
                    }
                    return "The constant movement helps ward off the worst of the cold.";
                }
            },
            66: {
                text: "You've crossed the Bridge of Bones! Before you stretches the foothills of the Deadwood Mountains. You've made it through the Moors of Dredd!",
                choices: [
                    {text: "Continue to the mountains", nextSection: 100, skillCheck: false}
                ]
            },
            67: {
                text: "After the long detour, you find yourself at the base of the Deadwood Mountains. The moors are behind you at last.",
                choices: [
                    {text: "Begin the ascent", nextSection: 100, skillCheck: false}
                ]
            },
            68: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 80, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "Your careful planning pays off! You cross the Bridge of Bones without incident.";
                    } else {
                        const damage = rollDice(1, 4);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "Even with planning, the bridge is treacherous. You slip but catch yourself, taking " + damage + " damage from the strain.";
                    }
                }
            },
            69: {
                text: "You've crossed the Bridge of Bones! The Deadwood Mountains loom ahead.",
                choices: [
                    {text: "Continue to the mountains", nextSection: 100, skillCheck: false}
                ]
            },
            70: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 56, skillCheck: false}
                ]
            },
            71: {
                text: "Searching the wraith's remains, you find little of value except for a strange, smooth stone that feels cold.",
                choices: [
                    {text: "Take the stone", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Cold Stone');
                    playSound('item');
                    return "You find a <span class='item'>Cold Stone</span>. It seems to absorb warmth from the air around it.";
                }
            },
            72: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 81, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You run just as a full skeleton emerges from the bog! You leave it behind in the fog.";
                    } else {
                        playSound('failure');
                        return "You stumble as you run! A skeletal hand grabs your leg, but you kick free and continue running.";
                    }
                }
            },
            73: {
                text: "A complete skeleton rises from the bog, ancient armor still clinging to its bones. It's a BOG KNIGHT!",
                choices: [
                    {text: "Fight the bog knight", nextSection: 82, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Bog Knight";
                    combatState.enemyHealth = 40;
                    combatState.enemyCurrentHealth = 40;
                    combatState.enemyStrength = 13;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 83;
                    combatState.round = 1;
                    combatState.isSpirit = false;
                    
                    playSound('combat');
                    return "<span class='enemy'>Bog Knight</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            74: {
                text: "You've escaped the whispering spirits. The fog seems to be thinning ahead.",
                choices: [
                    {text: "Continue toward the clearer area", nextSection: 19, skillCheck: false}
                ]
            },
            75: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue", nextSection: 84, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "The spirits seem to understand your peaceful intent. They part before you, showing you a safe path through the fog.";
                    } else {
                        playSound('failure');
                        return "The spirits don't understand or don't care. They close in around you, their whispers growing hostile!";
                    }
                }
            },
            76: {
                text: "You swing your weapon at the spectral shapes. They scatter with angry whispers, but more begin to gather.",
                choices: [
                    {text: "Fight the gathered spirits", nextSection: 85, skillCheck: false},
                    {text: "Run while they're scattered", nextSection: 59, skillCheck: true, checkType: 'agility', difficulty: 11}
                ]
            },
            77: {
                text: "With the silver pendant in your possession, you feel slightly more protected against the moors' dangers.",
                choices: [
                    {text: "Continue resting", nextSection: 63, skillCheck: false},
                    {text: "Continue your journey", nextSection: 44, skillCheck: false}
                ]
            },
            78: {
                text: "You rest in the relative safety of the cave. The warmth slowly returns to your limbs.",
                choices: [
                    {text: "Continue your journey", nextSection: 65, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 6) + 3;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    return "Resting in the cave restores " + actualHeal + " Health and helps you recover from the cold.";
                }
            },
            79: {
                text: "Searching the cave, you find a small stash hidden behind some rocks.",
                choices: [
                    {text: "Take the stash", nextSection: 78, skillCheck: false}
                ],
                action: function() {
                    const silverFound = rollDice(3, 10);
                    gameState.silver += silverFound;
                    addToInventory('Dried Meat');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + silverFound + " Silver</span> and some <span class='item'>Dried Meat</span> that's still edible.";
                }
            },
            80: {
                text: "You've successfully crossed the Bridge of Bones! The moors are behind you, and the Deadwood Mountains await.",
                choices: [
                    {text: "Continue to the mountains", nextSection: 100, skillCheck: false}
                ]
            },
            81: {
                text: "You've escaped whatever was rising from the bog. The experience has left you shaken but alive.",
                choices: [
                    {text: "Continue through the moors", nextSection: 19, skillCheck: false}
                ]
            },
            82: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 86, skillCheck: false}
                ]
            },
            83: {
                text: "", // After combat
                choices: [
                    {text: "Search the knight's remains", nextSection: 87, skillCheck: false},
                    {text: "Get away from the area", nextSection: 10, skillCheck: false}
                ]
            },
            84: {
                text: "With the spirits showing you the way, you make excellent progress through the moors.",
                choices: [
                    {text: "Follow the path they revealed", nextSection: 21, skillCheck: false}
                ]
            },
            85: {
                text: "The spirits solidify into hostile forms. You'll have to fight your way through!",
                choices: [
                    {text: "Fight the angry spirits", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Angry Spirits";
                    combatState.enemyHealth = 25;
                    combatState.enemyCurrentHealth = 25;
                    combatState.enemyStrength = 8;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 4;
                    combatState.nextSection = 89;
                    combatState.round = 1;
                    combatState.isSpirit = true;
                    
                    playSound('ghost');
                    return "<span class='ghost'>Angry Spirits</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            86: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 82, skillCheck: false}
                ]
            },
            87: {
                text: "Searching the bog knight's remains, you find its rusted sword and a few valuables.",
                choices: [
                    {text: "Take the items", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    const silverFound = rollDice(4, 8);
                    gameState.silver += silverFound;
                    addToInventory('Rusted Knight Sword');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + silverFound + " Silver</span> and a <span class='item'>Rusted Knight Sword</span>. It's not in fighting condition but might be valuable.";
                }
            },
            88: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 90, skillCheck: false}
                ]
            },
            89: {
                text: "", // After combat
                choices: [
                    {text: "Continue through the moors", nextSection: 19, skillCheck: false}
                ]
            },
            90: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 88, skillCheck: false}
                ]
            },
            100: {
                text: "CONGRATULATIONS! You have survived the Moors of Dredd. You stand at the base of the Deadwood Mountains, their jagged peaks piercing the gloomy sky. Somewhere in those mountains lies the source of the curse afflicting this land.",
                choices: [],
                action: function() {
                    gameState.moorsCleared = true;
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-spirit').textContent = gameState.spirit;
                    document.getElementById('next-stat-silver').textContent = gameState.silver;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 2;
                    saveGame();
                    
                    return "";
                }
            }
        };
        
        // Initialize game
        function initGame() {
            // Check for saved game
            const savedGame = localStorage.getItem('landOfTheDammedGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 1 (this page)
                if (savedState.level === 1) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    return;
                }
            }
            
            // Otherwise start with character creation
            showScreen('screen-creation');
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Select character class
        function selectClass(className) {
            playSound('click');
            gameState.playerClass = className;
            document.getElementById('selected-class').textContent = className.toUpperCase();
            showScreen('screen-dice');
        }
        
        // Roll dice for character stats
        function rollCharacterStats() {
            playSound('roll');
            
            // Base rolls (2d6 each)
            const strengthRoll = rollDice(2, 6);
            const healthRoll = rollDice(2, 6);
            const agilityRoll = rollDice(2, 6);
            const spiritRoll = rollDice(2, 6);
            
            // Apply class bonuses
            let strengthBonus = 0, healthBonus = 0, agilityBonus = 0, spiritBonus = 0;
            
            switch(gameState.playerClass) {
                case 'warrior':
                    strengthBonus = 4;
                    healthBonus = 30;
                    agilityBonus = 1;
                    spiritBonus = 0;
                    break;
                case 'explorer':
                    strengthBonus = 2;
                    healthBonus = 25;
                    agilityBonus = 4;
                    spiritBonus = 0;
                    break;
                case 'mystic':
                    strengthBonus = 1;
                    healthBonus = 20;
                    agilityBonus = 3;
                    spiritBonus = 2;
                    break;
            }
            
            gameState.strength = strengthRoll + strengthBonus;
            gameState.maxHealth = healthRoll + healthBonus;
            gameState.health = gameState.maxHealth;
            gameState.agility = agilityRoll + agilityBonus;
            gameState.spirit = spiritRoll + spiritBonus;
            
            // Starting equipment
            gameState.inventory = ['Torch', 'Rope', 'Waterskin', 'Hardtack'];
            gameState.equippedWeapon = 'Rusty Sword';
            gameState.equippedArmor = 'Leather Armor';
            
            document.getElementById('dice-results').innerHTML = `
                <div class="dice-roll">
                    Strength: ${strengthRoll} + ${strengthBonus} = <span class="stat-value">${gameState.strength}</span>
                </div>
                <div class="dice-roll">
                    Health: ${healthRoll} + ${healthBonus} = <span class="stat-value">${gameState.maxHealth}</span>
                </div>
                <div class="dice-roll">
                    Agility: ${agilityRoll} + ${agilityBonus} = <span class="stat-value">${gameState.agility}</span>
                </div>
                ${gameState.playerClass === 'mystic' ? 
                `<div class="dice-roll">
                    Spirit: ${spiritRoll} + ${spiritBonus} = <span class="stat-value">${gameState.spirit}</span>
                </div>` : ''}
            `;
            
            document.getElementById('proceed-btn').disabled = false;
        }
        
        function proceedToHermit() {
            playSound('click');
            document.getElementById('hermit-silver').textContent = gameState.silver;
            showScreen('screen-hermit');
        }
        
        // Hermit item selection
        let selectedHermitItem = null;
        
        function selectHermitItem(itemKey) {
            playSound('click');
            selectedHermitItem = itemKey;
            const item = hermitItems[itemKey];
            
            document.getElementById('selected-item-name').textContent = item.name;
            document.getElementById('selected-item-desc').innerHTML = 
                `<span class="item">${item.name}</span>: ${item.description}<br>Effect: ${item.effect}`;
            document.getElementById('selected-item-display').style.display = 'block';
            
            // Enable confirm button if player has enough silver
            if (gameState.silver >= item.cost) {
                document.getElementById('confirm-item-btn').disabled = false;
            } else {
                document.getElementById('confirm-item-btn').disabled = true;
            }
        }
        
        function confirmHermitItem() {
            if (!selectedHermitItem) return;
            
            const item = hermitItems[selectedHermitItem];
            
            if (gameState.silver >= item.cost) {
                playSound('item');
                gameState.silver -= item.cost;
                addToInventory(item.name);
                gameState.hermitItem = item.name;
                
                // Special handling for silvered knife (can be equipped)
                if (selectedHermitItem === 'silvered_knife') {
                    gameState.equippedWeapon = 'Silvered Knife';
                }
                
                updateStatsDisplay();
                updateInventoryDisplay();
                startGame();
            }
        }
        
        function skipHermit() {
            playSound('click');
            startGame();
        }
        
        function startGame() {
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-spirit').textContent = gameState.spirit;
            document.getElementById('stat-silver').textContent = gameState.silver;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item)) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Herbs') {
                const healAmount = rollDice(2, 8) + 8;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory('Healing Herbs');
                playSound('item');
                message = `You use the <span class='item'>Healing Herbs</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Torch') {
                message = "The <span class='item'>Torch</span> provides light in dark areas. It will burn for about an hour.";
            } else if (item === 'Ghost Salt') {
                message = "The <span class='item'>Ghost Salt</span> is blessed salt that disrupts spectral forms. It can be thrown at ghosts and spirits.";
            } else if (item === 'Iron Ward Charm') {
                message = "The <span class='item'>Iron Ward Charm</span> repels spirits. They cannot approach you while you hold it.";
            } else if (item === 'Moors Map') {
                message = "The <span class='item'>Moors Map</span> shows safer paths through the treacherous moors. It might help you avoid danger.";
            } else if (item === 'Warded Lantern') {
                message = "The <span class='item'>Warded Lantern</span> provides protective light that keeps weaker spirits at bay. It never runs out of oil.";
            } else if (item === 'Hardtack') {
                const healAmount = rollDice(1, 4) + 2;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory('Hardtack');
                playSound('item');
                message = `You eat the <span class='item'>Hardtack</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Dried Meat') {
                const healAmount = rollDice(1, 6) + 3;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory('Dried Meat');
                playSound('item');
                message = `You eat the <span class='item'>Dried Meat</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Sword' && 
                gameState.equippedArmor === 'Leather Armor') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 26 || sectionId === 29 || sectionId === 45 || sectionId === 47 || 
                                  sectionId === 56 || sectionId === 70 || sectionId === 82 || sectionId === 86 || 
                                  sectionId === 88 || sectionId === 90);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    const silverReward = Math.floor(Math.random() * 20) + 10;
                    gameState.silver += silverReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find <span class="gold">${silverReward} Silver</span> on the remains.`;
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue through the moors";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            let playerTotal = playerRoll + gameState.strength;
            let enemyTotal = enemyRoll + combatState.enemyStrength;
            
            // Special bonuses for spirits
            if (combatState.isSpirit && gameState.equippedWeapon === 'Silvered Knife') {
                playerTotal += 3; // Bonus vs spirits
            }
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength}${combatState.isSpirit && gameState.equippedWeapon === 'Silvered Knife' ? ' + 3 (silvered knife vs spirit)' : ''} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                if (gameState.equippedWeapon === 'Rusty Sword') damage = rollDice(2, 6);
                else if (gameState.equippedWeapon === 'Silvered Knife') {
                    damage = rollDice(2, 6);
                    if (combatState.isSpirit) damage += 3; // Bonus vs spirits
                }
                else damage = rollDice(2, 6); // Default
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                const enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('landOfTheDammedGameState');
                        location.reload();
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            
            // For non-mystics trying spirit checks, they have 0 spirit
            if (checkType === 'spirit' && gameState.playerClass !== 'mystic') {
                statValue = 0;
            }
            
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You dodge an unseen hazard in the bog!",
                    "You move silently past a sleeping bog creature.",
                    "You leap across a patch of treacherous ground safely."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip in the bog and take 2 damage!",
                    "You make noise and alert nearby creatures.",
                    "You get tangled in bog vines."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 2;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('landOfTheDammedGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('landOfTheDammedGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 1 (this page)
                if (savedState.level === 1) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 1.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 2 with updated level
            gameState.level = 2;
            localStorage.setItem('landOfTheDammedGameState', JSON.stringify(gameState));
            // Redirect to level 2
            window.location.href = 'lvl2.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
