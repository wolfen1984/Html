<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASTLE OF THE UNDEAD - Level 5: The Second Floor</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Gothic Purple/Black/White theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(60, 0, 80, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(60, 0, 80, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #8040a0;
            background-color: #000;
            box-shadow: 0 0 20px rgba(128, 64, 160, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(60, 0, 80, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #8040a0;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #c080ff;
            text-shadow: 0 0 5px #a040ff;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #8040a0;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #500;
            color: #ff0;
            border-color: #ff0;
        }
        
        .level-number.current {
            background-color: #8040a0;
            color: #fff;
            border-color: #c080ff;
            box-shadow: 0 0 8px #a040ff;
            text-shadow: 0 0 2px #000;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #c080ff;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #c080ff;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #8040a0;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #c080ff;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #c080ff;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #8040a0;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8040a0;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #c080ff;
            border-color: #c080ff;
            box-shadow: 0 0 10px rgba(128, 64, 255, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #8040a0;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #c080ff;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8040a0;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #c080ff;
            border-color: #c080ff;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #221133;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #c080ff;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #332244;
            border: 1px solid #c080ff;
            padding: 10px;
            margin: 10px 0;
            color: #c080ff;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #6ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        .ghost {
            color: #aaf;
            font-weight: bold;
            text-shadow: 0 0 3px #aaf;
        }
        
        .demon {
            color: #f96;
            font-weight: bold;
            text-shadow: 0 0 3px #f96;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8040a0;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #8040a0;
            color: #fff;
            border-color: #c080ff;
            box-shadow: 0 0 15px #a040ff;
        }
        
        /* Blood Rune Puzzle */
        .rune-puzzle {
            background-color: #221133;
            border: 1px solid #8040a0;
            padding: 15px;
            margin: 15px 0;
        }
        
        .puzzle-title {
            color: #c080ff;
            font-weight: bold;
            margin-bottom: 10px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .puzzle-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .puzzle-option {
            background-color: #332244;
            border: 1px solid #8040a0;
            padding: 10px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .puzzle-option:hover {
            background-color: #443355;
            border-color: #c080ff;
        }
        
        /* Book Selection */
        .book-selection {
            background-color: #221133;
            border: 1px solid #8040a0;
            padding: 15px;
            margin: 15px 0;
        }
        
        .book-option {
            background-color: #332244;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .book-option:hover {
            background-color: #443355;
            border-color: #c080ff;
        }
        
        /* Crypt Lock */
        .crypt-lock {
            background-color: #221133;
            border: 1px solid #8040a0;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .lock-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            background-color: #332244;
            border: 2px solid #8040a0;
            margin: 5px;
            font-size: 20px;
            color: #fff;
            text-align: center;
            line-height: 36px;
            cursor: pointer;
        }
        
        .lock-number:hover {
            background-color: #443355;
            border-color: #c080ff;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #8040a0;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #8040a0;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #c080ff;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CASTLE OF THE UNDEAD</h1>
            <h2>LEVEL 5: THE SECOND FLOOR</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number completed">2</div>
            <div class="level-number completed">3</div>
            <div class="level-number completed">4</div>
            <div class="level-number current">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Level Intro Screen -->
        <div id="screen-intro" class="screen active-screen">
            <h2>THE SECOND FLOOR</h2>
            <div class="story-text">
                <p>You stand on the second floor of Castle Vorlak. The air here is colder, thicker with ancient magic and the scent of undeath. Torches burn with an eerie blue flame that casts long, dancing shadows.</p>
                <p>This floor houses the vampire lord's personal chambers, his private library, and the ancient crypts where the oldest vampires sleep. The power of Valerius permeates every stone.</p>
                <p>From somewhere nearby, you hear faint whispers - not in any language you understand, but ancient, guttural sounds that raise the hairs on your neck.</p>
                <p>Your quest to destroy Valerius brings you to his inner sanctum. But first, you must navigate his most deadly defenses and find the passage to the graveyard where he draws his power.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="intro-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="intro-stat-health" class="stat-value">0</span>/<span id="intro-stat-maxhealth" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="intro-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="intro-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="startLevel5()">ENTER THE SECOND FLOOR</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>SECOND FLOOR OF CASTLE VORLAK</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Blood Rune Puzzle Screen -->
        <div id="screen-rune-puzzle" class="screen">
            <h2>BLOOD RUNE SEAL</h2>
            <div class="story-text">
                <p>Before you is a door sealed with five blood runes. They glow with a malevolent red light. The runes must be pressed in the correct order to break the seal.</p>
                <p>The runes are ancient symbols: <span class="item">Blood</span>, <span class="item">Moon</span>, <span class="item">Night</span>, <span class="item">Death</span>, and <span class="item">Eternal</span>.</p>
                <p>You recall something from your studies: Vampire seals often follow the cycle of their existence. What comes first in a vampire's transformation?</p>
                
                <div class="rune-puzzle">
                    <div class="puzzle-title">SELECT THE RUNES IN ORDER:</div>
                    <div class="puzzle-options">
                        <div class="puzzle-option" onclick="selectRune('blood')">BLOOD</div>
                        <div class="puzzle-option" onclick="selectRune('moon')">MOON</div>
                        <div class="puzzle-option" onclick="selectRune('night')">NIGHT</div>
                        <div class="puzzle-option" onclick="selectRune('death')">DEATH</div>
                        <div class="puzzle-option" onclick="selectRune('eternal')">ETERNAL</div>
                    </div>
                    
                    <div id="rune-sequence" style="margin-top: 15px; padding: 10px; background-color: #332244; border: 1px solid #8040a0; min-height: 40px;">
                        Sequence: <span id="rune-selection">None selected</span>
                    </div>
                </div>
                
                <div id="rune-feedback" style="margin-top: 15px; padding: 10px; background-color: #221133; border: 1px solid #8040a0; display: none;">
                    <p id="rune-feedback-text"></p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="tryRunePuzzle()" id="try-rune-btn">ATTEMPT SEQUENCE</button>
                <button class="action-btn" onclick="resetRunePuzzle()">RESET SELECTION</button>
                <button class="action-btn" onclick="cancelRunePuzzle()">CANCEL (RETURN)</button>
            </div>
        </div>
        
        <!-- Library Book Selection Screen -->
        <div id="screen-library-puzzle" class="screen">
            <h2>FORBIDDEN LIBRARY</h2>
            <div class="story-text">
                <p>The library contains thousands of books. One section catches your eye - books bound in what looks like human skin. An inscription above reads: "Knowledge of the grave opens the way to the grave."</p>
                <p>You need to find the right book to learn how to access the graveyard passage. Which subject should you research?</p>
                
                <div class="book-selection">
                    <div class="puzzle-title">SELECT A BOOK TO STUDY:</div>
                    <div class="book-option" onclick="selectBook('necromancy')">
                        <strong>Necromancy and the Undead</strong><br>
                        <small>Raising and controlling the dead</small>
                    </div>
                    <div class="book-option" onclick="selectBook('vampire_origins')">
                        <strong>The Origins of Vampirism</strong><br>
                        <small>How the first vampires were created</small>
                    </div>
                    <div class="book-option" onclick="selectBook('graveyard_rituals')">
                        <strong>Graveyard Rituals and Tombs</strong><br>
                        <small>Burial customs and tomb construction</small>
                    </div>
                    <div class="book-option" onclick="selectBook('castle_architecture')">
                        <strong>Castle Architecture and Secret Passages</strong><br>
                        <small>Hidden doors and structural secrets</small>
                    </div>
                    <div class="book-option" onclick="selectBook('blood_magic')">
                        <strong>Blood Magic and Sacrifice</strong><br>
                        <small>Rituals involving blood and life force</small>
                    </div>
                </div>
                
                <div id="book-feedback" style="margin-top: 15px; padding: 10px; background-color: #221133; border: 1px solid #8040a0; display: none;">
                    <p id="book-feedback-text"></p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="tryBookSelection()" id="try-book-btn">STUDY THIS BOOK</button>
                <button class="action-btn" onclick="cancelLibraryPuzzle()">LEAVE LIBRARY</button>
            </div>
        </div>
        
        <!-- Crypt Lock Puzzle -->
        <div id="screen-crypt-lock" class="screen">
            <h2>CRYPT ENTRANCE LOCK</h2>
            <div class="story-text">
                <p>The crypt entrance is sealed with a combination lock featuring five rotating number wheels. Each wheel has numbers 0-9.</p>
                <p>A faded inscription reads: "The year of our lord's turning, minus the number of his first victims, gives passage to his rest."</p>
                <p>From your research, you know Valerius was turned in 1347. The number of his first victims was recorded in the histories.</p>
                
                <div class="crypt-lock">
                    <div class="puzzle-title">ENTER THE 5-DIGIT CODE:</div>
                    <div style="margin: 15px 0;">
                        <span class="lock-number" onclick="changeLockDigit(0)">0</span>
                        <span class="lock-number" onclick="changeLockDigit(1)">0</span>
                        <span class="lock-number" onclick="changeLockDigit(2)">0</span>
                        <span class="lock-number" onclick="changeLockDigit(3)">0</span>
                        <span class="lock-number" onclick="changeLockDigit(4)">0</span>
                    </div>
                    <div style="margin: 10px 0; color: #c080ff;">
                        Current combination: <span id="lock-display">00000</span>
                    </div>
                    <div id="lock-feedback" style="margin-top: 10px; padding: 10px; background-color: #221133; border: 1px solid #8040a0; display: none;">
                        <p id="lock-feedback-text"></p>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="tryCryptLock()">TRY COMBINATION</button>
                <button class="action-btn" onclick="cancelCryptLock()">LEAVE CRYPT</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL 5 COMPLETE!</h2>
            <div class="story-text">
                <p>You have navigated the treacherous second floor of Castle Vorlak and found the hidden stairwell!</p>
                <p>The stone staircase descends into darkness, the air growing colder with each step. After what feels like an eternity, you reach a heavy iron door.</p>
                <p>Pushing it open, you find yourself emerging into a moonlit graveyard behind the castle. Ancient tombstones stand crooked in the earth, and mist hangs low between the monuments.</p>
                <p>This is the Castle Vorlak graveyard, where generations of vampires and their victims lie buried. Valerius draws power from this cursed ground.</p>
                <p>Your hunt continues among the tombs and crypts. All your stats, gold, and inventory will carry over to Level 6.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #221133; border: 1px solid #8040a0;">
                    <h3 style="color: #c080ff; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">ENTER THE GRAVEYARD - LEVEL 6</button>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE UNDEAD - A Retro Vampire Hunt Adventure<br>
            Level 5: The Second Floor
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'rune':
                    playBeep(300, 0.2, 'square');
                    break;
                case 'book':
                    playBeep(600, 0.1, 'sine');
                    setTimeout(() => playBeep(400, 0.2, 'sine'), 100);
                    break;
                case 'lock':
                    playBeep(200, 0.1, 'square');
                    break;
                case 'vampire':
                    playBeep(150, 0.3, 'sawtooth');
                    setTimeout(() => playBeep(100, 0.3, 'sawtooth'), 300);
                    break;
                case 'ghost':
                    playBeep(400, 0.3, 'sine');
                    setTimeout(() => playBeep(300, 0.5, 'sine'), 300);
                    break;
                case 'demon':
                    playBeep(80, 0.4, 'sawtooth');
                    setTimeout(() => playBeep(120, 0.3, 'sawtooth'), 400);
                    break;
                case 'crypt':
                    playBeep(100, 0.5, 'sine');
                    setTimeout(() => playBeep(80, 0.5, 'sine'), 500);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - loaded from Level 4
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Rusty Sword',
            equippedArmor: 'Leather Armor',
            currentSection: 1,
            gameComplete: false,
            level: 5,
            // Level 5 specific flags
            exploredLibrary: false,
            foundBloodRuneClue: false,
            solvedBloodRunePuzzle: false,
            foundSecretStudy: false,
            defeatedVampireGuardian: false,
            studiedGraveyardBook: false,
            foundCryptKey: false,
            solvedCryptLock: false,
            foundGraveyardPassage: false,
            // Special items that might be found
            hasHolyWater: false,
            hasGarlic: false,
            hasSilverBullets: false
        };
        
        // Blood rune puzzle state
        let runePuzzleState = {
            sequence: [],
            attempts: 0
        };
        
        const runeSolution = ['blood', 'moon', 'night', 'death', 'eternal'];
        
        // Library book selection
        let bookSelection = '';
        
        // Crypt lock puzzle state
        let cryptLockState = [0, 0, 0, 0, 0];
        const cryptSolution = [1, 3, 2, 5]; // 1347 - 22 = 1325 (Valerius turned 1347, first victims 22)
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1
        };
        
        // Game story sections for Level 5
        const storySections = {
            1: {
                text: "You stand on the second floor landing. The corridor stretches before you, lined with ornate doors. The air is icy cold, and your breath mists in the torchlight. From somewhere ahead, you hear faint whispers that seem to come from the walls themselves.",
                choices: [
                    {text: "Open the first door on the left", nextSection: 2, skillCheck: false},
                    {text: "Open the first door on the right", nextSection: 3, skillCheck: false},
                    {text: "Continue down the corridor", nextSection: 4, skillCheck: false},
                    {text: "Listen to the whispers", nextSection: 5, skillCheck: true, checkType: 'agility', difficulty: 14}
                ]
            },
            2: {
                text: "The door opens to reveal a lavish bedroom. A four-poster bed with black velvet curtains dominates the room. The furniture is exquisitely crafted from dark wood. A dressing table holds silver brushes and perfume bottles.",
                choices: [
                    {text: "Search the room", nextSection: 6, skillCheck: false},
                    {text: "Examine the bed", nextSection: 7, skillCheck: false},
                    {text: "Check the wardrobe", nextSection: 8, skillCheck: false},
                    {text: "Leave and try another door", nextSection: 1, skillCheck: false}
                ]
            },
            3: {
                text: "This room appears to be a study. A massive oak desk sits in the center, covered in papers and books. Shelves line the walls, filled with leather-bound volumes. The room smells of old paper and incense.",
                choices: [
                    {text: "Examine the desk", nextSection: 9, skillCheck: false},
                    {text: "Browse the bookshelves", nextSection: 10, skillCheck: false},
                    {text: "Look for hidden compartments", nextSection: 11, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Leave and try another door", nextSection: 1, skillCheck: false}
                ]
            },
            4: {
                text: "You continue down the corridor. The whispering grows louder, but you still can't make out words. At the end of the corridor, you find a set of double doors carved with scenes of vampires feasting. The doors are slightly ajar.",
                choices: [
                    {text: "Enter through the double doors", nextSection: 12, skillCheck: false},
                    {text: "Listen at the doors", nextSection: 13, skillCheck: false},
                    {text: "Return to the landing", nextSection: 1, skillCheck: false}
                ]
            },
            5: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 14, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.foundBloodRuneClue = true;
                        playSound('success');
                        return "You concentrate and make out the whispers: 'Blood... moon... night... death... eternal...' The words repeat in a cycle. This might be important.";
                    } else {
                        playSound('failure');
                        return "The whispers remain indistinct, just a maddening murmur that gives you a headache.";
                    }
                }
            },
            6: {
                text: "You search the bedroom thoroughly. Under the mattress, you find a hidden compartment containing some items.",
                choices: [
                    {text: "Take the items", nextSection: 15, skillCheck: false},
                    {text: "Continue searching", nextSection: 16, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    addToInventory('Silver Hairbrush');
                    addToInventory('Perfume of Eternal Youth');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span>, a <span class='item'>Silver Hairbrush</span>, and a bottle of <span class='item'>Perfume of Eternal Youth</span>.";
                }
            },
            7: {
                text: "You examine the bed. The sheets are cold as ice. As you pull back the covers, you find nothing but dust. However, you notice a strange depression in the headboard.",
                choices: [
                    {text: "Press the depression", nextSection: 17, skillCheck: false},
                    {text: "Ignore it and search elsewhere", nextSection: 6, skillCheck: false}
                ]
            },
            8: {
                text: "The wardrobe is filled with fine clothing - velvet robes, silk shirts, and leather boots. In the back, you find a hidden panel.",
                choices: [
                    {text: "Open the hidden panel", nextSection: 18, skillCheck: false},
                    {text: "Search the clothing", nextSection: 19, skillCheck: false}
                ]
            },
            9: {
                text: "The desk is covered in papers. Most are mundane - household accounts, correspondence. But one document catches your eye: a map showing a passage from the castle to the graveyard, marked with blood runes.",
                choices: [
                    {text: "Study the map", nextSection: 20, skillCheck: false},
                    {text: "Search the desk drawers", nextSection: 21, skillCheck: false}
                ]
            },
            10: {
                text: "The bookshelves contain volumes on history, magic, and vampire lore. One section seems particularly interesting - books about graveyards and burial rituals.",
                choices: [
                    {text: "Examine the graveyard books", nextSection: 22, skillCheck: false},
                    {text: "Look for books on vampires", nextSection: 23, skillCheck: false},
                    {text: "Return to the desk", nextSection: 9, skillCheck: false}
                ]
            },
            11: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.foundSecretStudy = true;
                        playSound('success');
                        return "You find a hidden lever behind a bookshelf! Pulling it reveals a secret room.";
                    } else {
                        playSound('failure');
                        return "You search thoroughly but find no hidden compartments.";
                    }
                }
            },
            12: {
                text: "You enter a grand library. The room is vast, with shelves reaching three stories high. Ladders provide access to upper levels. The air smells of dust and old magic. At the far end, a fireplace crackles with blue flames.",
                choices: [
                    {text: "Explore the lower shelves", nextSection: 25, skillCheck: false},
                    {text: "Climb a ladder to upper shelves", nextSection: 26, skillCheck: true, checkType: 'agility', difficulty: 13},
                    {text: "Approach the fireplace", nextSection: 27, skillCheck: false},
                    {text: "Leave the library", nextSection: 4, skillCheck: false}
                ]
            },
            13: {
                text: "You listen at the doors. You can hear the crackle of flames and... pages turning? But there's no one visible through the crack.",
                choices: [
                    {text: "Enter cautiously", nextSection: 12, skillCheck: false},
                    {text: "Return down the corridor", nextSection: 4, skillCheck: false}
                ]
            },
            14: {
                text: "After listening to the whispers, you consider your next move.",
                choices: [
                    {text: "Continue exploring", nextSection: 1, skillCheck: false}
                ]
            },
            15: {
                text: "With your new items, you continue searching the bedroom.",
                choices: [
                    {text: "Examine the bed", nextSection: 7, skillCheck: false},
                    {text: "Check the wardrobe", nextSection: 8, skillCheck: false},
                    {text: "Leave the room", nextSection: 1, skillCheck: false}
                ]
            },
            16: {
                text: "You continue searching but find nothing else of value in the bedroom.",
                choices: [
                    {text: "Leave the room", nextSection: 1, skillCheck: false}
                ]
            },
            17: {
                text: "You press the depression in the headboard. With a soft click, a small compartment opens, revealing a silver locket.",
                choices: [
                    {text: "Take the locket", nextSection: 28, skillCheck: false},
                    {text: "Leave it", nextSection: 7, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Silver Locket with Portrait');
                    playSound('item');
                    return "You find a <span class='item'>Silver Locket with Portrait</span>. Inside is a picture of a beautiful woman with sad eyes.";
                }
            },
            18: {
                text: "You open the hidden panel. Inside, you find a small chest.",
                choices: [
                    {text: "Open the chest", nextSection: 29, skillCheck: false},
                    {text: "Leave it", nextSection: 8, skillCheck: false}
                ]
            },
            19: {
                text: "You search through the clothing. In the pocket of a velvet robe, you find a small key.",
                choices: [
                    {text: "Take the key", nextSection: 30, skillCheck: false},
                    {text: "Check for the hidden panel", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Ornate Brass Key');
                    playSound('item');
                    return "You find an <span class='item'>Ornate Brass Key</span>. It might unlock something important.";
                }
            },
            20: {
                text: "The map shows a secret passage leading from the castle's second floor down to the graveyard. The entrance is marked with five blood runes that must be activated in sequence. The sequence is written in the margin: Blood, Moon, Night, Death, Eternal.",
                choices: [
                    {text: "Memorize the sequence", nextSection: 31, skillCheck: false},
                    {text: "Take the map", nextSection: 32, skillCheck: false},
                    {text: "Search the desk drawers", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    gameState.foundBloodRuneClue = true;
                    return "You've learned the blood rune sequence!";
                }
            },
            21: {
                text: "You search the desk drawers. In one, you find writing implements. In another, a bottle of ink that still seems fresh. The bottom drawer is locked.",
                choices: [
                    {text: "Try to pick the lock", nextSection: 33, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Try the brass key if you have it", nextSection: 34, skillCheck: false, requirement: 'Ornate Brass Key'},
                    {text: "Force it open", nextSection: 35, skillCheck: true, checkType: 'strength', difficulty: 14},
                    {text: "Leave it", nextSection: 9, skillCheck: false}
                ]
            },
            22: {
                text: "The graveyard books contain information about burial rites, tomb construction, and the significance of graveyards in vampire lore. One book in particular seems important: 'Graveyard Rituals and Tombs'.",
                choices: [
                    {text: "Study this book", nextSection: 36, skillCheck: false},
                    {text: "Look for other books", nextSection: 10, skillCheck: false}
                ]
            },
            23: {
                text: "The vampire books contain histories of vampire clans, their weaknesses, and their powers. One book stands out: 'The Origins of Vampirism'.",
                choices: [
                    {text: "Study this book", nextSection: 37, skillCheck: false},
                    {text: "Look for other books", nextSection: 10, skillCheck: false}
                ]
            },
            24: {
                text: "After your search for hidden compartments, you return to examining the study.",
                choices: [
                    {text: "Examine the desk", nextSection: 9, skillCheck: false},
                    {text: "Browse the bookshelves", nextSection: 10, skillCheck: false}
                ]
            },
            25: {
                text: "The lower shelves contain mostly historical records and accounts of castle life. One section seems out of place - books bound in what looks like human skin.",
                choices: [
                    {text: "Examine the strange books", nextSection: 38, skillCheck: false},
                    {text: "Climb to upper shelves", nextSection: 26, skillCheck: true, checkType: 'agility', difficulty: 13},
                    {text: "Approach the fireplace", nextSection: 27, skillCheck: false}
                ]
            },
            26: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 39, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(3, 10);
                        gameState.gold += goldFound;
                        addToInventory('Ancient Scroll');
                        updateStatsDisplay();
                        playSound('item');
                        return "You climb to the upper shelves and find <span class='gold'>" + goldFound + " Gold</span> and an <span class='item'>Ancient Scroll</span> tucked behind some books.";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You slip and fall, taking " + damage + " damage. Climbing is too dangerous.";
                    }
                }
            },
            27: {
                text: "The fireplace is enormous, large enough to stand in. The blue flames give off no heat, only cold. Above the mantel, a portrait of a noble-looking vampire stares down at you.",
                choices: [
                    {text: "Examine the portrait", nextSection: 40, skillCheck: false},
                    {text: "Check behind the fireplace", nextSection: 41, skillCheck: false},
                    {text: "Return to the shelves", nextSection: 25, skillCheck: false}
                ]
            },
            28: {
                text: "With the locket, you continue exploring the bedroom.",
                choices: [
                    {text: "Check the wardrobe", nextSection: 8, skillCheck: false},
                    {text: "Leave the room", nextSection: 1, skillCheck: false}
                ]
            },
            29: {
                text: "You open the chest. Inside, you find some valuable items.",
                choices: [
                    {text: "Take the contents", nextSection: 42, skillCheck: false},
                    {text: "Leave them", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(6, 10);
                    gameState.gold += goldFound;
                    addToInventory('Ruby Ring');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Ruby Ring</span>.";
                }
            },
            30: {
                text: "With the key, you consider your next move.",
                choices: [
                    {text: "Open the hidden panel", nextSection: 18, skillCheck: false},
                    {text: "Leave the wardrobe", nextSection: 8, skillCheck: false}
                ]
            },
            31: {
                text: "You've memorized the blood rune sequence. Now you need to find where to use it.",
                choices: [
                    {text: "Take the map", nextSection: 32, skillCheck: false},
                    {text: "Search the desk drawers", nextSection: 21, skillCheck: false}
                ]
            },
            32: {
                text: "You take the map. It might be useful later.",
                choices: [
                    {text: "Search the desk drawers", nextSection: 21, skillCheck: false},
                    {text: "Browse the bookshelves", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Graveyard Passage Map');
                    playSound('item');
                    return "You take the <span class='item'>Graveyard Passage Map</span>.";
                }
            },
            33: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 43, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(2, 10);
                        gameState.gold += goldFound;
                        addToInventory('Vampire Hunting Contract');
                        updateStatsDisplay();
                        playSound('item');
                        return "You pick the lock! Inside, you find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Vampire Hunting Contract</span> with your name on it!";
                    } else {
                        playSound('failure');
                        return "The lock is too complex. You can't pick it.";
                    }
                }
            },
            34: {
                text: "You try the brass key in the desk drawer. It fits perfectly!",
                choices: [
                    {text: "Open the drawer", nextSection: 44, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Ornate Brass Key');
                    playSound('success');
                    return "The <span class='item'>Ornate Brass Key</span> unlocks the drawer!";
                }
            },
            35: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 45, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(1, 10);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        playSound('item');
                        return "You force the drawer open! Inside, you find <span class='gold'>" + goldFound + " Gold</span>.";
                    } else {
                        playSound('failure');
                        return "The drawer won't budge. It's too sturdy.";
                    }
                }
            },
            36: {
                text: "You study 'Graveyard Rituals and Tombs'. It contains information about how vampires use graveyards to draw power from the dead. It also mentions secret passages connecting castles to their burial grounds.",
                choices: [
                    {text: "Continue studying", nextSection: 46, skillCheck: false},
                    {text: "Look for other books", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    gameState.studiedGraveyardBook = true;
                    playSound('book');
                    return "You've learned about graveyard-vampire connections. This knowledge might help you find the passage.";
                }
            },
            37: {
                text: "You study 'The Origins of Vampirism'. It describes how the first vampires were created through dark rituals involving blood sacrifice under a full moon.",
                choices: [
                    {text: "Continue studying", nextSection: 47, skillCheck: false},
                    {text: "Look for other books", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    playSound('book');
                    return "You've learned about vampire origins. This might help you understand their weaknesses.";
                }
            },
            38: {
                text: "The human-skin books contain forbidden knowledge - necromancy, blood magic, and dark rituals. One book in particular seems important for your quest.",
                choices: [
                    {text: "Examine the books more closely", nextSection: 48, skillCheck: false},
                    {text: "Leave them alone", nextSection: 25, skillCheck: false}
                ]
            },
            39: {
                text: "After your climbing attempt, you return to exploring the library.",
                choices: [
                    {text: "Examine the lower shelves", nextSection: 25, skillCheck: false},
                    {text: "Approach the fireplace", nextSection: 27, skillCheck: false}
                ]
            },
            40: {
                text: "The portrait depicts a handsome vampire lord with piercing eyes. The plaque reads 'Valerius, Lord of Vorlak'. As you look at it, the eyes seem to follow you.",
                choices: [
                    {text: "Search behind the portrait", nextSection: 49, skillCheck: false},
                    {text: "Check behind the fireplace", nextSection: 41, skillCheck: false},
                    {text: "Return to the shelves", nextSection: 25, skillCheck: false}
                ]
            },
            41: {
                text: "You check behind the fireplace. The stones are loose! You find a hidden lever.",
                choices: [
                    {text: "Pull the lever", nextSection: 50, skillCheck: false},
                    {text: "Leave it", nextSection: 27, skillCheck: false}
                ]
            },
            42: {
                text: "With the chest contents taken, you leave the wardrobe.",
                choices: [
                    {text: "Leave the bedroom", nextSection: 1, skillCheck: false}
                ]
            },
            43: {
                text: "After your lockpicking attempt, you consider your options.",
                choices: [
                    {text: "Try the brass key if you have it", nextSection: 34, skillCheck: false, requirement: 'Ornate Brass Key'},
                    {text: "Force the drawer", nextSection: 35, skillCheck: false},
                    {text: "Leave it", nextSection: 21, skillCheck: false}
                ]
            },
            44: {
                text: "You open the unlocked drawer. Inside, you find important documents.",
                choices: [
                    {text: "Examine the documents", nextSection: 51, skillCheck: false},
                    {text: "Take them", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Vampire Council Letters');
                    playSound('item');
                    return "You find <span class='item'>Vampire Council Letters</span> discussing the graveyard's importance.";
                }
            },
            45: {
                text: "After trying to force the drawer, you reconsider.",
                choices: [
                    {text: "Try to pick the lock", nextSection: 33, skillCheck: false},
                    {text: "Try the brass key if you have it", nextSection: 34, skillCheck: false, requirement: 'Ornate Brass Key'},
                    {text: "Leave it", nextSection: 21, skillCheck: false}
                ]
            },
            46: {
                text: "You continue studying the graveyard book. It mentions that vampire castles often have secret passages to their burial grounds, usually protected by blood magic.",
                choices: [
                    {text: "Put the book back", nextSection: 10, skillCheck: false},
                    {text: "Take the book with you", nextSection: 53, skillCheck: false}
                ]
            },
            47: {
                text: "You continue studying the vampire origins book. It mentions that sunlight, running water, garlic, and holy symbols are effective against vampires.",
                choices: [
                    {text: "Put the book back", nextSection: 10, skillCheck: false},
                    {text: "Take the book with you", nextSection: 54, skillCheck: false}
                ]
            },
            48: {
                text: "As you examine the human-skin books, one falls open to a page showing a diagram of blood runes. The caption reads: 'To open the way to the grave, follow the cycle of vampiric existence.'",
                choices: [
                    {text: "Study the diagram", nextSection: 55, skillCheck: false},
                    {text: "Take the book", nextSection: 56, skillCheck: false},
                    {text: "Leave it", nextSection: 38, skillCheck: false}
                ]
            },
            49: {
                text: "You search behind the portrait. There's nothing there but a cold stone wall.",
                choices: [
                    {text: "Check behind the fireplace", nextSection: 41, skillCheck: false},
                    {text: "Return to the shelves", nextSection: 25, skillCheck: false}
                ]
            },
            50: {
                text: "You pull the lever. With a grinding sound, a section of the bookcase slides aside, revealing a hidden passage!",
                choices: [
                    {text: "Enter the passage", nextSection: 57, skillCheck: false},
                    {text: "Leave it and return to the library", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "You've found a hidden passage!";
                }
            },
            51: {
                text: "The documents are letters from the Vampire Council discussing the importance of the Vorlak graveyard. They mention that Valerius draws power from the ancient graves there.",
                choices: [
                    {text: "Take the letters", nextSection: 52, skillCheck: false},
                    {text: "Leave them", nextSection: 44, skillCheck: false}
                ]
            },
            52: {
                text: "With the letters in hand, you continue exploring the study.",
                choices: [
                    {text: "Browse the bookshelves", nextSection: 10, skillCheck: false},
                    {text: "Leave the study", nextSection: 3, skillCheck: false}
                ]
            },
            53: {
                text: "You take the graveyard book with you.",
                choices: [
                    {text: "Continue exploring the library", nextSection: 25, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Graveyard Rituals and Tombs');
                    playSound('book');
                    return "You take <span class='item'>Graveyard Rituals and Tombs</span>.";
                }
            },
            54: {
                text: "You take the vampire origins book with you.",
                choices: [
                    {text: "Continue exploring the library", nextSection: 25, skillCheck: false}
                ],
                action: function() {
                    addToInventory('The Origins of Vampirism');
                    playSound('book');
                    return "You take <span class='item'>The Origins of Vampirism</span>.";
                }
            },
            55: {
                text: "The diagram shows five blood runes in a circle: Blood, Moon, Night, Death, and Eternal, with arrows indicating the sequence. This is exactly what you need!",
                choices: [
                    {text: "Memorize the sequence", nextSection: 58, skillCheck: false},
                    {text: "Take the book", nextSection: 56, skillCheck: false}
                ],
                action: function() {
                    gameState.foundBloodRuneClue = true;
                    playSound('rune');
                    return "You've learned the blood rune sequence from the diagram!";
                }
            },
            56: {
                text: "You take the human-skin book. It feels unnaturally cold in your hands.",
                choices: [
                    {text: "Continue examining the library", nextSection: 38, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Book of Blood Magic');
                    playSound('book');
                    return "You take the <span class='item'>Book of Blood Magic</span>. It feels evil.";
                }
            },
            57: {
                text: "You enter the hidden passage. It's narrow and dark, descending gradually. After a long walk, you emerge in a small room with a single door. The door is sealed with five glowing blood runes!",
                choices: [
                    {text: "Examine the blood runes", nextSection: 59, skillCheck: false},
                    {text: "Try to force the door", nextSection: 60, skillCheck: true, checkType: 'strength', difficulty: 18},
                    {text: "Return to the library", nextSection: 50, skillCheck: false}
                ]
            },
            58: {
                text: "With the blood rune sequence memorized, you continue exploring.",
                choices: [
                    {text: "Take the book", nextSection: 56, skillCheck: false},
                    {text: "Return to the main library", nextSection: 38, skillCheck: false}
                ]
            },
            59: {
                text: "The door is sealed with five blood runes that glow with a malevolent red light. They need to be pressed in the correct sequence to open the door.",
                choices: [
                    {text: "Attempt to solve the blood rune puzzle", nextSection: 61, skillCheck: false},
                    {text: "Look for clues in the room", nextSection: 62, skillCheck: false},
                    {text: "Return to the library", nextSection: 50, skillCheck: false}
                ]
            },
            60: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 63, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const damage = rollDice(3, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You strain against the door, but it doesn't budge. The blood runes flare angrily, dealing " + damage + " damage to you! The door is magically sealed.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The door is immovable. You injure yourself trying, taking " + damage + " damage.";
                    }
                }
            },
            61: {
                text: "You study the blood runes. They're labeled with ancient symbols: Blood, Moon, Night, Death, and Eternal. You need to press them in the correct order.",
                choices: [],
                action: function() {
                    showScreen('screen-rune-puzzle');
                    return "";
                }
            },
            62: {
                text: "You search the small room. On the floor, you find a scrap of parchment with writing: 'The cycle begins with Blood, follows the Moon of transformation, proceeds through the Night of hunting, ends with Death, and achieves Eternal existence.'",
                choices: [
                    {text: "Use this clue to solve the puzzle", nextSection: 61, skillCheck: false},
                    {text: "Return to examining the door", nextSection: 59, skillCheck: false}
                ],
                action: function() {
                    gameState.foundBloodRuneClue = true;
                    playSound('rune');
                    return "You've found a clue to the blood rune sequence!";
                }
            },
            63: {
                text: "After trying to force the door, you realize it won't open by strength alone.",
                choices: [
                    {text: "Examine the blood runes", nextSection: 59, skillCheck: false},
                    {text: "Return to the library", nextSection: 50, skillCheck: false}
                ]
            },
            64: {
                text: "With the blood rune seal broken, the door swings open silently. Beyond is a stone staircase descending into darkness. The air from below smells of damp earth and decay.",
                choices: [
                    {text: "Descend the staircase", nextSection: 65, skillCheck: false},
                    {text: "Return to the library first", nextSection: 50, skillCheck: false}
                ],
                action: function() {
                    gameState.solvedBloodRunePuzzle = true;
                    playSound('success');
                    return "The blood rune seal is broken! The way is open.";
                }
            },
            65: {
                text: "You descend the stone staircase. It spirals downward for what feels like an eternity. The air grows colder and damper with each step. Finally, you reach the bottom and find yourself in an ancient crypt.",
                choices: [
                    {text: "Explore the crypt", nextSection: 66, skillCheck: false},
                    {text: "Listen for sounds", nextSection: 67, skillCheck: false}
                ]
            },
            66: {
                text: "The crypt is filled with stone sarcophagi, each carved with the likeness of its occupant. The air is thick with dust and the scent of old death. At the far end, a larger sarcophagus stands on a dais.",
                choices: [
                    {text: "Examine the smaller sarcophagi", nextSection: 68, skillCheck: false},
                    {text: "Approach the large sarcophagus", nextSection: 69, skillCheck: false},
                    {text: "Search for exits", nextSection: 70, skillCheck: false}
                ]
            },
            67: {
                text: "You listen carefully. You can hear the drip of water somewhere in the distance, and... faint scratching sounds, like claws on stone.",
                choices: [
                    {text: "Investigate the scratching sounds", nextSection: 71, skillCheck: false},
                    {text: "Ignore them and explore", nextSection: 66, skillCheck: false}
                ]
            },
            68: {
                text: "The smaller sarcophagi are inscribed with names and dates going back centuries. Some have been broken open from the inside. These are the resting places of lesser vampires.",
                choices: [
                    {text: "Search for valuable items", nextSection: 72, skillCheck: false},
                    {text: "Approach the large sarcophagus", nextSection: 69, skillCheck: false}
                ]
            },
            69: {
                text: "The large sarcophagus is made of black marble, intricately carved with scenes of vampiric glory. The lid is heavy. An inscription reads: 'Here lies Vladis, Guardian of the Crypt'.",
                choices: [
                    {text: "Try to open the sarcophagus", nextSection: 73, skillCheck: true, checkType: 'strength', difficulty: 16},
                    {text: "Search for another way out", nextSection: 70, skillCheck: false},
                    {text: "Return to examining the smaller sarcophagi", nextSection: 68, skillCheck: false}
                ]
            },
            70: {
                text: "You search for exits. Besides the staircase you came down, there's a heavy iron door on the opposite wall. It's locked with a combination lock.",
                choices: [
                    {text: "Examine the lock", nextSection: 74, skillCheck: false},
                    {text: "Search for a key", nextSection: 75, skillCheck: false},
                    {text: "Return to the sarcophagi", nextSection: 66, skillCheck: false}
                ]
            },
            71: {
                text: "You follow the scratching sounds to a dark corner of the crypt. Suddenly, a gaunt figure leaps from the shadows - a CRYPT GHAST!",
                choices: [
                    {text: "Fight the crypt ghast", nextSection: 76, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Crypt Ghast";
                    combatState.enemyHealth = 50;
                    combatState.enemyCurrentHealth = 50;
                    combatState.enemyStrength = 12;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 77;
                    combatState.round = 1;
                    
                    playSound('demon');
                    return "<span class='demon'>Crypt Ghast</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            72: {
                text: "You search the smaller sarcophagi. Most contain only dust and bones, but in one you find some items.",
                choices: [
                    {text: "Take the items", nextSection: 78, skillCheck: false},
                    {text: "Approach the large sarcophagus", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    addToInventory('Ancient Burial Shroud');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and an <span class='item'>Ancient Burial Shroud</span> that might have protective properties.";
                }
            },
            73: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 79, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You manage to shift the heavy lid aside! Inside lies a vampire in ancient armor, but it's not Valerius. This must be Vladis, the crypt guardian.";
                    } else {
                        playSound('failure');
                        return "The lid is too heavy. You can't move it.";
                    }
                }
            },
            74: {
                text: "The lock has five rotating number wheels. It needs a 5-digit combination. A faded inscription above reads: 'The year of our lord's turning, minus the number of his first victims, gives passage to his rest.'",
                choices: [
                    {text: "Attempt to solve the combination", nextSection: 80, skillCheck: false},
                    {text: "Search for the combination", nextSection: 75, skillCheck: false},
                    {text: "Try to pick the lock", nextSection: 81, skillCheck: true, checkType: 'agility', difficulty: 17}
                ]
            },
            75: {
                text: "You search the crypt for clues to the combination. Near the large sarcophagus, you find a stone tablet with inscriptions.",
                choices: [
                    {text: "Read the inscriptions", nextSection: 82, skillCheck: false},
                    {text: "Examine the lock", nextSection: 74, skillCheck: false}
                ]
            },
            76: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 83, skillCheck: false}
                ]
            },
            77: {
                text: "With the crypt ghast defeated, you can continue exploring the crypt.",
                choices: [
                    {text: "Examine the lock", nextSection: 74, skillCheck: false},
                    {text: "Search the sarcophagi", nextSection: 68, skillCheck: false}
                ]
            },
            78: {
                text: "With your new items, you continue exploring the crypt.",
                choices: [
                    {text: "Approach the large sarcophagus", nextSection: 69, skillCheck: false},
                    {text: "Search for exits", nextSection: 70, skillCheck: false}
                ]
            },
            79: {
                text: "The vampire in the sarcophagus suddenly opens its eyes! It rises with unnatural speed. 'Who disturbs my eternal rest?' it hisses.",
                choices: [
                    {text: "Fight Vladis, the Crypt Guardian", nextSection: 84, skillCheck: false},
                    {text: "Try to reason with it", nextSection: 85, skillCheck: false},
                    {text: "Retreat quickly", nextSection: 86, skillCheck: true, checkType: 'agility', difficulty: 15}
                ]
            },
            80: {
                text: "You examine the combination lock. You need to figure out the 5-digit code.",
                choices: [],
                action: function() {
                    showScreen('screen-crypt-lock');
                    return "";
                }
            },
            81: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 87, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully pick the lock! The door clicks open.";
                    } else {
                        playSound('failure');
                        return "The lock is too complex. You can't pick it.";
                    }
                }
            },
            82: {
                text: "The stone tablet contains historical records. One entry reads: 'In the year 1347, our lord Valerius was granted eternal life. His first feast claimed 22 souls.'",
                choices: [
                    {text: "Use this information for the lock", nextSection: 80, skillCheck: false},
                    {text: "Return to examining the lock", nextSection: 74, skillCheck: false}
                ],
                action: function() {
                    gameState.foundCryptKey = true;
                    playSound('lock');
                    return "You've found the information needed for the combination! Valerius was turned in 1347, and his first victims numbered 22. 1347 - 22 = 1325.";
                }
            },
            83: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 76, skillCheck: false}
                ]
            },
            84: {
                text: "Vladis draws an ancient sword from his sarcophagus. 'I have guarded this crypt for three centuries. You shall not pass!'",
                choices: [
                    {text: "Fight the crypt guardian", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Vladis, Crypt Guardian";
                    combatState.enemyHealth = 90;
                    combatState.enemyCurrentHealth = 90;
                    combatState.enemyStrength = 15;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 89;
                    combatState.round = 1;
                    
                    playSound('vampire');
                    return "<span class='vampire'>Vladis, Crypt Guardian</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            85: {
                text: "'I seek Valerius,' you say. 'I mean no disrespect to your rest.' The vampire guardian studies you. 'The master is not here. He rests in the graveyard crypt. If you seek him, you must pass through the door behind me.'",
                choices: [
                    {text: "Ask how to open the door", nextSection: 90, skillCheck: false},
                    {text: "Attack anyway", nextSection: 84, skillCheck: false}
                ]
            },
            86: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 91, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You retreat quickly before Vladis can fully rise. He settles back into his sarcophagus, muttering curses.";
                    } else {
                        const damage = rollDice(2, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "Vladis strikes you as you retreat, dealing " + damage + " damage!";
                    }
                }
            },
            87: {
                text: "After your lockpicking attempt, you consider your options.",
                choices: [
                    {text: "Try to solve the combination", nextSection: 80, skillCheck: false},
                    {text: "Search for clues", nextSection: 75, skillCheck: false},
                    {text: "Return to the sarcophagi", nextSection: 66, skillCheck: false}
                ]
            },
            88: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 92, skillCheck: false}
                ]
            },
            89: {
                text: "With Vladis defeated, you search his sarcophagus. Inside, you find a key!",
                choices: [
                    {text: "Take the key", nextSection: 93, skillCheck: false},
                    {text: "Examine the lock", nextSection: 74, skillCheck: false}
                ],
                action: function() {
                    gameState.defeatedVampireGuardian = true;
                    const goldFound = rollDice(8, 10);
                    gameState.gold += goldFound;
                    addToInventory('Crypt Guardian Key');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Crypt Guardian Key</span>!";
                }
            },
            90: {
                text: "'The door opens with knowledge,' Vladis says. 'Know the year of the master's turning and the number of his first victims. Subtract one from the other, and the way is open.' With that, he settles back into his sarcophagus.",
                choices: [
                    {text: "Thank him and approach the door", nextSection: 74, skillCheck: false},
                    {text: "Attack while he's vulnerable", nextSection: 84, skillCheck: false}
                ],
                action: function() {
                    gameState.foundCryptKey = true;
                    return "Vladis has given you the clue!";
                }
            },
            91: {
                text: "Having retreated from Vladis, you consider your next move.",
                choices: [
                    {text: "Try the lock again", nextSection: 74, skillCheck: false},
                    {text: "Search for clues", nextSection: 75, skillCheck: false}
                ]
            },
            92: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 84, skillCheck: false}
                ]
            },
            93: {
                text: "With the key, you approach the locked door.",
                choices: [
                    {text: "Try the key on the lock", nextSection: 94, skillCheck: false},
                    {text: "Try the combination first", nextSection: 80, skillCheck: false}
                ]
            },
            94: {
                text: "You try the crypt guardian key in the lock. It doesn't fit. This key must be for something else.",
                choices: [
                    {text: "Try the combination", nextSection: 80, skillCheck: false},
                    {text: "Search for another key", nextSection: 75, skillCheck: false}
                ],
                action: function() {
                    playSound('failure');
                    return "The key doesn't fit the lock. You'll need to find another way.";
                }
            },
            95: {
                text: "With the combination entered correctly, the lock clicks open! The heavy iron door swings inward, revealing a stone staircase descending into darkness.",
                choices: [
                    {text: "Descend the staircase", nextSection: 96, skillCheck: false}
                ],
                action: function() {
                    gameState.solvedCryptLock = true;
                    playSound('success');
                    return "The combination lock opens! The way is clear.";
                }
            },
            96: {
                text: "You descend the stone staircase. It's even longer than the previous one, winding down through the castle foundations. The air grows cold and damp, smelling of earth and decay. Finally, you reach a heavy wooden door at the bottom.",
                choices: [
                    {text: "Open the door", nextSection: 97, skillCheck: false},
                    {text: "Listen at the door first", nextSection: 98, skillCheck: false}
                ]
            },
            97: {
                text: "You push open the heavy wooden door. Moonlight streams in, and you find yourself standing in a graveyard behind Castle Vorlak! Ancient tombstones stand crooked in the earth, mist hangs low between the monuments, and the air is cold and still.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    gameState.foundGraveyardPassage = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 6;
                    saveGame();
                    
                    return "";
                }
            },
            98: {
                text: "You listen at the door. You can hear the wind whistling through stones and the occasional hoot of an owl. It sounds like you're outside.",
                choices: [
                    {text: "Open the door", nextSection: 97, skillCheck: false}
                ]
            }
        };
        
        // Initialize game for Level 5
        function initGame() {
            // Load game state from Level 4
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 5 (coming from Level 4)
                if (savedState.level === 5) {
                    Object.assign(gameState, savedState);
                    
                    // Update intro screen with loaded stats
                    document.getElementById('intro-stat-strength').textContent = gameState.strength;
                    document.getElementById('intro-stat-health').textContent = gameState.health;
                    document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('intro-stat-agility').textContent = gameState.agility;
                    document.getElementById('intro-stat-gold').textContent = gameState.gold;
                    
                    showScreen('screen-intro');
                    return;
                } else if (savedState.level === 4) {
                    // If coming directly from Level 4 without completing it
                    alert("You must complete Level 4 first!");
                    window.location.href = 'l4.html';
                    return;
                }
            } else {
                // No saved game found
                alert("No saved game found. Starting from Level 1.");
                window.location.href = 'l1.html';
                return;
            }
        }
        
        function startLevel5() {
            playSound('click');
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item) && item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Blood rune puzzle functions
        function selectRune(rune) {
            playSound('rune');
            
            // Add rune to sequence if we haven't reached 5 yet
            if (runePuzzleState.sequence.length < 5) {
                runePuzzleState.sequence.push(rune);
                
                // Update display
                let displayText = runePuzzleState.sequence.map(r => r.toUpperCase()).join(' - ');
                document.getElementById('rune-selection').textContent = displayText;
                
                // Enable attempt button when we have 5 runes
                if (runePuzzleState.sequence.length === 5) {
                    document.getElementById('try-rune-btn').disabled = false;
                }
            }
        }
        
        function tryRunePuzzle() {
            playSound('rune');
            runePuzzleState.attempts++;
            
            // Check if sequence matches solution
            let correct = true;
            for (let i = 0; i < 5; i++) {
                if (runePuzzleState.sequence[i] !== runeSolution[i]) {
                    correct = false;
                    break;
                }
            }
            
            if (correct) {
                // Puzzle solved!
                playSound('success');
                gameState.solvedBloodRunePuzzle = true;
                showScreen('screen-game');
                loadSection(64); // Door opens
                
                // Reset puzzle
                runePuzzleState.sequence = [];
                runePuzzleState.attempts = 0;
            } else {
                // Puzzle failed
                playSound('failure');
                let feedback = "The runes flash red! The sequence is incorrect.";
                
                // Give hint if player has found clues
                if (gameState.foundBloodRuneClue) {
                    feedback += " Remember: Blood, Moon, Night, Death, Eternal.";
                }
                
                document.getElementById('rune-feedback-text').textContent = feedback;
                document.getElementById('rune-feedback').style.display = 'block';
                
                // Disable attempt button until new sequence
                document.getElementById('try-rune-btn').disabled = true;
            }
        }
        
        function resetRunePuzzle() {
            playSound('click');
            runePuzzleState.sequence = [];
            document.getElementById('rune-selection').textContent = 'None selected';
            document.getElementById('rune-feedback').style.display = 'none';
            document.getElementById('try-rune-btn').disabled = true;
        }
        
        function cancelRunePuzzle() {
            playSound('click');
            showScreen('screen-game');
            loadSection(61); // Return to blood rune puzzle start
        }
        
        // Library book selection functions
        function selectBook(book) {
            playSound('book');
            bookSelection = book;
            document.getElementById('try-book-btn').disabled = false;
            
            // Update feedback
            let bookName = '';
            switch(book) {
                case 'necromancy': bookName = 'Necromancy and the Undead'; break;
                case 'vampire_origins': bookName = 'The Origins of Vampirism'; break;
                case 'graveyard_rituals': bookName = 'Graveyard Rituals and Tombs'; break;
                case 'castle_architecture': bookName = 'Castle Architecture and Secret Passages'; break;
                case 'blood_magic': bookName = 'Blood Magic and Sacrifice'; break;
            }
            
            document.getElementById('book-feedback-text').textContent = `Selected: ${bookName}`;
            document.getElementById('book-feedback').style.display = 'block';
        }
        
        function tryBookSelection() {
            playSound('book');
            
            if (bookSelection === 'graveyard_rituals') {
                // Correct book
                playSound('success');
                gameState.studiedGraveyardBook = true;
                showScreen('screen-game');
                loadSection(36); // Successfully studied the book
            } else {
                // Wrong book
                playSound('failure');
                let feedback = "You study the book but find nothing useful about accessing the graveyard passage.";
                
                if (bookSelection === 'castle_architecture') {
                    feedback = "The book mentions secret passages but not specifically to graveyards.";
                } else if (bookSelection === 'blood_magic') {
                    feedback = "The book discusses blood rituals but not passage openings.";
                }
                
                document.getElementById('book-feedback-text').textContent = feedback;
            }
        }
        
        function cancelLibraryPuzzle() {
            playSound('click');
            showScreen('screen-game');
            loadSection(38); // Return to library book examination
        }
        
        // Crypt lock functions
        function changeLockDigit(position) {
            playSound('lock');
            cryptLockState[position] = (cryptLockState[position] + 1) % 10;
            
            // Update display
            let display = cryptLockState.join('');
            document.getElementById('lock-display').textContent = display;
            
            // Update lock numbers display
            const lockNumbers = document.querySelectorAll('.lock-number');
            lockNumbers[position].textContent = cryptLockState[position];
        }
        
        function tryCryptLock() {
            playSound('lock');
            
            // Check if combination matches solution
            let correct = true;
            for (let i = 0; i < 4; i++) { // First 4 digits matter (1325)
                if (cryptLockState[i] !== cryptSolution[i]) {
                    correct = false;
                    break;
                }
            }
            
            if (correct) {
                // Lock solved!
                playSound('success');
                gameState.solvedCryptLock = true;
                showScreen('screen-game');
                loadSection(95); // Door opens
            } else {
                // Wrong combination
                playSound('failure');
                let feedback = "The lock doesn't open. The combination is incorrect.";
                
                // Give hint if player has found clues
                if (gameState.foundCryptKey) {
                    feedback += " Remember: 1347 - 22 = 1325.";
                }
                
                document.getElementById('lock-feedback-text').textContent = feedback;
                document.getElementById('lock-feedback').style.display = 'block';
            }
        }
        
        function cancelCryptLock() {
            playSound('click');
            showScreen('screen-game');
            loadSection(80); // Return to crypt lock start
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Potion' || item === 'Mountain Potion' || item === 'Ancient Vampire Wine') {
                const healAmount = item === 'Mountain Potion' ? rollDice(3, 6) + 10 : 
                                 item === 'Ancient Vampire Wine' ? rollDice(2, 8) + 5 : rollDice(2, 6) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Perfume of Eternal Youth') {
                const healAmount = rollDice(1, 4);
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>Perfume of Eternal Youth</span> and feel slightly rejuvenated, restoring ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Graveyard Passage Map') {
                message = "The <span class='item'>Graveyard Passage Map</span> shows a secret passage from the castle's second floor to the graveyard, protected by blood runes.";
            } else if (item === 'Book of Blood Magic') {
                message = "The <span class='item'>Book of Blood Magic</span> contains dark rituals and information about blood runes. It feels evil to touch.";
            } else if (item === 'Graveyard Rituals and Tombs') {
                message = "The <span class='item'>Graveyard Rituals and Tombs</span> book contains information about how vampires use graveyards to draw power.";
            } else if (item === 'The Origins of Vampirism') {
                message = "The <span class='item'>The Origins of Vampirism</span> book describes how the first vampires were created and their weaknesses.";
            } else if (item === 'Ancient Burial Shroud') {
                gameState.equippedArmor = 'Ancient Burial Shroud';
                updateInventoryDisplay();
                message = "You wear the <span class='item'>Ancient Burial Shroud</span>. It offers some protection and might help you blend in with undead creatures.";
            } else if (item === 'Silver Locket with Portrait') {
                message = "The <span class='item'>Silver Locket with Portrait</span> shows a beautiful woman with sad eyes. It might have sentimental value to someone.";
            } else if (item === 'Vampire Council Letters') {
                message = "The <span class='item'>Vampire Council Letters</span> discuss the importance of the Vorlak graveyard to Valerius's power.";
            } else if (item === 'Garlic Cloves') {
                gameState.hasGarlic = true;
                message = "The <span class='item'>Garlic Cloves</span> might repel vampires. You keep them handy.";
            } else if (item === 'Silver Cross') {
                message = "The <span class='item'>Silver Cross</span> glows with holy energy. It might repel undead creatures.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Sword' && 
                gameState.equippedArmor === 'Leather Armor') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 76 || sectionId === 83 || sectionId === 84 || sectionId === 88 || sectionId === 92);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    const goldReward = Math.floor(Math.random() * 40) + 30;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find <span class="gold">${goldReward} Gold</span> on the remains.`;
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    if (typeof choice.requirement === 'function') {
                        return choice.requirement();
                    }
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue exploring";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                let weaponType = gameState.equippedWeapon;
                
                if (weaponType.includes('Silver')) {
                    // Silver weapons deal extra damage to undead/vampires
                    damage = rollDice(2, 6) + 3;
                    if (combatState.enemyName.includes('Vampire') || combatState.enemyName.includes('Vladis')) {
                        damage += 5; // Extra vs vampires
                        resultText += `<span class="item">Your silver weapon is especially effective against vampires!</span><br>`;
                    }
                } else if (weaponType === 'Glowing Crystal Sword') {
                    damage = rollDice(3, 6); // Powerful weapon
                    resultText += `<span class="item">The glowing sword pulses with power!</span><br>`;
                } else if (weaponType === 'Ice Axe') {
                    damage = rollDice(2, 6) + 2;
                } else if (weaponType === 'Ancient Bone Dagger') {
                    damage = rollDice(2, 6) + 1;
                } else {
                    damage = rollDice(2, 6);
                }
                
                // Check for garlic against vampires
                if (gameState.hasGarlic && (combatState.enemyName.includes('Vampire') || combatState.enemyName.includes('Vladis'))) {
                    damage += 3;
                    resultText += `<span class="item">The garlic repels the vampire!</span><br>`;
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                const enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('castleUndeadGameState');
                        window.location.href = 'l1.html';
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You dodge a trap!",
                    "You move silently past a sleeping guard.",
                    "You climb to a high shelf and find something useful.",
                    "You slip through a narrow passage others would miss."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip and take 3 damage!",
                    "You make noise and alert nearby creatures.",
                    "You get tangled in curtains or debris.",
                    "You knock something over, making a loud noise."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 3;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 5 (this page)
                if (savedState.level === 5) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 5.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 6 with updated level
            gameState.level = 6;
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            // Redirect to level 6 (The Graveyard)
            window.location.href = 'l6.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
