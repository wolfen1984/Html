<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASTLE OF THE UNDEAD - Level 8: The Castle's Catacombs</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Catacombs Deep Purple/Black/Green theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(60, 0, 80, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(60, 0, 80, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #8000ff;
            background-color: #000;
            box-shadow: 0 0 20px rgba(128, 0, 255, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(60, 0, 80, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #8000ff;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #c080ff;
            text-shadow: 0 0 5px #8000ff;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #8000ff;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #8000ff;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #200;
            color: #c080ff;
            border-color: #c080ff;
        }
        
        .level-number.current {
            background-color: #8000ff;
            color: #fff;
            border-color: #c080ff;
            box-shadow: 0 0 8px #8000ff;
            text-shadow: 0 0 2px #000;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #8000ff;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #c080ff;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #8000ff;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #c080ff;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #8000ff;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #c080ff;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #c080ff;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #8000ff;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8000ff;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #c080ff;
            border-color: #c080ff;
            box-shadow: 0 0 10px rgba(192, 128, 255, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #8000ff;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #c080ff;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8000ff;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #c080ff;
            border-color: #c080ff;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #220033;
            border: 1px solid #8000ff;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #c080ff;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #330044;
            border: 1px solid #c080ff;
            padding: 10px;
            margin: 10px 0;
            color: #c080ff;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #8ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        .ghost {
            color: #aaf;
            font-weight: bold;
            text-shadow: 0 0 3px #aaf;
        }
        
        .wolf {
            color: #aaa;
            font-weight: bold;
            text-shadow: 0 0 3px #aaa;
        }
        
        .zombie {
            color: #8f8;
            font-weight: bold;
            text-shadow: 0 0 3px #8f8;
        }
        
        .skeleton {
            color: #ccc;
            font-weight: bold;
            text-shadow: 0 0 3px #ccc;
        }
        
        .wraith {
            color: #8af;
            font-weight: bold;
            text-shadow: 0 0 3px #8af;
        }
        
        .lich {
            color: #6f6;
            font-weight: bold;
            text-shadow: 0 0 3px #6f6;
        }
        
        .catacomb {
            color: #c080ff;
            font-weight: bold;
            text-shadow: 0 0 3px #c080ff;
        }
        
        .crawler {
            color: #8f6;
            font-weight: bold;
            text-shadow: 0 0 3px #8f6;
        }
        
        .specter {
            color: #f8f;
            font-weight: bold;
            text-shadow: 0 0 3px #f8f;
        }
        
        .cryptfiend {
            color: #f84;
            font-weight: bold;
            text-shadow: 0 0 3px #f84;
        }
        
        .ancient {
            color: #ff8;
            font-weight: bold;
        }
        
        .ritual {
            color: #f6f;
            font-weight: bold;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8000ff;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            fontSize: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #8000ff;
            color: #fff;
            border-color: #c080ff;
            box-shadow: 0 0 15px #8000ff;
        }
        
        /* Catacomb Map Display */
        .catacomb-map {
            background-color: #220033;
            border: 1px solid #8000ff;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.8;
            color: #c080ff;
        }
        
        .map-row {
            display: flex;
        }
        
        .map-cell {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #440066;
        }
        
        .map-cell.player {
            background-color: #c080ff;
            color: #000;
        }
        
        .map-cell.explored {
            background-color: #330044;
        }
        
        .map-cell.unexplored {
            background-color: #110022;
        }
        
        .map-cell.exit {
            background-color: #ff0;
            color: #000;
        }
        
        /* Fountain Animation */
        .fountain-animation {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #220033;
            border: 1px solid #8000ff;
            animation: pulse-purple 2s infinite;
        }
        
        @keyframes pulse-purple {
            0% { border-color: #8000ff; }
            50% { border-color: #c080ff; }
            100% { border-color: #8000ff; }
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #8000ff;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #8000ff;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #c080ff;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CASTLE OF THE UNDEAD</h1>
            <h2>LEVEL 8: THE CASTLE'S CATACOMBS</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number completed">2</div>
            <div class="level-number completed">3</div>
            <div class="level-number completed">4</div>
            <div class="level-number completed">5</div>
            <div class="level-number completed">6</div>
            <div class="level-number completed">7</div>
            <div class="level-number current">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Level Intro Screen -->
        <div id="screen-intro" class="screen active-screen">
            <h2>THE CATACOMBS</h2>
            <div class="story-text">
                <p>The massive stone door of the catacombs grinds shut behind you, sealing you in complete darkness. After a moment, faintly glowing moss begins to illuminate the passage ahead with an eerie purple light.</p>
                <p>The air is thick with the smell of damp earth, ancient stone, and something else... a metallic scent mixed with decay. Water drips somewhere in the distance, echoing through the winding tunnels.</p>
                <p>You stand at the entrance to the ancient catacombs, the oldest part of Castle Vorlak. These tunnels were carved centuries before the castle was built, used for dark rituals and as the final resting place for the earliest vampires.</p>
                <p>Somewhere deep within this maze lies the entrance to the dungeon where Valerius performs his most terrible experiments. You must navigate the catacombs' deadly guardians and ancient traps to reach him.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="intro-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="intro-stat-health" class="stat-value">0</span>/<span id="intro-stat-maxhealth" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="intro-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="intro-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="startLevel8()">ENTER THE CATACOMBS</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>ANCIENT CATACOMBS</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Catacomb Map Screen -->
        <div id="screen-map" class="screen">
            <h2>CATACOMB MAP</h2>
            <div class="story-text">
                <p>As you explore the catacombs, you piece together a mental map of the winding tunnels:</p>
                
                <div class="catacomb-map" id="catacomb-map">
                    <!-- Map will be generated here -->
                </div>
                
                <p><strong>Key:</strong> <span style="color:#c080ff">■</span> = Your Position | <span style="color:#ff0">■</span> = Exit to Dungeon | <span style="color:#330044">■</span> = Explored | <span style="color:#110022">■</span> = Unexplored</p>
                <p>You've explored <span id="explored-percent">0</span>% of the catacombs.</p>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="closeMap()">RETURN TO CATACOMBS</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL 8 COMPLETE!</h2>
            <div class="story-text">
                <p>You have navigated the deadly catacombs and found the entrance to the dungeon!</p>
                <p>A heavy iron door reinforced with dark magic stands before you. From beyond it, you hear faint screams and the clanking of chains. The air smells of blood, fear, and dark magic.</p>
                <p>This is Valerius's personal dungeon, where he conducts his most terrible experiments on both living and undead subjects. Here, he perfects his methods for creating new types of undead servants.</p>
                <p>All your stats, gold, and inventory will carry over to Level 9: The Castle's Dungeon.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #220033; border: 1px solid #8000ff;">
                    <h3 style="color: #c080ff; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">ENTER THE DUNGEON - LEVEL 9</button>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE UNDEAD - A Retro Vampire Hunt Adventure<br>
            Level 8: The Castle's Catacombs
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'catacomb':
                    playBeep(250, 0.5, 'sine');
                    setTimeout(() => playBeep(200, 0.5, 'sine'), 500);
                    break;
                case 'crawler':
                    playBeep(150, 0.2, 'square');
                    setTimeout(() => playBeep(100, 0.2, 'square'), 200);
                    break;
                case 'specter':
                    playBeep(500, 0.3, 'sine');
                    setTimeout(() => playBeep(400, 0.3, 'sine'), 300);
                    break;
                case 'cryptfiend':
                    playBeep(100, 0.4, 'sawtooth');
                    break;
                case 'water':
                    playBeep(300, 0.3, 'sine');
                    setTimeout(() => playBeep(200, 0.3, 'sine'), 300);
                    break;
                case 'ritual':
                    playBeep(800, 0.2, 'triangle');
                    setTimeout(() => playBeep(600, 0.2, 'triangle'), 200);
                    setTimeout(() => playBeep(400, 0.2, 'triangle'), 400);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - loaded from Level 7
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Rusty Sword',
            equippedArmor: 'Leather Armor',
            currentSection: 1,
            gameComplete: false,
            level: 8,
            // Level 8 specific flags
            exploredCatacombSections: [],
            catacombMap: {},
            currentPosition: {x: 2, y: 2},
            exitFound: false,
            exitPosition: {x: 8, y: 8},
            // Encounters
            ancientGuardianDefeated: false,
            bloodFountainUsed: false,
            ritualChamberSolved: false,
            specterPuzzleSolved: false,
            cryptfiendNestCleared: false,
            // Special items
            hasAncientKey: false,
            hasCryptMap: false,
            hasPurpleMoss: false,
            hasRitualDagger: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            isGroup: false,
            groupCount: 0
        };
        
        // Random event tracking
        let randomEvents = {
            whispersHeard: 0,
            waterDrips: false,
            mossGlow: false,
            coldTouch: false
        };
        
        // Catacomb map generation
        function generateCatacombMap() {
            const map = [];
            const width = 11;
            const height = 11;
            
            // Initialize empty map
            for (let y = 0; y < height; y++) {
                map[y] = [];
                for (let x = 0; x < width; x++) {
                    map[y][x] = {
                        explored: false,
                        type: 'tunnel',
                        connections: []
                    };
                }
            }
            
            // Create main path to exit
            let x = 2, y = 2;
            const path = [];
            
            while (x < width - 3 || y < height - 3) {
                path.push({x, y});
                
                if (Math.random() > 0.5 && x < width - 3) {
                    x++;
                } else if (y < height - 3) {
                    y++;
                }
            }
            
            // Add exit at end
            gameState.exitPosition = {x, y};
            map[y][x].type = 'exit';
            
            // Add some branches
            for (let i = 0; i < 5; i++) {
                const branchStart = path[Math.floor(Math.random() * path.length)];
                let bx = branchStart.x;
                let by = branchStart.y;
                const branchLength = Math.floor(Math.random() * 4) + 2;
                
                for (let j = 0; j < branchLength; j++) {
                    if (Math.random() > 0.5 && bx > 1) {
                        bx--;
                    } else if (by > 1) {
                        by--;
                    }
                    if (bx >= 0 && bx < width && by >= 0 && by < height) {
                        path.push({x: bx, y: by});
                    }
                }
            }
            
            // Mark all path cells as tunnel
            path.forEach(pos => {
                if (pos.x >= 0 && pos.x < width && pos.y >= 0 && pos.y < height) {
                    map[pos.y][pos.x].type = 'tunnel';
                }
            });
            
            // Add some special rooms
            const specialRooms = [
                {x: 4, y: 1, type: 'guardian'},
                {x: 1, y: 4, type: 'fountain'},
                {x: 7, y: 3, type: 'ritual'},
                {x: 3, y: 7, type: 'nest'},
                {x: 9, y: 5, type: 'library'}
            ];
            
            specialRooms.forEach(room => {
                if (room.x >= 0 && room.x < width && room.y >= 0 && room.y < height) {
                    map[room.y][room.x].type = room.type;
                }
            });
            
            gameState.catacombMap = map;
            return map;
        }
        
        // Game story sections for Level 8
        const storySections = {
            1: {
                text: "You stand at the entrance to the catacombs. The tunnel stretches ahead into darkness, illuminated only by faintly glowing purple moss on the walls. The air is cold and damp. You can hear water dripping somewhere in the distance.",
                choices: [
                    {text: "Follow the main tunnel forward", nextSection: 2, skillCheck: false},
                    {text: "Check the side passages", nextSection: 3, skillCheck: false},
                    {text: "Examine the glowing moss", nextSection: 4, skillCheck: false},
                    {text: "Try to map the catacombs in your mind", nextSection: 5, skillCheck: true, checkType: 'agility', difficulty: 14}
                ],
                action: function() {
                    // Record starting position as explored
                    const posKey = `${gameState.currentPosition.x},${gameState.currentPosition.y}`;
                    if (!gameState.exploredCatacombSections.includes(posKey)) {
                        gameState.exploredCatacombSections.push(posKey);
                    }
                    
                    // Random catacomb sounds
                    if (Math.random() > 0.7) {
                        randomEvents.waterDrips = true;
                        playSound('water');
                        return "<br><span class='catacomb'>The sound of dripping water echoes through the tunnels.</span>";
                    }
                    return "";
                }
            },
            2: {
                text: "You follow the main tunnel deeper into the catacombs. The passage widens, and you enter a chamber with multiple branching tunnels. Strange carvings cover the walls, depicting ancient vampire rituals.",
                choices: [
                    {text: "Take the left tunnel", nextSection: 6, skillCheck: false},
                    {text: "Take the center tunnel", nextSection: 7, skillCheck: false},
                    {text: "Take the right tunnel", nextSection: 8, skillCheck: false},
                    {text: "Examine the carvings", nextSection: 9, skillCheck: false}
                ],
                action: function() {
                    playSound('catacomb');
                    return "A cold draft whispers through the tunnels, carrying with it the scent of ancient dust.";
                }
            },
            3: {
                text: "You investigate the side passages. One leads to a small alcove containing ancient bones. Another seems to have collapsed long ago. A third passage is partially flooded with dark, stagnant water.",
                choices: [
                    {text: "Search the bone alcove", nextSection: 10, skillCheck: false},
                    {text: "Try to clear the collapsed passage", nextSection: 11, skillCheck: true, checkType: 'strength', difficulty: 16},
                    {text: "Wade through the flooded passage", nextSection: 12, skillCheck: false},
                    {text: "Return to the main entrance", nextSection: 1, skillCheck: false}
                ]
            },
            4: {
                text: "The glowing moss emits a soft purple light. When you touch it, it feels cold and slightly damp. The glow intensifies briefly at your touch, then returns to normal.",
                choices: [
                    {text: "Collect some moss", nextSection: 13, skillCheck: false},
                    {text: "Follow where the moss is thickest", nextSection: 14, skillCheck: false},
                    {text: "Return to exploring", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    randomEvents.mossGlow = true;
                    playSound('item');
                    return "";
                }
            },
            5: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.hasCryptMap = true;
                        addToInventory('Mental Catacomb Map');
                        playSound('success');
                        return "You successfully create a mental map of the catacomb layout. This will help you navigate.";
                    } else {
                        playSound('failure');
                        return "The twisting tunnels are too confusing. You can't form a clear mental map.";
                    }
                }
            },
            6: {
                text: "The left tunnel descends steeply. The air grows colder as you descend. At the bottom, you find a chamber sealed with a stone door carved with ancient vampire runes.",
                choices: [
                    {text: "Try to open the stone door", nextSection: 16, skillCheck: true, checkType: 'strength', difficulty: 18},
                    {text: "Examine the runes", nextSection: 17, skillCheck: false},
                    {text: "Return to the main chamber", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    playSound('catacomb');
                    return "The runes glow faintly as you approach.";
                }
            },
            7: {
                text: "The center tunnel leads to a vast underground chamber. In the center stands a stone statue of an ancient vampire warrior, its eyes glowing with purple light. The statue turns its head to look at you!",
                choices: [
                    {text: "Approach the statue", nextSection: 18, skillCheck: false},
                    {text: "Search the chamber", nextSection: 19, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Attack the statue", nextSection: 20, skillCheck: false},
                    {text: "Retreat quickly", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    playSound('catacomb');
                    return "<span class='ancient'>Ancient Guardian Statue</span>: 'Who dares disturb the resting place of the ancients?'";
                }
            },
            8: {
                text: "The right tunnel winds through narrow passages. You hear skittering sounds ahead. As you round a corner, you see several pale, multi-legged creatures crawling on the walls and ceiling.",
                choices: [
                    {text: "Attack the creatures", nextSection: 21, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 22, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Throw something to distract them", nextSection: 23, skillCheck: false},
                    {text: "Retreat", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    playSound('crawler');
                    return "<span class='crawler'>Catacomb Crawlers</span> skitter across the walls, their many legs clicking against stone.";
                }
            },
            9: {
                text: "The carvings show ancient vampires performing rituals with human sacrifices. One sequence shows a ritual to transfer a vampire's essence into a new body. Another shows the creation of the first vampires from mortal sorcerers.",
                choices: [
                    {text: "Study the ritual details", nextSection: 24, skillCheck: false},
                    {text: "Look for hidden compartments", nextSection: 25, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Return to tunnel selection", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    return "The carvings are incredibly detailed, telling a dark history you wish you didn't know.";
                }
            },
            10: {
                text: "The bone alcove contains the skeletal remains of several adventurers. Their equipment lies scattered around them, rusted and decayed with age.",
                choices: [
                    {text: "Search the remains", nextSection: 26, skillCheck: false},
                    {text: "Take any usable equipment", nextSection: 27, skillCheck: false},
                    {text: "Return to the side passages", nextSection: 3, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "These poor souls never made it out of the catacombs...";
                }
            },
            11: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        const goldFound = rollDice(3, 10);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        return "You clear the rubble and find a hidden passage behind it! Within, you discover <span class='gold'>" + goldFound + " Gold</span>.";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The rubble shifts and falls on you, dealing " + damage + " damage.";
                    }
                }
            },
            12: {
                text: "You wade through the dark, stagnant water. It comes up to your knees and smells foul. Something brushes against your leg beneath the surface.",
                choices: [
                    {text: "Quickly cross to the other side", nextSection: 29, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Search the water", nextSection: 30, skillCheck: false},
                    {text: "Return to dry land", nextSection: 3, skillCheck: false}
                ],
                action: function() {
                    playSound('water');
                    return "The water is ice cold and unnaturally still.";
                }
            },
            13: {
                text: "You carefully collect some of the glowing moss. It continues to emit light in your hand, though the glow seems to be fading slowly.",
                choices: [
                    {text: "Follow where the moss is thickest", nextSection: 14, skillCheck: false},
                    {text: "Return to exploring", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.hasPurpleMoss = true;
                    addToInventory('Glowing Purple Moss');
                    playSound('item');
                    return "You collect some <span class='item'>Glowing Purple Moss</span>. It provides faint illumination.";
                }
            },
            14: {
                text: "You follow where the moss grows thickest. It leads to a hidden chamber where the walls are completely covered in the glowing moss, illuminating the room with a bright purple light. In the center of the room stands an ancient stone altar.",
                choices: [
                    {text: "Examine the altar", nextSection: 31, skillCheck: false},
                    {text: "Search the moss-covered walls", nextSection: 32, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The chamber is breathtakingly beautiful in an eerie, unnatural way.";
                }
            },
            15: {
                text: "After your mapping attempt, you return to exploring the entrance.",
                choices: [
                    {text: "Follow the main tunnel forward", nextSection: 2, skillCheck: false},
                    {text: "Check the side passages", nextSection: 3, skillCheck: false}
                ]
            },
            16: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With great effort, you force the stone door open! It groans in protest but yields.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The door doesn't budge. You strain yourself, taking " + damage + " damage.";
                    }
                }
            },
            17: {
                text: "The runes are written in ancient vampire script. You recognize some symbols from the carvings in the main chamber. They seem to be a warning: 'Here rests the First. Disturb not his slumber.'",
                choices: [
                    {text: "Try to open the door anyway", nextSection: 16, skillCheck: false},
                    {text: "Return to the main chamber", nextSection: 2, skillCheck: false}
                ]
            },
            18: {
                text: "As you approach the statue, it speaks in a deep, echoing voice: <span class='ancient'>'I am guardian of these catacombs. To pass, you must prove your worth or your purpose.'</span>",
                choices: [
                    {text: "Say you seek to destroy Valerius", nextSection: 34, skillCheck: false},
                    {text: "Challenge the guardian to combat", nextSection: 20, skillCheck: false},
                    {text: "Try to find another way around", nextSection: 35, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Show any ancient artifacts you have", nextSection: 36, skillCheck: false}
                ]
            },
            19: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 37, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        const goldFound = rollDice(4, 10);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        return "You find a hidden compartment behind the statue containing <span class='gold'>" + goldFound + " Gold</span> and an ancient key.";
                    } else {
                        // Guardian notices and attacks
                        combatState.active = true;
                        combatState.enemyName = "Ancient Stone Guardian";
                        combatState.enemyHealth = 100;
                        combatState.enemyCurrentHealth = 100;
                        combatState.enemyStrength = 18;
                        combatState.enemyDamageDice = 3;
                        combatState.enemyDamageSides = 8;
                        combatState.nextSection = 38;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('catacomb');
                        return "The guardian notices you searching!<br><br><span class='ancient'>Ancient Stone Guardian</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            20: {
                text: "You attack the stone guardian! It comes to life, stone grinding against stone as it moves.",
                choices: [
                    {text: "Fight the guardian", nextSection: 39, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Ancient Stone Guardian";
                    combatState.enemyHealth = 100;
                    combatState.enemyCurrentHealth = 100;
                    combatState.enemyStrength = 18;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 40;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('catacomb');
                    return "<span class='ancient'>Ancient Stone Guardian</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            21: {
                text: "You attack the catacomb crawlers! They skitter toward you with surprising speed.",
                choices: [
                    {text: "Fight the crawlers", nextSection: 41, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Catacomb Crawlers";
                    combatState.enemyHealth = 60;
                    combatState.enemyCurrentHealth = 60;
                    combatState.enemyStrength = 12;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 42;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 4;
                    
                    playSound('crawler');
                    return "<span class='crawler'>Catacomb Crawlers (4)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            22: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 43, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You move silently past the crawlers. They continue their skittering, unaware of your presence.";
                    } else {
                        // Crawlers attack
                        combatState.active = true;
                        combatState.enemyName = "Alerted Crawlers";
                        combatState.enemyHealth = 45;
                        combatState.enemyCurrentHealth = 45;
                        combatState.enemyStrength = 11;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 44;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 3;
                        
                        playSound('crawler');
                        return "The crawlers notice you!<br><br><span class='crawler'>Alerted Crawlers (3)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            23: {
                text: "You throw a stone down another passage. The crawlers skitter after the sound, giving you a chance to pass.",
                choices: [
                    {text: "Quickly move through", nextSection: 45, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The distraction works! You slip past while the crawlers investigate the noise.";
                }
            },
            24: {
                text: "The ritual details are complex. They describe a process of blood magic that can grant immortality, but at a terrible cost. The ritual requires the heart's blood of a pure soul and the willing sacrifice of the recipient's humanity.",
                choices: [
                    {text: "Look for hidden compartments", nextSection: 25, skillCheck: false},
                    {text: "Return to tunnel selection", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Ritual Knowledge');
                    playSound('item');
                    return "You gain valuable knowledge about vampire rituals. This might help you understand Valerius's methods.";
                }
            },
            25: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(5, 10);
                        gameState.gold += goldFound;
                        addToInventory('Ancient Ritual Dagger');
                        gameState.hasRitualDagger = true;
                        updateStatsDisplay();
                        playSound('item');
                        return "You find a hidden compartment! Inside is <span class='gold'>" + goldFound + " Gold</span> and an <span class='item'>Ancient Ritual Dagger</span>.";
                    } else {
                        playSound('failure');
                        return "You find no hidden compartments.";
                    }
                }
            },
            26: {
                text: "You search the skeletal remains. They've been picked clean by whatever lives in these catacombs. Among the bones, you find a few items that might still be useful.",
                choices: [
                    {text: "Take any usable items", nextSection: 27, skillCheck: false},
                    {text: "Return to the side passages", nextSection: 3, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(2, 10);
                    gameState.gold += goldFound;
                    addToInventory('Rusted Adventurer Medallion');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Rusted Adventurer Medallion</span>.";
                }
            },
            27: {
                text: "You take whatever might still be useful from the remains.",
                choices: [
                    {text: "Return to the side passages", nextSection: 3, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Old Adventurer Rope');
                    playSound('item');
                    return "You take an <span class='item'>Old Adventurer Rope</span>. It's frayed but might still hold.";
                }
            },
            28: {
                text: "After dealing with the collapsed passage, you return to the side passages.",
                choices: [
                    {text: "Search the bone alcove", nextSection: 10, skillCheck: false},
                    {text: "Wade through the flooded passage", nextSection: 12, skillCheck: false},
                    {text: "Return to the main entrance", nextSection: 1, skillCheck: false}
                ]
            },
            29: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You quickly cross the flooded passage without incident.";
                    } else {
                        // Something in the water attacks
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "Something grabs your leg from beneath the water! You struggle free, taking " + damage + " damage.";
                    }
                }
            },
            30: {
                text: "You search the dark water with your hands. Your fingers brush against something solid and metallic.",
                choices: [
                    {text: "Retrieve the object", nextSection: 48, skillCheck: false},
                    {text: "Leave it and cross", nextSection: 29, skillCheck: false}
                ],
                action: function() {
                    playSound('water');
                    return "The water is unnaturally cold, making your fingers go numb.";
                }
            },
            31: {
                text: "The stone altar is carved with intricate patterns that match the carvings in the main chamber. The surface is stained dark in the center. A single item lies upon the altar.",
                choices: [
                    {text: "Take the item", nextSection: 49, skillCheck: false},
                    {text: "Examine the altar more closely", nextSection: 50, skillCheck: false},
                    {text: "Search the moss-covered walls", nextSection: 32, skillCheck: false}
                ]
            },
            32: {
                text: "Behind the thick moss, you find a hidden niche containing ancient scrolls. They're written in the same vampire script as the carvings.",
                choices: [
                    {text: "Take the scrolls", nextSection: 51, skillCheck: false},
                    {text: "Examine the altar", nextSection: 31, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Ancient Vampire Scrolls');
                    playSound('item');
                    return "You take the <span class='item'>Ancient Vampire Scrolls</span>. They might contain valuable knowledge.";
                }
            },
            33: {
                text: "The stone door opens into a burial chamber. In the center lies a stone sarcophagus. The air here is deathly still.",
                choices: [
                    {text: "Open the sarcophagus", nextSection: 52, skillCheck: true, checkType: 'strength', difficulty: 16},
                    {text: "Search the chamber", nextSection: 53, skillCheck: false},
                    {text: "Leave and seal the door", nextSection: 54, skillCheck: false}
                ]
            },
            34: {
                text: "<span class='ancient'>'Valerius...'</span> the guardian rumbles. <span class='ancient'>'He defiles the ancient ways. He seeks power not for preservation, but for domination. For your purpose, I grant you passage. But be warned: deeper dangers await.'</span>",
                choices: [
                    {text: "Ask about the deeper dangers", nextSection: 55, skillCheck: false},
                    {text: "Thank the guardian and pass", nextSection: 56, skillCheck: false},
                    {text: "Ask for aid against Valerius", nextSection: 57, skillCheck: false}
                ],
                action: function() {
                    gameState.ancientGuardianDefeated = true; // Not defeated, but passed
                    playSound('catacomb');
                    return "";
                }
            },
            35: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You find a hidden passage behind a tapestry of stone! It bypasses the guardian chamber entirely.";
                    } else {
                        // Guardian notices and attacks
                        combatState.active = true;
                        combatState.enemyName = "Angered Stone Guardian";
                        combatState.enemyHealth = 80;
                        combatState.enemyCurrentHealth = 80;
                        combatState.enemyStrength = 16;
                        combatState.enemyDamageDice = 3;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 59;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('catacomb');
                        return "The guardian notices your attempt to sneak around!<br><br><span class='ancient'>Angered Stone Guardian</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            36: {
                text: "You show the ancient artifacts you've collected to the guardian.",
                choices: [
                    {text: "Show Valerius Signet Ring if you have it", nextSection: 60, skillCheck: false, requirement: 'Valerius Signet Ring'},
                    {text: "Show Ancient Vampire Amulet if you have it", nextSection: 61, skillCheck: false, requirement: 'Ancient Vampire Amulet'},
                    {text: "Show Skeleton King Crown if you have it", nextSection: 62, skillCheck: false, requirement: 'Skeleton King Crown'},
                    {text: "Return to other options", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    // This will be handled by the specific choice
                    return "";
                }
            },
            37: {
                text: "After searching the chamber, you return to dealing with the guardian.",
                choices: [
                    {text: "Approach the statue", nextSection: 18, skillCheck: false},
                    {text: "Attack the statue", nextSection: 20, skillCheck: false}
                ]
            },
            38: {
                text: "With the guardian defeated, it crumbles into a pile of rubble. The chamber is now clear.",
                choices: [
                    {text: "Search the rubble", nextSection: 63, skillCheck: false},
                    {text: "Continue through the chamber", nextSection: 64, skillCheck: false}
                ],
                action: function() {
                    gameState.ancientGuardianDefeated = true;
                    const goldFound = rollDice(8, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "The guardian crumbles! You find <span class='gold'>" + goldFound + " Gold</span> within the rubble.";
                }
            },
            39: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 65, skillCheck: false}
                ]
            },
            40: {
                text: "With the stone guardian defeated, you can now pass through the chamber.",
                choices: [
                    {text: "Search the chamber", nextSection: 66, skillCheck: false},
                    {text: "Continue deeper into the catacombs", nextSection: 67, skillCheck: false}
                ],
                action: function() {
                    gameState.ancientGuardianDefeated = true;
                    const goldFound = rollDice(10, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "The guardian is destroyed! You find <span class='gold'>" + goldFound + " Gold</span> in the chamber.";
                }
            },
            41: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 68, skillCheck: false}
                ]
            },
            42: {
                text: "With the crawlers defeated, you can continue down the tunnel.",
                choices: [
                    {text: "Search the area", nextSection: 69, skillCheck: false},
                    {text: "Continue down the tunnel", nextSection: 70, skillCheck: false}
                ],
                action: function() {
                    gameState.cryptfiendNestCleared = true;
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "The crawlers are defeated! You find <span class='gold'>" + goldFound + " Gold</span> in a nearby niche.";
                }
            },
            43: {
                text: "Having slipped past the crawlers, you continue down the tunnel.",
                choices: [
                    {text: "Continue exploring", nextSection: 70, skillCheck: false},
                    {text: "Return to the main chamber", nextSection: 2, skillCheck: false}
                ]
            },
            44: {
                text: "With the alerted crawlers defeated, you can continue.",
                choices: [
                    {text: "Search the area", nextSection: 69, skillCheck: false},
                    {text: "Continue down the tunnel", nextSection: 70, skillCheck: false}
                ],
                action: function() {
                    gameState.cryptfiendNestCleared = true;
                    const goldFound = rollDice(2, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the crawlers and find <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            45: {
                text: "You successfully bypass the crawlers and continue down the tunnel.",
                choices: [
                    {text: "Continue exploring", nextSection: 70, skillCheck: false},
                    {text: "Return to the main chamber", nextSection: 2, skillCheck: false}
                ]
            },
            46: {
                text: "After examining the carvings, you return to tunnel selection.",
                choices: [
                    {text: "Take the left tunnel", nextSection: 6, skillCheck: false},
                    {text: "Take the center tunnel", nextSection: 7, skillCheck: false},
                    {text: "Take the right tunnel", nextSection: 8, skillCheck: false}
                ]
            },
            47: {
                text: "You emerge from the flooded passage into a dry tunnel. The air here is slightly warmer, and you can hear faint chanting in the distance.",
                choices: [
                    {text: "Follow the chanting", nextSection: 71, skillCheck: false},
                    {text: "Explore the dry tunnel", nextSection: 72, skillCheck: false},
                    {text: "Return through the flooded passage", nextSection: 12, skillCheck: false}
                ]
            },
            48: {
                text: "You retrieve a metal object from the water. It's a heavy iron key, rusted but still solid.",
                choices: [
                    {text: "Keep the key and cross", nextSection: 29, skillCheck: false}
                ],
                action: function() {
                    gameState.hasAncientKey = true;
                    addToInventory('Ancient Iron Key');
                    playSound('item');
                    return "You retrieve an <span class='item'>Ancient Iron Key</span> from the water. It might unlock something important.";
                }
            },
            49: {
                text: "You take the item from the altar. It's a crystal vial filled with a dark liquid that seems to absorb light.",
                choices: [
                    {text: "Examine the altar more closely", nextSection: 50, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Vial of Ancient Blood');
                    playSound('item');
                    return "You take a <span class='item'>Vial of Ancient Blood</span>. It feels cold and heavy in your hand.";
                }
            },
            50: {
                text: "The altar's carvings show a ritual where this blood is used to empower vampires or create new ones. The stains suggest this altar has been used recently.",
                choices: [
                    {text: "Take the vial", nextSection: 49, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 1, skillCheck: false}
                ]
            },
            51: {
                text: "With the scrolls in hand, you examine the altar.",
                choices: [
                    {text: "Examine the altar", nextSection: 31, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 1, skillCheck: false}
                ]
            },
            52: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 73, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(6, 10);
                        gameState.gold += goldFound;
                        addToInventory('Ancient Vampire Lord Ring');
                        updateStatsDisplay();
                        playSound('item');
                        return "You open the sarcophagus! Inside, you find <span class='gold'>" + goldFound + " Gold</span> and an <span class='item'>Ancient Vampire Lord Ring</span>.";
                    } else {
                        playSound('failure');
                        return "The sarcophagus lid is too heavy. You cannot budge it.";
                    }
                }
            },
            53: {
                text: "You search the burial chamber. In addition to the sarcophagus, you find burial offerings and ancient artifacts.",
                choices: [
                    {text: "Take the offerings", nextSection: 74, skillCheck: false},
                    {text: "Try to open the sarcophagus", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> among the burial offerings.";
                }
            },
            54: {
                text: "You decide not to disturb the ancient burial and seal the door behind you.",
                choices: [
                    {text: "Return to the main chamber", nextSection: 2, skillCheck: false}
                ]
            },
            55: {
                text: "<span class='ancient'>'The catacombs hold ancient evils that even Valerius fears,'</span> the guardian explains. <span class='ancient'>'Specters of the first vampires, cryptfiends that feed on magic, and a blood fountain that grants power but demands sacrifice. Tread carefully.'</span>",
                choices: [
                    {text: "Thank the guardian and pass", nextSection: 56, skillCheck: false},
                    {text: "Ask for aid against Valerius", nextSection: 57, skillCheck: false}
                ]
            },
            56: {
                text: "The guardian steps aside, allowing you to pass. <span class='ancient'>'May the ancients watch over you, mortal.'</span>",
                choices: [
                    {text: "Continue deeper into the catacombs", nextSection: 67, skillCheck: false}
                ],
                action: function() {
                    gameState.ancientGuardianDefeated = true;
                    playSound('success');
                    return "";
                }
            },
            57: {
                text: "<span class='ancient'>'I cannot leave my post,'</span> the guardian says. <span class='ancient'>'But take this knowledge: Valerius draws power from the blood fountain in the deepest chamber. Destroy it, and you weaken him greatly.'</span>",
                choices: [
                    {text: "Thank the guardian and pass", nextSection: 56, skillCheck: false}
                ]
            },
            58: {
                text: "After your attempt to bypass the guardian, you find yourself in a new tunnel.",
                choices: [
                    {text: "Continue exploring", nextSection: 75, skillCheck: false},
                    {text: "Try to find your way back", nextSection: 2, skillCheck: false}
                ]
            },
            59: {
                text: "With the guardian defeated, you can continue.",
                choices: [
                    {text: "Continue deeper into the catacombs", nextSection: 67, skillCheck: false}
                ],
                action: function() {
                    gameState.ancientGuardianDefeated = true;
                    const goldFound = rollDice(6, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the guardian and find <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            60: {
                text: "<span class='ancient'>'The signet of the current lord...'</span> the guardian muses. <span class='ancient'>'This grants you authority in these catacombs. You may pass, but remember: authority comes with responsibility.'</span>",
                choices: [
                    {text: "Thank the guardian and pass", nextSection: 56, skillCheck: false}
                ],
                action: function() {
                    gameState.ancientGuardianDefeated = true;
                    playSound('success');
                    return "";
                }
            },
            61: {
                text: "<span class='ancient'>'An amulet of the ancients...'</span> the guardian says. <span class='ancient'>'You have shown respect for our ways. You may pass.'</span>",
                choices: [
                    {text: "Thank the guardian and pass", nextSection: 56, skillCheck: false}
                ],
                action: function() {
                    gameState.ancientGuardianDefeated = true;
                    playSound('success');
                    return "";
                }
            },
            62: {
                text: "<span class='ancient'>'The crown of a vampire king...'</span> the guardian rumbles. <span class='ancient'>'You have proven yourself worthy. Pass with our blessing.'</span>",
                choices: [
                    {text: "Thank the guardian and pass", nextSection: 56, skillCheck: false}
                ],
                action: function() {
                    gameState.ancientGuardianDefeated = true;
                    playSound('success');
                    return "";
                }
            },
            63: {
                text: "You search through the rubble of the defeated guardian.",
                choices: [
                    {text: "Continue through the chamber", nextSection: 64, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Guardian Stone Shard');
                    playSound('item');
                    return "You find a <span class='item'>Guardian Stone Shard</span> that still pulses with faint magic.";
                }
            },
            64: {
                text: "You pass through the guardian chamber and into the deeper catacombs.",
                choices: [
                    {text: "Continue forward", nextSection: 67, skillCheck: false}
                ]
            },
            65: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 39, skillCheck: false}
                ]
            },
            66: {
                text: "You search the guardian chamber thoroughly.",
                choices: [
                    {text: "Continue deeper into the catacombs", nextSection: 67, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Ancient Guardian Core');
                    playSound('item');
                    return "You find an <span class='item'>Ancient Guardian Core</span> - a magical crystal that was the guardian's power source.";
                }
            },
            67: {
                text: "You enter the deeper sections of the catacombs. The tunnels here are older, with more elaborate carvings. The air feels heavier, charged with ancient magic.",
                choices: [
                    {text: "Follow the main tunnel", nextSection: 76, skillCheck: false},
                    {text: "Take a side passage to the left", nextSection: 77, skillCheck: false},
                    {text: "Take a side passage to the right", nextSection: 78, skillCheck: false},
                    {text: "Check your map if you have one", nextSection: 79, skillCheck: false, requirement: function() { return gameState.hasCryptMap; }}
                ]
            },
            68: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 41, skillCheck: false}
                ]
            },
            69: {
                text: "You search the area where the crawlers were nesting.",
                choices: [
                    {text: "Continue down the tunnel", nextSection: 70, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Crawler Carapace');
                    playSound('item');
                    return "You collect a <span class='item'>Crawler Carapace</span> - the hard shell might be useful for armor.";
                }
            },
            70: {
                text: "The tunnel continues deeper, eventually opening into a large chamber with a pool of dark water in the center. The water glows with a faint purple light.",
                choices: [
                    {text: "Examine the pool", nextSection: 80, skillCheck: false},
                    {text: "Search the chamber", nextSection: 81, skillCheck: false},
                    {text: "Continue past the pool", nextSection: 82, skillCheck: false}
                ],
                action: function() {
                    playSound('water');
                    return "The pool's surface is perfectly still, reflecting the glowing moss on the ceiling.";
                }
            },
            71: {
                text: "You follow the chanting to a ritual chamber. Several spectral figures hover around a central altar, performing an ancient ritual. They haven't noticed you yet.",
                choices: [
                    {text: "Observe the ritual", nextSection: 83, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Interrupt the ritual", nextSection: 84, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 85, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Retreat", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    playSound('ritual');
                    return "<span class='specter'>Spectral Ritualists</span> chant in an ancient tongue, their ghostly forms shifting around the altar.";
                }
            },
            72: {
                text: "The dry tunnel leads to a series of ancient burial niches. Each contains skeletal remains and burial offerings from different eras of vampire history.",
                choices: [
                    {text: "Search the burial niches", nextSection: 86, skillCheck: false},
                    {text: "Follow the chanting", nextSection: 71, skillCheck: false},
                    {text: "Return to the flooded passage", nextSection: 47, skillCheck: false}
                ]
            },
            73: {
                text: "After opening the sarcophagus, you search the burial chamber.",
                choices: [
                    {text: "Search the chamber", nextSection: 53, skillCheck: false},
                    {text: "Leave and seal the door", nextSection: 54, skillCheck: false}
                ]
            },
            74: {
                text: "After taking the offerings, you leave the burial chamber.",
                choices: [
                    {text: "Return to the main chamber", nextSection: 2, skillCheck: false}
                ]
            },
            75: {
                text: "You find yourself in an unfamiliar section of the catacombs. The tunnels here are narrow and twisting.",
                choices: [
                    {text: "Try to find your bearings", nextSection: 87, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Follow the sound of water", nextSection: 88, skillCheck: false},
                    {text: "Follow the faint light ahead", nextSection: 89, skillCheck: false}
                ]
            },
            76: {
                text: "The main tunnel leads to a crossroads with three massive stone arches. Each arch is carved with different symbols: a bat, a skull, and a droplet of blood.",
                choices: [
                    {text: "Take the bat arch", nextSection: 90, skillCheck: false},
                    {text: "Take the skull arch", nextSection: 91, skillCheck: false},
                    {text: "Take the blood droplet arch", nextSection: 92, skillCheck: false},
                    {text: "Examine the arches more closely", nextSection: 93, skillCheck: false}
                ],
                action: function() {
                    playSound('catacomb');
                    return "A faint humming sound emanates from the arches, as if they're charged with magic.";
                }
            },
            77: {
                text: "The left passage leads to a chamber filled with strange, pulsating fungi. The fungi emit a soft glow and release spores into the air.",
                choices: [
                    {text: "Examine the fungi", nextSection: 94, skillCheck: false},
                    {text: "Try to harvest some fungi", nextSection: 95, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Avoid the fungi and continue", nextSection: 96, skillCheck: false},
                    {text: "Return to the main tunnel", nextSection: 67, skillCheck: false}
                ]
            },
            78: {
                text: "The right passage leads downward to a chamber that feels unnaturally cold. Frost covers the walls, and your breath fogs in the air. In the center of the chamber, a spectral figure hovers.",
                choices: [
                    {text: "Approach the spectral figure", nextSection: 97, skillCheck: false},
                    {text: "Search the frost-covered chamber", nextSection: 98, skillCheck: false},
                    {text: "Retreat from the cold", nextSection: 67, skillCheck: false}
                ],
                action: function() {
                    playSound('specter');
                    return "<span class='specter'>The spectral figure</span> turns toward you, its form shifting like mist in the cold air.";
                }
            },
            79: {
                text: "You consult your mental map of the catacombs.",
                choices: [
                    {text: "View the catacomb map", nextSection: 99, skillCheck: false},
                    {text: "Return to exploring", nextSection: 67, skillCheck: false}
                ]
            },
            80: {
                text: "The pool is filled with dark, still water that glows from within. Looking closely, you see that the glow comes from crystals at the bottom of the pool. The water has a metallic scent.",
                choices: [
                    {text: "Drink from the pool", nextSection: 100, skillCheck: false},
                    {text: "Collect some water", nextSection: 101, skillCheck: false},
                    {text: "Try to retrieve a crystal", nextSection: 102, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Continue past the pool", nextSection: 82, skillCheck: false}
                ],
                action: function() {
                    return "The pool seems magical, but whether its magic is beneficial or cursed is unclear.";
                }
            },
            81: {
                text: "You search the chamber around the pool. In a corner, you find a small alcove containing ancient offerings left for whatever spirit guards this place.",
                choices: [
                    {text: "Take the offerings", nextSection: 103, skillCheck: false},
                    {text: "Examine the pool", nextSection: 80, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> among the offerings.";
                }
            },
            82: {
                text: "You bypass the pool and continue down the tunnel. It eventually leads to a spiral staircase leading downward.",
                choices: [
                    {text: "Descend the staircase", nextSection: 104, skillCheck: false},
                    {text: "Return to the pool chamber", nextSection: 70, skillCheck: false}
                ]
            },
            83: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 105, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You observe the ritual unnoticed. The specters are attempting to commune with an ancient vampire spirit. You learn the ritual's patterns, which might be useful.";
                    } else {
                        // Specters notice you
                        combatState.active = true;
                        combatState.enemyName = "Spectral Ritualists";
                        combatState.enemyHealth = 70;
                        combatState.enemyCurrentHealth = 70;
                        combatState.enemyStrength = 14;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 8;
                        combatState.nextSection = 106;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 3;
                        
                        playSound('specter');
                        return "The specters notice you!<br><br><span class='specter'>Spectral Ritualists (3)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            84: {
                text: "You interrupt the ritual! The spectral figures turn toward you, their chanting turning to angry whispers.",
                choices: [
                    {text: "Fight the specters", nextSection: 107, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Angered Spectral Ritualists";
                    combatState.enemyHealth = 80;
                        combatState.enemyCurrentHealth = 80;
                        combatState.enemyStrength = 15;
                        combatState.enemyDamageDice = 3;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 108;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 3;
                        
                        playSound('specter');
                        return "<span class='specter'>Angered Spectral Ritualists (3)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                },
            85: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 109, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip past the ritual chamber unnoticed. The specters continue their chanting, unaware of your presence.";
                    } else {
                        // Specters notice
                        combatState.active = true;
                        combatState.enemyName = "Spectral Watchers";
                        combatState.enemyHealth = 50;
                        combatState.enemyCurrentHealth = 50;
                        combatState.enemyStrength = 12;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 110;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 2;
                        
                        playSound('specter');
                        return "Two specters break off from the ritual to investigate!<br><br><span class='specter'>Spectral Watchers (2)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            86: {
                text: "You search the burial niches. Each contains artifacts from different eras - ancient coins, rusted weapons, tattered scrolls.",
                choices: [
                    {text: "Take anything valuable", nextSection: 111, skillCheck: false},
                    {text: "Follow the chanting", nextSection: 71, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    addToInventory('Ancient Burial Coin');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and an <span class='item'>Ancient Burial Coin</span>.";
                }
            },
            87: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 112, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully orient yourself! You're in the western tunnels of the catacombs.";
                    } else {
                        playSound('failure');
                        return "You're completely lost in the twisting tunnels.";
                    }
                }
            },
            88: {
                text: "Following the sound of water leads you to an underground stream. The water flows from a crack in the wall and disappears into a crevice in the floor.",
                choices: [
                    {text: "Follow the stream upstream", nextSection: 113, skillCheck: false},
                    {text: "Follow the stream downstream", nextSection: 114, skillCheck: false},
                    {text: "Search the area around the stream", nextSection: 115, skillCheck: false}
                ],
                action: function() {
                    playSound('water');
                    return "The water is clear and cold, unlike the stagnant pools elsewhere in the catacombs.";
                }
            },
            89: {
                text: "Following the faint light leads you to a chamber where the glowing moss is particularly bright. The chamber contains several stone tablets covered in vampire script.",
                choices: [
                    {text: "Examine the stone tablets", nextSection: 116, skillCheck: false},
                    {text: "Search the chamber", nextSection: 117, skillCheck: false},
                    {text: "Take some of the bright moss", nextSection: 118, skillCheck: false}
                ]
            },
            90: {
                text: "The bat arch leads to a chamber filled with sleeping bats hanging from the ceiling. The chamber continues beyond them.",
                choices: [
                    {text: "Try to sneak past the bats", nextSection: 119, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Attack the bats to clear a path", nextSection: 120, skillCheck: false},
                    {text: "Return to the arches", nextSection: 76, skillCheck: false}
                ],
                action: function() {
                    playSound('crawler'); // Reusing crawler sound for bats
                    return "Thousands of bats sleep soundly, but the slightest noise could wake them.";
                }
            },
            91: {
                text: "The skull arch leads to a chamber filled with bones piled high. The bones rattle and begin to form into skeletal guardians!",
                choices: [
                    {text: "Fight the skeletal guardians", nextSection: 121, skillCheck: false},
                    {text: "Try to bypass them", nextSection: 122, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Retreat", nextSection: 76, skillCheck: false}
                ],
                action: function() {
                    playSound('skeleton');
                    return "<span class='skeleton'>Bones begin assembling into skeletal forms!</span>";
                }
            },
            92: {
                text: "The blood droplet arch leads to a chamber with a fountain in the center. Red liquid flows from the fountain into a basin. The air smells of copper and magic.",
                choices: [
                    {text: "Examine the fountain", nextSection: 123, skillCheck: false},
                    {text: "Drink from the fountain", nextSection: 124, skillCheck: false},
                    {text: "Search the chamber", nextSection: 125, skillCheck: false},
                    {text: "Return to the arches", nextSection: 76, skillCheck: false}
                ],
                action: function() {
                    playSound('water');
                    return "<span class='ritual'>The Blood Fountain</span> pulses with dark energy. This must be what the guardian warned you about.";
                }
            },
            93: {
                text: "Examining the arches more closely, you notice that the carvings tell a story: the bat represents stealth and observation, the skull represents death and guardianship, the blood droplet represents power and sacrifice.",
                choices: [
                    {text: "Take the bat arch", nextSection: 90, skillCheck: false},
                    {text: "Take the skull arch", nextSection: 91, skillCheck: false},
                    {text: "Take the blood droplet arch", nextSection: 92, skillCheck: false}
                ],
                action: function() {
                    return "The arches seem to represent different aspects of vampire nature. Which aspect will you embrace to continue?";
                }
            },
            94: {
                text: "The fungi are unlike any you've seen before. They pulse rhythmically, almost like a heartbeat. Some release glowing spores that float in the air.",
                choices: [
                    {text: "Try to harvest some fungi", nextSection: 95, skillCheck: false},
                    {text: "Avoid the fungi and continue", nextSection: 96, skillCheck: false},
                    {text: "Study the fungi more closely", nextSection: 126, skillCheck: false}
                ],
                action: function() {
                    return "The spores make the air thick and hard to breathe. You feel lightheaded.";
                }
            },
            95: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 127, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        addToInventory('Glowing Catacomb Fungi');
                        playSound('item');
                        return "You carefully harvest some <span class='item'>Glowing Catacomb Fungi</span> without disturbing the rest.";
                    } else {
                        // Fungi release toxic spores
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You disturb the fungi, causing them to release a cloud of toxic spores! You take " + damage + " damage.";
                    }
                }
            },
            96: {
                text: "You carefully avoid the fungi and continue through the chamber. On the other side, you find a tunnel leading downward.",
                choices: [
                    {text: "Descend the tunnel", nextSection: 128, skillCheck: false},
                    {text: "Return to the main tunnel", nextSection: 67, skillCheck: false}
                ]
            },
            97: {
                text: "As you approach, the spectral figure speaks in a whispery voice: <span class='specter'>'Why do you disturb my eternal vigil, mortal?'</span>",
                choices: [
                    {text: "Say you seek the dungeon entrance", nextSection: 129, skillCheck: false},
                    {text: "Ask who the specter is", nextSection: 130, skillCheck: false},
                    {text: "Attack the specter", nextSection: 131, skillCheck: false},
                    {text: "Apologize and leave", nextSection: 67, skillCheck: false}
                ]
            },
            98: {
                text: "You search the frost-covered chamber while avoiding the spectral figure. Behind a frozen tapestry, you find a hidden niche.",
                choices: [
                    {text: "Examine the hidden niche", nextSection: 132, skillCheck: false},
                    {text: "Approach the spectral figure", nextSection: 97, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> frozen in ice.";
                }
            },
            99: {
                text: "You consult your mental map of the catacombs to get your bearings.",
                choices: [
                    {text: "Return to exploring", nextSection: 67, skillCheck: false}
                ],
                action: function() {
                    showCatacombMap();
                    return "Your mental map helps you understand where you are in the catacombs.";
                }
            },
            100: {
                text: "You drink from the pool. The water is cold and has a metallic taste. You feel a surge of energy, but also a creeping coldness in your veins.",
                choices: [
                    {text: "Continue", nextSection: 133, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(3, 6);
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    
                    // Also take some damage from the cold
                    const coldDamage = rollDice(1, 4);
                    gameState.health -= coldDamage;
                    
                    updateStatsDisplay();
                    
                    playSound('water');
                    return "The magical water heals you for " + actualHeal + " Health, but the unnatural cold deals " + coldDamage + " damage. Net effect: " + (actualHeal - coldDamage) + " Health.";
                }
            },
            101: {
                text: "You collect some of the magical water in a container.",
                choices: [
                    {text: "Continue past the pool", nextSection: 82, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Vial of Magical Water');
                    playSound('item');
                    return "You collect a <span class='item'>Vial of Magical Water</span>. It might have healing or magical properties.";
                }
            },
            102: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 134, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        addToInventory('Glowing Pool Crystal');
                        playSound('item');
                        return "You successfully retrieve a <span class='item'>Glowing Pool Crystal</span> from the bottom of the pool.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You slip and fall into the pool! The magical water burns strangely, dealing " + damage + " damage.";
                    }
                }
            },
            103: {
                text: "With the offerings in hand, you examine the pool.",
                choices: [
                    {text: "Examine the pool", nextSection: 80, skillCheck: false},
                    {text: "Continue past the pool", nextSection: 82, skillCheck: false}
                ]
            },
            104: {
                text: "You descend the spiral staircase. It goes deep underground, the air growing colder with each step. At the bottom, you find a massive iron door reinforced with dark magic.",
                choices: [
                    {text: "Try to open the iron door", nextSection: 135, skillCheck: false},
                    {text: "Examine the door's reinforcements", nextSection: 136, skillCheck: false},
                    {text: "Return up the staircase", nextSection: 82, skillCheck: false}
                ],
                action: function() {
                    playSound('catacomb');
                    return "This must be the entrance to the dungeon. You can feel dark energy radiating from beyond the door.";
                }
            },
            105: {
                text: "After observing the ritual, you slip away unnoticed.",
                choices: [
                    {text: "Continue past the ritual chamber", nextSection: 137, skillCheck: false},
                    {text: "Return the way you came", nextSection: 47, skillCheck: false}
                ]
            },
            106: {
                text: "With the spectral ritualists defeated, their forms dissipate into mist. The ritual chamber falls silent.",
                choices: [
                    {text: "Search the ritual chamber", nextSection: 138, skillCheck: false},
                    {text: "Continue past the chamber", nextSection: 137, skillCheck: false}
                ],
                action: function() {
                    gameState.specterPuzzleSolved = true;
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "The specters dissipate! You find <span class='gold'>" + goldFound + " Gold</span> near the altar.";
                }
            },
            107: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 139, skillCheck: false}
                ]
            },
            108: {
                text: "With the angered ritualists defeated, you stand alone in the ritual chamber.",
                choices: [
                    {text: "Search the ritual chamber", nextSection: 138, skillCheck: false},
                    {text: "Continue past the chamber", nextSection: 137, skillCheck: false}
                ],
                action: function() {
                    gameState.specterPuzzleSolved = true;
                    const goldFound = rollDice(6, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the specters! You find <span class='gold'>" + goldFound + " Gold</span> among their remains.";
                }
            },
            109: {
                text: "Having slipped past the ritual chamber, you continue down the tunnel.",
                choices: [
                    {text: "Continue exploring", nextSection: 137, skillCheck: false},
                    {text: "Return to the dry tunnel", nextSection: 47, skillCheck: false}
                ]
            },
            110: {
                text: "With the spectral watchers defeated, you can continue.",
                choices: [
                    {text: "Search the area", nextSection: 140, skillCheck: false},
                    {text: "Continue past the ritual chamber", nextSection: 137, skillCheck: false}
                ],
                action: function() {
                    gameState.specterPuzzleSolved = true;
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the watchers and find <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            111: {
                text: "After searching the burial niches, you follow the chanting.",
                choices: [
                    {text: "Follow the chanting", nextSection: 71, skillCheck: false},
                    {text: "Return to the dry tunnel", nextSection: 72, skillCheck: false}
                ]
            },
            112: {
                text: "After getting your bearings (or failing to), you continue exploring.",
                choices: [
                    {text: "Follow the sound of water", nextSection: 88, skillCheck: false},
                    {text: "Follow the faint light ahead", nextSection: 89, skillCheck: false}
                ]
            },
            113: {
                text: "Following the stream upstream leads you to a small waterfall where the water emerges from a crack in the ceiling. Behind the waterfall, you see a hidden passage.",
                choices: [
                    {text: "Go through the hidden passage", nextSection: 141, skillCheck: false},
                    {text: "Follow the stream downstream", nextSection: 114, skillCheck: false}
                ]
            },
            114: {
                text: "Following the stream downstream leads you to a large underground lake. The water disappears into darkness at the far end of the lake.",
                choices: [
                    {text: "Explore around the lake", nextSection: 142, skillCheck: false},
                    {text: "Try to cross the lake", nextSection: 143, skillCheck: false},
                    {text: "Return upstream", nextSection: 113, skillCheck: false}
                ],
                action: function() {
                    playSound('water');
                    return "The lake is eerily still and dark. You can't see the bottom.";
                }
            },
            115: {
                text: "Searching around the stream, you find where previous travelers have camped. Among the remains of a campfire, you find some abandoned supplies.",
                choices: [
                    {text: "Take the supplies", nextSection: 144, skillCheck: false},
                    {text: "Follow the stream upstream", nextSection: 113, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(2, 10);
                    gameState.gold += goldFound;
                    addToInventory('Old Adventurer Supplies');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and <span class='item'>Old Adventurer Supplies</span>.";
                }
            },
            116: {
                text: "The stone tablets record the history of the ancient vampires. One tablet describes the construction of the catacombs. Another tells of a great battle between vampire factions. A third warns of a 'sleeping evil' deeper in the earth.",
                choices: [
                    {text: "Search the chamber", nextSection: 117, skillCheck: false},
                    {text: "Take some of the bright moss", nextSection: 118, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Tablet Knowledge');
                    playSound('item');
                    return "You learn valuable history from the tablets. Knowledge is power, even in a place like this.";
                }
            },
            117: {
                text: "You search the chamber. Behind one of the stone tablets, you find a hidden compartment.",
                choices: [
                    {text: "Open the compartment", nextSection: 145, skillCheck: false},
                    {text: "Examine the stone tablets", nextSection: 116, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> in the compartment.";
                }
            },
            118: {
                text: "You collect some of the particularly bright moss. It glows more intensely than the moss elsewhere in the catacombs.",
                choices: [
                    {text: "Examine the stone tablets", nextSection: 116, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 75, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Bright Glowing Moss');
                    playSound('item');
                    return "You collect <span class='item'>Bright Glowing Moss</span>. It provides better illumination than regular moss.";
                }
            },
            119: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 146, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You move silently past the sleeping bats. They continue their rest, undisturbed.";
                    } else {
                        // Bats wake up and attack
                        const batDamage = rollDice(2, 6);
                        gameState.health -= batDamage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You disturb the bats! They swarm around you, dealing " + batDamage + " damage before you escape.";
                    }
                }
            },
            120: {
                text: "You attack the bats, trying to clear a path. They awaken in a fury and swarm around you!",
                choices: [
                    {text: "Fight through the swarm", nextSection: 147, skillCheck: false}
                ],
                action: function() {
                    const batDamage = rollDice(3, 6);
                    gameState.health -= batDamage;
                    updateStatsDisplay();
                    playSound('damage');
                    return "You fight through the bat swarm, taking " + batDamage + " damage in the process.";
                }
            },
            121: {
                text: "The bones assemble into three skeletal guardians! They advance toward you with rusted weapons.",
                choices: [
                    {text: "Fight the skeletal guardians", nextSection: 148, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Skeletal Guardians";
                    combatState.enemyHealth = 75;
                    combatState.enemyCurrentHealth = 75;
                    combatState.enemyStrength = 14;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 149;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 3;
                    
                    playSound('skeleton');
                    return "<span class='skeleton'>Skeletal Guardians (3)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            122: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 150, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip past the assembling skeletons before they fully form!";
                    } else {
                        // Skeletons attack
                        combatState.active = true;
                        combatState.enemyName = "Skeletal Guardians";
                        combatState.enemyHealth = 60;
                        combatState.enemyCurrentHealth = 60;
                        combatState.enemyStrength = 13;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 151;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 2;
                        
                        playSound('skeleton');
                        return "Two skeletons fully form and attack!<br><br><span class='skeleton'>Skeletal Guardians (2)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            123: {
                text: "The blood fountain is carved from black stone. The red liquid that flows from it smells strongly of blood and magic. Runes around the basin glow with dark energy.",
                choices: [
                    {text: "Drink from the fountain", nextSection: 124, skillCheck: false},
                    {text: "Try to destroy the fountain", nextSection: 152, skillCheck: false},
                    {text: "Search the chamber", nextSection: 125, skillCheck: false}
                ],
                action: function() {
                    return "<span class='ritual'>This fountain is clearly a source of dark power. The guardian warned you about it.</span>";
                }
            },
            124: {
                text: "You drink from the blood fountain. The liquid is thick and metallic. Immediately, you feel a surge of power... but also a dark corruption spreading through you.",
                choices: [
                    {text: "Continue", nextSection: 153, skillCheck: false}
                ],
                action: function() {
                    gameState.bloodFountainUsed = true;
                    gameState.strength += 3;
                    gameState.maxHealth += 10;
                    gameState.health += 10;
                    gameState.agility -= 2; // Corruption makes you slower
                    
                    updateStatsDisplay();
                    playSound('ritual');
                    return "You gain +3 Strength and +10 Max Health, but lose 2 Agility. The dark power courses through you, strengthening your body but corrupting your soul.";
                }
            },
            125: {
                text: "You search the chamber around the blood fountain. In shadowy corners, you find the remains of those who came before you - some seeking power, others trying to destroy the fountain.",
                choices: [
                    {text: "Examine the remains", nextSection: 154, skillCheck: false},
                    {text: "Examine the fountain", nextSection: 123, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(8, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> on the remains of previous adventurers.";
                }
            },
            126: {
                text: "Studying the fungi more closely, you realize they're feeding on magical energy in the catacombs. Their spores carry this energy, which might explain the lightheaded feeling.",
                choices: [
                    {text: "Try to harvest some fungi", nextSection: 95, skillCheck: false},
                    {text: "Avoid the fungi and continue", nextSection: 96, skillCheck: false}
                ],
                action: function() {
                    return "The fungi are dangerous but potentially useful if handled correctly.";
                }
            },
            127: {
                text: "After dealing with the fungi, you continue through the chamber.",
                choices: [
                    {text: "Descend the tunnel", nextSection: 128, skillCheck: false},
                    {text: "Return to the main tunnel", nextSection: 67, skillCheck: false}
                ]
            },
            128: {
                text: "You descend the tunnel beyond the fungi chamber. It leads to a natural cavern with crystal formations that glow with inner light.",
                choices: [
                    {text: "Examine the crystals", nextSection: 155, skillCheck: false},
                    {text: "Search the cavern", nextSection: 156, skillCheck: false},
                    {text: "Continue through the cavern", nextSection: 157, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The crystals emit a beautiful, ethereal light that illuminates the entire cavern.";
                }
            },
            129: {
                text: "<span class='specter'>'The dungeon...'</span> the specter whispers. <span class='specter'>'Valerius defiles the ancient resting places with his experiments. I will tell you the way if you promise to end his desecration.'</span>",
                choices: [
                    {text: "Swear to end Valerius's desecration", nextSection: 158, skillCheck: false},
                    {text: "Ask for directions without swearing", nextSection: 159, skillCheck: false},
                    {text: "Attack the specter", nextSection: 131, skillCheck: false}
                ]
            },
            130: {
                text: "<span class='specter'>'I was once a guardian of these catacombs,'</span> the specter says. <span class='specter'>'Now I am bound here, watching over the ancient dead. Valerius's experiments disturb the eternal rest.'</span>",
                choices: [
                    {text: "Ask about the dungeon entrance", nextSection: 129, skillCheck: false},
                    {text: "Ask how to help free the specter", nextSection: 160, skillCheck: false},
                    {text: "Attack the specter", nextSection: 131, skillCheck: false}
                ]
            },
            131: {
                text: "You attack the spectral guardian! It responds with freezing touch attacks.",
                choices: [
                    {text: "Fight the specter", nextSection: 161, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Spectral Guardian";
                    combatState.enemyHealth = 65;
                    combatState.enemyCurrentHealth = 65;
                    combatState.enemyStrength = 15;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 162;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('specter');
                    return "<span class='specter'>Spectral Guardian</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            132: {
                text: "The hidden niche contains frozen artifacts from the catacomb's early days.",
                choices: [
                    {text: "Take the artifacts", nextSection: 163, skillCheck: false},
                    {text: "Approach the spectral figure", nextSection: 97, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Frozen Ancient Artifact');
                    playSound('item');
                    return "You take a <span class='item'>Frozen Ancient Artifact</span>. It's cold to the touch even out of the ice.";
                }
            },
            133: {
                text: "After drinking from the pool, you continue past it.",
                choices: [
                    {text: "Continue past the pool", nextSection: 82, skillCheck: false},
                    {text: "Collect some water", nextSection: 101, skillCheck: false}
                ]
            },
            134: {
                text: "After attempting to retrieve a crystal, you continue.",
                choices: [
                    {text: "Continue past the pool", nextSection: 82, skillCheck: false},
                    {text: "Drink from the pool", nextSection: 100, skillCheck: false}
                ]
            },
            135: {
                text: "You try to open the massive iron door. It's locked with a complex mechanism that requires a specific key.",
                choices: [
                    {text: "Try the Ancient Iron Key if you have it", nextSection: 164, skillCheck: false, requirement: 'Ancient Iron Key'},
                    {text: "Try to force the door", nextSection: 165, skillCheck: true, checkType: 'strength', difficulty: 22},
                    {text: "Look for another way in", nextSection: 166, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Examine the door's reinforcements", nextSection: 136, skillCheck: false}
                ]
            },
            136: {
                text: "The door is reinforced with dark magic. Runes glow along its edges, preventing unauthorized entry. The magic feels similar to that of the blood fountain.",
                choices: [
                    {text: "Try to open the iron door", nextSection: 135, skillCheck: false},
                    {text: "Try to dispel the magic", nextSection: 167, skillCheck: false},
                    {text: "Return up the staircase", nextSection: 82, skillCheck: false}
                ]
            },
            137: {
                text: "You continue past the ritual chamber into deeper tunnels. The air grows colder and the magical energy more intense.",
                choices: [
                    {text: "Continue forward", nextSection: 168, skillCheck: false},
                    {text: "Take a descending side passage", nextSection: 169, skillCheck: false},
                    {text: "Return to the ritual chamber", nextSection: 71, skillCheck: false}
                ]
            },
            138: {
                text: "You search the ritual chamber. The altar is carved with the same symbols as the arches. Various ritual implements lie scattered around.",
                choices: [
                    {text: "Take the ritual implements", nextSection: 170, skillCheck: false},
                    {text: "Continue past the chamber", nextSection: 137, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Spectral Ritual Implements');
                    playSound('item');
                    return "You take <span class='item'>Spectral Ritual Implements</span>. They might be useful for understanding or countering vampire magic.";
                }
            },
            139: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 107, skillCheck: false}
                ]
            },
            140: {
                text: "After searching the area, you continue past the ritual chamber.",
                choices: [
                    {text: "Continue past the chamber", nextSection: 137, skillCheck: false}
                ]
            },
            141: {
                text: "You pass through the hidden passage behind the waterfall. It leads to a dry tunnel that gradually descends.",
                choices: [
                    {text: "Follow the descending tunnel", nextSection: 171, skillCheck: false},
                    {text: "Return to the stream", nextSection: 113, skillCheck: false}
                ]
            },
            142: {
                text: "Exploring around the lake, you find a stone dock with a small boat tied to it. The boat looks ancient but still seaworthy.",
                choices: [
                    {text: "Take the boat across the lake", nextSection: 172, skillCheck: false},
                    {text: "Search the dock area", nextSection: 173, skillCheck: false},
                    {text: "Return upstream", nextSection: 113, skillCheck: false}
                ]
            },
            143: {
                text: "You attempt to swim across the lake. The water is freezing cold, and something brushes against your legs in the dark water.",
                choices: [
                    {text: "Continue swimming", nextSection: 174, skillCheck: true, checkType: 'strength', difficulty: 14},
                    {text: "Turn back", nextSection: 142, skillCheck: false}
                ],
                action: function() {
                    playSound('water');
                    return "The cold is bone-chilling, and the darkness of the water is unnerving.";
                }
            },
            144: {
                text: "With the supplies in hand, you follow the stream.",
                choices: [
                    {text: "Follow the stream upstream", nextSection: 113, skillCheck: false},
                    {text: "Follow the stream downstream", nextSection: 114, skillCheck: false}
                ]
            },
            145: {
                text: "After opening the hidden compartment, you examine the stone tablets.",
                choices: [
                    {text: "Examine the stone tablets", nextSection: 116, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 75, skillCheck: false}
                ]
            },
            146: {
                text: "Having dealt with the bats, you continue through the bat chamber.",
                choices: [
                    {text: "Continue through the chamber", nextSection: 175, skillCheck: false},
                    {text: "Return to the arches", nextSection: 76, skillCheck: false}
                ]
            },
            147: {
                text: "After fighting through the bat swarm, you continue through the chamber.",
                choices: [
                    {text: "Continue through the chamber", nextSection: 175, skillCheck: false},
                    {text: "Return to the arches", nextSection: 76, skillCheck: false}
                ]
            },
            148: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 176, skillCheck: false}
                ]
            },
            149: {
                text: "With the skeletal guardians defeated, you can pass through the chamber.",
                choices: [
                    {text: "Search the bone chamber", nextSection: 177, skillCheck: false},
                    {text: "Continue through the chamber", nextSection: 178, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the guardians! Among the bones, you find <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            150: {
                text: "After dealing with the skeletons, you continue through the chamber.",
                choices: [
                    {text: "Continue through the chamber", nextSection: 178, skillCheck: false},
                    {text: "Return to the arches", nextSection: 76, skillCheck: false}
                ]
            },
            151: {
                text: "With the skeletal guardians defeated, you continue.",
                choices: [
                    {text: "Continue through the chamber", nextSection: 178, skillCheck: false},
                    {text: "Return to the arches", nextSection: 76, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the guardians and find <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            152: {
                text: "You attempt to destroy the blood fountain. It's made of incredibly durable stone and reinforced with powerful magic.",
                choices: [
                    {text: "Smash it with your weapon", nextSection: 179, skillCheck: true, checkType: 'strength', difficulty: 20},
                    {text: "Use holy water if you have it", nextSection: 180, skillCheck: false, requirement: 'Holy Water'},
                    {text: "Use a silver weapon if you have one", nextSection: 181, skillCheck: false, requirement: function() { 
                        return gameState.equippedWeapon.includes('Silver') || gameState.inventory.some(item => item.includes('Silver'));
                    }},
                    {text: "Drink from the fountain instead", nextSection: 124, skillCheck: false}
                ]
            },
            153: {
                text: "After drinking from the blood fountain, you feel the dark power within you. The fountain's magic is now part of you.",
                choices: [
                    {text: "Try to destroy the fountain", nextSection: 152, skillCheck: false},
                    {text: "Search the chamber", nextSection: 125, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 182, skillCheck: false}
                ]
            },
            154: {
                text: "Examining the remains, you find they died in various ways - some from combat, others from the fountain's corrupting influence.",
                choices: [
                    {text: "Examine the fountain", nextSection: 123, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 182, skillCheck: false}
                ]
            },
            155: {
                text: "The crystals are magical, absorbing and amplifying the catacomb's ambient magic. Some are small enough to collect.",
                choices: [
                    {text: "Collect some crystals", nextSection: 183, skillCheck: false},
                    {text: "Search the cavern", nextSection: 156, skillCheck: false},
                    {text: "Continue through the cavern", nextSection: 157, skillCheck: false}
                ]
            },
            156: {
                text: "You search the crystal cavern. In a corner, you find a skeleton holding a crystal staff.",
                choices: [
                    {text: "Take the crystal staff", nextSection: 184, skillCheck: false},
                    {text: "Examine the crystals", nextSection: 155, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> on the skeleton.";
                }
            },
            157: {
                text: "You continue through the crystal cavern. The tunnel beyond leads to a junction with three choices.",
                choices: [
                    {text: "Take the left tunnel", nextSection: 185, skillCheck: false},
                    {text: "Take the center tunnel", nextSection: 186, skillCheck: false},
                    {text: "Take the right tunnel", nextSection: 187, skillCheck: false},
                    {text: "Return to the fungi chamber", nextSection: 96, skillCheck: false}
                ]
            },
            158: {
                text: "<span class='specter'>'Swear it on your soul,'</span> the specter demands. <span class='specter'>'Swear to end Valerius's desecration of our ancient resting place.'</span>",
                choices: [
                    {text: "Swear the oath", nextSection: 188, skillCheck: false},
                    {text: "Refuse and attack", nextSection: 131, skillCheck: false}
                ]
            },
            159: {
                text: "<span class='specter'>'Without commitment, I cannot help you,'</span> the specter says coldly. <span class='specter'>'The way is guarded by those loyal to the ancient vows.'</span>",
                choices: [
                    {text: "Swear to end Valerius's desecration", nextSection: 158, skillCheck: false},
                    {text: "Attack the specter", nextSection: 131, skillCheck: false},
                    {text: "Leave", nextSection: 67, skillCheck: false}
                ]
            },
            160: {
                text: "<span class='specter'>'My binding can only be broken by destroying the source of Valerius's power in the dungeon,'</span> the specter explains. <span class='specter'>'Free me by ending his experiments.'</span>",
                choices: [
                    {text: "Swear to end Valerius's experiments", nextSection: 158, skillCheck: false},
                    {text: "Ask about the dungeon entrance", nextSection: 129, skillCheck: false}
                ]
            },
            161: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 189, skillCheck: false}
                ]
            },
            162: {
                text: "With the spectral guardian defeated, its form dissipates into cold mist. The chamber grows slightly warmer.",
                choices: [
                    {text: "Search the chamber", nextSection: 190, skillCheck: false},
                    {text: "Continue exploring", nextSection: 191, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "The specter dissipates! You find <span class='gold'>" + goldFound + " Gold</span> where it hovered.";
                }
            },
            163: {
                text: "With the frozen artifact, you approach the spectral figure.",
                choices: [
                    {text: "Approach the spectral figure", nextSection: 97, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 67, skillCheck: false}
                ]
            },
            164: {
                text: "You use the Ancient Iron Key in the lock. It turns smoothly, and the massive iron door groans open, revealing darkness beyond.",
                choices: [
                    {text: "Enter the dungeon", nextSection: 192, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Ancient Iron Key');
                    gameState.exitFound = true;
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 9;
                    saveGame();
                    
                    return "";
                }
            },
            165: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 193, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.exitFound = true;
                        gameState.gameComplete = true;
                        showScreen('screen-next');
                        document.getElementById('next-stat-strength').textContent = gameState.strength;
                        document.getElementById('next-stat-health').textContent = gameState.health;
                        document.getElementById('next-stat-agility').textContent = gameState.agility;
                        document.getElementById('next-stat-gold').textContent = gameState.gold;
                        
                        // Display inventory that will carry over
                        const inventoryDisplay = document.getElementById('next-inventory-display');
                        inventoryDisplay.innerHTML = '';
                        
                        // Show equipped items
                        const equippedDiv = document.createElement('div');
                        equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                        inventoryDisplay.appendChild(equippedDiv);
                        
                        // Show other inventory
                        if (gameState.inventory.length > 0) {
                            const invDiv = document.createElement('div');
                            invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                            inventoryDisplay.appendChild(invDiv);
                        }
                        
                        playSound('level');
                        
                        // Save completed level state
                        gameState.level = 9;
                        saveGame();
                        
                        return "";
                    } else {
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The door doesn't budge. The dark magic protecting it retaliates, dealing " + damage + " damage.";
                    }
                }
            },
            166: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 194, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.exitFound = true;
                        gameState.gameComplete = true;
                        showScreen('screen-next');
                        document.getElementById('next-stat-strength').textContent = gameState.strength;
                        document.getElementById('next-stat-health').textContent = gameState.health;
                        document.getElementById('next-stat-agility').textContent = gameState.agility;
                        document.getElementById('next-stat-gold').textContent = gameState.gold;
                        
                        // Display inventory that will carry over
                        const inventoryDisplay = document.getElementById('next-inventory-display');
                        inventoryDisplay.innerHTML = '';
                        
                        // Show equipped items
                        const equippedDiv = document.createElement('div');
                        equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                        inventoryDisplay.appendChild(equippedDiv);
                        
                        // Show other inventory
                        if (gameState.inventory.length > 0) {
                            const invDiv = document.createElement('div');
                            invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                            inventoryDisplay.appendChild(invDiv);
                        }
                        
                        playSound('level');
                        
                        // Save completed level state
                        gameState.level = 9;
                        saveGame();
                        
                        return "";
                    } else {
                        playSound('failure');
                        return "You find no alternative way to open the door. It requires a specific key or immense strength.";
                    }
                }
            },
            167: {
                text: "You attempt to dispel the dark magic protecting the door. It's incredibly powerful ancient magic.",
                choices: [
                    {text: "Try to open the door anyway", nextSection: 135, skillCheck: false},
                    {text: "Return up the staircase", nextSection: 82, skillCheck: false}
                ],
                action: function() {
                    playSound('ritual');
                    return "The magic is too powerful to dispel without specialized knowledge or artifacts.";
                }
            },
            168: {
                text: "The tunnel continues forward, eventually leading to a massive underground chasm. A narrow stone bridge spans the chasm, leading to the other side.",
                choices: [
                    {text: "Cross the stone bridge", nextSection: 195, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Look for another way across", nextSection: 196, skillCheck: false},
                    {text: "Return the way you came", nextSection: 137, skillCheck: false}
                ],
                action: function() {
                    return "The chasm is deep and dark. You can't see the bottom. The bridge looks ancient and unstable.";
                }
            },
            169: {
                text: "The descending side passage leads to a lower level of the catacombs. The air here is even colder, and the walls are covered in thick ice.",
                choices: [
                    {text: "Explore the ice-covered tunnels", nextSection: 197, skillCheck: false},
                    {text: "Return to the main tunnel", nextSection: 137, skillCheck: false}
                ]
            },
            170: {
                text: "With the ritual implements, you continue past the chamber.",
                choices: [
                    {text: "Continue past the chamber", nextSection: 137, skillCheck: false}
                ]
            },
            171: {
                text: "The descending tunnel leads to a lower chamber where the air is warm and humid. Steam rises from cracks in the floor.",
                choices: [
                    {text: "Explore the steamy chamber", nextSection: 198, skillCheck: false},
                    {text: "Return to the waterfall", nextSection: 141, skillCheck: false}
                ],
                action: function() {
                    playSound('water');
                    return "The heat is a welcome change from the catacomb's usual chill.";
                }
            },
            172: {
                text: "You take the boat across the dark lake. The water is perfectly still, and the boat moves silently.",
                choices: [
                    {text: "Cross to the other side", nextSection: 199, skillCheck: false},
                    {text: "Search the dock area", nextSection: 173, skillCheck: false}
                ],
                action: function() {
                    playSound('water');
                    return "The boat glides smoothly across the dark water.";
                }
            },
            173: {
                text: "Searching the dock area, you find supplies left by previous boat users.",
                choices: [
                    {text: "Take the boat across the lake", nextSection: 172, skillCheck: false},
                    {text: "Take the supplies", nextSection: 200, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(2, 10);
                    gameState.gold += goldFound;
                    addToInventory('Boatman Supplies');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and <span class='item'>Boatman Supplies</span>.";
                }
            },
            174: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 201, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You swim strongly across the lake, reaching the other side despite the cold and darkness.";
                    } else {
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The cold and whatever is in the water overwhelm you! You take " + damage + " damage before reaching the other side.";
                    }
                }
            },
            175: {
                text: "You pass through the bat chamber and continue into deeper tunnels.",
                choices: [
                    {text: "Continue forward", nextSection: 202, skillCheck: false},
                    {text: "Return to the arches", nextSection: 76, skillCheck: false}
                ]
            },
            176: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 148, skillCheck: false}
                ]
            },
            177: {
                text: "You search the bone chamber after defeating the guardians.",
                choices: [
                    {text: "Continue through the chamber", nextSection: 178, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Guardian Bone Talisman');
                    playSound('item');
                    return "You find a <span class='item'>Guardian Bone Talisman</span> that might offer protection.";
                }
            },
            178: {
                text: "You pass through the bone chamber and continue into deeper tunnels.",
                choices: [
                    {text: "Continue forward", nextSection: 203, skillCheck: false},
                    {text: "Return to the arches", nextSection: 76, skillCheck: false}
                ]
            },
            179: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 204, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You smash the blood fountain! Dark energy erupts from it, then dissipates. Valerius's connection to this power source is severed.";
                    } else {
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The fountain resists your attack! Dark energy lashes back at you, dealing " + damage + " damage.";
                    }
                }
            },
            180: {
                text: "You use holy water on the blood fountain. It sizzles and cracks, dark energy leaking from the fractures.",
                choices: [
                    {text: "Finish destroying it", nextSection: 205, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Holy Water');
                    playSound('success');
                    return "The <span class='item'>Holy Water</span> causes the fountain to fracture! Dark energy leaks out, weakening Valerius's power source.";
                }
            },
            181: {
                text: "You attack the fountain with your silver weapon. It cracks under the blows, and the flow of blood-red liquid slows to a trickle.",
                choices: [
                    {text: "Continue attacking", nextSection: 206, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "Your silver weapon damages the fountain! Valerius's power source is compromised.";
                }
            },
            182: {
                text: "You leave the blood fountain chamber and return to the arches.",
                choices: [
                    {text: "Take the bat arch", nextSection: 90, skillCheck: false},
                    {text: "Take the skull arch", nextSection: 91, skillCheck: false},
                    {text: "Take the blood droplet arch again", nextSection: 92, skillCheck: false}
                ]
            },
            183: {
                text: "You collect some of the magical crystals. They glow with inner light and feel warm to the touch.",
                choices: [
                    {text: "Search the cavern", nextSection: 156, skillCheck: false},
                    {text: "Continue through the cavern", nextSection: 157, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Magical Catacomb Crystals');
                    playSound('item');
                    return "You collect <span class='item'>Magical Catacomb Crystals</span>. They might have various uses.";
                }
            },
            184: {
                text: "You take the crystal staff from the skeleton's grasp. It pulses with magical energy.",
                choices: [
                    {text: "Examine the crystals", nextSection: 155, skillCheck: false},
                    {text: "Continue through the cavern", nextSection: 157, skillCheck: false}
                ],
                action: function() {
                    gameState.equippedWeapon = 'Crystal Staff';
                    updateInventoryDisplay();
                    playSound('item');
                    return "You equip the <span class='item'>Crystal Staff</span>. It's a powerful magical weapon.";
                }
            },
            185: {
                text: "The left tunnel leads to a dead end with a single stone coffin. The coffin is plain and unadorned.",
                choices: [
                    {text: "Open the coffin", nextSection: 207, skillCheck: false},
                    {text: "Return to the junction", nextSection: 157, skillCheck: false}
                ]
            },
            186: {
                text: "The center tunnel leads to a chamber with a spiral staircase leading downward. This seems to be the way to deeper levels.",
                choices: [
                    {text: "Descend the staircase", nextSection: 208, skillCheck: false},
                    {text: "Return to the junction", nextSection: 157, skillCheck: false}
                ]
            },
            187: {
                text: "The right tunnel leads to a chamber filled with ancient scrolls and books. This appears to be an archive or library.",
                choices: [
                    {text: "Search the archive", nextSection: 209, skillCheck: false},
                    {text: "Return to the junction", nextSection: 157, skillCheck: false}
                ]
            },
            188: {
                text: "<span class='specter'>'Your oath is sworn,'</span> the specter says. <span class='specter'>'Break it, and your soul will know eternal cold. Now listen: the dungeon entrance is at the lowest point of the catacombs, guarded by an iron door. To open it, you need the Ancient Iron Key, which lies in the flooded passages, or the strength to break the door's magic.'</span>",
                choices: [
                    {text: "Thank the specter and leave", nextSection: 210, skillCheck: false},
                    {text: "Ask for more specific directions", nextSection: 211, skillCheck: false}
                ]
            },
            189: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 161, skillCheck: false}
                ]
            },
            190: {
                text: "You search the frost-covered chamber after the specter's defeat.",
                choices: [
                    {text: "Continue exploring", nextSection: 191, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Specter Essence Crystal');
                    playSound('item');
                    return "You find a <span class='item'>Specter Essence Crystal</span> - the concentrated remains of the guardian's spirit.";
                }
            },
            191: {
                text: "You leave the frost chamber and continue exploring the catacombs.",
                choices: [
                    {text: "Return to the main tunnel", nextSection: 67, skillCheck: false}
                ]
            },
            192: {
                text: "YOU HAVE FOUND THE DUNGEON ENTRANCE! The iron door closes behind you with a final-sounding clang. You stand at the top of a staircase leading down into even deeper darkness, from which come faint screams and the smell of blood.",
                choices: [],
                action: function() {
                    // This is handled in section 164
                    return "";
                }
            },
            193: {
                text: "After trying to force the door, you try other options.",
                choices: [
                    {text: "Look for another way in", nextSection: 166, skillCheck: false},
                    {text: "Examine the door's reinforcements", nextSection: 136, skillCheck: false}
                ]
            },
            194: {
                text: "After looking for another way, you return to trying the door.",
                choices: [
                    {text: "Try to open the iron door", nextSection: 135, skillCheck: false},
                    {text: "Examine the door's reinforcements", nextSection: 136, skillCheck: false}
                ]
            },
            195: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 212, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You cross the stone bridge carefully. It sways slightly but holds your weight.";
                    } else {
                        const damage = rollDice(4, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "Part of the bridge collapses beneath you! You fall partway before catching yourself, taking " + damage + " damage.";
                    }
                }
            },
            196: {
                text: "Looking for another way across, you find a narrow ledge along the chasm wall.",
                choices: [
                    {text: "Try to cross via the ledge", nextSection: 213, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Return to cross the bridge", nextSection: 195, skillCheck: false}
                ]
            },
            197: {
                text: "The ice-covered tunnels are treacherous. The air is freezing, and the floor is slick with ice.",
                choices: [
                    {text: "Continue carefully", nextSection: 214, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Return to the main tunnel", nextSection: 169, skillCheck: false}
                ],
                action: function() {
                    playSound('catacomb');
                    return "Your breath fogs heavily in the freezing air.";
                }
            },
            198: {
                text: "The steamy chamber contains hot springs. The water is warm and seems to have healing properties.",
                choices: [
                    {text: "Rest in the hot springs", nextSection: 215, skillCheck: false},
                    {text: "Search the chamber", nextSection: 216, skillCheck: false},
                    {text: "Return to the waterfall", nextSection: 171, skillCheck: false}
                ],
                action: function() {
                    playSound('water');
                    return "The warm steam is comforting after the catacomb's chill.";
                }
            },
            199: {
                text: "You reach the other side of the lake. Here, you find another tunnel leading away from the water.",
                choices: [
                    {text: "Explore the new tunnel", nextSection: 217, skillCheck: false},
                    {text: "Return across the lake", nextSection: 172, skillCheck: false}
                ]
            },
            200: {
                text: "With the supplies, you take the boat across the lake.",
                choices: [
                    {text: "Take the boat across the lake", nextSection: 172, skillCheck: false}
                ]
            },
            201: {
                text: "After swimming across the lake, you find a tunnel on the other side.",
                choices: [
                    {text: "Explore the new tunnel", nextSection: 217, skillCheck: false},
                    {text: "Rest and recover", nextSection: 218, skillCheck: false}
                ]
            },
            202: {
                text: "You continue forward from the bat chamber. The tunnel eventually leads to a junction.",
                choices: [
                    {text: "Take the left passage", nextSection: 219, skillCheck: false},
                    {text: "Take the right passage", nextSection: 220, skillCheck: false},
                    {text: "Continue straight", nextSection: 221, skillCheck: false}
                ]
            },
            203: {
                text: "You continue forward from the bone chamber. The tunnel eventually leads to a large chamber with multiple exits.",
                choices: [
                    {text: "Take the left exit", nextSection: 222, skillCheck: false},
                    {text: "Take the center exit", nextSection: 223, skillCheck: false},
                    {text: "Take the right exit", nextSection: 224, skillCheck: false}
                ]
            },
            204: {
                text: "After your attempt to destroy the fountain, you leave the chamber.",
                choices: [
                    {text: "Leave the chamber", nextSection: 182, skillCheck: false}
                ]
            },
            205: {
                text: "You finish destroying the blood fountain. It crumbles into useless rubble.",
                choices: [
                    {text: "Leave the chamber", nextSection: 182, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The blood fountain is completely destroyed! Valerius has lost an important source of power.";
                }
            },
            206: {
                text: "You continue attacking until the fountain is completely destroyed.",
                choices: [
                    {text: "Leave the chamber", nextSection: 182, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The blood fountain is destroyed!";
                }
            },
            207: {
                text: "You open the plain stone coffin. Inside, you find a skeleton holding a simple iron key.",
                choices: [
                    {text: "Take the key", nextSection: 225, skillCheck: false},
                    {text: "Return to the junction", nextSection: 157, skillCheck: false}
                ],
                action: function() {
                    gameState.hasAncientKey = true;
                    addToInventory('Simple Iron Key');
                    playSound('item');
                    return "You find a <span class='item'>Simple Iron Key</span>. It might unlock something important.";
                }
            },
            208: {
                text: "You descend the spiral staircase. It goes deep underground, eventually leading to the massive iron door - the dungeon entrance!",
                choices: [
                    {text: "Approach the iron door", nextSection: 104, skillCheck: false}
                ]
            },
            209: {
                text: "The archive contains scrolls and books on vampire history, magic, and rituals. Some of this knowledge could be valuable.",
                choices: [
                    {text: "Search for useful information", nextSection: 226, skillCheck: false},
                    {text: "Take some scrolls", nextSection: 227, skillCheck: false},
                    {text: "Return to the junction", nextSection: 157, skillCheck: false}
                ]
            },
            210: {
                text: "You thank the specter and leave the frost chamber.",
                choices: [
                    {text: "Continue exploring", nextSection: 191, skillCheck: false}
                ]
            },
            211: {
                text: "<span class='specter'>'Follow the main tunnel until you reach the three arches,'</span> the specter says. <span class='specter'>'Take the blood droplet arch, then continue until you find a spiral staircase descending. That leads to the door.'</span>",
                choices: [
                    {text: "Thank the specter and leave", nextSection: 210, skillCheck: false}
                ]
            },
            212: {
                text: "After crossing the bridge, you continue down the tunnel.",
                choices: [
                    {text: "Continue forward", nextSection: 228, skillCheck: false},
                    {text: "Return the way you came", nextSection: 168, skillCheck: false}
                ]
            },
            213: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 229, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You carefully make your way across the narrow ledge, reaching the other side safely.";
                    } else {
                        const damage = rollDice(5, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You slip on the icy ledge! You fall into the chasm, taking " + damage + " damage before managing to climb back up.";
                    }
                }
            },
            214: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 230, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You navigate the icy tunnels carefully, avoiding slips and falls.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You slip on the ice, taking " + damage + " damage.";
                    }
                }
            },
            215: {
                text: "You rest in the hot springs. The warm water soothes your aches and wounds, and you feel your strength returning.",
                choices: [
                    {text: "Continue resting", nextSection: 231, skillCheck: false},
                    {text: "Search the chamber", nextSection: 216, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(4, 6);
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    
                    updateStatsDisplay();
                    playSound('water');
                    return "The hot springs heal you for " + actualHeal + " Health.";
                }
            },
            216: {
                text: "You search the steamy chamber. Near the hot springs, you find a niche containing items left by previous visitors.",
                choices: [
                    {text: "Take the items", nextSection: 232, skillCheck: false},
                    {text: "Rest in the hot springs", nextSection: 215, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    addToInventory('Hot Spring Stones');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and some <span class='item'>Hot Spring Stones</span> that retain heat.";
                }
            },
            217: {
                text: "The tunnel from the lake leads to a series of chambers that seem to have been used for storage long ago.",
                choices: [
                    {text: "Search the storage chambers", nextSection: 233, skillCheck: false},
                    {text: "Continue through the chambers", nextSection: 234, skillCheck: false},
                    {text: "Return to the lake", nextSection: 199, skillCheck: false}
                ]
            },
            218: {
                text: "You rest after your swim, recovering some strength.",
                choices: [
                    {text: "Explore the new tunnel", nextSection: 217, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 6);
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    
                    updateStatsDisplay();
                    playSound('item');
                    return "You rest and recover " + actualHeal + " Health.";
                }
            },
            219: {
                text: "The left passage leads to a small chamber with a pedestal. On the pedestal rests a crystal that pulses with light.",
                choices: [
                    {text: "Take the crystal", nextSection: 235, skillCheck: false},
                    {text: "Return to the junction", nextSection: 202, skillCheck: false}
                ]
            },
            220: {
                text: "The right passage leads to a dead end with a collapsed ceiling. You can't proceed this way.",
                choices: [
                    {text: "Return to the junction", nextSection: 202, skillCheck: false}
                ]
            },
            221: {
                text: "Continuing straight leads you to a long tunnel that eventually connects to other parts of the catacombs.",
                choices: [
                    {text: "Continue forward", nextSection: 236, skillCheck: false},
                    {text: "Return to the junction", nextSection: 202, skillCheck: false}
                ]
            },
            222: {
                text: "The left exit leads to a tunnel that gradually descends.",
                choices: [
                    {text: "Follow the descending tunnel", nextSection: 237, skillCheck: false},
                    {text: "Return to the chamber", nextSection: 203, skillCheck: false}
                ]
            },
            223: {
                text: "The center exit leads to a chamber with a well in the center. The well is dry and appears to be very deep.",
                choices: [
                    {text: "Examine the well", nextSection: 238, skillCheck: false},
                    {text: "Return to the chamber", nextSection: 203, skillCheck: false}
                ]
            },
            224: {
                text: "The right exit leads to a series of small burial chambers.",
                choices: [
                    {text: "Search the burial chambers", nextSection: 239, skillCheck: false},
                    {text: "Return to the chamber", nextSection: 203, skillCheck: false}
                ]
            },
            225: {
                text: "With the key in hand, you return to the junction.",
                choices: [
                    {text: "Return to the junction", nextSection: 157, skillCheck: false}
                ]
            },
            226: {
                text: "You search for useful information in the archive. You find scrolls on vampire weaknesses, the history of the Vorlak family, and notes on Valerius's experiments.",
                choices: [
                    {text: "Take some scrolls", nextSection: 227, skillCheck: false},
                    {text: "Return to the junction", nextSection: 157, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Vampire Weakness Scroll');
                    playSound('item');
                    return "You find a <span class='item'>Vampire Weakness Scroll</span> detailing how to fight vampires effectively.";
                }
            },
            227: {
                text: "You take some of the most useful-looking scrolls from the archive.",
                choices: [
                    {text: "Return to the junction", nextSection: 157, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Archive Scroll Collection');
                    playSound('item');
                    return "You take an <span class='item'>Archive Scroll Collection</span>. This knowledge could be invaluable.";
                }
            },
            228: {
                text: "You continue down the tunnel from the bridge. It eventually leads to familiar territory - you recognize some of the carvings.",
                choices: [
                    {text: "Continue following the tunnel", nextSection: 240, skillCheck: false},
                    {text: "Try to get your bearings", nextSection: 241, skillCheck: false}
                ]
            },
            229: {
                text: "After crossing via the ledge, you continue down the tunnel.",
                choices: [
                    {text: "Continue forward", nextSection: 228, skillCheck: false}
                ]
            },
            230: {
                text: "You navigate through the ice-covered tunnels. They eventually lead to a chamber with a frozen lake.",
                choices: [
                    {text: "Cross the frozen lake", nextSection: 242, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Search around the lake", nextSection: 243, skillCheck: false},
                    {text: "Return through the icy tunnels", nextSection: 197, skillCheck: false}
                ],
                action: function() {
                    playSound('catacomb');
                    return "The frozen lake is eerily beautiful, with ice formations glittering in the faint light.";
                }
            },
            231: {
                text: "After resting in the hot springs, you feel rejuvenated.",
                choices: [
                    {text: "Search the chamber", nextSection: 216, skillCheck: false},
                    {text: "Return to the waterfall", nextSection: 171, skillCheck: false}
                ]
            },
            232: {
                text: "With the items from the hot springs chamber, you rest.",
                choices: [
                    {text: "Rest in the hot springs", nextSection: 215, skillCheck: false},
                    {text: "Return to the waterfall", nextSection: 171, skillCheck: false}
                ]
            },
            233: {
                text: "The storage chambers contain old crates and barrels, most of them rotted away. However, you find a few items still intact.",
                choices: [
                    {text: "Take the intact items", nextSection: 244, skillCheck: false},
                    {text: "Continue through the chambers", nextSection: 234, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    addToInventory('Old Storage Crate Contents');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and some <span class='item'>Old Storage Crate Contents</span> that might be useful.";
                }
            },
            234: {
                text: "You continue through the storage chambers. They eventually connect to other parts of the catacombs.",
                choices: [
                    {text: "Continue forward", nextSection: 245, skillCheck: false},
                    {text: "Return to the lake", nextSection: 199, skillCheck: false}
                ]
            },
            235: {
                text: "You take the crystal from the pedestal. It pulses with a regular rhythm, like a heartbeat.",
                choices: [
                    {text: "Return to the junction", nextSection: 202, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Pulsating Heart Crystal');
                    playSound('item');
                    return "You take the <span class='item'>Pulsating Heart Crystal</span>. It feels alive in your hand.";
                }
            },
            236: {
                text: "The long tunnel eventually leads to a familiar area - you've been here before!",
                choices: [
                    {text: "Continue exploring", nextSection: 67, skillCheck: false}
                ]
            },
            237: {
                text: "The descending tunnel leads to lower levels of the catacombs. The air grows colder and the magical energy more intense.",
                choices: [
                    {text: "Continue descending", nextSection: 246, skillCheck: false},
                    {text: "Return to the chamber", nextSection: 203, skillCheck: false}
                ]
            },
            238: {
                text: "The well is incredibly deep. Dropping a stone, you don't hear it hit bottom. A cold draft rises from the well, carrying with it the scent of damp earth and something else... something alive.",
                choices: [
                    {text: "Try to climb down the well", nextSection: 247, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Search around the well", nextSection: 248, skillCheck: false},
                    {text: "Return to the chamber", nextSection: 203, skillCheck: false}
                ],
                action: function() {
                    return "Something about the well feels wrong, as if it shouldn't be here.";
                }
            },
            239: {
                text: "The burial chambers contain ancient coffins. Most are sealed, but one lies open, its contents missing.",
                choices: [
                    {text: "Search the open coffin", nextSection: 249, skillCheck: false},
                    {text: "Try to open a sealed coffin", nextSection: 250, skillCheck: true, checkType: 'strength', difficulty: 17},
                    {text: "Return to the chamber", nextSection: 203, skillCheck: false}
                ]
            },
            240: {
                text: "Following the tunnel, you eventually reach an area you recognize - you're near the three arches!",
                choices: [
                    {text: "Go to the three arches", nextSection: 76, skillCheck: false}
                ]
            },
            241: {
                text: "You try to get your bearings. Looking at the carvings and the tunnel layout, you realize you're in the western section of the catacombs.",
                choices: [
                    {text: "Continue following the tunnel", nextSection: 240, skillCheck: false}
                ]
            },
            242: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 251, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You carefully cross the frozen lake. The ice holds your weight, though it creaks ominously.";
                    } else {
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The ice cracks beneath you! You fall into freezing water, taking " + damage + " damage before climbing out.";
                    }
                }
            },
            243: {
                text: "Searching around the frozen lake, you find items left by previous explorers who weren't as lucky as you.",
                choices: [
                    {text: "Take the items", nextSection: 252, skillCheck: false},
                    {text: "Cross the frozen lake", nextSection: 242, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> frozen in the ice.";
                }
            },
            244: {
                text: "With the items from the storage chambers, you continue through.",
                choices: [
                    {text: "Continue through the chambers", nextSection: 234, skillCheck: false}
                ]
            },
            245: {
                text: "The storage chambers connect to a tunnel that looks familiar. You think you've been here before.",
                choices: [
                    {text: "Follow the tunnel", nextSection: 253, skillCheck: false},
                    {text: "Return to the storage chambers", nextSection: 233, skillCheck: false}
                ]
            },
            246: {
                text: "You continue descending. The tunnel eventually leads to the spiral staircase - the way to the dungeon entrance!",
                choices: [
                    {text: "Descend to the dungeon entrance", nextSection: 104, skillCheck: false}
                ]
            },
            247: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 254, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You climb down the well carefully. At the bottom, you find a hidden chamber with valuable items!";
                    } else {
                        const damage = rollDice(5, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You slip while climbing and fall! You take " + damage + " damage.";
                    }
                }
            },
            248: {
                text: "Searching around the well, you find a loose stone in the wall. Behind it is a hidden compartment.",
                choices: [
                    {text: "Examine the compartment", nextSection: 255, skillCheck: false},
                    {text: "Try to climb down the well", nextSection: 247, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> in the compartment.";
                }
            },
            249: {
                text: "The open coffin is empty except for a few personal items left by whoever was buried here.",
                choices: [
                    {text: "Take the items", nextSection: 256, skillCheck: false},
                    {text: "Try to open a sealed coffin", nextSection: 250, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Coffin Personal Effects');
                    playSound('item');
                    return "You take the <span class='item'>Coffin Personal Effects</span>. They have little value but tell a story.";
                }
            },
            250: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 257, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(5, 10);
                        gameState.gold += goldFound;
                        addToInventory('Ancient Burial Jewelry');
                        updateStatsDisplay();
                        playSound('item');
                        return "You open the coffin! Inside, you find <span class='gold'>" + goldFound + " Gold</span> and <span class='item'>Ancient Burial Jewelry</span>.";
                    } else {
                        playSound('failure');
                        return "The coffin lid is sealed shut. You cannot open it.";
                    }
                }
            },
            251: {
                text: "After crossing the frozen lake, you find a tunnel on the other side.",
                choices: [
                    {text: "Explore the tunnel", nextSection: 258, skillCheck: false},
                    {text: "Return across the lake", nextSection: 242, skillCheck: false}
                ]
            },
            252: {
                text: "With the items from around the lake, you attempt to cross.",
                choices: [
                    {text: "Cross the frozen lake", nextSection: 242, skillCheck: false}
                ]
            },
            253: {
                text: "Following the familiar tunnel, you realize you're back in the main catacomb system.",
                choices: [
                    {text: "Continue to a familiar area", nextSection: 67, skillCheck: false}
                ]
            },
            254: {
                text: "At the bottom of the well, you find a hidden chamber. It contains ancient artifacts and treasure.",
                choices: [
                    {text: "Take the treasure", nextSection: 259, skillCheck: false},
                    {text: "Climb back up", nextSection: 238, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(10, 10);
                    gameState.gold += goldFound;
                    addToInventory('Well Hidden Treasure');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and <span class='item'>Well Hidden Treasure</span>!";
                }
            },
            255: {
                text: "After finding the compartment, you consider the well.",
                choices: [
                    {text: "Try to climb down the well", nextSection: 247, skillCheck: false},
                    {text: "Return to the chamber", nextSection: 203, skillCheck: false}
                ]
            },
            256: {
                text: "With the personal effects, you try another coffin.",
                choices: [
                    {text: "Try to open a sealed coffin", nextSection: 250, skillCheck: false},
                    {text: "Return to the chamber", nextSection: 203, skillCheck: false}
                ]
            },
            257: {
                text: "After attempting to open a coffin, you return to the burial chambers.",
                choices: [
                    {text: "Search the open coffin", nextSection: 249, skillCheck: false},
                    {text: "Return to the chamber", nextSection: 203, skillCheck: false}
                ]
            },
            258: {
                text: "The tunnel from the frozen lake leads to familiar territory. You recognize some of the carvings.",
                choices: [
                    {text: "Continue to familiar areas", nextSection: 67, skillCheck: false}
                ]
            },
            259: {
                text: "With the treasure from the well chamber, you climb back up.",
                choices: [
                    {text: "Climb back up", nextSection: 238, skillCheck: false}
                ]
            }
        };
        
        // Initialize game for Level 8
        function initGame() {
            // Load game state from Level 7
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 8 (coming from Level 7)
                if (savedState.level === 8) {
                    Object.assign(gameState, savedState);
                    
                    // Update intro screen with loaded stats
                    document.getElementById('intro-stat-strength').textContent = gameState.strength;
                    document.getElementById('intro-stat-health').textContent = gameState.health;
                    document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('intro-stat-agility').textContent = gameState.agility;
                    document.getElementById('intro-stat-gold').textContent = gameState.gold;
                    
                    // Generate catacomb map if not already generated
                    if (!gameState.catacombMap || Object.keys(gameState.catacombMap).length === 0) {
                        generateCatacombMap();
                    }
                    
                    showScreen('screen-intro');
                    return;
                } else if (savedState.level === 7) {
                    // If coming directly from Level 7 without completing it
                    alert("You must complete Level 7 first!");
                    window.location.href = 'l7.html';
                    return;
                } else if (savedState.level === 6) {
                    // If saved level is 6, redirect to level 6
                    alert("You need to complete Level 6 first!");
                    window.location.href = 'l6.html';
                    return;
                } else {
                    // If no valid save, start from beginning
                    alert("No valid saved game found. Starting from Level 1.");
                    window.location.href = 'l1.html';
                    return;
                }
            } else {
                // No saved game found
                alert("No saved game found. Starting from Level 1.");
                window.location.href = 'l1.html';
                return;
            }
        }
        
        function startLevel8() {
            playSound('click');
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item) && item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Show catacomb map
        function showCatacombMap() {
            playSound('click');
            
            // Update explored percentage
            const totalCells = 11 * 11; // 11x11 grid
            const exploredCells = gameState.exploredCatacombSections.length;
            const exploredPercent = Math.round((exploredCells / totalCells) * 100);
            document.getElementById('explored-percent').textContent = exploredPercent;
            
            // Generate map display
            const mapDiv = document.getElementById('catacomb-map');
            mapDiv.innerHTML = '';
            
            for (let y = 0; y < 11; y++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'map-row';
                
                for (let x = 0; x < 11; x++) {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'map-cell';
                    
                    // Check if this is player position
                    if (gameState.currentPosition.x === x && gameState.currentPosition.y === y) {
                        cellDiv.className += ' player';
                        cellDiv.textContent = 'P';
                    }
                    // Check if this is exit position
                    else if (gameState.exitPosition.x === x && gameState.exitPosition.y === y) {
                        cellDiv.className += ' exit';
                        cellDiv.textContent = 'E';
                    }
                    // Check if explored
                    else if (gameState.exploredCatacombSections.includes(`${x},${y}`)) {
                        cellDiv.className += ' explored';
                        cellDiv.textContent = '.';
                    }
                    // Unexplored
                    else {
                        cellDiv.className += ' unexplored';
                        cellDiv.textContent = '?';
                    }
                    
                    rowDiv.appendChild(cellDiv);
                }
                
                mapDiv.appendChild(rowDiv);
            }
            
            showScreen('screen-map');
        }
        
        function closeMap() {
            playSound('click');
            showScreen('screen-game');
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Potion' || item === 'Mountain Potion' || item === 'Ancient Vampire Wine') {
                const healAmount = item === 'Mountain Potion' ? rollDice(3, 6) + 10 : 
                                 item === 'Ancient Vampire Wine' ? rollDice(2, 8) + 5 : rollDice(2, 6) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Holy Water') {
                message = "The <span class='item'>Holy Water</span> is blessed and could harm undead, vampires, or dark artifacts like the blood fountain.";
            } else if (item === 'Vial of Magical Water') {
                const healAmount = rollDice(2, 6);
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You drink the <span class='item'>Vial of Magical Water</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Vial of Ancient Blood') {
                message = "The <span class='item'>Vial of Ancient Blood</span> contains powerful vampiric essence. It might be useful for rituals or bargaining with vampires.";
            } else if (item === 'Glowing Purple Moss' || item === 'Bright Glowing Moss') {
                message = "The <span class='item'>" + item + "</span> provides faint illumination. It might help in dark areas.";
            } else if (item === 'Ancient Ritual Dagger') {
                message = "The <span class='item'>Ancient Ritual Dagger</span> is inscribed with vampire runes. It might be effective against undead or for performing counter-rituals.";
            } else if (item === 'Ancient Iron Key' || item === 'Simple Iron Key') {
                message = "The <span class='item'>" + item + "</span> is heavy and cold. It might unlock something important in the catacombs.";
            } else if (item === 'Mental Catacomb Map') {
                showCatacombMap();
                return;
            } else if (item.includes('Shovel')) {
                gameState.equippedWeapon = item;
                updateInventoryDisplay();
                message = `You equip the <span class='item'>${item}</span>. It's heavy but could be an effective weapon.`;
            } else if (item === 'Crystal Staff') {
                gameState.equippedWeapon = 'Crystal Staff';
                updateInventoryDisplay();
                message = "You equip the <span class='item'>Crystal Staff</span>. It's a powerful magical weapon.";
            } else if (item === 'Necromancer Robes') {
                gameState.equippedArmor = 'Necromancer Robes';
                updateInventoryDisplay();
                message = "You wear the <span class='item'>Necromancer Robes</span>. They might offer protection against dark magic.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Sword' && 
                gameState.equippedArmor === 'Leather Armor') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Record current position as explored
            const posKey = `${gameState.currentPosition.x},${gameState.currentPosition.y}`;
            if (!gameState.exploredCatacombSections.includes(posKey)) {
                gameState.exploredCatacombSections.push(posKey);
            }
            
            // Check for random catacomb events
            if (Math.random() > 0.7) {
                randomEvents.coldTouch = true;
                playSound('catacomb');
                storyText += "<br><br><span class='catacomb'>You feel a sudden cold touch on your shoulder, but when you turn, nothing is there.</span>";
            }
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 39 || sectionId === 65 || sectionId === 68 || 
                                   sectionId === 107 || sectionId === 139 || sectionId === 148 || 
                                   sectionId === 161 || sectionId === 176 || sectionId === 189);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    let goldReward = 0;
                    
                    if (combatState.enemyName.includes("Crawler")) {
                        goldReward = Math.floor(Math.random() * 40) + 20;
                        gameState.cryptfiendNestCleared = true;
                    } else if (combatState.enemyName.includes("Skeleton") || combatState.enemyName.includes("Guardian")) {
                        goldReward = Math.floor(Math.random() * 60) + 30;
                    } else if (combatState.enemyName.includes("Specter")) {
                        goldReward = Math.floor(Math.random() * 50) + 25;
                        gameState.specterPuzzleSolved = true;
                    } else if (combatState.enemyName.includes("Ancient Stone")) {
                        goldReward = Math.floor(Math.random() * 80) + 40;
                        gameState.ancientGuardianDefeated = true;
                    }
                    
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    
                    if (goldReward > 0) {
                        storyText += `<br>You find <span class="gold">${goldReward} Gold</span> on the remains.`;
                    }
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    if (typeof choice.requirement === 'function') {
                        return choice.requirement();
                    }
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue exploring the catacombs";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                let weaponType = gameState.equippedWeapon;
                
                // Special weapon bonuses
                if (weaponType.includes('Silver')) {
                    // Silver weapons deal extra damage to undead/vampires
                    damage = rollDice(2, 6) + 4;
                    if (combatState.enemyName.includes('undead') || combatState.enemyName.includes('Skeleton') || combatState.enemyName.includes('Specter')) {
                        damage += 5; // Extra vs undead
                        resultText += `<span class="item">Your silver weapon is especially effective against undead!</span><br>`;
                    }
                } else if (weaponType === 'Crystal Staff') {
                    damage = rollDice(3, 6) + 3; // Magical weapon
                    if (combatState.enemyName.includes('Specter') || combatState.enemyName.includes('undead')) {
                        damage += 4; // Extra vs spectral/undead
                        resultText += `<span class="item">The crystal staff glows with magical power against the undead!</span><br>`;
                    }
                } else if (weaponType === 'Ancient Ritual Dagger') {
                    damage = rollDice(2, 6) + 3;
                    if (combatState.enemyName.includes('undead') || combatState.enemyName.includes('vampire') || combatState.enemyName.includes('Specter')) {
                        damage += 3;
                        resultText += `<span class="item">The ritual dagger is designed to harm undead creatures!</span><br>`;
                    }
                } else if (weaponType.includes('Shovel')) {
                    damage = rollDice(2, 6) + 1; // Shovel as weapon
                } else {
                    damage = rollDice(2, 6);
                }
                
                // Item bonuses
                if (gameState.hasHolyWater && (combatState.enemyName.includes('undead') || combatState.enemyName.includes('Specter'))) {
                    damage += 5;
                    resultText += `<span class="item">Holy water burns the undead creature!</span><br>`;
                }
                
                if (gameState.hasRitualDagger && (combatState.enemyName.includes('undead') || combatState.enemyName.includes('Specter'))) {
                    damage += 3;
                    resultText += `<span class="item">Your ritual dagger channels anti-undead energy!</span><br>`;
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                let enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                
                // Group enemies attack together
                if (combatState.isGroup && (combatState.enemyName.includes('Crawler') || combatState.enemyName.includes('Skeleton') || combatState.enemyName.includes('Specter'))) {
                    enemyDamage += Math.floor(combatState.groupCount * 1.5); // Extra damage for group
                    if (combatState.groupCount > 1) {
                        resultText += `The enemies attack as a group!<br>`;
                    }
                }
                
                // Specter special attack
                if (combatState.enemyName.includes('Specter')) {
                    if (Math.random() > 0.7) {
                        enemyDamage += rollDice(2, 6); // Extra chilling damage
                        resultText += `The specter's chilling touch freezes your flesh!<br>`;
                    }
                }
                
                // Crawler special attack
                if (combatState.enemyName.includes('Crawler')) {
                    if (Math.random() > 0.7) {
                        enemyDamage += rollDice(1, 6); // Extra poison damage
                        resultText += `The crawler's bite injects venom!<br>`;
                    }
                }
                
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('castleUndeadGameState');
                        window.location.href = 'l1.html';
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You dodge a falling rock trap!",
                    "You move silently past a sleeping creature.",
                    "You climb a difficult wall to bypass an obstacle.",
                    "You slip through a narrow crack others would miss."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip and take 3 damage!",
                    "You make noise and alert nearby creatures.",
                    "You get tangled in vines or debris.",
                    "You knock over some bones, making a loud clatter."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 3;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 8 (this page)
                if (savedState.level === 8) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 8.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 9 with updated level
            gameState.level = 9;
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            // Redirect to level 9 (The Castle's Dungeon)
            window.location.href = 'l9.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
