<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle of the Dammed 1984</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            overflow-x: hidden;
        }
        
        .game-container {
            border: 2px solid #fff;
            padding: 20px;
            margin-top: 20px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px dashed #fff;
            padding-bottom: 10px;
        }
        
        .game-title {
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #fff;
        }
        
        .game-subtitle {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }
        
        .game-output {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
            border: 1px solid #333;
            padding: 15px;
            background-color: #111;
        }
        
        .game-output p {
            margin-bottom: 10px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .game-output .location {
            color: #ffff00;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .game-output .hint {
            color: #888;
            font-style: italic;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .game-output .enemy {
            color: #ff5555;
        }
        
        .game-output .npc {
            color: #55ff55;
        }
        
        .game-output .combat {
            color: #ff4444;
            font-weight: bold;
        }
        
        .game-output .player {
            color: #55ffff;
        }
        
        .game-output .health {
            color: #ff6666;
        }
        
        .game-output .damage {
            color: #ff9966;
        }
        
        .game-output .victory {
            color: #ffff55;
            font-weight: bold;
        }
        
        .game-output .defeat {
            color: #ff5555;
            font-weight: bold;
        }
        
        .game-output .gold {
            color: #ffd700;
        }
        
        .game-output .shop {
            color: #ffaa00;
        }
        
        .game-output .magic {
            color: #ff66ff;
        }
        
        .game-output .item {
            color: #55ff55;
        }
        
        .game-input-container {
            display: flex;
            align-items: center;
            border-top: 1px dashed #fff;
            padding-top: 15px;
        }
        
        .game-prompt {
            margin-right: 10px;
            color: #00ff00;
        }
        
        #game-input {
            background-color: #000;
            color: #fff;
            border: 1px solid #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            padding: 10px;
            flex-grow: 1;
            outline: none;
        }
        
        #game-input:focus {
            box-shadow: 0 0 5px #fff;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Scrollbar styling */
        .game-output::-webkit-scrollbar {
            width: 10px;
        }
        
        .game-output::-webkit-scrollbar-track {
            background: #111;
        }
        
        .game-output::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 5px;
        }
        
        .game-output::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
        
        /* Status bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #222;
            border: 1px solid #444;
            font-size: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
        }
        
        .health-bar {
            width: 100px;
            height: 12px;
            background-color: #333;
            margin-left: 5px;
            border: 1px solid #555;
        }
        
        .health-fill {
            height: 100%;
            background-color: #ff5555;
            transition: width 0.3s;
        }
        
        .magic-fill {
            background-color: #9966ff;
        }
        
        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                font-size: 14px;
                padding: 10px;
            }
            
            .game-title {
                font-size: 18px;
            }
            
            .game-container {
                padding: 10px;
            }
            
            #game-input {
                font-size: 12px;
                padding: 8px;
            }
            
            .status-bar {
                font-size: 10px;
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1 class="game-title">CASTLE OF THE DAMMED 1984</h1>
        <p class="game-subtitle">Â© 1984 Dystopian Castle Software</p>
        <p class="game-subtitle">Text Adventure v1.0 - SPELLBOOK SYSTEM ACTIVE</p>
    </div>
    
    <div class="status-bar" id="status-bar">
        <div class="status-item">
            HP: <span id="player-hp-text">50/50</span>
            <div class="health-bar">
                <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
            </div>
        </div>
        <div class="status-item">
            MP: <span id="player-mp-text">20/20</span>
            <div class="health-bar">
                <div class="health-fill magic-fill" id="player-magic-fill" style="width: 100%;"></div>
            </div>
        </div>
        <div class="status-item">
            Weapon: <span id="player-weapon">Fists</span>
        </div>
        <div class="status-item">
            Gold: <span id="player-gold">15</span>
        </div>
        <div class="status-item">
            Enemy HP: <span id="enemy-hp-text">-</span>
            <div class="health-bar">
                <div class="health-fill" id="enemy-health-fill" style="width: 0%; background-color: #ff9966;"></div>
            </div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="game-output" id="game-output">
            <!-- Game text will appear here -->
        </div>
        
        <div class="game-input-container">
            <span class="game-prompt">&gt;</span>
            <input type="text" id="game-input" placeholder="Type your command..." autocomplete="off">
        </div>
    </div>

    <script>
        // ==================== GAME SAVE SYSTEM ====================
        
        const SAVE_KEY = 'castleDamned1984Save';
        
        function saveGame() {
            const saveData = {
                player: {
                    maxHP: player.maxHP,
                    currentHP: player.currentHP,
                    maxMP: player.maxMP,
                    currentMP: player.currentMP,
                    gold: player.gold,
                    weapon: player.weapon,
                    inventory: player.inventory,
                    spells: player.spells,
                    equippedItems: player.equippedItems
                },
                gameState: gameState,
                combatActive: combatActive,
                currentEnemy: currentEnemy
            };
            localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
        }
        
        function loadGame() {
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) {
                try {
                    const saveData = JSON.parse(saved);
                    Object.assign(player, saveData.player);
                    Object.assign(gameState, saveData.gameState);
                    combatActive = saveData.combatActive || false;
                    currentEnemy = saveData.currentEnemy || null;
                    return true;
                } catch (e) {
                    console.error("Failed to load save:", e);
                }
            }
            return false;
        }
        
        function clearSave() {
            localStorage.removeItem(SAVE_KEY);
        }
        
        // ==================== COMBAT SYSTEM ====================
        
        // Player stats
        const player = {
            maxHP: 50,
            currentHP: 50,
            maxMP: 20,
            currentMP: 20,
            gold: 15,
            weapon: {
                name: "Fists",
                minDamage: 4,
                maxDamage: 6,
                type: "melee"
            },
            inventory: ["leather bound spellbook", "health potion", "torch"],
            spells: ["magic missile"], // Starting spell
            equippedItems: {
                weapon: "Fists",
                armor: null,
                accessory: null
            }
        };
        
        // Enemy types
        const enemies = {
            corruptedGuard: {
                name: "Corrupted Castle Guard",
                maxHP: 25,
                currentHP: 25,
                minDamage: 3,
                maxDamage: 6,
                description: "A castle guard whose eyes glow with an unnatural purple light. His armor is rusted and he moves with jerky, unnatural motions.",
                defeatMessage: "The corrupted guard collapses into a pile of rusted armor and dust!",
                loot: "rusty sword"
            },
            shadowStalker: {
                name: "Shadow Stalker",
                maxHP: 18,
                currentHP: 18,
                minDamage: 4,
                maxDamage: 7,
                description: "A creature made of living shadow that seems to drink the light around it.",
                defeatMessage: "The shadow stalker dissipates with an unearthly shriek!",
                loot: "shadow essence"
            }
        };
        
        // Spell definitions
        const spells = {
            "magic missile": {
                name: "Magic Missile",
                cost: 5,
                description: "Fires a bolt of magical energy at your enemy.",
                effect: function() {
                    if (!currentEnemy) {
                        addToOutput("There's nothing to attack with magic here.", "magic");
                        return false;
                    }
                    
                    const damage = Math.floor(Math.random() * 6) + 5; // 5-10 damage
                    currentEnemy.currentHP -= damage;
                    currentEnemy.currentHP = Math.max(0, currentEnemy.currentHP);
                    
                    addToOutput(`You cast Magic Missile! It hits for ${damage} damage!`, "magic");
                    addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
                    
                    if (currentEnemy.currentHP <= 0) {
                        endCombat(true);
                    } else {
                        enemyAttack();
                    }
                    updateStatus();
                    return true;
                }
            },
            "heal": {
                name: "Heal",
                cost: 8,
                description: "Restores 15-25 HP to yourself.",
                effect: function() {
                    const healAmount = Math.floor(Math.random() * 11) + 15;
                    player.currentHP = Math.min(player.maxHP, player.currentHP + healAmount);
                    addToOutput(`You cast Heal! You restore ${healAmount} HP!`, "magic");
                    updateStatus();
                    return true;
                }
            },
            "light": {
                name: "Light",
                cost: 3,
                description: "Creates a magical light source that reveals hidden objects.",
                effect: function() {
                    const loc = locations[gameState.currentLocation];
                    addToOutput("You cast Light! The area is illuminated by magical energy.", "magic");
                    
                    if (loc.hiddenItems && loc.hiddenItems.length > 0) {
                        addToOutput("The magical light reveals previously hidden items!", "magic");
                        loc.hiddenItems.forEach(item => {
                            if (!loc.items.includes(item) && !player.inventory.includes(item)) {
                                loc.items.push(item);
                                addToOutput(`You see a ${item.toUpperCase()} revealed by the light!`, "item");
                            }
                        });
                    }
                    return true;
                }
            }
        };
        
        // Current combat state
        let combatActive = false;
        let currentEnemy = null;
        
        // ==================== GAME STATE ====================
        const gameState = {
            currentLocation: 'dungeonCell',
            inventory: [],
            visitedLocations: ['dungeonCell'],
            gameEnded: false,
            
            // Room-specific states
            dungeonCell: {
                bedExamined: false,
                brickExamined: false,
                looseBrickFound: false,
                potionTaken: false,
                keyTaken: false
            },
            guardRoom: {
                guardDefeated: false,
                swordTaken: false,
                portraitExamined: false,
                secretFound: false,
                silverKeyTaken: false
            },
            library: {
                librarianTalked: false,
                scrollTaken: false,
                fireplaceExamined: false,
                tomeExamined: false,
                healSpellLearned: false
            }
        };
        
        // Update status display
        function updateStatus() {
            document.getElementById('player-hp-text').textContent = 
                `${player.currentHP}/${player.maxHP}`;
            
            document.getElementById('player-mp-text').textContent = 
                `${player.currentMP}/${player.maxMP}`;
            
            const playerHealthPercent = (player.currentHP / player.maxHP) * 100;
            document.getElementById('player-health-fill').style.width = 
                `${Math.max(0, playerHealthPercent)}%`;
            
            const playerMagicPercent = (player.currentMP / player.maxMP) * 100;
            document.getElementById('player-magic-fill').style.width = 
                `${Math.max(0, playerMagicPercent)}%`;
            
            document.getElementById('player-weapon').textContent = player.weapon.name;
            document.getElementById('player-gold').textContent = player.gold;
            
            if (currentEnemy && combatActive) {
                document.getElementById('enemy-hp-text').textContent = 
                    `${currentEnemy.currentHP}/${currentEnemy.maxHP}`;
                
                const enemyHealthPercent = (currentEnemy.currentHP / currentEnemy.maxHP) * 100;
                document.getElementById('enemy-health-fill').style.width = 
                    `${Math.max(0, enemyHealthPercent)}%`;
                document.getElementById('enemy-health-fill').style.display = 'block';
            } else {
                document.getElementById('enemy-hp-text').textContent = '-';
                document.getElementById('enemy-health-fill').style.display = 'none';
            }
            
            // Auto-save after every status update
            saveGame();
        }
        
        // Combat functions
        function startCombat(enemyType) {
            currentEnemy = JSON.parse(JSON.stringify(enemies[enemyType])); // Clone enemy
            combatActive = true;
            updateStatus();
            
            addToOutput(`A ${currentEnemy.name} appears!`, "enemy");
            addToOutput(currentEnemy.description, "enemy");
            addToOutput("COMBAT STARTED! Use ATTACK to fight or CAST [spell]!", "combat");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP} | ${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "combat");
        }
        
        function playerAttack() {
            if (!combatActive || !currentEnemy) {
                addToOutput("There's nothing to attack here.");
                return;
            }
            
            const playerDamage = Math.floor(
                Math.random() * (player.weapon.maxDamage - player.weapon.minDamage + 1)
            ) + player.weapon.minDamage;
            
            currentEnemy.currentHP -= playerDamage;
            currentEnemy.currentHP = Math.max(0, currentEnemy.currentHP);
            
            addToOutput(`You attack with your ${player.weapon.name} and deal ${playerDamage} damage!`, "player");
            addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
            
            if (currentEnemy.currentHP <= 0) {
                endCombat(true);
                return;
            }
            
            enemyAttack();
            updateStatus();
        }
        
        function enemyAttack() {
            const enemyDamage = Math.floor(
                Math.random() * (currentEnemy.maxDamage - currentEnemy.minDamage + 1)
            ) + currentEnemy.minDamage;
            
            player.currentHP -= enemyDamage;
            player.currentHP = Math.max(0, player.currentHP);
            
            addToOutput(`${currentEnemy.name} attacks you for ${enemyDamage} damage!`, "enemy");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP}`, "health");
            
            if (player.currentHP <= 0) {
                endCombat(false);
            }
        }
        
        function endCombat(playerWon) {
            if (playerWon) {
                addToOutput(currentEnemy.defeatMessage, "victory");
                
                if (currentEnemy.loot && !player.inventory.includes(currentEnemy.loot)) {
                    player.inventory.push(currentEnemy.loot);
                    addToOutput(`You found a ${currentEnemy.loot}!`);
                    
                    if (currentEnemy.loot === "rusty sword") {
                        addToOutput("You can EQUIP RUSTY SWORD to use it as a weapon.", "hint");
                        gameState.guardRoom.swordTaken = true;
                    }
                    
                    if (currentEnemy.loot === "shadow essence") {
                        addToOutput("The shadow essence shimmers with dark energy.", "item");
                    }
                }
                
                if (currentEnemy.name === "Corrupted Castle Guard") {
                    gameState.guardRoom.guardDefeated = true;
                    // Add items to guard room after defeating guard
                    if (!locations.guardRoom.items.includes('rusty sword')) {
                        locations.guardRoom.items.push('rusty sword');
                    }
                }
                
                // Award some gold for victory
                const goldReward = Math.floor(Math.random() * 10) + 5;
                player.gold += goldReward;
                addToOutput(`You find ${goldReward} gold on the defeated enemy!`, "gold");
                
            } else {
                addToOutput("You have been defeated!", "defeat");
                addToOutput("GAME OVER - Type 'RESTART' to try again or load a saved game.", "defeat");
                gameState.gameEnded = true;
                gameInput.disabled = true;
            }
            
            combatActive = false;
            currentEnemy = null;
            updateStatus();
        }
        
        // Object descriptions
        const objectDescriptions = {
            // Weapons
            "fists": "Your bare hands. Not very effective but better than nothing. Damage: 4-6",
            "rusty sword": "A rusted but still functional sword. Better than fists. Damage: 6-9",
            "iron key": "A simple iron key. Might unlock something.",
            "silver key": "A delicate silver key with intricate designs.",
            
            // Items
            "leather bound spellbook": "Your personal spellbook. It contains the spells you know. READ SPELLBOOK to see your spells.",
            "health potion": "A small vial containing red liquid. Restores 20 HP when used.",
            "torch": "A wooden torch wrapped in cloth. Can be lit to provide light.",
            "shadow essence": "A vial containing swirling shadow. It might have magical properties.",
            "ancient scroll": "A scroll containing a healing spell. READ SCROLL to learn it.",
            "dusty tome": "An ancient book covered in dust. It might contain useful information.",
            
            // Room objects
            "straw bed": "A musty old bed filled with straw. It looks uncomfortable.",
            "loose brick": "A brick that seems out of place in the wall.",
            "rusty barrel": "An old, rusted barrel. It's empty.",
            "portrait": "A painting of a noble lord. The eyes seem to follow you.",
            "fireplace": "A large stone fireplace filled with cold ashes.",
            "bookshelf": "A shelf filled with ancient books.",
            "bookshelves": "Towering shelves filled with ancient books.",
            "table": "A sturdy wooden table.",
            "chair": "A comfortable looking chair."
        };

        // Game locations
        const locations = {
            dungeonCell: {
                name: "DUNGEON CELL",
                description: function() {
                    let desc = "You awaken in a cold, damp dungeon cell. The air smells of mildew and decay. ";
                    desc += "In one corner sits a STRAW BED, and in another, a RUSTY BARREL. ";
                    desc += "The cell door to the north is slightly ajar.";
                    
                    // Dynamic items
                    if (!gameState.dungeonCell.keyTaken && this.items.includes('iron key')) {
                        desc += " You notice an IRON KEY on the floor near the bed.";
                    }
                    
                    if (!gameState.dungeonCell.potionTaken && this.items.includes('health potion')) {
                        desc += " There's a HEALTH POTION on a small ledge.";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["iron key", "health potion"],
                exits: {
                    north: "guardRoom",
                    south: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            guardRoom: {
                name: "GUARD ROOM",
                description: function() {
                    let desc = "A guard room with a stone table and chairs. ";
                    
                    if (!gameState.guardRoom.guardDefeated) {
                        desc += "A CORRUPTED GUARD blocks your way, his eyes glowing with purple light! ";
                        this.enemy = "corruptedGuard";
                    } else {
                        desc += "The defeated guard's armor lies in a pile on the floor. ";
                        this.enemy = null;
                    }
                    
                    desc += "On the wall hangs a PORTRAIT of a noble lord. ";
                    desc += "A wooden DOOR leads east, and the cell door is to the south.";
                    
                    // Dynamic items
                    if (gameState.guardRoom.guardDefeated && !gameState.guardRoom.swordTaken && this.items.includes('rusty sword')) {
                        desc += " The guard's RUSTY SWORD lies on the floor.";
                    }
                    
                    if (gameState.guardRoom.secretFound && !gameState.guardRoom.silverKeyTaken && this.items.includes('silver key')) {
                        desc += " A SILVER KEY glints from within the portrait's secret compartment.";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["silver key"],
                exits: {
                    south: "dungeonCell",
                    east: "library",
                    north: null,
                    west: null
                },
                visited: false,
                enemy: "corruptedGuard"
            },
            library: {
                name: "ANCIENT LIBRARY",
                description: function() {
                    let desc = "You enter a vast library filled with towering BOOKSHELVES. ";
                    desc += "Dusty TOMES line the shelves. In the center of the room, an old LIBRARIAN ";
                    desc += "is organizing scrolls at a large TABLE. A stone FIREPLACE dominates the west wall. ";
                    desc += "The guard room is to the west.";
                    
                    // Dynamic items
                    if (!gameState.library.scrollTaken && this.items.includes('ancient scroll')) {
                        desc += " An ANCIENT SCROLL sits on the table.";
                    }
                    
                    return desc;
                },
                items: ["ancient scroll", "dusty tome"],
                hiddenItems: [],
                exits: {
                    west: "guardRoom",
                    north: null,
                    east: null,
                    south: null
                },
                visited: false,
                enemy: null
            }
        };

        // Game commands
        const commands = {
            'north': 'north',
            'n': 'north',
            'south': 'south',
            's': 'south',
            'east': 'east',
            'e': 'east',
            'west': 'west',
            'w': 'west',
            'look': 'look',
            'l': 'look',
            'inventory': 'inventory',
            'i': 'inventory',
            'take': 'take',
            'get': 'take',
            'grab': 'take',
            'drop': 'drop',
            'examine': 'examine',
            'x': 'examine',
            'use': 'use',
            'equip': 'equip',
            'unequip': 'unequip',
            'open': 'open',
            'read': 'read',
            'talk': 'talk',
            'speak': 'talk',
            'ask': 'talk',
            'give': 'give',
            'attack': 'attack',
            'fight': 'attack',
            'kill': 'attack',
            'cast': 'cast',
            'light': 'light',
            'repair': 'repair',
            'fix': 'repair',
            'eat': 'eat',
            'drink': 'drink',
            'buy': 'buy',
            'purchase': 'buy',
            'sell': 'sell',
            'shop': 'shop',
            'list': 'shop',
            'save': 'save',
            'load': 'load',
            'restart': 'restart',
            'help': 'help',
            'h': 'help',
            'quit': 'quit',
            'q': 'quit'
        };

        // DOM elements
        const gameOutput = document.getElementById('game-output');
        const gameInput = document.getElementById('game-input');

        // Add text to game output
        function addToOutput(text, className = '') {
            const p = document.createElement('p');
            p.textContent = text;
            if (className) {
                p.className = className;
            }
            gameOutput.appendChild(p);
            
            gameOutput.scrollTop = gameOutput.scrollHeight;
        }

        // Show current location
        function showLocation() {
            const loc = locations[gameState.currentLocation];
            
            addToOutput(loc.name, "location");
            
            const description = loc.description();
            addToOutput(description);
            
            if (!loc.visited) {
                loc.visited = true;
                gameState.visitedLocations.push(gameState.currentLocation);
            }
            
            // Start combat if there's an enemy in the room and we're not already in combat
            if (loc.enemy && !combatActive && gameState.currentLocation === "guardRoom" && !gameState.guardRoom.guardDefeated) {
                startCombat(loc.enemy);
            }
            
            const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
            if (exits.length > 0) {
                addToOutput("Exits: " + exits.map(exit => exit.toUpperCase()).join(", "));
            }
        }

        // Initialize game
        function initGame() {
            // Try to load saved game first
            const loaded = loadGame();
            
            if (!loaded) {
                // Normal initialization
                gameOutput.innerHTML = '';
                addToOutput("CASTLE OF THE DAMMED 1984", "title");
                addToOutput("Dystopian Text Adventure - SPELLBOOK SYSTEM ACTIVE", "subtitle");
                addToOutput(" ");
                addToOutput("The year is 1984, but not as you know it. The Castle of the Dammed", "story");
                addToOutput("has stood for centuries, its dark magic warping time and space.", "story");
                addToOutput("You awaken in its dungeons with no memory of how you got here...", "story");
                addToOutput(" ");
                addToOutput("TIP: You start with a spellbook containing MAGIC MISSILE.", "magic");
                addToOutput("Use CAST MAGIC MISSILE in combat or EXAMINE everything for clues.", "hint");
                addToOutput("New: Use EQUIP [weapon] to change your main weapon.", "hint");
                addToOutput(" ");
                
                // Set initial inventory
                gameState.inventory = [...player.inventory];
                updateStatus();
                showLocation();
            } else {
                gameOutput.innerHTML = '';
                addToOutput("CASTLE OF THE DAMMED 1984", "title");
                addToOutput("Game loaded successfully!", "victory");
                addToOutput(`HP: ${player.currentHP}/${player.maxHP} | MP: ${player.currentMP}/${player.maxMP}`, "player");
                addToOutput(`Gold: ${player.gold} | Weapon: ${player.weapon.name}`, "player");
                
                if (player.spells.length > 0) {
                    addToOutput("Known spells: " + player.spells.map(s => s.toUpperCase()).join(", "), "magic");
                }
                
                if (player.inventory.length > 0) {
                    addToOutput("Inventory: " + player.inventory.map(item => item.toUpperCase()).join(", "));
                }
                
                addToOutput(" ");
                showLocation();
            }
            
            // Set up input event listener
            gameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processCommand(this.value);
                    this.value = '';
                }
            });
            
            gameInput.focus();
        }

        // Process player command
        function processCommand(input) {
            if (gameState.gameEnded && !input.toLowerCase().includes('restart')) {
                addToOutput("The game has ended. Type RESTART to try again.", "hint");
                return;
            }
            
            const command = input.trim().toLowerCase();
            if (!command) return;
            
            const parts = command.split(' ');
            const verb = parts[0];
            const object = parts.slice(1).join(' ');
            
            // Check for restart command
            if (verb === 'restart') {
                clearSave();
                location.reload();
                return;
            }
            
            if (!commands[verb]) {
                addToOutput(`I don't understand "${verb}".`);
                return;
            }
            
            const action = commands[verb];
            
            switch(action) {
                case 'north':
                case 'south':
                case 'east':
                case 'west':
                    movePlayer(action);
                    break;
                case 'look':
                    lookAround();
                    break;
                case 'inventory':
                    showInventory();
                    break;
                case 'take':
                    takeItem(object);
                    break;
                case 'drop':
                    dropItem(object);
                    break;
                case 'examine':
                    examineObject(object);
                    break;
                case 'use':
                    useItem(object);
                    break;
                case 'equip':
                    equipItem(object);
                    break;
                case 'unequip':
                    unequipItem(object);
                    break;
                case 'open':
                    openObject(object);
                    break;
                case 'read':
                    readObject(object);
                    break;
                case 'talk':
                    talkTo(object);
                    break;
                case 'give':
                    giveItem(object);
                    break;
                case 'attack':
                    if (combatActive) {
                        playerAttack();
                    } else {
                        attackEnemy(object);
                    }
                    break;
                case 'cast':
                    castSpell(object);
                    break;
                case 'save':
                    saveGame();
                    addToOutput("Game saved successfully!", "victory");
                    break;
                case 'load':
                    if (loadGame()) {
                        addToOutput("Game loaded successfully!", "victory");
                        updateStatus();
                        showLocation();
                    } else {
                        addToOutput("No saved game found.", "hint");
                    }
                    break;
                case 'help':
                    showHelp();
                    break;
                case 'quit':
                    quitGame();
                    break;
                default:
                    addToOutput(`Command "${verb}" not implemented yet.`);
            }
        }

        // Move player
        function movePlayer(direction) {
            if (combatActive) {
                addToOutput("You can't run from combat! You must FIGHT!", "combat");
                return;
            }
            
            const currentLoc = locations[gameState.currentLocation];
            const newLocation = currentLoc.exits[direction];
            
            if (!newLocation) {
                addToOutput(`You can't go ${direction}.`);
                return;
            }
            
            // Check if guard blocks the way from dungeon cell
            if (gameState.currentLocation === "dungeonCell" && direction === 'north') {
                if (!gameState.guardRoom.guardDefeated) {
                    addToOutput("You attempt to go north through the cell door...");
                    addToOutput("A CORRUPTED CASTLE GUARD blocks your path!", "enemy");
                    addToOutput("You must defeat him first!");
                    // Start combat with the guard
                    gameState.currentLocation = "guardRoom";
                    showLocation();
                    return;
                }
            }
            
            // Check if trying to leave guardRoom to the east without defeating the guard
            if (gameState.currentLocation === "guardRoom" && direction === 'east') {
                if (!gameState.guardRoom.guardDefeated) {
                    addToOutput("The corrupted guard blocks your way to the east!");
                    addToOutput("You must defeat him first!");
                    return;
                }
            }
            
            gameState.currentLocation = newLocation;
            addToOutput(`You go ${direction}.`);
            showLocation();
        }

        // Look around
        function lookAround() {
            const loc = locations[gameState.currentLocation];
            
            addToOutput(loc.name, "location");
            
            const description = loc.description();
            addToOutput(description);
            
            const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
            if (exits.length > 0) {
                addToOutput("Exits: " + exits.map(exit => exit.toUpperCase()).join(", "));
            }
        }

        // Show inventory
        function showInventory() {
            if (player.inventory.length === 0) {
                addToOutput("You are carrying nothing.");
            } else {
                addToOutput("You are carrying: " + player.inventory.map(item => item.toUpperCase()).join(", "));
            }
            
            // Show equipped items
            addToOutput(`Equipped weapon: ${player.weapon.name} (${player.weapon.minDamage}-${player.weapon.maxDamage} damage)`, "player");
            
            // Show spells
            if (player.spells.length > 0) {
                addToOutput("Known spells: " + player.spells.map(spell => spell.toUpperCase()).join(", "), "magic");
                addToOutput("Use CAST [spell name] to cast a spell.");
            }
            
            addToOutput(`HP: ${player.currentHP}/${player.maxHP} | MP: ${player.currentMP}/${player.maxMP}`, "health");
            addToOutput(`Gold: ${player.gold}`, "gold");
        }

        // Take item
        function takeItem(itemName) {
            if (!itemName) {
                addToOutput("Take what?");
                return;
            }
            
            const loc = locations[gameState.currentLocation];
            const itemIndex = loc.items.findIndex(item => item.toLowerCase().includes(itemName.toLowerCase()));
            
            if (itemIndex === -1) {
                addToOutput(`I don't see a ${itemName} here.`);
                return;
            }
            
            const item = loc.items[itemIndex];
            
            // Handle specific items
            if (item === "rusty sword") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.guardRoom.swordTaken = true;
                addToOutput(`You take the rusty sword!`);
                addToOutput("You can EQUIP RUSTY SWORD to use it as a weapon.", "hint");
            } else if (item === "iron key") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.dungeonCell.keyTaken = true;
                addToOutput(`You take the iron key!`);
                addToOutput("This might unlock something.", "hint");
            } else if (item === "silver key") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.guardRoom.silverKeyTaken = true;
                addToOutput(`You take the delicate silver key!`, "victory");
                addToOutput("It feels warm to the touch.", "hint");
            } else if (item === "health potion") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.dungeonCell.potionTaken = true;
                addToOutput(`You take the health potion!`);
                addToOutput("Use HEALTH POTION to restore 20 HP.", "hint");
            } else if (item === "ancient scroll") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.library.scrollTaken = true;
                addToOutput(`You take the ancient scroll!`, "magic");
                addToOutput("READ SCROLL to learn its contents.", "hint");
            } else if (item === "shadow essence") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                addToOutput(`You take the shadow essence!`, "item");
                addToOutput("It shimmers with dark energy.", "hint");
            } else {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                addToOutput(`You take the ${item}.`);
            }
            
            updateStatus();
        }

        // Drop item
        function dropItem(itemName) {
            if (!itemName) {
                addToOutput("Drop what?");
                return;
            }
            
            const itemIndex = player.inventory.findIndex(item => item.toLowerCase().includes(itemName.toLowerCase()));
            
            if (itemIndex === -1) {
                addToOutput(`You're not carrying a ${itemName}.`);
                return;
            }
            
            const item = player.inventory[itemIndex];
            
            // Check if it's equipped
            if (player.weapon.name.toLowerCase() === item.toLowerCase()) {
                addToOutput("You must unequip the item first!");
                return;
            }
            
            player.inventory.splice(itemIndex, 1);
            locations[gameState.currentLocation].items.push(item);
            
            // Update game state
            if (item === "iron key") gameState.dungeonCell.keyTaken = false;
            if (item === "health potion") gameState.dungeonCell.potionTaken = false;
            if (item === "rusty sword") gameState.guardRoom.swordTaken = false;
            if (item === "silver key") gameState.guardRoom.silverKeyTaken = false;
            if (item === "ancient scroll") gameState.library.scrollTaken = false;
            
            addToOutput(`You drop the ${item}.`);
            updateStatus();
        }

        // Examine object
        function examineObject(objectName) {
            if (!objectName) {
                addToOutput("Examine what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            const loc = locations[gameState.currentLocation];
            
            // Check inventory
            const inventoryItem = player.inventory.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (inventoryItem) {
                if (objectDescriptions[inventoryItem]) {
                    addToOutput(objectDescriptions[inventoryItem]);
                } else {
                    addToOutput(`You examine the ${inventoryItem}. It's in your inventory.`);
                }
                return;
            }
            
            // Check location items
            const locationItem = loc.items.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (locationItem) {
                if (objectDescriptions[locationItem]) {
                    addToOutput(objectDescriptions[locationItem]);
                } else {
                    addToOutput(`You examine the ${locationItem}.`);
                }
                return;
            }
            
            // DUNGEON CELL EXAMINATIONS
            if (gameState.currentLocation === "dungeonCell") {
                if (objectLower.includes("bed") || objectLower.includes("straw")) {
                    gameState.dungeonCell.bedExamined = true;
                    if (!gameState.dungeonCell.keyTaken && !loc.items.includes('iron key')) {
                        addToOutput("You search through the musty straw bed. Underneath, you find an IRON KEY!");
                        loc.items.push('iron key');
                    } else {
                        addToOutput("The straw bed is old and uncomfortable. Nothing else of interest here.");
                    }
                    return;
                }
                
                if (objectLower.includes("barrel")) {
                    addToOutput("The rusty barrel is empty, but you notice something odd about the wall behind it.");
                    addToOutput("There appears to be a LOOSE BRICK in the wall.");
                    return;
                }
                
                if (objectLower.includes("brick") || objectLower.includes("loose")) {
                    gameState.dungeonCell.brickExamined = true;
                    if (!gameState.dungeonCell.potionTaken && !loc.items.includes('health potion')) {
                        addToOutput("You pry the loose brick from the wall. Behind it, you find a HEALTH POTION!");
                        loc.items.push('health potion');
                        gameState.dungeonCell.looseBrickFound = true;
                    } else {
                        addToOutput("You've already removed the loose brick.");
                    }
                    return;
                }
            }
            
            // GUARD ROOM EXAMINATIONS
            if (gameState.currentLocation === "guardRoom") {
                if (objectLower.includes("portrait") || objectLower.includes("painting")) {
                    gameState.guardRoom.portraitExamined = true;
                    addToOutput("The portrait shows a noble lord in fine clothing. The eyes seem to follow you.");
                    
                    if (!gameState.guardRoom.secretFound) {
                        addToOutput("Upon closer inspection, you notice the portrait has a small hidden compartment!");
                        gameState.guardRoom.secretFound = true;
                        
                        if (!gameState.guardRoom.silverKeyTaken && !loc.items.includes('silver key')) {
                            addToOutput("Inside the compartment, you find a SILVER KEY!", "victory");
                            loc.items.push('silver key');
                        }
                    } else {
                        addToOutput("You've already discovered the portrait's secret.");
                    }
                    return;
                }
                
                if (objectLower.includes("table") || objectLower.includes("chair")) {
                    addToOutput(objectDescriptions[objectLower.includes("table") ? "table" : "chair"]);
                    if (gameState.guardRoom.guardDefeated) {
                        addToOutput("There are some papers scattered on the table, but they're all blank.");
                    }
                    return;
                }
            }
            
            // LIBRARY EXAMINATIONS
            if (gameState.currentLocation === "library") {
                // Check for bookshelf/bookshelves
                if (objectLower.includes("bookshelf") || objectLower.includes("bookshelves") || objectLower.includes("shelf")) {
                    addToOutput("The bookshelves are filled with ancient tomes on magic, history, and dark arts.");
                    addToOutput("Most are too damaged to read, but one DUSTY TOME looks intact.");
                    return;
                }
                
                if (objectLower.includes("fireplace")) {
                    gameState.library.fireplaceExamined = true;
                    addToOutput("The large stone fireplace is filled with cold ashes from long-dead fires.");
                    
                    if (!loc.items.includes('silver key') && player.inventory.includes('silver key')) {
                        addToOutput("As you examine the ashes, you notice the silver key in your pocket begins to glow!");
                        addToOutput("Perhaps the key has something to do with this fireplace...", "hint");
                    }
                    return;
                }
                
                if (objectLower.includes("tome")) {
                    gameState.library.tomeExamined = true;
                    addToOutput("The dusty tome is titled 'Healing Arts of the Ancient Mages'.");
                    addToOutput("Reading it might teach you something useful.", "hint");
                    addToOutput("You could READ TOME to learn from it.");
                    return;
                }
                
                if (objectLower.includes("librarian")) {
                    addToOutput("An elderly librarian with spectacles perched on his nose. He seems absorbed in his work.");
                    addToOutput("You could TALK LIBRARIAN to speak with him.");
                    return;
                }
            }
            
            // Check general object descriptions
            if (objectDescriptions[objectLower]) {
                addToOutput(objectDescriptions[objectLower]);
                return;
            }
            
            // Partial matches
            for (const [objKey, description] of Object.entries(objectDescriptions)) {
                if (objKey.includes(objectLower) || objectLower.includes(objKey)) {
                    addToOutput(description);
                    return;
                }
            }
            
            // Direction check
            if (['north', 'south', 'east', 'west'].includes(objectLower)) {
                const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
                if (exits.includes(objectLower)) {
                    addToOutput(`You look ${objectLower}. You can go that way.`);
                } else {
                    addToOutput(`You look ${objectLower}. You cannot go that way.`);
                }
                return;
            }
            
            addToOutput(`You don't see a ${objectName} here.`);
        }

        // Use item
        function useItem(objectName) {
            if (!objectName) {
                addToOutput("Use what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Check if using health potion
            if (objectLower.includes("health potion") && player.inventory.includes("health potion")) {
                const potionIndex = player.inventory.indexOf("health potion");
                player.inventory.splice(potionIndex, 1);
                
                const healAmount = 20;
                player.currentHP = Math.min(player.maxHP, player.currentHP + healAmount);
                addToOutput(`You drink the health potion. It restores ${healAmount} HP!`, "health");
                updateStatus();
                return;
            }
            
            // Check if using torch
            if (objectLower.includes("torch") && player.inventory.includes("torch")) {
                addToOutput("You light the torch. It provides a warm, flickering light.");
                addToOutput("The light might help you see hidden things.", "hint");
                return;
            }
            
            // Check if using shadow essence
            if (objectLower.includes("shadow essence") && player.inventory.includes("shadow essence")) {
                addToOutput("You examine the shadow essence. It swirls with dark energy.");
                addToOutput("You're not sure how to use this yet. Perhaps someone in the library would know.", "hint");
                return;
            }
            
            // Check if using key on fireplace
            if ((objectLower.includes("silver key") || objectLower.includes("key")) && 
                gameState.currentLocation === "library") {
                
                if (!player.inventory.includes("silver key")) {
                    addToOutput("You don't have a silver key.");
                    return;
                }
                
                if (gameState.library.fireplaceExamined) {
                    addToOutput("You insert the silver key into a hidden keyhole in the fireplace.", "player");
                    addToOutput("The fireplace slides aside, revealing a secret passage!", "victory");
                    addToOutput("A new exit to the NORTH has been revealed!");
                    locations.library.exits.north = "secretPassage";
                    updateStatus();
                } else {
                    addToOutput("You're not sure where to use the key here.");
                }
                return;
            }
            
            addToOutput(`You're not sure how to use the ${objectName} here.`);
        }

        // Equip item
        function equipItem(itemName) {
            if (!itemName) {
                addToOutput("Equip what?");
                return;
            }
            
            const objectLower = itemName.toLowerCase();
            
            // Check if it's in inventory
            const inventoryItem = player.inventory.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (!inventoryItem) {
                addToOutput(`You don't have a ${itemName}.`);
                return;
            }
            
            // Handle weapons
            if (inventoryItem === "rusty sword") {
                player.weapon = {
                    name: "Rusty Sword",
                    minDamage: 6,
                    maxDamage: 9,
                    type: "melee"
                };
                player.equippedItems.weapon = "Rusty Sword";
                addToOutput(`You equip the rusty sword! (Damage: 6-9)`, "player");
                updateStatus();
                return;
            }
            
            if (inventoryItem === "fists") {
                player.weapon = {
                    name: "Fists",
                    minDamage: 4,
                    maxDamage: 6,
                    type: "melee"
                };
                player.equippedItems.weapon = "Fists";
                addToOutput(`You equip your fists! (Damage: 4-6)`, "player");
                updateStatus();
                return;
            }
            
            addToOutput(`You can't equip the ${inventoryItem}.`);
        }

        // Unequip item
        function unequipItem(itemName) {
            if (!itemName) {
                addToOutput("Unequip what?");
                return;
            }
            
            const objectLower = itemName.toLowerCase();
            
            // Check if it's equipped
            if (player.weapon.name.toLowerCase().includes(objectLower)) {
                // Check if we have fists in inventory (we always do)
                player.weapon = {
                    name: "Fists",
                    minDamage: 4,
                    maxDamage: 6,
                    type: "melee"
                };
                player.equippedItems.weapon = "Fists";
                addToOutput(`You unequip your weapon and use your fists.`, "player");
                updateStatus();
                return;
            }
            
            addToOutput(`You don't have ${itemName} equipped.`);
        }

        // Open object
        function openObject(objectName) {
            if (!objectName) {
                addToOutput("Open what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            if (objectLower.includes("door")) {
                const loc = locations[gameState.currentLocation];
                const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
                
                if (exits.length > 0) {
                    addToOutput("The door is already open.");
                } else {
                    addToOutput("There's no door to open here.");
                }
                return;
            }
            
            addToOutput(`You can't open the ${objectName}.`);
        }

        // Read object
        function readObject(objectName) {
            if (!objectName) {
                addToOutput("Read what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Read spellbook
            if ((objectLower.includes("spellbook") || objectLower.includes("spell book")) && 
                player.inventory.includes("leather bound spellbook")) {
                
                addToOutput("You open your spellbook:", "magic");
                addToOutput(" ");
                
                if (player.spells.length === 0) {
                    addToOutput("The spellbook is empty.", "magic");
                } else {
                    player.spells.forEach(spellName => {
                        const spell = spells[spellName];
                        if (spell) {
                            addToOutput(`${spell.name.toUpperCase()}: ${spell.description}`, "magic");
                            addToOutput(`  MP Cost: ${spell.cost}`, "magic");
                        }
                    });
                }
                
                addToOutput(" ");
                addToOutput("Use CAST [spell name] to cast a spell.", "hint");
                return;
            }
            
            // Read scroll - FIXED CONDITION
            if (objectLower.includes("scroll")) {
                // Check if player has the ancient scroll
                const hasAncientScroll = player.inventory.includes("ancient scroll");
                const hasScroll = player.inventory.some(item => item.toLowerCase().includes("scroll"));
                
                if (hasAncientScroll) {
                    if (!gameState.library.healSpellLearned) {
                        gameState.library.healSpellLearned = true;
                        
                        // Learn heal spell
                        if (!player.spells.includes("heal")) {
                            player.spells.push("heal");
                            addToOutput("You read the ancient scroll...", "magic");
                            addToOutput("It contains instructions for a healing spell!", "magic");
                            addToOutput("You have learned the HEAL spell!", "victory");
                            addToOutput("Use CAST HEAL to restore your health.", "hint");
                            
                            // Remove scroll from inventory
                            const scrollIndex = player.inventory.indexOf("ancient scroll");
                            player.inventory.splice(scrollIndex, 1);
                        }
                    } else {
                        addToOutput("You've already learned from this scroll.");
                    }
                } else if (hasScroll) {
                    // Check for any other scroll
                    const scrollItem = player.inventory.find(item => item.toLowerCase().includes("scroll"));
                    addToOutput(`You read the ${scrollItem}, but it's written in a language you don't understand.`);
                } else {
                    addToOutput("You don't have a scroll to read.");
                }
                return;
            }
            
            // Read tome
            if (objectLower.includes("tome") && gameState.currentLocation === "library") {
                if (gameState.library.tomeExamined) {
                    addToOutput("You spend some time studying the dusty tome...");
                    addToOutput("It contains advanced magical theory, but nothing practical you can use right now.");
                    addToOutput("However, you feel your magical knowledge has increased slightly.", "magic");
                    
                    // Small MP increase for studying
                    player.maxMP += 2;
                    player.currentMP = Math.min(player.maxMP, player.currentMP + 2);
                    addToOutput(`Your maximum MP has increased by 2! (Now: ${player.maxMP})`, "magic");
                    updateStatus();
                } else {
                    addToOutput("You need to examine the tome first.");
                }
                return;
            }
            
            addToOutput(`There's nothing to read on the ${objectName}.`);
        }

        // Cast spell
        function castSpell(spellName) {
            if (!spellName) {
                addToOutput("Cast what spell?");
                return;
            }
            
            const spellLower = spellName.toLowerCase();
            
            // Find the spell
            let spellToCast = null;
            let spellKey = null;
            
            for (const [key, spell] of Object.entries(spells)) {
                if (spell.name.toLowerCase().includes(spellLower) || spellLower.includes(key)) {
                    spellToCast = spell;
                    spellKey = key;
                    break;
                }
            }
            
            if (!spellToCast) {
                // Check if player knows a spell with similar name
                const knownSpell = player.spells.find(s => 
                    s.toLowerCase().includes(spellLower) || spellLower.includes(s.toLowerCase())
                );
                
                if (knownSpell) {
                    spellToCast = spells[knownSpell];
                    spellKey = knownSpell;
                }
            }
            
            if (!spellToCast) {
                addToOutput(`You don't know the spell '${spellName}'.`, "magic");
                return;
            }
            
            // Check if player has enough MP
            if (player.currentMP < spellToCast.cost) {
                addToOutput(`Not enough MP! You need ${spellToCast.cost} MP to cast ${spellToCast.name}.`, "magic");
                return;
            }
            
            // Deduct MP and cast spell
            player.currentMP -= spellToCast.cost;
            addToOutput(`You cast ${spellToCast.name}! (${spellToCast.cost} MP used)`, "magic");
            
            // Execute spell effect
            const success = spellToCast.effect();
            
            if (success) {
                updateStatus();
            }
        }

        // Talk to NPC
        function talkTo(objectName) {
            if (!objectName) {
                addToOutput("Talk to who?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Talking to librarian in library
            if ((objectLower.includes("librarian")) && gameState.currentLocation === "library") {
                
                if (!gameState.library.librarianTalked) {
                    addToOutput("You approach the elderly librarian.", "npc");
                    addToOutput("Librarian: 'Ah, a visitor! Rare to see new faces in these cursed halls.'", "npc");
                    addToOutput("Librarian: 'Be careful, the castle is not what it seems. Time flows strangely here.'", "npc");
                    addToOutput("Librarian: 'If you find any magical artifacts, I might be able to tell you about them.'", "npc");
                    gameState.library.librarianTalked = true;
                } else {
                    addToOutput("Librarian: 'Back again? Have you found anything interesting?'", "npc");
                    
                    // Check if player has shadow essence
                    if (player.inventory.includes("shadow essence")) {
                        addToOutput("You show the shadow essence to the librarian.", "player");
                        addToOutput("Librarian: 'Ah, shadow essence! Rare and dangerous.',", "npc");
                        addToOutput("Librarian: 'It can be used to create powerful darkness magic,", "npc");
                        addToOutput("Librarian: 'but you'll need a proper alchemy lab to refine it.'", "npc");
                    }
                }
                return;
            }
            
            if (objectLower.includes("guard") && combatActive) {
                addToOutput("The corrupted guard snarls and attacks! He's beyond reasoning with!", "enemy");
                return;
            }
            
            addToOutput("There's no one here to talk to.");
        }

        // Give item
        function giveItem(objectName) {
            if (!objectName) {
                addToOutput("Give what?");
                return;
            }
            
            const parts = objectName.toLowerCase().split(' to ');
            if (parts.length < 2) {
                addToOutput("Give what to whom?");
                return;
            }
            
            const itemName = parts[0].trim();
            const recipient = parts[1].trim();
            
            // Giving shadow essence to librarian
            if (recipient.includes("librarian") && gameState.currentLocation === "library") {
                if (!itemName.includes("shadow") && !itemName.includes("essence")) {
                    addToOutput("The librarian isn't interested in that.");
                    return;
                }
                
                if (!player.inventory.includes("shadow essence")) {
                    addToOutput("You don't have any shadow essence.");
                    return;
                }
                
                // Give shadow essence to librarian
                const essenceIndex = player.inventory.indexOf("shadow essence");
                player.inventory.splice(essenceIndex, 1);
                
                addToOutput("You give the shadow essence to the librarian.", "player");
                addToOutput("Librarian: 'Thank you! This is quite valuable.',", "npc");
                addToOutput("Librarian: 'Let me give you something in return.'", "npc");
                addToOutput("The librarian gives you 25 gold and a scroll containing the LIGHT spell!", "victory");
                
                player.gold += 25;
                
                // Learn light spell if not already known
                if (!player.spells.includes("light")) {
                    player.spells.push("light");
                    addToOutput("You have learned the LIGHT spell!", "magic");
                }
                
                updateStatus();
                return;
            }
            
            addToOutput("There's no one here to give anything to.");
        }

        // Attack enemy
        function attackEnemy(objectName) {
            if (!objectName) {
                addToOutput("Attack what?");
                return;
            }
            
            if (combatActive) {
                playerAttack();
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // If in dungeon cell and trying to attack guard
            if (gameState.currentLocation === "dungeonCell" && objectLower.includes("guard")) {
                addToOutput("You can't attack the guard from here. You need to go north to face him.");
                return;
            }
            
            // If in guard room and guard is not defeated
            if ((objectLower.includes("guard")) && 
                gameState.currentLocation === "guardRoom" && !gameState.guardRoom.guardDefeated) {
                // Start combat if not already in combat
                if (!combatActive) {
                    startCombat("corruptedGuard");
                }
                return;
            }
            
            addToOutput("There's nothing to attack here.");
        }

        // Show help
        function showHelp() {
            addToOutput("CASTLE OF THE DAMMED 1984 - COMMANDS", "location");
            addToOutput("Movement: NORTH, SOUTH, EAST, WEST (or N, S, E, W)");
            addToOutput("Basic: LOOK, EXAMINE [object], TAKE [item], DROP [item], INVENTORY");
            addToOutput("Equipment: EQUIP [weapon], UNEQUIP [weapon]");
            addToOutput("Interactive: USE [item], OPEN [object], READ [object], TALK [NPC], GIVE [item] TO [NPC]");
            addToOutput("Magic: CAST [spell name] (requires MP)", "magic");
            addToOutput("COMBAT: ATTACK (in combat)", "combat");
            addToOutput("Game: SAVE, LOAD, RESTART, HELP, QUIT");
            addToOutput(" ");
            addToOutput("DISCOVERY TIPS:", "hint");
            addToOutput("- Examine everything carefully for clues and hidden items", "hint");
            addToOutput("- Use LOOK to see what's around you", "hint");
            addToOutput("- Some items can only be found by examining objects multiple times", "hint");
            addToOutput("- Talk to NPCs for information and quests", "hint");
            addToOutput("- Equip better weapons for combat advantage", "hint");
            addToOutput("- Save your game often!", "hint");
        }

        // Quit game
        function quitGame() {
            addToOutput("Are you sure you want to quit? Your progress is saved automatically. (Y/N)");
            
            const originalEventHandler = gameInput.onkeypress;
            
            gameInput.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    const answer = this.value.trim().toLowerCase();
                    if (answer === 'y' || answer === 'yes') {
                        addToOutput("Thanks for playing Castle of the Dammed 1984!");
                        gameState.gameEnded = true;
                    } else {
                        addToOutput("Resuming game...");
                    }
                    
                    gameInput.onkeypress = originalEventHandler;
                    gameInput.value = '';
                    gameInput.focus();
                }
            };
        }

        // Initialize the game when the page loads
        window.onload = initGame;
    </script>
</body>
</html>
