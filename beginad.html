<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle of the Undead 1984 - COMPLETE</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        /* ---------- RETRO TERMINAL UI ---------- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            line-height: 1.6;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            overflow-x: hidden;
        }
        .game-container {
            border: 2px solid #fff;
            padding: 20px;
            margin-top: 20px;
            height: 75vh;
            display: flex;
            flex-direction: column;
        }
        .game-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px dashed #fff;
            padding-bottom: 10px;
        }
        .game-title {
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #fff;
        }
        .game-subtitle {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }
        .game-output {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
            border: 1px solid #333;
            padding: 15px;
            background-color: #111;
        }
        .game-output p { margin-bottom: 10px; animation: fadeIn 0.5s ease-in-out; }
        .game-output .location { color: #ffff00; margin-top: 15px; margin-bottom: 15px; }
        .game-output .hint { color: #888; font-style: italic; font-size: 12px; margin-top: 20px; }
        .game-output .item { color: #55ff55; }
        .game-output .victory { color: #ffff55; font-weight: bold; }
        .game-output .gold { color: #ffd700; }
        .game-output .health { color: #ff6666; }
        .game-output .npc { color: #55ffff; }
        .game-output .combat { color: #ff4444; font-weight: bold; }
        .game-output .damage { color: #ff9966; }
        .game-output .magic { color: #ff66ff; }
        .game-input-container {
            display: flex;
            align-items: center;
            border-top: 1px dashed #fff;
            padding-top: 15px;
        }
        .game-prompt { margin-right: 10px; color: #00ff00; }
        #game-input {
            background-color: #000;
            color: #fff;
            border: 1px solid #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            padding: 10px;
            flex-grow: 1;
            outline: none;
        }
        #game-input:focus { box-shadow: 0 0 5px #fff; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .game-output::-webkit-scrollbar { width: 10px; }
        .game-output::-webkit-scrollbar-track { background: #111; }
        .game-output::-webkit-scrollbar-thumb { background: #333; border-radius: 5px; }
        .game-output::-webkit-scrollbar-thumb:hover { background: #444; }
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #222;
            border: 1px solid #444;
            font-size: 12px;
            flex-wrap: wrap;
        }
        .status-item { display: flex; align-items: center; margin-right: 10px; }
        .health-bar {
            width: 100px;
            height: 12px;
            background-color: #333;
            margin-left: 5px;
            border: 1px solid #555;
        }
        .health-fill { height: 100%; background-color: #ff5555; transition: width 0.3s; }
        @media (max-width: 600px) {
            body { font-size: 14px; padding: 10px; }
            .game-title { font-size: 18px; }
            .game-container { padding: 10px; }
            #game-input { font-size: 12px; padding: 8px; }
            .status-bar { font-size: 10px; flex-direction: column; gap: 5px; }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1 class="game-title">CASTLE OF THE UNDEAD 1984</h1>
        <p class="game-subtitle">© 1984 Undead Castle Software</p>
        <p class="game-subtitle">COMPLETE EDITION — 13 ROOMS · BOSS FIGHTS · CRAFTING · ENDINGS</p>
    </div>
    
    <!-- STATUS BAR: HP, GOLD, WEAPON, ARMOR, BUFFS -->
    <div class="status-bar" id="status-bar">
        <div class="status-item">
            HP: <span id="player-hp-text">100/100</span>
            <div class="health-bar">
                <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
            </div>
        </div>
        <div class="status-item">
            Gold: <span id="player-gold">0</span>
        </div>
        <div class="status-item">
            Weapon: <span id="player-weapon">Fists (1-2)</span>
        </div>
        <div class="status-item">
            Armor: <span id="player-armor">None</span>
        </div>
        <div class="status-item">
            Weight: <span id="player-weight">0/30</span>
        </div>
    </div>
    
    <div class="game-container">
        <div class="game-output" id="game-output"></div>
        <div class="game-input-container">
            <span class="game-prompt">&gt;</span>
            <input type="text" id="game-input" placeholder="Type your command..." autocomplete="off">
        </div>
    </div>

    <script>
        // ==================== CASTLE OF THE UNDEAD - COMPLETE EDITION ====================
        // SAVE KEY
        const SAVE_KEY = 'castleUndead1984CompleteSave';

        // ==================== DEFAULT ROOM ITEMS (INITIAL STATE) ====================
        const DEFAULT_ROOM_ITEMS = {
            // Original three rooms
            outsideGates: ["rope"],
            courtyard: [],
            entranceHall: [],
            
            // NEW ROOMS - 10 total
            guardhouse: ["torch", "shield", "guard's log"],
            armory: ["steel sword", "chainmail", "lockpicks"],
            kitchen: ["cooking oil", "cleaver", "dried herbs"],
            wineCellar: ["antique wine", "cork", "empty bottle"],
            chapel: ["holy water", "silver cross", "prayer beads"],
            bellTower: ["heavy rope", "earplugs", "viewing lens"],
            library: ["spell scroll: fireball", "encyclopedia of undead", "blank book"],
            observatory: ["star chart", "telescope lens", "astrolabe"],
            throneRoom: ["royal crown", "soul gem", "necromancer's staff"],
            treasury: ["dragon's tooth dagger", "cloak of shadows", "amulet of life", "orb of scrying", "bag of holding"]
        };

        // ==================== PLAYER STATS ====================
        const player = {
            maxHP: 100,
            currentHP: 100,
            gold: 0,
            inventory: [],
            weapon: { name: "Fists", minDamage: 1, maxDamage: 2, type: "blunt" },
            armor: null,
            maxWeight: 30,
            currentWeight: function() {
                let weight = 0;
                this.inventory.forEach(item => {
                    weight += itemWeights[item] || 1;
                });
                weight += this.gold * 0.01;
                return Math.round(weight * 10) / 10;
            },
            blessings: [], // permanent buffs
            poisonTurns: 0
        };

        // ==================== ITEM WEIGHTS ====================
        const itemWeights = {
            "rope": 1, "heavy rope": 2, "rusty key": 0.2, "dagger": 1, "health potion": 0.5,
            "torch": 1.5, "shield": 4, "guard's log": 1, "steel sword": 3, "chainmail": 8,
            "lockpicks": 0.2, "cooking oil": 1, "cleaver": 1.5, "dried herbs": 0.2,
            "antique wine": 2, "cork": 0.1, "empty bottle": 0.3, "holy water": 0.5,
            "silver cross": 1, "prayer beads": 0.3, "heavy rope": 2, "earplugs": 0.1,
            "viewing lens": 0.5, "spell scroll: fireball": 0.2, "encyclopedia of undead": 2,
            "blank book": 1, "star chart": 0.3, "telescope lens": 0.5, "astrolabe": 1.5,
            "royal crown": 2, "soul gem": 0.5, "necromancer's staff": 4, "dragon's tooth dagger": 1.5,
            "cloak of shadows": 2, "amulet of life": 0.5, "orb of scrying": 2, "bag of holding": 1,
            "rat tail": 0.1, "spider silk": 0.2, "cursed blade": 3, "ghostly essence": 0.2,
            "family signet ring": 0.1, "masterwork dagger": 1, "silver key": 0.2,
            "tower key": 0.3, "antivenom": 0.5
        };

        // ==================== WEAPON STATS ====================
        const weapons = {
            "fists": { name: "Fists", minDamage: 1, maxDamage: 2, type: "blunt" },
            "dagger": { name: "Dagger", minDamage: 3, maxDamage: 6, type: "pierce" },
            "steel sword": { name: "Steel Sword", minDamage: 5, maxDamage: 9, type: "slash" },
            "cleaver": { name: "Cleaver", minDamage: 4, maxDamage: 7, type: "slash" },
            "cursed blade": { name: "Cursed Blade", minDamage: 8, maxDamage: 14, type: "dark", 
                onHit: function() { 
                    player.currentHP -= 2; 
                    addToOutput("The cursed blade drains your life force!", "damage");
                } 
            },
            "masterwork dagger": { name: "Masterwork Dagger", minDamage: 4, maxDamage: 8, type: "pierce", crit: 0.15 },
            "dragon's tooth dagger": { name: "Dragon's Tooth Dagger", minDamage: 8, maxDamage: 12, type: "fire", crit: 0.1 },
            "necromancer's staff": { name: "Necromancer's Staff", minDamage: 6, maxDamage: 10, type: "magic", 
                onHit: function(enemy) { 
                    enemy.poisonTurns = (enemy.poisonTurns || 0) + 2;
                    addToOutput("Shadow magic seeps into the wound!", "magic");
                } 
            }
        };

        // ==================== ARMOR STATS ====================
        const armors = {
            "shield": { name: "Shield", damageReduction: 2, weight: 4 },
            "chainmail": { name: "Chainmail", damageReduction: 3, maxHPBonus: 10, weight: 8 }
        };

        // ==================== ENEMY DEFINITIONS ====================
        const enemies = {
            // Original
            ratSwarm: {
                name: "Rat Swarm", maxHP: 20, currentHP: 20, minDamage: 2, maxDamage: 5,
                description: "Dozens of rats, moving as one hungry mass.",
                defeatMessage: "The rats scatter into the shadows!",
                loot: "rat tail", vulnerabilities: ["fire"], resistances: ["cold"], type: "beast"
            },
            giantSpider: {
                name: "Giant Spider", maxHP: 40, currentHP: 40, minDamage: 5, maxDamage: 9,
                description: "A hairy arachnid the size of a horse. Its fangs drip venom.",
                defeatMessage: "The spider curls up and dies.",
                loot: "spider silk", vulnerabilities: ["fire"], resistances: ["poison"], 
                poisonAttack: true, poisonDamage: 3, type: "beast"
            },
            animatedArmor: {
                name: "Animated Armor", maxHP: 35, currentHP: 35, minDamage: 4, maxDamage: 8,
                description: "An empty suit of armor that moves with jerky, unnatural motions.",
                defeatMessage: "The armor clatters to the floor, inert.",
                loot: "steel sword", vulnerabilities: ["lightning", "blunt"], resistances: ["slash", "pierce"], type: "construct"
            },
            ghostCook: {
                name: "Ghost Cook", maxHP: 25, currentHP: 25, minDamage: 3, maxDamage: 6,
                description: "The spectral form of the castle's chef. He still holds a cleaver.",
                defeatMessage: "The ghost fades away with a sigh.",
                loot: "ghostly essence", vulnerabilities: ["holy", "fire"], resistances: ["cold", "pierce"], 
                ethereal: true, type: "undead"
            },
            deathKnight: {
                name: "Death Knight", maxHP: 60, currentHP: 60, minDamage: 7, maxDamage: 12,
                description: "A fallen paladin, corrupted by the necromancer's curse.",
                defeatMessage: "The knight crumbles to dust.",
                loot: "cursed blade", vulnerabilities: ["holy"], resistances: ["cold", "dark"], type: "undead"
            },
            harpy: {
                name: "Harpy", maxHP: 30, currentHP: 30, minDamage: 4, maxDamage: 7,
                description: "A foul bird-woman with razor-sharp talons.",
                defeatMessage: "The harpy plummets from the tower.",
                loot: "feather", vulnerabilities: ["ranged"], resistances: [], flying: true, type: "beast"
            },
            livingBooks: {
                name: "Living Books", maxHP: 15, currentHP: 15, minDamage: 2, maxDamage: 4,
                description: "Animated tomes that flap and bite.",
                defeatMessage: "The books lie still.",
                loot: "blank book", vulnerabilities: ["fire"], resistances: ["blunt"], isSwarm: true, type: "construct"
            },
            starSpawn: {
                name: "Star Spawn", maxHP: 45, currentHP: 45, minDamage: 6, maxDamage: 10,
                description: "An eldritch horror from beyond the stars. Its form hurts to look at.",
                defeatMessage: "The creature unravels into nothingness.",
                loot: "star chart", vulnerabilities: ["holy", "light"], resistances: ["dark", "cold"], 
                confusion: true, type: "eldritch"
            },
            necromancer: {
                name: "Necromancer", maxHP: 80, currentHP: 80, minDamage: 8, maxDamage: 15,
                description: "The source of the curse. Robes crackling with dark energy.",
                defeatMessage: "The necromancer falls, his staff shattering.",
                loot: "necromancer's staff", vulnerabilities: ["holy"], resistances: ["dark", "cold"],
                boss: true, phases: 3, type: "humanoid"
            }
        };

        // ==================== CRAFTING RECIPES ====================
        const recipes = {
            "health potion": {
                ingredients: ["dried herbs", "empty bottle"],
                result: "health potion",
                description: "Restores 20 HP"
            },
            "antivenom": {
                ingredients: ["spider silk", "dried herbs"],
                result: "antivenom",
                description: "Cures poison"
            },
            "holy water": {
                ingredients: ["empty bottle", "holy water font"],
                result: "holy water",
                description: "30 damage to undead"
            }
        };

        // ==================== DIALOGUE DATABASE ====================
        const dialogues = {
            gatekeeper: {
                firstGreeting: [
                    "Gatekeeper: 'Hark, traveler. I am bound to these gates...'",
                    "Gatekeeper: 'I lost my family dagger long ago, somewhere inside the castle.'",
                    "Gatekeeper: 'If you find it, I would be eternally grateful.'",
                    "He glances at the well in the courtyard. 'Perhaps you need something to reach it...'"
                ],
                afterQuest: [
                    "Gatekeeper: 'My heirloom... at last! Thank you, brave soul.'",
                    "He presses a cool vial into your hand. 'Take this health potion.'",
                    "Gatekeeper: 'I can finally rest now. Farewell.'",
                    "The gatekeeper smiles and slowly fades away."
                ],
                idle: [
                    "Gatekeeper: 'Have you found my dagger?'",
                    "Gatekeeper: 'The well in the courtyard... perhaps you need something to reach it.'",
                    "Gatekeeper: 'I miss my family...'"
                ],
                options: {
                    "ask about castle": "Gatekeeper: 'This was once a proud fortress. Now it's a tomb.'",
                    "ask about curse": "Gatekeeper: 'The necromancer came three winters ago. We didn't stand a chance.'",
                    "ask about reward": "Gatekeeper: 'The dagger is priceless to me, but I have a potion to spare.'"
                }
            },
            woundedGuard: {
                firstGreeting: [
                    "Guard: 'Ugh... my leg. The rats got me.'",
                    "Guard: 'I served here for twenty years. Never thought it would end like this.'",
                    "Guard: 'If you can stop the bleeding, I might survive. Do you have bandages? Or herbs?'"
                ],
                healed: [
                    "Guard: 'Ah, that's better. Thank you, friend.'",
                    "Guard: 'Take this signet ring. It's been in my family for generations.'",
                    "Guard: 'Maybe it'll bring you better luck than it brought me.'"
                ],
                idle: [
                    "Guard: 'The pain is unbearable...'",
                    "Guard: 'Please, help me...'"
                ]
            },
            ratKing: {
                firstEncounter: [
                    "A massive rat wearing a tiny crown squeaks threateningly!",
                    "Rat King: 'Squeak! This is MY kitchen! What you offer?'"
                ],
                bribed: [
                    "Rat King: 'Squeak! Acceptable tribute. You may pass.'",
                    "The rat king scurries aside, allowing you through."
                ]
            },
            trappedMerchant: {
                freed: [
                    "Merchant: 'Bless you! I've been stuck in that barrel for hours!'",
                    "Merchant: 'I'm a traveling trader. Name's Alric.'",
                    "Merchant: 'I set up shop in the cellar sometimes. Stop by if you need supplies.'"
                ]
            },
            archivist: {
                firstMeeting: [
                    "A bronze mechanical man whirs to life.",
                    "Archivist: 'Greetings. I am the keeper of knowledge.'",
                    "Archivist: 'I can identify unknown items for 10 gold pieces.'"
                ],
                idle: [
                    "Archivist: 'Knowledge is power, traveler.'",
                    "Archivist: 'Bring me rare books and I shall reward you.'"
                ]
            },
            fatherThomas: {
                firstGreeting: [
                    "Father Thomas: 'This chapel was once a place of hope... now it's desecrated.'",
                    "Father Thomas: 'If you can reconsecrate the altar with holy water, I may be able to bless you.'"
                ],
                afterQuest: [
                    "Father Thomas: 'You've restored my faith. Thank you.'",
                    "He raises his hand in blessing. You feel stronger!",
                    "Father Thomas: 'May the light guide your path.'"
                ]
            },
            queenGhost: {
                firstGreeting: [
                    "Queen's Ghost: 'You've come far, mortal.'",
                    "Queen's Ghost: 'That necromancer stole my soul and bound it to this gem.'",
                    "Queen's Ghost: 'Shatter the Soul Gem on the altar to destroy him permanently.'",
                    "Queen's Ghost: 'Or... take his staff and claim his power. The choice is yours.'"
                ],
                endingGood: [
                    "Queen's Ghost: 'Thank you. At last, I am free.'",
                    "She ascends in a column of golden light, smiling peacefully."
                ],
                endingEvil: [
                    "Queen's Ghost: 'No... what have you done? You're just like him!'",
                    "She fades away, weeping."
                ]
            },
            castleJester: {
                greetings: [
                    "Skeleton Jester: 'Rattle rattle! Why did the skeleton go to the party alone?'",
                    "Skeleton Jester: '... He had no BODY to go with him! Ahaha!'",
                    "He clatters his bones together in amusement."
                ]
            }
        };

        // ==================== GAME STATE ====================
        const gameState = {
            currentLocation: 'outsideGates',
            visitedLocations: [],
            gameEnded: false,
            ending: null,
            
            // Original rooms
            outsideGates: { gateLocked: true, gatekeeperTalked: false, gatekeeperGivenDagger: false },
            courtyard: { bucketRetrieved: false, keyTaken: false },
            entranceHall: { chestOpened: false },
            
            // NEW ROOMS - 10 total
            guardhouse: { guardSaved: false, guardTalked: false, logRead: false },
            armory: { doorUnlocked: false, oilUsed: false, lockpicksUsed: false },
            kitchen: { ratKingBribed: false, cauldronMoved: false },
            wineCellar: { merchantFreed: false, combinationRevealed: false },
            chapel: { altarReconsecrated: false, fatherThomasTalked: false },
            bellTower: { bellRungOnce: false, bellRungThrice: false, secretFound: false },
            library: { archivistTalked: false, bookPuzzleSolved: false },
            observatory: { telescopeAssembled: false, alignmentSolved: false },
            throneRoom: { necromancerDefeated: false, soulGemShattered: false, staffTaken: false },
            treasury: { visited: false }
        };

        // ==================== ROOM DEFINITIONS ====================
        const locations = {
            // --- ORIGINAL THREE ROOMS ---
            outsideGates: {
                name: "OUTSIDE CASTLE GATES",
                description: function() {
                    let desc = "You stand before the ancient Castle of the Undead. Massive iron GATES, rusted and imposing, block the entrance to the north. ";
                    if (!gameState.outsideGates.gatekeeperGivenDagger) {
                        desc += "A ghostly GATEKEEPER drifts near the gate, his spectral form barely visible. ";
                    } else {
                        desc += "The grateful gatekeeper has faded away, leaving only a faint shimmer. ";
                    }
                    desc += "To the east, a breach in the wall leads to the castle courtyard. ";
                    if (this.items.includes('rope')) desc += "A frayed ROPE lies on the ground near the gate.";
                    else desc += "The ground is bare where the rope once lay.";
                    if (!gameState.outsideGates.gateLocked) desc += " The gates now stand open to the north.";
                    return desc;
                },
                items: [], exits: { north: "entranceHall", east: "courtyard" }, visited: false
            },
            courtyard: {
                name: "COURTYARD",
                description: function() {
                    let desc = "You are in a small, overgrown courtyard. An old stone WELL stands in the center. ";
                    if (!gameState.courtyard.bucketRetrieved) desc += "A bucket hangs at the bottom of the well, just out of reach. ";
                    else desc += "The bucket now rests at the top of the well. ";
                    if (this.items.includes('rusty key')) desc += "A RUSTY KEY lies at the bottom of the bucket.";
                    desc += " To the west, the breach leads back to the castle gates.";
                    return desc;
                },
                items: [], exits: { west: "outsideGates" }, visited: false
            },
            entranceHall: {
                name: "ENTRANCE HALL",
                description: function() {
                    let desc = "You enter the castle's entrance hall. Dust and cobwebs cover every surface. ";
                    desc += "In the corner, you see a small wooden CHEST. ";
                    if (!gameState.entranceHall.chestOpened) desc += "The chest is closed.";
                    else desc += "The chest is open and empty.";
                    desc += " The gate to the south leads back outside. ";
                    desc += "A heavy wooden door to the north leads deeper into the castle.";
                    return desc;
                },
                items: [], exits: { south: "outsideGates", north: "guardhouse" }, visited: false
            },

            // --- NEW ROOMS - COMPLETE CASTLE EXPANSION ---
            guardhouse: {
                name: "GUARDHOUSE",
                description: function() {
                    let desc = "A small stone guardhouse where castle guards once kept watch. Arrow slits provide narrow views of the courtyard. ";
                    if (!gameState.guardhouse.guardSaved) {
                        desc += "A WOUNDED GUARD lies on the floor, clutching his bleeding leg. ";
                    } else {
                        desc += "The guard has been bandaged and rests peacefully against the wall. ";
                    }
                    if (this.items.includes('torch')) desc += "A TORCH burns in a wall sconce. ";
                    if (this.items.includes('shield')) desc += "A wooden SHIELD leans against the wall. ";
                    if (this.items.includes("guard's log")) desc += "A leather-bound LOG sits on the desk. ";
                    desc += "A spiral staircase leads UP, and a door leads NORTH to the armory.";
                    return desc;
                },
                items: [], exits: { up: "bellTower", north: "armory", south: "entranceHall" }, visited: false
            },
            armory: {
                name: "ARMORY",
                description: function() {
                    let desc = "Racks of empty weapon stands. Broken swords litter the floor. ";
                    if (!gameState.armory.doorUnlocked) {
                        desc += "A heavy steel door to the east is jammed shut. ";
                    } else {
                        desc += "The steel door to the east now stands open. ";
                    }
                    if (this.items.includes('steel sword')) desc += "A STEEL SWORD lies on the floor. ";
                    if (this.items.includes('chainmail')) desc += "A suit of CHAINMAIL hangs on a mannequin. ";
                    if (this.items.includes('lockpicks')) desc += "LOCKPICKS glint from behind a loose stone. ";
                    return desc;
                },
                items: [], exits: { south: "guardhouse", east: "kitchen" }, visited: false
            },
            kitchen: {
                name: "KITCHEN",
                description: function() {
                    let desc = "A massive hearth dominates the room. Long wooden tables are covered in dust. ";
                    desc += "Pots hang from hooks on the ceiling. The smell of spoiled food lingers. ";
                    
                    if (!gameState.kitchen.ratKingBribed) {
                        desc += "A gigantic rat wearing a tiny crown squeaks at you from atop the table! ";
                    } else {
                        desc += "The rat king has retreated, satisfied with your tribute. ";
                    }
                    
                    if (this.items.includes('cooking oil')) desc += "COOKING OIL sits on the counter. ";
                    if (this.items.includes('cleaver')) desc += "A CLEAVER is stuck in a cutting board. ";
                    if (this.items.includes('dried herbs')) desc += "DRIED HERBS hang from the ceiling. ";
                    
                    desc += "A door leads west back to the armory. Stairs lead DOWN to the wine cellar.";
                    return desc;
                },
                items: [], exits: { west: "armory", down: "wineCellar" }, visited: false
            },
            wineCellar: {
                name: "WINE CELLAR",
                description: function() {
                    let desc = "A cool, dark chamber filled with aging barrels. Cobwebs drape every surface. Water drips somewhere. ";
                    
                    if (!gameState.wineCellar.merchantFreed) {
                        desc += "You hear muffled cries coming from inside one of the barrels! ";
                    } else {
                        desc += "The barrel that once trapped the merchant stands open and empty. ";
                    }
                    
                    if (this.items.includes('antique wine')) desc += "A bottle of ANTIQUE WINE rests on a rack. ";
                    if (this.items.includes('cork')) desc += "A strange CORK lies on the floor. ";
                    if (this.items.includes('empty bottle')) desc += "An EMPTY BOTTLE sits on a shelf. ";
                    
                    desc += "Stairs lead UP back to the kitchen.";
                    return desc;
                },
                items: [], exits: { up: "kitchen" }, visited: false
            },
            chapel: {
                name: "CHAPEL",
                description: function() {
                    let desc = "Stained glass windows depict saints and angels, though most are cracked. Pews are overturned. ";
                    
                    if (!gameState.chapel.altarReconsecrated) {
                        desc += "The altar has been desecrated with dark symbols. ";
                    } else {
                        desc += "The altar now glows with a faint, holy light. ";
                    }
                    
                    if (!gameState.chapel.fatherThomasTalked && !gameState.chapel.altarReconsecrated) {
                        desc += "The ghostly form of FATHER THOMAS kneels before the altar, weeping. ";
                    } else if (gameState.chapel.altarReconsecrated) {
                        desc += "Father Thomas's spirit has ascended. ";
                    }
                    
                    if (this.items.includes('holy water')) desc += "A vial of HOLY WATER rests in a font. ";
                    if (this.items.includes('silver cross')) desc += "A SILVER CROSS lies on the floor. ";
                    if (this.items.includes('prayer beads')) desc += "PRAYER BEADS hang from a pew. ";
                    
                    desc += "A door to the east leads to the bell tower staircase.";
                    return desc;
                },
                items: [], exits: { east: "bellTower" }, visited: false
            },
            bellTower: {
                name: "BELL TOWER",
                description: function() {
                    let desc = "A narrow spiral staircase ascends to the massive bronze BELL above. Wind howls through open arches. ";
                    
                    if (this.items.includes('heavy rope')) desc += "A coil of HEAVY ROPE lies near the bell. ";
                    if (this.items.includes('earplugs')) desc += "EARPLUGS rest on the windowsill. ";
                    if (this.items.includes('viewing lens')) desc += "A VIEWING LENS sits on a ledge. ";
                    
                    desc += "The chapel is below. A ladder leads UP to the bell mechanism.";
                    return desc;
                },
                items: [], exits: { down: "chapel", up: "bellMechanism" }, visited: false
            },
            bellMechanism: {
                name: "BELL MECHANISM",
                description: function() {
                    let desc = "You stand beside the massive bronze bell. A rope hangs from the clapper. ";
                    desc += "An inscription is carved into the bell's surface. ";
                    desc += "You can RING the bell here.";
                    return desc;
                },
                items: [], exits: { down: "bellTower" }, visited: false
            },
            library: {
                name: "LIBRARY",
                description: function() {
                    let desc = "A two-story chamber of knowledge. Ladders on rails run along towering bookshelves. ";
                    
                    if (!gameState.library.archivistTalked) {
                        desc += "A bronze mechanical man, the ARCHIVIST, stands motionless in the center of the room. ";
                    } else {
                        desc += "The Archivist whirs softly as you enter. ";
                    }
                    
                    if (this.items.includes('spell scroll: fireball')) desc += "A SPELL SCROLL glows on a lectern. ";
                    if (this.items.includes('encyclopedia of undead')) desc += "An ENCYCLOPEDIA OF UNDEAD rests on a shelf. ";
                    if (this.items.includes('blank book')) desc += "A BLANK BOOK lies open on a table. ";
                    
                    desc += "A hidden staircase is rumored to lead to the observatory...";
                    return desc;
                },
                items: [], exits: { down: "kitchen" }, visited: false
            },
            observatory: {
                name: "OBSERVATORY",
                description: function() {
                    let desc = "A brass TELESCOPE dominates the circular room. Star charts cover the walls. ";
                    desc += "An intricate ORRERY stands in the corner. ";
                    
                    if (gameState.observatory.telescopeAssembled) {
                        desc += "The telescope is complete and functional. ";
                    } else {
                        desc += "The telescope is missing its lens. ";
                    }
                    
                    if (this.items.includes('star chart')) desc += "A STAR CHART is spread on a table. ";
                    if (this.items.includes('telescope lens')) desc += "A TELESCOPE LENS rests on a velvet cushion. ";
                    if (this.items.includes('astrolabe')) desc += "An ASTROLABE sits beside the orrery. ";
                    
                    desc += "A teleportation circle on the floor glows faintly.";
                    return desc;
                },
                items: [], exits: { down: "library" }, visited: false
            },
            throneRoom: {
                name: "THRONE ROOM",
                description: function() {
                    let desc = "A grand chamber with an obsidian throne. Dark energy crackles through the air. ";
                    
                    if (!gameState.throneRoom.necromancerDefeated) {
                        desc += "The NECROMANCER stands before the throne, staff raised! ";
                    } else {
                        desc += "The necromancer's body lies broken on the floor. ";
                    }
                    
                    if (this.items.includes('royal crown')) desc += "The ROYAL CROWN rests on the throne. ";
                    if (this.items.includes('soul gem')) desc += "A SOUL GEM pulses with trapped light on the altar. ";
                    if (this.items.includes('necromancer\'s staff')) desc += "The NECROMANCER'S STAFF lies where it fell. ";
                    
                    desc += "A hidden door behind the throne leads to the treasury.";
                    return desc;
                },
                items: [], exits: { down: "observatory" }, visited: false
            },
            treasury: {
                name: "ROYAL TREASURY",
                description: function() {
                    let desc = "Mountains of gold, artifacts, and relics fill this vault. ";
                    desc += "The wealth of a kingdom lies before you. ";
                    
                    if (this.items.includes('dragon\'s tooth dagger')) desc += "A DRAGON'S TOOTH DAGGER gleams in a display case. ";
                    if (this.items.includes('cloak of shadows')) desc += "A CLOAK OF SHADOWS hangs on a mannequin. ";
                    if (this.items.includes('amulet of life')) desc += "An AMULET OF LIFE pulses with warm energy. ";
                    if (this.items.includes('orb of scrying')) desc += "An ORB OF SCRYING shows distant places. ";
                    if (this.items.includes('bag of holding')) desc += "A BAG OF HOLDING sits open, its interior impossibly deep. ";
                    
                    desc += "A skeleton in jester's clothes rattles nearby.";
                    return desc;
                },
                items: [], exits: { up: "throneRoom" }, visited: false
            }
        };

        // ==================== OBJECT DESCRIPTIONS ====================
        const objectDescriptions = {
            // Original
            "rope": "A sturdy, frayed rope. It looks strong enough to hold a man's weight.",
            "rusty key": "An old iron key, covered in rust. It might fit a gate or a chest.",
            "gate": "Massive iron gates, sealed tight. They need a key to open.",
            "well": "A deep stone well. A bucket hangs at the bottom, just beyond your reach.",
            "chest": "A small wooden chest reinforced with iron bands. It's locked.",
            "bucket": "An old metal bucket. It's at the bottom of the well.",
            "breach": "A gap in the wall, just wide enough to slip through. It leads east to the courtyard.",
            "dagger": "A sharp, well‑balanced dagger. A fine weapon. Damage: 3-6.",
            "health potion": "A crimson liquid in a small vial. Restores 20 HP when used.",
            "gatekeeper": "A translucent, sorrowful spirit. He was once the castle's gatekeeper.",
            
            // New items
            "torch": "A wooden torch wrapped in oiled cloth. It provides light and deals extra damage to beasts.",
            "shield": "A sturdy wooden shield reinforced with iron. Reduces incoming damage by 2.",
            "guard's log": "A leather-bound journal. It contains patrol schedules and observations.",
            "steel sword": "A well-made steel sword. Balanced and sharp. Damage: 5-9.",
            "chainmail": "A shirt of interlocking metal rings. Provides good protection. +10 max HP, damage reduction 3.",
            "lockpicks": "A set of fine metal picks. Useful for opening mechanical locks.",
            "cooking oil": "A flask of lamp oil. Slippery and flammable.",
            "cleaver": "A heavy kitchen cleaver. Good for chopping. Damage: 4-7.",
            "dried herbs": "Assorted medicinal herbs. Can be used to craft health potions.",
            "antique wine": "A bottle of fine wine, aged for decades. Worth 100 gold.",
            "cork": "An oddly shaped cork. It looks like it might fit something specific.",
            "empty bottle": "An empty glass bottle. Can be filled with liquids.",
            "holy water": "Blessed water that burns the undead. Deals 30 damage to undead enemies.",
            "silver cross": "A cross forged from pure silver. Repels vampires and other unholy creatures.",
            "prayer beads": "Sacred beads used in meditation. Increases max MP by 5.",
            "heavy rope": "Thick, durable rope. Stronger than ordinary rope.",
            "earplugs": "Wax earplugs. Useful for blocking loud noises.",
            "viewing lens": "A precision-ground crystal lens. Part of a telescope.",
            "spell scroll: fireball": "A scroll inscribed with the Fireball spell. Read to learn it.",
            "encyclopedia of undead": "A comprehensive guide to undead creatures and their weaknesses.",
            "blank book": "An empty book with blank pages.",
            "star chart": "A map of the night sky showing constellations and celestial bodies.",
            "telescope lens": "The primary lens for a telescope. Crystal clear.",
            "astrolabe": "An ancient astronomical instrument. Used to calculate celestial positions.",
            "royal crown": "The crown of the castle's rightful rulers. Worth 500 gold.",
            "soul gem": "A crystal that pulses with trapped souls. The necromancer's power source.",
            "necromancer's staff": "A staff of dark power. Deals 6-10 damage and poisons enemies.",
            "dragon's tooth dagger": "A dagger carved from a dragon's fang. Deals fire damage. 8-12 damage.",
            "cloak of shadows": "A cloak woven from shadow itself. 25% dodge chance.",
            "amulet of life": "An amulet that radiates warmth. Regenerates 1 HP per turn.",
            "orb of scrying": "A crystal ball that shows distant locations. Reveals the entire map.",
            "bag of holding": "A magical bag with extra-dimensional space. Increases carry capacity by 50.",
            "rat tail": "A severed rat tail. Proof of your victory over the rat swarm.",
            "spider silk": "Gleaming silk from a giant spider. Strong and sticky.",
            "cursed blade": "A sword that thirsts for blood. Powerful but drains your life force.",
            "ghostly essence": "Ectoplasmic residue from a ghost. Can be used in crafting.",
            "family signet ring": "An heirloom ring bearing a noble crest. Means something to the gatekeeper.",
            "masterwork dagger": "A perfectly balanced dagger. 4-8 damage, high critical chance.",
            "silver key": "A gleaming silver key. Different from the rusty one.",
            "tower key": "An ornate iron key. Opens the tower's upper chambers.",
            "antivenom": "A murky green potion. Cures poison."
        };

        // ==================== UI FUNCTIONS ====================
        const gameOutput = document.getElementById('game-output');
        const gameInput = document.getElementById('game-input');

        function addToOutput(text, className = '') {
            const p = document.createElement('p');
            p.textContent = text;
            if (className) p.className = className;
            gameOutput.appendChild(p);
            gameOutput.scrollTop = gameOutput.scrollHeight;
        }

        function updateStatus() {
            document.getElementById('player-hp-text').textContent = `${player.currentHP}/${player.maxHP}`;
            document.getElementById('player-health-fill').style.width = `${(player.currentHP / player.maxHP) * 100}%`;
            document.getElementById('player-gold').textContent = player.gold;
            document.getElementById('player-weapon').textContent = `${player.weapon.name} (${player.weapon.minDamage}-${player.weapon.maxDamage})`;
            document.getElementById('player-armor').textContent = player.armor ? player.armor.name : "None";
            document.getElementById('player-weight').textContent = `${player.currentWeight()}/${player.maxWeight}`;
            saveGame();
        }

        // ==================== SAVE / LOAD ====================
        function saveGame() {
            const roomItems = {};
            for (let room in locations) {
                roomItems[room] = [...(locations[room].items || [])];
            }
            const saveData = {
                player: {
                    maxHP: player.maxHP,
                    currentHP: player.currentHP,
                    gold: player.gold,
                    inventory: [...player.inventory],
                    weapon: { ...player.weapon },
                    armor: player.armor ? { ...player.armor } : null,
                    maxWeight: player.maxWeight,
                    blessings: [...player.blessings],
                    poisonTurns: player.poisonTurns
                },
                gameState: JSON.parse(JSON.stringify(gameState)),
                roomItems: roomItems
            };
            localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
        }

        function loadGame() {
            const saved = localStorage.getItem(SAVE_KEY);
            if (!saved) return false;
            try {
                const saveData = JSON.parse(saved);
                Object.assign(player, saveData.player);
                Object.assign(gameState, saveData.gameState);
                for (let room in saveData.roomItems) {
                    if (locations[room]) {
                        locations[room].items = saveData.roomItems[room];
                    }
                }
                return true;
            } catch (e) {
                console.error("Failed to load save:", e);
                return false;
            }
        }

        function clearSave() {
            localStorage.removeItem(SAVE_KEY);
        }

        // ==================== RESET TO DEFAULTS ====================
        function resetToDefaults() {
            // Reset room items
            for (let room in DEFAULT_ROOM_ITEMS) {
                if (locations[room]) {
                    locations[room].items = [...DEFAULT_ROOM_ITEMS[room]];
                }
            }
            
            // Reset player
            player.maxHP = 100;
            player.currentHP = 100;
            player.gold = 0;
            player.inventory = [];
            player.weapon = { name: "Fists", minDamage: 1, maxDamage: 2, type: "blunt" };
            player.armor = null;
            player.maxWeight = 30;
            player.blessings = [];
            player.poisonTurns = 0;
            
            // Reset gameState
            gameState.currentLocation = 'outsideGates';
            gameState.visitedLocations = ['outsideGates'];
            gameState.gameEnded = false;
            gameState.ending = null;
            
            // Reset all room states
            gameState.outsideGates = { gateLocked: true, gatekeeperTalked: false, gatekeeperGivenDagger: false };
            gameState.courtyard = { bucketRetrieved: false, keyTaken: false };
            gameState.entranceHall = { chestOpened: false };
            gameState.guardhouse = { guardSaved: false, guardTalked: false, logRead: false };
            gameState.armory = { doorUnlocked: false, oilUsed: false, lockpicksUsed: false };
            gameState.kitchen = { ratKingBribed: false, cauldronMoved: false };
            gameState.wineCellar = { merchantFreed: false, combinationRevealed: false };
            gameState.chapel = { altarReconsecrated: false, fatherThomasTalked: false };
            gameState.bellTower = { bellRungOnce: false, bellRungThrice: false, secretFound: false };
            gameState.library = { archivistTalked: false, bookPuzzleSolved: false };
            gameState.observatory = { telescopeAssembled: false, alignmentSolved: false };
            gameState.throneRoom = { necromancerDefeated: false, soulGemShattered: false, staffTaken: false };
            gameState.treasury = { visited: false };
        }

        // ==================== SHOW LOCATION ====================
        function showLocation() {
            const loc = locations[gameState.currentLocation];
            addToOutput(loc.name, "location");
            addToOutput(loc.description());
            const exits = Object.keys(loc.exits).filter(e => loc.exits[e] !== null);
            if (exits.length) addToOutput("Exits: " + exits.map(e => e.toUpperCase()).join(", "));
        }

        // ==================== COMMAND PARSING ====================
        const commands = {
            'north':'north','n':'north','south':'south','s':'south',
            'east':'east','e':'east','west':'west','w':'west',
            'up':'up','u':'up','down':'down','d':'down',
            'look':'look','l':'look','inventory':'inventory','i':'inventory',
            'take':'take','get':'take','grab':'take','drop':'drop',
            'examine':'examine','x':'examine',
            'use':'use',
            'open':'open',
            'talk':'talk','speak':'talk',
            'give':'give',
            'equip':'equip',
            'unequip':'unequip',
            'craft':'craft',
            'read':'read',
            'ring':'ring',
            'attack':'attack','fight':'attack','kill':'attack',
            'save':'save','load':'load','restart':'restart','help':'help','h':'help',
            'quit':'quit','q':'quit'
        };

        // ==================== MOVEMENT ====================
        function movePlayer(direction) {
            if (gameState.currentLocation === 'bellMechanism' && direction === 'down') {
                gameState.currentLocation = 'bellTower';
                addToOutput("You climb down from the bell mechanism.");
                showLocation();
                return;
            }
            
            const loc = locations[gameState.currentLocation];
            const target = loc.exits[direction];
            if (!target) { addToOutput(`You can't go ${direction}.`); return; }
            
            // Special blocked paths
            if (gameState.currentLocation === 'outsideGates' && direction === 'north' && gameState.outsideGates.gateLocked) {
                addToOutput("The massive iron gates are firmly locked.");
                return;
            }
            
            if (gameState.currentLocation === 'armory' && direction === 'east' && !gameState.armory.doorUnlocked) {
                addToOutput("The steel door is jammed shut. You'll need to oil it or pick the lock.");
                return;
            }
            
            if (gameState.currentLocation === 'library' && direction === 'up' && !gameState.library.bookPuzzleSolved) {
                addToOutput("The staircase to the observatory is magically concealed. You need to solve the book puzzle.");
                return;
            }
            
            if (gameState.currentLocation === 'observatory' && direction === 'down' && !gameState.observatory.alignmentSolved) {
                addToOutput("The teleportation circle is inactive. You need to align the orrery first.");
                return;
            }
            
            gameState.currentLocation = target;
            if (!gameState.visitedLocations.includes(target)) gameState.visitedLocations.push(target);
            addToOutput(`You go ${direction}.`);
            showLocation();
            
            // Trigger combat if enemy present
            checkForEnemy();
        }

        // ==================== COMBAT SYSTEM ====================
        let combatActive = false;
        let currentEnemy = null;
        let combatTurn = 0;

        function checkForEnemy() {
            const roomEnemies = {
                guardhouse: "ratSwarm",
                armory: "animatedArmor",
                kitchen: "ghostCook",
                wineCellar: "giantSpider",
                chapel: "deathKnight",
                bellTower: "harpy",
                library: "livingBooks",
                observatory: "starSpawn",
                throneRoom: gameState.throneRoom.necromancerDefeated ? null : "necromancer"
            };
            
            const enemyKey = roomEnemies[gameState.currentLocation];
            if (enemyKey && !combatActive) {
                startCombat(enemyKey);
            }
        }

        function startCombat(enemyType) {
            currentEnemy = JSON.parse(JSON.stringify(enemies[enemyType]));
            combatActive = true;
            combatTurn = 0;
            
            addToOutput(`\nA ${currentEnemy.name} appears!`, "combat");
            addToOutput(currentEnemy.description, "combat");
            addToOutput("COMBAT STARTED! Use ATTACK or cast spells!", "combat");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP} | ${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "combat");
        }

        function playerAttack() {
            if (!combatActive || !currentEnemy) {
                addToOutput("There's nothing to attack here.");
                return;
            }
            
            combatTurn++;
            
            // Calculate damage
            let damage = Math.floor(Math.random() * (player.weapon.maxDamage - player.weapon.minDamage + 1)) + player.weapon.minDamage;
            
            // Critical hit (10% base, modified by weapon)
            let critChance = 0.1;
            if (player.weapon.crit) critChance += player.weapon.crit;
            if (Math.random() < critChance) {
                damage *= 2;
                addToOutput("CRITICAL HIT!", "combat");
            }
            
            // Apply vulnerabilities/resistances
            if (currentEnemy.vulnerabilities?.includes(player.weapon.type)) {
                damage = Math.floor(damage * 1.5);
                addToOutput("The enemy is vulnerable to that attack!", "combat");
            }
            if (currentEnemy.resistances?.includes(player.weapon.type)) {
                damage = Math.floor(damage / 2);
                addToOutput("The enemy resists that attack.", "combat");
            }
            
            // Ethereal enemies have 50% dodge
            if (currentEnemy.ethereal && Math.random() < 0.5) {
                addToOutput("Your attack passes through the ghostly form!", "combat");
                damage = 0;
            }
            
            // Flying enemies have 30% dodge
            if (currentEnemy.flying && Math.random() < 0.3) {
                addToOutput("The flying enemy dodges your attack!", "combat");
                damage = 0;
            }
            
            // Apply damage
            currentEnemy.currentHP -= damage;
            currentEnemy.currentHP = Math.max(0, currentEnemy.currentHP);
            
            addToOutput(`You attack with your ${player.weapon.name} and deal ${damage} damage!`, "player");
            addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
            
            // Weapon on-hit effects
            if (player.weapon.onHit && damage > 0) {
                player.weapon.onHit(currentEnemy);
            }
            
            if (currentEnemy.currentHP <= 0) {
                endCombat(true);
                return;
            }
            
            enemyAttack();
            updateStatus();
        }

        function enemyAttack() {
            let damage = Math.floor(Math.random() * (currentEnemy.maxDamage - currentEnemy.minDamage + 1)) + currentEnemy.minDamage;
            
            // Armor reduction
            if (player.armor && player.armor.damageReduction) {
                damage = Math.max(1, damage - player.armor.damageReduction);
                addToOutput(`Your armor reduces the damage!`, "player");
            }
            
            // Blessing of light (from chapel) - 10% dodge
            if (player.blessings.includes('light') && Math.random() < 0.1) {
                addToOutput("The blessing of light helps you dodge!", "magic");
                damage = 0;
            }
            
            // Cloak of Shadows dodge
            if (player.inventory.includes('cloak of shadows') && Math.random() < 0.25) {
                addToOutput("The Cloak of Shadows makes you intangible!", "magic");
                damage = 0;
            }
            
            player.currentHP -= damage;
            player.currentHP = Math.max(0, player.currentHP);
            
            addToOutput(`${currentEnemy.name} attacks you for ${damage} damage!`, "enemy");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP}`, "health");
            
            // Poison attack
            if (currentEnemy.poisonAttack && Math.random() < 0.3) {
                player.poisonTurns += 3;
                addToOutput("You've been poisoned!", "damage");
            }
            
            if (player.currentHP <= 0) {
                endCombat(false);
            }
            
            // Amulet of Life regeneration
            if (player.inventory.includes('amulet of life') && player.currentHP < player.maxHP) {
                player.currentHP = Math.min(player.maxHP, player.currentHP + 1);
                addToOutput("The Amulet of Life restores 1 HP.", "health");
            }
        }

        function endCombat(playerWon) {
            if (playerWon) {
                addToOutput(currentEnemy.defeatMessage, "victory");
                
                // Loot
                if (currentEnemy.loot) {
                    player.inventory.push(currentEnemy.loot);
                    addToOutput(`You found a ${currentEnemy.loot}!`, "item");
                }
                
                // Gold reward
                const goldReward = Math.floor(Math.random() * 20) + 15;
                player.gold += goldReward;
                addToOutput(`You find ${goldReward} gold on the enemy.`, "gold");
                
                // Boss defeat flags
                if (currentEnemy.name === "Death Knight") {
                    gameState.chapel.necromancerDefeated = true;
                }
                if (currentEnemy.name === "Necromancer") {
                    gameState.throneRoom.necromancerDefeated = true;
                    // Add necromancer's staff to room items
                    if (!locations.throneRoom.items.includes("necromancer's staff")) {
                        locations.throneRoom.items.push("necromancer's staff");
                    }
                    if (!locations.throneRoom.items.includes("soul gem")) {
                        locations.throneRoom.items.push("soul gem");
                    }
                }
            } else {
                addToOutput("You have been defeated!", "defeat");
                addToOutput("GAME OVER - Type RESTART to try again.", "defeat");
                gameState.gameEnded = true;
            }
            
            combatActive = false;
            currentEnemy = null;
            updateStatus();
        }

        // ==================== TAKE / DROP ====================
        function takeItem(itemName) {
            if (!itemName) { addToOutput("Take what?"); return; }
            const loc = locations[gameState.currentLocation];
            const found = loc.items.find(i => i.toLowerCase().includes(itemName.toLowerCase()));
            if (!found) { addToOutput(`I don't see a ${itemName} here.`); return; }
            
            // Check weight
            const itemWeight = itemWeights[found] || 1;
            if (player.currentWeight() + itemWeight > player.maxWeight) {
                addToOutput("You're carrying too much weight. Drop something first.", "hint");
                return;
            }
            
            const index = loc.items.indexOf(found);
            loc.items.splice(index, 1);
            player.inventory.push(found);
            addToOutput(`You take the ${found}.`);
            
            // Special case: Bag of Holding increases carry capacity
            if (found === "bag of holding") {
                player.maxWeight += 50;
                addToOutput("The Bag of Holding expands your carrying capacity!", "victory");
            }
            
            updateStatus();
        }

        function dropItem(itemName) {
            if (!itemName) { addToOutput("Drop what?"); return; }
            const found = player.inventory.find(i => i.toLowerCase().includes(itemName.toLowerCase()));
            if (!found) { addToOutput(`You're not carrying a ${itemName}.`); return; }
            
            const index = player.inventory.indexOf(found);
            player.inventory.splice(index, 1);
            locations[gameState.currentLocation].items.push(found);
            addToOutput(`You drop the ${found}.`);
            
            // Special case: Bag of Holding decreases carry capacity
            if (found === "bag of holding") {
                player.maxWeight -= 50;
                addToOutput("You feel less capacious without the Bag of Holding.", "hint");
            }
            
            updateStatus();
        }

        // ==================== EXAMINE ====================
        function examineObject(objectName) {
            if (!objectName) { addToOutput("Examine what?"); return; }
            const objLower = objectName.toLowerCase();
            const loc = locations[gameState.currentLocation];
            
            // Check inventory
            const carried = player.inventory.find(i => i.toLowerCase().includes(objLower));
            if (carried) {
                addToOutput(objectDescriptions[carried] || `You see nothing special about the ${carried}.`);
                return;
            }
            
            // Check room items
            const roomItem = loc.items.find(i => i.toLowerCase().includes(objLower));
            if (roomItem) {
                addToOutput(objectDescriptions[roomItem] || `You see a ${roomItem}.`);
                return;
            }
            
            // Room-specific examinations
            if (gameState.currentLocation === 'outsideGates') {
                if (objLower.includes('gatekeeper') || objLower.includes('spirit') || objLower.includes('ghost')) {
                    if (gameState.outsideGates.gatekeeperGivenDagger) {
                        addToOutput("The gatekeeper's spirit has departed. Only a faint shimmer remains.");
                    } else {
                        addToOutput(objectDescriptions['gatekeeper']);
                        addToOutput("He seems sorrowful, as if he lost something precious.");
                    }
                    return;
                }
                if (objLower.includes('gate')) { addToOutput(objectDescriptions['gate']); return; }
                if (objLower.includes('breach') || objLower.includes('wall')) { addToOutput(objectDescriptions['breach']); return; }
            }
            
            if (gameState.currentLocation === 'courtyard') {
                if (objLower.includes('well')) {
                    addToOutput(objectDescriptions['well']);
                    if (!gameState.courtyard.bucketRetrieved) addToOutput("You could USE ROPE ON WELL to retrieve the bucket.", "hint");
                    return;
                }
                if (objLower.includes('bucket')) {
                    if (gameState.courtyard.bucketRetrieved) addToOutput("The bucket is now at the top of the well.");
                    else addToOutput("The bucket hangs at the bottom, tantalizingly out of reach.");
                    return;
                }
            }
            
            if (gameState.currentLocation === 'entranceHall') {
                if (objLower.includes('chest')) {
                    addToOutput(objectDescriptions['chest']);
                    if (!gameState.entranceHall.chestOpened) addToOutput("It's locked. Maybe a key will work.");
                    return;
                }
            }
            
            if (gameState.currentLocation === 'guardhouse') {
                if (objLower.includes('guard') || objLower.includes('wounded')) {
                    if (gameState.guardhouse.guardSaved) {
                        addToOutput("The guard rests peacefully. His leg is bandaged.");
                    } else {
                        addToOutput("A castle guard, bleeding from a deep wound on his leg. He's barely conscious.");
                        addToOutput("You could TALK GUARD to speak with him.");
                    }
                    return;
                }
                if (objLower.includes('log') || objLower.includes('journal')) {
                    addToOutput("The guard's log contains patrol schedules. One entry stands out:");
                    addToOutput("'The rose blooms at midnight' - what could that mean?");
                    gameState.guardhouse.logRead = true;
                    return;
                }
            }
            
            if (gameState.currentLocation === 'armory') {
                if (objLower.includes('door')) {
                    addToOutput("A heavy steel door. It's jammed shut.");
                    if (!gameState.armory.doorUnlocked) {
                        addToOutput("You could USE OIL ON DOOR to lubricate it, or USE LOCKPICKS ON DOOR to pick the lock.");
                    }
                    return;
                }
            }
            
            if (gameState.currentLocation === 'kitchen') {
                if (objLower.includes('rat king') || objLower.includes('rat')) {
                    addToOutput("An enormous rat wearing a tiny gold crown. He watches you with intelligent eyes.");
                    addToOutput("He seems open to negotiation...");
                    return;
                }
                if (objLower.includes('cauldron')) {
                    addToOutput("A massive iron cauldron. It's too heavy to lift, but maybe you could MOVE it?");
                    return;
                }
            }
            
            if (gameState.currentLocation === 'wineCellar') {
                if (objLower.includes('barrel')) {
                    if (!gameState.wineCellar.merchantFreed) {
                        addToOutput("One of the barrels is different from the others. You hear knocking from inside!");
                    } else {
                        addToOutput("The barrel stands open and empty.");
                    }
                    return;
                }
                if (objLower.includes('rack')) {
                    addToOutput("A wine rack with numbered slots. Some bottles are missing.");
                    if (!gameState.wineCellar.combinationRevealed) {
                        addToOutput("The numbers 1-4-7-2 are written in dust on the rack.");
                        gameState.wineCellar.combinationRevealed = true;
                    }
                    return;
                }
            }
            
            if (gameState.currentLocation === 'chapel') {
                if (objLower.includes('father thomas') || objLower.includes('priest')) {
                    if (gameState.chapel.altarReconsecrated) {
                        addToOutput("Father Thomas's spirit has ascended to the afterlife.");
                    } else {
                        addToOutput("The spectral form of a priest, weeping before the desecrated altar.");
                        addToOutput("You could TALK FATHER THOMAS to speak with him.");
                    }
                    return;
                }
                if (objLower.includes('altar')) {
                    if (gameState.chapel.altarReconsecrated) {
                        addToOutput("The altar glows with holy light. You feel at peace here.");
                    } else {
                        addToOutput("The altar has been defiled with dark symbols. It needs to be reconsecrated.");
                        addToOutput("You could USE HOLY WATER ON ALTAR to cleanse it.");
                    }
                    return;
                }
            }
            
            if (gameState.currentLocation === 'bellMechanism') {
                if (objLower.includes('bell') || objLower.includes('inscription')) {
                    addToOutput("The bell is inscribed with ancient text:");
                    addToOutput("'STRIKE ME AT MIDNIGHT FOR TRUTH'");
                    addToOutput("You can RING BELL here.");
                }
                return;
            }
            
            if (gameState.currentLocation === 'library') {
                if (objLower.includes('archivist')) {
                    if (gameState.library.archivistTalked) {
                        addToOutput("The Archivist whirs quietly. 'Knowledge is power, traveler.'");
                    } else {
                        addToOutput("A bronze mechanical man, covered in dust. His eyes glow faintly.");
                        addToOutput("You could TALK ARCHIVIST to activate him.");
                    }
                    return;
                }
                if (objLower.includes('book') || objLower.includes('shelf')) {
                    addToOutput("Thousands of books line the shelves. Their spines form a pattern...");
                    addToOutput("If you arrange them correctly, they might spell something.");
                    addToOutput("Try ARRANGE BOOKS TO 'UNDEAD'");
                    return;
                }
            }
            
            if (gameState.currentLocation === 'observatory') {
                if (objLower.includes('telescope')) {
                    if (gameState.observatory.telescopeAssembled) {
                        addToOutput("The telescope is complete. You can see stars that aren't visible to the naked eye.");
                    } else {
                        addToOutput("A magnificent brass telescope. It's missing its primary lens.");
                    }
                    return;
                }
                if (objLower.includes('orrery')) {
                    addToOutput("A mechanical model of the solar system. The planets are out of alignment.");
                    addToOutput("You need to set the correct celestial alignment.");
                    return;
                }
                if (objLower.includes('circle')) {
                    addToOutput("A teleportation circle etched into the floor. It's inactive.");
                    if (gameState.observatory.alignmentSolved) {
                        addToOutput("The circle now glows with blue energy, ready to use.");
                    }
                    return;
                }
            }
            
            if (gameState.currentLocation === 'throneRoom') {
                if (objLower.includes('throne')) {
                    addToOutput("An obsidian throne, carved with scenes of conquest and dark magic.");
                    if (!gameState.throneRoom.necromancerDefeated) {
                        addToOutput("The necromancer sits upon it, channeling power through the Soul Gem.");
                    }
                    return;
                }
                if (objLower.includes('soul gem')) {
                    addToOutput("A crystal pulsing with trapped light. You can hear faint whispers.");
                    addToOutput("Shattering it on the altar would free the souls but destroy the gem.");
                    return;
                }
                if (objLower.includes('altar')) {
                    addToOutput("A dark altar beneath the throne, covered in runes.");
                    addToOutput("This is where the necromancer draws his power.");
                    return;
                }
            }
            
            if (gameState.currentLocation === 'treasury') {
                if (objLower.includes('jester') || objLower.includes('skeleton')) {
                    addToOutput("A skeleton in faded jester's motley. He seems friendly!");
                    addToOutput("You could TALK JESTER to hear a joke.");
                    return;
                }
            }
            
            // Generic object descriptions
            for (let [key, desc] of Object.entries(objectDescriptions)) {
                if (key.includes(objLower) || objLower.includes(key)) {
                    addToOutput(desc);
                    return;
                }
            }
            
            addToOutput(`You don't see a ${objectName} here.`);
        }

        // ==================== USE (ITEM ON TARGET) ====================
        function useItemOnTarget(item, target) {
            const itemLower = item.toLowerCase();
            const targetLower = target.toLowerCase();

            // --- ORIGINAL PUZZLES ---
            // USE ROPE ON WELL (courtyard)
            if (itemLower.includes('rope') && targetLower.includes('well')) {
                if (gameState.currentLocation !== 'courtyard') { addToOutput("There's no well here."); return; }
                if (!player.inventory.includes('rope')) { addToOutput("You don't have a rope."); return; }
                if (gameState.courtyard.bucketRetrieved) { addToOutput("You've already retrieved the bucket."); return; }
                const ropeIdx = player.inventory.indexOf('rope');
                player.inventory.splice(ropeIdx, 1);
                gameState.courtyard.bucketRetrieved = true;
                if (!locations.courtyard.items.includes('rusty key')) {
                    locations.courtyard.items.push('rusty key');
                }
                addToOutput("You tie the rope to the well's crank and lower it. The bucket rises, and inside you find a RUSTY KEY!", "victory");
                updateStatus();
                return;
            }

            // USE RUSTY KEY ON GATE (outsideGates)
            if (itemLower.includes('rusty key') && targetLower.includes('gate')) {
                if (gameState.currentLocation !== 'outsideGates') { addToOutput("There's no gate here."); return; }
                if (!player.inventory.includes('rusty key')) { addToOutput("You don't have the rusty key."); return; }
                if (!gameState.outsideGates.gateLocked) { addToOutput("The gate is already unlocked."); return; }
                gameState.outsideGates.gateLocked = false;
                addToOutput("You insert the rusty key into the gate's lock. With a heavy CLUNK, the gates swing open!", "victory");
                updateStatus();
                return;
            }

            // USE RUSTY KEY ON CHEST (entranceHall)
            if (itemLower.includes('rusty key') && targetLower.includes('chest')) {
                if (gameState.currentLocation !== 'entranceHall') { addToOutput("There's no chest here."); return; }
                if (!player.inventory.includes('rusty key')) { addToOutput("You don't have the rusty key."); return; }
                if (gameState.entranceHall.chestOpened) { addToOutput("The chest is already open."); return; }
                gameState.entranceHall.chestOpened = true;
                player.inventory.push("dagger");
                player.gold += 50;
                addToOutput("You use the rusty key on the chest. The lock clicks open!", "victory");
                addToOutput("Inside, you find a DAGGER and 50 gold!", "item");
                addToOutput("You can EQUIP DAGGER to use it as a weapon.");
                updateStatus();
                return;
            }

            // --- NEW ROOM PUZZLES ---
            // USE OIL ON DOOR (armory)
            if (itemLower.includes('oil') && targetLower.includes('door')) {
                if (gameState.currentLocation !== 'armory') { addToOutput("There's no door like that here."); return; }
                if (!player.inventory.includes('cooking oil')) { addToOutput("You don't have cooking oil."); return; }
                if (gameState.armory.doorUnlocked) { addToOutput("The door is already unlocked."); return; }
                const oilIdx = player.inventory.indexOf('cooking oil');
                player.inventory.splice(oilIdx, 1);
                gameState.armory.doorUnlocked = true;
                gameState.armory.oilUsed = true;
                addToOutput("You pour oil on the door's hinges. With a groan, it swings open!", "victory");
                updateStatus();
                return;
            }

            // USE LOCKPICKS ON DOOR (armory)
            if (itemLower.includes('lockpick') && targetLower.includes('door')) {
                if (gameState.currentLocation !== 'armory') { addToOutput("There's no door like that here."); return; }
                if (!player.inventory.includes('lockpicks')) { addToOutput("You don't have lockpicks."); return; }
                if (gameState.armory.doorUnlocked) { addToOutput("The door is already unlocked."); return; }
                gameState.armory.doorUnlocked = true;
                gameState.armory.lockpicksUsed = true;
                addToOutput("You carefully pick the lock. Click! The door swings open!", "victory");
                updateStatus();
                return;
            }

            // USE HEAVY ROPE ON WELL (courtyard - alternative)
            if (itemLower.includes('heavy rope') && targetLower.includes('well')) {
                if (gameState.currentLocation !== 'courtyard') { addToOutput("There's no well here."); return; }
                if (!player.inventory.includes('heavy rope')) { addToOutput("You don't have heavy rope."); return; }
                if (gameState.courtyard.bucketRetrieved) { addToOutput("You've already retrieved the bucket."); return; }
                const ropeIdx = player.inventory.indexOf('heavy rope');
                player.inventory.splice(ropeIdx, 1);
                gameState.courtyard.bucketRetrieved = true;
                if (!locations.courtyard.items.includes('rusty key')) {
                    locations.courtyard.items.push('rusty key');
                }
                addToOutput("You tie the heavy rope to the well. It's strong enough to lower yourself down!", "victory");
                addToOutput("You climb down and find the RUSTY KEY at the bottom!");
                updateStatus();
                return;
            }

            // USE SILVER KEY ON CHEST (entranceHall - alternative)
            if (itemLower.includes('silver key') && targetLower.includes('chest')) {
                if (gameState.currentLocation !== 'entranceHall') { addToOutput("There's no chest here."); return; }
                if (!player.inventory.includes('silver key')) { addToOutput("You don't have the silver key."); return; }
                if (gameState.entranceHall.chestOpened) { addToOutput("The chest is already open."); return; }
                gameState.entranceHall.chestOpened = true;
                player.inventory.push("masterwork dagger");
                player.gold += 75;
                addToOutput("You use the silver key on the chest. It opens with a satisfying click!", "victory");
                addToOutput("Inside, you find a MASTERWORK DAGGER and 75 gold!", "item");
                updateStatus();
                return;
            }

            // USE HOLY WATER ON ALTAR (chapel)
            if (itemLower.includes('holy water') && targetLower.includes('altar')) {
                if (gameState.currentLocation !== 'chapel') { addToOutput("There's no altar here."); return; }
                if (!player.inventory.includes('holy water')) { addToOutput("You don't have holy water."); return; }
                if (gameState.chapel.altarReconsecrated) { addToOutput("The altar is already consecrated."); return; }
                const waterIdx = player.inventory.indexOf('holy water');
                player.inventory.splice(waterIdx, 1);
                gameState.chapel.altarReconsecrated = true;
                addToOutput("You sprinkle holy water on the defiled altar. The dark symbols dissolve!", "victory");
                addToOutput("A warm light fills the chapel. Father Thomas appears, smiling.", "npc");
                addToOutput("Father Thomas: 'You've restored my faith. Thank you.'", "npc");
                addToOutput("He raises his hand in blessing. You feel stronger!", "victory");
                player.maxHP += 20;
                player.currentHP = Math.min(player.maxHP, player.currentHP + 20);
                player.blessings.push('light');
                updateStatus();
                return;
            }

            // USE VIEWING LENS ON TELESCOPE (observatory)
            if (itemLower.includes('lens') && targetLower.includes('telescope')) {
                if (gameState.currentLocation !== 'observatory') { addToOutput("There's no telescope here."); return; }
                if (!player.inventory.includes('viewing lens') && !player.inventory.includes('telescope lens')) {
                    addToOutput("You don't have a lens."); return;
                }
                if (gameState.observatory.telescopeAssembled) { addToOutput("The telescope is already complete."); return; }
                const lensItem = player.inventory.includes('telescope lens') ? 'telescope lens' : 'viewing lens';
                const lensIdx = player.inventory.indexOf(lensItem);
                player.inventory.splice(lensIdx, 1);
                gameState.observatory.telescopeAssembled = true;
                addToOutput("You carefully insert the lens into the telescope. It clicks into place!", "victory");
                addToOutput("You can now see distant stars clearly. The orrery's alignment becomes clear.", "hint");
                updateStatus();
                return;
            }

            // USE SOUL GEM ON ALTAR (throneRoom) - Good ending
            if (itemLower.includes('soul gem') && targetLower.includes('altar')) {
                if (gameState.currentLocation !== 'throneRoom') { addToOutput("There's no altar here."); return; }
                if (!player.inventory.includes('soul gem')) { addToOutput("You don't have the soul gem."); return; }
                if (!gameState.throneRoom.necromancerDefeated) { 
                    addToOutput("You should defeat the necromancer first!"); 
                    return; 
                }
                const gemIdx = player.inventory.indexOf('soul gem');
                player.inventory.splice(gemIdx, 1);
                gameState.throneRoom.soulGemShattered = true;
                
                addToOutput("You raise the Soul Gem above the altar and bring it down with all your might!", "player");
                addToOutput("CRACK! The gem shatters into a thousand fragments of light!", "victory");
                addToOutput("The trapped souls swirl around you, freed at last.", "magic");
                
                if (gameState.queenGhost) {
                    addToOutput("Queen's Ghost: 'Thank you. At last, I am free.'", "npc");
                    addToOutput("She ascends in a column of golden light, smiling peacefully.", "victory");
                }
                
                addToOutput("\nTHE GOOD ENDING - The castle is freed from the curse.", "victory");
                addToOutput("You have saved the souls of the damned and restored hope to this place.", "victory");
                gameState.ending = "good";
                gameState.gameEnded = true;
                return;
            }

            // USE NECROMANCER'S STAFF (throneRoom) - Evil ending
            if (itemLower.includes('staff') && targetLower.includes('throne')) {
                if (gameState.currentLocation !== 'throneRoom') { addToOutput("There's no throne here."); return; }
                if (!player.inventory.includes('necromancer\'s staff')) { addToOutput("You don't have the necromancer's staff."); return; }
                if (!gameState.throneRoom.necromancerDefeated) { 
                    addToOutput("The necromancer still lives. You'll have to defeat him first."); 
                    return; 
                }
                if (gameState.throneRoom.soulGemShattered) { 
                    addToOutput("The power source is already destroyed."); 
                    return; 
                }
                
                gameState.throneRoom.staffTaken = true;
                
                addToOutput("You sit upon the obsidian throne, the necromancer's staff in hand.", "player");
                addToOutput("Dark energy flows into you. You feel the castle's curse respond to your will.", "damage");
                addToOutput("The power is intoxicating. Why would you ever give this up?", "damage");
                
                if (gameState.queenGhost) {
                    addToOutput("Queen's Ghost: 'No... what have you done? You're just like him!'", "npc");
                    addToOutput("She fades away, weeping.", "npc");
                }
                
                addToOutput("\nTHE EVIL ENDING - You have become the new dark lord.", "defeat");
                addToOutput("The castle's curse bends to your will. But at what cost?", "defeat");
                gameState.ending = "evil";
                gameState.gameEnded = true;
                return;
            }

            // USE HEALTH POTION (self)
            if (itemLower.includes('health potion')) {
                if (!player.inventory.includes('health potion')) { addToOutput("You don't have a health potion."); return; }
                const idx = player.inventory.indexOf('health potion');
                player.inventory.splice(idx, 1);
                const heal = 20;
                player.currentHP = Math.min(player.maxHP, player.currentHP + heal);
                addToOutput(`You drink the health potion and restore ${heal} HP.`, "health");
                updateStatus();
                return;
            }

            // USE ANTIVENOM (self)
            if (itemLower.includes('antivenom')) {
                if (!player.inventory.includes('antivenom')) { addToOutput("You don't have antivenom."); return; }
                if (player.poisonTurns <= 0) { addToOutput("You're not poisoned."); return; }
                const idx = player.inventory.indexOf('antivenom');
                player.inventory.splice(idx, 1);
                player.poisonTurns = 0;
                addToOutput("You drink the antivenom. The poison is neutralized.", "health");
                updateStatus();
                return;
            }

            addToOutput(`You can't use the ${item} on the ${target} here.`);
        }

        function useItem(itemName) {
            if (!itemName) { addToOutput("Use what?"); return; }
            const found = player.inventory.find(i => i.toLowerCase().includes(itemName.toLowerCase()));
            if (!found) { addToOutput(`You don't have a ${itemName}.`); return; }
            useItemOnTarget(found, "");
        }

        // ==================== CRAFT ====================
        function craftItem(recipeName) {
            if (!recipeName) { addToOutput("Craft what?"); return; }
            
            const recipeKey = Object.keys(recipes).find(r => r.toLowerCase().includes(recipeName.toLowerCase()));
            if (!recipeKey) { addToOutput("You don't know how to craft that."); return; }
            
            const recipe = recipes[recipeKey];
            
            // Check ingredients
            const hasIngredients = recipe.ingredients.every(ing => 
                player.inventory.includes(ing) || 
                (ing === "holy water font" && gameState.currentLocation === "chapel" && gameState.chapel.altarReconsecrated)
            );
            
            if (!hasIngredients) {
                addToOutput("You're missing some ingredients.");
                addToOutput(`Needed: ${recipe.ingredients.join(", ")}`);
                return;
            }
            
            // Remove ingredients
            recipe.ingredients.forEach(ing => {
                if (ing !== "holy water font") {
                    const index = player.inventory.indexOf(ing);
                    if (index > -1) player.inventory.splice(index, 1);
                }
            });
            
            // Add result
            player.inventory.push(recipe.result);
            addToOutput(`You craft a ${recipe.result}! ${recipe.description}`, "item");
            updateStatus();
        }

        // ==================== READ ====================
        function readObject(objectName) {
            if (!objectName) { addToOutput("Read what?"); return; }
            const objLower = objectName.toLowerCase();
            
            // Read spell scroll
            if (objLower.includes('spell scroll') || objLower.includes('fireball')) {
                if (!player.inventory.includes('spell scroll: fireball')) {
                    addToOutput("You don't have a fireball scroll.");
                    return;
                }
                const idx = player.inventory.indexOf('spell scroll: fireball');
                player.inventory.splice(idx, 1);
                addToOutput("You read the scroll and learn the Fireball spell!", "magic");
                // You would add spell learning system here
                updateStatus();
                return;
            }
            
            // Read encyclopedia
            if (objLower.includes('encyclopedia')) {
                if (!player.inventory.includes('encyclopedia of undead')) {
                    addToOutput("You don't have the encyclopedia.");
                    return;
                }
                addToOutput("The Encyclopedia of Undead reveals:", "item");
                addToOutput("- Death Knights are vulnerable to holy weapons", "hint");
                addToOutput("- Ghosts are resistant to physical attacks", "hint");
                addToOutput("- Spiders are weak to fire", "hint");
                return;
            }
            
            addToOutput("There's nothing to read here.");
        }

        // ==================== RING ====================
        function ringBell() {
            if (gameState.currentLocation !== 'bellMechanism') {
                addToOutput("There's no bell here to ring.");
                return;
            }
            
            if (!gameState.bellTower.bellRungOnce) {
                gameState.bellTower.bellRungOnce = true;
                addToOutput("You pull the rope. The bell tolls once, echoing across the castle.", "item");
                addToOutput("You hear distant shouts. Something is coming...");
                // Trigger patroller encounter
                return;
            } else if (!gameState.bellTower.bellRungThrice) {
                gameState.bellTower.bellRungThrice = true;
                addToOutput("You ring the bell three times. The vibrations feel... different.", "item");
                addToOutput("Cracks appear in the tower floor! A secret compartment is revealed!", "victory");
                if (!locations.bellTower.items.includes('tower key')) {
                    locations.bellTower.items.push('tower key');
                }
                return;
            } else {
                addToOutput("The bell rings, but nothing else happens.");
                return;
            }
        }

        // ==================== TALK ====================
        function talkTo(npcName) {
            if (!npcName) { addToOutput("Talk to who?"); return; }
            const npcLower = npcName.toLowerCase();
            
            // Gatekeeper
            if (gameState.currentLocation === 'outsideGates' && 
                (npcLower.includes('gatekeeper') || npcLower.includes('spirit') || npcLower.includes('ghost'))) {
                
                if (gameState.outsideGates.gatekeeperGivenDagger) {
                    addToOutput("The gatekeeper has already faded away, at peace.", "npc");
                    return;
                }
                
                if (!gameState.outsideGates.gatekeeperTalked) {
                    gameState.outsideGates.gatekeeperTalked = true;
                    dialogues.gatekeeper.firstGreeting.forEach(line => addToOutput(line, "npc"));
                } else {
                    // Random idle dialogue
                    const idleLine = dialogues.gatekeeper.idle[Math.floor(Math.random() * dialogues.gatekeeper.idle.length)];
                    addToOutput(idleLine, "npc");
                }
                return;
            }
            
            // Wounded Guard
            if (gameState.currentLocation === 'guardhouse' && 
                (npcLower.includes('guard') || npcLower.includes('wounded'))) {
                
                if (gameState.guardhouse.guardSaved) {
                    addToOutput("Guard: 'I'm feeling much better. Thank you again.'", "npc");
                    return;
                }
                
                if (!gameState.guardhouse.guardTalked) {
                    gameState.guardhouse.guardTalked = true;
                    dialogues.woundedGuard.firstGreeting.forEach(line => addToOutput(line, "npc"));
                } else {
                    addToOutput(dialogues.woundedGuard.idle[Math.floor(Math.random() * dialogues.woundedGuard.idle.length)], "npc");
                }
                return;
            }
            
            // Rat King
            if (gameState.currentLocation === 'kitchen' && 
                (npcLower.includes('rat king') || npcLower.includes('rat'))) {
                
                if (gameState.kitchen.ratKingBribed) {
                    addToOutput("The rat king nibbles on his tribute, ignoring you.", "npc");
                    return;
                }
                
                dialogues.ratKing.firstEncounter.forEach(line => addToOutput(line, "npc"));
                addToOutput("You could GIVE FOOD to the rat king.", "hint");
                return;
            }
            
            // Trapped Merchant
            if (gameState.currentLocation === 'wineCellar' && 
                npcLower.includes('merchant') && gameState.wineCellar.merchantFreed) {
                
                addToOutput("Merchant Alric: 'Good to see you again! I'm heading to the market soon.'", "npc");
                addToOutput("He eyes your antique wine. 'If you ever want to sell that vintage...'", "hint");
                return;
            }
            
            // Father Thomas
            if (gameState.currentLocation === 'chapel' && 
                (npcLower.includes('father') || npcLower.includes('thomas') || npcLower.includes('priest'))) {
                
                if (gameState.chapel.altarReconsecrated) {
                    addToOutput("Father Thomas's spirit has ascended. The chapel is at peace.", "npc");
                    return;
                }
                
                if (!gameState.chapel.fatherThomasTalked) {
                    gameState.chapel.fatherThomasTalked = true;
                    dialogues.fatherThomas.firstGreeting.forEach(line => addToOutput(line, "npc"));
                } else {
                    addToOutput("Father Thomas: 'The altar... it needs to be cleansed.'", "npc");
                }
                return;
            }
            
            // Archivist
            if (gameState.currentLocation === 'library' && 
                (npcLower.includes('archivist') || npcLower.includes('bronze'))) {
                
                if (!gameState.library.archivistTalked) {
                    gameState.library.archivistTalked = true;
                    dialogues.archivist.firstMeeting.forEach(line => addToOutput(line, "npc"));
                } else {
                    const idleLine = dialogues.archivist.idle[Math.floor(Math.random() * dialogues.archivist.idle.length)];
                    addToOutput(idleLine, "npc");
                }
                return;
            }
            
            // Queen's Ghost
            if (gameState.currentLocation === 'throneRoom' && 
                (npcLower.includes('queen') || npcLower.includes('ghost')) && 
                gameState.throneRoom.necromancerDefeated && 
                !gameState.throneRoom.soulGemShattered && 
                !gameState.throneRoom.staffTaken) {
                
                dialogues.queenGhost.firstGreeting.forEach(line => addToOutput(line, "npc"));
                return;
            }
            
            // Castle Jester
            if (gameState.currentLocation === 'treasury' && 
                (npcLower.includes('jester') || npcLower.includes('skeleton'))) {
                
                dialogues.castleJester.greetings.forEach(line => addToOutput(line, "npc"));
                return;
            }
            
            addToOutput("There's no one here to talk to.");
        }

        // ==================== GIVE ====================
        function giveItemToNpc(itemName, npcName) {
            if (!itemName || !npcName) { addToOutput("Give what to whom?"); return; }
            const itemLower = itemName.toLowerCase();
            const npcLower = npcName.toLowerCase();
            const foundItem = player.inventory.find(i => i.toLowerCase().includes(itemLower));
            if (!foundItem) { addToOutput(`You're not carrying a ${itemName}.`); return; }

            // --- GATEKEEPER: Give dagger ---
            if (gameState.currentLocation === 'outsideGates' && 
                (npcLower.includes('gatekeeper') || npcLower.includes('spirit') || npcLower.includes('ghost'))) {
                
                if (gameState.outsideGates.gatekeeperGivenDagger) {
                    addToOutput("The gatekeeper has already departed. He needs nothing more.", "npc");
                    return;
                }
                
                if (foundItem === "dagger" || foundItem === "family signet ring" || foundItem === "masterwork dagger") {
                    const idx = player.inventory.indexOf(foundItem);
                    player.inventory.splice(idx, 1);
                    gameState.outsideGates.gatekeeperGivenDagger = true;
                    
                    dialogues.gatekeeper.afterQuest.forEach(line => addToOutput(line, "npc"));
                    player.inventory.push("health potion");
                    addToOutput("You receive a HEALTH POTION!", "item");
                    updateStatus();
                } else {
                    addToOutput("Gatekeeper shakes his head. 'That is not what I lost. I need the family heirloom.'", "npc");
                }
                return;
            }

            // --- WOUNDED GUARD: Give healing items ---
            if (gameState.currentLocation === 'guardhouse' && 
                (npcLower.includes('guard') || npcLower.includes('wounded'))) {
                
                if (gameState.guardhouse.guardSaved) {
                    addToOutput("Guard: 'I'm already healed, friend.'", "npc");
                    return;
                }
                
                if (foundItem === "dried herbs" || foundItem === "health potion") {
                    const idx = player.inventory.indexOf(foundItem);
                    player.inventory.splice(idx, 1);
                    gameState.guardhouse.guardSaved = true;
                    
                    dialogues.woundedGuard.healed.forEach(line => addToOutput(line, "npc"));
                    player.inventory.push("family signet ring");
                    addToOutput("You receive the FAMILY SIGNET RING!", "item");
                    updateStatus();
                } else {
                    addToOutput("Guard: 'That won't help my wound. I need medicine or bandages.'", "npc");
                }
                return;
            }

            // --- RAT KING: Give food ---
            if (gameState.currentLocation === 'kitchen' && 
                (npcLower.includes('rat king') || npcLower.includes('rat'))) {
                
                if (gameState.kitchen.ratKingBribed) {
                    addToOutput("The rat king has had enough. He ignores you.", "npc");
                    return;
                }
                
                if (foundItem === "dried herbs" || foundItem === "antique wine" || foundItem === "cheese") {
                    const idx = player.inventory.indexOf(foundItem);
                    player.inventory.splice(idx, 1);
                    gameState.kitchen.ratKingBribed = true;
                    
                    dialogues.ratKing.bribed.forEach(line => addToOutput(line, "npc"));
                    updateStatus();
                } else {
                    addToOutput("Rat King: 'Squeak! Not food! Bring food!'", "npc");
                }
                return;
            }

            // --- TRAPPED MERCHANT: Free him ---
            if (gameState.currentLocation === 'wineCellar' && 
                npcLower.includes('merchant') && !gameState.wineCellar.merchantFreed) {
                
                if (foundItem === "crowbar" || foundItem === "cleaver" || foundItem === "steel sword") {
                    const idx = player.inventory.indexOf(foundItem);
                    player.inventory.splice(idx, 1);
                    gameState.wineCellar.merchantFreed = true;
                    
                    dialogues.trappedMerchant.freed.forEach(line => addToOutput(line, "npc"));
                    player.gold += 30;
                    addToOutput("The merchant gives you 30 gold as thanks!", "gold");
                    updateStatus();
                } else {
                    addToOutput("You need something to pry the barrel open with.", "hint");
                }
                return;
            }

            // --- ARCHIVIST: Give rare books ---
            if (gameState.currentLocation === 'library' && 
                (npcLower.includes('archivist') || npcLower.includes('bronze'))) {
                
                if (foundItem === "encyclopedia of undead" || foundItem === "blank book" || foundItem === "guard's log") {
                    const idx = player.inventory.indexOf(foundItem);
                    player.inventory.splice(idx, 1);
                    
                    addToOutput("Archivist: 'A valuable addition to the collection. Thank you.'", "npc");
                    player.gold += 25;
                    addToOutput("He rewards you with 25 gold.", "gold");
                    updateStatus();
                } else {
                    addToOutput("Archivist: 'I only collect rare books and knowledge.'", "npc");
                }
                return;
            }

            addToOutput("There's no one here to give that to.");
        }

        // ==================== EQUIP ====================
        function equipItem(itemName) {
            if (!itemName) { addToOutput("Equip what?"); return; }
            const itemLower = itemName.toLowerCase();
            const found = player.inventory.find(i => i.toLowerCase().includes(itemLower));
            if (!found) { addToOutput(`You don't have a ${itemName}.`); return; }
            
            // Equip weapon
            if (weapons[found]) {
                player.weapon = { ...weapons[found] };
                addToOutput(`You equip the ${found}. (${player.weapon.minDamage}-${player.weapon.maxDamage} damage)`, "item");
                updateStatus();
                return;
            }
            
            // Equip armor
            if (armors[found]) {
                // Remove old armor
                if (player.armor) {
                    player.inventory.push(player.armor.name.toLowerCase());
                    if (player.armor.maxHPBonus) {
                        player.maxHP -= player.armor.maxHPBonus;
                        player.currentHP = Math.min(player.currentHP, player.maxHP);
                    }
                }
                
                player.armor = { ...armors[found] };
                
                // Apply armor bonuses
                if (player.armor.maxHPBonus) {
                    player.maxHP += player.armor.maxHPBonus;
                    player.currentHP += player.armor.maxHPBonus;
                }
                
                // Remove from inventory
                const idx = player.inventory.indexOf(found);
                player.inventory.splice(idx, 1);
                
                addToOutput(`You equip the ${found}.`, "item");
                updateStatus();
                return;
            }
            
            addToOutput(`You can't equip the ${found}.`);
        }

        function unequipItem(itemName) {
            if (!itemName) { addToOutput("Unequip what?"); return; }
            const itemLower = itemName.toLowerCase();
            
            // Unequip weapon
            if (player.weapon.name.toLowerCase().includes(itemLower)) {
                player.weapon = { name: "Fists", minDamage: 1, maxDamage: 2, type: "blunt" };
                addToOutput("You return to using your fists.", "player");
                updateStatus();
                return;
            }
            
            // Unequip armor
            if (player.armor && player.armor.name.toLowerCase().includes(itemLower)) {
                player.inventory.push(player.armor.name.toLowerCase());
                
                if (player.armor.maxHPBonus) {
                    player.maxHP -= player.armor.maxHPBonus;
                    player.currentHP = Math.min(player.currentHP, player.maxHP);
                }
                
                player.armor = null;
                addToOutput(`You remove your armor.`, "player");
                updateStatus();
                return;
            }
            
            addToOutput(`You don't have ${itemName} equipped.`);
        }

        // ==================== ATTACK ====================
        function attackEnemy(objectName) {
            if (!objectName) {
                if (combatActive) {
                    playerAttack();
                } else {
                    addToOutput("Attack what?");
                }
                return;
            }
            
            if (combatActive) {
                playerAttack();
                return;
            }
            
            // Check for enemy in current room
            checkForEnemy();
            if (!combatActive) {
                addToOutput("There's nothing to attack here.");
            }
        }

        // ==================== OPEN ====================
        function openObject(objectName) {
            if (!objectName) { addToOutput("Open what?"); return; }
            const objLower = objectName.toLowerCase();
            
            if (objLower.includes('chest') && gameState.currentLocation === 'entranceHall') {
                if (gameState.entranceHall.chestOpened) {
                    addToOutput("The chest is already open.");
                } else {
                    addToOutput("The chest is locked. You need a key.");
                }
                return;
            }
            
            if (objLower.includes('barrel') && gameState.currentLocation === 'wineCellar' && !gameState.wineCellar.merchantFreed) {
                addToOutput("The barrel is sealed shut. You need a tool to pry it open.");
                return;
            }
            
            addToOutput(`You can't open the ${objectName}.`);
        }

        // ==================== HELP ====================
        function showHelp() {
            addToOutput("CASTLE OF THE UNDEAD - COMPLETE EDITION", "location");
            addToOutput(" ");
            addToOutput("MOVEMENT: N, S, E, W, UP, DOWN");
            addToOutput("LOOK: LOOK, EXAMINE [object], INVENTORY");
            addToOutput("ITEMS: TAKE [item], DROP [item]");
            addToOutput("USE: USE [item] ON [target]");
            addToOutput("COMBAT: ATTACK, EQUIP [weapon], UNEQUIP");
            addToOutput("CRAFT: CRAFT [potion name]");
            addToOutput("NPCs: TALK [npc], GIVE [item] TO [npc]");
            addToOutput("OTHER: READ, RING, OPEN, SAVE, LOAD, RESTART, QUIT");
            addToOutput(" ");
            addToOutput("GOAL: Explore the castle, defeat the necromancer,", "hint");
            addToOutput("      and decide the fate of the Soul Gem.", "hint");
            addToOutput(" ");
            addToOutput("PRESS F1 FOR MORE DETAILED HELP", "hint");
        }

        // ==================== QUIT ====================
        function quitGame() {
            addToOutput("Are you sure you want to quit? Your progress is saved. (Y/N)");
            const originalHandler = gameInput.onkeypress;
            gameInput.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    const ans = this.value.trim().toLowerCase();
                    if (ans === 'y' || ans === 'yes') {
                        addToOutput("Thanks for playing Castle of the Undead!");
                        gameState.gameEnded = true;
                    } else {
                        addToOutput("Resuming...");
                    }
                    gameInput.onkeypress = originalHandler;
                    gameInput.value = '';
                    gameInput.focus();
                }
            };
        }

        // ==================== PROCESS COMMAND ====================
        function processCommand(input) {
            if (gameState.gameEnded && !input.toLowerCase().includes('restart')) {
                addToOutput("The game has ended. Type RESTART to try again.", "hint");
                return;
            }
            
            const command = input.trim().toLowerCase();
            if (!command) return;
            
            // Special case: restart
            if (command === 'restart') {
                clearSave();
                resetToDefaults();
                addToOutput("CASTLE OF THE UNDEAD 1984 - COMPLETE EDITION", "title");
                addToOutput("Restarted. May fortune favor you.", "subtitle");
                updateStatus();
                showLocation();
                return;
            }
            
            const parts = command.split(' ');
            const verb = parts[0];
            const object = parts.slice(1).join(' ');
            
            if (!commands[verb]) { addToOutput(`I don't understand "${verb}".`); return; }
            
            const action = commands[verb];
            
            switch(action) {
                // Movement
                case 'north': case 'south': case 'east': case 'west': 
                case 'up': case 'down':
                    movePlayer(action);
                    break;
                
                // Basic commands
                case 'look': showLocation(); break;
                case 'inventory': 
                    showInventory();
                    break;
                
                // Item management
                case 'take': takeItem(object); break;
                case 'drop': dropItem(object); break;
                case 'examine': examineObject(object); break;
                
                // Interaction
                case 'use':
                    const useMatch = command.match(/^use\s+(.+?)\s+(?:on|with)\s+(.+)$/);
                    if (useMatch) useItemOnTarget(useMatch[1].trim(), useMatch[2].trim());
                    else useItem(object);
                    break;
                
                case 'open': openObject(object); break;
                case 'read': readObject(object); break;
                case 'ring': ringBell(); break;
                
                // NPCs
                case 'talk': talkTo(object); break;
                case 'give':
                    const giveMatch = command.match(/^give\s+(.+?)\s+to\s+(.+)$/);
                    if (giveMatch) giveItemToNpc(giveMatch[1].trim(), giveMatch[2].trim());
                    else addToOutput("Give what to whom? Use: GIVE [item] TO [npc]");
                    break;
                
                // Combat
                case 'attack': attackEnemy(object); break;
                case 'equip': equipItem(object); break;
                case 'unequip': unequipItem(object); break;
                
                // Crafting
                case 'craft': craftItem(object); break;
                
                // System
                case 'save': saveGame(); addToOutput("Game saved.", "victory"); break;
                case 'load':
                    if (loadGame()) { 
                        addToOutput("Game loaded.", "victory"); 
                        updateStatus(); 
                        showLocation(); 
                        checkForEnemy();
                    } else { 
                        addToOutput("No saved game found.", "hint"); 
                    }
                    break;
                case 'help': showHelp(); break;
                case 'quit': quitGame(); break;
                
                default: addToOutput(`Command not implemented.`);
            }
            
            // Auto-save after each command
            saveGame();
        }

        // ==================== SHOW INVENTORY (enhanced) ====================
        function showInventory() {
            if (player.inventory.length === 0) {
                addToOutput("You are carrying nothing.");
            } else {
                addToOutput("You are carrying:", "item");
                player.inventory.forEach(item => {
                    let weight = itemWeights[item] || 1;
                    addToOutput(`  - ${item} (${weight} kg)`, "item");
                });
            }
            addToOutput(`Total weight: ${player.currentWeight()}/${player.maxWeight} kg`, "hint");
            addToOutput(`HP: ${player.currentHP}/${player.maxHP}`, "health");
            addToOutput(`Gold: ${player.gold}`, "gold");
            addToOutput(`Weapon: ${player.weapon.name} (${player.weapon.minDamage}-${player.weapon.maxDamage})`, "player");
            addToOutput(`Armor: ${player.armor ? player.armor.name : "None"}`, "player");
            
            if (player.poisonTurns > 0) {
                addToOutput(`Poisoned: ${player.poisonTurns} turns remaining`, "damage");
            }
        }

        // ==================== INITIALISE ====================
        function initGame() {
            gameOutput.innerHTML = '';
            
            const loaded = loadGame();
            
            if (!loaded) {
                resetToDefaults();
                
                // Title screen
                addToOutput("========================================", "title");
                addToOutput("  CASTLE OF THE UNDEAD 1984", "title");
                addToOutput("      COMPLETE EDITION", "title");
                addToOutput("========================================", "title");
                addToOutput(" ");
                addToOutput("You awake before the gates of a cursed castle.", "story");
                addToOutput("A ghostly GATEKEEPER drifts nearby, mourning his lost dagger.", "story");
                addToOutput("Inside, a necromancer's dark power corrupts all who dwell here.", "story");
                addToOutput(" ");
                addToOutput("13 ROOMS · 8 ENEMIES · 3 BOSSES · CRAFTING · MULTIPLE ENDINGS", "victory");
                addToOutput(" ");
                addToOutput("TIPS:", "hint");
                addToOutput("- EXAMINE everything. USE items ON targets.", "hint");
                addToOutput("- GIVE DAGGER TO GATEKEEPER, heal the WOUNDED GUARD.", "hint");
                addToOutput("- EQUIP better weapons and armor.", "hint");
                addToOutput("- CRAFT health potions from herbs and bottles.", "hint");
                addToOutput("- The SOUL GEM's fate determines your ending.", "hint");
                addToOutput(" ");
            } else {
                addToOutput("CASTLE OF THE UNDEAD 1984 - COMPLETE EDITION", "title");
                addToOutput("Game loaded successfully!", "victory");
                addToOutput(`HP: ${player.currentHP}/${player.maxHP} | Gold: ${player.gold}`, "player");
                addToOutput(`Weapon: ${player.weapon.name} | Armor: ${player.armor ? player.armor.name : "None"}`, "player");
            }
            
            updateStatus();
            showLocation();
            checkForEnemy();
            
            // Event listener
            gameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processCommand(this.value);
                    this.value = '';
                }
            });
            
            gameInput.focus();
        }

        // Start the game
        window.onload = initGame;
    </script>
</body>
</html>
