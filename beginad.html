mi<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle of the Dammed 1984</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            overflow-x: hidden;
        }
        
        .game-container {
            border: 2px solid #fff;
            padding: 20px;
            margin-top: 20px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px dashed #fff;
            padding-bottom: 10px;
        }
        
        .game-title {
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #fff;
        }
        
        .game-subtitle {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }
        
        .game-output {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
            border: 1px solid #333;
            padding: 15px;
            background-color: #111;
        }
        
        .game-output p {
            margin-bottom: 10px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .game-output .location {
            color: #ffff00;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .game-output .hint {
            color: #888;
            font-style: italic;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .game-output .enemy {
            color: #ff5555;
        }
        
        .game-output .npc {
            color: #55ff55;
        }
        
        .game-output .combat {
            color: #ff4444;
            font-weight: bold;
        }
        
        .game-output .player {
            color: #55ffff;
        }
        
        .game-output .health {
            color: #ff6666;
        }
        
        .game-output .damage {
            color: #ff9966;
        }
        
        .game-output .victory {
            color: #ffff55;
            font-weight: bold;
        }
        
        .game-output .defeat {
            color: #ff5555;
            font-weight: bold;
        }
        
        .game-output .gold {
            color: #ffd700;
        }
        
        .game-output .shop {
            color: #ffaa00;
        }
        
        .game-output .magic {
            color: #ff66ff;
        }
        
        .game-output .item {
            color: #55ff55;
        }
        
        .game-input-container {
            display: flex;
            align-items: center;
            border-top: 1px dashed #fff;
            padding-top: 15px;
        }
        
        .game-prompt {
            margin-right: 10px;
            color: #00ff00;
        }
        
        #game-input {
            background-color: #000;
            color: #fff;
            border: 1px solid #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            padding: 10px;
            flex-grow: 1;
            outline: none;
        }
        
        #game-input:focus {
            box-shadow: 0 0 5px #fff;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Scrollbar styling */
        .game-output::-webkit-scrollbar {
            width: 10px;
        }
        
        .game-output::-webkit-scrollbar-track {
            background: #111;
        }
        
        .game-output::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 5px;
        }
        
        .game-output::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
        
        /* Status bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #222;
            border: 1px solid #444;
            font-size: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
        }
        
        .health-bar {
            width: 100px;
            height: 12px;
            background-color: #333;
            margin-left: 5px;
            border: 1px solid #555;
        }
        
        .health-fill {
            height: 100%;
            background-color: #ff5555;
            transition: width 0.3s;
        }
        
        .magic-fill {
            background-color: #9966ff;
        }
        
        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                font-size: 14px;
                padding: 10px;
            }
            
            .game-title {
                font-size: 18px;
            }
            
            .game-container {
                padding: 10px;
            }
            
            #game-input {
                font-size: 12px;
                padding: 8px;
            }
            
            .status-bar {
                font-size: 10px;
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1 class="game-title">CASTLE OF THE DAMMED 1984</h1>
        <p class="game-subtitle">Â© 1984 Dystopian Castle Software</p>
        <p class="game-subtitle">Text Adventure v2.0 - EXPANDED EDITION</p>
    </div>
    
    <div class="status-bar" id="status-bar">
        <div class="status-item">
            HP: <span id="player-hp-text">50/50</span>
            <div class="health-bar">
                <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
            </div>
        </div>
        <div class="status-item">
            MP: <span id="player-mp-text">20/20</span>
            <div class="health-bar">
                <div class="health-fill magic-fill" id="player-magic-fill" style="width: 100%;"></div>
            </div>
        </div>
        <div class="status-item">
            Weapon: <span id="player-weapon">Fists</span>
        </div>
        <div class="status-item">
            Gold: <span id="player-gold">15</span>
        </div>
        <div class="status-item">
            Enemy HP: <span id="enemy-hp-text">-</span>
            <div class="health-bar">
                <div class="health-fill" id="enemy-health-fill" style="width: 0%; background-color: #ff9966;"></div>
            </div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="game-output" id="game-output">
            <!-- Game text will appear here -->
        </div>
        
        <div class="game-input-container">
            <span class="game-prompt">&gt;</span>
            <input type="text" id="game-input" placeholder="Type your command..." autocomplete="off">
        </div>
    </div>

    <script>
        // ==================== GAME SAVE SYSTEM ====================
        
        const SAVE_KEY = 'castleDamned1984Save';
        
        function saveGame() {
            const saveData = {
                player: {
                    maxHP: player.maxHP,
                    currentHP: player.currentHP,
                    maxMP: player.maxMP,
                    currentMP: player.currentMP,
                    gold: player.gold,
                    weapon: player.weapon,
                    inventory: player.inventory,
                    spells: player.spells,
                    equippedItems: player.equippedItems
                },
                gameState: gameState,
                combatActive: combatActive,
                currentEnemy: currentEnemy
            };
            localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
        }
        
        function loadGame() {
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) {
                try {
                    const saveData = JSON.parse(saved);
                    Object.assign(player, saveData.player);
                    Object.assign(gameState, saveData.gameState);
                    combatActive = saveData.combatActive || false;
                    currentEnemy = saveData.currentEnemy || null;
                    return true;
                } catch (e) {
                    console.error("Failed to load save:", e);
                }
            }
            return false;
        }
        
        function clearSave() {
            localStorage.removeItem(SAVE_KEY);
        }
        
        // ==================== COMBAT SYSTEM ====================
        
        // Player stats
        const player = {
            maxHP: 500,
            currentHP: 500,
            maxMP: 200,
            currentMP: 20,
            gold: 15,
            weapon: {
                name: "Fists",
                minDamage: 4,
                maxDamage: 6,
                type: "melee"
            },
            inventory: ["leather bound spellbook", "health potion", "torch"],
            spells: ["magic missile"], // Starting spell
            equippedItems: {
                weapon: "Fists",
                armor: null,
                accessory: null
            }
        };
        
        // Enemy types - EXPANDED
        const enemies = {
            corruptedGuard: {
                name: "Corrupted Castle Guard",
                maxHP: 25,
                currentHP: 25,
                minDamage: 3,
                maxDamage: 6,
                description: "A castle guard whose eyes glow with an unnatural purple light. His armor is rusted and he moves with jerky, unnatural motions.",
                defeatMessage: "The corrupted guard collapses into a pile of rusted armor and dust!",
                loot: "rusty sword"
            },
            shadowStalker: {
                name: "Shadow Stalker",
                maxHP: 18,
                currentHP: 18,
                minDamage: 4,
                maxDamage: 7,
                description: "A creature made of living shadow that seems to drink the light around it.",
                defeatMessage: "The shadow stalker dissipates with an unearthly shriek!",
                loot: "shadow essence"
            },
            stoneGolem: {
                name: "Stone Golem",
                maxHP: 40,
                currentHP: 40,
                minDamage: 6,
                maxDamage: 10,
                description: "A massive construct of animated stone with glowing runes carved into its body.",
                defeatMessage: "The stone golem crumbles into rubble!",
                loot: "stone heart"
            },
            phantomKnight: {
                name: "Phantom Knight",
                maxHP: 30,
                currentHP: 30,
                minDamage: 5,
                maxDamage: 9,
                description: "A spectral knight in ethereal armor, floating above the ground.",
                defeatMessage: "The phantom knight vanishes with a mournful wail!",
                loot: "phantom shard"
            },
            fleshAbomination: {
                name: "Flesh Abomination",
                maxHP: 50,
                currentHP: 50,
                minDamage: 7,
                maxDamage: 12,
                description: "A horrific mass of stitched-together body parts that moves with unnatural speed.",
                defeatMessage: "The abomination dissolves into a puddle of foul-smelling goo!",
                loot: "abomination ichor"
            },
            fireElemental: {
                name: "Fire Elemental",
                maxHP: 35,
                currentHP: 35,
                minDamage: 8,
                maxDamage: 11,
                description: "A living being of pure flame that radiates intense heat.",
                defeatMessage: "The fire elemental snuffs out in a puff of smoke!",
                loot: "fire crystal"
            },
            cursedWizard: {
                name: "Cursed Wizard",
                maxHP: 28,
                currentHP: 28,
                minDamage: 4,
                maxDamage: 15,
                description: "A mage whose flesh has fused with his robes, crackling with unstable magic.",
                defeatMessage: "The wizard's body unravels in a burst of chaotic energy!",
                loot: "wizard's staff"
            },
            dungeonSlime: {
                name: "Dungeon Slime",
                maxHP: 15,
                currentHP: 15,
                minDamage: 2,
                maxDamage: 4,
                description: "A gelatinous green blob that leaves a corrosive trail.",
                defeatMessage: "The slime dissolves into harmless goo!",
                loot: "healing herb"
            },
            gargoyle: {
                name: "Gargoyle",
                maxHP: 32,
                currentHP: 32,
                minDamage: 5,
                maxDamage: 8,
                description: "A stone creature that has animated to protect the castle grounds.",
                defeatMessage: "The gargoyle returns to inert stone!",
                loot: "stone fragment"
            },
            vampireSpawn: {
                name: "Vampire Spawn",
                maxHP: 26,
                currentHP: 26,
                minDamage: 6,
                maxDamage: 9,
                description: "A pale humanoid with elongated fangs and blood-red eyes.",
                defeatMessage: "The vampire spawn crumbles to dust!",
                loot: "vampire dust"
            }
        };
        
        // Spell definitions - EXPANDED
        const spells = {
            "magic missile": {
                name: "Magic Missile",
                cost: 5,
                description: "Fires a bolt of magical energy at your enemy.",
                effect: function() {
                    if (!currentEnemy) {
                        addToOutput("There's nothing to attack with magic here.", "magic");
                        return false;
                    }
                    
                    const damage = Math.floor(Math.random() * 6) + 5; // 5-10 damage
                    currentEnemy.currentHP -= damage;
                    currentEnemy.currentHP = Math.max(0, currentEnemy.currentHP);
                    
                    addToOutput(`You cast Magic Missile! It hits for ${damage} damage!`, "magic");
                    addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
                    
                    if (currentEnemy.currentHP <= 0) {
                        endCombat(true);
                    } else {
                        enemyAttack();
                    }
                    updateStatus();
                    return true;
                }
            },
            "heal": {
                name: "Heal",
                cost: 8,
                description: "Restores 15-25 HP to yourself.",
                effect: function() {
                    const healAmount = Math.floor(Math.random() * 11) + 15;
                    player.currentHP = Math.min(player.maxHP, player.currentHP + healAmount);
                    addToOutput(`You cast Heal! You restore ${healAmount} HP!`, "magic");
                    updateStatus();
                    return true;
                }
            },
            "light": {
                name: "Light",
                cost: 3,
                description: "Creates a magical light source that reveals hidden objects.",
                effect: function() {
                    const loc = locations[gameState.currentLocation];
                    addToOutput("You cast Light! The area is illuminated by magical energy.", "magic");
                    
                    if (loc.hiddenItems && loc.hiddenItems.length > 0) {
                        addToOutput("The magical light reveals previously hidden items!", "magic");
                        loc.hiddenItems.forEach(item => {
                            if (!loc.items.includes(item) && !player.inventory.includes(item)) {
                                loc.items.push(item);
                                addToOutput(`You see a ${item.toUpperCase()} revealed by the light!`, "item");
                            }
                        });
                    }
                    return true;
                }
            },
            "fireball": {
                name: "Fireball",
                cost: 12,
                description: "Hurls a ball of fire that deals heavy damage.",
                effect: function() {
                    if (!currentEnemy) {
                        addToOutput("There's nothing to attack with fire here.", "magic");
                        return false;
                    }
                    
                    const damage = Math.floor(Math.random() * 11) + 15; // 15-25 damage
                    currentEnemy.currentHP -= damage;
                    currentEnemy.currentHP = Math.max(0, currentEnemy.currentHP);
                    
                    addToOutput(`You cast Fireball! It explodes for ${damage} damage!`, "magic");
                    addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
                    
                    if (currentEnemy.currentHP <= 0) {
                        endCombat(true);
                    } else {
                        enemyAttack();
                    }
                    updateStatus();
                    return true;
                }
            },
            "shield": {
                name: "Shield",
                cost: 6,
                description: "Creates a magical barrier that reduces incoming damage by 50% for 3 turns.",
                effect: function() {
                    if (!combatActive) {
                        addToOutput("You cast Shield. A magical barrier surrounds you.", "magic");
                        playerShieldActive = 3; // 3 turns
                        return true;
                    }
                    
                    addToOutput("You cast Shield. A magical barrier surrounds you, reducing damage!", "magic");
                    playerShieldActive = 3;
                    enemyAttack();
                    updateStatus();
                    return true;
                }
            },
            "freeze": {
                name: "Freeze",
                cost: 10,
                description: "Encases the enemy in ice, stunning them for 1 turn.",
                effect: function() {
                    if (!currentEnemy) {
                        addToOutput("There's nothing to freeze here.", "magic");
                        return false;
                    }
                    
                    const damage = Math.floor(Math.random() * 4) + 3; // 3-6 damage
                    currentEnemy.currentHP -= damage;
                    
                    addToOutput(`You cast Freeze! It hits for ${damage} damage and freezes the enemy!`, "magic");
                    enemyFrozen = true;
                    
                    if (currentEnemy.currentHP <= 0) {
                        endCombat(true);
                    } else {
                        addToOutput("The enemy is frozen solid and cannot attack this turn!");
                        updateStatus();
                    }
                    return true;
                }
            }
        };
        
        // Current combat state
        let combatActive = false;
        let currentEnemy = null;
        let playerShieldActive = 0;
        let enemyFrozen = false;
        
        // ==================== GAME STATE ====================
        const gameState = {
            currentLocation: 'dungeonCell',
            inventory: [],
            visitedLocations: ['dungeonCell'],
            gameEnded: false,
            
            // Room-specific states
            dungeonCell: {
                bedExamined: false,
                brickExamined: false,
                looseBrickFound: false,
                potionTaken: false,
                keyTaken: false
            },
            guardRoom: {
                guardDefeated: false,
                swordTaken: false,
                portraitExamined: false,
                secretFound: false,
                silverKeyTaken: false
            },
            library: {
                librarianTalked: false,
                scrollTaken: false,
                fireplaceExamined: false,
                tomeExamined: false,
                healSpellLearned: false
            },
            // NEW ROOMS
            secretPassage: {
                trapDisarmed: false,
                chestOpened: false,
                ratDefeated: false
            },
            alchemyLab: {
                alchemistTalked: false,
                potionBrewed: false,
                ingredientsTaken: false
            },
            grandHall: {
                knightTalked: false,
                chandelierExamined: false,
                golemDefeated: false
            },
            throneRoom: {
                throneExamined: false,
                kingDefeated: false,
                crownTaken: false
            },
            barracks: {
                bedsSearched: false,
                trainingDummyUsed: false,
                phantomDefeated: false
            },
            tortureChamber: {
                rackExamined: false,
                prisonerFreed: false,
                chainsTaken: false
            },
            armory: {
                weaponsTaken: false,
                armorEquipped: false,
                abominationDefeated: false
            },
            catacombs: {
                coffinOpened: false,
                altarUsed: false,
                vampireDefeated: false
            },
            observatory: {
                telescopeUsed: false,
                starChartRead: false,
                elementalDefeated: false
            },
            wizardTower: {
                spellLearned: false,
                experimentStopped: false,
                wizardDefeated: false
            }
        };
        
        // Update status display
        function updateStatus() {
            document.getElementById('player-hp-text').textContent = 
                `${player.currentHP}/${player.maxHP}`;
            
            document.getElementById('player-mp-text').textContent = 
                `${player.currentMP}/${player.maxMP}`;
            
            const playerHealthPercent = (player.currentHP / player.maxHP) * 100;
            document.getElementById('player-health-fill').style.width = 
                `${Math.max(0, playerHealthPercent)}%`;
            
            const playerMagicPercent = (player.currentMP / player.maxMP) * 100;
            document.getElementById('player-magic-fill').style.width = 
                `${Math.max(0, playerMagicPercent)}%`;
            
            document.getElementById('player-weapon').textContent = player.weapon.name;
            document.getElementById('player-gold').textContent = player.gold;
            
            if (currentEnemy && combatActive) {
                document.getElementById('enemy-hp-text').textContent = 
                    `${currentEnemy.currentHP}/${currentEnemy.maxHP}`;
                
                const enemyHealthPercent = (currentEnemy.currentHP / currentEnemy.maxHP) * 100;
                document.getElementById('enemy-health-fill').style.width = 
                    `${Math.max(0, enemyHealthPercent)}%`;
                document.getElementById('enemy-health-fill').style.display = 'block';
            } else {
                document.getElementById('enemy-hp-text').textContent = '-';
                document.getElementById('enemy-health-fill').style.display = 'none';
            }
            
            // Auto-save after every status update
            saveGame();
        }
        
        // Combat functions
        function startCombat(enemyType) {
            currentEnemy = JSON.parse(JSON.stringify(enemies[enemyType])); // Clone enemy
            combatActive = true;
            playerShieldActive = 0;
            enemyFrozen = false;
            updateStatus();
            
            addToOutput(`A ${currentEnemy.name} appears!`, "enemy");
            addToOutput(currentEnemy.description, "enemy");
            addToOutput("COMBAT STARTED! Use ATTACK to fight or CAST [spell]!", "combat");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP} | ${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "combat");
        }
        
        function playerAttack() {
            if (!combatActive || !currentEnemy) {
                addToOutput("There's nothing to attack here.");
                return;
            }
            
            const playerDamage = Math.floor(
                Math.random() * (player.weapon.maxDamage - player.weapon.minDamage + 1)
            ) + player.weapon.minDamage;
            
            currentEnemy.currentHP -= playerDamage;
            currentEnemy.currentHP = Math.max(0, currentEnemy.currentHP);
            
            addToOutput(`You attack with your ${player.weapon.name} and deal ${playerDamage} damage!`, "player");
            addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
            
            if (currentEnemy.currentHP <= 0) {
                endCombat(true);
                return;
            }
            
            if (!enemyFrozen) {
                enemyAttack();
            } else {
                addToOutput("The enemy is still frozen and cannot attack!", "magic");
                enemyFrozen = false;
            }
            
            // Reduce shield duration
            if (playerShieldActive > 0) {
                playerShieldActive--;
                if (playerShieldActive === 0) {
                    addToOutput("Your magical shield dissipates.", "magic");
                }
            }
            
            updateStatus();
        }
        
        function enemyAttack() {
            let enemyDamage = Math.floor(
                Math.random() * (currentEnemy.maxDamage - currentEnemy.minDamage + 1)
            ) + currentEnemy.minDamage;
            
            // Apply shield reduction
            if (playerShieldActive > 0) {
                enemyDamage = Math.floor(enemyDamage / 2);
                addToOutput("Your shield reduces the damage!", "magic");
            }
            
            player.currentHP -= enemyDamage;
            player.currentHP = Math.max(0, player.currentHP);
            
            addToOutput(`${currentEnemy.name} attacks you for ${enemyDamage} damage!`, "enemy");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP}`, "health");
            
            if (player.currentHP <= 0) {
                endCombat(false);
            }
        }
        
        function endCombat(playerWon) {
            if (playerWon) {
                addToOutput(currentEnemy.defeatMessage, "victory");
                
                if (currentEnemy.loot && !player.inventory.includes(currentEnemy.loot)) {
                    player.inventory.push(currentEnemy.loot);
                    addToOutput(`You found a ${currentEnemy.loot}!`, "item");
                    
                    // Special loot handling
                    if (currentEnemy.loot === "rusty sword") {
                        addToOutput("You can EQUIP RUSTY SWORD to use it as a weapon.", "hint");
                        gameState.guardRoom.swordTaken = true;
                    } else if (currentEnemy.loot === "stone heart") {
                        addToOutput("The stone heart pulses with a dull glow.", "item");
                    } else if (currentEnemy.loot === "wizard's staff") {
                        addToOutput("The staff hums with residual magical energy.", "magic");
                    }
                }
                
                // Update game states for specific enemies
                if (currentEnemy.name === "Corrupted Castle Guard") {
                    gameState.guardRoom.guardDefeated = true;
                } else if (currentEnemy.name === "Stone Golem") {
                    gameState.grandHall.golemDefeated = true;
                } else if (currentEnemy.name === "Flesh Abomination") {
                    gameState.armory.abominationDefeated = true;
                } else if (currentEnemy.name === "Cursed Wizard") {
                    gameState.wizardTower.wizardDefeated = true;
                } else if (currentEnemy.name === "Vampire Spawn") {
                    gameState.catacombs.vampireDefeated = true;
                } else if (currentEnemy.name === "Fire Elemental") {
                    gameState.observatory.elementalDefeated = true;
                } else if (currentEnemy.name === "Phantom Knight") {
                    gameState.barracks.phantomDefeated = true;
                }
                
                // Award some gold for victory
                const goldReward = Math.floor(Math.random() * 15) + 10;
                player.gold += goldReward;
                addToOutput(`You find ${goldReward} gold on the defeated enemy!`, "gold");
                
                // XP or stat boost chance
                if (Math.random() < 0.3) {
                    player.maxHP += 5;
                    player.currentHP = Math.min(player.maxHP, player.currentHP + 5);
                    addToOutput("You feel stronger! Maximum HP increased by 5!", "health");
                }
                
            } else {
                addToOutput("You have been defeated!", "defeat");
                addToOutput("GAME OVER - Type 'RESTART' to try again or load a saved game.", "defeat");
                gameState.gameEnded = true;
                gameInput.disabled = true;
            }
            
            combatActive = false;
            currentEnemy = null;
            playerShieldActive = 0;
            enemyFrozen = false;
            updateStatus();
        }
        
        // Object descriptions - EXPANDED
        const objectDescriptions = {
            // Weapons
            "fists": "Your bare hands. Not very effective but better than nothing. Damage: 4-6",
            "rusty sword": "A rusted but still functional sword. Better than fists. Damage: 6-9",
            "iron key": "A simple iron key. Might unlock something.",
            "silver key": "A delicate silver key with intricate designs.",
            "wizard's staff": "An ornate staff that hums with magical energy. Damage: 8-12, +5 MP",
            "enchanted sword": "A sword glowing with blue energy. Damage: 10-15",
            "crystal dagger": "A dagger made of pure crystal. Damage: 7-10, +3 MP",
            "stone heart": "A magical stone that pulses with energy. Can be used for something.",
            "phantom shard": "A fragment of a phantom's essence. It feels cold.",
            "abomination ichor": "A vial of thick, foul-smelling liquid.",
            "fire crystal": "A hot crystal that radiates warmth.",
            "healing herb": "A rare herb with medicinal properties.",
            "stone fragment": "A piece of magical stone. Might have uses.",
            "vampire dust": "Fine dust that sparkles in the light.",
            
            // Items
            "leather bound spellbook": "Your personal spellbook. It contains the spells you know. READ SPELLBOOK to see your spells.",
            "health potion": "A small vial containing red liquid. Restores 20 HP when used.",
            "torch": "A wooden torch wrapped in cloth. Can be lit to provide light.",
            "shadow essence": "A vial containing swirling shadow. It might have magical properties.",
            "ancient scroll": "A scroll containing a healing spell. READ SCROLL to learn it.",
            "dusty tome": "An ancient book covered in dust. It might contain useful information.",
            "alchemy ingredients": "Various herbs, crystals, and reagents for potion-making.",
            "royal crown": "A magnificent gold crown encrusted with gems.",
            "iron chains": "Heavy chains that might have uses.",
            "plate armor": "Heavy protective armor. Reduces damage taken.",
            "elixir of life": "A rare potion that permanently increases HP.",
            "star chart": "An ancient chart of constellations.",
            "crystal ball": "A magical orb that shows glimpses of the future.",
            "enchanted amulet": "An amulet that increases magical power.",
            "golden key": "A key made of pure gold. Must be important.",
            "potion of invisibility": "A potion that makes you invisible for a short time.",
            
            // Room objects
            "straw bed": "A musty old bed filled with straw. It looks uncomfortable.",
            "loose brick": "A brick that seems out of place in the wall.",
            "rusty barrel": "An old, rusted barrel. It's empty.",
            "portrait": "A painting of a noble lord. The eyes seem to follow you.",
            "fireplace": "A large stone fireplace filled with cold ashes.",
            "bookshelf": "A shelf filled with ancient books.",
            "bookshelves": "Towering shelves filled with ancient books.",
            "table": "A sturdy wooden table.",
            "chair": "A comfortable looking chair.",
            "chest": "An old wooden chest. Might contain treasure.",
            "alchemy table": "A table covered in beakers and flasks.",
            "chandelier": "A massive crystal chandelier hanging from the ceiling.",
            "throne": "An ornate throne carved from obsidian.",
            "training dummy": "A dummy used for weapons practice.",
            "torture rack": "A horrific device for stretching prisoners.",
            "weapon rack": "A rack holding various weapons.",
            "coffin": "An ancient coffin covered in dust.",
            "altar": "A stone altar with strange markings.",
            "telescope": "A large brass telescope pointed at the sky.",
            "cauldron": "A large bubbling cauldron of mysterious liquid."
        };

        // Game locations - EXPANDED WITH 10 NEW ROOMS
        const locations = {
            dungeonCell: {
                name: "DUNGEON CELL",
                description: function() {
                    let desc = "You awaken in a cold, damp dungeon cell. The air smells of mildew and decay. ";
                    desc += "In one corner sits a STRAW BED, and in another, a RUSTY BARREL. ";
                    desc += "The cell door to the north is slightly ajar.";
                    
                    if (!gameState.dungeonCell.keyTaken && this.items.includes('iron key')) {
                        desc += " You notice an IRON KEY on the floor near the bed.";
                    }
                    
                    if (!gameState.dungeonCell.potionTaken && this.items.includes('health potion')) {
                        desc += " There's a HEALTH POTION on a small ledge.";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["iron key", "health potion"],
                exits: {
                    north: "guardRoom",
                    south: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            guardRoom: {
                name: "GUARD ROOM",
                description: function() {
                    let desc = "A guard room with a stone table and chairs. ";
                    
                    if (!gameState.guardRoom.guardDefeated) {
                        desc += "A CORRUPTED GUARD blocks your way, his eyes glowing with purple light! ";
                        this.enemy = "corruptedGuard";
                    } else {
                        desc += "The defeated guard's armor lies in a pile on the floor. ";
                        this.enemy = null;
                    }
                    
                    desc += "On the wall hangs a PORTRAIT of a noble lord. ";
                    desc += "A wooden DOOR leads east, and the cell door is to the south.";
                    
                    if (gameState.guardRoom.guardDefeated && !gameState.guardRoom.swordTaken && this.items.includes('rusty sword')) {
                        desc += " The guard's RUSTY SWORD lies on the floor.";
                    }
                    
                    if (gameState.guardRoom.secretFound && !gameState.guardRoom.silverKeyTaken && this.items.includes('silver key')) {
                        desc += " A SILVER KEY glints from within the portrait's secret compartment.";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["silver key"],
                exits: {
                    south: "dungeonCell",
                    east: "library",
                    north: "grandHall",
                    west: null
                },
                visited: false,
                enemy: "corruptedGuard"
            },
            library: {
                name: "ANCIENT LIBRARY",
                description: function() {
                    let desc = "You enter a vast library filled with towering BOOKSHELVES. ";
                    desc += "Dusty TOMES line the shelves. In the center of the room, an old LIBRARIAN ";
                    desc += "is organizing scrolls at a large TABLE. A stone FIREPLACE dominates the west wall. ";
                    desc += "Exits lead west to the guard room and north to a secret passage.";
                    
                    if (!gameState.library.scrollTaken && this.items.includes('ancient scroll')) {
                        desc += " An ANCIENT SCROLL sits on the table.";
                    }
                    
                    return desc;
                },
                items: ["ancient scroll", "dusty tome"],
                hiddenItems: [],
                exits: {
                    west: "guardRoom",
                    north: "secretPassage",
                    east: null,
                    south: null
                },
                visited: false,
                enemy: null
            },
            // NEW ROOM 1: Secret Passage
            secretPassage: {
                name: "SECRET PASSAGE",
                description: function() {
                    let desc = "A narrow, winding passage hidden behind the library fireplace. ";
                    desc += "The walls are damp and covered in moss. A RUSTY CHEST sits in a corner. ";
                    
                    if (!gameState.secretPassage.ratDefeated) {
                        desc += "A giant DUNGEON SLIME blocks your path!";
                        this.enemy = "dungeonSlime";
                    } else {
                        desc += "The remains of the slime ooze on the floor. ";
                        this.enemy = null;
                    }
                    
                    desc += " The passage continues north to an alchemy lab.";
                    
                    if (!gameState.secretPassage.chestOpened && this.items.includes('golden key')) {
                        desc += " The chest appears to be locked.";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["golden key"],
                exits: {
                    south: "library",
                    north: "alchemyLab",
                    east: null,
                    west: null
                },
                visited: false,
                enemy: "dungeonSlime"
            },
            // NEW ROOM 2: Alchemy Lab
            alchemyLab: {
                name: "ALCHEMY LABORATORY",
                description: function() {
                    let desc = "A room filled with bubbling CAULDRONS and complex ALCHEMY EQUIPMENT. ";
                    desc += "Bottles of colorful liquids line the shelves. An ALCHEMIST in stained robes ";
                    desc += "works at the main table. Exits lead south to the secret passage and east to the grand hall.";
                    
                    if (!gameState.alchemyLab.ingredientsTaken && this.items.includes('alchemy ingredients')) {
                        desc += " A set of ALCHEMY INGREDIENTS sits on a side table.";
                    }
                    
                    return desc;
                },
                items: ["alchemy ingredients"],
                hiddenItems: [],
                exits: {
                    south: "secretPassage",
                    east: "grandHall",
                    north: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            // NEW ROOM 3: Grand Hall
            grandHall: {
                name: "GRAND HALL",
                description: function() {
                    let desc = "A massive hall with marble floors and towering pillars. ";
                    desc += "A massive CRYSTAL CHANDELIER hangs from the ceiling. ";
                    
                    if (!gameState.grandHall.golemDefeated) {
                        desc += "A massive STONE GOLEM stands guard in the center of the room!";
                        this.enemy = "stoneGolem";
                    } else {
                        desc += "The remains of the stone golem litter the floor. ";
                        this.enemy = null;
                    }
                    
                    desc += " Exits lead west to the alchemy lab, north to the throne room, east to the barracks, and south to the guard room.";
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["enchanted amulet"],
                exits: {
                    west: "alchemyLab",
                    north: "throneRoom",
                    east: "barracks",
                    south: "guardRoom"
                },
                visited: false,
                enemy: "stoneGolem"
            },
            // NEW ROOM 4: Throne Room
            throneRoom: {
                name: "THRONE ROOM",
                description: function() {
                    let desc = "An opulent throne room with a massive OBSIDIAN THRONE on a raised dais. ";
                    desc += "Tattered banners hang from the walls. The skeletal remains of courtiers ";
                    desc += "litter the floor. ";
                    
                    if (!gameState.throneRoom.kingDefeated) {
                        desc += "A CURSED WIZARD sits upon the throne, crackling with dark energy!";
                        this.enemy = "cursedWizard";
                    } else {
                        desc += "The wizard's robes lie empty on the throne. ";
                        this.enemy = null;
                    }
                    
                    desc += " The grand hall is to the south.";
                    
                    if (gameState.throneRoom.kingDefeated && !gameState.throneRoom.crownTaken && this.items.includes('royal crown')) {
                        desc += " The ROYAL CROWN rests on the throne.";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["royal crown"],
                exits: {
                    south: "grandHall",
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: "cursedWizard"
            },
            // NEW ROOM 5: Barracks
            barracks: {
                name: "CASTLE BARRACKS",
                description: function() {
                    let desc = "A long room filled with rows of BEDS and lockers. ";
                    desc += "A WEAPONS RACK holds training weapons, and a TRAINING DUMMY ";
                    desc += "stands in one corner. ";
                    
                    if (!gameState.barracks.phantomDefeated) {
                        desc += "A PHANTOM KNIGHT patrols the room, its spectral armor glowing!";
                        this.enemy = "phantomKnight";
                    } else {
                        desc += "The phantom's essence has dissipated. ";
                        this.enemy = null;
                    }
                    
                    desc += " Exits lead west to the grand hall and south to the torture chamber.";
                    
                    if (!gameState.barracks.bedsSearched && this.items.includes('plate armor')) {
                        desc += " Something glints under one of the beds.";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["plate armor"],
                exits: {
                    west: "grandHall",
                    south: "tortureChamber",
                    north: null,
                    east: null
                },
                visited: false,
                enemy: "phantomKnight"
            },
            // NEW ROOM 6: Torture Chamber
            tortureChamber: {
                name: "TORTURE CHAMBER",
                description: function() {
                    let desc = "A horrific room filled with TORTURE DEVICES. ";
                    desc += "A RACK dominates the center of the room, and IRON CHAINS ";
                    desc += "hang from the walls. A PRISONER is chained to the wall, barely conscious. ";
                    desc += "Exits lead north to the barracks and east to the armory.";
                    
                    if (!gameState.tortureChamber.chainsTaken && this.items.includes('iron chains')) {
                        desc += " A set of heavy IRON CHAINS lies on the floor.";
                    }
                    
                    return desc;
                },
                items: ["iron chains"],
                hiddenItems: [],
                exits: {
                    north: "barracks",
                    east: "armory",
                    south: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            // NEW ROOM 7: Armory
            armory: {
                name: "CASTLE ARMORY",
                description: function() {
                    let desc = "A room filled with WEAPONS RACKS and armor stands. ";
                    desc += "Most weapons are rusted or broken. ";
                    
                    if (!gameState.armory.abominationDefeated) {
                        desc += "A horrific FLESH ABOMINATION lurks among the weapons!";
                        this.enemy = "fleshAbomination";
                    } else {
                        desc += "The remains of the abomination stain the floor. ";
                        this.enemy = null;
                    }
                    
                    desc += " Exits lead west to the torture chamber and north to the catacombs.";
                    
                    if (!gameState.armory.weaponsTaken && this.items.includes('enchanted sword')) {
                        desc += " An ENCHANTED SWORD glows on one of the racks.";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["enchanted sword"],
                exits: {
                    west: "tortureChamber",
                    north: "catacombs",
                    south: null,
                    east: null
                },
                visited: false,
                enemy: "fleshAbomination"
            },
            // NEW ROOM 8: Catacombs
            catacombs: {
                name: "ROYAL CATACOMBS",
                description: function() {
                    let desc = "A network of tombs and burial chambers beneath the castle. ";
                    desc += "Ancient COFFINS line the walls, and a stone ALTAR stands ";
                    desc += "in the center. ";
                    
                    if (!gameState.catacombs.vampireDefeated) {
                        desc += "A VAMPIRE SPAWN emerges from the shadows!";
                        this.enemy = "vampireSpawn";
                    } else {
                        desc += "Vampire dust covers the floor. ";
                        this.enemy = null;
                    }
                    
                    desc += " Exits lead south to the armory and east to the observatory.";
                    
                    if (!gameState.catacombs.coffinOpened && this.items.includes('elixir of life')) {
                        desc += " One coffin seems different from the others.";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["elixir of life"],
                exits: {
                    south: "armory",
                    east: "observatory",
                    north: null,
                    west: null
                },
                visited: false,
                enemy: "vampireSpawn"
            },
            // NEW ROOM 9: Observatory
            observatory: {
                name: "ROYAL OBSERVATORY",
                description: function() {
                    let desc = "A circular room with a massive TELESCOPE pointed at the sky. ";
                    desc += "Star charts cover the walls, and a CRYSTAL BALL sits on a pedestal. ";
                    
                    if (!gameState.observatory.elementalDefeated) {
                        desc += "A FIRE ELEMENTAL rages near the telescope!";
                        this.enemy = "fireElemental";
                    } else {
                        desc += "The room is scorched but the fire is gone. ";
                        this.enemy = null;
                    }
                    
                    desc += " Exits lead west to the catacombs and north to the wizard tower.";
                    
                    if (!gameState.observatory.starChartRead && this.items.includes('star chart')) {
                        desc += " An intricate STAR CHART is spread on a table.";
                    }
                    
                    return desc;
                },
                items: ["star chart"],
                hiddenItems: [],
                exits: {
                    west: "catacombs",
                    north: "wizardTower",
                    south: null,
                    east: null
                },
                visited: false,
                enemy: "fireElemental"
            },
            // NEW ROOM 10: Wizard Tower
            wizardTower: {
                name: "WIZARD'S TOWER",
                description: function() {
                    let desc = "The highest room in the castle, with windows showing the night sky. ";
                    desc += "Magical artifacts and strange devices fill the room. ";
                    
                    if (!gameState.wizardTower.wizardDefeated) {
                        desc += "A CURSED WIZARD chants over a bubbling cauldron!";
                        this.enemy = "cursedWizard";
                    } else {
                        desc += "The wizard's experiment has been stopped. ";
                        this.enemy = null;
                    }
                    
                    desc += " The observatory is to the south.";
                    
                    if (gameState.wizardTower.wizardDefeated && this.items.includes('crystal ball')) {
                        desc += " A CRYSTAL BALL glows on the main table.";
                    }
                    
                    return desc;
                },
                items: ["crystal ball"],
                hiddenItems: [],
                exits: {
                    south: "observatory",
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: "cursedWizard"
            }
        };

        // Game commands
        const commands = {
            'north': 'north',
            'n': 'north',
            'south': 'south',
            's': 'south',
            'east': 'east',
            'e': 'east',
            'west': 'west',
            'w': 'west',
            'look': 'look',
            'l': 'look',
            'inventory': 'inventory',
            'i': 'inventory',
            'take': 'take',
            'get': 'take',
            'grab': 'take',
            'drop': 'drop',
            'examine': 'examine',
            'x': 'examine',
            'use': 'use',
            'equip': 'equip',
            'unequip': 'unequip',
            'open': 'open',
            'read': 'read',
            'talk': 'talk',
            'speak': 'talk',
            'ask': 'talk',
            'give': 'give',
            'attack': 'attack',
            'fight': 'attack',
            'kill': 'attack',
            'cast': 'cast',
            'light': 'light',
            'repair': 'repair',
            'fix': 'repair',
            'eat': 'eat',
            'drink': 'drink',
            'buy': 'buy',
            'purchase': 'buy',
            'sell': 'sell',
            'shop': 'shop',
            'list': 'shop',
            'save': 'save',
            'load': 'load',
            'restart': 'restart',
            'help': 'help',
            'h': 'help',
            'quit': 'quit',
            'q': 'quit'
        };

        // DOM elements
        const gameOutput = document.getElementById('game-output');
        const gameInput = document.getElementById('game-input');

        // Add text to game output
        function addToOutput(text, className = '') {
            const p = document.createElement('p');
            p.textContent = text;
            if (className) {
                p.className = className;
            }
            gameOutput.appendChild(p);
            
            gameOutput.scrollTop = gameOutput.scrollHeight;
        }

        // Show current location
        function showLocation() {
            const loc = locations[gameState.currentLocation];
            
            addToOutput(loc.name, "location");
            
            const description = loc.description();
            addToOutput(description);
            
            if (!loc.visited) {
                loc.visited = true;
                gameState.visitedLocations.push(gameState.currentLocation);
            }
            
            // Start combat if there's an enemy in the room and we're not already in combat
            if (loc.enemy && !combatActive) {
                const roomState = gameState[gameState.currentLocation];
                const enemyDefeatedField = gameState.currentLocation + "Defeated";
                
                // Check if enemy is already defeated for this room
                if (!roomState || !roomState[enemyDefeatedField] || !roomState.golemDefeated) {
                    startCombat(loc.enemy);
                }
            }
            
            const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
            if (exits.length > 0) {
                addToOutput("Exits: " + exits.map(exit => exit.toUpperCase()).join(", "));
            }
        }

        // Initialize game
        function initGame() {
            // Clear output first
            gameOutput.innerHTML = '';
            
            // Try to load saved game first
            const loaded = loadGame();
            
            if (!loaded) {
                // Normal initialization
                addToOutput("CASTLE OF THE DAMMED 1984 - EXPANDED EDITION", "title");
                addToOutput("Dystopian Text Adventure v2.0 - 13 ROOMS NOW AVAILABLE", "subtitle");
                addToOutput(" ");
                addToOutput("The year is 1984, but not as you know it. The Castle of the Dammed", "story");
                addToOutput("has stood for centuries, its dark magic warping time and space.", "story");
                addToOutput("You awaken in its dungeons with no memory of how you got here...", "story");
                addToOutput(" ");
                addToOutput("NEW FEATURES:", "victory");
                addToOutput("- 10 new rooms with unique enemies and puzzles", "victory");
                addToOutput("- New spells: Fireball, Shield, Freeze", "magic");
                addToOutput("- New weapons and armor to discover", "item");
                addToOutput("- Shield system for damage reduction", "hint");
                addToOutput(" ");
                addToOutput("TIP: You start with a spellbook containing MAGIC MISSILE.", "magic");
                addToOutput("Use CAST MAGIC MISSILE in combat or EXAMINE everything for clues.", "hint");
                addToOutput("New: Use EQUIP [weapon] to change your main weapon.", "hint");
                addToOutput(" ");
                
                // Set initial inventory
                gameState.inventory = [...player.inventory];
                updateStatus();
                showLocation();
            } else {
                addToOutput("CASTLE OF THE DAMMED 1984 - EXPANDED EDITION", "title");
                addToOutput("Game loaded successfully!", "victory");
                addToOutput(`HP: ${player.currentHP}/${player.maxHP} | MP: ${player.currentMP}/${player.maxMP}`, "player");
                addToOutput(`Gold: ${player.gold} | Weapon: ${player.weapon.name}`, "player");
                
                if (player.spells.length > 0) {
                    addToOutput("Known spells: " + player.spells.map(s => s.toUpperCase()).join(", "), "magic");
                }
                
                if (player.inventory.length > 0) {
                    addToOutput("Inventory: " + player.inventory.map(item => item.toUpperCase()).join(", "));
                }
                
                addToOutput(" ");
                showLocation();
            }
            
            // Set up input event listener
            gameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processCommand(this.value);
                    this.value = '';
                }
            });
            
            gameInput.focus();
        }

        // Process player command
        function processCommand(input) {
            if (gameState.gameEnded && !input.toLowerCase().includes('restart')) {
                addToOutput("The game has ended. Type RESTART to try again.", "hint");
                return;
            }
            
            const command = input.trim().toLowerCase();
            if (!command) return;
            
            const parts = command.split(' ');
            const verb = parts[0];
            const object = parts.slice(1).join(' ');
            
            // Check for restart command
            if (verb === 'restart') {
                clearSave();
                location.reload();
                return;
            }
            
            if (!commands[verb]) {
                addToOutput(`I don't understand "${verb}".`);
                return;
            }
            
            const action = commands[verb];
            
            switch(action) {
                case 'north':
                case 'south':
                case 'east':
                case 'west':
                    movePlayer(action);
                    break;
                case 'look':
                    lookAround();
                    break;
                case 'inventory':
                    showInventory();
                    break;
                case 'take':
                    takeItem(object);
                    break;
                case 'drop':
                    dropItem(object);
                    break;
                case 'examine':
                    examineObject(object);
                    break;
                case 'use':
                    useItem(object);
                    break;
                case 'equip':
                    equipItem(object);
                    break;
                case 'unequip':
                    unequipItem(object);
                    break;
                case 'open':
                    openObject(object);
                    break;
                case 'read':
                    readObject(object);
                    break;
                case 'talk':
                    talkTo(object);
                    break;
                case 'give':
                    giveItem(object);
                    break;
                case 'attack':
                    if (combatActive) {
                        playerAttack();
                    } else {
                        attackEnemy(object);
                    }
                    break;
                case 'cast':
                    castSpell(object);
                    break;
                case 'save':
                    saveGame();
                    addToOutput("Game saved successfully!", "victory");
                    break;
                case 'load':
                    if (loadGame()) {
                        addToOutput("Game loaded successfully!", "victory");
                        updateStatus();
                        showLocation();
                    } else {
                        addToOutput("No saved game found.", "hint");
                    }
                    break;
                case 'help':
                    showHelp();
                    break;
                case 'quit':
                    quitGame();
                    break;
                default:
                    addToOutput(`Command "${verb}" not implemented yet.`);
            }
        }

        // Move player
        function movePlayer(direction) {
            if (combatActive) {
                addToOutput("You can't run from combat! You must FIGHT!", "combat");
                return;
            }
            
            const currentLoc = locations[gameState.currentLocation];
            const newLocation = currentLoc.exits[direction];
            
            if (!newLocation) {
                addToOutput(`You can't go ${direction}.`);
                return;
            }
            
            // Check if guard blocks the way from dungeon cell
            if (gameState.currentLocation === "dungeonCell" && direction === 'north') {
                if (!gameState.guardRoom.guardDefeated) {
                    addToOutput("You attempt to go north through the cell door...");
                    addToOutput("A CORRUPTED CASTLE GUARD blocks your path!", "enemy");
                    addToOutput("You must defeat him first!");
                    // Start combat with the guard
                    gameState.currentLocation = "guardRoom";
                    showLocation();
                    return;
                }
            }
            
            // Check for other blocked paths
            if (gameState.currentLocation === "guardRoom" && direction === 'east' && !gameState.guardRoom.guardDefeated) {
                addToOutput("The corrupted guard blocks your way to the east!");
                addToOutput("You must defeat him first!");
                return;
            }
            
            // Check for secret passage access
            if (gameState.currentLocation === "library" && direction === 'north') {
                if (!gameState.library.fireplaceExamined) {
                    addToOutput("You see only a solid wall to the north.");
                    return;
                }
            }
            
            gameState.currentLocation = newLocation;
            addToOutput(`You go ${direction}.`);
            showLocation();
        }

        // Look around
        function lookAround() {
            const loc = locations[gameState.currentLocation];
            
            addToOutput(loc.name, "location");
            
            const description = loc.description();
            addToOutput(description);
            
            const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
            if (exits.length > 0) {
                addToOutput("Exits: " + exits.map(exit => exit.toUpperCase()).join(", "));
            }
        }

        // Show inventory
        function showInventory() {
            if (player.inventory.length === 0) {
                addToOutput("You are carrying nothing.");
            } else {
                addToOutput("You are carrying: " + player.inventory.map(item => item.toUpperCase()).join(", "));
            }
            
            // Show equipped items
            addToOutput(`Equipped weapon: ${player.weapon.name} (${player.weapon.minDamage}-${player.weapon.maxDamage} damage)`, "player");
            
            // Show spells
            if (player.spells.length > 0) {
                addToOutput("Known spells: " + player.spells.map(spell => spell.toUpperCase()).join(", "), "magic");
                addToOutput("Use CAST [spell name] to cast a spell.");
            }
            
            addToOutput(`HP: ${player.currentHP}/${player.maxHP} | MP: ${player.currentMP}/${player.maxMP}`, "health");
            addToOutput(`Gold: ${player.gold}`, "gold");
        }

        // Take item
        function takeItem(itemName) {
            if (!itemName) {
                addToOutput("Take what?");
                return;
            }
            
            const loc = locations[gameState.currentLocation];
            const itemIndex = loc.items.findIndex(item => item.toLowerCase().includes(itemName.toLowerCase()));
            
            if (itemIndex === -1) {
                addToOutput(`I don't see a ${itemName} here.`);
                return;
            }
            
            const item = loc.items[itemIndex];
            
            // Handle specific items
            if (item === "rusty sword") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.guardRoom.swordTaken = true;
                addToOutput(`You take the rusty sword!`);
                addToOutput("You can EQUIP RUSTY SWORD to use it as a weapon.", "hint");
            } else if (item === "iron key") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.dungeonCell.keyTaken = true;
                addToOutput(`You take the iron key!`);
                addToOutput("This might unlock something.", "hint");
            } else if (item === "silver key") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.guardRoom.silverKeyTaken = true;
                addToOutput(`You take the delicate silver key!`, "victory");
                addToOutput("It feels warm to the touch.", "hint");
            } else if (item === "health potion") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.dungeonCell.potionTaken = true;
                addToOutput(`You take the health potion!`);
                addToOutput("Use HEALTH POTION to restore 20 HP.", "hint");
            } else if (item === "ancient scroll") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.library.scrollTaken = true;
                addToOutput(`You take the ancient scroll!`, "magic");
                addToOutput("READ SCROLL to learn its contents.", "hint");
            } else if (item === "shadow essence") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                addToOutput(`You take the shadow essence!`, "item");
                addToOutput("It shimmers with dark energy.", "hint");
            } else if (item === "alchemy ingredients") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.alchemyLab.ingredientsTaken = true;
                addToOutput(`You take the alchemy ingredients!`, "item");
                addToOutput("An alchemist might be able to use these.", "hint");
            } else if (item === "royal crown") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.throneRoom.crownTaken = true;
                addToOutput(`You take the royal crown!`, "gold");
                addToOutput("It must be worth a fortune!", "hint");
            } else if (item === "iron chains") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.tortureChamber.chainsTaken = true;
                addToOutput(`You take the iron chains!`);
                addToOutput("These might have uses.", "hint");
            } else if (item === "plate armor") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.barracks.bedsSearched = true;
                addToOutput(`You take the plate armor!`, "item");
                addToOutput("This could provide protection.", "hint");
            } else if (item === "enchanted sword") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.armory.weaponsTaken = true;
                addToOutput(`You take the enchanted sword!`, "magic");
                addToOutput("It hums with magical energy!", "hint");
            } else if (item === "elixir of life") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.catacombs.coffinOpened = true;
                addToOutput(`You take the elixir of life!`, "health");
                addToOutput("This legendary potion can increase your maximum HP!", "hint");
            } else if (item === "star chart") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.observatory.starChartRead = true;
                addToOutput(`You take the star chart!`, "item");
                addToOutput("It shows constellations you've never seen before.", "hint");
            } else if (item === "crystal ball") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                addToOutput(`You take the crystal ball!`, "magic");
                addToOutput("It shows vague images when you peer into it.", "hint");
            } else if (item === "golden key") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.secretPassage.chestOpened = true;
                addToOutput(`You take the golden key!`, "gold");
                addToOutput("This must open something very important.", "hint");
            } else if (item === "enchanted amulet") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                addToOutput(`You take the enchanted amulet!`, "magic");
                addToOutput("It increases your magical power when worn.", "hint");
            } else {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                addToOutput(`You take the ${item}.`);
            }
            
            updateStatus();
        }

        // Drop item
        function dropItem(itemName) {
            if (!itemName) {
                addToOutput("Drop what?");
                return;
            }
            
            const itemIndex = player.inventory.findIndex(item => item.toLowerCase().includes(itemName.toLowerCase()));
            
            if (itemIndex === -1) {
                addToOutput(`You're not carrying a ${itemName}.`);
                return;
            }
            
            const item = player.inventory[itemIndex];
            
            // Check if it's equipped
            if (player.weapon.name.toLowerCase() === item.toLowerCase()) {
                addToOutput("You must unequip the item first!");
                return;
            }
            
            player.inventory.splice(itemIndex, 1);
            locations[gameState.currentLocation].items.push(item);
            
            // Update game state
            if (item === "iron key") gameState.dungeonCell.keyTaken = false;
            if (item === "health potion") gameState.dungeonCell.potionTaken = false;
            if (item === "rusty sword") gameState.guardRoom.swordTaken = false;
            if (item === "silver key") gameState.guardRoom.silverKeyTaken = false;
            if (item === "ancient scroll") gameState.library.scrollTaken = false;
            if (item === "alchemy ingredients") gameState.alchemyLab.ingredientsTaken = false;
            if (item === "royal crown") gameState.throneRoom.crownTaken = false;
            if (item === "iron chains") gameState.tortureChamber.chainsTaken = false;
            if (item === "plate armor") gameState.barracks.bedsSearched = false;
            if (item === "enchanted sword") gameState.armory.weaponsTaken = false;
            if (item === "elixir of life") gameState.catacombs.coffinOpened = false;
            if (item === "star chart") gameState.observatory.starChartRead = false;
            if (item === "golden key") gameState.secretPassage.chestOpened = false;
            if (item === "enchanted amulet") gameState.grandHall.golemDefeated = false;
            
            addToOutput(`You drop the ${item}.`);
            updateStatus();
        }

        // Examine object - UPDATED FOR NEW ROOMS
        function examineObject(objectName) {
            if (!objectName) {
                addToOutput("Examine what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            const loc = locations[gameState.currentLocation];
            
            // Check inventory
            const inventoryItem = player.inventory.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (inventoryItem) {
                if (objectDescriptions[inventoryItem]) {
                    addToOutput(objectDescriptions[inventoryItem]);
                } else {
                    addToOutput(`You examine the ${inventoryItem}. It's in your inventory.`);
                }
                return;
            }
            
            // Check location items
            const locationItem = loc.items.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (locationItem) {
                if (objectDescriptions[locationItem]) {
                    addToOutput(objectDescriptions[locationItem]);
                } else {
                    addToOutput(`You examine the ${locationItem}.`);
                }
                return;
            }
            
            // DUNGEON CELL EXAMINATIONS
            if (gameState.currentLocation === "dungeonCell") {
                if (objectLower.includes("bed") || objectLower.includes("straw")) {
                    gameState.dungeonCell.bedExamined = true;
                    if (!gameState.dungeonCell.keyTaken && !loc.items.includes('iron key')) {
                        addToOutput("You search through the musty straw bed. Underneath, you find an IRON KEY!");
                        loc.items.push('iron key');
                    } else {
                        addToOutput("The straw bed is old and uncomfortable. Nothing else of interest here.");
                    }
                    return;
                }
                
                if (objectLower.includes("barrel")) {
                    addToOutput("The rusty barrel is empty, but you notice something odd about the wall behind it.");
                    addToOutput("There appears to be a LOOSE BRICK in the wall.");
                    return;
                }
                
                if (objectLower.includes("brick") || objectLower.includes("loose")) {
                    gameState.dungeonCell.brickExamined = true;
                    if (!gameState.dungeonCell.potionTaken && !loc.items.includes('health potion')) {
                        addToOutput("You pry the loose brick from the wall. Behind it, you find a HEALTH POTION!");
                        loc.items.push('health potion');
                        gameState.dungeonCell.looseBrickFound = true;
                    } else {
                        addToOutput("You've already removed the loose brick.");
                    }
                    return;
                }
            }
            
            // GUARD ROOM EXAMINATIONS
            if (gameState.currentLocation === "guardRoom") {
                if (objectLower.includes("portrait") || objectLower.includes("painting")) {
                    gameState.guardRoom.portraitExamined = true;
                    addToOutput("The portrait shows a noble lord in fine clothing. The eyes seem to follow you.");
                    
                    if (!gameState.guardRoom.secretFound) {
                        addToOutput("Upon closer inspection, you notice the portrait has a small hidden compartment!");
                        gameState.guardRoom.secretFound = true;
                        
                        if (!gameState.guardRoom.silverKeyTaken && !loc.items.includes('silver key')) {
                            addToOutput("Inside the compartment, you find a SILVER KEY!", "victory");
                            loc.items.push('silver key');
                        }
                    } else {
                        addToOutput("You've already discovered the portrait's secret.");
                    }
                    return;
                }
                
                if (objectLower.includes("table") || objectLower.includes("chair")) {
                    addToOutput(objectDescriptions[objectLower.includes("table") ? "table" : "chair"]);
                    if (gameState.guardRoom.guardDefeated) {
                        addToOutput("There are some papers scattered on the table, but they're all blank.");
                    }
                    return;
                }
            }
            
            // LIBRARY EXAMINATIONS
            if (gameState.currentLocation === "library") {
                if (objectLower.includes("bookshelf") || objectLower.includes("bookshelves") || objectLower.includes("shelf")) {
                    addToOutput("The bookshelves are filled with ancient tomes on magic, history, and dark arts.");
                    addToOutput("Most are too damaged to read, but one DUSTY TOME looks intact.");
                    return;
                }
                
                if (objectLower.includes("fireplace")) {
                    gameState.library.fireplaceExamined = true;
                    addToOutput("The large stone fireplace is filled with cold ashes from long-dead fires.");
                    
                    if (!loc.items.includes('silver key') && player.inventory.includes('silver key')) {
                        addToOutput("As you examine the ashes, you notice the silver key in your pocket begins to glow!");
                        addToOutput("Perhaps the key has something to do with this fireplace...", "hint");
                    } else if (!loc.items.includes('silver key') && !player.inventory.includes('silver key')) {
                        addToOutput("There's a strange keyhole hidden in the back of the fireplace.");
                    }
                    return;
                }
                
                if (objectLower.includes("tome")) {
                    gameState.library.tomeExamined = true;
                    addToOutput("The dusty tome is titled 'Healing Arts of the Ancient Mages'.");
                    addToOutput("Reading it might teach you something useful.", "hint");
                    addToOutput("You could READ TOME to learn from it.");
                    return;
                }
                
                if (objectLower.includes("librarian")) {
                    addToOutput("An elderly librarian with spectacles perched on his nose. He seems absorbed in his work.");
                    addToOutput("You could TALK LIBRARIAN to speak with him.");
                    return;
                }
            }
            
            // SECRET PASSAGE EXAMINATIONS
            if (gameState.currentLocation === "secretPassage") {
                if (objectLower.includes("chest")) {
                    addToOutput("An old wooden chest reinforced with iron bands. It's locked.");
                    
                    if (player.inventory.includes("golden key")) {
                        addToOutput("You use the golden key to unlock the chest!");
                        if (!loc.items.includes('enchanted amulet')) {
                            loc.items.push('enchanted amulet');
                            addToOutput("Inside, you find an ENCHANTED AMULET!", "magic");
                        }
                    } else {
                        addToOutput("You need a key to open it.");
                    }
                    return;
                }
                
                if (objectLower.includes("wall") || objectLower.includes("moss")) {
                    addToOutput("The walls are covered in damp moss. Some of the stones have strange carvings.");
                    return;
                }
            }
            
            // ALCHEMY LAB EXAMINATIONS
            if (gameState.currentLocation === "alchemyLab") {
                if (objectLower.includes("alchemy") || objectLower.includes("table") || objectLower.includes("cauldron")) {
                    addToOutput("The alchemy table is covered in complex apparatus. Various potions bubble in the cauldrons.");
                    
                    if (player.inventory.includes("shadow essence")) {
                        addToOutput("The alchemist notices your shadow essence and looks interested.");
                    }
                    return;
                }
                
                if (objectLower.includes("alchemist")) {
                    addToOutput("A middle-aged man in stained robes, carefully measuring powders.");
                    addToOutput("You could TALK ALCHEMIST to speak with him.");
                    return;
                }
            }
            
            // GRAND HALL EXAMINATIONS
            if (gameState.currentLocation === "grandHall") {
                if (objectLower.includes("chandelier") || objectLower.includes("crystal")) {
                    gameState.grandHall.chandelierExamined = true;
                    addToOutput("The massive crystal chandelier hangs from a chain 50 feet above.");
                    addToOutput("One of the crystals seems to be glowing faintly.");
                    return;
                }
                
                if (objectLower.includes("pillar") || objectLower.includes("marble")) {
                    addToOutput("The marble pillars are carved with scenes of ancient battles.");
                    return;
                }
            }
            
            // THRONE ROOM EXAMINATIONS
            if (gameState.currentLocation === "throneRoom") {
                if (objectLower.includes("throne")) {
                    gameState.throneRoom.throneExamined = true;
                    addToOutput("The obsidian throne is carved with scenes of conquest and magic.");
                    
                    if (!gameState.throneRoom.kingDefeated) {
                        addToOutput("The cursed wizard sits upon it, channeling dark energy.");
                    } else if (!loc.items.includes('royal crown')) {
                        addToOutput("A magnificent ROYAL CROWN rests on the throne.", "gold");
                        loc.items.push('royal crown');
                    }
                    return;
                }
                
                if (objectLower.includes("banner")) {
                    addToOutput("The tattered banners show the crest of the castle's former rulers.");
                    return;
                }
            }
            
            // BARRACKS EXAMINATIONS
            if (gameState.currentLocation === "barracks") {
                if (objectLower.includes("bed")) {
                    if (!gameState.barracks.bedsSearched && !loc.items.includes('plate armor')) {
                        addToOutput("You search under the beds and find a set of PLATE ARMOR!", "item");
                        loc.items.push('plate armor');
                        gameState.barracks.bedsSearched = true;
                    } else {
                        addToOutput("Simple military cots, all empty now.");
                    }
                    return;
                }
                
                if (objectLower.includes("dummy") || objectLower.includes("training")) {
                    gameState.barracks.trainingDummyUsed = true;
                    addToOutput("A straw dummy used for weapons practice. You could USE DUMMY to train.");
                    return;
                }
                
                if (objectLower.includes("rack") || objectLower.includes("weapon")) {
                    addToOutput("The weapons rack holds practice swords and shields, all rusted.");
                    return;
                }
            }
            
            // TORTURE CHAMBER EXAMINATIONS
            if (gameState.currentLocation === "tortureChamber") {
                if (objectLower.includes("rack") || objectLower.includes("torture")) {
                    gameState.tortureChamber.rackExamined = true;
                    addToOutput("A horrific device for stretching prisoners until their joints dislocate.");
                    return;
                }
                
                if (objectLower.includes("prisoner")) {
                    addToOutput("A barely conscious man chained to the wall. He murmurs about 'the experiment'.");
                    addToOutput("You could TALK PRISONER to try to communicate with him.");
                    return;
                }
            }
            
            // ARMORY EXAMINATIONS
            if (gameState.currentLocation === "armory") {
                if (objectLower.includes("rack") || objectLower.includes("weapon")) {
                    if (!gameState.armory.weaponsTaken && !loc.items.includes('enchanted sword')) {
                        addToOutput("Among the rusted weapons, one ENCHANTED SWORD glows with blue energy!", "magic");
                        loc.items.push('enchanted sword');
                    } else {
                        addToOutput("Racks of weapons, most ruined by time.");
                    }
                    return;
                }
                
                if (objectLower.includes("armor") || objectLower.includes("stand")) {
                    addToOutput("Armor stands hold empty suits of plate mail.");
                    return;
                }
            }
            
            // CATACOMBS EXAMINATIONS
            if (gameState.currentLocation === "catacombs") {
                if (objectLower.includes("coffin")) {
                    if (!gameState.catacombs.coffinOpened && !loc.items.includes('elixir of life')) {
                        addToOutput("An ornate coffin different from the others. It's sealed shut.");
                        addToOutput("You could try to OPEN COFFIN.");
                    } else {
                        addToOutput("You've already opened this coffin.");
                    }
                    return;
                }
                
                if (objectLower.includes("altar")) {
                    gameState.catacombs.altarUsed = true;
                    addToOutput("A stone altar with strange blood-red markings. It feels... hungry.");
                    return;
                }
            }
            
            // OBSERVATORY EXAMINATIONS
            if (gameState.currentLocation === "observatory") {
                if (objectLower.includes("telescope")) {
                    gameState.observatory.telescopeUsed = true;
                    addToOutput("A massive brass telescope pointed at strange, unfamiliar stars.");
                    addToOutput("You could USE TELESCOPE to look through it.");
                    return;
                }
                
                if (objectLower.includes("crystal") || objectLower.includes("ball")) {
                    addToOutput("A crystal ball that shows swirling mists. You could READ CRYSTAL BALL.");
                    return;
                }
            }
            
            // WIZARD TOWER EXAMINATIONS
            if (gameState.currentLocation === "wizardTower") {
                if (objectLower.includes("cauldron")) {
                    addToOutput("A bubbling cauldron filled with glowing green liquid. It smells terrible.");
                    return;
                }
                
                if (objectLower.includes("artifact") || objectLower.includes("device")) {
                    addToOutput("Strange magical devices whose purposes are unclear.");
                    return;
                }
            }
            
            // Check general object descriptions
            if (objectDescriptions[objectLower]) {
                addToOutput(objectDescriptions[objectLower]);
                return;
            }
            
            // Partial matches
            for (const [objKey, description] of Object.entries(objectDescriptions)) {
                if (objKey.includes(objectLower) || objectLower.includes(objKey)) {
                    addToOutput(description);
                    return;
                }
            }
            
            // Direction check
            if (['north', 'south', 'east', 'west'].includes(objectLower)) {
                const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
                if (exits.includes(objectLower)) {
                    addToOutput(`You look ${objectLower}. You can go that way.`);
                } else {
                    addToOutput(`You look ${objectLower}. You cannot go that way.`);
                }
                return;
            }
            
            addToOutput(`You don't see a ${objectName} here.`);
        }

        // Use item - UPDATED FOR NEW ROOMS
        function useItem(objectName) {
            if (!objectName) {
                addToOutput("Use what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Check if using health potion
            if (objectLower.includes("health potion") && player.inventory.includes("health potion")) {
                const potionIndex = player.inventory.indexOf("health potion");
                player.inventory.splice(potionIndex, 1);
                
                const healAmount = 20;
                player.currentHP = Math.min(player.maxHP, player.currentHP + healAmount);
                addToOutput(`You drink the health potion. It restores ${healAmount} HP!`, "health");
                updateStatus();
                return;
            }
            
            // Check if using torch
            if (objectLower.includes("torch") && player.inventory.includes("torch")) {
                addToOutput("You light the torch. It provides a warm, flickering light.");
                addToOutput("The light might help you see hidden things.", "hint");
                return;
            }
            
            // Check if using shadow essence
            if (objectLower.includes("shadow essence") && player.inventory.includes("shadow essence")) {
                addToOutput("You examine the shadow essence. It swirls with dark energy.");
                addToOutput("You're not sure how to use this yet. Perhaps an alchemist could help.", "hint");
                return;
            }
            
            // Check if using silver key on fireplace
            if ((objectLower.includes("silver key") || objectLower.includes("key")) && 
                gameState.currentLocation === "library") {
                
                if (!player.inventory.includes("silver key")) {
                    addToOutput("You don't have a silver key.");
                    return;
                }
                
                if (gameState.library.fireplaceExamined) {
                    addToOutput("You insert the silver key into a hidden keyhole in the fireplace.", "player");
                    addToOutput("The fireplace slides aside, revealing a secret passage!", "victory");
                    addToOutput("A new exit to the NORTH has been revealed!");
                    locations.library.exits.north = "secretPassage";
                    updateStatus();
                } else {
                    addToOutput("You're not sure where to use the key here.");
                }
                return;
            }
            
            // Check if using golden key on chest
            if ((objectLower.includes("golden key") || objectLower.includes("key")) && 
                gameState.currentLocation === "secretPassage" &&
                objectLower.includes("chest")) {
                
                if (!player.inventory.includes("golden key")) {
                    addToOutput("You don't have the right key.");
                    return;
                }
                
                addToOutput("You use the golden key to unlock the chest!", "player");
                if (!locations.secretPassage.items.includes('enchanted amulet')) {
                    locations.secretPassage.items.push('enchanted amulet');
                    addToOutput("Inside, you find an ENCHANTED AMULET!", "magic");
                }
                return;
            }
            
            // Check if using elixir of life
            if (objectLower.includes("elixir") && player.inventory.includes("elixir of life")) {
                const elixirIndex = player.inventory.indexOf("elixir of life");
                player.inventory.splice(elixirIndex, 1);
                
                player.maxHP += 25;
                player.currentHP = player.maxHP;
                addToOutput("You drink the elixir of life! Your body surges with vitality!", "health");
                addToOutput(`Your maximum HP increases by 25! (Now: ${player.maxHP})`, "victory");
                updateStatus();
                return;
            }
            
            // Check if using training dummy
            if (objectLower.includes("dummy") && gameState.currentLocation === "barracks") {
                if (gameState.barracks.trainingDummyUsed) {
                    addToOutput("You practice with the training dummy. Your combat skills feel sharper.");
                    // Small chance to increase damage
                    if (Math.random() < 0.3) {
                        player.weapon.minDamage += 1;
                        player.weapon.maxDamage += 1;
                        addToOutput("You feel your attacks have become more effective!", "player");
                    }
                }
                return;
            }
            
            // Check if using telescope
            if (objectLower.includes("telescope") && gameState.currentLocation === "observatory") {
                if (gameState.observatory.telescopeUsed) {
                    addToOutput("You look through the telescope. The stars are arranged in strange patterns.");
                    addToOutput("You notice they match the star chart you found!", "hint");
                    
                    if (player.inventory.includes("star chart")) {
                        addToOutput("Studying the stars through the telescope while referencing the chart...");
                        addToOutput("You learn the FIREBALL spell from the celestial patterns!", "magic");
                        if (!player.spells.includes("fireball")) {
                            player.spells.push("fireball");
                        }
                    }
                }
                return;
            }
            
            // Check if using enchanted amulet
            if (objectLower.includes("amulet") && player.inventory.includes("enchanted amulet")) {
                addToOutput("You wear the enchanted amulet. It hums with magical power.");
                player.maxMP += 10;
                player.currentMP = Math.min(player.maxMP, player.currentMP + 10);
                addToOutput(`Your maximum MP increases by 10! (Now: ${player.maxMP})`, "magic");
                updateStatus();
                
                // Remove from inventory since it's "worn"
                const amuletIndex = player.inventory.indexOf("enchanted amulet");
                player.inventory.splice(amuletIndex, 1);
                player.equippedItems.accessory = "enchanted amulet";
                return;
            }
            
            // Check if using potion of invisibility
            if (objectLower.includes("invisibility") && player.inventory.includes("potion of invisibility")) {
                const potionIndex = player.inventory.indexOf("potion of invisibility");
                player.inventory.splice(potionIndex, 1);
                addToOutput("You drink the potion of invisibility and become transparent!", "magic");
                addToOutput("You can now sneak past enemies undetected for a short time.", "hint");
                return;
            }
            
            addToOutput(`You're not sure how to use the ${objectName} here.`);
        }

        // Equip item - UPDATED
        function equipItem(itemName) {
            if (!itemName) {
                addToOutput("Equip what?");
                return;
            }
            
            const objectLower = itemName.toLowerCase();
            
            // Check if it's in inventory
            const inventoryItem = player.inventory.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (!inventoryItem) {
                addToOutput(`You don't have a ${itemName}.`);
                return;
            }
            
            // Handle weapons
            if (inventoryItem === "rusty sword") {
                player.weapon = {
                    name: "Rusty Sword",
                    minDamage: 6,
                    maxDamage: 9,
                    type: "melee"
                };
                player.equippedItems.weapon = "Rusty Sword";
                addToOutput(`You equip the rusty sword! (Damage: 6-9)`, "player");
                updateStatus();
                return;
            }
            
            if (inventoryItem === "fists") {
                player.weapon = {
                    name: "Fists",
                    minDamage: 4,
                    maxDamage: 6,
                    type: "melee"
                };
                player.equippedItems.weapon = "Fists";
                addToOutput(`You equip your fists! (Damage: 4-6)`, "player");
                updateStatus();
                return;
            }
            
            if (inventoryItem === "enchanted sword") {
                player.weapon = {
                    name: "Enchanted Sword",
                    minDamage: 10,
                    maxDamage: 15,
                    type: "melee"
                };
                player.equippedItems.weapon = "Enchanted Sword";
                addToOutput(`You equip the enchanted sword! (Damage: 10-15)`, "magic");
                updateStatus();
                return;
            }
            
            if (inventoryItem === "wizard's staff") {
                player.weapon = {
                    name: "Wizard's Staff",
                    minDamage: 8,
                    maxDamage: 12,
                    type: "magic"
                };
                player.equippedItems.weapon = "Wizard's Staff";
                player.maxMP += 5;
                player.currentMP = Math.min(player.maxMP, player.currentMP + 5);
                addToOutput(`You equip the wizard's staff! (Damage: 8-12, +5 MP)`, "magic");
                updateStatus();
                return;
            }
            
            if (inventoryItem === "plate armor") {
                player.equippedItems.armor = "plate armor";
                addToOutput(`You equip the plate armor! (Reduces damage taken)`, "player");
                
                // Remove from inventory since it's "worn"
                const armorIndex = player.inventory.indexOf("plate armor");
                player.inventory.splice(armorIndex, 1);
                return;
            }
            
            addToOutput(`You can't equip the ${inventoryItem}.`);
        }

        // Unequip item
        function unequipItem(itemName) {
            if (!itemName) {
                addToOutput("Unequip what?");
                return;
            }
            
            const objectLower = itemName.toLowerCase();
            
            // Check if it's equipped as weapon
            if (player.weapon.name.toLowerCase().includes(objectLower)) {
                // Check if we have fists in inventory (we always do)
                player.weapon = {
                    name: "Fists",
                    minDamage: 4,
                    maxDamage: 6,
                    type: "melee"
                };
                player.equippedItems.weapon = "Fists";
                addToOutput(`You unequip your weapon and use your fists.`, "player");
                updateStatus();
                return;
            }
            
            // Check if it's equipped as armor
            if (player.equippedItems.armor && player.equippedItems.armor.toLowerCase().includes(objectLower)) {
                player.inventory.push(player.equippedItems.armor);
                player.equippedItems.armor = null;
                addToOutput(`You remove the plate armor.`, "player");
                return;
            }
            
            addToOutput(`You don't have ${itemName} equipped.`);
        }

        // Open object
        function openObject(objectName) {
            if (!objectName) {
                addToOutput("Open what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            if (objectLower.includes("door")) {
                const loc = locations[gameState.currentLocation];
                const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
                
                if (exits.length > 0) {
                    addToOutput("The door is already open.");
                } else {
                    addToOutput("There's no door to open here.");
                }
                return;
            }
            
            if (objectLower.includes("coffin") && gameState.currentLocation === "catacombs") {
                if (!gameState.catacombs.coffinOpened && !locations.catacombs.items.includes('elixir of life')) {
                    addToOutput("You force open the ornate coffin.");
                    addToOutput("Inside, you find an ELIXIR OF LIFE!", "health");
                    locations.catacombs.items.push('elixir of life');
                    gameState.catacombs.coffinOpened = true;
                } else {
                    addToOutput("The coffin is already open.");
                }
                return;
            }
            
            if (objectLower.includes("chest") && gameState.currentLocation === "secretPassage") {
                if (!player.inventory.includes("golden key")) {
                    addToOutput("The chest is locked. You need a key.");
                } else {
                    addToOutput("Use the golden key with the chest.");
                }
                return;
            }
            
            addToOutput(`You can't open the ${objectName}.`);
        }

        // Read object - UPDATED
        function readObject(objectName) {
            if (!objectName) {
                addToOutput("Read what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Read spellbook
            if ((objectLower.includes("spellbook") || objectLower.includes("spell book")) && 
                player.inventory.includes("leather bound spellbook")) {
                
                addToOutput("You open your spellbook:", "magic");
                addToOutput(" ");
                
                if (player.spells.length === 0) {
                    addToOutput("The spellbook is empty.", "magic");
                } else {
                    player.spells.forEach(spellName => {
                        const spell = spells[spellName];
                        if (spell) {
                            addToOutput(`${spell.name.toUpperCase()}: ${spell.description}`, "magic");
                            addToOutput(`  MP Cost: ${spell.cost}`, "magic");
                        }
                    });
                }
                
                addToOutput(" ");
                addToOutput("Use CAST [spell name] to cast a spell.", "hint");
                return;
            }
            
            // Read scroll
            if (objectLower.includes("scroll")) {
                const hasAncientScroll = player.inventory.includes("ancient scroll");
                const hasScroll = player.inventory.some(item => item.toLowerCase().includes("scroll"));
                
                if (hasAncientScroll) {
                    if (!gameState.library.healSpellLearned) {
                        gameState.library.healSpellLearned = true;
                        
                        if (!player.spells.includes("heal")) {
                            player.spells.push("heal");
                            addToOutput("You read the ancient scroll...", "magic");
                            addToOutput("It contains instructions for a healing spell!", "magic");
                            addToOutput("You have learned the HEAL spell!", "victory");
                            addToOutput("Use CAST HEAL to restore your health.", "hint");
                            
                            const scrollIndex = player.inventory.indexOf("ancient scroll");
                            player.inventory.splice(scrollIndex, 1);
                        }
                    } else {
                        addToOutput("You've already learned from this scroll.");
                    }
                } else if (hasScroll) {
                    const scrollItem = player.inventory.find(item => item.toLowerCase().includes("scroll"));
                    addToOutput(`You read the ${scrollItem}, but it's written in a language you don't understand.`);
                } else {
                    addToOutput("You don't have a scroll to read.");
                }
                return;
            }
            
            // Read tome
            if (objectLower.includes("tome") && gameState.currentLocation === "library") {
                if (gameState.library.tomeExamined) {
                    addToOutput("You spend some time studying the dusty tome...");
                    addToOutput("It contains advanced magical theory, but nothing practical you can use right now.");
                    addToOutput("However, you feel your magical knowledge has increased slightly.", "magic");
                    
                    player.maxMP += 2;
                    player.currentMP = Math.min(player.maxMP, player.currentMP + 2);
                    addToOutput(`Your maximum MP has increased by 2! (Now: ${player.maxMP})`, "magic");
                    updateStatus();
                } else {
                    addToOutput("You need to examine the tome first.");
                }
                return;
            }
            
            // Read star chart
            if (objectLower.includes("star") || objectLower.includes("chart")) {
                if (player.inventory.includes("star chart")) {
                    addToOutput("You study the star chart. It shows unfamiliar constellations.");
                    addToOutput("The patterns seem magical in nature...", "magic");
                    
                    if (gameState.observatory.telescopeUsed) {
                        addToOutput("Combined with what you saw through the telescope, you begin to understand...");
                        addToOutput("You learn the FREEZE spell from the celestial patterns!", "magic");
                        if (!player.spells.includes("freeze")) {
                            player.spells.push("freeze");
                        }
                    }
                } else {
                    addToOutput("You don't have a star chart to read.");
                }
                return;
            }
            
            // Read crystal ball
            if ((objectLower.includes("crystal") || objectLower.includes("ball")) && 
                player.inventory.includes("crystal ball")) {
                
                addToOutput("You peer into the crystal ball...");
                
                const visions = [
                    "You see a vision of a massive dragon sleeping deep beneath the castle.",
                    "The mists show a knight in shining armor falling to dark magic.",
                    "You see yourself standing victorious over a defeated enemy.",
                    "The vision shows a hidden treasure room filled with gold.",
                    "You see the castle crumbling as dark energy escapes."
                ];
                
                const vision = visions[Math.floor(Math.random() * visions.length)];
                addToOutput(vision, "magic");
                return;
            }
            
            addToOutput(`There's nothing to read on the ${objectName}.`);
        }

        // Cast spell - UPDATED
        function castSpell(spellName) {
            if (!spellName) {
                addToOutput("Cast what spell?");
                return;
            }
            
            const spellLower = spellName.toLowerCase();
            
            // Find the spell
            let spellToCast = null;
            let spellKey = null;
            
            for (const [key, spell] of Object.entries(spells)) {
                if (spell.name.toLowerCase().includes(spellLower) || spellLower.includes(key)) {
                    spellToCast = spell;
                    spellKey = key;
                    break;
                }
            }
            
            if (!spellToCast) {
                // Check if player knows a spell with similar name
                const knownSpell = player.spells.find(s => 
                    s.toLowerCase().includes(spellLower) || spellLower.includes(s.toLowerCase())
                );
                
                if (knownSpell) {
                    spellToCast = spells[knownSpell];
                    spellKey = knownSpell;
                }
            }
            
            if (!spellToCast) {
                addToOutput(`You don't know the spell '${spellName}'.`, "magic");
                return;
            }
            
            // Check if player has enough MP
            if (player.currentMP < spellToCast.cost) {
                addToOutput(`Not enough MP! You need ${spellToCast.cost} MP to cast ${spellToCast.name}.`, "magic");
                return;
            }
            
            // Deduct MP and cast spell
            player.currentMP -= spellToCast.cost;
            addToOutput(`You cast ${spellToCast.name}! (${spellToCast.cost} MP used)`, "magic");
            
            // Execute spell effect
            const success = spellToCast.effect();
            
            if (success) {
                updateStatus();
            }
        }

        // Talk to NPC - UPDATED
        function talkTo(objectName) {
            if (!objectName) {
                addToOutput("Talk to who?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Talking to librarian in library
            if ((objectLower.includes("librarian")) && gameState.currentLocation === "library") {
                
                if (!gameState.library.librarianTalked) {
                    addToOutput("You approach the elderly librarian.", "npc");
                    addToOutput("Librarian: 'Ah, a visitor! Rare to see new faces in these cursed halls.'", "npc");
                    addToOutput("Librarian: 'Be careful, the castle is not what it seems. Time flows strangely here.'", "npc");
                    addToOutput("Librarian: 'If you find any magical artifacts, I might be able to tell you about them.'", "npc");
                    gameState.library.librarianTalked = true;
                } else {
                    addToOutput("Librarian: 'Back again? Have you found anything interesting?'", "npc");
                    
                    if (player.inventory.includes("shadow essence")) {
                        addToOutput("You show the shadow essence to the librarian.", "player");
                        addToOutput("Librarian: 'Ah, shadow essence! Rare and dangerous.',", "npc");
                        addToOutput("Librarian: 'It can be used to create powerful darkness magic,", "npc");
                        addToOutput("Librarian: 'but you'll need a proper alchemy lab to refine it.'", "npc");
                    }
                }
                return;
            }
            
            // Talking to alchemist
            if ((objectLower.includes("alchemist")) && gameState.currentLocation === "alchemyLab") {
                
                if (!gameState.alchemyLab.alchemistTalked) {
                    addToOutput("You approach the alchemist.", "npc");
                    addToOutput("Alchemist: 'Hmm? Oh, a survivor. Surprising.'", "npc");
                    addToOutput("Alchemist: 'I'm trying to reverse the castle's curse, but progress is slow.'", "npc");
                    addToOutput("Alchemist: 'If you bring me rare ingredients, I can make useful potions.'", "npc");
                    gameState.alchemyLab.alchemistTalked = true;
                } else {
                    addToOutput("Alchemist: 'Do you have anything interesting for me?'", "npc");
                    
                    if (player.inventory.includes("shadow essence")) {
                        addToOutput("You show the shadow essence to the alchemist.", "player");
                        addToOutput("Alchemist: 'Excellent! Shadow essence!'", "npc");
                        addToOutput("Alchemist: 'I can refine this into a powerful potion for you.'", "npc");
                        addToOutput("Alchemist: 'Give me the shadow essence and I'll make something useful.'", "npc");
                    }
                    
                    if (player.inventory.includes("alchemy ingredients")) {
                        addToOutput("Alchemist: 'Ah, those are basic ingredients. I can make health potions from those.'", "npc");
                        addToOutput("Alchemist: 'GIVE INGREDIENTS TO ALCHEMIST and I'll make you some potions.'", "npc");
                    }
                }
                return;
            }
            
            // Talking to prisoner
            if ((objectLower.includes("prisoner")) && gameState.currentLocation === "tortureChamber") {
                
                if (!gameState.tortureChamber.prisonerFreed) {
                    addToOutput("You approach the chained prisoner.", "npc");
                    addToOutput("Prisoner: 'Please... help me...'", "npc");
                    addToOutput("Prisoner: 'The wizard... he's experimenting in the tower...'", "npc");
                    addToOutput("Prisoner: 'He seeks to become a lich... must be stopped...'", "npc");
                    addToOutput("You could FREE PRISONER if you have a way to break the chains.");
                } else {
                    addToOutput("The prisoner has been freed and has left.");
                }
                return;
            }
            
            if (objectLower.includes("guard") && combatActive) {
                addToOutput("The corrupted guard snarls and attacks! He's beyond reasoning with!", "enemy");
                return;
            }
            
            addToOutput("There's no one here to talk to.");
        }

        // Give item - UPDATED
        function giveItem(objectName) {
            if (!objectName) {
                addToOutput("Give what?");
                return;
            }
            
            const parts = objectName.toLowerCase().split(' to ');
            if (parts.length < 2) {
                addToOutput("Give what to whom?");
                return;
            }
            
            const itemName = parts[0].trim();
            const recipient = parts[1].trim();
            
            // Giving shadow essence to alchemist
            if (recipient.includes("alchemist") && gameState.currentLocation === "alchemyLab") {
                if (!itemName.includes("shadow") && !itemName.includes("essence")) {
                    addToOutput("The alchemist isn't interested in that.");
                    return;
                }
                
                if (!player.inventory.includes("shadow essence")) {
                    addToOutput("You don't have any shadow essence.");
                    return;
                }
                
                // Give shadow essence to alchemist
                const essenceIndex = player.inventory.indexOf("shadow essence");
                player.inventory.splice(essenceIndex, 1);
                
                addToOutput("You give the shadow essence to the alchemist.", "player");
                addToOutput("Alchemist: 'Excellent! Let me work my craft...'", "npc");
                addToOutput("The alchemist works for several minutes, then hands you a vial.", "npc");
                addToOutput("Alchemist: 'Here! A Potion of Invisibility! It will make you unseen for a short time.'", "npc");
                
                player.inventory.push("potion of invisibility");
                addToOutput("You receive a POTION OF INVISIBILITY!", "magic");
                updateStatus();
                return;
            }
            
            // Giving ingredients to alchemist
            if (recipient.includes("alchemist") && gameState.currentLocation === "alchemyLab") {
                if (!itemName.includes("ingredients")) {
                    addToOutput("The alchemist isn't interested in that.");
                    return;
                }
                
                if (!player.inventory.includes("alchemy ingredients")) {
                    addToOutput("You don't have any alchemy ingredients.");
                    return;
                }
                
                // Give ingredients to alchemist
                const ingredientsIndex = player.inventory.indexOf("alchemy ingredients");
                player.inventory.splice(ingredientsIndex, 1);
                
                addToOutput("You give the alchemy ingredients to the alchemist.", "player");
                addToOutput("Alchemist: 'Basic but useful. Here are some health potions.'", "npc");
                
                player.inventory.push("health potion");
                player.inventory.push("health potion");
                addToOutput("You receive 2 HEALTH POTIONS!", "health");
                updateStatus();
                return;
            }
            
            // Giving to librarian (from original)
            if (recipient.includes("librarian") && gameState.currentLocation === "library") {
                if (!itemName.includes("shadow") && !itemName.includes("essence")) {
                    addToOutput("The librarian isn't interested in that.");
                    return;
                }
                
                if (!player.inventory.includes("shadow essence")) {
                    addToOutput("You don't have any shadow essence.");
                    return;
                }
                
                const essenceIndex = player.inventory.indexOf("shadow essence");
                player.inventory.splice(essenceIndex, 1);
                
                addToOutput("You give the shadow essence to the librarian.", "player");
                addToOutput("Librarian: 'Thank you! This is quite valuable.',", "npc");
                addToOutput("Librarian: 'Let me give you something in return.'", "npc");
                addToOutput("The librarian gives you 25 gold and a scroll containing the LIGHT spell!", "victory");
                
                player.gold += 25;
                
                if (!player.spells.includes("light")) {
                    player.spells.push("light");
                    addToOutput("You have learned the LIGHT spell!", "magic");
                }
                
                updateStatus();
                return;
            }
            
            // Freeing prisoner
            if (recipient.includes("prisoner") && gameState.currentLocation === "tortureChamber") {
                if (itemName.includes("free") || itemName.includes("release")) {
                    if (player.inventory.includes("iron chains") || player.inventory.includes("rusty sword")) {
                        addToOutput("You use your equipment to break the prisoner's chains!", "player");
                        addToOutput("Prisoner: 'Thank you! I must leave this cursed place!'", "npc");
                        addToOutput("Prisoner: 'Take this, it's all I have.'", "npc");
                        addToOutput("The prisoner gives you a small pouch before running off.", "npc");
                        
                        player.gold += 50;
                        gameState.tortureChamber.prisonerFreed = true;
                        addToOutput("You receive 50 gold!", "gold");
                        updateStatus();
                    } else {
                        addToOutput("You need something to break the chains with.");
                    }
                    return;
                }
            }
            
            addToOutput("There's no one here to give anything to.");
        }

        // Attack enemy
        function attackEnemy(objectName) {
            if (!objectName) {
                addToOutput("Attack what?");
                return;
            }
            
            if (combatActive) {
                playerAttack();
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // If in dungeon cell and trying to attack guard
            if (gameState.currentLocation === "dungeonCell" && objectLower.includes("guard")) {
                addToOutput("You can't attack the guard from here. You need to go north to face him.");
                return;
            }
            
            // Check for enemy in current room
            const loc = locations[gameState.currentLocation];
            if (loc.enemy && !combatActive) {
                startCombat(loc.enemy);
                return;
            }
            
            addToOutput("There's nothing to attack here.");
        }

        // Show help
        function showHelp() {
            addToOutput("CASTLE OF THE DAMMED 1984 - EXPANDED EDITION - COMMANDS", "location");
            addToOutput("Movement: NORTH, SOUTH, EAST, WEST (or N, S, E, W)");
            addToOutput("Basic: LOOK, EXAMINE [object], TAKE [item], DROP [item], INVENTORY");
            addToOutput("Equipment: EQUIP [weapon/armor], UNEQUIP [item]");
            addToOutput("Interactive: USE [item], OPEN [object], READ [object], TALK [NPC], GIVE [item] TO [NPC]");
            addToOutput("Magic: CAST [spell name] (requires MP) - New spells: FIREBALL, SHIELD, FREEZE", "magic");
            addToOutput("COMBAT: ATTACK (in combat)", "combat");
            addToOutput("Game: SAVE, LOAD, RESTART, HELP, QUIT");
            addToOutput(" ");
            addToOutput("NEW FEATURES:", "victory");
            addToOutput("- 10 new rooms to explore", "victory");
            addToOutput("- Shield system: Cast SHIELD to reduce damage", "magic");
            addToOutput("- Freeze enemies: Cast FREEZE to stun them", "magic");
            addToOutput("- New weapons and armor to discover", "item");
            addToOutput("- Multiple NPCs with quests and trading", "npc");
            addToOutput(" ");
            addToOutput("DISCOVERY TIPS:", "hint");
            addToOutput("- Examine everything carefully for clues and hidden items", "hint");
            addToOutput("- Talk to all NPCs - they have valuable information and items", "hint");
            addToOutput("- Some items can only be used in specific locations", "hint");
            addToOutput("- Save your game often!", "hint");
        }

        // Quit game
        function quitGame() {
            addToOutput("Are you sure you want to quit? Your progress is saved automatically. (Y/N)");
            
            const originalEventHandler = gameInput.onkeypress;
            
            gameInput.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    const answer = this.value.trim().toLowerCase();
                    if (answer === 'y' || answer === 'yes') {
                        addToOutput("Thanks for playing Castle of the Dammed 1984 - Expanded Edition!");
                        gameState.gameEnded = true;
                    } else {
                        addToOutput("Resuming game...");
                    }
                    
                    gameInput.onkeypress = originalEventHandler;
                    gameInput.value = '';
                    gameInput.focus();
                }
            };
        }

        // Initialize the game when the page loads
        window.onload = initGame;
    </script>
</body>
</html>
