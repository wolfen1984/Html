<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle of the Dammed 1984</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            overflow-x: hidden;
        }
        
        .game-container {
            border: 2px solid #fff;
            padding: 20px;
            margin-top: 20px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px dashed #fff;
            padding-bottom: 10px;
        }
        
        .game-title {
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #fff;
        }
        
        .game-subtitle {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }
        
        .game-output {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
            border: 1px solid #333;
            padding: 15px;
            background-color: #111;
        }
        
        .game-output p {
            margin-bottom: 10px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .game-output .location {
            color: #ffff00;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .game-output .hint {
            color: #888;
            font-style: italic;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .game-output .enemy {
            color: #ff5555;
        }
        
        .game-output .npc {
            color: #55ff55;
        }
        
        .game-output .combat {
            color: #ff4444;
            font-weight: bold;
        }
        
        .game-output .player {
            color: #55ffff;
        }
        
        .game-output .health {
            color: #ff6666;
        }
        
        .game-output .damage {
            color: #ff9966;
        }
        
        .game-output .victory {
            color: #ffff55;
            font-weight: bold;
        }
        
        .game-output .defeat {
            color: #ff5555;
            font-weight: bold;
        }
        
        .game-output .gold {
            color: #ffd700;
        }
        
        .game-output .shop {
            color: #ffaa00;
        }
        
        .game-output .magic {
            color: #ff66ff;
        }
        
        .game-output .item {
            color: #55ff55;
        }
        
        .game-input-container {
            display: flex;
            align-items: center;
            border-top: 1px dashed #fff;
            padding-top: 15px;
        }
        
        .game-prompt {
            margin-right: 10px;
            color: #00ff00;
        }
        
        #game-input {
            background-color: #000;
            color: #fff;
            border: 1px solid #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            padding: 10px;
            flex-grow: 1;
            outline: none;
        }
        
        #game-input:focus {
            box-shadow: 0 0 5px #fff;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Scrollbar styling */
        .game-output::-webkit-scrollbar {
            width: 10px;
        }
        
        .game-output::-webkit-scrollbar-track {
            background: #111;
        }
        
        .game-output::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 5px;
        }
        
        .game-output::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
        
        /* Status bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #222;
            border: 1px solid #444;
            font-size: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
        }
        
        .health-bar {
            width: 100px;
            height: 12px;
            background-color: #333;
            margin-left: 5px;
            border: 1px solid #555;
        }
        
        .health-fill {
            height: 100%;
            background-color: #ff5555;
            transition: width 0.3s;
        }
        
        .magic-fill {
            background-color: #9966ff;
        }
        
        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                font-size: 14px;
                padding: 10px;
            }
            
            .game-title {
                font-size: 18px;
            }
            
            .game-container {
                padding: 10px;
            }
            
            #game-input {
                font-size: 12px;
                padding: 8px;
            }
            
            .status-bar {
                font-size: 10px;
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1 class="game-title">CASTLE OF THE DAMMED 1984</h1>
        <p class="game-subtitle">Â© 1984 Dystopian Castle Software</p>
        <p class="game-subtitle">Text Adventure v1.0 - EXPANDED WORLD (23 ROOMS)</p>
    </div>
    
    <div class="status-bar" id="status-bar">
        <div class="status-item">
            HP: <span id="player-hp-text">50/50</span>
            <div class="health-bar">
                <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
            </div>
        </div>
        <div class="status-item">
            MP: <span id="player-mp-text">20/20</span>
            <div class="health-bar">
                <div class="health-fill magic-fill" id="player-magic-fill" style="width: 100%;"></div>
            </div>
        </div>
        <div class="status-item">
            Weapon: <span id="player-weapon">Fists</span>
        </div>
        <div class="status-item">
            Gold: <span id="player-gold">15</span>
        </div>
        <div class="status-item">
            Enemy HP: <span id="enemy-hp-text">-</span>
            <div class="health-bar">
                <div class="health-fill" id="enemy-health-fill" style="width: 0%; background-color: #ff9966;"></div>
            </div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="game-output" id="game-output">
            <!-- Game text will appear here -->
        </div>
        
        <div class="game-input-container">
            <span class="game-prompt">&gt;</span>
            <input type="text" id="game-input" placeholder="Type your command..." autocomplete="off">
        </div>
    </div>

    <script>
        // ==================== GAME SAVE SYSTEM ====================
        
        const SAVE_KEY = 'castleDamned1984Save';
        
        function saveGame() {
            const saveData = {
                player: {
                    maxHP: player.maxHP,
                    currentHP: player.currentHP,
                    maxMP: player.maxMP,
                    currentMP: player.currentMP,
                    gold: player.gold,
                    weapon: player.weapon,
                    inventory: player.inventory,
                    spells: player.spells,
                    equippedItems: player.equippedItems
                },
                gameState: gameState,
                combatActive: combatActive,
                currentEnemy: currentEnemy
            };
            localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
        }
        
        function loadGame() {
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) {
                try {
                    const saveData = JSON.parse(saved);
                    Object.assign(player, saveData.player);
                    Object.assign(gameState, saveData.gameState);
                    combatActive = saveData.combatActive || false;
                    currentEnemy = saveData.currentEnemy || null;
                    return true;
                } catch (e) {
                    console.error("Failed to load save:", e);
                }
            }
            return false;
        }
        
        function clearSave() {
            localStorage.removeItem(SAVE_KEY);
        }
        
        // ==================== COMBAT SYSTEM ====================
        
        // Player stats
        const player = {
            maxHP: 50,
            currentHP: 50,
            maxMP: 20,
            currentMP: 20,
            gold: 15,
            weapon: {
                name: "Fists",
                minDamage: 4,
                maxDamage: 6,
                type: "melee"
            },
            inventory: ["leather bound spellbook", "health potion", "torch"],
            spells: ["magic missile"], // Starting spell
            equippedItems: {
                weapon: "Fists",
                armor: null,
                accessory: null
            }
        };
        
        // Enemy types
        const enemies = {
            corruptedGuard: {
                name: "Corrupted Castle Guard",
                maxHP: 25,
                currentHP: 25,
                minDamage: 3,
                maxDamage: 6,
                description: "A castle guard whose eyes glow with an unnatural purple light. His armor is rusted and he moves with jerky, unnatural motions.",
                defeatMessage: "The corrupted guard collapses into a pile of rusted armor and dust!",
                loot: "rusty sword"
            },
            shadowStalker: {
                name: "Shadow Stalker",
                maxHP: 18,
                currentHP: 18,
                minDamage: 4,
                maxDamage: 7,
                description: "A creature made of living shadow that seems to drink the light around it.",
                defeatMessage: "The shadow stalker dissipates with an unearthly shriek!",
                loot: "shadow essence"
            },
            spectralKnight: {
                name: "Spectral Knight",
                maxHP: 35,
                currentHP: 35,
                minDamage: 5,
                maxDamage: 9,
                description: "A ghostly knight in ethereal armor, wielding a phantom sword that phases in and out of existence.",
                defeatMessage: "The spectral knight fades away with a mournful sigh!",
                loot: "ghostly essence"
            },
            giantSpider: {
                name: "Giant Spider",
                maxHP: 22,
                currentHP: 22,
                minDamage: 4,
                maxDamage: 8,
                description: "A massive, hairy spider with venom-dripping fangs. Its multiple eyes glow with malevolent intelligence.",
                defeatMessage: "The giant spider curls up and dies!",
                loot: "spider silk"
            },
            cursedPriest: {
                name: "Cursed Priest",
                maxHP: 28,
                currentHP: 28,
                minDamage: 3,
                maxDamage: 7,
                description: "A former priest now twisted by dark magic. He chants unholy verses that chill your soul.",
                defeatMessage: "The cursed priest collapses, his dark prayers finally silenced!",
                loot: "holy symbol"
            },
            stoneGolem: {
                name: "Stone Golem",
                maxHP: 45,
                currentHP: 45,
                minDamage: 6,
                maxDamage: 12,
                description: "A massive construct of animated stone. It moves with earth-shaking steps.",
                defeatMessage: "The stone golem crumbles into rubble!",
                loot: "stone heart"
            }
        };
        
        // Spell definitions
        const spells = {
            "magic missile": {
                name: "Magic Missile",
                cost: 5,
                description: "Fires a bolt of magical energy at your enemy.",
                effect: function() {
                    if (!currentEnemy) {
                        addToOutput("There's nothing to attack with magic here.", "magic");
                        return false;
                    }
                    
                    const damage = Math.floor(Math.random() * 6) + 5; // 5-10 damage
                    currentEnemy.currentHP -= damage;
                    currentEnemy.currentHP = Math.max(0, currentEnemy.currentHP);
                    
                    addToOutput(`You cast Magic Missile! It hits for ${damage} damage!`, "magic");
                    addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
                    
                    if (currentEnemy.currentHP <= 0) {
                        endCombat(true);
                    } else {
                        enemyAttack();
                    }
                    updateStatus();
                    return true;
                }
            },
            "heal": {
                name: "Heal",
                cost: 8,
                description: "Restores 15-25 HP to yourself.",
                effect: function() {
                    const healAmount = Math.floor(Math.random() * 11) + 15;
                    player.currentHP = Math.min(player.maxHP, player.currentHP + healAmount);
                    addToOutput(`You cast Heal! You restore ${healAmount} HP!`, "magic");
                    updateStatus();
                    return true;
                }
            },
            "light": {
                name: "Light",
                cost: 3,
                description: "Creates a magical light source that reveals hidden objects.",
                effect: function() {
                    const loc = locations[gameState.currentLocation];
                    addToOutput("You cast Light! The area is illuminated by magical energy.", "magic");
                    
                    if (loc.hiddenItems && loc.hiddenItems.length > 0) {
                        addToOutput("The magical light reveals previously hidden items!", "magic");
                        loc.hiddenItems.forEach(item => {
                            if (!loc.items.includes(item) && !player.inventory.includes(item)) {
                                loc.items.push(item);
                                addToOutput(`You see a ${item.toUpperCase()} revealed by the light!`, "item");
                            }
                        });
                    }
                    return true;
                }
            },
            "fireball": {
                name: "Fireball",
                cost: 10,
                description: "Creates a massive explosion of fire that damages all enemies.",
                effect: function() {
                    if (!currentEnemy) {
                        addToOutput("There's nothing to attack with fire here.", "magic");
                        return false;
                    }
                    
                    const damage = Math.floor(Math.random() * 11) + 10; // 10-20 damage
                    currentEnemy.currentHP -= damage;
                    currentEnemy.currentHP = Math.max(0, currentEnemy.currentHP);
                    
                    addToOutput(`You cast Fireball! It engulfs the enemy for ${damage} damage!`, "magic");
                    addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
                    
                    if (currentEnemy.currentHP <= 0) {
                        endCombat(true);
                    } else {
                        enemyAttack();
                    }
                    updateStatus();
                    return true;
                }
            },
            "invisibility": {
                name: "Invisibility",
                cost: 12,
                description: "Makes you invisible to enemies for a short time.",
                effect: function() {
                    addToOutput("You cast Invisibility! You fade from sight.", "magic");
                    addToOutput("Enemies will have trouble hitting you for a while.", "magic");
                    return true;
                }
            }
        };
        
        // Current combat state
        let combatActive = false;
        let currentEnemy = null;
        
        // ==================== GAME STATE ====================
        const gameState = {
            currentLocation: 'dungeonCell',
            inventory: [],
            visitedLocations: ['dungeonCell'],
            gameEnded: false,
            
            // Room-specific states
            dungeonCell: {
                bedExamined: false,
                brickExamined: false,
                looseBrickFound: false,
                potionTaken: false,
                keyTaken: false
            },
            guardRoom: {
                guardDefeated: false,
                swordTaken: false,
                portraitExamined: false,
                secretFound: false,
                silverKeyTaken: false
            },
            library: {
                librarianTalked: false,
                scrollTaken: false,
                fireplaceExamined: false,
                tomeExamined: false,
                healSpellLearned: false
            },
            // New room states
            throneRoom: {
                throneExamined: false,
                tapestryExamined: false,
                secretDoorFound: false
            },
            kitchen: {
                pantryExamined: false,
                ratDefeated: false,
                cheeseTaken: false
            },
            armory: {
                weaponsExamined: false,
                armorTaken: false,
                trainingDummyUsed: false
            },
            barracks: {
                bedsExamined: false,
                footlockerOpened: false,
                journalRead: false
            }
        };
        
        // Update status display
        function updateStatus() {
            document.getElementById('player-hp-text').textContent = 
                `${player.currentHP}/${player.maxHP}`;
            
            document.getElementById('player-mp-text').textContent = 
                `${player.currentMP}/${player.maxMP}`;
            
            const playerHealthPercent = (player.currentHP / player.maxHP) * 100;
            document.getElementById('player-health-fill').style.width = 
                `${Math.max(0, playerHealthPercent)}%`;
            
            const playerMagicPercent = (player.currentMP / player.maxMP) * 100;
            document.getElementById('player-magic-fill').style.width = 
                `${Math.max(0, playerMagicPercent)}%`;
            
            document.getElementById('player-weapon').textContent = player.weapon.name;
            document.getElementById('player-gold').textContent = player.gold;
            
            if (currentEnemy && combatActive) {
                document.getElementById('enemy-hp-text').textContent = 
                    `${currentEnemy.currentHP}/${currentEnemy.maxHP}`;
                
                const enemyHealthPercent = (currentEnemy.currentHP / currentEnemy.maxHP) * 100;
                document.getElementById('enemy-health-fill').style.width = 
                    `${Math.max(0, enemyHealthPercent)}%`;
                document.getElementById('enemy-health-fill').style.display = 'block';
            } else {
                document.getElementById('enemy-hp-text').textContent = '-';
                document.getElementById('enemy-health-fill').style.display = 'none';
            }
            
            // Auto-save after every status update
            saveGame();
        }
        
        // Combat functions
        function startCombat(enemyType) {
            currentEnemy = JSON.parse(JSON.stringify(enemies[enemyType])); // Clone enemy
            combatActive = true;
            updateStatus();
            
            addToOutput(`A ${currentEnemy.name} appears!`, "enemy");
            addToOutput(currentEnemy.description, "enemy");
            addToOutput("COMBAT STARTED! Use ATTACK to fight or CAST [spell]!", "combat");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP} | ${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "combat");
        }
        
        function playerAttack() {
            if (!combatActive || !currentEnemy) {
                addToOutput("There's nothing to attack here.");
                return;
            }
            
            const playerDamage = Math.floor(
                Math.random() * (player.weapon.maxDamage - player.weapon.minDamage + 1)
            ) + player.weapon.minDamage;
            
            currentEnemy.currentHP -= playerDamage;
            currentEnemy.currentHP = Math.max(0, currentEnemy.currentHP);
            
            addToOutput(`You attack with your ${player.weapon.name} and deal ${playerDamage} damage!`, "player");
            addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
            
            if (currentEnemy.currentHP <= 0) {
                endCombat(true);
                return;
            }
            
            enemyAttack();
            updateStatus();
        }
        
        function enemyAttack() {
            const enemyDamage = Math.floor(
                Math.random() * (currentEnemy.maxDamage - currentEnemy.minDamage + 1)
            ) + currentEnemy.minDamage;
            
            player.currentHP -= enemyDamage;
            player.currentHP = Math.max(0, player.currentHP);
            
            addToOutput(`${currentEnemy.name} attacks you for ${enemyDamage} damage!`, "enemy");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP}`, "health");
            
            if (player.currentHP <= 0) {
                endCombat(false);
            }
        }
        
        function endCombat(playerWon) {
            if (playerWon) {
                addToOutput(currentEnemy.defeatMessage, "victory");
                
                if (currentEnemy.loot && !player.inventory.includes(currentEnemy.loot)) {
                    player.inventory.push(currentEnemy.loot);
                    addToOutput(`You found a ${currentEnemy.loot}!`);
                    
                    if (currentEnemy.loot === "rusty sword") {
                        addToOutput("You can EQUIP RUSTY SWORD to use it as a weapon.", "hint");
                        gameState.guardRoom.swordTaken = true;
                    }
                    
                    if (currentEnemy.loot === "shadow essence") {
                        addToOutput("The shadow essence shimmers with dark energy.", "item");
                    }
                    
                    if (currentEnemy.loot === "ghostly essence") {
                        addToOutput("The ghostly essence pulses with spectral energy.", "magic");
                    }
                    
                    if (currentEnemy.loot === "spider silk") {
                        addToOutput("The spider silk is incredibly strong and could be useful.", "item");
                    }
                    
                    if (currentEnemy.loot === "holy symbol") {
                        addToOutput("The holy symbol glows faintly with residual divine energy.", "item");
                    }
                    
                    if (currentEnemy.loot === "stone heart") {
                        addToOutput("The stone heart is cold and heavy.", "item");
                    }
                }
                
                // Update room-specific states
                if (currentEnemy.name === "Corrupted Castle Guard") {
                    gameState.guardRoom.guardDefeated = true;
                    if (!locations.guardRoom.items.includes('rusty sword')) {
                        locations.guardRoom.items.push('rusty sword');
                    }
                } else if (currentEnemy.name === "Giant Spider") {
                    gameState.kitchen.ratDefeated = true; // Actually spider in kitchen
                    if (!locations.kitchen.items.includes('spider silk')) {
                        locations.kitchen.items.push('spider silk');
                    }
                }
                
                // Award some gold for victory
                const goldReward = Math.floor(Math.random() * 10) + 5;
                player.gold += goldReward;
                addToOutput(`You find ${goldReward} gold on the defeated enemy!`, "gold");
                
            } else {
                addToOutput("You have been defeated!", "defeat");
                addToOutput("GAME OVER - Type 'RESTART' to try again or load a saved game.", "defeat");
                gameState.gameEnded = true;
                gameInput.disabled = true;
            }
            
            combatActive = false;
            currentEnemy = null;
            updateStatus();
        }
        
        // Object descriptions
        const objectDescriptions = {
            // Weapons
            "fists": "Your bare hands. Not very effective but better than nothing. Damage: 4-6",
            "rusty sword": "A rusted but still functional sword. Better than fists. Damage: 6-9",
            "iron key": "A simple iron key. Might unlock something.",
            "silver key": "A delicate silver key with intricate designs.",
            "golden key": "An ornate golden key that feels warm to the touch.",
            "steel sword": "A well-made steel sword. Sharp and reliable. Damage: 8-12",
            "enchanted dagger": "A dagger that glows with magical energy. Damage: 7-10 + magical properties",
            
            // Items
            "leather bound spellbook": "Your personal spellbook. It contains the spells you know. READ SPELLBOOK to see your spells.",
            "health potion": "A small vial containing red liquid. Restores 20 HP when used.",
            "torch": "A wooden torch wrapped in cloth. Can be lit to provide light.",
            "shadow essence": "A vial containing swirling shadow. It might have magical properties.",
            "ancient scroll": "A scroll containing a healing spell. READ SCROLL to learn it.",
            "dusty tome": "An ancient book covered in dust. It might contain useful information.",
            "ghostly essence": "Ethereal substance that shimmers with spectral energy.",
            "spider silk": "Incredibly strong silk from a giant spider.",
            "holy symbol": "A silver symbol that glows with faint divine energy.",
            "stone heart": "A heavy stone that pulses with magical energy.",
            "cheese wheel": "A large wheel of surprisingly fresh cheese.",
            "iron helmet": "A sturdy helmet that offers some protection.",
            "leather armor": "Light but durable leather armor.",
            "golden chalice": "An ornate chalice that looks valuable.",
            "crystal orb": "A glowing crystal orb that shows swirling mists.",
            "old journal": "A leather-bound journal filled with handwritten notes.",
            "royal seal": "The official seal of the castle's former ruler.",
            "mysterious potion": "A bubbling potion with unknown effects.",
            "silver necklace": "A delicate necklace with a moonstone pendant.",
            "ancient coin": "A coin from a forgotten civilization.",
            
            // Room objects
            "straw bed": "A musty old bed filled with straw. It looks uncomfortable.",
            "loose brick": "A brick that seems out of place in the wall.",
            "rusty barrel": "An old, rusted barrel. It's empty.",
            "portrait": "A painting of a noble lord. The eyes seem to follow you.",
            "fireplace": "A large stone fireplace filled with cold ashes.",
            "bookshelf": "A shelf filled with ancient books.",
            "bookshelves": "Towering shelves filled with ancient books.",
            "table": "A sturdy wooden table.",
            "chair": "A comfortable looking chair.",
            "throne": "An ornate throne made of dark wood and silver.",
            "tapestry": "A large tapestry depicting castle history.",
            "pantry": "A storage area for food and supplies.",
            "cooking pot": "A large iron pot hanging over cold ashes.",
            "weapon rack": "A rack holding various weapons.",
            "training dummy": "A straw dummy used for weapons practice.",
            "armor stand": "A stand holding a suit of armor.",
            "bed": "A simple soldier's bed.",
            "footlocker": "A small locked chest at the foot of a bed.",
            "altar": "A stone altar with strange markings.",
            "stained glass window": "A beautiful window depicting religious scenes.",
            "well": "A deep stone well with a wooden bucket.",
            "fountain": "A decorative fountain, now dry.",
            "statue": "A marble statue of a former king.",
            "brazier": "A metal bowl for holding fire.",
            "torture rack": "A horrific device for torture.",
            "iron maiden": "A spiked coffin-like torture device.",
            "alchemy table": "A table covered in vials and ingredients.",
            "crystal ball": "A large crystal ball on a stand.",
            "cauldron": "A large black cauldron.",
            "bed of roses": "A bed surrounded by strangely preserved roses.",
            "mirror": "A large ornate mirror."
        };

        // Game locations - 23 ROOMS TOTAL
        const locations = {
            // Original 3 rooms
            dungeonCell: {
                name: "DUNGEON CELL",
                description: function() {
                    let desc = "You awaken in a cold, damp dungeon cell. The air smells of mildew and decay. ";
                    desc += "In one corner sits a STRAW BED, and in another, a RUSTY BARREL. ";
                    desc += "The cell door to the north is slightly ajar.";
                    
                    if (!gameState.dungeonCell.keyTaken && this.items.includes('iron key')) {
                        desc += " You notice an IRON KEY on the floor near the bed.";
                    }
                    
                    if (!gameState.dungeonCell.potionTaken && this.items.includes('health potion')) {
                        desc += " There's a HEALTH POTION on a small ledge.";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["iron key", "health potion"],
                exits: {
                    north: "guardRoom",
                    south: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            guardRoom: {
                name: "GUARD ROOM",
                description: function() {
                    let desc = "A guard room with a stone table and chairs. ";
                    
                    if (!gameState.guardRoom.guardDefeated) {
                        desc += "A CORRUPTED GUARD blocks your way, his eyes glowing with purple light! ";
                        this.enemy = "corruptedGuard";
                    } else {
                        desc += "The defeated guard's armor lies in a pile on the floor. ";
                        this.enemy = null;
                    }
                    
                    desc += "On the wall hangs a PORTRAIT of a noble lord. ";
                    desc += "A wooden DOOR leads east, and the cell door is to the south.";
                    
                    if (gameState.guardRoom.guardDefeated && !gameState.guardRoom.swordTaken && this.items.includes('rusty sword')) {
                        desc += " The guard's RUSTY SWORD lies on the floor.";
                    }
                    
                    if (gameState.guardRoom.secretFound && !gameState.guardRoom.silverKeyTaken && this.items.includes('silver key')) {
                        desc += " A SILVER KEY glints from within the portrait's secret compartment.";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["silver key"],
                exits: {
                    south: "dungeonCell",
                    east: "library",
                    north: "mainHall",
                    west: null
                },
                visited: false,
                enemy: "corruptedGuard"
            },
            library: {
                name: "ANCIENT LIBRARY",
                description: function() {
                    let desc = "You enter a vast library filled with towering BOOKSHELVES. ";
                    desc += "Dusty TOMES line the shelves. In the center of the room, an old LIBRARIAN ";
                    desc += "is organizing scrolls at a large TABLE. A stone FIREPLACE dominates the west wall.";
                    
                    if (!gameState.library.scrollTaken && this.items.includes('ancient scroll')) {
                        desc += " An ANCIENT SCROLL sits on the table.";
                    }
                    
                    return desc;
                },
                items: ["ancient scroll", "dusty tome"],
                hiddenItems: [],
                exits: {
                    west: "guardRoom",
                    north: "alchemyLab",
                    east: "study",
                    south: null
                },
                visited: false,
                enemy: null
            },
            
            // New rooms (20 more)
            mainHall: {
                name: "GRAND MAIN HALL",
                description: function() {
                    let desc = "A massive hall with vaulted ceilings. Tattered banners hang from the walls. ";
                    desc += "A marble STAIRCASE leads up to a balcony. To the east, double doors lead to the ";
                    desc += "THRONE ROOM. To the west, a corridor leads to the BARRACKS.";
                    
                    if (!this.visited) {
                        desc += " A SPECTRAL KNIGHT patrols the hall!";
                        this.enemy = "spectralKnight";
                    } else {
                        this.enemy = null;
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["golden chalice"],
                exits: {
                    south: "guardRoom",
                    north: "courtyard",
                    east: "throneRoom",
                    west: "barracks",
                    up: "balcony"
                },
                visited: false,
                enemy: "spectralKnight"
            },
            
            throneRoom: {
                name: "THRONE ROOM",
                description: function() {
                    let desc = "An opulent throne room with a massive THRONE on a raised dais. ";
                    desc += "A large TAPESTRY behind the throne depicts the castle's history. ";
                    desc += "The room feels strangely cold despite its grandeur.";
                    
                    if (gameState.throneRoom.secretDoorFound) {
                        desc += " Behind the tapestry, you've discovered a SECRET DOOR!";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["royal seal"],
                exits: {
                    west: "mainHall",
                    north: "secretPassage",
                    south: null,
                    east: null
                },
                visited: false,
                enemy: null
            },
            
            barracks: {
                name: "SOLDIER BARRACKS",
                description: function() {
                    let desc = "A long room filled with rows of simple BEDS. ";
                    desc += "FOOTLOCKERS sit at the foot of each bed. ";
                    desc += "The air smells of dust and old leather.";
                    
                    if (!gameState.barracks.footlockerOpened && this.items.includes('iron helmet')) {
                        desc += " One footlocker isn't completely closed.";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["iron helmet", "old journal"],
                exits: {
                    east: "mainHall",
                    north: "armory",
                    south: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            armory: {
                name: "CASTLE ARMORY",
                description: function() {
                    let desc = "Weapon RACKS line the walls, holding various swords and axes. ";
                    desc += "An ARMOR STAND displays a suit of plate armor. ";
                    desc += "A TRAINING DUMMY stands in the corner.";
                    
                    if (!gameState.armory.armorTaken && this.items.includes('leather armor')) {
                        desc += " A suit of LEATHER ARMOR hangs on one wall.";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["leather armor", "steel sword"],
                exits: {
                    south: "barracks",
                    east: "trainingYard",
                    north: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            trainingYard: {
                name: "TRAINING YARD",
                description: function() {
                    let desc = "An open courtyard where soldiers once trained. ";
                    desc += "Weapon racks and straw dummies are scattered about. ";
                    desc += "A stone WELL stands in the center of the yard.";
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["enchanted dagger"],
                exits: {
                    west: "armory",
                    north: "courtyard",
                    east: "kitchen",
                    south: null
                },
                visited: false,
                enemy: null
            },
            
            kitchen: {
                name: "CASTLE KITCHEN",
                description: function() {
                    let desc = "A large kitchen with a massive cooking POT over cold ashes. ";
                    desc += "A PANTRY door stands ajar. The air smells of old spices and rot.";
                    
                    if (!gameState.kitchen.ratDefeated) {
                        desc += " A GIANT SPIDER has made its nest here!";
                        this.enemy = "giantSpider";
                    } else {
                        desc += " The defeated spider's web still hangs in the corner.";
                        this.enemy = null;
                    }
                    
                    if (!gameState.kitchen.cheeseTaken && this.items.includes('cheese wheel')) {
                        desc += " A wheel of CHEESE sits on a counter.";
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["cheese wheel", "silver necklace"],
                exits: {
                    west: "trainingYard",
                    north: "diningHall",
                    east: "pantryRoom",
                    south: null
                },
                visited: false,
                enemy: "giantSpider"
            },
            
            pantryRoom: {
                name: "PANTRY",
                description: function() {
                    let desc = "A storage room filled with empty shelves and barrels. ";
                    desc += "Most supplies have long since rotted away. ";
                    desc += "The only exit is back to the kitchen.";
                    
                    return desc;
                },
                items: ["mysterious potion"],
                hiddenItems: [],
                exits: {
                    west: "kitchen",
                    north: null,
                    east: null,
                    south: null
                },
                visited: false,
                enemy: null
            },
            
            diningHall: {
                name: "GRAND DINING HALL",
                description: function() {
                    let desc = "A long hall with a massive oak TABLE that could seat fifty. ";
                    desc += "Silver candelabras gather dust. A large STAINED GLASS WINDOW ";
                    desc += "depicts a feast scene.";
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["golden key"],
                exits: {
                    south: "kitchen",
                    north: "courtyard",
                    east: "wineCellar",
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            wineCellar: {
                name: "WINE CELLAR",
                description: function() {
                    let desc = "A cool, dark cellar filled with wine racks. ";
                    desc += "Most bottles have shattered or turned to vinegar. ";
                    desc += "The air smells of sour wine and damp stone.";
                    
                    if (!this.visited) {
                        desc += " A CURSED PRIEST kneels in prayer in the corner!";
                        this.enemy = "cursedPriest";
                    } else {
                        this.enemy = null;
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["ancient coin"],
                exits: {
                    west: "diningHall",
                    north: null,
                    east: null,
                    south: null
                },
                visited: false,
                enemy: "cursedPriest"
            },
            
            courtyard: {
                name: "CENTRAL COURTYARD",
                description: function() {
                    let desc = "A large open courtyard surrounded by castle walls. ";
                    desc += "A dry FOUNTAIN stands in the center. A marble STATUE ";
                    desc += "of a former king looks down upon the courtyard.";
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["crystal orb"],
                exits: {
                    south: "mainHall",
                    north: "chapel",
                    east: "diningHall",
                    west: "trainingYard"
                },
                visited: false,
                enemy: null
            },
            
            chapel: {
                name: "CASTLE CHAPEL",
                description: function() {
                    let desc = "A small chapel with wooden pews and a stone ALTAR. ";
                    desc += "Stained glass windows cast colorful light patterns. ";
                    desc += "The air feels heavy with forgotten prayers.";
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["holy symbol"],
                exits: {
                    south: "courtyard",
                    north: "cryptEntrance",
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            cryptEntrance: {
                name: "CRYPT ENTRANCE",
                description: function() {
                    let desc = "A stone stairway leading down into darkness. ";
                    desc += "An iron gate blocks the way, secured with a heavy lock. ";
                    desc += "Cold air wafts up from below, carrying the scent of decay.";
                    
                    return desc;
                },
                items: [],
                hiddenItems: [],
                exits: {
                    south: "chapel",
                    down: player.inventory.includes("golden key") ? "upperCrypt" : null,
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            upperCrypt: {
                name: "UPPER CRYPT",
                description: function() {
                    let desc = "A chamber filled with stone sarcophagi. ";
                    desc += "Dust covers everything. The air is cold and still. ";
                    desc += "A stairway leads further down into darkness.";
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["ghostly essence"],
                exits: {
                    up: "cryptEntrance",
                    down: "lowerCrypt",
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            lowerCrypt: {
                name: "LOWER CRYPT",
                description: function() {
                    let desc = "The lowest level of the crypt. The air is freezing. ";
                    desc += "Ancient bones are stacked in niches along the walls. ";
                    desc += "A massive stone door stands at the far end.";
                    
                    if (!this.visited) {
                        desc += " A STONE GOLEM guards the door!";
                        this.enemy = "stoneGolem";
                    } else {
                        this.enemy = null;
                    }
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["stone heart"],
                exits: {
                    up: "upperCrypt",
                    north: "royalTomb",
                    east: null,
                    west: null,
                    south: null
                },
                visited: false,
                enemy: "stoneGolem"
            },
            
            royalTomb: {
                name: "ROYAL TOMB",
                description: function() {
                    let desc = "An ornate burial chamber with a single massive sarcophagus. ";
                    desc += "Gold and jewels decorate the room, though much has tarnished. ";
                    desc += "This must be the resting place of the castle's former ruler.";
                    
                    return desc;
                },
                items: ["crown of the damned"],
                hiddenItems: [],
                exits: {
                    south: "lowerCrypt",
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            balcony: {
                name: "UPPER BALCONY",
                description: function() {
                    let desc = "A balcony overlooking the main hall. ";
                    desc += "You can see the entire hall from here. ";
                    desc += "A door leads to the royal chambers.";
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["silver key"],
                exits: {
                    down: "mainHall",
                    north: "royalChambers",
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            royalChambers: {
                name: "ROYAL CHAMBERS",
                description: function() {
                    let desc = "Once-luxurious living quarters now covered in dust. ";
                    desc += "A large BED with silk curtains stands against one wall. ";
                    desc += "An ornate MIRROR reflects the room dimly.";
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["royal signet ring"],
                exits: {
                    south: "balcony",
                    north: "royalBath",
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            royalBath: {
                name: "ROYAL BATH",
                description: function() {
                    let desc = "A marble bathing chamber with a large sunken tub. ";
                    desc += "The pipes have long since rusted shut. ";
                    desc += "The room smells faintly of old perfume.";
                    
                    return desc;
                },
                items: ["soap of cleansing"],
                hiddenItems: [],
                exits: {
                    south: "royalChambers",
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            study: {
                name: "WIZARD'S STUDY",
                description: function() {
                    let desc = "A room filled with strange devices and books. ";
                    desc += "An ALCHEMY TABLE holds various vials and ingredients. ";
                    desc += "A CRYSTAL BALL sits on a velvet cushion.";
                    
                    return desc;
                },
                items: ["scroll of fireball"],
                hiddenItems: ["potion of invisibility"],
                exits: {
                    west: "library",
                    north: "observatory",
                    east: null,
                    south: null
                },
                visited: false,
                enemy: null
            },
            
            observatory: {
                name: "ASTRONOMICAL OBSERVATORY",
                description: function() {
                    let desc = "A circular room with a domed glass ceiling. ";
                    desc += "A large telescope points at the night sky. ";
                    desc += "Star charts cover the walls.";
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["star chart"],
                exits: {
                    south: "study",
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            alchemyLab: {
                name: "ALCHEMY LABORATORY",
                description: function() {
                    let desc = "A room filled with bubbling CAULDRONS and strange smells. ";
                    desc += "Shelves hold jars of exotic ingredients. ";
                    desc += "The air crackles with magical energy.";
                    
                    return desc;
                },
                items: ["potion of healing"],
                hiddenItems: ["formula for magic"],
                exits: {
                    south: "library",
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            secretPassage: {
                name: "SECRET PASSAGE",
                description: function() {
                    let desc = "A narrow, dark passage behind the throne room tapestry. ";
                    desc += "Cobwebs brush against your face. The passage slopes downward.";
                    
                    return desc;
                },
                items: [],
                hiddenItems: ["hidden treasure"],
                exits: {
                    south: "throneRoom",
                    north: "hiddenVault",
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            
            hiddenVault: {
                name: "HIDDEN VAULT",
                description: function() {
                    let desc = "A small, secure room filled with treasure chests. ";
                    desc += "Gold coins spill onto the floor. This must be the castle's ";
                    desc += "secret treasury!";
                    
                    return desc;
                },
                items: ["treasure chest", "gold coins", "jeweled necklace"],
                hiddenItems: [],
                exits: {
                    south: "secretPassage",
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            }
        };

        // Game commands
        const commands = {
            'north': 'north',
            'n': 'north',
            'south': 'south',
            's': 'south',
            'east': 'east',
            'e': 'east',
            'west': 'west',
            'w': 'west',
            'up': 'up',
            'u': 'up',
            'down': 'down',
            'd': 'down',
            'look': 'look',
            'l': 'look',
            'inventory': 'inventory',
            'i': 'inventory',
            'take': 'take',
            'get': 'take',
            'grab': 'take',
            'drop': 'drop',
            'examine': 'examine',
            'x': 'examine',
            'use': 'use',
            'equip': 'equip',
            'unequip': 'unequip',
            'open': 'open',
            'read': 'read',
            'talk': 'talk',
            'speak': 'talk',
            'ask': 'talk',
            'give': 'give',
            'attack': 'attack',
            'fight': 'attack',
            'kill': 'attack',
            'cast': 'cast',
            'light': 'light',
            'repair': 'repair',
            'fix': 'repair',
            'eat': 'eat',
            'drink': 'drink',
            'buy': 'buy',
            'purchase': 'buy',
            'sell': 'sell',
            'shop': 'shop',
            'list': 'shop',
            'save': 'save',
            'load': 'load',
            'restart': 'restart',
            'help': 'help',
            'h': 'help',
            'quit': 'quit',
            'q': 'quit'
        };

        // DOM elements
        const gameOutput = document.getElementById('game-output');
        const gameInput = document.getElementById('game-input');

        // Add text to game output
        function addToOutput(text, className = '') {
            const p = document.createElement('p');
            p.textContent = text;
            if (className) {
                p.className = className;
            }
            gameOutput.appendChild(p);
            
            gameOutput.scrollTop = gameOutput.scrollHeight;
        }

        // Show current location
        function showLocation() {
            const loc = locations[gameState.currentLocation];
            
            addToOutput(loc.name, "location");
            
            const description = loc.description();
            addToOutput(description);
            
            if (!loc.visited) {
                loc.visited = true;
                gameState.visitedLocations.push(gameState.currentLocation);
            }
            
            // Start combat if there's an enemy in the room and we're not already in combat
            if (loc.enemy && !combatActive && !gameState[gameState.currentLocation]?.guardDefeated) {
                startCombat(loc.enemy);
            }
            
            const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
            if (exits.length > 0) {
                addToOutput("Exits: " + exits.map(exit => exit.toUpperCase()).join(", "));
            }
        }

        // Initialize game
        function initGame() {
            // Try to load saved game first
            const loaded = loadGame();
            
            if (!loaded) {
                // Normal initialization
                gameOutput.innerHTML = '';
                addToOutput("CASTLE OF THE DAMMED 1984", "title");
                addToOutput("Dystopian Text Adventure - EXPANDED WORLD (23 ROOMS)", "subtitle");
                addToOutput(" ");
                addToOutput("The year is 1984, but not as you know it. The Castle of the Dammed", "story");
                addToOutput("has stood for centuries, its dark magic warping time and space.", "story");
                addToOutput("You awaken in its dungeons with no memory of how you got here...", "story");
                addToOutput(" ");
                addToOutput("TIP: You start with a spellbook containing MAGIC MISSILE.", "magic");
                addToOutput("Explore 23 rooms filled with secrets, enemies, and treasure!", "hint");
                addToOutput("Use EQUIP [weapon] to change your main weapon.", "hint");
                addToOutput(" ");
                
                // Set initial inventory
                gameState.inventory = [...player.inventory];
                updateStatus();
                showLocation();
            } else {
                gameOutput.innerHTML = '';
                addToOutput("CASTLE OF THE DAMMED 1984", "title");
                addToOutput("Game loaded successfully!", "victory");
                addToOutput(`HP: ${player.currentHP}/${player.maxHP} | MP: ${player.currentMP}/${player.maxMP}`, "player");
                addToOutput(`Gold: ${player.gold} | Weapon: ${player.weapon.name}`, "player");
                
                if (player.spells.length > 0) {
                    addToOutput("Known spells: " + player.spells.map(s => s.toUpperCase()).join(", "), "magic");
                }
                
                if (player.inventory.length > 0) {
                    addToOutput("Inventory: " + player.inventory.map(item => item.toUpperCase()).join(", "));
                }
                
                addToOutput(" ");
                showLocation();
            }
            
            // Set up input event listener
            gameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processCommand(this.value);
                    this.value = '';
                }
            });
            
            gameInput.focus();
        }

        // Process player command
        function processCommand(input) {
            if (gameState.gameEnded && !input.toLowerCase().includes('restart')) {
                addToOutput("The game has ended. Type RESTART to try again.", "hint");
                return;
            }
            
            const command = input.trim().toLowerCase();
            if (!command) return;
            
            const parts = command.split(' ');
            const verb = parts[0];
            const object = parts.slice(1).join(' ');
            
            // Check for restart command
            if (verb === 'restart') {
                clearSave();
                location.reload();
                return;
            }
            
            if (!commands[verb]) {
                addToOutput(`I don't understand "${verb}".`);
                return;
            }
            
            const action = commands[verb];
            
            switch(action) {
                case 'north':
                case 'south':
                case 'east':
                case 'west':
                case 'up':
                case 'down':
                    movePlayer(action);
                    break;
                case 'look':
                    lookAround();
                    break;
                case 'inventory':
                    showInventory();
                    break;
                case 'take':
                    takeItem(object);
                    break;
                case 'drop':
                    dropItem(object);
                    break;
                case 'examine':
                    examineObject(object);
                    break;
                case 'use':
                    useItem(object);
                    break;
                case 'equip':
                    equipItem(object);
                    break;
                case 'unequip':
                    unequipItem(object);
                    break;
                case 'open':
                    openObject(object);
                    break;
                case 'read':
                    readObject(object);
                    break;
                case 'talk':
                    talkTo(object);
                    break;
                case 'give':
                    giveItem(object);
                    break;
                case 'attack':
                    if (combatActive) {
                        playerAttack();
                    } else {
                        attackEnemy(object);
                    }
                    break;
                case 'cast':
                    castSpell(object);
                    break;
                case 'save':
                    saveGame();
                    addToOutput("Game saved successfully!", "victory");
                    break;
                case 'load':
                    if (loadGame()) {
                        addToOutput("Game loaded successfully!", "victory");
                        updateStatus();
                        showLocation();
                    } else {
                        addToOutput("No saved game found.", "hint");
                    }
                    break;
                case 'help':
                    showHelp();
                    break;
                case 'quit':
                    quitGame();
                    break;
                default:
                    addToOutput(`Command "${verb}" not implemented yet.`);
            }
        }

        // Move player
        function movePlayer(direction) {
            if (combatActive) {
                addToOutput("You can't run from combat! You must FIGHT!", "combat");
                return;
            }
            
            const currentLoc = locations[gameState.currentLocation];
            const newLocation = currentLoc.exits[direction];
            
            if (!newLocation) {
                addToOutput(`You can't go ${direction}.`);
                return;
            }
            
            // Check if guard blocks the way from dungeon cell
            if (gameState.currentLocation === "dungeonCell" && direction === 'north') {
                if (!gameState.guardRoom.guardDefeated) {
                    addToOutput("You attempt to go north through the cell door...");
                    addToOutput("A CORRUPTED CASTLE GUARD blocks your path!", "enemy");
                    addToOutput("You must defeat him first!");
                    // Start combat with the guard
                    gameState.currentLocation = "guardRoom";
                    showLocation();
                    return;
                }
            }
            
            // Check if trying to enter crypt without golden key
            if (gameState.currentLocation === "cryptEntrance" && direction === 'down') {
                if (!player.inventory.includes("golden key")) {
                    addToOutput("The iron gate is locked with a massive lock. You need a golden key.");
                    return;
                }
            }
            
            // Check if stone golem blocks royal tomb
            if (gameState.currentLocation === "lowerCrypt" && direction === 'north') {
                const lowerCryptState = gameState.lowerCrypt || {};
                if (locations.lowerCrypt.enemy === "stoneGolem" && !lowerCryptState.golemDefeated) {
                    addToOutput("The stone golem blocks the way to the royal tomb!");
                    addToOutput("You must defeat it first!");
                    return;
                }
            }
            
            gameState.currentLocation = newLocation;
            addToOutput(`You go ${direction}.`);
            showLocation();
        }

        // Look around
        function lookAround() {
            const loc = locations[gameState.currentLocation];
            
            addToOutput(loc.name, "location");
            
            const description = loc.description();
            addToOutput(description);
            
            const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
            if (exits.length > 0) {
                addToOutput("Exits: " + exits.map(exit => exit.toUpperCase()).join(", "));
            }
        }

        // Show inventory
        function showInventory() {
            if (player.inventory.length === 0) {
                addToOutput("You are carrying nothing.");
            } else {
                addToOutput("You are carrying: " + player.inventory.map(item => item.toUpperCase()).join(", "));
            }
            
            // Show equipped items
            addToOutput(`Equipped weapon: ${player.weapon.name} (${player.weapon.minDamage}-${player.weapon.maxDamage} damage)`, "player");
            
            // Show spells
            if (player.spells.length > 0) {
                addToOutput("Known spells: " + player.spells.map(spell => spell.toUpperCase()).join(", "), "magic");
                addToOutput("Use CAST [spell name] to cast a spell.");
            }
            
            addToOutput(`HP: ${player.currentHP}/${player.maxHP} | MP: ${player.currentMP}/${player.maxMP}`, "health");
            addToOutput(`Gold: ${player.gold}`, "gold");
        }

        // Take item
        function takeItem(itemName) {
            if (!itemName) {
                addToOutput("Take what?");
                return;
            }
            
            const loc = locations[gameState.currentLocation];
            const itemIndex = loc.items.findIndex(item => item.toLowerCase().includes(itemName.toLowerCase()));
            
            if (itemIndex === -1) {
                addToOutput(`I don't see a ${itemName} here.`);
                return;
            }
            
            const item = loc.items[itemIndex];
            
            // Handle specific items
            if (item === "rusty sword") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.guardRoom.swordTaken = true;
                addToOutput(`You take the rusty sword!`);
                addToOutput("You can EQUIP RUSTY SWORD to use it as a weapon.", "hint");
            } else if (item === "steel sword") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                addToOutput(`You take the steel sword!`);
                addToOutput("This is much better than your rusty sword! Damage: 8-12", "victory");
            } else if (item === "enchanted dagger") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                addToOutput(`You take the enchanted dagger!`, "magic");
                addToOutput("It glows with magical energy. Damage: 7-10", "magic");
            } else if (item === "scroll of fireball") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                addToOutput(`You take the scroll of fireball!`, "magic");
                addToOutput("READ SCROLL to learn the fireball spell.", "hint");
            } else if (item === "iron key") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.dungeonCell.keyTaken = true;
                addToOutput(`You take the iron key!`);
                addToOutput("This might unlock something.", "hint");
            } else if (item === "silver key") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                // Check which room we're in for state tracking
                if (gameState.currentLocation === "guardRoom") {
                    gameState.guardRoom.silverKeyTaken = true;
                }
                addToOutput(`You take the delicate silver key!`, "victory");
                addToOutput("It feels warm to the touch.", "hint");
            } else if (item === "golden key") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                addToOutput(`You take the golden key!`, "victory");
                addToOutput("This looks important. It might unlock something valuable.", "hint");
                // Update crypt entrance exit
                locations.cryptEntrance.exits.down = "upperCrypt";
            } else if (item === "health potion") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.dungeonCell.potionTaken = true;
                addToOutput(`You take the health potion!`);
                addToOutput("Use HEALTH POTION to restore 20 HP.", "hint");
            } else if (item === "potion of healing") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                addToOutput(`You take the potion of healing!`, "item");
                addToOutput("This looks more potent than a regular health potion.", "hint");
            } else if (item === "ancient scroll") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                gameState.library.scrollTaken = true;
                addToOutput(`You take the ancient scroll!`, "magic");
                addToOutput("READ SCROLL to learn its contents.", "hint");
            } else if (item.includes("ghostly essence") || item.includes("shadow essence") || 
                       item.includes("spider silk") || item.includes("holy symbol") || 
                       item.includes("stone heart")) {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                addToOutput(`You take the ${item}!`, "item");
                addToOutput("This might be useful for something.", "hint");
            } else if (item === "crown of the damned") {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                addToOutput(`You take the Crown of the Damned!`, "victory");
                addToOutput("A powerful artifact! This might be the key to escaping the castle.", "magic");
            } else {
                loc.items.splice(itemIndex, 1);
                player.inventory.push(item);
                addToOutput(`You take the ${item}.`);
            }
            
            updateStatus();
        }

        // Drop item
        function dropItem(itemName) {
            if (!itemName) {
                addToOutput("Drop what?");
                return;
            }
            
            const itemIndex = player.inventory.findIndex(item => item.toLowerCase().includes(itemName.toLowerCase()));
            
            if (itemIndex === -1) {
                addToOutput(`You're not carrying a ${itemName}.`);
                return;
            }
            
            const item = player.inventory[itemIndex];
            
            // Check if it's equipped
            if (player.weapon.name.toLowerCase() === item.toLowerCase()) {
                addToOutput("You must unequip the item first!");
                return;
            }
            
            player.inventory.splice(itemIndex, 1);
            locations[gameState.currentLocation].items.push(item);
            
            // Update game state
            if (item === "iron key") gameState.dungeonCell.keyTaken = false;
            if (item === "health potion") gameState.dungeonCell.potionTaken = false;
            if (item === "rusty sword") gameState.guardRoom.swordTaken = false;
            if (item === "silver key") {
                if (gameState.currentLocation === "guardRoom") {
                    gameState.guardRoom.silverKeyTaken = false;
                }
            }
            if (item === "golden key") {
                // Update crypt entrance exit
                locations.cryptEntrance.exits.down = null;
            }
            if (item === "ancient scroll") gameState.library.scrollTaken = false;
            
            addToOutput(`You drop the ${item}.`);
            updateStatus();
        }

        // Examine object - This would need to be expanded for all 23 rooms
        // For brevity, I'll show the pattern and you can expand as needed
        function examineObject(objectName) {
            if (!objectName) {
                addToOutput("Examine what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            const loc = locations[gameState.currentLocation];
            
            // Check inventory
            const inventoryItem = player.inventory.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (inventoryItem) {
                if (objectDescriptions[inventoryItem]) {
                    addToOutput(objectDescriptions[inventoryItem]);
                } else {
                    addToOutput(`You examine the ${inventoryItem}. It's in your inventory.`);
                }
                return;
            }
            
            // Check location items
            const locationItem = loc.items.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (locationItem) {
                if (objectDescriptions[locationItem]) {
                    addToOutput(objectDescriptions[locationItem]);
                } else {
                    addToOutput(`You examine the ${locationItem}.`);
                }
                return;
            }
            
            // DUNGEON CELL EXAMINATIONS
            if (gameState.currentLocation === "dungeonCell") {
                if (objectLower.includes("bed") || objectLower.includes("straw")) {
                    gameState.dungeonCell.bedExamined = true;
                    if (!gameState.dungeonCell.keyTaken && !loc.items.includes('iron key')) {
                        addToOutput("You search through the musty straw bed. Underneath, you find an IRON KEY!");
                        loc.items.push('iron key');
                    } else {
                        addToOutput("The straw bed is old and uncomfortable. Nothing else of interest here.");
                    }
                    return;
                }
                
                if (objectLower.includes("barrel")) {
                    addToOutput("The rusty barrel is empty, but you notice something odd about the wall behind it.");
                    addToOutput("There appears to be a LOOSE BRICK in the wall.");
                    return;
                }
                
                if (objectLower.includes("brick") || objectLower.includes("loose")) {
                    gameState.dungeonCell.brickExamined = true;
                    if (!gameState.dungeonCell.potionTaken && !loc.items.includes('health potion')) {
                        addToOutput("You pry the loose brick from the wall. Behind it, you find a HEALTH POTION!");
                        loc.items.push('health potion');
                        gameState.dungeonCell.looseBrickFound = true;
                    } else {
                        addToOutput("You've already removed the loose brick.");
                    }
                    return;
                }
            }
            
            // THRONE ROOM EXAMINATIONS
            if (gameState.currentLocation === "throneRoom") {
                if (objectLower.includes("throne")) {
                    gameState.throneRoom.throneExamined = true;
                    addToOutput("The throne is made of dark wood inlaid with silver. Upon closer inspection,");
                    addToOutput("you notice a hidden compartment under the armrest!");
                    
                    if (!loc.items.includes('royal seal')) {
                        loc.items.push('royal seal');
                        addToOutput("Inside, you find the ROYAL SEAL!", "victory");
                    }
                    return;
                }
                
                if (objectLower.includes("tapestry")) {
                    gameState.throneRoom.tapestryExamined = true;
                    addToOutput("The tapestry shows the castle in its prime. Looking behind it,");
                    addToOutput("you discover a SECRET PASSAGE!");
                    gameState.throneRoom.secretDoorFound = true;
                    locations.throneRoom.exits.north = "secretPassage";
                    addToOutput("A new exit to the NORTH has been revealed!", "hint");
                    return;
                }
            }
            
            // KITCHEN EXAMINATIONS
            if (gameState.currentLocation === "kitchen") {
                if (objectLower.includes("pantry")) {
                    gameState.kitchen.pantryExamined = true;
                    addToOutput("The pantry is filled with empty shelves. However, in one corner,");
                    addToOutput("you find a wheel of CHEESE that's somehow still fresh!");
                    
                    if (!gameState.kitchen.cheeseTaken && !loc.items.includes('cheese wheel')) {
                        loc.items.push('cheese wheel');
                    }
                    return;
                }
                
                if (objectLower.includes("pot") || objectLower.includes("cooking")) {
                    addToOutput("The large iron cooking pot hangs over cold ashes.");
                    addToOutput("Something glints at the bottom...");
                    
                    if (!loc.items.includes('silver necklace')) {
                        loc.items.push('silver necklace');
                        addToOutput("You find a SILVER NECKLACE!", "item");
                    }
                    return;
                }
            }
            
            // ARMORY EXAMINATIONS
            if (gameState.currentLocation === "armory") {
                if (objectLower.includes("dummy") || objectLower.includes("training")) {
                    gameState.armory.trainingDummyUsed = true;
                    addToOutput("You practice your attacks on the training dummy.");
                    addToOutput("Your combat skills feel sharper!");
                    return;
                }
                
                if (objectLower.includes("weapon") || objectLower.includes("rack")) {
                    gameState.armory.weaponsExamined = true;
                    addToOutput("The weapon racks hold various swords and axes.");
                    addToOutput("One STEEL SWORD looks particularly well-maintained.");
                    
                    if (!loc.items.includes('steel sword')) {
                        loc.items.push('steel sword');
                    }
                    return;
                }
                
                if (objectLower.includes("armor") || objectLower.includes("stand")) {
                    addToOutput("The armor stand holds a suit of plate armor, but it's too heavy to carry.");
                    addToOutput("However, you notice a set of LEATHER ARMOR hanging nearby.");
                    
                    if (!gameState.armory.armorTaken && !loc.items.includes('leather armor')) {
                        loc.items.push('leather armor');
                    }
                    return;
                }
            }
            
            // BARRACKS EXAMINATIONS
            if (gameState.currentLocation === "barracks") {
                if (objectLower.includes("bed")) {
                    gameState.barracks.bedsExamined = true;
                    addToOutput("The soldier's beds are simple and uncomfortable.");
                    addToOutput("Under one pillow, you find an IRON HELMET!");
                    
                    if (!loc.items.includes('iron helmet')) {
                        loc.items.push('iron helmet');
                    }
                    return;
                }
                
                if (objectLower.includes("footlocker")) {
                    gameState.barracks.footlockerOpened = true;
                    addToOutput("You open the footlocker. Inside, you find an OLD JOURNAL!");
                    
                    if (!loc.items.includes('old journal')) {
                        loc.items.push('old journal');
                    }
                    return;
                }
            }
            
            // LIBRARY EXAMINATIONS
            if (gameState.currentLocation === "library") {
                // Check for bookshelf/bookshelves
                if (objectLower.includes("bookshelf") || objectLower.includes("bookshelves") || objectLower.includes("shelf")) {
                    addToOutput("The bookshelves are filled with ancient tomes on magic, history, and dark arts.");
                    addToOutput("Most are too damaged to read, but one DUSTY TOME looks intact.");
                    return;
                }
                
                if (objectLower.includes("fireplace")) {
                    gameState.library.fireplaceExamined = true;
                    addToOutput("The large stone fireplace is filled with cold ashes from long-dead fires.");
                    
                    if (!loc.items.includes('silver key') && player.inventory.includes('silver key')) {
                        addToOutput("As you examine the ashes, you notice the silver key in your pocket begins to glow!");
                        addToOutput("Perhaps the key has something to do with this fireplace...", "hint");
                    }
                    return;
                }
                
                if (objectLower.includes("tome")) {
                    gameState.library.tomeExamined = true;
                    addToOutput("The dusty tome is titled 'Healing Arts of the Ancient Mages'.");
                    addToOutput("Reading it might teach you something useful.", "hint");
                    addToOutput("You could READ TOME to learn from it.");
                    return;
                }
                
                if (objectLower.includes("librarian")) {
                    addToOutput("An elderly librarian with spectacles perched on his nose. He seems absorbed in his work.");
                    addToOutput("You could TALK LIBRARIAN to speak with him.");
                    return;
                }
            }
            
            // Check general object descriptions
            if (objectDescriptions[objectLower]) {
                addToOutput(objectDescriptions[objectLower]);
                return;
            }
            
            // Partial matches
            for (const [objKey, description] of Object.entries(objectDescriptions)) {
                if (objKey.includes(objectLower) || objectLower.includes(objKey)) {
                    addToOutput(description);
                    return;
                }
            }
            
            // Direction check
            if (['north', 'south', 'east', 'west', 'up', 'down'].includes(objectLower)) {
                const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
                if (exits.includes(objectLower)) {
                    addToOutput(`You look ${objectLower}. You can go that way.`);
                } else {
                    addToOutput(`You look ${objectLower}. You cannot go that way.`);
                }
                return;
            }
            
            addToOutput(`You don't see a ${objectName} here.`);
        }

        // Use item
        function useItem(objectName) {
            if (!objectName) {
                addToOutput("Use what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Check if using health potion
            if ((objectLower.includes("health potion") || objectLower.includes("potion of healing")) && 
                (player.inventory.includes("health potion") || player.inventory.includes("potion of healing"))) {
                
                let potionIndex = player.inventory.indexOf("health potion");
                let healAmount = 20;
                let potionName = "health potion";
                
                if (potionIndex === -1) {
                    potionIndex = player.inventory.indexOf("potion of healing");
                    healAmount = 40;
                    potionName = "potion of healing";
                }
                
                if (potionIndex > -1) {
                    player.inventory.splice(potionIndex, 1);
                    player.currentHP = Math.min(player.maxHP, player.currentHP + healAmount);
                    addToOutput(`You drink the ${potionName}. It restores ${healAmount} HP!`, "health");
                    updateStatus();
                    return;
                }
            }
            
            // Check if using torch
            if (objectLower.includes("torch") && player.inventory.includes("torch")) {
                addToOutput("You light the torch. It provides a warm, flickering light.");
                addToOutput("The light might help you see hidden things.", "hint");
                return;
            }
            
            // Check if using key on crypt gate
            if ((objectLower.includes("golden key") || objectLower.includes("key")) && 
                gameState.currentLocation === "cryptEntrance") {
                
                if (!player.inventory.includes("golden key")) {
                    addToOutput("You don't have a golden key.");
                    return;
                }
                
                addToOutput("You use the golden key on the iron gate.", "player");
                addToOutput("The lock clicks open! The gate swings inward.", "victory");
                addToOutput("You can now go DOWN into the crypt.");
                locations.cryptEntrance.exits.down = "upperCrypt";
                updateStatus();
                return;
            }
            
            // Check if using cheese (could be used for something later)
            if (objectLower.includes("cheese") && player.inventory.includes("cheese wheel")) {
                addToOutput("The cheese looks delicious, but you're not hungry right now.");
                addToOutput("It might be useful for something else.", "hint");
                return;
            }
            
            // Check if using mysterious potion
            if (objectLower.includes("mysterious potion") && player.inventory.includes("mysterious potion")) {
                const potionIndex = player.inventory.indexOf("mysterious potion");
                player.inventory.splice(potionIndex, 1);
                
                // Random effect
                const effect = Math.floor(Math.random() * 3);
                if (effect === 0) {
                    player.currentHP = Math.min(player.maxHP, player.currentHP + 30);
                    addToOutput("You drink the mysterious potion. It tastes sweet and restores 30 HP!", "health");
                } else if (effect === 1) {
                    player.currentHP = Math.max(0, player.currentHP - 15);
                    addToOutput("You drink the mysterious potion. It tastes foul and you lose 15 HP!", "health");
                } else {
                    player.maxMP += 5;
                    player.currentMP = player.maxMP;
                    addToOutput("You drink the mysterious potion. Your mind expands! Max MP increased by 5!", "magic");
                }
                updateStatus();
                return;
            }
            
            addToOutput(`You're not sure how to use the ${objectName} here.`);
        }

        // Equip item
        function equipItem(itemName) {
            if (!itemName) {
                addToOutput("Equip what?");
                return;
            }
            
            const objectLower = itemName.toLowerCase();
            
            // Check if it's in inventory
            const inventoryItem = player.inventory.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (!inventoryItem) {
                addToOutput(`You don't have a ${itemName}.`);
                return;
            }
            
            // Handle weapons
            if (inventoryItem === "rusty sword") {
                player.weapon = {
                    name: "Rusty Sword",
                    minDamage: 6,
                    maxDamage: 9,
                    type: "melee"
                };
                player.equippedItems.weapon = "Rusty Sword";
                addToOutput(`You equip the rusty sword! (Damage: 6-9)`, "player");
                updateStatus();
                return;
            }
            
            if (inventoryItem === "steel sword") {
                player.weapon = {
                    name: "Steel Sword",
                    minDamage: 8,
                    maxDamage: 12,
                    type: "melee"
                };
                player.equippedItems.weapon = "Steel Sword";
                addToOutput(`You equip the steel sword! (Damage: 8-12)`, "player");
                updateStatus();
                return;
            }
            
            if (inventoryItem === "enchanted dagger") {
                player.weapon = {
                    name: "Enchanted Dagger",
                    minDamage: 7,
                    maxDamage: 10,
                    type: "magic"
                };
                player.equippedItems.weapon = "Enchanted Dagger";
                addToOutput(`You equip the enchanted dagger! (Damage: 7-10 + magical)`, "magic");
                updateStatus();
                return;
            }
            
            if (inventoryItem === "fists") {
                player.weapon = {
                    name: "Fists",
                    minDamage: 4,
                    maxDamage: 6,
                    type: "melee"
                };
                player.equippedItems.weapon = "Fists";
                addToOutput(`You equip your fists! (Damage: 4-6)`, "player");
                updateStatus();
                return;
            }
            
            // Handle armor
            if (inventoryItem === "leather armor") {
                player.equippedItems.armor = "Leather Armor";
                player.maxHP += 10;
                player.currentHP += 10;
                addToOutput(`You equip the leather armor! Max HP increased by 10!`, "player");
                updateStatus();
                return;
            }
            
            if (inventoryItem === "iron helmet") {
                player.equippedItems.accessory = "Iron Helmet";
                addToOutput(`You equip the iron helmet! You feel more protected.`, "player");
                return;
            }
            
            addToOutput(`You can't equip the ${inventoryItem}.`);
        }

        // Unequip item
        function unequipItem(itemName) {
            if (!itemName) {
                addToOutput("Unequip what?");
                return;
            }
            
            const objectLower = itemName.toLowerCase();
            
            // Check if it's equipped as weapon
            if (player.weapon.name.toLowerCase().includes(objectLower)) {
                // Check if we have fists in inventory (we always do)
                player.weapon = {
                    name: "Fists",
                    minDamage: 4,
                    maxDamage: 6,
                    type: "melee"
                };
                player.equippedItems.weapon = "Fists";
                addToOutput(`You unequip your weapon and use your fists.`, "player");
                updateStatus();
                return;
            }
            
            // Check if it's equipped as armor
            if (player.equippedItems.armor && player.equippedItems.armor.toLowerCase().includes(objectLower)) {
                player.equippedItems.armor = null;
                player.maxHP = Math.max(50, player.maxHP - 10);
                player.currentHP = Math.min(player.currentHP, player.maxHP);
                addToOutput(`You unequip your armor.`, "player");
                updateStatus();
                return;
            }
            
            // Check if it's equipped as accessory
            if (player.equippedItems.accessory && player.equippedItems.accessory.toLowerCase().includes(objectLower)) {
                player.equippedItems.accessory = null;
                addToOutput(`You unequip your accessory.`, "player");
                return;
            }
            
            addToOutput(`You don't have ${itemName} equipped.`);
        }

        // Open object
        function openObject(objectName) {
            if (!objectName) {
                addToOutput("Open what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            if (objectLower.includes("door")) {
                const loc = locations[gameState.currentLocation];
                const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
                
                if (exits.length > 0) {
                    addToOutput("The door is already open.");
                } else {
                    addToOutput("There's no door to open here.");
                }
                return;
            }
            
            if (objectLower.includes("chest") && gameState.currentLocation === "hiddenVault") {
                addToOutput("You open the treasure chest! It's filled with gold!");
                player.gold += 100;
                addToOutput("You find 100 gold!", "gold");
                updateStatus();
                return;
            }
            
            addToOutput(`You can't open the ${objectName}.`);
        }

        // Read object
        function readObject(objectName) {
            if (!objectName) {
                addToOutput("Read what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Read spellbook
            if ((objectLower.includes("spellbook") || objectLower.includes("spell book")) && 
                player.inventory.includes("leather bound spellbook")) {
                
                addToOutput("You open your spellbook:", "magic");
                addToOutput(" ");
                
                if (player.spells.length === 0) {
                    addToOutput("The spellbook is empty.", "magic");
                } else {
                    player.spells.forEach(spellName => {
                        const spell = spells[spellName];
                        if (spell) {
                            addToOutput(`${spell.name.toUpperCase()}: ${spell.description}`, "magic");
                            addToOutput(`  MP Cost: ${spell.cost}`, "magic");
                        }
                    });
                }
                
                addToOutput(" ");
                addToOutput("Use CAST [spell name] to cast a spell.", "hint");
                return;
            }
            
            // Read scroll - FIXED CONDITION
            if (objectLower.includes("scroll")) {
                // Check if player has the ancient scroll
                const hasAncientScroll = player.inventory.includes("ancient scroll");
                const hasFireballScroll = player.inventory.includes("scroll of fireball");
                const hasScroll = player.inventory.some(item => item.toLowerCase().includes("scroll"));
                
                if (hasAncientScroll) {
                    if (!gameState.library.healSpellLearned) {
                        gameState.library.healSpellLearned = true;
                        
                        // Learn heal spell
                        if (!player.spells.includes("heal")) {
                            player.spells.push("heal");
                            addToOutput("You read the ancient scroll...", "magic");
                            addToOutput("It contains instructions for a healing spell!", "magic");
                            addToOutput("You have learned the HEAL spell!", "victory");
                            addToOutput("Use CAST HEAL to restore your health.", "hint");
                            
                            // Remove scroll from inventory
                            const scrollIndex = player.inventory.indexOf("ancient scroll");
                            player.inventory.splice(scrollIndex, 1);
                        }
                    } else {
                        addToOutput("You've already learned from this scroll.");
                    }
                } else if (hasFireballScroll) {
                    // Learn fireball spell
                    if (!player.spells.includes("fireball")) {
                        player.spells.push("fireball");
                        addToOutput("You read the scroll of fireball...", "magic");
                        addToOutput("It contains instructions for a powerful fire spell!", "magic");
                        addToOutput("You have learned the FIREBALL spell!", "victory");
                        addToOutput("Use CAST FIREBALL to unleash fiery destruction!", "hint");
                        
                        // Remove scroll from inventory
                        const scrollIndex = player.inventory.indexOf("scroll of fireball");
                        player.inventory.splice(scrollIndex, 1);
                    } else {
                        addToOutput("You've already learned from this scroll.");
                    }
                } else if (hasScroll) {
                    // Check for any other scroll
                    const scrollItem = player.inventory.find(item => item.toLowerCase().includes("scroll"));
                    addToOutput(`You read the ${scrollItem}, but it's written in a language you don't understand.`);
                } else {
                    addToOutput("You don't have a scroll to read.");
                }
                return;
            }
            
            // Read tome
            if (objectLower.includes("tome") && gameState.currentLocation === "library") {
                if (gameState.library.tomeExamined) {
                    addToOutput("You spend some time studying the dusty tome...");
                    addToOutput("It contains advanced magical theory, but nothing practical you can use right now.");
                    addToOutput("However, you feel your magical knowledge has increased slightly.", "magic");
                    
                    // Small MP increase for studying
                    player.maxMP += 2;
                    player.currentMP = Math.min(player.maxMP, player.currentMP + 2);
                    addToOutput(`Your maximum MP has increased by 2! (Now: ${player.maxMP})`, "magic");
                    updateStatus();
                } else {
                    addToOutput("You need to examine the tome first.");
                }
                return;
            }
            
            // Read journal
            if (objectLower.includes("journal") && player.inventory.includes("old journal")) {
                addToOutput("You read the old journal:");
                addToOutput("'Day 45: The castle grows stranger each day. The lord's madness spreads.'");
                addToOutput("'Day 47: I heard chanting from the chapel at midnight. Something is wrong.'");
                addToOutput("'Day 49: The guards' eyes... they glow now. I must escape.'");
                addToOutput("'Day 50: Found a secret passage behind the throne. My only hope.'");
                addToOutput("The journal ends abruptly.");
                return;
            }
            
            addToOutput(`There's nothing to read on the ${objectName}.`);
        }

        // Cast spell
        function castSpell(spellName) {
            if (!spellName) {
                addToOutput("Cast what spell?");
                return;
            }
            
            const spellLower = spellName.toLowerCase();
            
            // Find the spell
            let spellToCast = null;
            let spellKey = null;
            
            for (const [key, spell] of Object.entries(spells)) {
                if (spell.name.toLowerCase().includes(spellLower) || spellLower.includes(key)) {
                    spellToCast = spell;
                    spellKey = key;
                    break;
                }
            }
            
            if (!spellToCast) {
                // Check if player knows a spell with similar name
                const knownSpell = player.spells.find(s => 
                    s.toLowerCase().includes(spellLower) || spellLower.includes(s.toLowerCase())
                );
                
                if (knownSpell) {
                    spellToCast = spells[knownSpell];
                    spellKey = knownSpell;
                }
            }
            
            if (!spellToCast) {
                addToOutput(`You don't know the spell '${spellName}'.`, "magic");
                return;
            }
            
            // Check if player has enough MP
            if (player.currentMP < spellToCast.cost) {
                addToOutput(`Not enough MP! You need ${spellToCast.cost} MP to cast ${spellToCast.name}.`, "magic");
                return;
            }
            
            // Deduct MP and cast spell
            player.currentMP -= spellToCast.cost;
            addToOutput(`You cast ${spellToCast.name}! (${spellToCast.cost} MP used)`, "magic");
            
            // Execute spell effect
            const success = spellToCast.effect();
            
            if (success) {
                updateStatus();
            }
        }

        // Talk to NPC
        function talkTo(objectName) {
            if (!objectName) {
                addToOutput("Talk to who?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Talking to librarian in library
            if ((objectLower.includes("librarian")) && gameState.currentLocation === "library") {
                
                if (!gameState.library.librarianTalked) {
                    addToOutput("You approach the elderly librarian.", "npc");
                    addToOutput("Librarian: 'Ah, a visitor! Rare to see new faces in these cursed halls.'", "npc");
                    addToOutput("Librarian: 'Be careful, the castle is not what it seems. Time flows strangely here.'", "npc");
                    addToOutput("Librarian: 'If you find any magical artifacts, I might be able to tell you about them.'", "npc");
                    gameState.library.librarianTalked = true;
                } else {
                    addToOutput("Librarian: 'Back again? Have you found anything interesting?'", "npc");
                    
                    // Check if player has shadow essence
                    if (player.inventory.includes("shadow essence")) {
                        addToOutput("You show the shadow essence to the librarian.", "player");
                        addToOutput("Librarian: 'Ah, shadow essence! Rare and dangerous.',", "npc");
                        addToOutput("Librarian: 'It can be used to create powerful darkness magic,", "npc");
                        addToOutput("Librarian: 'but you'll need a proper alchemy lab to refine it.'", "npc");
                    }
                    
                    // Check if player has ghostly essence
                    if (player.inventory.includes("ghostly essence")) {
                        addToOutput("You show the ghostly essence to the librarian.", "player");
                        addToOutput("Librarian: 'Ghostly essence! This comes from spectral beings.',", "npc");
                        addToOutput("Librarian: 'It can be used to create potions of invisibility.'", "npc");
                    }
                }
                return;
            }
            
            if (objectLower.includes("guard") && combatActive) {
                addToOutput("The corrupted guard snarls and attacks! He's beyond reasoning with!", "enemy");
                return;
            }
            
            addToOutput("There's no one here to talk to.");
        }

        // Give item
        function giveItem(objectName) {
            if (!objectName) {
                addToOutput("Give what?");
                return;
            }
            
            const parts = objectName.toLowerCase().split(' to ');
            if (parts.length < 2) {
                addToOutput("Give what to whom?");
                return;
            }
            
            const itemName = parts[0].trim();
            const recipient = parts[1].trim();
            
            // Giving shadow essence to librarian
            if (recipient.includes("librarian") && gameState.currentLocation === "library") {
                if (!itemName.includes("shadow") && !itemName.includes("essence")) {
                    addToOutput("The librarian isn't interested in that.");
                    return;
                }
                
                if (!player.inventory.includes("shadow essence")) {
                    addToOutput("You don't have any shadow essence.");
                    return;
                }
                
                // Give shadow essence to librarian
                const essenceIndex = player.inventory.indexOf("shadow essence");
                player.inventory.splice(essenceIndex, 1);
                
                addToOutput("You give the shadow essence to the librarian.", "player");
                addToOutput("Librarian: 'Thank you! This is quite valuable.',", "npc");
                addToOutput("Librarian: 'Let me give you something in return.'", "npc");
                addToOutput("The librarian gives you 25 gold and teaches you the INVISIBILITY spell!", "victory");
                
                player.gold += 25;
                
                // Learn invisibility spell if not already known
                if (!player.spells.includes("invisibility")) {
                    player.spells.push("invisibility");
                    addToOutput("You have learned the INVISIBILITY spell!", "magic");
                }
                
                updateStatus();
                return;
            }
            
            addToOutput("There's no one here to give anything to.");
        }

        // Attack enemy
        function attackEnemy(objectName) {
            if (!objectName) {
                addToOutput("Attack what?");
                return;
            }
            
            if (combatActive) {
                playerAttack();
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // If in dungeon cell and trying to attack guard
            if (gameState.currentLocation === "dungeonCell" && objectLower.includes("guard")) {
                addToOutput("You can't attack the guard from here. You need to go north to face him.");
                return;
            }
            
            // If in guard room and guard is not defeated
            if ((objectLower.includes("guard")) && 
                gameState.currentLocation === "guardRoom" && !gameState.guardRoom.guardDefeated) {
                // Start combat if not already in combat
                if (!combatActive) {
                    startCombat("corruptedGuard");
                }
                return;
            }
            
            // If in main hall and spectral knight is present
            if ((objectLower.includes("knight") || objectLower.includes("spectral")) && 
                gameState.currentLocation === "mainHall" && locations.mainHall.enemy === "spectralKnight") {
                // Start combat if not already in combat
                if (!combatActive) {
                    startCombat("spectralKnight");
                }
                return;
            }
            
            // If in kitchen and spider is present
            if ((objectLower.includes("spider") || objectLower.includes("giant")) && 
                gameState.currentLocation === "kitchen" && locations.kitchen.enemy === "giantSpider") {
                // Start combat if not already in combat
                if (!combatActive) {
                    startCombat("giantSpider");
                }
                return;
            }
            
            // If in wine cellar and cursed priest is present
            if ((objectLower.includes("priest") || objectLower.includes("cursed")) && 
                gameState.currentLocation === "wineCellar" && locations.wineCellar.enemy === "cursedPriest") {
                // Start combat if not already in combat
                if (!combatActive) {
                    startCombat("cursedPriest");
                }
                return;
            }
            
            // If in lower crypt and stone golem is present
            if ((objectLower.includes("golem") || objectLower.includes("stone")) && 
                gameState.currentLocation === "lowerCrypt" && locations.lowerCrypt.enemy === "stoneGolem") {
                // Start combat if not already in combat
                if (!combatActive) {
                    startCombat("stoneGolem");
                }
                return;
            }
            
            addToOutput("There's nothing to attack here.");
        }

        // Show help
        function showHelp() {
            addToOutput("CASTLE OF THE DAMMED 1984 - COMMANDS", "location");
            addToOutput("Movement: NORTH, SOUTH, EAST, WEST, UP, DOWN (or N, S, E, W, U, D)");
            addToOutput("Basic: LOOK, EXAMINE [object], TAKE [item], DROP [item], INVENTORY");
            addToOutput("Equipment: EQUIP [weapon/armor], UNEQUIP [item]");
            addToOutput("Interactive: USE [item], OPEN [object], READ [object], TALK [NPC], GIVE [item] TO [NPC]");
            addToOutput("Magic: CAST [spell name] (requires MP)", "magic");
            addToOutput("COMBAT: ATTACK (in combat)", "combat");
            addToOutput("Game: SAVE, LOAD, RESTART, HELP, QUIT");
            addToOutput(" ");
            addToOutput("EXPLORATION TIPS:", "hint");
            addToOutput("- Examine EVERYTHING! Many secrets are hidden in plain sight", "hint");
            addToOutput("- Talk to the librarian for information and quests", "hint");
            addToOutput"- Search for hidden items in every room", "hint");
            addToOutput("- Better weapons and armor can be found throughout the castle", "hint");
            addToOutput("- Learn new spells from scrolls", "magic");
            addToOutput("- Save your game often with the SAVE command", "hint");
        }

        // Quit game
        function quitGame() {
            addToOutput("Are you sure you want to quit? Your progress is saved automatically. (Y/N)");
            
            const originalEventHandler = gameInput.onkeypress;
            
            gameInput.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    const answer = this.value.trim().toLowerCase();
                    if (answer === 'y' || answer === 'yes') {
                        addToOutput("Thanks for playing Castle of the Dammed 1984!");
                        gameState.gameEnded = true;
                    } else {
                        addToOutput("Resuming game...");
                    }
                    
                    gameInput.onkeypress = originalEventHandler;
                    gameInput.value = '';
                    gameInput.focus();
                }
            };
        }

        // Initialize the game when the page loads
        window.onload = initGame;
    </script>
</body>
</html>
