<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle of the Dammed 1982</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            overflow-x: hidden;
        }
        
        .game-container {
            border: 2px solid #fff;
            padding: 20px;
            margin-top: 20px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px dashed #fff;
            padding-bottom: 10px;
        }
        
        .game-title {
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #fff;
        }
        
        .game-subtitle {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }
        
        .game-output {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
            border: 1px solid #333;
            padding: 15px;
            background-color: #111;
        }
        
        .game-output p {
            margin-bottom: 10px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .game-output .location {
            color: #ffff00;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .game-output .hint {
            color: #888;
            font-style: italic;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .game-output .enemy {
            color: #ff5555;
        }
        
        .game-output .npc {
            color: #55ff55;
        }
        
        .game-output .combat {
            color: #ff4444;
            font-weight: bold;
        }
        
        .game-output .player {
            color: #55ffff;
        }
        
        .game-output .health {
            color: #ff6666;
        }
        
        .game-output .damage {
            color: #ff9966;
        }
        
        .game-output .victory {
            color: #ffff55;
            font-weight: bold;
        }
        
        .game-output .defeat {
            color: #ff5555;
            font-weight: bold;
        }
        
        .game-output .gold {
            color: #ffd700;
        }
        
        .game-output .shop {
            color: #ffaa00;
        }
        
        .game-output .magic {
            color: #ff66ff;
        }
        
        .game-output .item {
            color: #55ff55;
        }
        
        .game-input-container {
            display: flex;
            align-items: center;
            border-top: 1px dashed #fff;
            padding-top: 15px;
        }
        
        .game-prompt {
            margin-right: 10px;
            color: #00ff00;
        }
        
        #game-input {
            background-color: #000;
            color: #fff;
            border: 1px solid #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            padding: 10px;
            flex-grow: 1;
            outline: none;
        }
        
        #game-input:focus {
            box-shadow: 0 0 5px #fff;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Scrollbar styling */
        .game-output::-webkit-scrollbar {
            width: 10px;
        }
        
        .game-output::-webkit-scrollbar-track {
            background: #111;
        }
        
        .game-output::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 5px;
        }
        
        .game-output::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
        
        /* Status bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #222;
            border: 1px solid #444;
            font-size: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
        }
        
        .health-bar {
            width: 100px;
            height: 12px;
            background-color: #333;
            margin-left: 5px;
            border: 1px solid #555;
        }
        
        .health-fill {
            height: 100%;
            background-color: #ff5555;
            transition: width 0.3s;
        }
        
        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                font-size: 14px;
                padding: 10px;
            }
            
            .game-title {
                font-size: 18px;
            }
            
            .game-container {
                padding: 10px;
            }
            
            #game-input {
                font-size: 12px;
                padding: 8px;
            }
            
            .status-bar {
                font-size: 10px;
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1 class="game-title">CASTLE OF THE DAMMED</h1>
        <p class="game-subtitle">Â© 1982 Dark Castle Software</p>
        <p class="game-subtitle">Text Adventure v3.2 - HORSE STABLES ADDED</p>
    </div>
    
    <div class="status-bar" id="status-bar">
        <div class="status-item">
            HP: <span id="player-hp-text">25/25</span>
            <div class="health-bar">
                <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
            </div>
        </div>
        <div class="status-item">
            Weapon: <span id="player-weapon">Fists</span>
        </div>
        <div class="status-item">
            Gold: <span id="player-gold">10</span>
        </div>
        <div class="status-item">
            Enemy HP: <span id="enemy-hp-text">-</span>
            <div class="health-bar">
                <div class="health-fill" id="enemy-health-fill" style="width: 0%; background-color: #ff9966;"></div>
            </div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="game-output" id="game-output">
            <!-- Game text will appear here -->
        </div>
        
        <div class="game-input-container">
            <span class="game-prompt">&gt;</span>
            <input type="text" id="game-input" placeholder="Type your command..." autocomplete="off">
        </div>
    </div>

    <script>
        // ==================== COMBAT SYSTEM ====================
        
        // Player stats
        const player = {
            maxHP: 25,
            currentHP: 25,
            gold: 10,
            weapon: {
                name: "Fists",
                minDamage: 4,
                maxDamage: 6
            },
            inventory: [],
            spells: [], // Track learned spells
            hasAmuletOfDawn: false // For spellcasting
        };
        
        // Enemy types
        const enemies = {
            goblin: {
                name: "Forest Goblin",
                maxHP: 10,
                currentHP: 10,
                minDamage: 2,
                maxDamage: 4,
                description: "A small, green-skinned goblin with sharp teeth and beady red eyes.",
                defeatMessage: "The goblin squeals and runs off into the forest!",
                loot: "crude dagger"
            },
            wolf: {
                name: "Hungry Wolf",
                maxHP: 12,
                currentHP: 12,
                minDamage: 3,
                maxDamage: 5,
                description: "A lean, gray wolf with bared teeth and hungry eyes.",
                defeatMessage: "The wolf yelps and retreats into the woods!",
                loot: "wolf pelt"
            },
            rat: {
                name: "Giant Black Rat",
                maxHP: 8,
                currentHP: 8,
                minDamage: 2,
                maxDamage: 4,
                description: "A massive, black-furred rat with beady red eyes and sharp yellow teeth.",
                defeatMessage: "The giant rat squeals and scurries back down the well!",
                loot: null
            },
            skeletalHorse: {
                name: "Skeletal Horse",
                maxHP: 18,
                currentHP: 18,
                minDamage: 4,
                maxDamage: 7,
                description: "A terrifying undead horse with glowing red eyes in its empty sockets.",
                defeatMessage: "The skeletal horse collapses into a pile of bones!",
                loot: null
            }
        };
        
        // Hermit's Shop Inventory
        const hermitShop = {
            items: [
                { name: "health potion", price: 5, description: "Restores 10 HP when used." },
                { name: "torch", price: 3, description: "Provides light in dark places." },
                { name: "rope", price: 4, description: "A sturdy length of rope. Useful for climbing." },
                { name: "bread loaf", price: 2, description: "A fresh loaf of bread. Restores 5 HP." },
                { name: "iron key", price: 8, description: "A sturdy iron key. Might unlock something." }
            ],
            buyItems: ["crude dagger", "wolf pelt", "rusty key"],
            buyPrices: {
                "crude dagger": 3,
                "wolf pelt": 4,
                "rusty key": 5
            }
        };
        
        // Current combat state
        let combatActive = false;
        let currentEnemy = null;
        
        // ==================== GAME STATE ====================
        const gameState = {
            currentLocation: 'outside',
            inventory: player.inventory,
            visitedLocations: ['outside'],
            gameEnded: false,
            bridgeFixed: false,
            goblinDefeated: false,
            hasLantern: false,
            wolfDefeated: false,
            foundRustyKey: false,
            examinedBridge: false,
            examinedStream: false,
            keyVisible: false,
            castleEntered: false,
            // Courtyard states
            wellExamined: false,
            bucketPulled: false,
            ratDefeated: false,
            foundNecklace: false,
            hermitTalked: false,
            // Graveyard states
            tombstonesExamined: false,
            metalObjectFound: false,
            metalObjectExamined: false,
            graveyardKeyTaken: false,
            tombstoneRead: false,
            ravenExamined: false,
            ravenTalked: false,
            breadGivenToRaven: false,
            ringTaken: false,
            gravediggerExamined: false,
            gravediggerTalkCount: 0,
            // Stables states
            stablesVisited: false,
            chestOpened: false,
            chestUnlocked: false,
            mapRead: false,
            spellbookRead: false,
            trapdoorRevealed: false,
            // Tower map exploration
            towerMapExplored: {
                entrance: false
            }
        };
        
        // Update status display
        function updateStatus() {
            document.getElementById('player-hp-text').textContent = 
                `${player.currentHP}/${player.maxHP}`;
            
            const playerHealthPercent = (player.currentHP / player.maxHP) * 100;
            document.getElementById('player-health-fill').style.width = 
                `${Math.max(0, playerHealthPercent)}%`;
            
            document.getElementById('player-weapon').textContent = player.weapon.name;
            document.getElementById('player-gold').textContent = player.gold;
            
            if (currentEnemy && combatActive) {
                document.getElementById('enemy-hp-text').textContent = 
                    `${currentEnemy.currentHP}/${currentEnemy.maxHP}`;
                
                const enemyHealthPercent = (currentEnemy.currentHP / currentEnemy.maxHP) * 100;
                document.getElementById('enemy-health-fill').style.width = 
                    `${Math.max(0, enemyHealthPercent)}%`;
                document.getElementById('enemy-health-fill').style.display = 'block';
            } else {
                document.getElementById('enemy-hp-text').textContent = '-';
                document.getElementById('enemy-health-fill').style.display = 'none';
            }
        }
        
        // Combat functions
        function startCombat(enemyType) {
            currentEnemy = JSON.parse(JSON.stringify(enemies[enemyType])); // Clone enemy
            combatActive = true;
            updateStatus();
            
            addToOutput(`A ${currentEnemy.name} appears!`, "enemy");
            addToOutput("COMBAT STARTED! Use ATTACK to fight!", "combat");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP} | ${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "combat");
        }
        
        function playerAttack() {
            if (!combatActive || !currentEnemy) {
                addToOutput("There's nothing to attack here.");
                return;
            }
            
            const playerDamage = Math.floor(
                Math.random() * (player.weapon.maxDamage - player.weapon.minDamage + 1)
            ) + player.weapon.minDamage;
            
            currentEnemy.currentHP -= playerDamage;
            currentEnemy.currentHP = Math.max(0, currentEnemy.currentHP);
            
            addToOutput(`You attack with your ${player.weapon.name} and deal ${playerDamage} damage!`, "player");
            addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
            
            if (currentEnemy.currentHP <= 0) {
                endCombat(true);
                return;
            }
            
            enemyAttack();
            updateStatus();
        }
        
        function enemyAttack() {
            const enemyDamage = Math.floor(
                Math.random() * (currentEnemy.maxDamage - currentEnemy.minDamage + 1)
            ) + currentEnemy.minDamage;
            
            player.currentHP -= enemyDamage;
            player.currentHP = Math.max(0, player.currentHP);
            
            addToOutput(`${currentEnemy.name} attacks you for ${enemyDamage} damage!`, "enemy");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP}`, "health");
            
            if (player.currentHP <= 0) {
                endCombat(false);
            }
        }
        
        function endCombat(playerWon) {
            if (playerWon) {
                addToOutput(currentEnemy.defeatMessage, "victory");
                
                if (currentEnemy.loot && !gameState.inventory.includes(currentEnemy.loot)) {
                    gameState.inventory.push(currentEnemy.loot);
                    addToOutput(`You found a ${currentEnemy.loot}!`);
                    
                    if (currentEnemy.loot === "crude dagger") {
                        player.weapon = {
                            name: "Crude Dagger",
                            minDamage: 5,
                            maxDamage: 7
                        };
                        addToOutput("You equip the crude dagger! (Damage: 5-7)", "player");
                        updateStatus();
                    }
                    
                    if (currentEnemy.loot === "rusty key") {
                        addToOutput("This key might unlock something in the castle.");
                    }
                }
                
                if (currentEnemy.name === "Forest Goblin") {
                    gameState.goblinDefeated = true;
                } else if (currentEnemy.name === "Hungry Wolf") {
                    gameState.wolfDefeated = true;
                } else if (currentEnemy.name === "Giant Black Rat") {
                    gameState.ratDefeated = true;
                    addToOutput("With the rat gone, you can safely examine the bucket now.", "hint");
                } else if (currentEnemy.name === "Skeletal Horse") {
                    addToOutput("With the skeletal horse defeated, you can now safely explore the stables.", "hint");
                }
            } else {
                addToOutput("You have been defeated!", "defeat");
                addToOutput("GAME OVER - Refresh the page to try again.", "defeat");
                gameState.gameEnded = true;
                gameInput.disabled = true;
            }
            
            combatActive = false;
            currentEnemy = null;
            updateStatus();
        }
        
        // Object descriptions
        const objectDescriptions = {
            // Weapons
            "fists": "Your bare hands. Not very effective but better than nothing. Damage: 4-6",
            "crude dagger": "A small, poorly made dagger. Better than fists. Damage: 5-7",
            "rusty key": "A rusty iron key. It might fit the castle gates.",
            
            // Outside objects
            "castle": "The Castle of the Dammed looms before you. Its dark stone walls rise ominously against the stormy sky.",
            "gates": "Massive iron gates, twenty feet tall. They stand firmly closed. A rusty keyhole is visible.",
            "forest": "A dense, dark forest surrounds the castle. Strange noises echo from within the trees.",
            "path": "A narrow dirt path leads through the forest to the castle gates.",
            "bridge": "A wooden bridge over a murky stream. Several planks are missing or broken.",
            "stream": "A fast-flowing stream with dark, murky water. It looks deep and dangerous.",
            "lantern": "An old iron lantern with a small amount of oil left. It could be lit.",
            "sign": "A weathered wooden sign. The text is barely readable.",
            "planks": "Some wooden planks scattered near the bridge. They could be used to repair it.",
            "rope": "A length of sturdy rope. Could be useful for various purposes.",
            "berries": "Some red berries growing on a bush. They look edible.",
            "mushrooms": "Strange glowing mushrooms growing in the shadows. They look poisonous.",
            "mud": "Thick, dark mud along the stream banks.",
            
            // Items
            "wolf pelt": "The pelt of a wolf. It's still warm and bloody.",
            "health potion": "A small vial containing red liquid. Restores 10 HP when used.",
            "torch": "A wooden torch wrapped in cloth. Can be lit to provide light.",
            "bread loaf": "A fresh loaf of bread. Restores 5 HP when eaten.",
            "iron key": "A sturdy iron key. Might unlock something.",
            "silver chain necklace": "A beautiful silver chain necklace with a wolf's head pendant. The wolf's eyes are red gems that seem to glow faintly.",
            "gold ring": "A gold ring with a green crystal set in it. Small engravings on the inside read: 'If worn, you summon the undead.'",
            "graveyard key": "An old, ornate key made of tarnished silver. It looks like it might fit the graveyard gate.",
            
            // Courtyard objects
            "courtyard": "A large, cobblestone courtyard surrounded by high stone walls.",
            "well": "An old stone well with a wooden bucket.",
            "bucket": "A wooden bucket attached to a rope.",
            "hermit": "An old, ragged man with a cart full of goods.",
            "cart": "A wooden cart filled with various items for sale.",
            "graveyard gate": "An iron gate leading to the castle graveyard.",
            "stables": "Stone stables that once housed the castle's horses.",
            "tower door": "A massive oak door leading to the castle tower.",
            
            // Graveyard objects
            "graveyard": "The castle graveyard, filled with old tombstones.",
            "tombstones": "Ancient tombstones marking the graves of castle inhabitants.",
            "raven": "A large black raven perched on a gate post.",
            "gravedigger": "A haggard old man digging a grave.",
            "metal object": "A metallic object partially buried in the ground.",
            "open grave": "A freshly dug grave in the ground.",
            
            // Stables objects
            "skeletal horse": "A terrifying undead horse with glowing red eyes in its empty sockets. Its bones are held together by dark magic.",
            "old locked wooden chest": "A heavy wooden chest with an ornate lock. It looks ancient and sturdy.",
            "bed of straw": "A pile of old, moldy straw that was once used for horses.",
            "castle tower key": "A large iron key with intricate designs. It looks like it would fit the main tower door.",
            "leather bound spellbook": "A thick book bound in dark leather. Strange symbols are etched into the cover.",
            "cursed map": "A parchment map that seems to shift and change as you look at it.",
            "iron trapdoor handle": "A heavy iron ring attached to a trapdoor. It looks like it leads underground.",
            "amulet of dawn": "A golden amulet with a sun symbol. It radiates magical energy."
        };

        // Game locations - UPDATED WITH TOWER ENTRANCE
        const locations = {
            outside: {
                name: "OUTSIDE THE CASTLE",
                description: function() {
                    let desc = "You stand before the CASTLE of the Dammed. Massive iron GATES stand before you, firmly closed. ";
                    desc += "A dark FOREST surrounds the area, with a narrow PATH winding through the trees. ";
                    desc += "To the north, a wooden BRIDGE crosses a murky STREAM. ";
                    
                    if (this.items.includes('lantern')) {
                        desc += "An old LANTERN hangs from a nearby tree.";
                    }
                    
                    if (this.items.includes('planks')) {
                        desc += " Some wooden PLANKS are scattered near the bridge.";
                    }
                    
                    if (this.items.includes('rope')) {
                        desc += " A length of ROPE lies on the ground.";
                    }
                    
                    if (this.items.includes('sign')) {
                        desc += " A weathered SIGN stands by the path.";
                    }
                    
                    if (!gameState.goblinDefeated && this.enemy === "goblin") {
                        desc += " A small green GOBLIN is lurking near the bridge!";
                    }
                    
                    if (!gameState.wolfDefeated && this.enemy === "wolf") {
                        desc += " A hungry WOLF watches you from the forest's edge!";
                    }
                    
                    return desc;
                },
                items: ["lantern", "planks", "rope", "sign"],
                exits: {
                    north: "bridge",
                    south: "forest",
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            bridge: {
                name: "BRIDGE OVER THE STREAM",
                description: function() {
                    let desc = "A rickety wooden BRIDGE over a fast-flowing STREAM. ";
                    
                    if (!gameState.bridgeFixed) {
                        desc += "Several planks are missing or broken, making it dangerous to cross. ";
                        desc += "You'll need to repair it first.";
                    } else {
                        desc += "The bridge has been repaired and is now safe to cross. ";
                        desc += "The path continues north toward the castle.";
                    }
                    
                    if (gameState.bridgeFixed && !gameState.foundRustyKey && gameState.keyVisible) {
                        desc += " Something metallic glints in the MUD under the bridge!";
                    }
                    
                    if (this.items.includes('rusty key') && !gameState.foundRustyKey) {
                        desc += " A rusty KEY lies half-buried in the mud.";
                    }
                    
                    return desc;
                },
                items: [],
                exits: {
                    south: "outside",
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            forest: {
                name: "DARK FOREST",
                description: function() {
                    let desc = "You're in a dense, dark FOREST. The trees block most of the light. ";
                    desc += "Strange noises echo around you. ";
                    
                    if (gameState.hasLantern) {
                        desc += "Your lantern illuminates the area, revealing strange MUSHROOMS and BERRIES growing nearby.";
                        this.items = ["mushrooms", "berries"];
                    } else {
                        desc += "It's too dark to see much. You need a light source.";
                        this.items = [];
                    }
                    
                    return desc;
                },
                items: [],
                exits: {
                    north: "outside",
                    south: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: "wolf"
            },
            // UPDATED COURTYARD (ADDED WEST EXIT TO TOWER)
            courtyard: {
                name: "CASTLE COURTYARD",
                description: function() {
                    let desc = "You enter a large, cobblestone COURTYARD surrounded by high stone walls. ";
                    desc += "To the east, an ancient stone WELL stands with a rope hanging into its dark depths. ";
                    
                    // Hermit description
                    desc += " An old HERMIT has set up a wooden CART near the center, filled with various goods. ";
                    
                    // Well state
                    if (gameState.bucketPulled && !gameState.ratDefeated) {
                        desc += " The bucket from the well lies on the ground nearby.";
                    }
                    
                    // Exits description
                    desc += " A rusty iron gate to the north leads to the GRAVEYARD. ";
                    desc += "Stone STABLES stand to the EAST, their doors hanging off the hinges. ";
                    desc += "To the WEST, a massive oak door marks the entrance to the castle TOWER.";
                    
                    return desc;
                },
                items: [],
                exits: {
                    south: "outside",
                    north: "graveyard",
                    east: "stables",
                    west: "towerEntrance"  // NEW: Added west exit to tower
                },
                visited: false,
                enemy: null
            },
            // GRAVEYARD LOCATION
            graveyard: {
                name: "CASTLE GRAVEYARD",
                description: function() {
                    let desc = "You pass through the iron gate into a fog-shrouded GRAVEYARD. ";
                    desc += "Ancient TOMBSTONES rise from the earth at crooked angles, their inscriptions worn by time. ";
                    desc += "A large black RAVEN perches on a nearby gate post, watching you with beady eyes. ";
                    desc += "A GRAVEDIGGER is working near an OPEN GRAVE, his lantern casting eerie shadows. ";
                    
                    // Dynamic elements
                    if (gameState.metalObjectFound && !gameState.graveyardKeyTaken) {
                        desc += " You notice a METAL OBJECT sticking out of the ground near one of the tombstones.";
                    }
                    
                    if (gameState.breadGivenToRaven && !gameState.ringTaken) {
                        desc += " A GOLD RING lies on the ground where the raven was perched.";
                    }
                    
                    return desc;
                },
                items: [],
                exits: {
                    south: "courtyard",
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            // STABLES LOCATION
            stables: {
                name: "HORSE STABLES",
                description: function() {
                    let desc = "You enter the dilapidated horse STABLES. The air is thick with dust and decay. ";
                    desc += "Empty stalls line the walls, their wooden partitions rotting away. ";
                    
                    // Skeletal horse
                    if (!gameState.stablesVisited || (gameState.stablesVisited && currentEnemy && currentEnemy.name === "Skeletal Horse")) {
                        desc += " In the center of the stables, a terrifying SKELETAL HORSE stands guard, its empty eye sockets glowing with red light! ";
                    }
                    
                    // Chest
                    if (!gameState.chestOpened) {
                        desc += " Against the far wall rests an OLD LOCKED WOODEN CHEST. ";
                    } else {
                        desc += " Against the far wall rests an opened wooden chest. ";
                    }
                    
                    // Bed of straw
                    desc += " In one corner, there's a BED OF STRAW. ";
                    
                    // Items in the room
                    if (this.items.length > 0) {
                        desc += " On the ground, you see: " + this.items.map(item => item.toUpperCase()).join(", ") + ". ";
                    }
                    
                    return desc;
                },
                items: [],
                exits: {
                    west: "courtyard",
                    down: gameState.trapdoorRevealed ? "underground" : null,
                    north: null,
                    east: null,
                    south: null
                },
                visited: false,
                enemy: "skeletalHorse"
            },
            // NEW TOWER ENTRANCE LOCATION
            towerEntrance: {
                name: "CASTLE TOWER ENTRANCE",
                description: function() {
                    let desc = "You stand before the massive oak door to the castle TOWER. ";
                    desc += "The door is intricately carved with scenes of battle and magic. ";
                    desc += "To the EAST, the door leads back to the COURTYARD. ";
                    
                    if (gameState.inventory.includes("castle tower key")) {
                        desc += " You have the CASTLE TOWER KEY and can now enter the tower!";
                    } else {
                        desc += " The door is securely locked. You'll need the CASTLE TOWER KEY to enter.";
                    }
                    
                    return desc;
                },
                items: [],
                exits: {
                    east: "courtyard",
                    west: gameState.inventory.includes("castle tower key") ? "cd2_transfer" : null,
                    north: null,
                    south: null
                },
                visited: false,
                enemy: null
            }
        };

        // Game commands
        const commands = {
            'north': 'north',
            'n': 'north',
            'south': 'south',
            's': 'south',
            'east': 'east',
            'e': 'east',
            'west': 'west',
            'w': 'west',
            'look': 'look',
            'l': 'look',
            'inventory': 'inventory',
            'i': 'inventory',
            'take': 'take',
            'get': 'take',
            'grab': 'take',
            'drop': 'drop',
            'examine': 'examine',
            'x': 'examine',
            'use': 'use',
            'open': 'open',
            'read': 'read',
            'talk': 'talk',
            'speak': 'talk',
            'ask': 'talk',
            'give': 'give',
            'attack': 'attack',
            'fight': 'attack',
            'kill': 'attack',
            'light': 'light',
            'repair': 'repair',
            'fix': 'repair',
            'eat': 'eat',
            'drink': 'drink',
            'buy': 'buy',
            'purchase': 'buy',
            'sell': 'sell',
            'shop': 'shop',
            'list': 'shop',
            'cast': 'cast',
            'help': 'help',
            'h': 'help',
            'quit': 'quit',
            'q': 'quit'
        };

        // DOM elements
        const gameOutput = document.getElementById('game-output');
        const gameInput = document.getElementById('game-input');

        // ==================== NEW FUNCTIONS FOR CD2 TRANSFER ====================
        
        // Function to transfer to CD2.html
        function transferToCD2() {
            // Save all game data to localStorage
            const saveData = {
                player: {
                    maxHP: player.maxHP,
                    currentHP: player.currentHP,
                    gold: player.gold,
                    weapon: player.weapon,
                    inventory: player.inventory,
                    spells: player.spells,
                    hasAmuletOfDawn: player.hasAmuletOfDawn
                },
                gameState: gameState,
                combatActive: combatActive,
                currentEnemy: currentEnemy
            };
            
            // Save to localStorage
            localStorage.setItem('castleDamnedSave', JSON.stringify(saveData));
            
            // Add transition message
            addToOutput("You unlock the massive oak door with the castle tower key...", "player");
            addToOutput("The door creaks open, revealing the dark interior of the castle tower.", "location");
            addToOutput(" ");
            addToOutput("Passing through the tower entrance...", "location");
            addToOutput("Loading Castle Tower...", "hint");
            
            // Delay slightly for message to show, then transfer
            setTimeout(() => {
                window.location.href = 'cd2.html';
            }, 2000);
        }
        
        // Load saved game from cd2.html if returning
        function loadSavedGameFromCD2() {
            const savedGame = localStorage.getItem('castleDamnedSaveToCD1');
            
            if (savedGame) {
                try {
                    const saveData = JSON.parse(savedGame);
                    
                    // Load player data
                    Object.assign(player, saveData.player);
                    Object.assign(gameState, saveData.gameState);
                    combatActive = saveData.combatActive || false;
                    currentEnemy = saveData.currentEnemy || null;
                    
                    // Set location to courtyard (where tower entrance is)
                    gameState.currentLocation = 'courtyard';
                    
                    // Clear save
                    localStorage.removeItem('castleDamnedSaveToCD1');
                    
                    // Initialize with loaded state
                    gameOutput.innerHTML = '';
                    addToOutput("CASTLE OF THE DAMMED", "title");
                    addToOutput("Returned from the castle tower...", "story");
                    addToOutput(" ");
                    addToOutput("Game state loaded successfully!", "victory");
                    addToOutput(`HP: ${player.currentHP}/${player.maxHP} | Gold: ${player.gold} | Weapon: ${player.weapon.name}`, "player");
                    
                    // Show inventory if not empty
                    if (gameState.inventory.length > 0) {
                        addToOutput("Inventory: " + gameState.inventory.map(item => item.toUpperCase()).join(", "));
                    }
                    
                    addToOutput(" ");
                    
                    updateStatus();
                    showLocation();
                    return true;
                    
                } catch (error) {
                    console.error("Error loading save from cd2:", error);
                }
            }
            return false;
        }

        // Initialize game
        function initGame() {
            // First try to load saved game from cd2.html
            const loadedFromCD2 = loadSavedGameFromCD2();
            
            if (!loadedFromCD2) {
                // Normal initialization
                gameOutput.innerHTML = '';
                addToOutput("CASTLE OF THE DAMMED", "title");
                addToOutput("1982 Text Adventure - HORSE STABLES ADDED", "subtitle");
                addToOutput(" ");
                addToOutput("You are an adventurer seeking the legendary Castle of the Dammed.", "story");
                addToOutput("You've finally found it, but getting inside won't be easy...", "story");
                addToOutput(" ");
                addToOutput("TIP: Examine everything carefully. Use LOOK to see your surroundings,", "hint");
                addToOutput("and EXAMINE objects for clues. Talk to NPCs and use BUY/SELL at shops.", "hint");
                addToOutput("New: Use CAST [spell name] to cast spells from your spellbook.", "magic");
                addToOutput(" ");
                updateStatus();
                
                locations.outside.enemy = "goblin";
                
                showLocation();
            }
            
            gameInput.focus();
            
            gameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processCommand(this.value);
                    this.value = '';
                }
            });
        }

        // Add text to game output
        function addToOutput(text, className = '') {
            const p = document.createElement('p');
            p.textContent = text;
            if (className) {
                p.className = className;
            }
            gameOutput.appendChild(p);
            
            gameOutput.scrollTop = gameOutput.scrollHeight;
        }

        // Show current location
        function showLocation() {
            const loc = locations[gameState.currentLocation];
            
            addToOutput(loc.name, "location");
            
            const description = loc.description();
            addToOutput(description);
            
            if (!loc.visited) {
                loc.visited = true;
                gameState.visitedLocations.push(gameState.currentLocation);
            }
            
            // Special handling for stables first visit
            if (gameState.currentLocation === "stables" && !gameState.stablesVisited) {
                gameState.stablesVisited = true;
            }
            
            if (loc.enemy && !combatActive) {
                if (loc.enemy === "goblin" && !gameState.goblinDefeated) {
                    startCombat(loc.enemy);
                } else if (loc.enemy === "wolf" && !gameState.wolfDefeated) {
                    startCombat(loc.enemy);
                } else if (loc.enemy === "skeletalHorse") {
                    startCombat(loc.enemy);
                }
            }
            
            if (gameState.currentLocation === "bridge" && gameState.bridgeFixed) {
                if (gameState.foundRustyKey) {
                    loc.exits.north = "courtyard";
                }
            }
            
            const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
            if (exits.length > 0) {
                addToOutput("Exits: " + exits.map(exit => exit.toUpperCase()).join(", "));
            }
        }

        // Process player command - UPDATED WITH TOWER TRANSFER
        function processCommand(input) {
            if (gameState.gameEnded) {
                addToOutput("The game has ended. Refresh the page to try again.", "hint");
                return;
            }
            
            const command = input.trim().toLowerCase();
            if (!command) return;
            
            const parts = command.split(' ');
            const verb = parts[0];
            const object = parts.slice(1).join(' ');
            
            if (!commands[verb]) {
                addToOutput(`I don't understand "${verb}".`);
                return;
            }
            
            const action = commands[verb];
            
            switch(action) {
                case 'north':
                case 'south':
                case 'east':
                case 'west':
                    movePlayer(action);
                    break;
                case 'look':
                    lookAround();
                    break;
                case 'inventory':
                    showInventory();
                    break;
                case 'take':
                    takeItem(object);
                    break;
                case 'drop':
                    dropItem(object);
                    break;
                case 'examine':
                    examineObject(object);
                    break;
                case 'use':
                    useItem(object);
                    break;
                case 'open':
                    openObject(object);
                    break;
                case 'read':
                    readObject(object);
                    break;
                case 'talk':
                    talkTo(object);
                    break;
                case 'give':
                    giveItem(object);
                    break;
                case 'attack':
                    if (combatActive) {
                        playerAttack();
                    } else {
                        attackEnemy(object);
                    }
                    break;
                case 'light':
                    lightLantern();
                    break;
                case 'repair':
                    repairBridge();
                    break;
                case 'eat':
                    eatItem(object);
                    break;
                case 'buy':
                    buyItem(object);
                    break;
                case 'sell':
                    sellItem(object);
                    break;
                case 'shop':
                    showShop();
                    break;
                case 'cast':
                    castSpell(object);
                    break;
                case 'help':
                    showHelp();
                    break;
                case 'quit':
                    quitGame();
                    break;
                default:
                    addToOutput(`Command "${verb}" not implemented yet.`);
            }
        }

        // Move player - UPDATED WITH TOWER TRANSFER
        function movePlayer(direction) {
            if (combatActive) {
                addToOutput("You can't run from combat! You must FIGHT!", "combat");
                return;
            }
            
            const currentLoc = locations[gameState.currentLocation];
            let newLocation = currentLoc.exits[direction];
            
            // Handle bridge crossing
            if (gameState.currentLocation === "bridge" && direction === 'north') {
                if (!gameState.bridgeFixed) {
                    addToOutput("The bridge is too dangerous to cross! You need to REPAIR it first.");
                    return;
                } else if (!gameState.foundRustyKey) {
                    addToOutput("You need a key to enter the castle gates. Maybe you should search around the bridge area more carefully.");
                    return;
                } else {
                    newLocation = "courtyard";
                    addToOutput("You cross the repaired bridge and approach the castle gates.", "player");
                    addToOutput("You use the rusty key on the gates. They creak open!", "victory");
                    addToOutput("You enter the castle courtyard!");
                }
            }
            
            // Handle tower entrance transfer to cd2.html
            if (gameState.currentLocation === "towerEntrance" && direction === 'west') {
                if (!gameState.inventory.includes("castle tower key")) {
                    addToOutput("The tower door is locked. You need the castle tower key.");
                    return;
                } else {
                    transferToCD2();
                    return; // Stop further processing
                }
            }
            
            if (!newLocation) {
                addToOutput(`You can't go ${direction}.`);
                return;
            }
            
            if (newLocation === "forest" && !gameState.hasLantern) {
                addToOutput("It's too dark to enter the forest. You need a light source.");
                return;
            }
            
            gameState.currentLocation = newLocation;
            addToOutput(`You go ${direction}.`);
            showLocation();
        }

        // Look around
        function lookAround() {
            const loc = locations[gameState.currentLocation];
            
            addToOutput(loc.name, "location");
            
            const description = loc.description();
            addToOutput(description);
            
            if (gameState.currentLocation === "bridge" && gameState.bridgeFixed) {
                if (gameState.foundRustyKey) {
                    loc.exits.north = "courtyard";
                }
            }
            
            const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
            if (exits.length > 0) {
                addToOutput("Exits: " + exits.map(exit => exit.toUpperCase()).join(", "));
            }
        }

        // Show inventory
        function showInventory() {
            if (gameState.inventory.length === 0) {
                addToOutput("You are carrying nothing.");
            } else {
                addToOutput("You are carrying: " + gameState.inventory.map(item => item.toUpperCase()).join(", "));
                if (gameState.hasLantern) {
                    addToOutput("(Your lantern is LIT)");
                }
            }
            
            // Show spells if spellbook has been read
            if (gameState.spellbookRead && player.spells.length > 0) {
                addToOutput("Known spells: " + player.spells.map(spell => spell.toUpperCase()).join(", "), "magic");
            }
            
            addToOutput(`Equipped weapon: ${player.weapon.name} (${player.weapon.minDamage}-${player.weapon.maxDamage} damage)`, "player");
            addToOutput(`HP: ${player.currentHP}/${player.maxHP}`, "health");
            addToOutput(`Gold: ${player.gold}`, "gold");
        }

        // Take item
        function takeItem(itemName) {
            if (!itemName) {
                addToOutput("Take what?");
                return;
            }
            
            const loc = locations[gameState.currentLocation];
            const itemIndex = loc.items.findIndex(item => item.toLowerCase().includes(itemName.toLowerCase()));
            
            if (itemIndex === -1) {
                addToOutput(`I don't see a ${itemName} here.`);
                return;
            }
            
            const item = loc.items[itemIndex];
            
            if (item === "crude dagger") {
                loc.items.splice(itemIndex, 1);
                addToOutput(`You take the crude dagger and equip it! (Damage: 5-7)`);
                player.weapon = {
                    name: "Crude Dagger",
                    minDamage: 5,
                    maxDamage: 7
                };
                updateStatus();
            } else if (item === "rusty key") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                gameState.foundRustyKey = true;
                addToOutput(`You take the rusty key!`);
                addToOutput("This might open the castle gates!");
                
                if (gameState.currentLocation === "bridge" && gameState.bridgeFixed) {
                    loc.exits.north = "courtyard";
                    addToOutput("Now that you have the key and the bridge is repaired, you can go NORTH to enter the castle!", "hint");
                }
            } else if (item === "silver chain necklace") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                gameState.foundNecklace = true;
                addToOutput(`You take the beautiful silver chain necklace!`, "victory");
                addToOutput("The wolf pendant's red gem eyes seem to glow faintly.");
            } else if (item === "graveyard key") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                gameState.graveyardKeyTaken = true;
                addToOutput(`You take the ornate silver key!`, "victory");
                addToOutput("This might unlock the graveyard gate.");
            } else if (item === "gold ring") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                gameState.ringTaken = true;
                addToOutput(`You take the gold ring with the green crystal!`, "victory");
                addToOutput("The ring feels cold to the touch.");
            } else if (item === "castle tower key") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                addToOutput(`You take the castle tower key!`, "victory");
                addToOutput("This should unlock the tower door in the courtyard.");
                // Update tower entrance exit
                locations.towerEntrance.exits.west = "cd2_transfer";
            } else if (item === "leather bound spellbook") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                addToOutput(`You take the leather bound spellbook!`, "magic");
                addToOutput("You feel a faint magical energy from the book.");
            } else if (item === "cursed map") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                addToOutput(`You take the cursed map!`, "item");
                addToOutput("The parchment feels strangely cold to the touch.");
            } else if (item === "iron trapdoor handle") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                addToOutput(`You take the iron trapdoor handle!`, "item");
                addToOutput("It's heavy and cold. This must be used to open the trapdoor.");
            } else {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                addToOutput(`You take the ${item}.`);
                
                if (item === "lantern") {
                    gameState.hasLantern = true;
                }
            }
        }

        // Drop item
        function dropItem(itemName) {
            if (!itemName) {
                addToOutput("Drop what?");
                return;
            }
            
            const itemIndex = gameState.inventory.findIndex(item => item.toLowerCase().includes(itemName.toLowerCase()));
            
            if (itemIndex === -1) {
                addToOutput(`You're not carrying a ${itemName}.`);
                return;
            }
            
            const item = gameState.inventory[itemIndex];
            
            if (item === "crude dagger" && player.weapon.name === "Crude Dagger") {
                addToOutput("You can't drop your equipped weapon!");
                return;
            }
            
            gameState.inventory.splice(itemIndex, 1);
            locations[gameState.currentLocation].items.push(item);
            
            if (item === "lantern") {
                gameState.hasLantern = false;
            }
            
            if (item === "rusty key") {
                gameState.foundRustyKey = false;
                if (gameState.currentLocation === "bridge") {
                    locations[gameState.currentLocation].exits.north = null;
                }
            }
            
            if (item === "silver chain necklace") {
                gameState.foundNecklace = false;
            }
            
            if (item === "graveyard key") {
                gameState.graveyardKeyTaken = false;
            }
            
            if (item === "gold ring") {
                gameState.ringTaken = false;
            }
            
            if (item === "castle tower key") {
                // Update tower entrance exit
                locations.towerEntrance.exits.west = null;
            }
            
            addToOutput(`You drop the ${item}.`);
        }

        // Examine object
        function examineObject(objectName) {
            if (!objectName) {
                addToOutput("Examine what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            const loc = locations[gameState.currentLocation];
            
            // Check for weapons
            if (objectLower.includes("fist") || objectLower.includes("hand")) {
                addToOutput(objectDescriptions["fists"]);
                return;
            }
            
            if (objectLower.includes("crude dagger")) {
                addToOutput(objectDescriptions["crude dagger"]);
                return;
            }
            
            // Check inventory
            const inventoryItem = gameState.inventory.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (inventoryItem) {
                if (objectDescriptions[inventoryItem]) {
                    addToOutput(objectDescriptions[inventoryItem]);
                } else {
                    addToOutput(`You examine the ${inventoryItem}. It's in your inventory.`);
                }
                return;
            }
            
            // Check location items
            const locationItem = loc.items.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (locationItem) {
                if (objectDescriptions[locationItem]) {
                    addToOutput(objectDescriptions[locationItem]);
                } else {
                    addToOutput(`You examine the ${locationItem}.`);
                }
                return;
            }
            
            // Special: Examine tower door in courtyard or tower entrance
            if ((objectLower.includes("tower") || objectLower.includes("door")) && 
                (gameState.currentLocation === "courtyard" || gameState.currentLocation === "towerEntrance")) {
                
                if (gameState.currentLocation === "courtyard") {
                    addToOutput("A massive oak door leading to the castle tower. It's securely locked.");
                    addToOutput("You'll need the CASTLE TOWER KEY to enter.");
                    return;
                } else if (gameState.currentLocation === "towerEntrance") {
                    addToOutput("The massive oak door to the castle tower. Intricate carvings depict scenes of battle and magic.");
                    if (gameState.inventory.includes("castle tower key")) {
                        addToOutput("You have the key and can now enter the tower!", "hint");
                    } else {
                        addToOutput("The door is locked. You need the castle tower key.");
                    }
                    return;
                }
            }
            
            // STABLES EXAMINE FUNCTIONS
            if (gameState.currentLocation === "stables") {
                // Examine skeletal horse
                if (objectLower.includes("skeletal") || objectLower.includes("horse")) {
                    addToOutput(objectDescriptions["skeletal horse"]);
                    if (currentEnemy && currentEnemy.name === "Skeletal Horse") {
                        addToOutput("The skeletal horse is blocking your path! You must defeat it first!", "enemy");
                    }
                    return;
                }
                
                // Examine old locked wooden chest
                if ((objectLower.includes("old") && objectLower.includes("chest")) || 
                    objectLower.includes("wooden chest") || objectLower.includes("locked chest")) {
                    
                    if (!gameState.chestOpened) {
                        if (gameState.chestUnlocked) {
                            addToOutput("The wooden chest is now unlocked. You can OPEN it to see what's inside.");
                        } else {
                            addToOutput(objectDescriptions["old locked wooden chest"]);
                            addToOutput("The chest is securely locked. You'll need a key to open it.");
                        }
                    } else {
                        addToOutput("The wooden chest is open and empty.");
                    }
                    return;
                }
                
                // Examine bed of straw
                if (objectLower.includes("bed") || objectLower.includes("straw")) {
                    addToOutput(objectDescriptions["bed of straw"]);
                    
                    if (!gameState.trapdoorRevealed) {
                        addToOutput("Well poking through it reveals an IRON TRAPDOOR HANDLE!", "victory");
                        addToOutput("It looks like it leads underground to another room.");
                        
                        // Add trapdoor handle to room items
                        if (!loc.items.includes('iron trapdoor handle')) {
                            loc.items.push('iron trapdoor handle');
                        }
                        gameState.trapdoorRevealed = true;
                        
                        // Update stables exit
                        loc.exits.down = "underground";
                        addToOutput("A hidden trapdoor is now revealed! You can go DOWN from here.", "hint");
                    } else {
                        addToOutput("You've already found the trapdoor handle in the straw.");
                    }
                    return;
                }
            }
            
            // GRAVEYARD EXAMINE FUNCTIONS
            if (gameState.currentLocation === "graveyard") {
                // Check for raven FIRST (most specific)
                if (objectLower.includes("raven")) {
                    gameState.ravenExamined = true;
                    addToOutput("A large black raven perches on a gate post. It cocks its head and looks at you.");
                    
                    if (!gameState.breadGivenToRaven) {
                        addToOutput("The raven caws: 'I'm hungry!'", "npc");
                    } else {
                        addToOutput("The raven has flown away.");
                    }
                    return;
                }
                
                // Check for gravedigger SECOND (before tombstones)
                if (objectLower.includes("gravedigger")) {
                    gameState.gravediggerExamined = true;
                    addToOutput("A haggard old man with a hunched back, dressed in tattered clothes.");
                    addToOutput("He's slowly digging a grave with a rusty shovel.");
                    addToOutput("An old lantern sits nearby, casting a dim light on his work.");
                    addToOutput("He doesn't seem to notice you.");
                    return;
                }
                
                // Check for open grave THIRD
                if (objectLower.includes("open grave")) {
                    addToOutput("A freshly dug grave about six feet deep.");
                    addToOutput("The earth is dark and moist. It looks like it was just dug today.");
                    addToOutput("The gravedigger is still working on it.");
                    return;
                }
                
                // Check for metal object FOURTH
                if (objectLower.includes("metal")) {
                    if (!gameState.metalObjectFound) {
                        addToOutput("You don't see any metal object here.");
                        return;
                    }
                    
                    if (!gameState.metalObjectExamined) {
                        gameState.metalObjectExamined = true;
                        addToOutput("You carefully free the dirt around the metal object.", "player");
                        addToOutput("It's an ornate silver KEY!", "victory");
                        addToOutput("This might unlock the graveyard gate in the courtyard.");
                        
                        // Add key to room items
                        if (!loc.items.includes('graveyard key')) {
                            loc.items.push('graveyard key');
                        }
                    } else {
                        addToOutput("You've already examined the metal object and found a key.");
                    }
                    return;
                }
                
                // Check for gold ring FIFTH
                if (objectLower.includes("gold ring")) {
                    if (gameState.breadGivenToRaven && !gameState.ringTaken) {
                        addToOutput("A beautiful gold ring with a green crystal set in it.");
                        addToOutput("Small engravings are visible on the inside of the ring.");
                    } else {
                        addToOutput("You don't see a gold ring here.");
                    }
                    return;
                }
                
                // Check for tombstones LAST (least specific, but don't match "gravedigger" or "open grave")
                if ((objectLower.includes("tombstone") || (objectLower.includes("grave") && !objectLower.includes("gravedigger") && !objectLower.includes("open grave")))) {
                    gameState.tombstonesExamined = true;
                    let desc = "Ancient tombstones mark the final resting places of the castle's former inhabitants. ";
                    desc += "The engravings are worn but still readable on some. ";
                    
                    if (!gameState.metalObjectFound) {
                        desc += "Near one of the tombstones, you notice a METAL OBJECT sticking out of the ground!";
                        gameState.metalObjectFound = true;
                    } else if (gameState.metalObjectFound && !gameState.metalObjectExamined) {
                        desc += "The metal object is still partially buried near the tombstone.";
                    } else if (gameState.metalObjectExamined && !gameState.graveyardKeyTaken) {
                        desc += "Where the metal object was, there's now a hole in the ground.";
                    }
                    
                    addToOutput(desc);
                    
                    if (gameState.metalObjectFound && !gameState.metalObjectExamined) {
                        addToOutput("Try EXAMINE METAL OBJECT to investigate further.", "hint");
                    }
                    
                    if (!gameState.tombstoneRead) {
                        addToOutput("You could READ ENGRAVINGS to see what's written on the tombstones.", "hint");
                    }
                    return;
                }
            }
            
            // OTHER LOCATIONS
            // SPECIAL: Examine bridge
            if ((objectLower.includes("bridge") || objectLower.includes("wood")) && 
                gameState.currentLocation === "bridge") {
                
                gameState.examinedBridge = true;
                let desc = "A rickety wooden bridge over a stream. ";
                
                if (!gameState.bridgeFixed) {
                    desc += "Several planks are missing or broken. ";
                    desc += "You notice dark MUD along the stream banks below.";
                } else {
                    desc += "The bridge has been repaired and is now safe to cross. ";
                    
                    if (!gameState.foundRustyKey) {
                        desc += "Looking down, you notice the MUD below seems disturbed. ";
                        if (!gameState.keyVisible) {
                            desc += "Something catches the light in the mud...";
                            gameState.keyVisible = true;
                            if (!loc.items.includes('rusty key')) {
                                loc.items.push('rusty key');
                            }
                        } else {
                            desc += "There's definitely something metallic buried in the mud!";
                        }
                    }
                }
                addToOutput(desc);
                if (gameState.bridgeFixed && !gameState.foundRustyKey) {
                    addToOutput("Try examining the MUD for more details.");
                }
                return;
            }
            
            // SPECIAL: Examine stream
            if ((objectLower.includes("stream") || objectLower.includes("water")) && 
                gameState.currentLocation === "bridge") {
                
                gameState.examinedStream = true;
                let desc = "A fast-flowing stream with dark, murky water. ";
                desc += "From up on the bridge, you can see the water flows swiftly. ";
                
                if (gameState.bridgeFixed && !gameState.foundRustyKey) {
                    desc += "Looking down at the stream banks, you notice dark MUD. ";
                    desc += "Something metallic seems to be partially buried there.";
                    if (!gameState.keyVisible) {
                        gameState.keyVisible = true;
                        if (!loc.items.includes('rusty key')) {
                            loc.items.push('rusty key');
                        }
                    }
                }
                
                addToOutput(desc);
                if (gameState.bridgeFixed && !gameState.foundRustyKey) {
                    addToOutput("The MUD along the banks looks interesting.");
                }
                return;
            }
            
            // SPECIAL: Examine mud
            if (objectLower.includes("mud") && gameState.currentLocation === "bridge") {
                let desc = "Thick, dark mud along the stream banks. ";
                
                if (gameState.bridgeFixed) {
                    desc += "Now that you've repaired the bridge, you can get a better look. ";
                    
                    if (!gameState.foundRustyKey) {
                        if (gameState.keyVisible) {
                            desc += "Buried in the mud, you find a RUSTY KEY!";
                            addToOutput(desc);
                            if (!loc.items.includes('rusty key')) {
                                loc.items.push('rusty key');
                            }
                            addToOutput("Try TAKE KEY to get it.");
                            addToOutput("Once you have the key, you can go NORTH to enter the castle!", "hint");
                            return;
                        } else {
                            desc += "The mud looks freshly disturbed. Maybe you should examine the bridge or stream more closely first.";
                        }
                    } else {
                        desc += "You've already taken the key from here.";
                    }
                } else {
                    desc += "It's too dangerous to examine closely while the bridge is broken.";
                }
                
                addToOutput(desc);
                return;
            }
            
            // SPECIAL: Examine gates
            if (objectLower.includes("gate") && gameState.currentLocation === "outside") {
                addToOutput(objectDescriptions["gates"]);
                if (!gameState.foundRustyKey) {
                    addToOutput("You'll need a KEY to open them.");
                }
                return;
            }
            
            // SPECIAL: Examine well
            if (objectLower.includes("well") && gameState.currentLocation === "courtyard") {
                gameState.wellExamined = true;
                let desc = "An ancient stone well with a wooden bucket attached to a rope. ";
                desc += "The bucket is lowered down into the darkness below. ";
                desc += "You can't see the bottom from here.";
                
                if (!gameState.bucketPulled) {
                    desc += " The rope looks sturdy enough to pull the bucket up.";
                } else if (gameState.bucketPulled && !gameState.ratDefeated) {
                    desc += " The bucket is now on the ground next to the well.";
                } else if (gameState.ratDefeated) {
                    desc += " The bucket lies empty on the ground.";
                }
                
                addToOutput(desc);
                
                if (!gameState.bucketPulled) {
                    addToOutput("You could USE ROPE to pull the bucket up.", "hint");
                } else if (gameState.bucketPulled && !gameState.ratDefeated) {
                    addToOutput("There's movement inside the bucket!", "enemy");
                } else if (gameState.ratDefeated) {
                    addToOutput("The bucket is now safe to examine.", "hint");
                }
                return;
            }
            
            // SPECIAL: Examine bucket
            if (objectLower.includes("bucket") && gameState.currentLocation === "courtyard") {
                if (!gameState.bucketPulled) {
                    addToOutput("The bucket is down the well. You need to pull it up first.");
                    return;
                }
                
                if (!gameState.ratDefeated) {
                    addToOutput("As you peer into the bucket, a GIANT BLACK RAT leaps out!", "enemy");
                    startCombat("rat");
                    return;
                }
                
                if (gameState.ratDefeated && !gameState.foundNecklace) {
                    addToOutput("You examine the bucket. Inside, you find a beautiful SILVER CHAIN NECKLACE!", "victory");
                    addToOutput("The necklace has a wolf's head pendant with red gem eyes that seem to glow faintly.");
                    if (!loc.items.includes('silver chain necklace')) {
                        loc.items.push('silver chain necklace');
                    }
                    return;
                } else if (gameState.foundNecklace) {
                    addToOutput("The bucket is empty now.");
                }
                return;
            }
            
            // SPECIAL: Examine cart
            if (objectLower.includes("cart") && gameState.currentLocation === "courtyard") {
                addToOutput("A wooden cart filled with various goods. The hermit uses it to carry his wares.");
                addToOutput("Use SHOP to see what's for sale, or TALK HERMIT to speak with him.");
                return;
            }
            
            // SPECIAL: Examine graveyard gate, stables
            if ((objectLower.includes("graveyard") || objectLower.includes("gate")) && 
                gameState.currentLocation === "courtyard") {
                if (gameState.graveyardKeyTaken) {
                    addToOutput("The graveyard gate is now unlocked. You can go NORTH to enter.");
                } else {
                    addToOutput("A rusty iron gate leading to the castle graveyard. It's locked tight.");
                    addToOutput("You'll need to find the key to open it.");
                }
                return;
            }
            
            if (objectLower.includes("stable") && gameState.currentLocation === "courtyard") {
                addToOutput("Stone stables with rotting wooden doors. They look like they haven't been used in years.");
                addToOutput("The doors are stuck and won't budge.");
                return;
            }
            
            // Check object descriptions
            if (objectDescriptions[objectLower]) {
                addToOutput(objectDescriptions[objectLower]);
                return;
            }
            
            // Partial matches
            for (const [objKey, description] of Object.entries(objectDescriptions)) {
                if (objKey.includes(objectLower) || objectLower.includes(objKey)) {
                    addToOutput(description);
                    return;
                }
            }
            
            // Direction check
            if (['north', 'south', 'east', 'west'].includes(objectLower)) {
                const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
                if (exits.includes(objectLower)) {
                    addToOutput(`You look ${objectLower}. You can go that way.`);
                } else {
                    addToOutput(`You look ${objectLower}. You cannot go that way.`);
                }
                return;
            }
            
            // Special: examine sign
            if (objectLower.includes("sign") && gameState.currentLocation === "outside") {
                addToOutput("The weathered sign reads: 'Beware the Castle of the Dammed. None who enter return unchanged.'");
                return;
            }
            
            // Special: examine forest
            if (objectLower.includes("forest") && gameState.currentLocation === "outside") {
                addToOutput(objectDescriptions["forest"]);
                if (!gameState.hasLantern) {
                    addToOutput("It looks too dark to enter without a light.");
                }
                return;
            }
            
            addToOutput(`You don't see a ${objectName} here.`);
        }

        // Use item
        function useItem(objectName) {
            if (!objectName) {
                addToOutput("Use what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Check if using lantern
            if (objectLower.includes("lantern") && gameState.inventory.includes("lantern")) {
                if (gameState.hasLantern) {
                    addToOutput("The lantern is already lit.");
                } else {
                    addToOutput("You light the lantern. It casts a warm glow around you.");
                    gameState.hasLantern = true;
                }
                return;
            }
            
            // Check if using planks on bridge
            if (objectLower.includes("planks") && gameState.currentLocation === "bridge" && 
                gameState.inventory.includes("planks")) {
                repairBridge();
                return;
            }
            
            // Check if using rope at well in courtyard
            if (objectLower.includes("rope") && gameState.currentLocation === "courtyard") {
                if (!gameState.wellExamined) {
                    addToOutput("You're not sure what to use the rope on here.");
                    return;
                }
                
                if (gameState.bucketPulled) {
                    addToOutput("The bucket is already pulled up.");
                    return;
                }
                
                addToOutput("You slowly pull on the rope, raising the bucket from the well...", "player");
                addToOutput("The wooden bucket rises from the darkness. You hear scratching sounds from inside!", "enemy");
                gameState.bucketPulled = true;
                
                addToOutput("The bucket is now on the ground next to the well.", "hint");
                addToOutput("Try EXAMINE BUCKET to see what's inside.", "hint");
                return;
            }
            
            // Check if using rope elsewhere
            if (objectLower.includes("rope") && gameState.inventory.includes("rope")) {
                if (gameState.currentLocation === "bridge" && !gameState.bridgeFixed) {
                    addToOutput("You could use the rope with planks to repair the bridge.");
                } else {
                    addToOutput("You're not sure how to use the rope here.");
                }
                return;
            }
            
            // Check if using health potion
            if (objectLower.includes("health potion") && gameState.inventory.includes("health potion")) {
                const potionIndex = gameState.inventory.indexOf("health potion");
                gameState.inventory.splice(potionIndex, 1);
                
                const healAmount = 10;
                player.currentHP = Math.min(player.maxHP, player.currentHP + healAmount);
                addToOutput(`You drink the health potion. It restores ${healAmount} HP!`, "health");
                updateStatus();
                return;
            }
            
            // Check if using bread
            if ((objectLower.includes("bread") || objectLower.includes("loaf")) && 
                gameState.inventory.includes("bread loaf")) {
                const breadIndex = gameState.inventory.indexOf("bread loaf");
                gameState.inventory.splice(breadIndex, 1);
                
                const healAmount = 5;
                player.currentHP = Math.min(player.maxHP, player.currentHP + healAmount);
                addToOutput(`You eat the bread. It restores ${healAmount} HP!`, "health");
                updateStatus();
                return;
            }
            
            // Check if using graveyard key on chest in stables
            if (objectLower.includes("graveyard key") && gameState.currentLocation === "stables") {
                if (!gameState.inventory.includes("graveyard key")) {
                    addToOutput("You don't have the graveyard key.");
                    return;
                }
                
                if (gameState.chestOpened) {
                    addToOutput("The chest is already opened.");
                    return;
                }
                
                if (!gameState.chestUnlocked) {
                    addToOutput("You use the graveyard key on the old wooden chest.", "player");
                    addToOutput("The key fits perfectly! With a loud click, the chest unlocks!", "victory");
                    gameState.chestUnlocked = true;
                    addToOutput("Now you can OPEN the chest to see what's inside.");
                } else {
                    addToOutput("The chest is already unlocked.");
                }
                return;
            }
            
            // Check if using iron trapdoor handle in stables
            if (objectLower.includes("iron trapdoor") || objectLower.includes("trapdoor handle")) {
                if (!gameState.inventory.includes("iron trapdoor handle")) {
                    addToOutput("You don't have the trapdoor handle.");
                    return;
                }
                
                if (gameState.currentLocation !== "stables") {
                    addToOutput("There's no trapdoor to use the handle on here.");
                    return;
                }
                
                addToOutput("You attach the iron trapdoor handle to the hidden trapdoor.", "player");
                addToOutput("The trapdoor is now accessible! You can go DOWN from the stables.", "victory");
                locations.stables.exits.down = "underground";
                return;
            }
            
            // Check if using castle tower key on tower door
            if (objectLower.includes("castle tower key") && 
                (gameState.currentLocation === "courtyard" || gameState.currentLocation === "towerEntrance")) {
                if (!gameState.inventory.includes("castle tower key")) {
                    addToOutput("You don't have the castle tower key.");
                    return;
                }
                
                if (gameState.currentLocation === "courtyard") {
                    addToOutput("You need to go to the tower entrance to use the key.");
                } else if (gameState.currentLocation === "towerEntrance") {
                    addToOutput("You use the castle tower key on the massive oak door.", "player");
                    addToOutput("The key turns with a satisfying click! The tower door is now unlocked!", "victory");
                    addToOutput("You can now enter the tower by going WEST.");
                }
                return;
            }
            
            addToOutput(`You're not sure how to use the ${objectName} here.`);
        }

        // Open object
        function openObject(objectName) {
            if (!objectName) {
                addToOutput("Open what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Trying to open chest in stables
            if (objectLower.includes("chest") && gameState.currentLocation === "stables") {
                if (!gameState.chestUnlocked) {
                    addToOutput("The chest is locked. You need a key to open it.");
                    return;
                }
                
                if (gameState.chestOpened) {
                    addToOutput("The chest is already opened.");
                    return;
                }
                
                addToOutput("You open the old wooden chest...", "player");
                addToOutput("Inside you find:", "item");
                addToOutput("- A CASTLE TOWER KEY", "item");
                addToOutput("- A LEATHER BOUND SPELLBOOK", "magic");
                addToOutput("- A CURSED MAP", "item");
                
                // Add items to stables location
                const stables = locations.stables;
                if (!stables.items.includes('castle tower key')) {
                    stables.items.push('castle tower key');
                }
                if (!stables.items.includes('leather bound spellbook')) {
                    stables.items.push('leather bound spellbook');
                }
                if (!stables.items.includes('cursed map')) {
                    stables.items.push('cursed map');
                }
                
                gameState.chestOpened = true;
                addToOutput("You can now TAKE these items from the stables.", "hint");
                return;
            }
            
            // Trying to open gates at outside
            if ((objectLower.includes("gate") || objectLower.includes("door")) && 
                gameState.currentLocation === "outside") {
                if (gameState.inventory.includes("rusty key")) {
                    addToOutput("You need to go to the bridge and cross north to use the key.");
                } else {
                    addToOutput("The gates are firmly locked. You need a key.");
                }
                return;
            }
            
            // Trying to open graveyard gate in courtyard
            if ((objectLower.includes("graveyard") || objectLower.includes("gate")) && 
                gameState.currentLocation === "courtyard") {
                if (gameState.graveyardKeyTaken) {
                    addToOutput("The graveyard gate is already unlocked. You can go NORTH to enter.");
                } else {
                    addToOutput("The graveyard gate is locked. You need a key.");
                }
                return;
            }
            
            if (objectLower.includes("stable") && gameState.currentLocation === "courtyard") {
                addToOutput("The stable doors are stuck and won't budge.");
                return;
            }
            
            // Trying to open tower door
            if ((objectLower.includes("tower") || objectLower.includes("door")) && 
                (gameState.currentLocation === "courtyard" || gameState.currentLocation === "towerEntrance")) {
                if (gameState.inventory.includes("castle tower key")) {
                    if (gameState.currentLocation === "towerEntrance") {
                        addToOutput("The tower door is now unlocked! You can enter the tower by going WEST.");
                    } else {
                        addToOutput("The tower door is in the tower entrance. Go WEST from here to reach it.");
                    }
                } else {
                    addToOutput("The tower door is locked. You need the castle tower key.");
                }
                return;
            }
            
            addToOutput(`You can't open the ${objectName}.`);
        }

        // Read object
        function readObject(objectName) {
            if (!objectName) {
                addToOutput("Read what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            if (objectLower.includes("sign") && gameState.currentLocation === "outside") {
                addToOutput("The weathered sign reads: 'Beware the Castle of the Dammed. None who enter return unchanged.'");
                return;
            }
            
            // Read spellbook
            if ((objectLower.includes("spellbook") || objectLower.includes("spell book")) && 
                gameState.inventory.includes("leather bound spellbook")) {
                
                gameState.spellbookRead = true;
                addToOutput("You open the leather bound spellbook and read its contents:", "magic");
                addToOutput(" ");
                addToOutput("Spells contained in this book:", "magic");
                addToOutput("- BLOOD DRAIN: Drains life from your enemy", "magic");
                addToOutput("- MOON RISING: Summons moonlight to reveal hidden paths", "magic");
                addToOutput("- NIGHT GLARE: Blinds enemies with a flash of dark light", "magic");
                addToOutput("- MIST OF SOULS: Summons a protective mist of lost souls", "magic");
                addToOutput(" ");
                addToOutput("The book also contains 4 more empty pages that can be filled", "magic");
                addToOutput("with other spells that can be learned and acquired later in gameplay.", "magic");
                addToOutput(" ");
                addToOutput("You have learned these spells! Use CAST [spell name] to cast them.", "magic");
                
                // Add spells to player's known spells
                const spells = ["blood drain", "moon rising", "night glare", "mist of souls"];
                spells.forEach(spell => {
                    if (!player.spells.includes(spell)) {
                        player.spells.push(spell);
                    }
                });
                
                return;
            }
            
            // Read cursed map
            if ((objectLower.includes("map") || objectLower.includes("cursed")) && 
                gameState.inventory.includes("cursed map")) {
                
                gameState.mapRead = true;
                addToOutput("You unfold the cursed map of the castle tower:", "item");
                addToOutput(" ");
                addToOutput("It shows only one room so far: the TOWER ENTRANCE", "item");
                addToOutput(" ");
                addToOutput("A message is written under it:", "item");
                addToOutput("'Once each room is explored, each part of the curse is lifted", "item");
                addToOutput(" and the map grows.'", "item");
                addToOutput(" ");
                addToOutput("The map seems to be magically linked to your exploration.", "hint");
                
                return;
            }
            
            // Read tombstone engravings in graveyard
            if ((objectLower.includes("engraving") || objectLower.includes("tombstone") || 
                 (objectLower.includes("grave") && !objectLower.includes("gravedigger"))) && 
                gameState.currentLocation === "graveyard") {
                
                if (!gameState.tombstonesExamined) {
                    addToOutput("You need to examine the tombstones first.");
                    return;
                }
                
                gameState.tombstoneRead = true;
                addToOutput("You read the engravings on the largest tombstone:");
                addToOutput("'HERE RESTS LORD VARRACK, LAST LORD OF THE DAMMED'");
                addToOutput("'FALLEN IN BATTLE AGAINST THE FORCES OF DARKNESS'");
                addToOutput("'MAY HIS SOUL FIND PEACE THAT ELUDED HIM IN LIFE'");
                addToOutput("'BORN 1342 - DIED 1382'");
                return;
            }
            
            // Read gold ring engravings
            if (objectLower.includes("ring") && gameState.inventory.includes("gold ring")) {
                addToOutput("You examine the gold ring closely. The engravings on the inside read:");
                addToOutput("'IF WORN, YOU SUMMON THE UNDEAD'");
                addToOutput("The words send a chill down your spine.");
                return;
            }
            
            addToOutput(`There's nothing to read on the ${objectName}.`);
        }

        // Cast spell
        function castSpell(spellName) {
            if (!spellName) {
                addToOutput("Cast what spell?");
                return;
            }
            
            const spellLower = spellName.toLowerCase();
            
            // Check if player knows the spell
            const knownSpell = player.spells.find(spell => 
                spell.toLowerCase().includes(spellLower) || 
                spellLower.includes(spell.toLowerCase())
            );
            
            if (!knownSpell) {
                addToOutput(`You don't know the spell '${spellName}'.`, "magic");
                return;
            }
            
            // Check if player has amulet of dawn
            if (!player.hasAmuletOfDawn) {
                addToOutput(`Without the amulet of dawn you have no magical ability to spellcast.`, "magic");
                return;
            }
            
            // If player has amulet, implement spell effects
            addToOutput(`You cast ${knownSpell.toUpperCase()}!`, "magic");
            
            // Basic spell effects
            switch(knownSpell.toLowerCase()) {
                case "blood drain":
                    if (combatActive && currentEnemy) {
                        const drainAmount = Math.floor(Math.random() * 5) + 3;
                        currentEnemy.currentHP -= drainAmount;
                        player.currentHP = Math.min(player.maxHP, player.currentHP + Math.floor(drainAmount / 2));
                        addToOutput(`You drain ${drainAmount} HP from ${currentEnemy.name}!`, "magic");
                        addToOutput(`You heal ${Math.floor(drainAmount / 2)} HP.`, "health");
                        
                        if (currentEnemy.currentHP <= 0) {
                            endCombat(true);
                        } else {
                            addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
                        }
                        updateStatus();
                    } else {
                        addToOutput("The spell has no effect here.", "magic");
                    }
                    break;
                case "moon rising":
                    addToOutput("Moonlight fills the area, revealing hidden details.", "magic");
                    break;
                case "night glare":
                    if (combatActive && currentEnemy) {
                        addToOutput(`A flash of dark light blinds ${currentEnemy.name}!`, "magic");
                        addToOutput("The enemy is stunned and misses its next turn!", "magic");
                    } else {
                        addToOutput("The spell has no effect here.", "magic");
                    }
                    break;
                case "mist of souls":
                    addToOutput("A protective mist of lost souls swirls around you.", "magic");
                    addToOutput("You feel protected from harm.", "magic");
                    break;
                default:
                    addToOutput(`The spell ${knownSpell} has no effect here.`, "magic");
            }
        }

        // Talk to NPC
        function talkTo(objectName) {
            if (!objectName) {
                addToOutput("Talk to who?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Talking to hermit in courtyard
            if ((objectLower.includes("hermit") || objectLower.includes("man")) && 
                gameState.currentLocation === "courtyard") {
                
                if (!gameState.hermitTalked) {
                    addToOutput("The old hermit looks up as you approach.", "npc");
                    addToOutput("Hermit: 'Ah, a traveler! Not many come to this cursed place anymore.'", "npc");
                    addToOutput("Hermit: 'I'm just a simple trader. Take a look at my wares - you might find something useful.'", "npc");
                    addToOutput("Hermit: 'Use SHOP to see what I have for sale, or SELL to sell me your items.'", "npc");
                    gameState.hermitTalked = true;
                } else {
                    addToOutput("Hermit: 'Back again? Take a look at my goods or sell me something.'", "npc");
                }
                return;
            }
            
            // Talking to raven in graveyard
            if (objectLower.includes("raven") && gameState.currentLocation === "graveyard") {
                if (!gameState.ravenExamined) {
                    addToOutput("You need to examine the raven first.");
                    return;
                }
                
                if (gameState.breadGivenToRaven) {
                    addToOutput("The raven has flown away.");
                    return;
                }
                
                gameState.ravenTalked = true;
                addToOutput("You speak to the raven.", "player");
                addToOutput("Raven: 'A piece of bread, if you have some spare.'", "npc");
                addToOutput("The raven looks at you expectantly.");
                addToOutput("You could GIVE BREAD to the raven if you have any.", "hint");
                return;
            }
            
            // Talking to gravedigger in graveyard
            if (objectLower.includes("gravedigger") && gameState.currentLocation === "graveyard") {
                if (!gameState.gravediggerExamined) {
                    addToOutput("You need to examine the gravedigger first.");
                    return;
                }
                
                gameState.gravediggerTalkCount++;
                
                if (gameState.gravediggerTalkCount === 1) {
                    addToOutput("The gravedigger stops digging and looks up at you.", "npc");
                    addToOutput("Gravedigger: 'Beware of those who roam the night...'", "npc");
                    addToOutput("Gravedigger: '...as they hunt those who dare wander the night.'", "npc");
                    addToOutput("He returns to his digging without another word.");
                } else if (gameState.gravediggerTalkCount === 2) {
                    addToOutput("The gravedigger stops again, a grim look on his face.", "npc");
                    addToOutput("Gravedigger: 'I'm digging a new grave... this grave...'", "npc");
                    addToOutput("Gravedigger: '...it will be yours if you don't flee soon...'", "npc");
                    addToOutput("Gravedigger: '...as the creatures that roam this place at night will see to that.'", "npc");
                    addToOutput("He resumes his work, ignoring you completely.");
                } else {
                    addToOutput("The gravedigger ignores you, focused on his work.");
                }
                return;
            }
            
            if ((objectLower.includes("goblin") || objectLower.includes("wolf") || 
                 objectLower.includes("rat") || objectLower.includes("skeletal horse")) && combatActive) {
                addToOutput("The creature doesn't understand you. It only wants to fight!", "enemy");
                return;
            }
            
            addToOutput("There's no one here to talk to.");
        }

        // Give item
        function giveItem(objectName) {
            if (!objectName) {
                addToOutput("Give what?");
                return;
            }
            
            const parts = objectName.toLowerCase().split(' to ');
            if (parts.length < 2) {
                addToOutput("Give what to whom?");
                return;
            }
            
            const itemName = parts[0].trim();
            const recipient = parts[1].trim();
            
            // Giving bread to raven
            if (recipient.includes("raven") && gameState.currentLocation === "graveyard") {
                if (!gameState.ravenTalked) {
                    addToOutput("The raven hasn't asked for anything.");
                    return;
                }
                
                if (gameState.breadGivenToRaven) {
                    addToOutput("You've already given bread to the raven.");
                    return;
                }
                
                if (!itemName.includes("bread")) {
                    addToOutput("The raven only wants bread.");
                    return;
                }
                
                // Check if player has bread
                if (!gameState.inventory.includes("bread loaf")) {
                    addToOutput("You don't have any bread to give.");
                    return;
                }
                
                // Give bread to raven
                const breadIndex = gameState.inventory.indexOf("bread loaf");
                gameState.inventory.splice(breadIndex, 1);
                gameState.breadGivenToRaven = true;
                
                addToOutput("You give the bread loaf to the raven.", "player");
                addToOutput("The raven eagerly takes the bread in its beak.", "npc");
                addToOutput("Raven: 'Thank you, traveler! Take this as thanks.'", "npc");
                addToOutput("The raven drops a GOLD RING with a green crystal, then flies off!", "victory");
                
                // Add ring to graveyard items
                const graveyard = locations.graveyard;
                if (!graveyard.items.includes('gold ring')) {
                    graveyard.items.push('gold ring');
                }
                return;
            }
            
            addToOutput("There's no one here to give anything to.");
        }

        // Attack enemy
        function attackEnemy(objectName) {
            if (!objectName) {
                addToOutput("Attack what?");
                return;
            }
            
            if (combatActive) {
                playerAttack();
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            if ((objectLower.includes("goblin")) && 
                gameState.currentLocation === "outside" && !gameState.goblinDefeated) {
                startCombat("goblin");
                return;
            }
            
            if ((objectLower.includes("wolf")) && 
                gameState.currentLocation === "forest" && !gameState.wolfDefeated) {
                startCombat("wolf");
                return;
            }
            
            if ((objectLower.includes("rat")) && 
                gameState.currentLocation === "courtyard" && 
                gameState.bucketPulled && !gameState.ratDefeated) {
                addToOutput("The rat is still in the bucket. Try EXAMINE BUCKET first.");
                return;
            }
            
            if ((objectLower.includes("skeletal") || objectLower.includes("horse")) && 
                gameState.currentLocation === "stables") {
                startCombat("skeletalHorse");
                return;
            }
            
            addToOutput("There's nothing to attack here.");
        }

        // Light lantern
        function lightLantern() {
            if (!gameState.inventory.includes("lantern")) {
                addToOutput("You don't have a lantern to light.");
                return;
            }
            
            if (gameState.hasLantern) {
                addToOutput("Your lantern is already lit.");
            } else {
                addToOutput("You light the lantern. It casts a warm, flickering light.");
                gameState.hasLantern = true;
                
                if (gameState.currentLocation === "forest") {
                    addToOutput("The lantern illuminates the forest, revealing strange mushrooms and berries.");
                    locations.forest.items = ["mushrooms", "berries"];
                }
            }
        }

        // Repair bridge
        function repairBridge() {
            if (gameState.currentLocation !== "bridge") {
                addToOutput("There's nothing to repair here.");
                return;
            }
            
            if (gameState.bridgeFixed) {
                addToOutput("The bridge is already repaired.");
                return;
            }
            
            if (!gameState.inventory.includes("planks")) {
                addToOutput("You need wooden planks to repair the bridge.");
                return;
            }
            
            if (!gameState.inventory.includes("rope")) {
                addToOutput("You need rope to secure the planks.");
                return;
            }
            
            addToOutput("You use the planks and rope to repair the bridge.", "player");
            addToOutput("The bridge is now safe to cross!", "victory");
            gameState.bridgeFixed = true;
            
            gameState.keyVisible = true;
            
            const plankIndex = gameState.inventory.indexOf("planks");
            if (plankIndex > -1) gameState.inventory.splice(plankIndex, 1);
            
            const ropeIndex = gameState.inventory.indexOf("rope");
            if (ropeIndex > -1) gameState.inventory.splice(ropeIndex, 1);
            
            addToOutput("Now that the bridge is stable, you can examine your surroundings more carefully.");
            addToOutput("Try examining the MUD under the bridge!", "hint");
            
            if (gameState.foundRustyKey) {
                locations.bridge.exits.north = "courtyard";
                addToOutput("You can now go NORTH to enter the castle!", "hint");
            }
        }

        // Eat item
        function eatItem(objectName) {
            if (!objectName) {
                addToOutput("Eat what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            if (objectLower.includes("berries") && gameState.inventory.includes("berries")) {
                const berryIndex = gameState.inventory.indexOf("berries");
                gameState.inventory.splice(berryIndex, 1);
                
                const healAmount = 5;
                player.currentHP = Math.min(player.maxHP, player.currentHP + healAmount);
                addToOutput(`You eat the berries. They taste sweet and restore ${healAmount} HP!`, "health");
                updateStatus();
                return;
            }
            
            if (objectLower.includes("mushrooms") && gameState.inventory.includes("mushrooms")) {
                const mushroomIndex = gameState.inventory.indexOf("mushrooms");
                gameState.inventory.splice(mushroomIndex, 1);
                
                addToOutput("You eat the glowing mushrooms. They taste terrible!");
                addToOutput("You feel sick and lose 3 HP!", "health");
                player.currentHP = Math.max(0, player.currentHP - 3);
                updateStatus();
                return;
            }
            
            if ((objectLower.includes("bread") || objectLower.includes("loaf")) && 
                gameState.inventory.includes("bread loaf")) {
                useItem("bread loaf");
                return;
            }
            
            addToOutput(`You can't eat ${objectName}.`);
        }

        // BUY item from hermit
        function buyItem(itemName) {
            if (!itemName) {
                addToOutput("Buy what? Use SHOP to see what's available.");
                return;
            }
            
            if (gameState.currentLocation !== "courtyard") {
                addToOutput("There's no shop here.");
                return;
            }
            
            const itemLower = itemName.toLowerCase();
            const shopItem = hermitShop.items.find(item => 
                item.name.toLowerCase().includes(itemLower)
            );
            
            if (!shopItem) {
                addToOutput(`The hermit doesn't have ${itemName} for sale.`);
                return;
            }
            
            if (player.gold < shopItem.price) {
                addToOutput(`You don't have enough gold. ${shopItem.name} costs ${shopItem.price} gold.`, "gold");
                return;
            }
            
            if (gameState.inventory.includes(shopItem.name)) {
                addToOutput(`You already have a ${shopItem.name}.`);
                return;
            }
            
            player.gold -= shopItem.price;
            gameState.inventory.push(shopItem.name);
            addToOutput(`You buy a ${shopItem.name} for ${shopItem.price} gold.`, "shop");
            addToOutput(`Gold remaining: ${player.gold}`, "gold");
            
            if (shopItem.name === "health potion") {
                addToOutput("Use HEALTH POTION to restore 10 HP.", "hint");
            } else if (shopItem.name === "torch") {
                addToOutput("The torch can be lit to provide light.", "hint");
            } else if (shopItem.name === "rope") {
                addToOutput("The rope might be useful for various tasks.", "hint");
            }
            
            updateStatus();
        }

        // SELL item to hermit
        function sellItem(itemName) {
            if (!itemName) {
                addToOutput("Sell what?");
                return;
            }
            
            if (gameState.currentLocation !== "courtyard") {
                addToOutput("There's no one to sell to here.");
                return;
            }
            
            const itemLower = itemName.toLowerCase();
            const inventoryItem = gameState.inventory.find(item => 
                item.toLowerCase().includes(itemLower)
            );
            
            if (!inventoryItem) {
                addToOutput(`You don't have ${itemName} to sell.`);
                return;
            }
            
            if (!hermitShop.buyItems.includes(inventoryItem)) {
                addToOutput(`The hermit isn't interested in ${inventoryItem}.`);
                return;
            }
            
            const price = hermitShop.buyPrices[inventoryItem];
            
            if (inventoryItem === "crude dagger" && player.weapon.name === "Crude Dagger") {
                addToOutput("You can't sell your equipped weapon!");
                return;
            }
            
            const itemIndex = gameState.inventory.indexOf(inventoryItem);
            gameState.inventory.splice(itemIndex, 1);
            player.gold += price;
            
            addToOutput(`You sell the ${inventoryItem} to the hermit for ${price} gold.`, "shop");
            addToOutput(`Gold now: ${player.gold}`, "gold");
            
            updateStatus();
        }

        // SHOW shop inventory
        function showShop() {
            if (gameState.currentLocation !== "courtyard") {
                addToOutput("There's no shop here.");
                return;
            }
            
            addToOutput("HERMIT'S CART - Items for Sale:", "shop");
            addToOutput("=================================", "shop");
            
            hermitShop.items.forEach(item => {
                addToOutput(`${item.name.toUpperCase()} - ${item.price} gold: ${item.description}`);
            });
            
            addToOutput(" ", "shop");
            addToOutput("Your gold: " + player.gold, "gold");
            addToOutput(" ", "shop");
            addToOutput("The hermit will buy:", "shop");
            hermitShop.buyItems.forEach(item => {
                addToOutput(`${item.toUpperCase()} - ${hermitShop.buyPrices[item]} gold each`);
            });
            addToOutput(" ", "shop");
            addToOutput("Use BUY [item] to purchase or SELL [item] to sell.", "hint");
        }

        // Show help
        function showHelp() {
            addToOutput("CASTLE OF THE DAMMED - COMMANDS", "location");
            addToOutput("Movement: NORTH, SOUTH, EAST, WEST (or N, S, E, W)");
            addToOutput("Basic: LOOK, EXAMINE [object], TAKE [item], DROP [item], INVENTORY");
            addToOutput("Interactive: USE [item], OPEN [object], READ [object], TALK [NPC], GIVE [item] TO [NPC]");
            addToOutput("Magic: CAST [spell name] (requires spellbook and amulet of dawn)", "magic");
            addToOutput("COMBAT: ATTACK (in combat)", "combat");
            addToOutput("Shop: SHOP, BUY [item], SELL [item]", "shop");
            addToOutput("Other: LIGHT, REPAIR, EAT [food], HELP, QUIT");
            addToOutput(" ");
            addToOutput("DISCOVERY TIPS:", "hint");
            addToOutput("- Examine everything carefully for clues", "hint");
            addToOutput("- Use LOOK to see what's around you", "hint");
            addToOutput("- Some objects can only be seen with light", "hint");
            addToOutput("- Try examining things multiple times or from different angles", "hint");
            addToOutput("- Talk to NPCs for information and to access shops", "hint");
            addToOutput("- Find the spellbook and amulet of dawn to use magic", "magic");
        }

        // Quit game
        function quitGame() {
            addToOutput("Are you sure you want to quit? (Y/N)");
            
            const originalEventHandler = gameInput.onkeypress;
            
            gameInput.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    const answer = this.value.trim().toLowerCase();
                    if (answer === 'y' || answer === 'yes') {
                        addToOutput("Thanks for playing Castle of the Dammed!");
                        gameState.gameEnded = true;
                    } else {
                        addToOutput("Resuming game...");
                    }
                    
                    gameInput.onkeypress = originalEventHandler;
                    gameInput.value = '';
                    gameInput.focus();
                }
            };
        }

        window.onload = initGame;
    </script>
</body>
</html>
