<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASTLE.EXE - Castle of the Undead</title>
    <style>
        /* ====== 80s DOS STYLES ====== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'MS Sans Serif', 'Terminal', monospace;
        }

        body {
            background: #000;
            color: #C0C0C0;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 8px;
            background: #000080; /* DOS Blue background */
            border: 3px double #C0C0C0;
            margin: 4px;
        }

        /* ====== HEADER ====== */
        .dos-header {
            border-bottom: 2px solid #C0C0C0;
            padding: 4px 8px;
            margin-bottom: 8px;
            background: #0000AA;
            color: #FFFF55;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 18px;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .header-subtitle {
            font-size: 12px;
            color: #C0C0C0;
        }

        .header-time {
            font-size: 12px;
            color: #55FF55;
        }

        /* ====== MAIN CONTAINER ====== */
        .dos-container {
            display: flex;
            flex: 1;
            gap: 8px;
            min-height: 0;
        }

        /* ====== GAME OUTPUT WINDOW (TOP) ====== */
        .game-output {
            flex: 3;
            background: #000;
            border: 2px solid #C0C0C0;
            padding: 8px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            max-height: 50vh;
        }

        .output-header {
            background: #0000AA;
            color: #FFFF55;
            padding: 2px 4px;
            margin: -8px -8px 8px -8px;
            border-bottom: 1px solid #C0C0C0;
            font-size: 14px;
        }

        .output-content {
            flex: 1;
            overflow-y: auto;
            line-height: 1.4;
            font-size: 14px;
        }

        /* ====== STATUS PANEL ====== */
        .status-panel {
            flex: 1;
            background: #000;
            border: 2px solid #C0C0C0;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
        }

        .status-header {
            background: #0000AA;
            color: #FFFF55;
            padding: 2px 4px;
            margin: -8px -8px 8px -8px;
            border-bottom: 1px solid #C0C0C0;
            font-size: 14px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            border-bottom: 1px dotted #555;
            padding-bottom: 2px;
        }

        .stat-label {
            color: #55FF55;
        }

        .stat-value {
            color: #FFFF55;
            font-weight: bold;
        }

        .health-bar, .mana-bar {
            height: 12px;
            background: #550000;
            border: 1px inset #C0C0C0;
            margin-top: 2px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background: #FF0000;
            width: 100%;
        }

        .mana-fill {
            height: 100%;
            background: #0000FF;
            width: 50%;
        }

        /* ====== GAME CONTROLS ====== */
        .game-controls {
            margin-top: 8px;
            border-top: 2px solid #C0C0C0;
            padding-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: 40vh;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            flex: 2;
        }

        .controls-sidebar {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        /* ====== DOS BUTTONS ====== */
        .dos-btn {
            background: #C0C0C0;
            border: 2px outset #C0C0C0;
            color: #000;
            padding: 6px 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            font-weight: bold;
        }

        .dos-btn:active {
            border: 2px inset #C0C0C0;
        }

        .dos-btn:hover {
            background: #D0D0D0;
        }

        .dos-btn:disabled {
            color: #808080;
            cursor: not-allowed;
            background: #A0A0A0;
        }

        .btn-move {
            background: #0000AA;
            color: #FFFFFF;
            border-color: #0000FF;
        }

        .btn-action {
            background: #00AA00;
            color: #FFFFFF;
            border-color: #00FF00;
        }

        .btn-combat {
            background: #AA0000;
            color: #FFFFFF;
            border-color: #FF0000;
        }

        .btn-magic {
            background: #AA00AA;
            color: #FFFFFF;
            border-color: #FF00FF;
        }

        /* ====== INVENTORY & OBJECTS ====== */
        .inventory-window {
            background: #000;
            border: 2px inset #C0C0C0;
            padding: 6px;
            margin-top: 8px;
            max-height: 120px;
            overflow-y: auto;
        }

        .inventory-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 4px;
            border-bottom: 1px dotted #555;
        }

        .object-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }

        .object-btn {
            background: #005500;
            color: #55FF55;
            border: 1px outset #00AA00;
            padding: 3px 6px;
            font-size: 11px;
            cursor: pointer;
        }

        /* ====== SPECIAL INTERFACES ====== */
        .combat-interface, .dialogue-box, .shop-interface {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 4px double #C0C0C0;
            padding: 16px;
            z-index: 1000;
            min-width: 400px;
            display: none;
        }

        .interface-header {
            background: #AA0000;
            color: #FFFF55;
            padding: 4px;
            margin: -16px -16px 16px -16px;
            text-align: center;
            font-weight: bold;
        }

        .dialogue-header {
            background: #0000AA;
        }

        .shop-header {
            background: #AA5500;
        }

        /* ====== CLASS SELECTION ====== */
        .class-selection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0000AA;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .class-title {
            color: #FFFF00;
            font-size: 32px;
            text-shadow: 0 0 10px #FF0000;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .class-options {
            display: flex;
            gap: 20px;
        }

        .class-option {
            background: #000;
            border: 4px double #C0C0C0;
            padding: 20px;
            width: 200px;
            cursor: pointer;
            text-align: center;
        }

        .class-option:hover {
            border-color: #FFFF00;
            background: #000055;
        }

        .class-name {
            color: #FF5555;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .class-desc {
            color: #AAAAAA;
            font-size: 12px;
        }

        /* ====== MESSAGE COLORS ====== */
        .msg-system { color: #C0C0C0; }
        .msg-combat { color: #FF5555; }
        .msg-loot { color: #FFFF55; }
        .msg-npc { color: #55FFFF; }
        .msg-quest { color: #55FF55; }
        .msg-danger { color: #FF0000; font-weight: bold; }
        .msg-success { color: #00FF00; }
        .msg-magic { color: #FF55FF; }

        /* ====== SCROLLBAR ====== */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
            border: 1px inset #C0C0C0;
        }

        ::-webkit-scrollbar-thumb {
            background: #555555;
            border: 1px outset #555555;
        }

        /* ====== PROMPT ====== */
        .prompt {
            color: #FFFF00;
            font-weight: bold;
        }

        .prompt::after {
            content: "_";
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Class Selection Screen -->
    <div id="classSelection" class="class-selection">
        <div class="class-title">CASTLE OF THE UNDEAD</div>
        <div class="class-options">
            <div class="class-option" onclick="startGame('gravekeeper')">
                <div class="class-name">GRAVEKEEPER</div>
                <div class="class-desc">Master of burial rites<br>Can turn undead<br>+20 Health</div>
            </div>
            <div class="class-option" onclick="startGame('bloodmage')">
                <div class="class-name">BLOOD MAGE</div>
                <div class="class-desc">Uses life force for magic<br>Can drain enemies<br>+30 Mana</div>
            </div>
            <div class="class-option" onclick="startGame('exorcist')">
                <div class="class-name">EXORCIST</div>
                <div class="class-desc">Wields holy power<br>Strong vs spirits<br>+5 Damage vs undead</div>
            </div>
        </div>
        <div style="color: #5555FF; text-align: center; max-width: 600px; margin-top: 20px;">
            > The Castle of the Undead awaits... Choose your path.<br>
            > [Use mouse or arrow keys + ENTER to select]
        </div>
    </div>

    <!-- Main Game Interface -->
    <div id="gameInterface" style="display: none; flex: 1; flex-direction: column;">
        <!-- DOS Header -->
        <div class="dos-header">
            <div class="header-title">CASTLE.EXE</div>
            <div class="header-subtitle">Necropolis Edition v1.0</div>
            <div class="header-time" id="gameTime">23:59:45</div>
        </div>

        <!-- Main Content Area -->
        <div class="dos-container">
            <!-- Game Output Window (TOP) -->
            <div class="game-output">
                <div class="output-header">> GAME OUTPUT</div>
                <div id="outputWindow" class="output-content">
                    <div class="msg-system">> CASTLE OF THE UNDEAD initialized...</div>
                    <div class="msg-system">> Booting Necropolis Edition v1.0...</div>
                    <div class="msg-system">> Graphics: CGA compatible</div>
                    <div class="msg-system">> Memory: 640KB OK</div>
                    <div class="msg-system">> Loading game data...</div>
                    <div class="msg-success">> READY</div>
                    <div class="msg-system">> Choose your class to begin.</div>
                </div>
                <div class="prompt" id="gamePrompt">></div>
            </div>

            <!-- Status Panel -->
            <div class="status-panel">
                <div class="status-header">> STATUS</div>
                <div class="stat-row">
                    <span class="stat-label">HEALTH:</span>
                    <span id="health" class="stat-value">100/100</span>
                </div>
                <div class="health-bar">
                    <div id="healthBar" class="health-fill" style="width: 100%"></div>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">MANA:</span>
                    <span id="mana" class="stat-value">50/50</span>
                </div>
                <div class="mana-bar">
                    <div id="manaBar" class="mana-fill" style="width: 100%"></div>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">GOLD:</span>
                    <span id="gold" class="stat-value">100</span>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">LEVEL:</span>
                    <span id="level" class="stat-value">1</span>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">LOCATION:</span>
                    <span id="location" class="stat-value">ENTRANCE</span>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">WEAPON:</span>
                    <span id="weapon" class="stat-value">DAGGER</span>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">ARMOR:</span>
                    <span id="armor" class="stat-value">LEATHER</span>
                </div>
            </div>
        </div>

        <!-- Game Controls -->
        <div class="game-controls">
            <!-- Main Action Buttons -->
            <div class="controls-grid">
                <button class="dos-btn btn-move" onclick="move('north')">NORTH</button>
                <button class="dos-btn btn-move" onclick="move('south')">SOUTH</button>
                <button class="dos-btn btn-move" onclick="move('east')">EAST</button>
                <button class="dos-btn btn-move" onclick="move('west')">WEST</button>
                
                <button class="dos-btn btn-action" onclick="look()">LOOK</button>
                <button class="dos-btn btn-action" onclick="search()">SEARCH</button>
                <button class="dos-btn btn-action" onclick="takeAll()">TAKE ALL</button>
                <button class="dos-btn btn-action" onclick="examine()">EXAMINE</button>
                
                <button class="dos-btn btn-combat" onclick="attack()">ATTACK</button>
                <button class="dos-btn btn-magic" onclick="castSpell()">CAST</button>
                <button class="dos-btn btn-action" onclick="useItem()">USE ITEM</button>
                <button class="dos-btn btn-action" onclick="flee()">FLEE</button>
                
                <button class="dos-btn" onclick="talk()">TALK</button>
                <button class="dos-btn" onclick="showInventory()">INVENTORY</button>
                <button class="dos-btn" onclick="saveGame()">SAVE</button>
                <button class="dos-btn" onclick="loadGame()">LOAD</button>
            </div>

            <!-- Inventory Display -->
            <div style="display: flex; gap: 8px;">
                <div style="flex: 2;">
                    <div style="color: #55FF55; font-size: 12px;">> INVENTORY:</div>
                    <div id="inventoryDisplay" class="inventory-window">
                        <div class="inventory-item">
                            <span>TORCH</span>
                            <button class="object-btn" onclick="useItem('torch')">USE</button>
                        </div>
                        <div class="inventory-item">
                            <span>HEALTH POTION</span>
                            <button class="object-btn" onclick="useItem('health_potion')">DRINK</button>
                        </div>
                        <div class="inventory-item">
                            <span>RUSTY KEY</span>
                            <button class="object-btn" onclick="useItem('rusty_key')">USE</button>
                        </div>
                    </div>
                </div>
                
                <!-- Room Objects -->
                <div style="flex: 3;">
                    <div style="color: #55FF55; font-size: 12px;">> OBJECTS IN ROOM:</div>
                    <div id="roomObjects" class="object-list">
                        <!-- Objects will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Combat Interface -->
    <div id="combatInterface" class="combat-interface">
        <div class="interface-header">> COMBAT MODE</div>
        <div id="enemyDisplay" style="margin-bottom: 16px;">
            <div style="color: #FF5555; font-size: 16px;" id="enemyName">SPECTRAL LIBRARIAN</div>
            <div style="background: #550000; border: 1px inset #C0C0C0; height: 12px; margin: 8px 0;">
                <div id="enemyHealthBar" style="background: #FF0000; height: 100%; width: 100%;"></div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
            <button class="dos-btn btn-combat" onclick="playerAttack()">ATTACK</button>
            <button class="dos-btn btn-magic" onclick="playerCast()">CAST SPELL</button>
            <button class="dos-btn btn-action" onclick="playerUseItem()">USE ITEM</button>
            <button class="dos-btn" onclick="playerFlee()">FLEE</button>
        </div>
    </div>

    <!-- Dialogue Interface -->
    <div id="dialogueBox" class="dialogue-box">
        <div class="interface-header dialogue-header">> DIALOGUE</div>
        <div id="npcName" style="color: #55FFFF; margin-bottom: 8px;">GHOSTLY BUTLER</div>
        <div id="dialogueText" style="margin-bottom: 16px;">The master is expecting you... in the crypt.</div>
        <div id="dialogueOptions">
            <!-- Options will be added here -->
        </div>
    </div>

    <!-- Shop Interface -->
    <div id="shopInterface" class="shop-interface">
        <div class="interface-header shop-header">> SHOP</div>
        <div style="color: #FFFF55; margin-bottom: 8px;">Your Gold: <span id="shopGold">100</span></div>
        <div id="shopItems" style="margin-bottom: 16px;">
            <!-- Shop items will be added here -->
        </div>
        <button class="dos-btn" onclick="hideShop()">LEAVE SHOP</button>
    </div>

    <script>
        // ====== ENHANCED GAME DATA ======
        const gameData = {
            player: {
                class: null,
                health: 100,
                maxHealth: 100,
                mana: 50,
                maxMana: 50,
                gold: 100,
                level: 1,
                experience: 0,
                inventory: ['torch', 'health_potion', 'rusty_key', 'holy_symbol'],
                equipped: {
                    weapon: 'rusty_dagger',
                    armor: 'leather_armor'
                },
                skills: [],
                location: 'entrance_hall',
                quests: []
            },
            
            classes: {
                gravekeeper: {
                    health: 120,
                    mana: 40,
                    skills: ['turn_undead', 'consecrate', 'grave_whisper'],
                    description: 'Keeper of burial rites with power over the dead'
                },
                bloodmage: {
                    health: 80,
                    mana: 80,
                    skills: ['blood_drain', 'hemorrhage', 'life_siphon'],
                    description: 'Mage who uses life force for dark magic'
                },
                exorcist: {
                    health: 90,
                    mana: 60,
                    skills: ['holy_smite', 'banish', 'purify'],
                    description: 'Wielder of holy power against spirits'
                }
            },
            
            rooms: {
                entrance_hall: {
                    name: 'ENTRANCE HALL',
                    description: 'A grand hall with tattered banners. The air is cold and smells of decay.',
                    objects: ['stone_door', 'tattered_banner', 'wall_sconce'],
                    exits: { north: 'great_hall', east: 'armory' },
                    npc: null,
                    enemy: null,
                    items: ['rusty_key'],
                    visited: false
                },
                
                great_hall: {
                    name: 'GREAT HALL',
                    description: 'A vast hall with a long banquet table. Dust covers everything.',
                    objects: ['banquet_table', 'silver_goblet', 'chandelier'],
                    exits: { south: 'entrance_hall', west: 'library', east: 'kitchen' },
                    npc: 'ghostly_butler',
                    enemy: null,
                    items: ['silver_coin'],
                    visited: false
                },
                
                library: {
                    name: 'FORGOTTEN LIBRARY',
                    description: 'Books line the walls, most rotten to pulp. Something moves in the shadows.',
                    objects: ['ancient_tome', 'writing_desk', 'bookshelf'],
                    exits: { east: 'great_hall', north: 'secret_passage' },
                    npc: null,
                    enemy: 'spectral_librarian',
                    items: ['library_key', 'spell_scroll'],
                    visited: false
                },
                
                armory: {
                    name: 'ARMORY',
                    description: 'Weapon racks line the walls. Most weapons are rusted or broken.',
                    objects: ['weapon_rack', 'armor_stand', 'chest'],
                    exits: { west: 'entrance_hall', north: 'barracks' },
                    npc: null,
                    enemy: 'armored_skeleton',
                    items: ['iron_sword', 'steel_shield'],
                    visited: false
                }
            },
            
            objects: {
                stone_door: {
                    name: 'Stone Door',
                    description: 'A massive stone door carved with skull motifs. It appears to be locked.',
                    actions: ['examine', 'push', 'pick_lock'],
                    state: 'locked',
                    requiredKey: 'rusty_key'
                },
                tattered_banner: {
                    name: 'Tattered Banner',
                    description: 'A faded banner depicting a family crest. Might be valuable.',
                    actions: ['examine', 'take', 'burn'],
                    state: 'hanging',
                    takeable: true
                },
                ancient_tome: {
                    name: 'Ancient Tome',
                    description: 'A leather-bound book with silver clasps. It radiates magical energy.',
                    actions: ['examine', 'read', 'take'],
                    state: 'closed',
                    takeable: true,
                    value: 200
                },
                weapon_rack: {
                    name: 'Weapon Rack',
                    description: 'Holds various rusted weapons. One sword looks salvageable.',
                    actions: ['examine', 'search', 'take_sword'],
                    state: 'full',
                    hiddenItem: 'iron_sword'
                }
            },
            
            items: {
                torch: {
                    name: 'Torch',
                    type: 'tool',
                    description: 'Provides light in dark places.',
                    value: 10,
                    effect: 'light_area'
                },
                health_potion: {
                    name: 'Health Potion',
                    type: 'consumable',
                    description: 'Restores 30 health.',
                    value: 25,
                    effect: { health: 30 }
                },
                rusty_key: {
                    name: 'Rusty Key',
                    type: 'key',
                    description: 'An old, rusted key. Might open something.',
                    value: 5,
                    effect: 'unlock_door'
                },
                iron_sword: {
                    name: 'Iron Sword',
                    type: 'weapon',
                    description: 'A basic iron sword. Better than a dagger.',
                    value: 50,
                    effect: { damage: 8 }
                }
            },
            
            npcs: {
                ghostly_butler: {
                    name: 'Ghostly Butler',
                    description: 'A transparent figure in formal attire.',
                    dialogue: {
                        greet: 'The master is expecting you... in the crypt.',
                        trade: 'I have items for sale, for the right price.',
                        quest: 'Find the family crest in the armory. I will reward you.',
                        farewell: 'Watch your step... the castle is restless tonight.'
                    },
                    shop: ['silver_dagger', 'holy_water', 'ghostly_key'],
                    quest: 'find_crest',
                    questComplete: false
                }
            },
            
            enemies: {
                spectral_librarian: {
                    name: 'Spectral Librarian',
                    health: 60,
                    maxHealth: 60,
                    damage: 8,
                    loot: ['ancient_tome', 'ghost_dust', 'silver_coin'],
                    weak_to: ['holy', 'silver'],
                    experience: 75
                },
                armored_skeleton: {
                    name: 'Armored Skeleton',
                    health: 40,
                    maxHealth: 40,
                    damage: 6,
                    loot: ['iron_sword', 'bone_fragments'],
                    weak_to: ['blunt'],
                    experience: 50
                }
            },
            
            spells: {
                turn_undead: {
                    name: 'Turn Undead',
                    cost: 15,
                    damage: 25,
                    effect: 'fear_undead'
                },
                holy_smite: {
                    name: 'Holy Smite',
                    cost: 20,
                    damage: 30,
                    effect: 'holy_damage'
                },
                blood_drain: {
                    name: 'Blood Drain',
                    cost: 10,
                    damage: 15,
                    effect: 'drain_health'
                }
            }
        };

        // ====== GAME STATE ======
        let gameState = JSON.parse(JSON.stringify(gameData));
        let currentEnemy = null;
        let currentNpc = null;
        let gameActive = false;

        // ====== UI FUNCTIONS ======
        function output(message, type = 'system') {
            const outputWindow = document.getElementById('outputWindow');
            const messageDiv = document.createElement('div');
            messageDiv.className = `msg-${type}`;
            messageDiv.textContent = `> ${message}`;
            outputWindow.appendChild(messageDiv);
            outputWindow.scrollTop = outputWindow.scrollHeight;
            
            // Update prompt
            document.getElementById('gamePrompt').scrollIntoView();
        }

        function updateUI() {
            // Update status bars
            const healthPercent = (gameState.player.health / gameState.player.maxHealth) * 100;
            const manaPercent = (gameState.player.mana / gameState.player.maxMana) * 100;
            
            document.getElementById('health').textContent = 
                `${gameState.player.health}/${gameState.player.maxHealth}`;
            document.getElementById('healthBar').style.width = `${healthPercent}%`;
            
            document.getElementById('mana').textContent = 
                `${gameState.player.mana}/${gameState.player.maxMana}`;
            document.getElementById('manaBar').style.width = `${manaPercent}%`;
            
            document.getElementById('gold').textContent = gameState.player.gold;
            document.getElementById('level').textContent = gameState.player.level;
            
            // Update location
            const room = gameState.rooms[gameState.player.location];
            document.getElementById('location').textContent = room.name;
            
            // Update equipment
            document.getElementById('weapon').textContent = 
                gameState.items[gameState.player.equipped.weapon]?.name?.toUpperCase() || 'NONE';
            document.getElementById('armor').textContent = 
                gameState.items[gameState.player.equipped.armor]?.name?.toUpperCase() || 'NONE';
            
            updateInventory();
            updateRoomObjects();
        }

        function updateInventory() {
            const inventoryDisplay = document.getElementById('inventoryDisplay');
            inventoryDisplay.innerHTML = '';
            
            gameState.player.inventory.forEach(itemId => {
                const item = gameState.items[itemId];
                if (!item) return;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';
                itemDiv.innerHTML = `
                    <span>${item.name.toUpperCase()}</span>
                    <button class="object-btn" onclick="useInventoryItem('${itemId}')">USE</button>
                `;
                inventoryDisplay.appendChild(itemDiv);
            });
            
            if (gameState.player.inventory.length === 0) {
                inventoryDisplay.innerHTML = '<div style="color: #555;">> EMPTY</div>';
            }
        }

        function updateRoomObjects() {
            const roomObjectsDiv = document.getElementById('roomObjects');
            roomObjectsDiv.innerHTML = '';
            
            const room = gameState.rooms[gameState.player.location];
            
            room.objects.forEach(objectId => {
                const obj = gameState.objects[objectId];
                if (!obj) return;
                
                const button = document.createElement('button');
                button.className = 'object-btn';
                button.textContent = obj.name.toUpperCase();
                button.onclick = () => interactWithObject(objectId);
                roomObjectsDiv.appendChild(button);
            });
            
            if (room.objects.length === 0) {
                roomObjectsDiv.innerHTML = '<div style="color: #555;">> NO OBJECTS</div>';
            }
        }

        // ====== GAME FUNCTIONS ======
        function startGame(className) {
            gameState.player.class = className;
            const classData = gameState.classes[className];
            
            // Apply class bonuses
            gameState.player.maxHealth = classData.health;
            gameState.player.health = classData.health;
            gameState.player.maxMana = classData.mana;
            gameState.player.mana = classData.mana;
            gameState.player.skills = [...classData.skills];
            
            // Hide class selection, show game
            document.getElementById('classSelection').style.display = 'none';
            document.getElementById('gameInterface').style.display = 'flex';
            
            output(`CLASS SELECTED: ${className.toUpperCase()}`, 'success');
            output(classData.description, 'system');
            output('You stand before the Castle of the Undead. The gates creak open...', 'danger');
            
            look();
            updateUI();
            gameActive = true;
            
            // Start game clock
            updateGameTime();
            setInterval(updateGameTime, 1000);
        }

        function updateGameTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('gameTime').textContent = timeString;
        }

        function move(direction) {
            if (!gameActive) return;
            
            const room = gameState.rooms[gameState.player.location];
            
            if (!room.exits[direction]) {
                output(`You cannot go ${direction.toUpperCase()}.`, 'system');
                return;
            }
            
            const newLocation = room.exits[direction];
            gameState.player.location = newLocation;
            
            output(`You move ${direction.toUpperCase()}.`, 'system');
            
            // Check if room is visited for the first time
            if (!gameState.rooms[newLocation].visited) {
                gameState.rooms[newLocation].visited = true;
                output(`*** NEW AREA DISCOVERED: ${gameState.rooms[newLocation].name} ***`, 'success');
            }
            
            look();
            updateUI();
        }

        function look() {
            const room = gameState.rooms[gameState.player.location];
            
            output(`=== ${room.name} ===`, 'system');
            output(room.description, 'system');
            
            if (room.npc && !gameState.npcs[room.npc]?.questComplete) {
                const npc = gameState.npcs[room.npc];
                output(`${npc.name} is here.`, 'npc');
            }
            
            if (room.enemy && !room.enemy.defeated) {
                const enemy = gameState.enemies[room.enemy];
                output(`A ${enemy.name} blocks your path!`, 'danger');
                startCombat(room.enemy);
            }
            
            if (room.items && room.items.length > 0) {
                output(`You see items: ${room.items.map(id => gameState.items[id]?.name || id).join(', ')}`, 'loot');
            }
            
            output(`Exits: ${Object.keys(room.exits).map(d => d.toUpperCase()).join(', ')}`, 'system');
        }

        function search() {
            const room = gameState.rooms[gameState.player.location];
            let foundSomething = false;
            
            // Search objects for hidden items
            room.objects.forEach(objectId => {
                const obj = gameState.objects[objectId];
                if (obj.hiddenItem && !room.items.includes(obj.hiddenItem)) {
                    room.items.push(obj.hiddenItem);
                    output(`You find ${gameState.items[obj.hiddenItem]?.name || obj.hiddenItem} hidden in the ${obj.name.toLowerCase()}!`, 'loot');
                    foundSomething = true;
                    delete obj.hiddenItem;
                }
            });
            
            // Search room for hidden exits
            if (Math.random() > 0.7 && !room.exits.hidden) {
                room.exits.hidden = 'secret_room';
                output('You discover a hidden passage!', 'success');
                foundSomething = true;
            }
            
            if (!foundSomething) {
                output('You search thoroughly but find nothing.', 'system');
            }
            
            updateUI();
        }

        function interactWithObject(objectId) {
            const room = gameState.rooms[gameState.player.location];
            const obj = gameState.objects[objectId];
            
            if (!obj || !room.objects.includes(objectId)) {
                output('That object is not here.', 'system');
                return;
            }
            
            // Show available actions
            output(`Interacting with ${obj.name}:`, 'system');
            output(`Description: ${obj.description}`, 'system');
            output(`Available actions: ${obj.actions.join(', ')}`, 'system');
            
            // Handle specific object types
            if (obj.state === 'locked' && obj.requiredKey) {
                if (gameState.player.inventory.includes(obj.requiredKey)) {
                    output('You have the key to unlock this!', 'success');
                } else {
                    output(`It requires a ${gameState.items[obj.requiredKey]?.name || obj.requiredKey} to unlock.`, 'system');
                }
            }
            
            if (obj.takeable && !gameState.player.inventory.includes(objectId)) {
                output('You can take this object.', 'system');
                if (confirm(`Take ${obj.name}?`)) {
                    takeObject(objectId);
                }
            }
        }

        function takeObject(objectId) {
            const room = gameState.rooms[gameState.player.location];
            const obj = gameState.objects[objectId];
            
            if (!obj.takeable) {
                output('You cannot take that.', 'system');
                return;
            }
            
            // Remove from room, add to inventory
            const index = room.objects.indexOf(objectId);
            if (index > -1) {
                room.objects.splice(index, 1);
            }
            gameState.player.inventory.push(objectId);
            
            output(`You take the ${obj.name}.`, 'success');
            updateUI();
        }

        function takeAll() {
            const room = gameState.rooms[gameState.player.location];
            
            if (room.items.length === 0) {
                output('There is nothing to take.', 'system');
                return;
            }
            
            room.items.forEach(itemId => {
                gameState.player.inventory.push(itemId);
                output(`You take ${gameState.items[itemId]?.name || itemId}.`, 'success');
            });
            
            room.items = [];
            updateUI();
        }

        function useInventoryItem(itemId) {
            const item = gameState.items[itemId];
            
            if (!item) {
                output('You do not have that item.', 'system');
                return;
            }
            
            output(`Using ${item.name}...`, 'system');
            
            switch(item.type) {
                case 'consumable':
                    if (item.effect.health) {
                        gameState.player.health = Math.min(
                            gameState.player.maxHealth,
                            gameState.player.health + item.effect.health
                        );
                        output(`You restore ${item.effect.health} health.`, 'success');
                        
                        // Remove from inventory
                        const index = gameState.player.inventory.indexOf(itemId);
                        if (index > -1) {
                            gameState.player.inventory.splice(index, 1);
                        }
                    }
                    break;
                    
                case 'weapon':
                    gameState.player.equipped.weapon = itemId;
                    output(`You equip the ${item.name}.`, 'success');
                    break;
                    
                case 'key':
                    output(`This key might unlock something.`, 'system');
                    // Key usage would be context-specific
                    break;
                    
                default:
                    output(`You use the ${item.name}.`, 'system');
            }
            
            updateUI();
        }

        function examine() {
            const room = gameState.rooms[gameState.player.location];
            output(`Examining the area closely...`, 'system');
            output(room.description, 'system');
            
            // More detailed examination
            if (room.objects.length > 0) {
                output(`Notable objects: ${room.objects.map(id => gameState.objects[id]?.name).join(', ')}`, 'system');
            }
        }

        function talk() {
            const room = gameState.rooms[gameState.player.location];
            
            if (!room.npc) {
                output('There is no one here to talk to.', 'system');
                return;
            }
            
            currentNpc = gameState.npcs[room.npc];
            const dialogueBox = document.getElementById('dialogueBox');
            
            // Show dialogue box
            dialogueBox.style.display = 'block';
            document.getElementById('npcName').textContent = currentNpc.name;
            document.getElementById('dialogueText').textContent = currentNpc.dialogue.greet;
            
            // Create dialogue options
            const optionsDiv = document.getElementById('dialogueOptions');
            optionsDiv.innerHTML = '';
            
            // Add dialogue options
            const option1 = document.createElement('button');
            option1.className = 'dos-btn';
            option1.textContent = 'ASK ABOUT TRADE';
            option1.onclick = () => {
                document.getElementById('dialogueText').textContent = currentNpc.dialogue.trade;
                showShop(currentNpc.shop);
            };
            optionsDiv.appendChild(option1);
            
            if (!currentNpc.questComplete) {
                const option2 = document.createElement('button');
                option2.className = 'dos-btn';
                option2.textContent = 'ASK ABOUT QUESTS';
                option2.onclick = () => {
                    document.getElementById('dialogueText').textContent = currentNpc.dialogue.quest;
                    gameState.player.quests.push(currentNpc.quest);
                    output(`QUEST ACCEPTED: ${currentNpc.quest.toUpperCase()}`, 'quest');
                };
                optionsDiv.appendChild(option2);
            }
            
            const option3 = document.createElement('button');
            option3.className = 'dos-btn';
            option3.textContent = 'SAY GOODBYE';
            option3.onclick = () => {
                document.getElementById('dialogueText').textContent = currentNpc.dialogue.farewell;
                setTimeout(() => {
                    dialogueBox.style.display = 'none';
                }, 1000);
            };
            optionsDiv.appendChild(option3);
        }

        function showShop(items) {
            const shopInterface = document.getElementById('shopInterface');
            const shopItemsDiv = document.getElementById('shopItems');
            const shopGold = document.getElementById('shopGold');
            
            shopInterface.style.display = 'block';
            shopGold.textContent = gameState.player.gold;
            shopItemsDiv.innerHTML = '';
            
            items.forEach(itemId => {
                const item = gameState.items[itemId];
                if (!item) return;
                
                const itemDiv = document.createElement('div');
                itemDiv.style.display = 'flex';
                itemDiv.style.justifyContent = 'space-between';
                itemDiv.style.marginBottom = '4px';
                itemDiv.style.padding = '4px';
                itemDiv.style.background = '#111';
                
                itemDiv.innerHTML = `
                    <span>${item.name.toUpperCase()} - ${item.value} GOLD</span>
                    <button class="object-btn" onclick="buyItem('${itemId}')">BUY</button>
                `;
                
                shopItemsDiv.appendChild(itemDiv);
            });
        }

        function hideShop() {
            document.getElementById('shopInterface').style.display = 'none';
        }

        function buyItem(itemId) {
            const item = gameState.items[itemId];
            
            if (!item) {
                output('Item not available.', 'system');
                return;
            }
            
            if (gameState.player.gold < item.value) {
                output(`Not enough gold! You need ${item.value} but only have ${gameState.player.gold}.`, 'system');
                return;
            }
            
            gameState.player.gold -= item.value;
            gameState.player.inventory.push(itemId);
            
            output(`You buy ${item.name} for ${item.value} gold.`, 'success');
            
            // Update shop display
            document.getElementById('shopGold').textContent = gameState.player.gold;
            updateUI();
        }

        // ====== COMBAT SYSTEM ======
        function startCombat(enemyId) {
            currentEnemy = { ...gameState.enemies[enemyId], id: enemyId };
            gameActive = false;
            
            const combatInterface = document.getElementById('combatInterface');
            combatInterface.style.display = 'block';
            
            document.getElementById('enemyName').textContent = currentEnemy.name;
            updateEnemyHealth();
            
            output(`COMBAT STARTED! You face a ${currentEnemy.name}!`, 'danger');
        }

        function updateEnemyHealth() {
            const healthBar = document.getElementById('enemyHealthBar');
            const percent = Math.max(0, (currentEnemy.health / currentEnemy.maxHealth) * 100);
            healthBar.style.width = `${percent}%`;
        }

        function playerAttack() {
            if (!currentEnemy) return;
            
            // Calculate damage
            const weapon = gameState.items[gameState.player.equipped.weapon];
            const baseDamage = weapon?.effect?.damage || 5;
            const damage = baseDamage + Math.floor(Math.random() * 6);
            
            currentEnemy.health -= damage;
            output(`You attack for ${damage} damage!`, 'combat');
            
            if (currentEnemy.health <= 0) {
                endCombat(true);
                return;
            }
            
            // Enemy counterattack
            enemyTurn();
        }

        function playerCast() {
            if (!currentEnemy) return;
            
            const skills = gameState.player.skills;
            if (skills.length === 0) {
                output('You have no spells!', 'system');
                return;
            }
            
            // Use first available spell
            const spellId = skills[0];
            const spell = gameState.spells[spellId];
            
            if (gameState.player.mana < spell.cost) {
                output(`Not enough mana! Need ${spell.cost}, have ${gameState.player.mana}.`, 'system');
                return;
            }
            
            gameState.player.mana -= spell.cost;
            const damage = spell.damage + Math.floor(Math.random() * 10);
            
            currentEnemy.health -= damage;
            output(`You cast ${spell.name} for ${damage} damage!`, 'magic');
            
            if (currentEnemy.health <= 0) {
                endCombat(true);
                return;
            }
            
            enemyTurn();
            updateUI();
        }

        function enemyTurn() {
            if (!currentEnemy) return;
            
            const damage = currentEnemy.damage + Math.floor(Math.random() * 4);
            gameState.player.health -= damage;
            
            output(`${currentEnemy.name} attacks you for ${damage} damage!`, 'danger');
            updateEnemyHealth();
            
            if (gameState.player.health <= 0) {
                gameOver();
                return;
            }
            
            updateUI();
        }

        function endCombat(victorious) {
            const combatInterface = document.getElementById('combatInterface');
            combatInterface.style.display = 'none';
            
            if (victorious) {
                output(`You defeated the ${currentEnemy.name}!`, 'success');
                
                // Give loot
                if (currentEnemy.loot) {
                    currentEnemy.loot.forEach(itemId => {
                        gameState.player.inventory.push(itemId);
                        output(`You find: ${gameState.items[itemId]?.name || itemId}`, 'loot');
                    });
                }
                
                // Give experience
                gameState.player.experience += currentEnemy.experience;
                checkLevelUp();
                
                // Mark enemy as defeated
                const room = gameState.rooms[gameState.player.location];
                room.enemy = null;
            }
            
            currentEnemy = null;
            gameActive = true;
            updateUI();
        }

        function gameOver() {
            output('=== YOU HAVE BEEN DEFEATED ===', 'danger');
            output('GAME OVER', 'danger');
            output('Press F5 to restart', 'system');
            
            gameActive = false;
        }

        function checkLevelUp() {
            const neededExp = gameState.player.level * 100;
            
            if (gameState.player.experience >= neededExp) {
                gameState.player.level++;
                gameState.player.experience -= neededExp;
                
                gameState.player.maxHealth += 20;
                gameState.player.health = gameState.player.maxHealth;
                gameState.player.maxMana += 10;
                gameState.player.mana = gameState.player.maxMana;
                
                output(`=== LEVEL UP! You are now level ${gameState.player.level}! ===`, 'success');
                output(`Health: +20, Mana: +10`, 'success');
                updateUI();
            }
        }

        function flee() {
            if (!currentEnemy) {
                output('You are not in combat.', 'system');
                return;
            }
            
            if (Math.random() > 0.3) {
                output('You successfully flee from combat!', 'system');
                endCombat(false);
            } else {
                output('You fail to flee!', 'danger');
                enemyTurn();
            }
        }

        // ====== SYSTEM FUNCTIONS ======
        function saveGame() {
            const saveData = {
                player: gameState.player,
                rooms: gameState.rooms,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('castleSave', JSON.stringify(saveData));
            output('Game saved successfully!', 'success');
        }

        function loadGame() {
            const saveData = localStorage.getItem('castleSave');
            if (!saveData) {
                output('No save game found.', 'system');
                return;
            }
            
            try {
                const save = JSON.parse(saveData);
                gameState.player = save.player;
                gameState.rooms = save.rooms;
                
                output('Game loaded successfully!', 'success');
                look();
                updateUI();
            } catch (e) {
                output('Error loading save game.', 'danger');
            }
        }

        function showInventory() {
            output('=== INVENTORY ===', 'system');
            gameState.player.inventory.forEach(itemId => {
                const item = gameState.items[itemId];
                if (item) {
                    output(`${item.name} - ${item.description}`, 'system');
                }
            });
            
            if (gameState.player.inventory.length === 0) {
                output('Your inventory is empty.', 'system');
            }
        }

        // ====== KEYBOARD CONTROLS ======
        document.addEventListener('keydown', (e) => {
            if (!gameActive) return;
            
            switch(e.key.toUpperCase()) {
                case 'ARROWUP':
                case 'W':
                    move('north');
                    break;
                case 'ARROWDOWN':
                case 'S':
                    move('south');
                    break;
                case 'ARROWRIGHT':
                case 'D':
                    move('east');
                    break;
                case 'ARROWLEFT':
                case 'A':
                    move('west');
                    break;
                case ' ':
                    look();
                    break;
                case 'E':
                    examine();
                    break;
                case 'F':
                    search();
                    break;
                case 'I':
                    showInventory();
                    break;
                case 'T':
                    talk();
                    break;
                case '1':
                    if (currentEnemy) playerAttack();
                    break;
                case '2':
                    if (currentEnemy) playerCast();
                    break;
                case '3':
                    if (currentEnemy) playerFlee();
                    break;
                case 'ESCAPE':
                    if (currentEnemy) endCombat(false);
                    hideShop();
                    document.getElementById('dialogueBox').style.display = 'none';
                    break;
            }
        });

        // Initialize
        window.onload = function() {
            output('Castle of the Undead - NECROPOLIS EDITION', 'danger');
            output('A text adventure game by Dark Arts Software', 'system');
            output('=============================================', 'system');
            output('Press any key on class screen to select...', 'system');
            
            // Add keyboard support for class selection
            document.addEventListener('keydown', handleClassSelection);
        };

        function handleClassSelection(e) {
            if (document.getElementById('classSelection').style.display === 'none') return;
            
            switch(e.key) {
                case '1':
                    startGame('gravekeeper');
                    break;
                case '2':
                    startGame('bloodmage');
                    break;
                case '3':
                    startGame('exorcist');
                    break;
            }
        }

        // Alias functions for button compatibility
        window.playerFlee = flee;
        window.playerUseItem = () => {
            output('Select an item from your inventory to use.', 'system');
        };
        window.castSpell = () => {
            if (currentEnemy) {
                playerCast();
            } else {
                output('You are not in combat.', 'system');
            }
        };
        window.attack = () => {
            if (currentEnemy) {
                playerAttack();
            } else {
                output('You are not in combat.', 'system');
            }
        };
        window.useItem = () => {
            output('Select an item from your inventory.', 'system');
        };
    </script>
</body>
</html>
