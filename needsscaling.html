<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Castle of the Undead 1984 ‚Äî EQUIPMENT RPG</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        /* ---------- CCS RETRO TERMINAL ‚Äì MOBILE + AUDIO ---------- */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 12px;
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .game-header {
            text-align: center;
            margin-bottom: 12px;
            border-bottom: 1px dashed #fff;
            padding-bottom: 8px;
        }
        .game-title {
            font-size: 20px;
            margin-bottom: 6px;
            text-shadow: 0 0 5px #fff;
        }
        .game-subtitle {
            font-size: 9px;
            color: #ccc;
            margin-bottom: 3px;
        }

        /* ---------- STATUS BAR ‚Äì with mute toggle ---------- */
        .status-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            background-color: #222;
            border: 1px solid #444;
            padding: 8px 10px;
            margin-bottom: 12px;
            font-size: 10px;
            row-gap: 6px;
        }
        .status-item {
            display: flex;
            align-items: center;
            margin-right: 8px;
        }
        .health-bar, .mp-bar {
            width: 70px;
            height: 10px;
            background-color: #333;
            margin-left: 5px;
            border: 1px solid #555;
        }
        .health-fill { height: 100%; background-color: #ff5555; transition: width 0.2s; }
        .mp-fill { height: 100%; background-color: #55aaff; transition: width 0.2s; }

        /* mute button */
        .mute-btn {
            background: #000;
            border: 1px solid #fff;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            padding: 4px 8px;
            cursor: pointer;
            margin-left: auto;
        }
        .mute-btn.active {
            background-color: #ff0000;
            color: #fff;
            border-color: #ff0000;
        }

        /* ---------- GAME OUTPUT ---------- */
        .game-container {
            border: 2px solid #fff;
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            min-height: 0;
            margin-bottom: 12px;
        }
        .game-output {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 12px;
            background-color: #111;
            border: 1px solid #333;
            font-size: 12px;
            line-height: 1.5;
            max-height: 35vh;
        }
        .game-output p { margin-bottom: 8px; animation: fadeIn 0.2s; }
        .game-output .location { color: #ffff00; }
        .game-output .hint { color: #888; font-size: 10px; }
        .game-output .victory { color: #ffff55; }
        .game-output .gold { color: #ffd700; }
        .game-output .damage { color: #ff9966; }
        .game-output .skill { color: #55aaff; }
        .game-output .stat { color: #88ddff; }
        .game-output .magic { color: #ff66ff; }
        .game-output .rare { color: #ff66aa; }
        .game-output .epic { color: #aa66ff; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ---------- TOUCH BUTTON GRID ‚Äì PORTRAIT ---------- */
        .button-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 5px;
        }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            background: #1a1a1a;
            padding: 10px;
            border: 1px solid #444;
        }
        .btn-label {
            color: #aaa;
            font-size: 10px;
            width: 100%;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .cmd-btn {
            background-color: #000;
            border: 2px solid #fff;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 11px;
            padding: 12px 10px;
            cursor: pointer;
            transition: 0.05s;
            text-shadow: 0 0 2px #fff;
            flex: 1 0 calc(33.33% - 8px);
            min-width: 90px;
            text-align: center;
            line-height: 1.2;
            word-break: break-word;
            -webkit-tap-highlight-color: transparent;
        }
        .cmd-btn:active {
            background-color: #0f0;
            color: #000;
            border-color: #0f0;
        }
        #skills-container .cmd-btn { flex: 1 0 calc(50% - 8px); }
        #stat-points-container .cmd-btn { flex: 1 0 calc(25% - 8px); min-width: 70px; font-size: 10px; }

        /* ---------- EQUIPMENT PANEL (toggleable) ---------- */
        .equipment-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 5px;
            background: #1a1a1a;
            padding: 12px;
            border: 2px solid #fff;
        }
        .equipment-slots, .inventory-equipment {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            background: #111;
            padding: 10px;
            border: 1px solid #444;
        }
        .slot-btn, .inv-item-btn {
            background-color: #000;
            border: 2px solid #aaa;
            color: #ddd;
            font-family: 'Press Start 2P', monospace;
            font-size: 9px;
            padding: 8px 5px;
            cursor: pointer;
            flex: 1 0 calc(25% - 6px);
            min-width: 70px;
            text-align: center;
            word-break: break-word;
        }
        .slot-btn.equipped { border-color: #0f0; background: #030; }
        .inv-item-btn { border-color: #88f; background: #112; }

        @media (max-width: 450px) {
            body { padding: 8px; }
            .game-title { font-size: 18px; }
            .cmd-btn { font-size: 10px; padding: 10px 6px; min-width: 70px; }
            .status-bar { font-size: 9px; }
            .health-bar, .mp-bar { width: 60px; }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1 class="game-title">‚öî CASTLE 1984 ‚öî</h1>
        <p class="game-subtitle">FULL EQUIPMENT ¬∑ DUAL WIELD ¬∑ SET BONUS</p>
        <p class="game-subtitle">TAP ¬∑ FIGHT ¬∑ EQUIP</p>
    </div>
    
    <!-- ===== STATUS BAR with MUTE TOGGLE ===== -->
    <div class="status-bar" id="status-bar">
        <div class="status-item">
            HP <span id="player-hp-text">100/100</span>
            <div class="health-bar"><div class="health-fill" id="player-health-fill" style="width:100%"></div></div>
        </div>
        <div class="status-item">
            MP <span id="player-mp-text">50/50</span>
            <div class="mp-bar"><div class="mp-fill" id="player-mp-fill" style="width:100%"></div></div>
        </div>
        <div class="status-item">
            LV<span id="player-level">1</span> XP<span id="player-xp">0/100</span>
        </div>
        <div class="status-item">
            ‚öî<span id="player-atk">30</span> üõ°<span id="player-def">20</span>
        </div>
        <div class="status-item">
            üí∞<span id="player-gold">30</span> üéí<span id="inventory-count">0</span>
        </div>
        <button id="mute-toggle" class="mute-btn">üîä</button>
    </div>
    
    <!-- ===== MAIN OUTPUT ===== -->
    <div class="game-container">
        <div class="game-output" id="game-output"></div>
        
        <!-- ===== BUTTON GRID ‚Äì ALL ACTIONS ===== -->
        <div class="button-panel">
            <!-- ROW 1: BATTLE -->
            <div class="btn-group">
                <span class="btn-label">‚öî BATTLE</span>
                <button class="cmd-btn" id="btn-search">SEARCH</button>
                <button class="cmd-btn" id="btn-attack">ATTACK</button>
                <button class="cmd-btn" id="btn-defend">DEFEND</button>
                <button class="cmd-btn" id="btn-flee">FLEE</button>
                <button class="cmd-btn" id="btn-rest">REST</button>
                <button class="cmd-btn" id="btn-stats">STATS</button>
            </div>
            <!-- ROW 2: SKILLS (dynamic) -->
            <div class="btn-group" id="skills-container">
                <span class="btn-label">‚ú® SKILLS</span>
            </div>
            <!-- ROW 3: ITEMS -->
            <div class="btn-group">
                <span class="btn-label">üß™ ITEMS</span>
                <button class="cmd-btn" id="btn-use-hpotion">HEALTH POT</button>
                <button class="cmd-btn" id="btn-use-ether">ETHER</button>
                <button class="cmd-btn" id="btn-inventory">SHOW BAG</button>
            </div>
            <!-- ROW 4: SHOP & UPGRADES -->
            <div class="btn-group" id="shop-group">
                <span class="btn-label">üè™ SHOP</span>
                <button class="cmd-btn" id="btn-shop">INFO</button>
                <button class="cmd-btn" id="btn-buy-potion">BUY POTION</button>
                <button class="cmd-btn" id="btn-buy-ether">BUY ETHER</button>
                <button class="cmd-btn" id="btn-upgrade-weapon">UP SWORD</button>
                <button class="cmd-btn" id="btn-upgrade-armor">UP ARMOR</button>
            </div>
            <!-- ROW 5: EQUIPMENT TOGGLE & QUEST -->
            <div class="btn-group">
                <span class="btn-label">‚öôÔ∏è GEAR</span>
                <button class="cmd-btn" id="btn-toggle-equip">EQUIP SCREEN</button>
                <button class="cmd-btn" id="btn-quest-log">QUEST LOG</button>
                <button class="cmd-btn" id="btn-save">SAVE</button>
                <button class="cmd-btn" id="btn-load">LOAD</button>
                <button class="cmd-btn" id="btn-restart">RESTART</button>
            </div>
            <!-- ROW 6: LEVEL UP (visible when points > 0) -->
            <div class="btn-group" id="stat-points-container" style="display: none;">
                <span class="btn-label">‚¨ÜÔ∏è LEVEL UP</span>
                <button class="cmd-btn" id="btn-inc-str">STR</button>
                <button class="cmd-btn" id="btn-inc-dex">DEX</button>
                <button class="cmd-btn" id="btn-inc-int">INT</button>
                <button class="cmd-btn" id="btn-inc-vit">VIT</button>
            </div>
        </div>

        <!-- ===== EQUIPMENT PANEL (initially hidden) ===== -->
        <div id="equipment-panel" class="equipment-panel" style="display: none;">
            <div class="btn-label">üõ°Ô∏è EQUIPPED SLOTS</div>
            <div class="equipment-slots" id="equipment-slots-container">
                <!-- slot buttons will be injected by JS -->
            </div>
            <div class="btn-label">üì¶ EQUIPMENT BAG</div>
            <div class="inventory-equipment" id="inventory-equipment-container">
                <!-- inventory equipment items will be injected by JS -->
            </div>
            <button class="cmd-btn" id="btn-close-equip">CLOSE</button>
        </div>
    </div>

    <script>
        // =================================================================
        // CASTLE OF THE UNDEAD 1984 ‚Äî FULL EQUIPMENT RPG (Web Audio API)
        // =================================================================

        // ---------- WEB AUDIO ENGINE (same, with extra sounds) ----------
        const AudioManager = (function() {
            let audioCtx = null;
            let muted = false;

            function initContext() {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                return audioCtx;
            }

            function playSound(type, pitch = 800, duration = 0.1, vol = 0.2) {
                if (muted) return;
                try {
                    const ctx = initContext();
                    const osc = ctx.createOscillator();
                    const gainNode = ctx.createGain();
                    osc.type = type;
                    osc.frequency.value = pitch;
                    gainNode.gain.setValueAtTime(vol, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
                    osc.connect(gainNode);
                    gainNode.connect(ctx.destination);
                    osc.start();
                    osc.stop(ctx.currentTime + duration);
                } catch (e) {}
            }

            return {
                init: function() { initContext(); },
                toggleMute: function() { muted = !muted; return muted; },
                isMuted: () => muted,
                click: function() { playSound('square', 880, 0.05, 0.1); },
                encounter: function() { /* noise same as before */ 
                    if (muted) return;
                    try { const ctx = initContext();
                        const noise = ctx.createBufferSource();
                        const buffer = ctx.createBuffer(1, ctx.sampleRate * 0.2, ctx.sampleRate);
                        const data = buffer.getChannelData(0);
                        for (let i = 0; i < buffer.length; i++) data[i] = Math.random() * 2 - 1;
                        noise.buffer = buffer;
                        const gain = ctx.createGain();
                        gain.gain.setValueAtTime(0.15, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
                        noise.connect(gain);
                        gain.connect(ctx.destination);
                        noise.start();
                        noise.stop(ctx.currentTime + 0.3);
                    } catch(e) {}
                },
                attack: function() { playSound('sawtooth', 220, 0.15, 0.15); },
                enemyHit: function() { playSound('square', 180, 0.1, 0.12); },
                playerHit: function() { playSound('sawtooth', 120, 0.2, 0.18); },
                victory: function() { /* arpeggio */
                    if (muted) return;
                    try { const ctx = initContext();
                        const now = ctx.currentTime;
                        [523.25, 659.25, 783.99].forEach((freq, i) => {
                            const osc = ctx.createOscillator();
                            const gain = ctx.createGain();
                            osc.frequency.value = freq;
                            osc.type = 'square';
                            gain.gain.setValueAtTime(0.1, now + i * 0.08);
                            gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.08 + 0.2);
                            osc.connect(gain);
                            gain.connect(ctx.destination);
                            osc.start(now + i * 0.08);
                            osc.stop(now + i * 0.08 + 0.2);
                        });
                    } catch(e) {}
                },
                levelUp: function() { /* fanfare */
                    if (muted) return;
                    try { const ctx = initContext();
                        const now = ctx.currentTime;
                        [392, 523.25, 659.25, 783.99, 1046.5].forEach((freq,i) => {
                            const osc = ctx.createOscillator();
                            const gain = ctx.createGain();
                            osc.frequency.value = freq;
                            osc.type = 'triangle';
                            gain.gain.setValueAtTime(0.12, now + i * 0.1);
                            gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.25);
                            osc.connect(gain);
                            gain.connect(ctx.destination);
                            osc.start(now + i * 0.1);
                            osc.stop(now + i * 0.1 + 0.25);
                        });
                    } catch(e) {}
                },
                heal: function() { playSound('sine', 740, 0.25, 0.2); },
                error: function() { playSound('square', 180, 0.2, 0.12); },
                item: function() { playSound('sine', 1200, 0.08, 0.1); },
                purchase: function() { playSound('square', 600, 0.1, 0.12); },
                flee: function() { playSound('sawtooth', 300, 0.2, 0.1); },
                rest: function() { playSound('sine', 500, 0.3, 0.15); },
                equip: function() { playSound('square', 1100, 0.06, 0.1); },
                poison: function() { playSound('sawtooth', 90, 0.4, 0.12); }
            };
        })();

        // ---------- ITEM DATABASE (equipment) ----------
        const ItemDB = {
            // Weapons
            "Rusty Sword": { name: "Rusty Sword", slot: "mainHand", type: "sword", bonusAtk: 5, bonusStr: 1, value: 30, rarity: "common", req: { str: 5 } },
            "Iron Sword": { name: "Iron Sword", slot: "mainHand", type: "sword", bonusAtk: 10, bonusStr: 2, value: 80, rarity: "uncommon", req: { str: 8 } },
            "Dagger": { name: "Dagger", slot: "offHand", type: "dagger", bonusAtk: 4, bonusDex: 2, bonusCrit: 0.03, value: 35, rarity: "common", req: { dex: 6 } },
            "Wooden Shield": { name: "Wooden Shield", slot: "offHand", type: "shield", bonusDef: 6, bonusVit: 1, block: 0.15, value: 25, rarity: "common" },
            "Iron Shield": { name: "Iron Shield", slot: "offHand", type: "shield", bonusDef: 12, bonusVit: 2, block: 0.2, value: 70, rarity: "uncommon", req: { str: 10 } },
            "Battle Axe": { name: "Battle Axe", slot: "mainHand", type: "axe", bonusAtk: 15, bonusStr: 3, value: 110, rarity: "rare", req: { str: 14 } },
            "Staff": { name: "Staff", slot: "mainHand", type: "staff", bonusInt: 4, bonusMP: 10, magicPower: 8, value: 45, rarity: "common", req: { int: 8 } },
            // Armor
            "Leather Armor": { name: "Leather Armor", slot: "chest", type: "light", bonusDef: 4, bonusVit: 1, value: 25, rarity: "common" },
            "Chainmail": { name: "Chainmail", slot: "chest", type: "heavy", bonusDef: 10, bonusVit: 2, value: 60, rarity: "uncommon", req: { str: 10 } },
            "Iron Helm": { name: "Iron Helm", slot: "head", type: "heavy", bonusDef: 5, bonusVit: 1, value: 40, rarity: "common", req: { str: 8 } },
            "Leather Cap": { name: "Leather Cap", slot: "head", type: "light", bonusDef: 2, bonusDex: 1, value: 18, rarity: "common" },
            "Gauntlets": { name: "Gauntlets", slot: "hands", type: "heavy", bonusDef: 3, bonusAtk: 2, value: 35, rarity: "common", req: { str: 8 } },
            "Leather Gloves": { name: "Leather Gloves", slot: "hands", type: "light", bonusDex: 2, bonusCrit: 0.02, value: 22, rarity: "common" },
            "Greaves": { name: "Greaves", slot: "legs", type: "heavy", bonusDef: 4, bonusVit: 1, value: 38, rarity: "common" },
            "Leather Boots": { name: "Leather Boots", slot: "feet", type: "light", bonusDex: 2, bonusDodge: 0.03, value: 20, rarity: "common" },
            "Iron Boots": { name: "Iron Boots", slot: "feet", type: "heavy", bonusDef: 6, bonusVit: 1, value: 45, rarity: "uncommon", req: { str: 9 } },
            // Accessories
            "Ring of Strength": { name: "Ring of Strength", slot: "accessory1", type: "ring", bonusStr: 3, value: 55, rarity: "rare" },
            "Ring of Dexterity": { name: "Ring of Dexterity", slot: "accessory1", type: "ring", bonusDex: 3, value: 55, rarity: "rare" },
            "Amulet of Health": { name: "Amulet of Health", slot: "accessory2", type: "amulet", bonusHP: 20, value: 60, rarity: "rare" }
        };

        // ---------- SET BONUS DEFINITIONS ----------
        const SetBonuses = {
            "Iron Set": { pieces: ["Iron Helm", "Chainmail", "Gauntlets", "Greaves", "Iron Boots"], bonus: { bonusDef: 5, bonusStr: 2 } },
            "Leather Set": { pieces: ["Leather Cap", "Leather Armor", "Leather Gloves", "Leather Boots"], bonus: { bonusDex: 3, bonusCrit: 0.05 } }
        };

        // ---------- QUEST SYSTEM (simple) ----------
        let quest = {
            active: { type: "kill", target: "Skeleton", current: 0, required: 3, rewardXP: 150, rewardGold: 50, rewardItem: "Iron Sword" },
            completed: false
        };

        // ---------- PLAYER OBJECT with full equipment ----------
        const player = {
            level: 1, xp: 0, xpNext: 100,
            base: { str: 10, dex: 10, int: 10, vit: 10, maxHP: 100, maxMP: 50, currentHP: 100, currentMP: 50, gold: 30 },
            statPoints: 0,
            skills: ["Slash"],
            equipment: {
                head: null,
                chest: { ...ItemDB["Leather Armor"] }, // start with leather armor
                hands: null,
                legs: null,
                feet: null,
                mainHand: { ...ItemDB["Rusty Sword"] },
                offHand: null,
                accessory1: null,
                accessory2: null
            },
            inventory: {
                consumables: { healthPotion: 2, ether: 1 },
                equipment: [
                    { ...ItemDB["Dagger"] },
                    { ...ItemDB["Wooden Shield"] },
                    { ...ItemDB["Leather Cap"] }
                ] // starting items
            },
            // computed stats (filled by recalcStats)
            finalAttack: 0, finalDefense: 0, finalCrit: 0.05, finalDodge: 0.05, finalBlock: 0,
            setBonuses: [],
            poisonTurns: 0, // for player
            defending: false,
            focusBuff: null
        };

        // ---------- ENEMIES (expanded) ----------
        const enemies = [
            { name: "Zombie", level:1, maxHP:38, minDamage:6, maxDamage:11, xpReward:45, goldReward:8, armor:2, resist:["cold"], weakness:["fire"] },
            { name: "Skeleton", level:2, maxHP:45, minDamage:8, maxDamage:14, xpReward:60, goldReward:12, armor:4, resist:["pierce"], weakness:["blunt","lightning"] },
            { name: "Ghoul", level:2, maxHP:52, minDamage:9, maxDamage:16, xpReward:70, goldReward:15, armor:3, resist:["dark"], weakness:["holy","fire"], poisonAttack: true },
            { name: "Vampire Spawn", level:3, maxHP:70, minDamage:12, maxDamage:19, xpReward:100, goldReward:25, armor:5, resist:["cold"], weakness:["holy","fire"] },
            { name: "Wraith", level:4, maxHP:64, minDamage:14, maxDamage:22, xpReward:130, goldReward:30, armor:2, ethereal:true, weakness:["magic","holy"] },
            { name: "Death Knight", level:5, maxHP:95, minDamage:16, maxDamage:25, xpReward:180, goldReward:45, armor:8, resist:["pierce","fire"], weakness:["holy","lightning"] },
            { name: "Necromancer", level:6, maxHP:110, minDamage:18, maxDamage:28, xpReward:250, goldReward:60, armor:4, weakness:["holy","physical"] }
        ];

        // ---------- GAME STATE ----------
        let inCombat = false;
        let currentEnemy = null;
        let enemyDebuff = 1.0;
        let gameEnded = false;
        let equipmentPanelVisible = false;

        // ---------- UI ----------
        const gameOutput = document.getElementById('game-output');
        function addToOutput(text, className = '') {
            const p = document.createElement('p');
            p.textContent = text;
            if (className) p.className = className;
            gameOutput.appendChild(p);
            gameOutput.scrollTop = gameOutput.scrollHeight;
        }

        // ---------- RECALCULATE STATS from base + equipment + set bonuses ----------
        function recalcStats() {
            let atk = 10 + player.base.str * 1.5 + player.base.dex * 0.5;
            let def = 5 + player.base.vit * 1.2 + player.base.dex * 0.3;
            let maxHP = 100 + (player.base.vit - 10) * 10; // base VIT 10 = 100HP
            let maxMP = 50 + (player.base.int - 10) * 5;
            let crit = 0.05 + player.base.dex * 0.005;
            let dodge = 0.05 + player.base.dex * 0.003;
            let block = 0;

            // Reset set bonuses
            player.setBonuses = [];

            // Add equipment bonuses
            for (let slot in player.equipment) {
                const item = player.equipment[slot];
                if (item) {
                    atk += item.bonusAtk || 0;
                    def += item.bonusDef || 0;
                    maxHP += item.bonusHP || 0;
                    maxMP += item.bonusMP || 0;
                    crit += item.bonusCrit || 0;
                    dodge += item.bonusDodge || 0;
                    block += item.block || 0;
                    player.base.str += item.bonusStr || 0;
                    player.base.dex += item.bonusDex || 0;
                    player.base.int += item.bonusInt || 0;
                    player.base.vit += item.bonusVit || 0;
                }
            }

            // Apply set bonuses
            const equippedNames = Object.values(player.equipment).filter(i => i).map(i => i.name);
            for (let setName in SetBonuses) {
                const set = SetBonuses[setName];
                let count = set.pieces.filter(p => equippedNames.includes(p)).length;
                if (count >= 2) { // 2-piece bonus
                    if (setName === "Iron Set") { def += 5; player.base.str += 2; }
                    if (setName === "Leather Set") { player.base.dex += 3; crit += 0.05; }
                    player.setBonuses.push(setName + " (2)");
                }
                if (count >= 4) { // 4-piece bonus
                    if (setName === "Iron Set") { def += 8; player.base.vit += 2; }
                    if (setName === "Leather Set") { dodge += 0.08; }
                    player.setBonuses.push(setName + " (4)");
                }
            }

            // Store final values
            player.finalAttack = Math.floor(atk);
            player.finalDefense = Math.floor(def);
            player.finalCrit = Math.min(0.8, crit);
            player.finalDodge = Math.min(0.5, dodge);
            player.finalBlock = Math.min(0.6, block);
            player.maxHP = Math.floor(maxHP);
            player.maxMP = Math.floor(maxMP);
            if (player.base.currentHP > player.maxHP) player.base.currentHP = player.maxHP;
            if (player.base.currentMP > player.maxMP) player.base.currentMP = player.maxMP;
            if (player.base.currentHP < 0) player.base.currentHP = 0;
        }

        // ---------- UPDATE UI ----------
        function updateStatus() {
            document.getElementById('player-hp-text').textContent = `${player.base.currentHP}/${player.maxHP}`;
            document.getElementById('player-health-fill').style.width = `${(player.base.currentHP/player.maxHP)*100}%`;
            document.getElementById('player-mp-text').textContent = `${player.base.currentMP}/${player.maxMP}`;
            document.getElementById('player-mp-fill').style.width = `${(player.base.currentMP/player.maxMP)*100}%`;
            document.getElementById('player-level').textContent = player.level;
            document.getElementById('player-xp').textContent = `${player.xp}/${player.xpNext}`;
            document.getElementById('player-atk').textContent = player.finalAttack;
            document.getElementById('player-def').textContent = player.finalDefense;
            document.getElementById('player-gold').textContent = player.base.gold;
            let invCount = (player.inventory.consumables.healthPotion||0)+(player.inventory.consumables.ether||0)+player.inventory.equipment.length;
            document.getElementById('inventory-count').textContent = invCount;
            document.getElementById('stat-points-container').style.display = player.statPoints > 0 ? 'flex' : 'none';
            renderSkillButtons();
            if (equipmentPanelVisible) renderEquipmentPanel();
        }

        // ---------- SKILL BUTTONS (unlock with level) ----------
        function renderSkillButtons() {
            const container = document.getElementById('skills-container');
            container.innerHTML = '<span class="btn-label">‚ú® SKILLS</span>';
            player.skills.forEach(skill => {
                if (skill === 'Slash') return;
                const btn = document.createElement('button');
                btn.className = 'cmd-btn';
                btn.textContent = skill.toUpperCase();
                btn.onclick = (e) => { AudioManager.click(); useSkill(skill); };
                container.appendChild(btn);
            });
        }

        // ---------- LEVEL UP & SKILL UNLOCK ----------
        function checkLevelUp() {
            while (player.xp >= player.xpNext) {
                player.level++;
                player.xp -= player.xpNext;
                player.xpNext = Math.floor(player.xpNext * 1.6);
                player.base.maxHP += 12 + Math.floor(player.base.vit * 0.5);
                player.base.maxMP += 6 + Math.floor(player.base.int * 0.4);
                player.base.currentHP = player.maxHP;
                player.base.currentMP = player.maxMP;
                player.statPoints += 3;
                AudioManager.levelUp();

                // Unlock skills
                if (player.level === 2 && !player.skills.includes("Fireball")) player.skills.push("Fireball");
                if (player.level === 3 && !player.skills.includes("Heal")) player.skills.push("Heal");
                if (player.level === 4 && !player.skills.includes("ShieldBash")) player.skills.push("ShieldBash");
                if (player.level === 5 && !player.skills.includes("Lightning")) player.skills.push("Lightning");
                if (player.level === 6 && !player.skills.includes("Focus")) player.skills.push("Focus");
                if (player.level === 7 && !player.skills.includes("PoisonStrike")) player.skills.push("PoisonStrike");
                if (player.level === 8 && !player.skills.includes("DualStrike") && player.equipment.mainHand && player.equipment.offHand && player.equipment.offHand.type !== "shield") {
                    player.skills.push("DualStrike");
                }

                addToOutput(`‚ñà LV UP! LV ${player.level} ‚ñà`, "victory");
            }
            recalcStats();
            updateStatus();
        }

        // ---------- SKILL DATABASE (extended) ----------
        const skillDB = {
            Slash: { name: "Slash", mpCost: 0, baseDmg: 8, type: "phys" },
            Fireball: { name: "Fireball", mpCost: 4, baseDmg: 14, type: "fire" },
            Heal: { name: "Heal", mpCost: 5, baseDmg: 0, type: "heal", healAmount: 25 },
            ShieldBash: { name: "ShieldBash", mpCost: 2, baseDmg: 10, type: "phys", stun: true },
            Lightning: { name: "Lightning", mpCost: 7, baseDmg: 22, type: "lightning" },
            Focus: { name: "Focus", mpCost: 3, baseDmg: 0, type: "buff" },
            PoisonStrike: { name: "PoisonStrike", mpCost: 3, baseDmg: 8, type: "poison" },
            DualStrike: { name: "DualStrike", mpCost: 5, baseDmg: 12, type: "phys", dual: true }
        };

        // ---------- ENEMY GENERATION ----------
        function generateEnemy() {
            let pool = enemies.filter(e => e.level <= player.level+1 && e.level >= player.level-1);
            if (!pool.length) pool = enemies.slice(0,3);
            const base = pool[Math.floor(Math.random() * pool.length)];
            let hpScale = 1 + (player.level - base.level)*0.2;
            hpScale = Math.min(1.8, Math.max(0.8, hpScale));
            return {
                ...base,
                maxHP: Math.floor(base.maxHP * hpScale),
                currentHP: Math.floor(base.maxHP * hpScale),
                xpReward: Math.floor(base.xpReward * (0.8 + player.level*0.1)),
                goldReward: Math.floor(base.goldReward * (0.7 + player.level*0.1)),
                poisonTurns: 0
            };
        }

        // ---------- COMBAT ----------
        function startCombat() {
            if (gameEnded) return;
            if (inCombat) { addToOutput("Already in combat!", "combat"); AudioManager.error(); return; }
            currentEnemy = generateEnemy();
            inCombat = true;
            enemyDebuff = 1.0;
            AudioManager.encounter();
            addToOutput(`‚öî ${currentEnemy.name} Lv.${currentEnemy.level}`, "location");
            addToOutput(`HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "combat");
            if (currentEnemy.weakness) addToOutput(`Weak: ${currentEnemy.weakness.join('/')}`, "hint");
        }

        function enemyTurn() {
            if (!inCombat || !currentEnemy) return;
            let dmg = Math.floor(Math.random()*(currentEnemy.maxDamage-currentEnemy.minDamage+1)+currentEnemy.minDamage);
            dmg = Math.floor(dmg * enemyDebuff);
            enemyDebuff = 1.0;

            // Player dodge
            if (Math.random() < player.finalDodge) {
                addToOutput(`Dodged!`, "skill");
                AudioManager.click();
                return;
            }
            // Player block (shield)
            if (Math.random() < player.finalBlock) {
                dmg = Math.floor(dmg * 0.3);
                addToOutput(`Blocked!`, "skill");
            }

            dmg -= Math.floor(player.finalDefense * 0.2); // armor reduction
            if (dmg < 2) dmg = 2;
            if (player.defending) { dmg = Math.floor(dmg*0.5); player.defending = false; }

            player.base.currentHP -= dmg;
            if (player.base.currentHP < 0) player.base.currentHP = 0;
            AudioManager.playerHit();
            addToOutput(`${currentEnemy.name} hits for ${dmg}!`, "damage");

            // Enemy poison
            if (currentEnemy.poisonAttack && Math.random() < 0.3) {
                player.poisonTurns = 3;
                addToOutput(`Poisoned!`, "magic");
                AudioManager.poison();
            }

            updateStatus();
            if (player.base.currentHP <= 0) {
                addToOutput("‚ò† DEFEAT ‚ò†", "combat"); gameEnded = true; inCombat = false; AudioManager.error();
            }
        }

        // ---------- PLAYER POISON TICK ----------
        function applyPoison() {
            if (player.poisonTurns > 0) {
                let poisonDmg = Math.floor(player.maxHP * 0.05);
                player.base.currentHP -= poisonDmg;
                if (player.base.currentHP < 1) player.base.currentHP = 1;
                addToOutput(`Poison deals ${poisonDmg}`, "damage");
                player.poisonTurns--;
                AudioManager.poison();
            }
        }

        function endCombat(win) {
            if (win && currentEnemy) {
                player.xp += currentEnemy.xpReward;
                player.base.gold += currentEnemy.goldReward;
                AudioManager.victory();
                addToOutput(`VICTORY! +${currentEnemy.xpReward}XP +${currentEnemy.goldReward}G`, "victory");

                // Quest progress
                if (quest.active && !quest.completed && quest.active.type === "kill" && quest.active.target === currentEnemy.name) {
                    quest.active.current++;
                    addToOutput(`Quest: ${quest.active.current}/${quest.active.required} ${quest.active.target}s`, "hint");
                    if (quest.active.current >= quest.active.required) {
                        player.xp += quest.active.rewardXP;
                        player.base.gold += quest.active.rewardGold;
                        addToOutput(`Quest complete! +${quest.active.rewardXP}XP +${quest.active.rewardGold}G`, "victory");
                        if (quest.active.rewardItem) {
                            let item = { ...ItemDB[quest.active.rewardItem] };
                            player.inventory.equipment.push(item);
                            addToOutput(`Reward: ${item.name}`, "rare");
                        }
                        quest.completed = true;
                    }
                }

                // Loot drop (equipment)
                if (Math.random() < 0.4) {
                    let possibleItems = Object.values(ItemDB).filter(i => i.value < 80 && i.rarity !== "rare");
                    let drop = possibleItems[Math.floor(Math.random() * possibleItems.length)];
                    player.inventory.equipment.push({ ...drop });
                    addToOutput(`Found: ${drop.name}`, drop.rarity === "rare" ? "epic" : "rare");
                    AudioManager.item();
                }
                if (Math.random() < 0.3) { player.inventory.consumables.healthPotion = (player.inventory.consumables.healthPotion||0)+1; addToOutput("Potion drop!", "loot"); AudioManager.item(); }
                if (Math.random() < 0.2) { player.inventory.consumables.ether = (player.inventory.consumables.ether||0)+1; addToOutput("Ether drop!", "loot"); AudioManager.item(); }

                checkLevelUp();
            }
            inCombat = false; currentEnemy = null; updateStatus();
            applyPoison(); // poison ticks after combat
        }

        // ---------- PLAYER ACTIONS ----------
        function playerAttack() {
            if (!inCombat) { addToOutput("No enemy! SEARCH", "hint"); AudioManager.error(); return; }
            let dmg = Math.floor(player.finalAttack * (Math.random()*0.4+0.8));
            if (Math.random() < player.finalCrit) { dmg = Math.floor(dmg*1.8); addToOutput("CRIT!", "victory"); }
            dmg -= Math.floor(currentEnemy.armor || 0);
            if (dmg < 2) dmg = 2;
            currentEnemy.currentHP -= dmg;
            AudioManager.attack();
            addToOutput(`Attack: ${dmg} dmg`, "damage");
            if (currentEnemy.currentHP <= 0) endCombat(true);
            else enemyTurn();
            updateStatus();
        }

        function useSkill(skillName) {
            if (!inCombat && skillName !== 'Heal' && skillName !== 'Focus') { addToOutput("No enemy.", "hint"); AudioManager.error(); return; }
            const skill = skillDB[skillName];
            if (!skill || !player.skills.includes(skillName)) return;
            if (player.base.currentMP < skill.mpCost) { addToOutput("No MP!", "magic"); AudioManager.error(); return; }
            player.base.currentMP -= skill.mpCost;

            if (skill.type === 'heal') {
                let heal = skill.healAmount + Math.floor(player.base.int * 0.5);
                player.base.currentHP = Math.min(player.maxHP, player.base.currentHP+heal);
                addToOutput(`Heal +${heal} HP`, "magic");
                AudioManager.heal();
                if (inCombat) enemyTurn();
                updateStatus(); return;
            }
            if (skill.name === 'Focus') {
                player.focusBuff = 1.2; addToOutput("Focus +20%", "skill");
                AudioManager.click();
                if (inCombat) enemyTurn(); updateStatus(); return;
            }
            if (!inCombat) { addToOutput("No enemy", "hint"); AudioManager.error(); return; }

            let dmg = skill.baseDmg;
            if (['fire','lightning','poison','magic'].includes(skill.type)) dmg += Math.floor((player.base.int*1.8 + (player.equipment.mainHand?.magicPower||0)) *0.6);
            else dmg += Math.floor(player.finalAttack*0.5);
            if (player.focusBuff) { dmg = Math.floor(dmg*player.focusBuff); player.focusBuff = null; }
            if (currentEnemy.weakness?.includes(skill.type)) { dmg = Math.floor(dmg*1.6); addToOutput("Super effective!", "victory"); }
            if (currentEnemy.resist?.includes(skill.type)) { dmg = Math.floor(dmg*0.6); addToOutput("Resisted.", "hint"); }
            if (skill.type === 'phys') dmg -= Math.floor((currentEnemy.armor||0)*0.6);
            if (dmg < 3) dmg = 3;
            if (skill.name === 'ShieldBash') { enemyDebuff = 0.7; if (Math.random()<0.3) { addToOutput("Stunned!", "victory"); enemyDebuff = 0.4; } }
            if (skill.name === 'PoisonStrike') { currentEnemy.poisonTurns = (currentEnemy.poisonTurns||0)+3; }
            if (skill.name === 'DualStrike') {
                // second hit
                let dmg2 = Math.floor(dmg * 0.6);
                currentEnemy.currentHP -= dmg2;
                addToOutput(`Dual Strike +${dmg2}`, "skill");
            }

            currentEnemy.currentHP -= dmg;
            AudioManager.attack();
            addToOutput(`${skillName}: ${dmg} dmg`, "skill");
            if (currentEnemy.currentHP <= 0) endCombat(true);
            else enemyTurn();
            updateStatus();
        }

        // ---------- EQUIPMENT MANAGEMENT ----------
        function equipItem(item, slot) {
            // check requirements
            if (item.req) {
                if (item.req.str && player.base.str < item.req.str) { addToOutput(`Requires STR ${item.req.str}`, "hint"); AudioManager.error(); return false; }
                if (item.req.dex && player.base.dex < item.req.dex) { addToOutput(`Requires DEX ${item.req.dex}`, "hint"); AudioManager.error(); return false; }
                if (item.req.int && player.base.int < item.req.int) { addToOutput(`Requires INT ${item.req.int}`, "hint"); AudioManager.error(); return false; }
                if (item.req.vit && player.base.vit < item.req.vit) { addToOutput(`Requires VIT ${item.req.vit}`, "hint"); AudioManager.error(); return false; }
            }
            // unequip current if any
            if (player.equipment[slot]) {
                let oldItem = player.equipment[slot];
                player.inventory.equipment.push(oldItem);
                player.equipment[slot] = null;
            }
            // equip new item
            player.equipment[slot] = item;
            // remove from inventory
            let index = player.inventory.equipment.findIndex(i => i === item);
            if (index > -1) player.inventory.equipment.splice(index, 1);
            recalcStats();
            AudioManager.equip();
            addToOutput(`Equipped ${item.name} [${slot}]`, "stat");
            updateStatus();
            return true;
        }

        function unequipSlot(slot) {
            if (player.equipment[slot]) {
                let item = player.equipment[slot];
                player.inventory.equipment.push(item);
                player.equipment[slot] = null;
                recalcStats();
                AudioManager.equip();
                addToOutput(`Unequipped ${item.name}`, "hint");
                updateStatus();
            }
        }

        // ---------- RENDER EQUIPMENT PANEL ----------
        function renderEquipmentPanel() {
            const slotsContainer = document.getElementById('equipment-slots-container');
            slotsContainer.innerHTML = '';
            const slots = ['head', 'chest', 'hands', 'legs', 'feet', 'mainHand', 'offHand', 'accessory1', 'accessory2'];
            slots.forEach(slot => {
                const item = player.equipment[slot];
                const btn = document.createElement('button');
                btn.className = 'slot-btn' + (item ? ' equipped' : '');
                btn.textContent = (item ? item.name : `-${slot.toUpperCase()}-`).substring(0, 12);
                btn.onclick = (e) => { AudioManager.click(); unequipSlot(slot); renderEquipmentPanel(); };
                slotsContainer.appendChild(btn);
            });

            const invContainer = document.getElementById('inventory-equipment-container');
            invContainer.innerHTML = '';
            player.inventory.equipment.forEach((item, idx) => {
                const btn = document.createElement('button');
                btn.className = 'inv-item-btn';
                btn.textContent = `${item.name} (${item.slot})`.substring(0, 14);
                btn.onclick = (e) => {
                    AudioManager.click();
                    if (equipItem(item, item.slot)) {
                        renderEquipmentPanel();
                    }
                };
                invContainer.appendChild(btn);
            });
        }

        // ---------- TOGGLE EQUIPMENT PANEL ----------
        function toggleEquipmentPanel() {
            equipmentPanelVisible = !equipmentPanelVisible;
            document.getElementById('equipment-panel').style.display = equipmentPanelVisible ? 'flex' : 'none';
            if (equipmentPanelVisible) renderEquipmentPanel();
        }

        // ---------- ITEMS & SHOP (updated with equipment) ----------
        function useHealthPotion() { if (player.inventory.consumables.healthPotion>0) { player.inventory.consumables.healthPotion--; let heal = 30+Math.floor(player.base.vit*0.5); player.base.currentHP = Math.min(player.maxHP, player.base.currentHP+heal); addToOutput(`Potion +${heal} HP`, "item"); AudioManager.heal(); updateStatus(); } else { addToOutput("None", "hint"); AudioManager.error(); } }
        function useEther() { if (player.inventory.consumables.ether>0) { player.inventory.consumables.ether--; let mp = 20+Math.floor(player.base.int*0.4); player.base.currentMP = Math.min(player.maxMP, player.base.currentMP+mp); addToOutput(`Ether +${mp} MP`, "magic"); AudioManager.item(); updateStatus(); } else { addToOutput("None", "hint"); AudioManager.error(); } }
        function showInventory() {
            addToOutput("üéí INVENTORY", "location");
            addToOutput(`Potions: ${player.inventory.consumables.healthPotion||0}  Ether: ${player.inventory.consumables.ether||0}`, "item");
            addToOutput(`Equipment pieces: ${player.inventory.equipment.length}`, "stat");
            AudioManager.click();
        }
        function shopInfo() { addToOutput("üè™ SHOP: Potion 15g, Ether 20g, Up Sword 50g, Up Armor 40g. Also: Iron Helm 40g, Dagger 35g, Leather Gloves 22g", "gold"); AudioManager.click(); }
        function buyHealthPotion() { if (player.base.gold>=15) { player.base.gold-=15; player.inventory.consumables.healthPotion=(player.inventory.consumables.healthPotion||0)+1; addToOutput("Bought Potion", "item"); AudioManager.purchase(); } else { addToOutput("Not enough gold", "hint"); AudioManager.error(); } updateStatus(); }
        function buyEther() { if (player.base.gold>=20) { player.base.gold-=20; player.inventory.consumables.ether=(player.inventory.consumables.ether||0)+1; addToOutput("Bought Ether", "item"); AudioManager.purchase(); } else { addToOutput("Not enough gold", "hint"); AudioManager.error(); } updateStatus(); }
        function upgradeWeapon() { 
            if (player.base.gold>=50) { 
                player.base.gold-=50; 
                if (player.equipment.mainHand) {
                    player.equipment.mainHand.bonusAtk += 3;
                    player.equipment.mainHand.name += '+';
                    addToOutput(`Weapon +3 ATK`, "victory");
                } else { addToOutput("No weapon equipped", "hint"); }
                AudioManager.levelUp(); 
            } else { addToOutput(`Need 50g`, "hint"); AudioManager.error(); } 
            recalcStats(); updateStatus(); 
        }
        function upgradeArmor() { 
            if (player.base.gold>=40) { 
                player.base.gold-=40; 
                if (player.equipment.chest) {
                    player.equipment.chest.bonusDef += 2;
                    player.equipment.chest.name += '+';
                    addToOutput(`Armor +2 DEF`, "victory");
                } else { addToOutput("No chest equipped", "hint"); }
                AudioManager.levelUp(); 
            } else { addToOutput(`Need 40g`, "hint"); AudioManager.error(); } 
            recalcStats(); updateStatus(); 
        }

        // ---------- STAT INCREASE ----------
        function incStat(stat) {
            if (player.statPoints<=0) { AudioManager.error(); return; }
            if (stat==='str') { player.base.str++; player.statPoints--; addToOutput("STR +1","stat"); AudioManager.click(); }
            if (stat==='dex') { player.base.dex++; player.statPoints--; addToOutput("DEX +1","stat"); AudioManager.click(); }
            if (stat==='int') { player.base.int++; player.statPoints--; addToOutput("INT +1","stat"); AudioManager.click(); }
            if (stat==='vit') { player.base.vit++; player.statPoints--; player.maxHP += 10; player.base.currentHP += 10; addToOutput("VIT +1 HP+10","stat"); AudioManager.click(); }
            recalcStats();
            updateStatus();
        }

        // ---------- SAVE / LOAD / RESTART ----------
        function saveGame() { localStorage.setItem('ccsEquipmentSave',JSON.stringify({player,inCombat,currentEnemy,gameEnded,quest})); addToOutput("Saved","victory"); AudioManager.click(); }
        function loadGame() { 
            let s=localStorage.getItem('ccsEquipmentSave'); 
            if(s) { 
                let d=JSON.parse(s); 
                Object.assign(player, d.player);
                inCombat=d.inCombat; currentEnemy=d.currentEnemy; gameEnded=d.gameEnded; quest=d.quest;
                recalcStats();
                addToOutput("Loaded","victory"); AudioManager.click(); updateStatus(); renderSkillButtons(); 
            } else { addToOutput("No save","hint"); AudioManager.error(); } 
        }
        function restartGame() { location.reload(); }

        function questLog() {
            if (quest.completed) addToOutput("Quest completed! Talk to adventurer.", "victory");
            else addToOutput(`QUEST: Kill ${quest.active.current}/${quest.active.required} ${quest.active.target}s. Reward: ${quest.active.rewardXP}XP, ${quest.active.rewardGold}G, ${quest.active.rewardItem}`, "hint");
            AudioManager.click();
        }

        // ---------- BIND BUTTONS ----------
        function bindButtons() {
            document.querySelectorAll('.cmd-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { if (!e.target.closest('#mute-toggle')) AudioManager.click(); });
            });

            document.getElementById('btn-search').onclick = startCombat;
            document.getElementById('btn-attack').onclick = playerAttack;
            document.getElementById('btn-defend').onclick = ()=>{ if(inCombat){ player.defending=true; addToOutput("Defend stance","skill"); AudioManager.click(); enemyTurn(); } else { addToOutput("Not in combat","hint"); AudioManager.error(); } };
            document.getElementById('btn-flee').onclick = ()=>{ if(inCombat){ if(Math.random()<0.45+player.base.dex*0.02){ addToOutput("Fled","item"); AudioManager.flee(); inCombat=false; currentEnemy=null; } else { addToOutput("Escape failed","damage"); AudioManager.error(); enemyTurn(); }} else { addToOutput("No combat","hint"); AudioManager.error(); } };
            document.getElementById('btn-rest').onclick = ()=>{ if(!inCombat){ let rec = Math.floor(player.maxMP*0.2); player.base.currentMP = Math.min(player.maxMP, player.base.currentMP+rec); addToOutput(`Rest +${rec} MP`,"magic"); AudioManager.rest(); updateStatus(); } else { addToOutput("Not now","hint"); AudioManager.error(); } };
            document.getElementById('btn-stats').onclick = ()=>{ 
                addToOutput(`‚ïê‚ïê STATS ‚ïê‚ïê`,"location"); 
                addToOutput(`LV${player.level} XP:${player.xp}/${player.xpNext}`,"stat"); 
                addToOutput(`STR:${player.base.str} DEX:${player.base.dex} INT:${player.base.int} VIT:${player.base.vit}`,"stat"); 
                addToOutput(`ATK:${player.finalAttack} DEF:${player.finalDefense} CRIT:${Math.floor(player.finalCrit*100)}% DODGE:${Math.floor(player.finalDodge*100)}%`,"stat");
                addToOutput(`Points: ${player.statPoints}`,"victory");
                if (player.setBonuses.length) addToOutput(`Sets: ${player.setBonuses.join(', ')}`, "magic");
                AudioManager.click(); 
            };
            document.getElementById('btn-use-hpotion').onclick = useHealthPotion;
            document.getElementById('btn-use-ether').onclick = useEther;
            document.getElementById('btn-inventory').onclick = showInventory;
            document.getElementById('btn-shop').onclick = shopInfo;
            document.getElementById('btn-buy-potion').onclick = buyHealthPotion;
            document.getElementById('btn-buy-ether').onclick = buyEther;
            document.getElementById('btn-upgrade-weapon').onclick = upgradeWeapon;
            document.getElementById('btn-upgrade-armor').onclick = upgradeArmor;
            document.getElementById('btn-toggle-equip').onclick = toggleEquipmentPanel;
            document.getElementById('btn-quest-log').onclick = questLog;
            document.getElementById('btn-close-equip').onclick = toggleEquipmentPanel;
            document.getElementById('btn-save').onclick = saveGame;
            document.getElementById('btn-load').onclick = loadGame;
            document.getElementById('btn-restart').onclick = restartGame;
            document.getElementById('btn-inc-str').onclick = ()=>incStat('str');
            document.getElementById('btn-inc-dex').onclick = ()=>incStat('dex');
            document.getElementById('btn-inc-int').onclick = ()=>incStat('int');
            document.getElementById('btn-inc-vit').onclick = ()=>incStat('vit');

            const muteBtn = document.getElementById('mute-toggle');
            muteBtn.onclick = () => {
                const muted = AudioManager.toggleMute();
                muteBtn.textContent = muted ? 'üîá' : 'üîä';
                muteBtn.classList.toggle('active', muted);
                AudioManager.click();
            };
        }

        // ---------- INIT ----------
        function initGame() {
            AudioManager.init();
            gameOutput.innerHTML = '';
            addToOutput("CASTLE UNDEAD 1984 ‚Äî EQUIPMENT EDITION", "location");
            addToOutput("Tap GEAR ‚Üí equip items. Dual wield, shields, sets!", "hint");
            addToOutput("------------------------------------------------");
            player.base.currentHP = player.maxHP; player.base.currentMP = player.maxMP;
            recalcStats();
            updateStatus();
            renderSkillButtons();
            bindButtons();
        }

        window.onload = initGame;
    </script>
</body>
</html>
