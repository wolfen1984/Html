<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Castle of the Damned - Action RPG Combat</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body {
            font-family: 'VT323', monospace;
            background-color: #0a0a12;
            color: #33ff33;
            line-height: 1.5;
            padding: 10px;
            height: 100vh;
            max-height: -webkit-fill-available;
            overflow: hidden;
            text-shadow: 0 0 5px #33ff33;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 500px;
            margin: 0 auto;
            border: 2px solid #33ff33;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.3);
            background-color: #000011;
            position: relative;
        }
        
        .header {
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #33ff33;
            background-color: #000022;
        }
        
        h1 {
            font-size: 28px;
            color: #ff3366;
            text-shadow: 0 0 8px #ff3366;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #33ccff;
            font-size: 18px;
        }
        
        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .screen {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 20px;
            display: none;
        }
        
        .active-screen {
            display: block;
        }
        
        .text-output {
            margin-bottom: 20px;
            min-height: 200px;
            border-bottom: 1px dashed #33ff33;
            padding-bottom: 10px;
        }
        
        .button-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 10px;
        }
        
        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .game-button {
            flex: 1;
            min-width: 120px;
            background-color: #001122;
            color: #33ff33;
            border: 1px solid #33ff33;
            padding: 12px 8px;
            font-family: 'VT323', monospace;
            font-size: 20px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            text-align: center;
            box-shadow: 0 0 5px rgba(51, 255, 51, 0.5);
        }
        
        .game-button:hover, .game-button:active {
            background-color: #003344;
            box-shadow: 0 0 10px rgba(51, 255, 51, 0.8);
        }
        
        .game-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .game-button.red {
            color: #ff3366;
            border-color: #ff3366;
            box-shadow: 0 0 5px rgba(255, 51, 102, 0.5);
        }
        
        .game-button.blue {
            color: #33ccff;
            border-color: #33ccff;
            box-shadow: 0 0 5px rgba(51, 204, 255, 0.5);
        }
        
        .game-button.yellow {
            color: #ffff33;
            border-color: #ffff33;
            box-shadow: 0 0 5px rgba(255, 255, 51, 0.5);
        }
        
        .game-button.green {
            color: #33ff33;
            border-color: #33ff33;
            box-shadow: 0 0 5px rgba(51, 255, 51, 0.5);
        }
        
        .game-button.purple {
            color: #cc33ff;
            border-color: #cc33ff;
            box-shadow: 0 0 5px rgba(204, 51, 255, 0.5);
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: #000022;
            border-top: 2px solid #33ff33;
            font-size: 18px;
            flex-wrap: wrap;
        }
        
        .stat {
            margin-right: 15px;
        }
        
        .stat-value {
            color: #ffff33;
        }
        
        .inventory {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .item {
            background-color: #001133;
            border: 1px solid #33ccff;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .item:hover {
            background-color: #002255;
            transform: scale(1.05);
        }
        
        .item.selected {
            background-color: #003355;
            border-color: #ffff33;
            box-shadow: 0 0 8px rgba(255, 255, 51, 0.8);
        }
        
        .item.common {
            border-color: #33ccff;
            background-color: #001133;
            color: #33ccff;
        }
        
        .item.rare {
            border-color: #ffff33;
            background-color: #332200;
            color: #ffff33;
        }
        
        .item.epic {
            border-color: #cc33ff;
            background-color: #330033;
            color: #cc33ff;
        }
        
        .item.legendary {
            border-color: #ff9900;
            background-color: #442200;
            color: #ff9900;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 5px rgba(255, 153, 0, 0.5); }
            50% { box-shadow: 0 0 15px rgba(255, 153, 0, 0.8); }
            100% { box-shadow: 0 0 5px rgba(255, 153, 0, 0.5); }
        }
        
        .combat-log {
            color: #ff9933;
            margin-top: 15px;
            padding: 10px;
            background-color: #110000;
            border: 1px solid #ff3366;
            max-height: 150px;
            overflow-y: auto;
            font-size: 18px;
        }
        
        .loot-drop {
            color: #ffff33;
            margin: 10px 0;
            padding: 10px;
            background-color: #222200;
            border: 1px solid #ffff33;
            border-left: 5px solid #ffff33;
            animation: glow 1s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 5px #ffff33; }
            to { box-shadow: 0 0 15px #ffff33; }
        }
        
        .enemy-health {
            height: 20px;
            background-color: #330000;
            border: 1px solid #ff3366;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .enemy-health-fill {
            height: 100%;
            background-color: #ff3366;
            width: 100%;
            transition: width 0.5s;
        }
        
        .player-health {
            height: 20px;
            background-color: #003300;
            border: 1px solid #33ff33;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .player-health-fill {
            height: 100%;
            background-color: #33ff33;
            width: 100%;
            transition: width 0.5s;
        }
        
        .footer {
            padding: 10px;
            text-align: center;
            font-size: 14px;
            color: #33ccff;
            border-top: 1px solid #33ff33;
            background-color: #000022;
        }
        
        .restart-button {
            background-color: #330000;
            color: #ff3366;
            border: 1px solid #ff3366;
            padding: 8px 15px;
            font-family: 'VT323', monospace;
            font-size: 18px;
            cursor: pointer;
            margin-top: 5px;
        }
        
        .class-option {
            border: 2px solid #33ff33;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .class-option:hover, .class-option.selected {
            background-color: #003322;
            box-shadow: 0 0 10px rgba(51, 255, 51, 0.8);
        }
        
        .class-title {
            color: #33ccff;
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        .class-desc {
            font-size: 18px;
            color: #cccccc;
        }
        
        .glitch {
            position: relative;
            animation: glitch 5s infinite;
        }
        
        @keyframes glitch {
            0% { text-shadow: 0 0 5px #33ff33; }
            97% { text-shadow: 0 0 5px #33ff33; }
            98% { text-shadow: 2px 0 5px #ff3366, -2px 0 5px #33ccff; }
            99% { text-shadow: -2px 0 5px #ff3366, 2px 0 5px #33ccff; }
            100% { text-shadow: 0 0 5px #33ff33; }
        }
        
        .xp-bar {
            height: 10px;
            background-color: #003300;
            border: 1px solid #33ff33;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .xp-fill {
            height: 100%;
            background-color: #33ccff;
            width: 0%;
            transition: width 0.5s;
        }
        
        .loot-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background-color: #001122;
            border: 1px solid #33ccff;
        }
        
        .loot-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background-color: #002233;
            border-radius: 3px;
        }
        
        .loot-icon {
            font-size: 18px;
        }
        
        .level-up {
            color: #ffff33;
            font-size: 24px;
            text-align: center;
            animation: pulse 1s infinite;
            margin: 10px 0;
        }
        
        .npc-dialog {
            background-color: #002244;
            border: 2px solid #33ccff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .quest-marker {
            color: #ffff33;
            font-size: 20px;
            margin: 5px 0;
        }
        
        .boss-health {
            height: 25px;
            background-color: #330000;
            border: 2px solid #ff9900;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .boss-health-fill {
            height: 100%;
            background-color: #ff9900;
            width: 100%;
            transition: width 0.5s;
        }
        
        .zone-title {
            color: #ff3366;
            font-size: 22px;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .zone-desc {
            color: #33ccff;
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .enemy-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .enemy-icon {
            background-color: #220000;
            border: 1px solid #ff3366;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .enemy-icon:hover {
            background-color: #440000;
            transform: scale(1.05);
        }
        
        .enemy-icon.boss {
            border-color: #ff9900;
            background-color: #442200;
            color: #ff9900;
        }
        
        .enemy-icon.elite {
            border-color: #cc33ff;
            background-color: #330033;
            color: #cc33ff;
        }
        
        @media (max-width: 400px) {
            .button-row {
                flex-direction: column;
            }
            
            .stats-bar {
                font-size: 16px;
            }
            
            h1 {
                font-size: 24px;
            }
        }
        
        .sound-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: #001122;
            color: #33ccff;
            border: 1px solid #33ccff;
            padding: 5px 10px;
            font-family: 'VT323', monospace;
            font-size: 16px;
            cursor: pointer;
            border-radius: 3px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="sound-toggle" class="sound-toggle">ðŸ”Š SOUND ON</button>
        
        <div class="header">
            <h1 class="glitch">CASTLE OF THE DAMNED</h1>
            <div class="subtitle">ACTION RPG COMBAT EDITION</div>
        </div>
        
        <div class="stats-bar">
            <div class="stat">HP: <span id="hp-value" class="stat-value">100</span>/<span id="hp-max">100</span></div>
            <div class="stat">CLASS: <span id="class-value" class="stat-value">-</span></div>
            <div class="stat">LEVEL: <span id="level-value" class="stat-value">1</span></div>
            <div class="stat">GOLD: <span id="gold-value" class="stat-value">10</span></div>
        </div>
        
        <div class="game-container">
            <!-- Start Screen -->
            <div id="start-screen" class="screen active-screen">
                <div class="text-output">
                    <p>CASTLE OF THE DAMNED: ARPG COMBAT</p>
                    <p>====================================</p>
                    <p>An action-focused RPG combat experience.</p>
                    <br>
                    <p>Darkness spreads from the vampire Lord Mortis' castle.</p>
                    <p>Battle through hordes of enemies, gather loot, and become powerful enough to face the vampire!</p>
                    <br>
                    <p>ENHANCED ARPG FEATURES:</p>
                    <p>â€¢ 24+ Different Enemy Types</p>
                    <p>â€¢ 8 Combat NPCs with Quests</p>
                    <p>â€¢ 30+ Weapons and Armor Sets</p>
                    <p>â€¢ Boss Battles and Elite Enemies</p>
                    <p>â€¢ Multiple Combat Zones</p>
                    <br>
                    <p>Game will auto-save your progress.</p>
                </div>
                <div class="button-container">
                    <button id="start-button" class="game-button red">START HUNT</button>
                    <button id="load-button" class="game-button blue">LOAD GAME</button>
                    <button id="about-button" class="game-button">ABOUT</button>
                </div>
            </div>
            
            <!-- Class Selection Screen -->
            <div id="class-screen" class="screen">
                <div class="text-output">
                    <p>CHOOSE YOUR HUNTER CLASS</p>
                    <p>=======================</p>
                    <p>Select a combat class to begin your hunt:</p>
                    <br>
                    
                    <div id="warrior-class" class="class-option">
                        <div class="class-title">BARBARIAN</div>
                        <div class="class-desc">Brutal strength and massive health pool. Starts with a great axe and heavy armor.</div>
                        <br>
                        <div>STRENGTH: â˜…â˜…â˜…â˜…â˜…â˜…</div>
                        <div>AGILITY: â˜…â˜…â˜†â˜†â˜†â˜†</div>
                        <div>LUCK: â˜…â˜…â˜†â˜†â˜†â˜†</div>
                        <div>SPECIAL: +30% Melee Damage, Bleed Effects</div>
                    </div>
                    
                    <div id="rogue-class" class="class-option">
                        <div class="class-title">ASSASSIN</div>
                        <div class="class-desc">Deadly precision and critical strikes. Starts with poisoned daggers and stealth gear.</div>
                        <br>
                        <div>STRENGTH: â˜…â˜…â˜…â˜†â˜†â˜†</div>
                        <div>AGILITY: â˜…â˜…â˜…â˜…â˜…â˜…</div>
                        <div>LUCK: â˜…â˜…â˜…â˜…â˜…â˜†</div>
                        <div>SPECIAL: +40% Critical Chance, Poison Attacks</div>
                    </div>
                    
                    <div id="mage-class" class="class-option">
                        <div class="class-title">SORCERER</div>
                        <div class="class-desc">Elemental magic and area damage. Starts with a spellbook and mana crystals.</div>
                        <br>
                        <div>STRENGTH: â˜…â˜…â˜†â˜†â˜†â˜†</div>
                        <div>AGILITY: â˜…â˜…â˜…â˜†â˜†â˜†</div>
                        <div>LUCK: â˜…â˜…â˜…â˜…â˜…â˜†</div>
                        <div>SPECIAL: +50% Magic Damage, Elemental Effects</div>
                    </div>
                </div>
                <div class="button-container">
                    <button id="confirm-class" class="game-button" disabled>CONFIRM CLASS</button>
                    <button id="back-to-start" class="game-button red">BACK</button>
                </div>
            </div>
            
            <!-- Combat Zone Selection Screen -->
            <div id="zone-screen" class="screen">
                <div class="text-output">
                    <p class="zone-title">COMBAT ZONES</p>
                    <p class="zone-desc">Choose a zone to hunt enemies and gather loot:</p>
                    <br>
                    
                    <div class="npc-dialog">
                        <p><strong>Captain Valerius:</strong> "Hail, hunter! Choose your hunting ground. Each zone has different enemies and loot."</p>
                    </div>
                    
                    <div class="enemy-group">
                        <div class="zone-option" data-zone="haunted-woods">
                            <p><strong>HAUNTED WOODS</strong> (Level 1-5)</p>
                            <p>Enemies: Wolves, Goblins, Spiders, Bandits</p>
                            <p>Loot: Basic weapons, armor, potions</p>
                            <p>NPCs: Woodsman (3 quests)</p>
                        </div>
                        
                        <div class="zone-option" data-zone="cursed-ruins">
                            <p><strong>CURSED RUINS</strong> (Level 3-8)</p>
                            <p>Enemies: Skeletons, Zombies, Ghosts, Necromancers</p>
                            <p>Loot: Magic items, rare materials</p>
                            <p>NPCs: Archaeologist (2 quests)</p>
                        </div>
                        
                        <div class="zone-option" data-zone="demon-caves">
                            <p><strong>DEMON CAVES</strong> (Level 6-12)</p>
                            <p>Enemies: Imps, Demons, Fire Elementals</p>
                            <p>Loot: Fire weapons, demonic armor</p>
                            <p>NPCs: Demon Hunter (3 quests)</p>
                        </div>
                        
                        <div class="zone-option" data-zone="vampire-castle">
                            <p><strong>VAMPIRE CASTLE GATES</strong> (Level 10-15)</p>
                            <p>Enemies: Vampire Spawn, Blood Knights, Bats</p>
                            <p>Loot: Vampiric weapons, dark armor</p>
                            <p>NPCs: Vampire Hunter (4 quests)</p>
                        </div>
                    </div>
                    
                    <div id="zone-quests"></div>
                    <div id="zone-log"></div>
                </div>
                <div class="button-container">
                    <button id="enter-zone" class="game-button red" disabled>ENTER ZONE</button>
                    <button id="zone-merchant" class="game-button yellow">VISIT MERCHANT</button>
                    <button id="view-inv-zone" class="game-button">INVENTORY</button>
                    <button id="back-to-tavern" class="game-button">RETURN TO CAMP</button>
                </div>
            </div>
            
            <!-- Hunt Screen -->
            <div id="hunt-screen" class="screen">
                <div class="text-output">
                    <p class="zone-title" id="current-zone-title">HAUNTED WOODS</p>
                    <p class="zone-desc" id="current-zone-desc">A dark forest filled with dangerous creatures.</p>
                    <br>
                    
                    <div id="hunt-event">
                        <p>Choose your hunting approach:</p>
                    </div>
                    
                    <div class="enemy-group" id="enemy-group-display">
                        <!-- Enemy groups will appear here -->
                    </div>
                    
                    <div id="npc-encounter"></div>
                    
                    <div id="hunt-log" class="combat-log"></div>
                    <div id="loot-display"></div>
                    <div id="xp-display" style="margin-top: 10px;">
                        <div>XP: <span id="xp-current">0</span>/<span id="xp-next">100</span></div>
                        <div class="xp-bar">
                            <div id="xp-bar-fill" class="xp-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="button-container">
                    <div class="button-row">
                        <button id="hunt-common" class="game-button">HUNT COMMON ENEMIES</button>
                        <button id="hunt-elite" class="game-button purple">HUNT ELITE ENEMY</button>
                    </div>
                    <div class="button-row">
                        <button id="hunt-boss" class="game-button red">HUNT BOSS</button>
                        <button id="rest-hunt" class="game-button blue">CAMP & REST</button>
                    </div>
                    <div class="button-row">
                        <button id="use-item-hunt" class="game-button yellow">USE ITEM</button>
                        <button id="view-inv-hunt" class="game-button">INVENTORY</button>
                        <button id="leave-zone" class="game-button">LEAVE ZONE</button>
                    </div>
                </div>
            </div>
            
            <!-- Combat Screen -->
            <div id="combat-screen" class="screen">
                <div class="text-output">
                    <p id="enemy-name">WOLF</p>
                    <p>=====================</p>
                    
                    <div id="boss-health-container" style="display: none;">
                        <p>BOSS HEALTH:</p>
                        <div class="boss-health">
                            <div id="boss-health-bar" class="boss-health-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <div id="normal-health-container">
                        <div class="enemy-health">
                            <div id="enemy-health-bar" class="enemy-health-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <p id="enemy-desc">A snarling wolf blocks your path!</p>
                    <br>
                    <p>YOUR HEALTH:</p>
                    <div class="player-health">
                        <div id="player-health-bar" class="player-health-fill" style="width: 100%"></div>
                    </div>
                    <div class="combat-log" id="combat-action-log"></div>
                    <div id="combat-loot"></div>
                </div>
                <div class="button-container">
                    <div class="button-row">
                        <button id="attack-button" class="game-button red">BASIC ATTACK</button>
                        <button id="ability-button" class="game-button blue">CLASS ABILITY</button>
                        <button id="heavy-attack" class="game-button purple">HEAVY ATTACK</button>
                    </div>
                    <div class="button-row">
                        <button id="special-attack" class="game-button yellow">SPECIAL ATTACK</button>
                        <button id="use-item-combat" class="game-button">USE ITEM</button>
                        <button id="flee-button" class="game-button">FLEE</button>
                    </div>
                </div>
            </div>
            
            <!-- Inventory Screen -->
            <div id="inventory-screen" class="screen">
                <div class="text-output">
                    <p>INVENTORY & EQUIPMENT</p>
                    <p>=====================</p>
                    <div id="inventory-display">
                        <p>Items will appear here.</p>
                    </div>
                    <br>
                    <p>EQUIPPED GEAR:</p>
                    <p>Weapon: <span id="inv-weapon">Fists</span> (DMG: <span id="inv-weapon-dmg">2</span>)</p>
                    <p>Armor: <span id="inv-armor">Clothes</span> (DEF: <span id="inv-armor-def">0</span>)</p>
                    <p>Helmet: <span id="inv-helmet">None</span></p>
                    <p>Gloves: <span id="inv-gloves">None</span></p>
                    <p>Boots: <span id="inv-boots">None</span></p>
                    <p>Accessory: <span id="inv-accessory">None</span></p>
                </div>
                <div class="button-container">
                    <button id="close-inventory" class="game-button">BACK</button>
                    <button id="use-item-inv" class="game-button yellow">USE SELECTED</button>
                    <button id="equip-item" class="game-button blue">EQUIP</button>
                    <button id="enhance-item" class="game-button purple">ENHANCE (50g)</button>
                </div>
            </div>
            
            <!-- Merchant Screen -->
            <div id="merchant-screen" class="screen">
                <div class="text-output">
                    <p>BLACKSMITH'S FORGE</p>
                    <p>==================</p>
                    
                    <div class="npc-dialog">
                        <p><strong>Blacksmith Thorin:</strong> "I have the finest weapons and armor for your hunt! What'll it be?"</p>
                    </div>
                    
                    <p>Available Categories:</p>
                    <div id="merchant-categories">
                        <button class="game-button" onclick="showCategory('weapons')">WEAPONS</button>
                        <button class="game-button" onclick="showCategory('armor')">ARMOR</button>
                        <button class="game-button" onclick="showCategory('consumables')">CONSUMABLES</button>
                        <button class="game-button" onclick="showCategory('special')">SPECIAL</button>
                    </div>
                    
                    <div id="shop-items">
                        <!-- Shop items will be generated here -->
                    </div>
                    <br>
                    <p>Your Gold: <span id="shop-gold">10</span></p>
                    <div id="shop-log"></div>
                </div>
                <div class="button-container">
                    <button id="leave-merchant" class="game-button">BACK TO CAMP</button>
                    <button id="sell-items" class="game-button yellow">SELL ITEMS</button>
                </div>
            </div>
            
            <!-- About Screen -->
            <div id="about-screen" class="screen">
                <div class="text-output">
                    <p>ABOUT CASTLE OF THE DAMNED: ARPG</p>
                    <p>=================================</p>
                    <p>An action RPG combat game focused on hunting, looting, and character progression.</p>
                    <br>
                    <p>FEATURES:</p>
                    <p>â€¢ 24+ Enemy Types across 4 zones</p>
                    <p>â€¢ 8 NPCs with unique quests and rewards</p>
                    <p>â€¢ 30+ Weapons (Swords, Axes, Bows, Staffs)</p>
                    <p>â€¢ 25+ Armor Sets (Light, Medium, Heavy)</p>
                    <p>â€¢ 15+ Consumables and Special Items</p>
                    <p>â€¢ Boss Battles with unique mechanics</p>
                    <p>â€¢ Item Enhancement System</p>
                    <p>â€¢ Class-specific abilities and playstyles</p>
                    <br>
                    <p>Created for Android portrait mode.</p>
                </div>
                <div class="button-container">
                    <button id="back-from-about" class="game-button">BACK</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Castle of the Damned - Action RPG Combat Edition</p>
            <button id="restart-button" class="restart-button">RESTART GAME</button>
        </div>
    </div>
    
    <script>
        // Sound System using Web Audio API
        const soundSystem = {
            enabled: true,
            audioContext: null,
            
            init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("Audio system initialized");
                } catch (e) {
                    console.log("Web Audio API not supported, sounds disabled");
                    this.enabled = false;
                }
            },
            
            toggle() {
                this.enabled = !this.enabled;
                document.getElementById("sound-toggle").textContent = 
                    this.enabled ? "ðŸ”Š SOUND ON" : "ðŸ”‡ SOUND OFF";
                return this.enabled;
            },
            
            playSound(frequency, duration, type = 'sine', volume = 0.3) {
                if (!this.enabled || !this.audioContext) return;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                    oscillator.type = type;
                    
                    gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    console.log("Sound error:", e);
                }
            },
            
            // Button click sound
            playClick() {
                this.playSound(800, 0.1, 'sine', 0.2);
            },
            
            // Notification sound (level up, quest complete)
            playNotification() {
                this.playSound(1000, 0.3, 'sine', 0.3);
                setTimeout(() => this.playSound(1200, 0.2, 'sine', 0.3), 150);
            },
            
            // Combat sounds
            playAttack() {
                const freq = 300 + Math.random() * 200;
                this.playSound(freq, 0.2, 'sawtooth', 0.4);
            },
            
            playEnemyHit() {
                const freq = 100 + Math.random() * 100;
                this.playSound(freq, 0.3, 'square', 0.3);
            },
            
            playCriticalHit() {
                this.playSound(600, 0.1, 'sine', 0.5);
                setTimeout(() => this.playSound(800, 0.1, 'sine', 0.5), 50);
                setTimeout(() => this.playSound(1000, 0.1, 'sine', 0.5), 100);
            },
            
            playHeal() {
                this.playSound(523.25, 0.2, 'sine', 0.3); // C
                setTimeout(() => this.playSound(659.25, 0.2, 'sine', 0.3), 100); // E
                setTimeout(() => this.playSound(783.99, 0.2, 'sine', 0.3), 200); // G
            },
            
            playLevelUp() {
                this.playSound(523.25, 0.2, 'sine', 0.3); // C
                setTimeout(() => this.playSound(659.25, 0.2, 'sine', 0.3), 150); // E
                setTimeout(() => this.playSound(783.99, 0.2, 'sine', 0.3), 300); // G
                setTimeout(() => this.playSound(1046.50, 0.3, 'sine', 0.4), 450); // C
            },
            
            playLoot() {
                this.playSound(800, 0.1, 'sine', 0.3);
                setTimeout(() => this.playSound(1000, 0.2, 'sine', 0.3), 100);
            },
            
            playHurt() {
                const freq = 150 + Math.random() * 50;
                this.playSound(freq, 0.4, 'sawtooth', 0.4);
            },
            
            playFlee() {
                this.playSound(200, 0.5, 'sine', 0.3);
            },
            
            playError() {
                this.playSound(200, 0.3, 'square', 0.4);
            }
        };

        // Initialize sound system
        soundSystem.init();
        
        // Enhanced Game State for ARPG - FIXED VERSION
        const gameState = {
            player: {
                name: "Hunter",
                class: null,
                level: 1,
                xp: 0,
                xpToNext: 100,
                hp: 100,
                maxHp: 100,
                strength: 5,
                agility: 5,
                intelligence: 5,
                luck: 5,
                weapon: { name: "Fists", damage: 2, type: "weapon", rarity: "common" },
                armor: { name: "Clothes", defense: 0, type: "armor", rarity: "common" },
                helmet: null,
                gloves: null,
                boots: null,
                accessory: null,
                inventory: [],
                gold: 100,
                stats: {
                    enemiesDefeated: 0,
                    bossesDefeated: 0,
                    totalGold: 100,
                    itemsFound: 0,
                    questsCompleted: 0
                },
                currentZone: null,
                activeQuests: [],
                completedQuests: [],
                // FIXED: Added boss defeat tracking
                defeatedBosses: []  // This will track which bosses have been defeated
            },
            location: "start",
            selectedItem: null,
            shopItems: [],
            lastRestTime: 0,
            currentNPC: null
        };
        
        // Enhanced Enemy Database
        const enemyDatabase = {
            "haunted-woods": {
                name: "Haunted Woods",
                levelRange: "1-5",
                description: "A dark forest filled with dangerous creatures.",
                npcs: [
                    { name: "Woodsman", quests: ["Clear the Wolf Pack", "Gather Spider Silk", "Defeat the Alpha Wolf"] }
                ],
                commonEnemies: [
                    { name: "Forest Wolf", hp: 30, damage: 5, gold: 8, xp: 25, description: "A snarling wolf with sharp teeth." },
                    { name: "Goblin Scout", hp: 25, damage: 6, gold: 10, xp: 30, description: "A small green creature with a rusty dagger." },
                    { name: "Giant Spider", hp: 35, damage: 7, gold: 12, xp: 35, description: "A venomous spider that spins sticky webs." },
                    { name: "Bandit Thug", hp: 40, damage: 8, gold: 15, xp: 40, description: "A ruthless bandit looking for easy prey." },
                    { name: "Corrupted Deer", hp: 20, damage: 4, gold: 6, xp: 20, description: "A deer twisted by dark magic." }
                ],
                eliteEnemies: [
                    { name: "Alpha Wolf", hp: 80, damage: 12, gold: 40, xp: 100, description: "The leader of the wolf pack.", drops: ["Wolf Fang Amulet"] },
                    { name: "Goblin Shaman", hp: 60, damage: 15, gold: 50, xp: 120, description: "A goblin with dark magical powers.", drops: ["Shaman Staff"] }
                ],
                bosses: [
                    { name: "Forest Troll Chieftain", hp: 200, damage: 20, gold: 200, xp: 300, description: "A massive troll that rules the woods.", drops: ["Troll Hide Armor", "Great Club"] }
                ]
            },
            "cursed-ruins": {
                name: "Cursed Ruins",
                levelRange: "3-8",
                description: "Ancient ruins haunted by undead and dark magic.",
                npcs: [
                    { name: "Archaeologist", quests: ["Clear the Skeleton Army", "Retrieve the Ancient Relic", "Defeat the Necromancer"] }
                ],
                commonEnemies: [
                    { name: "Skeleton Warrior", hp: 45, damage: 9, gold: 18, xp: 45, description: "An animated skeleton with a rusty sword." },
                    { name: "Zombie", hp: 50, damage: 8, gold: 20, xp: 40, description: "A slow but tough undead creature." },
                    { name: "Ghost", hp: 30, damage: 12, gold: 25, xp: 50, description: "An ethereal spirit that can phase through attacks." },
                    { name: "Grave Robber", hp: 40, damage: 10, gold: 22, xp: 42, description: "A human scavenger turned violent." }
                ],
                eliteEnemies: [
                    { name: "Skeleton Mage", hp: 70, damage: 18, gold: 60, xp: 130, description: "A skeletal spellcaster.", drops: ["Bone Staff"] },
                    { name: "Wraith", hp: 65, damage: 20, gold: 70, xp: 140, description: "A powerful ghost with ice attacks.", drops: ["Frost Shard"] }
                ],
                bosses: [
                    { name: "Necromancer Val'Thuz", hp: 300, damage: 25, gold: 300, xp: 500, description: "A powerful undead summoner.", drops: ["Necromancer Robes", "Staff of Souls"] }
                ]
            },
            "demon-caves": {
                name: "Demon Caves",
                levelRange: "6-12",
                description: "Fiery caves inhabited by demons and elementals.",
                npcs: [
                    { name: "Demon Hunter", quests: ["Purge the Imp Nest", "Slay the Fire Elemental", "Defeat the Demon Lord"] }
                ],
                commonEnemies: [
                    { name: "Imp", hp: 55, damage: 12, gold: 25, xp: 55, description: "A small but annoying demon." },
                    { name: "Hellhound", hp: 65, damage: 15, gold: 30, xp: 60, description: "A demonic dog with fiery breath." },
                    { name: "Succubus", hp: 60, damage: 18, gold: 35, xp: 65, description: "A seductive demon that drains life." }
                ],
                eliteEnemies: [
                    { name: "Fire Elemental", hp: 120, damage: 25, gold: 100, xp: 200, description: "A being of pure flame.", drops: ["Fire Essence"] },
                    { name: "Demon Knight", hp: 150, damage: 30, gold: 120, xp: 220, description: "A heavily armored demon.", drops: ["Demon Plate"] }
                ],
                bosses: [
                    { name: "Demon Lord Azgoth", hp: 500, damage: 40, gold: 500, xp: 1000, description: "Ruler of the demon caves.", drops: ["Azgoth's Blade", "Demon Lord Crown"] }
                ]
            },
            "vampire-castle": {
                name: "Vampire Castle Gates",
                levelRange: "10-15",
                description: "The outer defenses of Lord Mortis' castle.",
                npcs: [
                    { name: "Vampire Hunter", quests: ["Kill 10 Vampire Spawn", "Destroy the Blood Altar", "Defeat the Vampire Lord"] }
                ],
                commonEnemies: [
                    { name: "Vampire Spawn", hp: 70, damage: 20, gold: 40, xp: 80, description: "A newly turned vampire." },
                    { name: "Blood Knight", hp: 90, damage: 25, gold: 50, xp: 100, description: "A vampire in full plate armor." },
                    { name: "Giant Bat", hp: 50, damage: 15, gold: 30, xp: 60, description: "A massive bat with sharp fangs." }
                ],
                eliteEnemies: [
                    { name: "Vampire Count", hp: 200, damage: 35, gold: 150, xp: 300, description: "An ancient vampire noble.", drops: ["Vampire Cloak"] },
                    { name: "Blood Mage", hp: 180, damage: 40, gold: 160, xp: 320, description: "A vampire who specializes in blood magic.", drops: ["Blood Ruby"] }
                ],
                bosses: [
                    { name: "Lord Mortis", hp: 1000, damage: 50, gold: 1000, xp: 2000, description: "The vampire lord himself.", drops: ["Mortis' Fang", "Crown of Eternal Night"] }
                ]
            }
        };
        
        // Enhanced Weapon and Armor Database - FIXED WITH SPECIAL CATEGORY
        const itemDatabase = {
            weapons: [
                { name: "Iron Sword", damage: 6, type: "weapon", rarity: "common", price: 50 },
                { name: "Steel Greatsword", damage: 10, type: "weapon", rarity: "common", price: 100 },
                { name: "Oak Bow", damage: 8, type: "weapon", rarity: "common", price: 80 },
                { name: "Apprentice Staff", damage: 7, type: "weapon", rarity: "common", price: 70 },
                { name: "Silver Sword", damage: 12, type: "weapon", rarity: "rare", price: 200, special: "vampire_slayer" },
                { name: "Dragonbone Sword", damage: 18, type: "weapon", rarity: "epic", price: 500, special: "fire_damage" },
                { name: "Vampire's Kiss", damage: 20, type: "weapon", rarity: "legendary", price: 1000, special: "life_steal" },
                { name: "Demon Slayer", damage: 22, type: "weapon", rarity: "legendary", price: 1200, special: "demon_slayer" }
            ],
            armor: [
                { name: "Leather Armor", defense: 3, type: "armor", rarity: "common", price: 40 },
                { name: "Chainmail", defense: 6, type: "armor", rarity: "common", price: 120 },
                { name: "Plate Armor", defense: 10, type: "armor", rarity: "rare", price: 300 },
                { name: "Mage Robes", defense: 2, type: "armor", rarity: "common", price: 60, magicDefense: 5 },
                { name: "Demon Hide Armor", defense: 15, type: "armor", rarity: "epic", price: 600, special: "fire_resistance" },
                { name: "Vampire Lord Armor", defense: 20, type: "armor", rarity: "legendary", price: 1500, special: "life_steal" }
            ],
            helmets: [
                { name: "Leather Cap", defense: 1, type: "helmet", rarity: "common", price: 20 },
                { name: "Iron Helmet", defense: 3, type: "helmet", rarity: "common", price: 50 },
                { name: "Mage Hood", defense: 1, type: "helmet", rarity: "common", price: 30, magicDefense: 3 }
            ],
            gloves: [
                { name: "Leather Gloves", defense: 1, type: "gloves", rarity: "common", price: 20 },
                { name: "Gauntlets", defense: 2, type: "gloves", rarity: "common", price: 40 }
            ],
            boots: [
                { name: "Leather Boots", defense: 1, type: "boots", rarity: "common", price: 20 },
                { name: "Steel Boots", defense: 3, type: "boots", rarity: "common", price: 60 }
            ],
            accessories: [
                { name: "Health Amulet", hp: 20, type: "accessory", rarity: "common", price: 100 },
                { name: "Strength Ring", strength: 2, type: "accessory", rarity: "rare", price: 200 },
                { name: "Luck Charm", luck: 3, type: "accessory", rarity: "rare", price: 250 },
                { name: "Vampire Ring", special: "life_steal_small", type: "accessory", rarity: "epic", price: 500 }
            ],
            consumables: [
                { name: "Health Potion", effect: "heal", value: 50, type: "consumable", rarity: "common", price: 30 },
                { name: "Greater Health Potion", effect: "heal", value: 100, type: "consumable", rarity: "rare", price: 80 },
                { name: "Elixir of Strength", effect: "buff_strength", value: 5, type: "consumable", rarity: "rare", price: 120 },
                { name: "Elixir of Defense", effect: "buff_defense", value: 5, type: "consumable", rarity: "rare", price: 120 },
                { name: "Poison Antidote", effect: "cure_poison", type: "consumable", rarity: "common", price: 40 }
            ],
            // FIXED: Added SPECIAL category with boss-unlocked items
            special: [
                { 
                    name: "Forest Guardian's Cloak", 
                    defense: 8, 
                    type: "armor", 
                    rarity: "epic", 
                    price: 800, 
                    special: "nature_resistance",
                    unlockBoss: "Forest Troll Chieftain",
                    description: "A cloak woven from enchanted forest vines. Unlocked after defeating the Forest Troll Chieftain."
                },
                { 
                    name: "Necromancer's Phylactery", 
                    hp: 50, 
                    intelligence: 5, 
                    type: "accessory", 
                    rarity: "epic", 
                    price: 1000, 
                    special: "undead_command",
                    unlockBoss: "Necromancer Val'Thuz",
                    description: "A soul container that grants power over the undead. Unlocked after defeating Necromancer Val'Thuz."
                },
                { 
                    name: "Demon Heart", 
                    strength: 8, 
                    damage: 5, 
                    type: "accessory", 
                    rarity: "legendary", 
                    price: 1500, 
                    special: "demon_essence",
                    unlockBoss: "Demon Lord Azgoth",
                    description: "The still-beating heart of a demon lord. Unlocked after defeating Demon Lord Azgoth."
                },
                { 
                    name: "Vampire Lord's Mantle", 
                    defense: 12, 
                    hp: 100, 
                    type: "armor", 
                    rarity: "legendary", 
                    price: 2500, 
                    special: "vampiric_aura",
                    unlockBoss: "Lord Mortis",
                    description: "The regal mantle of the vampire lord. Unlocked after defeating Lord Mortis."
                },
                { 
                    name: "Ancient Relic", 
                    luck: 10, 
                    goldBonus: 0.25, 
                    type: "accessory", 
                    rarity: "legendary", 
                    price: 3000, 
                    special: "relic_power",
                    unlockBoss: "ALL_BOSSES",
                    description: "An ancient artifact that reacts to all boss essences. Unlocked after defeating all four major bosses."
                }
            ]
        };
        
        // Game Functions
        function saveGame() {
            localStorage.setItem("castleARPG", JSON.stringify(gameState));
            console.log("Game saved");
        }
        
        function loadGame() {
            const saved = localStorage.getItem("castleARPG");
            if (saved) {
                const loadedState = JSON.parse(saved);
                Object.assign(gameState, loadedState);
                
                // Ensure defeatedBosses exists in old saves
                if (!gameState.player.defeatedBosses) {
                    gameState.player.defeatedBosses = [];
                }
                
                updateStatsDisplay();
                addToLog("Game loaded successfully!", "zone-log");
                soundSystem.playNotification();
                return true;
            }
            return false;
        }
        
        function updateStatsDisplay() {
            document.getElementById("hp-value").textContent = gameState.player.hp;
            document.getElementById("hp-max").textContent = gameState.player.maxHp;
            document.getElementById("class-value").textContent = gameState.player.class || "-";
            document.getElementById("level-value").textContent = gameState.player.level;
            document.getElementById("gold-value").textContent = gameState.player.gold;
            
            // FIXED: Update player health bar width
            const playerHealthPercent = (gameState.player.hp / gameState.player.maxHp) * 100;
            document.getElementById("player-health-bar").style.width = playerHealthPercent + "%";
            
            if (document.getElementById("xp-current")) {
                document.getElementById("xp-current").textContent = gameState.player.xp;
                document.getElementById("xp-next").textContent = gameState.player.xpToNext;
                const xpPercent = (gameState.player.xp / gameState.player.xpToNext) * 100;
                document.getElementById("xp-bar-fill").style.width = Math.min(xpPercent, 100) + "%";
            }
            
            // Update inventory display
            document.getElementById("inv-weapon").textContent = gameState.player.weapon.name;
            document.getElementById("inv-weapon-dmg").textContent = gameState.player.weapon.damage;
            document.getElementById("inv-armor").textContent = gameState.player.armor.name;
            document.getElementById("inv-armor-def").textContent = gameState.player.armor.defense;
            document.getElementById("inv-helmet").textContent = gameState.player.helmet ? gameState.player.helmet.name : "None";
            document.getElementById("inv-gloves").textContent = gameState.player.gloves ? gameState.player.gloves.name : "None";
            document.getElementById("inv-boots").textContent = gameState.player.boots ? gameState.player.boots.name : "None";
            document.getElementById("inv-accessory").textContent = gameState.player.accessory ? gameState.player.accessory.name : "None";
        }
        
        function addToLog(message, logId = "hunt-log") {
            const logElement = document.getElementById(logId);
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            logElement.innerHTML = `<p>[${timestamp}] ${message}</p>` + logElement.innerHTML;
            
            if (logElement.children.length > 10) {
                logElement.removeChild(logElement.lastChild);
            }
        }
        
        function switchScreen(screenId) {
            document.querySelectorAll(".screen").forEach(screen => {
                screen.classList.remove("active-screen");
            });
            document.getElementById(screenId).classList.add("active-screen");
            
            // Initialize specific screens
            if (screenId === "zone-screen") {
                updateZoneScreen();
            } else if (screenId === "hunt-screen") {
                updateHuntScreen();
            } else if (screenId === "inventory-screen") {
                updateInventoryDisplay();
            } else if (screenId === "merchant-screen") {
                showCategory('weapons');
            }
        }
        
        // Combat System
        let currentEnemy = null;
        let isBossFight = false;
        
        function startCombat(enemy, isBoss = false) {
            currentEnemy = {
                ...enemy,
                currentHp: enemy.hp,
                maxHp: enemy.hp
            };
            
            isBossFight = isBoss;
            
            document.getElementById("enemy-name").textContent = enemy.name;
            document.getElementById("enemy-desc").textContent = enemy.description;
            
            if (isBoss) {
                document.getElementById("boss-health-container").style.display = "block";
                document.getElementById("normal-health-container").style.display = "none";
                document.getElementById("boss-health-bar").style.width = "100%";
            } else {
                document.getElementById("boss-health-container").style.display = "none";
                document.getElementById("normal-health-container").style.display = "block";
                document.getElementById("enemy-health-bar").style.width = "100%";
            }
            
            // Update player health bar at combat start
            updateStatsDisplay();
            
            switchScreen("combat-screen");
            addToLog(`A ${enemy.name} appears!`, "combat-action-log");
            
            // Combat start sound
            soundSystem.playAttack();
        }
        
        function playerAttack(type = "basic") {
            if (!currentEnemy) return;
            
            soundSystem.playAttack();
            
            let baseDamage = gameState.player.weapon.damage;
            let damage = baseDamage;
            let isCritical = false;
            
            // Apply class bonuses
            switch(gameState.player.class) {
                case "BARBARIAN":
                    damage += Math.floor(gameState.player.strength / 2);
                    if (type === "heavy") damage *= 1.5;
                    break;
                case "ASSASSIN":
                    damage += Math.floor(gameState.player.agility / 3);
                    // High critical chance
                    if (Math.random() < 0.3) {
                        damage *= 1.8;
                        isCritical = true;
                    }
                    break;
                case "SORCERER":
                    damage += Math.floor(gameState.player.intelligence / 2);
                    if (type === "special") damage *= 1.6;
                    break;
            }
            
            // Apply random variation
            damage = Math.floor(damage * (0.8 + Math.random() * 0.4));
            
            currentEnemy.currentHp -= damage;
            updateEnemyHealth();
            
            if (isCritical) {
                addToLog(`CRITICAL HIT! You attack for ${damage} damage!`, "combat-action-log");
                soundSystem.playCriticalHit();
            } else {
                addToLog(`You attack for ${damage} damage!`, "combat-action-log");
            }
            
            if (currentEnemy.currentHp <= 0) {
                enemyDefeated();
            } else {
                setTimeout(enemyAttack, 800);
            }
        }
        
        function updateEnemyHealth() {
            const healthPercent = (currentEnemy.currentHp / currentEnemy.maxHp) * 100;
            if (isBossFight) {
                document.getElementById("boss-health-bar").style.width = healthPercent + "%";
            } else {
                document.getElementById("enemy-health-bar").style.width = healthPercent + "%";
            }
        }
        
        function enemyAttack() {
            if (!currentEnemy) return;
            
            soundSystem.playEnemyHit();
            
            let damage = currentEnemy.damage;
            
            // Apply defense
            let totalDefense = gameState.player.armor.defense;
            if (gameState.player.helmet) totalDefense += gameState.player.helmet.defense || 0;
            if (gameState.player.gloves) totalDefense += gameState.player.gloves.defense || 0;
            if (gameState.player.boots) totalDefense += gameState.player.boots.defense || 0;
            
            damage = Math.max(1, damage - Math.floor(totalDefense / 2));
            
            gameState.player.hp -= damage;
            updateStatsDisplay(); // This now updates the player health bar too
            
            addToLog(`The ${currentEnemy.name} attacks for ${damage} damage!`, "combat-action-log");
            
            // Play hurt sound if damage is significant
            if (damage > 5) {
                soundSystem.playHurt();
            }
            
            // Check if player is defeated
            if (gameState.player.hp <= 0) {
                gameOver();
            }
        }
        
        // FIXED: enemyDefeated function now properly tracks boss defeats
        function enemyDefeated() {
            gameState.player.stats.enemiesDefeated++;
            
            // FIXED: Track boss defeats
            if (isBossFight) {
                gameState.player.stats.bossesDefeated++;
                
                // Check if this boss hasn't been defeated before
                if (!gameState.player.defeatedBosses.includes(currentEnemy.name)) {
                    gameState.player.defeatedBosses.push(currentEnemy.name);
                    
                    // Show special unlock message
                    addToLog(`ðŸŽŠ ${currentEnemy.name} has been defeated! New special items unlocked at the merchant!`, "combat-action-log");
                }
            }
            
            // Calculate rewards
            let goldReward = currentEnemy.gold;
            let xpReward = currentEnemy.xp;
            
            // Luck bonus
            goldReward += Math.floor(gameState.player.luck);
            xpReward += Math.floor(gameState.player.luck);
            
            gameState.player.gold += goldReward;
            gameState.player.xp += xpReward;
            
            // Victory sound
            soundSystem.playNotification();
            
            // Check for level up
            checkLevelUp();
            
            // Show loot - FIXED: Now shows proper message about merchant unlocks
            const lootHTML = `
                <div class="loot-drop">
                    <p>ðŸŽ‰ VICTORY! ðŸŽ‰</p>
                    <p>+${goldReward} Gold</p>
                    <p>+${xpReward} XP</p>
                    ${isBossFight ? `<p>âš”ï¸ BOSS DEFEATED!</p><p>Check the SPECIAL category at the merchant for new items!</p>` : ''}
                </div>
            `;
            document.getElementById("combat-loot").innerHTML = lootHTML;
            
            addToLog(`You defeated the ${currentEnemy.name}!`, "combat-action-log");
            
            // Check quest progress
            checkQuestProgress(currentEnemy.name);
            
            // Return to hunt screen
            setTimeout(() => {
                currentEnemy = null;
                switchScreen("hunt-screen");
                saveGame();
            }, 3000);
        }
        
        function checkLevelUp() {
            if (gameState.player.xp >= gameState.player.xpToNext) {
                gameState.player.level++;
                gameState.player.xp -= gameState.player.xpToNext;
                gameState.player.xpToNext = Math.floor(gameState.player.xpToNext * 1.5);
                
                // Level up bonuses
                gameState.player.maxHp += 20;
                gameState.player.hp = gameState.player.maxHp;
                gameState.player.strength += 2;
                gameState.player.agility += 2;
                gameState.player.intelligence += 2;
                gameState.player.luck += 1;
                
                // Class-specific level up
                switch(gameState.player.class) {
                    case "BARBARIAN":
                        gameState.player.maxHp += 10;
                        gameState.player.strength += 2;
                        break;
                    case "ASSASSIN":
                        gameState.player.agility += 3;
                        gameState.player.luck += 1;
                        break;
                    case "SORCERER":
                        gameState.player.intelligence += 3;
                        gameState.player.maxHp += 5;
                        break;
                }
                
                soundSystem.playLevelUp();
                showLevelUp();
            }
        }
        
        function showLevelUp() {
            const levelUpHTML = `
                <div class="level-up">
                    â­ LEVEL UP! â­<br>
                    You are now Level ${gameState.player.level}!<br>
                    All stats increased!
                </div>
            `;
            
            const logElement = document.getElementById("hunt-log");
            logElement.innerHTML = levelUpHTML + logElement.innerHTML;
        }
        
        // Zone System
        function updateZoneScreen() {
            const zoneQuestDiv = document.getElementById("zone-quests");
            zoneQuestDiv.innerHTML = "";
            
            // Show available quests
            if (gameState.player.currentZone && enemyDatabase[gameState.player.currentZone]) {
                const zone = enemyDatabase[gameState.player.currentZone];
                zone.npcs.forEach(npc => {
                    zoneQuestDiv.innerHTML += `<div class="quest-marker">${npc.name}: ${npc.quests[0]}</div>`;
                });
            }
            
            // Highlight selected zone
            document.querySelectorAll(".zone-option").forEach(option => {
                option.style.border = "1px solid #33ccff";
                if (option.dataset.zone === gameState.player.currentZone) {
                    option.style.border = "2px solid #ffff33";
                }
            });
            
            // FIXED: Show boss progress
            if (gameState.player.defeatedBosses.length > 0) {
                const bossProgress = `
                    <div class="npc-dialog" style="margin-top: 15px;">
                        <p><strong>Boss Progress:</strong> ${gameState.player.defeatedBosses.length}/4 bosses defeated</p>
                        <p>Special items unlocked: ${gameState.player.defeatedBosses.length}</p>
                    </div>
                `;
                zoneQuestDiv.innerHTML += bossProgress;
            }
        }
        
        function updateHuntScreen() {
            if (!gameState.player.currentZone) return;
            
            const zone = enemyDatabase[gameState.player.currentZone];
            document.getElementById("current-zone-title").textContent = zone.name;
            document.getElementById("current-zone-desc").textContent = zone.description;
            
            // Update enemy group display
            const enemyGroupDiv = document.getElementById("enemy-group-display");
            enemyGroupDiv.innerHTML = `
                <p><strong>Common Enemies:</strong></p>
                <div>
                    ${zone.commonEnemies.map(enemy => `
                        <span class="enemy-icon">${enemy.name}</span>
                    `).join('')}
                </div>
                
                <p><strong>Elite Enemies:</strong></p>
                <div>
                    ${zone.eliteEnemies.map(enemy => `
                        <span class="enemy-icon elite">${enemy.name}</span>
                    `).join('')}
                </div>
                
                <p><strong>Boss:</strong></p>
                <div>
                    ${zone.bosses.map(enemy => `
                        <span class="enemy-icon boss">${enemy.name} ${gameState.player.defeatedBosses.includes(enemy.name) ? 'âœ“' : ''}</span>
                    `).join('')}
                </div>
            `;
            
            // Show NPC encounter chance
            if (Math.random() < 0.3) {
                const npc = zone.npcs[0];
                document.getElementById("npc-encounter").innerHTML = `
                    <div class="npc-dialog">
                        <p><strong>${npc.name}:</strong> "${npc.quests[0]}"</p>
                        <button class="game-button" onclick="acceptQuest('${npc.quests[0]}')">ACCEPT QUEST</button>
                    </div>
                `;
            }
        }
        
        // Quest System
        function acceptQuest(questName) {
            if (!gameState.player.activeQuests.includes(questName)) {
                gameState.player.activeQuests.push(questName);
                addToLog(`Quest accepted: ${questName}`);
                soundSystem.playNotification();
                document.getElementById("npc-encounter").innerHTML = "";
                saveGame();
            }
        }
        
        function checkQuestProgress(enemyName) {
            const completedQuests = [];
            
            gameState.player.activeQuests.forEach(quest => {
                if (quest.includes("Wolf") && enemyName.includes("Wolf")) {
                    completedQuests.push(quest);
                } else if (quest.includes("Spider") && enemyName.includes("Spider")) {
                    completedQuests.push(quest);
                } else if (quest.includes("Goblin") && enemyName.includes("Goblin")) {
                    completedQuests.push(quest);
                }
                // Add more quest completion conditions here
            });
            
            completedQuests.forEach(quest => {
                completeQuest(quest);
            });
        }
        
        function completeQuest(questName) {
            const index = gameState.player.activeQuests.indexOf(questName);
            if (index > -1) {
                gameState.player.activeQuests.splice(index, 1);
                gameState.player.completedQuests.push(questName);
                gameState.player.stats.questsCompleted++;
                
                // Quest rewards
                const goldReward = 100 * gameState.player.level;
                const xpReward = 50 * gameState.player.level;
                
                gameState.player.gold += goldReward;
                gameState.player.xp += xpReward;
                
                addToLog(`Quest completed: ${questName}! Reward: ${goldReward} gold, ${xpReward} XP`);
                soundSystem.playLevelUp();
                
                checkLevelUp();
                updateStatsDisplay();
                saveGame();
            }
        }
        
        // Inventory System
        function updateInventoryDisplay() {
            const inventoryDisplay = document.getElementById("inventory-display");
            
            if (gameState.player.inventory.length === 0) {
                inventoryDisplay.innerHTML = "<p>Your inventory is empty.</p>";
                return;
            }
            
            let html = "<div class='inventory'>";
            gameState.player.inventory.forEach((item, index) => {
                const isSelected = gameState.selectedItem === index ? "selected" : "";
                const rarityClass = item.rarity || "common";
                const itemClass = `item ${rarityClass} ${isSelected}`;
                
                html += `<div class='${itemClass}' data-index='${index}' onclick="selectItem(${index})">`;
                html += item.name;
                if (item.damage) html += ` (+${item.damage} DMG)`;
                if (item.defense) html += ` (+${item.defense} DEF)`;
                html += `</div>`;
            });
            html += "</div>";
            
            inventoryDisplay.innerHTML = html;
        }
        
        function selectItem(index) {
            gameState.selectedItem = index;
            updateInventoryDisplay();
            soundSystem.playClick();
        }
        
        function equipSelectedItem() {
            if (gameState.selectedItem === null) return;
            
            const item = gameState.player.inventory[gameState.selectedItem];
            let oldItem = null;
            
            switch(item.type) {
                case "weapon":
                    oldItem = gameState.player.weapon;
                    gameState.player.weapon = item;
                    break;
                case "armor":
                    oldItem = gameState.player.armor;
                    gameState.player.armor = item;
                    break;
                case "helmet":
                    oldItem = gameState.player.helmet;
                    gameState.player.helmet = item;
                    break;
                case "gloves":
                    oldItem = gameState.player.gloves;
                    gameState.player.gloves = item;
                    break;
                case "boots":
                    oldItem = gameState.player.boots;
                    gameState.player.boots = item;
                    break;
                case "accessory":
                    oldItem = gameState.player.accessory;
                    gameState.player.accessory = item;
                    break;
            }
            
            if (oldItem) {
                gameState.player.inventory[gameState.selectedItem] = oldItem;
            } else {
                gameState.player.inventory.splice(gameState.selectedItem, 1);
            }
            
            gameState.selectedItem = null;
            updateInventoryDisplay();
            updateStatsDisplay();
            saveGame();
            
            soundSystem.playNotification();
            addToLog(`Equipped ${item.name}`);
        }
        
        // FIXED: Merchant System - Now properly shows special items
        function showCategory(category) {
            const shopItemsDiv = document.getElementById("shop-items");
            
            let html = `<h3>${category.toUpperCase()}</h3>`;
            
            // FIXED: Special category shows items based on defeated bosses
            if (category === 'special') {
                // Get unlocked special items
                const unlockedItems = itemDatabase.special.filter(item => {
                    if (item.unlockBoss === "ALL_BOSSES") {
                        // Check if all 4 bosses are defeated
                        const allBosses = [
                            "Forest Troll Chieftain",
                            "Necromancer Val'Thuz", 
                            "Demon Lord Azgoth",
                            "Lord Mortis"
                        ];
                        return allBosses.every(boss => gameState.player.defeatedBosses.includes(boss));
                    }
                    return gameState.player.defeatedBosses.includes(item.unlockBoss);
                });
                
                if (unlockedItems.length === 0) {
                    html += `
                        <div class="item" style="margin: 10px 0; padding: 10px; border-color: #ff9900;">
                            <strong>ðŸ”’ LOCKED SPECIAL ITEMS</strong><br>
                            Defeat bosses to unlock powerful special items!<br>
                            <small>Bosses defeated: ${gameState.player.defeatedBosses.length}/4</small>
                            ${gameState.player.defeatedBosses.length > 0 ? 
                                `<br><small>You've defeated: ${gameState.player.defeatedBosses.join(', ')}</small>` : 
                                ''}
                        </div>
                    `;
                } else {
                    unlockedItems.forEach((item, index) => {
                        html += `
                            <div class="item ${item.rarity}" style="margin: 10px 0; padding: 10px;">
                                <strong>â­ ${item.name}</strong><br>
                                ${item.description || ''}<br>
                                ${item.damage ? `Damage: +${item.damage}<br>` : ''}
                                ${item.defense ? `Defense: +${item.defense}<br>` : ''}
                                ${item.hp ? `HP: +${item.hp}<br>` : ''}
                                ${item.strength ? `Strength: +${item.strength}<br>` : ''}
                                ${item.intelligence ? `Intelligence: +${item.intelligence}<br>` : ''}
                                ${item.luck ? `Luck: +${item.luck}<br>` : ''}
                                ${item.special ? `Special: ${item.special}<br>` : ''}
                                Price: ${item.price} gold<br>
                                <button class="game-button" onclick="buySpecialItem('${item.name}')" style="margin-top: 5px;">BUY</button>
                            </div>
                        `;
                    });
                }
            } else {
                // Original logic for other categories
                const items = itemDatabase[category];
                if (items) {
                    items.forEach((item, index) => {
                        html += `
                            <div class="item ${item.rarity}" style="margin: 10px 0; padding: 10px;">
                                <strong>${item.name}</strong><br>
                                ${item.damage ? `Damage: +${item.damage}<br>` : ''}
                                ${item.defense ? `Defense: +${item.defense}<br>` : ''}
                                ${item.hp ? `HP: +${item.hp}<br>` : ''}
                                ${item.effect ? `Effect: ${item.effect}<br>` : ''}
                                Price: ${item.price} gold<br>
                                <button class="game-button" onclick="buyItem('${category}', ${index})" style="margin-top: 5px;">BUY</button>
                            </div>
                        `;
                    });
                }
            }
            
            shopItemsDiv.innerHTML = html;
            document.getElementById("shop-gold").textContent = gameState.player.gold;
        }
        
        function buyItem(category, index) {
            const item = itemDatabase[category][index];
            
            if (gameState.player.gold >= item.price) {
                gameState.player.gold -= item.price;
                gameState.player.inventory.push({...item});
                addToLog(`Bought ${item.name} for ${item.price} gold.`, "shop-log");
                soundSystem.playLoot();
                updateStatsDisplay();
                showCategory(category);
                saveGame();
            } else {
                addToLog("Not enough gold!", "shop-log");
                soundSystem.playError();
            }
        }
        
        // FIXED: Special item purchase function
        function buySpecialItem(itemName) {
            // Find the special item by name
            const item = itemDatabase.special.find(i => i.name === itemName);
            
            if (!item) {
                addToLog("Item not found!", "shop-log");
                soundSystem.playError();
                return;
            }
            
            // Check if player has enough gold
            if (gameState.player.gold >= item.price) {
                gameState.player.gold -= item.price;
                gameState.player.inventory.push({...item});
                addToLog(`Bought ${item.name} for ${item.price} gold.`, "shop-log");
                soundSystem.playLoot();
                updateStatsDisplay();
                showCategory('special'); // Refresh the special category
                saveGame();
            } else {
                addToLog("Not enough gold!", "shop-log");
                soundSystem.playError();
            }
        }
        
        // Event Listeners
        document.addEventListener("DOMContentLoaded", function() {
            // Sound toggle button
            document.getElementById("sound-toggle").addEventListener("click", function() {
                soundSystem.toggle();
                soundSystem.playClick();
            });
            
            // Add sound to all game buttons
            document.querySelectorAll(".game-button").forEach(button => {
                button.addEventListener("click", function() {
                    if (!this.disabled) {
                        soundSystem.playClick();
                    }
                });
            });
            
            // Class Selection
            let selectedClass = null;
            document.querySelectorAll(".class-option").forEach(option => {
                option.addEventListener("click", function() {
                    document.querySelectorAll(".class-option").forEach(opt => {
                        opt.classList.remove("selected");
                    });
                    this.classList.add("selected");
                    selectedClass = this.id.replace("-class", "").toUpperCase();
                    document.getElementById("confirm-class").disabled = false;
                    soundSystem.playClick();
                });
            });
            
            document.getElementById("confirm-class").addEventListener("click", function() {
                if (!selectedClass) return;
                
                gameState.player.class = selectedClass;
                
                // Class starting gear
                switch(selectedClass) {
                    case "BARBARIAN":
                        gameState.player.hp = 150;
                        gameState.player.maxHp = 150;
                        gameState.player.strength = 10;
                        gameState.player.agility = 4;
                        gameState.player.intelligence = 3;
                        gameState.player.luck = 3;
                        gameState.player.weapon = { name: "Battle Axe", damage: 8, type: "weapon", rarity: "rare" };
                        gameState.player.armor = { name: "Heavy Leather Armor", defense: 5, type: "armor", rarity: "rare" };
                        gameState.player.inventory.push({ name: "Health Potion", effect: "heal", value: 50, type: "consumable", rarity: "common" });
                        gameState.player.inventory.push({ name: "Health Potion", effect: "heal", value: 50, type: "consumable", rarity: "common" });
                        break;
                    case "ASSASSIN":
                        gameState.player.hp = 100;
                        gameState.player.maxHp = 100;
                        gameState.player.strength = 5;
                        gameState.player.agility = 10;
                        gameState.player.intelligence = 4;
                        gameState.player.luck = 6;
                        gameState.player.weapon = { name: "Poisoned Daggers", damage: 6, type: "weapon", rarity: "rare", special: "poison" };
                        gameState.player.armor = { name: "Assassin's Garb", defense: 2, type: "armor", rarity: "rare" };
                        gameState.player.inventory.push({ name: "Smoke Bomb", effect: "escape", type: "consumable", rarity: "common" });
                        gameState.player.inventory.push({ name: "Health Potion", effect: "heal", value: 50, type: "consumable", rarity: "common" });
                        break;
                    case "SORCERER":
                        gameState.player.hp = 80;
                        gameState.player.maxHp = 80;
                        gameState.player.strength = 3;
                        gameState.player.agility = 4;
                        gameState.player.intelligence = 10;
                        gameState.player.luck = 5;
                        gameState.player.weapon = { name: "Spellbook", damage: 5, type: "weapon", rarity: "rare", special: "magic" };
                        gameState.player.armor = { name: "Mage Robes", defense: 1, type: "armor", rarity: "rare", magicDefense: 5 };
                        gameState.player.inventory.push({ name: "Mana Potion", effect: "heal", value: 30, type: "consumable", rarity: "common" });
                        gameState.player.inventory.push({ name: "Health Potion", effect: "heal", value: 50, type: "consumable", rarity: "common" });
                        break;
                }
                
                updateStatsDisplay();
                switchScreen("zone-screen");
                soundSystem.playNotification();
                saveGame();
            });
            
            // Navigation
            document.getElementById("start-button").addEventListener("click", function() {
                switchScreen("class-screen");
            });
            
            document.getElementById("load-button").addEventListener("click", function() {
                if (loadGame()) {
                    switchScreen("zone-screen");
                } else {
                    addToLog("No saved game found.");
                    soundSystem.playError();
                }
            });
            
            document.getElementById("back-to-start").addEventListener("click", function() {
                switchScreen("start-screen");
            });
            
            document.getElementById("back-from-about").addEventListener("click", function() {
                switchScreen("start-screen");
            });
            
            // Zone Selection
            document.querySelectorAll(".zone-option").forEach(option => {
                option.addEventListener("click", function() {
                    gameState.player.currentZone = this.dataset.zone;
                    document.getElementById("enter-zone").disabled = false;
                    updateZoneScreen();
                    soundSystem.playClick();
                });
            });
            
            document.getElementById("enter-zone").addEventListener("click", function() {
                if (gameState.player.currentZone) {
                    switchScreen("hunt-screen");
                }
            });
            
            document.getElementById("zone-merchant").addEventListener("click", function() {
                switchScreen("merchant-screen");
            });
            
            document.getElementById("view-inv-zone").addEventListener("click", function() {
                switchScreen("inventory-screen");
            });
            
            document.getElementById("back-to-tavern").addEventListener("click", function() {
                switchScreen("zone-screen");
            });
            
            // Hunt Screen
            document.getElementById("hunt-common").addEventListener("click", function() {
                if (!gameState.player.currentZone) return;
                
                const zone = enemyDatabase[gameState.player.currentZone];
                const enemy = zone.commonEnemies[Math.floor(Math.random() * zone.commonEnemies.length)];
                startCombat(enemy);
            });
            
            document.getElementById("hunt-elite").addEventListener("click", function() {
                if (!gameState.player.currentZone) return;
                
                const zone = enemyDatabase[gameState.player.currentZone];
                const enemy = zone.eliteEnemies[Math.floor(Math.random() * zone.eliteEnemies.length)];
                startCombat(enemy);
            });
            
            document.getElementById("hunt-boss").addEventListener("click", function() {
                if (!gameState.player.currentZone) return;
                
                const zone = enemyDatabase[gameState.player.currentZone];
                if (gameState.player.level < parseInt(zone.levelRange.split("-")[0])) {
                    addToLog(`You need to be at least level ${zone.levelRange.split("-")[0]} to face the boss!`);
                    soundSystem.playError();
                    return;
                }
                
                const enemy = zone.bosses[0];
                startCombat(enemy, true);
            });
            
            document.getElementById("rest-hunt").addEventListener("click", function() {
                const now = Date.now();
                if (now - gameState.lastRestTime < 30000) {
                    addToLog("You need to wait before resting again.");
                    soundSystem.playError();
                    return;
                }
                
                const healAmount = 50 + (gameState.player.level * 10);
                gameState.player.hp = Math.min(gameState.player.hp + healAmount, gameState.player.maxHp);
                addToLog(`You rest and recover ${healAmount} HP.`);
                soundSystem.playHeal();
                gameState.lastRestTime = now;
                updateStatsDisplay();
                saveGame();
            });
            
            document.getElementById("use-item-hunt").addEventListener("click", function() {
                switchScreen("inventory-screen");
            });
            
            document.getElementById("view-inv-hunt").addEventListener("click", function() {
                switchScreen("inventory-screen");
            });
            
            document.getElementById("leave-zone").addEventListener("click", function() {
                switchScreen("zone-screen");
            });
            
            // Combat Screen
            document.getElementById("attack-button").addEventListener("click", function() {
                playerAttack("basic");
            });
            
            document.getElementById("heavy-attack").addEventListener("click", function() {
                playerAttack("heavy");
            });
            
            document.getElementById("special-attack").addEventListener("click", function() {
                playerAttack("special");
            });
            
            document.getElementById("ability-button").addEventListener("click", function() {
                // Class abilities
                let abilityMessage = "";
                
                switch(gameState.player.class) {
                    case "BARBARIAN":
                        abilityMessage = "You enter a RAGE, increasing your damage!";
                        // Temporary damage boost
                        soundSystem.playAttack();
                        break;
                    case "ASSASSIN":
                        abilityMessage = "You go into STEALTH, your next attack will be a critical!";
                        // Next attack is guaranteed critical
                        soundSystem.playFlee();
                        break;
                    case "SORCERER":
                        abilityMessage = "You cast FIREBALL, dealing area damage!";
                        // Extra damage
                        soundSystem.playCriticalHit();
                        break;
                }
                
                addToLog(abilityMessage, "combat-action-log");
                
                if (currentEnemy && currentEnemy.currentHp > 0) {
                    setTimeout(enemyAttack, 800);
                }
            });
            
            document.getElementById("flee-button").addEventListener("click", function() {
                const fleeChance = gameState.player.agility / 20;
                if (Math.random() < fleeChance) {
                    addToLog("You successfully flee from combat!", "combat-action-log");
                    soundSystem.playFlee();
                    setTimeout(() => {
                        currentEnemy = null;
                        switchScreen("hunt-screen");
                    }, 1000);
                } else {
                    addToLog("You fail to escape!", "combat-action-log");
                    soundSystem.playError();
                    setTimeout(enemyAttack, 500);
                }
            });
            
            document.getElementById("use-item-combat").addEventListener("click", function() {
                switchScreen("inventory-screen");
            });
            
            // Inventory Screen
            document.getElementById("close-inventory").addEventListener("click", function() {
                if (currentEnemy) {
                    switchScreen("combat-screen");
                } else {
                    switchScreen("hunt-screen");
                }
            });
            
            document.getElementById("use-item-inv").addEventListener("click", function() {
                if (gameState.selectedItem === null) return;
                
                const item = gameState.player.inventory[gameState.selectedItem];
                
                if (item.type === "consumable") {
                    if (item.effect === "heal") {
                        gameState.player.hp = Math.min(gameState.player.hp + item.value, gameState.player.maxHp);
                        addToLog(`Used ${item.name}, healed ${item.value} HP.`);
                        soundSystem.playHeal();
                    }
                    
                    // Remove from inventory
                    gameState.player.inventory.splice(gameState.selectedItem, 1);
                    gameState.selectedItem = null;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                    saveGame();
                }
            });
            
            document.getElementById("equip-item").addEventListener("click", equipSelectedItem);
            
            document.getElementById("enhance-item").addEventListener("click", function() {
                if (gameState.selectedItem === null) return;
                
                const item = gameState.player.inventory[gameState.selectedItem];
                
                if (gameState.player.gold >= 50) {
                    gameState.player.gold -= 50;
                    
                    // Enhance the item
                    if (item.damage) item.damage += 2;
                    if (item.defense) item.defense += 1;
                    
                    addToLog(`Enhanced ${item.name} for 50 gold.`);
                    soundSystem.playNotification();
                    updateInventoryDisplay();
                    updateStatsDisplay();
                    saveGame();
                } else {
                    addToLog("Not enough gold for enhancement!");
                    soundSystem.playError();
                }
            });
            
            // Merchant Screen
            document.getElementById("leave-merchant").addEventListener("click", function() {
                switchScreen("zone-screen");
            });
            
            document.getElementById("sell-items").addEventListener("click", function() {
                if (gameState.selectedItem === null) return;
                
                const item = gameState.player.inventory[gameState.selectedItem];
                let sellPrice = 20;
                
                if (item.rarity === "rare") sellPrice = 50;
                if (item.rarity === "epic") sellPrice = 150;
                if (item.rarity === "legendary") sellPrice = 500;
                
                gameState.player.gold += sellPrice;
                gameState.player.inventory.splice(gameState.selectedItem, 1);
                gameState.selectedItem = null;
                
                addToLog(`Sold item for ${sellPrice} gold.`, "shop-log");
                soundSystem.playLoot();
                updateInventoryDisplay();
                updateStatsDisplay();
                showCategory('weapons');
                saveGame();
            });
            
            // About button
            document.getElementById("about-button").addEventListener("click", function() {
                switchScreen("about-screen");
            });
            
            // Restart button
            document.getElementById("restart-button").addEventListener("click", function() {
                if (confirm("Are you sure you want to restart? All progress will be lost.")) {
                    localStorage.removeItem("castleARPG");
                    location.reload();
                }
            });
            
            // Auto-save every 30 seconds
            setInterval(saveGame, 30000);
            
            // Load game if exists
            if (localStorage.getItem("castleARPG")) {
                document.getElementById("load-button").style.display = "block";
            }
            
            // Initial player health bar setup
            updateStatsDisplay();
        });
        
        // Global functions for merchant
        window.showCategory = showCategory;
        window.buyItem = buyItem;
        window.buySpecialItem = buySpecialItem;
        window.acceptQuest = acceptQuest;
        window.selectItem = selectItem;
        
        // Game over function
        function gameOver() {
            addToLog("YOU HAVE BEEN DEFEATED!", "combat-action-log");
            soundSystem.playError();
            setTimeout(() => {
                if (confirm("You have been defeated! Restart game?")) {
                    localStorage.removeItem("castleARPG");
                    location.reload();
                }
            }, 2000);
        }
    </script>
</body>
</html>
