<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASTLE OF THE UNDEAD - Level 10: The Master Quarters</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Royal Purple/Gold/Black theme for Master Quarters */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(80, 40, 140, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(80, 40, 140, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #bf40bf;
            background-color: #000;
            box-shadow: 0 0 20px rgba(191, 64, 191, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(80, 40, 140, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #bf40bf;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #d8a0ff;
            text-shadow: 0 0 5px #bf40bf;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #bf40bf;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #bf40bf;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #301060;
            color: #d8a0ff;
            border-color: #d8a0ff;
        }
        
        .level-number.current {
            background-color: #bf40bf;
            color: #fff;
            border-color: #d8a0ff;
            box-shadow: 0 0 8px #bf40bf;
            text-shadow: 0 0 2px #000;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #bf40bf;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #d8a0ff;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #bf40bf;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #d8a0ff;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #bf40bf;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #d8a0ff;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #d8a0ff;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #bf40bf;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #bf40bf;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #d8a0ff;
            border-color: #d8a0ff;
            box-shadow: 0 0 10px rgba(216, 160, 255, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #bf40bf;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #d8a0ff;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #bf40bf;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #d8a0ff;
            border-color: #d8a0ff;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #301060;
            border: 1px solid #bf40bf;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #d8a0ff;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #440044;
            border: 1px solid #d8a0ff;
            padding: 10px;
            margin: 10px 0;
            color: #d8a0ff;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .victory {
            color: #6f6;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #6f6;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #8ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .vampire-lord {
            color: #f00;
            font-weight: bold;
            text-shadow: 0 0 5px #f00;
            font-size: 18px;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        .ghost {
            color: #8ff;
            font-weight: bold;
            text-shadow: 0 0 3px #8ff;
        }
        
        .maid {
            color: #f9f;
            font-weight: bold;
        }
        
        .bride {
            color: #f66;
            font-weight: bold;
        }
        
        .werewolf {
            color: #a62;
            font-weight: bold;
        }
        
        .hound {
            color: #a86;
            font-weight: bold;
        }
        
        .weapon {
            color: #ff6;
            font-weight: bold;
        }
        
        .armor {
            color: #6cf;
            font-weight: bold;
        }
        
        .room {
            color: #d8a0ff;
            font-weight: bold;
        }
        
        /* Master Quarters Map Display */
        .quarters-map {
            background-color: #301060;
            border: 1px solid #bf40bf;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.8;
            color: #d8a0ff;
        }
        
        .map-row {
            display: flex;
        }
        
        .map-cell {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #502090;
        }
        
        .map-cell.player {
            background-color: #d8a0ff;
            color: #000;
        }
        
        .map-cell.explored {
            background-color: #301060;
        }
        
        .map-cell.unexplored {
            background-color: #110033;
        }
        
        .map-cell.valerius {
            background-color: #f00;
            color: #000;
        }
        
        .map-cell.bedroom {
            background-color: #400080;
        }
        
        .map-cell.vault {
            background-color: #604010;
        }
        
        .map-cell.study {
            background-color: #004040;
        }
        
        .map-cell.observatory {
            background-color: #000080;
        }
        
        .map-cell.library {
            background-color: #804000;
        }
        
        /* Final Battle Animation */
        .final-battle-animation {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #301060;
            border: 1px solid #bf40bf;
            animation: pulse-purple 2s infinite;
        }
        
        @keyframes pulse-purple {
            0% { border-color: #bf40bf; }
            50% { border-color: #d8a0ff; }
            100% { border-color: #bf40bf; }
        }
        
        /* Victory Screen */
        .victory-screen {
            text-align: center;
            padding: 20px;
            background-color: #301060;
            border: 2px solid #d8a0ff;
            margin: 20px 0;
        }
        
        .victory-title {
            color: #ff0;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 24px;
            margin-bottom: 15px;
            text-shadow: 0 0 5px #ff0;
        }
        
        .victory-text {
            color: #fff;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .victory-stats {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background-color: #220044;
            border: 1px solid #bf40bf;
        }
        
        .victory-stat {
            text-align: center;
        }
        
        .victory-stat-label {
            color: #d8a0ff;
            font-size: 14px;
        }
        
        .victory-stat-value {
            color: #ff0;
            font-size: 24px;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #bf40bf;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #bf40bf;
            color: #fff;
            border-color: #d8a0ff;
            box-shadow: 0 0 15px #bf40bf;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #bf40bf;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #bf40bf;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #d8a0ff;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
            
            .victory-title {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CASTLE OF THE UNDEAD</h1>
            <h2>LEVEL 10: THE MASTER QUARTERS</h2>
            <h3>FINAL BATTLE</h3>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number completed">2</div>
            <div class="level-number completed">3</div>
            <div class="level-number completed">4</div>
            <div class="level-number completed">5</div>
            <div class="level-number completed">6</div>
            <div class="level-number completed">7</div>
            <div class="level-number completed">8</div>
            <div class="level-number completed">9</div>
            <div class="level-number current">10</div>
        </div>
        
        <!-- Level Intro Screen -->
        <div id="screen-intro" class="screen active-screen">
            <h2>THE MASTER QUARTERS</h2>
            <div class="story-text">
                <p>You stand at the entrance to Valerius's personal sanctuary - the Master Quarters. Unlike the dungeons below, this place is opulent and extravagant, decorated with gold, velvet, and dark artistry. The air is thick with the scent of aged wine, old books, and ancient magic.</p>
                <p>Somewhere within these lavish chambers, Vampire Lord Valerius awaits. This is where he plans his conquests, stores his most valuable treasures, and rests during the daylight hours. The final confrontation is at hand.</p>
                <p>Your journey through the castle has brought you here. You have faced horrors, solved mysteries, and gathered powerful artifacts. Now it all comes to this final test.</p>
                <p>You push open the heavy oaken door carved with the Vorlak family crest. Beyond lies a grand hall with multiple doors leading to different chambers of the Master Quarters.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="intro-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="intro-stat-health" class="stat-value">0</span>/<span id="intro-stat-maxhealth" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="intro-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="intro-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="startLevel10()">ENTER THE MASTER QUARTERS</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>VALERIUS'S SANCTUARY</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="showMap()">VIEW MAP</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
            </div>
        </div>
        
        <!-- Quarters Map Screen -->
        <div id="screen-map" class="screen">
            <h2>MASTER QUARTERS MAP</h2>
            <div class="story-text">
                <p>As you explore the Master Quarters, you piece together its layout:</p>
                
                <div class="quarters-map" id="quarters-map">
                    <!-- Map will be generated here -->
                </div>
                
                <p><strong>Key:</strong> <span style="color:#d8a0ff">■</span> = Your Position | <span style="color:#f00">■</span> = Valerius | <span style="color:#301060">■</span> = Explored | <span style="color:#110033">■</span> = Unexplored | <span style="color:#400080">■</span> = Master Bedroom | <span style="color:#604010">■</span> = Vault | <span style="color:#004040">■</span> = Study | <span style="color:#000080">■</span> = Observatory | <span style="color:#804000">■</span> = Library</p>
                <p>You've explored <span id="explored-percent">0</span>% of the Master Quarters.</p>
                <p><span class="vampire-lord">Valerius awaits in the Throne Room at the heart of the quarters!</span></p>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="closeMap()">RETURN TO QUARTERS</button>
            </div>
        </div>
        
        <!-- Victory Screen -->
        <div id="screen-victory" class="screen">
            <div class="victory-screen">
                <div class="victory-title">VICTORY!</div>
                <div class="victory-text">
                    <p>YOU HAVE DEFEATED VAMPIRE LORD VALERIUS!</p>
                    <p>With the vampire lord's destruction, his hold over the castle and surrounding lands is broken. The undead servants collapse into dust, and the dark magic sustaining this place begins to dissipate.</p>
                    <p>Sunlight will once again shine upon Castle Vorlak. The people of the nearby villages can live without fear. You have saved the realm from a terrible fate.</p>
                    <p>Your name will be remembered in legends as the hunter who defeated the Vampire Lord Valerius.</p>
                </div>
                
                <div class="victory-stats">
                    <div class="victory-stat">
                        <div class="victory-stat-label">FINAL STRENGTH</div>
                        <div id="victory-stat-strength" class="victory-stat-value">0</div>
                    </div>
                    <div class="victory-stat">
                        <div class="victory-stat-label">FINAL HEALTH</div>
                        <div id="victory-stat-health" class="victory-stat-value">0</div>
                    </div>
                    <div class="victory-stat">
                        <div class="victory-stat-label">FINAL AGILITY</div>
                        <div id="victory-stat-agility" class="victory-stat-value">0</div>
                    </div>
                    <div class="victory-stat">
                        <div class="victory-stat-label">FINAL GOLD</div>
                        <div id="victory-stat-gold" class="victory-stat-value">0</div>
                    </div>
                </div>
                
                <div class="victory-text">
                    <h3>YOUR LEGACY</h3>
                    <p>You finish the game with <span id="victory-total-items">0</span> legendary items in your possession.</p>
                    <p>You defeated <span id="victory-enemies-defeated">0</span> enemies in the Master Quarters alone.</p>
                    <p>You explored <span id="victory-rooms-explored">0</span> of the Master Quarters' chambers.</p>
                    <p><strong>CONGRATULATIONS ON COMPLETING CASTLE OF THE UNDEAD!</strong></p>
                </div>
                
                <div class="next-level">
                    <button class="next-level-btn" onclick="restartGame()">PLAY AGAIN FROM BEGINNING</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE UNDEAD - A Retro Vampire Hunt Adventure<br>
            Level 10: The Master Quarters - FINAL LEVEL
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects for Master Quarters
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'victory':
                    playBeep(523, 0.1, 'sine');
                    setTimeout(() => playBeep(659, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(784, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1047, 0.3, 'sine'), 300);
                    break;
                case 'vampire':
                    playBeep(300, 0.3, 'sawtooth');
                    setTimeout(() => playBeep(250, 0.3, 'sawtooth'), 300);
                    break;
                case 'werewolf':
                    playBeep(150, 0.4, 'square');
                    setTimeout(() => playBeep(100, 0.3, 'square'), 400);
                    break;
                case 'hound':
                    playBeep(500, 0.2, 'square');
                    setTimeout(() => playBeep(400, 0.2, 'square'), 200);
                    break;
                case 'ghost':
                    playBeep(800, 0.5, 'sine');
                    setTimeout(() => playBeep(600, 0.5, 'sine'), 500);
                    break;
                case 'maid':
                    playBeep(600, 0.2, 'triangle');
                    setTimeout(() => playBeep(700, 0.2, 'triangle'), 200);
                    break;
                case 'valerius':
                    playBeep(200, 0.4, 'sawtooth');
                    setTimeout(() => playBeep(150, 0.4, 'sawtooth'), 400);
                    setTimeout(() => playBeep(100, 0.4, 'sawtooth'), 800);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - loaded from Level 9
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Rusty Sword',
            equippedArmor: 'Leather Armor',
            currentSection: 1,
            gameComplete: false,
            level: 10,
            // Level 10 specific flags
            exploredQuarters: [],
            quartersMap: {},
            currentPosition: {x: 2, y: 2},
            valeriusPosition: {x: 8, y: 8},
            valeriusDefeated: false,
            // Rooms explored
            bedroomExplored: false,
            vaultExplored: false,
            studyExplored: false,
            observatoryExplored: false,
            libraryExplored: false,
            // Special items found in Level 10
            hasSunstone: false,
            hasHolySymbol: false,
            hasSilverTippedDagger: false,
            hasVampireSlayerSword: false,
            hasAncientWardArmor: false,
            // NPCs encountered
            metMaid: false,
            maidHelped: false,
            metGhostKnight: false,
            ghostKnightAllied: false,
            // Enemies defeated
            enemiesDefeated: 0,
            brideDefeated: false,
            werewolfDefeated: false,
            houndDefeated: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            isGroup: false,
            groupCount: 0
        };
        
        // Master Quarters map generation
        function generateQuartersMap() {
            const map = [];
            const width = 11;
            const height = 11;
            
            // Initialize empty map
            for (let y = 0; y < height; y++) {
                map[y] = [];
                for (let x = 0; x < width; x++) {
                    map[y][x] = {
                        explored: false,
                        type: 'hallway',
                        connections: []
                    };
                }
            }
            
            // Create main path to Valerius
            let x = 2, y = 2;
            const path = [];
            
            while (x < width - 3 || y < height - 3) {
                path.push({x, y});
                
                if (Math.random() > 0.5 && x < width - 3) {
                    x++;
                } else if (y < height - 3) {
                    y++;
                }
            }
            
            // Add Valerius at end
            gameState.valeriusPosition = {x, y};
            map[y][x].type = 'valerius';
            
            // Add branches to special rooms
            const specialRooms = [
                {x: 4, y: 1, type: 'bedroom', name: 'Master Bedroom'},
                {x: 1, y: 4, type: 'vault', name: 'Vault Room'},
                {x: 7, y: 3, type: 'study', name: 'Study'},
                {x: 3, y: 7, type: 'observatory', name: 'Observatory'},
                {x: 9, y: 5, type: 'library', name: 'Library'}
            ];
            
            specialRooms.forEach(room => {
                if (room.x >= 0 && room.x < width && room.y >= 0 && room.y < height) {
                    map[room.y][room.x].type = room.type;
                    // Connect to nearest path point
                    const nearest = path.reduce((prev, curr) => {
                        const prevDist = Math.abs(prev.x - room.x) + Math.abs(prev.y - room.y);
                        const currDist = Math.abs(curr.x - room.x) + Math.abs(curr.y - room.y);
                        return currDist < prevDist ? curr : prev;
                    });
                    
                    // Create connecting corridor
                    let cx = nearest.x;
                    let cy = nearest.y;
                    
                    while (cx !== room.x || cy !== room.y) {
                        if (cx !== room.x) {
                            cx += cx < room.x ? 1 : -1;
                        } else if (cy !== room.y) {
                            cy += cy < room.y ? 1 : -1;
                        }
                        path.push({x: cx, y: cy});
                    }
                }
            });
            
            // Mark all path cells as hallway
            path.forEach(pos => {
                if (pos.x >= 0 && pos.x < width && pos.y >= 0 && pos.y < height) {
                    if (map[pos.y][pos.x].type === 'hallway') {
                        map[pos.y][pos.x].type = 'hallway';
                    }
                }
            });
            
            gameState.quartersMap = map;
            return map;
        }
        
        // Game story sections for Level 10
        const storySections = {
            1: {
                text: "You stand in the Grand Hall of the Master Quarters. Opulent tapestries depicting the Vorlak family's dark history line the walls. A massive chandelier hangs from the ceiling, its candles flickering with unnatural light. Five ornate doors lead to different chambers, and a grand staircase at the far end ascends to what must be Valerius's throne room.",
                choices: [
                    {text: "Enter the door marked with a crescent moon (Observatory)", nextSection: 2, skillCheck: false},
                    {text: "Enter the door with iron bands (Vault Room)", nextSection: 3, skillCheck: false},
                    {text: "Enter the door with book carvings (Library)", nextSection: 4, skillCheck: false},
                    {text: "Enter the door with velvet curtains (Master Bedroom)", nextSection: 5, skillCheck: false},
                    {text: "Enter the door with quill and scroll carvings (Study)", nextSection: 6, skillCheck: false},
                    {text: "Ascend the grand staircase to confront Valerius", nextSection: 7, skillCheck: false}
                ],
                action: function() {
                    // Record starting position as explored
                    const posKey = `${gameState.currentPosition.x},${gameState.currentPosition.y}`;
                    if (!gameState.exploredQuarters.includes(posKey)) {
                        gameState.exploredQuarters.push(posKey);
                    }
                    
                    return "The air feels charged with dark energy. You can sense Valerius's presence above.";
                }
            },
            2: {
                text: "The Observatory is a circular room with a domed glass ceiling revealing the night sky. Astronomical instruments and star charts are scattered about. In the center stands a telescope pointed at a blood-red moon. A figure in tattered noble clothing stands by the window - a ghostly knight, transparent and shimmering.",
                choices: [
                    {text: "Approach the ghost knight", nextSection: 8, skillCheck: false},
                    {text: "Examine the telescope", nextSection: 9, skillCheck: false},
                    {text: "Search the room for useful items", nextSection: 10, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.observatoryExplored = true;
                    playSound('ghost');
                    return "The ghost knight turns toward you, his spectral armor clinking softly.";
                }
            },
            3: {
                text: "The Vault Room is filled with treasures beyond imagination: chests overflowing with gold, jeweled artifacts, and magical items. However, three hulking werewolf guards stand watch, their eyes glowing with feral intelligence. They growl as you enter.",
                choices: [
                    {text: "Fight the werewolf guards", nextSection: 11, skillCheck: false},
                    {text: "Try to sneak past them", nextSection: 12, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Attempt to bribe them with gold", nextSection: 13, skillCheck: false},
                    {text: "Retreat to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.vaultExplored = true;
                    playSound('werewolf');
                    return "<span class='werewolf'>Werewolf Guards (3)</span> snarl and ready their weapons.";
                }
            },
            4: {
                text: "The Library is vast, with shelves reaching to the ceiling. Ancient tomes line every wall. In the center, a beautiful but pale woman in a blood-red dress reads from a massive book. She looks up with crimson eyes - a vampire bride of Valerius.",
                choices: [
                    {text: "Confront the vampire bride", nextSection: 14, skillCheck: false},
                    {text: "Search for useful books or items", nextSection: 15, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Try to reason with her", nextSection: 16, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.libraryExplored = true;
                    playSound('vampire');
                    return "<span class='bride'>Vampire Bride</span>: 'My lord will be pleased with a new plaything.'";
                }
            },
            5: {
                text: "The Master Bedroom is lavish with a massive four-poster bed draped in black velvet. The room smells of ancient perfume and something darker. A frightened-looking maid in a simple dress is cleaning, but she freezes when she sees you.",
                choices: [
                    {text: "Question the maid", nextSection: 17, skillCheck: false},
                    {text: "Search Valerius's personal belongings", nextSection: 18, skillCheck: false},
                    {text: "Look for hidden compartments", nextSection: 19, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.bedroomExplored = true;
                    playSound('maid');
                    return "<span class='maid'>The maid</span> looks at you with a mixture of fear and hope.";
                }
            },
            6: {
                text: "The Study is filled with maps, scrolls, and battle plans. Valerius's conquest plans are laid out on a large table. Beast hounds - twisted canine creatures with too many eyes - guard the room. They growl and circle you.",
                choices: [
                    {text: "Fight the beast hounds", nextSection: 20, skillCheck: false},
                    {text: "Try to grab plans and run", nextSection: 21, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Use any beast-controlling items you have", nextSection: 22, skillCheck: false, requirement: function() { 
                        return gameState.inventory.some(item => item.includes('Whistle') || item.includes('Meat') || item.includes('Collar'));
                    }},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.studyExplored = true;
                    playSound('hound');
                    return "<span class='hound'>Beast Hounds (2)</span> bare their teeth, drool dripping from their maws.";
                }
            },
            7: {
                text: "You ascend the grand staircase. At the top, massive double doors carved with scenes of vampiric triumph stand before you. From beyond them, you can feel immense dark power. This is it - the final confrontation with Vampire Lord Valerius.",
                choices: [
                    {text: "Kick the doors open dramatically", nextSection: 23, skillCheck: false},
                    {text: "Listen at the doors first", nextSection: 24, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Prepare your items and weapons", nextSection: 25, skillCheck: false},
                    {text: "Return to explore more rooms first", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('valerius');
                    return "A deep, resonant voice echoes from beyond the doors: 'COME... I HAVE BEEN EXPECTING YOU.'";
                }
            },
            8: {
                text: "The ghost knight speaks in a hollow, echoing voice: 'I am Sir Galen, once a knight who opposed Valerius centuries ago. He cursed me to guard this room for eternity. I can aid you if you release me from this torment.'",
                choices: [
                    {text: "Ask how to release him", nextSection: 26, skillCheck: false},
                    {text: "Ask for information about Valerius", nextSection: 27, skillCheck: false},
                    {text: "Attack the ghost (it might be a trick)", nextSection: 28, skillCheck: false},
                    {text: "Return to examining the room", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    gameState.metGhostKnight = true;
                    return "<span class='ghost'>Sir Galen</span>: 'My sword arm still remembers how to fight, if you would have my aid.'";
                }
            },
            9: {
                text: "The telescope is aimed at a blood-red moon. Looking through it, you see celestial alignments that seem to amplify dark magic. Notes nearby mention 'The Crimson Moon Ritual' - Valerius plans to use it to become invincible tonight.",
                choices: [
                    {text: "Destroy the telescope", nextSection: 29, skillCheck: false},
                    {text: "Take the notes about the ritual", nextSection: 30, skillCheck: false},
                    {text: "Talk to the ghost knight", nextSection: 8, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    return "The notes could be valuable for understanding Valerius's plans.";
                }
            },
            10: {
                text: "Searching the Observatory, you find various items among the astronomical instruments.",
                choices: [
                    {text: "Take a celestial compass", nextSection: 31, skillCheck: false},
                    {text: "Take a vial of moonwater", nextSection: 32, skillCheck: false},
                    {text: "Take an ancient star chart", nextSection: 33, skillCheck: false},
                    {text: "Talk to the ghost knight", nextSection: 8, skillCheck: false}
                ],
                action: function() {
                    return "Some of these items might have magical properties.";
                }
            },
            11: {
                text: "The werewolf guards attack! They're fast and strong, their claws and teeth gleaming in the vault's torchlight.",
                choices: [
                    {text: "Fight the werewolves", nextSection: 34, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Werewolf Guards";
                    combatState.enemyHealth = 90;
                    combatState.enemyCurrentHealth = 90;
                    combatState.enemyStrength = 18;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 35;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 3;
                    
                    playSound('werewolf');
                    return "<span class='werewolf'>Werewolf Guards (3)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            12: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 36, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip past the werewolf guards unnoticed! They continue their patrol, unaware of your presence.";
                    } else {
                        // Werewolves notice and attack
                        combatState.active = true;
                        combatState.enemyName = "Alerted Werewolf Guards";
                        combatState.enemyHealth = 85;
                        combatState.enemyCurrentHealth = 85;
                        combatState.enemyStrength = 17;
                        combatState.enemyDamageDice = 3;
                        combatState.enemyDamageSides = 8;
                        combatState.nextSection = 37;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 3;
                        
                        playSound('werewolf');
                        return "The werewolf guards notice you!<br><br><span class='werewolf'>Alerted Werewolf Guards (3)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            13: {
                text: "You offer gold to the werewolf guards. One of them sniffs at your gold pouch, then laughs - a harsh, barking sound. 'Gold means nothing to us. We serve Valerius for the hunt, not coin.'",
                choices: [
                    {text: "Fight the werewolf guards", nextSection: 11, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 12, skillCheck: false},
                    {text: "Retreat to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    return "<span class='werewolf'>Werewolf Guard</span>: 'We want your blood, not your gold!'";
                }
            },
            14: {
                text: "The vampire bride smiles, revealing sharp fangs. 'A living mortal in my library? How... delicious.' She moves with supernatural speed.",
                choices: [
                    {text: "Fight the vampire bride", nextSection: 38, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Vampire Bride";
                    combatState.enemyHealth = 100;
                    combatState.enemyCurrentHealth = 100;
                    combatState.enemyStrength = 20;
                    combatState.enemyDamageDice = 4;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 39;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('vampire');
                    return "<span class='bride'>Vampire Bride</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            15: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 40, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.hasSilverTippedDagger = true;
                        addToInventory('Silver-Tipped Throwing Dagger');
                        return "You find a <span class='weapon'>Silver-Tipped Throwing Dagger</span> hidden in a book! The vampire bride hasn't noticed you yet.";
                    } else {
                        // Bride notices
                        combatState.active = true;
                        combatState.enemyName = "Angered Vampire Bride";
                        combatState.enemyHealth = 95;
                        combatState.enemyCurrentHealth = 95;
                        combatState.enemyStrength = 19;
                        combatState.enemyDamageDice = 4;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 41;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('vampire');
                        return "The vampire bride catches you searching!<br><br><span class='bride'>Angered Vampire Bride</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            16: {
                text: "You try to reason with the vampire bride. 'Valerius's reign ends tonight,' you say. She laughs. 'Foolish mortal. My lord is eternal. I was human once too, you know. He showed me true power.'",
                choices: [
                    {text: "Continue trying to reason", nextSection: 42, skillCheck: false},
                    {text: "Attack her", nextSection: 14, skillCheck: false},
                    {text: "Search for items while talking", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    return "<span class='bride'>Vampire Bride</span>: 'Join us. Become immortal. Or die here tonight.'";
                }
            },
            17: {
                text: "The maid whispers, 'Please, you must help me! Valerius keeps me here against my will. I can tell you about his weaknesses...' She looks around nervously.",
                choices: [
                    {text: "Ask about Valerius's weaknesses", nextSection: 43, skillCheck: false},
                    {text: "Ask about the Master Quarters", nextSection: 44, skillCheck: false},
                    {text: "Offer to help her escape", nextSection: 45, skillCheck: false},
                    {text: "Search the room instead", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    gameState.metMaid = true;
                    return "<span class='maid'>The Maid</span>: 'He has a holy symbol hidden in his study that weakens him. And he fears sunlight above all else.'";
                }
            },
            18: {
                text: "You search Valerius's personal belongings. Among fine clothes and jewelry, you find something interesting.",
                choices: [
                    {text: "Take a signet ring with the Vorlak crest", nextSection: 46, skillCheck: false},
                    {text: "Take a journal detailing his plans", nextSection: 47, skillCheck: false},
                    {text: "Take a small locked chest", nextSection: 48, skillCheck: false},
                    {text: "Talk to the maid", nextSection: 17, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> hidden in a drawer.";
                }
            },
            19: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 49, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.hasAncientWardArmor = true;
                        addToInventory('Ancient Ward Armor');
                        playSound('item');
                        return "You find a hidden compartment behind the headboard! Inside is <span class='armor'>Ancient Ward Armor</span> that provides protection against dark magic.";
                    } else {
                        playSound('failure');
                        return "You search thoroughly but find no hidden compartments.";
                    }
                }
            },
            20: {
                text: "The beast hounds attack! They're fast and vicious, with multiple eyes giving them nearly perfect awareness.",
                choices: [
                    {text: "Fight the beast hounds", nextSection: 50, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Beast Hounds";
                    combatState.enemyHealth = 60;
                    combatState.enemyCurrentHealth = 60;
                    combatState.enemyStrength = 14;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 51;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 2;
                    
                    playSound('hound');
                    return "<span class='hound'>Beast Hounds (2)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            21: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        addToInventory('Valerius Battle Plans');
                        playSound('item');
                        return "You grab the battle plans and retreat before the hounds can react!";
                    } else {
                        // Hounds attack
                        combatState.active = true;
                        combatState.enemyName = "Enraged Beast Hounds";
                        combatState.enemyHealth = 65;
                        combatState.enemyCurrentHealth = 65;
                        combatState.enemyStrength = 15;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 8;
                        combatState.nextSection = 53;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 2;
                        
                        playSound('hound');
                        return "The hounds catch you stealing!<br><br><span class='hound'>Enraged Beast Hounds (2)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            22: {
                text: "You use items to try to control or distract the beast hounds.",
                choices: [
                    {text: "Use Beast Whistle if you have it", nextSection: 54, skillCheck: false, requirement: 'Beast Whistle'},
                    {text: "Use Raw Meat if you have it", nextSection: 55, skillCheck: false, requirement: 'Raw Meat'},
                    {text: "Use Silver Collar if you have it", nextSection: 56, skillCheck: false, requirement: 'Silver Collar'},
                    {text: "Return to other options", nextSection: 6, skillCheck: false}
                ],
                action: function() {
                    return "The hounds watch you warily, sniffing the air.";
                }
            },
            23: {
                text: "You kick the doors open dramatically! They swing inward to reveal a massive throne room. At the far end, on a throne made of bones and dark stone, sits Vampire Lord Valerius. He smiles, revealing sharp fangs.",
                choices: [
                    {text: "Confront Valerius", nextSection: 57, skillCheck: false}
                ],
                action: function() {
                    playSound('valerius');
                    return "<span class='vampire-lord'>Vampire Lord Valerius</span>: 'AT LAST, THE HUNTER ARRIVES. I HAVE WATCHED YOUR PROGRESS WITH GREAT INTEREST.'";
                }
            },
            24: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You hear Valerius speaking to someone: '...the ritual is nearly complete. When the crimson moon reaches its zenith, I will be unstoppable...' This is valuable information!";
                    } else {
                        playSound('failure');
                        return "The doors are too thick. You cannot hear anything.";
                    }
                }
            },
            25: {
                text: "You take a moment to prepare for the final battle. Check your equipment and use any items that might help.",
                choices: [
                    {text: "Use a healing item", nextSection: 59, skillCheck: false},
                    {text: "Equip your best weapon", nextSection: 60, skillCheck: false},
                    {text: "Use any special anti-vampire items", nextSection: 61, skillCheck: false},
                    {text: "Enter the throne room", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    return "This is your last chance to prepare before facing Valerius.";
                }
            },
            26: {
                text: "Sir Galen explains: 'My curse is tied to an amulet hidden in this observatory. Find it and destroy it, and I will be free to aid you against Valerius.'",
                choices: [
                    {text: "Search for the amulet", nextSection: 62, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Ask about Valerius instead", nextSection: 27, skillCheck: false},
                    {text: "Attack the ghost", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    return "<span class='ghost'>Sir Galen</span>: 'The amulet is hidden among the astronomical instruments.'";
                }
            },
            27: {
                text: "Sir Galen shares his knowledge: 'Valerius has three great weaknesses: sunlight, holy symbols, and his own arrogance. He keeps a holy symbol locked away because it weakens him in its presence. Find it before you face him.'",
                choices: [
                    {text: "Ask how to release him", nextSection: 26, skillCheck: false},
                    {text: "Ask for his aid", nextSection: 63, skillCheck: false},
                    {text: "Return to examining the room", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    return "<span class='ghost'>Sir Galen</span>: 'He also fears the sunstone in the vault. It can simulate sunlight.'";
                }
            },
            28: {
                text: "You attack the ghost knight! Your weapon passes through him harmlessly. He shakes his head sadly. 'I am already dead, hunter. You cannot harm me further. But I could have helped you...'",
                choices: [
                    {text: "Apologize and ask for help", nextSection: 26, skillCheck: false},
                    {text: "Leave the observatory", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('ghost');
                    return "<span class='ghost'>Sir Galen</span>: 'Your suspicion is understandable in this place of treachery.'";
                }
            },
            29: {
                text: "You destroy the telescope! Glass shatters and metal bends. The celestial alignment is disrupted.",
                choices: [
                    {text: "Take the ritual notes", nextSection: 30, skillCheck: false},
                    {text: "Talk to the ghost knight", nextSection: 8, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "Valerius's ritual will be more difficult without this instrument.";
                }
            },
            30: {
                text: "You take the notes about the Crimson Moon Ritual. They detail how Valerius plans to use the celestial event to amplify his powers.",
                choices: [
                    {text: "Destroy the telescope", nextSection: 29, skillCheck: false},
                    {text: "Talk to the ghost knight", nextSection: 8, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Crimson Moon Ritual Notes');
                    playSound('item');
                    return "You take the <span class='item'>Crimson Moon Ritual Notes</span>. This knowledge could be useful.";
                }
            },
            31: {
                text: "You take the celestial compass. It glows faintly and points toward sources of dark magic.",
                choices: [
                    {text: "Take the moonwater", nextSection: 32, skillCheck: false},
                    {text: "Take the star chart", nextSection: 33, skillCheck: false},
                    {text: "Talk to the ghost knight", nextSection: 8, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Celestial Compass');
                    playSound('item');
                    return "You take the <span class='item'>Celestial Compass</span>. It might help navigate or detect magic.";
                }
            },
            32: {
                text: "You take the vial of moonwater. It shimmers with captured moonlight.",
                choices: [
                    {text: "Take the celestial compass", nextSection: 31, skillCheck: false},
                    {text: "Take the star chart", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Vial of Moonwater');
                    playSound('item');
                    return "You take the <span class='item'>Vial of Moonwater</span>. Moonlight has power against creatures of darkness.";
                }
            },
            33: {
                text: "You take the ancient star chart. It shows constellations that no longer exist in the night sky.",
                choices: [
                    {text: "Take the celestial compass", nextSection: 31, skillCheck: false},
                    {text: "Take the moonwater", nextSection: 32, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Ancient Star Chart');
                    playSound('item');
                    return "You take the <span class='item'>Ancient Star Chart</span>. It might contain forgotten knowledge.";
                }
            },
            34: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 64, skillCheck: false}
                ]
            },
            35: {
                text: "With the werewolf guards defeated, the vault is yours to explore! Treasure gleams everywhere.",
                choices: [
                    {text: "Search the vault thoroughly", nextSection: 65, skillCheck: false},
                    {text: "Take the most valuable items", nextSection: 66, skillCheck: false},
                    {text: "Look for the sunstone Sir Galen mentioned", nextSection: 67, skillCheck: false}
                ],
                action: function() {
                    gameState.werewolfDefeated = true;
                    gameState.enemiesDefeated += 3;
                    const goldFound = rollDice(20, 50);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the werewolf guards! The vault contains unimaginable wealth. You find <span class='gold'>" + goldFound + " Gold</span> in immediate reach.";
                }
            },
            36: {
                text: "Having slipped past the werewolf guards, you can now explore the vault.",
                choices: [
                    {text: "Search the vault", nextSection: 65, skillCheck: false},
                    {text: "Look for the sunstone", nextSection: 67, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            37: {
                text: "With the alerted werewolf guards defeated, you can explore the vault.",
                choices: [
                    {text: "Search the vault", nextSection: 65, skillCheck: false},
                    {text: "Look for the sunstone", nextSection: 67, skillCheck: false}
                ],
                action: function() {
                    gameState.werewolfDefeated = true;
                    gameState.enemiesDefeated += 3;
                    const goldFound = rollDice(15, 50);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the werewolf guards! You find <span class='gold'>" + goldFound + " Gold</span> nearby.";
                }
            },
            38: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 68, skillCheck: false}
                ]
            },
            39: {
                text: "With the vampire bride defeated, the library is yours to search. She dissolves into dust, leaving behind only her dress and a few items.",
                choices: [
                    {text: "Search the library thoroughly", nextSection: 69, skillCheck: false},
                    {text: "Look for books on vampire weaknesses", nextSection: 70, skillCheck: false},
                    {text: "Take any valuable items", nextSection: 71, skillCheck: false}
                ],
                action: function() {
                    gameState.brideDefeated = true;
                    gameState.enemiesDefeated += 1;
                    const goldFound = rollDice(10, 30);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the vampire bride! She crumbles to dust. You find <span class='gold'>" + goldFound + " Gold</span> and her jewelry.";
                }
            },
            40: {
                text: "After finding the silver dagger, the vampire bride still hasn't noticed you.",
                choices: [
                    {text: "Attack her by surprise", nextSection: 72, skillCheck: false},
                    {text: "Try to leave quietly", nextSection: 73, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Continue searching", nextSection: 74, skillCheck: false}
                ],
                action: function() {
                    return "You have a <span class='weapon'>Silver-Tipped Throwing Dagger</span>. It could give you an advantage.";
                }
            },
            41: {
                text: "With the angered vampire bride defeated, you can search the library.",
                choices: [
                    {text: "Search the library", nextSection: 69, skillCheck: false},
                    {text: "Look for vampire weakness books", nextSection: 70, skillCheck: false}
                ],
                action: function() {
                    gameState.brideDefeated = true;
                    gameState.enemiesDefeated += 1;
                    const goldFound = rollDice(8, 30);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the vampire bride! You find <span class='gold'>" + goldFound + " Gold</span> on her remains.";
                }
            },
            42: {
                text: "You continue trying to reason with the vampire bride. 'There's still humanity in you,' you say. She hesitates, a flicker of her former self showing in her eyes... then it's gone. 'No. That part of me died long ago.' She attacks!",
                choices: [
                    {text: "Defend yourself!", nextSection: 38, skillCheck: false}
                ],
                action: function() {
                    playSound('vampire');
                    return "<span class='bride'>Vampire Bride</span>: 'ENOUGH TALK!'";
                }
            },
            43: {
                text: "The maid whispers: 'Valerius keeps a holy symbol locked in his study - it weakens him. There's also a sunstone in the vault that can create sunlight. And... he sleeps in a coffin in the bedroom during the day. If you could trap him there at sunrise...'",
                choices: [
                    {text: "Ask about the Master Quarters", nextSection: 44, skillCheck: false},
                    {text: "Offer to help her escape", nextSection: 45, skillCheck: false},
                    {text: "Search the room", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    gameState.maidHelped = true;
                    return "<span class='maid'>The Maid</span>: 'Please, if you defeat him, help me escape this place!'";
                }
            },
            44: {
                text: "The maid describes the quarters: 'The vault has his treasures but is guarded by werewolves. The study has his plans and is guarded by beast hounds. The library has his vampire bride. The observatory has a ghost knight - he might help you if you free him.'",
                choices: [
                    {text: "Ask about Valerius's weaknesses", nextSection: 43, skillCheck: false},
                    {text: "Offer to help her escape", nextSection: 45, skillCheck: false},
                    {text: "Search the room", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    return "<span class='maid'>The Maid</span>: 'Be careful in all the rooms. Valerius has traps and guardians everywhere.'";
                }
            },
            45: {
                text: "You offer to help the maid escape. She tears up. 'Thank you! But I can't leave until Valerius is defeated. He'd just find me and kill me. Defeat him first, then I'll escape with you.'",
                choices: [
                    {text: "Ask about Valerius's weaknesses", nextSection: 43, skillCheck: false},
                    {text: "Ask about the Master Quarters", nextSection: 44, skillCheck: false},
                    {text: "Search the room", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    return "<span class='maid'>The Maid</span>: 'I'll hide here until you return. Good luck!'";
                }
            },
            46: {
                text: "You take the Vorlak signet ring. It's heavy and cold, made of dark metal.",
                choices: [
                    {text: "Take the journal", nextSection: 47, skillCheck: false},
                    {text: "Take the locked chest", nextSection: 48, skillCheck: false},
                    {text: "Talk to the maid", nextSection: 17, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Vorlak Signet Ring');
                    playSound('item');
                    return "You take the <span class='item'>Vorlak Signet Ring</span>. It might have authority or magical properties.";
                }
            },
            47: {
                text: "You take Valerius's journal. It details his centuries of conquests and plans for expansion.",
                choices: [
                    {text: "Take the signet ring", nextSection: 46, skillCheck: false},
                    {text: "Take the locked chest", nextSection: 48, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Valerius Journal');
                    playSound('item');
                    return "You take the <span class='item'>Valerius Journal</span>. It contains valuable information about his plans.";
                }
            },
            48: {
                text: "You take the small locked chest. It's heavy for its size.",
                choices: [
                    {text: "Try to open it now", nextSection: 75, skillCheck: true, checkType: 'strength', difficulty: 18},
                    {text: "Take the signet ring", nextSection: 46, skillCheck: false},
                    {text: "Take the journal", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Locked Chest');
                    playSound('item');
                    return "You take the <span class='item'>Locked Chest</span>. You'll need to force it open or find a key.";
                }
            },
            49: {
                text: "After searching for hidden compartments, you return to other options.",
                choices: [
                    {text: "Talk to the maid", nextSection: 17, skillCheck: false},
                    {text: "Search Valerius's belongings", nextSection: 18, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            50: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 76, skillCheck: false}
                ]
            },
            51: {
                text: "With the beast hounds defeated, the study is yours to search. Valerius's battle plans are spread across the table.",
                choices: [
                    {text: "Examine the battle plans", nextSection: 77, skillCheck: false},
                    {text: "Search the study for items", nextSection: 78, skillCheck: false},
                    {text: "Look for the holy symbol the maid mentioned", nextSection: 79, skillCheck: false}
                ],
                action: function() {
                    gameState.houndDefeated = true;
                    gameState.enemiesDefeated += 2;
                    const goldFound = rollDice(5, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the beast hounds! You find <span class='gold'>" + goldFound + " Gold</span> in a desk drawer.";
                }
            },
            52: {
                text: "After grabbing the battle plans, you retreat from the study.",
                choices: [
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false},
                    {text: "Go to another room", nextSection: 80, skillCheck: false}
                ]
            },
            53: {
                text: "With the enraged beast hounds defeated, you can search the study.",
                choices: [
                    {text: "Examine the battle plans", nextSection: 77, skillCheck: false},
                    {text: "Search the study", nextSection: 78, skillCheck: false},
                    {text: "Look for the holy symbol", nextSection: 79, skillCheck: false}
                ],
                action: function() {
                    gameState.houndDefeated = true;
                    gameState.enemiesDefeated += 2;
                    const goldFound = rollDice(4, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the beast hounds! You find <span class='gold'>" + goldFound + " Gold</span> nearby.";
                }
            },
            54: {
                text: "You blow the beast whistle. The hounds cock their heads, confused. They seem less aggressive but still watchful.",
                choices: [
                    {text: "Try to grab plans while they're distracted", nextSection: 21, skillCheck: false},
                    {text: "Search the study", nextSection: 78, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The whistle distracts the hounds! You might be able to move past them.";
                }
            },
            55: {
                text: "You toss the raw meat to the side. The hounds immediately go for it, fighting over the food.",
                choices: [
                    {text: "Grab the battle plans", nextSection: 81, skillCheck: false},
                    {text: "Search the study", nextSection: 78, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Raw Meat');
                    playSound('success');
                    return "The hounds are completely distracted by the meat!";
                }
            },
            56: {
                text: "You show the silver collar. The hounds whimper and back away, recognizing it as a symbol of domination.",
                choices: [
                    {text: "Command the hounds to stand down", nextSection: 82, skillCheck: false},
                    {text: "Search the study", nextSection: 78, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The hounds recognize the collar's authority and become submissive.";
                }
            },
            57: {
                text: "<span class='vampire-lord'>VAMPIRE LORD VALERIUS</span> rises from his throne. He's tall, pale, and aristocratic, with eyes that burn like red coals. Dark energy crackles around him. 'YOU HAVE COME FAR, MORTAL. BUT YOUR JOURNEY ENDS HERE.'",
                choices: [
                    {text: "Attack Valerius", nextSection: 83, skillCheck: false},
                    {text: "Try to reason with him", nextSection: 84, skillCheck: false},
                    {text: "Use a special item against him", nextSection: 85, skillCheck: false},
                    {text: "Retreat and prepare more (if you haven't explored all rooms)", nextSection: 86, skillCheck: false}
                ],
                action: function() {
                    playSound('valerius');
                    return "This is the final battle. All your preparation leads to this moment.";
                }
            },
            58: {
                text: "After listening at the doors, you know Valerius is preparing a ritual. Time is limited.",
                choices: [
                    {text: "Kick the doors open", nextSection: 23, skillCheck: false},
                    {text: "Prepare your items", nextSection: 25, skillCheck: false},
                    {text: "Return to explore more rooms", nextSection: 1, skillCheck: false}
                ]
            },
            59: {
                text: "You use healing items before the final battle.",
                choices: [
                    {text: "Use Healing Potion if you have it", nextSection: 87, skillCheck: false, requirement: function() { 
                        return gameState.inventory.some(item => item.includes('Potion') && !item.includes('Mountain')) || 
                               gameState.inventory.includes('Ancient Vampire Wine') || 
                               gameState.inventory.includes('Vial of Magical Water');
                    }},
                    {text: "Use Mountain Potion if you have it", nextSection: 88, skillCheck: false, requirement: 'Mountain Potion'},
                    {text: "Use other healing items", nextSection: 89, skillCheck: false},
                    {text: "Enter the throne room", nextSection: 23, skillCheck: false}
                ]
            },
            60: {
                text: "You equip your best weapon for the final battle.",
                choices: [
                    {text: "Equip Vampire Slayer Sword if you have it", nextSection: 90, skillCheck: false, requirement: 'Vampire Slayer Sword'},
                    {text: "Equip Silvered Mace if you have it", nextSection: 91, skillCheck: false, requirement: 'Silvered Mace'},
                    {text: "Equip Silver-Tipped Throwing Dagger if you have it", nextSection: 92, skillCheck: false, requirement: 'Silver-Tipped Throwing Dagger'},
                    {text: "Keep current weapon", nextSection: 93, skillCheck: false}
                ]
            },
            61: {
                text: "You prepare special anti-vampire items.",
                choices: [
                    {text: "Use Holy Water if you have it", nextSection: 94, skillCheck: false, requirement: 'Holy Water'},
                    {text: "Use Holy Symbol if you have it", nextSection: 95, skillCheck: false, requirement: function() { 
                        return gameState.hasHolySymbol || gameState.inventory.some(item => item.includes('Holy') && item.includes('Symbol'));
                    }},
                    {text: "Use Sunstone if you have it", nextSection: 96, skillCheck: false, requirement: function() { 
                        return gameState.hasSunstone || gameState.inventory.includes('Sunstone');
                    }},
                    {text: "Use Garlic if you have it", nextSection: 97, skillCheck: false, requirement: 'Garlic'},
                    {text: "Enter the throne room", nextSection: 23, skillCheck: false}
                ]
            },
            62: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 98, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.ghostKnightAllied = true;
                        playSound('success');
                        return "You find the amulet hidden in a hollow leg of the telescope! You destroy it, and Sir Galen's form becomes more solid. 'Thank you, hunter. I will fight by your side against Valerius.'";
                    } else {
                        playSound('failure');
                        return "You cannot find the amulet. It must be well hidden.";
                    }
                }
            },
            63: {
                text: "You ask Sir Galen for his aid. 'I will fight with you when you face Valerius,' he says. 'But first, free me from my curse by finding and destroying the amulet.'",
                choices: [
                    {text: "Search for the amulet", nextSection: 62, skillCheck: false},
                    {text: "Ask about Valerius's weaknesses", nextSection: 27, skillCheck: false}
                ]
            },
            64: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 34, skillCheck: false}
                ]
            },
            65: {
                text: "You search the vault thoroughly. It contains mountains of gold, jewels, artifacts, and magical items.",
                choices: [
                    {text: "Take as much gold as you can carry", nextSection: 99, skillCheck: false},
                    {text: "Look for magical weapons or armor", nextSection: 100, skillCheck: false},
                    {text: "Look for the sunstone", nextSection: 67, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(10, 100);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> in easily accessible chests.";
                }
            },
            66: {
                text: "You take the most valuable-looking items from the vault.",
                choices: [
                    {text: "Take a jeweled crown", nextSection: 101, skillCheck: false},
                    {text: "Take a magical artifact", nextSection: 102, skillCheck: false},
                    {text: "Take a chest of gems", nextSection: 103, skillCheck: false},
                    {text: "Look for the sunstone", nextSection: 67, skillCheck: false}
                ]
            },
            67: {
                text: "You search specifically for the sunstone Sir Galen and the maid mentioned. After careful looking, you find it in a lead-lined box.",
                choices: [
                    {text: "Take the sunstone", nextSection: 104, skillCheck: false},
                    {text: "Search for other items", nextSection: 65, skillCheck: false}
                ],
                action: function() {
                    gameState.hasSunstone = true;
                    addToInventory('Sunstone');
                    playSound('item');
                    return "You find the <span class='item'>Sunstone</span>! When activated, it creates sunlight that will weaken Valerius.";
                }
            },
            68: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 38, skillCheck: false}
                ]
            },
            69: {
                text: "You search the library thoroughly. It contains thousands of books on dark magic, history, and vampire lore.",
                choices: [
                    {text: "Look for books on vampire weaknesses", nextSection: 70, skillCheck: false},
                    {text: "Take valuable books", nextSection: 105, skillCheck: false},
                    {text: "Search for hidden items", nextSection: 106, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            70: {
                text: "You find a book titled 'Vanquishing the Vampire: A Hunter's Guide'. It contains valuable information.",
                choices: [
                    {text: "Take the book", nextSection: 107, skillCheck: false},
                    {text: "Search for other items", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Vampire Hunter Guide');
                    playSound('item');
                    return "You find the <span class='item'>Vampire Hunter Guide</span>. It could provide advantages against Valerius.";
                }
            },
            71: {
                text: "You take valuable items from the vampire bride's remains and the library.",
                choices: [
                    {text: "Take her jewelry", nextSection: 108, skillCheck: false},
                    {text: "Take rare books", nextSection: 105, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 50);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You take valuable items worth <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            72: {
                text: "You attack the vampire bride by surprise with the silver-tipped dagger! It strikes true, and she screams in pain.",
                choices: [
                    {text: "Continue the attack", nextSection: 109, skillCheck: false}
                ],
                action: function() {
                    // Surprise round advantage
                    const surpriseDamage = rollDice(4, 6) + 10; // Silver weapon bonus
                    
                    combatState.active = true;
                    combatState.enemyName = "Wounded Vampire Bride";
                    combatState.enemyHealth = 100 - surpriseDamage;
                    combatState.enemyCurrentHealth = 100 - surpriseDamage;
                    combatState.enemyStrength = 18; // Lower due to surprise and silver wound
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 110;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('combat');
                    return "Your silver-tipped dagger strikes for " + surpriseDamage + " damage!<br><br><span class='bride'>Wounded Vampire Bride</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            73: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 111, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip out of the library quietly, the silver-tipped dagger in hand. The vampire bride continues reading, unaware.";
                    } else {
                        // Bride notices
                        combatState.active = true;
                        combatState.enemyName = "Vampire Bride Discovering You";
                        combatState.enemyHealth = 95;
                        combatState.enemyCurrentHealth = 95;
                        combatState.enemyStrength = 19;
                        combatState.enemyDamageDice = 4;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 112;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('vampire');
                        return "The vampire bride notices you leaving!<br><br><span class='bride'>Vampire Bride Discovering You</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            74: {
                text: "You continue searching the library while the vampire bride is distracted.",
                choices: [
                    {text: "Look for books on vampire weaknesses", nextSection: 70, skillCheck: false},
                    {text: "Search for hidden items", nextSection: 106, skillCheck: false},
                    {text: "Attack her by surprise", nextSection: 72, skillCheck: false}
                ]
            },
            75: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 113, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.hasVampireSlayerSword = true;
                        addToInventory('Vampire Slayer Sword');
                        removeFromInventory('Locked Chest');
                        playSound('item');
                        return "You force the chest open! Inside is a magnificent <span class='weapon'>Vampire Slayer Sword</span> - a silver blade inscribed with holy symbols. This is a legendary weapon against vampires!";
                    } else {
                        playSound('failure');
                        return "The chest is too sturdy. You cannot open it without a key or better tools.";
                    }
                }
            },
            76: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 50, skillCheck: false}
                ]
            },
            77: {
                text: "You examine Valerius's battle plans. They detail invasions of neighboring kingdoms, creation of new vampire spawn, and dark rituals to extend his power.",
                choices: [
                    {text: "Take the plans", nextSection: 114, skillCheck: false},
                    {text: "Search the study for items", nextSection: 78, skillCheck: false},
                    {text: "Look for the holy symbol", nextSection: 79, skillCheck: false}
                ],
                action: function() {
                    return "The plans show Valerius intends to conquer the entire continent within a decade.";
                }
            },
            78: {
                text: "You search the study for items. In addition to the battle plans, you find various useful things.",
                choices: [
                    {text: "Take a magnifying glass", nextSection: 115, skillCheck: false},
                    {text: "Take ink and quills", nextSection: 116, skillCheck: false},
                    {text: "Take a map of the castle", nextSection: 117, skillCheck: false},
                    {text: "Examine the battle plans", nextSection: 77, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> in a desk.";
                }
            },
            79: {
                text: "You search for the holy symbol the maid mentioned. After checking several hiding spots, you find it in a secret compartment in the desk.",
                choices: [
                    {text: "Take the holy symbol", nextSection: 118, skillCheck: false},
                    {text: "Examine the battle plans", nextSection: 77, skillCheck: false},
                    {text: "Search for other items", nextSection: 78, skillCheck: false}
                ],
                action: function() {
                    gameState.hasHolySymbol = true;
                    addToInventory('Holy Symbol of Light');
                    playSound('item');
                    return "You find the <span class='item'>Holy Symbol of Light</span>! Its presence weakens vampires and other dark creatures.";
                }
            },
            80: {
                text: "With the battle plans in hand, you decide which room to explore next.",
                choices: [
                    {text: "Go to the Observatory", nextSection: 2, skillCheck: false},
                    {text: "Go to the Vault Room", nextSection: 3, skillCheck: false},
                    {text: "Go to the Library", nextSection: 4, skillCheck: false},
                    {text: "Go to the Master Bedroom", nextSection: 5, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            81: {
                text: "While the hounds are distracted by the meat, you grab the battle plans.",
                choices: [
                    {text: "Search the study", nextSection: 78, skillCheck: false},
                    {text: "Look for the holy symbol", nextSection: 79, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Valerius Battle Plans');
                    playSound('item');
                    return "You successfully take the <span class='item'>Valerius Battle Plans</span> while the hounds eat.";
                }
            },
            82: {
                text: "You command the hounds to stand down using the authority of the silver collar. They whimper and lie down, submitting to you.",
                choices: [
                    {text: "Examine the battle plans", nextSection: 77, skillCheck: false},
                    {text: "Search the study", nextSection: 78, skillCheck: false},
                    {text: "Look for the holy symbol", nextSection: 79, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The hounds obey your command! They will not attack you.";
                }
            },
            83: {
                text: "You charge at Valerius! He laughs and meets your attack with supernatural speed. Dark energy crackles around him as he prepares to fight.",
                choices: [
                    {text: "Fight Valerius", nextSection: 119, skillCheck: false}
                ],
                action: function() {
                    // Final boss combat
                    combatState.active = true;
                    combatState.enemyName = "Vampire Lord Valerius";
                    combatState.enemyHealth = 200;
                    combatState.enemyCurrentHealth = 200;
                    combatState.enemyStrength = 25;
                    combatState.enemyDamageDice = 5;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 120;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('valerius');
                    return "<span class='vampire-lord'>Vampire Lord Valerius</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            84: {
                text: "You try to reason with Valerius. 'Your reign of terror ends tonight!' you declare. He laughs. 'FOOLISH MORTAL. I HAVE LIVED FOR CENTURIES. I HAVE SEEN EMPIRES RISE AND FALL. YOU ARE BUT A MOMENT IN TIME.'",
                choices: [
                    {text: "Attack him", nextSection: 83, skillCheck: false},
                    {text: "Use a special item", nextSection: 85, skillCheck: false},
                    {text: "Continue talking", nextSection: 121, skillCheck: false}
                ],
                action: function() {
                    return "<span class='vampire-lord'>Valerius</span>: 'JOIN ME, AND I WILL GRANT YOU ETERNAL LIFE. FIGHT ME, AND I WILL GRANT YOU ETERNAL TORMENT.'";
                }
            },
            85: {
                text: "You prepare to use a special item against Valerius.",
                choices: [
                    {text: "Use Holy Water", nextSection: 122, skillCheck: false, requirement: 'Holy Water'},
                    {text: "Use Holy Symbol", nextSection: 123, skillCheck: false, requirement: function() { 
                        return gameState.hasHolySymbol || gameState.inventory.some(item => item.includes('Holy') && item.includes('Symbol'));
                    }},
                    {text: "Use Sunstone", nextSection: 124, skillCheck: false, requirement: function() { 
                        return gameState.hasSunstone || gameState.inventory.includes('Sunstone');
                    }},
                    {text: "Use Silver-Tipped Throwing Dagger", nextSection: 125, skillCheck: false, requirement: 'Silver-Tipped Throwing Dagger'},
                    {text: "Use Garlic", nextSection: 126, skillCheck: false, requirement: 'Garlic'},
                    {text: "Attack normally", nextSection: 83, skillCheck: false}
                ]
            },
            86: {
                text: "You decide you're not fully prepared and retreat to explore more rooms first.",
                choices: [
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('click');
                    return "Wisdom sometimes means knowing when you need more preparation.";
                }
            },
            87: {
                text: "You use a healing potion before the final battle.",
                choices: [
                    {text: "Use another healing item", nextSection: 89, skillCheck: false},
                    {text: "Equip your best weapon", nextSection: 60, skillCheck: false},
                    {text: "Use anti-vampire items", nextSection: 61, skillCheck: false},
                    {text: "Enter the throne room", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    // Find and use first healing potion
                    const potions = gameState.inventory.filter(item => 
                        (item.includes('Potion') && !item.includes('Mountain')) || 
                        item.includes('Ancient Vampire Wine') || 
                        item.includes('Vial of Magical Water')
                    );
                    
                    if (potions.length > 0) {
                        const potion = potions[0];
                        let healAmount;
                        
                        if (potion.includes('Mountain')) {
                            healAmount = rollDice(3, 6) + 10;
                        } else if (potion.includes('Ancient Vampire Wine')) {
                            healAmount = rollDice(2, 8) + 5;
                        } else if (potion.includes('Magical Water')) {
                            healAmount = rollDice(2, 6);
                        } else {
                            healAmount = rollDice(2, 6) + 5;
                        }
                        
                        const oldHealth = gameState.health;
                        gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                        const actualHeal = gameState.health - oldHealth;
                        removeFromInventory(potion);
                        updateStatsDisplay();
                        playSound('item');
                        
                        return `You use the <span class='item'>${potion}</span> and restore ${actualHeal} Health!`;
                    }
                    
                    return "You don't have any healing potions.";
                }
            },
            88: {
                text: "You use the Mountain Potion - the most powerful healing item.",
                choices: [
                    {text: "Use other healing items", nextSection: 89, skillCheck: false},
                    {text: "Equip your best weapon", nextSection: 60, skillCheck: false},
                    {text: "Enter the throne room", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(3, 6) + 10;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    removeFromInventory('Mountain Potion');
                    updateStatsDisplay();
                    playSound('item');
                    
                    return `You use the <span class='item'>Mountain Potion</span> and restore ${actualHeal} Health!`;
                }
            },
            89: {
                text: "You use other healing items you might have.",
                choices: [
                    {text: "Use Healing Potion", nextSection: 87, skillCheck: false},
                    {text: "Use Mountain Potion", nextSection: 88, skillCheck: false},
                    {text: "Equip your best weapon", nextSection: 60, skillCheck: false},
                    {text: "Enter the throne room", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    // Check for any healing items
                    const healingItems = gameState.inventory.filter(item => 
                        item.includes('Potion') || 
                        item.includes('Vial') || 
                        item.includes('Wine')
                    );
                    
                    if (healingItems.length > 0) {
                        return "Select a specific healing item to use.";
                    } else {
                        return "You don't have any healing items.";
                    }
                }
            },
            90: {
                text: "You equip the Vampire Slayer Sword - the ultimate weapon against vampires.",
                choices: [
                    {text: "Use healing items", nextSection: 59, skillCheck: false},
                    {text: "Use anti-vampire items", nextSection: 61, skillCheck: false},
                    {text: "Enter the throne room", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    gameState.equippedWeapon = 'Vampire Slayer Sword';
                    updateInventoryDisplay();
                    playSound('item');
                    return "You equip the <span class='weapon'>Vampire Slayer Sword</span>. This legendary weapon is especially effective against vampires!";
                }
            },
            91: {
                text: "You equip the Silvered Mace - effective against undead.",
                choices: [
                    {text: "Use healing items", nextSection: 59, skillCheck: false},
                    {text: "Enter the throne room", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    gameState.equippedWeapon = 'Silvered Mace';
                    updateInventoryDisplay();
                    playSound('item');
                    return "You equip the <span class='weapon'>Silvered Mace</span>. Silver weapons are effective against vampires and werewolves.";
                }
            },
            92: {
                text: "You prepare the Silver-Tipped Throwing Dagger for use.",
                choices: [
                    {text: "Use healing items", nextSection: 59, skillCheck: false},
                    {text: "Enter the throne room", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "You prepare the <span class='weapon'>Silver-Tipped Throwing Dagger</span>. You can throw it during combat for a ranged silver attack.";
                }
            },
            93: {
                text: "You keep your current weapon equipped.",
                choices: [
                    {text: "Use healing items", nextSection: 59, skillCheck: false},
                    {text: "Enter the throne room", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    return `You keep your <span class='weapon'>${gameState.equippedWeapon}</span> equipped.`;
                }
            },
            94: {
                text: "You prepare Holy Water to use against Valerius.",
                choices: [
                    {text: "Use other anti-vampire items", nextSection: 61, skillCheck: false},
                    {text: "Enter the throne room", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "You prepare <span class='item'>Holy Water</span>. It will burn Valerius on contact.";
                }
            },
            95: {
                text: "You prepare the Holy Symbol to use against Valerius.",
                choices: [
                    {text: "Use other anti-vampire items", nextSection: 61, skillCheck: false},
                    {text: "Enter the throne room", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "You prepare the <span class='item'>Holy Symbol</span>. Its presence weakens vampires.";
                }
            },
            96: {
                text: "You prepare the Sunstone to use against Valerius.",
                choices: [
                    {text: "Use other anti-vampire items", nextSection: 61, skillCheck: false},
                    {text: "Enter the throne room", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "You prepare the <span class='item'>Sunstone</span>. When activated, it creates sunlight that will severely weaken Valerius.";
                }
            },
            97: {
                text: "You prepare Garlic to use against Valerius.",
                choices: [
                    {text: "Use other anti-vampire items", nextSection: 61, skillCheck: false},
                    {text: "Enter the throne room", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "You prepare <span class='item'>Garlic</span>. Vampires are repelled by its scent.";
                }
            },
            98: {
                text: "After your attempt to find the amulet, Sir Galen looks at you expectantly.",
                choices: [
                    {text: "Try searching again", nextSection: 62, skillCheck: false},
                    {text: "Ask about Valerius", nextSection: 27, skillCheck: false},
                    {text: "Leave the observatory", nextSection: 1, skillCheck: false}
                ]
            },
            99: {
                text: "You take as much gold as you can carry from the vault.",
                choices: [
                    {text: "Look for magical items", nextSection: 100, skillCheck: false},
                    {text: "Look for the sunstone", nextSection: 67, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(50, 100);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You take <span class='gold'>" + goldFound + " Gold</span>! You're now incredibly wealthy.";
                }
            },
            100: {
                text: "You look for magical weapons or armor in the vault.",
                choices: [
                    {text: "Take a glowing sword", nextSection: 127, skillCheck: false},
                    {text: "Take enchanted armor", nextSection: 128, skillCheck: false},
                    {text: "Take a magical amulet", nextSection: 129, skillCheck: false},
                    {text: "Take gold instead", nextSection: 99, skillCheck: false}
                ]
            },
            101: {
                text: "You take the jeweled crown. It's heavy with gems and radiates subtle magic.",
                choices: [
                    {text: "Take a magical artifact", nextSection: 102, skillCheck: false},
                    {text: "Take a chest of gems", nextSection: 103, skillCheck: false},
                    {text: "Look for the sunstone", nextSection: 67, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Jeweled Crown');
                    const goldValue = rollDice(10, 50);
                    gameState.gold += goldValue;
                    updateStatsDisplay();
                    playSound('item');
                    return "You take the <span class='item'>Jeweled Crown</span> worth <span class='gold'>" + goldValue + " Gold</span>.";
                }
            },
            102: {
                text: "You take a magical artifact - a crystal orb that shows glimpses of the future.",
                choices: [
                    {text: "Take the jeweled crown", nextSection: 101, skillCheck: false},
                    {text: "Take a chest of gems", nextSection: 103, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Crystal Orb of Vision');
                    playSound('item');
                    return "You take the <span class='item'>Crystal Orb of Vision</span>. It might provide insights.";
                }
            },
            103: {
                text: "You take a chest filled with precious gems.",
                choices: [
                    {text: "Take the jeweled crown", nextSection: 101, skillCheck: false},
                    {text: "Take a magical artifact", nextSection: 102, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Chest of Gems');
                    const goldValue = rollDice(20, 100);
                    gameState.gold += goldValue;
                    updateStatsDisplay();
                    playSound('item');
                    return "You take a <span class='item'>Chest of Gems</span> worth <span class='gold'>" + goldValue + " Gold</span>.";
                }
            },
            104: {
                text: "With the sunstone in hand, you consider what to do next in the vault.",
                choices: [
                    {text: "Take gold", nextSection: 99, skillCheck: false},
                    {text: "Look for magical items", nextSection: 100, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            105: {
                text: "You take rare and valuable books from the library.",
                choices: [
                    {text: "Look for books on vampire weaknesses", nextSection: 70, skillCheck: false},
                    {text: "Search for hidden items", nextSection: 106, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Rare Books');
                    const goldValue = rollDice(5, 30);
                    gameState.gold += goldValue;
                    updateStatsDisplay();
                    playSound('item');
                    return "You take <span class='item'>Rare Books</span> worth <span class='gold'>" + goldValue + " Gold</span> to scholars.";
                }
            },
            106: {
                text: "You search for hidden items in the library. Behind a false book, you find a small compartment.",
                choices: [
                    {text: "Open the compartment", nextSection: 130, skillCheck: false},
                    {text: "Look for books on vampire weaknesses", nextSection: 70, skillCheck: false},
                    {text: "Take valuable books", nextSection: 105, skillCheck: false}
                ]
            },
            107: {
                text: "With the Vampire Hunter Guide, you feel more prepared to face Valerius.",
                choices: [
                    {text: "Search for other items", nextSection: 69, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            108: {
                text: "You take the vampire bride's jewelry. It's exquisite but feels tainted.",
                choices: [
                    {text: "Take rare books", nextSection: 105, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Vampire Bride Jewelry');
                    const goldValue = rollDice(8, 40);
                    gameState.gold += goldValue;
                    updateStatsDisplay();
                    playSound('item');
                    return "You take <span class='item'>Vampire Bride Jewelry</span> worth <span class='gold'>" + goldValue + " Gold</span>.";
                }
            },
            109: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 131, skillCheck: false}
                ]
            },
            110: {
                text: "With the wounded vampire bride defeated, you can search the library.",
                choices: [
                    {text: "Search the library", nextSection: 69, skillCheck: false},
                    {text: "Look for books on vampire weaknesses", nextSection: 70, skillCheck: false}
                ],
                action: function() {
                    gameState.brideDefeated = true;
                    gameState.enemiesDefeated += 1;
                    const goldFound = rollDice(12, 30);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the vampire bride! Your silver-tipped dagger was especially effective. You find <span class='gold'>" + goldFound + " Gold</span> and other valuables.";
                }
            },
            111: {
                text: "Having slipped out of the library, you return to the Grand Hall with the silver-tipped dagger.",
                choices: [
                    {text: "Go to another room", nextSection: 80, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            112: {
                text: "With the vampire bride defeated after she discovered you, you can search the library.",
                choices: [
                    {text: "Search the library", nextSection: 69, skillCheck: false},
                    {text: "Look for books on vampire weaknesses", nextSection: 70, skillCheck: false}
                ],
                action: function() {
                    gameState.brideDefeated = true;
                    gameState.enemiesDefeated += 1;
                    const goldFound = rollDice(6, 30);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the vampire bride! You find <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            113: {
                text: "After trying to open the locked chest, you consider other options.",
                choices: [
                    {text: "Take the signet ring", nextSection: 46, skillCheck: false},
                    {text: "Take the journal", nextSection: 47, skillCheck: false},
                    {text: "Talk to the maid", nextSection: 17, skillCheck: false}
                ]
            },
            114: {
                text: "You take Valerius's battle plans. They could be valuable to the kingdoms he planned to invade.",
                choices: [
                    {text: "Search the study for items", nextSection: 78, skillCheck: false},
                    {text: "Look for the holy symbol", nextSection: 79, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Valerius Battle Plans');
                    playSound('item');
                    return "You take the <span class='item'>Valerius Battle Plans</span>. They could prevent future wars.";
                }
            },
            115: {
                text: "You take a magnifying glass. It might help examine details.",
                choices: [
                    {text: "Take ink and quills", nextSection: 116, skillCheck: false},
                    {text: "Take a map of the castle", nextSection: 117, skillCheck: false},
                    {text: "Examine the battle plans", nextSection: 77, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Magnifying Glass');
                    playSound('item');
                    return "You take a <span class='item'>Magnifying Glass</span>. It could be useful for examining small details.";
                }
            },
            116: {
                text: "You take ink and quills. They're high quality but not particularly valuable.",
                choices: [
                    {text: "Take a magnifying glass", nextSection: 115, skillCheck: false},
                    {text: "Take a map of the castle", nextSection: 117, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Ink and Quills');
                    playSound('item');
                    return "You take <span class='item'>Ink and Quills</span>. They might be useful for documentation.";
                }
            },
            117: {
                text: "You take a detailed map of Castle Vorlak. It shows all levels and secret passages.",
                choices: [
                    {text: "Take a magnifying glass", nextSection: 115, skillCheck: false},
                    {text: "Take ink and quills", nextSection: 116, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Castle Vorlak Map');
                    playSound('item');
                    return "You take a <span class='item'>Castle Vorlak Map</span>. It shows the entire layout of the castle.";
                }
            },
            118: {
                text: "With the holy symbol in hand, you feel its protective power.",
                choices: [
                    {text: "Examine the battle plans", nextSection: 77, skillCheck: false},
                    {text: "Search for other items", nextSection: 78, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            119: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 132, skillCheck: false}
                ]
            },
            120: {
                text: "WITH VALERIUS DEFEATED! The vampire lord screams as he dissolves into dust and ash. His dark energy dissipates, and the castle shakes as his power is broken.",
                choices: [
                    {text: "Claim your victory", nextSection: 133, skillCheck: false}
                ],
                action: function() {
                    gameState.valeriusDefeated = true;
                    gameState.enemiesDefeated += 1;
                    gameState.gameComplete = true;
                    
                    // Show victory screen
                    showScreen('screen-victory');
                    
                    // Update victory stats
                    document.getElementById('victory-stat-strength').textContent = gameState.strength;
                    document.getElementById('victory-stat-health').textContent = gameState.health;
                    document.getElementById('victory-stat-agility').textContent = gameState.agility;
                    document.getElementById('victory-stat-gold').textContent = gameState.gold;
                    
                    // Count total items
                    const totalItems = gameState.inventory.length + 2; // +2 for equipped items
                    document.getElementById('victory-total-items').textContent = totalItems;
                    
                    // Count enemies defeated in Master Quarters
                    document.getElementById('victory-enemies-defeated').textContent = gameState.enemiesDefeated;
                    
                    // Count rooms explored
                    let roomsExplored = 0;
                    if (gameState.bedroomExplored) roomsExplored++;
                    if (gameState.vaultExplored) roomsExplored++;
                    if (gameState.studyExplored) roomsExplored++;
                    if (gameState.observatoryExplored) roomsExplored++;
                    if (gameState.libraryExplored) roomsExplored++;
                    document.getElementById('victory-rooms-explored').textContent = roomsExplored;
                    
                    playSound('victory');
                    
                    // Clear saved game since we've completed it
                    localStorage.removeItem('castleUndeadGameState');
                    
                    return "";
                }
            },
            121: {
                text: "You continue talking to Valerius. 'Your evil ends tonight. The people you've terrorized will be free.' He scoffs. 'THEY WILL FIND NEW MASTERS. MORTALITY IS WEAKNESS. I OFFERED YOU POWER, AND YOU REFUSE. SO BE IT.'",
                choices: [
                    {text: "Attack him", nextSection: 83, skillCheck: false},
                    {text: "Use a special item", nextSection: 85, skillCheck: false}
                ],
                action: function() {
                    return "<span class='vampire-lord'>Valerius</span>: 'LET US END THIS CHARADE. COME, MORTAL. SHOW ME YOUR STRENGTH.'";
                }
            },
            122: {
                text: "You throw Holy Water at Valerius! It sizzles against his skin, and he screams in pain. 'HOLY WATER! YOU DARE!'",
                choices: [
                    {text: "Attack while he's weakened", nextSection: 134, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Holy Water');
                    playSound('item');
                    return "The Holy Water burns Valerius, weakening him significantly!";
                }
            },
            123: {
                text: "You brandish the Holy Symbol! Valerius hisses and steps back, his power visibly diminishing. 'THAT... THAT SYMBOL! HOW DID YOU FIND IT?'",
                choices: [
                    {text: "Attack while he's weakened", nextSection: 135, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The Holy Symbol weakens Valerius! His dark aura fades slightly.";
                }
            },
            124: {
                text: "You activate the Sunstone! It glows with brilliant light that mimics sunlight. Valerius screams and covers his eyes, smoke rising from his skin. 'THE SUN! IMPOSSIBLE!'",
                choices: [
                    {text: "Attack while he's severely weakened", nextSection: 136, skillCheck: false}
                ],
                action: function() {
                    if (gameState.hasSunstone) {
                        removeFromInventory('Sunstone');
                        gameState.hasSunstone = false;
                    }
                    playSound('item');
                    return "The Sunstone creates sunlight in the throne room! Valerius is severely weakened!";
                }
            },
            125: {
                text: "You throw the Silver-Tipped Dagger at Valerius! It strikes him in the shoulder, and he roars in pain. Silver is toxic to vampires.",
                choices: [
                    {text: "Attack while he's wounded", nextSection: 137, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Silver-Tipped Throwing Dagger');
                    gameState.hasSilverTippedDagger = false;
                    playSound('item');
                    return "The Silver-Tipped Dagger wounds Valerius! The silver burns his vampiric flesh.";
                }
            },
            126: {
                text: "You throw Garlic at Valerius! He recoils in disgust. 'FILTHY HERB! YOU MOCK ME WITH PEASANT SUPERSTITIONS!'",
                choices: [
                    {text: "Attack while he's distracted", nextSection: 138, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Garlic');
                    playSound('item');
                    return "The Garlic repels Valerius! He's distracted and disgusted.";
                }
            },
            127: {
                text: "You take the glowing sword. It hums with magical energy.",
                choices: [
                    {text: "Take enchanted armor", nextSection: 128, skillCheck: false},
                    {text: "Take a magical amulet", nextSection: 129, skillCheck: false},
                    {text: "Take gold instead", nextSection: 99, skillCheck: false}
                ],
                action: function() {
                    gameState.equippedWeapon = 'Glowing Magic Sword';
                    updateInventoryDisplay();
                    playSound('item');
                    return "You take and equip the <span class='weapon'>Glowing Magic Sword</span>! It's a powerful magical weapon.";
                }
            },
            128: {
                text: "You take the enchanted armor. It's lighter than it looks and radiates protective magic.",
                choices: [
                    {text: "Take the glowing sword", nextSection: 127, skillCheck: false},
                    {text: "Take a magical amulet", nextSection: 129, skillCheck: false}
                ],
                action: function() {
                    gameState.equippedArmor = 'Enchanted Plate Armor';
                    updateInventoryDisplay();
                    playSound('item');
                    return "You take and equip the <span class='armor'>Enchanted Plate Armor</span>! It offers excellent protection.";
                }
            },
            129: {
                text: "You take the magical amulet. It feels warm and protective.",
                choices: [
                    {text: "Take the glowing sword", nextSection: 127, skillCheck: false},
                    {text: "Take enchanted armor", nextSection: 128, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Magical Protection Amulet');
                    playSound('item');
                    return "You take the <span class='item'>Magical Protection Amulet</span>. It offers protection against magic.";
                }
            },
            130: {
                text: "You open the hidden compartment. Inside is a small, ancient book bound in pale leather.",
                choices: [
                    {text: "Take the book", nextSection: 139, skillCheck: false},
                    {text: "Look for books on vampire weaknesses", nextSection: 70, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Ancient Vampire Tome');
                    playSound('item');
                    return "You find an <span class='item'>Ancient Vampire Tome</span>. It contains forgotten vampire lore.";
                }
            },
            131: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 109, skillCheck: false}
                ]
            },
            132: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 119, skillCheck: false}
                ]
            },
            133: {
                text: "VAMPIRE LORD VALERIUS IS DEFEATED! With his destruction, the castle begins to crumble. The dark magic sustaining it dissipates. You have won!",
                choices: [],
                action: function() {
                    // Handled in section 120
                    return "";
                }
            },
            134: {
                text: "You attack Valerius while he's weakened by Holy Water!",
                choices: [
                    {text: "Fight the weakened Valerius", nextSection: 140, skillCheck: false}
                ],
                action: function() {
                    // Weakened Valerius stats
                    combatState.active = true;
                    combatState.enemyName = "Weakened Valerius (Holy Water)";
                    combatState.enemyHealth = 160; // Reduced from 200
                    combatState.enemyCurrentHealth = 160;
                    combatState.enemyStrength = 22; // Reduced from 25
                    combatState.enemyDamageDice = 4; // Reduced from 5
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 120;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('valerius');
                    return "<span class='vampire-lord'>Weakened Valerius</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            135: {
                text: "You attack Valerius while he's weakened by the Holy Symbol!",
                choices: [
                    {text: "Fight the weakened Valerius", nextSection: 141, skillCheck: false}
                ],
                action: function() {
                    // Weakened Valerius stats
                    combatState.active = true;
                    combatState.enemyName = "Weakened Valerius (Holy Symbol)";
                    combatState.enemyHealth = 170; // Reduced from 200
                    combatState.enemyCurrentHealth = 170;
                    combatState.enemyStrength = 23; // Reduced from 25
                    combatState.enemyDamageDice = 4; // Reduced from 5
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 120;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('valerius');
                    return "<span class='vampire-lord'>Weakened Valerius</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            136: {
                text: "You attack Valerius while he's severely weakened by the Sunstone!",
                choices: [
                    {text: "Fight the severely weakened Valerius", nextSection: 142, skillCheck: false}
                ],
                action: function() {
                    // Severely weakened Valerius stats
                    combatState.active = true;
                    combatState.enemyName = "Severely Weakened Valerius (Sunstone)";
                    combatState.enemyHealth = 120; // Greatly reduced from 200
                    combatState.enemyCurrentHealth = 120;
                    combatState.enemyStrength = 20; // Reduced from 25
                    combatState.enemyDamageDice = 3; // Reduced from 5
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 120;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('valerius');
                    return "<span class='vampire-lord'>Severely Weakened Valerius</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            137: {
                text: "You attack Valerius while he's wounded by the Silver-Tipped Dagger!",
                choices: [
                    {text: "Fight the wounded Valerius", nextSection: 143, skillCheck: false}
                ],
                action: function() {
                    // Wounded Valerius stats
                    combatState.active = true;
                    combatState.enemyName = "Wounded Valerius (Silver Dagger)";
                    combatState.enemyHealth = 180; // Reduced from 200
                    combatState.enemyCurrentHealth = 180;
                    combatState.enemyStrength = 24; // Slightly reduced from 25
                    combatState.enemyDamageDice = 5;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 120;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('valerius');
                    return "<span class='vampire-lord'>Wounded Valerius</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            138: {
                text: "You attack Valerius while he's distracted by Garlic!",
                choices: [
                    {text: "Fight the distracted Valerius", nextSection: 144, skillCheck: false}
                ],
                action: function() {
                    // Distracted Valerius stats
                    combatState.active = true;
                    combatState.enemyName = "Distracted Valerius (Garlic)";
                    combatState.enemyHealth = 190; // Slightly reduced from 200
                    combatState.enemyCurrentHealth = 190;
                    combatState.enemyStrength = 24; // Slightly reduced from 25
                    combatState.enemyDamageDice = 5;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 120;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('valerius');
                    return "<span class='vampire-lord'>Distracted Valerius</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            139: {
                text: "With the ancient vampire tome, you consider what to do next in the library.",
                choices: [
                    {text: "Look for books on vampire weaknesses", nextSection: 70, skillCheck: false},
                    {text: "Take valuable books", nextSection: 105, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            140: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 145, skillCheck: false}
                ]
            },
            141: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 146, skillCheck: false}
                ]
            },
            142: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 147, skillCheck: false}
                ]
            },
            143: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 148, skillCheck: false}
                ]
            },
            144: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 149, skillCheck: false}
                ]
            },
            145: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 134, skillCheck: false}
                ]
            },
            146: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 135, skillCheck: false}
                ]
            },
            147: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 136, skillCheck: false}
                ]
            },
            148: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 137, skillCheck: false}
                ]
            },
            149: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 138, skillCheck: false}
                ]
            }
        };
        
        // Initialize game for Level 10
        function initGame() {
            // Load game state from Level 9
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 10 (coming from Level 9)
                if (savedState.level === 10) {
                    Object.assign(gameState, savedState);
                    
                    // Update intro screen with loaded stats
                    document.getElementById('intro-stat-strength').textContent = gameState.strength;
                    document.getElementById('intro-stat-health').textContent = gameState.health;
                    document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('intro-stat-agility').textContent = gameState.agility;
                    document.getElementById('intro-stat-gold').textContent = gameState.gold;
                    
                    // Generate quarters map if not already generated
                    if (!gameState.quartersMap || Object.keys(gameState.quartersMap).length === 0) {
                        generateQuartersMap();
                    }
                    
                    showScreen('screen-intro');
                    return;
                } else if (savedState.level === 9) {
                    // If coming directly from Level 9 without completing it
                    alert("You must complete Level 9 first!");
                    window.location.href = 'l9.html';
                    return;
                } else {
                    // If no valid save, start from beginning
                    alert("No valid saved game found. Starting from Level 1.");
                    window.location.href = 'l1.html';
                    return;
                }
            } else {
                // No saved game found
                alert("No saved game found. Starting from Level 1.");
                window.location.href = 'l1.html';
                return;
            }
        }
        
        function startLevel10() {
            playSound('click');
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item) && item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='weapon'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='armor'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Show quarters map
        function showMap() {
            playSound('click');
            
            // Update explored percentage
            const totalCells = 11 * 11; // 11x11 grid
            const exploredCells = gameState.exploredQuarters.length;
            const exploredPercent = Math.round((exploredCells / totalCells) * 100);
            document.getElementById('explored-percent').textContent = exploredPercent;
            
            // Generate map display
            const mapDiv = document.getElementById('quarters-map');
            mapDiv.innerHTML = '';
            
            for (let y = 0; y < 11; y++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'map-row';
                
                for (let x = 0; x < 11; x++) {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'map-cell';
                    
                    // Check if this is player position
                    if (gameState.currentPosition.x === x && gameState.currentPosition.y === y) {
                        cellDiv.className += ' player';
                        cellDiv.textContent = 'P';
                    }
                    // Check if this is Valerius position
                    else if (gameState.valeriusPosition.x === x && gameState.valeriusPosition.y === y) {
                        cellDiv.className += ' valerius';
                        cellDiv.textContent = 'V';
                    }
                    // Check if explored
                    else if (gameState.exploredQuarters.includes(`${x},${y}`)) {
                        // Check room type
                        if (gameState.quartersMap[y] && gameState.quartersMap[y][x]) {
                            const roomType = gameState.quartersMap[y][x].type;
                            if (roomType === 'bedroom') {
                                cellDiv.className += ' bedroom';
                                cellDiv.textContent = 'B';
                            } else if (roomType === 'vault') {
                                cellDiv.className += ' vault';
                                cellDiv.textContent = '$';
                            } else if (roomType === 'study') {
                                cellDiv.className += ' study';
                                cellDiv.textContent = 'S';
                            } else if (roomType === 'observatory') {
                                cellDiv.className += ' observatory';
                                cellDiv.textContent = 'O';
                            } else if (roomType === 'library') {
                                cellDiv.className += ' library';
                                cellDiv.textContent = 'L';
                            } else {
                                cellDiv.className += ' explored';
                                cellDiv.textContent = '.';
                            }
                        } else {
                            cellDiv.className += ' explored';
                            cellDiv.textContent = '.';
                        }
                    }
                    // Unexplored
                    else {
                        cellDiv.className += ' unexplored';
                        cellDiv.textContent = '?';
                    }
                    
                    rowDiv.appendChild(cellDiv);
                }
                
                mapDiv.appendChild(rowDiv);
            }
            
            showScreen('screen-map');
        }
        
        function closeMap() {
            playSound('click');
            showScreen('screen-game');
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Potion' || item === 'Mountain Potion' || item === 'Ancient Vampire Wine' || item === 'Vial of Magical Water') {
                const healAmount = item === 'Mountain Potion' ? rollDice(3, 6) + 10 : 
                                 item === 'Ancient Vampire Wine' ? rollDice(2, 8) + 5 : 
                                 item === 'Vial of Magical Water' ? rollDice(2, 6) : rollDice(2, 6) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Holy Water') {
                message = "The <span class='item'>Holy Water</span> is blessed and will burn vampires and other dark creatures.";
            } else if (item === 'Holy Symbol of Light') {
                message = "The <span class='item'>Holy Symbol of Light</span> weakens vampires in its presence.";
            } else if (item === 'Sunstone') {
                message = "The <span class='item'>Sunstone</span> can create sunlight when activated, severely weakening vampires.";
            } else if (item === 'Silver-Tipped Throwing Dagger') {
                message = "The <span class='weapon'>Silver-Tipped Throwing Dagger</span> can be thrown for a ranged silver attack effective against vampires and werewolves.";
            } else if (item === 'Garlic') {
                message = "<span class='item'>Garlic</span> repels vampires with its scent.";
            } else if (item === 'Vampire Slayer Sword') {
                gameState.equippedWeapon = 'Vampire Slayer Sword';
                updateInventoryDisplay();
                message = "You equip the <span class='weapon'>Vampire Slayer Sword</span>. This legendary weapon is especially effective against vampires!";
            } else if (item === 'Silvered Mace') {
                gameState.equippedWeapon = 'Silvered Mace';
                updateInventoryDisplay();
                message = "You equip the <span class='weapon'>Silvered Mace</span>. Silver weapons are effective against vampires and werewolves.";
            } else if (item === 'Ancient Ward Armor') {
                gameState.equippedArmor = 'Ancient Ward Armor';
                updateInventoryDisplay();
                message = "You equip the <span class='armor'>Ancient Ward Armor</span>. It provides protection against dark magic.";
            } else if (item === 'Enchanted Plate Armor') {
                gameState.equippedArmor = 'Enchanted Plate Armor';
                updateInventoryDisplay();
                message = "You equip the <span class='armor'>Enchanted Plate Armor</span>. It offers excellent physical protection.";
            } else if (item === 'Glowing Magic Sword') {
                gameState.equippedWeapon = 'Glowing Magic Sword';
                updateInventoryDisplay();
                message = "You equip the <span class='weapon'>Glowing Magic Sword</span>. It's a powerful magical weapon.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Sword' && 
                gameState.equippedArmor === 'Leather Armor') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Record current position as explored
            const posKey = `${gameState.currentPosition.x},${gameState.currentPosition.y}`;
            if (!gameState.exploredQuarters.includes(posKey)) {
                gameState.exploredQuarters.push(posKey);
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat or victory
            if (!gameState.gameComplete) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    if (typeof choice.requirement === 'function') {
                        return choice.requirement();
                    }
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement ||
                           gameState[choice.requirement] === true;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue exploring the Master Quarters";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                let weaponType = gameState.equippedWeapon;
                
                // Special weapon bonuses against specific enemies
                if (weaponType.includes('Silver') || weaponType.includes('Silver-Tipped')) {
                    // Silver weapons deal extra damage to vampires/werewolves
                    damage = rollDice(2, 6) + 5;
                    if (combatState.enemyName.includes('Vampire') || combatState.enemyName.includes('Werewolf')) {
                        damage += 8; // Extra vs vampires/werewolves
                        resultText += `<span class="weapon">Your silver weapon is especially effective!</span><br>`;
                    }
                } else if (weaponType === 'Vampire Slayer Sword') {
                    damage = rollDice(4, 6) + 10; // Legendary weapon vs vampires
                    if (combatState.enemyName.includes('Vampire')) {
                        damage += 15; // Huge bonus vs vampires
                        resultText += `<span class="weapon">The Vampire Slayer Sword glows with holy power!</span><br>`;
                    }
                } else if (weaponType === 'Glowing Magic Sword') {
                    damage = rollDice(3, 6) + 8; // Magical weapon
                    resultText += `<span class="weapon">The magic sword strikes with arcane energy!</span><br>`;
                } else if (weaponType.includes('Mace')) {
                    damage = rollDice(2, 8) + 4; // Blunt weapon
                } else {
                    damage = rollDice(2, 6) + 2;
                }
                
                // Item bonuses
                if (gameState.inventory.includes('Holy Water') && combatState.enemyName.includes('Vampire')) {
                    damage += 10;
                    resultText += `<span class="item">Holy water burns the vampire!</span><br>`;
                }
                
                if ((gameState.hasHolySymbol || gameState.inventory.some(item => item.includes('Holy') && item.includes('Symbol'))) && combatState.enemyName.includes('Vampire')) {
                    damage += 7;
                    resultText += `<span class="item">The holy symbol weakens the vampire!</span><br>`;
                }
                
                // Ghost knight ally bonus
                if (gameState.ghostKnightAllied && combatState.enemyName.includes('Valerius')) {
                    damage += 5;
                    resultText += `<span class="ghost">Sir Galen attacks alongside you!</span><br>`;
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                let enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                
                // Group enemies attack together
                if (combatState.isGroup && combatState.groupCount > 1) {
                    enemyDamage += Math.floor(combatState.groupCount * 2); // Extra damage for group
                    resultText += `The enemies attack as a group!<br>`;
                }
                
                // Valerius special attacks
                if (combatState.enemyName.includes('Valerius')) {
                    if (Math.random() > 0.7) {
                        enemyDamage += rollDice(3, 8); // Extra vampire lord damage
                        resultText += `Valerius's dark magic enhances his attack!<br>`;
                    }
                    
                    if (Math.random() > 0.9) {
                        // Life drain
                        const drain = rollDice(2, 6);
                        gameState.health -= drain;
                        combatState.enemyCurrentHealth += Math.floor(drain / 2); // Valerius heals from drain
                        resultText += `<span class="vampire">Valerius drains your life force for ${drain} damage, healing himself!</span><br>`;
                    }
                }
                
                // Vampire bride special
                if (combatState.enemyName.includes('Vampire Bride')) {
                    if (Math.random() > 0.8) {
                        enemyDamage += rollDice(2, 6); // Extra vampire damage
                        resultText += `The vampire bride's fangs sink deep!<br>`;
                    }
                }
                
                // Werewolf special
                if (combatState.enemyName.includes('Werewolf')) {
                    if (Math.random() > 0.8) {
                        enemyDamage += rollDice(2, 6); // Ferocious attack
                        resultText += `The werewolf attacks with bestial ferocity!<br>`;
                    }
                }
                
                // Armor protection
                let armorProtection = 0;
                if (gameState.equippedArmor.includes('Plate')) {
                    armorProtection = 5;
                } else if (gameState.equippedArmor.includes('Ward')) {
                    armorProtection = 4;
                } else if (gameState.equippedArmor.includes('Chain')) {
                    armorProtection = 3;
                } else if (gameState.equippedArmor.includes('Leather')) {
                    armorProtection = 1;
                }
                
                enemyDamage = Math.max(1, enemyDamage - armorProtection);
                if (armorProtection > 0) {
                    resultText += `Your <span class="armor">${gameState.equippedArmor}</span> reduces damage by ${armorProtection}.<br>`;
                }
                
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('castleUndeadGameState');
                        window.location.href = 'l1.html';
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You dodge a trap!",
                    "You move silently past a guard.",
                    "You climb a difficult obstacle.",
                    "You slip through a narrow passage.",
                    "You perform an acrobatic maneuver."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip and take 3 damage!",
                    "You make noise and alert nearby enemies.",
                    "You get tangled in curtains or tapestries.",
                    "You knock over a valuable item, making noise."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 3;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Restart game from beginning
        function restartGame() {
            playSound('click');
            localStorage.removeItem('castleUndeadGameState');
            window.location.href = 'l1.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
