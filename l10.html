<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASTLE OF THE UNDEAD - Level 10: The Master Quarters</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Final Level Gold/Purple/Black theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(120, 0, 120, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(120, 0, 120, 0.15) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 3px solid #ffd700;
            background-color: #000;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(120, 0, 120, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #ffd700;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #ffd700;
            text-shadow: 0 0 8px #ffd700;
            font-size: 32px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #ffd700;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 20px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #ffd700;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #220022;
            color: #cc88cc;
            border-color: #cc88cc;
        }
        
        .level-number.current {
            background-color: #ffd700;
            color: #000;
            border-color: #ffd700;
            box-shadow: 0 0 12px #ffd700;
            text-shadow: 0 0 2px #000;
            font-weight: bold;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #ffd700;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #ffd700;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #ffd700;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #ffd700;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #ffd700;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #ffed4e;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ffd700;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #ffd700;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #ffd700;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #ffed4e;
            border-color: #ffed4e;
            box-shadow: 0 0 10px rgba(255, 237, 78, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #ffd700;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #ffed4e;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #ffd700;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #ffed4e;
            border-color: #ffed4e;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #330033;
            border: 1px solid #ffd700;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ffd700;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #550055;
            border: 1px solid #ff00ff;
            padding: 10px;
            margin: 10px 0;
            color: #ffd700;
            font-weight: bold;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .victory {
            color: #ffd700;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 8px #ffd700;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ffd700;
            font-weight: bold;
        }
        
        .item {
            color: #8ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        .maid {
            color: #9cf;
            font-weight: bold;
        }
        
        .ghost {
            color: #8f8;
            font-weight: bold;
        }
        
        .bride {
            color: #f6f;
            font-weight: bold;
        }
        
        .werewolf {
            color: #fa6;
            font-weight: bold;
        }
        
        .hound {
            color: #f84;
            font-weight: bold;
        }
        
        .valerius {
            color: #ff0000;
            font-weight: bold;
            text-shadow: 0 0 5px #ff0000;
        }
        
        .master-bedroom {
            color: #ff88ff;
            font-weight: bold;
        }
        
        .vault {
            color: #ffd700;
            font-weight: bold;
        }
        
        .study {
            color: #8cf;
            font-weight: bold;
        }
        
        .observatory {
            color: #88f;
            font-weight: bold;
        }
        
        .library {
            color: #8f8;
            font-weight: bold;
        }
        
        /* Victory Screen */
        .victory-screen {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .victory-btn {
            background-color: #222;
            color: #fff;
            border: 3px solid #ffd700;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            fontSize: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .victory-btn:hover, .victory-btn:active {
            background-color: #ffd700;
            color: #000;
            border-color: #ffed4e;
            box-shadow: 0 0 20px #ffd700;
        }
        
        /* Blood Pool Animation */
        .blood-animation {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #330000;
            border: 1px solid #ff0040;
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0% { border-color: #ff0040; }
            50% { border-color: #ff6666; }
            100% { border-color: #ff0040; }
        }
        
        /* Gold Animation */
        .gold-animation {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #332200;
            border: 1px solid #ffd700;
            animation: pulse-gold 2s infinite;
        }
        
        @keyframes pulse-gold {
            0% { border-color: #ffd700; }
            50% { border-color: #ffed4e; }
            100% { border-color: #ffd700; }
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #ffd700;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #ffd700;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #ffed4e;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            h2 {
                font-size: 16px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .victory-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CASTLE OF THE UNDEAD</h1>
            <h2>LEVEL 10: THE MASTER QUARTERS</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number completed">2</div>
            <div class="level-number completed">3</div>
            <div class="level-number completed">4</div>
            <div class="level-number completed">5</div>
            <div class="level-number completed">6</div>
            <div class="level-number completed">7</div>
            <div class="level-number completed">8</div>
            <div class="level-number completed">9</div>
            <div class="level-number current">10</div>
        </div>
        
        <!-- Level Intro Screen -->
        <div id="screen-intro" class="screen active-screen">
            <h2>THE FINAL CONFRONTATION</h2>
            <div class="story-text">
                <p>You stand at the entrance to Valerius Vorlak's personal sanctuary. The grand staircase before you leads up to the Master Quarters - the most luxurious and heavily defended area of the castle.</p>
                <p>Marble floors, gilded walls, and priceless artworks line the corridors. But beneath the opulence, you sense the true darkness that dwells here. This is where the Vampire Lord plans his conquests, conducts his darkest rituals, and keeps his most valuable treasures.</p>
                <p>Somewhere in these quarters, Valerius awaits your arrival. He knows you're coming. He has prepared his most powerful servants and deadliest traps.</p>
                <p>Beyond these doors lie the <span class="master-bedroom">Master Bedroom</span>, the <span class="vault">Vault Room</span>, the <span class="study">Study</span>, the <span class="observatory">Observatory</span>, and the <span class="library">Grand Library</span>. Each holds dangers, secrets, and possibly tools to aid you in the final battle.</p>
                <p>This is it - the end of your journey. One way or another, everything ends here.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="intro-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="intro-stat-health" class="stat-value">0</span>/<span id="intro-stat-maxhealth" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="intro-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="intro-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="startLevel10()">ENTER THE MASTER QUARTERS</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/10</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>VALERIUS'S MASTER QUARTERS</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Victory Screen -->
        <div id="screen-victory" class="screen">
            <h2>VICTORY!</h2>
            <div class="story-text">
                <p class="victory">YOU HAVE DEFEATED VALERIUS VORLAK!</p>
                <div class="gold-animation">
                    <p>The Vampire Lord is no more! His reign of terror has ended with your final blow.</p>
                    <p>The castle begins to tremble as the dark magic sustaining it unravels. Sunlight begins to pierce through the centuries-old darkness.</p>
                </div>
                <p>With Valerius defeated, the curse on the land begins to lift. The undead servants collapse into dust, and the monsters flee into the shadows.</p>
                <p>You have accomplished what countless others failed to do. You have entered the Castle of the Undead and destroyed its master.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">FINAL STRENGTH:</span> <span id="victory-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">FINAL HEALTH:</span> <span id="victory-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">FINAL AGILITY:</span> <span id="victory-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">FINAL GOLD:</span> <span id="victory-stat-gold" class="stat-value">0</span></div>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background-color: #330033; border: 1px solid #ffd700;">
                    <h3 style="color: #ffd700; margin-top: 0;">FINAL INVENTORY:</h3>
                    <div id="victory-inventory-display"></div>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background-color: #003322; border: 1px solid #00ff88;">
                    <h3 style="color: #00ff88; margin-top: 0;">YOUR LEGACY:</h3>
                    <p>Your name will be remembered in songs and stories for generations. The people of the surrounding lands can now live without fear of the night.</p>
                    <p>The treasures you've collected will make you wealthy beyond imagination, but more importantly, you have saved countless lives.</p>
                </div>
            </div>
            
            <div class="victory-screen">
                <button class="victory-btn" onclick="completeGame()">COMPLETE THE GAME</button>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE UNDEAD - A Retro Vampire Hunt Adventure<br>
            Level 10: The Master Quarters - FINAL LEVEL
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects for master quarters
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'victory':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    setTimeout(() => playBeep(1300, 0.3, 'sine'), 500);
                    break;
                case 'vampire':
                    playBeep(150, 0.5, 'sawtooth');
                    break;
                case 'ghost':
                    playBeep(300, 0.8, 'sine');
                    setTimeout(() => playBeep(250, 0.6, 'sine'), 800);
                    break;
                case 'werewolf':
                    playBeep(80, 0.4, 'square');
                    setTimeout(() => playBeep(60, 0.4, 'square'), 400);
                    break;
                case 'hound':
                    playBeep(200, 0.3, 'sawtooth');
                    setTimeout(() => playBeep(180, 0.3, 'sawtooth'), 300);
                    break;
                case 'maid':
                    playBeep(600, 0.2, 'triangle');
                    setTimeout(() => playBeep(700, 0.2, 'triangle'), 200);
                    break;
                case 'valerius':
                    playBeep(100, 0.6, 'sawtooth');
                    setTimeout(() => playBeep(120, 0.5, 'sawtooth'), 600);
                    setTimeout(() => playBeep(140, 0.4, 'sawtooth'), 1100);
                    break;
                case 'gold':
                    playBeep(1000, 0.1, 'sine');
                    for(let i = 0; i < 5; i++) {
                        setTimeout(() => playBeep(800 + i*100, 0.1, 'sine'), 100 + i*100);
                    }
                    break;
                case 'final':
                    playBeep(300, 0.2, 'sine');
                    setTimeout(() => playBeep(400, 0.2, 'sine'), 200);
                    setTimeout(() => playBeep(500, 0.2, 'sine'), 400);
                    setTimeout(() => playBeep(600, 0.2, 'sine'), 600);
                    setTimeout(() => playBeep(700, 0.2, 'sine'), 800);
                    setTimeout(() => playBeep(800, 0.5, 'sine'), 1000);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - loaded from Level 9
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Rusty Sword',
            equippedArmor: 'Leather Armor',
            currentSection: 1,
            gameComplete: false,
            level: 10,
            // Level 10 specific flags
            roomsExplored: [],
            enemiesDefeated: {
                vampireBride: false,
                werewolfGuard: false,
                beastHound: false,
                ghostKnight: false,
                valerius: false
            },
            itemsFound: {
                holySword: false,
                dragonScaleArmor: false,
                silverDaggers: false,
                ancientTome: false,
                sunAmulet: false
            },
            npcInteractions: {
                maid: false,
                ghostKnight: false
            },
            // Special items for final battle
            hasHolyWater: false,
            hasSilverWeapon: false,
            hasSunAmulet: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            isGroup: false,
            groupCount: 0,
            isValerius: false,
            valeriusPhase: 1
        };
        
        // Initialize game for Level 10
        function initGame() {
            // Load game state from Level 9
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 10 (coming from Level 9)
                if (savedState.level === 10) {
                    Object.assign(gameState, savedState);
                    
                    // Update intro screen with loaded stats
                    document.getElementById('intro-stat-strength').textContent = gameState.strength;
                    document.getElementById('intro-stat-health').textContent = gameState.health;
                    document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('intro-stat-agility').textContent = gameState.agility;
                    document.getElementById('intro-stat-gold').textContent = gameState.gold;
                    
                    showScreen('screen-intro');
                    return;
                } else if (savedState.level === 9) {
                    // If coming directly from Level 9 without completing it
                    alert("You must complete Level 9 first!");
                    window.location.href = 'l9.html';
                    return;
                } else if (savedState.level === 8) {
                    // If saved level is 8, redirect to level 8
                    alert("You need to complete Level 8 first!");
                    window.location.href = 'l8.html';
                    return;
                } else {
                    // If no valid save, start from beginning
                    alert("No valid saved game found. Starting from Level 1.");
                    window.location.href = 'l1.html';
                    return;
                }
            } else {
                // No saved game found
                alert("No saved game found. Starting from Level 1.");
                window.location.href = 'l1.html';
                return;
            }
        }
        
        function startLevel10() {
            playSound('click');
            updateStatsDisplay();
            updateInventoryDisplay();
            
            // Check for special items that give advantages
            if (gameState.inventory.includes('Holy Water') || gameState.inventory.some(item => item.includes('Holy'))) {
                gameState.hasHolyWater = true;
            }
            if (gameState.equippedWeapon.includes('Silver') || gameState.inventory.some(item => item.includes('Silver'))) {
                gameState.hasSilverWeapon = true;
            }
            if (gameState.inventory.includes('Sun Amulet') || gameState.inventory.some(item => item.includes('Amulet'))) {
                gameState.hasSunAmulet = true;
            }
            
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item) && item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/10`;
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Potion' || item === 'Mountain Potion' || item === 'Ancient Vampire Wine' || item === 'Vial of Magical Water') {
                const healAmount = item === 'Mountain Potion' ? rollDice(3, 6) + 10 : 
                                 item === 'Ancient Vampire Wine' ? rollDice(2, 8) + 5 : 
                                 item === 'Vial of Magical Water' ? rollDice(2, 6) : rollDice(2, 6) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Holy Water') {
                message = "The <span class='item'>Holy Water</span> is blessed and could harm undead, vampires, or dark artifacts.";
            } else if (item === 'Vial of Ancient Blood' || item === 'Vial of Powerful Blood') {
                message = "The <span class='item'>" + item + "</span> contains powerful vampiric essence. It might be useful for rituals or bargaining.";
            } else if (item === 'Throwing Silver Tipped Dagger') {
                if (combatState.active && (combatState.enemyName.includes('Vampire') || combatState.enemyName.includes('Werewolf'))) {
                    // Special combat use
                    const damage = rollDice(3, 6) + 10;
                    combatState.enemyCurrentHealth -= damage;
                    removeFromInventory(item);
                    playSound('combat');
                    message = `You throw the <span class='item'>Silver Tipped Dagger</span> at ${combatState.enemyName} for ${damage} damage!`;
                } else {
                    message = "The <span class='item'>Throwing Silver Tipped Dagger</span> can be thrown in combat against vampires or werewolves for massive damage.";
                }
            } else if (item === 'Holy Sword of Light') {
                gameState.equippedWeapon = 'Holy Sword of Light';
                updateInventoryDisplay();
                message = "You equip the <span class='item'>Holy Sword of Light</span>. It glows with divine power against darkness.";
            } else if (item === 'Dragon Scale Armor') {
                gameState.equippedArmor = 'Dragon Scale Armor';
                updateInventoryDisplay();
                message = "You wear the <span class='item'>Dragon Scale Armor</span>. It offers incredible protection.";
            } else if (item === 'Sun Amulet') {
                message = "The <span class='item'>Sun Amulet</span> glows with sunlight energy. It could weaken vampires.";
            } else if (item === 'Ancient Tome of Vampire Lore') {
                message = "The <span class='item'>Ancient Tome of Vampire Lore</span> contains secrets about vampire weaknesses.";
            } else if (item.includes('Key')) {
                message = "The <span class='item'>" + item + "</span> might unlock doors in the master quarters.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
            
            // If in combat and used a damaging item, continue combat
            if (combatState.active && (item === 'Throwing Silver Tipped Dagger' || item === 'Holy Water')) {
                // Check if enemy defeated
                if (combatState.enemyCurrentHealth <= 0) {
                    endCombatVictory();
                } else {
                    // Enemy still alive, their turn
                    setTimeout(() => {
                        enemyAttack();
                    }, 1500);
                }
            }
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Sword' && 
                gameState.equippedArmor === 'Leather Armor') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Game story sections for Level 10
        const storySections = {
            1: {
                text: "You enter the Grand Hall of the Master Quarters. Marble floors reflect the light of crystal chandeliers. Tapestries depicting ancient vampire conquests line the walls. Four corridors branch off from here, each leading to different parts of Valerius's sanctuary.",
                choices: [
                    {text: "Take the left corridor (leads to the Library and Study)", nextSection: 2, skillCheck: false},
                    {text: "Take the right corridor (leads to the Observatory and Vault)", nextSection: 3, skillCheck: false},
                    {text: "Continue straight ahead (leads to the Master Bedroom)", nextSection: 4, skillCheck: false},
                    {text: "Examine the Grand Hall for secrets", nextSection: 5, skillCheck: true, checkType: 'agility', difficulty: 16}
                ],
                action: function() {
                    if (!gameState.roomsExplored.includes('grand hall')) {
                        gameState.roomsExplored.push('grand hall');
                    }
                    return "The air is thick with power here. You can feel Valerius's presence nearby.";
                }
            },
            2: {
                text: "You enter the Grand Library. Floor-to-ceiling bookshelves hold thousands of volumes. Ancient tomes, scrolls, and strange artifacts fill the room. A lone figure moves among the shelves - a pale woman in elegant robes, her eyes glowing red.",
                choices: [
                    {text: "Approach the woman", nextSection: 6, skillCheck: false},
                    {text: "Search for useful books or items", nextSection: 7, skillCheck: false},
                    {text: "Check the adjacent Study", nextSection: 8, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('vampire');
                    return "<span class='bride'>Vampire Bride</span>: 'The master awaits, little mortal. But first, you must deal with me.'";
                }
            },
            3: {
                text: "You enter the Observatory. A massive telescope points through a glass dome at the night sky. Astronomical charts and celestial models fill the room. In the center stands a suit of animated armor holding a glowing greatsword.",
                choices: [
                    {text: "Approach the animated armor", nextSection: 9, skillCheck: false},
                    {text: "Examine the telescope and charts", nextSection: 10, skillCheck: false},
                    {text: "Check the adjacent Vault Room", nextSection: 11, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('ghost');
                    return "<span class='ghost'>Cursed Ghost Knight</span> stands motionless, its empty helmet gazing at you.";
                }
            },
            4: {
                text: "You approach the doors to the Master Bedroom. They're made of dark ebony, carved with scenes of vampiric glory. From beyond, you can hear faint music and feel a powerful dark presence.",
                choices: [
                    {text: "Enter the Master Bedroom", nextSection: 12, skillCheck: false},
                    {text: "Listen at the door", nextSection: 13, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Prepare yourself before entering", nextSection: 14, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('valerius');
                    return "This is it - Valerius awaits beyond these doors.";
                }
            },
            5: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        const goldFound = rollDice(5, 20);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        return "You find a hidden compartment in one of the tapestries! Inside is <span class='gold'>" + goldFound + " Gold</span>.";
                    } else {
                        playSound('failure');
                        return "You search the hall but find nothing of value.";
                    }
                }
            },
            6: {
                text: "The pale woman turns to face you. 'I am Lysandra, first bride of Valerius. You have come far, mortal, but your journey ends here.' She bares her fangs and her hands elongate into claws.",
                choices: [
                    {text: "Fight Lysandra", nextSection: 16, skillCheck: false},
                    {text: "Try to reason with her", nextSection: 17, skillCheck: false},
                    {text: "Use holy items if you have them", nextSection: 18, skillCheck: false, requirement: function() { 
                        return gameState.hasHolyWater || gameState.hasSilverWeapon || gameState.hasSunAmulet;
                    }},
                    {text: "Retreat from the library", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    playSound('vampire');
                    return "<span class='bride'>Lysandra</span>: 'The master has promised me your blood as a reward!'";
                }
            },
            7: {
                text: "You search the library while avoiding Lysandra's gaze. Among the books, you find several that might be useful.",
                choices: [
                    {text: "Take 'Ancient Tome of Vampire Lore'", nextSection: 19, skillCheck: false},
                    {text: "Search for hidden weapons", nextSection: 20, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Return to dealing with Lysandra", nextSection: 6, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The library holds centuries of knowledge about vampires and their weaknesses.";
                }
            },
            8: {
                text: "You slip into the Study adjacent to the library. This is clearly Valerius's personal workspace. A large desk dominates the room, covered in papers, maps, and strange artifacts.",
                choices: [
                    {text: "Search the desk", nextSection: 21, skillCheck: false},
                    {text: "Examine the artifacts", nextSection: 22, skillCheck: false},
                    {text: "Look for a hidden safe or compartment", nextSection: 23, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Return to the library", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    if (!gameState.roomsExplored.includes('study')) {
                        gameState.roomsExplored.push('study');
                    }
                    return "This room feels like the nerve center of Valerius's operations.";
                }
            },
            9: {
                text: "The animated armor turns toward you, its glowing eyes fixing on your position. A hollow voice echoes from within: 'None may pass to the master's vault. I am Sir Alistair, cursed to guard this place for eternity.'",
                choices: [
                    {text: "Fight the Ghost Knight", nextSection: 24, skillCheck: false},
                    {text: "Try to reason with Sir Alistair", nextSection: 25, skillCheck: false},
                    {text: "Use holy items to dispel the curse", nextSection: 26, skillCheck: false, requirement: function() { 
                        return gameState.hasHolyWater || gameState.inventory.includes('Holy Symbol');
                    }},
                    {text: "Retreat from the observatory", nextSection: 3, skillCheck: false}
                ],
                action: function() {
                    playSound('ghost');
                    return "<span class='ghost'>Sir Alistair</span>: 'Leave now, or join me in eternal service.'";
                }
            },
            10: {
                text: "You examine the astronomical equipment. The charts show complex celestial alignments. One chart in particular seems to show a 'Day of Eternal Night' alignment that empowers vampires.",
                choices: [
                    {text: "Study the charts for weaknesses", nextSection: 27, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Use the telescope", nextSection: 28, skillCheck: false},
                    {text: "Return to dealing with the Ghost Knight", nextSection: 9, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The observatory seems to be used for tracking celestial events important to vampire magic.";
                }
            },
            11: {
                text: "You approach the Vault Room. A massive, magically-sealed door blocks the way. It glows with protective runes. This is where Valerius keeps his greatest treasures.",
                choices: [
                    {text: "Try to open the vault door", nextSection: 29, skillCheck: false},
                    {text: "Examine the protective runes", nextSection: 30, skillCheck: false},
                    {text: "Look for another way in", nextSection: 31, skillCheck: true, checkType: 'agility', difficulty: 20},
                    {text: "Return to the observatory", nextSection: 3, skillCheck: false}
                ],
                action: function() {
                    if (!gameState.roomsExplored.includes('vault')) {
                        gameState.roomsExplored.push('vault');
                    }
                    return "The vault door radiates powerful protective magic.";
                }
            },
            12: {
                text: "You enter the Master Bedroom. The room is opulent beyond imagination. A massive canopy bed dominates the space, but it's empty. Instead, you find a maid nervously dusting a bookshelf.",
                choices: [
                    {text: "Approach the maid", nextSection: 32, skillCheck: false},
                    {text: "Search the bedroom for Valerius", nextSection: 33, skillCheck: false},
                    {text: "Examine the room's contents", nextSection: 34, skillCheck: false},
                    {text: "Leave and return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('maid');
                    return "The maid glances at you nervously, then returns to her work.";
                }
            },
            13: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 35, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You hear faint chanting from beyond the door. Valerius is performing some kind of ritual. You also hear the growl of a large beast.";
                    } else {
                        playSound('failure');
                        return "The door is too thick. You can't hear anything from the other side.";
                    }
                }
            },
            14: {
                text: "You take a moment to prepare yourself. Check your equipment, use any healing items, and mentally prepare for the final battle.",
                choices: [
                    {text: "Use a healing item if available", nextSection: 36, skillCheck: false, requirement: function() { 
                        return gameState.inventory.some(item => item.includes('Potion') || item.includes('Heal'));
                    }},
                    {text: "Check your equipment", nextSection: 37, skillCheck: false},
                    {text: "Enter the Master Bedroom", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    return "This might be your last chance to prepare before facing Valerius.";
                }
            },
            15: {
                text: "After examining the Grand Hall, you consider where to go next.",
                choices: [
                    {text: "Take the left corridor (Library and Study)", nextSection: 2, skillCheck: false},
                    {text: "Take the right corridor (Observatory and Vault)", nextSection: 3, skillCheck: false},
                    {text: "Continue straight ahead (Master Bedroom)", nextSection: 4, skillCheck: false}
                ]
            },
            16: {
                text: "Lysandra hisses and attacks with supernatural speed!",
                choices: [
                    {text: "Fight Lysandra", nextSection: 38, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Lysandra the Vampire Bride";
                    combatState.enemyHealth = 100;
                    combatState.enemyCurrentHealth = 100;
                    combatState.enemyStrength = 18;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 39;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('vampire');
                    return "<span class='bride'>Lysandra the Vampire Bride</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            17: {
                text: "'You don't have to serve him,' you say. 'Valerius uses everyone. You could be free.' Lysandra hesitates, then shakes her head. 'I have been with him for three centuries. I know no other life.'",
                choices: [
                    {text: "Continue trying to reason", nextSection: 40, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Attack while she's distracted", nextSection: 41, skillCheck: false},
                    {text: "Use holy items", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    return "<span class='bride'>Lysandra</span>: 'Your words are... tempting. But no. My loyalty is to Valerius.'";
                }
            },
            18: {
                text: "You present your holy items. Lysandra recoils, hissing in pain.",
                choices: [
                    {text: "Use Holy Water if you have it", nextSection: 42, skillCheck: false, requirement: 'Holy Water'},
                    {text: "Use Silver Weapon if you have one", nextSection: 43, skillCheck: false, requirement: function() { 
                        return gameState.equippedWeapon.includes('Silver') || gameState.inventory.some(item => item.includes('Silver'));
                    }},
                    {text: "Use Sun Amulet if you have it", nextSection: 44, skillCheck: false, requirement: 'Sun Amulet'},
                    {text: "Return to other options", nextSection: 6, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The holy items weaken Lysandra! She seems more vulnerable now.";
                }
            },
            19: {
                text: "You take the Ancient Tome of Vampire Lore. It contains valuable information about vampire weaknesses.",
                choices: [
                    {text: "Search for hidden weapons", nextSection: 20, skillCheck: false},
                    {text: "Return to dealing with Lysandra", nextSection: 6, skillCheck: false}
                ],
                action: function() {
                    gameState.itemsFound.ancientTome = true;
                    addToInventory('Ancient Tome of Vampire Lore');
                    playSound('item');
                    return "You acquire the <span class='item'>Ancient Tome of Vampire Lore</span>. This knowledge could be crucial against Valerius.";
                }
            },
            20: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 45, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        addToInventory('Throwing Silver Tipped Dagger');
                        return "You find a hidden compartment containing a <span class='item'>Throwing Silver Tipped Dagger</span>! Perfect against vampires.";
                    } else {
                        playSound('failure');
                        return "You search but find no hidden weapons.";
                    }
                }
            },
            21: {
                text: "Valerius's desk is covered in plans for conquest, maps of human kingdoms, and lists of potential 'subjects.' Among the papers, you find something interesting.",
                choices: [
                    {text: "Take the maps and plans", nextSection: 46, skillCheck: false},
                    {text: "Search for keys", nextSection: 47, skillCheck: false},
                    {text: "Examine the strange artifacts", nextSection: 22, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(8, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> in a desk drawer.";
                }
            },
            22: {
                text: "The artifacts on Valerius's desk include strange crystals, bottled essences, and a silver medallion that glows with inner light.",
                choices: [
                    {text: "Take the Sun Amulet", nextSection: 48, skillCheck: false},
                    {text: "Examine the crystals", nextSection: 49, skillCheck: false},
                    {text: "Search the desk", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "These artifacts radiate powerful magic.";
                }
            },
            23: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 50, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.itemsFound.holySword = true;
                        addToInventory('Holy Sword of Light');
                        return "You find a hidden compartment behind a bookshelf! Inside is a <span class='item'>Holy Sword of Light</span> that glows with divine energy!";
                    } else {
                        playSound('failure');
                        return "You search thoroughly but find no hidden compartments.";
                    }
                }
            },
            24: {
                text: "Sir Alistair raises his glowing greatsword. 'So be it. Have at thee!'",
                choices: [
                    {text: "Fight the Ghost Knight", nextSection: 51, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Sir Alistair the Ghost Knight";
                    combatState.enemyHealth = 120;
                    combatState.enemyCurrentHealth = 120;
                    combatState.enemyStrength = 20;
                    combatState.enemyDamageDice = 4;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 52;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('ghost');
                    return "<span class='ghost'>Sir Alistair the Ghost Knight</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            25: {
                text: "'Sir Alistair, you were once a noble knight. Do you truly wish to serve evil for eternity?' The ghost knight pauses, his glowing eyes dimming slightly.",
                choices: [
                    {text: "Continue reasoning", nextSection: 53, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Attack while he's distracted", nextSection: 54, skillCheck: false},
                    {text: "Use holy items to free him", nextSection: 26, skillCheck: false}
                ],
                action: function() {
                    playSound('ghost');
                    return "<span class='ghost'>Sir Alistair</span>: 'I... I remember... sunlight... honor...'";
                }
            },
            26: {
                text: "You use holy items on the ghost knight. He cries out as the curse begins to unravel.",
                choices: [
                    {text: "Use Holy Water", nextSection: 55, skillCheck: false, requirement: 'Holy Water'},
                    {text: "Use Holy Symbol if you have it", nextSection: 56, skillCheck: false, requirement: function() { 
                        return gameState.inventory.some(item => item.includes('Holy Symbol'));
                    }},
                    {text: "Return to other options", nextSection: 9, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The holy items glow with power, weakening the curse that binds Sir Alistair.";
                }
            },
            27: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 57, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You discover that during certain celestial alignments, vampires are actually weaker! The next such alignment is... tonight! This could be crucial information.";
                    } else {
                        playSound('failure');
                        return "The charts are too complex. You can't make sense of them.";
                    }
                }
            },
            28: {
                text: "You look through the telescope. It's trained not on stars, but on the surrounding countryside. You see villages, roads, and what looks like marching undead armies in the distance.",
                choices: [
                    {text: "Study the charts for weaknesses", nextSection: 27, skillCheck: false},
                    {text: "Return to dealing with the Ghost Knight", nextSection: 9, skillCheck: false}
                ],
                action: function() {
                    return "Valerius has been watching his future conquests through this telescope.";
                }
            },
            29: {
                text: "You try to open the vault door, but it's sealed with powerful magic. The runes glow brighter as you touch it.",
                choices: [
                    {text: "Try to break the runes", nextSection: 58, skillCheck: true, checkType: 'strength', difficulty: 22},
                    {text: "Look for a key", nextSection: 59, skillCheck: false},
                    {text: "Examine the protective runes", nextSection: 30, skillCheck: false}
                ],
                action: function() {
                    playSound('failure');
                    return "The vault door doesn't budge. The magic protecting it is incredibly strong.";
                }
            },
            30: {
                text: "The runes on the vault door are ancient vampire magic. Some seem to be protective, others are warnings. One rune in particular seems to be a 'daylight' symbol - a weakness.",
                choices: [
                    {text: "Try to exploit the daylight rune", nextSection: 60, skillCheck: false},
                    {text: "Try to open the vault door", nextSection: 29, skillCheck: false},
                    {text: "Look for another way in", nextSection: 31, skillCheck: false}
                ],
                action: function() {
                    return "The daylight rune seems out of place among the other protective symbols.";
                }
            },
            31: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 61, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.itemsFound.dragonScaleArmor = true;
                        addToInventory('Dragon Scale Armor');
                        return "You find a ventilation shaft leading into the vault! Inside, you discover <span class='item'>Dragon Scale Armor</span> - incredibly protective armor!";
                    } else {
                        playSound('failure');
                        return "You search for another entrance but find none. The vault is completely sealed.";
                    }
                }
            },
            32: {
                text: "The maid turns to you, her eyes wide with fear. 'Please, don't hurt me! I'm just a servant. Valerius... he's in his private chamber beyond that door.' She points to another, smaller door at the back of the bedroom.",
                choices: [
                    {text: "Ask about Valerius's weaknesses", nextSection: 62, skillCheck: false},
                    {text: "Ask about the layout of the quarters", nextSection: 63, skillCheck: false},
                    {text: "Ask if there are any useful items here", nextSection: 64, skillCheck: false},
                    {text: "Thank her and continue", nextSection: 65, skillCheck: false}
                ],
                action: function() {
                    gameState.npcInteractions.maid = true;
                    playSound('maid');
                    return "<span class='maid'>The Maid</span>: 'He... he keeps his most powerful artifacts in the vault, but the ghost knight guards it. He's weakest during daylight, but it's always night here.'";
                }
            },
            33: {
                text: "You search the bedroom. It's empty except for the maid. However, you notice the smaller door the maid mentioned. From beyond it, you can feel immense dark power.",
                choices: [
                    {text: "Enter Valerius's private chamber", nextSection: 66, skillCheck: false},
                    {text: "Talk to the maid", nextSection: 32, skillCheck: false},
                    {text: "Examine the room's contents", nextSection: 34, skillCheck: false}
                ],
                action: function() {
                    playSound('valerius');
                    return "Valerius is definitely behind that door. You can feel his power emanating from it.";
                }
            },
            34: {
                text: "The bedroom contains luxurious furnishings, but also strange items: jars of blood, ancient texts, and what looks like a collection of trophies from previous vampire hunters.",
                choices: [
                    {text: "Search for useful items", nextSection: 67, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Talk to the maid", nextSection: 32, skillCheck: false},
                    {text: "Enter Valerius's private chamber", nextSection: 66, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(10, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('gold');
                    return "Among Valerius's trophies, you find <span class='gold'>" + goldFound + " Gold</span> taken from previous adventurers.";
                }
            },
            35: {
                text: "After listening at the door, you're ready to enter.",
                choices: [
                    {text: "Enter the Master Bedroom", nextSection: 12, skillCheck: false},
                    {text: "Prepare yourself first", nextSection: 14, skillCheck: false}
                ]
            },
            36: {
                text: "You use a healing item to restore your health before the final battle.",
                choices: [
                    {text: "Enter the Master Bedroom", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    // This will be handled by the useItem function
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">Select a healing item from your inventory.</div>`;
                    setTimeout(() => useItem(), 100);
                    return "";
                }
            },
            37: {
                text: "You check your equipment. You're as ready as you'll ever be.",
                choices: [
                    {text: "Enter the Master Bedroom", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    return "Your equipment is in order. The final battle awaits.";
                }
            },
            38: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 68, skillCheck: false}
                ]
            },
            39: {
                text: "With Lysandra defeated, the library is now safe to explore. She collapses into dust, her curse finally broken.",
                choices: [
                    {text: "Search the library thoroughly", nextSection: 69, skillCheck: false},
                    {text: "Check the adjacent Study", nextSection: 8, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.enemiesDefeated.vampireBride = true;
                    const goldFound = rollDice(10, 25);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You defeat Lysandra! She leaves behind <span class='gold'>" + goldFound + " Gold</span> and her jewelry.";
                }
            },
            40: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 70, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.enemiesDefeated.vampireBride = true;
                        return "Lysandra hesitates, then lowers her hands. 'You... you're right. I've been a slave for too long. Take what you need from the library. I will leave this place and try to find... redemption.' She vanishes in a swirl of mist.";
                    } else {
                        // She attacks
                        combatState.active = true;
                        combatState.enemyName = "Angered Lysandra";
                        combatState.enemyHealth = 90;
                        combatState.enemyCurrentHealth = 90;
                        combatState.enemyStrength = 17;
                        combatState.enemyDamageDice = 3;
                        combatState.enemyDamageSides = 8;
                        combatState.nextSection = 71;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('vampire');
                        return "Lysandra snarls. 'Nice try, but I see through your tricks!'<br><br><span class='bride'>Angered Lysandra</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            41: {
                text: "You attack Lysandra while she's distracted by your words!",
                choices: [
                    {text: "Continue the attack", nextSection: 72, skillCheck: false}
                ],
                action: function() {
                    // Surprise round advantage
                    const surpriseDamage = rollDice(3, 8);
                    
                    combatState.active = true;
                    combatState.enemyName = "Surprised Lysandra";
                    combatState.enemyHealth = 100 - surpriseDamage;
                    combatState.enemyCurrentHealth = 100 - surpriseDamage;
                    combatState.enemyStrength = 16; // Lower due to surprise
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 73;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('combat');
                    return "You strike while she's distracted for " + surpriseDamage + " damage!<br><br><span class='bride'>Surprised Lysandra</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            42: {
                text: "You splash Holy Water on Lysandra. She screams as her skin sizzles and burns!",
                choices: [
                    {text: "Finish her off", nextSection: 74, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Holy Water');
                    const damage = rollDice(4, 10) + 20;
                    gameState.enemiesDefeated.vampireBride = true;
                    const goldFound = rollDice(8, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('combat');
                    return "The Holy Water deals " + damage + " damage to Lysandra! She collapses into dust, defeated. You find <span class='gold'>" + goldFound + " Gold</span> among her remains.";
                }
            },
            43: {
                text: "You attack Lysandra with your silver weapon. It cuts through her defenses easily!",
                choices: [
                    {text: "Finish her off", nextSection: 75, skillCheck: false}
                ],
                action: function() {
                    const damage = rollDice(3, 10) + 15;
                    gameState.enemiesDefeated.vampireBride = true;
                    const goldFound = rollDice(8, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('combat');
                    return "Your silver weapon deals " + damage + " damage to Lysandra! She collapses into dust, defeated. You find <span class='gold'>" + goldFound + " Gold</span> among her remains.";
                }
            },
            44: {
                text: "You hold up the Sun Amulet. It glows with sunlight energy, causing Lysandra to shriek and cover her face!",
                choices: [
                    {text: "Finish her off", nextSection: 76, skillCheck: false}
                ],
                action: function() {
                    const damage = rollDice(3, 8) + 10;
                    gameState.enemiesDefeated.vampireBride = true;
                    const goldFound = rollDice(8, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('combat');
                    return "The Sun Amulet deals " + damage + " damage to Lysandra! She collapses into dust, defeated. You find <span class='gold'>" + goldFound + " Gold</span> among her remains.";
                }
            },
            45: {
                text: "After searching the library, you return to dealing with Lysandra.",
                choices: [
                    {text: "Approach Lysandra", nextSection: 6, skillCheck: false},
                    {text: "Check the adjacent Study", nextSection: 8, skillCheck: false}
                ]
            },
            46: {
                text: "You take Valerius's plans. They could be useful evidence of his intentions.",
                choices: [
                    {text: "Search for keys", nextSection: 47, skillCheck: false},
                    {text: "Examine the strange artifacts", nextSection: 22, skillCheck: false},
                    {text: "Leave the Study", nextSection: 8, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Valerius Invasion Plans');
                    playSound('item');
                    return "You take <span class='item'>Valerius Invasion Plans</span>. These could be valuable if you survive.";
                }
            },
            47: {
                text: "You search for keys. In a small drawer, you find an ornate silver key.",
                choices: [
                    {text: "Take the key", nextSection: 77, skillCheck: false},
                    {text: "Take the maps and plans", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Ornate Silver Key');
                    playSound('item');
                    return "You find an <span class='item'>Ornate Silver Key</span>. It might unlock something important.";
                }
            },
            48: {
                text: "You take the Sun Amulet. It glows warmly in your hand.",
                choices: [
                    {text: "Examine the crystals", nextSection: 49, skillCheck: false},
                    {text: "Search the desk", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    gameState.itemsFound.sunAmulet = true;
                    gameState.hasSunAmulet = true;
                    addToInventory('Sun Amulet');
                    playSound('item');
                    return "You acquire the <span class='item'>Sun Amulet</span>. It radiates sunlight energy that could weaken vampires.";
                }
            },
            49: {
                text: "The crystals pulse with dark energy. They seem to be sources of vampiric power.",
                choices: [
                    {text: "Take the Sun Amulet", nextSection: 48, skillCheck: false},
                    {text: "Destroy the crystals", nextSection: 78, skillCheck: false},
                    {text: "Leave them alone", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    return "Destroying these crystals might weaken Valerius's power.";
                }
            },
            50: {
                text: "After searching the Study, you return to the library.",
                choices: [
                    {text: "Return to the library", nextSection: 2, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            51: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 79, skillCheck: false}
                ]
            },
            52: {
                text: "With Sir Alistair defeated, the observatory is now safe. His armor collapses into a pile, finally at peace.",
                choices: [
                    {text: "Examine the telescope and charts", nextSection: 10, skillCheck: false},
                    {text: "Check the adjacent Vault Room", nextSection: 11, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.enemiesDefeated.ghostKnight = true;
                    const goldFound = rollDice(12, 25);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You defeat Sir Alistair! His armor contains <span class='gold'>" + goldFound + " Gold</span> and his glowing greatsword.";
                }
            },
            53: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 80, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.enemiesDefeated.ghostKnight = true;
                        gameState.npcInteractions.ghostKnight = true;
                        return "Sir Alistair's form begins to glow with a pure white light. 'Thank you... for freeing me from this curse. Take this - it may help you against the vampire.' He hands you his glowing greatsword before fading away to his final rest.";
                    } else {
                        // He attacks
                        combatState.active = true;
                        combatState.enemyName = "Confused Ghost Knight";
                        combatState.enemyHealth = 110;
                        combatState.enemyCurrentHealth = 110;
                        combatState.enemyStrength = 19;
                        combatState.enemyDamageDice = 4;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 81;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('ghost');
                        return "Sir Alistair shakes his head. 'No... the curse is too strong. Forgive me!'<br><br><span class='ghost'>Confused Ghost Knight</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            54: {
                text: "You attack Sir Alistair while he's distracted by memories.",
                choices: [
                    {text: "Continue the attack", nextSection: 82, skillCheck: false}
                ],
                action: function() {
                    // Surprise round advantage
                    const surpriseDamage = rollDice(3, 10);
                    
                    combatState.active = true;
                    combatState.enemyName = "Surprised Ghost Knight";
                    combatState.enemyHealth = 120 - surpriseDamage;
                    combatState.enemyCurrentHealth = 120 - surpriseDamage;
                    combatState.enemyStrength = 18; // Lower due to surprise
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 83;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('combat');
                    return "You strike while he's distracted for " + surpriseDamage + " damage!<br><br><span class='ghost'>Surprised Ghost Knight</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            55: {
                text: "You sprinkle Holy Water on Sir Alistair. He glows brightly as the curse unravels!",
                choices: [
                    {text: "Watch as he's freed", nextSection: 84, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Holy Water');
                    gameState.enemiesDefeated.ghostKnight = true;
                    gameState.npcInteractions.ghostKnight = true;
                    playSound('success');
                    return "The Holy Water breaks the curse! Sir Alistair thanks you before passing on to the afterlife. He leaves behind his glowing greatsword.";
                }
            },
            56: {
                text: "You show the Holy Symbol to Sir Alistair. It glows with divine light, breaking his curse.",
                choices: [
                    {text: "Watch as he's freed", nextSection: 85, skillCheck: false}
                ],
                action: function() {
                    gameState.enemiesDefeated.ghostKnight = true;
                    gameState.npcInteractions.ghostKnight = true;
                    playSound('success');
                    return "The Holy Symbol breaks the curse! Sir Alistair thanks you before passing on to the afterlife. He leaves behind his glowing greatsword.";
                }
            },
            57: {
                text: "With your new knowledge, you consider your next move.",
                choices: [
                    {text: "Return to dealing with the Ghost Knight", nextSection: 9, skillCheck: false},
                    {text: "Check the adjacent Vault Room", nextSection: 11, skillCheck: false}
                ]
            },
            58: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 86, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        const goldFound = rollDice(20, 50);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        return "You break the magical runes! The vault door swings open, revealing mountains of treasure! You collect <span class='gold'>" + goldFound + " Gold</span>!";
                    } else {
                        const damage = rollDice(2, 10);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The runes retaliate with magical energy, dealing " + damage + " damage to you!";
                    }
                }
            },
            59: {
                text: "You look for a key to the vault. There's no obvious keyhole, but you notice the Ornate Silver Key you found might fit somewhere.",
                choices: [
                    {text: "Try the Ornate Silver Key if you have it", nextSection: 87, skillCheck: false, requirement: 'Ornate Silver Key'},
                    {text: "Try to break the runes", nextSection: 58, skillCheck: false},
                    {text: "Examine the protective runes", nextSection: 30, skillCheck: false}
                ],
                action: function() {
                    return "The vault seems to require a specific key.";
                }
            },
            60: {
                text: "You focus on the daylight rune. It seems to be a weakness in the protective magic.",
                choices: [
                    {text: "Attack the daylight rune", nextSection: 88, skillCheck: false},
                    {text: "Try to open the vault door", nextSection: 29, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The daylight rune is the key to bypassing the vault's protections.";
                }
            },
            61: {
                text: "After your attempt to find another entrance, you return to the vault door.",
                choices: [
                    {text: "Try to open the vault door", nextSection: 29, skillCheck: false},
                    {text: "Examine the protective runes", nextSection: 30, skillCheck: false}
                ]
            },
            62: {
                text: "'What are Valerius's weaknesses?' you ask. The maid thinks for a moment. 'Sunlight, of course. Holy symbols hurt him. Silver too. But he's strongest at night, and it's always night here. He keeps his power in a crystal in his private chamber.'",
                choices: [
                    {text: "Ask about the layout of the quarters", nextSection: 63, skillCheck: false},
                    {text: "Ask if there are any useful items here", nextSection: 64, skillCheck: false},
                    {text: "Thank her and continue", nextSection: 65, skillCheck: false}
                ],
                action: function() {
                    return "<span class='maid'>The Maid</span>: 'If you break his power crystal, he'll be much weaker. But be careful - he guards it fiercely.'";
                }
            },
            63: {
                text: "'What's in the other rooms?' you ask. 'The library has Lysandra, his first bride,' she says. 'The observatory has the ghost knight. The vault has his treasures, but it's magically sealed. The study has his plans and research.'",
                choices: [
                    {text: "Ask about Valerius's weaknesses", nextSection: 62, skillCheck: false},
                    {text: "Ask if there are any useful items here", nextSection: 64, skillCheck: false},
                    {text: "Thank her and continue", nextSection: 65, skillCheck: false}
                ],
                action: function() {
                    return "<span class='maid'>The Maid</span>: 'You might find useful things in the other rooms, but they're all guarded.'";
                }
            },
            64: {
                text: "'Are there any items here that could help against Valerius?' you ask. The maid looks around nervously, then whispers, 'Check his trophy collection. Sometimes he keeps things from... previous visitors that might help.'",
                choices: [
                    {text: "Ask about Valerius's weaknesses", nextSection: 62, skillCheck: false},
                    {text: "Ask about the layout of the quarters", nextSection: 63, skillCheck: false},
                    {text: "Thank her and continue", nextSection: 65, skillCheck: false}
                ],
                action: function() {
                    return "<span class='maid'>The Maid</span>: 'I have to go now. Good luck.' She hurries out of the room.";
                }
            },
            65: {
                text: "You thank the maid and she leaves quickly. You're now alone in Valerius's bedroom, facing the door to his private chamber.",
                choices: [
                    {text: "Enter Valerius's private chamber", nextSection: 66, skillCheck: false},
                    {text: "Search the bedroom for useful items", nextSection: 67, skillCheck: false}
                ]
            },
            66: {
                text: "You enter Valerius's private chamber. The room is dark, lit only by a single blood-red crystal floating in the center. Before it stands Valerius Vorlak himself, tall and pale, his eyes glowing with ancient evil. Two massive beasts flank him - a werewolf in guard armor and a monstrous hound with three heads.",
                choices: [
                    {text: "Confront Valerius", nextSection: 89, skillCheck: false},
                    {text: "Attack the werewolf guard first", nextSection: 90, skillCheck: false},
                    {text: "Target the power crystal", nextSection: 91, skillCheck: false},
                    {text: "Use any special items you've collected", nextSection: 92, skillCheck: false}
                ],
                action: function() {
                    playSound('valerius');
                    return "<span class='valerius'>Valerius Vorlak</span>: 'Ah, the persistent little hunter. You've made it farther than any before you. I shall enjoy adding your skull to my collection.'";
                }
            },
            67: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 93, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        addToInventory('Vampire Hunter Medallion');
                        return "Among Valerius's trophies, you find a <span class='item'>Vampire Hunter Medallion</span> that grants protection against vampiric attacks!";
                    } else {
                        playSound('failure');
                        return "You search the trophies but find nothing useful.";
                    }
                }
            },
            68: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 38, skillCheck: false}
                ]
            },
            69: {
                text: "With Lysandra gone, you search the library thoroughly.",
                choices: [
                    {text: "Take 'Ancient Tome of Vampire Lore'", nextSection: 19, skillCheck: false},
                    {text: "Search for hidden weapons", nextSection: 20, skillCheck: false},
                    {text: "Check the adjacent Study", nextSection: 8, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> hidden among the books.";
                }
            },
            70: {
                text: "With Lysandra gone, the library is safe.",
                choices: [
                    {text: "Search the library thoroughly", nextSection: 69, skillCheck: false},
                    {text: "Check the adjacent Study", nextSection: 8, skillCheck: false}
                ]
            },
            71: {
                text: "With the angered Lysandra defeated, you can explore the library.",
                choices: [
                    {text: "Search the library thoroughly", nextSection: 69, skillCheck: false},
                    {text: "Check the adjacent Study", nextSection: 8, skillCheck: false}
                ],
                action: function() {
                    gameState.enemiesDefeated.vampireBride = true;
                    const goldFound = rollDice(8, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You defeat Lysandra! She leaves behind <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            72: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 41, skillCheck: false}
                ]
            },
            73: {
                text: "With the surprised Lysandra defeated, you can explore the library.",
                choices: [
                    {text: "Search the library thoroughly", nextSection: 69, skillCheck: false},
                    {text: "Check the adjacent Study", nextSection: 8, skillCheck: false}
                ],
                action: function() {
                    gameState.enemiesDefeated.vampireBride = true;
                    const goldFound = rollDice(10, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You defeat Lysandra! She leaves behind <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            74: {
                text: "With Lysandra defeated by Holy Water, the library is safe.",
                choices: [
                    {text: "Search the library thoroughly", nextSection: 69, skillCheck: false},
                    {text: "Check the adjacent Study", nextSection: 8, skillCheck: false}
                ]
            },
            75: {
                text: "With Lysandra defeated by silver weapon, the library is safe.",
                choices: [
                    {text: "Search the library thoroughly", nextSection: 69, skillCheck: false},
                    {text: "Check the adjacent Study", nextSection: 8, skillCheck: false}
                ]
            },
            76: {
                text: "With Lysandra defeated by Sun Amulet, the library is safe.",
                choices: [
                    {text: "Search the library thoroughly", nextSection: 69, skillCheck: false},
                    {text: "Check the adjacent Study", nextSection: 8, skillCheck: false}
                ]
            },
            77: {
                text: "With the Ornate Silver Key, you consider your next move.",
                choices: [
                    {text: "Take the maps and plans", nextSection: 46, skillCheck: false},
                    {text: "Examine the strange artifacts", nextSection: 22, skillCheck: false},
                    {text: "Leave the Study", nextSection: 8, skillCheck: false}
                ]
            },
            78: {
                text: "You destroy the dark crystals. They shatter with a sound like breaking glass, releasing their dark energy.",
                choices: [
                    {text: "Take the Sun Amulet", nextSection: 48, skillCheck: false},
                    {text: "Search the desk", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The crystals shatter! This might weaken Valerius's power slightly.";
                }
            },
            79: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 51, skillCheck: false}
                ]
            },
            80: {
                text: "With Sir Alistair freed, the observatory is safe.",
                choices: [
                    {text: "Examine the telescope and charts", nextSection: 10, skillCheck: false},
                    {text: "Check the adjacent Vault Room", nextSection: 11, skillCheck: false}
                ]
            },
            81: {
                text: "With the confused ghost knight defeated, the observatory is safe.",
                choices: [
                    {text: "Examine the telescope and charts", nextSection: 10, skillCheck: false},
                    {text: "Check the adjacent Vault Room", nextSection: 11, skillCheck: false}
                ],
                action: function() {
                    gameState.enemiesDefeated.ghostKnight = true;
                    const goldFound = rollDice(10, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You defeat Sir Alistair! His armor contains <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            82: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 54, skillCheck: false}
                ]
            },
            83: {
                text: "With the surprised ghost knight defeated, the observatory is safe.",
                choices: [
                    {text: "Examine the telescope and charts", nextSection: 10, skillCheck: false},
                    {text: "Check the adjacent Vault Room", nextSection: 11, skillCheck: false}
                ],
                action: function() {
                    gameState.enemiesDefeated.ghostKnight = true;
                    const goldFound = rollDice(11, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You defeat Sir Alistair! His armor contains <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            84: {
                text: "With Sir Alistair freed by Holy Water, the observatory is safe.",
                choices: [
                    {text: "Examine the telescope and charts", nextSection: 10, skillCheck: false},
                    {text: "Check the adjacent Vault Room", nextSection: 11, skillCheck: false}
                ]
            },
            85: {
                text: "With Sir Alistair freed by Holy Symbol, the observatory is safe.",
                choices: [
                    {text: "Examine the telescope and charts", nextSection: 10, skillCheck: false},
                    {text: "Check the adjacent Vault Room", nextSection: 11, skillCheck: false}
                ]
            },
            86: {
                text: "After your attempt to break the runes, you consider other options.",
                choices: [
                    {text: "Look for a key", nextSection: 59, skillCheck: false},
                    {text: "Examine the protective runes", nextSection: 30, skillCheck: false}
                ]
            },
            87: {
                text: "You try the Ornate Silver Key in the vault door. It fits perfectly! The door swings open with a hiss.",
                choices: [
                    {text: "Enter the vault", nextSection: 94, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    removeFromInventory('Ornate Silver Key');
                    return "The key works! The vault door opens.";
                }
            },
            88: {
                text: "You attack the daylight rune. It shatters under your blow, causing the other runes to flicker and die!",
                choices: [
                    {text: "Enter the vault", nextSection: 94, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The protective magic fails! The vault door swings open.";
                }
            },
            89: {
                text: "'Valerius! Your reign ends today!' you shout. The vampire lord smiles coldly. 'Brave words. Let's see if you can back them up.'",
                choices: [
                    {text: "Begin the final battle", nextSection: 95, skillCheck: false}
                ],
                action: function() {
                    playSound('valerius');
                    return "<span class='valerius'>Valerius</span>: 'Fenrir, Cerberus - deal with this insect.' The werewolf and hound snarl and step forward.";
                }
            },
            90: {
                text: "You attack the werewolf guard first! It howls and prepares to fight.",
                choices: [
                    {text: "Fight the werewolf guard", nextSection: 96, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Fenrir the Werewolf Guard";
                    combatState.enemyHealth = 90;
                    combatState.enemyCurrentHealth = 90;
                    combatState.enemyStrength = 17;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 97;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('werewolf');
                    return "<span class='werewolf'>Fenrir the Werewolf Guard</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            91: {
                text: "You make a dash for the power crystal! Valerius moves to intercept you.",
                choices: [
                    {text: "Try to reach the crystal", nextSection: 98, skillCheck: true, checkType: 'agility', difficulty: 20},
                    {text: "Fight Valerius instead", nextSection: 99, skillCheck: false}
                ],
                action: function() {
                    playSound('valerius');
                    return "<span class='valerius'>Valerius</span>: 'No! Protect the crystal!'";
                }
            },
            92: {
                text: "You use special items against Valerius and his minions.",
                choices: [
                    {text: "Use Holy Water if you have it", nextSection: 100, skillCheck: false, requirement: function() { 
                        return gameState.inventory.includes('Holy Water');
                    }},
                    {text: "Use Sun Amulet if you have it", nextSection: 101, skillCheck: false, requirement: 'Sun Amulet'},
                    {text: "Use Silver Weapons if you have them", nextSection: 102, skillCheck: false, requirement: function() { 
                        return gameState.hasSilverWeapon || gameState.inventory.some(item => item.includes('Silver'));
                    }},
                    {text: "Return to other options", nextSection: 66, skillCheck: false}
                ],
                action: function() {
                    return "Special items could give you an advantage in this fight.";
                }
            },
            93: {
                text: "After searching the bedroom, you face the door to Valerius's private chamber.",
                choices: [
                    {text: "Enter Valerius's private chamber", nextSection: 66, skillCheck: false}
                ]
            },
            94: {
                text: "You enter the vault. Mountains of gold, jewels, and magical artifacts fill the room. This is Valerius's accumulated wealth over centuries.",
                choices: [
                    {text: "Take as much treasure as you can", nextSection: 103, skillCheck: false},
                    {text: "Search for specific powerful artifacts", nextSection: 104, skillCheck: false},
                    {text: "Take only what you can carry", nextSection: 105, skillCheck: false},
                    {text: "Leave the vault and face Valerius", nextSection: 106, skillCheck: false}
                ],
                action: function() {
                    playSound('gold');
                    return "The vault contains more wealth than you've ever seen in your life.";
                }
            },
            95: {
                text: "The final battle begins! Valerius sends his minions to attack you first.",
                choices: [
                    {text: "Fight the werewolf and hound", nextSection: 107, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Fenrir & Cerberus";
                    combatState.enemyHealth = 150;
                    combatState.enemyCurrentHealth = 150;
                    combatState.enemyStrength = 18;
                    combatState.enemyDamageDice = 4;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 108;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 2;
                    
                    playSound('werewolf');
                    playSound('hound');
                    return "<span class='werewolf'>Fenrir the Werewolf Guard</span> and <span class='hound'>Cerberus the Beast Hound</span>: Combined Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            96: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 109, skillCheck: false}
                ]
            },
            97: {
                text: "With the werewolf guard defeated, only Cerberus and Valerius remain. The beast hound snarls and prepares to attack.",
                choices: [
                    {text: "Fight Cerberus next", nextSection: 110, skillCheck: false},
                    {text: "Attack Valerius directly", nextSection: 111, skillCheck: false}
                ],
                action: function() {
                    gameState.enemiesDefeated.werewolfGuard = true;
                    playSound('success');
                    return "You defeat Fenrir the werewolf guard! Cerberus the beast hound howls in rage.";
                }
            },
            98: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 112, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.enemiesDefeated.valerius = true; // Crystal destroyed, Valerius weakened
                        return "You reach the power crystal and shatter it with a single blow! Valerius screams as his power diminishes. 'NO! My power!' He's significantly weakened now!";
                    } else {
                        const damage = rollDice(3, 10);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "Valerius intercepts you and strikes you for " + damage + " damage!";
                    }
                }
            },
            99: {
                text: "You attack Valerius directly, ignoring his minions!",
                choices: [
                    {text: "Fight Valerius", nextSection: 113, skillCheck: false}
                ],
                action: function() {
                    // Valerius is powerful, but fighting him directly is possible
                    combatState.active = true;
                    combatState.enemyName = "Valerius Vorlak";
                    combatState.enemyHealth = 200;
                    combatState.enemyCurrentHealth = 200;
                    combatState.enemyStrength = 22;
                    combatState.enemyDamageDice = 5;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 114;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    combatState.isValerius = true;
                    combatState.valeriusPhase = 1;
                    
                    playSound('valerius');
                    return "<span class='valerius'>Valerius Vorlak</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            100: {
                text: "You throw Holy Water at Valerius and his minions! They scream as it burns them.",
                choices: [
                    {text: "Continue the attack", nextSection: 115, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Holy Water');
                    const damage = rollDice(4, 12) + 25;
                    // Damage all enemies
                    playSound('combat');
                    return "The Holy Water deals " + damage + " damage to Valerius and his minions! They're significantly weakened.";
                }
            },
            101: {
                text: "You hold up the Sun Amulet. It glows with blinding sunlight, causing Valerius and his minions to recoil in pain!",
                choices: [
                    {text: "Continue the attack", nextSection: 116, skillCheck: false}
                ],
                action: function() {
                    const damage = rollDice(3, 10) + 20;
                    playSound('combat');
                    return "The Sun Amulet deals " + damage + " damage to Valerius and his minions! They're weakened by the sunlight energy.";
                }
            },
            102: {
                text: "You attack with your silver weapons! They're especially effective against the werewolf.",
                choices: [
                    {text: "Continue the attack", nextSection: 117, skillCheck: false}
                ],
                action: function() {
                    const damage = rollDice(3, 8) + 15;
                    playSound('combat');
                    return "Your silver weapons deal " + damage + " damage to the werewolf guard! It howls in pain.";
                }
            },
            103: {
                text: "You fill your pockets with as much treasure as you can carry.",
                choices: [
                    {text: "Face Valerius", nextSection: 118, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(50, 100);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You take <span class='gold'>" + goldFound + " Gold</span> and several valuable jewels! You're now incredibly wealthy.";
                }
            },
            104: {
                text: "You search for specific powerful artifacts. Among the treasure, you find a few items of particular value.",
                choices: [
                    {text: "Take the artifacts", nextSection: 119, skillCheck: false},
                    {text: "Take gold instead", nextSection: 103, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "You find several powerful magical artifacts that could be useful.";
                }
            },
            105: {
                text: "You take only what you can practically carry - some gold and a few small jewels.",
                choices: [
                    {text: "Face Valerius", nextSection: 118, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(20, 50);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You take <span class='gold'>" + goldFound + " Gold</span> and a few valuable items.";
                }
            },
            106: {
                text: "You leave the vault without taking anything. The final battle is more important than treasure.",
                choices: [
                    {text: "Face Valerius", nextSection: 118, skillCheck: false}
                ],
                action: function() {
                    playSound('valerius');
                    return "You return to face Valerius, treasure forgotten. The real prize is ending his reign.";
                }
            },
            107: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 120, skillCheck: false}
                ]
            },
            108: {
                text: "With Valerius's minions defeated, only the vampire lord himself remains. He looks at their bodies with disdain. 'Useless creatures. I'll have to deal with you myself.'",
                choices: [
                    {text: "Fight Valerius", nextSection: 121, skillCheck: false}
                ],
                action: function() {
                    gameState.enemiesDefeated.werewolfGuard = true;
                    gameState.enemiesDefeated.beastHound = true;
                    playSound('valerius');
                    return "<span class='valerius'>Valerius</span>: 'You've defeated my guards. Impressive. But now you face ME.'";
                }
            },
            109: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 96, skillCheck: false}
                ]
            },
            110: {
                text: "You attack Cerberus, the three-headed beast hound! It snarls and all three heads prepare to bite.",
                choices: [
                    {text: "Fight Cerberus", nextSection: 122, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Cerberus the Beast Hound";
                    combatState.enemyHealth = 80;
                    combatState.enemyCurrentHealth = 80;
                    combatState.enemyStrength = 16;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 123;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('hound');
                    return "<span class='hound'>Cerberus the Beast Hound</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            111: {
                text: "You attack Valerius directly while Cerberus is still alive! This is risky - you'll have to fight both at once.",
                choices: [
                    {text: "Fight Valerius and Cerberus", nextSection: 124, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Valerius & Cerberus";
                    combatState.enemyHealth = 250;
                    combatState.enemyCurrentHealth = 250;
                    combatState.enemyStrength = 20;
                    combatState.enemyDamageDice = 5;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 125;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 2;
                    combatState.isValerius = true;
                    combatState.valeriusPhase = 1;
                    
                    playSound('valerius');
                    playSound('hound');
                    return "<span class='valerius'>Valerius</span> and <span class='hound'>Cerberus</span>: Combined Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            112: {
                text: "With the power crystal destroyed, Valerius is significantly weakened. He staggers, his dark power diminished.",
                choices: [
                    {text: "Attack the weakened Valerius", nextSection: 126, skillCheck: false}
                ],
                action: function() {
                    playSound('valerius');
                    return "<span class='valerius'>Valerius</span>: 'You... you dare! I'll still destroy you!'";
                }
            },
            113: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 127, skillCheck: false}
                ]
            },
            114: {
                text: "You've been fighting Valerius directly!",
                choices: [
                    {text: "Continue the fight!", nextSection: 128, skillCheck: false}
                ],
                action: function() {
                    // Check if Valerius is defeated
                    if (combatState.enemyCurrentHealth <= 0) {
                        endCombatVictoryValerius();
                        return "";
                    }
                    
                    // Valerius phase check
                    if (combatState.enemyCurrentHealth <= 100 && combatState.valeriusPhase === 1) {
                        combatState.valeriusPhase = 2;
                        playSound('valerius');
                        return "<span class='valerius'>Valerius</span>: 'Enough! I'll show you my true power!' He transforms, growing larger and more monstrous!";
                    }
                    
                    if (combatState.enemyCurrentHealth <= 40 && combatState.valeriusPhase === 2) {
                        combatState.valeriusPhase = 3;
                        playSound('valerius');
                        return "<span class='valerius'>Valerius</span>: 'No! This cannot be! I am eternal!' He's desperate now, fighting for survival.";
                    }
                    
                    return "The battle with Valerius continues...";
                }
            },
            115: {
                text: "After using Holy Water, the battle continues.",
                choices: [
                    {text: "Fight Valerius and his minions", nextSection: 95, skillCheck: false}
                ]
            },
            116: {
                text: "After using the Sun Amulet, the battle continues.",
                choices: [
                    {text: "Fight Valerius and his minions", nextSection: 95, skillCheck: false}
                ]
            },
            117: {
                text: "After using silver weapons, the battle continues.",
                choices: [
                    {text: "Fight Valerius and his minions", nextSection: 95, skillCheck: false}
                ]
            },
            118: {
                text: "You return from the vault to face Valerius.",
                choices: [
                    {text: "Confront Valerius", nextSection: 89, skillCheck: false}
                ]
            },
            119: {
                text: "You take powerful artifacts from the vault.",
                choices: [
                    {text: "Face Valerius", nextSection: 118, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Amulet of Vitality');
                    addToInventory('Ring of Power');
                    playSound('item');
                    return "You take an <span class='item'>Amulet of Vitality</span> and a <span class='item'>Ring of Power</span>. These will help in the final battle.";
                }
            },
            120: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 107, skillCheck: false}
                ]
            },
            121: {
                text: "Valerius prepares for battle. Dark energy crackles around him.",
                choices: [
                    {text: "Fight Valerius", nextSection: 129, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Valerius Vorlak";
                    combatState.enemyHealth = 200;
                    combatState.enemyCurrentHealth = 200;
                    combatState.enemyStrength = 22;
                    combatState.enemyDamageDice = 5;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 130;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    combatState.isValerius = true;
                    combatState.valeriusPhase = 1;
                    
                    playSound('valerius');
                    return "<span class='valerius'>Valerius Vorlak</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            122: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 131, skillCheck: false}
                ]
            },
            123: {
                text: "With Cerberus defeated, only Valerius remains. The vampire lord looks at his dead pet with anger.",
                choices: [
                    {text: "Fight Valerius", nextSection: 121, skillCheck: false}
                ],
                action: function() {
                    gameState.enemiesDefeated.beastHound = true;
                    playSound('valerius');
                    return "<span class='valerius'>Valerius</span>: 'You killed my faithful hound. For that, you will suffer.'";
                }
            },
            124: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 132, skillCheck: false}
                ]
            },
            125: {
                text: "You've been fighting both Valerius and Cerberus!",
                choices: [
                    {text: "Continue the fight!", nextSection: 133, skillCheck: false}
                ],
                action: function() {
                    // Check if enemies are defeated
                    if (combatState.enemyCurrentHealth <= 0) {
                        endCombatVictoryValerius();
                        return "";
                    }
                    
                    return "The battle with Valerius and Cerberus continues...";
                }
            },
            126: {
                text: "With his power crystal destroyed, Valerius is vulnerable. He's still dangerous, but much weaker than before.",
                choices: [
                    {text: "Fight the weakened Valerius", nextSection: 134, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Weakened Valerius";
                    combatState.enemyHealth = 120;
                    combatState.enemyCurrentHealth = 120;
                    combatState.enemyStrength = 18;
                    combatState.enemyDamageDice = 4;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 135;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    combatState.isValerius = true;
                    combatState.valeriusPhase = 1;
                    
                    playSound('valerius');
                    return "<span class='valerius'>Weakened Valerius</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            127: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 113, skillCheck: false}
                ]
            },
            128: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 114, skillCheck: false}
                ]
            },
            129: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 136, skillCheck: false}
                ]
            },
            130: {
                text: "You've been fighting Valerius!",
                choices: [
                    {text: "Continue the fight!", nextSection: 137, skillCheck: false}
                ],
                action: function() {
                    // Check if Valerius is defeated
                    if (combatState.enemyCurrentHealth <= 0) {
                        endCombatVictoryValerius();
                        return "";
                    }
                    
                    // Valerius phase check
                    if (combatState.enemyCurrentHealth <= 100 && combatState.valeriusPhase === 1) {
                        combatState.valeriusPhase = 2;
                        playSound('valerius');
                        return "<span class='valerius'>Valerius</span>: 'Enough! I'll show you my true power!' He transforms, growing larger and more monstrous!";
                    }
                    
                    if (combatState.enemyCurrentHealth <= 40 && combatState.valeriusPhase === 2) {
                        combatState.valeriusPhase = 3;
                        playSound('valerius');
                        return "<span class='valerius'>Valerius</span>: 'No! This cannot be! I am eternal!' He's desperate now, fighting for survival.";
                    }
                    
                    return "The battle with Valerius continues...";
                }
            },
            131: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 122, skillCheck: false}
                ]
            },
            132: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 124, skillCheck: false}
                ]
            },
            133: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 125, skillCheck: false}
                ]
            },
            134: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 138, skillCheck: false}
                ]
            },
            135: {
                text: "You've been fighting the weakened Valerius!",
                choices: [
                    {text: "Continue the fight!", nextSection: 139, skillCheck: false}
                ],
                action: function() {
                    // Check if Valerius is defeated
                    if (combatState.enemyCurrentHealth <= 0) {
                        endCombatVictoryValerius();
                        return "";
                    }
                    
                    return "The battle with the weakened Valerius continues...";
                }
            },
            136: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 129, skillCheck: false}
                ]
            },
            137: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 130, skillCheck: false}
                ]
            },
            138: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 134, skillCheck: false}
                ]
            },
            139: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 135, skillCheck: false}
                ]
            }
        };
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in combat
            if (!combatState.active || sectionId === 95 || sectionId === 108 || sectionId === 121 || sectionId === 126) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    if (typeof choice.requirement === 'function') {
                        return choice.requirement();
                    }
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                let weaponType = gameState.equippedWeapon;
                
                // Special weapon bonuses
                if (weaponType.includes('Silver') || weaponType.includes('Holy')) {
                    // Silver/Holy weapons deal extra damage to vampires/werewolves
                    damage = rollDice(3, 6) + 5;
                    if (combatState.enemyName.includes('Vampire') || combatState.enemyName.includes('Werewolf') || combatState.enemyName.includes('Valerius')) {
                        damage += 10; // Extra vs vampires
                        resultText += `<span class="item">Your ${weaponType} is especially effective!</span><br>`;
                    }
                } else if (weaponType === 'Holy Sword of Light') {
                    damage = rollDice(4, 8) + 10; // Very powerful against darkness
                    if (combatState.enemyName.includes('Vampire') || combatState.enemyName.includes('Valerius') || combatState.enemyName.includes('Ghost')) {
                        damage += 15;
                        resultText += `<span class="item">The holy sword blazes with divine power!</span><br>`;
                    }
                } else if (weaponType.includes('Mace') || weaponType.includes('Sword')) {
                    damage = rollDice(2, 8) + 3;
                } else {
                    damage = rollDice(2, 6);
                }
                
                // Special enemy vulnerabilities
                if (combatState.enemyName.includes('Vampire') && gameState.hasHolyWater) {
                    damage += 5;
                    resultText += `<span class="item">Holy water burns the vampire!</span><br>`;
                }
                
                if (combatState.enemyName.includes('Werewolf') && gameState.hasSilverWeapon) {
                    damage += 8;
                    resultText += `<span class="item">Silver hurts the werewolf!</span><br>`;
                }
                
                if (combatState.enemyName.includes('Valerius') && gameState.hasSunAmulet) {
                    damage += 10;
                    resultText += `<span class="item">The Sun Amulet weakens Valerius!</span><br>`;
                }
                
                // Dragon Scale Armor might provide combat bonus
                if (gameState.equippedArmor === 'Dragon Scale Armor') {
                    damage += 5;
                    resultText += `<span class="item">Your dragon scale armor enhances your attacks!</span><br>`;
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                // Check for Valerius phase change
                if (combatState.isValerius) {
                    if (combatState.enemyCurrentHealth <= 100 && combatState.valeriusPhase === 1) {
                        resultText += `<br><span class="valerius">Valerius transforms, growing more powerful!</span>`;
                        combatState.valeriusPhase = 2;
                        combatState.enemyStrength = 25; // Stronger in phase 2
                    } else if (combatState.enemyCurrentHealth <= 40 && combatState.valeriusPhase === 2) {
                        resultText += `<br><span class="valerius">Valerius is desperate now!</span>`;
                        combatState.valeriusPhase = 3;
                        combatState.enemyStrength = 28; // Even stronger when desperate
                    }
                }
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                let enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                
                // Group enemies attack together
                if (combatState.isGroup && combatState.groupCount > 1) {
                    enemyDamage += Math.floor(combatState.groupCount * 2); // Extra damage for group
                    resultText += `The enemies attack together!<br>`;
                }
                
                // Valerius special attacks
                if (combatState.enemyName.includes('Valerius')) {
                    if (combatState.valeriusPhase === 2) {
                        enemyDamage += rollDice(2, 10); // Extra damage in phase 2
                        resultText += `Valerius's transformed form strikes with terrible force!<br>`;
                    } else if (combatState.valeriusPhase === 3) {
                        enemyDamage += rollDice(3, 10); // Even more damage when desperate
                        resultText += `Valerius fights desperately for survival!<br>`;
                    }
                    
                    // Life drain
                    if (Math.random() > 0.7) {
                        const drain = rollDice(1, 8);
                        enemyDamage += drain;
                        gameState.health -= drain; // Extra damage that bypasses armor
                        resultText += `Valerius drains your life force for ${drain} extra damage!<br>`;
                    }
                }
                
                // Werewolf special attack
                if (combatState.enemyName.includes('Werewolf')) {
                    if (Math.random() > 0.7) {
                        enemyDamage += rollDice(2, 6); // Extra savage attack
                        resultText += `The werewolf attacks savagely!<br>`;
                    }
                }
                
                // Beast hound special attack
                if (combatState.enemyName.includes('Cerberus') || combatState.enemyName.includes('Hound')) {
                    if (Math.random() > 0.7) {
                        enemyDamage += rollDice(1, 8); // Multiple heads attack
                        resultText += `All three heads of the beast bite at once!<br>`;
                    }
                }
                
                // Armor protection
                let finalDamage = enemyDamage;
                if (gameState.equippedArmor === 'Dragon Scale Armor') {
                    finalDamage = Math.max(1, Math.floor(enemyDamage * 0.6)); // 40% damage reduction
                    resultText += `<span class="item">Your dragon scale armor absorbs some damage!</span><br>`;
                } else if (gameState.equippedArmor.includes('Armor')) {
                    finalDamage = Math.max(1, Math.floor(enemyDamage * 0.8)); // 20% damage reduction
                }
                
                gameState.health -= finalDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${finalDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('castleUndeadGameState');
                        window.location.href = 'l1.html';
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Enemy attack (for when player uses item in combat)
        function enemyAttack() {
            const combatResult = executeCombatRound();
            document.getElementById('story-text').innerHTML += combatResult;
            
            // Check if combat is over
            if (!combatState.active) {
                // Combat ended
                if (combatState.enemyName.includes('Valerius')) {
                    endCombatVictoryValerius();
                } else {
                    endCombatVictory();
                }
            }
        }
        
        // End combat with victory (for non-Valerius enemies)
        function endCombatVictory() {
            let goldReward = 0;
            
            if (combatState.enemyName.includes('Lysandra') || combatState.enemyName.includes('Vampire')) {
                goldReward = Math.floor(Math.random() * 100) + 50;
                gameState.enemiesDefeated.vampireBride = true;
            } else if (combatState.enemyName.includes('Werewolf')) {
                goldReward = Math.floor(Math.random() * 80) + 40;
                gameState.enemiesDefeated.werewolfGuard = true;
            } else if (combatState.enemyName.includes('Cerberus') || combatState.enemyName.includes('Hound')) {
                goldReward = Math.floor(Math.random() * 70) + 35;
                gameState.enemiesDefeated.beastHound = true;
            } else if (combatState.enemyName.includes('Ghost') || combatState.enemyName.includes('Alistair')) {
                goldReward = Math.floor(Math.random() * 90) + 45;
                gameState.enemiesDefeated.ghostKnight = true;
            }
            
            gameState.gold += goldReward;
            updateStatsDisplay();
            
            document.getElementById('story-text').innerHTML += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
            
            if (goldReward > 0) {
                document.getElementById('story-text').innerHTML += `<br>You find <span class="gold">${goldReward} Gold</span>.`;
            }
            
            // Clear choice buttons - combat is over
            document.getElementById('choice-buttons').innerHTML = '';
            
            // Auto-continue to next section after combat
            setTimeout(() => {
                loadSection(combatState.nextSection);
            }, 2000);
        }
        
        // End combat with victory over Valerius
        function endCombatVictoryValerius() {
            gameState.enemiesDefeated.valerius = true;
            gameState.gameComplete = true;
            
            const goldReward = Math.floor(Math.random() * 500) + 500;
            gameState.gold += goldReward;
            updateStatsDisplay();
            
            playSound('victory');
            
            document.getElementById('story-text').innerHTML += `<br><br><div class="gold-animation"><span class="victory">YOU HAVE DEFEATED VALERIUS VORLAK!</span></div>`;
            document.getElementById('story-text').innerHTML += `<br>You find <span class="gold">${goldReward} Gold</span> in Valerius's personal treasury.`;
            
            // Clear choice buttons
            document.getElementById('choice-buttons').innerHTML = '';
            
            // Show victory screen after delay
            setTimeout(() => {
                showVictoryScreen();
            }, 3000);
        }
        
        // Show victory screen
        function showVictoryScreen() {
            // Update victory screen stats
            document.getElementById('victory-stat-strength').textContent = gameState.strength;
            document.getElementById('victory-stat-health').textContent = gameState.health;
            document.getElementById('victory-stat-agility').textContent = gameState.agility;
            document.getElementById('victory-stat-gold').textContent = gameState.gold;
            
            // Display final inventory
            const inventoryDisplay = document.getElementById('victory-inventory-display');
            inventoryDisplay.innerHTML = '';
            
            // Show equipped items
            const equippedDiv = document.createElement('div');
            equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
            inventoryDisplay.appendChild(equippedDiv);
            
            // Show other inventory
            if (gameState.inventory.length > 0) {
                const invDiv = document.createElement('div');
                invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                inventoryDisplay.appendChild(invDiv);
            }
            
            // Show rooms explored
            const roomsDiv = document.createElement('div');
            roomsDiv.innerHTML = `<strong>Rooms Explored:</strong> ${gameState.roomsExplored.length}/6`;
            inventoryDisplay.appendChild(roomsDiv);
            
            // Show enemies defeated
            let enemiesDefeatedCount = 0;
            for (const enemy in gameState.enemiesDefeated) {
                if (gameState.enemiesDefeated[enemy]) enemiesDefeatedCount++;
            }
            const enemiesDiv = document.createElement('div');
            enemiesDiv.innerHTML = `<strong>Enemies Defeated:</strong> ${enemiesDefeatedCount}/5`;
            inventoryDisplay.appendChild(enemiesDiv);
            
            playSound('final');
            showScreen('screen-victory');
            
            // Save completed game state
            saveGame();
        }
        
        // Complete the game
        function completeGame() {
            playSound('victory');
            alert("CONGRATULATIONS! You have completed CASTLE OF THE UNDEAD!\n\nYour final stats:\nStrength: " + gameState.strength + "\nHealth: " + gameState.health + "\nAgility: " + gameState.agility + "\nGold: " + gameState.gold + "\n\nThank you for playing!");
            
            // Clear save game
            localStorage.removeItem('castleUndeadGameState');
            
            // Optionally redirect to start or show credits
            window.location.href = 'l1.html';
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You dodge an attack!",
                    "You move silently past an enemy.",
                    "You climb a difficult obstacle.",
                    "You slip through a narrow passage."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip and take 5 damage!",
                    "You make noise and alert nearby enemies.",
                    "You get tangled in something.",
                    "You knock something over, making noise."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 5;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 10 (this page)
                if (savedState.level === 10) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 10.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
