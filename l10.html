<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASTLE OF THE UNDEAD - Level 10: The Master Quarters</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Royal Purple/Black/Gold theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(80, 0, 80, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(80, 0, 80, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #cc00ff;
            background-color: #000;
            box-shadow: 0 0 20px rgba(204, 0, 255, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(80, 0, 80, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #cc00ff;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #ff66ff;
            text-shadow: 0 0 5px #cc00ff;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #cc00ff;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #cc00ff;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #300;
            color: #ff6666;
            border-color: #ff6666;
        }
        
        .level-number.current {
            background-color: #cc00ff;
            color: #fff;
            border-color: #ff66ff;
            box-shadow: 0 0 8px #cc00ff;
            text-shadow: 0 0 2px #000;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #cc00ff;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #ff66ff;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #cc00ff;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #ff66ff;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #cc00ff;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #ff66ff;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff66ff;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #cc00ff;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #cc00ff;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #ff66ff;
            border-color: #ff66ff;
            box-shadow: 0 0 10px rgba(255, 102, 255, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #cc00ff;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #ff66ff;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #cc00ff;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #ff66ff;
            border-color: #ff66ff;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #330033;
            border: 1px solid #cc00ff;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ff66ff;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #440044;
            border: 1px solid #ff66ff;
            padding: 10px;
            margin: 10px 0;
            color: #ff66ff;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .victory {
            color: #6ff;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #6ff;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #8ff;
            font-weight: bold;
        }
        
        .weapon {
            color: #f96;
            font-weight: bold;
        }
        
        .armor {
            color: #9cf;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .vampire-lord {
            color: #f00;
            font-weight: bold;
            text-shadow: 0 0 5px #f00;
            font-size: 18px;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        .servant {
            color: #af9;
            font-weight: bold;
        }
        
        .ghost {
            color: #8ff;
            font-weight: bold;
        }
        
        .vampire-bride {
            color: #f6f;
            font-weight: bold;
        }
        
        .werewolf {
            color: #c96;
            font-weight: bold;
        }
        
        .beast {
            color: #a62;
            font-weight: bold;
        }
        
        .silver {
            color: #ccc;
            font-weight: bold;
        }
        
        .holy {
            color: #ff0;
            font-weight: bold;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #cc00ff;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #cc00ff;
            color: #fff;
            border-color: #ff66ff;
            box-shadow: 0 0 15px #cc00ff;
        }
        
        /* Map Display */
        .quarters-map {
            background-color: #330033;
            border: 1px solid #cc00ff;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.8;
            color: #ff66ff;
        }
        
        .map-row {
            display: flex;
            justify-content: center;
        }
        
        .map-cell {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #660066;
            margin: 1px;
        }
        
        .map-cell.player {
            background-color: #ff66ff;
            color: #000;
        }
        
        .map-cell.room {
            background-color: #330033;
        }
        
        .map-cell.explored {
            background-color: #220022;
        }
        
        .map-cell.throne {
            background-color: #ff0;
            color: #000;
        }
        
        .map-cell.vault {
            background-color: #ff9900;
            color: #000;
        }
        
        /* Final Battle Animation */
        .final-battle {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #330033;
            border: 1px solid #cc00ff;
            animation: pulse-purple 2s infinite;
        }
        
        @keyframes pulse-purple {
            0% { border-color: #cc00ff; }
            50% { border-color: #ff66ff; }
            100% { border-color: #cc00ff; }
        }
        
        /* Victory Screen */
        .victory-screen {
            text-align: center;
            padding: 30px;
            background-color: #000;
            border: 3px solid #6ff;
            box-shadow: 0 0 20px #6ff;
            animation: pulse-blue 3s infinite;
        }
        
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 10px #6ff; }
            50% { box-shadow: 0 0 30px #6ff; }
            100% { box-shadow: 0 0 10px #6ff; }
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #cc00ff;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #cc00ff;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #ff66ff;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CASTLE OF THE UNDEAD</h1>
            <h2>LEVEL 10: THE MASTER QUARTERS</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number completed">2</div>
            <div class="level-number completed">3</div>
            <div class="level-number completed">4</div>
            <div class="level-number completed">5</div>
            <div class="level-number completed">6</div>
            <div class="level-number completed">7</div>
            <div class="level-number completed">8</div>
            <div class="level-number completed">9</div>
            <div class="level-number current">10</div>
        </div>
        
        <!-- Level Intro Screen -->
        <div id="screen-intro" class="screen active-screen">
            <h2>THE MASTER QUARTERS</h2>
            <div class="story-text">
                <p>The grand staircase from the dungeon leads up to a pair of massive, ornate doors. This is it - Valerius's personal quarters. The air here is cold, heavy with ancient power and the scent of aged wine and dried blood.</p>
                <p>Before you stands the entrance to the Master Quarters. From behind the doors, you can hear faint strains of haunting music and sense powerful energies at work. This is where Valerius Vorlak, the Vampire Lord, has ruled for centuries.</p>
                <p>You must navigate his private chambers, face his most powerful guardians, and finally confront the Vampire Lord himself. The fate of the realm rests on this final confrontation.</p>
                <p>Choose your path carefully. Each room may hold treasures to aid you, or deadly traps and enemies.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="intro-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="intro-stat-health" class="stat-value">0</span>/<span id="intro-stat-maxhealth" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="intro-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="intro-stat-gold" class="stat-value">0</span></div>
                </div>
                
                <div class="quarters-map">
                    <div class="map-row">
                        <div class="map-cell throne">T</div>
                        <div class="map-cell room">?</div>
                        <div class="map-cell room">?</div>
                    </div>
                    <div class="map-row">
                        <div class="map-cell room">?</div>
                        <div class="map-cell player">P</div>
                        <div class="map-cell room">?</div>
                    </div>
                    <div class="map-row">
                        <div class="map-cell room">?</div>
                        <div class="map-cell vault">V</div>
                        <div class="map-cell room">?</div>
                    </div>
                    <p><strong>Map Key:</strong> <span style="color:#ff66ff">■</span> = Your Position | <span style="color:#ff0">■</span> = Throne Room | <span style="color:#ff9900">■</span> = Vault | <span style="color:#220022">■</span> = Unexplored Room</p>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="startLevel10()">ENTER THE MASTER QUARTERS</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>VALERIUS'S MASTER QUARTERS</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="showMap()">SHOW MAP</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
            </div>
        </div>
        
        <!-- Map Screen -->
        <div id="screen-map" class="screen">
            <h2>MASTER QUARTERS MAP</h2>
            <div class="story-text">
                <p>You are in the Master Quarters of Castle Vorlak. Each room may contain valuable items, deadly enemies, or clues to defeating Valerius.</p>
                
                <div class="quarters-map" id="quarters-map">
                    <!-- Map will be generated here -->
                </div>
                
                <p><strong>Key:</strong> <span style="color:#ff66ff">■</span> = Your Position | <span style="color:#ff0">■</span> = Throne Room | <span style="color:#ff9900">■</span> = Vault Room | <span style="color:#330033">■</span> = Explored Room | <span style="color:#220022">■</span> = Unexplored Room</p>
                <p>You've explored <span id="explored-percent">0</span>% of the Master Quarters.</p>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="closeMap()">RETURN TO QUARTERS</button>
            </div>
        </div>
        
        <!-- Final Battle Screen -->
        <div id="screen-battle" class="screen">
            <h2>FINAL BATTLE: VAMPIRE LORD VALERIUS</h2>
            <div class="story-text" id="battle-text">
                <!-- Battle content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="battle-choices">
                <!-- Battle choices will be inserted here -->
            </div>
        </div>
        
        <!-- Victory Screen -->
        <div id="screen-victory" class="screen">
            <div class="victory-screen">
                <h2 class="victory">VICTORY!</h2>
                <div class="story-text">
                    <p>You have defeated <span class="vampire-lord">VAMPIRE LORD VALERIUS VORLAK</span>!</p>
                    <p>The ancient vampire lord crumbles to dust before your eyes, his dark power dissipating into the air. With his destruction, the curse over Castle Vorlak begins to lift.</p>
                    <p>The unnatural darkness recedes, and for the first time in centuries, sunlight begins to filter through the stained glass windows of the throne room.</p>
                    <p>You have accomplished what countless others failed to do. The reign of terror is over. The land will slowly heal from the vampire's curse.</p>
                    
                    <div class="final-battle">
                        <p><strong>FINAL STATS:</strong></p>
                        <div class="stats-bar">
                            <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="victory-stat-strength" class="stat-value">0</span></div>
                            <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="victory-stat-health" class="stat-value">0</span>/<span id="victory-stat-maxhealth" class="stat-value">0</span></div>
                            <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="victory-stat-agility" class="stat-value">0</span></div>
                            <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="victory-stat-gold" class="stat-value">0</span></div>
                        </div>
                    </div>
                    
                    <p><strong>FINAL INVENTORY:</strong></p>
                    <div class="inventory-container">
                        <div id="victory-inventory-display"></div>
                    </div>
                    
                    <p>Your name will be remembered in legends as the one who defeated the Vampire Lord!</p>
                </div>
                
                <div class="next-level">
                    <button class="next-level-btn" onclick="completeGame()">THE END - RETURN TO MAIN MENU</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE UNDEAD - A Retro Vampire Hunt Adventure<br>
            Level 10: The Master Quarters - FINAL LEVEL
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects for final level
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'victory':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    setTimeout(() => playBeep(1300, 0.3, 'sine'), 500);
                    break;
                case 'vampire':
                    playBeep(300, 0.3, 'sawtooth');
                    setTimeout(() => playBeep(200, 0.3, 'sawtooth'), 300);
                    break;
                case 'werewolf':
                    playBeep(150, 0.4, 'square');
                    break;
                case 'ghost':
                    playBeep(800, 0.5, 'sine');
                    break;
                case 'silver':
                    playBeep(1000, 0.2, 'triangle');
                    break;
                case 'holy':
                    playBeep(1200, 0.3, 'sine');
                    break;
                case 'final-battle':
                    playBeep(200, 0.2, 'sawtooth');
                    setTimeout(() => playBeep(150, 0.3, 'sawtooth'), 200);
                    setTimeout(() => playBeep(100, 0.4, 'sawtooth'), 500);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - loaded from Level 9
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Rusty Sword',
            equippedArmor: 'Leather Armor',
            currentSection: 1,
            gameComplete: false,
            level: 10,
            // Level 10 specific flags
            exploredRooms: [],
            currentRoom: 'entrance',
            rooms: {
                'entrance': { explored: true },
                'grandHall': { explored: false },
                'library': { explored: false },
                'study': { explored: false },
                'observatory': { explored: false },
                'masterBedroom': { explored: false },
                'vault': { explored: false },
                'throneRoom': { explored: false }
            },
            // Enemies defeated
            werewolfGuardDefeated: false,
            vampireBrideDefeated: false,
            beastHoundsDefeated: false,
            ghostKnightEncountered: false,
            servantMaidHelped: false,
            // Items found
            hasSilverSword: false,
            hasHolyWater: false,
            hasVampireKillingStake: false,
            hasThrowingSilverDaggers: false,
            hasAncientWardAmulet: false,
            hasObsidianArmor: false,
            // Final battle state
            valeriusPhase: 1,
            valeriusHealth: 200,
            valeriusMaxHealth: 200,
            valeriusStrength: 25,
            usedSilverSword: false,
            usedHolyWater: false,
            usedStake: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            isGroup: false,
            groupCount: 0,
            isValerius: false
        };
        
        // Map layout
        const quartersMap = {
            '1,1': 'throneRoom',
            '1,2': 'observatory',
            '1,3': 'vault',
            '2,1': 'study',
            '2,2': 'grandHall',
            '2,3': 'masterBedroom',
            '3,1': 'library',
            '3,2': 'entrance',
            '3,3': 'secret'
        };
        
        // Initialize game for Level 10
        function initGame() {
            // Load game state from Level 9
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 10 (coming from Level 9)
                if (savedState.level === 10) {
                    Object.assign(gameState, savedState);
                    
                    // Update intro screen with loaded stats
                    document.getElementById('intro-stat-strength').textContent = gameState.strength;
                    document.getElementById('intro-stat-health').textContent = gameState.health;
                    document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('intro-stat-agility').textContent = gameState.agility;
                    document.getElementById('intro-stat-gold').textContent = gameState.gold;
                    
                    showScreen('screen-intro');
                    return;
                } else if (savedState.level === 9) {
                    // If coming directly from Level 9 without completing it
                    alert("You must complete Level 9 first!");
                    window.location.href = 'l9.html';
                    return;
                } else {
                    // If no valid save, start from beginning
                    alert("No valid saved game found. Starting from Level 1.");
                    window.location.href = 'l1.html';
                    return;
                }
            } else {
                // No saved game found
                alert("No saved game found. Starting from Level 1.");
                window.location.href = 'l1.html';
                return;
            }
        }
        
        function startLevel10() {
            playSound('click');
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item) && item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Equip weapon
        function equipWeapon(weapon) {
            // Add old weapon to inventory if not default
            if (gameState.equippedWeapon !== 'Rusty Sword' && gameState.equippedWeapon !== 'Fists') {
                addToInventory(gameState.equippedWeapon);
            }
            gameState.equippedWeapon = weapon;
            updateInventoryDisplay();
        }
        
        // Equip armor
        function equipArmor(armor) {
            // Add old armor to inventory if not default
            if (gameState.equippedArmor !== 'Leather Armor' && gameState.equippedArmor !== 'Clothes') {
                addToInventory(gameState.equippedArmor);
            }
            gameState.equippedArmor = armor;
            updateInventoryDisplay();
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='weapon'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='armor'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Show map
        function showMap() {
            playSound('click');
            
            // Update explored percentage
            const totalRooms = 9; // 3x3 grid
            let exploredRooms = 0;
            for (const room in gameState.rooms) {
                if (gameState.rooms[room].explored) exploredRooms++;
            }
            const exploredPercent = Math.round((exploredRooms / totalRooms) * 100);
            document.getElementById('explored-percent').textContent = exploredPercent;
            
            // Generate map display
            const mapDiv = document.getElementById('quarters-map');
            mapDiv.innerHTML = '';
            
            for (let y = 1; y <= 3; y++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'map-row';
                
                for (let x = 1; x <= 3; x++) {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'map-cell';
                    
                    const roomKey = `${x},${y}`;
                    const roomName = quartersMap[roomKey];
                    
                    // Check if this is current room
                    if (gameState.currentRoom === roomName) {
                        cellDiv.className += ' player';
                        cellDiv.textContent = 'P';
                    }
                    // Check room type
                    else if (roomName === 'throneRoom') {
                        cellDiv.className += ' throne';
                        cellDiv.textContent = 'T';
                    } else if (roomName === 'vault') {
                        cellDiv.className += ' vault';
                        cellDiv.textContent = 'V';
                    } else if (roomName && gameState.rooms[roomName] && gameState.rooms[roomName].explored) {
                        cellDiv.className += ' explored';
                        cellDiv.textContent = roomName.charAt(0).toUpperCase();
                    } else {
                        cellDiv.className += ' room';
                        cellDiv.textContent = '?';
                    }
                    
                    rowDiv.appendChild(cellDiv);
                }
                
                mapDiv.appendChild(rowDiv);
            }
            
            showScreen('screen-map');
        }
        
        function closeMap() {
            playSound('click');
            showScreen('screen-game');
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Potion' || item === 'Mountain Potion' || item === 'Ancient Vampire Wine' || item === 'Vial of Magical Water') {
                const healAmount = item === 'Mountain Potion' ? rollDice(3, 6) + 10 : 
                                 item === 'Ancient Vampire Wine' ? rollDice(2, 8) + 5 : 
                                 item === 'Vial of Magical Water' ? rollDice(2, 6) : rollDice(2, 6) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Holy Water' || item === 'Blessed Holy Water') {
                message = "The <span class='holy'>Holy Water</span> is blessed and could harm undead, vampires, or dark artifacts.";
            } else if (item === 'Silver Sword' || item === 'Ancient Silver Sword') {
                message = "The <span class='silver'>Silver Sword</span> is especially effective against werewolves and vampires.";
            } else if (item === 'Vampire Killing Stake') {
                message = "The <span class='item'>Vampire Killing Stake</span> could be used to finish off a vampire lord if weakened.";
            } else if (item === 'Throwing Silver Daggers') {
                message = "The <span class='silver'>Throwing Silver Daggers</span> can be thrown from a distance, dealing silver damage.";
            } else if (item === 'Ancient Ward Amulet') {
                message = "The <span class='item'>Ancient Ward Amulet</span> provides protection against dark magic and vampire charms.";
            } else if (item === 'Obsidian Armor') {
                message = "The <span class='armor'>Obsidian Armor</span> provides excellent protection against physical and magical attacks.";
            } else if (item === 'Crystal Staff') {
                message = "The <span class='item'>Crystal Staff</span> is a powerful magical weapon.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Sword' && 
                gameState.equippedArmor === 'Leather Armor') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect - restore some health or find something
                if (Math.random() > 0.5) {
                    const heal = rollDice(1, 6);
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + heal);
                    updateStatsDisplay();
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">You catch your breath and restore ${heal} Health!</div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">You move silently and avoid detection!</div>`;
                }
            } else {
                playSound('failure');
                // Bad effect
                const damage = rollDice(1, 6);
                gameState.health -= damage;
                updateStatsDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You trip and take ${damage} damage!</div>`;
                playSound('damage');
                
                if (gameState.health <= 0) {
                    document.getElementById('story-text').innerHTML += `<div class="game-over">You have been defeated! Game Over.</div>`;
                    setTimeout(() => {
                        localStorage.removeItem('castleUndeadGameState');
                        window.location.href = 'l1.html';
                    }, 3000);
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Game story sections for Level 10
        const storySections = {
            1: {
                text: "You stand in the Grand Hall of Valerius's Master Quarters. The room is opulent beyond imagination, with velvet drapes, gold leaf trim, and crystal chandeliers. Four corridors lead from this central hall.",
                choices: [
                    {text: "Enter the Library (North)", nextSection: 2, skillCheck: false},
                    {text: "Enter the Study (East)", nextSection: 3, skillCheck: false},
                    {text: "Enter the Observatory (West)", nextSection: 4, skillCheck: false},
                    {text: "Ascend to the Throne Room (South)", nextSection: 5, skillCheck: false},
                    {text: "Check the Servants' Passage", nextSection: 6, skillCheck: true, checkType: 'agility', difficulty: 16}
                ],
                action: function() {
                    gameState.currentRoom = 'grandHall';
                    gameState.rooms.grandHall.explored = true;
                    return "The air hums with dark energy. You can feel Valerius's presence nearby.";
                }
            },
            2: {
                text: "The Library is vast, with shelves reaching three stories high. Ancient tomes line the walls. In the center of the room, a <span class='werewolf'>Werewolf Guard</span> stands watch, its yellow eyes fixed on you.",
                choices: [
                    {text: "Attack the Werewolf Guard", nextSection: 7, skillCheck: false},
                    {text: "Try to sneak past to search the shelves", nextSection: 8, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Attempt to reason with the creature", nextSection: 9, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.currentRoom = 'library';
                    gameState.rooms.library.explored = true;
                    playSound('werewolf');
                    return "<span class='werewolf'>Werewolf Guard</span> growls: 'None may pass without the master's permission!'";
                }
            },
            3: {
                text: "Valerius's Study is filled with maps, scrolls, and strange devices. A <span class='servant'>Servant Maid</span> is dusting a bookshelf. She looks human, but her eyes have a faint red glow.",
                choices: [
                    {text: "Question the servant maid", nextSection: 10, skillCheck: false},
                    {text: "Search the study for useful items", nextSection: 11, skillCheck: false},
                    {text: "Attack the servant", nextSection: 12, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.currentRoom = 'study';
                    gameState.rooms.study.explored = true;
                    return "The <span class='servant'>Servant Maid</span> looks at you with a mix of fear and curiosity.";
                }
            },
            4: {
                text: "The Observatory has a domed glass ceiling showing the starless night sky. Astronomical instruments fill the room. A <span class='ghost'>Cursed Ghost Knight</span> in tattered armor floats near a large telescope.",
                choices: [
                    {text: "Confront the Ghost Knight", nextSection: 13, skillCheck: false},
                    {text: "Examine the astronomical instruments", nextSection: 14, skillCheck: false},
                    {text: "Search for hidden items", nextSection: 15, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.currentRoom = 'observatory';
                    gameState.rooms.observatory.explored = true;
                    playSound('ghost');
                    return "The <span class='ghost'>Cursed Ghost Knight</span> turns toward you, its empty eye sockets glowing with pale light.";
                }
            },
            5: {
                text: "You approach the massive doors to the Throne Room. They are carved with scenes of vampiric conquest. Two <span class='beast'>Beast Hounds</span> with glowing red eyes guard the entrance.",
                choices: [
                    {text: "Fight the Beast Hounds", nextSection: 16, skillCheck: false},
                    {text: "Try to sneak past them", nextSection: 17, skillCheck: true, checkType: 'agility', difficulty: 20},
                    {text: "Use bait or food to distract them", nextSection: 18, skillCheck: false, requirement: function() { 
                        return gameState.inventory.some(item => item.includes('Meat') || item.includes('Food') || item.includes('Blood'));
                    }},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('werewolf');
                    return "The <span class='beast'>Beast Hounds</span> growl menacingly, their fangs dripping with saliva.";
                }
            },
            6: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip through a hidden servants' passage. It leads to the Master Bedroom!";
                    } else {
                        playSound('failure');
                        return "You can't find any hidden passages here.";
                    }
                }
            },
            7: {
                text: "You attack the Werewolf Guard! It transforms fully, muscles bulging and claws extending.",
                choices: [
                    {text: "Fight the Werewolf Guard", nextSection: 20, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Werewolf Guard";
                    combatState.enemyHealth = 80;
                    combatState.enemyCurrentHealth = 80;
                    combatState.enemyStrength = 18;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 21;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('werewolf');
                    return "<span class='werewolf'>Werewolf Guard</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            8: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 22, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.hasSilverSword = true;
                        equipWeapon('Silver Sword');
                        addToInventory('Ancient Tome of Vampire Weaknesses');
                        return "You sneak past the werewolf and find a <span class='silver'>Silver Sword</span> and an <span class='item'>Ancient Tome of Vampire Weaknesses</span>!";
                    } else {
                        // Werewolf notices
                        combatState.active = true;
                        combatState.enemyName = "Alerted Werewolf Guard";
                        combatState.enemyHealth = 70;
                        combatState.enemyCurrentHealth = 70;
                        combatState.enemyStrength = 16;
                        combatState.enemyDamageDice = 3;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 23;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('werewolf');
                        return "The werewolf notices you!<br><br><span class='werewolf'>Alerted Werewolf Guard</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            9: {
                text: "You try to reason with the werewolf. 'I mean no harm to you, only to Valerius,' you say. The creature snarls, 'The master saved me from execution. I owe him my loyalty.'",
                choices: [
                    {text: "Attack the werewolf", nextSection: 7, skillCheck: false},
                    {text: "Try to bribe it with gold", nextSection: 24, skillCheck: false},
                    {text: "Use silver if you have any", nextSection: 25, skillCheck: false, requirement: function() { 
                        return gameState.inventory.some(item => item.includes('Silver')) || gameState.equippedWeapon.includes('Silver');
                    }}
                ]
            },
            10: {
                text: "The servant maid looks at you with frightened eyes. 'Please, don't hurt me! I'm just a servant. Valerius keeps my family hostage in the village.'",
                choices: [
                    {text: "Ask about Valerius's weaknesses", nextSection: 26, skillCheck: false},
                    {text: "Ask about the layout of the quarters", nextSection: 27, skillCheck: false},
                    {text: "Offer to help her family if she helps you", nextSection: 28, skillCheck: false},
                    {text: "Attack her anyway", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    gameState.servantMaidHelped = true;
                    return "<span class='servant'>Servant Maid</span>: 'He... he rests in a coffin in the Master Bedroom during the day. But it's night now.'";
                }
            },
            11: {
                text: "You search the study while the servant watches nervously. In a drawer, you find a vial of clear liquid and a journal.",
                choices: [
                    {text: "Take the vial", nextSection: 29, skillCheck: false},
                    {text: "Take the journal", nextSection: 30, skillCheck: false},
                    {text: "Take both", nextSection: 31, skillCheck: false},
                    {text: "Leave them", nextSection: 32, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You also find <span class='gold'>" + goldFound + " Gold</span> in a secret compartment.";
                }
            },
            12: {
                text: "You attack the servant maid! She screams and transforms, revealing fangs and claws - she's a vampire thrall!",
                choices: [
                    {text: "Fight the Vampire Thrall", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Vampire Thrall Maid";
                    combatState.enemyHealth = 60;
                    combatState.enemyCurrentHealth = 60;
                    combatState.enemyStrength = 14;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 34;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('vampire');
                    return "<span class='vampire'>Vampire Thrall Maid</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            13: {
                text: "The Ghost Knight speaks in a hollow voice: 'Who dares disturb my eternal watch?'",
                choices: [
                    {text: "State your purpose", nextSection: 35, skillCheck: false},
                    {text: "Attack the ghost", nextSection: 36, skillCheck: false},
                    {text: "Ask about Valerius", nextSection: 37, skillCheck: false},
                    {text: "Try to free the ghost from its curse", nextSection: 38, skillCheck: false}
                ],
                action: function() {
                    gameState.ghostKnightEncountered = true;
                    playSound('ghost');
                    return "<span class='ghost'>Cursed Ghost Knight</span>: 'I am Sir Alistair, cursed to guard this observatory for eternity.'";
                }
            },
            14: {
                text: "You examine the astronomical instruments. They seem to be tracking celestial events. A chart shows an alignment happening tonight - a 'Blood Moon' that will amplify Valerius's power.",
                choices: [
                    {text: "Confront the Ghost Knight", nextSection: 13, skillCheck: false},
                    {text: "Search for hidden items", nextSection: 15, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Astronomical Chart');
                    playSound('item');
                    return "You take the <span class='item'>Astronomical Chart</span>. The Blood Moon rises in one hour!";
                }
            },
            15: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 39, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.hasThrowingSilverDaggers = true;
                        addToInventory('Throwing Silver Daggers');
                        addToInventory('Ancient Ward Amulet');
                        return "You find a set of <span class='silver'>Throwing Silver Daggers</span> and an <span class='item'>Ancient Ward Amulet</span> hidden behind a loose brick!";
                    } else {
                        playSound('failure');
                        return "You search but find nothing of value.";
                    }
                }
            },
            16: {
                text: "You attack the Beast Hounds! They leap at you with terrifying speed.",
                choices: [
                    {text: "Fight the Beast Hounds", nextSection: 40, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Beast Hounds";
                    combatState.enemyHealth = 100;
                    combatState.enemyCurrentHealth = 100;
                    combatState.enemyStrength = 16;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 41;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 2;
                    
                    playSound('werewolf');
                    return "<span class='beast'>Beast Hounds (2)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            17: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 42, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.beastHoundsDefeated = true;
                        return "You slip past the Beast Hounds unnoticed and enter the Throne Room!";
                    } else {
                        // Hounds notice
                        combatState.active = true;
                        combatState.enemyName = "Alerted Beast Hounds";
                        combatState.enemyHealth = 90;
                        combatState.enemyCurrentHealth = 90;
                        combatState.enemyStrength = 15;
                        combatState.enemyDamageDice = 3;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 43;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 2;
                        
                        playSound('werewolf');
                        return "The hounds notice you!<br><br><span class='beast'>Alerted Beast Hounds (2)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            18: {
                text: "You use bait to distract the Beast Hounds. They sniff the air, then run toward the food, allowing you to slip past.",
                choices: [
                    {text: "Enter the Throne Room", nextSection: 44, skillCheck: false}
                ],
                action: function() {
                    gameState.beastHoundsDefeated = true;
                    playSound('success');
                    return "The hounds are distracted by the food! You enter the Throne Room.";
                }
            },
            19: {
                text: "You enter the Master Bedroom through the servants' passage. The room is dominated by a massive four-poster bed with black silk curtains. A <span class='vampire-bride'>Vampire Bride</span> in a tattered wedding dress stands by the window.",
                choices: [
                    {text: "Attack the Vampire Bride", nextSection: 45, skillCheck: false},
                    {text: "Search the room for Valerius's coffin", nextSection: 46, skillCheck: false},
                    {text: "Try to reason with the bride", nextSection: 47, skillCheck: false},
                    {text: "Return through the passage", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.currentRoom = 'masterBedroom';
                    gameState.rooms.masterBedroom.explored = true;
                    playSound('vampire');
                    return "<span class='vampire-bride'>Vampire Bride</span>: 'My husband will feast on your blood tonight.'";
                }
            },
            20: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 48, skillCheck: false}
                ]
            },
            21: {
                text: "With the Werewolf Guard defeated, you can search the Library freely.",
                choices: [
                    {text: "Search for valuable items", nextSection: 49, skillCheck: false},
                    {text: "Look for information on Valerius", nextSection: 50, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.werewolfGuardDefeated = true;
                    const goldFound = rollDice(8, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the werewolf! You find <span class='gold'>" + goldFound + " Gold</span> in its pouch.";
                }
            },
            22: {
                text: "After sneaking past the werewolf, you search the Library.",
                choices: [
                    {text: "Look for information on Valerius", nextSection: 50, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            23: {
                text: "With the alerted werewolf defeated, you search the Library.",
                choices: [
                    {text: "Search for valuable items", nextSection: 49, skillCheck: false},
                    {text: "Look for information on Valerius", nextSection: 50, skillCheck: false}
                ],
                action: function() {
                    gameState.werewolfGuardDefeated = true;
                    const goldFound = rollDice(6, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the werewolf and find <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            24: {
                text: "You offer gold to the werewolf. It snarls, 'Gold means nothing to me. Only the master's approval matters.'",
                choices: [
                    {text: "Attack the werewolf", nextSection: 7, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 8, skillCheck: false}
                ],
                action: function() {
                    return "<span class='werewolf'>Werewolf Guard</span>: 'Your attempts at bribery insult me!'";
                }
            },
            25: {
                text: "You show silver to the werewolf. It recoils in fear. 'Silver! Stay back!'",
                choices: [
                    {text: "Attack with the silver", nextSection: 51, skillCheck: false},
                    {text: "Demand it stand aside", nextSection: 52, skillCheck: false},
                    {text: "Try to sneak past while it's distracted", nextSection: 53, skillCheck: true, checkType: 'agility', difficulty: 15}
                ],
                action: function() {
                    playSound('silver');
                    return "The werewolf is terrified of the silver!";
                }
            },
            26: {
                text: "The servant maid whispers: 'Valerius is weakened by silver, garlic, and sunlight. He keeps a stake in the Vault Room for executing rivals. The Vault is behind the tapestry in the Grand Hall.'",
                choices: [
                    {text: "Ask about the layout", nextSection: 27, skillCheck: false},
                    {text: "Offer to help her family", nextSection: 28, skillCheck: false},
                    {text: "Thank her and leave", nextSection: 54, skillCheck: false}
                ],
                action: function() {
                    gameState.hasHolyWater = true;
                    addToInventory('Blessed Holy Water');
                    playSound('item');
                    return "She also gives you a vial of <span class='holy'>Blessed Holy Water</span>. 'This might help against him,' she says.";
                }
            },
            27: {
                text: "The servant maid describes the layout: 'The Throne Room is south. The Vault is hidden behind the eastern tapestry in the Grand Hall. The Master Bedroom is through a servants' passage.'",
                choices: [
                    {text: "Ask about Valerius's weaknesses", nextSection: 26, skillCheck: false},
                    {text: "Offer to help her family", nextSection: 28, skillCheck: false}
                ]
            },
            28: {
                text: "You promise to help the servant maid's family if you survive. She tearfully thanks you. 'There's a secret passage to the Vault Room behind the eastern tapestry in the Grand Hall. You'll find weapons there.'",
                choices: [
                    {text: "Ask about Valerius's weaknesses", nextSection: 26, skillCheck: false},
                    {text: "Thank her and leave", nextSection: 54, skillCheck: false}
                ],
                action: function() {
                    gameState.hasHolyWater = true;
                    addToInventory('Blessed Holy Water');
                    addToInventory('Garlic Cluster');
                    playSound('item');
                    return "She gives you <span class='holy'>Blessed Holy Water</span> and a <span class='item'>Garlic Cluster</span>.";
                }
            },
            29: {
                text: "You take the vial. It's labeled 'Holy Water - Blessed by the High Priest of Solaria'.",
                choices: [
                    {text: "Take the journal", nextSection: 55, skillCheck: false},
                    {text: "Leave", nextSection: 54, skillCheck: false}
                ],
                action: function() {
                    gameState.hasHolyWater = true;
                    addToInventory('Blessed Holy Water');
                    playSound('holy');
                    return "You take the <span class='holy'>Blessed Holy Water</span>. It glows with a faint divine light.";
                }
            },
            30: {
                text: "You take the journal. It contains Valerius's personal notes about his plans and weaknesses.",
                choices: [
                    {text: "Take the vial", nextSection: 55, skillCheck: false},
                    {text: "Leave", nextSection: 54, skillCheck: false}
                ],
                action: function() {
                    addToInventory("Valerius's Journal");
                    playSound('item');
                    return "You take <span class='item'>Valerius's Journal</span>. It mentions his fear of a 'silver stake from the Vault.'";
                }
            },
            31: {
                text: "You take both the vial and the journal.",
                choices: [
                    {text: "Leave", nextSection: 54, skillCheck: false}
                ],
                action: function() {
                    gameState.hasHolyWater = true;
                    addToInventory('Blessed Holy Water');
                    addToInventory("Valerius's Journal");
                    playSound('item');
                    return "You take the <span class='holy'>Blessed Holy Water</span> and <span class='item'>Valerius's Journal</span>.";
                }
            },
            32: {
                text: "You leave the items and exit the study.",
                choices: [
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            33: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 56, skillCheck: false}
                ]
            },
            34: {
                text: "With the Vampire Thrall defeated, you search the study.",
                choices: [
                    {text: "Search for useful items", nextSection: 57, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the vampire thrall and find <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            35: {
                text: "You explain that you're here to defeat Valerius. The ghost knight nods slowly. 'I was once a knight who tried to defeat him. He cursed me to guard this place forever. If you can defeat him, I might be freed.'",
                choices: [
                    {text: "Ask for help", nextSection: 58, skillCheck: false},
                    {text: "Ask about Valerius", nextSection: 37, skillCheck: false},
                    {text: "Try to free the ghost", nextSection: 38, skillCheck: false}
                ],
                action: function() {
                    return "<span class='ghost'>Sir Alistair</span>: 'In the Vault, you'll find weapons that can harm him. Look behind the eastern tapestry in the Grand Hall.'";
                }
            },
            36: {
                text: "You attack the ghost! Your weapon passes through it harmlessly. It laughs hollowly.",
                choices: [
                    {text: "Try a different approach", nextSection: 13, skillCheck: false},
                    {text: "Use holy water if you have it", nextSection: 59, skillCheck: false, requirement: 'Blessed Holy Water'}
                ],
                action: function() {
                    playSound('ghost');
                    return "<span class='ghost'>Sir Alistair</span>: 'Foolish mortal! You cannot harm me with ordinary weapons.'";
                }
            },
            37: {
                text: "The ghost knight says: 'Valerius is most vulnerable during the day, in his coffin. But tonight is the Blood Moon - his power is at its peak. Silver and holy objects can harm him.'",
                choices: [
                    {text: "Ask for help", nextSection: 58, skillCheck: false},
                    {text: "Try to free the ghost", nextSection: 38, skillCheck: false}
                ]
            },
            38: {
                text: "You attempt to free the ghost knight from its curse. The ghost shudders. 'Only Valerius's death or true forgiveness can free me. But I can give you this advice: strike at his heart with silver.'",
                choices: [
                    {text: "Ask for help", nextSection: 58, skillCheck: false},
                    {text: "Thank the ghost", nextSection: 60, skillCheck: false}
                ],
                action: function() {
                    gameState.hasVampireKillingStake = true;
                    addToInventory('Vampire Killing Stake');
                    playSound('item');
                    return "The ghost knight points to a hidden compartment. Inside is a <span class='item'>Vampire Killing Stake</span> made of ancient silver!";
                }
            },
            39: {
                text: "After searching, you return to the observatory.",
                choices: [
                    {text: "Confront the Ghost Knight", nextSection: 13, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            40: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 61, skillCheck: false}
                ]
            },
            41: {
                text: "With the Beast Hounds defeated, the path to the Throne Room is clear.",
                choices: [
                    {text: "Enter the Throne Room", nextSection: 44, skillCheck: false},
                    {text: "Return to the Grand Hall first", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.beastHoundsDefeated = true;
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the hounds! You find <span class='gold'>" + goldFound + " Gold</span> on their collars.";
                }
            },
            42: {
                text: "You successfully sneak past the hounds and enter the Throne Room.",
                choices: [
                    {text: "Face Valerius", nextSection: 44, skillCheck: false}
                ]
            },
            43: {
                text: "With the alerted hounds defeated, you enter the Throne Room.",
                choices: [
                    {text: "Face Valerius", nextSection: 44, skillCheck: false}
                ],
                action: function() {
                    gameState.beastHoundsDefeated = true;
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the hounds and find <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            44: {
                text: "You enter the Throne Room. The chamber is vast, with black marble floors and blood-red banners. At the far end, on a throne of bones, sits <span class='vampire-lord'>VAMPIRE LORD VALERIUS VORLAK</span>. He rises as you enter.",
                choices: [
                    {text: "Confront Valerius", nextSection: 62, skillCheck: false},
                    {text: "Attack immediately", nextSection: 63, skillCheck: false},
                    {text: "Use holy water if you have it", nextSection: 64, skillCheck: false, requirement: 'Blessed Holy Water'},
                    {text: "Retreat and prepare more", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.currentRoom = 'throneRoom';
                    gameState.rooms.throneRoom.explored = true;
                    playSound('final-battle');
                    return "<span class='vampire-lord'>Valerius</span>: 'So... the little mouse has found its way to the cat. I've been expecting you.'";
                }
            },
            45: {
                text: "You attack the Vampire Bride! She shrieks and flies at you with blinding speed.",
                choices: [
                    {text: "Fight the Vampire Bride", nextSection: 65, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Vampire Bride";
                    combatState.enemyHealth = 90;
                    combatState.enemyCurrentHealth = 90;
                    combatState.enemyStrength = 17;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 66;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('vampire');
                    return "<span class='vampire-bride'>Vampire Bride</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            46: {
                text: "You search the Master Bedroom for Valerius's coffin. Behind a curtain, you find an ornate black coffin with silver trim.",
                choices: [
                    {text: "Open the coffin", nextSection: 67, skillCheck: false},
                    {text: "Destroy the coffin", nextSection: 68, skillCheck: false},
                    {text: "Return to face the bride", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    return "The coffin is cold to the touch and radiates dark energy.";
                }
            },
            47: {
                text: "You try to reason with the Vampire Bride. 'Valerius has enslaved you,' you say. She laughs bitterly. 'He turned me on our wedding night. I hate him, but I cannot disobey him.'",
                choices: [
                    {text: "Offer to free her", nextSection: 70, skillCheck: false},
                    {text: "Attack her", nextSection: 45, skillCheck: false},
                    {text: "Search for the coffin", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    return "<span class='vampire-bride'>Vampire Bride</span>: 'If you defeat him, I will be free. But you cannot win.'";
                }
            },
            48: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 20, skillCheck: false}
                ]
            },
            49: {
                text: "You search the Library and find valuable items among the books.",
                choices: [
                    {text: "Look for information on Valerius", nextSection: 50, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(10, 10);
                    gameState.gold += goldFound;
                    addToInventory('Ancient Scroll of Protection');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and an <span class='item'>Ancient Scroll of Protection</span>.";
                }
            },
            50: {
                text: "You find an ancient tome about vampire lords. It says: 'A vampire lord's power is tied to his original heart. Destroy the heart to destroy the vampire. The heart is often kept in a separate, protected location.'",
                choices: [
                    {text: "Search for more items", nextSection: 49, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Tome of Vampire Lords');
                    playSound('item');
                    return "You take the <span class='item'>Tome of Vampire Lords</span>. This knowledge could be crucial.";
                }
            },
            51: {
                text: "You attack the werewolf with silver! It howls in pain as the silver burns its flesh.",
                choices: [
                    {text: "Continue the attack", nextSection: 71, skillCheck: false}
                ],
                action: function() {
                    // Silver does extra damage
                    const silverDamage = rollDice(4, 6);
                    
                    combatState.active = true;
                    combatState.enemyName = "Silver-Wounded Werewolf";
                    combatState.enemyHealth = 80 - silverDamage;
                    combatState.enemyCurrentHealth = 80 - silverDamage;
                    combatState.enemyStrength = 16; // Weakened by silver
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 72;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('silver');
                    return "Your silver weapon burns the werewolf for " + silverDamage + " damage!<br><br><span class='werewolf'>Silver-Wounded Werewolf</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            52: {
                text: "You demand the werewolf stand aside. It snarls but steps back, fear in its eyes. 'Very well. But the master will know of this.'",
                choices: [
                    {text: "Search the Library", nextSection: 73, skillCheck: false},
                    {text: "Attack it anyway", nextSection: 51, skillCheck: false}
                ],
                action: function() {
                    playSound('silver');
                    return "The werewolf allows you to pass, keeping its distance from the silver.";
                }
            },
            53: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 74, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.hasSilverSword = true;
                        equipWeapon('Silver Sword');
                        return "You sneak past the distracted werewolf and find a <span class='silver'>Silver Sword</span> in the Library!";
                    } else {
                        // Werewolf attacks
                        combatState.active = true;
                        combatState.enemyName = "Enraged Werewolf";
                        combatState.enemyHealth = 85;
                        combatState.enemyCurrentHealth = 85;
                        combatState.enemyStrength = 19;
                        combatState.enemyDamageDice = 3;
                        combatState.enemyDamageSides = 8;
                        combatState.nextSection = 75;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('werewolf');
                        return "The werewolf attacks in rage!<br><br><span class='werewolf'>Enraged Werewolf</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            54: {
                text: "You leave the study.",
                choices: [
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            55: {
                text: "You take both items and leave the study.",
                choices: [
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            56: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 33, skillCheck: false}
                ]
            },
            57: {
                text: "You search the study after defeating the thrall.",
                choices: [
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(6, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> in the study.";
                }
            },
            58: {
                text: "You ask the ghost knight for help. 'I cannot leave this observatory,' he says. 'But I can give you knowledge. Valerius keeps his original heart in the Vault. Destroy it to weaken him greatly.'",
                choices: [
                    {text: "Ask about the Vault", nextSection: 76, skillCheck: false},
                    {text: "Try to free the ghost", nextSection: 38, skillCheck: false},
                    {text: "Thank him", nextSection: 60, skillCheck: false}
                ]
            },
            59: {
                text: "You use holy water on the ghost! It shrieks as the blessed liquid burns its ethereal form.",
                choices: [
                    {text: "Continue attacking with holy water", nextSection: 77, skillCheck: false},
                    {text: "Try to reason with it now", nextSection: 78, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Blessed Holy Water');
                    playSound('holy');
                    return "The holy water harms the ghost! It writhes in pain.";
                }
            },
            60: {
                text: "You thank the ghost knight and leave the observatory.",
                choices: [
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            61: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 40, skillCheck: false}
                ]
            },
            62: {
                text: "You confront Valerius. 'Your reign of terror ends tonight,' you declare. He laughs, a cold, echoing sound. 'Many have said that. All now serve me in death.'",
                choices: [
                    {text: "Begin the final battle", nextSection: 79, skillCheck: false},
                    {text: "Use a special item if you have one", nextSection: 80, skillCheck: false},
                    {text: "Try to distract him", nextSection: 81, skillCheck: true, checkType: 'agility', difficulty: 18}
                ],
                action: function() {
                    playSound('final-battle');
                    return "<span class='vampire-lord'>Valerius</span>: 'Let us see if you are different from the others. Come, little hero. Try to strike me down.'";
                }
            },
            63: {
                text: "You attack Valerius without warning! He moves with impossible speed, dodging your first blow.",
                choices: [
                    {text: "Begin the final battle", nextSection: 79, skillCheck: false}
                ],
                action: function() {
                    playSound('final-battle');
                    return "<span class='vampire-lord'>Valerius</span>: 'Direct. I appreciate that. But futile.'";
                }
            },
            64: {
                text: "You throw holy water at Valerius! It sizzles against his skin, and he screams in pain.",
                choices: [
                    {text: "Begin the final battle with advantage", nextSection: 82, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Blessed Holy Water');
                    gameState.usedHolyWater = true;
                    gameState.valeriusHealth -= 30;
                    playSound('holy');
                    return "The holy water burns Valerius for 30 damage! He is weakened. <span class='vampire-lord'>Valerius Health: " + gameState.valeriusHealth + "/" + gameState.valeriusMaxHealth + "</span>";
                }
            },
            65: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 83, skillCheck: false}
                ]
            },
            66: {
                text: "With the Vampire Bride defeated, you search the Master Bedroom.",
                choices: [
                    {text: "Search for Valerius's coffin", nextSection: 46, skillCheck: false},
                    {text: "Look for valuable items", nextSection: 84, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.vampireBrideDefeated = true;
                    const goldFound = rollDice(12, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the Vampire Bride! You find <span class='gold'>" + goldFound + " Gold</span> and her jewelry.";
                }
            },
            67: {
                text: "You open the coffin. Inside is empty except for a handful of grave dirt. Valerius is not here - he's in the Throne Room.",
                choices: [
                    {text: "Destroy the coffin", nextSection: 68, skillCheck: false},
                    {text: "Return to face the bride", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    return "Destroying his coffin might weaken Valerius.";
                }
            },
            68: {
                text: "You destroy Valerius's coffin! As it splinters, you hear a distant roar of anger from somewhere in the castle.",
                choices: [
                    {text: "Face the Vampire Bride", nextSection: 69, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    // Valerius takes damage when his coffin is destroyed
                    gameState.valeriusHealth -= 20;
                    playSound('success');
                    return "Valerius's connection to this place is weakened! He takes 20 damage.";
                }
            },
            69: {
                text: "You return to face the Vampire Bride.",
                choices: [
                    {text: "Attack the Vampire Bride", nextSection: 45, skillCheck: false},
                    {text: "Try to reason with her", nextSection: 47, skillCheck: false}
                ]
            },
            70: {
                text: "You offer to free the Vampire Bride from Valerius's control. She looks hopeful. 'If you can defeat him, I will help you. There is a secret: his original heart is in the Vault. Destroy it to weaken him.'",
                choices: [
                    {text: "Ask about the Vault", nextSection: 85, skillCheck: false},
                    {text: "Thank her and leave", nextSection: 86, skillCheck: false},
                    {text: "Attack her anyway", nextSection: 45, skillCheck: false}
                ],
                action: function() {
                    gameState.vampireBrideDefeated = true; // She's now an ally
                    addToInventory('Vampire Bride's Locket');
                    playSound('item');
                    return "She gives you her <span class='item'>Vampire Bride's Locket</span>. 'This belonged to me when I was human. It might protect you.'";
                }
            },
            71: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 87, skillCheck: false}
                ]
            },
            72: {
                text: "With the silver-wounded werewolf defeated, you search the Library.",
                choices: [
                    {text: "Search for valuable items", nextSection: 49, skillCheck: false},
                    {text: "Look for information", nextSection: 50, skillCheck: false}
                ],
                action: function() {
                    gameState.werewolfGuardDefeated = true;
                    const goldFound = rollDice(9, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the werewolf! You find <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            73: {
                text: "With the werewolf standing aside, you search the Library.",
                choices: [
                    {text: "Search for valuable items", nextSection: 49, skillCheck: false},
                    {text: "Look for information", nextSection: 50, skillCheck: false}
                ]
            },
            74: {
                text: "After dealing with the werewolf, you search the Library.",
                choices: [
                    {text: "Search for valuable items", nextSection: 49, skillCheck: false},
                    {text: "Look for information", nextSection: 50, skillCheck: false}
                ]
            },
            75: {
                text: "With the enraged werewolf defeated, you search the Library.",
                choices: [
                    {text: "Search for valuable items", nextSection: 49, skillCheck: false},
                    {text: "Look for information", nextSection: 50, skillCheck: false}
                ],
                action: function() {
                    gameState.werewolfGuardDefeated = true;
                    const goldFound = rollDice(7, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the werewolf and find <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            76: {
                text: "The ghost knight explains: 'The Vault is hidden behind the eastern tapestry in the Grand Hall. It contains Valerius's greatest treasures... and his greatest weakness.'",
                choices: [
                    {text: "Try to free the ghost", nextSection: 38, skillCheck: false},
                    {text: "Thank him", nextSection: 60, skillCheck: false}
                ]
            },
            77: {
                text: "You continue attacking the ghost with holy water. It dissipates into mist, then reforms. 'Enough! I yield!'",
                choices: [
                    {text: "Stop and talk", nextSection: 78, skillCheck: false}
                ],
                action: function() {
                    playSound('holy');
                    return "The ghost is badly wounded by the holy water.";
                }
            },
            78: {
                text: "The wounded ghost knight speaks: 'Please, no more. I will help you. Valerius's heart is in the Vault. Destroy it with fire or silver.'",
                choices: [
                    {text: "Ask about the Vault", nextSection: 76, skillCheck: false},
                    {text: "Thank him and leave", nextSection: 60, skillCheck: false}
                ]
            },
            79: {
                text: "The final battle begins! <span class='vampire-lord'>VAMPIRE LORD VALERIUS VORLAK</span> moves toward you with supernatural speed.",
                choices: [
                    {text: "Fight Valerius", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    // Start final battle
                    startFinalBattle();
                    return "";
                }
            },
            80: {
                text: "You prepare to use a special item against Valerius.",
                choices: [
                    {text: "Use Silver Sword if you have it", nextSection: 89, skillCheck: false, requirement: function() { 
                        return gameState.equippedWeapon.includes('Silver') || gameState.inventory.some(item => item.includes('Silver Sword'));
                    }},
                    {text: "Use Vampire Killing Stake if you have it", nextSection: 90, skillCheck: false, requirement: 'Vampire Killing Stake'},
                    {text: "Use Throwing Silver Daggers if you have them", nextSection: 91, skillCheck: false, requirement: 'Throwing Silver Daggers'},
                    {text: "Use Garlic Cluster if you have it", nextSection: 92, skillCheck: false, requirement: 'Garlic Cluster'},
                    {text: "Begin normal battle", nextSection: 79, skillCheck: false}
                ]
            },
            81: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 93, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        // Surprise attack advantage
                        gameState.valeriusHealth -= 15;
                        return "You distract Valerius and land a surprise attack for 15 damage! <span class='vampire-lord'>Valerius Health: " + gameState.valeriusHealth + "/" + gameState.valeriusMaxHealth + "</span>";
                    } else {
                        playSound('failure');
                        return "Valerius sees through your distraction. 'Pathetic.'";
                    }
                }
            },
            82: {
                text: "With Valerius weakened by holy water, the battle begins!",
                choices: [
                    {text: "Fight Valerius", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    // Start final battle with advantage
                    startFinalBattle();
                    return "<span class='success'>Valerius is weakened by the holy water!</span>";
                }
            },
            83: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 65, skillCheck: false}
                ]
            },
            84: {
                text: "You search the Master Bedroom and find valuable items.",
                choices: [
                    {text: "Search for Valerius's coffin", nextSection: 46, skillCheck: false},
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(15, 10);
                    gameState.gold += goldFound;
                    gameState.hasObsidianArmor = true;
                    equipArmor('Obsidian Armor');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a set of <span class='armor'>Obsidian Armor</span>!";
                }
            },
            85: {
                text: "The Vampire Bride explains: 'The Vault is behind the eastern tapestry in the Grand Hall. The heart is in a crystal jar on the central pedestal. Break the jar and burn the heart.'",
                choices: [
                    {text: "Thank her and leave", nextSection: 86, skillCheck: false}
                ]
            },
            86: {
                text: "You thank the Vampire Bride and leave the Master Bedroom.",
                choices: [
                    {text: "Return to the Grand Hall", nextSection: 1, skillCheck: false}
                ]
            },
            87: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 71, skillCheck: false}
                ]
            },
            88: {
                text: "",
                choices: [
                    {text: "Continue the final battle!", nextSection: 94, skillCheck: false}
                ]
            },
            89: {
                text: "You attack Valerius with a silver weapon! The silver burns him, and he screams in pain.",
                choices: [
                    {text: "Begin the final battle with silver advantage", nextSection: 95, skillCheck: false}
                ],
                action: function() {
                    gameState.usedSilverSword = true;
                    gameState.valeriusHealth -= 25;
                    playSound('silver');
                    return "Your silver weapon burns Valerius for 25 damage! <span class='vampire-lord'>Valerius Health: " + gameState.valeriusHealth + "/" + gameState.valeriusMaxHealth + "</span>";
                }
            },
            90: {
                text: "You prepare the Vampire Killing Stake. Valerius's eyes widen. 'Where did you get that?!'",
                choices: [
                    {text: "Begin the final battle with stake advantage", nextSection: 96, skillCheck: false}
                ],
                action: function() {
                    gameState.hasVampireKillingStake = true;
                    playSound('silver');
                    return "Valerius is afraid of the stake! This could be your key to victory.";
                }
            },
            91: {
                text: "You throw silver daggers at Valerius! They strike true, embedding in his chest.",
                choices: [
                    {text: "Begin the final battle with dagger advantage", nextSection: 97, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Throwing Silver Daggers');
                    gameState.valeriusHealth -= 20;
                    playSound('silver');
                    return "Your silver daggers hit Valerius for 20 damage! <span class='vampire-lord'>Valerius Health: " + gameState.valeriusHealth + "/" + gameState.valeriusMaxHealth + "</span>";
                }
            },
            92: {
                text: "You throw garlic at Valerius! He recoils, gagging at the smell.",
                choices: [
                    {text: "Begin the final battle with garlic advantage", nextSection: 98, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Garlic Cluster');
                    gameState.valeriusHealth -= 10;
                    playSound('success');
                    return "The garlic weakens Valerius for 10 damage! <span class='vampire-lord'>Valerius Health: " + gameState.valeriusHealth + "/" + gameState.valeriusMaxHealth + "</span>";
                }
            },
            93: {
                text: "After your distraction attempt, the battle begins.",
                choices: [
                    {text: "Fight Valerius", nextSection: 88, skillCheck: false}
                ]
            },
            94: {
                text: "",
                choices: [
                    {text: "Continue the final battle!", nextSection: 99, skillCheck: false}
                ]
            },
            95: {
                text: "With Valerius wounded by silver, the final battle begins!",
                choices: [
                    {text: "Fight Valerius", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    startFinalBattle();
                    return "<span class='success'>The silver has weakened Valerius!</span>";
                }
            },
            96: {
                text: "With the Vampire Killing Stake ready, the final battle begins!",
                choices: [
                    {text: "Fight Valerius", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    startFinalBattle();
                    return "<span class='success'>You have the means to kill Valerius permanently!</span>";
                }
            },
            97: {
                text: "With Valerius wounded by silver daggers, the final battle begins!",
                choices: [
                    {text: "Fight Valerius", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    startFinalBattle();
                    return "<span class='success'>Valerius is wounded by silver!</span>";
                }
            },
            98: {
                text: "With Valerius weakened by garlic, the final battle begins!",
                choices: [
                    {text: "Fight Valerius", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    startFinalBattle();
                    return "<span class='success'>The garlic has weakened Valerius!</span>";
                }
            },
            99: {
                text: "",
                choices: [
                    {text: "Continue the final battle!", nextSection: 100, skillCheck: false}
                ]
            },
            100: {
                text: "Vault Room - You find the hidden entrance behind the eastern tapestry. The Vault contains piles of gold, jewels, and magical artifacts. In the center, on a pedestal, is a crystal jar containing a still-beating heart.",
                choices: [
                    {text: "Destroy the heart", nextSection: 101, skillCheck: false},
                    {text: "Take the treasure first", nextSection: 102, skillCheck: false},
                    {text: "Examine the heart", nextSection: 103, skillCheck: false}
                ],
                action: function() {
                    gameState.currentRoom = 'vault';
                    gameState.rooms.vault.explored = true;
                    playSound('vampire');
                    return "The heart pulses with dark energy. This must be Valerius's original heart!";
                }
            },
            101: {
                text: "You destroy Valerius's heart! As it crumbles to dust, a deafening scream echoes through the castle. Valerius is severely weakened!",
                choices: [
                    {text: "Take the treasure", nextSection: 104, skillCheck: false},
                    {text: "Return to the Throne Room to face a weakened Valerius", nextSection: 105, skillCheck: false}
                ],
                action: function() {
                    gameState.valeriusHealth = Math.floor(gameState.valeriusHealth / 2); // Halve his health
                    gameState.valeriusStrength -= 5; // Reduce his strength
                    playSound('success');
                    return "<span class='success'>Valerius's power is broken! His health is halved and his strength reduced!</span>";
                }
            },
            102: {
                text: "You take the treasure from the Vault.",
                choices: [
                    {text: "Destroy the heart", nextSection: 101, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(50, 10);
                    gameState.gold += goldFound;
                    addToInventory('Ancient Vampire Crown');
                    addToInventory('Ruby of Blood Magic');
                    updateStatsDisplay();
                    playSound('item');
                    return "You take <span class='gold'>" + goldFound + " Gold</span>, an <span class='item'>Ancient Vampire Crown</span>, and a <span class='item'>Ruby of Blood Magic</span>!";
                }
            },
            103: {
                text: "The heart is large, black, and veined with silver. It beats slowly, rhythmically. Destroying it would cripple Valerius.",
                choices: [
                    {text: "Destroy the heart", nextSection: 101, skillCheck: false},
                    {text: "Take the treasure first", nextSection: 102, skillCheck: false}
                ]
            },
            104: {
                text: "After taking the treasure, you destroy the heart.",
                choices: [
                    {text: "Return to the Throne Room to face a weakened Valerius", nextSection: 105, skillCheck: false}
                ],
                action: function() {
                    gameState.valeriusHealth = Math.floor(gameState.valeriusHealth / 2);
                    gameState.valeriusStrength -= 5;
                    playSound('success');
                    return "<span class='success'>Valerius's power is broken! His health is halved and his strength reduced!</span>";
                }
            },
            105: {
                text: "You return to the Throne Room. Valerius is on his knees, clutching his chest. 'My... heart...' he gasps. He looks up at you, hatred in his eyes. 'You will pay for that!'",
                choices: [
                    {text: "Finish him!", nextSection: 106, skillCheck: false}
                ],
                action: function() {
                    playSound('final-battle');
                    return "<span class='vampire-lord'>Valerius (Weakened)</span>: Health " + gameState.valeriusHealth + "/" + gameState.valeriusMaxHealth + ", Strength " + gameState.valeriusStrength;
                }
            },
            106: {
                text: "You face the weakened Valerius for the final confrontation!",
                choices: [
                    {text: "Fight the weakened Valerius", nextSection: 107, skillCheck: false}
                ],
                action: function() {
                    // Start final battle with weakened Valerius
                    combatState.active = true;
                    combatState.enemyName = "Weakened Vampire Lord Valerius";
                    combatState.enemyHealth = gameState.valeriusHealth;
                    combatState.enemyCurrentHealth = gameState.valeriusHealth;
                    combatState.enemyStrength = gameState.valeriusStrength;
                    combatState.enemyDamageDice = 4;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 108;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    combatState.isValerius = true;
                    
                    playSound('final-battle');
                    return "<span class='vampire-lord'>Weakened Vampire Lord Valerius</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            107: {
                text: "",
                choices: [
                    {text: "Continue the final battle!", nextSection: 109, skillCheck: false}
                ]
            },
            108: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 110, skillCheck: false}
                ],
                action: function() {
                    if (combatState.enemyCurrentHealth <= 0) {
                        // Valerius defeated!
                        if (gameState.hasVampireKillingStake) {
                            return "Valerius falls to the ground, weakened and helpless. You raise the Vampire Killing Stake...";
                        } else {
                            return "Valerius falls to the ground, defeated but not destroyed. He will regenerate unless you finish him properly!";
                        }
                    } else {
                        return ""; // Combat continues
                    }
                }
            },
            109: {
                text: "",
                choices: [
                    {text: "Continue the final battle!", nextSection: 107, skillCheck: false}
                ]
            },
            110: {
                text: "With Valerius defeated, you have one final choice.",
                choices: [
                    {text: "Use the Vampire Killing Stake to finish him (if you have it)", nextSection: 111, skillCheck: false, requirement: 'Vampire Killing Stake'},
                    {text: "Decapitate him with your weapon", nextSection: 112, skillCheck: false},
                    {text: "Burn his body", nextSection: 113, skillCheck: false},
                    {text: "Leave him to regenerate (BAD ENDING)", nextSection: 114, skillCheck: false}
                ]
            },
            111: {
                text: "You drive the Vampire Killing Stake through Valerius's heart! He screams, his body turning to dust. The curse is broken forever!",
                choices: [
                    {text: "Claim your victory", nextSection: 115, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Vampire Killing Stake');
                    playSound('silver');
                    return "<span class='victory'>VALERIUS IS DESTROYED!</span>";
                }
            },
            112: {
                text: "You decapitate Valerius with your weapon. His body turns to ash. The vampire lord is destroyed!",
                choices: [
                    {text: "Claim your victory", nextSection: 115, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "<span class='victory'>VALERIUS IS DESTROYED!</span>";
                }
            },
            113: {
                text: "You burn Valerius's body. The flames consume him completely, leaving only ashes. The vampire lord is no more!",
                choices: [
                    {text: "Claim your victory", nextSection: 115, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "<span class='victory'>VALERIUS IS DESTROYED!</span>";
                }
            },
            114: {
                text: "You leave Valerius's body, thinking him defeated. But as you turn to leave, you hear a laugh. 'Fool... I cannot die so easily...' His body begins to regenerate! You have failed!",
                choices: [
                    {text: "GAME OVER - Try Again", nextSection: 116, skillCheck: false}
                ],
                action: function() {
                    playSound('failure');
                    return "<span class='game-over'>VALERIUS REGENERATES AND KILLS YOU! GAME OVER.</span>";
                }
            },
            115: {
                text: "You have defeated Vampire Lord Valerius Vorlak! The castle begins to crumble as his dark magic dissipates.",
                choices: [
                    {text: "Escape with your treasure", nextSection: 117, skillCheck: false}
                ],
                action: function() {
                    gameState.gameComplete = true;
                    return "<span class='victory'>VICTORY IS YOURS!</span>";
                }
            },
            116: {
                text: "You have failed to destroy Valerius. He regenerates and kills you. The land remains under his curse.",
                choices: [
                    {text: "Return to Main Menu", nextSection: 118, skillCheck: false}
                ]
            },
            117: {
                text: "You escape the crumbling Castle Vorlak as sunlight breaks through the eternal night. You have saved the land from the vampire's curse!",
                choices: [
                    {text: "View your final stats and victory screen", nextSection: 119, skillCheck: false}
                ]
            },
            118: {
                text: "",
                choices: [],
                action: function() {
                    localStorage.removeItem('castleUndeadGameState');
                    setTimeout(() => {
                        window.location.href = 'l1.html';
                    }, 2000);
                    return "Returning to Main Menu...";
                }
            },
            119: {
                text: "",
                choices: [],
                action: function() {
                    // Show victory screen
                    showScreen('screen-victory');
                    
                    // Update victory stats
                    document.getElementById('victory-stat-strength').textContent = gameState.strength;
                    document.getElementById('victory-stat-health').textContent = gameState.health;
                    document.getElementById('victory-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('victory-stat-agility').textContent = gameState.agility;
                    document.getElementById('victory-stat-gold').textContent = gameState.gold;
                    
                    // Display final inventory
                    const inventoryDisplay = document.getElementById('victory-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> <span class='weapon'>${gameState.equippedWeapon}</span>, <span class='armor'>${gameState.equippedArmor}</span>`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    // Show treasure
                    const treasureDiv = document.createElement('div');
                    treasureDiv.innerHTML = `<strong>Treasure:</strong> <span class='gold'>${gameState.gold} Gold</span>`;
                    inventoryDisplay.appendChild(treasureDiv);
                    
                    playSound('victory');
                    
                    // Save completed game
                    localStorage.setItem('castleUndeadGameComplete', 'true');
                    localStorage.removeItem('castleUndeadGameState'); // Clear current game state
                    
                    return "";
                }
            }
        };
        
        // Start the final battle
        function startFinalBattle() {
            showScreen('screen-battle');
            
            combatState.active = true;
            combatState.enemyName = "Vampire Lord Valerius";
            combatState.enemyHealth = gameState.valeriusHealth;
            combatState.enemyCurrentHealth = gameState.valeriusHealth;
            combatState.enemyStrength = gameState.valeriusStrength;
            combatState.enemyDamageDice = 4;
            combatState.enemyDamageSides = 8;
            combatState.nextSection = 108;
            combatState.round = 1;
            combatState.isGroup = false;
            combatState.isValerius = true;
            
            const battleText = `<div class="final-battle">
                <span class="vampire-lord">FINAL BATTLE: VAMPIRE LORD VALERIUS VORLAK</span><br>
                Health: ${combatState.enemyCurrentHealth}/${gameState.valeriusMaxHealth}<br>
                Strength: ${combatState.enemyStrength}<br>
                Phase: ${gameState.valeriusPhase}/3
            </div>
            <p>The ancient vampire lord stands before you, dark energy crackling around him. This is the final battle that will determine the fate of the realm!</p>`;
            
            document.getElementById('battle-text').innerHTML = battleText;
            
            const battleChoices = document.getElementById('battle-choices');
            battleChoices.innerHTML = '';
            
            const attackButton = document.createElement('button');
            attackButton.className = 'choice-btn';
            attackButton.textContent = "Attack Valerius";
            attackButton.onclick = function() {
                executeFinalBattleRound();
            };
            battleChoices.appendChild(attackButton);
            
            // Special item buttons if available
            if (gameState.inventory.includes('Blessed Holy Water') || gameState.inventory.includes('Holy Water')) {
                const holyButton = document.createElement('button');
                holyButton.className = 'choice-btn';
                holyButton.textContent = "Use Holy Water";
                holyButton.onclick = function() {
                    useHolyWaterInBattle();
                };
                battleChoices.appendChild(holyButton);
            }
            
            if (gameState.hasVampireKillingStake) {
                const stakeButton = document.createElement('button');
                stakeButton.className = 'choice-btn';
                stakeButton.textContent = "Use Vampire Killing Stake";
                stakeButton.onclick = function() {
                    useStakeInBattle();
                };
                battleChoices.appendChild(stakeButton);
            }
            
            if (gameState.inventory.includes('Garlic Cluster')) {
                const garlicButton = document.createElement('button');
                garlicButton.className = 'choice-btn';
                garlicButton.textContent = "Use Garlic Cluster";
                garlicButton.onclick = function() {
                    useGarlicInBattle();
                };
                battleChoices.appendChild(garlicButton);
            }
            
            if (gameState.inventory.includes('Throwing Silver Daggers')) {
                const daggerButton = document.createElement('button');
                daggerButton.className = 'choice-btn';
                daggerButton.textContent = "Throw Silver Daggers";
                daggerButton.onclick = function() {
                    throwDaggersInBattle();
                };
                battleChoices.appendChild(daggerButton);
            }
            
            const healButton = document.createElement('button');
            healButton.className = 'choice-btn';
            healButton.textContent = "Use Healing Item";
            healButton.onclick = function() {
                useHealingInBattle();
            };
            battleChoices.appendChild(healButton);
        }
        
        // Execute a round of the final battle
        function executeFinalBattleRound() {
            playSound('combat');
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="vampire-lord">ROUND ${combatState.round}: VAMPIRE LORD VALERIUS</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Valerius Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Valerius rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            // Check for silver weapon bonus
            let silverBonus = 0;
            if (gameState.equippedWeapon.includes('Silver') || gameState.usedSilverSword) {
                silverBonus = 5;
                resultText += `<span class="silver">Silver weapon bonus: +${silverBonus} damage!</span><br>`;
            }
            
            if (playerTotal > enemyTotal) {
                // Player hits Valerius
                let damage = rollDice(2, 6) + Math.floor(gameState.strength / 2) + silverBonus;
                
                // Phase transitions
                if (combatState.enemyCurrentHealth > gameState.valeriusMaxHealth * 0.66) {
                    // Phase 1
                    resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                } else if (combatState.enemyCurrentHealth > gameState.valeriusMaxHealth * 0.33) {
                    // Phase 2 - Valerius gets more aggressive
                    gameState.valeriusPhase = 2;
                    damage = Math.floor(damage * 0.8); // Player does less damage in phase 2
                    resultText += `<span class="vampire-lord">Phase 2: Valerius's dark aura weakens your attacks! You hit for ${damage} damage!</span><br>`;
                } else {
                    // Phase 3 - Valerius is desperate
                    gameState.valeriusPhase = 3;
                    resultText += `<span class="vampire-lord">Phase 3: Valerius is desperate! You hit for ${damage} damage!</span><br>`;
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="vampire">Valerius Health: ${Math.max(0, combatState.enemyCurrentHealth)}/${gameState.valeriusMaxHealth}</span><br>`;
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="victory">VALERIUS IS DEFEATED!</span><br>`;
                    
                    // Check if player has stake
                    if (gameState.hasVampireKillingStake) {
                        resultText += `Valerius lies helpless before you. Use the Vampire Killing Stake to finish him!`;
                    } else {
                        resultText += `Valerius is defeated but not destroyed. You must finish him properly!`;
                    }
                    
                    document.getElementById('battle-text').innerHTML += resultText;
                    
                    // Update battle choices
                    const battleChoices = document.getElementById('battle-choices');
                    battleChoices.innerHTML = '';
                    
                    if (gameState.hasVampireKillingStake) {
                        const stakeButton = document.createElement('button');
                        stakeButton.className = 'choice-btn';
                        stakeButton.textContent = "Use Vampire Killing Stake";
                        stakeButton.onclick = function() {
                            loadSection(111);
                        };
                        battleChoices.appendChild(stakeButton);
                    }
                    
                    const decapitateButton = document.createElement('button');
                    decapitateButton.className = 'choice-btn';
                    decapitateButton.textContent = "Decapitate Him";
                    decapitateButton.onclick = function() {
                        loadSection(112);
                    };
                    battleChoices.appendChild(decapitateButton);
                    
                    const burnButton = document.createElement('button');
                    burnButton.className = 'choice-btn';
                    burnButton.textContent = "Burn His Body";
                    burnButton.onclick = function() {
                        loadSection(113);
                    };
                    battleChoices.appendChild(burnButton);
                    
                    const leaveButton = document.createElement('button');
                    leaveButton.className = 'choice-btn';
                    leaveButton.textContent = "Leave Him (Bad Ending)";
                    leaveButton.onclick = function() {
                        loadSection(114);
                    };
                    battleChoices.appendChild(leaveButton);
                    
                    return;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Valerius hits player
                let enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                
                // Phase-based adjustments
                if (gameState.valeriusPhase === 2) {
                    enemyDamage = Math.floor(enemyDamage * 1.3); // 30% more damage in phase 2
                    resultText += `<span class="vampire-lord">Phase 2: Valerius's attacks are more powerful!</span><br>`;
                } else if (gameState.valeriusPhase === 3) {
                    enemyDamage = Math.floor(enemyDamage * 1.5); // 50% more damage in phase 3
                    resultText += `<span class="vampire-lord">Phase 3: Valerius fights desperately!</span><br>`;
                }
                
                // Armor reduction
                let armorReduction = 0;
                if (gameState.equippedArmor.includes('Obsidian')) {
                    armorReduction = 5;
                } else if (gameState.equippedArmor.includes('Plate')) {
                    armorReduction = 3;
                } else if (gameState.equippedArmor.includes('Chain')) {
                    armorReduction = 2;
                }
                
                enemyDamage = Math.max(1, enemyDamage - armorReduction);
                
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">Valerius hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated by Valerius! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    document.getElementById('battle-text').innerHTML += resultText;
                    
                    const battleChoices = document.getElementById('battle-choices');
                    battleChoices.innerHTML = '';
                    
                    const gameOverButton = document.createElement('button');
                    gameOverButton.className = 'choice-btn';
                    gameOverButton.textContent = "Return to Main Menu";
                    gameOverButton.onclick = function() {
                        localStorage.removeItem('castleUndeadGameState');
                        window.location.href = 'l1.html';
                    };
                    battleChoices.appendChild(gameOverButton);
                    
                    return;
                }
                
                updateStatsDisplay();
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            document.getElementById('battle-text').innerHTML += resultText;
            
            // Update phase display
            const phaseDisplay = document.querySelector('.final-battle');
            if (phaseDisplay) {
                phaseDisplay.innerHTML = `<span class="vampire-lord">FINAL BATTLE: VAMPIRE LORD VALERIUS VORLAK</span><br>
                Health: ${combatState.enemyCurrentHealth}/${gameState.valeriusMaxHealth}<br>
                Strength: ${combatState.enemyStrength}<br>
                Phase: ${gameState.valeriusPhase}/3`;
            }
        }
        
        // Use holy water in battle
        function useHolyWaterInBattle() {
            playSound('holy');
            
            // Remove holy water from inventory
            if (gameState.inventory.includes('Blessed Holy Water')) {
                removeFromInventory('Blessed Holy Water');
            } else if (gameState.inventory.includes('Holy Water')) {
                removeFromInventory('Holy Water');
            }
            
            const damage = rollDice(3, 8) + 10;
            combatState.enemyCurrentHealth -= damage;
            
            let resultText = `<div class="combat-log"><span class="holy">You throw Holy Water at Valerius!</span><br>`;
            resultText += `The blessed water burns him for ${damage} damage!<br>`;
            resultText += `<span class="vampire">Valerius Health: ${Math.max(0, combatState.enemyCurrentHealth)}/${gameState.valeriusMaxHealth}</span><br>`;
            
            if (combatState.enemyCurrentHealth <= 0) {
                combatState.active = false;
                resultText += `<br><span class="victory">VALERIUS IS DEFEATED!</span><br>`;
                resultText += `Valerius is defeated but not destroyed. You must finish him properly!`;
                
                document.getElementById('battle-text').innerHTML += resultText;
                
                // Update battle choices (similar to victory)
                const battleChoices = document.getElementById('battle-choices');
                battleChoices.innerHTML = '';
                
                if (gameState.hasVampireKillingStake) {
                    const stakeButton = document.createElement('button');
                    stakeButton.className = 'choice-btn';
                    stakeButton.textContent = "Use Vampire Killing Stake";
                    stakeButton.onclick = function() {
                        loadSection(111);
                    };
                    battleChoices.appendChild(stakeButton);
                }
                
                const decapitateButton = document.createElement('button');
                decapitateButton.className = 'choice-btn';
                decapitateButton.textContent = "Decapitate Him";
                decapitateButton.onclick = function() {
                    loadSection(112);
                };
                battleChoices.appendChild(decapitateButton);
                
                const burnButton = document.createElement('button');
                burnButton.className = 'choice-btn';
                burnButton.textContent = "Burn His Body";
                burnButton.onclick = function() {
                    loadSection(113);
                };
                battleChoices.appendChild(burnButton);
                
                return;
            }
            
            resultText += `</div>`;
            document.getElementById('battle-text').innerHTML += resultText;
            
            // Valerius gets a turn after holy water
            setTimeout(() => {
                valeriusCounterAttack();
            }, 1000);
        }
        
        // Use stake in battle
        function useStakeInBattle() {
            playSound('silver');
            
            let resultText = `<div class="combat-log"><span class="item">You attempt to use the Vampire Killing Stake!</span><br>`;
            
            // Stake can only be used when Valerius is weakened
            if (combatState.enemyCurrentHealth < gameState.valeriusMaxHealth * 0.5) {
                resultText += `You drive the stake through Valerius's heart!<br>`;
                resultText += `<span class="victory">VALERIUS IS DESTROYED!</span><br>`;
                
                combatState.active = false;
                document.getElementById('battle-text').innerHTML += resultText;
                
                // Victory!
                setTimeout(() => {
                    loadSection(111);
                }, 1500);
            } else {
                resultText += `Valerius is still too powerful! He knocks the stake from your hand.<br>`;
                resultText += `</div>`;
                document.getElementById('battle-text').innerHTML += resultText;
                
                // Valerius counterattacks
                setTimeout(() => {
                    valeriusCounterAttack();
                }, 1000);
            }
        }
        
        // Use garlic in battle
        function useGarlicInBattle() {
            playSound('success');
            removeFromInventory('Garlic Cluster');
            
            const damage = rollDice(2, 6);
            combatState.enemyCurrentHealth -= damage;
            combatState.enemyStrength -= 2; // Garlic weakens him
            
            let resultText = `<div class="combat-log"><span class="item">You throw garlic at Valerius!</span><br>`;
            resultText += `The garlic weakens him for ${damage} damage and reduces his strength!<br>`;
            resultText += `<span class="vampire">Valerius Health: ${Math.max(0, combatState.enemyCurrentHealth)}/${gameState.valeriusMaxHealth}</span><br>`;
            resultText += `<span class="vampire">Valerius Strength reduced to: ${combatState.enemyStrength}</span><br>`;
            resultText += `</div>`;
            
            document.getElementById('battle-text').innerHTML += resultText;
            
            // Valerius counterattacks
            setTimeout(() => {
                valeriusCounterAttack();
            }, 1000);
        }
        
        // Throw daggers in battle
        function throwDaggersInBattle() {
            playSound('silver');
            removeFromInventory('Throwing Silver Daggers');
            
            const damage = rollDice(4, 6) + 8; // Silver daggers do good damage
            combatState.enemyCurrentHealth -= damage;
            
            let resultText = `<div class="combat-log"><span class="silver">You throw Silver Daggers at Valerius!</span><br>`;
            resultText += `The silver daggers strike true for ${damage} damage!<br>`;
            resultText += `<span class="vampire">Valerius Health: ${Math.max(0, combatState.enemyCurrentHealth)}/${gameState.valeriusMaxHealth}</span><br>`;
            
            if (combatState.enemyCurrentHealth <= 0) {
                combatState.active = false;
                resultText += `<br><span class="victory">VALERIUS IS DEFEATED!</span><br>`;
                resultText += `Valerius is defeated but not destroyed. You must finish him properly!`;
                
                document.getElementById('battle-text').innerHTML += resultText;
                
                // Update battle choices
                const battleChoices = document.getElementById('battle-choices');
                battleChoices.innerHTML = '';
                
                if (gameState.hasVampireKillingStake) {
                    const stakeButton = document.createElement('button');
                    stakeButton.className = 'choice-btn';
                    stakeButton.textContent = "Use Vampire Killing Stake";
                    stakeButton.onclick = function() {
                        loadSection(111);
                    };
                    battleChoices.appendChild(stakeButton);
                }
                
                const decapitateButton = document.createElement('button');
                decapitateButton.className = 'choice-btn';
                decapitateButton.textContent = "Decapitate Him";
                decapitateButton.onclick = function() {
                    loadSection(112);
                };
                battleChoices.appendChild(decapitateButton);
                
                return;
            }
            
            resultText += `</div>`;
            document.getElementById('battle-text').innerHTML += resultText;
            
            // Valerius counterattacks
            setTimeout(() => {
                valeriusCounterAttack();
            }, 1000);
        }
        
        // Use healing in battle
        function useHealingInBattle() {
            // Find healing items
            const healingItems = gameState.inventory.filter(item => 
                item.includes('Potion') || item.includes('Wine') || item.includes('Water'));
            
            if (healingItems.length === 0) {
                document.getElementById('battle-text').innerHTML += `<div class="combat-log">You have no healing items!</div>`;
                return;
            }
            
            // Use first healing item
            const item = healingItems[0];
            removeFromInventory(item);
            
            const healAmount = item === 'Mountain Potion' ? rollDice(3, 6) + 10 : 
                             item === 'Ancient Vampire Wine' ? rollDice(2, 8) + 5 : 
                             item === 'Vial of Magical Water' ? rollDice(2, 6) : rollDice(2, 6) + 5;
            
            const oldHealth = gameState.health;
            gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
            const actualHeal = gameState.health - oldHealth;
            
            updateStatsDisplay();
            playSound('item');
            
            document.getElementById('battle-text').innerHTML += `<div class="combat-log">You use ${item} and heal ${actualHeal} health!</div>`;
            
            // Valerius gets a turn
            setTimeout(() => {
                valeriusCounterAttack();
            }, 1000);
        }
        
        // Valerius counterattack
        function valeriusCounterAttack() {
            if (!combatState.active) return;
            
            const enemyRoll = rollDice(2, 6);
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="vampire-lord">Valerius counterattacks!</span><br>`;
            resultText += `Valerius rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            // Simple counterattack - player can't defend during item use
            let enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
            
            // Phase adjustments
            if (gameState.valeriusPhase === 2) {
                enemyDamage = Math.floor(enemyDamage * 1.3);
            } else if (gameState.valeriusPhase === 3) {
                enemyDamage = Math.floor(enemyDamage * 1.5);
            }
            
            // Armor reduction
            let armorReduction = 0;
            if (gameState.equippedArmor.includes('Obsidian')) {
                armorReduction = 5;
            } else if (gameState.equippedArmor.includes('Plate')) {
                armorReduction = 3;
            } else if (gameState.equippedArmor.includes('Chain')) {
                armorReduction = 2;
            }
            
            enemyDamage = Math.max(1, enemyDamage - armorReduction);
            
            gameState.health -= enemyDamage;
            resultText += `<span class="damage">Valerius hits you for ${enemyDamage} damage while you're distracted!</span>`;
            playSound('damage');
            
            // Check if player died
            if (gameState.health <= 0) {
                combatState.active = false;
                resultText += `<br><span class="game-over">You have been defeated by Valerius! Game Over.</span>`;
                resultText += `</div>`;
                
                document.getElementById('battle-text').innerHTML += resultText;
                
                const battleChoices = document.getElementById('battle-choices');
                battleChoices.innerHTML = '';
                
                const gameOverButton = document.createElement('button');
                gameOverButton.className = 'choice-btn';
                gameOverButton.textContent = "Return to Main Menu";
                gameOverButton.onclick = function() {
                    localStorage.removeItem('castleUndeadGameState');
                    window.location.href = 'l1.html';
                };
                battleChoices.appendChild(gameOverButton);
                
                return;
            }
            
            resultText += `</div>`;
            document.getElementById('battle-text').innerHTML += resultText;
            updateStatsDisplay();
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 20 || sectionId === 33 || sectionId === 40 || 
                                   sectionId === 45 || sectionId === 48 || sectionId === 56 || 
                                   sectionId === 61 || sectionId === 65 || sectionId === 71 || 
                                   sectionId === 83 || sectionId === 87 || sectionId === 94 || 
                                   sectionId === 99 || sectionId === 107 || sectionId === 109);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active && !combatState.isValerius) {
                    // Combat ended (but not Valerius)
                    let goldReward = 0;
                    
                    if (combatState.enemyName.includes("Werewolf")) {
                        goldReward = Math.floor(Math.random() * 80) + 40;
                        gameState.werewolfGuardDefeated = true;
                    } else if (combatState.enemyName.includes("Vampire")) {
                        goldReward = Math.floor(Math.random() * 70) + 35;
                        gameState.vampireBrideDefeated = true;
                    } else if (combatState.enemyName.includes("Beast Hound")) {
                        goldReward = Math.floor(Math.random() * 60) + 30;
                        gameState.beastHoundsDefeated = true;
                    }
                    
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    
                    if (goldReward > 0) {
                        storyText += `<br>You find <span class="gold">${goldReward} Gold</span>.`;
                    }
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Only show on game screen (not battle screen)
            if (sectionId !== 79 && sectionId !== 88 && sectionId !== 94 && sectionId !== 99 && 
                sectionId !== 107 && sectionId !== 109 && !combatState.isValerius) {
                document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
                
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    if (typeof choice.requirement === 'function') {
                        return choice.requirement();
                    }
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue exploring the Master Quarters";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Complete the game
        function completeGame() {
            playSound('victory');
            localStorage.removeItem('castleUndeadGameState');
            localStorage.setItem('castleUndeadGameComplete', 'true');
            window.location.href = 'l1.html';
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
