<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dracula's Castle - Retro RPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
            image-rendering: pixelated;
        }
        
        body {
            background-color: #000;
            color: #0f0;
            overflow: hidden;
            touch-action: manipulation;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #game-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #000;
            border: 2px solid #0f0;
            position: relative;
        }
        
        #screen {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            border-bottom: 1px solid #0f0;
        }
        
        #input-area {
            display: flex;
            padding: 5px;
            border-top: 1px solid #0f0;
        }
        
        #input {
            flex: 1;
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 8px;
            font-size: 16px;
        }
        
        button {
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 8px 12px;
            margin-left: 5px;
            cursor: pointer;
        }
        
        button:active {
            background: #0f0;
            color: #000;
        }
        
        .screen-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
            text-shadow: 0 0 5px #0f0;
        }
        
        .menu-option {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #0f0;
            cursor: pointer;
        }
        
        .menu-option:hover, .menu-option.selected {
            background: #0f0;
            color: #000;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .stat {
            border: 1px solid #0f0;
            padding: 5px;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        
        .item {
            border: 1px solid #0f0;
            padding: 5px;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }
        
        .item-stats {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .equip-btn {
            margin-top: 5px;
            padding: 3px;
            font-size: 12px;
        }
        
        .combat-log {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #0f0;
            padding: 5px;
            margin-top: 10px;
        }
        
        .combat-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 10px;
        }
        
        .enemy {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .ascii-art {
            text-align: center;
            line-height: 1;
            font-family: monospace;
            margin: 10px 0;
            white-space: pre;
        }
        
        .hidden {
            display: none !important;
        }
        
        #notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px;
            z-index: 1000;
            max-width: 80%;
            text-align: center;
            display: none;
        }
        
        .message-log {
            height: 100px;
            overflow-y: auto;
            border: 1px solid #0f0;
            padding: 5px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .npc-dialogue {
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
            background: #111;
        }
        
        .npc-options {
            margin-top: 10px;
        }
        
        .npc-option {
            margin: 5px 0;
            padding: 5px;
            border: 1px solid #0f0;
            cursor: pointer;
        }
        
        .location-title {
            font-weight: bold;
            margin-bottom: 5px;
            text-align: center;
        }
        
        .room-exits {
            margin-top: 10px;
            font-style: italic;
        }
        
        .merchant-items {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 10px;
        }
        
        .merchant-item {
            border: 1px solid #0f0;
            padding: 5px;
            text-align: center;
        }
        
        .buy-btn {
            margin-top: 5px;
            padding: 3px;
            font-size: 12px;
        }
        
        .spell-option {
            margin: 5px 0;
            padding: 5px;
            border: 1px solid #0f0;
            cursor: pointer;
        }
        
        .combat-status {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .health-bar, .mana-bar {
            height: 10px;
            background: #333;
            margin: 2px 0;
        }
        
        .health-fill {
            height: 100%;
            background: #0f0;
        }
        
        .mana-fill {
            height: 100%;
            background: #00f;
        }
        
        /* Retro scanlines effect */
        body::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Notification Area -->
        <div id="notification"></div>
        
        <!-- Start Screen -->
        <div id="start-screen" class="screen">
            <div class="screen-title">DRACULA'S CASTLE</div>
            <div class="ascii-art">
   _____
  /  _  \
 |  / \  |
 |  \_/  |
  \_____/
            </div>
            <div class="menu-option" onclick="showClassSelection()">NEW GAME</div>
            <div class="menu-option" onclick="loadGame()">LOAD GAME</div>
            <div class="menu-option" onclick="showInstructions()">INSTRUCTIONS</div>
        </div>

        <!-- Class Selection Screen -->
        <div id="class-screen" class="screen hidden">
            <div class="screen-title">SELECT YOUR CLASS</div>
            <div class="menu-option" onclick="selectClass('Warrior')">
                WARRIOR<br>
                High HP and Strength<br>
                Starts with Leather Armor
            </div>
            <div class="menu-option" onclick="selectClass('Mage')">
                MAGE<br>
                High MP and Intelligence<br>
                Starts with Fireball spell
            </div>
            <div class="menu-option" onclick="selectClass('Rogue')">
                ROGUE<br>
                High Agility and Luck<br>
                Starts with Dagger and Lockpicks
            </div>
            <button onclick="showStartScreen()">BACK</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen hidden">
            <div class="stats">
                <div class="stat">HP: <span id="hp">100</span>/<span id="max-hp">100</span></div>
                <div class="stat">MP: <span id="mp">50</span>/<span id="max-mp">50</span></div>
                <div class="stat">Level: <span id="level">1</span></div>
                <div class="stat">XP: <span id="xp">0</span>/<span id="next-level">100</span></div>
                <div class="stat">Gold: <span id="gold">0</span></div>
                <div class="stat">Weapon: <span id="weapon">Fists</span> (<span id="weapon-dmg">5</span> DMG)</div>
                <div class="stat">Armor: <span id="armor">None</span> (<span id="armor-def">0</span> DEF)</div>
            </div>
            
            <div class="location-title" id="location-title">CASTLE ENTRANCE</div>
            <div id="location">You are at the entrance of Dracula's castle. The heavy wooden doors loom before you.</div>
            
            <div id="npc-container"></div>
            
            <div class="room-exits" id="room-exits"></div>
            
            <div class="message-log" id="message-log"></div>
            
            <div id="actions">
                <button onclick="move('north')">NORTH</button>
                <button onclick="move('east')">EAST</button>
                <button onclick="move('south')">SOUTH</button>
                <button onclick="move('west')">WEST</button>
                <button onclick="search()">SEARCH</button>
                <button onclick="showInventory()">INVENTORY</button>
                <button onclick="showSpellbook()">SPELLBOOK</button>
                <button onclick="rest()">REST</button>
                <button onclick="saveGame()">SAVE</button>
            </div>
        </div>

        <!-- Combat Screen -->
        <div id="combat-screen" class="screen hidden">
            <div class="enemy" id="enemy-name">VAMPIRE</div>
            <div class="ascii-art" id="enemy-art">
   .---.
  /     \
 | () () |
  \  ^  /
   |||||
            </div>
            <div class="stats">
                <div class="stat">Enemy HP: <span id="enemy-hp">50</span></div>
                <div class="stat">Your HP: <span id="player-hp-combat">100</span></div>
                <div class="stat">Your MP: <span id="player-mp-combat">50</span></div>
            </div>
            
            <div class="combat-log" id="combat-log">
                A vampire appears! Prepare for battle!
            </div>
            
            <div class="combat-actions">
                <button onclick="attack()">ATTACK</button>
                <button onclick="showSpellsInCombat()">CAST SPELL</button>
                <button onclick="useItemInCombat()">USE ITEM</button>
                <button onclick="flee()">FLEE</button>
            </div>
        </div>

        <!-- Spell Selection in Combat -->
        <div id="spell-select-screen" class="screen hidden">
            <div class="screen-title">SELECT SPELL</div>
            <div id="spell-select-list">
                <!-- Spells will be populated here -->
            </div>
            <button onclick="showCombatScreen()">BACK</button>
        </div>

        <!-- Item Selection in Combat -->
        <div id="item-select-screen" class="screen hidden">
            <div class="screen-title">SELECT ITEM</div>
            <div id="item-select-list">
                <!-- Items will be populated here -->
            </div>
            <button onclick="showCombatScreen()">BACK</button>
        </div>

        <!-- Inventory Screen -->
        <div id="inventory-screen" class="screen hidden">
            <div class="screen-title">INVENTORY</div>
            <div class="inventory-grid" id="inventory-grid">
                <!-- Items will be populated here -->
            </div>
            <button onclick="showGameScreen()">BACK</button>
        </div>

        <!-- Spellbook Screen -->
        <div id="spellbook-screen" class="screen hidden">
            <div class="screen-title">SPELLBOOK</div>
            <div id="spell-list">
                <!-- Spells will be populated here -->
            </div>
            <button onclick="showGameScreen()">BACK</button>
        </div>

        <!-- Merchant Screen -->
        <div id="merchant-screen" class="screen hidden">
            <div class="screen-title">WANDERING MERCHANT</div>
            <div id="merchant-dialogue">"Greetings traveler! What can I interest you in today?"</div>
            <div class="merchant-items" id="merchant-items">
                <!-- Merchant items will be populated here -->
            </div>
            <div class="stats">
                <div class="stat">Your Gold: <span id="merchant-gold">0</span></div>
            </div>
            <button onclick="showGameScreen()">LEAVE</button>
        </div>

        <!-- Input Area -->
        <div id="input-area">
            <input type="text" id="input" placeholder="Enter command...">
            <button onclick="processInput()">ENTER</button>
        </div>
    </div>

    <script>
        // Audio Context for Sound Effects
        let audioContext;
        let backgroundNoise;
        
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log("Web Audio API is not supported in this browser");
            }
        }
        
        function playSound(frequency, duration, type = 'sine') {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }
        
        function playClickSound() {
            playSound(800, 0.1, 'square');
        }
        
        function playActionSound() {
            playSound(600, 0.2, 'sawtooth');
        }
        
        function playCombatSound() {
            playSound(400, 0.3, 'triangle');
        }
        
        function playLevelUpSound() {
            // Play a rising tone
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.5);
            
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }
        
        function playPurchaseSound() {
            playSound(1200, 0.2, 'sine');
        }
        
        function playSpellSound() {
            playSound(1000, 0.4, 'sine');
        }
        
        // Background sounds for different areas
        function playBackgroundSound(location) {
            if (!audioContext) return;
            
            // Stop any existing background sound
            if (backgroundNoise) {
                backgroundNoise.stop();
            }
            
            // Create a new background sound based on location
            backgroundNoise = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            backgroundNoise.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Set different sounds for different locations
            switch(location) {
                case 'entrance':
                case 'courtyard':
                    backgroundNoise.frequency.value = 80;
                    backgroundNoise.type = 'sawtooth';
                    gainNode.gain.value = 0.02;
                    break;
                case 'chapel':
                    backgroundNoise.frequency.value = 110;
                    backgroundNoise.type = 'sine';
                    gainNode.gain.value = 0.015;
                    break;
                case 'library':
                case 'study':
                    backgroundNoise.frequency.value = 150;
                    backgroundNoise.type = 'triangle';
                    gainNode.gain.value = 0.01;
                    break;
                case 'dungeon':
                case 'crypt':
                case 'catacombs':
                    backgroundNoise.frequency.value = 60;
                    backgroundNoise.type = 'square';
                    gainNode.gain.value = 0.025;
                    break;
                case 'throneRoom':
                    backgroundNoise.frequency.value = 45;
                    backgroundNoise.type = 'sawtooth';
                    gainNode.gain.value = 0.03;
                    break;
                case 'gardens':
                    backgroundNoise.frequency.value = 200;
                    backgroundNoise.type = 'sine';
                    gainNode.gain.value = 0.01;
                    break;
                case 'tower':
                    backgroundNoise.frequency.value = 120;
                    backgroundNoise.type = 'triangle';
                    gainNode.gain.value = 0.015;
                    break;
                default:
                    backgroundNoise.frequency.value = 100;
                    backgroundNoise.type = 'sine';
                    gainNode.gain.value = 0.01;
            }
            
            backgroundNoise.start();
        }

        // Game State
        const gameState = {
            screen: 'start',
            player: {
                class: '',
                level: 1,
                xp: 0,
                nextLevel: 100,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                str: 10,
                int: 10,
                agi: 10,
                weapon: { name: 'Fists', dmg: 5 },
                armor: { name: 'None', def: 0 },
                inventory: [],
                spells: [],
                location: 'entrance',
                gold: 50,
                quests: []
            },
            map: {
                entrance: {
                    title: 'CASTLE ENTRANCE',
                    description: 'You are at the entrance of Dracula\'s castle. The heavy wooden doors loom before you.',
                    north: 'courtyard',
                    east: null,
                    south: null,
                    west: null,
                    searched: false,
                    enemy: null,
                    npc: null
                },
                courtyard: {
                    title: 'COURTYARD',
                    description: 'A vast courtyard surrounded by high walls. A fountain with a gargoyle stands in the center.',
                    north: 'greatHall',
                    east: 'stables',
                    south: 'entrance',
                    west: 'chapel',
                    searched: false,
                    enemy: 'zombie',
                    npc: null
                },
                stables: {
                    title: 'STABLES',
                    description: 'Empty horse stalls line the walls. The air smells of hay and decay.',
                    north: null,
                    east: null,
                    south: null,
                    west: 'courtyard',
                    searched: false,
                    enemy: 'ghost',
                    npc: null
                },
                chapel: {
                    title: 'CHAPEL',
                    description: 'A small chapel with broken pews and a defiled altar.',
                    north: null,
                    east: 'courtyard',
                    south: null,
                    west: null,
                    searched: false,
                    enemy: null,
                    npc: { 
                        name: 'Father Dimitru', 
                        dialogue: [
                            "I have been hiding here for weeks.",
                            "Dracula's evil has corrupted this holy place.",
                            "If you seek to defeat him, you'll need a blessed weapon.",
                            "I can bless your weapon if you bring me holy water from the crypt."
                        ],
                        quest: {
                            type: 'fetch',
                            item: 'holyWater',
                            reward: { type: 'weapon', item: 'blessedSword' },
                            completed: false
                        }
                    }
                },
                greatHall: {
                    title: 'GREAT HALL',
                    description: 'You stand in a vast, dusty hall. Tattered banners hang from the walls.',
                    north: 'diningRoom',
                    east: 'library',
                    south: 'courtyard',
                    west: 'armory',
                    searched: false,
                    enemy: 'skeleton',
                    npc: null
                },
                diningRoom: {
                    title: 'DINING ROOM',
                    description: 'A long table covered in dust and cobwebs. Silverware is neatly arranged.',
                    north: 'kitchen',
                    east: null,
                    south: 'greatHall',
                    west: null,
                    searched: false,
                    enemy: 'ratKing',
                    npc: null
                },
                kitchen: {
                    title: 'KITCHEN',
                    description: 'A cold, dark kitchen with pots and pans hanging from hooks.',
                    north: 'pantry',
                    east: null,
                    south: 'diningRoom',
                    west: null,
                    searched: false,
                    enemy: null,
                    npc: { 
                        name: 'Chef Boris', 
                        dialogue: [
                            "I'm the last survivor of the castle staff.",
                            "Dracula turned the others into his minions.",
                            "I can cook you a healing stew if you bring me ingredients.",
                            "I need wolf meat from the courtyard and mushrooms from the crypt."
                        ],
                        quest: {
                            type: 'fetchMultiple',
                            items: ['wolfMeat', 'mushrooms'],
                            reward: { type: 'consumable', item: 'healingStew', quantity: 3 },
                            completed: false
                        }
                    }
                },
                pantry: {
                    title: 'PANTRY',
                    description: 'Shelves filled with preserved foods, most now rotten.',
                    north: null,
                    east: null,
                    south: 'kitchen',
                    west: null,
                    searched: false,
                    enemy: 'ghoul',
                    npc: null
                },
                library: {
                    title: 'LIBRARY',
                    description: 'Books line the walls from floor to ceiling. Many appear to be ancient.',
                    north: 'study',
                    east: null,
                    south: null,
                    west: 'greatHall',
                    searched: false,
                    enemy: 'vampire',
                    npc: { 
                        name: 'Professor Van Helsing', 
                        dialogue: [
                            "I've been researching Dracula's weaknesses.",
                            "He is vulnerable to silver and sunlight.",
                            "I can craft you silver bullets if you bring me silver ore.",
                            "You'll find it in the mines beneath the castle."
                        ],
                        quest: {
                            type: 'fetch',
                            item: 'silverOre',
                            reward: { type: 'ammo', item: 'silverBullets', quantity: 10 },
                            completed: false
                        }
                    }
                },
                study: {
                    title: 'STUDY',
                    description: 'A small room with a writing desk and a single candle burning.',
                    north: null,
                    east: null,
                    south: 'library',
                    west: null,
                    searched: false,
                    enemy: null,
                    npc: null
                },
                armory: {
                    title: 'ARMORY',
                    description: 'Weapons and armor line the walls, covered in a thick layer of dust.',
                    north: 'barracks',
                    east: 'greatHall',
                    south: null,
                    west: 'dungeon',
                    searched: false,
                    enemy: 'armoredSkeleton',
                    npc: null
                },
                barracks: {
                    title: 'BARRACKS',
                    description: 'Rows of empty beds where Dracula\'s guards once slept.',
                    north: null,
                    east: null,
                    south: 'armory',
                    west: null,
                    searched: false,
                    enemy: 'vampireKnight',
                    npc: null
                },
                dungeon: {
                    title: 'DUNGEON',
                    description: 'A dark, damp dungeon with cells lining the walls.',
                    north: 'tortureChamber',
                    east: 'armory',
                    south: null,
                    west: 'crypt',
                    searched: false,
                    enemy: 'ghoul',
                    npc: null
                },
                tortureChamber: {
                    title: 'TORTURE CHAMBER',
                    description: 'Gruesome devices fill this room. The air is thick with suffering.',
                    north: null,
                    east: null,
                    south: 'dungeon',
                    west: null,
                    searched: false,
                    enemy: 'torturedSoul',
                    npc: null
                },
                crypt: {
                    title: 'CRYPT',
                    description: 'Stone coffins line the walls. The air is cold and still.',
                    north: null,
                    east: 'dungeon',
                    south: null,
                    west: 'catacombs',
                    searched: false,
                    enemy: 'wraith',
                    npc: null
                },
                catacombs: {
                    title: 'CATACOMBS',
                    description: 'A maze of tunnels filled with bones and ancient tombs.',
                    north: 'ancientTomb',
                    east: 'crypt',
                    south: null,
                    west: null,
                    searched: false,
                    enemy: 'lich',
                    npc: null
                },
                ancientTomb: {
                    title: 'ANCIENT TOMB',
                    description: 'An ornate tomb with glowing runes on the walls.',
                    north: null,
                    east: null,
                    south: 'catacombs',
                    west: null,
                    searched: false,
                    enemy: null,
                    npc: { 
                        name: 'Spirit of the Ancient King', 
                        dialogue: [
                            "I have watched over this castle for centuries.",
                            "Dracula defiles this sacred place with his presence.",
                            "Take my blessing. It will protect you from his dark magic."
                        ],
                        quest: {
                            type: 'blessing',
                            reward: { type: 'buff', effect: 'holyProtection' },
                            completed: false
                        }
                    }
                },
                throneRoom: {
                    title: 'THRONE ROOM',
                    description: 'A massive room with a throne at the far end. Dracula awaits you.',
                    north: null,
                    east: null,
                    south: 'greatHall',
                    west: null,
                    searched: false,
                    enemy: 'dracula',
                    npc: null
                },
                // New areas
                gardens: {
                    title: 'CASTLE GARDENS',
                    description: 'Overgrown gardens with twisted, thorny plants and dead trees.',
                    north: 'maze',
                    east: 'courtyard',
                    south: null,
                    west: 'greenhouse',
                    searched: false,
                    enemy: 'werewolf',
                    npc: null
                },
                maze: {
                    title: 'HEDGE MAZE',
                    description: 'A confusing maze of tall hedges. You hear strange rustling sounds.',
                    north: null,
                    east: null,
                    south: 'gardens',
                    west: 'mazeCenter',
                    searched: false,
                    enemy: 'gargoyle',
                    npc: null
                },
                mazeCenter: {
                    title: 'MAZE CENTER',
                    description: 'The center of the hedge maze. A stone statue stands here.',
                    north: null,
                    east: 'maze',
                    south: null,
                    west: null,
                    searched: false,
                    enemy: null,
                    npc: { 
                        name: 'Wandering Merchant', 
                        dialogue: [
                            "Ah, a customer! I travel between worlds selling rare goods.",
                            "Take a look at my wares. I guarantee you won't find better prices anywhere!"
                        ],
                        type: 'merchant'
                    }
                },
                greenhouse: {
                    title: 'ABANDONED GREENHOUSE',
                    description: 'A glass structure filled with strange, glowing plants.',
                    north: null,
                    east: 'gardens',
                    south: null,
                    west: null,
                    searched: false,
                    enemy: 'venomousIvy',
                    npc: null
                },
                tower: {
                    title: 'OBSERVATION TOWER',
                    description: 'A tall tower with a spiral staircase. You can see the entire castle from here.',
                    north: null,
                    east: 'greatHall',
                    south: null,
                    west: null,
                    searched: false,
                    enemy: 'vampireBatSwarm',
                    npc: { 
                        name: 'Mad Alchemist', 
                        dialogue: [
                            "The stars are not right! The alignment is all wrong!",
                            "I can teach you powerful alchemical spells if you help me.",
                            "Bring me a phoenix feather from the aviary and I'll share my knowledge."
                        ],
                        quest: {
                            type: 'fetch',
                            item: 'phoenixFeather',
                            reward: { type: 'spell', item: 'alchemicalFire' },
                            completed: false
                        }
                    }
                },
                aviary: {
                    title: 'RUINED AVIARY',
                    description: 'A large cage filled with skeletal remains of exotic birds.',
                    north: null,
                    east: null,
                    south: 'tower',
                    west: null,
                    searched: false,
                    enemy: 'phoenix',
                    npc: null
                },
                wineCellar: {
                    title: 'WINE CELLAR',
                    description: 'Rows of wine barrels, most now empty or filled with vinegar.',
                    north: 'secretPassage',
                    east: 'kitchen',
                    south: null,
                    west: null,
                    searched: false,
                    enemy: 'drunkenGhost',
                    npc: null
                },
                secretPassage: {
                    title: 'SECRET PASSAGE',
                    description: 'A hidden corridor behind a wine rack. Dust covers everything.',
                    north: 'treasureRoom',
                    east: null,
                    south: 'wineCellar',
                    west: null,
                    searched: false,
                    enemy: 'mimic',
                    npc: null
                },
                treasureRoom: {
                    title: 'HIDDEN TREASURE ROOM',
                    description: 'A small room filled with gold coins and valuable artifacts.',
                    north: null,
                    east: null,
                    south: 'secretPassage',
                    west: null,
                    searched: false,
                    enemy: null,
                    npc: null
                }
            },
            currentEnemy: null,
            inCombat: false,
            currentNPC: null,
            merchantItems: [
                { item: 'healthPotion', price: 10 },
                { item: 'manaPotion', price: 15 },
                { item: 'dagger', price: 25 },
                { item: 'sword', price: 50 },
                { item: 'leatherArmor', price: 40 },
                { item: 'chainmail', price: 80 },
                { item: 'greaterHealthPotion', price: 30 },
                { item: 'greaterManaPotion', price: 35 },
                { item: 'magicAmulet', price: 100 }
            ]
        };

        // Items Database
        const items = {
            healthPotion: { name: 'Health Potion', type: 'consumable', effect: 'restoreHp', value: 20 },
            manaPotion: { name: 'Mana Potion', type: 'consumable', effect: 'restoreMp', value: 15 },
            greaterHealthPotion: { name: 'Greater Health Potion', type: 'consumable', effect: 'restoreHp', value: 50 },
            greaterManaPotion: { name: 'Greater Mana Potion', type: 'consumable', effect: 'restoreMp', value: 40 },
            healingStew: { name: 'Healing Stew', type: 'consumable', effect: 'restoreHp', value: 40 },
            dagger: { name: 'Dagger', type: 'weapon', dmg: 8 },
            sword: { name: 'Sword', type: 'weapon', dmg: 12 },
            blessedSword: { name: 'Blessed Sword', type: 'weapon', dmg: 18 },
            silverSword: { name: 'Silver Sword', type: 'weapon', dmg: 22 },
            leatherArmor: { name: 'Leather Armor', type: 'armor', def: 5 },
            chainmail: { name: 'Chainmail', type: 'armor', def: 10 },
            vampireArmor: { name: 'Vampire Armor', type: 'armor', def: 15 },
            magicAmulet: { name: 'Magic Amulet', type: 'accessory', effect: 'increaseMp', value: 20 },
            holyWater: { name: 'Holy Water', type: 'quest', description: 'Sacred water from the crypt' },
            wolfMeat: { name: 'Wolf Meat', type: 'quest', description: 'Meat from a werewolf' },
            mushrooms: { name: 'Glowing Mushrooms', type: 'quest', description: 'Mushrooms from the crypt' },
            silverOre: { name: 'Silver Ore', type: 'quest', description: 'Raw silver from the mines' },
            phoenixFeather: { name: 'Phoenix Feather', type: 'quest', description: 'Feather from a phoenix' },
            silverBullets: { name: 'Silver Bullets', type: 'ammo', dmg: 8, quantity: 10 },
            lockpick: { name: 'Lockpick', type: 'tool', description: 'Used to open locked doors' }
        };

        // Spells Database
        const spells = {
            fireball: { name: 'Fireball', cost: 10, dmg: 15, description: 'Launches a ball of fire' },
            heal: { name: 'Heal', cost: 8, heal: 20, description: 'Restores health' },
            lightning: { name: 'Lightning', cost: 12, dmg: 18, description: 'Calls down a lightning bolt' },
            holyWater: { name: 'Holy Water', cost: 15, dmg: 25, description: 'Blessed water that harms undead' },
            sunlight: { name: 'Sunlight', cost: 20, dmg: 30, description: 'Creates a burst of sunlight' },
            shield: { name: 'Shield', cost: 10, defense: 10, description: 'Creates a protective barrier', duration: 3 },
            poison: { name: 'Poison', cost: 12, dmg: 5, description: 'Poisons the enemy over time', duration: 3 },
            teleport: { name: 'Teleport', cost: 25, description: 'Escape from non-boss battles' },
            alchemicalFire: { name: 'Alchemical Fire', cost: 18, dmg: 22, description: 'A powerful alchemical explosion' },
            iceShard: { name: 'Ice Shard', cost: 14, dmg: 16, description: 'Launches sharp ice crystals' },
            lifeDrain: { name: 'Life Drain', cost: 15, dmg: 12, heal: 8, description: 'Drains life from enemy to heal yourself' }
        };

        // Enemy Database
        const enemies = {
            zombie: { 
                name: 'Zombie', 
                hp: 30, 
                dmg: 8,
                xp: 20,
                art: `   .---.
  /     \\
 | () () |
  \\  ^  /
   |||||`
            },
            vampire: {
                name: 'Vampire',
                hp: 50,
                dmg: 12,
                xp: 40,
                art: `    .-.
   (o.o)
    |=|
   __|__
  //.=.\\
 //=.=.\\
 \\=.=.//
  \\(.)//
   (:")
    "-"`
            },
            dracula: {
                name: 'Dracula',
                hp: 200,
                dmg: 25,
                xp: 300,
                art: `     .-.
    (0.0)
     |=|
    __|__
   //.=.\\
  //=.=.\\
  \\=.=.//
   \\(.)//
    (:")
     "-"`
            },
            ghost: {
                name: 'Ghost',
                hp: 25,
                dmg: 6,
                xp: 15,
                art: `   .---.
  /     \\
 | . . |
  \\  ~  /
   |||||`
            },
            skeleton: {
                name: 'Skeleton',
                hp: 35,
                dmg: 10,
                xp: 25,
                art: `   .---.
  /     \\
 | X X |
  \\  -  /
   |||||`
            },
            ratKing: {
                name: 'Rat King',
                hp: 40,
                dmg: 9,
                xp: 30,
                art: `   .---.
  /     \\
 | o o |
  \\  @  /
   |||||`
            },
            ghoul: {
                name: 'Ghoul',
                hp: 45,
                dmg: 11,
                xp: 35,
                art: `   .---.
  /     \\
 | - - |
  \\  #  /
   |||||`
            },
            armoredSkeleton: {
                name: 'Armored Skeleton',
                hp: 60,
                dmg: 14,
                xp: 45,
                art: `   .---.
  /|   |\\
 | X X |
  \\  -  /
   |||||`
            },
            vampireKnight: {
                name: 'Vampire Knight',
                hp: 80,
                dmg: 18,
                xp: 60,
                art: `    .-.
   (o.o)
   /|=|\\
  //.=.\\
 //=.=.\\
 \\=.=.//
  \\(.)//
   (:")
    "-"`
            },
            torturedSoul: {
                name: 'Tortured Soul',
                hp: 55,
                dmg: 13,
                xp: 40,
                art: `   .---.
  /     \\
 | T T |
  \\  ~  /
   |||||`
            },
            wraith: {
                name: 'Wraith',
                hp: 70,
                dmg: 16,
                xp: 50,
                art: `   .---.
  /     \\
 | W W |
  \\  ~  /
   |||||`
            },
            lich: {
                name: 'Lich',
                hp: 90,
                dmg: 20,
                xp: 70,
                art: `   .---.
  /     \\
 | L L |
  \\  ~  /
   |||||`
            },
            // New enemies
            werewolf: {
                name: 'Werewolf',
                hp: 75,
                dmg: 16,
                xp: 55,
                art: `   .---.
  /     \\
 | W W |
  \\  #  /
   |||||`
            },
            gargoyle: {
                name: 'Gargoyle',
                hp: 85,
                dmg: 14,
                xp: 60,
                art: `   .---.
  /|   |\\
 | G G |
  \\  #  /
   |||||`
            },
            venomousIvy: {
                name: 'Venomous Ivy',
                hp: 50,
                dmg: 12,
                xp: 35,
                art: `   ~~~~
  ~~~~~~
 ~~~~~~~
  ~~~~~~
   ~~~~`
            },
            vampireBatSwarm: {
                name: 'Vampire Bat Swarm',
                hp: 65,
                dmg: 15,
                xp: 45,
                art: `   ....
  ......
 .......
  ......
   ....`
            },
            phoenix: {
                name: 'Phoenix',
                hp: 110,
                dmg: 22,
                xp: 80,
                art: `   .---.
  /     \\
 | P P |
  \\  @  /
   |||||`
            },
            drunkenGhost: {
                name: 'Drunken Ghost',
                hp: 40,
                dmg: 10,
                xp: 30,
                art: `   .---.
  /     \\
 | ~ ~ |
  \\  ~  /
   |||||`
            },
            mimic: {
                name: 'Mimic',
                hp: 95,
                dmg: 18,
                xp: 65,
                art: `   .---.
  /     \\
 | $ $ |
  \\  #  /
   |||||`
            }
        };

        // Notification System
        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }
        
        function addMessage(message) {
            const messageLog = document.getElementById('message-log');
            if (!messageLog) return;
            
            const messageElement = document.createElement('div');
            messageElement.textContent = `> ${message}`;
            messageLog.appendChild(messageElement);
            messageLog.scrollTop = messageLog.scrollHeight;
        }

        // Screen Management
        function showScreen(screenId) {
            playClickSound();
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            gameState.screen = screenId;
        }

        function showStartScreen() {
            showScreen('start-screen');
        }

        function showClassSelection() {
            showScreen('class-screen');
        }

        function showGameScreen() {
            showScreen('game-screen');
            updateGameScreen();
        }

        function showCombatScreen() {
            showScreen('combat-screen');
        }

        function showSpellSelectScreen() {
            showScreen('spell-select-screen');
            updateSpellSelect();
        }

        function showItemSelectScreen() {
            showScreen('item-select-screen');
            updateItemSelect();
        }

        function showInventory() {
            showScreen('inventory-screen');
            updateInventory();
        }

        function showSpellbook() {
            showScreen('spellbook-screen');
            updateSpellbook();
        }

        function showMerchantScreen() {
            showScreen('merchant-screen');
            updateMerchantScreen();
        }

        function showInstructions() {
            addMessage("DRACULA'S CASTLE - INSTRUCTIONS");
            addMessage("Explore Dracula's castle, defeat enemies, gain XP and level up.");
            addMessage("Find better weapons and armor. Cast spells from your spellbook.");
            addMessage("Talk to NPCs for quests and information.");
            addMessage("Find and defeat Dracula to win the game!");
            addMessage("Use the buttons or type commands to play.");
        }

        // Class Selection
        function selectClass(className) {
            playActionSound();
            gameState.player.class = className;
            
            // Set class-specific starting items
            switch(className) {
                case 'Warrior':
                    gameState.player.armor = {...items.leatherArmor};
                    gameState.player.str = 15;
                    gameState.player.maxHp = 120;
                    gameState.player.hp = 120;
                    addMessage("You chose the Warrior class! You start with Leather Armor.");
                    break;
                case 'Mage':
                    gameState.player.spells.push({...spells.fireball});
                    gameState.player.int = 15;
                    gameState.player.maxMp = 80;
                    gameState.player.mp = 80;
                    addMessage("You chose the Mage class! You start with the Fireball spell.");
                    break;
                case 'Rogue':
                    gameState.player.weapon = {...items.dagger};
                    gameState.player.inventory.push({...items.healthPotion});
                    gameState.player.inventory.push({...items.lockpick});
                    gameState.player.agi = 15;
                    addMessage("You chose the Rogue class! You start with a Dagger, Health Potion, and Lockpick.");
                    break;
            }
            
            showGameScreen();
        }

        // Game Screen Updates
        function updateGameScreen() {
            document.getElementById('hp').textContent = gameState.player.hp;
            document.getElementById('max-hp').textContent = gameState.player.maxHp;
            document.getElementById('mp').textContent = gameState.player.mp;
            document.getElementById('max-mp').textContent = gameState.player.maxMp;
            document.getElementById('level').textContent = gameState.player.level;
            document.getElementById('xp').textContent = gameState.player.xp;
            document.getElementById('next-level').textContent = gameState.player.nextLevel;
            document.getElementById('gold').textContent = gameState.player.gold;
            document.getElementById('weapon').textContent = gameState.player.weapon.name;
            document.getElementById('weapon-dmg').textContent = gameState.player.weapon.dmg;
            document.getElementById('armor').textContent = gameState.player.armor.name;
            document.getElementById('armor-def').textContent = gameState.player.armor.def;
            
            const location = gameState.map[gameState.player.location];
            document.getElementById('location-title').textContent = location.title;
            document.getElementById('location').textContent = location.description;
            
            // Update room exits
            let exits = "Exits: ";
            if (location.north) exits += "North ";
            if (location.east) exits += "East ";
            if (location.south) exits += "South ";
            if (location.west) exits += "West";
            document.getElementById('room-exits').textContent = exits;
            
            // Update NPC display
            const npcContainer = document.getElementById('npc-container');
            npcContainer.innerHTML = '';
            
            if (location.npc) {
                const npcElement = document.createElement('div');
                
                if (location.npc.type === 'merchant') {
                    npcElement.className = 'npc-dialogue';
                    npcElement.innerHTML = `
                        <strong>${location.npc.name}:</strong> ${location.npc.dialogue[0]}
                        <div class="npc-options">
                            <div class="npc-option" onclick="showMerchantScreen()">TRADE</div>
                            <div class="npc-option" onclick="updateGameScreen()">LEAVE</div>
                        </div>
                    `;
                } else {
                    npcElement.className = 'npc-dialogue';
                    npcElement.innerHTML = `
                        <strong>${location.npc.name}:</strong> ${location.npc.dialogue[0]}
                        <div class="npc-options">
                            <div class="npc-option" onclick="talkToNPC('${gameState.player.location}')">TALK</div>
                        </div>
                    `;
                }
                
                npcContainer.appendChild(npcElement);
            }
            
            // Play background sound for this location
            playBackgroundSound(gameState.player.location);
        }

        // NPC Interaction
        function talkToNPC(locationId) {
            playActionSound();
            const location = gameState.map[locationId];
            const npc = location.npc;
            gameState.currentNPC = npc;
            
            const npcContainer = document.getElementById('npc-container');
            npcContainer.innerHTML = '';
            
            let dialogueHTML = `<strong>${npc.name}:</strong> `;
            
            // Show different dialogue based on quest status
            if (npc.quest && !npc.quest.completed) {
                if (npc.quest.type === 'fetch') {
                    const hasItem = gameState.player.inventory.some(item => item.name === npc.quest.item);
                    if (hasItem) {
                        dialogueHTML += `"Thank you for bringing me the ${items[npc.quest.item].name}! Here is your reward."`;
                        completeQuest(locationId);
                    } else {
                        dialogueHTML += npc.dialogue.join(' ');
                    }
                } else if (npc.quest.type === 'fetchMultiple') {
                    const hasAllItems = npc.quest.items.every(itemName => 
                        gameState.player.inventory.some(item => item.name === itemName)
                    );
                    if (hasAllItems) {
                        dialogueHTML += `"Thank you for bringing all the ingredients! Here is your reward."`;
                        completeQuest(locationId);
                    } else {
                        dialogueHTML += npc.dialogue.join(' ');
                    }
                } else if (npc.quest.type === 'blessing') {
                    dialogueHTML += npc.dialogue.join(' ');
                    completeQuest(locationId);
                }
            } else {
                // Random dialogue after quest completion
                const randomDialogue = npc.dialogue[Math.floor(Math.random() * npc.dialogue.length)];
                dialogueHTML += `"${randomDialogue}"`;
            }
            
            const npcElement = document.createElement('div');
            npcElement.className = 'npc-dialogue';
            npcElement.innerHTML = dialogueHTML + `<div class="npc-options"><div class="npc-option" onclick="updateGameScreen()">GO BACK</div></div>`;
            npcContainer.appendChild(npcElement);
        }
        
        function completeQuest(locationId) {
            const npc = gameState.map[locationId].npc;
            const quest = npc.quest;
            
            if (quest.type === 'fetch') {
                // Remove the quest item from inventory
                const itemIndex = gameState.player.inventory.findIndex(item => item.name === quest.item);
                if (itemIndex !== -1) {
                    gameState.player.inventory.splice(itemIndex, 1);
                }
            } else if (quest.type === 'fetchMultiple') {
                // Remove all quest items from inventory
                quest.items.forEach(itemName => {
                    const itemIndex = gameState.player.inventory.findIndex(item => item.name === itemName);
                    if (itemIndex !== -1) {
                        gameState.player.inventory.splice(itemIndex, 1);
                    }
                });
            }
            
            // Give reward
            if (quest.reward.type === 'weapon') {
                gameState.player.weapon = {...items[quest.reward.item]};
                addMessage(`You received: ${items[quest.reward.item].name}`);
            } else if (quest.reward.type === 'consumable') {
                for (let i = 0; i < quest.reward.quantity; i++) {
                    gameState.player.inventory.push({...items[quest.reward.item]});
                }
                addMessage(`You received: ${quest.reward.quantity} ${items[quest.reward.item].name}`);
            } else if (quest.reward.type === 'ammo') {
                gameState.player.inventory.push({...items[quest.reward.item], quantity: quest.reward.quantity});
                addMessage(`You received: ${quest.reward.quantity} ${items[quest.reward.item].name}`);
            } else if (quest.reward.type === 'buff') {
                // Apply buff to player
                addMessage("You feel a holy protection surrounding you!");
            } else if (quest.reward.type === 'spell') {
                gameState.player.spells.push({...spells[quest.reward.item]});
                addMessage(`You learned a new spell: ${spells[quest.reward.item].name}!`);
            }
            
            // Mark quest as completed
            quest.completed = true;
            addMessage(`Quest completed: ${npc.name}'s request`);
            
            updateGameScreen();
        }

        // Movement
        function move(direction) {
            playActionSound();
            const location = gameState.map[gameState.player.location];
            const newLocation = location[direction];
            
            if (newLocation) {
                gameState.player.location = newLocation;
                updateGameScreen();
                
                // Check for enemy encounter
                const newLoc = gameState.map[newLocation];
                if (newLoc.enemy && !newLoc.searched) {
                    startCombat(newLoc.enemy);
                }
                
                // Special case: If player reaches throne room and defeats Dracula
                if (newLocation === 'throneRoom' && !newLoc.enemy) {
                    document.getElementById('location').textContent = 'You stand in the throne room. Dracula has been defeated! You have won the game!';
                    addMessage("CONGRATULATIONS! You have defeated Dracula and saved the land!");
                    addMessage("You are a true hero!");
                }
            } else {
                document.getElementById('location').textContent = 'You cannot go that way.';
            }
        }

        // Search Function
        function search() {
            playActionSound();
            const location = gameState.map[gameState.player.location];
            
            if (!location.searched) {
                location.searched = true;
                
                // Random chance to find an item
                if (Math.random() > 0.5) {
                    const itemKeys = Object.keys(items);
                    const randomItemKey = itemKeys[Math.floor(Math.random() * itemKeys.length)];
                    const randomItem = {...items[randomItemKey]};
                    gameState.player.inventory.push(randomItem);
                    document.getElementById('location').textContent = `You found a ${randomItem.name}!`;
                    addMessage(`You found a ${randomItem.name}!`);
                    
                    // Special items in specific locations
                    if (gameState.player.location === 'crypt' && !gameState.player.inventory.some(item => item.name === 'Holy Water')) {
                        gameState.player.inventory.push({...items.holyWater});
                        addMessage("You found Holy Water in the crypt!");
                    }
                    if (gameState.player.location === 'courtyard' && !gameState.player.inventory.some(item => item.name === 'Wolf Meat')) {
                        gameState.player.inventory.push({...items.wolfMeat});
                        addMessage("You found Wolf Meat in the courtyard!");
                    }
                    if (gameState.player.location === 'catacombs' && !gameState.player.inventory.some(item => item.name === 'Glowing Mushrooms')) {
                        gameState.player.inventory.push({...items.mushrooms});
                        addMessage("You found Glowing Mushrooms in the catacombs!");
                    }
                    if (gameState.player.location === 'aviary' && !gameState.player.inventory.some(item => item.name === 'Phoenix Feather')) {
                        gameState.player.inventory.push({...items.phoenixFeather});
                        addMessage("You found a Phoenix Feather in the aviary!");
                    }
                    if (gameState.player.location === 'treasureRoom') {
                        const goldFound = Math.floor(Math.random() * 100) + 50;
                        gameState.player.gold += goldFound;
                        addMessage(`You found ${goldFound} gold in the treasure room!`);
                    }
                } else {
                    document.getElementById('location').textContent = 'You search the area but find nothing of value.';
                    addMessage('You search the area but find nothing of value.');
                }
            } else {
                document.getElementById('location').textContent = 'You have already searched this area.';
                addMessage('You have already searched this area.');
            }
        }

        // Rest Function
        function rest() {
            playActionSound();
            if (gameState.player.hp < gameState.player.maxHp || gameState.player.mp < gameState.player.maxMp) {
                const location = gameState.map[gameState.player.location];
                
                // Can't rest in combat areas or with enemies present
                if (location.enemy) {
                    addMessage("It's not safe to rest here with enemies nearby!");
                    return;
                }
                
                gameState.player.hp = Math.min(gameState.player.hp + 20, gameState.player.maxHp);
                gameState.player.mp = Math.min(gameState.player.mp + 15, gameState.player.maxMp);
                addMessage("You rest and recover some HP and MP.");
                updateGameScreen();
            } else {
                addMessage("You are already at full health and mana.");
            }
        }

        // Merchant System
        function updateMerchantScreen() {
            document.getElementById('merchant-gold').textContent = gameState.player.gold;
            
            const merchantItems = document.getElementById('merchant-items');
            merchantItems.innerHTML = '';
            
            gameState.merchantItems.forEach((merchantItem, index) => {
                const item = items[merchantItem.item];
                const itemElement = document.createElement('div');
                itemElement.className = 'merchant-item';
                
                let statsText = '';
                if (item.type === 'weapon') {
                    statsText = `DMG: ${item.dmg}`;
                } else if (item.type === 'armor') {
                    statsText = `DEF: ${item.def}`;
                } else if (item.type === 'consumable') {
                    statsText = `Heals: ${item.value} ${item.effect === 'restoreHp' ? 'HP' : 'MP'}`;
                } else if (item.type === 'accessory') {
                    statsText = `+${item.value} MP`;
                }
                
                itemElement.innerHTML = `
                    <div>${item.name}</div>
                    <div class="item-stats">${statsText}</div>
                    <div>Price: ${merchantItem.price} gold</div>
                    <button class="buy-btn" onclick="buyItem(${index})" ${gameState.player.gold < merchantItem.price ? 'disabled' : ''}>BUY</button>
                `;
                
                merchantItems.appendChild(itemElement);
            });
        }
        
        function buyItem(index) {
            playPurchaseSound();
            const merchantItem = gameState.merchantItems[index];
            const item = items[merchantItem.item];
            
            if (gameState.player.gold >= merchantItem.price) {
                gameState.player.gold -= merchantItem.price;
                gameState.player.inventory.push({...item});
                addMessage(`You bought ${item.name} for ${merchantItem.price} gold.`);
                updateMerchantScreen();
            } else {
                addMessage("You don't have enough gold to buy that!");
            }
        }

        // Combat System
        function startCombat(enemyType) {
            playCombatSound();
            gameState.inCombat = true;
            gameState.currentEnemy = { ...enemies[enemyType] };
            
            document.getElementById('enemy-name').textContent = gameState.currentEnemy.name;
            document.getElementById('enemy-hp').textContent = gameState.currentEnemy.hp;
            document.getElementById('player-hp-combat').textContent = gameState.player.hp;
            document.getElementById('player-mp-combat').textContent = gameState.player.mp;
            document.getElementById('combat-log').textContent = `A ${gameState.currentEnemy.name} appears! Prepare for battle!`;
            
            // Set enemy ASCII art
            document.getElementById('enemy-art').textContent = gameState.currentEnemy.art;
            
            showCombatScreen();
        }

        function attack() {
            playCombatSound();
            if (!gameState.inCombat || !gameState.currentEnemy) return;
            
            const playerDmg = gameState.player.weapon.dmg + Math.floor(gameState.player.str / 5);
            gameState.currentEnemy.hp -= playerDmg;
            
            let log = `You attack the ${gameState.currentEnemy.name} for ${playerDmg} damage!\n`;
            
            // Enemy counterattack
            if (gameState.currentEnemy.hp > 0) {
                const enemyDmg = Math.max(1, gameState.currentEnemy.dmg - Math.floor(gameState.player.armor.def / 2));
                gameState.player.hp -= enemyDmg;
                log += `The ${gameState.currentEnemy.name} attacks you for ${enemyDmg} damage!`;
            }
            
            updateCombatScreen(log);
            checkCombatEnd();
        }

        function showSpellsInCombat() {
            showSpellSelectScreen();
        }
        
        function updateSpellSelect() {
            const spellList = document.getElementById('spell-select-list');
            spellList.innerHTML = '';
            
            if (gameState.player.spells.length === 0) {
                spellList.innerHTML = '<div>You don\'t know any spells.</div>';
                return;
            }
            
            gameState.player.spells.forEach((spell, index) => {
                const spellElement = document.createElement('div');
                spellElement.className = 'spell-option';
                spellElement.innerHTML = `
                    <strong>${spell.name}</strong><br>
                    ${spell.description}<br>
                    Cost: ${spell.cost} MP
                    ${spell.dmg ? `<br>Damage: ${spell.dmg}` : ''}
                    ${spell.heal ? `<br>Heal: ${spell.heal}` : ''}
                    ${spell.defense ? `<br>Defense: +${spell.defense}` : ''}
                `;
                spellElement.onclick = () => castSpellInCombat(index);
                spellList.appendChild(spellElement);
            });
        }
        
        function castSpellInCombat(spellIndex) {
            playSpellSound();
            const spell = gameState.player.spells[spellIndex];
            
            if (gameState.player.mp < spell.cost) {
                updateCombatScreen("Not enough MP to cast that spell!");
                showCombatScreen();
                return;
            }
            
            gameState.player.mp -= spell.cost;
            let log = `You cast ${spell.name}!\n`;
            
            if (spell.dmg) {
                const spellDmg = spell.dmg + Math.floor(gameState.player.int / 5);
                gameState.currentEnemy.hp -= spellDmg;
                log += `It hits the ${gameState.currentEnemy.name} for ${spellDmg} damage!\n`;
            }
            
            if (spell.heal) {
                const healAmount = Math.min(spell.heal, gameState.player.maxHp - gameState.player.hp);
                gameState.player.hp += healAmount;
                log += `You heal yourself for ${healAmount} HP!\n`;
            }
            
            if (spell.defense) {
                // Apply defense buff
                log += `You gain ${spell.defense} temporary defense!\n`;
            }
            
            // Enemy counterattack
            if (gameState.currentEnemy.hp > 0) {
                const enemyDmg = Math.max(1, gameState.currentEnemy.dmg - Math.floor(gameState.player.armor.def / 2));
                gameState.player.hp -= enemyDmg;
                log += `The ${gameState.currentEnemy.name} attacks you for ${enemyDmg} damage!`;
            }
            
            updateCombatScreen(log);
            showCombatScreen();
            checkCombatEnd();
        }

        function useItemInCombat() {
            showItemSelectScreen();
        }
        
        function updateItemSelect() {
            const itemList = document.getElementById('item-select-list');
            itemList.innerHTML = '';
            
            // Filter consumable items
            const consumables = gameState.player.inventory.filter(item => item.type === 'consumable');
            
            if (consumables.length === 0) {
                itemList.innerHTML = '<div>You have no usable items.</div>';
                return;
            }
            
            consumables.forEach((item, index) => {
                // Find the original index in the inventory
                const originalIndex = gameState.player.inventory.findIndex(invItem => invItem === item);
                
                const itemElement = document.createElement('div');
                itemElement.className = 'item';
                itemElement.innerHTML = `
                    <div>${item.name}</div>
                    <div class="item-stats">Heals: ${item.value} ${item.effect === 'restoreHp' ? 'HP' : 'MP'}</div>
                    <button class="equip-btn" onclick="useItemInCombatAction(${originalIndex})">USE</button>
                `;
                itemList.appendChild(itemElement);
            });
        }
        
        function useItemInCombatAction(index) {
            playActionSound();
            const item = gameState.player.inventory[index];
            let log = `You use ${item.name}!\n`;
            
            if (item.effect === 'restoreHp') {
                const healAmount = Math.min(item.value, gameState.player.maxHp - gameState.player.hp);
                gameState.player.hp += healAmount;
                log += `You restore ${healAmount} HP!\n`;
            } else if (item.effect === 'restoreMp') {
                const restoreAmount = Math.min(item.value, gameState.player.maxMp - gameState.player.mp);
                gameState.player.mp += restoreAmount;
                log += `You restore ${restoreAmount} MP!\n`;
            }
            
            // Remove the used item
            gameState.player.inventory.splice(index, 1);
            
            // Enemy counterattack
            if (gameState.currentEnemy.hp > 0) {
                const enemyDmg = Math.max(1, gameState.currentEnemy.dmg - Math.floor(gameState.player.armor.def / 2));
                gameState.player.hp -= enemyDmg;
                log += `The ${gameState.currentEnemy.name} attacks you for ${enemyDmg} damage!`;
            }
            
            updateCombatScreen(log);
            showCombatScreen();
            checkCombatEnd();
        }

        function flee() {
            playActionSound();
            if (!gameState.inCombat || !gameState.currentEnemy) return;
            
            // 50% chance to successfully flee
            if (Math.random() > 0.5) {
                updateCombatScreen("You successfully flee from battle!");
                setTimeout(() => {
                    gameState.inCombat = false;
                    gameState.currentEnemy = null;
                    showGameScreen();
                }, 1500);
            } else {
                const enemyDmg = Math.max(1, gameState.currentEnemy.dmg - Math.floor(gameState.player.armor.def / 2));
                gameState.player.hp -= enemyDmg;
                updateCombatScreen(`You try to flee but fail! The ${gameState.currentEnemy.name} attacks you for ${enemyDmg} damage!`);
                checkCombatEnd();
            }
        }

        function updateCombatScreen(log) {
            document.getElementById('enemy-hp').textContent = Math.max(0, gameState.currentEnemy.hp);
            document.getElementById('player-hp-combat').textContent = gameState.player.hp;
            document.getElementById('player-mp-combat').textContent = gameState.player.mp;
            
            const combatLog = document.getElementById('combat-log');
            combatLog.textContent = log;
            combatLog.scrollTop = combatLog.scrollHeight;
        }

        function checkCombatEnd() {
            if (gameState.currentEnemy.hp <= 0) {
                // Player wins
                const xpGain = gameState.currentEnemy.xp;
                gameState.player.xp += xpGain;
                
                // Mark enemy as defeated in this location
                gameState.map[gameState.player.location].enemy = null;
                
                // Random loot drop
                let lootMessage = "";
                if (Math.random() > 0.7) {
                    const itemKeys = Object.keys(items);
                    const randomItemKey = itemKeys[Math.floor(Math.random() * itemKeys.length)];
                    const randomItem = {...items[randomItemKey]};
                    gameState.player.inventory.push(randomItem);
                    lootMessage = `\nThe enemy dropped a ${randomItem.name}!`;
                }
                
                // Gold reward
                const goldReward = Math.floor(gameState.currentEnemy.xp / 5);
                gameState.player.gold += goldReward;
                lootMessage += `\nYou found ${goldReward} gold!`;
                
                updateCombatScreen(`You defeated the ${gameState.currentEnemy.name}! You gain ${xpGain} XP.${lootMessage}`);
                
                // Check for level up
                checkLevelUp();
                
                // Special case: If Dracula is defeated
                if (gameState.currentEnemy.name === 'Dracula') {
                    updateCombatScreen("You have defeated Dracula! You have saved the land from his evil reign!");
                    setTimeout(() => {
                        gameState.inCombat = false;
                        gameState.currentEnemy = null;
                        showGameScreen();
                    }, 3000);
                } else {
                    setTimeout(() => {
                        gameState.inCombat = false;
                        gameState.currentEnemy = null;
                        showGameScreen();
                    }, 2500);
                }
            } else if (gameState.player.hp <= 0) {
                // Player dies
                updateCombatScreen("You have been defeated! Game Over.");
                setTimeout(() => {
                    gameState.inCombat = false;
                    gameState.currentEnemy = null;
                    resetGame();
                    showStartScreen();
                }, 3000);
            }
        }

        function checkLevelUp() {
            if (gameState.player.xp >= gameState.player.nextLevel) {
                playLevelUpSound();
                gameState.player.level++;
                gameState.player.xp -= gameState.player.nextLevel;
                gameState.player.nextLevel = Math.floor(gameState.player.nextLevel * 1.5);
                
                // Increase stats based on class
                switch(gameState.player.class) {
                    case 'Warrior':
                        gameState.player.maxHp += 20;
                        gameState.player.str += 2;
                        break;
                    case 'Mage':
                        gameState.player.maxMp += 15;
                        gameState.player.int += 3;
                        break;
                    case 'Rogue':
                        gameState.player.maxHp += 10;
                        gameState.player.agi += 3;
                        break;
                }
                
                // Learn new spells at certain levels
                if (gameState.player.level === 3 && !gameState.player.spells.some(s => s.name === 'Heal')) {
                    gameState.player.spells.push({...spells.heal});
                    addMessage("You learned a new spell: Heal!");
                }
                if (gameState.player.level === 5 && !gameState.player.spells.some(s => s.name === 'Lightning')) {
                    gameState.player.spells.push({...spells.lightning});
                    addMessage("You learned a new spell: Lightning!");
                }
                if (gameState.player.level === 7 && !gameState.player.spells.some(s => s.name === 'Holy Water')) {
                    gameState.player.spells.push({...spells.holyWater});
                    addMessage("You learned a new spell: Holy Water!");
                }
                if (gameState.player.level === 9 && !gameState.player.spells.some(s => s.name === 'Sunlight')) {
                    gameState.player.spells.push({...spells.sunlight});
                    addMessage("You learned a new spell: Sunlight!");
                }
                if (gameState.player.level === 11 && !gameState.player.spells.some(s => s.name === 'Shield')) {
                    gameState.player.spells.push({...spells.shield});
                    addMessage("You learned a new spell: Shield!");
                }
                if (gameState.player.level === 13 && !gameState.player.spells.some(s => s.name === 'Poison')) {
                    gameState.player.spells.push({...spells.poison});
                    addMessage("You learned a new spell: Poison!");
                }
                if (gameState.player.level === 15 && !gameState.player.spells.some(s => s.name === 'Ice Shard')) {
                    gameState.player.spells.push({...spells.iceShard});
                    addMessage("You learned a new spell: Ice Shard!");
                }
                if (gameState.player.level === 17 && !gameState.player.spells.some(s => s.name === 'Life Drain')) {
                    gameState.player.spells.push({...spells.lifeDrain});
                    addMessage("You learned a new spell: Life Drain!");
                }
                
                // Full heal on level up
                gameState.player.hp = gameState.player.maxHp;
                gameState.player.mp = gameState.player.maxMp;
                
                showNotification(`Level Up! You are now level ${gameState.player.level}!`);
                addMessage(`Level Up! You are now level ${gameState.player.level}!`);
            }
        }

        // Inventory Management
        function updateInventory() {
            const inventoryGrid = document.getElementById('inventory-grid');
            inventoryGrid.innerHTML = '';
            
            if (gameState.player.inventory.length === 0) {
                inventoryGrid.innerHTML = '<div>Your inventory is empty.</div>';
                return;
            }
            
            gameState.player.inventory.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'item';
                
                let statsText = '';
                if (item.type === 'weapon') {
                    statsText = `DMG: ${item.dmg}`;
                } else if (item.type === 'armor') {
                    statsText = `DEF: ${item.def}`;
                } else if (item.type === 'consumable') {
                    statsText = `Heals: ${item.value} ${item.effect === 'restoreHp' ? 'HP' : 'MP'}`;
                } else if (item.type === 'quest') {
                    statsText = item.description;
                } else if (item.type === 'ammo') {
                    statsText = `DMG: ${item.dmg} (${item.quantity} left)`;
                } else if (item.type === 'accessory') {
                    statsText = `+${item.value} MP`;
                }
                
                itemElement.innerHTML = `
                    <div>${item.name}</div>
                    <div class="item-stats">${statsText}</div>
                    ${item.type === 'weapon' || item.type === 'armor' ? 
                        `<button class="equip-btn" onclick="equipItem(${index})">EQUIP</button>` : 
                        (item.type === 'consumable' ? `<button class="equip-btn" onclick="useInventoryItem(${index})">USE</button>` : '')
                    }
                `;
                
                inventoryGrid.appendChild(itemElement);
            });
        }

        function useInventoryItem(index) {
            playActionSound();
            const item = gameState.player.inventory[index];
            
            if (item.type === 'consumable') {
                if (item.effect === 'restoreHp') {
                    const healAmount = Math.min(item.value, gameState.player.maxHp - gameState.player.hp);
                    gameState.player.hp += healAmount;
                    addMessage(`You use ${item.name} and restore ${healAmount} HP.`);
                } else if (item.effect === 'restoreMp') {
                    const restoreAmount = Math.min(item.value, gameState.player.maxMp - gameState.player.mp);
                    gameState.player.mp += restoreAmount;
                    addMessage(`You use ${item.name} and restore ${restoreAmount} MP.`);
                }
                
                // Remove the used item
                gameState.player.inventory.splice(index, 1);
                updateInventory();
                updateGameScreen();
            } else if (item.type === 'accessory') {
                gameState.player.maxMp += item.value;
                gameState.player.mp += item.value;
                gameState.player.inventory.splice(index, 1);
                addMessage(`You equip the ${item.name} and gain ${item.value} MP!`);
                updateInventory();
                updateGameScreen();
            }
        }
        
        function equipItem(index) {
            playActionSound();
            const item = gameState.player.inventory[index];
            
            if (item.type === 'weapon') {
                // Add old weapon to inventory if it's not fists
                if (gameState.player.weapon.name !== 'Fists') {
                    gameState.player.inventory.push({...gameState.player.weapon});
                }
                gameState.player.weapon = item;
                gameState.player.inventory.splice(index, 1);
                addMessage(`You equip the ${item.name}.`);
            } else if (item.type === 'armor') {
                // Add old armor to inventory if it's not none
                if (gameState.player.armor.name !== 'None') {
                    gameState.player.inventory.push({...gameState.player.armor});
                }
                gameState.player.armor = item;
                gameState.player.inventory.splice(index, 1);
                addMessage(`You equip the ${item.name}.`);
            }
            
            updateInventory();
            updateGameScreen();
        }

        // Spellbook Management
        function updateSpellbook() {
            const spellList = document.getElementById('spell-list');
            spellList.innerHTML = '';
            
            if (gameState.player.spells.length === 0) {
                spellList.innerHTML = '<div>You don\'t know any spells.</div>';
                return;
            }
            
            gameState.player.spells.forEach(spell => {
                const spellElement = document.createElement('div');
                spellElement.className = 'menu-option';
                spellElement.innerHTML = `
                    <strong>${spell.name}</strong><br>
                    ${spell.description}<br>
                    Cost: ${spell.cost} MP
                    ${spell.dmg ? `<br>Damage: ${spell.dmg}` : ''}
                    ${spell.heal ? `<br>Heal: ${spell.heal}` : ''}
                    ${spell.defense ? `<br>Defense: +${spell.defense}` : ''}
                `;
                spellList.appendChild(spellElement);
            });
        }

        // Save/Load System (simplified)
        function saveGame() {
            playActionSound();
            localStorage.setItem('draculaRPG', JSON.stringify(gameState));
            addMessage('Game saved successfully!');
        }

        function loadGame() {
            playActionSound();
            const savedGame = localStorage.getItem('draculaRPG');
            if (savedGame) {
                const loadedState = JSON.parse(savedGame);
                
                // We need to properly restore object references
                Object.keys(loadedState.player).forEach(key => {
                    gameState.player[key] = loadedState.player[key];
                });
                
                // Restore the map state
                Object.keys(loadedState.map).forEach(key => {
                    if (gameState.map[key]) {
                        gameState.map[key].searched = loadedState.map[key].searched;
                        gameState.map[key].enemy = loadedState.map[key].enemy;
                    }
                });
                
                showGameScreen();
                addMessage('Game loaded successfully!');
            } else {
                addMessage('No saved game found!');
            }
        }

        function resetGame() {
            // Reset game state to initial values
            Object.assign(gameState, {
                screen: 'start',
                player: {
                    class: '',
                    level: 1,
                    xp: 0,
                    nextLevel: 100,
                    hp: 100,
                    maxHp: 100,
                    mp: 50,
                    maxMp: 50,
                    str: 10,
                    int: 10,
                    agi: 10,
                    weapon: { name: 'Fists', dmg: 5 },
                    armor: { name: 'None', def: 0 },
                    inventory: [],
                    spells: [],
                    location: 'entrance',
                    gold: 50,
                    quests: []
                },
                inCombat: false,
                currentEnemy: null,
                currentNPC: null
            });
            
            // Reset map
            Object.keys(gameState.map).forEach(key => {
                gameState.map[key].searched = false;
                // Reset NPC quests
                if (gameState.map[key].npc && gameState.map[key].npc.quest) {
                    gameState.map[key].npc.quest.completed = false;
                }
            });
            
            // Reset specific enemies
            gameState.map.courtyard.enemy = 'zombie';
            gameState.map.stables.enemy = 'ghost';
            gameState.map.greatHall.enemy = 'skeleton';
            gameState.map.diningRoom.enemy = 'ratKing';
            gameState.map.library.enemy = 'vampire';
            gameState.map.armory.enemy = 'armoredSkeleton';
            gameState.map.barracks.enemy = 'vampireKnight';
            gameState.map.dungeon.enemy = 'ghoul';
            gameState.map.tortureChamber.enemy = 'torturedSoul';
            gameState.map.crypt.enemy = 'wraith';
            gameState.map.catacombs.enemy = 'lich';
            gameState.map.throneRoom.enemy = 'dracula';
            gameState.map.gardens.enemy = 'werewolf';
            gameState.map.maze.enemy = 'gargoyle';
            gameState.map.greenhouse.enemy = 'venomousIvy';
            gameState.map.tower.enemy = 'vampireBatSwarm';
            gameState.map.aviary.enemy = 'phoenix';
            gameState.map.wineCellar.enemy = 'drunkenGhost';
            gameState.map.secretPassage.enemy = 'mimic';
        }

        // Text Input Processing (for advanced users)
        function processInput() {
            playClickSound();
            const input = document.getElementById('input').value.toLowerCase();
            document.getElementById('input').value = '';
            
            if (gameState.screen === 'game-screen') {
                if (input === 'n' || input === 'north') {
                    move('north');
                } else if (input === 'e' || input === 'east') {
                    move('east');
                } else if (input === 's' || input === 'south') {
                    move('south');
                } else if (input === 'w' || input === 'west') {
                    move('west');
                } else if (input === 'search') {
                    search();
                } else if (input === 'inventory' || input === 'i') {
                    showInventory();
                } else if (input === 'spellbook' || input === 'spells') {
                    showSpellbook();
                } else if (input === 'rest') {
                    rest();
                } else if (input === 'save') {
                    saveGame();
                } else if (input === 'talk') {
                    const location = gameState.map[gameState.player.location];
                    if (location.npc) {
                        if (location.npc.type === 'merchant') {
                            showMerchantScreen();
                        } else {
                            talkToNPC(gameState.player.location);
                        }
                    } else {
                        addMessage('There is no one here to talk to.');
                    }
                } else {
                    addMessage('Unknown command. Try: north, east, south, west, search, inventory, spellbook, rest, save, talk');
                }
            }
        }

        // Initialize the game
        document.addEventListener('DOMContentLoaded', function() {
            initAudio();
            
            document.getElementById('input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processInput();
                }
            });
            
            // Add click sounds to all buttons
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', playClickSound);
            });
            
            // Add click sounds to menu options
            document.querySelectorAll('.menu-option').forEach(option => {
                option.addEventListener('click', playClickSound);
            });
        });
    </script>
</body>
</html>
