<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dracula's Castle - Text Adventure with Sounds</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* ---------- (Your existing CSS remains unchanged) ---------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            line-height: 1.6;
            padding: 10px;
            max-width: 1200px;
            margin: 0 auto;
            overflow-x: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            min-height: 96vh;
            border: 2px solid #fff;
            padding: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px solid #fff;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        
        h1 {
            color: #ff0000;
            font-size: 2.2rem;
            text-shadow: 0 0 5px #ff0000;
            margin-bottom: 8px;
        }
        
        h2 {
            color: #fff;
            font-size: 1.3rem;
            margin-bottom: 12px;
            border-bottom: 1px dashed #fff;
            padding-bottom: 5px;
        }
        
        .game-area {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            flex: 1;
            min-height: 0;
        }
        
        .main-content {
            flex: 3;
            min-width: 300px;
            display: flex;
            flex-direction: column;
        }
        
        .side-panel {
            flex: 1;
            min-width: 250px;
            border-left: 2px solid #fff;
            padding-left: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .screen {
            background-color: #111;
            border: 2px solid #fff;
            padding: 15px;
            flex: 1;
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        
        .screen-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .message {
            animation: fadeIn 0.5s;
            padding: 4px 0;
        }
        
        .npc-message {
            color: #ffff00;
        }
        
        .player-message {
            color: #00ff00;
        }
        
        .enemy-message {
            color: #ff3333;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        
        button {
            background-color: #000;
            color: #fff;
            border: 2px solid #fff;
            padding: 10px 12px;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 180px;
        }
        
        button:hover {
            background-color: #333;
            transform: scale(1.02);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button.primary {
            background-color: #222;
            border-color: #ff0000;
            color: #ff0000;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        button:disabled:hover {
            background-color: #000;
            transform: none;
        }
        
        .stat-box {
            margin-bottom: 20px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.75rem;
        }
        
        .stat-value {
            color: #00ff00;
        }
        
        .inventory {
            margin-top: 20px;
        }
        
        .inventory-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.75rem;
        }
        
        .item-icon {
            margin-right: 8px;
            font-size: 1rem;
        }
        
        .game-progress {
            margin-top: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 18px;
            background-color: #111;
            border: 1px solid #fff;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #ff0000;
            width: 0%;
            transition: width 0.5s;
        }
        
        .character-creation {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .stat-allocation {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .stat-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .stat-btn {
            min-width: 35px;
            padding: 4px;
            font-size: 0.65rem;
        }
        
        .item-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }
        
        .item-option {
            padding: 8px;
            border: 1px solid #fff;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.7rem;
        }
        
        .item-option.selected {
            border-color: #ff0000;
            background-color: #222;
            color: #ff0000;
        }
        
        .item-option:hover {
            background-color: #333;
        }
        
        .warning {
            color: #ff3333;
            font-size: 0.7rem;
            margin-top: 10px;
            text-align: center;
        }
        
        .game-over {
            color: #ff0000;
            text-align: center;
            font-size: 1.3rem;
            margin-top: 15px;
        }
        
        .hidden {
            display: none;
        }
        
        .screen-header {
            color: #ff0000;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .combat-screen {
            border: 2px solid #ff0000;
            padding: 10px;
            margin: 10px 0;
            background-color: #220000;
        }
        
        .combat-log {
            max-height: 150px;
            overflow-y: auto;
            margin: 10px 0;
            padding: 5px;
            background-color: #111;
            border: 1px solid #333;
            font-size: 0.8rem;
        }
        
        .combat-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        
        .combat-action-btn {
            min-width: 120px;
            padding: 8px;
            font-size: 0.7rem;
        }
        
        .enemy-health, .player-health {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.8rem;
        }
        
        .health-bar {
            width: 100%;
            height: 10px;
            background-color: #333;
            border: 1px solid #666;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .health-fill {
            height: 100%;
            transition: width 0.5s;
        }
        
        .player-health-fill {
            background-color: #00ff00;
        }
        
        .enemy-health-fill {
            background-color: #ff0000;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        .merchant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border: 1px solid #666;
            margin: 5px 0;
            background-color: #222;
        }
        
        .merchant-item:hover {
            background-color: #333;
        }
        
        .item-price {
            color: #ffd700;
            font-size: 0.8rem;
        }
        
        .merchant-gold {
            color: #ffd700;
            font-weight: bold;
            margin: 10px 0;
        }
        
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .side-panel {
                border-left: none;
                border-top: 2px solid #fff;
                padding-left: 0;
                padding-top: 15px;
            }
            
            button {
                min-width: 140px;
                font-size: 0.7rem;
                padding: 8px 10px;
            }
            
            h1 {
                font-size: 1.6rem;
            }
            
            h2 {
                font-size: 1.1rem;
            }
            
            .stat-allocation {
                grid-template-columns: 1fr;
            }
            
            .item-options {
                grid-template-columns: 1fr;
            }
            
            .combat-actions {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .screen {
                padding: 10px;
                font-size: 0.75rem;
            }
            
            button {
                min-width: 100%;
            }
            
            h1 {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DRACULA'S CASTLE</h1>
            <p>A STAT-DRIVEN TEXT ADVENTURE</p>
        </div>
        
        <div class="game-area">
            <div class="main-content">
                <div id="gameScreen" class="screen">
                    <!-- Game content will be dynamically inserted here -->
                </div>
                
                <div id="controls" class="controls">
                    <!-- Game controls will be dynamically inserted here -->
                </div>
            </div>
            
            <div class="side-panel">
                <div class="stat-box">
                    <h2>STATUS</h2>
                    <div id="statsDisplay">
                        <!-- Stats will be dynamically inserted here -->
                    </div>
                </div>
                
                <div class="inventory">
                    <h2>INVENTORY</h2>
                    <div id="inventoryDisplay">
                        <!-- Inventory will be dynamically inserted here -->
                    </div>
                </div>
                
                <div class="game-progress">
                    <h2>CASTLE PROGRESS</h2>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== AUDIO MANAGER ====================
        const AudioManager = (function() {
            let audioContext = null;
            const masterGain = 0.2; // global volume

            function initContext() {
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                        console.warn('Web Audio API not supported');
                        return null;
                    }
                }
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                return audioContext;
            }

            function playSound(type, pitch, duration, volume) {
                const ctx = initContext();
                if (!ctx) return;

                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                osc.type = type || 'sine';
                osc.frequency.value = pitch || 440;

                gain.gain.setValueAtTime((volume || 0.1) * masterGain, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + (duration || 0.1));

                osc.connect(gain);
                gain.connect(ctx.destination);

                osc.start();
                osc.stop(ctx.currentTime + (duration || 0.1));
            }

            return {
                playClick: function() {
                    playSound('sine', 600, 0.05, 0.1);
                },
                playNotification: function() {
                    playSound('sine', 800, 0.1, 0.15);
                },
                playCombatHit: function() {
                    playSound('triangle', 200, 0.1, 0.2);
                },
                playEnemyHit: function() {
                    playSound('sawtooth', 150, 0.15, 0.2);
                },
                playVictory: function() {
                    playSound('sine', 400, 0.2, 0.2);
                    setTimeout(() => playSound('sine', 600, 0.2, 0.2), 100);
                    setTimeout(() => playSound('sine', 800, 0.3, 0.2), 200);
                },
                playLevelUp: function() {
                    playSound('sine', 500, 0.15, 0.2);
                    setTimeout(() => playSound('sine', 700, 0.15, 0.2), 100);
                    setTimeout(() => playSound('sine', 900, 0.2, 0.2), 200);
                },
                playReward: function() {
                    playSound('sine', 1000, 0.1, 0.15);
                    setTimeout(() => playSound('sine', 1200, 0.1, 0.15), 50);
                },
                playGameOver: function() {
                    playSound('sawtooth', 200, 0.5, 0.3);
                },
                playGameComplete: function() {
                    for (let i = 0; i < 5; i++) {
                        setTimeout(() => {
                            playSound('sine', 600 + i * 100, 0.2, 0.2);
                        }, i * 150);
                    }
                }
            };
        })();
        // ==================== END AUDIO MANAGER ====================

        // Game state
        const gameState = {
            // Player stats
            stats: {
                strength: 5,
                intelligence: 5,
                charisma: 5,
                luck: 5,
                health: 100,
                maxHealth: 100
            },
            
            // Available stat points
            statPoints: 10,
            
            // Player inventory
            inventory: [],
            
            // Current game location/scene
            currentScene: 'characterCreation',
            
            // Game progress (0 to 100)
            progress: 0,
            
            // Selected starting item
            selectedItem: null,
            
            // Game over flag
            gameOver: false,
            
            // Scene before combat started
            preCombatScene: 'castleEntrance',
            
            // Combat state
            combat: {
                active: false,
                enemy: null,
                enemyHealth: 0,
                enemyMaxHealth: 0,
                turn: 'player', // 'player' or 'enemy'
                log: []
            },
            
            // NPC memory (to track interactions)
            npcMemory: {},
            
            // Player name
            playerName: 'Hunter',
            
            // Current NPC for reference
            currentNPC: null,
            
            // Player gold
            gold: 50, // Starting gold
            
            // Discovered rooms
            discoveredRooms: ['castleEntrance'],
            
            // Merchant tracking
            merchantPresent: false,
            merchantCooldown: 0
        };
        
        // Available starting items
        const startingItems = [
            {
                id: 'holyWater',
                name: 'Holy Water',
                description: 'Blessed water that harms the undead',
                icon: 'üíß',
                effect: 'Deals extra damage to vampires',
                combatBonus: 2.0,
                type: 'combat'
            },
            {
                id: 'silverCross',
                name: 'Silver Cross',
                description: 'A cross that repels evil creatures',
                icon: '‚úùÔ∏è',
                effect: 'Increases charisma against religious NPCs',
                combatBonus: 1.5,
                type: 'defensive'
            },
            {
                id: 'garlicNecklace',
                name: 'Garlic Necklace',
                description: 'Strong garlic to ward off vampires',
                icon: 'üßÑ',
                effect: 'Reduces damage from vampire attacks',
                combatBonus: 0.5,
                type: 'defensive'
            },
            {
                id: 'stake',
                name: 'Wooden Stake',
                description: 'For the heart of a vampire',
                icon: 'üî™',
                effect: 'Critical hit chance against vampires',
                combatBonus: 2.5,
                type: 'combat'
            }
        ];
        
        // Merchant NPC definition
        const merchantNPC = {
            id: 'wanderingMerchant',
            name: 'Wandering Merchant',
            type: 'merchant',
            description: 'A mysterious traveler with a heavy pack of goods',
            introduction: "A cloaked figure emerges from the shadows. 'Greetings, traveler! I am Renfield, a merchant of rare and useful items. Care to browse my wares?'",
            dialogues: [
                {
                    id: 'initial',
                    text: "I have traveled far and wide to acquire these rare items. What interests you today?",
                    responses: [
                        { text: "Show me what you have for sale.", next: 'shop' },
                        { text: "How did you get into this castle?", next: 'story' },
                        { text: "I have no time for merchants.", next: 'leave' }
                    ]
                },
                {
                    id: 'shop',
                    text: `Here are my finest wares (You have ${gameState.gold} gold):`,
                    responses: [
                        { text: "I'll browse another time.", next: 'leave' }
                    ]
                },
                {
                    id: 'story',
                    text: "Dracula allows me passage in exchange for... certain services. But enough of that! Would you like to see my goods?",
                    responses: [
                        { text: "Show me your wares.", next: 'shop' },
                        { text: "I must be going.", next: 'leave' }
                    ]
                },
                {
                    id: 'leave',
                    text: "Very well. Safe travels, and may fortune favor you!",
                    responses: [
                        { text: "Continue exploring", action: 'returnToScene' }
                    ]
                }
            ]
        };
        
        // Merchant items for sale
        const merchantItems = [
            {
                id: 'healthPotion',
                name: 'Health Potion',
                description: 'Restores 40 health points',
                icon: 'üß™',
                effect: 'Restores 40 health when used',
                price: 25,
                type: 'consumable',
                use: function() {
                    gameState.stats.health = Math.min(gameState.stats.health + 40, gameState.stats.maxHealth);
                    return `You drink the health potion and restore 40 health!`;
                }
            },
            {
                id: 'greaterHealthPotion',
                name: 'Greater Health Potion',
                description: 'Restores 80 health points',
                icon: 'üß™',
                effect: 'Restores 80 health when used',
                price: 45,
                type: 'consumable',
                use: function() {
                    gameState.stats.health = Math.min(gameState.stats.health + 80, gameState.stats.maxHealth);
                    return `You drink the greater health potion and restore 80 health!`;
                }
            },
            {
                id: 'strengthElixir',
                name: 'Strength Elixir',
                description: 'Increases strength by 3 for next combat',
                icon: '‚öóÔ∏è',
                effect: '+3 strength for next combat encounter',
                price: 35,
                type: 'consumable',
                use: function() {
                    gameState.stats.strength += 3;
                    return `You drink the strength elixir! Strength increased by 3 for your next combat!`;
                }
            },
            {
                id: 'luckCharm',
                name: 'Luck Charm',
                description: 'Permanently increases luck by 2',
                icon: 'üçÄ',
                effect: 'Permanently increases luck stat',
                price: 60,
                type: 'permanent',
                use: function() {
                    gameState.stats.luck += 2;
                    return `You equip the luck charm! Your luck permanently increases by 2!`;
                }
            },
            {
                id: 'vampireRepellent',
                name: 'Vampire Repellent',
                description: 'Causes vampires to flee from combat',
                icon: 'üß¥',
                effect: 'Allows escape from vampire encounters',
                price: 50,
                type: 'consumable',
                use: function() {
                    return `You now have vampire repellent! Next time you encounter a vampire, you can use it to escape.`;
                }
            },
            {
                id: 'silverDagger',
                name: 'Silver Dagger',
                description: 'Extra damage against werewolves and vampires',
                icon: 'üó°Ô∏è',
                effect: '+5 damage against supernatural creatures',
                price: 75,
                type: 'weapon',
                use: function() {
                    return `You equip the silver dagger! It glows with a faint light.`;
                },
                combatBonus: 1.8
            },
            {
                id: 'lantern',
                name: 'Magical Lantern',
                description: 'Reveals hidden passages and secrets',
                icon: 'üèÆ',
                effect: 'Reveals secret rooms and items',
                price: 40,
                type: 'utility',
                use: function() {
                    return `The magical lantern illuminates hidden details you would otherwise miss!`;
                }
            },
            {
                id: 'garlicBomb',
                name: 'Garlic Bomb',
                description: 'Damages all vampires in an area',
                icon: 'üí£',
                effect: 'Deals 30 damage to all vampires in combat',
                price: 55,
                type: 'combat',
                use: function() {
                    return `You now have a garlic bomb! It will be devastating against multiple vampires.`;
                }
            }
        ];
        
        // Enemies
        const enemies = {
            vampire: {
                name: 'Vampire',
                health: 60,
                attack: 8,
                defense: 4,
                description: 'A bloodthirsty creature of the night',
                type: 'vampire',
                xp: 25,
                gold: 15
            },
            vampireSpawn: {
                name: 'Vampire Spawn',
                health: 40,
                attack: 6,
                defense: 3,
                description: 'A newly turned vampire',
                type: 'vampire',
                xp: 15,
                gold: 8
            },
            werewolf: {
                name: 'Werewolf',
                health: 80,
                attack: 12,
                defense: 6,
                description: 'A ferocious shapeshifter',
                type: 'lycanthrope',
                xp: 30,
                gold: 20
            },
            dracula: {
                name: 'Count Dracula',
                health: 150,
                attack: 15,
                defense: 10,
                description: 'The Lord of Vampires',
                type: 'vampire',
                xp: 100,
                gold: 100
            },
            zombie: {
                name: 'Zombie',
                health: 50,
                attack: 5,
                defense: 2,
                description: 'A reanimated corpse that smells of decay',
                type: 'undead',
                xp: 10,
                gold: 3
            },
            skeleton: {
                name: 'Skeleton Warrior',
                health: 35,
                attack: 7,
                defense: 5,
                description: 'An animated skeleton armed with a rusty sword',
                type: 'undead',
                xp: 12,
                gold: 5
            },
            ghost: {
                name: 'Wailing Ghost',
                health: 45,
                attack: 8,
                defense: 0,
                description: 'A spectral entity that can pass through walls',
                type: 'spirit',
                xp: 18,
                gold: 10
            },
            gargoyle: {
                name: 'Stone Gargoyle',
                health: 70,
                attack: 9,
                defense: 8,
                description: 'A stone creature that comes to life at night',
                type: 'construct',
                xp: 22,
                gold: 12
            },
            vampireBride: {
                name: 'Vampire Bride',
                health: 55,
                attack: 10,
                defense: 5,
                description: 'One of Dracula\'s immortal consorts',
                type: 'vampire',
                xp: 28,
                gold: 18
            },
            ratSwarm: {
                name: 'Giant Rat Swarm',
                health: 30,
                attack: 4,
                defense: 1,
                description: 'A swarm of oversized, aggressive rats',
                type: 'beast',
                xp: 8,
                gold: 2
            },
            batSwarm: {
                name: 'Bat Swarm',
                health: 25,
                attack: 5,
                defense: 0,
                description: 'A cloud of sharp-toothed bats',
                type: 'beast',
                xp: 5,
                gold: 1
            },
            shadowCreature: {
                name: 'Shadow Creature',
                health: 55,
                attack: 9,
                defense: 3,
                description: 'A being of pure darkness that drains life',
                type: 'shadow',
                xp: 20,
                gold: 12
            }
        };
        
        // NPC definitions
        const npcs = {
            oldMan: {
                id: 'oldMan',
                name: 'Old Man',
                type: 'helpful',
                description: 'A frail old man with a lantern',
                introduction: "You see an old man huddled in the corner. He looks up at you with weary eyes.",
                dialogues: [
                    {
                        id: 'initial',
                        text: "Who dares enter these cursed halls? Ah, a hunter... I can see it in your eyes. I was once like you, but now I'm too old. Take this advice: the Count is weakest at dawn. You'll find him in the highest tower.",
                        responses: [
                            { text: "Thank you for the advice. Do you have anything that could help?", next: 'help' },
                            { text: "I don't need advice from a coward.", next: 'insult' },
                            { text: "I must continue my quest. Farewell.", next: 'leave' }
                        ]
                    },
                    {
                        id: 'help',
                        text: "I have this old silver cross. It's been in my family for generations. It might protect you...",
                        responses: [
                            { text: "Thank you, I'll take good care of it.", action: 'addItem', item: 'silverCross', next: 'endHelp' },
                            { text: "Keep your trinkets. I have my own weapons.", next: 'leave' }
                        ]
                    },
                    {
                        id: 'insult',
                        text: "Fool! You'll die like all the others!",
                        responses: [
                            { text: "We'll see about that.", next: 'endInsult' }
                        ]
                    },
                    {
                        id: 'leave',
                        text: "May God have mercy on your soul...",
                        responses: [
                            { text: "Continue exploring", action: 'progress', amount: 5, next: 'endLeave' }
                        ]
                    },
                    {
                        id: 'endHelp',
                        text: "The old man hands you the silver cross and fades into the shadows.",
                        responses: [
                            { text: "Continue exploring", action: 'returnToMainHall' }
                        ]
                    },
                    {
                        id: 'endInsult',
                        text: "The old man shakes his head and disappears into the darkness.",
                        responses: [
                            { text: "Continue exploring", action: 'returnToMainHall' }
                        ]
                    },
                    {
                        id: 'endLeave',
                        text: "You leave the old man behind and continue your exploration.",
                        responses: [
                            { text: "Continue exploring", action: 'returnToMainHall' }
                        ]
                    }
                ]
            },
            
            mysteriousWoman: {
                id: 'mysteriousWoman',
                name: 'Mysterious Woman',
                type: 'tricky',
                description: 'A beautiful woman in a flowing red dress',
                introduction: "A mysterious woman appears before you, her smile both alluring and dangerous.",
                dialogues: [
                    {
                        id: 'initial',
                        text: "Well, what do we have here? A brave soul wandering these halls. You look tired, hunter. Come, rest with me awhile.",
                        responses: [
                            { text: "I don't have time for distractions. What do you want?", next: 'confront' },
                            { text: "You're very beautiful... but I sense danger.", next: 'flatter' },
                            { text: "Leave me be, creature of the night!", action: 'startCombat', enemy: 'vampireBride' }
                        ]
                    },
                    {
                        id: 'confront',
                        text: "Straight to the point, I like that. I can help you find what you seek. The Count's treasure room is just beyond that door. But you'll need a key... which I have.",
                        responses: [
                            { text: "Show me the key.", statCheck: { stat: 'intelligence', min: 7, success: 'detectTrick', failure: 'fallForTrick' } },
                            { text: "I don't trust you.", action: 'startCombat', enemy: 'vampireBride' }
                        ]
                    },
                    {
                        id: 'detectTrick',
                        text: "You notice her fangs when she smiles. She's a vampire!",
                        responses: [
                            { text: "Draw your weapon and attack!", action: 'startCombat', enemy: 'vampireBride' },
                            { text: "Use your holy symbol to repel her", action: 'checkItem', item: 'silverCross', success: 'repel', failure: 'combatDialogue' },
                            { text: "Try to escape", next: 'escape' }
                        ]
                    },
                    {
                        id: 'fallForTrick',
                        text: "She hands you a key with a smile. As you take it, she grabs your arm with surprising strength!",
                        responses: [
                            { text: "Try to break free", statCheck: { stat: 'strength', min: 8, success: 'breakFree', failure: 'bitten' } },
                            { text: "Use your garlic necklace", action: 'checkItem', item: 'garlicNecklace', success: 'repel', failure: 'bitten' }
                        ]
                    },
                    {
                        id: 'repel',
                        text: "The vampire recoils from your holy item! She hisses and retreats into the shadows.",
                        responses: [
                            { text: "Continue exploring", action: 'returnToCourtyard' }
                        ]
                    },
                    {
                        id: 'bitten',
                        text: "She bites your neck! You feel your strength draining away...",
                        action: 'damage',
                        amount: 20,
                        next: 'transform'
                    },
                    {
                        id: 'transform',
                        text: "The woman transforms into a vampire and attacks!",
                        responses: [
                            { text: "Fight back!", action: 'startCombat', enemy: 'vampireBride' }
                        ]
                    },
                    {
                        id: 'breakFree',
                        text: "You break free from her grasp! She snarls and transforms into her true vampire form.",
                        responses: [
                            { text: "Attack!", action: 'startCombat', enemy: 'vampireBride' },
                            { text: "Run away!", next: 'escape' }
                        ]
                    },
                    {
                        id: 'escape',
                        text: "You manage to escape just as she lunges at you. You return to the courtyard, shaken but alive.",
                        responses: [
                            { text: "Continue", action: 'returnToCourtyard' }
                        ]
                    },
                    {
                        id: 'attack',
                        text: "You draw your weapon. The woman laughs and transforms into a vampire!",
                        responses: [
                            { text: "Prepare for battle!", action: 'startCombat', enemy: 'vampireBride' }
                        ]
                    },
                    {
                        id: 'flatter',
                        text: "She smiles seductively. 'Flattery will get you everywhere, hunter. Come closer...'",
                        responses: [
                            { text: "Step closer", next: 'tooClose' },
                            { text: "Back away cautiously", next: 'detectTrick' }
                        ]
                    },
                    {
                        id: 'tooClose',
                        text: "As you step closer, she reveals her fangs and attacks!",
                        responses: [
                            { text: "Fight!", action: 'startCombat', enemy: 'vampireBride' }
                        ]
                    },
                    {
                        id: 'combatDialogue',
                        text: "The vampire attacks!",
                        responses: [
                            { text: "Fight!", action: 'startCombat', enemy: 'vampireBride' }
                        ]
                    }
                ]
            },
            
            vampireHunter: {
                id: 'vampireHunter',
                name: 'Van Helsing',
                type: 'helpful',
                description: 'A grizzled vampire hunter with many weapons',
                introduction: "You encounter another hunter, covered in dust and sporting fresh wounds.",
                dialogues: [
                    {
                        id: 'initial',
                        text: "Another hunter! I'm Van Helsing. I've been tracking Dracula for weeks. We can work together, or you can die alone like the others.",
                        responses: [
                            { text: "I could use an ally. What's the plan?", next: 'ally' },
                            { text: "I work alone. Move aside.", next: 'alone' },
                            { text: "How do I know you're not a vampire yourself?", statCheck: { stat: 'intelligence', min: 6, success: 'detectTruth', failure: 'distrust' } }
                        ]
                    },
                    {
                        id: 'ally',
                        text: "Good! I know a secret passage to Dracula's crypt. Follow me, but stay quiet. There are vampire spawn everywhere.",
                        responses: [
                            { text: "Lead the way.", action: 'allyProgress', next: 'endAlly' },
                            { text: "This seems too easy...", next: 'distrust' }
                        ]
                    },
                    {
                        id: 'detectTruth',
                        text: "You examine him carefully. He casts a reflection in a nearby puddle and has a shadow. He's human.",
                        responses: [
                            { text: "Alright, I'll trust you. Let's work together.", next: 'ally' },
                            { text: "Still, I prefer to work alone.", next: 'alone' }
                        ]
                    },
                    {
                        id: 'distrust',
                        text: "Van Helsing shakes his head. 'Suit yourself. But you'll regret it.' He disappears into the shadows.",
                        responses: [
                            { text: "Continue alone", action: 'progress', amount: 5, next: 'endDistrust' }
                        ]
                    },
                    {
                        id: 'alone',
                        text: "'Foolish pride,' he mutters as he walks away.",
                        responses: [
                            { text: "Continue exploring", action: 'progress', amount: 5, next: 'endAlone' }
                        ]
                    },
                    {
                        id: 'endAlly',
                        text: "Van Helsing leads you through a hidden passage. You make significant progress toward Dracula's lair.",
                        responses: [
                            { text: "Continue", action: 'returnToUpperFloor' }
                        ]
                    },
                    {
                        id: 'endDistrust',
                        text: "You continue on your own, more cautiously than before.",
                        responses: [
                            { text: "Continue", action: 'returnToUpperFloor' }
                        ]
                    },
                    {
                        id: 'endAlone',
                        text: "You continue your quest alone, determined to succeed.",
                        responses: [
                            { text: "Continue", action: 'returnToUpperFloor' }
                        ]
                    }
                ]
            },
            
            librarian: {
                id: 'librarian',
                name: 'The Librarian',
                type: 'helpful',
                description: 'A scholarly man surrounded by ancient books',
                introduction: "In the castle library, you find an elderly man meticulously organizing books. He seems out of place in this cursed castle.",
                dialogues: [
                    {
                        id: 'initial',
                        text: "Ah, a visitor! I am the Librarian. Dracula allows me to tend his collection in exchange for... certain services. But I can offer you knowledge that may aid your quest.",
                        responses: [
                            { text: "What do you know about defeating Dracula?", next: 'knowledge' },
                            { text: "You serve Dracula? You're as bad as he is!", next: 'accuse' },
                            { text: "I need to find a way to the highest tower.", next: 'tower' }
                        ]
                    },
                    {
                        id: 'knowledge',
                        text: "Dracula can only be truly killed by a wooden stake through the heart during daylight. He is also weakened by holy symbols and running water.",
                        responses: [
                            { text: "Thank you. Anything else?", next: 'moreInfo' },
                            { text: "I must go now.", next: 'end' }
                        ]
                    },
                    {
                        id: 'moreInfo',
                        text: "His brides guard the east wing. Avoid them if you can. The west wing contains his laboratory - you may find useful items there.",
                        responses: [
                            { text: "Thank you for the information.", action: 'addItem', item: 'map', next: 'end' },
                            { text: "Farewell.", next: 'end' }
                        ]
                    },
                    {
                        id: 'accuse',
                        text: "You misunderstand! I serve only to preserve knowledge. Here, take this - it may help you.",
                        action: 'addItem',
                        item: 'ancientTome',
                        next: 'end'
                    },
                    {
                        id: 'tower',
                        text: "The highest tower is accessible through the throne room. But beware - Dracula's most powerful guards protect it.",
                        responses: [
                            { text: "Thank you for the warning.", next: 'end' },
                            { text: "I'm not afraid of his guards.", next: 'brave' }
                        ]
                    },
                    {
                        id: 'brave',
                        text: "Bravery is one thing, foolishness another. Take this at least.",
                        action: 'addItem',
                        item: 'silverCross',
                        next: 'end'
                    },
                    {
                        id: 'end',
                        text: "May knowledge light your path, hunter.",
                        responses: [
                            { text: "Continue", action: 'returnToLibrary' }
                        ]
                    }
                ]
            },
            
            alchemist: {
                id: 'alchemist',
                name: 'The Alchemist',
                type: 'merchant',
                description: 'A mysterious figure surrounded by bubbling potions',
                introduction: "In the laboratory, you find an alchemist hunched over a cauldron. The air smells of sulfur and herbs.",
                dialogues: [
                    {
                        id: 'initial',
                        text: "Ah, a visitor! I am the castle's alchemist. Dracula keeps me here to brew potions for his minions. But for the right price, I can brew something for you too.",
                        responses: [
                            { text: "What potions do you have for sale?", next: 'shop' },
                            { text: "I need to know Dracula's weaknesses.", next: 'weakness' },
                            { text: "I don't trust alchemists.", next: 'distrust' }
                        ]
                    },
                    {
                        id: 'shop',
                        text: `I have several concoctions (You have ${gameState.gold} gold):
                        1. Health Potion - 15 gold (restores 30 health)
                        2. Strength Elixir - 25 gold (+2 strength for next combat)
                        3. Holy Water - 20 gold (extra damage vs undead)
                        What would you like?`,
                        responses: [
                            { text: "Buy Health Potion", action: 'buyItem', item: 'healthPotion', cost: 15, next: 'bought' },
                            { text: "Buy Strength Elixir", action: 'buyItem', item: 'strengthElixir', cost: 25, next: 'bought' },
                            { text: "Buy Holy Water", action: 'buyItem', item: 'holyWater2', cost: 20, next: 'bought' },
                            { text: "I'll come back later.", next: 'end' }
                        ]
                    },
                    {
                        id: 'weakness',
                        text: "Dracula has three great weaknesses: sunlight, running water, and a wooden stake through the heart. But beware - he is strongest at midnight.",
                        responses: [
                            { text: "Thank you for the information.", next: 'end' }
                        ]
                    },
                    {
                        id: 'distrust',
                        text: "Your loss. Many hunters have perished without my aid.",
                        responses: [
                            { text: "Continue", action: 'returnToLaboratory' }
                        ]
                    },
                    {
                        id: 'bought',
                        text: "A wise purchase. This will help you survive.",
                        responses: [
                            { text: "Thank you.", next: 'end' }
                        ]
                    },
                    {
                        id: 'end',
                        text: "Good luck, hunter. You'll need it.",
                        responses: [
                            { text: "Continue", action: 'returnToLaboratory' }
                        ]
                    }
                ]
            },
            
            ghostChild: {
                id: 'ghostChild',
                name: 'Ghostly Child',
                type: 'tricky',
                description: 'A translucent child who flickers in and out of existence',
                introduction: "You hear faint crying. A ghostly child appears before you, tears streaming down its translucent face.",
                dialogues: [
                    {
                        id: 'initial',
                        text: "Please... help me. I'm lost. I can't find my way home.",
                        responses: [
                            { text: "How can I help you?", next: 'help' },
                            { text: "You're a ghost. You're already dead.", next: 'harsh' },
                            { text: "I have no time for spirits.", next: 'ignore' }
                        ]
                    },
                    {
                        id: 'help',
                        text: "Find my teddy bear. It's in the nursery. Without it, I can't rest.",
                        responses: [
                            { text: "I'll look for it.", action: 'addQuest', quest: 'teddyBear', next: 'thankYou' },
                            { text: "I don't have time for this.", next: 'ignore' }
                        ]
                    },
                    {
                        id: 'harsh',
                        text: "The child's face contorts in anger! 'You're mean!' It wails, and the sound chills you to the bone.",
                        action: 'damage',
                        amount: 10,
                        next: 'attack'
                    },
                    {
                        id: 'ignore',
                        text: "The child fades away, still crying.",
                        responses: [
                            { text: "Continue", action: 'returnToNursery' }
                        ]
                    },
                    {
                        id: 'thankYou',
                        text: "Thank you! Please hurry!",
                        responses: [
                            { text: "Continue", action: 'returnToNursery' }
                        ]
                    },
                    {
                        id: 'attack',
                        text: "The ghost child attacks!",
                        responses: [
                            { text: "Defend yourself!", action: 'startCombat', enemy: 'ghost' }
                        ]
                    }
                ]
            },
            
            imprisonedKnight: {
                id: 'imprisonedKnight',
                name: 'Imprisoned Knight',
                type: 'helpful',
                description: 'A knight in rusted armor, locked in a cell',
                introduction: "In the dungeon, you find a knight chained to the wall. His armor is rusted, but his eyes still burn with defiance.",
                dialogues: [
                    {
                        id: 'initial',
                        text: "You! Are you here to free me? I've been imprisoned here for months, forced to fight Dracula's creatures for sport.",
                        responses: [
                            { text: "How can I free you?", next: 'free' },
                            { text: "What do you know about this castle?", next: 'info' },
                            { text: "I can't help you now.", next: 'leave' }
                        ]
                    },
                    {
                        id: 'free',
                        text: "The key is on the wall behind you. Free me, and I'll give you this enchanted sword I managed to hide from the guards.",
                        responses: [
                            { text: "Take the key and free him", statCheck: { stat: 'strength', min: 7, success: 'freeSuccess', failure: 'freeFail' } },
                            { text: "This could be a trap.", next: 'leave' }
                        ]
                    },
                    {
                        id: 'info',
                        text: "Dracula's treasure vault is beneath the throne room. But it's guarded by stone gargoyles. You'll need silver weapons to harm them.",
                        responses: [
                            { text: "Thank you. I'll be careful.", next: 'end' },
                            { text: "Can you give me anything to help?", next: 'help' }
                        ]
                    },
                    {
                        id: 'freeSuccess',
                        text: "You break the rusted lock and free the knight. True to his word, he hands you an enchanted sword.",
                        action: 'addItem',
                        item: 'enchantedSword',
                        next: 'gratitude'
                    },
                    {
                        id: 'freeFail',
                        text: "The lock is too strong. You can't break it with your current strength.",
                        responses: [
                            { text: "I'm sorry, I can't free you.", next: 'disappointed' }
                        ]
                    },
                    {
                        id: 'help',
                        text: "Take this. It's all I have left.",
                        action: 'addItem',
                        item: 'healthPotion',
                        next: 'end'
                    },
                    {
                        id: 'disappointed',
                        text: "Very well. May God be with you.",
                        responses: [
                            { text: "Continue", action: 'returnToDungeon' }
                        ]
                    },
                    {
                        id: 'gratitude',
                        text: "Thank you, hunter. I shall make my escape now. Good luck against Dracula!",
                        responses: [
                            { text: "Farewell", action: 'returnToDungeon' }
                        ]
                    },
                    {
                        id: 'leave',
                        text: "The knight hangs his head in disappointment.",
                        responses: [
                            { text: "Continue", action: 'returnToDungeon' }
                        ]
                    },
                    {
                        id: 'end',
                        text: "Be careful, hunter. This castle has claimed many lives.",
                        responses: [
                            { text: "Continue", action: 'returnToDungeon' }
                        ]
                    }
                ]
            },
            
            wanderingMerchant: merchantNPC
        };
        
        // Items
        const additionalItems = {
            map: {
                id: 'map',
                name: 'Castle Map',
                description: 'A detailed map of the castle',
                icon: 'üó∫Ô∏è',
                effect: 'Reveals secret passages',
                type: 'utility'
            },
            ancientTome: {
                id: 'ancientTome',
                name: 'Ancient Tome',
                description: 'A book of vampire lore',
                icon: 'üìñ',
                effect: '+2 intelligence while in inventory',
                type: 'knowledge'
            },
            healthPotion: {
                id: 'healthPotion',
                name: 'Health Potion',
                description: 'Restores 30 health',
                icon: 'üß™',
                effect: 'Restores 30 health when used',
                type: 'consumable',
                use: function() {
                    const healAmount = 30;
                    gameState.stats.health = Math.min(gameState.stats.health + healAmount, gameState.stats.maxHealth);
                    return `You drink the health potion and restore ${healAmount} health!`;
                }
            },
            strengthElixir: {
                id: 'strengthElixir',
                name: 'Strength Elixir',
                description: 'Temporarily increases strength',
                icon: '‚öóÔ∏è',
                effect: '+2 strength for next combat',
                type: 'consumable',
                use: function() {
                    gameState.stats.strength += 2;
                    return `You drink the strength elixir! Strength increased by 2 for your next combat!`;
                }
            },
            holyWater2: {
                id: 'holyWater2',
                name: 'Holy Water (blessed)',
                description: 'Extra potent holy water',
                icon: 'üíß',
                effect: 'Deals 2x damage to undead',
                combatBonus: 2.5,
                type: 'combat'
            },
            enchantedSword: {
                id: 'enchantedSword',
                name: 'Enchanted Sword',
                description: 'A sword that glows with magical energy',
                icon: '‚öîÔ∏è',
                effect: '+3 damage in combat',
                combatBonus: 1.8,
                type: 'weapon'
            },
            silverBullets: {
                id: 'silverBullets',
                name: 'Silver Bullets',
                description: 'Ammunition effective against werewolves',
                icon: 'üî´',
                effect: 'Extra damage to lycanthropes',
                combatBonus: 2.0,
                type: 'ammunition'
            },
            skeletonKey: {
                id: 'skeletonKey',
                name: 'Skeleton Key',
                description: 'Opens most locked doors',
                icon: 'üîë',
                effect: 'Unlocks special rooms',
                type: 'key'
            },
            torch: {
                id: 'torch',
                name: 'Lit Torch',
                description: 'Provides light and can scare creatures',
                icon: 'üî•',
                effect: '+1 to attack in dark areas',
                type: 'utility'
            },
            teddyBear: {
                id: 'teddyBear',
                name: 'Teddy Bear',
                description: 'A worn-out teddy bear',
                icon: 'üß∏',
                effect: 'Quest item for ghost child',
                type: 'quest'
            },
            vampireDust: {
                id: 'vampireDust',
                name: 'Vampire Dust',
                description: 'Remains of a defeated vampire',
                icon: 'üå´Ô∏è',
                effect: 'Can be used for alchemy',
                type: 'material'
            }
        };
        
        // Game scenes
        const scenes = {
            characterCreation: {
                name: 'Character Creation',
                text: 'CREATE YOUR VAMPIRE HUNTER\n\nYou stand before the gates of Dracula\'s castle. Before entering, you must prepare yourself.\n\nDistribute your stat points (10 available):',
                controls: 'characterCreation'
            },
            
            castleEntrance: {
                name: 'Castle Entrance',
                text: 'The massive gates of Castle Dracula loom before you. The air is cold and still. Torches flicker in iron sconces, casting long shadows. You can hear the distant howl of wolves.\n\nWhat will you do?',
                controls: [
                    { text: 'Enter the main hall', scene: 'mainHall' },
                    { text: 'Search the courtyard', scene: 'courtyard' },
                    { text: 'Check your supplies', action: 'checkSupplies' }
                ]
            },
            
            mainHall: {
                name: 'Main Hall',
                text: 'You enter a vast, dusty hall. Portraits of ancient nobles line the walls, their eyes seeming to follow you. A grand staircase leads upward, and several doors lead deeper into the castle.\n\nYou notice movement in the shadows...',
                controls: [
                    { text: 'Approach the shadowy figure', scene: 'encounter', npc: 'oldMan' },
                    { text: 'Ascend the staircase', scene: 'upperFloor' },
                    { text: 'Enter the library', scene: 'library' },
                    { text: 'Go to the dining hall', scene: 'diningHall' },
                    { text: 'Descend to the dungeon', scene: 'dungeon' },
                    { text: 'Return to the entrance', scene: 'castleEntrance' }
                ]
            },
            
            courtyard: {
                name: 'Courtyard',
                text: 'The castle courtyard is overgrown with thorny roses that seem to twist unnaturally. A fountain in the center contains dark, stagnant water. You sense you\'re being watched from the castle windows above.',
                controls: [
                    { text: 'Investigate the fountain', scene: 'encounter', npc: 'mysteriousWoman' },
                    { text: 'Search the gardener\'s shed', action: 'searchShed' },
                    { text: 'Explore the graveyard', scene: 'graveyard' },
                    { text: 'Return to the entrance', scene: 'castleEntrance' }
                ]
            },
            
            upperFloor: {
                name: 'Upper Floor',
                text: 'The upper floor is even darker than below. Dusty tapestries depict scenes of battle and feasting. You hear strange whispers echoing through the corridors.',
                controls: [
                    { text: 'Follow the whispers', scene: 'encounter', npc: 'vampireHunter' },
                    { text: 'Enter the throne room', scene: 'throneRoom' },
                    { text: 'Explore the guest bedrooms', scene: 'guestBedrooms' },
                    { text: 'Climb to the tower', scene: 'tower' },
                    { text: 'Return to the main hall', scene: 'mainHall' }
                ]
            },
            
            library: {
                name: 'Library',
                text: 'The library contains thousands of ancient books. In the center of the room, a large book lies open on a pedestal. It appears to be a genealogy of the Dracula family.',
                controls: [
                    { text: 'Examine the book', action: 'readBook' },
                    { text: 'Search for useful information', action: 'searchLibrary' },
                    { text: 'Talk to the librarian', scene: 'encounter', npc: 'librarian' },
                    { text: 'Leave the library', scene: 'mainHall' }
                ]
            },
            
            throneRoom: {
                name: 'Throne Room',
                text: 'You enter the throne room. At the far end sits an empty throne made of black stone. The room is freezing cold, and your breath forms mist in the air.\n\nSuddenly, a figure materializes on the throne!',
                controls: [
                    { text: 'Approach the throne', action: 'finalConfrontation' },
                    { text: 'Search the room for clues', action: 'searchThroneRoom' },
                    { text: 'Examine the tapestries', action: 'examineTapestries' },
                    { text: 'Retreat and regroup', scene: 'upperFloor' }
                ]
            },
            
            diningHall: {
                name: 'Dining Hall',
                text: 'A long table set for a feast stretches the length of the hall. The food on the plates has long since rotted, and cobwebs drape from the chandeliers. Rats scurry in the corners.',
                controls: [
                    { text: 'Search the table', action: 'searchDiningTable' },
                    { text: 'Investigate the kitchen', scene: 'kitchen' },
                    { text: 'Check the wine cellar', scene: 'wineCellar' },
                    { text: 'Return to the main hall', scene: 'mainHall' }
                ]
            },
            
            dungeon: {
                name: 'Dungeon',
                text: 'The air in the dungeon is thick with the smell of damp stone and decay. Rusted chains hang from the walls, and you can hear dripping water echoing in the darkness.',
                controls: [
                    { text: 'Explore the cells', action: 'exploreCells' },
                    { text: 'Talk to the imprisoned knight', scene: 'encounter', npc: 'imprisonedKnight' },
                    { text: 'Investigate the torture chamber', action: 'tortureChamber' },
                    { text: 'Return to the main hall', scene: 'mainHall' }
                ]
            },
            
            laboratory: {
                name: 'Alchemy Laboratory',
                text: 'Bubbling cauldrons and strange apparatus fill this room. Shelves line the walls, containing jars of mysterious ingredients. The air smells of sulfur and ozone.',
                controls: [
                    { text: 'Talk to the alchemist', scene: 'encounter', npc: 'alchemist' },
                    { text: 'Search for useful potions', action: 'searchLaboratory' },
                    { text: 'Examine the alchemical notes', action: 'readNotes' },
                    { text: 'Return to the upper floor', scene: 'upperFloor' }
                ]
            },
            
            nursery: {
                name: 'Abandoned Nursery',
                text: 'This room was once a child\'s nursery. Dusty toys are scattered about, and a broken crib sits in the corner. The room feels unnaturally cold.',
                controls: [
                    { text: 'Search for the teddy bear', action: 'searchForTeddy' },
                    { text: 'Talk to the ghost child', scene: 'encounter', npc: 'ghostChild' },
                    { text: 'Investigate the rocking chair', action: 'rockingChair' },
                    { text: 'Leave the nursery', scene: 'guestBedrooms' }
                ]
            },
            
            guestBedrooms: {
                name: 'Guest Bedrooms',
                text: 'A series of lavish bedrooms, each more opulent than the last. Silk curtains hang in tatters, and the beds look untouched for centuries.',
                controls: [
                    { text: 'Search the first bedroom', action: 'searchBedroom1' },
                    { text: 'Investigate the second bedroom', action: 'searchBedroom2' },
                    { text: 'Enter the nursery', scene: 'nursery' },
                    { text: 'Return to the upper floor', scene: 'upperFloor' }
                ]
            },
            
            graveyard: {
                name: 'Castle Graveyard',
                text: 'Ancient tombstones tilt at odd angles in the overgrown graveyard. A thick fog blankets the ground, and you hear the occasional sound of earth shifting.',
                controls: [
                    { text: 'Search for useful items', action: 'searchGraveyard' },
                    { text: 'Examine the mausoleum', scene: 'mausoleum' },
                    { text: 'Return to the courtyard', scene: 'courtyard' }
                ]
            },
            
            mausoleum: {
                name: 'Family Mausoleum',
                text: 'The Dracula family mausoleum is an imposing structure of black marble. The air inside is deathly still.',
                controls: [
                    { text: 'Search the sarcophagi', action: 'searchMausoleum' },
                    { text: 'Examine the inscriptions', action: 'readInscriptions' },
                    { text: 'Return to the graveyard', scene: 'graveyard' }
                ]
            },
            
            tower: {
                name: 'Clock Tower',
                text: 'You climb a spiral staircase to the clock tower. Giant gears turn slowly, and the clock face shows it\'s almost midnight. From here, you can see the entire castle grounds.',
                controls: [
                    { text: 'Examine the clock mechanism', action: 'examineClock' },
                    { text: 'Look for Dracula\'s coffin', action: 'searchForCoffin' },
                    { text: 'Return to the upper floor', scene: 'upperFloor' }
                ]
            },
            
            kitchen: {
                name: 'Castle Kitchen',
                text: 'A massive kitchen with huge fireplaces and rusted cooking implements. The remains of a last meal are still on the cutting boards.',
                controls: [
                    { text: 'Search for food', action: 'searchKitchen' },
                    { text: 'Investigate the pantry', action: 'searchPantry' },
                    { text: 'Return to the dining hall', scene: 'diningHall' }
                ]
            },
            
            wineCellar: {
                name: 'Wine Cellar',
                text: 'Rows of wine barrels line the walls. The air is cool and smells of fermentation. Something is moving in the shadows...',
                controls: [
                    { text: 'Search for valuable wine', action: 'searchWineCellar' },
                    { text: 'Investigate the strange noise', action: 'wineCellarNoise' },
                    { text: 'Return to the dining hall', scene: 'diningHall' }
                ]
            },
            
            armory: {
                name: 'Castle Armory',
                text: 'Rusted weapons and armor line the walls of this room. Most are in poor condition, but a few pieces still gleam in the dim light.',
                controls: [
                    { text: 'Search for usable weapons', action: 'searchArmory' },
                    { text: 'Examine the armor', action: 'examineArmor' },
                    { text: 'Return to the main hall', scene: 'mainHall' }
                ]
            },
            
            chapel: {
                name: 'Castle Chapel',
                text: 'A small, neglected chapel with broken pews and a shattered stained glass window. An altar stands at the front, covered in dust.',
                controls: [
                    { text: 'Search the altar', action: 'searchAltar' },
                    { text: 'Examine the stained glass', action: 'examineStainedGlass' },
                    { text: 'Return to the courtyard', scene: 'courtyard' }
                ]
            },
            
            observatory: {
                name: 'Observatory',
                text: 'A circular room with a large telescope pointed at the night sky. Star charts and astronomical instruments are scattered about.',
                controls: [
                    { text: 'Look through the telescope', action: 'useTelescope' },
                    { text: 'Examine the star charts', action: 'examineStarCharts' },
                    { text: 'Return to the upper floor', scene: 'upperFloor' }
                ]
            },
            
            secretPassage: {
                name: 'Secret Passage',
                text: 'A hidden passage behind a bookshelf. The air is musty, and cobwebs brush against your face as you move forward.',
                controls: [
                    { text: 'Follow the passage', action: 'followSecretPassage' },
                    { text: 'Search for hidden items', action: 'searchSecretPassage' },
                    { text: 'Return to where you came from', action: 'returnFromSecretPassage' }
                ]
            },
            
            treasureVault: {
                name: 'Treasure Vault',
                text: 'A room filled with gold coins, jewels, and priceless artifacts. The wealth of centuries is stored here.',
                controls: [
                    { text: 'Take some treasure', action: 'takeTreasure' },
                    { text: 'Search for special items', action: 'searchTreasureVault' },
                    { text: 'Leave the vault', scene: 'throneRoom' }
                ]
            },
            
            encounter: {
                name: 'NPC Encounter',
                text: '',
                controls: []
            },
            
            combat: {
                name: 'Combat',
                text: '',
                controls: []
            }
        };
        
        // DOM Elements
        const gameScreen = document.getElementById('gameScreen');
        const controlsDiv = document.getElementById('controls');
        const statsDisplay = document.getElementById('statsDisplay');
        const inventoryDisplay = document.getElementById('inventoryDisplay');
        const progressFill = document.getElementById('progressFill');
        
        // Initialize game
        function initGame() {
            updateDisplay();
            showScene('characterCreation');
        }
        
        // Update all displays
        function updateDisplay() {
            updateStatsDisplay();
            updateInventoryDisplay();
            updateProgressBar();
        }
        
        // Update stats display
        function updateStatsDisplay() {
            statsDisplay.innerHTML = '';
            
            // Add gold display
            const goldItem = document.createElement('div');
            goldItem.className = 'stat-item';
            const goldName = document.createElement('span');
            goldName.textContent = 'Gold:';
            const goldValue = document.createElement('span');
            goldValue.className = 'stat-value';
            goldValue.textContent = gameState.gold;
            goldValue.style.color = '#ffd700';
            goldItem.appendChild(goldName);
            goldItem.appendChild(goldValue);
            statsDisplay.appendChild(goldItem);
            
            for (const [stat, value] of Object.entries(gameState.stats)) {
                if (stat === 'maxHealth') continue;
                
                const statItem = document.createElement('div');
                statItem.className = 'stat-item';
                
                const statName = document.createElement('span');
                statName.textContent = stat.charAt(0).toUpperCase() + stat.slice(1) + ':';
                
                const statValue = document.createElement('span');
                statValue.className = 'stat-value';
                
                if (stat === 'health') {
                    statValue.textContent = `${value}/${gameState.stats.maxHealth}`;
                    // Change color based on health level
                    if (value < 30) {
                        statValue.style.color = '#ff3333';
                    } else if (value < 60) {
                        statValue.style.color = '#ffff00';
                    }
                } else {
                    statValue.textContent = value;
                }
                
                statItem.appendChild(statName);
                statItem.appendChild(statValue);
                statsDisplay.appendChild(statItem);
            }
            
            // Add stat points if in character creation
            if (gameState.currentScene === 'characterCreation') {
                const pointsItem = document.createElement('div');
                pointsItem.className = 'stat-item';
                
                const pointsName = document.createElement('span');
                pointsName.textContent = 'Available Points:';
                
                const pointsValue = document.createElement('span');
                pointsValue.className = 'stat-value';
                pointsValue.textContent = gameState.statPoints;
                
                pointsItem.appendChild(pointsName);
                pointsItem.appendChild(pointsValue);
                statsDisplay.appendChild(pointsItem);
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            inventoryDisplay.innerHTML = '';
            
            if (gameState.inventory.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'inventory-item';
                emptyMsg.textContent = 'Empty';
                inventoryDisplay.appendChild(emptyMsg);
                return;
            }
            
            gameState.inventory.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                
                const itemIcon = document.createElement('span');
                itemIcon.className = 'item-icon';
                itemIcon.textContent = item.icon || '‚öîÔ∏è';
                
                const itemName = document.createElement('span');
                itemName.textContent = item.name;
                
                itemElement.appendChild(itemIcon);
                itemElement.appendChild(itemName);
                inventoryDisplay.appendChild(itemElement);
            });
        }
        
        // Update progress bar
        function updateProgressBar() {
            progressFill.style.width = `${gameState.progress}%`;
        }
        
        // Show a game scene
        function showScene(sceneId, npcId = null) {
            gameState.currentScene = sceneId;
            
            // Add to discovered rooms if not already there
            if (!gameState.discoveredRooms.includes(sceneId) && scenes[sceneId]) {
                gameState.discoveredRooms.push(sceneId);
            }
            
            // Clear screen
            gameScreen.innerHTML = '';
            controlsDiv.innerHTML = '';
            
            // Create screen content container
            const screenContent = document.createElement('div');
            screenContent.className = 'screen-content';
            gameScreen.appendChild(screenContent);
            
            // Check if merchant should appear (15% chance in most rooms, not in combat or character creation)
            if (sceneId !== 'combat' && sceneId !== 'characterCreation' && sceneId !== 'encounter' && 
                !sceneId.includes('merchant') && gameState.merchantCooldown <= 0) {
                if (Math.random() < 0.15) {
                    gameState.merchantPresent = true;
                    gameState.merchantCooldown = 3; // Merchant won't appear again for 3 room changes
                    
                    // Add merchant option to the scene
                    const merchantMsg = document.createElement('div');
                    merchantMsg.className = 'message npc-message';
                    merchantMsg.textContent = "You notice a cloaked figure in the corner of the room. It's the wandering merchant!";
                    screenContent.appendChild(merchantMsg);
                    
                    // Add merchant button to controls
                    const merchantButton = document.createElement('button');
                    merchantButton.textContent = 'Talk to Merchant';
                    merchantButton.onclick = () => {
                        AudioManager.playClick(); // <-- SOUND
                        gameState.merchantPresent = false;
                        showScene('encounter', 'wanderingMerchant');
                    };
                    controlsDiv.appendChild(merchantButton);
                } else {
                    gameState.merchantPresent = false;
                }
            }
            
            // Reduce merchant cooldown if > 0
            if (gameState.merchantCooldown > 0) {
                gameState.merchantCooldown--;
            }
            
            // Handle different scene types
            if (sceneId === 'characterCreation') {
                displayCharacterCreation(screenContent);
            } else if (sceneId === 'encounter' && npcId) {
                startEncounter(npcId, screenContent);
            } else if (sceneId === 'combat') {
                displayCombatScreen(screenContent);
            } else {
                const scene = scenes[sceneId];
                
                if (!scene) {
                    console.error(`Scene ${sceneId} not found`);
                    return;
                }
                
                // Display scene header
                const sceneHeader = document.createElement('div');
                sceneHeader.className = 'screen-header';
                sceneHeader.textContent = scene.name;
                screenContent.appendChild(sceneHeader);
                
                // Display scene text
                const sceneText = document.createElement('div');
                sceneText.className = 'message';
                sceneText.textContent = scene.text;
                screenContent.appendChild(sceneText);
                
                // Display scene controls
                if (scene.controls === 'characterCreation') {
                    // Handled separately
                } else if (Array.isArray(scene.controls)) {
                    scene.controls.forEach(control => {
                        createSceneButton(control, screenContent);
                    });
                }
            }
            
            updateDisplay();
        }
        
        // Create a button for scene controls
        function createSceneButton(control, screenContent) {
            const button = document.createElement('button');
            button.textContent = control.text;
            
            button.onclick = () => {
                AudioManager.playClick(); // <-- SOUND
                if (control.action) {
                    handleAction(control.action, control, screenContent);
                } else if (control.statCheck) {
                    handleStatCheck(control.statCheck, null, control.next, screenContent);
                } else if (control.scene === 'encounter' && control.npc) {
                    showScene('encounter', control.npc);
                } else if (control.scene) {
                    // Increase progress when moving to new areas
                    if (gameState.progress < 100 && !gameState.currentScene.includes('castleEntrance')) {
                        gameState.progress += Math.floor(Math.random() * 5) + 1;
                        if (gameState.progress > 100) gameState.progress = 100;
                        updateProgressBar();
                    }
                    showScene(control.scene);
                }
            };
            controlsDiv.appendChild(button);
        }
        
        // Display character creation screen
        function displayCharacterCreation(screenContent) {
            // Create scene header
            const sceneHeader = document.createElement('div');
            sceneHeader.className = 'screen-header';
            sceneHeader.textContent = 'CHARACTER CREATION';
            screenContent.appendChild(sceneHeader);
            
            // Create instruction text
            const instructionText = document.createElement('div');
            instructionText.className = 'message';
            instructionText.textContent = 'You stand before the gates of Dracula\'s castle. Before entering, you must prepare yourself.';
            screenContent.appendChild(instructionText);
            
            // Create stat allocation UI
            const statAllocation = document.createElement('div');
            statAllocation.className = 'stat-allocation';
            
            // Define which stats can be allocated
            const allocatableStats = ['strength', 'intelligence', 'charisma', 'luck'];
            
            allocatableStats.forEach(stat => {
                const statControl = document.createElement('div');
                statControl.className = 'stat-control';
                
                const statName = document.createElement('span');
                statName.textContent = stat.charAt(0).toUpperCase() + stat.slice(1) + ': ';
                
                const statValue = document.createElement('span');
                statValue.id = `${stat}Value`;
                statValue.textContent = gameState.stats[stat];
                statValue.style.margin = '0 8px';
                statValue.style.color = '#00ff00';
                
                const decreaseBtn = document.createElement('button');
                decreaseBtn.textContent = '-';
                decreaseBtn.className = 'stat-btn';
                decreaseBtn.onclick = () => {
                    AudioManager.playClick(); // <-- SOUND
                    adjustStat(stat, -1);
                };
                
                const increaseBtn = document.createElement('button');
                increaseBtn.textContent = '+';
                increaseBtn.className = 'stat-btn';
                increaseBtn.onclick = () => {
                    AudioManager.playClick(); // <-- SOUND
                    adjustStat(stat, 1);
                };
                
                statControl.appendChild(statName);
                statControl.appendChild(decreaseBtn);
                statControl.appendChild(statValue);
                statControl.appendChild(increaseBtn);
                
                statAllocation.appendChild(statControl);
            });
            
            screenContent.appendChild(statAllocation);
            
            // Display stat points remaining
            const pointsDisplay = document.createElement('div');
            pointsDisplay.className = 'message';
            pointsDisplay.id = 'pointsDisplay';
            pointsDisplay.textContent = `Stat points remaining: ${gameState.statPoints}`;
            screenContent.appendChild(pointsDisplay);
            
            // Warning message container
            const warningContainer = document.createElement('div');
            warningContainer.id = 'warningContainer';
            screenContent.appendChild(warningContainer);
            
            // Item selection
            const itemSelection = document.createElement('div');
            itemSelection.innerHTML = '<h3>SELECT STARTING ITEM:</h3>';
            
            const itemOptions = document.createElement('div');
            itemOptions.className = 'item-options';
            
            startingItems.forEach(item => {
                const itemOption = document.createElement('div');
                itemOption.className = `item-option ${gameState.selectedItem === item.id ? 'selected' : ''}`;
                itemOption.dataset.itemId = item.id;
                itemOption.innerHTML = `
                    <strong>${item.name}</strong><br>
                    <small>${item.description}</small>
                `;
                itemOption.onclick = () => {
                    AudioManager.playClick(); // <-- SOUND
                    selectItem(item.id);
                };
                itemOptions.appendChild(itemOption);
            });
            
            itemSelection.appendChild(itemOptions);
            screenContent.appendChild(itemSelection);
            
            // Start game button
            const startButton = document.createElement('button');
            startButton.textContent = 'BEGIN YOUR QUEST';
            startButton.className = 'primary';
            startButton.style.marginTop = '15px';
            startButton.onclick = () => {
                AudioManager.playClick(); // <-- SOUND
                startGame();
            };
            startButton.id = 'startButton';
            
            // Check initial state for button
            updateStartButtonState();
            
            controlsDiv.appendChild(startButton);
        }
        
        // Update start button state based on stat points and item selection
        function updateStartButtonState() {
            const startButton = document.getElementById('startButton');
            const warningContainer = document.getElementById('warningContainer');
            
            if (!startButton || !warningContainer) return;
            
            if (gameState.statPoints > 0) {
                startButton.disabled = true;
                warningContainer.innerHTML = `<div class="warning">You have ${gameState.statPoints} stat points remaining!</div>`;
            } else if (!gameState.selectedItem) {
                startButton.disabled = true;
                warningContainer.innerHTML = `<div class="warning">You must select a starting item!</div>`;
            } else {
                startButton.disabled = false;
                warningContainer.innerHTML = '';
            }
        }
        
        // Adjust a stat during character creation
        function adjustStat(stat, amount) {
            if (amount > 0 && gameState.statPoints <= 0) return;
            if (amount < 0 && gameState.stats[stat] <= 1) return;
            
            gameState.stats[stat] += amount;
            gameState.statPoints -= amount;
            
            document.getElementById(`${stat}Value`).textContent = gameState.stats[stat];
            document.getElementById('pointsDisplay').textContent = `Stat points remaining: ${gameState.statPoints}`;
            
            // Update start button state
            updateStartButtonState();
            updateDisplay();
        }
        
        // Select a starting item
        function selectItem(itemId) {
            gameState.selectedItem = itemId;
            
            // Update UI to show selected item
            document.querySelectorAll('.item-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked item
            document.querySelector(`.item-option[data-item-id="${itemId}"]`).classList.add('selected');
            
            // Update start button state
            updateStartButtonState();
            updateDisplay();
        }
        
        // Start the game proper
        function startGame() {
            if (gameState.statPoints > 0 || !gameState.selectedItem) return;
            
            // Add selected item to inventory
            const selectedItemData = startingItems.find(item => item.id === gameState.selectedItem);
            if (selectedItemData) {
                gameState.inventory.push(selectedItemData);
            }
            
            showScene('castleEntrance');
        }
        
        // Start an NPC encounter
        function startEncounter(npcId, screenContent) {
            const npc = npcs[npcId];
            
            if (!npc) {
                console.error(`NPC ${npcId} not found`);
                return;
            }
            
            gameState.currentNPC = npc;
            
            // Display NPC introduction
            const introText = document.createElement('div');
            introText.className = 'message npc-message';
            introText.textContent = npc.introduction;
            screenContent.appendChild(introText);
            
            // Start with initial dialogue
            displayDialogue(npc, npc.dialogues[0], screenContent);
        }
        
        // Display NPC dialogue
        function displayDialogue(npc, dialogue, screenContent) {
            // Clear controls
            controlsDiv.innerHTML = '';
            
            // Display NPC dialogue text
            if (dialogue.text) {
                const dialogueText = document.createElement('div');
                dialogueText.className = 'message npc-message';
                dialogueText.textContent = dialogue.text;
                screenContent.appendChild(dialogueText);
            }
            
            // Special handling for merchant shop
            if (npc.id === 'wanderingMerchant' && dialogue.id === 'shop') {
                displayMerchantShop(screenContent);
                return;
            }
            
            // Handle dialogue action if present
            if (dialogue.action) {
                handleAction(dialogue.action, dialogue, screenContent);
            }
            
            // Create response buttons if there are responses
            if (dialogue.responses && dialogue.responses.length > 0) {
                dialogue.responses.forEach(response => {
                    createDialogueButton(response, npc, screenContent);
                });
            } else {
                // If no responses, add a continue button
                const continueButton = document.createElement('button');
                continueButton.textContent = 'Continue';
                continueButton.onclick = () => {
                    AudioManager.playClick(); // <-- SOUND
                    // Default to returning to previous scene
                    showScene(gameState.preCombatScene);
                };
                controlsDiv.appendChild(continueButton);
            }
        }
        
        // Display merchant shop
        function displayMerchantShop(screenContent) {
            // Clear controls first
            controlsDiv.innerHTML = '';
            
            // Create gold display
            const goldDisplay = document.createElement('div');
            goldDisplay.className = 'merchant-gold';
            goldDisplay.textContent = `Your Gold: ${gameState.gold}`;
            screenContent.appendChild(goldDisplay);
            
            // Create merchant items list
            merchantItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'merchant-item';
                
                const itemInfo = document.createElement('div');
                itemInfo.innerHTML = `
                    <strong>${item.name}</strong><br>
                    <small>${item.description}</small><br>
                    <small>${item.effect}</small>
                `;
                
                const itemPrice = document.createElement('div');
                itemPrice.className = 'item-price';
                itemPrice.textContent = `${item.price} gold`;
                
                itemElement.appendChild(itemInfo);
                itemElement.appendChild(itemPrice);
                
                // Make clickable if player can afford it
                if (gameState.gold >= item.price) {
                    itemElement.style.cursor = 'pointer';
                    itemElement.onclick = () => {
                        AudioManager.playClick(); // <-- SOUND
                        buyMerchantItem(item, screenContent);
                    };
                } else {
                    itemElement.style.opacity = '0.5';
                    itemElement.style.cursor = 'not-allowed';
                }
                
                screenContent.appendChild(itemElement);
            });
            
            // Add leave button
            const leaveButton = document.createElement('button');
            leaveButton.textContent = 'Leave Shop';
            leaveButton.onclick = () => {
                AudioManager.playClick(); // <-- SOUND
                showScene(gameState.preCombatScene);
            };
            controlsDiv.appendChild(leaveButton);
        }
        
        // Buy an item from the merchant
        function buyMerchantItem(item, screenContent) {
            if (gameState.gold >= item.price) {
                // Deduct gold
                gameState.gold -= item.price;
                
                // Add item to inventory
                gameState.inventory.push(item);
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'message player-message';
                successMsg.textContent = `You bought ${item.name} for ${item.price} gold!`;
                screenContent.appendChild(successMsg);
                AudioManager.playReward(); // <-- SOUND
                
                // Update displays
                updateDisplay();
                
                // Re-render merchant shop
                setTimeout(() => {
                    // Clear the screen content except the first message (NPC intro)
                    while (screenContent.childNodes.length > 1) {
                        screenContent.removeChild(screenContent.lastChild);
                    }
                    displayMerchantShop(screenContent);
                }, 1500);
            }
        }
        
        // Create a button for dialogue responses
        function createDialogueButton(response, npc, screenContent) {
            const button = document.createElement('button');
            button.textContent = response.text;
            
            button.onclick = () => {
                AudioManager.playClick(); // <-- SOUND
                // Handle special actions
                if (response.action) {
                    const result = handleAction(response.action, response, screenContent, npc);
                    
                    // If action returns false (like failed item check), don't proceed
                    if (result === false) {
                        // The action handler should show appropriate messages
                        return;
                    }
                }
                
                // Handle stat checks
                if (response.statCheck) {
                    handleStatCheck(response.statCheck, npc, response.next, screenContent);
                    return;
                }
                
                // Handle next dialogue
                handleNextDialogue(response, npc, screenContent);
            };
            
            controlsDiv.appendChild(button);
        }
        
        // Handle next dialogue after a response
        function handleNextDialogue(response, npc, screenContent) {
            // Find next dialogue
            if (response.next) {
                const nextDialogue = npc.dialogues.find(d => d.id === response.next);
                if (nextDialogue) {
                    displayDialogue(npc, nextDialogue, screenContent);
                } else {
                    // If no dialogue found, return to scene
                    showScene(gameState.preCombatScene);
                }
            } else {
                // End encounter
                showScene(gameState.preCombatScene);
            }
        }
        
        // Handle special actions
        function handleAction(action, response, screenContent, npc) {
            const screenContentElement = screenContent || document.querySelector('.screen-content');
            
            switch(action) {
                case 'addItem':
                    if (response.item) {
                        let item;
                        if (startingItems.some(i => i.id === response.item)) {
                            item = startingItems.find(i => i.id === response.item);
                        } else if (additionalItems[response.item]) {
                            item = additionalItems[response.item];
                        }
                        
                        if (item && !gameState.inventory.some(i => i.id === item.id)) {
                            gameState.inventory.push(item);
                            
                            // Show message
                            const messageDiv = document.createElement('div');
                            messageDiv.className = 'message player-message';
                            messageDiv.textContent = `You received: ${item.name}`;
                            screenContentElement.appendChild(messageDiv);
                            AudioManager.playNotification(); // <-- SOUND
                            
                            updateInventoryDisplay();
                        }
                    }
                    return true;
                    
                case 'buyItem':
                    if (response.item && response.cost) {
                        if (gameState.gold >= response.cost) {
                            gameState.gold -= response.cost;
                            
                            let item;
                            if (startingItems.some(i => i.id === response.item)) {
                                item = startingItems.find(i => i.id === response.item);
                            } else if (additionalItems[response.item]) {
                                item = additionalItems[response.item];
                            }
                            
                            if (item) {
                                gameState.inventory.push(item);
                                
                                // Show message
                                const messageDiv = document.createElement('div');
                                messageDiv.className = 'message player-message';
                                messageDiv.textContent = `You bought: ${item.name} for ${response.cost} gold.`;
                                screenContentElement.appendChild(messageDiv);
                                AudioManager.playReward(); // <-- SOUND
                                
                                updateDisplay();
                                updateInventoryDisplay();
                            }
                            return true;
                        } else {
                            // Not enough gold
                            const messageDiv = document.createElement('div');
                            messageDiv.className = 'message enemy-message';
                            messageDiv.textContent = `You don't have enough gold! (Need: ${response.cost}, Have: ${gameState.gold})`;
                            screenContentElement.appendChild(messageDiv);
                            return false;
                        }
                    }
                    return false;
                    
                case 'addQuest':
                    // Placeholder for quest system
                    const questMsg = document.createElement('div');
                    questMsg.className = 'message player-message';
                    questMsg.textContent = `New quest: ${response.quest}`;
                    screenContentElement.appendChild(questMsg);
                    return true;
                    
                case 'checkItem':
                    // Check if player has the item
                    const hasItem = gameState.inventory.some(item => item.id === response.item);
                    if (hasItem) {
                        // Item check succeeded
                        if (response.success) {
                            // Find the success dialogue
                            if (npc) {
                                const successDialogue = npc.dialogues.find(d => d.id === response.success);
                                if (successDialogue) {
                                    displayDialogue(npc, successDialogue, screenContentElement);
                                }
                            }
                        }
                        return true;
                    } else {
                        // Item check failed
                        if (response.failure) {
                            if (response.failure === 'combat' && response.enemy) {
                                startCombat(response.enemy);
                            } else if (npc) {
                                const failureDialogue = npc.dialogues.find(d => d.id === response.failure);
                                if (failureDialogue) {
                                    displayDialogue(npc, failureDialogue, screenContentElement);
                                }
                            }
                        }
                        return false;
                    }
                    
                case 'progress':
                    if (response.amount) {
                        gameState.progress += response.amount;
                        if (gameState.progress > 100) gameState.progress = 100;
                        updateProgressBar();
                    }
                    return true;
                    
                case 'allyProgress':
                    // Special progress for allying with Van Helsing
                    gameState.progress += 20;
                    if (gameState.progress > 100) gameState.progress = 100;
                    updateProgressBar();
                    
                    // Add a helpful item
                    handleAction('addItem', { item: 'healthPotion' }, screenContent, npc);
                    return true;
                    
                case 'damage':
                    if (response.amount) {
                        gameState.stats.health -= response.amount;
                        
                        // Show damage message
                        const damageMsg = document.createElement('div');
                        damageMsg.className = 'message enemy-message';
                        damageMsg.textContent = `You take ${response.amount} damage! Health: ${gameState.stats.health}/${gameState.stats.maxHealth}`;
                        screenContentElement.appendChild(damageMsg);
                        AudioManager.playEnemyHit(); // <-- SOUND (player takes damage)
                        
                        if (gameState.stats.health <= 0) {
                            setTimeout(() => gameOver(), 1000);
                        } else {
                            updateDisplay();
                        }
                    }
                    return true;
                    
                case 'checkSupplies':
                    const suppliesMsg = document.createElement('div');
                    suppliesMsg.className = 'message';
                    suppliesMsg.textContent = `You check your supplies. Health: ${gameState.stats.health}/${gameState.stats.maxHealth}. Items: ${gameState.inventory.length}. Gold: ${gameState.gold}`;
                    screenContentElement.appendChild(suppliesMsg);
                    return true;
                    
                case 'readBook':
                    const bookMsg = document.createElement('div');
                    bookMsg.className = 'message player-message';
                    bookMsg.textContent = "The book reveals that Dracula can only be killed by a wooden stake through the heart, during daylight hours.";
                    screenContentElement.appendChild(bookMsg);
                    
                    // Add a continue button
                    setTimeout(() => {
                        const continueBtn = document.createElement('button');
                        continueBtn.textContent = 'Continue';
                        continueBtn.onclick = () => {
                            AudioManager.playClick(); // <-- SOUND
                            showScene('library');
                        };
                        controlsDiv.appendChild(continueBtn);
                    }, 500);
                    return true;
                    
                case 'searchLibrary':
                    // Clear controls first
                    controlsDiv.innerHTML = '';
                    
                    const searchMsg = document.createElement('div');
                    searchMsg.className = 'message';
                    
                    // Intelligence check
                    if (gameState.stats.intelligence >= 6) {
                        searchMsg.textContent = "You find a hidden note: 'Dracula's weakness: sunlight, wooden stake, holy water.' You also find 10 gold!";
                        searchMsg.style.color = '#00ff00';
                        
                        // Add progress and gold
                        gameState.progress += 5;
                        gameState.gold += 10;
                        if (gameState.progress > 100) gameState.progress = 100;
                        updateProgressBar();
                        updateDisplay();
                        AudioManager.playReward(); // <-- SOUND
                    } else {
                        searchMsg.textContent = "You search through the books but find nothing useful.";
                        searchMsg.style.color = '#ff3333';
                    }
                    
                    screenContentElement.appendChild(searchMsg);
                    
                    // Add a continue button
                    setTimeout(() => {
                        const continueBtn = document.createElement('button');
                        continueBtn.textContent = 'Continue';
                        continueBtn.onclick = () => {
                            AudioManager.playClick(); // <-- SOUND
                            showScene('library');
                        };
                        controlsDiv.appendChild(continueBtn);
                    }, 500);
                    return true;
                    
                case 'searchShed':
                    const shedMsg = document.createElement('div');
                    shedMsg.className = 'message';
                    
                    if (gameState.stats.luck >= 7) {
                        shedMsg.textContent = "You find a health potion and 5 gold in the shed!";
                        shedMsg.style.color = '#00ff00';
                        handleAction('addItem', { item: 'healthPotion' }, screenContent, npc);
                        gameState.gold += 5;
                        updateDisplay();
                        AudioManager.playReward(); // <-- SOUND
                    } else {
                        shedMsg.textContent = "The shed is empty except for some gardening tools.";
                    }
                    
                    screenContentElement.appendChild(shedMsg);
                    
                    // Add a continue button
                    setTimeout(() => {
                        const continueBtn = document.createElement('button');
                        continueBtn.textContent = 'Continue';
                        continueBtn.onclick = () => {
                            AudioManager.playClick(); // <-- SOUND
                            showScene('courtyard');
                        };
                        controlsDiv.appendChild(continueBtn);
                    }, 500);
                    return true;
                    
                case 'searchThroneRoom':
                    const throneMsg = document.createElement('div');
                    throneMsg.className = 'message';
                    
                    if (Math.random() > 0.5) {
                        throneMsg.textContent = "You find a secret compartment containing a health potion and 20 gold!";
                        throneMsg.style.color = '#00ff00';
                        handleAction('addItem', { item: 'healthPotion' }, screenContent, npc);
                        gameState.gold += 20;
                        updateDisplay();
                        AudioManager.playReward(); // <-- SOUND
                    } else {
                        throneMsg.textContent = "You search the room but find nothing of value.";
                    }
                    
                    screenContentElement.appendChild(throneMsg);
                    
                    // Add a continue button
                    setTimeout(() => {
                        const continueBtn = document.createElement('button');
                        continueBtn.textContent = 'Continue';
                        continueBtn.onclick = () => {
                            AudioManager.playClick(); // <-- SOUND
                            showScene('throneRoom');
                        };
                        controlsDiv.appendChild(continueBtn);
                    }, 500);
                    return true;
                    
                case 'examineTapestries':
                    const tapestryMsg = document.createElement('div');
                    tapestryMsg.className = 'message';
                    
                    if (gameState.stats.intelligence >= 8) {
                        tapestryMsg.textContent = "The tapestries depict Dracula's past victories. One shows a secret passage behind the throne!";
                        tapestryMsg.style.color = '#00ff00';
                        
                        // Add new control
                        const secretBtn = document.createElement('button');
                        secretBtn.textContent = 'Enter secret passage';
                        secretBtn.onclick = () => {
                            AudioManager.playClick(); // <-- SOUND
                            gameState.progress += 10;
                            startCombat('gargoyle');
                        };
                        setTimeout(() => {
                            controlsDiv.appendChild(secretBtn);
                        }, 500);
                    } else {
                        tapestryMsg.textContent = "The tapestries are faded and hard to understand.";
                    }
                    
                    screenContentElement.appendChild(tapestryMsg);
                    return true;
                    
                case 'searchDiningTable':
                    const tableMsg = document.createElement('div');
                    tableMsg.className = 'message';
                    
                    // Random encounter
                    if (Math.random() < 0.4) {
                        tableMsg.textContent = "As you search the table, rats swarm out from under it!";
                        screenContentElement.appendChild(tableMsg);
                        setTimeout(() => {
                            startCombat('ratSwarm');
                        }, 1500);
                    } else {
                        if (Math.random() > 0.5) {
                            tableMsg.textContent = "You find a silver fork worth 5 gold!";
                            tableMsg.style.color = '#00ff00';
                            gameState.gold += 5;
                            updateDisplay();
                            AudioManager.playReward(); // <-- SOUND
                        } else {
                            tableMsg.textContent = "You find only rotting food and dust.";
                        }
                        screenContentElement.appendChild(tableMsg);
                    }
                    return true;
                    
                case 'exploreCells':
                    const cellMsg = document.createElement('div');
                    cellMsg.className = 'message';
                    
                    // Random encounter
                    if (Math.random() < 0.6) {
                        cellMsg.textContent = "A zombie rises from one of the cells!";
                        screenContentElement.appendChild(cellMsg);
                        setTimeout(() => {
                            startCombat('zombie');
                        }, 1500);
                    } else {
                        if (Math.random() > 0.5) {
                            cellMsg.textContent = "You find a health potion in an empty cell!";
                            cellMsg.style.color = '#00ff00';
                            handleAction('addItem', { item: 'healthPotion' }, screenContent, npc);
                        } else {
                            cellMsg.textContent = "The cells are empty except for bones and chains.";
                        }
                        screenContentElement.appendChild(cellMsg);
                    }
                    return true;
                    
                case 'tortureChamber':
                    const tortureMsg = document.createElement('div');
                    tortureMsg.className = 'message';
                    
                    if (gameState.stats.strength >= 8) {
                        tortureMsg.textContent = "You break the locks on a chest and find 30 gold and a torch!";
                        tortureMsg.style.color = '#00ff00';
                        gameState.gold += 30;
                        handleAction('addItem', { item: 'torch' }, screenContent, npc);
                        updateDisplay();
                        AudioManager.playReward(); // <-- SOUND
                    } else {
                        tortureMsg.textContent = "The torture devices are rusted and broken. You find nothing of value.";
                    }
                    
                    screenContentElement.appendChild(tortureMsg);
                    return true;
                    
                case 'searchLaboratory':
                    const labMsg = document.createElement('div');
                    labMsg.className = 'message';
                    
                    if (gameState.stats.intelligence >= 7) {
                        labMsg.textContent = "You identify and safely collect a strength elixir!";
                        labMsg.style.color = '#00ff00';
                        handleAction('addItem', { item: 'strengthElixir' }, screenContent, npc);
                    } else {
                        labMsg.textContent = "You're not sure what any of these potions do. It's too risky to take any.";
                    }
                    
                    screenContentElement.appendChild(labMsg);
                    return true;
                    
                case 'readNotes':
                    const notesMsg = document.createElement('div');
                    notesMsg.className = 'message';
                    notesMsg.textContent = "The notes describe a potion that can temporarily turn a human into a vampire. There's also mention of a 'Daywalker' serum that allows vampires to walk in sunlight.";
                    screenContentElement.appendChild(notesMsg);
                    return true;
                    
                case 'searchForTeddy':
                    const teddyMsg = document.createElement('div');
                    teddyMsg.className = 'message';
                    
                    if (gameState.stats.luck >= 6) {
                        teddyMsg.textContent = "You find the teddy bear under the broken crib!";
                        teddyMsg.style.color = '#00ff00';
                        handleAction('addItem', { item: 'teddyBear' }, screenContent, npc);
                    } else {
                        teddyMsg.textContent = "You search but can't find the teddy bear.";
                    }
                    
                    screenContentElement.appendChild(teddyMsg);
                    return true;
                    
                case 'rockingChair':
                    const chairMsg = document.createElement('div');
                    chairMsg.className = 'message';
                    
                    if (Math.random() < 0.3) {
                        chairMsg.textContent = "The rocking chair starts moving on its own! A ghost appears!";
                        screenContentElement.appendChild(chairMsg);
                        setTimeout(() => {
                            startCombat('ghost');
                        }, 1500);
                    } else {
                        chairMsg.textContent = "The rocking chair is still. You find 5 gold in the cushion.";
                        gameState.gold += 5;
                        updateDisplay();
                        AudioManager.playReward(); // <-- SOUND
                        screenContentElement.appendChild(chairMsg);
                    }
                    return true;
                    
                case 'searchBedroom1':
                    const bedroom1Msg = document.createElement('div');
                    bedroom1Msg.className = 'message';
                    
                    if (Math.random() < 0.4) {
                        bedroom1Msg.textContent = "A vampire spawn was resting here! It attacks!";
                        screenContentElement.appendChild(bedroom1Msg);
                        setTimeout(() => {
                            startCombat('vampireSpawn');
                        }, 1500);
                    } else {
                        if (Math.random() > 0.5) {
                            bedroom1Msg.textContent = "You find 15 gold in a jewelry box!";
                            bedroom1Msg.style.color = '#00ff00';
                            gameState.gold += 15;
                            updateDisplay();
                            AudioManager.playReward(); // <-- SOUND
                        } else {
                            bedroom1Msg.textContent = "The bedroom contains only dusty furniture.";
                        }
                        screenContentElement.appendChild(bedroom1Msg);
                    }
                    return true;
                    
                case 'searchBedroom2':
                    const bedroom2Msg = document.createElement('div');
                    bedroom2Msg.className = 'message';
                    
                    if (gameState.stats.charisma >= 7) {
                        bedroom2Msg.textContent = "You convince a friendly ghost to show you where it hid 25 gold!";
                        bedroom2Msg.style.color = '#00ff00';
                        gameState.gold += 25;
                        updateDisplay();
                        AudioManager.playReward(); // <-- SOUND
                    } else {
                        bedroom2Msg.textContent = "The room feels haunted. You decide to leave quickly.";
                    }
                    
                    screenContentElement.appendChild(bedroom2Msg);
                    return true;
                    
                case 'searchGraveyard':
                    const graveyardMsg = document.createElement('div');
                    graveyardMsg.className = 'message';
                    
                    // Random encounter
                    if (Math.random() < 0.5) {
                        graveyardMsg.textContent = "Zombies rise from their graves!";
                        screenContentElement.appendChild(graveyardMsg);
                        setTimeout(() => {
                            startCombat('zombie');
                        }, 1500);
                    } else {
                        if (Math.random() > 0.5) {
                            graveyardMsg.textContent = "You find a grave with fresh flowers and 10 gold as an offering.";
                            graveyardMsg.style.color = '#00ff00';
                            gameState.gold += 10;
                            updateDisplay();
                            AudioManager.playReward(); // <-- SOUND
                        } else {
                            graveyardMsg.textContent = "The graveyard is eerily quiet. You find nothing of value.";
                        }
                        screenContentElement.appendChild(graveyardMsg);
                    }
                    return true;
                    
                case 'searchMausoleum':
                    const mausoleumMsg = document.createElement('div');
                    mausoleumMsg.className = 'message';
                    
                    if (Math.random() < 0.7) {
                        mausoleumMsg.textContent = "Skeletons rise from the sarcophagi!";
                        screenContentElement.appendChild(mausoleumMsg);
                        setTimeout(() => {
                            startCombat('skeleton');
                        }, 1500);
                    } else {
                        mausoleumMsg.textContent = "You find a silver necklace worth 30 gold in one of the coffins!";
                        mausoleumMsg.style.color = '#00ff00';
                        gameState.gold += 30;
                        updateDisplay();
                        AudioManager.playReward(); // <-- SOUND
                        screenContentElement.appendChild(mausoleumMsg);
                    }
                    return true;
                    
                case 'readInscriptions':
                    const inscriptionMsg = document.createElement('div');
                    inscriptionMsg.className = 'message';
                    inscriptionMsg.textContent = "The inscriptions tell of Dracula's ancestors. One mentions a 'Curse of the Blood Moon' that strengthens vampires every century.";
                    screenContentElement.appendChild(inscriptionMsg);
                    return true;
                    
                case 'examineClock':
                    const clockMsg = document.createElement('div');
                    clockMsg.className = 'message';
                    
                    if (gameState.stats.intelligence >= 6) {
                        clockMsg.textContent = "You notice the clock is stuck at midnight - the time when Dracula is strongest. You adjust it to dawn, weakening him slightly.";
                        clockMsg.style.color = '#00ff00';
                        gameState.progress += 5;
                        updateProgressBar();
                    } else {
                        clockMsg.textContent = "The clock mechanism is complex and you can't understand how it works.";
                    }
                    
                    screenContentElement.appendChild(clockMsg);
                    return true;
                    
                case 'searchForCoffin':
                    const coffinMsg = document.createElement('div');
                    coffinMsg.className = 'message';
                    
                    if (Math.random() < 0.8) {
                        coffinMsg.textContent = "You find Dracula's coffin! But it's guarded by a vampire!";
                        screenContentElement.appendChild(coffinMsg);
                        setTimeout(() => {
                            startCombat('vampire');
                        }, 1500);
                    } else {
                        coffinMsg.textContent = "The coffin is empty. Dracula must be elsewhere in the castle.";
                        screenContentElement.appendChild(coffinMsg);
                    }
                    return true;
                    
                case 'searchKitchen':
                    const kitchenMsg = document.createElement('div');
                    kitchenMsg.className = 'message';
                    
                    if (gameState.stats.luck >= 5) {
                        kitchenMsg.textContent = "You find some edible dried meat and a health potion in the pantry!";
                        kitchenMsg.style.color = '#00ff00';
                        handleAction('addItem', { item: 'healthPotion' }, screenContent, npc);
                    } else {
                        kitchenMsg.textContent = "All the food has rotted away to nothing.";
                    }
                    
                    screenContentElement.appendChild(kitchenMsg);
                    return true;
                    
                case 'searchPantry':
                    const pantryMsg = document.createElement('div');
                    pantryMsg.className = 'message';
                    
                    if (Math.random() < 0.3) {
                        pantryMsg.textContent = "A rat swarm attacks from the shadows!";
                        screenContentElement.appendChild(pantryMsg);
                        setTimeout(() => {
                            startCombat('ratSwarm');
                        }, 1500);
                    } else {
                        pantryMsg.textContent = "The pantry is empty except for some sacks of moldy flour.";
                        screenContentElement.appendChild(pantryMsg);
                    }
                    return true;
                    
                case 'searchWineCellar':
                    const wineMsg = document.createElement('div');
                    wineMsg.className = 'message';
                    
                    if (gameState.stats.charisma >= 6) {
                        wineMsg.textContent = "You find a bottle of century-old wine worth 50 gold!";
                        wineMsg.style.color = '#00ff00';
                        gameState.gold += 50;
                        updateDisplay();
                        AudioManager.playReward(); // <-- SOUND
                    } else {
                        wineMsg.textContent = "You find some wine, but it has all turned to vinegar.";
                    }
                    
                    screenContentElement.appendChild(wineMsg);
                    return true;
                    
                case 'wineCellarNoise':
                    const noiseMsg = document.createElement('div');
                    noiseMsg.className = 'message';
                    
                    noiseMsg.textContent = "You investigate and find a werewolf feeding on a deer carcass! It turns and attacks!";
                    screenContentElement.appendChild(noiseMsg);
                    setTimeout(() => {
                        startCombat('werewolf');
                    }, 1500);
                    return true;
                    
                // New room actions
                case 'searchArmory':
                    const armoryMsg = document.createElement('div');
                    armoryMsg.className = 'message';
                    
                    if (gameState.stats.strength >= 6) {
                        armoryMsg.textContent = "You find a usable sword and 15 gold!";
                        armoryMsg.style.color = '#00ff00';
                        gameState.gold += 15;
                        // Temporary strength boost for finding a sword
                        gameState.stats.strength += 1;
                        updateDisplay();
                        AudioManager.playReward(); // <-- SOUND
                    } else {
                        armoryMsg.textContent = "The weapons are too heavy for you to wield effectively.";
                    }
                    
                    screenContentElement.appendChild(armoryMsg);
                    return true;
                    
                case 'examineArmor':
                    const armorMsg = document.createElement('div');
                    armorMsg.className = 'message';
                    
                    if (Math.random() < 0.4) {
                        armorMsg.textContent = "The armor suddenly animates and attacks!";
                        screenContentElement.appendChild(armorMsg);
                        setTimeout(() => {
                            startCombat('skeleton');
                        }, 1500);
                    } else {
                        armorMsg.textContent = "The armor is rusted and useless.";
                        screenContentElement.appendChild(armorMsg);
                    }
                    return true;
                    
                case 'searchAltar':
                    const altarMsg = document.createElement('div');
                    altarMsg.className = 'message';
                    
                    if (gameState.stats.luck >= 8) {
                        altarMsg.textContent = "You find a hidden compartment with a blessed silver dagger and 25 gold!";
                        altarMsg.style.color = '#00ff00';
                        gameState.gold += 25;
                        handleAction('addItem', { item: 'silverDagger' }, screenContent, npc);
                        updateDisplay();
                        AudioManager.playReward(); // <-- SOUND
                    } else {
                        altarMsg.textContent = "The altar is empty and covered in dust.";
                    }
                    
                    screenContentElement.appendChild(altarMsg);
                    return true;
                    
                case 'examineStainedGlass':
                    const glassMsg = document.createElement('div');
                    glassMsg.className = 'message';
                    glassMsg.textContent = "The stained glass depicts saints battling demons. One panel shows a saint driving a stake through a vampire's heart.";
                    screenContentElement.appendChild(glassMsg);
                    return true;
                    
                case 'useTelescope':
                    const telescopeMsg = document.createElement('div');
                    telescopeMsg.className = 'message';
                    
                    if (gameState.stats.intelligence >= 7) {
                        telescopeMsg.textContent = "You observe the stars and determine that dawn is approaching. Dracula will be weaker soon!";
                        telescopeMsg.style.color = '#00ff00';
                        gameState.progress += 8;
                        updateProgressBar();
                    } else {
                        telescopeMsg.textContent = "You look through the telescope but don't understand what you're seeing.";
                    }
                    
                    screenContentElement.appendChild(telescopeMsg);
                    return true;
                    
                case 'examineStarCharts':
                    const starMsg = document.createElement('div');
                    starMsg.className = 'message';
                    starMsg.textContent = "The star charts show celestial alignments. One chart is marked 'Blood Moon - Power Peaks'.";
                    screenContentElement.appendChild(starMsg);
                    return true;
                    
                case 'followSecretPassage':
                    const passageMsg = document.createElement('div');
                    passageMsg.className = 'message';
                    
                    if (Math.random() < 0.5) {
                        passageMsg.textContent = "The passage leads to a hidden treasure room!";
                        screenContentElement.appendChild(passageMsg);
                        setTimeout(() => {
                            showScene('treasureVault');
                        }, 1500);
                    } else {
                        passageMsg.textContent = "The passage ends at a dead end. You find 10 gold on the floor.";
                        gameState.gold += 10;
                        updateDisplay();
                        AudioManager.playReward(); // <-- SOUND
                        screenContentElement.appendChild(passageMsg);
                    }
                    return true;
                    
                case 'searchSecretPassage':
                    const secretSearchMsg = document.createElement('div');
                    secretSearchMsg.className = 'message';
                    
                    if (gameState.stats.luck >= 5) {
                        secretSearchMsg.textContent = "You find a health potion hidden in a crevice!";
                        secretSearchMsg.style.color = '#00ff00';
                        handleAction('addItem', { item: 'healthPotion' }, screenContent, npc);
                    } else {
                        secretSearchMsg.textContent = "You search the passage but find nothing.";
                    }
                    
                    screenContentElement.appendChild(secretSearchMsg);
                    return true;
                    
                case 'returnFromSecretPassage':
                    showScene('library');
                    return true;
                    
                case 'takeTreasure':
                    const treasureMsg = document.createElement('div');
                    treasureMsg.className = 'message';
                    
                    if (Math.random() < 0.7) {
                        treasureMsg.textContent = "As you reach for the treasure, a shadow creature attacks!";
                        screenContentElement.appendChild(treasureMsg);
                        setTimeout(() => {
                            startCombat('shadowCreature');
                        }, 1500);
                    } else {
                        const goldFound = Math.floor(Math.random() * 100) + 50;
                        treasureMsg.textContent = `You take ${goldFound} gold from the vault!`;
                        treasureMsg.style.color = '#00ff00';
                        gameState.gold += goldFound;
                        updateDisplay();
                        AudioManager.playReward(); // <-- SOUND
                        screenContentElement.appendChild(treasureMsg);
                    }
                    return true;
                    
                case 'searchTreasureVault':
                    const vaultSearchMsg = document.createElement('div');
                    vaultSearchMsg.className = 'message';
                    
                    if (gameState.stats.intelligence >= 8) {
                        vaultSearchMsg.textContent = "You find a magical amulet that increases your max health by 20!";
                        vaultSearchMsg.style.color = '#00ff00';
                        gameState.stats.maxHealth += 20;
                        gameState.stats.health += 20;
                        updateDisplay();
                        AudioManager.playLevelUp(); // <-- SOUND (level up / permanent boost)
                    } else {
                        vaultSearchMsg.textContent = "You search but only find ordinary gold and jewels.";
                    }
                    
                    screenContentElement.appendChild(vaultSearchMsg);
                    return true;
                    
                case 'finalConfrontation':
                    startCombat('dracula');
                    return true;
                    
                case 'startCombat':
                    if (response.enemy) {
                        startCombat(response.enemy);
                    }
                    return false;
                    
                case 'returnToScene':
                    showScene(gameState.preCombatScene);
                    return false;
                    
                case 'returnToMainHall':
                    showScene('mainHall');
                    return false;
                    
                case 'returnToCourtyard':
                    showScene('courtyard');
                    return false;
                    
                case 'returnToLibrary':
                    showScene('library');
                    return false;
                    
                case 'returnToUpperFloor':
                    showScene('upperFloor');
                    return false;
                    
                case 'returnToLaboratory':
                    showScene('laboratory');
                    return false;
                    
                case 'returnToNursery':
                    showScene('nursery');
                    return false;
                    
                case 'returnToDungeon':
                    showScene('dungeon');
                    return false;
                    
                default:
                    return true;
            }
        }
        
        // Handle stat checks
        function handleStatCheck(statCheck, npc, nextId, screenContent) {
            const { stat, min, success, failure } = statCheck;
            const statValue = gameState.stats[stat];
            
            // Clear controls
            controlsDiv.innerHTML = '';
            
            // Display check result
            const resultText = document.createElement('div');
            resultText.className = 'message';
            
            if (statValue >= min) {
                resultText.textContent = `[SUCCESS] Your ${stat} is sufficient (${statValue}/${min}).`;
                resultText.style.color = '#00ff00';
                
                // Find success dialogue
                if (npc && success) {
                    const successDialogue = npc.dialogues.find(d => d.id === success);
                    if (successDialogue) {
                        setTimeout(() => {
                            displayDialogue(npc, successDialogue, screenContent);
                        }, 1500);
                    }
                }
            } else {
                resultText.textContent = `[FAILURE] Your ${stat} is insufficient (${statValue}/${min}).`;
                resultText.style.color = '#ff3333';
                
                // Find failure dialogue
                if (npc && failure) {
                    const failureDialogue = npc.dialogues.find(d => d.id === failure);
                    if (failureDialogue) {
                        setTimeout(() => {
                            displayDialogue(npc, failureDialogue, screenContent);
                        }, 1500);
                    }
                }
            }
            
            screenContent.appendChild(resultText);
        }
        
        // Start combat with an enemy
        function startCombat(enemyId) {
            const enemy = enemies[enemyId];
            if (!enemy) return;
            
            // Store the current scene before combat
            gameState.preCombatScene = gameState.currentScene;
            
            gameState.combat.active = true;
            gameState.combat.enemy = enemy;
            gameState.combat.enemyHealth = enemy.health;
            gameState.combat.enemyMaxHealth = enemy.health;
            gameState.combat.turn = 'player';
            gameState.combat.log = [`A ${enemy.name} attacks you!`];
            AudioManager.playNotification(); // <-- SOUND (combat start alert)
            
            showScene('combat');
        }
        
        // Display combat screen
        function displayCombatScreen(screenContent) {
            // Clear controls
            controlsDiv.innerHTML = '';
            
            // Create combat screen
            const combatScreen = document.createElement('div');
            combatScreen.className = 'combat-screen';
            
            // Combat header
            const combatHeader = document.createElement('div');
            combatHeader.className = 'screen-header';
            combatHeader.textContent = `COMBAT: ${gameState.combat.enemy.name}`;
            combatScreen.appendChild(combatHeader);
            
            // Enemy description
            const enemyDesc = document.createElement('div');
            enemyDesc.className = 'message enemy-message';
            enemyDesc.textContent = gameState.combat.enemy.description;
            combatScreen.appendChild(enemyDesc);
            
            // Health bars
            const playerHealthBar = createHealthBar('Player Health', gameState.stats.health, gameState.stats.maxHealth, 'player');
            const enemyHealthBar = createHealthBar(`${gameState.combat.enemy.name} Health`, gameState.combat.enemyHealth, gameState.combat.enemyMaxHealth, 'enemy');
            
            combatScreen.appendChild(playerHealthBar);
            combatScreen.appendChild(enemyHealthBar);
            
            // Combat log
            const combatLog = document.createElement('div');
            combatLog.className = 'combat-log';
            gameState.combat.log.forEach(logEntry => {
                const logItem = document.createElement('div');
                logItem.textContent = logEntry;
                combatLog.appendChild(logItem);
            });
            combatLog.scrollTop = combatLog.scrollHeight;
            combatScreen.appendChild(combatLog);
            
            screenContent.appendChild(combatScreen);
            
            // Only show combat actions if it's player's turn and combat is active
            if (gameState.combat.active && gameState.combat.turn === 'player') {
                // Combat actions
                const combatActions = document.createElement('div');
                combatActions.className = 'combat-actions';
                
                const attackBtn = document.createElement('button');
                attackBtn.textContent = 'Attack';
                attackBtn.className = 'combat-action-btn';
                attackBtn.onclick = () => {
                    AudioManager.playClick(); // <-- SOUND
                    playerAttack();
                };
                combatActions.appendChild(attackBtn);
                
                // Check for usable items
                const usableItems = gameState.inventory.filter(item => item.use && typeof item.use === 'function');
                
                if (usableItems.length > 0) {
                    usableItems.forEach(item => {
                        const itemBtn = document.createElement('button');
                        itemBtn.textContent = `Use ${item.name}`;
                        itemBtn.className = 'combat-action-btn';
                        itemBtn.onclick = () => {
                            AudioManager.playClick(); // <-- SOUND
                            useItemInCombat(item);
                        };
                        combatActions.appendChild(itemBtn);
                    });
                }
                
                const fleeBtn = document.createElement('button');
                fleeBtn.textContent = 'Try to Flee';
                fleeBtn.className = 'combat-action-btn';
                fleeBtn.onclick = () => {
                    AudioManager.playClick(); // <-- SOUND
                    tryToFlee();
                };
                combatActions.appendChild(fleeBtn);
                
                controlsDiv.appendChild(combatActions);
            }
        }
        
        // Create a health bar
        function createHealthBar(label, current, max, type) {
            const container = document.createElement('div');
            container.className = `${type}-health`;
            
            const labelSpan = document.createElement('span');
            labelSpan.textContent = `${label}:`;
            
            const valueSpan = document.createElement('span');
            valueSpan.textContent = `${current}/${max}`;
            
            const healthBar = document.createElement('div');
            healthBar.className = 'health-bar';
            
            const healthFill = document.createElement('div');
            healthFill.className = `health-fill ${type}-health-fill`;
            healthFill.style.width = `${(current / max) * 100}%`;
            
            healthBar.appendChild(healthFill);
            
            container.appendChild(labelSpan);
            container.appendChild(valueSpan);
            container.appendChild(healthBar);
            
            return container;
        }
        
        // Player attack action
        function playerAttack() {
            if (!gameState.combat.active || gameState.combat.turn !== 'player') return;
            
            // Calculate damage
            let damage = Math.floor(gameState.stats.strength / 2) + Math.floor(Math.random() * 6) + 1;
            
            // Check for item bonuses
            const hasStake = gameState.inventory.some(item => item.id === 'stake');
            const hasHolyWater = gameState.inventory.some(item => item.id === 'holyWater' || item.id === 'holyWater2');
            const hasEnchantedSword = gameState.inventory.some(item => item.id === 'enchantedSword');
            const hasTorch = gameState.inventory.some(item => item.id === 'torch');
            const hasSilverBullets = gameState.inventory.some(item => item.id === 'silverBullets');
            const hasSilverDagger = gameState.inventory.some(item => item.id === 'silverDagger');
            
            if (hasStake && gameState.combat.enemy.type === 'vampire') {
                damage *= 2;
                gameState.combat.log.push(`Your wooden stake is super effective against vampires!`);
            }
            
            if (hasHolyWater && (gameState.combat.enemy.type === 'vampire' || gameState.combat.enemy.type === 'undead')) {
                damage = Math.floor(damage * 1.5);
                gameState.combat.log.push(`Holy water burns the creature!`);
            }
            
            if (hasEnchantedSword) {
                damage += 3;
                gameState.combat.log.push(`Your enchanted sword glows with power!`);
            }
            
            if (hasTorch && (gameState.combat.enemy.type === 'undead' || gameState.combat.enemy.type === 'beast')) {
                damage += 2;
                gameState.combat.log.push(`The torchlight scares the creature!`);
            }
            
            if (hasSilverBullets && gameState.combat.enemy.type === 'lycanthrope') {
                damage *= 2;
                gameState.combat.log.push(`Silver bullets are deadly to werewolves!`);
            }
            
            if (hasSilverDagger && (gameState.combat.enemy.type === 'vampire' || gameState.combat.enemy.type === 'lycanthrope')) {
                damage += 5;
                gameState.combat.log.push(`Your silver dagger strikes true!`);
            }
            
            // Apply damage
            gameState.combat.enemyHealth -= damage;
            gameState.combat.log.push(`You attack for ${damage} damage!`);
            AudioManager.playCombatHit(); // <-- SOUND (player hits)
            
            // Check if enemy is defeated
            if (gameState.combat.enemyHealth <= 0) {
                gameState.combat.log.push(`You defeated the ${gameState.combat.enemy.name}!`);
                gameState.combat.active = false;
                
                // Gain progress and gold
                gameState.progress += gameState.combat.enemy.xp;
                gameState.gold += gameState.combat.enemy.gold;
                if (gameState.progress > 100) gameState.progress = 100;
                updateProgressBar();
                updateDisplay();
                AudioManager.playVictory(); // <-- SOUND (victory)
                
                // Special drops
                if (gameState.combat.enemy.type === 'vampire' && Math.random() < 0.3) {
                    gameState.combat.log.push(`You collect some vampire dust from the remains.`);
                    handleAction('addItem', { item: 'vampireDust' }, null, null);
                }
                
                // Show victory message
                setTimeout(() => {
                    if (gameState.combat.enemy.name === 'Count Dracula') {
                        gameComplete();
                    } else {
                        // Return to the scene we were in before combat
                        showScene(gameState.preCombatScene);
                    }
                }, 2000);
            } else {
                // Enemy's turn
                gameState.combat.turn = 'enemy';
                setTimeout(enemyAttack, 1000);
            }
            
            // Update display
            showScene('combat');
        }
        
        // Enemy attack action
        function enemyAttack() {
            if (!gameState.combat.active || gameState.combat.turn !== 'enemy') return;
            
            // Calculate damage
            let damage = Math.floor(gameState.combat.enemy.attack / 2) + Math.floor(Math.random() * 4) + 1;
            
            // Check for defensive items
            const hasGarlic = gameState.inventory.some(item => item.id === 'garlicNecklace');
            const hasCross = gameState.inventory.some(item => item.id === 'silverCross');
            
            if (hasGarlic && gameState.combat.enemy.type === 'vampire') {
                damage = Math.floor(damage / 2);
                gameState.combat.log.push(`Your garlic necklace weakens the vampire's attack!`);
            }
            
            if (hasCross && (gameState.combat.enemy.type === 'vampire' || gameState.combat.enemy.type === 'undead' || gameState.combat.enemy.type === 'spirit')) {
                damage -= 2;
                if (damage < 1) damage = 1;
                gameState.combat.log.push(`Your silver cross repels some of the attack!`);
            }
            
            // Apply damage
            gameState.stats.health -= damage;
            gameState.combat.log.push(`The ${gameState.combat.enemy.name} attacks for ${damage} damage!`);
            AudioManager.playEnemyHit(); // <-- SOUND (enemy hits player)
            
            // Check if player is defeated
            if (gameState.stats.health <= 0) {
                gameOver();
                return;
            }
            
            // Player's turn next
            gameState.combat.turn = 'player';
            
            // Update display
            updateDisplay();
            showScene('combat');
        }
        
        // Use item in combat
        function useItemInCombat(item) {
            if (!gameState.combat.active || gameState.combat.turn !== 'player') return;
            
            // Check if item has a use function
            if (item.use && typeof item.use === 'function') {
                // Use the item
                const result = item.use();
                gameState.combat.log.push(result);
                AudioManager.playNotification(); // <-- SOUND (item use)
                
                // Remove consumable items from inventory after use
                if (item.type === 'consumable') {
                    const itemIndex = gameState.inventory.findIndex(i => i.id === item.id);
                    if (itemIndex !== -1) {
                        gameState.inventory.splice(itemIndex, 1);
                    }
                }
                
                updateDisplay();
                updateInventoryDisplay();
                
                // Enemy's turn next
                gameState.combat.turn = 'enemy';
                setTimeout(enemyAttack, 1000);
            } else {
                gameState.combat.log.push(`You can't use ${item.name} in combat!`);
            }
            
            showScene('combat');
        }
        
        // Try to flee from combat
        function tryToFlee() {
            if (!gameState.combat.active || gameState.combat.turn !== 'player') return;
            
            // Chance to flee based on luck
            const fleeChance = gameState.stats.luck * 10;
            if (Math.random() * 100 < fleeChance) {
                gameState.combat.log.push(`You successfully flee from combat!`);
                gameState.combat.active = false;
                
                setTimeout(() => {
                    showScene(gameState.preCombatScene);
                }, 1500);
            } else {
                gameState.combat.log.push(`You fail to escape!`);
                
                // Enemy's turn
                gameState.combat.turn = 'enemy';
                setTimeout(enemyAttack, 1000);
            }
            
            showScene('combat');
        }
        
        // Game over function
        function gameOver() {
            gameState.gameOver = true;
            
            gameScreen.innerHTML = '';
            controlsDiv.innerHTML = '';
            
            const gameOverMsg = document.createElement('div');
            gameOverMsg.className = 'game-over';
            gameOverMsg.innerHTML = `
                <h2>GAME OVER</h2>
                <p>You have fallen to the darkness of Dracula's castle.</p>
                <p>Your progress: ${gameState.progress}%</p>
                <p>Gold collected: ${gameState.gold}</p>
                <p>Rooms discovered: ${gameState.discoveredRooms.length}</p>
            `;
            
            const restartButton = document.createElement('button');
            restartButton.textContent = 'TRY AGAIN';
            restartButton.className = 'primary';
            restartButton.onclick = () => {
                AudioManager.playClick(); // <-- SOUND
                // Reset game state
                Object.assign(gameState, {
                    stats: {
                        strength: 5,
                        intelligence: 5,
                        charisma: 5,
                        luck: 5,
                        health: 100,
                        maxHealth: 100
                    },
                    statPoints: 10,
                    inventory: [],
                    currentScene: 'characterCreation',
                    progress: 0,
                    selectedItem: null,
                    gameOver: false,
                    combat: {
                        active: false,
                        enemy: null,
                        enemyHealth: 0,
                        enemyMaxHealth: 0,
                        turn: 'player',
                        log: []
                    },
                    npcMemory: {},
                    currentNPC: null,
                    gold: 50,
                    discoveredRooms: ['castleEntrance'],
                    merchantPresent: false,
                    merchantCooldown: 0
                });
                
                initGame();
            };
            AudioManager.playGameOver(); // <-- SOUND (game over)
            
            gameScreen.appendChild(gameOverMsg);
            controlsDiv.appendChild(restartButton);
        }
        
        // Game completion function
        function gameComplete() {
            gameScreen.innerHTML = '';
            controlsDiv.innerHTML = '';
            
            const victoryMsg = document.createElement('div');
            victoryMsg.className = 'game-over';
            victoryMsg.style.color = '#00ff00';
            victoryMsg.innerHTML = `
                <h2>VICTORY!</h2>
                <p>You have defeated Count Dracula and saved the land from his curse!</p>
                <p>The castle begins to crumble as sunlight pours through the windows.</p>
                <p>Final progress: ${gameState.progress}%</p>
                <p>Final health: ${gameState.stats.health}/${gameState.stats.maxHealth}</p>
                <p>Gold collected: ${gameState.gold}</p>
                <p>Rooms discovered: ${gameState.discoveredRooms.length}/20</p>
                <p>Congratulations, vampire hunter!</p>
            `;
            
            const restartButton = document.createElement('button');
            restartButton.textContent = 'PLAY AGAIN';
            restartButton.className = 'primary';
            restartButton.onclick = () => {
                AudioManager.playClick(); // <-- SOUND
                // Reset game state
                Object.assign(gameState, {
                    stats: {
                        strength: 5,
                        intelligence: 5,
                        charisma: 5,
                        luck: 5,
                        health: 100,
                        maxHealth: 100
                    },
                    statPoints: 10,
                    inventory: [],
                    currentScene: 'characterCreation',
                    progress: 0,
                    selectedItem: null,
                    gameOver: false,
                    combat: {
                        active: false,
                        enemy: null,
                        enemyHealth: 0,
                        enemyMaxHealth: 0,
                        turn: 'player',
                        log: []
                    },
                    npcMemory: {},
                    currentNPC: null,
                    gold: 50,
                    discoveredRooms: ['castleEntrance'],
                    merchantPresent: false,
                    merchantCooldown: 0
                });
                
                initGame();
            };
            AudioManager.playGameComplete(); // <-- SOUND (game complete)
            
            gameScreen.appendChild(victoryMsg);
            controlsDiv.appendChild(restartButton);
        }
        
        // Initialize the game when page loads
        window.onload = initGame;
    </script>
</body>
</html>
