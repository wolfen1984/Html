<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASTLE OF THE UNDEAD - Level 6: The Graveyard</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Gothic Purple/Black/White theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(60, 0, 80, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(60, 0, 80, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #8040a0;
            background-color: #000;
            box-shadow: 0 0 20px rgba(128, 64, 160, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(60, 0, 80, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #8040a0;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #c080ff;
            text-shadow: 0 0 5px #a040ff;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #8040a0;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #500;
            color: #ff0;
            border-color: #ff0;
        }
        
        .level-number.current {
            background-color: #8040a0;
            color: #fff;
            border-color: #c080ff;
            box-shadow: 0 0 8px #a040ff;
            text-shadow: 0 0 2px #000;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #c080ff;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #c080ff;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #8040a0;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #c080ff;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #c080ff;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #8040a0;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8040a0;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #c080ff;
            border-color: #c080ff;
            box-shadow: 0 0 10px rgba(128, 64, 255, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #8040a0;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #c080ff;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8040a0;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #c080ff;
            border-color: #c080ff;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #221133;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #c080ff;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #332244;
            border: 1px solid #c080ff;
            padding: 10px;
            margin: 10px 0;
            color: #c080ff;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #6ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        .ghost {
            color: #aaf;
            font-weight: bold;
            text-shadow: 0 0 3px #aaf;
        }
        
        .wolf {
            color: #aaa;
            font-weight: bold;
            text-shadow: 0 0 3px #aaa;
        }
        
        .zombie {
            color: #8f8;
            font-weight: bold;
            text-shadow: 0 0 3px #8f8;
        }
        
        .gravekeeper {
            color: #9cf;
            font-weight: bold;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8040a0;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #8040a0;
            color: #fff;
            border-color: #c080ff;
            box-shadow: 0 0 15px #a040ff;
        }
        
        /* Gravestone Selection */
        .gravestone-selection {
            background-color: #221133;
            border: 1px solid #8040a0;
            padding: 15px;
            margin: 15px 0;
        }
        
        .gravestone-option {
            background-color: #332244;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .gravestone-option:hover {
            background-color: #443355;
            border-color: #c080ff;
        }
        
        /* Coffin Opening Animation */
        .coffin-opening {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #221133;
            border: 1px solid #8040a0;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { border-color: #8040a0; }
            50% { border-color: #f66; }
            100% { border-color: #8040a0; }
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #8040a0;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #8040a0;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #c080ff;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CASTLE OF THE UNDEAD</h1>
            <h2>LEVEL 6: THE GRAVEYARD</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number completed">2</div>
            <div class="level-number completed">3</div>
            <div class="level-number completed">4</div>
            <div class="level-number completed">5</div>
            <div class="level-number current">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Level Intro Screen -->
        <div id="screen-intro" class="screen active-screen">
            <h2>THE GRAVEYARD</h2>
            <div class="story-text">
                <p>The heavy wooden door creaks open, and you emerge into the Castle Vorlak graveyard. A full moon hangs low in the sky, casting silvery light through thick fog that clings to the ground.</p>
                <p>Ancient tombstones stand crooked in the earth, their inscriptions worn away by centuries of wind and rain. Stone angels and gargoyles watch over the graves with empty eyes. In the distance, a wolf howls mournfully.</p>
                <p>The air is cold and still, smelling of damp earth and decay. To the east, you see a caretaker's shed and horse stables. To the west, older graves with elaborate mausoleums. In the center stands a large stone crypt - your destination.</p>
                <p>This is where Valerius draws his power from the dead. But first, you must navigate the graveyard's dangers and find the entrance to the main crypt.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="intro-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="intro-stat-health" class="stat-value">0</span>/<span id="intro-stat-maxhealth" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="intro-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="intro-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="startLevel6()">ENTER THE GRAVEYARD</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>CASTLE VORLAK GRAVEYARD</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Gravestone Selection Screen -->
        <div id="screen-gravestones" class="screen">
            <h2>ANCIENT GRAVESTONES</h2>
            <div class="story-text">
                <p>You examine the row of ancient gravestones. The inscriptions are faded, but you can make out some names and dates. Some graves look disturbed, with fresh earth piled beside them.</p>
                <p>Which gravestone do you examine more closely?</p>
                
                <div class="gravestone-selection">
                    <div class="gravestone-option" onclick="selectGravestone('general')">
                        <strong>General Alistair Von Helden</strong><br>
                        <small>"He fought the darkness, but darkness won." (1672-1701)</small>
                    </div>
                    <div class="gravestone-option" onclick="selectGravestone('priest')">
                        <strong>Father Michael Donovan</strong><br>
                        <small>"May God have mercy on his soul." (1645-1699)</small>
                    </div>
                    <div class="gravestone-option" onclick="selectGravestone('maiden')">
                        <strong>Lady Eleanor of House Valerius</strong><br>
                        <small>"Beloved bride, taken too soon." (1660-1685)</small>
                    </div>
                    <div class="gravestone-option" onclick="selectGravestone('unknown')">
                        <strong>Unknown Soldier</strong><br>
                        <small>"No name, no fame, only rest." (Date illegible)</small>
                    </div>
                    <div class="gravestone-option" onclick="selectGravestone('witch')">
                        <strong>Agatha the Wise</strong><br>
                        <small>"She knew too much." (1620-1690)</small>
                    </div>
                </div>
                
                <div id="gravestone-feedback" style="margin-top: 15px; padding: 10px; background-color: #221133; border: 1px solid #8040a0; display: none;">
                    <p id="gravestone-feedback-text"></p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="cancelGravestoneSelection()">RETURN TO GRAVEYARD</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL 6 COMPLETE!</h2>
            <div class="story-text">
                <p>You have navigated the haunted graveyard and found the entrance to the main crypt!</p>
                <p>The massive stone doors of the crypt stand before you, carved with images of vampires feasting. The air here is colder than the rest of the graveyard, and you can feel powerful dark magic emanating from within.</p>
                <p>This is the final resting place of the Vorlak vampire line. Valerius himself likely rests within, drawing power from his ancestors. The true heart of darkness awaits.</p>
                <p>All your stats, gold, and inventory will carry over to Level 7.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #221133; border: 1px solid #8040a0;">
                    <h3 style="color: #c080ff; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">ENTER THE CRYPT - LEVEL 7</button>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE UNDEAD - A Retro Vampire Hunt Adventure<br>
            Level 6: The Graveyard
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'wolf':
                    playBeep(300, 0.3, 'sawtooth');
                    setTimeout(() => playBeep(200, 0.4, 'sawtooth'), 300);
                    break;
                case 'howl':
                    playBeep(150, 1.0, 'sine');
                    break;
                case 'zombie':
                    playBeep(80, 0.5, 'square');
                    setTimeout(() => playBeep(60, 0.5, 'square'), 500);
                    break;
                case 'ghost':
                    playBeep(400, 0.3, 'sine');
                    setTimeout(() => playBeep(300, 0.5, 'sine'), 300);
                    break;
                case 'coffin':
                    playBeep(100, 0.5, 'sine');
                    setTimeout(() => playBeep(150, 0.3, 'sine'), 500);
                    break;
                case 'gravedigger':
                    playBeep(600, 0.2, 'triangle');
                    setTimeout(() => playBeep(500, 0.2, 'triangle'), 200);
                    break;
                case 'fog':
                    playBeep(200, 0.8, 'sine');
                    break;
                case 'moon':
                    playBeep(800, 0.1, 'sine');
                    setTimeout(() => playBeep(600, 0.2, 'sine'), 100);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - loaded from Level 5
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Rusty Sword',
            equippedArmor: 'Leather Armor',
            currentSection: 1,
            gameComplete: false,
            level: 6,
            // Level 6 specific flags
            metGravedigger: false,
            wolfhoundsDefeated: false,
            foundShovel: false,
            exploredShed: false,
            exploredStables: false,
            undeadServantDefeated: false,
            openedCoffin: false,
            crawlingCorpseDefeated: false,
            metGhostBride: false,
            foundCryptKey: false,
            examinedGravestones: false,
            foundHolySymbol: false,
            // Combat tracking
            wolfhoundCount: 3, // Start with 3 wolfhounds
            // Special items
            hasWolfsbane: false,
            hasHolyWater: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            isPack: false, // For wolfhounds
            packCount: 0
        };
        
        // Random event tracking
        let randomEvents = {
            ghostBrideAppeared: false,
            wolfHowlCount: 0,
            fogShift: false
        };
        
        // Gravestone examination results
        const gravestoneResults = {
            'general': {
                text: "The grave of General Alistair Von Helden. The inscription reads: 'He fought the darkness, but darkness won. May he find peace in death that eluded him in life.' The grave has been disturbed recently.",
                item: 'Rusted Military Medal',
                gold: 15
            },
            'priest': {
                text: "Father Michael Donovan's grave. The stone cross atop it is broken. The inscription: 'May God have mercy on his soul, for the vampires showed none.' You notice something glinting in the dirt.",
                item: 'Broken Silver Cross',
                gold: 10
            },
            'maiden': {
                text: "Lady Eleanor's grave is adorned with wilted flowers. 'Beloved bride, taken too soon. Her beauty eternal in memory.' As you read, you feel a cold presence nearby.",
                item: 'Withered Rose',
                gold: 5
            },
            'unknown': {
                text: "The unknown soldier's grave is the most disturbed. Fresh earth suggests recent activity. The marker is simple and unadorned.",
                item: 'Ancient Coin',
                gold: 20
            },
            'witch': {
                text: "Agatha the Wise's grave has strange symbols carved around the edges. 'She knew too much, and for that knowledge, she paid the ultimate price.' The ground here feels charged with energy.",
                item: 'Strange Herb Bundle',
                gold: 12
            }
        };
        
        // Game story sections for Level 6
        const storySections = {
            1: {
                text: "You stand in the Castle Vorlak graveyard under a full moon. Thick fog swirls around ancient tombstones, and stone statues watch with empty eyes. From the distant woods comes another mournful wolf howl. The air is cold and heavy with the scent of damp earth.",
                choices: [
                    {text: "Head toward the caretaker's shed", nextSection: 2, skillCheck: false},
                    {text: "Explore the older graves to the west", nextSection: 3, skillCheck: false},
                    {text: "Approach the central crypt", nextSection: 4, skillCheck: false},
                    {text: "Investigate the horse stables", nextSection: 5, skillCheck: false}
                ],
                action: function() {
                    // Random wolf howl
                    if (Math.random() > 0.7) {
                        randomEvents.wolfHowlCount++;
                        playSound('howl');
                        return "<br><span class='wolf'>A distant wolf howls, the sound echoing through the fog.</span>";
                    }
                    return "";
                }
            },
            2: {
                text: "You approach a small wooden shed with a slanted roof. The door hangs slightly open, creaking in the night breeze. Tools are scattered outside - a wheelbarrow, a rake, and what looks like a freshly dug grave nearby.",
                choices: [
                    {text: "Enter the shed", nextSection: 6, skillCheck: false},
                    {text: "Examine the tools", nextSection: 7, skillCheck: false},
                    {text: "Check the freshly dug grave", nextSection: 8, skillCheck: false},
                    {text: "Return to the main graveyard", nextSection: 1, skillCheck: false}
                ]
            },
            3: {
                text: "The western section contains the oldest graves. Elaborate mausoleums stand beside simple headstones, all weathered by time. The fog is thicker here, and the air feels colder. You notice movement between the graves.",
                choices: [
                    {text: "Examine the mausoleums", nextSection: 9, skillCheck: false},
                    {text: "Read the ancient headstones", nextSection: 10, skillCheck: false},
                    {text: "Investigate the movement", nextSection: 11, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Return to the main graveyard", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('fog');
                    return "The fog shifts around you, making shapes that almost look like figures moving between the graves.";
                }
            },
            4: {
                text: "The central crypt is an imposing stone structure with heavy doors carved with vampire imagery. Two stone gargoyles flank the entrance, their eyes seeming to follow you. The doors are locked with a massive iron lock.",
                choices: [
                    {text: "Examine the crypt doors", nextSection: 12, skillCheck: false},
                    {text: "Look for another entrance", nextSection: 13, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Inspect the gargoyles", nextSection: 14, skillCheck: false},
                    {text: "Return to the main graveyard", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    // Check if player has crypt key from previous level
                    if (gameState.inventory.includes('Crypt Guardian Key')) {
                        return "<br>You have the <span class='item'>Crypt Guardian Key</span> from Vladis. It might open these doors.";
                    }
                    return "";
                }
            },
            5: {
                text: "The horse stables are dilapidated, with several stalls and a hayloft above. The smell of old hay and decay hangs in the air. You hear shuffling sounds from within.",
                choices: [
                    {text: "Enter the stables", nextSection: 15, skillCheck: false},
                    {text: "Peek through a window", nextSection: 16, skillCheck: false},
                    {text: "Check the tack room", nextSection: 17, skillCheck: false},
                    {text: "Return to the main graveyard", nextSection: 1, skillCheck: false}
                ]
            },
            6: {
                text: "The shed interior is cramped and filled with gardening tools, sacks of lime, and other grave-digging supplies. A small workbench holds various implements. In the corner, an old man sits whittling a piece of wood.",
                choices: [
                    {text: "Greet the old man", nextSection: 18, skillCheck: false},
                    {text: "Search the workbench", nextSection: 19, skillCheck: false},
                    {text: "Examine the tools", nextSection: 20, skillCheck: false},
                    {text: "Leave quietly", nextSection: 2, skillCheck: false}
                ]
            },
            7: {
                text: "The tools are well-used but cared for. The shovel is sharp and clean, the wheelbarrow recently used. You notice something glinting in the dirt near the rake.",
                choices: [
                    {text: "Pick up the shiny object", nextSection: 21, skillCheck: false},
                    {text: "Take the shovel", nextSection: 22, skillCheck: false},
                    {text: "Return to the shed door", nextSection: 2, skillCheck: false}
                ]
            },
            8: {
                text: "The freshly dug grave is about six feet deep, but empty. The earth is damp and dark. At the bottom, you see something metallic reflecting the moonlight.",
                choices: [
                    {text: "Climb down into the grave", nextSection: 23, skillCheck: true, checkType: 'agility', difficulty: 12},
                    {text: "Try to reach the object with the shovel", nextSection: 24, skillCheck: false},
                    {text: "Leave it alone", nextSection: 2, skillCheck: false}
                ]
            },
            9: {
                text: "The mausoleums are family tombs of the Vorlak lineage. The largest bears the name 'Valerius' in ancient script. The door is sealed, but one mausoleum has a broken lock.",
                choices: [
                    {text: "Enter the broken mausoleum", nextSection: 25, skillCheck: false},
                    {text: "Examine the Valerius tomb", nextSection: 26, skillCheck: false},
                    {text: "Check for hidden passages", nextSection: 27, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Return to the older graves", nextSection: 3, skillCheck: false}
                ]
            },
            10: {
    text: "You examine a row of ancient headstones. The inscriptions tell tragic stories - villagers, soldiers, even children, all victims of the vampires. You've finished examining them for now.",
    choices: [
        {text: "Explore the mausoleums", nextSection: 9, skillCheck: false},
        {text: "Return to the main graveyard", nextSection: 3, skillCheck: false}
    ],
    action: function() {
        gameState.examinedGravestones = true;
        return "";
    }
},
            11: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You move silently through the fog. The movement was just mist swirling around a statue. But you do find something useful - a small silver charm on the ground.";
                    } else {
                        // Encounter wolfhounds!
                        combatState.active = true;
                        combatState.enemyName = "Black Wolfhounds";
                        combatState.enemyHealth = 60;
                        combatState.enemyCurrentHealth = 60;
                        combatState.enemyStrength = 13;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 29;
                        combatState.round = 1;
                        combatState.isPack = true;
                        combatState.packCount = gameState.wolfhoundCount;
                        
                        playSound('wolf');
                        return "You're not stealthy enough! Three black wolfhounds emerge from the fog, eyes glowing red, fangs bared!<br><br><span class='wolf'>Black Wolfhounds (3)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            12: {
                text: "The crypt doors are massive slabs of stone reinforced with iron. The lock is intricate and requires a specific key. There's no handle or visible mechanism to open them from outside.",
                choices: [
                    {text: "Try the crypt key if you have it", nextSection: 30, skillCheck: false, requirement: 'Crypt Guardian Key'},
                    {text: "Try to force the doors", nextSection: 31, skillCheck: true, checkType: 'strength', difficulty: 20},
                    {text: "Look for a hidden mechanism", nextSection: 32, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Return to examining the crypt", nextSection: 4, skillCheck: false}
                ]
            },
            13: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You find a hidden side entrance! It's a small door cleverly disguised as part of the stonework.";
                    } else {
                        playSound('failure');
                        return "You search thoroughly but find no alternative entrance. The crypt is well-sealed.";
                    }
                }
            },
            14: {
                text: "The gargoyles are intricately carved, similar to those at the castle gates but more weathered. Their eyes seem to be made of some dark gemstone. One has a crack running through it.",
                choices: [
                    {text: "Examine the cracked gargoyle", nextSection: 34, skillCheck: false},
                    {text: "Try to remove a gemstone eye", nextSection: 35, skillCheck: true, checkType: 'strength', difficulty: 14},
                    {text: "Return to the doors", nextSection: 4, skillCheck: false}
                ]
            },
            15: {
                text: "Inside the stables, the smell of decay is stronger. Several stalls contain the skeletal remains of horses. In one stall, a figure in tattered servant's clothes shambles toward you!",
                choices: [
                    {text: "Fight the undead servant", nextSection: 36, skillCheck: false},
                    {text: "Retreat from the stables", nextSection: 37, skillCheck: true, checkType: 'agility', difficulty: 12},
                    {text: "Try to reason with it", nextSection: 38, skillCheck: false}
                ],
                action: function() {
                    gameState.exploredStables = true;
                    playSound('zombie');
                    return "An <span class='zombie'>Undead Servant</span> lurches toward you, its mouth working silently as if trying to speak!";
                }
            },
            16: {
                text: "You peek through a grimy window. Inside, you can see skeletal horses and a shambling figure in servant's clothes. It doesn't seem to have noticed you.",
                choices: [
                    {text: "Enter quietly", nextSection: 39, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Enter normally", nextSection: 15, skillCheck: false},
                    {text: "Leave and check the tack room", nextSection: 17, skillCheck: false}
                ]
            },
            17: {
                text: "The tack room is filled with rotting leather saddles, bridles, and other riding gear. A workbench holds tools for horse care. In a corner, you find a half-buried wooden coffin!",
                choices: [
                    {text: "Open the coffin", nextSection: 40, skillCheck: false},
                    {text: "Search the workbench", nextSection: 41, skillCheck: false},
                    {text: "Leave the tack room", nextSection: 5, skillCheck: false}
                ]
            },
            18: {
                text: "The old man looks up from his whittling. 'You shouldn't be here,' he says in a gravelly voice. 'The graveyard ain't safe after dark. Things walk here that shouldn't.'",
                choices: [
                    {text: "Ask about the graveyard", nextSection: 42, skillCheck: false},
                    {text: "Ask about the crypt", nextSection: 43, skillCheck: false},
                    {text: "Ask about the creatures he mentioned", nextSection: 44, skillCheck: false},
                    {text: "Thank him and leave", nextSection: 6, skillCheck: false}
                ],
                action: function() {
                    gameState.metGravedigger = true;
                    playSound('gravedigger');
                    return "";
                }
            },
            19: {
                text: "The workbench holds various tools - a trowel, pruning shears, a small saw. There's also a ledger book with records of burials. The most recent entry is troubling.",
                choices: [
                    {text: "Examine the ledger", nextSection: 45, skillCheck: false},
                    {text: "Take useful tools", nextSection: 46, skillCheck: false},
                    {text: "Return to talking to the old man", nextSection: 18, skillCheck: false}
                ]
            },
            20: {
                text: "The tools are typical for grave-digging and maintenance. Several shovels, picks, and a sledgehammer. One shovel has a silver inlay on the handle.",
                choices: [
                    {text: "Examine the silver-handled shovel", nextSection: 47, skillCheck: false},
                    {text: "Take a regular shovel", nextSection: 22, skillCheck: false},
                    {text: "Return to the shed interior", nextSection: 6, skillCheck: false}
                ]
            },
            21: {
                text: "You pick up the shiny object. It's a silver locket, tarnished but still beautiful. It opens to reveal a tiny portrait of a woman.",
                choices: [
                    {text: "Take the locket", nextSection: 48, skillCheck: false},
                    {text: "Leave it", nextSection: 7, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Silver Portrait Locket');
                    playSound('item');
                    return "You find a <span class='item'>Silver Portrait Locket</span>. The woman in the portrait looks familiar.";
                }
            },
            22: {
                text: "You take the shovel. It's a sturdy tool that could be useful for digging or as a weapon.",
                choices: [
                    {text: "Return to examining the tools", nextSection: 7, skillCheck: false}
                ],
                action: function() {
                    gameState.foundShovel = true;
                    addToInventory('Gravedigger Shovel');
                    playSound('item');
                    return "You take the <span class='item'>Gravedigger Shovel</span>. It's heavy but well-balanced.";
                }
            },
            23: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 49, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(3, 10);
                        gameState.gold += goldFound;
                        addToInventory('Burial Ring');
                        updateStatsDisplay();
                        playSound('item');
                        return "You climb down and retrieve a <span class='item'>Burial Ring</span> and <span class='gold'>" + goldFound + " Gold</span>. The ring is inscribed with a name: 'Eleanor'.";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You slip and fall into the grave, taking " + damage + " damage. You scramble out empty-handed.";
                    }
                }
            },
            24: {
                text: "You use the shovel to fish the object out of the grave. It's a metal box.",
                choices: [
                    {text: "Open the box", nextSection: 50, skillCheck: false},
                    {text: "Take the box and leave", nextSection: 51, skillCheck: false}
                ]
            },
            25: {
                text: "Inside the broken mausoleum, you find several stone sarcophagi. One is open and empty. The air is thick with dust and the scent of decay. On a small altar, you find some items.",
                choices: [
                    {text: "Search the sarcophagi", nextSection: 52, skillCheck: false},
                    {text: "Examine the altar", nextSection: 53, skillCheck: false},
                    {text: "Leave the mausoleum", nextSection: 9, skillCheck: false}
                ]
            },
            26: {
                text: "The Valerius tomb is the largest and most elaborate. The door is sealed with a silver lock shaped like a bat. The family crest - a bat over a crescent moon - is carved above the entrance.",
                choices: [
                    {text: "Try to pick the lock", nextSection: 54, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Look for another way in", nextSection: 55, skillCheck: false},
                    {text: "Return to the mausoleums", nextSection: 9, skillCheck: false}
                ]
            },
            27: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 56, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(4, 10);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        playSound('item');
                        return "You find a hidden compartment in a false tombstone containing <span class='gold'>" + goldFound + " Gold</span>!";
                    } else {
                        playSound('failure');
                        return "You search thoroughly but find no hidden passages.";
                    }
                }
            },
            28: {
                text: "With the silver charm in hand, you return to the older graves section.",
                choices: [
                    {text: "Examine the mausoleums", nextSection: 9, skillCheck: false},
                    {text: "Return to main graveyard", nextSection: 3, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Silver Protection Charm');
                    playSound('item');
                    return "You found a <span class='item'>Silver Protection Charm</span>!";
                }
            },
            29: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 57, skillCheck: false}
                ]
            },
            30: {
                text: "You try the crypt guardian key in the lock. It fits perfectly! The massive doors groan open.",
                choices: [
                    {text: "Enter the crypt", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Crypt Guardian Key');
                    gameState.foundCryptKey = true;
                    playSound('success');
                    return "The <span class='item'>Crypt Guardian Key</span> unlocks the crypt doors!";
                }
            },
            31: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 59, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With immense effort, you force the doors open! They groan in protest but yield.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The doors don't budge. You strain yourself, taking " + damage + " damage.";
                    }
                }
            },
            32: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 60, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You find a hidden pressure plate! Stepping on it causes the doors to swing open silently.";
                    } else {
                        playSound('failure');
                        return "You find no hidden mechanisms. The doors seem to require a specific key.";
                    }
                }
            },
            33: {
                text: "You've found a hidden side entrance to the crypt!",
                choices: [
                    {text: "Enter through the side door", nextSection: 61, skillCheck: false},
                    {text: "Return to the main doors", nextSection: 4, skillCheck: false}
                ]
            },
            34: {
                text: "The crack in the gargoyle reveals that it's hollow inside. There's something within - a scroll case.",
                choices: [
                    {text: "Retrieve the scroll case", nextSection: 62, skillCheck: false},
                    {text: "Leave it", nextSection: 14, skillCheck: false}
                ]
            },
            35: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 63, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        addToInventory('Dark Gemstone');
                        playSound('item');
                        return "You pry out a <span class='item'>Dark Gemstone</span> from the gargoyle's eye socket. It feels unnaturally cold.";
                    } else {
                        playSound('failure');
                        return "The gemstone won't budge. It's set firmly in place.";
                    }
                }
            },
            36: {
                text: "The undead servant attacks with surprising speed for something so decayed!",
                choices: [
                    {text: "Fight the undead servant", nextSection: 64, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Undead Servant";
                    combatState.enemyHealth = 45;
                    combatState.enemyCurrentHealth = 45;
                    combatState.enemyStrength = 11;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 65;
                    combatState.round = 1;
                    combatState.isPack = false;
                    
                    playSound('zombie');
                    return "<span class='zombie'>Undead Servant</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            37: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 66, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You retreat quickly before the undead servant can reach you.";
                    } else {
                        const damage = rollDice(1, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The undead servant grabs you as you retreat, dealing " + damage + " damage!";
                    }
                }
            },
            38: {
                text: "You hold up your hands peacefully. The undead servant pauses, its milky eyes studying you. It makes a gurgling sound, then points toward the tack room before collapsing into dust.",
                choices: [
                    {text: "Investigate the tack room", nextSection: 17, skillCheck: false},
                    {text: "Search the stables", nextSection: 67, skillCheck: false}
                ],
                action: function() {
                    gameState.undeadServantDefeated = true;
                    const goldFound = rollDice(2, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('success');
                    return "The undead servant disintegrates, leaving behind <span class='gold'>" + goldFound + " Gold</span>. It seemed to be pointing you toward the tack room.";
                }
            },
            39: {
                text: "You enter the stables quietly. The undead servant hasn't noticed you. You can search the area without alerting it.",
                choices: [
                    {text: "Search the stalls", nextSection: 68, skillCheck: false},
                    {text: "Check the hayloft", nextSection: 69, skillCheck: true, checkType: 'agility', difficulty: 13},
                    {text: "Attack the servant", nextSection: 36, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "You've entered undetected. The undead servant continues shuffling aimlessly.";
                }
            },
            40: {
                text: "You approach the half-buried wooden coffin. The lid is loose, and something inside scratches against the wood. A foul odor emanates from within.",
                choices: [
                    {text: "Open the coffin", nextSection: 70, skillCheck: false},
                    {text: "Leave it closed", nextSection: 17, skillCheck: false},
                    {text: "Set it on fire if you have a torch", nextSection: 71, skillCheck: false, requirement: 'Torch'}
                ]
            },
            41: {
                text: "The workbench holds rusted farrier tools - hammers, nails, files. In a drawer, you find a small bottle of liquid and some dried herbs.",
                choices: [
                    {text: "Take the items", nextSection: 72, skillCheck: false},
                    {text: "Examine the coffin", nextSection: 40, skillCheck: false}
                ],
                action: function() {
                    gameState.hasHolyWater = true;
                    gameState.hasWolfsbane = true;
                    addToInventory('Holy Water');
                    addToInventory('Wolfsbane Herb');
                    playSound('item');
                    return "You find <span class='item'>Holy Water</span> and <span class='item'>Wolfsbane Herb</span>! Both could be useful against undead creatures.";
                }
            },
            42: {
                text: "'This graveyard's been here longer than the castle,' the gravedigger says. 'The Vorlaks built over an older burial ground. Bad business, disturbing the dead. Now they won't stay buried.'",
                choices: [
                    {text: "Ask about specific dangers", nextSection: 44, skillCheck: false},
                    {text: "Ask about the crypt", nextSection: 43, skillCheck: false},
                    {text: "Thank him for the warning", nextSection: 6, skillCheck: false}
                ]
            },
            43: {
                text: "'The main crypt? That's where the vampire lords are buried. Valerius and his ancestors. They say he goes there to draw power from his dead kin. Nobody goes in there and comes out... at least, not alive.'",
                choices: [
                    {text: "Ask how to get in", nextSection: 73, skillCheck: false},
                    {text: "Ask about other dangers", nextSection: 44, skillCheck: false},
                    {text: "Thank him", nextSection: 6, skillCheck: false}
                ]
            },
            44: {
                text: "'Wolfhounds, black as night with red eyes. The master's pets. They patrol the grounds. Then there's the things that crawl out of graves when the moon's full. And the ghost bride... she wanders, looking for her groom who never came.'",
                choices: [
                    {text: "Ask about the ghost bride", nextSection: 74, skillCheck: false},
                    {text: "Ask about the wolfhounds", nextSection: 75, skillCheck: false},
                    {text: "Thank him for the warning", nextSection: 6, skillCheck: false}
                ]
            },
            45: {
                text: "The ledger records burials going back a century. The most recent entries are troubling: 'Unknown traveler, died of blood loss,' 'Villager girl, missing then found drained,' 'Soldier, attacked by wild animals.' All within the last year.",
                choices: [
                    {text: "Take the ledger", nextSection: 76, skillCheck: false},
                    {text: "Return it to the bench", nextSection: 19, skillCheck: false}
                ]
            },
            46: {
                text: "You take some potentially useful tools from the workbench.",
                choices: [
                    {text: "Return to the old man", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Iron Trowel');
                    addToInventory('Pruning Shears');
                    playSound('item');
                    return "You take an <span class='item'>Iron Trowel</span> and <span class='item'>Pruning Shears</span>.";
                }
            },
            47: {
                text: "The silver-handled shovel is beautifully crafted. The silver inlay forms protective symbols. This is no ordinary grave-digging tool.",
                choices: [
                    {text: "Take the silver-handled shovel", nextSection: 77, skillCheck: false},
                    {text: "Leave it", nextSection: 20, skillCheck: false}
                ],
                action: function() {
                    gameState.foundShovel = true;
                    addToInventory('Silver-handled Shovel');
                    playSound('item');
                    return "You take the <span class='item'>Silver-handled Shovel</span>. It feels like it has protective properties.";
                }
            },
            48: {
                text: "With the locket, you return to examining the tools.",
                choices: [
                    {text: "Take the shovel", nextSection: 22, skillCheck: false},
                    {text: "Return to the shed", nextSection: 2, skillCheck: false}
                ]
            },
            49: {
                text: "After climbing out of the grave, you brush yourself off.",
                choices: [
                    {text: "Return to the shed area", nextSection: 2, skillCheck: false}
                ]
            },
            50: {
                text: "You open the metal box. Inside is a collection of grave goods - coins, a ring, and a small figurine.",
                choices: [
                    {text: "Take the contents", nextSection: 78, skillCheck: false},
                    {text: "Leave them", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    addToInventory('Grave Figurine');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Grave Figurine</span> of a weeping angel.";
                }
            },
            51: {
                text: "You take the metal box without opening it.",
                choices: [
                    {text: "Return to the shed", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Metal Grave Box');
                    playSound('item');
                    return "You take the <span class='item'>Metal Grave Box</span>. It's heavy.";
                }
            },
            52: {
                text: "You search the stone sarcophagi. Most contain only dust and bones. One, however, has been broken open from the inside. Scratch marks cover the interior.",
                choices: [
                    {text: "Search the broken sarcophagus", nextSection: 79, skillCheck: false},
                    {text: "Check the altar", nextSection: 53, skillCheck: false}
                ]
            },
            53: {
                text: "The altar holds ceremonial items - a tarnished silver cup, a ritual dagger, and some dried herbs that might have been offerings.",
                choices: [
                    {text: "Take the items", nextSection: 80, skillCheck: false},
                    {text: "Search the sarcophagi", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Tarnished Silver Cup');
                    addToInventory('Ritual Dagger');
                    playSound('item');
                    return "You take a <span class='item'>Tarnished Silver Cup</span> and a <span class='item'>Ritual Dagger</span>.";
                }
            },
            54: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 81, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully pick the lock! The Valerius tomb door swings open.";
                    } else {
                        playSound('failure');
                        return "The lock is too complex. You can't pick it.";
                    }
                }
            },
            55: {
                text: "You search for another entrance. Behind the tomb, you find a ventilation shaft covered by a rusted grate.",
                choices: [
                    {text: "Try to remove the grate", nextSection: 82, skillCheck: true, checkType: 'strength', difficulty: 14},
                    {text: "Return to the front", nextSection: 26, skillCheck: false}
                ]
            },
            56: {
                text: "After your search, you return to examining the mausoleums.",
                choices: [
                    {text: "Enter the broken mausoleum", nextSection: 25, skillCheck: false},
                    {text: "Examine the Valerius tomb", nextSection: 26, skillCheck: false}
                ]
            },
            57: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 29, skillCheck: false}
                ]
            },
            58: {
                text: "YOU HAVE ENTERED THE MAIN CRYPT! The doors close behind you with a final-sounding thud. You stand in an antechamber, facing another set of doors that presumably lead deeper into the crypt.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 7;
                    saveGame();
                    
                    return "";
                }
            },
            59: {
                text: "After trying to force the doors, you reconsider your approach.",
                choices: [
                    {text: "Try the crypt key if you have it", nextSection: 30, skillCheck: false, requirement: 'Crypt Guardian Key'},
                    {text: "Look for a hidden mechanism", nextSection: 32, skillCheck: false},
                    {text: "Return to examining the crypt", nextSection: 4, skillCheck: false}
                ]
            },
            60: {
                text: "After searching for hidden mechanisms, you try other options.",
                choices: [
                    {text: "Try the crypt key if you have it", nextSection: 30, skillCheck: false, requirement: 'Crypt Guardian Key'},
                    {text: "Try to force the doors", nextSection: 31, skillCheck: false},
                    {text: "Look for another entrance", nextSection: 13, skillCheck: false}
                ]
            },
            61: {
                text: "You enter through the hidden side door. It leads into the crypt's antechamber.",
                choices: [
                    {text: "Proceed deeper into the crypt", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    gameState.foundCryptKey = true;
                    playSound('success');
                    return "You've found an alternative entrance to the crypt!";
                }
            },
            62: {
                text: "You retrieve the scroll case from inside the gargoyle. It contains an ancient map of the crypt's interior.",
                choices: [
                    {text: "Take the map", nextSection: 83, skillCheck: false},
                    {text: "Leave it", nextSection: 34, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Crypt Interior Map');
                    playSound('item');
                    return "You find a <span class='item'>Crypt Interior Map</span>! It shows the layout of the crypt's chambers.";
                }
            },
            63: {
                text: "After trying to remove the gemstone, you return to examining the gargoyles.",
                choices: [
                    {text: "Examine the cracked gargoyle", nextSection: 34, skillCheck: false},
                    {text: "Return to the doors", nextSection: 4, skillCheck: false}
                ]
            },
            64: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 84, skillCheck: false}
                ]
            },
            65: {
                text: "With the undead servant defeated, you can search the stables.",
                choices: [
                    {text: "Search the stalls", nextSection: 68, skillCheck: false},
                    {text: "Check the tack room", nextSection: 17, skillCheck: false}
                ],
                action: function() {
                    gameState.undeadServantDefeated = true;
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> on the servant's remains.";
                }
            },
            66: {
                text: "Having retreated from the stables, you consider your next move.",
                choices: [
                    {text: "Try to enter quietly", nextSection: 39, skillCheck: false},
                    {text: "Check the tack room instead", nextSection: 17, skillCheck: false},
                    {text: "Leave the stables area", nextSection: 5, skillCheck: false}
                ]
            },
            67: {
                text: "You search the stables after the servant's collapse. In one stall, you find a hidden compartment under the hay.",
                choices: [
                    {text: "Open the compartment", nextSection: 85, skillCheck: false},
                    {text: "Check the tack room", nextSection: 17, skillCheck: false}
                ]
            },
            68: {
                text: "You search the horse stalls. Most contain only skeletal remains, but in one you find a saddlebag with some items.",
                choices: [
                    {text: "Take the items", nextSection: 86, skillCheck: false},
                    {text: "Check the hayloft", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(2, 10);
                    gameState.gold += goldFound;
                    addToInventory('Riding Gloves');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a pair of <span class='item'>Riding Gloves</span>.";
                }
            },
            69: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 87, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(3, 10);
                        gameState.gold += goldFound;
                        addToInventory('Hayloft Key');
                        updateStatsDisplay();
                        playSound('item');
                        return "You climb to the hayloft and find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Hayloft Key</span> that might open something.";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You slip and fall from the ladder, taking " + damage + " damage.";
                    }
                }
            },
            70: {
                text: "<div class='coffin-opening'>You pry open the coffin lid...</div>",
                choices: [
                    {text: "Continue", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    gameState.openedCoffin = true;
                    playSound('coffin');
                    return "";
                }
            },
            71: {
                text: "You use your torch to set the coffin on fire. The wood catches quickly, and horrible screams come from within as whatever is inside burns.",
                choices: [
                    {text: "Wait for it to burn", nextSection: 89, skillCheck: false},
                    {text: "Leave immediately", nextSection: 17, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Torch');
                    playSound('success');
                    return "The coffin burns fiercely. The screams soon stop.";
                }
            },
            72: {
                text: "With the holy water and wolfsbane, you consider the coffin.",
                choices: [
                    {text: "Open the coffin", nextSection: 70, skillCheck: false},
                    {text: "Leave the tack room", nextSection: 17, skillCheck: false}
                ]
            },
            73: {
                text: "'Need a special key,' the gravedigger says. 'The crypt guardian has it, they say. Or there's other ways... hidden passages, but they're dangerous. Me, I'd just leave it be.'",
                choices: [
                    {text: "Ask about the crypt guardian", nextSection: 90, skillCheck: false},
                    {text: "Thank him for the information", nextSection: 6, skillCheck: false}
                ]
            },
            74: {
                text: "'Lady Eleanor, she was to marry one of the Vorlaks. Died on her wedding day, they say. Now her ghost wanders, still in her wedding dress. She's not malicious, just... sad. Sometimes she helps lost souls find their way.'",
                choices: [
                    {text: "Ask about the wolfhounds", nextSection: 75, skillCheck: false},
                    {text: "Thank him", nextSection: 6, skillCheck: false}
                ]
            },
            75: {
                text: "'The master's wolfhounds are unnatural beasts. Fast, strong, hunt in packs. Silver hurts them, and wolfsbane repels them. There's some growing near the old chapel ruins.'",
                choices: [
                    {text: "Ask about the ghost bride", nextSection: 74, skillCheck: false},
                    {text: "Thank him", nextSection: 6, skillCheck: false}
                ]
            },
            76: {
                text: "You take the burial ledger. It might contain useful information.",
                choices: [
                    {text: "Return to the old man", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Burial Ledger');
                    playSound('item');
                    return "You take the <span class='item'>Burial Ledger</span>.";
                }
            },
            77: {
                text: "With the silver-handled shovel, you return to the shed interior.",
                choices: [
                    {text: "Greet the old man", nextSection: 18, skillCheck: false},
                    {text: "Leave the shed", nextSection: 2, skillCheck: false}
                ]
            },
            78: {
                text: "With the grave goods, you climb out of the grave.",
                choices: [
                    {text: "Return to the shed", nextSection: 2, skillCheck: false}
                ]
            },
            79: {
                text: "You search the broken sarcophagus. Inside, you find scratch marks and... a journal! It seems to have belonged to a previous adventurer.",
                choices: [
                    {text: "Take and read the journal", nextSection: 91, skillCheck: false},
                    {text: "Leave it", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Adventurer\'s Journal');
                    playSound('item');
                    return "You find an <span class='item'>Adventurer's Journal</span>. It might contain useful information about the crypt.";
                }
            },
            80: {
                text: "With the ceremonial items, you leave the mausoleum.",
                choices: [
                    {text: "Return to the older graves", nextSection: 9, skillCheck: false}
                ]
            },
            81: {
                text: "After your lockpicking attempt, you try other options.",
                choices: [
                    {text: "Look for another way in", nextSection: 55, skillCheck: false},
                    {text: "Return to other mausoleums", nextSection: 9, skillCheck: false}
                ]
            },
            82: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 92, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You wrench the rusted grate free! The ventilation shaft is narrow but passable.";
                    } else {
                        playSound('failure');
                        return "The grate won't budge. It's rusted solid.";
                    }
                }
            },
            83: {
                text: "With the crypt map, you have a better understanding of the crypt's layout.",
                choices: [
                    {text: "Return to the crypt doors", nextSection: 4, skillCheck: false}
                ]
            },
            84: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 64, skillCheck: false}
                ]
            },
            85: {
                text: "You open the hidden compartment. Inside is a small chest.",
                choices: [
                    {text: "Open the chest", nextSection: 93, skillCheck: false},
                    {text: "Take it with you", nextSection: 94, skillCheck: false}
                ]
            },
            86: {
                text: "With the saddlebag items, you continue searching the stables.",
                choices: [
                    {text: "Check the tack room", nextSection: 17, skillCheck: false},
                    {text: "Leave the stables", nextSection: 5, skillCheck: false}
                ]
            },
            87: {
                text: "After your hayloft attempt, you search the rest of the stables.",
                choices: [
                    {text: "Search the stalls", nextSection: 68, skillCheck: false},
                    {text: "Check the tack room", nextSection: 17, skillCheck: false}
                ]
            },
            88: {
                text: "As the coffin lid falls away, a rotting corpse with milky eyes sits up! Its movements are jerky and unnatural as it crawls out of the coffin toward you!",
                choices: [
                    {text: "Fight the crawling corpse", nextSection: 95, skillCheck: false},
                    {text: "Try to slam the lid back shut", nextSection: 96, skillCheck: true, checkType: 'strength', difficulty: 13},
                    {text: "Flee the tack room", nextSection: 97, skillCheck: true, checkType: 'agility', difficulty: 12}
                ],
                action: function() {
                    playSound('zombie');
                    return "A <span class='zombie'>Crawling Corpse</span> emerges from the coffin!";
                }
            },
            89: {
                text: "You wait until the coffin is completely burned. In the ashes, you find some metal items that survived the fire.",
                choices: [
                    {text: "Take the items", nextSection: 98, skillCheck: false},
                    {text: "Leave the tack room", nextSection: 17, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    addToInventory('Fire-blackened Key');
                    updateStatsDisplay();
                    playSound('item');
                    return "In the ashes, you find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Fire-blackened Key</span>.";
                }
            },
            90: {
                text: "'The crypt guardian's an old vampire, Vladis they call him. Sleeps in the crypt above this one. Guards the way to the master's tomb. Tough fight, that one.'",
                choices: [
                    {text: "Thank him", nextSection: 6, skillCheck: false}
                ]
            },
            91: {
                text: "The journal describes the crypt's traps and guardians. The writer didn't survive, but their notes could be invaluable.",
                choices: [
                    {text: "Leave the mausoleum", nextSection: 25, skillCheck: false}
                ]
            },
            92: {
                text: "The ventilation shaft is now accessible. It's dark and narrow, but you can fit through.",
                choices: [
                    {text: "Crawl through the shaft", nextSection: 99, skillCheck: false},
                    {text: "Return to the front", nextSection: 26, skillCheck: false}
                ]
            },
            93: {
                text: "You open the chest. Inside are some valuable items.",
                choices: [
                    {text: "Take the contents", nextSection: 100, skillCheck: false},
                    {text: "Leave them", nextSection: 85, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(6, 10);
                    gameState.gold += goldFound;
                    addToInventory('Stablemaster Signet Ring');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Stablemaster Signet Ring</span>.";
                }
            },
            94: {
                text: "You take the small chest without opening it.",
                choices: [
                    {text: "Leave the stables", nextSection: 5, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Small Locked Chest');
                    playSound('item');
                    return "You take the <span class='item'>Small Locked Chest</span>.";
                }
            },
            95: {
                text: "The crawling corpse attacks with surprising speed for something so decayed!",
                choices: [
                    {text: "Fight the crawling corpse", nextSection: 101, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Crawling Corpse";
                    combatState.enemyHealth = 55;
                    combatState.enemyCurrentHealth = 55;
                    combatState.enemyStrength = 12;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 102;
                    combatState.round = 1;
                    combatState.isPack = false;
                    
                    playSound('zombie');
                    return "<span class='zombie'>Crawling Corpse</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            96: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 103, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slam the coffin lid shut just as the corpse tries to emerge! You hear scratching from inside, but it's trapped.";
                    } else {
                        // Fight the corpse
                        combatState.active = true;
                        combatState.enemyName = "Crawling Corpse";
                        combatState.enemyHealth = 55;
                        combatState.enemyCurrentHealth = 55;
                        combatState.enemyStrength = 12;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 8;
                        combatState.nextSection = 102;
                        combatState.round = 1;
                        combatState.isPack = false;
                        
                        playSound('zombie');
                        return "The corpse pushes past you!<br><br><span class='zombie'>Crawling Corpse</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            97: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 104, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You flee the tack room just as the corpse emerges. You slam the door behind you.";
                    } else {
                        const damage = rollDice(1, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The corpse grabs your leg as you flee, dealing " + damage + " damage! You manage to escape.";
                    }
                }
            },
            98: {
                text: "With the fire-blackened items, you leave the tack room.",
                choices: [
                    {text: "Return to the stables", nextSection: 17, skillCheck: false}
                ]
            },
            99: {
                text: "You crawl through the narrow ventilation shaft. It's dark and cramped, but eventually you emerge inside the Valerius tomb.",
                choices: [
                    {text: "Explore the tomb", nextSection: 105, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "You've entered the Valerius tomb through the ventilation shaft!";
                }
            },
            100: {
                text: "With the chest contents, you leave the stables.",
                choices: [
                    {text: "Check the tack room", nextSection: 17, skillCheck: false},
                    {text: "Leave the stables", nextSection: 5, skillCheck: false}
                ]
            },
            101: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 106, skillCheck: false}
                ]
            },
            102: {
                text: "With the crawling corpse defeated, you can search the tack room more thoroughly.",
                choices: [
                    {text: "Search the workbench", nextSection: 41, skillCheck: false},
                    {text: "Examine the coffin remains", nextSection: 107, skillCheck: false}
                ],
                action: function() {
                    gameState.crawlingCorpseDefeated = true;
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> in the corpse's ragged clothing.";
                }
            },
            103: {
                text: "With the corpse trapped in the coffin, you can search the tack room safely.",
                choices: [
                    {text: "Search the workbench", nextSection: 41, skillCheck: false},
                    {text: "Leave the tack room", nextSection: 17, skillCheck: false}
                ],
                action: function() {
                    gameState.crawlingCorpseDefeated = true; // Technically not defeated, but neutralized
                    return "The corpse continues to scratch at the coffin lid, but it can't escape.";
                }
            },
            104: {
                text: "Having fled the tack room, you're back in the stables.",
                choices: [
                    {text: "Return to the tack room", nextSection: 17, skillCheck: false},
                    {text: "Leave the stables", nextSection: 5, skillCheck: false}
                ]
            },
            105: {
                text: "Inside the Valerius tomb, you find yourself in an antechamber. A stone door leads deeper into the crypt.",
                choices: [
                    {text: "Proceed through the stone door", nextSection: 58, skillCheck: false}
                ]
            },
            106: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 95, skillCheck: false}
                ]
            },
            107: {
                text: "You examine what's left of the coffin. Besides the corpse's remains, you find something else - a hidden compartment in the coffin bottom!",
                choices: [
                    {text: "Open the compartment", nextSection: 108, skillCheck: false},
                    {text: "Search the workbench", nextSection: 41, skillCheck: false}
                ]
            },
            108: {
                text: "The hidden compartment contains a small velvet pouch.",
                choices: [
                    {text: "Open the pouch", nextSection: 109, skillCheck: false},
                    {text: "Take it and leave", nextSection: 110, skillCheck: false}
                ],
                action: function() {
                    gameState.foundHolySymbol = true;
                    addToInventory('Silver Holy Symbol');
                    playSound('item');
                    return "You find a <span class='item'>Silver Holy Symbol</span>! It glows with faint holy energy.";
                }
            },
            109: {
                text: "You open the pouch to find a silver holy symbol.",
                choices: [
                    {text: "Take it and search the workbench", nextSection: 41, skillCheck: false}
                ],
                action: function() {
                    gameState.foundHolySymbol = true;
                    addToInventory('Silver Holy Symbol');
                    playSound('item');
                    return "You take the <span class='item'>Silver Holy Symbol</span>.";
                }
            },
            110: {
                text: "You take the pouch without opening it.",
                choices: [
                    {text: "Leave the tack room", nextSection: 17, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Velvet Pouch');
                    playSound('item');
                    return "You take the <span class='item'>Velvet Pouch</span>.";
                }
            },
            111: {
                text: "As you move through the graveyard, a ghostly figure materializes before you - a woman in a tattered wedding dress, her face pale and sad. <span class='ghost'>'Have you seen my beloved?'</span> she asks in a whispery voice.",
                choices: [
                    {text: "Ask who she's looking for", nextSection: 112, skillCheck: false},
                    {text: "Ask about the graveyard", nextSection: 113, skillCheck: false},
                    {text: "Attack the ghost", nextSection: 114, skillCheck: false},
                    {text: "Try to comfort her", nextSection: 115, skillCheck: false}
                ],
                action: function() {
                    gameState.metGhostBride = true;
                    randomEvents.ghostBrideAppeared = true;
                    playSound('ghost');
                    return "";
                }
            },
            // Add these missing sections
112: {
    text: "The ghost bride weeps softly. 'My beloved was a knight named Sir Richard. He promised to rescue me from this castle, but he never came. I've been waiting for three hundred years.'",
    choices: [
        {text: "Ask if she can help you", nextSection: 116, skillCheck: false},
        {text: "Ask about the crypt", nextSection: 117, skillCheck: false},
        {text: "Leave her to her sorrow", nextSection: 118, skillCheck: false}
    ]
},
113: {
    text: "The ghost bride looks around the graveyard. 'This place is cursed. The master's power grows with each full moon. The crypt holds his greatest secrets... and his greatest weakness.'",
    choices: [
        {text: "Ask about his weakness", nextSection: 119, skillCheck: false},
        {text: "Ask for help entering the crypt", nextSection: 120, skillCheck: false},
        {text: "Thank her and leave", nextSection: 118, skillCheck: false}
    ]
},
114: {
    text: "You attack the ghost bride, but your weapon passes through her! She looks at you with deep sadness and disappears into the mist.",
    choices: [
        {text: "Continue exploring", nextSection: 1, skillCheck: false}
    ]
},
115: {
    text: "'Your kindness touches me,' the ghost bride says. 'Few have shown me compassion in all these years. Take this, it may help you.' She hands you an old key before fading away.",
    choices: [
        {text: "Take the key and continue", nextSection: 121, skillCheck: false}
    ]
},
116: {
    text: "'I can guide you past the guardian wolfhounds,' she whispers. 'They cannot see me. Follow my light, and they will not see you either.' A soft blue light begins to glow around you.",
    choices: [
        {text: "Follow the ghost's guidance", nextSection: 122, skillCheck: false},
        {text: "Ask about the crypt instead", nextSection: 117, skillCheck: false}
    ]
},
117: {
    text: "'The crypt has two entrances,' the ghost explains. 'The main doors require the guardian's key, but there is a hidden entrance in the Valerius family tomb. I can show you.'",
    choices: [
        {text: "Have her show you the hidden entrance", nextSection: 123, skillCheck: false},
        {text: "Ask for the key instead", nextSection: 124, skillCheck: false}
    ]
},
118: {
    text: "The ghost bride fades away, leaving you alone in the fog. Her sad whispers echo briefly before fading completely.",
    choices: [
        {text: "Continue exploring the graveyard", nextSection: 1, skillCheck: false}
    ]
},
119: {
    text: "'The master fears two things: sunlight and the symbol of his first victim. I was that victim. This locket contains a strand of my hair, blessed by a priest.' She shows you a silver locket.",
    choices: [
        {text: "Ask if you can have the locket", nextSection: 125, skillCheck: false},
        {text: "Ask about the crypt entrance", nextSection: 117, skillCheck: false}
    ]
},
120: {
    text: "'I can show you the way, but you must do something for me. Find my wedding ring in the crypt. It was taken from me when I was buried.'",
    choices: [
        {text: "Agree to find her ring", nextSection: 126, skillCheck: false},
        {text: "Decline and leave", nextSection: 118, skillCheck: false}
    ]
},
121: {
    text: "You receive a Ghost Bride's Key. The ghost fades away, leaving you alone in the mist.",
    choices: [
        {text: "Return to exploring", nextSection: 1, skillCheck: false}
    ],
    action: function() {
        addToInventory("Ghost Bride's Key");
        playSound('item');
        return "You received the <span class='item'>Ghost Bride's Key</span>. It feels cold to the touch.";
    }
},
122: {
    text: "Following the ghost's blue light, you move through the graveyard unseen. The wolfhounds pass by without noticing you. The light leads you directly to the crypt entrance.",
    choices: [
        {text: "Approach the crypt", nextSection: 4, skillCheck: false}
    ]
},
123: {
    text: "The ghost leads you to the Valerius family tomb and shows you the hidden entrance she mentioned earlier.",
    choices: [
        {text: "Enter through the hidden entrance", nextSection: 99, skillCheck: false}
    ]
},
124: {
    text: "'I do not have the key,' she says sadly. 'The crypt guardian keeps it. But I can help you avoid his notice.'",
    choices: [
        {text: "Accept her help avoiding the guardian", nextSection: 122, skillCheck: false},
        {text: "Look for the hidden entrance instead", nextSection: 123, skillCheck: false}
    ]
},
125: {
    text: "The ghost bride gives you the locket. 'Use it wisely. It may protect you from the master's gaze.'",
    choices: [
        {text: "Take the locket", nextSection: 127, skillCheck: false}
    ],
    action: function() {
        addToInventory("Ghost Bride's Locket");
        playSound('item');
        return "You receive the <span class='item'>Ghost Bride's Locket</span>. It glows with a faint blue light.";
    }
},
126: {
    text: "'Thank you,' the ghost whispers. 'My ring is in the main crypt, in the master's coffin. Bring it to me, and I will grant you a boon.' She fades away, leaving you with her promise.",
    choices: [
        {text: "Continue your exploration", nextSection: 1, skillCheck: false}
    ],
    action: function() {
        gameState.hasGhostBrideQuest = true;
        return "You've agreed to find the ghost bride's wedding ring in the crypt.";
    }
},
127: {
    text: "With the ghost bride's locket, you feel a sense of protection. The ghost fades away, her task complete.",
    choices: [
        {text: "Continue exploring", nextSection: 1, skillCheck: false}
    ]
},

// Add a few more missing sections referenced in other parts
83: {
    text: "With the crypt map in hand, you have a better understanding of the crypt's layout. The map shows multiple chambers and potential traps.",
    choices: [
        {text: "Return to the crypt doors", nextSection: 4, skillCheck: false}
    ]
},
85: {
    text: "You open the hidden compartment in the horse stall. Inside is a small locked chest.",
    choices: [
        {text: "Try to open the chest", nextSection: 128, skillCheck: false},
        {text: "Take it with you", nextSection: 94, skillCheck: false}
    ]
},
94: {
    text: "You take the small locked chest without opening it.",
    choices: [
        {text: "Leave the stables", nextSection: 5, skillCheck: false}
    ],
    action: function() {
        addToInventory('Small Locked Chest');
        playSound('item');
        return "You take the <span class='item'>Small Locked Chest</span>.";
    }
},
128: {
    text: "The chest is locked with a simple lock. You try to pry it open.",
    choices: [
        {text: "Force it open", nextSection: 129, skillCheck: true, checkType: 'strength', difficulty: 12},
        {text: "Try to pick the lock", nextSection: 130, skillCheck: true, checkType: 'agility', difficulty: 14},
        {text: "Take it unopened", nextSection: 94, skillCheck: false}
    ]
},
129: {
    text: "",
    choices: [
        {text: "Continue", nextSection: 131, skillCheck: false}
    ],
    action: function() {
        if (window.checkResult) {
            const goldFound = rollDice(4, 10);
            gameState.gold += goldFound;
            updateStatsDisplay();
            playSound('item');
            return "You force the chest open! Inside you find <span class='gold'>" + goldFound + " Gold</span>.";
        } else {
            playSound('failure');
            return "The chest won't budge. It's sturdier than it looks.";
        }
    }
},
130: {
    text: "",
    choices: [
        {text: "Continue", nextSection: 132, skillCheck: false}
    ],
    action: function() {
        if (window.checkResult) {
            const goldFound = rollDice(5, 10);
            gameState.gold += goldFound;
            addToInventory('Stable Key');
            updateStatsDisplay();
            playSound('item');
            return "You pick the lock! Inside you find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Stable Key</span>.";
        } else {
            playSound('failure');
            return "The lock is tricky. You can't seem to pick it.";
        }
    }
},
131: {
    text: "After opening the chest, you search the rest of the stables.",
    choices: [
        {text: "Check the tack room", nextSection: 17, skillCheck: false},
        {text: "Leave the stables", nextSection: 5, skillCheck: false}
    ]
},
132: {
    text: "With the chest opened, you continue your search of the stables.",
    choices: [
        {text: "Check the tack room", nextSection: 17, skillCheck: false},
        {text: "Leave the stables", nextSection: 5, skillCheck: false}
    ]
}
        }   
        
        // Initialize game for Level 6
        function initGame() {
            // Load game state from Level 5
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 6 (coming from Level 5)
                if (savedState.level === 6) {
                    Object.assign(gameState, savedState);
                    
                    // Update intro screen with loaded stats
                    document.getElementById('intro-stat-strength').textContent = gameState.strength;
                    document.getElementById('intro-stat-health').textContent = gameState.health;
                    document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('intro-stat-agility').textContent = gameState.agility;
                    document.getElementById('intro-stat-gold').textContent = gameState.gold;
                    
                    showScreen('screen-intro');
                    return;
                } else if (savedState.level === 5) {
                    // If coming directly from Level 5 without completing it
                    alert("You must complete Level 5 first!");
                    window.location.href = 'l5.html';
                    return;
                }
            } else {
                // No saved game found
                alert("No saved game found. Starting from Level 1.");
                window.location.href = 'l1.html';
                return;
            }
        }
        
        function startLevel6() {
            playSound('click');
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item) && item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Gravestone selection functions
        function selectGravestone(graveType) {
            playSound('item');
            const result = gravestoneResults[graveType];
            
            // Add gold if any
            if (result.gold) {
                gameState.gold += result.gold;
                updateStatsDisplay();
            }
            
            // Add item if any
            if (result.item) {
                addToInventory(result.item);
            }
            
            // Show feedback
            document.getElementById('gravestone-feedback-text').innerHTML = result.text + 
                (result.gold ? `<br><br>You find <span class='gold'>${result.gold} Gold</span>` : '') +
                (result.item ? ` and a <span class='item'>${result.item}</span>.` : '.');
            document.getElementById('gravestone-feedback').style.display = 'block';
        }
        
        function cancelGravestoneSelection() {
            playSound('click');
            showScreen('screen-game');
            loadSection(10); // Return to gravestone examination
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Potion' || item === 'Mountain Potion' || item === 'Ancient Vampire Wine') {
                const healAmount = item === 'Mountain Potion' ? rollDice(3, 6) + 10 : 
                                 item === 'Ancient Vampire Wine' ? rollDice(2, 8) + 5 : rollDice(2, 6) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Holy Water') {
                message = "The <span class='item'>Holy Water</span> is blessed and could harm undead or vampire creatures.";
                gameState.hasHolyWater = true;
            } else if (item === 'Wolfsbane Herb') {
                message = "The <span class='item'>Wolfsbane Herb</span> might repel wolf-like creatures, including the black wolfhounds.";
                gameState.hasWolfsbane = true;
            } else if (item === 'Silver Holy Symbol') {
                message = "The <span class='item'>Silver Holy Symbol</span> glows with holy energy. It might repel undead and vampire creatures.";
                gameState.foundHolySymbol = true;
            } else if (item === 'Gravedigger Shovel' || item === 'Silver-handled Shovel') {
                gameState.equippedWeapon = item;
                updateInventoryDisplay();
                message = `You equip the <span class='item'>${item}</span>. It's heavy but could be an effective weapon.`;
            } else if (item === 'Ancient Burial Shroud') {
                gameState.equippedArmor = 'Ancient Burial Shroud';
                updateInventoryDisplay();
                message = "You wear the <span class='item'>Ancient Burial Shroud</span>. It offers protection and might help you blend with the undead.";
            } else if (item === 'Silver Protection Charm') {
                message = "The <span class='item'>Silver Protection Charm</span> feels warm. It might offer some protection against evil creatures.";
            } else if (item === 'Crypt Interior Map') {
                message = "The <span class='item'>Crypt Interior Map</span> shows the layout of the crypt's chambers, including the main tomb and side passages.";
            } else if (item === 'Adventurer\'s Journal') {
                message = "The <span class='item'>Adventurer's Journal</span> describes traps and guardians in the crypt. The writer didn't survive their exploration.";
            } else if (item === 'Burial Ledger') {
                message = "The <span class='item'>Burial Ledger</span> records recent suspicious deaths and burials in the graveyard.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Sword' && 
                gameState.equippedArmor === 'Leather Armor') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check for random ghost bride appearance (10% chance when moving in graveyard)
            if (!randomEvents.ghostBrideAppeared && !gameState.metGhostBride && 
                Math.random() < 0.1 && sectionId === 1) {
                // Insert ghost bride encounter
                showScreen('screen-game');
                loadSection(111);
                return;
            }
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 29 || sectionId === 57 || sectionId === 64 || 
                                   sectionId === 84 || sectionId === 95 || sectionId === 101 || 
                                   sectionId === 106);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    let goldReward = 0;
                    
                    if (combatState.enemyName.includes("Wolfhounds")) {
                        goldReward = Math.floor(Math.random() * 40) + 20;
                        gameState.wolfhoundsDefeated = true;
                        gameState.wolfhoundCount = 0;
                    } else if (combatState.enemyName.includes("Undead Servant")) {
                        goldReward = Math.floor(Math.random() * 30) + 15;
                        gameState.undeadServantDefeated = true;
                    } else if (combatState.enemyName.includes("Crawling Corpse")) {
                        goldReward = Math.floor(Math.random() * 35) + 18;
                        gameState.crawlingCorpseDefeated = true;
                    }
                    
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    
                    if (goldReward > 0) {
                        storyText += `<br>You find <span class="gold">${goldReward} Gold</span> on the remains.`;
                    }
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    if (typeof choice.requirement === 'function') {
                        return choice.requirement();
                    }
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue exploring the graveyard";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                let weaponType = gameState.equippedWeapon;
                
                // Special weapon bonuses
                if (weaponType.includes('Silver')) {
                    // Silver weapons deal extra damage to undead/wolf-like creatures
                    damage = rollDice(2, 6) + 3;
                    if (combatState.enemyName.includes('Wolfhound') || combatState.enemyName.includes('undead') || combatState.enemyName.includes('Corpse')) {
                        damage += 4; // Extra vs undead/wolf-like
                        resultText += `<span class="item">Your silver weapon is especially effective!</span><br>`;
                    }
                } else if (weaponType === 'Glowing Crystal Sword') {
                    damage = rollDice(3, 6); // Powerful weapon
                    resultText += `<span class="item">The glowing sword pulses with power!</span><br>`;
                } else if (weaponType === 'Ice Axe') {
                    damage = rollDice(2, 6) + 2;
                } else if (weaponType === 'Ancient Bone Dagger') {
                    damage = rollDice(2, 6) + 1;
                } else if (weaponType.includes('Shovel')) {
                    damage = rollDice(2, 6); // Shovel as weapon
                } else {
                    damage = rollDice(2, 6);
                }
                
                // Item bonuses
                if (gameState.hasHolyWater && (combatState.enemyName.includes('undead') || combatState.enemyName.includes('Corpse'))) {
                    damage += 3;
                    resultText += `<span class="item">Holy water burns the undead creature!</span><br>`;
                }
                
                if (gameState.hasWolfsbane && combatState.enemyName.includes('Wolfhound')) {
                    damage += 3;
                    resultText += `<span class="item">Wolfsbane repels the wolfhound!</span><br>`;
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                let enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                
                // Wolfhounds attack as pack
                if (combatState.isPack && combatState.enemyName.includes('Wolfhound')) {
                    enemyDamage += Math.floor(combatState.packCount * 0.5); // Extra damage for pack
                    if (combatState.packCount > 1) {
                        resultText += `The wolfhounds attack as a pack!<br>`;
                    }
                }
                
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('castleUndeadGameState');
                        window.location.href = 'l1.html';
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You dodge a trap!",
                    "You move silently past a sleeping creature.",
                    "You climb to a high place and get a better view.",
                    "You slip through a narrow passage others would miss."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip and take 3 damage!",
                    "You make noise and alert nearby creatures.",
                    "You get tangled in vines or debris.",
                    "You knock over a gravestone, making a loud noise."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 3;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 6 (this page)
                if (savedState.level === 6) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 6.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 7 with updated level
            gameState.level = 7;
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            // Redirect to level 7 (The Crypt)
            window.location.href = 'l7.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
