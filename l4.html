<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASTLE OF THE UNDEAD - Level 4: Inside the Keep</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Gothic Purple/Black/White theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(60, 0, 80, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(60, 0, 80, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #8040a0;
            background-color: #000;
            box-shadow: 0 0 20px rgba(128, 64, 160, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(60, 0, 80, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #8040a0;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #c080ff;
            text-shadow: 0 0 5px #a040ff;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #8040a0;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #500;
            color: #ff0;
            border-color: #ff0;
        }
        
        .level-number.current {
            background-color: #8040a0;
            color: #fff;
            border-color: #c080ff;
            box-shadow: 0 0 8px #a040ff;
            text-shadow: 0 0 2px #000;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #c080ff;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #c080ff;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #8040a0;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #c080ff;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #c080ff;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #8040a0;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8040a0;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #c080ff;
            border-color: #c080ff;
            box-shadow: 0 0 10px rgba(128, 64, 255, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #8040a0;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #c080ff;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8040a0;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #c080ff;
            border-color: #c080ff;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #221133;
            border: 1px solid #8040a0;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #c080ff;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #332244;
            border: 1px solid #c080ff;
            padding: 10px;
            margin: 10px 0;
            color: #c080ff;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #6ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        .ghost {
            color: #aaf;
            font-weight: bold;
            text-shadow: 0 0 3px #aaf;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #8040a0;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #8040a0;
            color: #fff;
            border-color: #c080ff;
            box-shadow: 0 0 15px #a040ff;
        }
        
        /* Statue Puzzle */
        .statue-puzzle {
            background-color: #221133;
            border: 1px solid #8040a0;
            padding: 15px;
            margin: 15px 0;
        }
        
        .puzzle-title {
            color: #c080ff;
            font-weight: bold;
            margin-bottom: 10px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .puzzle-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .puzzle-option {
            background-color: #332244;
            border: 1px solid #8040a0;
            padding: 10px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .puzzle-option:hover {
            background-color: #443355;
            border-color: #c080ff;
        }
        
        /* Ghost Music Puzzle */
        .music-puzzle {
            background-color: #221133;
            border: 1px solid #8040a0;
            padding: 15px;
            margin: 15px 0;
        }
        
        .music-note {
            font-size: 24px;
            margin: 0 5px;
            cursor: pointer;
            color: #c080ff;
        }
        
        .music-note:hover {
            color: #fff;
            text-shadow: 0 0 5px #c080ff;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #8040a0;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #8040a0;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #c080ff;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CASTLE OF THE UNDEAD</h1>
            <h2>LEVEL 4: INSIDE THE KEEP</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number completed">2</div>
            <div class="level-number completed">3</div>
            <div class="level-number current">4</div>
            <div class="level-number">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Level Intro Screen -->
        <div id="screen-intro" class="screen active-screen">
            <h2>INSIDE THE KEEP</h2>
            <div class="story-text">
                <p>You stand inside the courtyard of Castle Vorlak. The massive gates close behind you with an ominous groan. Green torches cast flickering shadows on the cold stone walls.</p>
                <p>The air is thick with the scent of decay and ancient magic. From somewhere deep within the keep, you can hear faint, mournful music and the distant fluttering of bat wings.</p>
                <p>The main keep looms before you - a dark, foreboding structure with narrow windows that resemble slitted eyes. The second floor is said to contain the vampire lord's personal chambers.</p>
                <p>Between you and the staircase to the second floor lie haunted halls, cursed servants, and deadly traps. The vampire lord knows you're here now.</p>
                <p>Your quest continues deeper into the heart of darkness.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="intro-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="intro-stat-health" class="stat-value">0</span>/<span id="intro-stat-maxhealth" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="intro-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="intro-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="startLevel4()">ENTER THE KEEP</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>CASTLE VORLAK KEEP</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Ghost Music Puzzle Screen -->
        <div id="screen-music-puzzle" class="screen">
            <h2>GHOSTLY MELODY PUZZLE</h2>
            <div class="story-text">
                <p>The ghostly violinist plays a mournful melody. The ghost asks: <span class="ghost">"To pass, you must complete my song. The notes are C, E, G, and B. But which comes last in the melody of my sorrow?"</span></p>
                <p>The ghost plays a sequence of notes. You must determine which note comes next.</p>
                
                <div class="music-puzzle">
                    <div class="puzzle-title">LISTEN TO THE SEQUENCE:</div>
                    <div style="text-align: center; margin: 15px 0;">
                        <span class="music-note" onclick="playNote('C')">♪ C</span>
                        <span class="music-note" onclick="playNote('E')">♪ E</span>
                        <span class="music-note" onclick="playNote('G')">♪ G</span>
                    </div>
                    <div class="puzzle-title">WHICH NOTE COMES NEXT?</div>
                    <div class="puzzle-options">
                        <div class="puzzle-option" onclick="selectMusicNote('C')">C</div>
                        <div class="puzzle-option" onclick="selectMusicNote('E')">E</div>
                        <div class="puzzle-option" onclick="selectMusicNote('G')">G</div>
                        <div class="puzzle-option" onclick="selectMusicNote('B')">B</div>
                    </div>
                </div>
                
                <div id="music-feedback" style="margin-top: 15px; padding: 10px; background-color: #221133; border: 1px solid #8040a0; display: none;">
                    <p>Current selection: <span id="music-selection">None</span></p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="tryMusicPuzzle()" id="try-music-btn">PLAY THE NOTE</button>
                <button class="action-btn" onclick="cancelMusicPuzzle()">CANCEL (RETURN)</button>
            </div>
        </div>
        
        <!-- Statue Alignment Puzzle -->
        <div id="screen-statue-puzzle" class="screen">
            <h2>ANCESTRAL STATUE ALIGNMENT</h2>
            <div class="story-text">
                <p>Four statues of ancient vampire lords stand in the hall, each facing a different direction. An inscription reads: <span class="item">"Align the ancestors as they stood in life: facing their most cherished symbols."</span></p>
                <p>The symbols on the walls are: Sun (West), Moon (East), Bat (North), and Wolf (South).</p>
                
                <div class="statue-puzzle">
                    <div class="puzzle-title">STATUE OF VALERIUS I (First Vampire Lord):</div>
                    <div class="puzzle-options">
                        <div class="puzzle-option" onclick="rotateStatue('valerius', 'north')">FACE NORTH (BAT)</div>
                        <div class="puzzle-option" onclick="rotateStatue('valerius', 'south')">FACE SOUTH (WOLF)</div>
                        <div class="puzzle-option" onclick="rotateStatue('valerius', 'east')">FACE EAST (MOON)</div>
                        <div class="puzzle-option" onclick="rotateStatue('valerius', 'west')">FACE WEST (SUN)</div>
                    </div>
                    
                    <div class="puzzle-title" style="margin-top: 15px;">STATUE OF MORANA (Vampire Queen):</div>
                    <div class="puzzle-options">
                        <div class="puzzle-option" onclick="rotateStatue('morana', 'north')">FACE NORTH (BAT)</div>
                        <div class="puzzle-option" onclick="rotateStatue('morana', 'south')">FACE SOUTH (WOLF)</div>
                        <div class="puzzle-option" onclick="rotateStatue('morana', 'east')">FACE EAST (MOON)</div>
                        <div class="puzzle-option" onclick="rotateStatue('morana', 'west')">FACE WEST (SUN)</div>
                    </div>
                    
                    <div class="puzzle-title" style="margin-top: 15px;">STATUE OF VLADISLAUS (The Cruel):</div>
                    <div class="puzzle-options">
                        <div class="puzzle-option" onclick="rotateStatue('vladislaus', 'north')">FACE NORTH (BAT)</div>
                        <div class="puzzle-option" onclick="rotateStatue('vladislaus', 'south')">FACE SOUTH (WOLF)</div>
                        <div class="puzzle-option" onclick="rotateStatue('vladislaus', 'east')">FACE EAST (MOON)</div>
                        <div class="puzzle-option" onclick="rotateStatue('vladislaus', 'west')">FACE WEST (SUN)</div>
                    </div>
                    
                    <div class="puzzle-title" style="margin-top: 15px;">STATUE OF ELISABETA (The Beautiful):</div>
                    <div class="puzzle-options">
                        <div class="puzzle-option" onclick="rotateStatue('elisabeta', 'north')">FACE NORTH (BAT)</div>
                        <div class="puzzle-option" onclick="rotateStatue('elisabeta', 'south')">FACE SOUTH (WOLF)</div>
                        <div class="puzzle-option" onclick="rotateStatue('elisabeta', 'east')">FACE EAST (MOON)</div>
                        <div class="puzzle-option" onclick="rotateStatue('elisabeta', 'west')">FACE WEST (SUN)</div>
                    </div>
                </div>
                
                <div id="statue-feedback" style="margin-top: 15px; padding: 10px; background-color: #221133; border: 1px solid #8040a0; display: none;">
                    <p>Current alignments:<br>
                    <span id="statue-positions">Valerius I: ?, Morana: ?, Vladislaus: ?, Elisabeta: ?</span></p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="tryStatuePuzzle()" id="try-statue-btn">TRY ALIGNMENT</button>
                <button class="action-btn" onclick="cancelStatuePuzzle()">CANCEL (RETURN)</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL 4 COMPLETE!</h2>
            <div class="story-text">
                <p>You have navigated the treacherous keep and found the staircase to the second floor!</p>
                <p>The staircase spirals upward into darkness. From above, you can hear faint whispers and the sound of dripping water. The air grows colder as you ascend.</p>
                <p>The second floor houses the vampire lord's personal chambers, his library of dark arts, and the ancient crypts where the oldest vampires sleep.</p>
                <p>Valerius himself awaits somewhere in these upper chambers. Your final confrontation draws near.</p>
                <p>All your stats, gold, and inventory will carry over to Level 5.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #221133; border: 1px solid #8040a0;">
                    <h3 style="color: #c080ff; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">ASCEND TO SECOND FLOOR - LEVEL 5</button>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE UNDEAD - A Retro Vampire Hunt Adventure<br>
            Level 4: Inside the Keep
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'music':
                    playBeep(523, 0.2, 'sine'); // C
                    break;
                case 'music-e':
                    playBeep(659, 0.2, 'sine'); // E
                    break;
                case 'music-g':
                    playBeep(784, 0.2, 'sine'); // G
                    break;
                case 'music-b':
                    playBeep(988, 0.2, 'sine'); // B
                    break;
                case 'ghost':
                    playBeep(400, 0.3, 'sine');
                    setTimeout(() => playBeep(300, 0.5, 'sine'), 300);
                    break;
                case 'statue':
                    playBeep(150, 0.5, 'square');
                    break;
                case 'trap':
                    playBeep(1200, 0.05, 'sawtooth');
                    setTimeout(() => playBeep(100, 0.3, 'sawtooth'), 50);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - loaded from Level 3
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Rusty Sword',
            equippedArmor: 'Leather Armor',
            currentSection: 1,
            gameComplete: false,
            level: 4,
            // Level 4 specific flags
            foundKitchen: false,
            foundArmory: false,
            metGhostMusician: false,
            solvedMusicPuzzle: false,
            foundSecretPassage: false,
            defeatedCastleGuard: false,
            solvedStatuePuzzle: false,
            foundStaircaseKey: false,
            reachedSecondFloor: false
        };
        
        // Music puzzle state
        let musicPuzzleState = {
            selectedNote: '',
            attempts: 0
        };
        
        const musicSolution = 'B'; // C, E, G, B sequence
        
        // Statue puzzle state
        let statuePuzzleState = {
            valerius: '',
            morana: '',
            vladislaus: '',
            elisabeta: '',
            attempts: 0
        };
        
        const statueSolution = {
            valerius: 'east', // Moon
            morana: 'north',  // Bat
            vladislaus: 'west', // Sun (hated the sun)
            elisabeta: 'south' // Wolf
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1
        };
        
        // Game story sections for Level 4
        const storySections = {
            1: {
                text: "You stand in the grand entrance hall of Castle Vorlak's keep. The air is cold and stale. Green-flamed torches cast flickering shadows on stone walls adorned with ancient tapestries. Ahead, three passages branch off: left, right, and straight ahead up a grand staircase.",
                choices: [
                    {text: "Take the left passage", nextSection: 2, skillCheck: false},
                    {text: "Take the right passage", nextSection: 3, skillCheck: false},
                    {text: "Ascend the grand staircase", nextSection: 4, skillCheck: false},
                    {text: "Examine the tapestries", nextSection: 5, skillCheck: false}
                ]
            },
            2: {
                text: "The left passage leads to what appears to be the castle's kitchen area. Copper pots hang from hooks, and a large hearth dominates one wall. The room smells of old spices and something more pungent.",
                choices: [
                    {text: "Search the kitchen", nextSection: 6, skillCheck: false},
                    {text: "Continue through to the pantry", nextSection: 7, skillCheck: false},
                    {text: "Return to the entrance hall", nextSection: 1, skillCheck: false}
                ]
            },
            3: {
                text: "The right passage leads to an armory. Racks of weapons line the walls - swords, axes, and polearms, all coated in dust. Several suits of armor stand guard in the corners.",
                choices: [
                    {text: "Search for usable weapons", nextSection: 8, skillCheck: false},
                    {text: "Examine the armor", nextSection: 9, skillCheck: true, checkType: 'strength', difficulty: 12},
                    {text: "Return to the entrance hall", nextSection: 1, skillCheck: false}
                ]
            },
            4: {
                text: "You ascend the grand staircase. Halfway up, you encounter a massive iron gate blocking further progress. It's locked with an elaborate mechanism. A plaque reads: 'Only those who understand the castle's sorrow may pass.'",
                choices: [
                    {text: "Try to force the gate", nextSection: 10, skillCheck: true, checkType: 'strength', difficulty: 18},
                    {text: "Examine the locking mechanism", nextSection: 11, skillCheck: false},
                    {text: "Return downstairs", nextSection: 1, skillCheck: false}
                ]
            },
            5: {
                text: "The tapestries depict scenes from vampire history. One shows the first vampire lord, Valerius I, being created by a dark ritual. Another shows vampires ruling over human villages. A third shows a great battle between vampires and vampire hunters.",
                choices: [
                    {text: "Examine the battle tapestry closely", nextSection: 12, skillCheck: false},
                    {text: "Return to exploring", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(1, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "Behind one tapestry, you find a hidden compartment containing <span class='gold'>" + goldFound + " Gold</span>!";
                }
            },
            6: {
                text: "You search the kitchen. In a cupboard, you find some useful items.",
                choices: [
                    {text: "Take the items and continue", nextSection: 13, skillCheck: false},
                    {text: "Go to the pantry", nextSection: 7, skillCheck: false}
                ],
                action: function() {
                    gameState.foundKitchen = true;
                    addToInventory('Silver Knife Set');
                    addToInventory('Garlic Cloves');
                    playSound('item');
                    return "You find a <span class='item'>Silver Knife Set</span> and some <span class='item'>Garlic Cloves</span>. Both could be useful against vampires.";
                }
            },
            7: {
                text: "The pantry is filled with barrels and shelves. Most contain rotten food, but one shelf holds preserved items.",
                choices: [
                    {text: "Search the preserved items", nextSection: 14, skillCheck: false},
                    {text: "Look for a hidden door", nextSection: 15, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Return to the kitchen", nextSection: 6, skillCheck: false}
                ]
            },
            8: {
                text: "You search the weapon racks. Most weapons are rusted or ceremonial, but you find a few that might be useful.",
                choices: [
                    {text: "Take the best weapon", nextSection: 16, skillCheck: false},
                    {text: "Search for armor", nextSection: 9, skillCheck: false},
                    {text: "Examine a strange glowing weapon", nextSection: 17, skillCheck: false}
                ],
                action: function() {
                    gameState.foundArmory = true;
                    const weaponChoices = ['Silver-tipped Spear', 'Ancient Battleaxe', 'Vampire-hunter\'s Dagger'];
                    const foundWeapon = weaponChoices[Math.floor(Math.random() * weaponChoices.length)];
                    
                    if (confirm(`You found a ${foundWeapon}. Take it and replace your current weapon?`)) {
                        gameState.equippedWeapon = foundWeapon;
                        updateInventoryDisplay();
                        playSound('item');
                        return `You equip the <span class='item'>${foundWeapon}</span>.`;
                    }
                    return `You find a <span class='item'>${foundWeapon}</span> but leave it.`;
                }
            },
            9: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        addToInventory('Reinforced Breastplate');
                        playSound('item');
                        return "You find a <span class='item'>Reinforced Breastplate</span> that offers better protection than your current armor.";
                    } else {
                        playSound('failure');
                        return "The armor is rusted shut or too heavy to move. You find nothing useful.";
                    }
                }
            },
            10: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With immense effort, you force the gate open! It groans in protest but yields.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        
                        if (gameState.health <= 0) {
                            return "The gate doesn't budge, and you strain yourself terribly, taking " + damage + " fatal damage!";
                        } else {
                            return "The gate is immovable. You strain against it and injure yourself, taking " + damage + " damage.";
                        }
                    }
                }
            },
            11: {
                text: "The locking mechanism is intricate. It seems to require a specific key or solution. Looking around, you notice four statues in alcoves along the staircase, each facing a different direction.",
                choices: [
                    {text: "Examine the statues", nextSection: 20, skillCheck: false},
                    {text: "Search for a key", nextSection: 21, skillCheck: false},
                    {text: "Try to pick the lock", nextSection: 22, skillCheck: true, checkType: 'agility', difficulty: 16}
                ]
            },
            12: {
                text: "The battle tapestry shows vampire hunters using silver weapons, holy symbols, and sunlight. One figure stands out - a hunter wielding a glowing sword. The caption reads: 'The Daywalker's Last Stand'.",
                choices: [
                    {text: "Look for the sword depicted", nextSection: 23, skillCheck: false},
                    {text: "Return to exploring", nextSection: 1, skillCheck: false}
                ]
            },
            13: {
                text: "With your new items, you can either continue through the pantry or return to the entrance hall.",
                choices: [
                    {text: "Go to the pantry", nextSection: 7, skillCheck: false},
                    {text: "Return to entrance hall", nextSection: 1, skillCheck: false}
                ]
            },
            14: {
                text: "Among the preserved items, you find some that are still edible and a few other useful things.",
                choices: [
                    {text: "Take the items", nextSection: 24, skillCheck: false},
                    {text: "Continue searching", nextSection: 25, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(2, 6);
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    addToInventory('Ancient Wine');
                    playSound('item');
                    return "You find and eat some preserved fruits, restoring " + actualHeal + " Health. You also find a bottle of <span class='item'>Ancient Wine</span>.";
                }
            },
            15: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 26, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.foundSecretPassage = true;
                        playSound('success');
                        return "You find a hidden door behind a shelf! It leads to a narrow servant's passage.";
                    } else {
                        playSound('failure');
                        return "You search thoroughly but find no hidden doors.";
                    }
                }
            },
            16: {
                text: "With a new weapon equipped, you continue exploring the armory.",
                choices: [
                    {text: "Examine the glowing weapon", nextSection: 17, skillCheck: false},
                    {text: "Return to entrance hall", nextSection: 1, skillCheck: false}
                ]
            },
            17: {
                text: "The glowing weapon is a sword with a blade that seems to be made of crystal or glass. It emits a soft blue light. An inscription on the hilt reads: 'For those who walk in daylight'.",
                choices: [
                    {text: "Take the glowing sword", nextSection: 27, skillCheck: false},
                    {text: "Leave it and search elsewhere", nextSection: 8, skillCheck: false}
                ]
            },
            18: {
                text: "After examining the armor, you return to searching the armory.",
                choices: [
                    {text: "Search for weapons", nextSection: 8, skillCheck: false},
                    {text: "Return to entrance hall", nextSection: 1, skillCheck: false}
                ]
            },
            19: {
                text: "Whether you forced the gate or not, you're at the staircase gate.",
                choices: [
                    {text: "Continue through if open", nextSection: 28, skillCheck: false, requirement: function() { return window.checkResult === true; }},
                    {text: "Examine the statues", nextSection: 20, skillCheck: false},
                    {text: "Return downstairs", nextSection: 1, skillCheck: false}
                ]
            },
            20: {
                text: "Four stone statues stand in alcoves, each depicting an ancient vampire lord. They can be rotated to face different directions. An inscription on the gate reads: 'Align the ancestors as they stood in life.'",
                choices: [
                    {text: "Attempt to solve the statue puzzle", nextSection: 29, skillCheck: false},
                    {text: "Search for clues", nextSection: 30, skillCheck: false},
                    {text: "Return to examining the gate", nextSection: 11, skillCheck: false}
                ]
            },
            21: {
                text: "You search the area around the staircase for a key.",
                choices: [
                    {text: "Search the alcoves", nextSection: 31, skillCheck: false},
                    {text: "Look for hidden compartments", nextSection: 32, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Return to the statues", nextSection: 20, skillCheck: false}
                ]
            },
            22: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully pick the lock! The gate swings open.";
                    } else {
                        playSound('failure');
                        return "The lock is too complex. Your tools are insufficient.";
                    }
                }
            },
            23: {
                text: "You search the area near the tapestry but find no sword. However, you do notice that one section of the wall looks different - the stones are slightly uneven.",
                choices: [
                    {text: "Press the uneven stones", nextSection: 34, skillCheck: false},
                    {text: "Leave it and continue exploring", nextSection: 1, skillCheck: false}
                ]
            },
            24: {
                text: "With your new items, you continue exploring the pantry.",
                choices: [
                    {text: "Look for hidden door", nextSection: 15, skillCheck: false},
                    {text: "Return to kitchen", nextSection: 6, skillCheck: false}
                ]
            },
            25: {
                text: "You continue searching the pantry and find a trapdoor in the floor!",
                choices: [
                    {text: "Open the trapdoor", nextSection: 35, skillCheck: false},
                    {text: "Ignore it and return", nextSection: 7, skillCheck: false}
                ]
            },
            26: {
                text: "You've found a secret servant's passage! It's dark and narrow, but it might lead to other parts of the castle.",
                choices: [
                    {text: "Enter the passage", nextSection: 36, skillCheck: false},
                    {text: "Mark it and return later", nextSection: 7, skillCheck: false}
                ]
            },
            27: {
                text: "You take the glowing sword. As you grasp it, it feels warm in your hand, and the glow intensifies slightly.",
                choices: [
                    {text: "Equip the sword", nextSection: 37, skillCheck: false},
                    {text: "Keep it in inventory", nextSection: 38, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Glowing Crystal Sword');
                    playSound('item');
                    return "You now have the <span class='item'>Glowing Crystal Sword</span>. It seems to have special properties.";
                }
            },
            28: {
                text: "You pass through the gate and continue up the staircase. At the top, you find yourself in a long corridor with doors on either side.",
                choices: [
                    {text: "Open the first door on the left", nextSection: 39, skillCheck: false},
                    {text: "Open the first door on the right", nextSection: 40, skillCheck: false},
                    {text: "Continue down the corridor", nextSection: 41, skillCheck: false}
                ]
            },
            29: {
                text: "You examine the statues more closely. Each has a name plaque: Valerius I, Morana, Vladislaus, and Elisabeta. They can be rotated to face north, south, east, or west.",
                choices: [],
                action: function() {
                    showScreen('screen-statue-puzzle');
                    return "";
                }
            },
            30: {
                text: "You search for clues about the statues. On the wall nearby, you find faded inscriptions describing each vampire lord's preferences.",
                choices: [
                    {text: "Read about Valerius I", nextSection: 42, skillCheck: false},
                    {text: "Read about Morana", nextSection: 43, skillCheck: false},
                    {text: "Read about Vladislaus", nextSection: 44, skillCheck: false},
                    {text: "Read about Elisabeta", nextSection: 45, skillCheck: false},
                    {text: "Attempt the puzzle", nextSection: 29, skillCheck: false}
                ]
            },
            31: {
                text: "You search the alcoves near the statues. In one, you find a small silver key!",
                choices: [
                    {text: "Take the key", nextSection: 46, skillCheck: false},
                    {text: "Try it on the gate", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    gameState.foundStaircaseKey = true;
                    addToInventory('Ornate Silver Key');
                    playSound('item');
                    return "You find an <span class='item'>Ornate Silver Key</span>! It might fit the gate lock.";
                }
            },
            32: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 48, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(3, 10);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        playSound('item');
                        return "You find a hidden compartment containing <span class='gold'>" + goldFound + " Gold</span>!";
                    } else {
                        playSound('failure');
                        return "You find no hidden compartments.";
                    }
                }
            },
            33: {
                text: "After your lockpicking attempt, you reconsider your options.",
                choices: [
                    {text: "Examine the statues", nextSection: 20, skillCheck: false},
                    {text: "Search for a key", nextSection: 21, skillCheck: false},
                    {text: "Return downstairs", nextSection: 1, skillCheck: false}
                ]
            },
            34: {
                text: "You press the uneven stones, and a section of the wall slides open! Behind it is a small niche containing a dusty old book.",
                choices: [
                    {text: "Take the book", nextSection: 49, skillCheck: false},
                    {text: "Leave it", nextSection: 1, skillCheck: false}
                ]
            },
            35: {
                text: "You open the trapdoor. A ladder leads down into darkness. From below, you hear the sound of flowing water.",
                choices: [
                    {text: "Descend the ladder", nextSection: 50, skillCheck: false},
                    {text: "Close it and return", nextSection: 7, skillCheck: false}
                ]
            },
            36: {
                text: "The servant's passage is cramped and dark. You have to feel your way along. After some time, you see light ahead and emerge in a different part of the castle - a library.",
                choices: [
                    {text: "Explore the library", nextSection: 51, skillCheck: false},
                    {text: "Return through the passage", nextSection: 7, skillCheck: false}
                ]
            },
            37: {
                text: "You equip the glowing sword. It feels lighter and more balanced than your previous weapon.",
                choices: [
                    {text: "Test the sword", nextSection: 52, skillCheck: false},
                    {text: "Return to searching", nextSection: 8, skillCheck: false}
                ],
                action: function() {
                    gameState.equippedWeapon = 'Glowing Crystal Sword';
                    updateInventoryDisplay();
                    playSound('item');
                    return "You equip the <span class='item'>Glowing Crystal Sword</span>. Its glow provides some light in dark areas.";
                }
            },
            38: {
                text: "You keep the sword in your inventory for now.",
                choices: [
                    {text: "Continue searching the armory", nextSection: 8, skillCheck: false}
                ]
            },
            39: {
                text: "The door opens to reveal a bedroom. It's lavishly furnished but covered in dust. A four-poster bed with velvet curtains dominates the room. On a nightstand, you see a jewelry box.",
                choices: [
                    {text: "Search the room", nextSection: 53, skillCheck: false},
                    {text: "Open the jewelry box", nextSection: 54, skillCheck: false},
                    {text: "Leave and try another door", nextSection: 28, skillCheck: false}
                ]
            },
            40: {
                text: "This door leads to a study. Books line the walls, and a large oak desk sits in the center. On the desk is an open book with strange symbols.",
                choices: [
                    {text: "Examine the book", nextSection: 55, skillCheck: false},
                    {text: "Search the desk", nextSection: 56, skillCheck: false},
                    {text: "Leave and try another door", nextSection: 28, skillCheck: false}
                ]
            },
            41: {
                text: "You continue down the corridor. At the end, you find a set of double doors. From behind them, you hear faint, mournful music.",
                choices: [
                    {text: "Listen at the doors", nextSection: 57, skillCheck: false},
                    {text: "Open the doors", nextSection: 58, skillCheck: false},
                    {text: "Return to the staircase", nextSection: 28, skillCheck: false}
                ]
            },
            42: {
                text: "The inscription reads: 'Valerius I, first of our kind, who loved the moon's silver light more than the sun's harsh glare.'",
                choices: [
                    {text: "Continue reading others", nextSection: 30, skillCheck: false},
                    {text: "Attempt the puzzle", nextSection: 29, skillCheck: false}
                ]
            },
            43: {
                text: "The inscription reads: 'Morana, queen of the night, whose spirit took the form of a bat to fly between worlds.'",
                choices: [
                    {text: "Continue reading others", nextSection: 30, skillCheck: false},
                    {text: "Attempt the puzzle", nextSection: 29, skillCheck: false}
                ]
            },
            44: {
                text: "The inscription reads: 'Vladislaus, called the Cruel, who despised the sun that he could never again behold.'",
                choices: [
                    {text: "Continue reading others", nextSection: 30, skillCheck: false},
                    {text: "Attempt the puzzle", nextSection: 29, skillCheck: false}
                ]
            },
            45: {
                text: "The inscription reads: 'Elisabeta, the Beautiful, who kept wolves as pets and companions in her eternal loneliness.'",
                choices: [
                    {text: "Continue reading others", nextSection: 30, skillCheck: false},
                    {text: "Attempt the puzzle", nextSection: 29, skillCheck: false}
                ]
            },
            46: {
                text: "You now have the silver key. Will you try it on the gate?",
                choices: [
                    {text: "Try the key on the gate", nextSection: 47, skillCheck: false},
                    {text: "Continue searching", nextSection: 21, skillCheck: false}
                ]
            },
            47: {
                text: "You try the ornate silver key in the gate lock. It fits perfectly! The gate unlocks and swings open.",
                choices: [
                    {text: "Ascend the staircase", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Ornate Silver Key');
                    playSound('success');
                    return "The <span class='item'>Ornate Silver Key</span> unlocks the gate!";
                }
            },
            48: {
                text: "After searching for hidden compartments, you return to other options.",
                choices: [
                    {text: "Examine the statues", nextSection: 20, skillCheck: false},
                    {text: "Search the alcoves", nextSection: 31, skillCheck: false},
                    {text: "Return downstairs", nextSection: 1, skillCheck: false}
                ]
            },
            49: {
                text: "The book is titled 'The History of the Daywalker Order'. It contains information about an ancient order of vampire hunters.",
                choices: [
                    {text: "Take the book", nextSection: 59, skillCheck: false},
                    {text: "Leave it", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Daywalker History Book');
                    playSound('item');
                    return "You take the <span class='item'>Daywalker History Book</span>. It might contain useful information.";
                }
            },
            50: {
                text: "You descend into what appears to be the castle's cistern or water system. The air is damp and cool. You can hear water flowing through channels in the stone.",
                choices: [
                    {text: "Follow the water flow", nextSection: 60, skillCheck: false},
                    {text: "Search the area", nextSection: 61, skillCheck: false},
                    {text: "Climb back up", nextSection: 7, skillCheck: false}
                ]
            },
            51: {
                text: "The library is vast, with shelves reaching to the ceiling. Ladders provide access to higher shelves. In the center of the room, a ghostly figure plays a violin.",
                choices: [
                    {text: "Approach the ghostly musician", nextSection: 62, skillCheck: false},
                    {text: "Search the bookshelves", nextSection: 63, skillCheck: false},
                    {text: "Leave quietly", nextSection: 64, skillCheck: false}
                ]
            },
            52: {
                text: "You test the sword by swinging it through the air. It leaves a faint trail of light. The sword feels exceptionally well-balanced and sharp.",
                choices: [
                    {text: "Return to the armory", nextSection: 8, skillCheck: false}
                ]
            },
            53: {
                text: "You search the bedroom. In a wardrobe, you find fine clothes that have mostly turned to dust. In a drawer, you find some jewelry.",
                choices: [
                    {text: "Take the jewelry", nextSection: 65, skillCheck: false},
                    {text: "Continue searching", nextSection: 66, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find jewelry worth <span class='gold'>" + goldFound + " Gold</span>!";
                }
            },
            54: {
                text: "You open the jewelry box. Inside is a beautiful silver necklace with a ruby pendant. As you touch it, you feel a slight warmth.",
                choices: [
                    {text: "Take the necklace", nextSection: 67, skillCheck: false},
                    {text: "Leave it", nextSection: 53, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Ruby Pendant Necklace');
                    playSound('item');
                    return "You take the <span class='item'>Ruby Pendant Necklace</span>. It feels magical.";
                }
            },
            55: {
                text: "The book contains vampire lore and rituals. One passage catches your eye: 'To open the way to the master's chambers, understand the sorrow of the castle.' There's a musical staff with notes written on it.",
                choices: [
                    {text: "Study the musical notes", nextSection: 68, skillCheck: false},
                    {text: "Search the desk", nextSection: 56, skillCheck: false}
                ]
            },
            56: {
                text: "You search the desk drawers. In one, you find writing implements that have long since dried up. In another, you find a sealed letter.",
                choices: [
                    {text: "Open and read the letter", nextSection: 69, skillCheck: false},
                    {text: "Take the letter", nextSection: 70, skillCheck: false},
                    {text: "Leave it", nextSection: 40, skillCheck: false}
                ]
            },
            57: {
                text: "You listen at the doors. The music is a slow, mournful melody played on a violin. It seems to be coming from just beyond the doors.",
                choices: [
                    {text: "Open the doors", nextSection: 58, skillCheck: false},
                    {text: "Knock first", nextSection: 71, skillCheck: false},
                    {text: "Return down the corridor", nextSection: 41, skillCheck: false}
                ]
            },
            58: {
                text: "You open the doors to reveal a grand ballroom. Chandeliers hang from the ceiling, and at the far end, a ghostly figure plays a violin. The ghost notices you and stops playing.",
                choices: [
                    {text: "Approach the ghost", nextSection: 72, skillCheck: false},
                    {text: "Ask about the music", nextSection: 73, skillCheck: false},
                    {text: "Prepare for combat", nextSection: 74, skillCheck: false}
                ]
            },
            59: {
                text: "With the book in hand, you return to the entrance hall.",
                choices: [
                    {text: "Continue exploring", nextSection: 1, skillCheck: false}
                ]
            },
            60: {
                text: "You follow the water flow through underground channels. Eventually, you come to a grille that looks out into the castle moat. There's no way forward.",
                choices: [
                    {text: "Search the area around the grille", nextSection: 75, skillCheck: false},
                    {text: "Return the way you came", nextSection: 50, skillCheck: false}
                ]
            },
            61: {
                text: "You search the cistern area. In a dry corner, you find some old barrels and crates.",
                choices: [
                    {text: "Search the barrels", nextSection: 76, skillCheck: false},
                    {text: "Return to the ladder", nextSection: 50, skillCheck: false}
                ]
            },
            62: {
                text: "You approach the ghostly musician. It stops playing and turns to face you. Its features are indistinct, but you can make out the shape of a man in old-fashioned clothing.",
                choices: [
                    {text: "Ask who it is", nextSection: 77, skillCheck: false},
                    {text: "Ask about the castle", nextSection: 78, skillCheck: false},
                    {text: "Ask for help finding Valerius", nextSection: 79, skillCheck: false}
                ]
            },
            63: {
                text: "You search the bookshelves. Most books are in languages you don't understand or are too decayed to read. One shelf contains books on alchemy and magic.",
                choices: [
                    {text: "Search the magic books", nextSection: 80, skillCheck: false},
                    {text: "Search for maps of the castle", nextSection: 81, skillCheck: false},
                    {text: "Approach the ghost", nextSection: 62, skillCheck: false}
                ]
            },
            64: {
                text: "You leave the library quietly, not disturbing the ghost. You find yourself back in the servant's passage.",
                choices: [
                    {text: "Return to the pantry", nextSection: 7, skillCheck: false},
                    {text: "Explore further down the passage", nextSection: 82, skillCheck: false}
                ]
            },
            65: {
                text: "With the jewelry taken, you continue searching the bedroom.",
                choices: [
                    {text: "Search under the bed", nextSection: 83, skillCheck: false},
                    {text: "Examine the fireplace", nextSection: 84, skillCheck: false},
                    {text: "Leave the room", nextSection: 28, skillCheck: false}
                ]
            },
            66: {
                text: "You continue searching the bedroom but find nothing else of value.",
                choices: [
                    {text: "Open the jewelry box", nextSection: 54, skillCheck: false},
                    {text: "Leave the room", nextSection: 28, skillCheck: false}
                ]
            },
            67: {
                text: "With the necklace, you continue exploring the bedroom.",
                choices: [
                    {text: "Search the rest of the room", nextSection: 53, skillCheck: false},
                    {text: "Leave the room", nextSection: 28, skillCheck: false}
                ]
            },
            68: {
                text: "The musical notes form a simple melody: C, E, G, and then... the last note is smudged. You'll need to figure out what completes the sequence.",
                choices: [
                    {text: "Memorize the sequence", nextSection: 85, skillCheck: false},
                    {text: "Search the desk", nextSection: 56, skillCheck: false}
                ],
                action: function() {
                    gameState.solvedMusicPuzzle = true;
                    playSound('music');
                    return "You study the musical sequence. It seems important.";
                }
            },
            69: {
                text: "You open and read the letter. It's from Valerius to his lieutenant, instructing him to guard the second floor. The letter mentions a 'ghost who guards the way with music' and that 'only those who understand the melody may pass'.",
                choices: [
                    {text: "Take the letter", nextSection: 70, skillCheck: false},
                    {text: "Leave it", nextSection: 56, skillCheck: false}
                ]
            },
            70: {
                text: "You take the letter. It might contain useful information.",
                choices: [
                    {text: "Continue searching the study", nextSection: 56, skillCheck: false},
                    {text: "Leave the study", nextSection: 40, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Valerius\' Letter');
                    playSound('item');
                    return "You take <span class='item'>Valerius' Letter</span>.";
                }
            },
            71: {
                text: "You knock on the doors. The music stops abruptly. After a moment, a ghostly voice says, 'Enter... if you dare.'",
                choices: [
                    {text: "Enter", nextSection: 58, skillCheck: false},
                    {text: "Ask who's there", nextSection: 86, skillCheck: false},
                    {text: "Retreat", nextSection: 41, skillCheck: false}
                ]
            },
            72: {
                text: "You approach the ghost. It looks at you with hollow eyes. 'Another mortal come to challenge the master,' it says in a whispery voice. 'Few have come this far.'",
                choices: [
                    {text: "Ask how to proceed", nextSection: 87, skillCheck: false},
                    {text: "Ask about the music", nextSection: 73, skillCheck: false},
                    {text: "Attack the ghost", nextSection: 74, skillCheck: false}
                ]
            },
            73: {
                text: "'The music is my sorrow, my eternal regret,' the ghost says. 'To pass, you must understand it. Complete my melody, and the way will open.'",
                choices: [
                    {text: "Attempt to complete the melody", nextSection: 88, skillCheck: false},
                    {text: "Ask for more information", nextSection: 89, skillCheck: false},
                    {text: "Attack instead", nextSection: 74, skillCheck: false}
                ],
                action: function() {
                    gameState.metGhostMusician = true;
                    playSound('ghost');
                }
            },
            74: {
                text: "You attack the ghost, but your weapon passes through it harmlessly. The ghost laughs mournfully. 'You cannot harm what is already dead, mortal. Now leave me to my music.'",
                choices: [
                    {text: "Try to complete the melody", nextSection: 88, skillCheck: false},
                    {text: "Leave the ballroom", nextSection: 58, skillCheck: false}
                ]
            },
            75: {
                text: "You search around the grille. In the dim light, you see something glinting in the water - a metal box caught on the grille.",
                choices: [
                    {text: "Try to retrieve the box", nextSection: 90, skillCheck: true, checkType: 'strength', difficulty: 14},
                    {text: "Leave it", nextSection: 60, skillCheck: false}
                ]
            },
            76: {
                text: "You search the barrels. Most are empty or contain rotten matter. One, however, is sealed and marked with a symbol of a bat.",
                choices: [
                    {text: "Open the marked barrel", nextSection: 91, skillCheck: false},
                    {text: "Leave it", nextSection: 61, skillCheck: false}
                ]
            },
            77: {
                text: "'I am Alistair, court musician to Lord Valerius,' the ghost says. 'I have played here for centuries, since the night I died.'",
                choices: [
                    {text: "Ask how you died", nextSection: 92, skillCheck: false},
                    {text: "Ask about the castle", nextSection: 78, skillCheck: false},
                    {text: "Ask for help", nextSection: 79, skillCheck: false}
                ]
            },
            78: {
                text: "'The castle holds many secrets,' Alistair says. 'The master's chambers are on the second floor, but the way is guarded. You must prove your worth.'",
                choices: [
                    {text: "Ask how to prove my worth", nextSection: 87, skillCheck: false},
                    {text: "Ask about the music", nextSection: 73, skillCheck: false},
                    {text: "Thank him and leave", nextSection: 51, skillCheck: false}
                ]
            },
            79: {
                text: "'I cannot directly help you against my master,' Alistair says. 'But I can give you this advice: understand sorrow, and you may understand how to proceed.'",
                choices: [
                    {text: "Ask what he means", nextSection: 93, skillCheck: false},
                    {text: "Ask about the music", nextSection: 73, skillCheck: false},
                    {text: "Thank him", nextSection: 51, skillCheck: false}
                ]
            },
            80: {
                text: "You search through the magic books. One in particular catches your eye: 'Warding Against the Undead'. It contains information on protective spells.",
                choices: [
                    {text: "Take the book", nextSection: 94, skillCheck: false},
                    {text: "Search for maps", nextSection: 81, skillCheck: false}
                ]
            },
            81: {
                text: "You search for maps but find none. However, you do find a scroll with a partial floor plan of the first floor.",
                choices: [
                    {text: "Take the scroll", nextSection: 95, skillCheck: false},
                    {text: "Search magic books", nextSection: 80, skillCheck: false}
                ]
            },
            82: {
                text: "You explore further down the servant's passage. It winds through the castle walls and eventually leads to a door.",
                choices: [
                    {text: "Open the door", nextSection: 96, skillCheck: false},
                    {text: "Return to the library", nextSection: 51, skillCheck: false}
                ]
            },
            83: {
                text: "You look under the bed and find a locked chest.",
                choices: [
                    {text: "Try to open the chest", nextSection: 97, skillCheck: false},
                    {text: "Leave it", nextSection: 65, skillCheck: false}
                ]
            },
            84: {
                text: "You examine the fireplace. The ashes are cold, but you notice something glinting in the back - a key hanging on a hook.",
                choices: [
                    {text: "Reach for the key", nextSection: 98, skillCheck: false},
                    {text: "Leave it", nextSection: 65, skillCheck: false}
                ]
            },
            85: {
                text: "You've memorized the musical sequence from the book. Now you need to find where to use it.",
                choices: [
                    {text: "Return to searching the study", nextSection: 55, skillCheck: false},
                    {text: "Leave the study", nextSection: 40, skillCheck: false}
                ]
            },
            86: {
                text: "'I am the keeper of sorrow,' the voice replies. 'Enter and face your test, or leave and abandon your quest.'",
                choices: [
                    {text: "Enter", nextSection: 58, skillCheck: false},
                    {text: "Leave", nextSection: 41, skillCheck: false}
                ]
            },
            87: {
                text: "'Complete my melody,' the ghost says. 'Show me you understand sorrow, and the way to the second floor will open.'",
                choices: [
                    {text: "Attempt the melody puzzle", nextSection: 88, skillCheck: false},
                    {text: "Ask for a hint", nextSection: 89, skillCheck: false},
                    {text: "Attack", nextSection: 74, skillCheck: false}
                ]
            },
            88: {
                text: "The ghost gestures to the air, and four glowing musical notes appear: C, E, G, and a question mark for the fourth note. 'Complete my sorrowful melody,' it says.",
                choices: [],
                action: function() {
                    showScreen('screen-music-puzzle');
                    return "";
                }
            },
            89: {
                text: "'The notes form a chord of sorrow,' the ghost says. 'Think of what completes a minor chord of C.'",
                choices: [
                    {text: "Attempt the puzzle", nextSection: 88, skillCheck: false},
                    {text: "Thank the ghost", nextSection: 72, skillCheck: false}
                ]
            },
            90: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 99, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(4, 10);
                        gameState.gold += goldFound;
                        addToInventory('Waterlogged Lockbox');
                        updateStatsDisplay();
                        playSound('item');
                        return "You retrieve the metal box! Inside, you find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Waterlogged Lockbox</span> that might contain something valuable.";
                    } else {
                        playSound('failure');
                        return "You can't reach the box. The current is too strong.";
                    }
                }
            },
            91: {
                text: "You open the marked barrel. Inside, you find several bottles of ancient wine and some preserved food.",
                choices: [
                    {text: "Take the wine", nextSection: 100, skillCheck: false},
                    {text: "Take the food", nextSection: 101, skillCheck: false},
                    {text: "Leave it", nextSection: 61, skillCheck: false}
                ]
            },
            92: {
                text: "'I challenged Valerius for the love of a woman,' Alistair says mournfully. 'He turned me into what I am now - neither living nor truly dead, forced to play for eternity.'",
                choices: [
                    {text: "Express sympathy", nextSection: 102, skillCheck: false},
                    {text: "Ask how to defeat Valerius", nextSection: 79, skillCheck: false}
                ]
            },
            93: {
                text: "'Sorrow is the key to this castle,' Alistair says. 'We are all trapped by it - the master by his curse, I by my regret, the castle itself by its history.'",
                choices: [
                    {text: "Ask about the melody", nextSection: 73, skillCheck: false},
                    {text: "Thank him", nextSection: 51, skillCheck: false}
                ]
            },
            94: {
                text: "You take the book on warding against undead. It might be useful.",
                choices: [
                    {text: "Continue searching", nextSection: 81, skillCheck: false},
                    {text: "Approach the ghost", nextSection: 62, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Warding Against Undead');
                    playSound('item');
                    return "You take <span class='item'>Warding Against Undead</span>.";
                }
            },
            95: {
                text: "You take the partial floor plan. It shows the layout of the first floor, including some secret passages.",
                choices: [
                    {text: "Study the map", nextSection: 103, skillCheck: false},
                    {text: "Continue searching", nextSection: 80, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Partial Castle Map');
                    playSound('item');
                    return "You take a <span class='item'>Partial Castle Map</span>.";
                }
            },
            96: {
                text: "You open the door and find yourself in the castle's grand ballroom. A ghostly musician plays violin at the far end.",
                choices: [
                    {text: "Approach the ghost", nextSection: 72, skillCheck: false},
                    {text: "Retreat back through the door", nextSection: 82, skillCheck: false}
                ]
            },
            97: {
                text: "The chest is locked. You'll need a key or lockpicking skills to open it.",
                choices: [
                    {text: "Try to pick the lock", nextSection: 104, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Force it open", nextSection: 105, skillCheck: true, checkType: 'strength', difficulty: 15},
                    {text: "Leave it", nextSection: 83, skillCheck: false}
                ]
            },
            98: {
                text: "You retrieve the key from the fireplace. It's an ornate bronze key.",
                choices: [
                    {text: "Try it on the chest", nextSection: 106, skillCheck: false},
                    {text: "Keep it", nextSection: 107, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Ornate Bronze Key');
                    playSound('item');
                    return "You retrieve an <span class='item'>Ornate Bronze Key</span> from the fireplace.";
                }
            },
            99: {
                text: "With the lockbox retrieved, you climb back up the ladder to the pantry.",
                choices: [
                    {text: "Search the rest of the cistern", nextSection: 61, skillCheck: false},
                    {text: "Return to the pantry", nextSection: 7, skillCheck: false}
                ]
            },
            100: {
                text: "You take bottles of ancient wine. It might have restorative properties or be valuable.",
                choices: [
                    {text: "Take the food too", nextSection: 101, skillCheck: false},
                    {text: "Leave the cistern", nextSection: 61, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Ancient Vampire Wine');
                    playSound('item');
                    return "You take <span class='item'>Ancient Vampire Wine</span>. It has a dark, rich color.";
                }
            },
            101: {
                text: "You take the preserved food. It's still edible and could restore health.",
                choices: [
                    {text: "Take the wine too", nextSection: 100, skillCheck: false},
                    {text: "Leave the cistern", nextSection: 61, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Preserved Rations');
                    playSound('item');
                    return "You take <span class='item'>Preserved Rations</span>.";
                }
            },
            102: {
                text: "'Thank you for your sympathy,' Alistair says. 'Few show kindness to the dead. For this, I will give you a clue: the melody of sorrow ends on B.'",
                choices: [
                    {text: "Thank him", nextSection: 62, skillCheck: false},
                    {text: "Ask about the castle", nextSection: 78, skillCheck: false}
                ],
                action: function() {
                    gameState.solvedMusicPuzzle = true; // Hint given
                    return "The ghost has given you a clue about the melody!";
                }
            },
            103: {
                text: "You study the map. It shows the layout of the first floor, including the entrance hall, kitchen, armory, library, and ballroom. It also shows a secret passage from the library to the ballroom.",
                choices: [
                    {text: "Use the map to navigate", nextSection: 108, skillCheck: false},
                    {text: "Put it away", nextSection: 95, skillCheck: false}
                ]
            },
            104: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 109, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(6, 10);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        playSound('item');
                        return "You successfully pick the lock! Inside, you find <span class='gold'>" + goldFound + " Gold</span> and a beautiful silver bracelet.";
                    } else {
                        playSound('trap');
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "You trigger a trap! A needle pricks your finger, dealing " + damage + " damage. The chest remains locked.";
                    }
                }
            },
            105: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 110, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(4, 10);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        playSound('item');
                        return "You force the chest open! Inside, you find <span class='gold'>" + goldFound + " Gold</span>.";
                    } else {
                        playSound('failure');
                        return "The chest won't budge. It's too sturdy.";
                    }
                }
            },
            106: {
                text: "You try the bronze key on the chest. It fits perfectly! The chest unlocks.",
                choices: [
                    {text: "Open the chest", nextSection: 111, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Ornate Bronze Key');
                    playSound('success');
                    return "The <span class='item'>Ornate Bronze Key</span> unlocks the chest!";
                }
            },
            107: {
                text: "You keep the key and continue searching the bedroom.",
                choices: [
                    {text: "Try the chest again", nextSection: 97, skillCheck: false},
                    {text: "Leave the room", nextSection: 28, skillCheck: false}
                ]
            },
            108: {
                text: "Using the map, you can now navigate the castle more efficiently.",
                choices: [
                    {text: "Go to the kitchen", nextSection: 2, skillCheck: false},
                    {text: "Go to the armory", nextSection: 3, skillCheck: false},
                    {text: "Go to the ballroom", nextSection: 41, skillCheck: false},
                    {text: "Return to entrance hall", nextSection: 1, skillCheck: false}
                ]
            },
            109: {
                text: "After your lockpicking attempt, you consider your next move.",
                choices: [
                    {text: "Try to force the chest", nextSection: 105, skillCheck: false},
                    {text: "Look for a key", nextSection: 84, skillCheck: false},
                    {text: "Leave it", nextSection: 83, skillCheck: false}
                ]
            },
            110: {
                text: "After trying to force the chest, you reconsider.",
                choices: [
                    {text: "Try to pick the lock", nextSection: 104, skillCheck: false},
                    {text: "Look for a key", nextSection: 84, skillCheck: false},
                    {text: "Leave it", nextSection: 83, skillCheck: false}
                ]
            },
            111: {
                text: "You open the chest. Inside, you find valuable items!",
                choices: [
                    {text: "Take everything", nextSection: 112, skillCheck: false},
                    {text: "Leave it", nextSection: 97, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(8, 10);
                    gameState.gold += goldFound;
                    addToInventory('Silver Hair Comb');
                    addToInventory('Perfume of Eternal Youth');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span>, a <span class='item'>Silver Hair Comb</span>, and a bottle of <span class='item'>Perfume of Eternal Youth</span>!";
                }
            },
            112: {
                text: "With the chest looted, you leave the bedroom.",
                choices: [
                    {text: "Return to the corridor", nextSection: 28, skillCheck: false}
                ]
            },
            113: {
                text: "The ghost nods approvingly. 'You understand sorrow,' it says. The doors at the far end of the ballroom swing open, revealing a staircase leading upward. 'The way to the second floor is open. May you find what you seek.'",
                choices: [
                    {text: "Thank the ghost", nextSection: 114, skillCheck: false},
                    {text: "Ascend the staircase", nextSection: 115, skillCheck: false}
                ],
                action: function() {
                    gameState.reachedSecondFloor = true;
                    playSound('ghost');
                    return "";
                }
            },
            114: {
                text: "'Farewell, mortal,' the ghost says, resuming its playing. The mournful melody fills the ballroom once more as you approach the staircase.",
                choices: [
                    {text: "Ascend to the second floor", nextSection: 115, skillCheck: false}
                ]
            },
            115: {
                text: "YOU HAVE REACHED THE SECOND FLOOR! The staircase ends in another corridor, darker and colder than the first floor. The air smells of ancient dust and something else... the faint scent of blood. The vampire lord's personal chambers are somewhere on this floor.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 5;
                    saveGame();
                    
                    return "";
                }
            },
            116: {
                text: "The statues click into place, and you hear a mechanism engage. The gate unlocks and swings open!",
                choices: [
                    {text: "Ascend the staircase", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    gameState.solvedStatuePuzzle = true;
                    playSound('success');
                    return "You've solved the statue puzzle! The gate is now open.";
                }
            }
        };
        
        // Initialize game for Level 4
        function initGame() {
            // Load game state from Level 3
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 4 (coming from Level 3)
                if (savedState.level === 4) {
                    Object.assign(gameState, savedState);
                    
                    // Update intro screen with loaded stats
                    document.getElementById('intro-stat-strength').textContent = gameState.strength;
                    document.getElementById('intro-stat-health').textContent = gameState.health;
                    document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('intro-stat-agility').textContent = gameState.agility;
                    document.getElementById('intro-stat-gold').textContent = gameState.gold;
                    
                    showScreen('screen-intro');
                    return;
                } else if (savedState.level === 3) {
                    // If coming directly from Level 3 without completing it
                    alert("You must complete Level 3 first!");
                    window.location.href = 'l3.html';
                    return;
                }
            } else {
                // No saved game found
                alert("No saved game found. Starting from Level 1.");
                window.location.href = 'l1.html';
                return;
            }
        }
        
        function startLevel4() {
            playSound('click');
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item) && item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Music puzzle functions
        function playNote(note) {
            switch(note) {
                case 'C': playSound('music'); break;
                case 'E': playSound('music-e'); break;
                case 'G': playSound('music-g'); break;
                case 'B': playSound('music-b'); break;
            }
        }
        
        function selectMusicNote(note) {
            playSound('music');
            musicPuzzleState.selectedNote = note;
            
            document.getElementById('music-selection').textContent = note;
            document.getElementById('music-feedback').style.display = 'block';
            document.getElementById('try-music-btn').disabled = false;
        }
        
        function tryMusicPuzzle() {
            playSound('music');
            musicPuzzleState.attempts++;
            
            if (musicPuzzleState.selectedNote === musicSolution) {
                // Puzzle solved!
                playSound('success');
                gameState.solvedMusicPuzzle = true;
                showScreen('screen-game');
                loadSection(113); // Ghost opens the way
                
                // Reset puzzle
                musicPuzzleState.selectedNote = '';
                musicPuzzleState.attempts = 0;
            } else {
                // Puzzle failed
                playSound('failure');
                let feedback = "The ghost shakes its head sadly. 'That is not the note of sorrow.'";
                
                document.getElementById('story-text').innerHTML = `<p>${feedback}</p><div class='blinking-cursor'></div>`;
                
                // Reset for another attempt
                musicPuzzleState.selectedNote = '';
                document.getElementById('try-music-btn').disabled = true;
                document.getElementById('music-feedback').style.display = 'none';
            }
        }
        
        function cancelMusicPuzzle() {
            playSound('click');
            showScreen('screen-game');
            loadSection(88); // Return to ghost
        }
        
        // Statue puzzle functions
        function rotateStatue(statue, direction) {
            playSound('statue');
            statuePuzzleState[statue] = direction;
            
            // Update display
            let positionsText = `Valerius I: ${statuePuzzleState.valerius || '?'}, `;
            positionsText += `Morana: ${statuePuzzleState.morana || '?'}, `;
            positionsText += `Vladislaus: ${statuePuzzleState.vladislaus || '?'}, `;
            positionsText += `Elisabeta: ${statuePuzzleState.elisabeta || '?'}`;
            
            document.getElementById('statue-positions').textContent = positionsText;
            document.getElementById('statue-feedback').style.display = 'block';
            
            // Enable try button when all statues are positioned
            if (statuePuzzleState.valerius && statuePuzzleState.morana && 
                statuePuzzleState.vladislaus && statuePuzzleState.elisabeta) {
                document.getElementById('try-statue-btn').disabled = false;
            }
        }
        
        function tryStatuePuzzle() {
            playSound('statue');
            statuePuzzleState.attempts++;
            
            const correctValerius = (statuePuzzleState.valerius === statueSolution.valerius);
            const correctMorana = (statuePuzzleState.morana === statueSolution.morana);
            const correctVladislaus = (statuePuzzleState.vladislaus === statueSolution.vladislaus);
            const correctElisabeta = (statuePuzzleState.elisabeta === statueSolution.elisabeta);
            
            if (correctValerius && correctMorana && correctVladislaus && correctElisabeta) {
                // Puzzle solved!
                playSound('success');
                gameState.solvedStatuePuzzle = true;
                showScreen('screen-game');
                loadSection(116); // Gate opens
                
                // Reset puzzle
                statuePuzzleState.valerius = '';
                statuePuzzleState.morana = '';
                statuePuzzleState.vladislaus = '';
                statuePuzzleState.elisabeta = '';
                statuePuzzleState.attempts = 0;
            } else {
                // Puzzle failed
                playSound('failure');
                let feedback = "The statues don't align properly. Nothing happens.";
                
                if (correctValerius) feedback += " Valerius seems correctly positioned.";
                if (correctMorana) feedback += " Morana seems correctly positioned.";
                if (correctVladislaus) feedback += " Vladislaus seems correctly positioned.";
                if (correctElisabeta) feedback += " Elisabeta seems correctly positioned.";
                
                document.getElementById('story-text').innerHTML = `<p>${feedback}</p><div class='blinking-cursor'></div>`;
                
                // Reset for another attempt
                statuePuzzleState.valerius = '';
                statuePuzzleState.morana = '';
                statuePuzzleState.vladislaus = '';
                statuePuzzleState.elisabeta = '';
                document.getElementById('try-statue-btn').disabled = true;
                document.getElementById('statue-feedback').style.display = 'none';
            }
        }
        
        function cancelStatuePuzzle() {
            playSound('click');
            showScreen('screen-game');
            loadSection(29); // Return to statue puzzle start
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Potion' || item === 'Mountain Potion' || item === 'Ancient Vampire Wine') {
                const healAmount = item === 'Mountain Potion' ? rollDice(3, 6) + 10 : 
                                 item === 'Ancient Vampire Wine' ? rollDice(2, 8) + 5 : rollDice(2, 6) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Preserved Meat' || item === 'Goat Cheese' || item === 'Iron Rations' || item === 'Preserved Rations') {
                const healAmount = rollDice(2, 6);
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You eat the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Garlic Cloves') {
                message = "The <span class='item'>Garlic Cloves</span> might repel vampires or be used in other ways.";
            } else if (item === 'Silver Cross') {
                message = "The <span class='item'>Silver Cross</span> glows with holy energy. It might repel undead creatures.";
            } else if (item === 'Silver Knife Set') {
                gameState.equippedWeapon = 'Silver Knife Set';
                updateInventoryDisplay();
                message = "You equip the <span class='item'>Silver Knife Set</span>. Silver weapons are effective against vampires.";
            } else if (item === 'Reinforced Breastplate') {
                gameState.equippedArmor = 'Reinforced Breastplate';
                updateInventoryDisplay();
                message = "You equip the <span class='item'>Reinforced Breastplate</span>. It offers better protection.";
            } else if (item === 'Glowing Crystal Sword') {
                gameState.equippedWeapon = 'Glowing Crystal Sword';
                updateInventoryDisplay();
                message = "You equip the <span class='item'>Glowing Crystal Sword</span>. Its glow provides light and it feels powerful.";
            } else if (item === 'Daywalker History Book') {
                message = "The <span class='item'>Daywalker History Book</span> contains information about ancient vampire hunters. It might provide clues.";
            } else if (item === 'Warding Against Undead') {
                message = "The <span class='item'>Warding Against Undead</span> book contains protective spells and information about undead creatures.";
            } else if (item === 'Partial Castle Map') {
                message = "The <span class='item'>Partial Castle Map</span> shows the layout of the first floor and some secret passages.";
            } else if (item === 'Valerius\' Letter') {
                message = "The <span class='item'>Valerius' Letter</span> mentions a 'ghost who guards the way with music' and that 'only those who understand the melody may pass'.";
            } else if (item === 'Ruby Pendant Necklace') {
                message = "The <span class='item'>Ruby Pendant Necklace</span> feels warm to the touch. It might have magical properties.";
            } else if (item === 'Perfume of Eternal Youth') {
                const healAmount = rollDice(1, 4);
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>Perfume of Eternal Youth</span> and feel slightly rejuvenated, restoring ${actualHeal} Health!`;
                updateStatsDisplay();
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Sword' && 
                gameState.equippedArmor === 'Leather Armor') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section (none in Level 4, but keeping structure)
            const isCombatRound = false;
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    const goldReward = Math.floor(Math.random() * 30) + 20;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find <span class="gold">${goldReward} Gold</span> on the remains.`;
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    if (typeof choice.requirement === 'function') {
                        return choice.requirement();
                    }
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue exploring the keep";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                let weaponType = gameState.equippedWeapon;
                
                if (weaponType.includes('Silver')) {
                    // Silver weapons deal extra damage to undead/vampires
                    damage = rollDice(2, 6) + 3;
                    if (combatState.enemyName.includes('Vampire')) {
                        damage += 5; // Extra vs vampires
                        resultText += `<span class="item">Your silver weapon is especially effective!</span><br>`;
                    }
                } else if (weaponType === 'Glowing Crystal Sword') {
                    damage = rollDice(3, 6); // Powerful weapon
                    resultText += `<span class="item">The glowing sword pulses with power!</span><br>`;
                } else if (weaponType === 'Ice Axe') {
                    damage = rollDice(2, 6) + 2;
                } else if (weaponType === 'Ancient Bone Dagger') {
                    damage = rollDice(2, 6) + 1;
                } else {
                    damage = rollDice(2, 6);
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                const enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('castleUndeadGameState');
                        window.location.href = 'l1.html';
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You find a hidden path around an obstacle!",
                    "You dodge a trap!",
                    "You move silently past a guard.",
                    "You climb to a high shelf and find something useful."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip and take 3 damage!",
                    "You make noise and alert nearby creatures.",
                    "You get tangled in curtains or debris.",
                    "You knock something over, making a loud noise."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 3;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 4 (this page)
                if (savedState.level === 4) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 4.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 5 with updated level
            gameState.level = 5;
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            // Redirect to level 5 (Second Floor)
            window.location.href = 'l5.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
