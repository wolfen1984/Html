    <!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hollowlands</title>
<style>
body {
    color: #fff;
    font-family: 'Courier New', monospace;
    margin: 0;
    padding: 0;
    overflow-x: auto;
    text-shadow: 0 0 5px rgba(255,255,255,0.3);
    background-image: url('bk.jpg');
    background-size: 100% 100%;  /* Forces exact dimensions */
    background-repeat: no-repeat;
    background-color: rgba(17, 17, 17, 0);
    display: flex;
    flex-direction: column;
    }

#game-container {
    max-width: 880px;
    min-height: 100vh;
    margin: 0 auto;
    position: relative;
}

#game-title {
    color: #ff0000;
    text-align: center;
    font-size: 36px;
    margin-bottom: 15px;
    text-shadow: 0 0 15px #f00, 0 0 25px #f00;
    border-bottom: 1px solid #ff0000;
    padding-bottom: 10px;
    font-weight: bold;
    letter-spacing: 3px;
    text-transform: uppercase;
    font-family: 'Arial Black', sans-serif;
}

#game-screen {
    border: 1px solid #333;
    padding: 15px;
    min-height: 150px;
    margin-bottom: 10px;
    overflow-y: auto;
    max-height: 250px;
    background-color: rgba(17, 17, 17, 0);
    font-size: 25px;
    line-height: 1.5;
    border-radius: 5px;
}

#player-stats {
    border: 1px solid #333;
    padding: 10px;
    margin-bottom: 10px;
    background-color: rgba(17, 17, 17, 0.5);
    font-size: 18px;
    border-radius: 5px;
}

.button-row {
    display: flex;
    flex-wrap: wrap;
    margin-bottom: 5px;
    gap: 5px;
    background-color: rgba(17, 17, 17, 0);
}

.game-button {
    background-color: rgba(17, 17, 17, 1);
    color: #fff;
    border: 1px solid #444;
    padding: 10px;
    margin: 0;
    flex-grow: 1;
    min-width: 100px;
    cursor: pointer;
    font-family: 'Courier New', monospace;
    font-size: 16px;
    font-weight: bold;
    border-radius: 4px;
    transition: all 0.2s;
}

.game-button:hover {
    background-color: rgba(17, 17, 17, 0.5);
    color: #f00;
    background-color: #333;
    transform: translateY(-2px);
}

.game-button:active {
    transform: translateY(0);
}

.game-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.selected {
    color: #f00;
    border-color: #f00;
}

.important {
    color: #ff0;
    font-weight: bold;
}

.enemy {
    color: #f55;
    font-size: 20px;
    font-weight: bold;
    background-color: rgba(17, 17, 17, 0.5);
}

.item {
    color: #5f5;
}

.gold {
    color: #ff0;
}

.health {
    color: #f55;
    }

#combat-screen .health {
    font-size: 20px;
    font-weight: bold;
}
    
.mana {
    color: #55f;
}

.xp {
    color: #5af;
}

.damage {
    color: #f55;
}

.heal {
    color: #5f5;
}

.critical {
    color: #f80;
    font-weight: bold;
    text-shadow: 0 0 5px #f80;
}

.debuff {
    color: #a5a;
}

#inventory-screen, #character-screen, #shop-screen, #combat-screen, #quests-screen, #class-select-screen, #talent-screen, #challenges-screen, #endgame-screen, #pets-screen, #lore-screen {
    display: none;
}

.item-info {
    border: 1px solid #333;
    padding: 10px;
    margin-top: 10px;
    background-color: rgba(17, 17, 17, 1);
    border-radius: 5px;
}

.class-warrior {
    color: #f55;
}

.class-mage {
    color: #55f;
}

.class-rogue {
    color: #5f5;
}

/* CRT effect */
body::after {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0), rgba(0, 255, 0, 0), rgba(0, 0, 255, 0));
    z-index: 100;
    pointer-events: none;
}

/* Scanlines */
body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom,
    transparent 0%,
    rgba(0, 0, 0, 0.2) 50%,
    transparent 100%);
    background-size: 100% 4px;
    z-index: 101;
    pointer-events: none;
    animation: scanline 8s linear infinite;
}

@keyframes scanline {
    0% { background-position: 0 0; }
    100% { background-position: 0 100%; }
}

/* Tooltip styles */
.tooltip {
    position: relative;
    display: inline-block;
}

.tooltip .tooltiptext {
    visibility: hidden;
    width: 200px;
    background-color: #111;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    border: 1px solid #f00;
    padding: 5px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -100px;
    opacity: 0;
    transition: opacity 0.3s;
}

.tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
}

/* Progress bar styles */
.progress-container {
    width: 100%;
    background-color: #222;
    margin: 5px 0;
    border-radius: 3px;
    overflow: hidden;
}

.progress-bar {
    height: 10px;
    background-color: #f55;
    text-align: center;
    line-height: 10px;
    color: white;
    transition: width 0.3s;
}

.health-bar {
    background-color: #f55;
}

.mana-bar {
    background-color: #55f;
}

.xp-bar {
    background-color: #5af;
}

/* Enemy health bar */
.enemy-health-container {
    width: 100%;
    background-color: #222;
    margin: 5px 0;
    border-radius: 3px;
    overflow: hidden;
}

.enemy-health-bar {
    height: 10px;
    background-color: #f55;
    text-align: center;
    line-height: 10px;
    color: white;
    transition: width 0.3s;
}

/* Status effect icons */
.status-effect {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 5px;
    vertical-align: middle;
}

.poison {
    background-color: #5f0;
}

.strength {
    background-color: #f55;
}

.weakness {
    background-color: #aaf;
}

.stun {
    background-color: #ff0;
}

.regen {
    background-color: #0f0;
}

/* Quest styles */
.quest {
    border: 1px solid #333;
    padding: 10px;
    margin: 10px 0;
    background-color: #111;
    border-radius: 5px;
}

.quest-active {
    border-left: 4px solid #ff0;
    background-color: rgba(17, 17, 17, 0.5);
}

.quest-completed {
    border-left: 4px solid #0f0;
    opacity: 0.7;
}

/* Combat animations */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-5px); }
    40%, 80% { transform: translateX(5px); }
}

.combat-shake {
    animation: shake 0.5s;
}

@keyframes flash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.combat-flash {
    animation: flash 0.3s;
}

/* Area transition animation */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.fade-in {
    animation: fadeIn 0.5s;
}

/* Class selection screen */
#class-select-screen {
    text-align: center;
    padding: 20px;
}

.class-description {
    margin: 20px 0;
    padding: 15px;
    background-color: rgba(17, 17, 17, 0.5);
    border-radius: 5px;
    border: 1px solid #333;
}

.class-button {
    min-width: 150px;
    font-size: 18px;
    padding: 15px;
    margin: 5px;
}

/* Responsive adjustments */
@media (max-width: 600px) {
    .game-button {
        min-width: 80px;
        font-size: 14px;
        padding: 8px;
    }
    
    #game-title {
        font-size: 28px;
    }
    
    #game-screen, #player-stats {
        font-size: 16px;
    }
}

/* Achievement toast */
.achievement-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #222;
    border-left: 4px solid #ff0;
    padding: 15px;
    border-radius: 4px;
    box-shadow: 0 0 10px rgba(255,255,0,0.5);
    z-index: 1000;
    transform: translateX(200%);
    transition: transform 0.3s ease-out;
}

.achievement-toast.show {
    transform: translateX(0);
}

.achievement-title {
    color: #ff0;
    font-weight: bold;
    margin-bottom: 5px;
}

/* Save/Load buttons */
.save-load-buttons {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.save-load-buttons button {
    padding: 5px 15px;
    font-size: 12px;
    background-color: #333;
    border: 1px solid #444;
    color: #fff;
    border-radius: 3px;
    cursor: pointer;
}

.save-load-buttons button:hover {
    background-color: #444;
}

/* Music controls */
.music-controls, .save-load-controls {
    display: flex;
    justify-content: left;
    gap: 10px; /* Space between buttons */
    margin-bottom: 10px; /* Space below buttons, above title */
}

.music-controls button, .save-load-controls button {
    padding: 5px 15px;
    font-size: 12px;
    background-color: #333;
    border: 1px solid #444;
    color: #fff;
    border-radius: 3px;
    cursor: pointer;
    font-family: 'Courier New', monospace;
}

h1 {
    text-align: left;
    color: #fff;
    margin: 10px 0;
}

.music-controls button:hover {
    background-color: #444;
}

/* Tutorial highlight */
.tutorial-highlight {
    position: relative;
    z-index: 10;
}

.tutorial-highlight::after {
    content: "";
    position: absolute;
    top: -5px;
    left: -5px;
    right: -5px;
    bottom: -5px;
    border: 2px solid #ff0;
    border-radius: 5px;
    animation: pulse 2s infinite;
    pointer-events: none;
}

@keyframes pulse {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}

/* Class selection highlight */
.class-selected {
    transform: scale(1.05);
    box-shadow: 0 0 10px rgba(255,255,255,0.5);
}

/* Select button */
.select-button {
    min-width: 200px;
    font-size: 20px;
    padding: 15px;
    margin: 20px auto;
    display: none;
}

/* NEW STYLES FOR ENHANCEMENTS */

/* Talent tree styles */
.talent-node {
    display: inline-block;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: #333;
    margin: 10px;
    text-align: center;
    line-height: 60px;
    cursor: pointer;
    border: 2px solid #555;
    transition: all 0.3s;
}

.talent-node.available {
    border-color: #5f5;
    background-color: #222;
}

.talent-node.unlocked {
    border-color: #ff0;
    background-color: #333;
    box-shadow: 0 0 10px rgba(255,255,0,0.5);
}

.talent-node.locked {
    border-color: #555;
    background-color: #111;
    cursor: not-allowed;
}

.talent-path {
    display: flex;
    justify-content: center;
    margin: 20px 0;
}

.talent-connector {
    height: 2px;
    background-color: #555;
    margin: 0 10px;
    flex-grow: 1;
    align-self: center;
}

.talent-connector.unlocked {
    background-color: #ff0;
}

.talent-description {
    margin-top: 10px;
    padding: 10px;
    background-color: rgba(17, 17, 17, 0.7);
    border-radius: 5px;
}

/* Equipment comparison styles */
.stat-change-positive {
    color: #5f5;
}

.stat-change-negative {
    color: #f55;
}

.stat-change-neutral {
    color: #aaa;
}

.equipment-comparison {
    border: 1px solid #333;
    padding: 10px;
    margin: 10px 0;
    background-color: rgba(17, 17, 17, 0.7);
    border-radius: 5px;
}

/* Challenge styles */
.challenge {
    border: 1px solid #333;
    padding: 15px;
    margin: 10px 0;
    background-color: rgba(17, 17, 17, 0.7);
    border-radius: 5px;
}

.challenge-daily {
    border-left: 4px solid #5af;
}

.challenge-weekly {
    border-left: 4px solid #f80;
}

.challenge-completed {
    opacity: 0.7;
    border-left: 4px solid #5f5;
}

.challenge-reward {
    color: #ff0;
    font-weight: bold;
}

/* Specialization styles */
.specialization-option {
    border: 1px solid #333;
    padding: 15px;
    margin: 10px 0;
    background-color: rgba(17, 17, 17, 0.7);
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s;
}

.specialization-option:hover {
    background-color: rgba(17, 17, 17, 0.9);
    transform: translateY(-2px);
}

.specialization-option.selected {
    border-color: #ff0;
    box-shadow: 0 0 10px rgba(255,255,0,0.5);
}

/* Visual feedback animations */
@keyframes levelUp {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.level-up {
    animation: levelUp 0.5s ease-in-out;
}

@keyframes itemGlow {
    0% { box-shadow: 0 0 5px rgba(255,255,255,0.5); }
    50% { box-shadow: 0 0 15px rgba(255,255,255,0.8); }
    100% { box-shadow: 0 0 5px rgba(255,255,255,0.5); }
}

.item-glow {
    animation: itemGlow 1s infinite;
}

@keyframes talentUnlock {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.talent-unlock {
    animation: talentUnlock 0.5s ease-in-out;
}

/* Specialization colors */
.spec-berserker {
    color: #f55;
}

.spec-paladin {
    color: #ff0;
}

.spec-guardian {
    color: #5af;
}

.spec-archmage {
    color: #55f;
}

.spec-necromancer {
    color: #a5a;
}

.spec-elementalist {
    color: #f80;
}

.spec-assassin {
    color: #a55;
}

.spec-shadowdancer {
    color: #5a5;
}

.spec-bard {
    color: #ff5;
}

/* NEW: Pet and Lore Styles */
.pet-card {
    border: 1px solid #333;
    padding: 15px;
    margin: 10px 0;
    background-color: rgba(17, 17, 17, 0.7);
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s;
}

.pet-card:hover {
    background-color: rgba(17, 17, 17, 0.9);
    transform: translateY(-2px);
}

.pet-card.active {
    border-color: #ff0;
    box-shadow: 0 0 10px rgba(255,255,0,0.5);
}

.pet-stats {
    font-size: 14px;
    color: #aaa;
}

.lore-item {
    border: 1px solid #333;
    padding: 15px;
    margin: 10px 0;
    background-color: rgba(17, 17, 17, 0.7);
    border-radius: 5px;
    cursor: pointer;
}

.lore-item.unread {
    border-left: 4px solid #5af;
}

.lore-item.read {
    border-left: 4px solid #5f5;
    opacity: 0.8;
}

.lore-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    background-color: rgba(17, 17, 17, 0.9);
    margin-top: 10px;
    padding: 0 15px;
    border-radius: 5px;
}

.lore-content.expanded {
    max-height: 500px;
    padding: 15px;
}

.raid-boss {
    border: 2px solid #f00;
    padding: 20px;
    margin: 15px 0;
    background-color: rgba(17, 17, 17, 0.8);
    border-radius: 5px;
    text-align: center;
}

.raid-boss.defeated {
    border-color: #5f5;
    opacity: 0.7;
}

.dungeon-floor {
    border: 1px solid #333;
    padding: 15px;
    margin: 10px 0;
    background-color: rgba(17, 17, 17, 0.7);
    border-radius: 5px;
    cursor: pointer;
}

.dungeon-floor.completed {
    border-left: 4px solid #5f5;
}

.dungeon-floor.available {
    border-left: 4px solid #ff0;
}

.dungeon-floor.locked {
    border-left: 4px solid #f55;
    opacity: 0.6;
    cursor: not-allowed;
}

.prestige-option {
    border: 1px solid #333;
    padding: 20px;
    margin: 15px 0;
    background-color: rgba(17, 17, 17, 0.7);
    border-radius: 5px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.prestige-option:hover {
    background-color: rgba(17, 17, 17, 0.9);
    transform: translateY(-2px);
}

.prestige-option.available {
    border-color: #ff0;
    box-shadow: 0 0 15px rgba(255,255,0,0.3);
}

.set-item {
    border: 1px solid #5af;
    padding: 10px;
    margin: 5px 0;
    background-color: rgba(17, 17, 17, 0.8);
    border-radius: 5px;
}

.set-bonus {
    color: #5af;
    font-weight: bold;
    margin-top: 5px;
}

.legendary-item {
    border: 2px solid #f80;
    padding: 15px;
    margin: 10px 0;
    background: linear-gradient(45deg, rgba(136, 68, 0, 0.3), rgba(255, 136, 0, 0.3));
    border-radius: 5px;
    animation: itemGlow 2s infinite;
}

.arena-wave {
    border: 1px solid #333;
    padding: 15px;
    margin: 10px 0;
    background-color: rgba(17, 17, 17, 0.7);
    border-radius: 5px;
    text-align: center;
}

.arena-wave.completed {
    border-left: 4px solid #5f5;
}

.arena-wave.current {
    border-left: 4px solid #ff0;
    background-color: rgba(17, 17, 17, 0.9);
}
</style>
</head>
<body>
<div id="game-container">
    <div class="save-load-buttons">
        <button onclick="saveGame()">SAVE</button>
        <button onclick="loadGame()">LOAD</button>
    </div>
    
    <div class="music-controls">
        <button onclick="toggleMusic()">TOGGLE MUSIC</button>
    </div>
    
    <div id="game-title">HOLLOWLANDS</div>

    <!-- Main Game Screen -->
    <div id="game-screen"></div>

    <!-- Player Stats -->
    <div id="player-stats"></div>

    <!-- Main Menu Buttons -->
    <div id="main-buttons" class="button-row" style="display: none;">
        <button class="game-button tutorial-highlight" onclick="showScreen('explore')">EXPLORE</button>
        <button class="game-button" onclick="showScreen('character')">CHARACTER</button>
        <button class="game-button" onclick="showScreen('inventory')">INVENTORY</button>
        <button class="game-button" onclick="showScreen('shop')">SHOP</button>
        <button class="game-button" onclick="showScreen('quests')">QUESTS</button>
        <button class="game-button" onclick="showScreen('talent')">TALENTS</button>
        <button class="game-button" onclick="showScreen('challenges')">CHALLENGES</button>
        <button class="game-button" onclick="showScreen('pets')">PETS</button>
        <button class="game-button" onclick="showScreen('lore')">LORE</button>
        <button class="game-button" onclick="showScreen('endgame')">ENDGAME</button>
    </div>

    <!-- Explore Screen -->
    <div id="explore-screen" style="display: none;">
        <div class="button-row">
            <button class="game-button" onclick="exploreArea()">EXPLORE</button>
            <button class="game-button" onclick="rest()">REST</button>
            <button class="game-button" onclick="changeArea()">MOVE AREA</button>
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Character Screen -->
    <div id="character-screen">
        <div id="character-info"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Inventory Screen -->
    <div id="inventory-screen">
        <div id="inventory-items"></div>
        <div id="item-details"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Shop Screen -->
    <div id="shop-screen">
        <div id="shop-items"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
            <button class="game-button" onclick="refreshShop()">REFRESH (50G)</button>
        </div>
    </div>

    <!-- Combat Screen -->
    <div id="combat-screen">
        <div id="combat-info"></div>
        <div id="combat-actions" class="button-row"></div>
    </div>

    <!-- Quests Screen -->
    <div id="quests-screen">
        <div id="active-quests"></div>
        <div id="completed-quests"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Talent Screen -->
    <div id="talent-screen">
        <div id="talent-info"></div>
        <div id="talent-tree"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Challenges Screen -->
    <div id="challenges-screen">
        <div id="challenges-info"></div>
        <div id="daily-challenges"></div>
        <div id="weekly-challenges"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Pets Screen -->
    <div id="pets-screen">
        <div id="pets-info"></div>
        <div id="available-pets"></div>
        <div id="active-pet"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Lore Screen -->
    <div id="lore-screen">
        <div id="lore-collection"></div>
        <div id="lore-details"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Endgame Screen -->
    <div id="endgame-screen">
        <div id="endgame-content"></div>
        <div class="button-row">
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    </div>

    <!-- Class Selection Screen (Initial) -->
    <div id="class-select-screen">
        <h2>Choose Your Class</h2>
        <div class="button-row">
            <button class="game-button class-warrior class-button" onclick="showClassDetails('warrior')">WARRIOR</button>
            <button class="game-button class-mage class-button" onclick="showClassDetails('mage')">MAGE</button>
            <button class="game-button class-rogue class-button" onclick="showClassDetails('rogue')">ROGUE</button>
        </div>
        <div id="class-description" class="class-description">Click on a class to see details</div>
        <button id="select-class-button" class="game-button select-button" onclick="selectClass()">SELECT CLASS</button>
    </div>
</div>

<!-- Achievement Toast -->
<div id="achievement-toast" class="achievement-toast">
    <div class="achievement-title">ACHIEVEMENT UNLOCKED!</div>
    <div id="achievement-desc"></div>
</div>

<!-- Audio Elements -->
<audio id="background-music" loop>
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>
<audio id="combat-sound">
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" type="audio/mpeg">
</audio>
<audio id="victory-sound">
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" type="audio/mpeg">
</audio>

<script>
// Game State
const gameState = {
    player: {
        name: "Adventurer",
        class: null,
        specialization: null,
        level: 1,
        xp: 0,
        xpToNextLevel: 100,
        health: 100,
        maxHealth: 100,
        mana: 50,
        maxMana: 50,
        strength: 10,
        dexterity: 10,
        intelligence: 10,
        constitution: 10,
        gold: 50,
        equippedWeapon: null,
        equippedArmor: null,
        inventory: [],
        skills: [],
        currentArea: "Forest",
        inCombat: false,
        currentEnemy: null,
        buffs: [],
        debuffs: [],
        quests: {
            active: [],
            completed: []
        },
        achievements: [],
        stealth: 0, // New property for rogue stealth
        talentPoints: 0,
        talents: {},
        challenges: {
            daily: {
                completed: [],
                resetTime: Date.now() + (24 * 60 * 60 * 1000) // 24 hours from now
            },
            weekly: {
                completed: [],
                resetTime: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 days from now
            }
        },
        // NEW: Pet System
        pets: {
            owned: [],
            active: null
        },
        // NEW: Lore Collection
        lore: {
            collected: [],
            read: []
        },
        // NEW: Endgame Progress
        endgame: {
            raidProgress: {},
            dungeonFloor: 1,
            arenaWave: 0,
            prestigeLevel: 0,
            prestigePoints: 0
        },
        // NEW: Set Items
        equippedSetItems: []
    },
    areas: [
        { name: "Forest", minLevel: 1, unlocked: true, description: "A dense forest filled with low-level creatures." },
        { name: "Caves", minLevel: 3, unlocked: false, description: "Dark caves with tougher enemies and valuable minerals." },
        { name: "Ruins", minLevel: 6, unlocked: false, description: "Ancient ruins haunted by undead creatures." },
        { name: "Dungeon", minLevel: 9, unlocked: false, description: "A dangerous dungeon filled with deadly foes." },
        { name: "Abyss", minLevel: 12, unlocked: false, description: "A bottomless pit leading to the underworld." },
        { name: "Volcano", minLevel: 15, unlocked: false, description: "A fiery mountain with lava and fire creatures." },
        { name: "Sky Temple", minLevel: 18, unlocked: false, description: "A floating temple in the clouds guarded by celestial beings." },
        { name: "Frozen Wastes", minLevel: 22, unlocked: false, description: "A frozen wasteland inhabited by ice creatures." },
        { name: "Shadow Realm", minLevel: 26, unlocked: false, description: "A dark dimension where shadows come to life." },
        { name: "Celestial Palace", minLevel: 30, unlocked: false, description: "The home of the gods, filled with divine beings." }
    ],
    enemies: {
        Forest: [
            { name: "Goblin", health: 40, maxHealth: 40, damage: "8-12", xp: 25, gold: "10-20", level: 1, critChance: 0.05 },
            { name: "Wolf", health: 35, maxHealth: 35, damage: "10-14", xp: 30, gold: "15-25", level: 1, critChance: 0.1 },
            { name: "Werewolf", health: 50, maxHealth: 50, damage: "12-16", xp: 40, gold: "25-35", level: 2, critChance: 0.1 },
            { name: "Giant Spider", health: 60, maxHealth: 60, damage: "15-18", xp: 45, gold: "20-30", level: 2, poisonChance: 0.4, poisonDamage: 3 },
            { name: "Treant Sapling", health: 80, maxHealth: 80, damage: "10-15", xp: 50, gold: "15-25", level: 3, regen: 3 }
        ],
        Caves: [
            { name: "Cave Spider", health: 70, maxHealth: 70, damage: "15-20", xp: 60, gold: "30-40", level: 3, poisonChance: 0.3, poisonDamage: 3 },
            { name: "Skeleton", health: 80, maxHealth: 80, damage: "18-22", xp: 70, gold: "40-50", level: 4, armor: 5 },
            { name: "Troll", health: 120, maxHealth: 120, damage: "20-25", xp: 90, gold: "60-70", level: 5, regen: 5 },
            { name: "Dark Acolyte", health: 90, maxHealth: 90, damage: "15-18", xp: 80, gold: "50-60", level: 4, magicDamage: 15 },
            { name: "Cave Bear", health: 150, maxHealth: 150, damage: "25-30", xp: 100, gold: "70-80", level: 5 }
        ],
        Ruins: [
            { name: "Wraith", health: 100, maxHealth: 100, damage: "25-30", xp: 120, gold: "80-90", level: 6, magicResist: 15 },
            { name: "Stone Golem", health: 180, maxHealth: 180, damage: "30-35", xp: 150, gold: "100-120", level: 7, armor: 15 },
            { name: "Necromancer", health: 110, maxHealth: 110, damage: "35-40", xp: 180, gold: "120-140", level: 8, magicDamage: 20 },
            { name: "Death Knight", health: 200, maxHealth: 200, damage: "40-45", xp: 200, gold: "150-170", level: 9, lifesteal: 0.1 },
            { name: "Ancient Guardian", health: 250, maxHealth: 250, damage: "35-40", xp: 220, gold: "180-200", level: 10, armor: 20 }
        ],
        Dungeon: [
            { name: "Hellhound", health: 150, maxHealth: 150, damage: "40-45", xp: 220, gold: "150-170", level: 9, fireDamage: 10 },
            { name: "Dark Knight", health: 250, maxHealth: 250, damage: "45-50", xp: 280, gold: "200-220", level: 10, armor: 20 },
            { name: "Demon Spawn", health: 300, maxHealth: 300, damage: "50-60", xp: 350, gold: "250-270", level: 12, lifesteal: 0.2 },
            { name: "Succubus", health: 200, maxHealth: 200, damage: "30-40", xp: 300, gold: "180-200", level: 11, charmChance: 0.3 },
            { name: "Beholder", health: 350, maxHealth: 350, damage: "55-65", xp: 400, gold: "300-350", level: 13, magicDamage: 30 }
        ],
        Abyss: [
            { name: "Elder Demon", health: 600, maxHealth: 600, damage: "60-70", xp: 600, gold: "500-600", level: 15, magicResist: 30, armor: 25 },
            { name: "Abyssal Horror", health: 1000, maxHealth: 1000, damage: "70-80", xp: 900, gold: "800-900", level: 20, regen: 20 },
            { name: "Void Reaver", health: 1200, maxHealth: 1200, damage: "75-85", xp: 1100, gold: "1000-1200", level: 22, voidDamage: 25 },
            { name: "Voidwalker", health: 800, maxHealth: 800, damage: "65-75", xp: 700, gold: "600-700", level: 18, magicDamage: 40 },
            { name: "Dread Titan", health: 2000, maxHealth: 2000, damage: "90-110", xp: 2000, gold: "1500-1800", level: 30, armor: 30 }
        ],
        Volcano: [
            { name: "Fire Elemental", health: 700, maxHealth: 700, damage: "70-80", xp: 800, gold: "700-800", level: 20, fireDamage: 25 },
            { name: "Lava Giant", health: 1200, maxHealth: 1200, damage: "80-90", xp: 1000, gold: "900-1000", level: 22, armor: 25 },
            { name: "Magma Wyrm", health: 1500, maxHealth: 1500, damage: "90-100", xp: 1200, gold: "1100-1300", level: 25, fireDamage: 30 },
            { name: "Phoenix", health: 1800, maxHealth: 1800, damage: "100-120", xp: 1500, gold: "1400-1600", level: 28, regen: 50 }
        ],
        "Sky Temple": [
            { name: "Storm Drake", health: 2000, maxHealth: 2000, damage: "110-130", xp: 1800, gold: "1600-1800", level: 30, lightningDamage: 40 },
            { name: "Celestial Guardian", health: 2500, maxHealth: 2500, damage: "120-140", xp: 2200, gold: "2000-2200", level: 35, armor: 35 },
            { name: "Archon", health: 3000, maxHealth: 3000, damage: "140-160", xp: 2500, gold: "2300-2500", level: 40, magicDamage: 50 },
            { name: "Elder Dragon", health: 5000, maxHealth: 5000, damage: "180-200", xp: 3000, gold: "3000-3500", level: 50, fireDamage: 60 }
        ],
        "Frozen Wastes": [
            { name: "Ice Troll", health: 2200, maxHealth: 2200, damage: "130-150", xp: 2400, gold: "2200-2400", level: 32, frostDamage: 30 },
            { name: "Frost Giant", health: 3000, maxHealth: 3000, damage: "150-170", xp: 2800, gold: "2600-2800", level: 36, armor: 40 },
            { name: "Ice Elemental", health: 2500, maxHealth: 2500, damage: "140-160", xp: 2600, gold: "2400-2600", level: 34, freezeChance: 0.2 },
            { name: "Yeti", health: 3500, maxHealth: 3500, damage: "160-180", xp: 3200, gold: "3000-3200", level: 38 }
        ],
        "Shadow Realm": [
            { name: "Shadow Beast", health: 4000, maxHealth: 4000, damage: "180-200", xp: 3600, gold: "3400-3600", level: 42, lifesteal: 0.25 },
            { name: "Nightmare", health: 4500, maxHealth: 4500, damage: "200-220", xp: 4000, gold: "3800-4000", level: 45, fearChance: 0.3 },
            { name: "Dark Phantom", health: 3800, maxHealth: 3800, damage: "190-210", xp: 3800, gold: "3600-3800", level: 43, magicResist: 50 },
            { name: "Void Specter", health: 5000, maxHealth: 5000, damage: "220-240", xp: 4500, gold: "4200-4500", level: 48, voidDamage: 40 }
        ],
        "Celestial Palace": [
            { name: "Seraph", health: 6000, maxHealth: 6000, damage: "250-270", xp: 5000, gold: "5000-5500", level: 55, holyDamage: 50 },
            { name: "Celestial Champion", health: 7000, maxHealth: 7000, damage: "270-290", xp: 5500, gold: "5500-6000", level: 58, armor: 50 },
            { name: "Divine Herald", health: 6500, maxHealth: 6500, damage: "260-280", xp: 5200, gold: "5200-5700", level: 56, magicDamage: 60 },
            { name: "God King", health: 10000, maxHealth: 10000, damage: "300-350", xp: 10000, gold: "10000-12000", level: 60, regen: 100 }
        ]
    },
    items: {
        weapons: [
            { id: 1, name: "Rusty Sword", type: "weapon", damage: "8-12", value: 15, level: 1 },
            { id: 2, name: "Iron Axe", type: "weapon", damage: "12-16", value: 35, level: 2 },
            { id: 3, name: "Steel Longsword", type: "weapon", damage: "16-20", value: 70, level: 3 },
            { id: 4, name: "Enchanted Blade", type: "weapon", damage: "22-28", value: 150, level: 5, critChance: 0.1 },
            { id: 5, name: "Demon Edge", type: "weapon", damage: "35-45", value: 300, level: 8, lifesteal: 0.1 },
            { id: 6, name: "Staff of Fire", type: "weapon", damage: "12-18", magicDamage: 20, value: 80, level: 3 },
            { id: 7, name: "Arcane Scepter", type: "weapon", damage: "8-14", magicDamage: 30, value: 150, level: 5, manaRegen: 5 },
            { id: 8, name: "Dagger of Shadows", type: "weapon", damage: "10-15", value: 40, level: 1, critChance: 0.15 },
            { id: 9, name: "Assassin's Blade", type: "weapon", damage: "18-24", value: 100, level: 3, backstabDamage: 1.5 },
            { id: 20, name: "Frostbrand", type: "weapon", damage: "30-40", value: 250, level: 7, frostDamage: 15, slowChance: 0.3 },
            { id: 21, name: "Dragonbone Bow", type: "weapon", damage: "25-35", value: 200, level: 6, critChance: 0.2, armorPen: 10 },
            { id: 22, name: "Voidreaver", type: "weapon", damage: "50-60", value: 400, level: 10, voidDamage: 25, lifesteal: 0.15 },
            { id: 23, name: "Staff of Storms", type: "weapon", damage: "15-20", magicDamage: 40, value: 300, level: 8, lightningDamage: 20 },
            { id: 24, name: "Bloodthirster", type: "weapon", damage: "45-55", value: 350, level: 9, lifesteal: 0.25, critChance: 0.15 },
            { id: 25, name: "Titan's Hammer", type: "weapon", damage: "60-70", value: 450, level: 12, stunChance: 0.2, armorPen: 15 },
            { id: 41, name: "Celestial Blade", type: "weapon", damage: "70-80", value: 600, level: 15, holyDamage: 30, critChance: 0.25 },
            { id: 42, name: "Shadowfang", type: "weapon", damage: "55-65", value: 500, level: 14, shadowDamage: 25, lifesteal: 0.2 },
            { id: 43, name: "Frostmourne", type: "weapon", damage: "65-75", value: 550, level: 16, frostDamage: 35, freezeChance: 0.15 },
            { id: 44, name: "Staff of the Archmage", type: "weapon", damage: "20-30", magicDamage: 60, value: 700, level: 18, manaRegen: 15 },
            { id: 45, name: "Godslayer", type: "weapon", damage: "90-100", value: 1000, level: 20, armorPen: 30, divineSlayer: true },
            // NEW: Legendary Weapons
            { id: 100, name: "Soul Reaver", type: "weapon", rarity: "legendary", damage: "120-140", value: 5000, level: 25, lifesteal: 0.3, soulHarvest: true, set: "Reaver" },
            { id: 101, name: "Eternal Frost", type: "weapon", rarity: "legendary", damage: "110-130", value: 4500, level: 25, frostDamage: 50, freezeChance: 0.25, set: "Frostborn" },
            { id: 102, name: "Inferno's Wrath", type: "weapon", rarity: "legendary", damage: "130-150", value: 5500, level: 25, fireDamage: 60, burning: true, set: "Pyromancer" }
        ],
        armor: [
            { id: 10, name: "Leather Armor", type: "armor", defense: 8, value: 30, level: 1 },
            { id: 11, name: "Chainmail", type: "armor", defense: 15, value: 70, level: 2 },
            { id: 12, name: "Plate Armor", type: "armor", defense: 25, value: 150, level: 4, blockChance: 0.1 },
            { id: 13, name: "Mage Robes", type: "armor", defense: 12, magicResist: 20, value: 90, level: 3, manaRegen: 3 },
            { id: 14, name: "Shadow Cloak", type: "armor", defense: 10, value: 60, level: 2, dodgeChance: 0.15, stealthBonus: 1 },
            { id: 26, name: "Dragon Scale Armor", type: "armor", defense: 35, value: 300, level: 8, fireResist: 25 },
            { id: 27, name: "Celestial Plate", type: "armor", defense: 40, value: 400, level: 10, magicResist: 30, healthRegen: 5 },
            { id: 28, name: "Nightstalker Garb", type: "armor", defense: 20, value: 250, level: 6, dodgeChance: 0.25, stealthBonus: 2, critChance: 0.1 },
            { id: 29, name: "Titan's Cuirass", type: "armor", defense: 50, value: 500, level: 12, blockChance: 0.2, strengthBonus: 5 },
            { id: 30, name: "Archmage's Vestments", type: "armor", defense: 20, value: 450, level: 11, magicResist: 40, manaRegen: 10 },
            { id: 46, name: "Frostforged Plate", type: "armor", defense: 55, value: 600, level: 14, frostResist: 40, healthRegen: 10 },
            { id: 47, name: "Shadowweave Cloak", type: "armor", defense: 30, value: 550, level: 13, dodgeChance: 0.3, stealthBonus: 3, shadowResist: 35 },
            { id: 48, name: "Divine Aegis", type: "armor", defense: 60, value: 800, level: 16, holyResist: 50, blockChance: 0.25 },
            { id: 49, name: "Phoenix Mantle", type: "armor", defense: 45, value: 700, level: 15, fireResist: 50, healthRegen: 15 },
            { id: 50, name: "Armor of the Gods", type: "armor", defense: 70, value: 1200, level: 20, magicResist: 60, healthRegen: 20, allResist: 20 },
            // NEW: Legendary Armor
            { id: 103, name: "Reaver's Chestplate", type: "armor", rarity: "legendary", defense: 80, value: 3000, level: 25, lifesteal: 0.1, health: 100, set: "Reaver" },
            { id: 104, name: "Frostborn Pauldrons", type: "armor", rarity: "legendary", defense: 75, value: 2800, level: 25, frostResist: 60, mana: 50, set: "Frostborn" },
            { id: 105, name: "Pyromancer's Mantle", type: "armor", rarity: "legendary", defense: 70, value: 3200, level: 25, fireResist: 70, intelligence: 10, set: "Pyromancer" }
        ],
        consumables: [
            { id: 15, name: "Health Potion", type: "consumable", effect: { health: 50 }, value: 30 },
            { id: 16, name: "Mana Potion", type: "consumable", effect: { mana: 40 }, value: 35 },
            { id: 17, name: "Elixir of Strength", type: "consumable", effect: { strength: 5 }, duration: 5, value: 70 },
            { id: 18, name: "Scroll of Fireball", type: "consumable", effect: { damage: 60 }, value: 60 },
            { id: 19, name: "Potion of Vitality", type: "consumable", effect: { maxHealth: 20 }, permanent: true, value: 100 },
            { id: 31, name: "Elixir of Dexterity", type: "consumable", effect: { dexterity: 5 }, duration: 5, value: 70 },
            { id: 32, name: "Elixir of Intelligence", type: "consumable", effect: { intelligence: 5 }, duration: 5, value: 70 },
            { id: 33, name: "Potion of Invisibility", type: "consumable", effect: { stealth: 3 }, value: 120 },
            { id: 34, name: "Scroll of Lightning", type: "consumable", effect: { damage: 80 }, value: 80 },
            { id: 35, name: "Phoenix Down", type: "consumable", effect: { revive: true }, value: 200 },
            { id: 51, name: "Elixir of Constitution", type: "consumable", effect: { constitution: 5 }, duration: 5, value: 70 },
            { id: 52, name: "Potion of Invulnerability", type: "consumable", effect: { damageReduction: 0.5 }, duration: 3, value: 150 },
            { id: 53, name: "Scroll of Meteor", type: "consumable", effect: { damage: 150 }, value: 200 },
            { id: 54, name: "Elixir of the Gods", type: "consumable", effect: { allStats: 10 }, duration: 5, value: 300 },
            { id: 55, name: "Potion of Immortality", type: "consumable", effect: { revive: true, fullHeal: true }, value: 500 }
        ],
        questItems: [
            { id: 36, name: "Goblin Ear", type: "quest", value: 5, description: "Proof of a goblin slain" },
            { id: 37, name: "Wolf Pelt", type: "quest", value: 10, description: "Fur from a forest wolf" },
            { id: 38, name: "Ancient Relic", type: "quest", value: 100, description: "Mysterious artifact from the ruins" },
            { id: 39, name: "Demon Heart", type: "quest", value: 150, description: "Still beating with dark energy" },
            { id: 40, name: "Dragon Scale", type: "quest", value: 200, description: "Hardened scale from a mighty dragon" },
            { id: 56, name: "Phoenix Feather", type: "quest", value: 300, description: "A feather from the legendary phoenix" },
            { id: 57, name: "Celestial Shard", type: "quest", value: 400, description: "A fragment of divine energy" },
            { id: 58, name: "Shadow Essence", type: "quest", value: 350, description: "Pure darkness given form" },
            { id: 59, name: "Frozen Core", type: "quest", value: 250, description: "The heart of an ice elemental" },
            { id: 60, name: "God King's Sigil", type: "quest", value: 1000, description: "Proof of defeating the divine ruler" }
        ],
        // NEW: Lore Items
        loreItems: [
            { id: 200, name: "Ancient Tome: The Hollow Wars", type: "lore", value: 0, description: "A history of the great wars that shaped the Hollowlands", content: "In the age before memory, the Hollowlands were whole and vibrant. The Great Sundering tore the world asunder, creating the fractured realms we know today. This tome details the battles between the Titans of Light and the Shadows that sought to consume all..." },
            { id: 201, name: "Scroll of the First Mages", type: "lore", value: 0, description: "The origins of arcane magic", content: "The First Mages discovered the weave of reality by observing the patterns of falling leaves and flowing water. They learned to manipulate the fundamental forces of nature, giving birth to the schools of magic we practice today..." },
            { id: 202, name: "Warrior's Codex", type: "lore", value: 0, description: "The teachings of the ancient warrior clans", content: "Strength is not merely in the muscle, but in the will. The ancient clans understood that true power comes from discipline, honor, and the unbreakable spirit. These teachings have been passed down through generations of warriors..." },
            { id: 203, name: "Rogue's Folio", type: "lore", value: 0, description: "Secrets of stealth and subterfuge", content: "In the shadows, we find our strength. The art of remaining unseen is not merely physical - it is a state of mind. The greatest rogues move like whispers, striking like thunder, and vanishing like mist..." },
            { id: 204, name: "The God King's Prophecy", type: "lore", value: 0, description: "A prophecy about the end of days", content: "When the stars align and the moons bleed, a champion shall rise from among the mortals. This champion will either save the Hollowlands from eternal darkness or become the instrument of its destruction. The choice rests in their hands alone..." }
        ],
        // NEW: Pet Items
        petItems: [
            { id: 300, name: "Forest Sprite Egg", type: "pet", value: 500, description: "A glowing egg containing a forest spirit", petType: "sprite" },
            { id: 301, name: "Dragon Hatchling", type: "pet", value: 1000, description: "A baby dragon ready to bond", petType: "dragon" },
            { id: 302, name: "Shadow Wolf Pup", type: "pet", value: 800, description: "A wolf pup born from shadows", petType: "shadow_wolf" },
            { id: 303, name: "Celestial Owl", type: "pet", value: 1200, description: "An owl touched by celestial magic", petType: "celestial_owl" }
        ]
    },
    // NEW: Pet Definitions
    pets: {
        sprite: {
            name: "Forest Sprite",
            type: "utility",
            level: 1,
            maxLevel: 10,
            xp: 0,
            abilities: [
                { name: "Nature's Blessing", description: "Heals 5% of player's health each turn", level: 1 },
                { name: "Thorn Shield", description: "Reflects 10% damage back to attackers", level: 3 },
                { name: "Photosynthesis", description: "Restores 10 mana per turn", level: 5 }
            ],
            stats: { health: 50, damage: 5, speed: 8 }
        },
        dragon: {
            name: "Dragon Hatchling",
            type: "combat",
            level: 1,
            maxLevel: 10,
            xp: 0,
            abilities: [
                { name: "Fire Breath", description: "Deals 15 fire damage to enemy", level: 1 },
                { name: "Dragon Scales", description: "Increases player armor by 10%", level: 3 },
                { name: "Roar of Dominance", description: "Fears enemies for 1 turn", level: 5 }
            ],
            stats: { health: 100, damage: 20, speed: 5 }
        },
        shadow_wolf: {
            name: "Shadow Wolf",
            type: "combat",
            level: 1,
            maxLevel: 10,
            xp: 0,
            abilities: [
                { name: "Shadow Bite", description: "Deals 12 damage and reduces enemy accuracy", level: 1 },
                { name: "Pack Tactics", description: "Increases player critical chance by 5%", level: 3 },
                { name: "Lunar Howl", description: "Heals player for 20 health", level: 5 }
            ],
            stats: { health: 80, damage: 15, speed: 10 }
        },
        celestial_owl: {
            name: "Celestial Owl",
            type: "utility",
            level: 1,
            maxLevel: 10,
            xp: 0,
            abilities: [
                { name: "Wisdom's Light", description: "Increases player intelligence by 5", level: 1 },
                { name: "Starlight Beam", description: "Deals 25 magic damage to enemy", level: 3 },
                { name: "Celestial Guidance", description: "Increases gold and XP gain by 15%", level: 5 }
            ],
            stats: { health: 60, damage: 8, speed: 12 }
        }
    },
    // NEW: Set Bonuses
    itemSets: {
        "Reaver": {
            2: { lifesteal: 0.1, strength: 10 },
            3: { health: 200, damage: 0.15 }
        },
        "Frostborn": {
            2: { frostDamage: 25, intelligence: 10 },
            3: { mana: 100, spellPower: 0.2 }
        },
        "Pyromancer": {
            2: { fireDamage: 30, critChance: 0.1 },
            3: { allResist: 25, damage: 0.25 }
        }
    },
    shopItems: [],
    gameLog: [], // Empty array to start
    classDescriptions: {
        warrior: "The Warrior excels in close combat with high health and strength. Can wear heavy armor and wield powerful weapons. Starts with higher health and strength but lower mana. Skills include Taunt and Battle Cry.",
        mage: "The Mage harnesses arcane power to cast devastating spells. High intelligence boosts magical damage. Starts with powerful spells but lower health and armor. Skills include Fireball and Mana Shield.",
        rogue: "The Rogue specializes in stealth and precision strikes. High dexterity increases critical hit chance and dodge. Starts with light armor and fast weapons. Skills include Backstab and Vanish."
    },
    classSkills: {
        warrior: [
            { name: "Taunt", cost: 10, description: "Forces enemy to focus on you, reducing their damage by 30% for 3 turns" },
            { name: "Battle Cry", cost: 15, description: "Increases your strength by 5 for 5 turns" },
            { name: "Shield Slam", cost: 20, damageMultiplier: 1.5, description: "Powerful attack that stuns the enemy for 1 turn", stunChance: 0.3 },
            { name: "Last Stand", cost: 30, description: "When below 30% health, doubles your damage and reduces incoming damage by 50% for 3 turns" }
        ],
        mage: [
            { name: "Fireball", cost: 20, damage: 40, description: "Hurls a fiery projectile at the enemy" },
            { name: "Mana Shield", cost: 25, description: "Absorbs 50% of damage with mana for 3 turns" },
            { name: "Arcane Blast", cost: 30, damage: 60, description: "Unleashes raw magical energy at the enemy" },
            { name: "Polymorph", cost: 40, description: "Transforms the enemy into a harmless creature for 2 turns", transformChance: 0.4 }
        ],
        rogue: [
            { name: "Backstab", cost: 15, description: "Deals 2x damage if attacking from stealth", requiresStealth: true },
            { name: "Vanish", cost: 20, description: "Enter stealth for 2 turns, avoiding enemy attacks" },
            { name: "Poison Strike", cost: 25, description: "Applies a deadly poison that deals damage over time", poisonDamage: 10, duration: 3 },
            { name: "Shadowstep", cost: 30, description: "Instantly attack the enemy from stealth with guaranteed critical hit", requiresStealth: true }
        ]
    },
    // NEW: Advanced class specializations
    specializations: {
        warrior: [
            { 
                name: "Berserker", 
                description: "Focuses on raw damage and critical strikes. Gains bonus damage when health is low.",
                bonuses: { 
                    strength: 10, 
                    constitution: 5,
                    critChance: 0.1,
                    damageBonus: 0.2
                },
                skills: [
                    { name: "Frenzy", cost: 25, description: "Increases attack speed and damage by 30% for 4 turns" },
                    { name: "Bloodlust", cost: 40, description: "Heal for 50% of damage dealt for 3 turns" }
                ]
            },
            { 
                name: "Paladin", 
                description: "Holy warrior with healing abilities and damage resistance. Excels against undead.",
                bonuses: { 
                    strength: 5, 
                    constitution: 10,
                    intelligence: 5,
                    holyDamage: 20
                },
                skills: [
                    { name: "Holy Light", cost: 30, description: "Heal yourself for 100 health and damage undead for 50" },
                    { name: "Divine Shield", cost: 40, description: "Become immune to damage for 1 turn" }
                ]
            },
            { 
                name: "Guardian", 
                description: "Defensive specialist with high armor and threat generation. Protects allies.",
                bonuses: { 
                    constitution: 15, 
                    strength: 5,
                    armor: 20,
                    blockChance: 0.15
                },
                skills: [
                    { name: "Shield Wall", cost: 30, description: "Reduce all damage taken by 75% for 2 turns" },
                    { name: "Challenging Shout", cost: 25, description: "Force all enemies to attack you for 3 turns" }
                ]
            }
        ],
        mage: [
            { 
                name: "Archmage", 
                description: "Master of all arcane arts with powerful area of effect spells.",
                bonuses: { 
                    intelligence: 15, 
                    maxMana: 50,
                    spellPower: 0.2
                },
                skills: [
                    { name: "Arcane Explosion", cost: 40, description: "Deal 80 damage to all enemies" },
                    { name: "Time Warp", cost: 60, description: "Take an extra turn immediately" }
                ]
            },
            { 
                name: "Necromancer", 
                description: "Commands dark magic and undead minions. Drains life from enemies.",
                bonuses: { 
                    intelligence: 10, 
                    constitution: 5,
                    lifesteal: 0.1,
                    shadowDamage: 25
                },
                skills: [
                    { name: "Raise Dead", cost: 50, description: "Summon a skeleton to fight for you for 5 turns" },
                    { name: "Life Drain", cost: 30, description: "Drain 60 health from an enemy and heal yourself" }
                ]
            },
            { 
                name: "Elementalist", 
                description: "Wielder of elemental forces with fire, frost, and lightning spells.",
                bonuses: { 
                    intelligence: 10, 
                    dexterity: 5,
                    fireDamage: 15,
                    frostDamage: 15,
                    lightningDamage: 15
                },
                skills: [
                    { name: "Chain Lightning", cost: 35, description: "Deal 70 damage that jumps to 2 additional enemies" },
                    { name: "Elemental Mastery", cost: 50, description: "Double all elemental damage for 3 turns" }
                ]
            }
        ],
        rogue: [
            { 
                name: "Assassin", 
                description: "Master of stealth and single-target elimination with deadly critical strikes.",
                bonuses: { 
                    dexterity: 15, 
                    strength: 5,
                    critChance: 0.15,
                    backstabDamage: 0.5
                },
                skills: [
                    { name: "Death Mark", cost: 50, description: "Mark an enemy for death, guaranteeing a critical hit on your next attack" },
                    { name: "Blade Flurry", cost: 40, description: "Attack all enemies for 50% weapon damage" }
                ]
            },
            { 
                name: "Shadowdancer", 
                description: "Moves through shadows with enhanced stealth and mobility.",
                bonuses: { 
                    dexterity: 10, 
                    intelligence: 5,
                    stealthBonus: 2,
                    dodgeChance: 0.1
                },
                skills: [
                    { name: "Shadow Clone", cost: 45, description: "Create a clone that distracts enemies for 3 turns" },
                    { name: "Phantom Strike", cost: 35, description: "Teleport behind an enemy and attack with guaranteed critical" }
                ]
            },
            { 
                name: "Bard", 
                description: "Uses music and charm to support allies and confuse enemies.",
                bonuses: { 
                    dexterity: 10, 
                    intelligence: 10,
                    charmChance: 0.2
                },
                skills: [
                    { name: "Inspire", cost: 30, description: "Increase all stats by 5 for 4 turns" },
                    { name: "Lullaby", cost: 40, description: "Put all enemies to sleep for 2 turns" }
                ]
            }
        ]
    },
    // NEW: Talent trees for each class
    talentTrees: {
        warrior: {
            "Weapon Mastery": {
                maxPoints: 5,
                effect: "Increases weapon damage by 3% per point",
                currentPoints: 0
            },
            "Iron Skin": {
                maxPoints: 3,
                effect: "Increases armor by 5% per point",
                currentPoints: 0
            },
            "Bloodthirst": {
                maxPoints: 3,
                effect: "Grants 2% lifesteal per point",
                currentPoints: 0
            },
            "Battle Fury": {
                maxPoints: 5,
                effect: "Increases critical strike chance by 2% per point",
                currentPoints: 0
            },
            "Unbreakable": {
                maxPoints: 1,
                effect: "Once per combat, survive a killing blow with 1 health",
                currentPoints: 0
            }
        },
        mage: {
            "Arcane Focus": {
                maxPoints: 5,
                effect: "Increases spell damage by 4% per point",
                currentPoints: 0
            },
            "Mana Efficiency": {
                maxPoints: 3,
                effect: "Reduces spell cost by 10% per point",
                currentPoints: 0
            },
            "Elemental Affinity": {
                maxPoints: 5,
                effect: "Increases elemental damage by 5% per point",
                currentPoints: 0
            },
            "Spell Critical": {
                maxPoints: 3,
                effect: "Spells have 5% chance to crit for double damage per point",
                currentPoints: 0
            },
            "Arcane Mastery": {
                maxPoints: 1,
                effect: "Your spells ignore 50% of enemy magic resistance",
                currentPoints: 0
            }
        },
        rogue: {
            "Precision": {
                maxPoints: 5,
                effect: "Increases critical strike chance by 3% per point",
                currentPoints: 0
            },
            "Agility": {
                maxPoints: 5,
                effect: "Increases dodge chance by 2% per point",
                currentPoints: 0
            },
            "Deadly Poison": {
                maxPoints: 3,
                effect: "Increases poison damage by 5 per point",
                currentPoints: 0
            },
            "Shadow Arts": {
                maxPoints: 3,
                effect: "Increases stealth duration by 1 turn per point",
                currentPoints: 0
            },
            "Assassinate": {
                maxPoints: 1,
                effect: "Your first attack from stealth deals triple damage",
                currentPoints: 0
            }
        }
    },
    // NEW: Daily and weekly challenges
    challenges: {
        daily: [
            {
                id: 1,
                name: "Forest Explorer",
                description: "Defeat 10 enemies in the Forest",
                objective: { type: "kill", area: "Forest", count: 10, current: 0 },
                reward: { gold: 200, xp: 300 }
            },
            {
                id: 2,
                name: "Treasure Hunter",
                description: "Collect 500 gold",
                objective: { type: "collect", target: "gold", count: 500, current: 0 },
                reward: { gold: 100, xp: 200 }
            },
            {
                id: 3,
                name: "Skill Master",
                description: "Use class skills 5 times",
                objective: { type: "use", target: "skills", count: 5, current: 0 },
                reward: { gold: 150, xp: 250 }
            }
        ],
        weekly: [
            {
                id: 1,
                name: "Boss Slayer",
                description: "Defeat 3 area bosses",
                objective: { type: "kill", target: "boss", count: 3, current: 0 },
                reward: { gold: 1000, xp: 1500, item: 54 } // Elixir of the Gods
            },
            {
                id: 2,
                name: "Quest Champion",
                description: "Complete 5 quests",
                objective: { type: "complete", target: "quests", count: 5, current: 0 },
                reward: { gold: 800, xp: 1200 }
            },
            {
                id: 3,
                name: "Master Adventurer",
                description: "Reach level 10",
                objective: { type: "reach", target: "level", count: 10, current: 0 },
                reward: { gold: 1500, xp: 2000, item: 29 } // Titan's Cuirass
            }
        ]
    },
    // NEW: Endgame Content
    endgameContent: {
        raids: [
            {
                id: 1,
                name: "Titan's Fall",
                description: "Face the ancient titans in their crumbling fortress",
                requiredLevel: 25,
                bosses: [
                    { name: "Stone Titan", health: 15000, damage: "200-250", abilities: ["Earth Shatter", "Stone Skin"] },
                    { name: "Flame Titan", health: 12000, damage: "250-300", abilities: ["Meteor Shower", "Inferno"] },
                    { name: "Storm Titan", health: 18000, damage: "180-220", abilities: ["Chain Lightning", "Tempest"] }
                ],
                rewards: { gold: 5000, xp: 10000, items: [100, 103] }
            },
            {
                id: 2,
                name: "Void Incursion",
                description: "Stop the void creatures from consuming reality",
                requiredLevel: 30,
                bosses: [
                    { name: "Void Walker", health: 20000, damage: "220-270", abilities: ["Void Blast", "Reality Tear"] },
                    { name: "Ethereal Horror", health: 25000, damage: "180-230", abilities: ["Mind Shatter", "Phase Shift"] },
                    { name: "Void Titan", health: 30000, damage: "300-350", abilities: ["Oblivion Beam", "Gravity Well"] }
                ],
                rewards: { gold: 8000, xp: 15000, items: [101, 104] }
            }
        ],
        infiniteDungeon: {
            currentFloor: 1,
            floors: [
                { floor: 1, enemies: 3, boss: false, reward: { gold: 100, xp: 200 } },
                { floor: 5, enemies: 5, boss: true, reward: { gold: 500, xp: 1000 } },
                { floor: 10, enemies: 8, boss: true, reward: { gold: 1000, xp: 2000, item: "random_legendary" } }
                // More floors can be generated dynamically
            ]
        },
        arena: {
            waves: [
                { wave: 1, enemies: ["Goblin", "Wolf", "Goblin"], reward: { gold: 100, xp: 150 } },
                { wave: 5, enemies: ["Werewolf", "Giant Spider", "Treant Sapling"], reward: { gold: 300, xp: 450 } },
                { wave: 10, enemies: ["Ancient Treant"], reward: { gold: 1000, xp: 1500, item: "random_epic" } }
                // More waves can be added
            ]
        }
    },
    quests: [
        { 
            id: 1, 
            name: "Goblin Menace", 
            description: "Defeat 5 Goblins in the Forest", 
            objective: { type: "kill", target: "Goblin", count: 5, current: 0 }, 
            reward: { gold: 100, xp: 150, item: 15 }, 
            area: "Forest", 
            level: 1 
        },
        { 
            id: 2, 
            name: "Wolf Pelt Collection", 
            description: "Collect 3 Wolf Pelts (drops from Wolves)", 
            objective: { type: "collect", target: "Wolf Pelt", count: 3, current: 0 }, 
            reward: { gold: 150, xp: 200, item: 17 }, 
            area: "Forest", 
            level: 2 
        },
        { 
            id: 3, 
            name: "Werewolf Patrol", 
            description: "Eliminate 4 Werewolves in the Forest", 
            objective: { type: "kill", target: "Werewolf", count: 4, current: 0 }, 
            reward: { gold: 200, xp: 300, item: 11 }, 
            area: "Forest", 
            level: 3 
        },
        { 
            id: 4, 
            name: "Cave Exploration", 
            description: "Defeat 3 Cave Spiders and 2 Skeletons", 
            objective: { type: "kill", target: ["Cave Spider", "Skeleton"], count: [3, 2], current: [0, 0] }, 
            reward: { gold: 300, xp: 400, item: 26 }, 
            area: "Caves", 
            level: 4 
        },
        { 
            id: 5, 
            name: "Ancient Relics", 
            description: "Recover 2 Ancient Relics from the Ruins", 
            objective: { type: "collect", target: "Ancient Relic", count: 2, current: 0 }, 
            reward: { gold: 500, xp: 600, item: 22 }, 
            area: "Ruins", 
            level: 7 
        },
        { 
            id: 6, 
            name: "Demon Slayer", 
            description: "Defeat the Elder Demon in the Abyss", 
            objective: { type: "kill", target: "Elder Demon", count: 1, current: 0 }, 
            reward: { gold: 1000, xp: 1500, item: 29 }, 
            area: "Abyss", 
            level: 15 
        },
        { 
            id: 7, 
            name: "Phoenix Hunt", 
            description: "Defeat 2 Phoenixes in the Volcano", 
            objective: { type: "kill", target: "Phoenix", count: 2, current: 0 }, 
            reward: { gold: 2000, xp: 2500, item: 49 }, 
            area: "Volcano", 
            level: 28 
        },
        { 
            id: 8, 
            name: "Storm Chaser", 
            description: "Defeat the Storm Drake in the Sky Temple", 
            objective: { type: "kill", target: "Storm Drake", count: 1, current: 0 }, 
            reward: { gold: 3000, xp: 3500, item: 23 }, 
            area: "Sky Temple", 
            level: 30 
        },
        { 
            id: 9, 
            name: "Frozen Expedition", 
            description: "Collect 3 Frozen Cores from Ice Elementals", 
            objective: { type: "collect", target: "Frozen Core", count: 3, current: 0 }, 
            reward: { gold: 3500, xp: 4000, item: 46 }, 
            area: "Frozen Wastes", 
            level: 34 
        },
        { 
            id: 10, 
            name: "Shadow Purge", 
            description: "Defeat 5 Shadow Beasts in the Shadow Realm", 
            objective: { type: "kill", target: "Shadow Beast", count: 5, current: 0 }, 
            reward: { gold: 4000, xp: 4500, item: 47 }, 
            area: "Shadow Realm", 
            level: 42 
        },
        { 
            id: 11, 
            name: "Divine Challenge", 
            description: "Defeat the God King in the Celestial Palace", 
            objective: { type: "kill", target: "God King", count: 1, current: 0 }, 
            reward: { gold: 10000, xp: 10000, item: 50 }, 
            area: "Celestial Palace", 
            level: 60 
        }
    ],
    bosses: {
        "Forest": { name: "Ancient Treant", health: 300, maxHealth: 300, damage: "30-40", xp: 500, gold: "400-500", level: 5, regen: 10, area: "Forest" },
        "Caves": { name: "Cave Dragon", health: 500, maxHealth: 500, damage: "40-50", xp: 800, gold: "700-800", level: 8, fireDamage: 20, area: "Caves" },
        "Ruins": { name: "Lich King", health: 800, maxHealth: 800, damage: "50-60", xp: 1200, gold: "1000-1200", level: 12, magicDamage: 30, area: "Ruins" },
        "Dungeon": { name: "Dungeon Overlord", health: 1200, maxHealth: 1200, damage: "60-70", xp: 1800, gold: "1500-1700", level: 16, armor: 30, area: "Dungeon" },
        "Abyss": { name: "Lord of Darkness", health: 1500, maxHealth: 1500, damage: "80-100", xp: 2500, gold: "2000-2500", level: 25, lifesteal: 0.3, area: "Abyss" },
        "Volcano": { name: "Magma Lord", health: 2500, maxHealth: 2500, damage: "120-140", xp: 3000, gold: "2500-2800", level: 30, fireDamage: 50, area: "Volcano" },
        "Sky Temple": { name: "Celestial Emperor", health: 4000, maxHealth: 4000, damage: "160-180", xp: 4000, gold: "3500-4000", level: 40, magicDamage: 60, area: "Sky Temple" },
        "Frozen Wastes": { name: "Ice Queen", health: 5000, maxHealth: 5000, damage: "180-200", xp: 5000, gold: "4500-5000", level: 45, freezeChance: 0.3, area: "Frozen Wastes" },
        "Shadow Realm": { name: "Shadow King", health: 6000, maxHealth: 6000, damage: "200-220", xp: 6000, gold: "5500-6000", level: 50, shadowDamage: 60, area: "Shadow Realm" },
        "Celestial Palace": { name: "God King", health: 10000, maxHealth: 10000, damage: "300-350", xp: 10000, gold: "10000-12000", level: 60, regen: 100, area: "Celestial Palace" }
    },
    bossDefeated: {},
    achievements: [
        { id: 1, name: "First Blood", description: "Defeat your first enemy", unlocked: false },
        { id: 2, name: "Novice Adventurer", description: "Reach level 5", unlocked: false },
        { id: 3, name: "Master Adventurer", description: "Reach level 10", unlocked: false },
        { id: 4, name: "Legendary Hero", description: "Reach level 20", unlocked: false },
        { id: 5, name: "Treasure Hunter", description: "Collect 10,000 gold", unlocked: false },
        { id: 6, name: "Bane of the Forest", description: "Defeat the Ancient Treant", unlocked: false },
        { id: 7, name: "Dragon Slayer", description: "Defeat the Cave Dragon", unlocked: false },
        { id: 8, name: "Undead Destroyer", description: "Defeat the Lich King", unlocked: false },
        { id: 9, name: "Dungeon Delver", description: "Defeat the Dungeon Overlord", unlocked: false },
        { id: 10, name: "Darkness Vanquished", description: "Defeat the Lord of Darkness", unlocked: false },
        { id: 11, name: "Volcano Conqueror", description: "Defeat the Magma Lord", unlocked: false },
        { id: 12, name: "Sky Champion", description: "Defeat the Celestial Emperor", unlocked: false },
        { id: 13, name: "Frostborn", description: "Defeat the Ice Queen", unlocked: false },
        { id: 14, name: "Shadowbane", description: "Defeat the Shadow King", unlocked: false },
        { id: 15, name: "Godslayer", description: "Defeat the God King", unlocked: false },
        { id: 16, name: "Completionist", description: "Complete all quests", unlocked: false },
        { id: 17, name: "Master Collector", description: "Collect all unique items", unlocked: false },
        { id: 18, name: "Legendary Warrior", description: "Reach level 30 as a Warrior", unlocked: false },
        { id: 19, name: "Archmage", description: "Reach level 30 as a Mage", unlocked: false },
        { id: 20, name: "Shadowmaster", description: "Reach level 30 as a Rogue", unlocked: false },
        // NEW: Specialization achievements
        { id: 21, name: "Berserker's Rage", description: "Unlock the Berserker specialization", unlocked: false },
        { id: 22, name: "Holy Champion", description: "Unlock the Paladin specialization", unlocked: false },
        { id: 23, name: "Immovable Object", description: "Unlock the Guardian specialization", unlocked: false },
        { id: 24, name: "Arcane Master", description: "Unlock the Archmage specialization", unlocked: false },
        { id: 25, name: "Master of Death", description: "Unlock the Necromancer specialization", unlocked: false },
        { id: 26, name: "Elemental Lord", description: "Unlock the Elementalist specialization", unlocked: false },
        { id: 27, name: "Silent Death", description: "Unlock the Assassin specialization", unlocked: false },
        { id: 28, name: "Shadow Walker", description: "Unlock the Shadowdancer specialization", unlocked: false },
        { id: 29, name: "Master Performer", description: "Unlock the Bard specialization", unlocked: false },
        { id: 30, name: "Talent Master", description: "Unlock 10 talent points", unlocked: false },
        // NEW: Pet and Endgame Achievements
        { id: 31, name: "Pet Lover", description: "Collect your first pet", unlocked: false },
        { id: 32, name: "Master Trainer", description: "Level a pet to maximum level", unlocked: false },
        { id: 33, name: "Lore Master", description: "Collect all lore items", unlocked: false },
        { id: 34, name: "Raider", description: "Complete your first raid", unlocked: false },
        { id: 35, name: "Dungeon Master", description: "Reach floor 100 in the Infinite Dungeon", unlocked: false },
        { id: 36, name: "Arena Champion", description: "Complete wave 50 in the Arena", unlocked: false },
        { id: 37, name: "Prestigious", description: "Prestige for the first time", unlocked: false },
        { id: 38, name: "Set Collector", description: "Complete a legendary item set", unlocked: false }
    ]
};

// Audio elements
const bgMusic = document.getElementById("background-music");
const combatSound = document.getElementById("combat-sound");
const victorySound = document.getElementById("victory-sound");

// Initialize the game
function initGame() {
    updateGameScreen();
    generateShopItems();
    generateQuests();
    generateChallenges();
    
    // Try to play background music (may be blocked by browser autoplay policies)
    try {
        bgMusic.volume = 0.3;
        bgMusic.play().catch(e => console.log("Autoplay prevented:", e));
    } catch (e) {
        console.log("Audio error:", e);
    }
}

// Toggle background music
function toggleMusic() {
    if (bgMusic.paused) {
        bgMusic.play();
        addToGameLog("Music enabled");
    } else {
        bgMusic.pause();
        addToGameLog("Music disabled");
    }
}

// Save game to localStorage
function saveGame() {
    try {
        localStorage.setItem("hollowlands_save", JSON.stringify(gameState));
        addToGameLog("Game saved successfully!");
        showAchievement("Game Saved", "Your progress has been saved");
    } catch (e) {
        addToGameLog("Failed to save game: " + e.message);
    }
}

// Load game from localStorage
function loadGame() {
    try {
        const savedGame = localStorage.getItem("hollowlands_save");
        if (savedGame) {
            const parsed = JSON.parse(savedGame);
            Object.assign(gameState, parsed);
            addToGameLog("Game loaded successfully!");
            updateGameScreen();
            showAchievement("Game Loaded", "Your progress has been restored");
        } else {
            addToGameLog("No saved game found");
        }
    } catch (e) {
        addToGameLog("Failed to load game: " + e.message);
    }
}

// Show achievement notification
function showAchievement(title, description) {
    const toast = document.getElementById("achievement-toast");
    const desc = document.getElementById("achievement-desc");
    
    toast.querySelector(".achievement-title").textContent = title;
    desc.textContent = description;
    
    toast.classList.add("show");
    
    setTimeout(() => {
        toast.classList.remove("show");
    }, 3000);
}

// Check for achievements
function checkAchievements() {
    const player = gameState.player;
    
    // First Blood
    if (!gameState.achievements[0].unlocked && player.quests.completed.length > 0) {
        gameState.achievements[0].unlocked = true;
        showAchievement("First Blood", "Defeat your first enemy");
    }
    
    // Level-based achievements
    if (!gameState.achievements[1].unlocked && player.level >= 5) {
        gameState.achievements[1].unlocked = true;
        showAchievement("Novice Adventurer", "Reached level 5");
    }
    
    if (!gameState.achievements[2].unlocked && player.level >= 10) {
        gameState.achievements[2].unlocked = true;
        showAchievement("Master Adventurer", "Reached level 10");
    }
    
    if (!gameState.achievements[3].unlocked && player.level >= 20) {
        gameState.achievements[3].unlocked = true;
        showAchievement("Legendary Hero", "Reached level 20");
    }
    
    // Gold achievement
    if (!gameState.achievements[4].unlocked && player.gold >= 10000) {
        gameState.achievements[4].unlocked = true;
        showAchievement("Treasure Hunter", "Collected 10,000 gold");
    }
    
    // Boss achievements
    if (!gameState.achievements[5].unlocked && gameState.bossDefeated["Forest"]) {
        gameState.achievements[5].unlocked = true;
        showAchievement("Bane of the Forest", "Defeated the Ancient Treant");
    }
    
    if (!gameState.achievements[6].unlocked && gameState.bossDefeated["Caves"]) {
        gameState.achievements[6].unlocked = true;
        showAchievement("Dragon Slayer", "Defeated the Cave Dragon");
    }
    
    if (!gameState.achievements[7].unlocked && gameState.bossDefeated["Ruins"]) {
        gameState.achievements[7].unlocked = true;
        showAchievement("Undead Destroyer", "Defeated the Lich King");
    }
    
    if (!gameState.achievements[8].unlocked && gameState.bossDefeated["Dungeon"]) {
        gameState.achievements[8].unlocked = true;
        showAchievement("Dungeon Delver", "Defeated the Dungeon Overlord");
    }
    
    if (!gameState.achievements[9].unlocked && gameState.bossDefeated["Abyss"]) {
        gameState.achievements[9].unlocked = true;
        showAchievement("Darkness Vanquished", "Defeated the Lord of Darkness");
    }

    if (!gameState.achievements[10].unlocked && gameState.bossDefeated["Volcano"]) {
        gameState.achievements[10].unlocked = true;
        showAchievement("Volcano Conqueror", "Defeated the Magma Lord");
    }

    if (!gameState.achievements[11].unlocked && gameState.bossDefeated["Sky Temple"]) {
        gameState.achievements[11].unlocked = true;
        showAchievement("Sky Champion", "Defeated the Celestial Emperor");
    }

    if (!gameState.achievements[12].unlocked && gameState.bossDefeated["Frozen Wastes"]) {
        gameState.achievements[12].unlocked = true;
        showAchievement("Frostborn", "Defeated the Ice Queen");
    }

    if (!gameState.achievements[13].unlocked && gameState.bossDefeated["Shadow Realm"]) {
        gameState.achievements[13].unlocked = true;
        showAchievement("Shadowbane", "Defeated the Shadow King");
    }

    if (!gameState.achievements[14].unlocked && gameState.bossDefeated["Celestial Palace"]) {
        gameState.achievements[14].unlocked = true;
        showAchievement("Godslayer", "Defeated the God King");
    }

    // Completionist achievement
    if (!gameState.achievements[15].unlocked && 
        gameState.quests.every(q => gameState.player.quests.completed.some(cq => cq.id === q.id))) {
        gameState.achievements[15].unlocked = true;
        showAchievement("Completionist", "Completed all quests");
    }

    // Class-specific achievements
    if (!gameState.achievements[16].unlocked && player.level >= 30 && player.class === 'warrior') {
        gameState.achievements[16].unlocked = true;
        showAchievement("Legendary Warrior", "Reached level 30 as a Warrior");
    }

    if (!gameState.achievements[17].unlocked && player.level >= 30 && player.class === 'mage') {
        gameState.achievements[17].unlocked = true;
        showAchievement("Archmage", "Reached level 30 as a Mage");
    }

    if (!gameState.achievements[18].unlocked && player.level >= 30 && player.class === 'rogue') {
        gameState.achievements[18].unlocked = true;
        showAchievement("Shadowmaster", "Reached level 30 as a Rogue");
    }

    // Specialization achievements
    if (!gameState.achievements[20].unlocked && player.specialization === 'Berserker') {
        gameState.achievements[20].unlocked = true;
        showAchievement("Berserker's Rage", "Unlocked the Berserker specialization");
    }

    if (!gameState.achievements[21].unlocked && player.specialization === 'Paladin') {
        gameState.achievements[21].unlocked = true;
        showAchievement("Holy Champion", "Unlocked the Paladin specialization");
    }

    if (!gameState.achievements[22].unlocked && player.specialization === 'Guardian') {
        gameState.achievements[22].unlocked = true;
        showAchievement("Immovable Object", "Unlocked the Guardian specialization");
    }

    if (!gameState.achievements[23].unlocked && player.specialization === 'Archmage') {
        gameState.achievements[23].unlocked = true;
        showAchievement("Arcane Master", "Unlocked the Archmage specialization");
    }

    if (!gameState.achievements[24].unlocked && player.specialization === 'Necromancer') {
        gameState.achievements[24].unlocked = true;
        showAchievement("Master of Death", "Unlocked the Necromancer specialization");
    }

    if (!gameState.achievements[25].unlocked && player.specialization === 'Elementalist') {
        gameState.achievements[25].unlocked = true;
        showAchievement("Elemental Lord", "Unlocked the Elementalist specialization");
    }

    if (!gameState.achievements[26].unlocked && player.specialization === 'Assassin') {
        gameState.achievements[26].unlocked = true;
        showAchievement("Silent Death", "Unlocked the Assassin specialization");
    }

    if (!gameState.achievements[27].unlocked && player.specialization === 'Shadowdancer') {
        gameState.achievements[27].unlocked = true;
        showAchievement("Shadow Walker", "Unlocked the Shadowdancer specialization");
    }

    if (!gameState.achievements[28].unlocked && player.specialization === 'Bard') {
        gameState.achievements[28].unlocked = true;
        showAchievement("Master Performer", "Unlocked the Bard specialization");
    }

    // Talent achievement
    if (!gameState.achievements[29].unlocked && player.talentPoints >= 10) {
        gameState.achievements[29].unlocked = true;
        showAchievement("Talent Master", "Unlocked 10 talent points");
    }

    // NEW: Pet achievements
    if (!gameState.achievements[30].unlocked && player.pets.owned.length > 0) {
        gameState.achievements[30].unlocked = true;
        showAchievement("Pet Lover", "Collected your first pet");
    }

    // NEW: Lore achievement
    if (!gameState.achievements[32].unlocked && player.lore.collected.length >= Object.keys(gameState.items.loreItems).length) {
        gameState.achievements[32].unlocked = true;
        showAchievement("Lore Master", "Collected all lore items");
    }

    // NEW: Set achievement
    const hasCompleteSet = Object.values(gameState.itemSets).some(set => {
        const setItems = player.inventory.filter(item => item.set && gameState.itemSets[item.set]);
        const setCounts = {};
        setItems.forEach(item => {
            setCounts[item.set] = (setCounts[item.set] || 0) + 1;
        });
        return Object.values(setCounts).some(count => count >= 3);
    });
    
    if (!gameState.achievements[37].unlocked && hasCompleteSet) {
        gameState.achievements[37].unlocked = true;
        showAchievement("Set Collector", "Completed a legendary item set");
    }
}

// Update the main game screen with the game log
function updateGameScreen() {
    const gameScreen = document.getElementById("game-screen");
    gameScreen.innerHTML = gameState.gameLog.slice(-10).join("<br>");
    gameScreen.scrollTop = gameScreen.scrollHeight;

    updatePlayerStats();
}

// Update player stats display
function updatePlayerStats() {
    const statsElement = document.getElementById("player-stats");
    const player = gameState.player;

    let statsHTML = `[${player.name}] <span class="class-${player.class}">${player.class ? player.class.toUpperCase() : ''}</span> `;
    if (player.specialization) {
        statsHTML += `<span class="spec-${player.specialization.toLowerCase()}">${player.specialization}</span> `;
    }
    statsHTML += `Lvl:${player.level} `;
    statsHTML += `<span class="health">HP:${player.health}/${player.maxHealth}</span> `;

    if (player.class === 'mage' || player.class === 'warrior' || player.class === 'rogue') {
        statsHTML += `<span class="mana">MP:${player.mana}/${player.maxMana}</span> `;
    }

    statsHTML += `<span class="xp">XP:${player.xp}/${player.xpToNextLevel}</span> `;
    statsHTML += `<span class="gold">Gold:${player.gold}</span>`;

    // Add progress bars
    statsHTML += `<div class="progress-container"><div class="progress-bar health-bar" style="width: ${(player.health / player.maxHealth) * 100}%"></div></div>`;

    if (player.class === 'mage' || player.class === 'warrior' || player.class === 'rogue') {
        statsHTML += `<div class="progress-container"><div class="progress-bar mana-bar" style="width: ${(player.mana / player.maxMana) * 100}%"></div></div>`;
    }

    statsHTML += `<div class="progress-container"><div class="progress-bar xp-bar" style="width: ${(player.xp / player.xpToNextLevel) * 100}%"></div></div>`;

    if (player.equippedWeapon) {
        statsHTML += `<br>Weapon: <span class="item">${player.equippedWeapon.name}</span> (${player.equippedWeapon.damage})`;
    }

    if (player.equippedArmor) {
        statsHTML += ` | Armor: <span class="item">${player.equippedArmor.name}</span> (Def:${player.equippedArmor.defense})`;
    }

    // Show active buffs/debuffs
    if (player.buffs.length > 0 || player.debuffs.length > 0) {
        statsHTML += `<br>Status: `;
        player.buffs.forEach(buff => {
            statsHTML += `<span class="heal">${buff.name}</span> (${buff.duration}), `;
        });
        player.debuffs.forEach(debuff => {
            statsHTML += `<span class="debuff">${debuff.name}</span> (${debuff.duration}), `;
        });
        statsHTML = statsHTML.slice(0, -2); // Remove trailing comma
    }

    // Show stealth if active
    if (player.stealth > 0) {
        statsHTML += `<br><span class="heal">Stealth: ${player.stealth} turns remaining</span>`;
    }

    // Show talent points if any
    if (player.talentPoints > 0) {
        statsHTML += `<br><span class="xp">Talent Points: ${player.talentPoints}</span>`;
    }

    // NEW: Show active pet
    if (player.pets.active) {
        const activePet = player.pets.active;
        statsHTML += `<br><span class="heal">Pet: ${activePet.name} (Lvl ${activePet.level})</span>`;
    }

    // NEW: Show prestige level
    if (player.endgame.prestigeLevel > 0) {
        statsHTML += `<br><span class="gold">Prestige: ${player.endgame.prestigeLevel}</span>`;
    }

    statsElement.innerHTML = statsHTML;
}

// Show different game screens
function showScreen(screen) {
    document.getElementById("explore-screen").style.display = "none";
    document.getElementById("character-screen").style.display = "none";
    document.getElementById("inventory-screen").style.display = "none";
    document.getElementById("shop-screen").style.display = "none";
    document.getElementById("combat-screen").style.display = "none";
    document.getElementById("quests-screen").style.display = "none";
    document.getElementById("talent-screen").style.display = "none";
    document.getElementById("challenges-screen").style.display = "none";
    document.getElementById("pets-screen").style.display = "none";
    document.getElementById("lore-screen").style.display = "none";
    document.getElementById("endgame-screen").style.display = "none";
    document.getElementById("main-buttons").style.display = "flex";

    if (screen === "explore") {
        document.getElementById("explore-screen").style.display = "block";
        addToGameLog(`You are exploring the ${gameState.player.currentArea}.`);
    } else if (screen === "character") {
        document.getElementById("character-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showCharacterScreen();
    } else if (screen === "inventory") {
        document.getElementById("inventory-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showInventory();
    } else if (screen === "shop") {
        document.getElementById("shop-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showShop();
    } else if (screen === "main") {
        // Already handled by hiding others
    } else if (screen === "combat") {
        document.getElementById("combat-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        updateCombatScreen();
    } else if (screen === "quests") {
        document.getElementById("quests-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showQuests();
    } else if (screen === "talent") {
        document.getElementById("talent-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showTalentTree();
    } else if (screen === "challenges") {
        document.getElementById("challenges-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showChallenges();
    } else if (screen === "pets") {
        document.getElementById("pets-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showPetsScreen();
    } else if (screen === "lore") {
        document.getElementById("lore-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showLoreScreen();
    } else if (screen === "endgame") {
        document.getElementById("endgame-screen").style.display = "block";
        document.getElementById("main-buttons").style.display = "none";
        showEndgameScreen();
    }

    updateGameScreen();
}

// Add message to game log
function addToGameLog(message) {
    gameState.gameLog.push(message);
    if (gameState.gameLog.length > 50) {
        gameState.gameLog.shift();
    }
    updateGameScreen();
}

// Explore area function
function exploreArea() {
    const player = gameState.player;

    // Check for boss spawn (5% chance if not already defeated)
    if (!gameState.bossDefeated[player.currentArea] && Math.random() < 0.05) {
        startBossFight();
        return;
    }

    // Chance to find combat, items, or nothing
    const roll = Math.random();

    if (roll < 0.7) { // 70% chance for combat
        startCombat();
    } else if (roll < 0.9) { // 20% chance to find item
        findItem();
    } else { // 10% chance to find nothing
        addToGameLog("You explore the area but find nothing of interest.");
    }
}

// Start a boss fight
function startBossFight() {
    const player = gameState.player;
    const boss = {...gameState.bosses[player.currentArea]};

    // Scale boss stats based on player level
    const levelDiff = player.level - boss.level;
    if (levelDiff > 0) {
        boss.health = Math.floor(boss.health * (1 + levelDiff * 0.1));
        boss.maxHealth = boss.health;
        const damageRange = boss.damage.split("-").map(Number);
        damageRange[0] = Math.floor(damageRange[0] * (1 + levelDiff * 0.1));
        damageRange[1] = Math.floor(damageRange[1] * (1 + levelDiff * 0.1));
        boss.damage = damageRange.join("-");
    }

    gameState.player.inCombat = true;
    gameState.player.currentEnemy = boss;

    addToGameLog(`<span class="enemy">A terrifying ${boss.name} (Lvl ${boss.level}) appears!</span>`);
    addToGameLog("<span class='important'>BOSS FIGHT!</span>");
    
    // Play combat music
    try {
        bgMusic.pause();
        combatSound.currentTime = 0;
        combatSound.play();
    } catch (e) {
        console.log("Audio error:", e);
    }
    
    showScreen("combat");
}

function changeArea() {
    const player = gameState.player;
    const availableAreas = gameState.areas.filter(area => area.unlocked && area.name !== player.currentArea);

    if (availableAreas.length === 0) {
        addToGameLog("No other areas are available yet. Keep leveling up!");
        return;
    }

    // Create a container for the area selection
    const areaSelection = document.createElement("div");
    areaSelection.innerHTML = "<h3>Available Areas:</h3>";
    
    availableAreas.forEach(area => {
        const areaBtn = document.createElement("button");
        areaBtn.className = "game-button";
        areaBtn.style.textAlign = "left";
        areaBtn.style.margin = "2px 0";
        areaBtn.style.padding = "5px";
        areaBtn.innerHTML = `${area.name} (Recommended Level: ${area.minLevel})<br><small>${area.description}</small>`;
        areaBtn.onclick = function() { travelToArea(area.name); };
        areaSelection.appendChild(areaBtn);
        areaSelection.appendChild(document.createElement("br"));
    });

    // Replace the explore screen content while preserving the button row
    const exploreScreen = document.getElementById("explore-screen");
    exploreScreen.innerHTML = "";
    exploreScreen.appendChild(areaSelection);
    
    // Re-add the button row
    const buttonRow = document.createElement("div");
    buttonRow.className = "button-row";
    buttonRow.innerHTML = `
        <button class="game-button" onclick="showScreen('explore')">BACK</button>
    `;
    exploreScreen.appendChild(buttonRow);
}

function travelToArea(areaName) {
    const player = gameState.player;
    player.currentArea = areaName;
    addToGameLog(`You travel to the ${areaName}.`);
    
    // Restore the original explore screen content
    document.getElementById("explore-screen").innerHTML = `
        <div class="button-row">
            <button class="game-button" onclick="exploreArea()">EXPLORE</button>
            <button class="game-button" onclick="rest()">REST</button>
            <button class="game-button" onclick="changeArea()">MOVE AREA</button>
            <button class="game-button" onclick="showScreen('main')">BACK</button>
        </div>
    `;
    
    // Add visual feedback
    document.getElementById("game-screen").classList.add("fade-in");
    setTimeout(() => {
        document.getElementById("game-screen").classList.remove("fade-in");
    }, 500);
}

// Start combat with random enemy
function startCombat() {
    const player = gameState.player;
    const areaEnemies = gameState.enemies[player.currentArea];
    const randomEnemy = {...areaEnemies[Math.floor(Math.random() * areaEnemies.length)]};

    // Scale enemy stats based on player level
    const levelDiff = player.level - randomEnemy.level;
    if (levelDiff > 0) {
        randomEnemy.health = Math.floor(randomEnemy.health * (1 + levelDiff * 0.1));
        randomEnemy.maxHealth = randomEnemy.health;
        const damageRange = randomEnemy.damage.split("-").map(Number);
        damageRange[0] = Math.floor(damageRange[0] * (1 + levelDiff * 0.1));
        damageRange[1] = Math.floor(damageRange[1] * (1 + levelDiff * 0.1));
        randomEnemy.damage = damageRange.join("-");
    }

    gameState.player.inCombat = true;
    gameState.player.currentEnemy = randomEnemy;

    addToGameLog(`<span class="enemy">A ${randomEnemy.name} (Lvl ${randomEnemy.level}) appears!</span>`);
    
    // Play combat music
    try {
        bgMusic.pause();
        combatSound.currentTime = 0;
        combatSound.play();
    } catch (e) {
        console.log("Audio error:", e);
    }
    
    showScreen("combat");
}

// Update combat screen
function updateCombatScreen() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    if (!enemy) return;

    let combatHTML = `<span class="enemy">${enemy.name} (Lvl ${enemy.level})</span><br>`;
    combatHTML += `<span class="health">HP: ${enemy.health}/${enemy.maxHealth}</span>`;
    combatHTML += `<div class="enemy-health-container"><div class="enemy-health-bar" style="width: ${(enemy.health / enemy.maxHealth) * 100}%"></div></div><br>`;

    // Show enemy special abilities
    if (enemy.poisonChance) {
        combatHTML += `<span class="debuff">Poisonous</span> `;
    }
    if (enemy.regen) {
        combatHTML += `<span class="heal">Regenerates</span> `;
    }
    if (enemy.lifesteal) {
        combatHTML += `<span class="damage">Lifesteal</span> `;
    }
    if (enemy.armor) {
        combatHTML += `<span class="important">Armored</span> `;
    }

    combatHTML += `<br><br>What will you do?`;

    document.getElementById("combat-info").innerHTML = combatHTML;

    // Create combat actions
    const actionsDiv = document.getElementById("combat-actions");
    actionsDiv.innerHTML = "";

    // Basic attack
    const attackBtn = document.createElement("button");
    attackBtn.className = "game-button";
    attackBtn.textContent = "ATTACK";
    attackBtn.onclick = function() { playerAttack(); };
    actionsDiv.appendChild(attackBtn);

    // Class skills
    player.skills.forEach(skill => {
        const skillBtn = document.createElement("button");
        skillBtn.className = "game-button";
        skillBtn.textContent = skill.name.toUpperCase();
        skillBtn.onclick = function() { useSkill(skill); };

        // Disable if not enough mana or requires stealth
        if (player.mana < skill.cost) {
            skillBtn.disabled = true;
        }
        if (skill.requiresStealth && player.stealth <= 0) {
            skillBtn.disabled = true;
        }

        actionsDiv.appendChild(skillBtn);
    });

    // Flee button
    const fleeBtn = document.createElement("button");
    fleeBtn.className = "game-button";
    fleeBtn.textContent = "FLEE";
    fleeBtn.onclick = function() { attemptFlee(); };
    actionsDiv.appendChild(fleeBtn);

    // Use item button
    const itemsBtn = document.createElement("button");
    itemsBtn.className = "game-button";
    itemsBtn.textContent = "ITEMS";
    itemsBtn.onclick = function() { showCombatItems(); };
    actionsDiv.appendChild(itemsBtn);
}

// Player attack in combat
function playerAttack() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    if (!enemy) return;

    let damage = 5; // Base damage

    // Calculate damage based on weapon
    if (player.equippedWeapon) {
        const damageRange = player.equippedWeapon.damage.split("-").map(Number);
        damage = Math.floor(Math.random() * (damageRange[1] - damageRange[0] + 1)) + damageRange[0];

        // Add stat bonuses based on class
        if (player.class === 'warrior') {
            damage += Math.floor(player.strength / 2);
        } else if (player.class === 'rogue') {
            damage += Math.floor(player.dexterity / 3);
        }

        // Check for backstab bonus (Rogue only)
        if (player.class === 'rogue' && player.stealth > 0 && player.equippedWeapon.backstabDamage) {
            damage = Math.floor(damage * player.equippedWeapon.backstabDamage);
            addToGameLog(`<span class="critical">Backstab!</span> You attack the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
            player.stealth = 0; // Break stealth after attacking
        } else {
            // Check for critical hit
            let critChance = 0.1; // Base 10% chance
            if (player.equippedWeapon.critChance) {
                critChance += player.equippedWeapon.critChance;
            }
            if (player.class === 'rogue') {
                critChance += player.dexterity * 0.01; // 1% per point of dexterity
            }

            // Apply talent bonuses
            if (player.talents && player.talents["Battle Fury"]) {
                critChance += player.talents["Battle Fury"].currentPoints * 0.02;
            }
            if (player.talents && player.talents["Precision"]) {
                critChance += player.talents["Precision"].currentPoints * 0.03;
            }

            if (Math.random() < critChance) {
                damage *= 2;
                addToGameLog(`<span class="critical">Critical hit!</span> You attack the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
            } else {
                addToGameLog(`You attack the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
            }
        }

        // Check for weapon special effects
        if (player.equippedWeapon.poisonDamage) {
            addToGameLog(`<span class="debuff">Your weapon poisons the enemy for ${player.equippedWeapon.poisonDamage} damage!</span>`);
            enemy.health -= player.equippedWeapon.poisonDamage;
        }
        if (player.equippedWeapon.frostDamage && Math.random() < 0.3) {
            addToGameLog(`<span class="debuff">Your weapon slows the enemy!</span>`);
        }
        if (player.equippedWeapon.armorPen) {
            const armorReduction = Math.max(0, (enemy.armor || 0) - player.equippedWeapon.armorPen);
            damage = Math.max(1, damage - armorReduction);
        }
    } else {
        // Bare hands
        damage += Math.floor(player.strength / 3);
        addToGameLog(`You punch the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
    }

    // Apply enemy armor reduction if no armor penetration
    if (enemy.armor && (!player.equippedWeapon || !player.equippedWeapon.armorPen)) {
        damage = Math.max(1, damage - enemy.armor);
    }

    enemy.health -= damage;

    // Check for lifesteal
    if (player.equippedWeapon && player.equippedWeapon.lifesteal) {
        const healAmount = Math.floor(damage * player.equippedWeapon.lifesteal);
        player.health = Math.min(player.maxHealth, player.health + healAmount);
        addToGameLog(`You steal <span class="heal">${healAmount}</span> health!`);
    }

    // Apply talent lifesteal
    if (player.talents && player.talents["Bloodthirst"]) {
        const talentLifesteal = player.talents["Bloodthirst"].currentPoints * 0.02;
        const healAmount = Math.floor(damage * talentLifesteal);
        player.health = Math.min(player.maxHealth, player.health + healAmount);
        if (healAmount > 0) {
            addToGameLog(`<span class="heal">Bloodthirst heals you for ${healAmount} health!</span>`);
        }
    }

    // NEW: Pet attack if active
    if (player.pets.active && player.pets.active.type === "combat") {
        const pet = player.pets.active;
        const petDamage = Math.floor(pet.stats.damage * (1 + (pet.level - 1) * 0.2));
        enemy.health -= petDamage;
        addToGameLog(`<span class="heal">${pet.name} attacks for ${petDamage} damage!</span>`);
    }

    // Check if enemy is defeated
    if (enemy.health <= 0) {
        enemy.health = 0;
        defeatEnemy();
    } else {
        // Enemy attacks back unless player is stealthed
        if (player.stealth <= 0) {
            enemyAttack();
        } else {
            addToGameLog(`The ${enemy.name} can't see you!`);
            player.stealth--; // Reduce stealth duration
        }
    }

    updateCombatScreen();
}

// Use skill in combat
function useSkill(skill) {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    if (!enemy) return;

    // Deduct mana cost
    let actualCost = skill.cost;
    
    // Apply talent mana reduction
    if (player.talents && player.talents["Mana Efficiency"]) {
        actualCost = Math.floor(actualCost * (1 - player.talents["Mana Efficiency"].currentPoints * 0.1));
    }
    
    player.mana -= actualCost;

    // Handle different skills
    if (skill.damageMultiplier) {
        let damage = 5; // Base damage

        if (player.equippedWeapon) {
            const damageRange = player.equippedWeapon.damage.split("-").map(Number);
            damage = Math.floor(Math.random() * (damageRange[1] - damageRange[0] + 1)) + damageRange[0];
        }

        damage = Math.floor(damage * skill.damageMultiplier);

        // Add stat bonuses
        if (player.class === 'warrior') {
            damage += Math.floor(player.strength / 2);
        } else if (player.class === 'mage') {
            damage += Math.floor(player.intelligence);
        } else if (player.class === 'rogue') {
            damage += Math.floor(player.dexterity / 2);
        }

        addToGameLog(`You use <span class="important">${skill.name}</span> on the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
        enemy.health -= damage;
    } else if (skill.damage) {
        let damage = skill.damage;

        // Mage spells scale with intelligence
        if (player.class === 'mage') {
            damage += Math.floor(player.intelligence * 1.5);
        }

        // Apply talent spell damage bonuses
        if (player.talents && player.talents["Arcane Focus"]) {
            damage = Math.floor(damage * (1 + player.talents["Arcane Focus"].currentPoints * 0.04));
        }
        if (player.talents && player.talents["Spell Critical"] && Math.random() < player.talents["Spell Critical"].currentPoints * 0.05) {
            damage *= 2;
            addToGameLog(`<span class="critical">Spell critical hit!</span>`);
        }

        addToGameLog(`You use <span class="important">${skill.name}</span> on the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
        enemy.health -= damage;
    } else if (skill.effect) {
        addToGameLog(`You use <span class="important">${skill.name}</span>: ${skill.description}`);

        // Handle specific effects
        if (skill.name === "Taunt") {
            // Apply debuff to enemy
            if (!enemy.debuffs) enemy.debuffs = [];
            enemy.debuffs.push({
                name: "Taunted",
                duration: 3,
                effect: "damageReduction",
                amount: 0.3
            });
        } else if (skill.name === "Battle Cry") {
            // Apply buff to player
            player.buffs.push({
                name: "Battle Cry",
                duration: 5,
                effect: "strength",
                amount: 5
            });
            player.strength += 5;
        } else if (skill.name === "Mana Shield") {
            player.buffs.push({
                name: "Mana Shield",
                duration: 3,
                effect: "manaShield"
            });
        } else if (skill.name === "Vanish") {
            player.stealth = 2;
            
            // Apply talent stealth duration
            if (player.talents && player.talents["Shadow Arts"]) {
                player.stealth += player.talents["Shadow Arts"].currentPoints;
            }
            
            addToGameLog("You vanish into the shadows!");
        } else if (skill.name === "Last Stand") {
            if (player.health <= player.maxHealth * 0.3) {
                player.buffs.push({
                    name: "Last Stand",
                    duration: 3,
                    effect: "damageBoost",
                    amount: 2
                });
                player.buffs.push({
                    name: "Last Stand",
                    duration: 3,
                    effect: "damageReduction",
                    amount: 0.5
                });
            } else {
                addToGameLog("You must be below 30% health to use Last Stand!");
            }
        } else if (skill.name === "Polymorph") {
            if (Math.random() < skill.transformChance) {
                addToGameLog(`<span class="important">The ${enemy.name} has been transformed into a harmless creature!</span>`);
                enemy.debuffs.push({
                    name: "Polymorphed",
                    duration: 2,
                    effect: "stun"
                });
            } else {
                addToGameLog("The transformation failed!");
            }
        } else if (skill.name === "Poison Strike") {
            let poisonDamage = skill.poisonDamage;
            
            // Apply talent poison damage
            if (player.talents && player.talents["Deadly Poison"]) {
                poisonDamage += player.talents["Deadly Poison"].currentPoints * 5;
            }
            
            enemy.debuffs.push({
                name: "Poisoned",
                duration: skill.duration,
                effect: "damage",
                amount: poisonDamage
            });
            addToGameLog(`<span class="debuff">You poisoned the ${enemy.name}!</span>`);
        } else if (skill.name === "Shadowstep") {
            if (player.stealth > 0) {
                let damage = 5; // Base damage
                if (player.equippedWeapon) {
                    const damageRange = player.equippedWeapon.damage.split("-").map(Number);
                    damage = Math.floor(Math.random() * (damageRange[1] - damageRange[0] + 1)) + damageRange[0];
                }
                
                // Apply talent backstab damage
                let backstabMultiplier = 2;
                if (player.talents && player.talents["Assassinate"]) {
                    backstabMultiplier = 3;
                }
                
                damage = Math.floor(damage * backstabMultiplier);
                addToGameLog(`<span class="critical">Shadowstep!</span> You attack the ${enemy.name} for <span class="damage">${damage}</span> damage!`);
                enemy.health -= damage;
                player.stealth = 0; // Break stealth
            }
        }
    }

    // Check for freeze effect
    if (skill.freezeChance && Math.random() < skill.freezeChance) {
        addToGameLog(`<span class="debuff">The ${enemy.name} is frozen!</span>`);
        if (!enemy.debuffs) enemy.debuffs = [];
        enemy.debuffs.push({
            name: "Frozen",
            duration: 1,
            effect: "stun"
        });
    }

    // Check if enemy is defeated
    if (enemy.health <= 0) {
        enemy.health = 0;
        defeatEnemy();
        return;
    }

    // Enemy attacks back unless player is stealthed
    if (player.stealth <= 0) {
        enemyAttack();
    } else {
        addToGameLog(`The ${enemy.name} can't see you!`);
        player.stealth--; // Reduce stealth duration
    }

    // Add visual feedback
    document.getElementById("combat-info").classList.add("combat-flash");
    setTimeout(() => {
        document.getElementById("combat-info").classList.remove("combat-flash");
    }, 300);
    
    updateCombatScreen();
}

// Enemy attack in combat
function enemyAttack() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    if (!enemy) return;

    // Check if player is stealthed
    if (player.stealth > 0) {
        addToGameLog(`The ${enemy.name} can't see you!`);
        player.stealth--;
        return;
    }

    // Check if enemy is stunned
    if (enemy.debuffs && enemy.debuffs.some(d => d.effect === "stun")) {
        addToGameLog(`<span class="important">The ${enemy.name} is stunned and can't attack!</span>`);
        // Reduce stun duration
        enemy.debuffs.forEach(debuff => {
            if (debuff.effect === "stun") debuff.duration--;
        });
        enemy.debuffs = enemy.debuffs.filter(d => d.duration > 0);
        return;
    }

    // Calculate enemy damage
    let damage;
    if (typeof enemy.damage === "string") {
        const damageRange = enemy.damage.split("-").map(Number);
        damage = Math.floor(Math.random() * (damageRange[1] - damageRange[0] + 1)) + damageRange[0];
    } else {
        damage = enemy.damage;
    }

    // Apply damage reduction if taunted
    if (enemy.debuffs && enemy.debuffs.some(d => d.effect === "damageReduction")) {
        const reduction = enemy.debuffs.find(d => d.effect === "damageReduction").amount;
        damage = Math.floor(damage * (1 - reduction));
    }

    // Check for enemy critical hit
    if (enemy.critChance && Math.random() < enemy.critChance) {
        damage *= 2;
        addToGameLog(`<span class="critical">The ${enemy.name} lands a critical hit!</span>`);
    }

    // Add any special damage types
    if (enemy.fireDamage) {
        damage += enemy.fireDamage;
        addToGameLog(`<span class="debuff">The attack burns you for ${enemy.fireDamage} extra damage!</span>`);
    }
    if (enemy.poisonDamage && Math.random() < enemy.poisonChance) {
        addToGameLog(`<span class="debuff">You are poisoned for ${enemy.poisonDamage} damage per turn!</span>`);
        if (!player.debuffs) player.debuffs = [];
        player.debuffs.push({
            name: "Poison",
            duration: 3,
            effect: "damage",
            amount: enemy.poisonDamage
        });
    }
    if (enemy.charmChance && Math.random() < enemy.charmChance) {
        addToGameLog(`<span class="debuff">You are charmed and can't attack next turn!</span>`);
        player.debuffs.push({
            name: "Charmed",
            duration: 1,
            effect: "stun"
        });
    }
    if (enemy.fearChance && Math.random() < enemy.fearChance) {
        addToGameLog(`<span class="debuff">You are feared and flee from combat!</span>`);
        attemptFlee();
        return;
    }

    // Reduce damage by armor if equipped
    if (player.equippedArmor) {
        let armorValue = player.equippedArmor.defense;
        
        // Apply talent armor bonus
        if (player.talents && player.talents["Iron Skin"]) {
            armorValue = Math.floor(armorValue * (1 + player.talents["Iron Skin"].currentPoints * 0.05));
        }
        
        damage -= armorValue;
        if (damage < 1) damage = 1; // Minimum 1 damage

        // Check for dodge chance (Rogue)
        let dodgeChance = 0;
        if (player.class === 'rogue') {
            dodgeChance = player.dexterity * 0.01; // 1% per point of dexterity
            if (player.equippedArmor.dodgeChance) {
                dodgeChance += player.equippedArmor.dodgeChance;
            }
            
            // Apply talent dodge bonus
            if (player.talents && player.talents["Agility"]) {
                dodgeChance += player.talents["Agility"].currentPoints * 0.02;
            }
        }

        if (Math.random() < dodgeChance) {
            damage = 0;
            addToGameLog(`<span class="important">You dodge the attack!</span>`);
        } else {
            // Check for block chance
            if (player.equippedArmor.blockChance && Math.random() < player.equippedArmor.blockChance) {
                damage = 0;
                addToGameLog(`<span class="important">Your armor blocks the attack!</span>`);
            }
        }
    }

    // Check for mana shield
    if (player.buffs.some(b => b.effect === "manaShield")) {
        const manaDamage = Math.floor(damage / 2);
        if (player.mana >= manaDamage) {
            player.mana -= manaDamage;
            damage = Math.floor(damage / 2);
            addToGameLog(`<span class="important">Your mana shield absorbs some damage!</span>`);
        } else {
            player.buffs = player.buffs.filter(b => b.effect !== "manaShield");
            addToGameLog(`<span class="debuff">Your mana shield breaks!</span>`);
        }
    }

    // Apply damage reduction from buffs
    if (player.buffs.some(b => b.effect === "damageReduction")) {
        const reduction = player.buffs.find(b => b.effect === "damageReduction").amount;
        damage = Math.floor(damage * (1 - reduction));
    }

    player.health -= damage;
    addToGameLog(`The ${enemy.name} attacks you for <span class="damage">${damage}</span> damage!`);

    // Check for enemy lifesteal
    if (enemy.lifesteal) {
        const enemyHeal = Math.floor(damage * enemy.lifesteal);
        enemy.health = Math.min(enemy.maxHealth, enemy.health + enemyHeal);
        addToGameLog(`The ${enemy.name} heals for <span class="heal">${enemyHeal}</span> health!`);
    }

    // Check for enemy regen
    if (enemy.regen) {
        enemy.health = Math.min(enemy.maxHealth, enemy.health + enemy.regen);
    }

    // Apply poison/DoT effects
    if (player.debuffs && player.debuffs.length > 0) {
        player.debuffs.forEach(debuff => {
            if (debuff.effect === "damage") {
                player.health -= debuff.amount;
                addToGameLog(`<span class="debuff">You take ${debuff.amount} damage from ${debuff.name}!</span>`);
            }
            debuff.duration--;
        });
        player.debuffs = player.debuffs.filter(d => d.duration > 0);
    }

    // Apply buff/debuff expiration
    player.buffs.forEach(buff => buff.duration--);
    player.buffs = player.buffs.filter(b => b.duration > 0);

    // Check if player is defeated
    if (player.health <= 0) {
        player.health = 0;
        addToGameLog(`<span class="enemy">You have been defeated by the ${enemy.name}!</span>`);
        
        // Check for Phoenix Down
        const phoenixDown = player.inventory.find(i => i.id === 35 || i.id === 55);
        if (phoenixDown) {
            if (phoenixDown.id === 55) { // Potion of Immortality
                player.health = player.maxHealth;
                addToGameLog(`<span class="heal">The Potion of Immortality revives you at full health!</span>`);
                
                // Remove from inventory
                const itemIndex = player.inventory.findIndex(i => i.id === phoenixDown.id);
                player.inventory.splice(itemIndex, 1);
                
                return;
            } else { // Regular Phoenix Down
                player.health = Math.floor(player.maxHealth / 2);
                addToGameLog(`<span class="heal">The Phoenix Down revives you with 50% health!</span>`);
                
                // Remove from inventory
                const itemIndex = player.inventory.findIndex(i => i.id === phoenixDown.id);
                player.inventory.splice(itemIndex, 1);
                
                return;
            }
        }
        
        addToGameLog("You wake up back at camp, having lost some gold and items...");

        // Lose some gold and items
        let goldLost;
        if (typeof enemy.gold === "string") {
            const goldRange = enemy.gold.split("-").map(Number);
            goldLost = Math.floor(Math.random() * (goldRange[1] - goldRange[0] + 1)) + goldRange[0];
        } else {
            goldLost = Math.floor(enemy.gold * 0.5);
        }

        player.gold -= goldLost;
        if (player.gold < 0) player.gold = 0;

        // Lose a random item (10% chance for each item)
        for (let i = player.inventory.length - 1; i >= 0; i--) {
            if (Math.random() < 0.1) {
                addToGameLog(`You lost your ${player.inventory[i].name} in the fight!`);
                player.inventory.splice(i, 1);
            }
        }

        // Reset health
        player.health = Math.floor(player.maxHealth / 3);
        if (player.class === 'mage' || player.class === 'warrior' || player.class === 'rogue') {
            player.mana = Math.floor(player.maxMana / 3);
        }

        // End combat
        gameState.player.inCombat = false;
        gameState.player.currentEnemy = null;
        
        // Stop combat music, resume background
        try {
            combatSound.pause();
            bgMusic.currentTime = 0;
            bgMusic.play();
        } catch (e) {
            console.log("Audio error:", e);
        }
        
        showScreen("main");
    }
    
    // Add visual feedback
    document.getElementById("player-stats").classList.add("combat-shake");
    setTimeout(() => {
        document.getElementById("player-stats").classList.remove("combat-shake");
    }, 500);
}

// Attempt to flee from combat
function attemptFlee() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    let fleeChance = 0.4; // Base 40% chance

    // Rogues have higher flee chance
    if (player.class === 'rogue') {
        fleeChance += 0.2 + (player.dexterity * 0.01); // +20% base +1% per dexterity
    }

    // Reduce chance if enemy is faster
    if (enemy.level > player.level) {
        fleeChance -= 0.1 * (enemy.level - player.level);
    }

    if (Math.random() < fleeChance) {
        addToGameLog(`You successfully flee from the ${enemy.name}!`);
        gameState.player.inCombat = false;
        gameState.player.currentEnemy = null;
        
        // Stop combat music, resume background
        try {
            combatSound.pause();
            bgMusic.currentTime = 0;
            bgMusic.play();
        } catch (e) {
            console.log("Audio error:", e);
        }
        
        showScreen("main");
    } else {
        addToGameLog(`You fail to flee from the ${enemy.name}!`);
        enemyAttack();
    }
}

// Show items during combat
function showCombatItems() {
    const player = gameState.player;
    const consumables = player.inventory.filter(item => item.type === "consumable");

    const actionsDiv = document.getElementById("combat-actions");
    actionsDiv.innerHTML = "";

    if (consumables.length === 0) {
        const noItemsBtn = document.createElement("button");
        noItemsBtn.className = "game-button";
        noItemsBtn.textContent = "NO ITEMS";
        noItemsBtn.disabled = true;
        actionsDiv.appendChild(noItemsBtn);
    } else {
        consumables.forEach(item => {
            const itemBtn = document.createElement("button");
            itemBtn.className = "game-button";
            itemBtn.textContent = item.name.toUpperCase();
            itemBtn.onclick = function() { useItem(item); };
            actionsDiv.appendChild(itemBtn);
        });
    }

    const backBtn = document.createElement("button");
    backBtn.className = "game-button";
    backBtn.textContent = "BACK";
    backBtn.onclick = function() { updateCombatScreen(); };
    actionsDiv.appendChild(backBtn);
}

// Use item during combat
function useItem(item) {
    const player = gameState.player;

    if (item.effect.health) {
        player.health += item.effect.health;
        if (player.health > player.maxHealth) player.health = player.maxHealth;
        addToGameLog(`You use ${item.name} and restore <span class="heal">${item.effect.health}</span> health!`);
    } else if (item.effect.mana) {
        player.mana += item.effect.mana;
        if (player.mana > player.maxMana) player.mana = player.maxMana;
        addToGameLog(`You use ${item.name} and restore <span class="heal">${item.effect.mana}</span> mana!`);
    } else if (item.effect.damage) {
        const enemy = gameState.player.currentEnemy;
        enemy.health -= item.effect.damage;
        addToGameLog(`You use ${item.name} and deal <span class="damage">${item.effect.damage}</span> damage to the ${enemy.name}!`);

        if (enemy.health <= 0) {
            enemy.health = 0;
            defeatEnemy();
            return;
        }
    } else if (item.effect.stealth) {
        player.stealth = item.effect.stealth;
        addToGameLog(`You use ${item.name} and vanish into the shadows for ${item.effect.stealth} turns!`);
    } else if (item.effect.strength) {
        player.strength += item.effect.strength;
        player.buffs.push({
            name: "Strength Potion",
            duration: item.duration,
            effect: "strength",
            amount: item.effect.strength
        });
        addToGameLog(`You use ${item.name} and gain <span class="heal">+${item.effect.strength} Strength</span> for ${item.duration} turns!`);
    } else if (item.effect.damageReduction) {
        player.buffs.push({
            name: "Invulnerability",
            duration: item.duration,
            effect: "damageReduction",
            amount: item.effect.damageReduction
        });
        addToGameLog(`You use ${item.name} and gain <span class="heal">50% damage reduction</span> for ${item.duration} turns!`);
    } else if (item.effect.allStats) {
        player.strength += item.effect.allStats;
        player.dexterity += item.effect.allStats;
        player.intelligence += item.effect.allStats;
        player.constitution += item.effect.allStats;
        player.buffs.push({
            name: "Godly Power",
            duration: item.duration,
            effect: "allStats",
            amount: item.effect.allStats
        });
        addToGameLog(`You use ${item.name} and gain <span class="heal">+${item.effect.allStats} to all stats</span> for ${item.duration} turns!`);
    }

    // Remove item from inventory
    const itemIndex = player.inventory.findIndex(i => i.id === item.id);
    if (itemIndex !== -1) {
        player.inventory.splice(itemIndex, 1);
    }

    // Enemy still gets an attack unless player is stealthed
    if (player.stealth <= 0) {
        enemyAttack();
    } else {
        addToGameLog(`The ${enemy.name} can't see you!`);
        player.stealth--;
    }

    updateCombatScreen();
}

// Defeat enemy in combat
function defeatEnemy() {
    const player = gameState.player;
    const enemy = gameState.player.currentEnemy;

    addToGameLog(`<span class="important">You defeated the ${enemy.name}!</span>`);

    // Check if this was a boss
    if (gameState.bosses[player.currentArea]?.name === enemy.name) {
        gameState.bossDefeated[player.currentArea] = true;
        addToGameLog(`<span class="important">You have defeated the ${player.currentArea} boss!</span>`);
        
        // Play victory sound
        try {
            combatSound.pause();
            victorySound.currentTime = 0;
            victorySound.play();
            setTimeout(() => {
                bgMusic.currentTime = 0;
                bgMusic.play();
            }, 3000);
        } catch (e) {
            console.log("Audio error:", e);
        }
    } else {
        // Resume normal music
        try {
            combatSound.pause();
            bgMusic.currentTime = 0;
            bgMusic.play();
        } catch (e) {
            console.log("Audio error:", e);
        }
    }

    // Gain XP
    const xpGain = enemy.xp;
    player.xp += xpGain;
    addToGameLog(`You gain <span class="xp">${xpGain} XP</span>!`);

    // Gain gold
    let goldGain;
    if (typeof enemy.gold === "string") {
        const goldRange = enemy.gold.split("-").map(Number);
        goldGain = Math.floor(Math.random() * (goldRange[1] - goldRange[0] + 1)) + goldRange[0];
    } else {
        goldGain = enemy.gold;
    }
    player.gold += goldGain;
    addToGameLog(`You find <span class="gold">${goldGain} gold</span> on the ${enemy.name}.`);

    // Check for quest progress
    updateQuestProgress(enemy.name);

    // Small chance to find item
    if (Math.random() < 0.4) {
        findItem(enemy.name);
    }

    // Check for level up
    checkLevelUp();

    // Check for area unlocks
    checkAreaUnlocks();
    
    // Check for achievements
    checkAchievements();
    
    // Check for challenge progress
    updateChallengeProgress(enemy.name);

    // NEW: Pet XP gain
    if (player.pets.active) {
        const pet = player.pets.active;
        const petXP = Math.floor(xpGain * 0.5);
        pet.xp += petXP;
        addToGameLog(`<span class="heal">${pet.name} gains ${petXP} XP!</span>`);
        
        // Check for pet level up
        checkPetLevelUp(pet);
    }

    // End combat
    gameState.player.inCombat = false;
    gameState.player.currentEnemy = null;
    showScreen("main");
}

// Check if player levels up
function checkLevelUp() {
    const player = gameState.player;

    if (player.xp >= player.xpToNextLevel) {
        player.level++;
        player.xp -= player.xpToNextLevel;
        player.xpToNextLevel = Math.floor(player.xpToNextLevel * 1.5);

        // Increase stats based on class
        if (player.class === 'warrior') {
            player.maxHealth += 25;
            player.health += 25;
            player.strength += 4;
            player.constitution += 3;
            player.dexterity += 1;
            player.maxMana += 5;
            player.mana += 5;
        } else if (player.class === 'mage') {
            player.maxHealth += 12;
            player.health += 12;
            player.maxMana += 20;
            player.mana += 20;
            player.intelligence += 5;
            player.dexterity += 1;
        } else if (player.class === 'rogue') {
            player.maxHealth += 15;
            player.health += 15;
            player.maxMana += 10;
            player.mana += 10;
            player.dexterity += 4;
            player.strength += 1;
            player.constitution += 2;
        }

        // Gain talent point every 2 levels
        if (player.level % 2 === 0) {
            player.talentPoints++;
            addToGameLog(`<span class="important">You gained a talent point! You now have ${player.talentPoints} talent points.</span>`);
        }

        // Check for specialization unlock at level 10
        if (player.level === 10 && !player.specialization) {
            unlockSpecialization();
        }

        addToGameLog(`<span class="important">You leveled up to level ${player.level}!</span>`);
        addToGameLog(`Your stats have improved!`);

        // Add visual feedback
        document.getElementById("player-stats").classList.add("level-up");
        setTimeout(() => {
            document.getElementById("player-stats").classList.remove("level-up");
        }, 500);

        // Check for another level up (unlikely but possible)
        checkLevelUp();
    }
}

// NEW: Check for pet level up
function checkPetLevelUp(pet) {
    const xpRequired = pet.level * 100;
    if (pet.xp >= xpRequired && pet.level < pet.maxLevel) {
        pet.level++;
        pet.xp -= xpRequired;
        
        // Improve pet stats
        pet.stats.health += 10;
        pet.stats.damage += 2;
        pet.stats.speed += 1;
        
        addToGameLog(`<span class="important">${pet.name} leveled up to level ${pet.level}!</span>`);
        
        // Check for pet achievement
        if (pet.level === pet.maxLevel) {
            gameState.achievements[31].unlocked = true;
            showAchievement("Master Trainer", "Leveled a pet to maximum level");
        }
        
        // Check for another level up
        checkPetLevelUp(pet);
    }
}

// Unlock class specialization at level 10
function unlockSpecialization() {
    const player = gameState.player;
    const specializations = gameState.specializations[player.class];
    
    addToGameLog(`<span class="important">You have reached level 10! You can now choose a specialization.</span>`);
    
    // Create specialization selection screen
    const specSelection = document.createElement("div");
    specSelection.innerHTML = `<h3>Choose Your Specialization:</h3>`;
    
    specializations.forEach(spec => {
        const specDiv = document.createElement("div");
        specDiv.className = "specialization-option";
        specDiv.innerHTML = `
            <h4 class="spec-${spec.name.toLowerCase()}">${spec.name}</h4>
            <p>${spec.description}</p>
            <p><strong>Bonuses:</strong> ${Object.entries(spec.bonuses).map(([stat, value]) => `${stat}: +${value}`).join(', ')}</p>
            <p><strong>Skills:</strong> ${spec.skills.map(skill => skill.name).join(', ')}</p>
        `;
        specDiv.onclick = function() { selectSpecialization(spec.name); };
        specSelection.appendChild(specDiv);
    });
    
    // Replace the main screen content
    const gameScreen = document.getElementById("game-screen");
    gameScreen.innerHTML = "";
    gameScreen.appendChild(specSelection);
    
    // Hide main buttons
    document.getElementById("main-buttons").style.display = "none";
}

// Select a specialization
function selectSpecialization(specName) {
    const player = gameState.player;
    const spec = gameState.specializations[player.class].find(s => s.name === specName);
    
    if (!spec) return;
    
    player.specialization = specName;
    
    // Apply stat bonuses
    Object.entries(spec.bonuses).forEach(([stat, value]) => {
        if (stat === 'maxHealth') {
            player.maxHealth += value;
            player.health += value;
        } else if (stat === 'maxMana') {
            player.maxMana += value;
            player.mana += value;
        } else {
            player[stat] += value;
        }
    });
    
    // Add specialization skills
    spec.skills.forEach(skill => {
        player.skills.push(skill);
    });
    
    addToGameLog(`<span class="important">You have chosen the ${specName} specialization!</span>`);
    
    // Restore the game screen
    updateGameScreen();
    document.getElementById("main-buttons").style.display = "flex";
    
    // Check for specialization achievements
    checkAchievements();
}

// Check if new areas should be unlocked
function checkAreaUnlocks() {
    const player = gameState.player;
    gameState.areas.forEach(area => {
        if (!area.unlocked && player.level >= area.minLevel) {
            area.unlocked = true;
            addToGameLog(`<span class="important">New area unlocked: ${area.name}!</span>`);
        }
    });
}

// Find random item
function findItem(source) {
    const player = gameState.player;
    const allItems = [...gameState.items.weapons, ...gameState.items.armor, ...gameState.items.consumables, ...gameState.items.questItems, ...gameState.items.loreItems, ...gameState.items.petItems];
    const randomItem = {...allItems[Math.floor(Math.random() * allItems.length)]};

    // Only find items appropriate for player level
    if (randomItem.level && randomItem.level > player.level) {
        // Try again for a lower level item
        return findItem(source);
    }

    // Special drops from certain enemies
    if (source === "Goblin" && Math.random() < 0.3) {
        const questItem = {...gameState.items.questItems.find(i => i.id === 36)};
        player.inventory.push(questItem);
        addToGameLog(`You found a <span class="item">${questItem.name}</span>!`);
        return;
    } else if (source === "Wolf" && Math.random() < 0.3) {
        const questItem = {...gameState.items.questItems.find(i => i.id === 37)};
        player.inventory.push(questItem);
        addToGameLog(`You found a <span class="item">${questItem.name}</span>!`);
        return;
    } else if (source === "Ancient Treant" && Math.random() < 0.8) {
        const specialItem = {...gameState.items.consumables.find(i => i.id === 19)};
        player.inventory.push(specialItem);
        addToGameLog(`You found a <span class="item">${specialItem.name}</span>!`);
        return;
    } else if (source === "Phoenix" && Math.random() < 0.5) {
        const questItem = {...gameState.items.questItems.find(i => i.id === 56)};
        player.inventory.push(questItem);
        addToGameLog(`You found a <span class="item">${questItem.name}</span>!`);
        return;
    } else if (source === "Celestial Champion" && Math.random() < 0.5) {
        const questItem = {...gameState.items.questItems.find(i => i.id === 57)};
        player.inventory.push(questItem);
        addToGameLog(`You found a <span class="item">${questItem.name}</span>!`);
        return;
    } else if (source === "Shadow King" && Math.random() < 0.5) {
        const questItem = {...gameState.items.questItems.find(i => i.id === 58)};
        player.inventory.push(questItem);
        addToGameLog(`You found a <span class="item">${questItem.name}</span>!`);
        return;
    } else if (source === "Ice Queen" && Math.random() < 0.5) {
        const questItem = {...gameState.items.questItems.find(i => i.id === 59)};
        player.inventory.push(questItem);
        addToGameLog(`You found a <span class="item">${questItem.name}</span>!`);
        return;
    } else if (source === "God King" && Math.random() < 1.0) {
        const questItem = {...gameState.items.questItems.find(i => i.id === 60)};
        player.inventory.push(questItem);
        addToGameLog(`You found a <span class="item">${questItem.name}</span>!`);
        return;
    }

    // NEW: Chance to find lore items
    if (randomItem.type === "lore" && !player.lore.collected.includes(randomItem.id)) {
        player.lore.collected.push(randomItem.id);
        addToGameLog(`You discovered ancient knowledge: <span class="item">${randomItem.name}</span>!`);
        return;
    }

    // NEW: Chance to find pet items
    if (randomItem.type === "pet" && !player.pets.owned.some(pet => pet.type === randomItem.petType)) {
        const petData = {...gameState.pets[randomItem.petType]};
        player.pets.owned.push(petData);
        addToGameLog(`You found a <span class="item">${randomItem.name}</span>! A new companion joins you!`);
        return;
    }

    player.inventory.push(randomItem);
    addToGameLog(`You found a <span class="item">${randomItem.name}</span>!`);
}

// Rest to recover health and mana
function rest() {
    const player = gameState.player;

    const healthRecovered = Math.floor(player.maxHealth * 0.5);
    player.health = Math.min(player.maxHealth, player.health + healthRecovered);

    if (player.class === 'mage' || player.class === 'warrior' || player.class === 'rogue') {
        const manaRecovered = Math.floor(player.maxMana * 0.5);
        player.mana = Math.min(player.maxMana, player.mana + manaRecovered);
    }

    // Apply regen from armor
    if (player.equippedArmor?.healthRegen) {
        player.health = Math.min(player.maxHealth, player.health + player.equippedArmor.healthRegen);
    }
    if (player.equippedArmor?.manaRegen) {
        player.mana = Math.min(player.maxMana, player.mana + player.equippedArmor.manaRegen);
    }

    addToGameLog(`You rest and recover <span class="heal">${healthRecovered}</span> health.`);
    updatePlayerStats();
}

// Show character screen
function showCharacterScreen() {
    const player = gameState.player;
    let charHTML = `<span class="class-${player.class}">${player.class.toUpperCase()}</span> `;
    if (player.specialization) {
        charHTML += `<span class="spec-${player.specialization.toLowerCase()}">${player.specialization}</span> `;
    }
    charHTML += `Level: ${player.level}<br>`;
    charHTML += `XP: ${player.xp}/${player.xpToNextLevel}<br><br>`;
    charHTML += `<span class="health">Health: ${player.health}/${player.maxHealth}</span><br>`;

    if (player.class === 'mage' || player.class === 'warrior' || player.class === 'rogue') {
        charHTML += `<span class="mana">Mana: ${player.mana}/${player.maxMana}</span><br>`;
    }

    charHTML += `<br><strong>Stats:</strong><br>`;
    charHTML += `Strength: ${player.strength}<br>`;
    charHTML += `Dexterity: ${player.dexterity}<br>`;
    charHTML += `Intelligence: ${player.intelligence}<br>`;
    charHTML += `Constitution: ${player.constitution}<br><br>`;

    charHTML += `<strong>Equipment:</strong><br>`;
    charHTML += `Weapon: ${player.equippedWeapon ? player.equippedWeapon.name : "None"}<br>`;
    charHTML += `Armor: ${player.equippedArmor ? player.equippedArmor.name : "None"}<br><br>`;

    charHTML += `<strong>Current Area:</strong> ${player.currentArea}<br>`;
    charHTML += `<strong>Unlocked Areas:</strong> `;
    charHTML += gameState.areas.filter(a => a.unlocked).map(a => a.name).join(", ");

    // Show talent points
    if (player.talentPoints > 0) {
        charHTML += `<br><br><span class="xp">Talent Points Available: ${player.talentPoints}</span>`;
    }

    // NEW: Show pet info
    if (player.pets.active) {
        charHTML += `<br><br><strong>Active Pet:</strong> ${player.pets.active.name} (Level ${player.pets.active.level})`;
    }

    // NEW: Show prestige info
    if (player.endgame.prestigeLevel > 0) {
        charHTML += `<br><br><span class="gold">Prestige Level: ${player.endgame.prestigeLevel}</span>`;
        charHTML += `<br><span class="gold">Prestige Points: ${player.endgame.prestigePoints}</span>`;
    }

    document.getElementById("character-info").innerHTML = charHTML;
}

// Show inventory
function showInventory() {
    const player = gameState.player;
    const inventoryDiv = document.getElementById("inventory-items");

    if (player.inventory.length === 0) {
        inventoryDiv.innerHTML = "Your inventory is empty.";
        document.getElementById("item-details").innerHTML = "";
        return;
    }

    let inventoryHTML = "<h3>Inventory:</h3>";
    inventoryHTML += `<span class="gold">Gold: ${player.gold}</span><br><br>`;

    // Group items by type
    const weapons = player.inventory.filter(item => item.type === "weapon");
    const armor = player.inventory.filter(item => item.type === "armor");
    const consumables = player.inventory.filter(item => item.type === "consumable");
    const questItems = player.inventory.filter(item => item.type === "quest");
    const loreItems = player.inventory.filter(item => item.type === "lore");
    const petItems = player.inventory.filter(item => item.type === "pet");

    if (weapons.length > 0) {
        inventoryHTML += "<strong>Weapons:</strong><br>";
        weapons.forEach(weapon => {
            // Add visual indicator for better items
            let itemClass = "";
            if (player.equippedWeapon && player.equippedWeapon.id === weapon.id) {
                itemClass = "item-glow";
            }
            
            // NEW: Show set items with special styling
            if (weapon.rarity === "legendary") {
                inventoryHTML += `<div class="legendary-item">`;
            } else if (weapon.set) {
                inventoryHTML += `<div class="set-item">`;
            } else {
                inventoryHTML += `<div>`;
            }
            
            inventoryHTML += `<button class="game-button ${itemClass}" onclick="showItemDetails(${weapon.id})" style="text-align:left;margin:2px 0;padding:5px;">${weapon.name} (${weapon.damage})</button>`;
            
            if (weapon.set) {
                inventoryHTML += `<div class="set-bonus">Set: ${weapon.set}</div>`;
            }
            
            inventoryHTML += `</div>`;
        });
    }

    if (armor.length > 0) {
        inventoryHTML += "<br><strong>Armor:</strong><br>";
        armor.forEach(armorItem => {
            // Add visual indicator for better items
            let itemClass = "";
            if (player.equippedArmor && player.equippedArmor.id === armorItem.id) {
                itemClass = "item-glow";
            }
            
            // NEW: Show set items with special styling
            if (armorItem.rarity === "legendary") {
                inventoryHTML += `<div class="legendary-item">`;
            } else if (armorItem.set) {
                inventoryHTML += `<div class="set-item">`;
            } else {
                inventoryHTML += `<div>`;
            }
            
            inventoryHTML += `<button class="game-button ${itemClass}" onclick="showItemDetails(${armorItem.id})" style="text-align:left;margin:2px 0;padding:5px;">${armorItem.name} (Def:${armorItem.defense})</button>`;
            
            if (armorItem.set) {
                inventoryHTML += `<div class="set-bonus">Set: ${armorItem.set}</div>`;
            }
            
            inventoryHTML += `</div>`;
        });
    }

    if (consumables.length > 0) {
        inventoryHTML += "<br><strong>Consumables:</strong><br>";
        consumables.forEach(consumable => {
            inventoryHTML += `<button class="game-button" onclick="showItemDetails(${consumable.id})" style="text-align:left;margin:2px 0;padding:5px;">${consumable.name}</button><br>`;
        });
    }

    if (questItems.length > 0) {
        inventoryHTML += "<br><strong>Quest Items:</strong><br>";
        questItems.forEach(questItem => {
            inventoryHTML += `<button class="game-button" onclick="showItemDetails(${questItem.id})" style="text-align:left;margin:2px 0;padding:5px;">${questItem.name}</button><br>`;
        });
    }

    // NEW: Lore items
    if (loreItems.length > 0) {
        inventoryHTML += "<br><strong>Lore Items:</strong><br>";
        loreItems.forEach(loreItem => {
            inventoryHTML += `<button class="game-button" onclick="showItemDetails(${loreItem.id})" style="text-align:left;margin:2px 0;padding:5px;">${loreItem.name}</button><br>`;
        });
    }

    // NEW: Pet items
    if (petItems.length > 0) {
        inventoryHTML += "<br><strong>Pet Items:</strong><br>";
        petItems.forEach(petItem => {
            inventoryHTML += `<button class="game-button" onclick="showItemDetails(${petItem.id})" style="text-align:left;margin:2px 0;padding:5px;">${petItem.name}</button><br>`;
        });
    }

    inventoryDiv.innerHTML = inventoryHTML;
}

// Show item details with comparison
function showItemDetails(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);

    if (!item) return;

    let detailsHTML = `<div class="item-info"><h3>${item.name}</h3>`;

    if (item.type === "weapon") {
        detailsHTML += `Type: Weapon<br>`;
        detailsHTML += `Damage: ${item.damage}<br>`;
        if (item.magicDamage) {
            detailsHTML += `Magic Damage: +${item.magicDamage}<br>`;
        }
        if (item.critChance) {
            detailsHTML += `Crit Chance: +${Math.floor(item.critChance * 100)}%<br>`;
        }
        if (item.lifesteal) {
            detailsHTML += `Lifesteal: ${Math.floor(item.lifesteal * 100)}%<br>`;
        }
        if (item.poisonDamage) {
            detailsHTML += `Poison Damage: ${item.poisonDamage}<br>`;
        }
        if (item.frostDamage) {
            detailsHTML += `Frost Damage: ${item.frostDamage}<br>`;
        }
        if (item.armorPen) {
            detailsHTML += `Armor Penetration: ${item.armorPen}<br>`;
        }
        if (item.backstabDamage) {
            detailsHTML += `Backstab Damage: ${Math.floor((item.backstabDamage - 1) * 100)}% bonus<br>`;
        }
        if (item.divineSlayer) {
            detailsHTML += `Divine Slayer: Deals bonus damage to divine beings<br>`;
        }
        if (item.soulHarvest) {
            detailsHTML += `Soul Harvest: Chance to instantly kill weakened enemies<br>`;
        }
        if (item.burning) {
            detailsHTML += `Burning: Applies fire damage over time<br>`;
        }
        detailsHTML += `Level: ${item.level}<br>`;
        detailsHTML += `Value: ${item.value} gold<br><br>`;

        // NEW: Show set bonus info
        if (item.set) {
            const setBonuses = gameState.itemSets[item.set];
            detailsHTML += `<div class="set-bonus"><strong>Set: ${item.set}</strong><br>`;
            Object.entries(setBonuses).forEach(([pieceCount, bonuses]) => {
                detailsHTML += `${pieceCount} pieces: ${Object.entries(bonuses).map(([stat, value]) => `${stat}: +${value}`).join(', ')}<br>`;
            });
            detailsHTML += `</div><br>`;
        }

        // Equipment comparison
        if (player.equippedWeapon) {
            detailsHTML += `<div class="equipment-comparison">`;
            detailsHTML += `<strong>Comparison with ${player.equippedWeapon.name}:</strong><br>`;
            
            // Compare damage
            const currentDamage = player.equippedWeapon.damage.split("-").map(Number);
            const newDamage = item.damage.split("-").map(Number);
            const currentAvg = (currentDamage[0] + currentDamage[1]) / 2;
            const newAvg = (newDamage[0] + newDamage[1]) / 2;
            
            if (newAvg > currentAvg) {
                detailsHTML += `<span class="stat-change-positive">Damage: +${Math.floor(newAvg - currentAvg)}</span><br>`;
            } else if (newAvg < currentAvg) {
                detailsHTML += `<span class="stat-change-negative">Damage: ${Math.floor(newAvg - currentAvg)}</span><br>`;
            } else {
                detailsHTML += `<span class="stat-change-neutral">Damage: No change</span><br>`;
            }
            
            // Compare other stats
            const stats = ['critChance', 'lifesteal', 'armorPen'];
            stats.forEach(stat => {
                if (item[stat] || player.equippedWeapon[stat]) {
                    const current = player.equippedWeapon[stat] || 0;
                    const newVal = item[stat] || 0;
                    const diff = newVal - current;
                    
                    if (diff > 0) {
                        detailsHTML += `<span class="stat-change-positive">${stat}: +${Math.floor(diff * 100)}%</span><br>`;
                    } else if (diff < 0) {
                        detailsHTML += `<span class="stat-change-negative">${stat}: ${Math.floor(diff * 100)}%</span><br>`;
                    } else {
                        detailsHTML += `<span class="stat-change-neutral">${stat}: No change</span><br>`;
                    }
                }
            });
            
            detailsHTML += `</div><br>`;
        }

        // Equip button if not already equipped
        if (player.equippedWeapon && player.equippedWeapon.id === item.id) {
            detailsHTML += `<button class="game-button" disabled>EQUIPPED</button> `;
        } else {
            detailsHTML += `<button class="game-button" onclick="equipItem(${item.id})">EQUIP</button> `;
        }
    } else if (item.type === "armor") {
        detailsHTML += `Type: Armor<br>`;
        detailsHTML += `Defense: ${item.defense}<br>`;
        if (item.magicResist) {
            detailsHTML += `Magic Resist: +${item.magicResist}<br>`;
        }
        if (item.dodgeChance) {
            detailsHTML += `Dodge Chance: +${Math.floor(item.dodgeChance * 100)}%<br>`;
        }
        if (item.blockChance) {
            detailsHTML += `Block Chance: +${Math.floor(item.blockChance * 100)}%<br>`;
        }
        if (item.manaRegen) {
            detailsHTML += `Mana Regen: +${item.manaRegen}/turn<br>`;
        }
        if (item.healthRegen) {
            detailsHTML += `Health Regen: +${item.healthRegen}/turn<br>`;
        }
        if (item.strengthBonus) {
            detailsHTML += `Strength Bonus: +${item.strengthBonus}<br>`;
        }
        if (item.stealthBonus) {
            detailsHTML += `Stealth Bonus: +${item.stealthBonus}<br>`;
        }
        if (item.fireResist) {
            detailsHTML += `Fire Resistance: +${item.fireResist}<br>`;
        }
        if (item.frostResist) {
            detailsHTML += `Frost Resistance: +${item.frostResist}<br>`;
        }
        if (item.shadowResist) {
            detailsHTML += `Shadow Resistance: +${item.shadowResist}<br>`;
        }
        if (item.holyResist) {
            detailsHTML += `Holy Resistance: +${item.holyResist}<br>`;
        }
        if (item.allResist) {
            detailsHTML += `All Resistances: +${item.allResist}<br>`;
        }
        detailsHTML += `Level: ${item.level}<br>`;
        detailsHTML += `Value: ${item.value} gold<br><br>`;

        // NEW: Show set bonus info
        if (item.set) {
            const setBonuses = gameState.itemSets[item.set];
            detailsHTML += `<div class="set-bonus"><strong>Set: ${item.set}</strong><br>`;
            Object.entries(setBonuses).forEach(([pieceCount, bonuses]) => {
                detailsHTML += `${pieceCount} pieces: ${Object.entries(bonuses).map(([stat, value]) => `${stat}: +${value}`).join(', ')}<br>`;
            });
            detailsHTML += `</div><br>`;
        }

        // Equipment comparison
        if (player.equippedArmor) {
            detailsHTML += `<div class="equipment-comparison">`;
            detailsHTML += `<strong>Comparison with ${player.equippedArmor.name}:</strong><br>`;
            
            // Compare defense
            const currentDef = player.equippedArmor.defense;
            const newDef = item.defense;
            
            if (newDef > currentDef) {
                detailsHTML += `<span class="stat-change-positive">Defense: +${newDef - currentDef}</span><br>`;
            } else if (newDef < currentDef) {
                detailsHTML += `<span class="stat-change-negative">Defense: ${newDef - currentDef}</span><br>`;
            } else {
                detailsHTML += `<span class="stat-change-neutral">Defense: No change</span><br>`;
            }
            
            // Compare other stats
            const stats = ['dodgeChance', 'blockChance', 'healthRegen', 'manaRegen'];
            stats.forEach(stat => {
                if (item[stat] || player.equippedArmor[stat]) {
                    const current = player.equippedArmor[stat] || 0;
                    const newVal = item[stat] || 0;
                    const diff = newVal - current;
                    
                    if (diff > 0) {
                        if (stat === 'dodgeChance' || stat === 'blockChance') {
                            detailsHTML += `<span class="stat-change-positive">${stat}: +${Math.floor(diff * 100)}%</span><br>`;
                        } else {
                            detailsHTML += `<span class="stat-change-positive">${stat}: +${diff}</span><br>`;
                        }
                    } else if (diff < 0) {
                        if (stat === 'dodgeChance' || stat === 'blockChance') {
                            detailsHTML += `<span class="stat-change-negative">${stat}: ${Math.floor(diff * 100)}%</span><br>`;
                        } else {
                            detailsHTML += `<span class="stat-change-negative">${stat}: ${diff}</span><br>`;
                        }
                    } else {
                        detailsHTML += `<span class="stat-change-neutral">${stat}: No change</span><br>`;
                    }
                }
            });
            
            detailsHTML += `</div><br>`;
        }

        // Equip button if not already equipped
        if (player.equippedArmor && player.equippedArmor.id === item.id) {
            detailsHTML += `<button class="game-button" disabled>EQUIPPED</button> `;
        } else {
            detailsHTML += `<button class="game-button" onclick="equipItem(${item.id})">EQUIP</button> `;
        }
    } else if (item.type === "consumable") {
        detailsHTML += `Type: Consumable<br>`;
        if (item.effect.health) {
            detailsHTML += `Restores ${item.effect.health} health<br>`;
        } else if (item.effect.mana) {
            detailsHTML += `Restores ${item.effect.mana} mana<br>`;
        } else if (item.effect.damage) {
            detailsHTML += `Deals ${item.effect.damage} damage<br>`;
        } else if (item.effect.strength) {
            detailsHTML += `+${item.effect.strength} Strength for ${item.duration} turns<br>`;
        } else if (item.effect.maxHealth) {
            detailsHTML += `Permanently increases max health by ${item.effect.maxHealth}<br>`;
        } else if (item.effect.stealth) {
            detailsHTML += `Grants stealth for ${item.effect.stealth} turns<br>`;
        } else if (item.effect.revive) {
            if (item.effect.fullHeal) {
                detailsHTML += `Revives with full health when defeated<br>`;
            } else {
                detailsHTML += `Revives with 50% health when defeated<br>`;
            }
        } else if (item.effect.damageReduction) {
            detailsHTML += `Reduces damage taken by 50% for ${item.duration} turns<br>`;
        } else if (item.effect.allStats) {
            detailsHTML += `+${item.effect.allStats} to all stats for ${item.duration} turns<br>`;
        }
        detailsHTML += `Value: ${item.value} gold<br><br>`;

        detailsHTML += `<button class="game-button" onclick="useInventoryItem(${item.id})">USE</button> `;
    } else if (item.type === "quest") {
        detailsHTML += `Type: Quest Item<br>`;
        detailsHTML += `${item.description}<br>`;
        detailsHTML += `Value: ${item.value} gold<br><br>`;
    } else if (item.type === "lore") {
        detailsHTML += `Type: Lore Item<br>`;
        detailsHTML += `${item.description}<br><br>`;
        detailsHTML += `<button class="game-button" onclick="readLore(${item.id})">READ</button> `;
    } else if (item.type === "pet") {
        detailsHTML += `Type: Pet Item<br>`;
        detailsHTML += `${item.description}<br><br>`;
        if (!player.pets.owned.some(pet => pet.type === item.petType)) {
            detailsHTML += `<button class="game-button" onclick="hatchPet(${item.id})">HATCH</button> `;
        } else {
            detailsHTML += `<button class="game-button" disabled>ALREADY OWNED</button> `;
        }
    }

    if (item.type !== "quest" && item.type !== "lore") {
        detailsHTML += `<button class="game-button" onclick="sellItem(${item.id})">SELL</button>`;
    } else {
        detailsHTML += `<button class="game-button" disabled>CAN'T SELL</button>`;
    }
    detailsHTML += `</div>`;

    document.getElementById("item-details").innerHTML = detailsHTML;
}

// NEW: Read lore item
function readLore(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);

    if (!item || item.type !== "lore") return;

    // Mark as read
    if (!player.lore.read.includes(itemId)) {
        player.lore.read.push(itemId);
    }

    // Show lore content
    const loreDetails = document.getElementById("item-details");
    loreDetails.innerHTML = `
        <div class="item-info">
            <h3>${item.name}</h3>
            <p>${item.content}</p>
            <br>
            <button class="game-button" onclick="showInventory()">BACK TO INVENTORY</button>
        </div>
    `;

    addToGameLog(`You read ${item.name} and learn about the world's history.`);
}

// NEW: Hatch pet from pet item
function hatchPet(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);

    if (!item || item.type !== "pet") return;

    // Create pet instance
    const petData = {...gameState.pets[item.petType]};
    player.pets.owned.push(petData);

    // Remove item from inventory
    const itemIndex = player.inventory.findIndex(i => i.id === item.id);
    if (itemIndex !== -1) {
        player.inventory.splice(itemIndex, 1);
    }

    addToGameLog(`<span class="important">You hatched a ${petData.name}! Your new companion joins you.</span>`);
    
    // Check for pet achievement
    gameState.achievements[30].unlocked = true;
    showAchievement("Pet Lover", "Collected your first pet");

    showInventory();
}

// Equip item
function equipItem(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);

    if (!item) return;

    if (item.type === "weapon") {
        // Check level requirement
        if (item.level > player.level) {
            addToGameLog(`You need to be level ${item.level} to equip this weapon!`);
            return;
        }

        // Unequip current weapon if any
        if (player.equippedWeapon) {
            player.inventory.push(player.equippedWeapon);
        }
        player.equippedWeapon = item;

        // Remove from inventory
        const itemIndex = player.inventory.findIndex(i => i.id === item.id);
        if (itemIndex !== -1) {
            player.inventory.splice(itemIndex, 1);
        }

        addToGameLog(`You equipped the ${item.name}.`);
    } else if (item.type === "armor") {
        // Check level requirement
        if (item.level > player.level) {
            addToGameLog(`You need to be level ${item.level} to equip this armor!`);
            return;
        }

        // Unequip current armor if any
        if (player.equippedArmor) {
            player.inventory.push(player.equippedArmor);
        }
        player.equippedArmor = item;

        // Remove from inventory
        const itemIndex = player.inventory.findIndex(i => i.id === item.id);
        if (itemIndex !== -1) {
            player.inventory.splice(itemIndex, 1);
        }

        addToGameLog(`You equipped the ${item.name}.`);
    }

    // NEW: Apply set bonuses
    applySetBonuses();

    showInventory();
    updatePlayerStats();
}

// NEW: Apply set bonuses
function applySetBonuses() {
    const player = gameState.player;
    
    // Clear previous set bonuses
    player.equippedSetItems = [];
    
    // Check equipped items for sets
    const equippedItems = [];
    if (player.equippedWeapon && player.equippedWeapon.set) {
        equippedItems.push(player.equippedWeapon);
    }
    if (player.equippedArmor && player.equippedArmor.set) {
        equippedItems.push(player.equippedArmor);
    }
    
    // Group by set
    const setCounts = {};
    equippedItems.forEach(item => {
        setCounts[item.set] = (setCounts[item.set] || 0) + 1;
    });
    
    // Apply set bonuses
    Object.entries(setCounts).forEach(([setName, count]) => {
        const setBonuses = gameState.itemSets[setName];
        if (setBonuses) {
            // Apply bonuses for the number of pieces equipped
            for (let pieces = count; pieces >= 2; pieces--) {
                if (setBonuses[pieces]) {
                    player.equippedSetItems.push({
                        set: setName,
                        pieces: pieces,
                        bonuses: setBonuses[pieces]
                    });
                    break;
                }
            }
        }
    });
    
    // Log set bonuses
    player.equippedSetItems.forEach(setInfo => {
        addToGameLog(`<span class="important">${setInfo.set} Set Bonus (${setInfo.pieces} pieces) activated!</span>`);
    });
}

// Use item from inventory (outside combat)
function useInventoryItem(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);

    if (!item) return;

    if (item.effect.health) {
        player.health += item.effect.health;
        if (player.health > player.maxHealth) player.health = player.maxHealth;
        addToGameLog(`You use ${item.name} and restore <span class="heal">${item.effect.health}</span> health!`);
    } else if (item.effect.mana) {
        player.mana += item.effect.mana;
        if (player.mana > player.maxMana) player.mana = player.maxMana;
        addToGameLog(`You use ${item.name} and restore <span class="heal">${item.effect.mana}</span> mana!`);
    } else if (item.effect.maxHealth) {
        player.maxHealth += item.effect.maxHealth;
        player.health += item.effect.maxHealth;
        addToGameLog(`You use ${item.name} and permanently increase your max health by <span class="heal">${item.effect.maxHealth}</span>!`);
    } else if (item.effect.strength) {
        player.strength += item.effect.strength;
        player.buffs.push({
            name: "Strength Potion",
            duration: item.duration,
            effect: "strength",
            amount: item.effect.strength
        });
        addToGameLog(`You use ${item.name} and gain <span class="heal">+${item.effect.strength} Strength</span> for ${item.duration} turns!`);
    } else if (item.effect.revive) {
        addToGameLog(`You save the ${item.name} for when you might need it.`);
    } else if (item.effect.allStats) {
        player.strength += item.effect.allStats;
        player.dexterity += item.effect.allStats;
        player.intelligence += item.effect.allStats;
        player.constitution += item.effect.allStats;
        player.buffs.push({
            name: "Godly Power",
            duration: item.duration,
            effect: "allStats",
            amount: item.effect.allStats
        });
        addToGameLog(`You use ${item.name} and gain <span class="heal">+${item.effect.allStats} to all stats</span> for ${item.duration} turns!`);
    }

    // Remove item from inventory if not permanent
    if (!item.effect.revive) {
        const itemIndex = player.inventory.findIndex(i => i.id === item.id);
        if (itemIndex !== -1) {
            player.inventory.splice(itemIndex, 1);
        }
    }

    showInventory();
    updatePlayerStats();
}

// Sell item
function sellItem(itemId) {
    const player = gameState.player;
    const item = player.inventory.find(i => i.id === itemId);

    if (!item) return;

    // Can't sell equipped items
    if ((player.equippedWeapon && player.equippedWeapon.id === item.id) ||
        (player.equippedArmor && player.equippedArmor.id === item.id)) {
        addToGameLog("You can't sell equipped items!");
        return;
    }

    const sellValue = Math.floor(item.value * 0.75);
    player.gold += sellValue;

    // Remove from inventory
    const itemIndex = player.inventory.findIndex(i => i.id === item.id);
    if (itemIndex !== -1) {
        player.inventory.splice(itemIndex, 1);
    }

    addToGameLog(`You sold ${item.name} for <span class="gold">${sellValue} gold</span>.`);
    showInventory();
    updatePlayerStats();
}

// Generate shop items
function generateShopItems() {
    const player = gameState.player;
    gameState.shopItems = [];

    // Generate 3 weapons, 2 armor, and 3 consumables
    const allWeapons = gameState.items.weapons.filter(w => w.level <= player.level + 2);
    const allArmor = gameState.items.armor.filter(a => a.level <= player.level + 2);
    const allConsumables = gameState.items.consumables;

    // Add random weapons
    for (let i = 0; i < 3; i++) {
        if (allWeapons.length > 0) {
            const randomWeapon = {...allWeapons[Math.floor(Math.random() * allWeapons.length)]};
            gameState.shopItems.push(randomWeapon);
        }
    }

    // Add random armor
    for (let i = 0; i < 2; i++) {
        if (allArmor.length > 0) {
            const randomArmor = {...allArmor[Math.floor(Math.random() * allArmor.length)]};
            gameState.shopItems.push(randomArmor);
        }
    }

    // Add random consumables
    for (let i = 0; i < 3; i++) {
        if (allConsumables.length > 0) {
            const randomConsumable = {...allConsumables[Math.floor(Math.random() * allConsumables.length)]};
            gameState.shopItems.push(randomConsumable);
        }
    }
}

// Show shop
function showShop() {
    const player = gameState.player;
    const shopDiv = document.getElementById("shop-items");

    if (gameState.shopItems.length === 0) {
        shopDiv.innerHTML = "The shop is currently empty.";
        return;
    }

    let shopHTML = "<h3>Shop:</h3>";
    shopHTML += `<span class="gold">Your gold: ${player.gold}</span><br><br>`;

    gameState.shopItems.forEach(item => {
        shopHTML += `<div style="margin-bottom:10px;border-bottom:1px solid #333;padding-bottom:5px;">`;
        shopHTML += `<strong>${item.name}</strong> - ${item.value} gold<br>`;

        if (item.type === "weapon") {
            shopHTML += `Damage: ${item.damage} `;
            if (item.magicDamage) shopHTML += `+ ${item.magicDamage} magic `;
            if (item.critChance) shopHTML += `(${Math.floor(item.critChance * 100)}% crit) `;
            if (item.lifesteal) shopHTML += `(${Math.floor(item.lifesteal * 100)}% lifesteal) `;
            if (item.backstabDamage) shopHTML += `(${Math.floor((item.backstabDamage - 1) * 100)}% backstab) `;
            shopHTML += `| Level: ${item.level}`;
        } else if (item.type === "armor") {
            shopHTML += `Defense: ${item.defense} `;
            if (item.magicResist) shopHTML += `Magic Resist: ${item.magicResist} `;
            if (item.dodgeChance) shopHTML += `Dodge: ${Math.floor(item.dodgeChance * 100)}% `;
            if (item.blockChance) shopHTML += `Block: ${Math.floor(item.blockChance * 100)}% `;
            if (item.stealthBonus) shopHTML += `Stealth: +${item.stealthBonus} `;
            shopHTML += `| Level: ${item.level}`;
        } else if (item.type === "consumable") {
            if (item.effect.health) {
                shopHTML += `Restores ${item.effect.health} health `;
            } else if (item.effect.mana) {
                shopHTML += `Restores ${item.effect.mana} mana `;
            } else if (item.effect.damage) {
                shopHTML += `Deals ${item.effect.damage} damage `;
            } else if (item.effect.maxHealth) {
                shopHTML += `+${item.effect.maxHealth} max HP `;
            } else if (item.effect.stealth) {
                shopHTML += `Grants stealth for ${item.effect.stealth} turns `;
            }
        }

        shopHTML += `<br><button class="game-button" onclick="buyItem(${item.id})" ${player.gold < item.value ? "disabled" : ""}>BUY</button>`;
        shopHTML += `</div>`;
    });

    shopDiv.innerHTML = shopHTML;
}

// Refresh shop items
function refreshShop() {
    const player = gameState.player;
    if (player.gold < 50) {
        addToGameLog("You need 50 gold to refresh the shop!");
        return;
    }

    player.gold -= 50;
    generateShopItems();
    showShop();
    addToGameLog("The shopkeeper brings out new items... (-50 gold)");
    updatePlayerStats();
}

// Buy item from shop
function buyItem(itemId) {
    const player = gameState.player;
    const item = gameState.shopItems.find(i => i.id === itemId);

    if (!item) return;

    if (player.gold >= item.value) {
        player.gold -= item.value;
        player.inventory.push({...item});

        // Remove from shop
        const itemIndex = gameState.shopItems.findIndex(i => i.id === item.id);
        if (itemIndex !== -1) {
            gameState.shopItems.splice(itemIndex, 1);
        }

        addToGameLog(`You bought ${item.name} for <span class="gold">${item.value} gold</span>.`);
        showShop();
        updatePlayerStats();
    } else {
        addToGameLog("Not enough gold!");
    }
}

// Generate quests
function generateQuests() {
    const player = gameState.player;
    const availableQuests = gameState.quests.filter(q => q.level <= player.level && 
        !gameState.player.quests.active.some(aq => aq.id === q.id) &&
        !gameState.player.quests.completed.some(cq => cq.id === q.id));

    // Add up to 3 available quests
    for (let i = 0; i < Math.min(3, availableQuests.length); i++) {
        const quest = {...availableQuests[i]};
        gameState.player.quests.active.push(quest);
        addToGameLog(`New quest available: ${quest.name}`);
    }
}

// Show quests screen
function showQuests() {
    const player = gameState.player;
    const activeQuestsDiv = document.getElementById("active-quests");
    const completedQuestsDiv = document.getElementById("completed-quests");

    let activeHTML = "<h3>Active Quests:</h3>";
    if (player.quests.active.length === 0) {
        activeHTML += "No active quests.<br>";
    } else {
        player.quests.active.forEach(quest => {
            activeHTML += `<div class="quest quest-active">`;
            activeHTML += `<strong>${quest.name}</strong><br>`;
            activeHTML += `${quest.description}<br>`;

            if (quest.objective.type === "kill") {
                if (Array.isArray(quest.objective.target)) {
                    quest.objective.target.forEach((target, idx) => {
                        activeHTML += `${target}: ${quest.objective.current[idx]}/${quest.objective.count[idx]}<br>`;
                    });
                } else {
                    activeHTML += `${quest.objective.target}: ${quest.objective.current}/${quest.objective.count}<br>`;
                }
            } else if (quest.objective.type === "collect") {
                activeHTML += `${quest.objective.target}: ${quest.objective.current}/${quest.objective.count}<br>`;
            }

            activeHTML += `Reward: ${quest.reward.gold} gold, ${quest.reward.xp} XP`;
            if (quest.reward.item) {
                const item = gameState.items.weapons.concat(gameState.items.armor, gameState.items.consumables)
                    .find(i => i.id === quest.reward.item);
                if (item) {
                    activeHTML += `, ${item.name}`;
                }
            }
            activeHTML += `</div>`;
        });
    }

    let completedHTML = "<h3>Completed Quests:</h3>";
    if (player.quests.completed.length === 0) {
        completedHTML += "No completed quests.<br>";
    } else {
        player.quests.completed.forEach(quest => {
            completedHTML += `<div class="quest quest-completed">`;
            completedHTML += `<strong>${quest.name}</strong><br>`;
            completedHTML += `${quest.description}<br>`;
            completedHTML += `Reward: ${quest.reward.gold} gold, ${quest.reward.xp} XP`;
            if (quest.reward.item) {
                const item = gameState.items.weapons.concat(gameState.items.armor, gameState.items.consumables)
                    .find(i => i.id === quest.reward.item);
                if (item) {
                    completedHTML += `, ${item.name}`;
                }
            }
            completedHTML += `</div>`;
        });
    }

    activeQuestsDiv.innerHTML = activeHTML;
    completedQuestsDiv.innerHTML = completedHTML;
}

// Update quest progress
function updateQuestProgress(enemyName) {
    const player = gameState.player;

    player.quests.active.forEach(quest => {
        if (quest.objective.type === "kill") {
            if (Array.isArray(quest.objective.target)) {
                const targetIndex = quest.objective.target.indexOf(enemyName);
                if (targetIndex !== -1 && quest.objective.current[targetIndex] < quest.objective.count[targetIndex]) {
                    quest.objective.current[targetIndex]++;
                    addToGameLog(`Quest progress: ${quest.name} (${quest.objective.current[targetIndex]}/${quest.objective.count[targetIndex]} ${enemyName}s)`);
                }
            } else if (quest.objective.target === enemyName && quest.objective.current < quest.objective.count) {
                quest.objective.current++;
                addToGameLog(`Quest progress: ${quest.name} (${quest.objective.current}/${quest.objective.count} ${enemyName}s)`);
            }
        }
    });

    // Check for completed quests
    for (let i = player.quests.active.length - 1; i >= 0; i--) {
        const quest = player.quests.active[i];
        let isComplete = false;

        if (quest.objective.type === "kill") {
            if (Array.isArray(quest.objective.target)) {
                isComplete = quest.objective.target.every((_, idx) => 
                    quest.objective.current[idx] >= quest.objective.count[idx]);
            } else {
                isComplete = quest.objective.current >= quest.objective.count;
            }
        } else if (quest.objective.type === "collect") {
            // Check inventory for collected items
            const itemCount = player.inventory.filter(i => i.name === quest.objective.target).length;
            isComplete = itemCount >= quest.objective.count;
        }

        if (isComplete) {
            completeQuest(i);
        }
    }
}

// Complete a quest
function completeQuest(index) {
    const player = gameState.player;
    const quest = player.quests.active[index];

    // Give rewards
    player.gold += quest.reward.gold;
    player.xp += quest.reward.xp;
    addToGameLog(`<span class="important">Quest completed: ${quest.name}!</span>`);
    addToGameLog(`You received ${quest.reward.gold} gold and ${quest.reward.xp} XP!`);

    // Give item reward if any
    if (quest.reward.item) {
        const item = {...gameState.items.weapons.concat(gameState.items.armor, gameState.items.consumables)
            .find(i => i.id === quest.reward.item)};
        player.inventory.push(item);
        addToGameLog(`You received a <span class="item">${item.name}</span>!`);
    }

    // Remove collected items if needed
    if (quest.objective.type === "collect") {
        const itemsToRemove = quest.objective.count;
        let removed = 0;
        for (let i = player.inventory.length - 1; i >= 0 && removed < itemsToRemove; i--) {
            if (player.inventory[i].name === quest.objective.target) {
                player.inventory.splice(i, 1);
                removed++;
            }
        }
    }

    // Move to completed
    player.quests.completed.push(quest);
    player.quests.active.splice(index, 1);

    // Check for level up
    checkLevelUp();

    // Generate new quests if needed
    if (player.quests.active.length < 3) {
        generateQuests();
    }

    // Check for completionist achievement
    if (gameState.quests.every(q => player.quests.completed.some(cq => cq.id === q.id))) {
        gameState.achievements[15].unlocked = true;
        showAchievement("Completionist", "Completed all quests");
    }
}

// NEW: Show talent tree
function showTalentTree() {
    const player = gameState.player;
    const talentDiv = document.getElementById("talent-tree");
    
    if (!player.class) {
        talentDiv.innerHTML = "You need to choose a class first!";
        return;
    }
    
    let talentHTML = `<h3>Talent Tree - ${player.class.toUpperCase()}</h3>`;
    talentHTML += `<p>Talent Points Available: <span class="xp">${player.talentPoints}</span></p>`;
    
    const talentTree = gameState.talentTrees[player.class];
    const talentNames = Object.keys(talentTree);
    
    talentHTML += `<div class="talent-path">`;
    
    talentNames.forEach((talentName, index) => {
        const talent = talentTree[talentName];
        const isUnlocked = talent.currentPoints > 0;
        const isMaxed = talent.currentPoints >= talent.maxPoints;
        const canUpgrade = player.talentPoints > 0 && !isMaxed;
        
        let nodeClass = "talent-node";
        if (isUnlocked) nodeClass += " unlocked";
        if (canUpgrade) nodeClass += " available";
        if (isMaxed) nodeClass += " locked";
        
        talentHTML += `<div class="${nodeClass}" onclick="upgradeTalent('${talentName}')">`;
        talentHTML += `${talentName}<br>${talent.currentPoints}/${talent.maxPoints}`;
        talentHTML += `</div>`;
        
        // Add connector between nodes (except for the last one)
        if (index < talentNames.length - 1) {
            let connectorClass = "talent-connector";
            if (isUnlocked) connectorClass += " unlocked";
            talentHTML += `<div class="${connectorClass}"></div>`;
        }
    });
    
    talentHTML += `</div>`;
    
    // Add talent descriptions
    talentHTML += `<div class="talent-description">`;
    talentHTML += `<h4>Talent Descriptions:</h4>`;
    talentNames.forEach(talentName => {
        const talent = talentTree[talentName];
        talentHTML += `<p><strong>${talentName}</strong>: ${talent.effect} (${talent.currentPoints}/${talent.maxPoints})</p>`;
    });
    talentHTML += `</div>`;
    
    talentDiv.innerHTML = talentHTML;
}

// NEW: Upgrade a talent
function upgradeTalent(talentName) {
    const player = gameState.player;
    
    if (!player.class) return;
    
    const talentTree = gameState.talentTrees[player.class];
    const talent = talentTree[talentName];
    
    if (!talent) return;
    
    // Check if we can upgrade this talent
    if (player.talentPoints <= 0) {
        addToGameLog("You don't have any talent points!");
        return;
    }
    
    if (talent.currentPoints >= talent.maxPoints) {
        addToGameLog("This talent is already maxed out!");
        return;
    }
    
    // Upgrade the talent
    talent.currentPoints++;
    player.talentPoints--;
    
    addToGameLog(`<span class="important">You upgraded ${talentName} to ${talent.currentPoints}/${talent.maxPoints}!</span>`);
    
    // Add visual feedback
    const talentNodes = document.querySelectorAll('.talent-node');
    talentNodes.forEach(node => {
        if (node.textContent.includes(talentName)) {
            node.classList.add("talent-unlock");
            setTimeout(() => {
                node.classList.remove("talent-unlock");
            }, 500);
        }
    });
    
    // Update the talent screen
    showTalentTree();
    updatePlayerStats();
    
    // Check for talent achievement
    checkAchievements();
}

// NEW: Generate challenges
function generateChallenges() {
    const player = gameState.player;
    
    // Check if challenges need to be reset
    const now = Date.now();
    
    // Reset daily challenges if needed
    if (now > player.challenges.daily.resetTime) {
        player.challenges.daily.completed = [];
        player.challenges.daily.resetTime = now + (24 * 60 * 60 * 1000);
        addToGameLog("<span class='important'>Daily challenges have been reset!</span>");
    }
    
    // Reset weekly challenges if needed
    if (now > player.challenges.weekly.resetTime) {
        player.challenges.weekly.completed = [];
        player.challenges.weekly.resetTime = now + (7 * 24 * 60 * 60 * 1000);
        addToGameLog("<span class='important'>Weekly challenges have been reset!</span>");
    }
    
    // Initialize challenge progress if not already done
    if (!player.challenges.daily.progress) {
        player.challenges.daily.progress = {};
        gameState.challenges.daily.forEach(challenge => {
            player.challenges.daily.progress[challenge.id] = { current: 0 };
        });
    }
    
    if (!player.challenges.weekly.progress) {
        player.challenges.weekly.progress = {};
        gameState.challenges.weekly.forEach(challenge => {
            player.challenges.weekly.progress[challenge.id] = { current: 0 };
        });
    }
}

// NEW: Show challenges screen
function showChallenges() {
    const player = gameState.player;
    const challengesDiv = document.getElementById("challenges-info");
    const dailyDiv = document.getElementById("daily-challenges");
    const weeklyDiv = document.getElementById("weekly-challenges");
    
    let challengesHTML = "<h3>Challenges</h3>";
    challengesHTML += `<p>Complete challenges for bonus rewards!</p>`;
    
    challengesDiv.innerHTML = challengesHTML;
    
    // Show daily challenges
    let dailyHTML = "<h4>Daily Challenges</h4>";
    if (gameState.challenges.daily.length === 0) {
        dailyHTML += "No daily challenges available.<br>";
    } else {
        gameState.challenges.daily.forEach(challenge => {
            const isCompleted = player.challenges.daily.completed.includes(challenge.id);
            const progress = player.challenges.daily.progress[challenge.id] || { current: 0 };
            
            dailyHTML += `<div class="challenge challenge-daily ${isCompleted ? 'challenge-completed' : ''}">`;
            dailyHTML += `<strong>${challenge.name}</strong><br>`;
            dailyHTML += `${challenge.description}<br>`;
            
            if (challenge.objective.type === "kill") {
                dailyHTML += `Progress: ${progress.current}/${challenge.objective.count}<br>`;
            } else if (challenge.objective.type === "collect") {
                dailyHTML += `Progress: ${progress.current}/${challenge.objective.count}<br>`;
            } else if (challenge.objective.type === "use") {
                dailyHTML += `Progress: ${progress.current}/${challenge.objective.count}<br>`;
            } else if (challenge.objective.type === "reach") {
                dailyHTML += `Progress: ${player.level >= challenge.objective.count ? 'Completed' : 'Not completed'}<br>`;
            }
            
            dailyHTML += `Reward: <span class="challenge-reward">${challenge.reward.gold} gold, ${challenge.reward.xp} XP</span>`;
            if (challenge.reward.item) {
                const item = gameState.items.weapons.concat(gameState.items.armor, gameState.items.consumables)
                    .find(i => i.id === challenge.reward.item);
                if (item) {
                    dailyHTML += `, ${item.name}`;
                }
            }
            dailyHTML += `</div>`;
        });
    }
    
    // Show weekly challenges
    let weeklyHTML = "<h4>Weekly Challenges</h4>";
    if (gameState.challenges.weekly.length === 0) {
        weeklyHTML += "No weekly challenges available.<br>";
    } else {
        gameState.challenges.weekly.forEach(challenge => {
            const isCompleted = player.challenges.weekly.completed.includes(challenge.id);
            const progress = player.challenges.weekly.progress[challenge.id] || { current: 0 };
            
            weeklyHTML += `<div class="challenge challenge-weekly ${isCompleted ? 'challenge-completed' : ''}">`;
            weeklyHTML += `<strong>${challenge.name}</strong><br>`;
            weeklyHTML += `${challenge.description}<br>`;
            
            if (challenge.objective.type === "kill") {
                weeklyHTML += `Progress: ${progress.current}/${challenge.objective.count}<br>`;
            } else if (challenge.objective.type === "complete") {
                weeklyHTML += `Progress: ${progress.current}/${challenge.objective.count}<br>`;
            } else if (challenge.objective.type === "reach") {
                weeklyHTML += `Progress: ${player.level >= challenge.objective.count ? 'Completed' : 'Not completed'}<br>`;
            }
            
            weeklyHTML += `Reward: <span class="challenge-reward">${challenge.reward.gold} gold, ${challenge.reward.xp} XP</span>`;
            if (challenge.reward.item) {
                const item = gameState.items.weapons.concat(gameState.items.armor, gameState.items.consumables)
                    .find(i => i.id === challenge.reward.item);
                if (item) {
                    weeklyHTML += `, ${item.name}`;
                }
            }
            weeklyHTML += `</div>`;
        });
    }
    
    dailyDiv.innerHTML = dailyHTML;
    weeklyDiv.innerHTML = weeklyHTML;
}

// NEW: Update challenge progress
function updateChallengeProgress(enemyName) {
    const player = gameState.player;
    
    // Update daily challenges
    gameState.challenges.daily.forEach(challenge => {
        if (player.challenges.daily.completed.includes(challenge.id)) return;
        
        const progress = player.challenges.daily.progress[challenge.id] || { current: 0 };
        
        if (challenge.objective.type === "kill") {
            if (challenge.objective.area && player.currentArea === challenge.objective.area) {
                progress.current++;
                if (progress.current >= challenge.objective.count) {
                    completeChallenge("daily", challenge.id);
                }
            }
        } else if (challenge.objective.type === "collect") {
            if (challenge.objective.target === "gold" && player.gold >= challenge.objective.count) {
                progress.current = challenge.objective.count;
                completeChallenge("daily", challenge.id);
            }
        }
    });
    
    // Update weekly challenges
    gameState.challenges.weekly.forEach(challenge => {
        if (player.challenges.weekly.completed.includes(challenge.id)) return;
        
        const progress = player.challenges.weekly.progress[challenge.id] || { current: 0 };
        
        if (challenge.objective.type === "kill") {
            if (challenge.objective.target === "boss" && gameState.bosses[player.currentArea]?.name === enemyName) {
                progress.current++;
                if (progress.current >= challenge.objective.count) {
                    completeChallenge("weekly", challenge.id);
                }
            }
        } else if (challenge.objective.type === "reach") {
            if (challenge.objective.target === "level" && player.level >= challenge.objective.count) {
                progress.current = challenge.objective.count;
                completeChallenge("weekly", challenge.id);
            }
        }
    });
    
    // Update skill use challenge
    const skillChallenge = gameState.challenges.daily.find(c => c.objective.type === "use" && c.objective.target === "skills");
    if (skillChallenge && !player.challenges.daily.completed.includes(skillChallenge.id)) {
        // This would need to be tracked separately when skills are used
    }
    
    // Update quest completion challenge
    const questChallenge = gameState.challenges.weekly.find(c => c.objective.type === "complete" && c.objective.target === "quests");
    if (questChallenge && !player.challenges.weekly.completed.includes(questChallenge.id)) {
        const progress = player.challenges.weekly.progress[questChallenge.id] || { current: 0 };
        progress.current = player.quests.completed.length;
        if (progress.current >= questChallenge.objective.count) {
            completeChallenge("weekly", questChallenge.id);
        }
    }
}

// NEW: Complete a challenge
function completeChallenge(type, challengeId) {
    const player = gameState.player;
    const challenge = gameState.challenges[type].find(c => c.id === challengeId);
    
    if (!challenge) return;
    
    // Give rewards
    player.gold += challenge.reward.gold;
    player.xp += challenge.reward.xp;
    addToGameLog(`<span class="important">${type === 'daily' ? 'Daily' : 'Weekly'} challenge completed: ${challenge.name}!</span>`);
    addToGameLog(`You received ${challenge.reward.gold} gold and ${challenge.reward.xp} XP!`);

    // Give item reward if any
    if (challenge.reward.item) {
        const item = {...gameState.items.weapons.concat(gameState.items.armor, gameState.items.consumables)
            .find(i => i.id === challenge.reward.item)};
        player.inventory.push(item);
        addToGameLog(`You received a <span class="item">${item.name}</span>!`);
    }
    
    // Mark as completed
    player.challenges[type].completed.push(challengeId);
    
    // Check for level up
    checkLevelUp();
}

// NEW: Show pets screen
function showPetsScreen() {
    const player = gameState.player;
    const petsDiv = document.getElementById("pets-info");
    const availablePetsDiv = document.getElementById("available-pets");
    const activePetDiv = document.getElementById("active-pet");
    
    let petsHTML = "<h3>Pets</h3>";
    petsHTML += `<p>Your loyal companions who fight alongside you!</p>`;
    
    petsDiv.innerHTML = petsHTML;
    
    // Show available pets
    let availableHTML = "<h4>Your Pets:</h4>";
    if (player.pets.owned.length === 0) {
        availableHTML += "You don't have any pets yet. Find pet eggs in your adventures!<br>";
    } else {
        player.pets.owned.forEach(pet => {
            const isActive = player.pets.active && player.pets.active.type === pet.type;
            availableHTML += `<div class="pet-card ${isActive ? 'active' : ''}" onclick="setActivePet('${pet.type}')">`;
            availableHTML += `<strong>${pet.name}</strong> (Level ${pet.level})<br>`;
            availableHTML += `<div class="pet-stats">Type: ${pet.type} | Health: ${pet.stats.health} | Damage: ${pet.stats.damage} | Speed: ${pet.stats.speed}</div>`;
            availableHTML += `<div class="pet-stats">XP: ${pet.xp}/${pet.level * 100}</div>`;
            availableHTML += `<strong>Abilities:</strong><br>`;
            pet.abilities.forEach(ability => {
                if (pet.level >= ability.level) {
                    availableHTML += `• ${ability.name}: ${ability.description}<br>`;
                } else {
                    availableHTML += `• ${ability.name}: Unlocks at level ${ability.level}<br>`;
                }
            });
            availableHTML += `</div>`;
        });
    }
    
    // Show active pet info
    let activeHTML = "<h4>Active Pet:</h4>";
    if (player.pets.active) {
        const pet = player.pets.active;
        activeHTML += `<div class="pet-card active">`;
        activeHTML += `<strong>${pet.name}</strong> (Level ${pet.level})<br>`;
        activeHTML += `<div class="pet-stats">Type: ${pet.type} | Health: ${pet.stats.health} | Damage: ${pet.stats.damage} | Speed: ${pet.stats.speed}</div>`;
        activeHTML += `<div class="pet-stats">XP: ${pet.xp}/${pet.level * 100}</div>`;
        activeHTML += `<strong>Active Abilities:</strong><br>`;
        pet.abilities.forEach(ability => {
            if (pet.level >= ability.level) {
                activeHTML += `• ${ability.name}: ${ability.description}<br>`;
            }
        });
        activeHTML += `<br><button class="game-button" onclick="dismissPet()">DISMISS PET</button>`;
        activeHTML += `</div>`;
    } else {
        activeHTML += "No active pet. Select a pet from your collection to have it join you in combat!";
    }
    
    availablePetsDiv.innerHTML = availableHTML;
    activePetDiv.innerHTML = activeHTML;
}

// NEW: Set active pet
function setActivePet(petType) {
    const player = gameState.player;
    const pet = player.pets.owned.find(p => p.type === petType);
    
    if (!pet) return;
    
    player.pets.active = pet;
    addToGameLog(`<span class="important">${pet.name} is now your active companion!</span>`);
    
    showPetsScreen();
    updatePlayerStats();
}

// NEW: Dismiss active pet
function dismissPet() {
    const player = gameState.player;
    
    if (player.pets.active) {
        addToGameLog(`${player.pets.active.name} has been dismissed.`);
        player.pets.active = null;
    }
    
    showPetsScreen();
    updatePlayerStats();
}

// NEW: Show lore screen
function showLoreScreen() {
    const player = gameState.player;
    const loreDiv = document.getElementById("lore-collection");
    
    let loreHTML = "<h3>Lore Collection</h3>";
    loreHTML += `<p>Ancient knowledge you've discovered in your travels.</p>`;
    
    if (player.lore.collected.length === 0) {
        loreHTML += "<br>You haven't discovered any lore yet. Explore the world to find ancient texts and artifacts!";
    } else {
        player.lore.collected.forEach(loreId => {
            const loreItem = gameState.items.loreItems.find(l => l.id === loreId);
            if (loreItem) {
                const isRead = player.lore.read.includes(loreId);
                loreHTML += `<div class="lore-item ${isRead ? 'read' : 'unread'}" onclick="toggleLoreContent(${loreId})">`;
                loreHTML += `<strong>${loreItem.name}</strong><br>`;
                loreHTML += `<em>${loreItem.description}</em>`;
                loreHTML += `<div class="lore-content" id="lore-content-${loreId}">`;
                loreHTML += `<p>${loreItem.content}</p>`;
                loreHTML += `</div>`;
                loreHTML += `</div>`;
            }
        });
    }
    
    loreDiv.innerHTML = loreHTML;
}

// NEW: Toggle lore content visibility
function toggleLoreContent(loreId) {
    const content = document.getElementById(`lore-content-${loreId}`);
    content.classList.toggle("expanded");
    
    // Mark as read when expanded
    if (content.classList.contains("expanded") && !gameState.player.lore.read.includes(loreId)) {
        gameState.player.lore.read.push(loreId);
        
        // Update the item class
        const loreItem = document.querySelector(`[onclick="toggleLoreContent(${loreId})"]`);
        if (loreItem) {
            loreItem.classList.remove("unread");
            loreItem.classList.add("read");
        }
    }
}

// NEW: Show endgame screen
function showEndgameScreen() {
    const player = gameState.player;
    const endgameDiv = document.getElementById("endgame-content");
    
    let endgameHTML = "<h3>Endgame Content</h3>";
    endgameHTML += `<p>Challenges for the most powerful adventurers.</p>`;
    
    // Show raids
    endgameHTML += `<h4>Raids</h4>`;
    gameState.endgameContent.raids.forEach(raid => {
        const isUnlocked = player.level >= raid.requiredLevel;
        const isCompleted = player.endgame.raidProgress[raid.id];
        
        endgameHTML += `<div class="raid-boss ${isCompleted ? 'defeated' : ''}">`;
        endgameHTML += `<strong>${raid.name}</strong><br>`;
        endgameHTML += `${raid.description}<br>`;
        endgameHTML += `Required Level: ${raid.requiredLevel}<br>`;
        endgameHTML += `<strong>Bosses:</strong> ${raid.bosses.map(b => b.name).join(', ')}<br>`;
        endgameHTML += `<strong>Rewards:</strong> ${raid.rewards.gold} gold, ${raid.rewards.xp} XP<br>`;
        
        if (isUnlocked) {
            if (isCompleted) {
                endgameHTML += `<button class="game-button" disabled>COMPLETED</button>`;
            } else {
                endgameHTML += `<button class="game-button" onclick="startRaid(${raid.id})">ENTER RAID</button>`;
            }
        } else {
            endgameHTML += `<button class="game-button" disabled>LOCKED (Level ${raid.requiredLevel}+)</button>`;
        }
        
        endgameHTML += `</div>`;
    });
    
    // Show infinite dungeon
    endgameHTML += `<h4>Infinite Dungeon</h4>`;
    endgameHTML += `<p>Current Floor: ${player.endgame.dungeonFloor}</p>`;
    endgameHTML += `<button class="game-button" onclick="enterInfiniteDungeon()">ENTER DUNGEON</button>`;
    
    // Show arena
    endgameHTML += `<h4>Arena</h4>`;
    endgameHTML += `<p>Current Wave: ${player.endgame.arenaWave}</p>`;
    endgameHTML += `<button class="game-button" onclick="enterArena()">ENTER ARENA</button>`;
    
    // Show prestige system
    endgameHTML += `<h4>Prestige System</h4>`;
    if (player.level >= 30) {
        endgameHTML += `<div class="prestige-option available">`;
        endgameHTML += `<strong>Prestige</strong><br>`;
        endgameHTML += `Reset your character to level 1 in exchange for permanent bonuses.<br>`;
        endgameHTML += `You will keep: Gold, Items, Pets, Lore<br>`;
        endgameHTML += `You will lose: Level, Stats, Talent Points<br>`;
        endgameHTML += `<br><button class="game-button" onclick="prestige()">PRESTIGE NOW</button>`;
        endgameHTML += `</div>`;
    } else {
        endgameHTML += `<div class="prestige-option">`;
        endgameHTML += `<strong>Prestige</strong><br>`;
        endgameHTML += `Available at level 30<br>`;
        endgameHTML += `</div>`;
    }
    
    endgameDiv.innerHTML = endgameHTML;
}

// NEW: Start a raid
function startRaid(raidId) {
    const player = gameState.player;
    const raid = gameState.endgameContent.raids.find(r => r.id === raidId);
    
    if (!raid || player.level < raid.requiredLevel) return;
    
    addToGameLog(`<span class="important">You enter ${raid.name}!</span>`);
    addToGameLog("This is a challenging multi-phase encounter. Prepare yourself!");
    
    // For now, we'll simulate a successful raid completion
    // In a full implementation, this would be a multi-stage combat
    
    // Give rewards
    player.gold += raid.rewards.gold;
    player.xp += raid.rewards.xp;
    addToGameLog(`<span class="important">You have completed ${raid.name}!</span>`);
    addToGameLog(`You received ${raid.rewards.gold} gold and ${raid.rewards.xp} XP!`);
    
    // Give item rewards
    raid.rewards.items.forEach(itemId => {
        const item = {...gameState.items.weapons.concat(gameState.items.armor).find(i => i.id === itemId)};
        if (item) {
            player.inventory.push(item);
            addToGameLog(`You received a <span class="item">${item.name}</span>!`);
        }
    });
    
    // Mark as completed
    player.endgame.raidProgress[raidId] = true;
    
    // Check for raid achievement
    if (!gameState.achievements[33].unlocked) {
        gameState.achievements[33].unlocked = true;
        showAchievement("Raider", "Completed your first raid");
    }
    
    showScreen("main");
}

// NEW: Enter infinite dungeon
function enterInfiniteDungeon() {
    const player = gameState.player;
    
    addToGameLog(`<span class="important">You enter the Infinite Dungeon at floor ${player.endgame.dungeonFloor}!</span>`);
    
    // For now, we'll simulate dungeon progression
    // In a full implementation, this would generate random encounters
    
    const floor = player.endgame.dungeonFloor;
    const enemiesDefeated = 3 + Math.floor(floor / 5);
    const goldReward = 100 * floor;
    const xpReward = 200 * floor;
    
    // Simulate combat
    addToGameLog(`You defeat ${enemiesDefeated} enemies on floor ${floor}!`);
    
    // Give rewards
    player.gold += goldReward;
    player.xp += xpReward;
    addToGameLog(`You found <span class="gold">${goldReward} gold</span> and gained <span class="xp">${xpReward} XP</span>!`);
    
    // Special rewards every 5 floors
    if (floor % 5 === 0) {
        const specialReward = Math.floor(floor / 5) * 500;
        player.gold += specialReward;
        addToGameLog(`<span class="important">Floor ${floor} Bonus: ${specialReward} gold!</span>`);
    }
    
    // Special rewards every 10 floors
    if (floor % 10 === 0) {
        addToGameLog(`<span class="important">You found a legendary chest on floor ${floor}!</span>`);
        // In full implementation, this would give a random legendary item
    }
    
    // Advance to next floor
    player.endgame.dungeonFloor++;
    
    // Check for dungeon achievement
    if (player.endgame.dungeonFloor >= 100 && !gameState.achievements[34].unlocked) {
        gameState.achievements[34].unlocked = true;
        showAchievement("Dungeon Master", "Reached floor 100 in the Infinite Dungeon");
    }
    
    // Check for level up
    checkLevelUp();
    
    showScreen("main");
}

// NEW: Enter arena
function enterArena() {
    const player = gameState.player;
    const nextWave = player.endgame.arenaWave + 1;
    
    addToGameLog(`<span class="important">You enter the Arena at wave ${nextWave}!</span>`);
    
    // For now, we'll simulate arena progression
    // In a full implementation, this would be wave-based combat
    
    const waveData = gameState.endgameContent.arena.waves.find(w => w.wave === nextWave);
    if (waveData) {
        addToGameLog(`You face: ${waveData.enemies.join(', ')}`);
        
        // Simulate combat
        addToGameLog("You defeat all enemies in the arena!");
        
        // Give rewards
        player.gold += waveData.reward.gold;
        player.xp += waveData.reward.xp;
        addToGameLog(`You received <span class="gold">${waveData.reward.gold} gold</span> and <span class="xp">${waveData.reward.xp} XP</span>!`);
        
        // Advance to next wave
        player.endgame.arenaWave = nextWave;
        
        // Check for arena achievement
        if (player.endgame.arenaWave >= 50 && !gameState.achievements[35].unlocked) {
            gameState.achievements[35].unlocked = true;
            showAchievement("Arena Champion", "Completed wave 50 in the Arena");
        }
    } else {
        // Generate random wave for higher levels
        const enemyCount = 3 + Math.floor(nextWave / 5);
        const goldReward = 50 * nextWave;
        const xpReward = 100 * nextWave;
        
        addToGameLog(`You defeat ${enemyCount} powerful enemies!`);
        addToGameLog(`You received <span class="gold">${goldReward} gold</span> and <span class="xp">${xpReward} XP</span>!`);
        
        player.gold += goldReward;
        player.xp += xpReward;
        player.endgame.arenaWave = nextWave;
    }
    
    // Check for level up
    checkLevelUp();
    
    showScreen("main");
}

// NEW: Prestige system
function prestige() {
    const player = gameState.player;
    
    if (player.level < 30) {
        addToGameLog("You must be at least level 30 to prestige!");
        return;
    }
    
    // Calculate prestige points based on achievements, level, etc.
    let prestigePoints = Math.floor(player.level / 5);
    prestigePoints += player.quests.completed.length;
    prestigePoints += player.achievements.filter(a => a.unlocked).length;
    
    // Reset character
    const savedGold = player.gold;
    const savedInventory = [...player.inventory];
    const savedPets = {...player.pets};
    const savedLore = {...player.lore};
    const savedEndgame = {...player.endgame};
    
    // Reset to level 1
    player.level = 1;
    player.xp = 0;
    player.xpToNextLevel = 100;
    player.health = 100;
    player.maxHealth = 100;
    player.mana = 50;
    player.maxMana = 50;
    player.strength = 10;
    player.dexterity = 10;
    player.intelligence = 10;
    player.constitution = 10;
    player.talentPoints = 0;
    
    // Reset talents
    Object.keys(player.talents).forEach(talentName => {
        player.talents[talentName].currentPoints = 0;
    });
    
    // Keep some progress
    player.gold = savedGold;
    player.inventory = savedInventory;
    player.pets = savedPets;
    player.lore = savedLore;
    
    // Update endgame with prestige
    player.endgame = savedEndgame;
    player.endgame.prestigeLevel++;
    player.endgame.prestigePoints += prestigePoints;
    
    addToGameLog(`<span class="important">You have prestiged to level ${player.endgame.prestigeLevel}!</span>`);
    addToGameLog(`You gained ${prestigePoints} prestige points!`);
    addToGameLog("Your journey begins anew with the wisdom of your previous life...");
    
    // Check for prestige achievement
    if (!gameState.achievements[36].unlocked) {
        gameState.achievements[36].unlocked = true;
        showAchievement("Prestigious", "Prestiged for the first time");
    }
    
    showScreen("main");
}

// Show class details when clicked
function showClassDetails(className) {
    // Remove selected class from all buttons
    document.querySelectorAll('.class-button').forEach(btn => {
        btn.classList.remove('class-selected');
    });
    
    // Add selected class to clicked button
    event.target.classList.add('class-selected');
    
    // Show the class description
    document.getElementById("class-description").innerHTML = gameState.classDescriptions[className];
    
    // Store the selected class in gameState temporarily
    gameState.tempSelectedClass = className;
    
    // Show the select button
    document.getElementById("select-class-button").style.display = "block";
}

// Select the chosen class
function selectClass() {
    if (!gameState.tempSelectedClass) {
        addToGameLog("Please select a class first!");
        return;
    }
    
    const className = gameState.tempSelectedClass;
    const player = gameState.player;
    player.class = className;

    // Set class-specific stats
    if (className === 'warrior') {
        player.maxHealth = 150;
        player.health = 150;
        player.maxMana = 40
        player.mana = 40;
        player.strength = 18;
        player.dexterity = 8;
        player.intelligence = 5;
        player.constitution = 15;

        // Starting equipment
        player.equippedWeapon = {...gameState.items.weapons.find(w => w.id === 1)}; // Rusty Sword
        player.equippedArmor = {...gameState.items.armor.find(a => a.id === 10)}; // Leather Armor
        player.skills = [...gameState.classSkills.warrior];
        
        // Initialize talent tree
        player.talents = {...gameState.talentTrees.warrior};
    } else if (className === 'mage') {
        player.maxHealth = 90;
        player.health = 90;
        player.maxMana = 100;
        player.mana = 100;
        player.strength = 5;
        player.dexterity = 8;
        player.intelligence = 18;
        player.constitution = 8;

        // Starting equipment
        player.equippedWeapon = {...gameState.items.weapons.find(w => w.id === 6)}; // Staff of Fire
        player.equippedArmor = {...gameState.items.armor.find(a => a.id === 13)}; // Mage Robes
        player.skills = [...gameState.classSkills.mage];
        
        // Initialize talent tree
        player.talents = {...gameState.talentTrees.mage};
    } else if (className === 'rogue') {
        player.maxHealth = 110;
        player.health = 110;
        player.maxMana = 60;
        player.mana = 60;
        player.strength = 8;
        player.dexterity = 18;
        player.intelligence = 8;
        player.constitution = 10;

        // Starting equipment
        player.equippedWeapon = {...gameState.items.weapons.find(w => w.id === 8)}; // Dagger of Shadows
        player.equippedArmor = {...gameState.items.armor.find(a => a.id === 14)}; // Shadow Cloak
        player.skills = [...gameState.classSkills.rogue];
        
        // Initialize talent tree
        player.talents = {...gameState.talentTrees.rogue};
    }

    // Hide class selection and show main game
    document.getElementById("class-select-screen").style.display = "none";
    document.getElementById("main-buttons").style.display = "flex";

    addToGameLog(`You have chosen the path of the ${className}. Your adventure begins!`);
    updatePlayerStats();

    // Generate initial quests
    generateQuests();
    
    // Generate challenges
    generateChallenges();
    
    // Initialize the rest of the game
    initGame();
}

// Initialize the game when page loads
window.onload = function() {
    document.getElementById("class-select-screen").style.display = "block";
    document.getElementById("main-buttons").style.display = "none";
    document.getElementById("select-class-button").style.display = "none";
    addToGameLog("Welcome to the Hollowlands! Choose your class to begin...");
};
</script>
</body>
</html>
