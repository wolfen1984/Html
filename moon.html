<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Operation Lunar Wolf: Nazi Moon Base RPG</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Audiowide&family=Orbitron:wght@400;700&family=Press+Start+2P&display=swap');
        
        :root {
            --text-color: #e0e0e0;
            --bg-color: black;
            --panel-bg: black;
            --border-color: red;
            --border-glow: 0 0 8px rgba(100, 150, 255, 0.5);
            --npc-color: yellow;
            --item-color: red;
            --location-color: pink;
            --danger-color: #ff3333;
            --success-color: #33ff33;
            --button-bg: linear-gradient(to bottom, black, black);
            --button-active: grey;
            --button-border: 1px solid red;
            --title-color: #ff4444;
            --title-glow: 0 0 10px rgba(255, 50, 50, 0.7);
            --mission-color: red;
            --skill-color: #cc88ff;
            --rep-loyalist: #cc3333;
            --rep-science: #3399ff;
            --rep-security: #33cc66;
            --health-bar: linear-gradient(to right, #ff0000, #ff3300);
            --health-bg: rgba(50, 0, 0, 0.7);
            --time-color: white;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Monospace;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(0, 0, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 0, 0, 0.1) 0%, transparent 50%);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.4;
            touch-action: manipulation;
            overscroll-behavior: none;
            height: 100vh;
            overflow: hidden;
            text-shadow: 0 0 5px rgba(200, 200, 255, 0.3);
        }
        
        #game-container {
            width: 100%;
            height: 100vh;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        #header-area {
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            padding: 8px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        #game-title {
            text-align: center;
            color: var(--title-color);
            text-shadow: var(--title-glow);
            font-family: 'Audiowide', cursive;
            font-size: 1.5rem;
            letter-spacing: 2px;
            margin: 0;
            padding: 0;
        }
        
        #time-display {
            text-align: center;
            color: var(--time-color);
            font-size: 0.9rem;
            letter-spacing: 1px;
        }
        
        #status-bars {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }
        
        #health-bar-container {
            flex: 2;
            position: relative;
            height: 24px;
            background: var(--health-bg);
            border: 1px solid #500000;
            border-radius: 3px;
            overflow: hidden;
        }
        
        #health-bar {
            height: 100%;
            background: var(--health-bar);
            width: 100%;
            transition: width 0.3s;
        }
        
        #health-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            text-shadow: 0 0 3px black;
        }
        
        #reputation-display {
            flex: 3;
            display: flex;
            gap: 4px;
        }
        
        .rep-bar {
            flex: 1;
            height: 24px;
            position: relative;
            background: rgba(10, 10, 30, 0.7);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .rep-fill {
            height: 100%;
            width: 50%;
            transition: width 0.3s;
        }
        
        #loyalist-rep .rep-fill {
            background: linear-gradient(to right, #800000, var(--rep-loyalist));
        }
        
        #science-rep .rep-fill {
            background: linear-gradient(to right, #004080, var(--rep-science));
        }
        
        #security-rep .rep-fill {
            background: linear-gradient(to right, #006000, var(--rep-security));
        }
        
        .rep-label {
            position: absolute;
            top: -18px;
            left: 0;
            font-size: 0.6rem;
            white-space: nowrap;
            width: 100%;
            text-align: center;
        }
        
        #main-game-area {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        #game-screen {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            background: rgba(5, 5, 15, 0.7);
            border: 1px solid var(--border-color);
            margin: 8px;
            border-radius: 6px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
        }
        
        #game-screen::-webkit-scrollbar {
            display: none;
        }
        
        #game-screen p {
            margin: 0.5em 0;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        #side-panels {
            width: 120px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 8px;
            background: black;
            border-left: 1px solid var(--border-color);
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }
        
        .side-panel {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .side-panel h3 {
            font-size: 0.8rem;
            margin-bottom: 6px;
            color: black;
            text-align: center;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 4px;
        }
        
        #inventory-list, #missions-list {
            font-size: 0.75rem;
            padding-left: 15px;
            margin: 0;
            list-style-type: square;
            color: #ccccff;
        }
        
        #inventory-list li, #missions-list li {
            margin-bottom: 3px;
            word-break: break-word;
        }
        
        #controls-area {
            background: rgba(0, 0, 0, 0.9);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }
        
        #command-area {
            display: flex;
            gap: 8px;
        }
        
        #command-input {
            flex: 1;
            background: black;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            font-family: inherit;
            font-size: 0.9rem;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        #submit-btn {
            background: var(--button-bg);
            color: var(--text-color);
            border: var(--button-border);
            border-radius: 6px;
            padding: 0 15px;
            font-family: Arial;
            font-size: 0.9rem;
            min-width: 80px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            text-shadow: 0 0 5px rgba(200, 200, 255, 0.5);
        }
        
        #submit-btn:active {
            background: var(--button-active);
        }
        
        #action-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        
        #movement-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            grid-template-areas:
                ". north ."
                "west . east"
                ". south .";
        }
        
        button {
            background: var(--button-bg);
            color: var(--text-color);
            border: var(--button-border);
            border-radius: 6px;
            padding: 8px 5px;
            cursor: pointer;
            font-family: sans-serif;
            font-size: 0.8rem;
            touch-action: manipulation;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            text-shadow: 0 0 5px rgba(200, 200, 255, 0.3);
            transition: all 0.1s;
        }
        
        button:active {
            background: var(--button-active);
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        button:disabled {
            opacity: 0.5;
            transform: none;
            box-shadow: none;
        }
        
        .dir-btn {
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        #north-btn {
            grid-area: north;
        }
        
        #south-btn {
            grid-area: south;
        }
        
        #east-btn {
            grid-area: east;
        }
        
        #west-btn {
            grid-area: west;
        }
        
        #npc-buttons, #item-buttons, #skill-buttons, #system-buttons, #take-buttons, #look-buttons, #use-target-buttons {
            display: none;
            position: fixed;
            bottom: 70px;
            left: 8px;
            right: 8px;
            background: black;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            z-index: 100;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
            max-height: 50vh;
            overflow-y: auto;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }
        
        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .modal-title {
            text-align: center;
            margin-bottom: 10px;
            color: #ffcc00;
            font-size: 1.1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        
        .npc {
            color: var(--npc-color);
            font-weight: bold;
        }
        
        .item {
            color: var(--item-color);
            font-weight: bold;
        }
        
        .location {
            color: var(--location-color);
            font-weight: bold;
        }
        
        .danger {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .success {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .mission {
            color: var(--mission-color);
            font-weight: bold;
        }
        
        .skill {
            color: var(--skill-color);
            font-weight: bold;
        }
        
        .loyalist {
            color: var(--rep-loyalist);
            font-weight: bold;
        }
        
        .science {
            color: var(--rep-science);
            font-weight: bold;
        }
        
        .security {
            color: var(--rep-security);
            font-weight: bold;
        }
        
        #map-display {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--panel-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            z-index: 100;
            max-width: 90%;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            width: 300px;
        }
        
        #map-close {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger-color);
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            font-weight: bold;
            border-radius: 50%;
        }
        
        #map-content {
            font-family: Monospace;
            white-space: pre;
            line-height: 1.3;
            color: #aaffaa;
        }
        
        #notification-area {
            position: fixed;
            bottom: 70px;
            right: 10px;
            width: 250px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .notification {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 5px;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            font-size: 0.9rem;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        #combat-display {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--panel-bg);
            border: 2px solid var(--danger-color);
            border-radius: 10px;
            padding: 20px;
            z-index: 100;
            max-width: 90%;
            width: 300px;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
        }
        
        #combat-close {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger-color);
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            font-weight: bold;
            border-radius: 50%;
        }
        
        .combat-option {
            margin: 5px 0;
            padding: 8px;
            background: var(--button-bg);
            border: var(--button-border);
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
        }
        
        .combat-option:hover {
            background: var(--button-active);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            #side-panels {
                display: none;
            }
            
            #header-area {
                padding: 6px;
            }
            
            #game-title {
                font-size: 1.2rem;
            }
            
            #time-display {
                font-size: 0.8rem;
            }
            
            #health-bar-container, .rep-bar {
                height: 20px;
            }
            
            #health-text {
                font-size: 0.7rem;
            }
            
            .rep-label {
                font-size: 0.5rem;
                top: -16px;
            }
            
            #game-screen {
                padding: 8px;
                margin: 5px;
            }
            
            #game-screen p {
                font-size: 0.85rem;
            }
            
            button {
                padding: 8px 3px;
                font-size: 0.7rem;
            }
            
            #submit-btn {
                min-width: 70px;
                font-size: 0.8rem;
            }
            
            #command-input {
                padding: 8px;
                font-size: 0.8rem;
            }
            
            #notification-area {
                width: 200px;
                bottom: 60px;
            }
            
            .notification {
                font-size: 0.8rem;
                padding: 8px;
            }
            
            #npc-buttons, #item-buttons, #skill-buttons, #system-buttons, #take-buttons, #look-buttons, #use-target-buttons {
                bottom: 60px;
            }
        }
        
        @media (max-width: 480px) {
            #game-title {
                font-size: 1rem;
            }
            
            #time-display {
                font-size: 0.7rem;
            }
            
            #health-text {
                font-size: 0.6rem;
            }
            
            #game-screen p {
                font-size: 0.8rem;
            }
            
            button {
                padding: 6px 2px;
                font-size: 0.65rem;
            }
            
            #submit-btn {
                min-width: 60px;
                font-size: 0.7rem;
            }
            
            #command-input {
                padding: 6px;
                font-size: 0.7rem;
            }
            
            #notification-area {
                width: 180px;
                bottom: 50px;
            }
            
            .notification {
                font-size: 0.75rem;
                padding: 6px;
            }
            
            #npc-buttons, #item-buttons, #skill-buttons, #system-buttons, #take-buttons, #look-buttons, #use-target-buttons {
                bottom: 50px;
                max-height: 40vh;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="header-area">
            <h1 id="game-title">Iron Reich</h1>
            <div id="time-display">COUNTDOWN: <span id="time-remaining">72:00:00</span></div>
            <div id="status-bars">
                <div id="health-bar-container">
                    <div id="health-bar"></div>
                    <div id="health-text">HEALTH: 100%</div>
                </div>
                <div id="reputation-display">
                    <div id="loyalist-rep" class="rep-bar">
                        <div class="rep-fill"></div>
                        <div class="rep-label">LOYAL</div>
                    </div>
                    <div id="science-rep" class="rep-bar">
                        <div class="rep-fill"></div>
                        <div class="rep-label">SCI</div>
                    </div>
                    <div id="security-rep" class="rep-bar">
                        <div class="rep-fill"></div>
                        <div class="rep-label">SEC</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="main-game-area">
            <div id="game-screen">
                <p>April 1945 - As Allied forces close in on Berlin, key members of the SS and Nazi party make their escape aboard modified V4 rockets to a secret base on the dark side of the moon.</p>
                <p>Now it's 1969 - The moon base is operational but still under construction. The Nazis are developing advanced UFO-style spacecraft to return to Earth and establish the Fourth Reich.</p>
                <p>You are SS Officer <span id="player-name">KLAUS SCHMIDT</span>, tasked with securing the base's future.</p>
                <p>Type 'help' for commands.</p>
            </div>
            
            <div id="side-panels">
                <div id="inventory" class="side-panel">
                    <h3>INVENTORY</h3>
                    <ul id="inventory-list">
                        <li>Luger P08 (6/8)</li>
                        <li>SS Uniform</li>
                        <li>Base Access Card</li>
                    </ul>
                </div>
                <div id="missions" class="side-panel">
                    <h3>MISSIONS</h3>
                    <ul id="missions-list">
                        <li>Secure the base</li>
                        <li>Report to General Müller</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div id="controls-area">
            <div id="command-area">
                <input type="text" id="command-input" placeholder="Enter command...">
                <button id="submit-btn">EXECUTE</button>
            </div>
            
            <div id="action-buttons">
                <button id="look-btn">LOOK</button>
                <button id="inventory-btn">INV</button>
                <button id="take-btn">TAKE</button>
                <button id="talk-btn">TALK</button>
                <button id="use-btn">USE</button>
                <button id="skills-btn">SKILLS</button>
                <button id="map-btn">MAP</button>
                <button id="mission-btn">MISSIONS</button>
            </div>
            
            <div id="movement-buttons">
                <button id="north-btn" class="dir-btn" data-dir="north">↑ NORTH</button>
                <button id="south-btn" class="dir-btn" data-dir="south">↓ SOUTH</button>
                <button id="east-btn" class="dir-btn" data-dir="east">→ EAST</button>
                <button id="west-btn" class="dir-btn" data-dir="west">← WEST</button>
            </div>
        </div>
        
        <div id="npc-buttons" class="button-grid"></div>
        <div id="item-buttons" class="button-grid"></div>
        <div id="skill-buttons" class="button-grid"></div>
        <div id="system-buttons" class="modal-buttons"></div>
        <div id="take-buttons" class="button-grid"></div>
        <div id="look-buttons" class="modal-buttons"></div>
        <div id="use-target-buttons" class="modal-buttons"></div>
    </div>

    <div id="map-display">
        <button id="map-close">X</button>
        <h2 class="modal-title">LUNAR BASE MAP</h2>
        <pre id="map-content">
        [Medical Bay]
            |
[Officers Quarters]---[Command Center]---[Hangar Bay]---[Armory]
            |                   |
        [Laboratory]        [Surface Access]
        </pre>
        <p>Explored locations highlighted in green</p>
    </div>

    <div id="combat-display">
        <button id="combat-close">X</button>
        <h2 class="modal-title">COMBAT ENCOUNTER</h2>
        <div id="combat-description">You are facing an enemy!</div>
        <div id="combat-options">
            <div class="combat-option" data-action="attack">ATTACK</div>
            <div class="combat-option" data-action="intimidate">INTIMIDATE</div>
            <div class="combat-option" data-action="flee">FLEE</div>
            <div class="combat-option" data-action="use">USE ITEM</div>
        </div>
        <div id="combat-status"></div>
    </div>

    <div id="notification-area"></div>

    <script>
        // Enhanced Game state
        const gameState = {
            playerName: "KLAUS SCHMIDT",
            currentLocation: 'command_center',
            health: 100,
            inventory: [
                { name: 'Luger P08', type: 'weapon', ammo: 6, maxAmmo: 8 },
                { name: 'SS Uniform', type: 'clothing' },
                { name: 'Base Access Card', type: 'key' }
            ],
            skills: {
                combat: 1,
                technical: 1,
                social: 1,
                stealth: 1
            },
            reputation: {
                loyalists: 50,
                scientists: 50,
                security: 50
            },
            missions: {
                active: [
                    { id: 'secure_base', title: 'Secure the base', description: 'Ensure all systems are operational', completed: false },
                    { id: 'report_muller', title: 'Report to General Müller', description: 'Receive your initial orders', completed: false }
                ],
                completed: []
            },
            locations: {
                command_center: {
                    name: 'Command Center',
                    description: 'The nerve center of the lunar base. Large screens display Earth and lunar surface activity. Several high-ranking officers are monitoring progress.',
                    exits: { north: 'hangar', east: 'quarters', south: 'laboratory', up: 'surface' },
                    items: ['Top Secret Files', 'Command Console'],
                    npcs: ['General Müller', 'Dr. Vogel'],
                    explored: true,
                    events: ['alarm', 'meeting']
                },
                hangar: {
                    name: 'Hangar Bay',
                    description: 'A massive chamber housing several prototype UFO spacecraft. Technicians scurry about making final adjustments to the Haunebu-III model.',
                    exits: { south: 'command_center', west: 'armory' },
                    items: ['Welding Torch', 'Spare Parts'],
                    npcs: ['Chief Engineer Krause'],
                    explored: false,
                    events: ['test_flight', 'sabotage']
                },
                laboratory: {
                    name: 'Scientific Laboratory',
                    description: 'A high-tech lab where strange experiments are conducted. Blueprints for advanced weapons cover the walls.',
                    exits: { north: 'command_center', east: 'medical', down: 'vault' },
                    items: ['Experimental Serum', 'Weapon Blueprints'],
                    npcs: ['Dr. Eisenberg'],
                    explored: false,
                    events: ['experiment', 'containment_breach']
                },
                quarters: {
                    name: 'Officers Quarters',
                    description: 'Living area for high-ranking personnel. Spartan but functional, with personal effects from Earth.',
                    exits: { west: 'command_center', north: 'medical' },
                    items: ['Personal Diary', 'Security Codes'],
                    npcs: ['Colonel Schneider'],
                    explored: false,
                    events: ['private_conversation', 'theft']
                },
                medical: {
                    name: 'Medical Bay',
                    description: 'A sterile white room with advanced medical equipment. Several cryo-chambers hold high-value personnel in stasis.',
                    exits: { south: 'quarters', west: 'laboratory' },
                    items: ['Medkit', 'Stimulants'],
                    npcs: ['Dr. Weiss'],
                    explored: false,
                    events: ['awakening', 'treatment']
                },
                armory: {
                    name: 'Armory',
                    description: 'A secured room filled with advanced weapons and prototype energy devices. Warning signs in German cover the walls.',
                    exits: { east: 'hangar' },
                    items: ['Sturmgewehr 44', 'Energy Cell', 'Plasma Pistol'],
                    npcs: ['Armory Officer Brandt'],
                    explored: false,
                    events: ['inspection', 'theft']
                },
                surface: {
                    name: 'Lunar Surface',
                    description: 'The barren landscape of the moon. Earth hangs in the black sky. Several moon vehicles are parked near the airlock.',
                    exits: { down: 'command_center' },
                    items: ['Moon Rover', 'Oxygen Tank'],
                    npcs: ['Surface Technician'],
                    explored: false,
                    events: ['meteor_shower', 'equipment_failure']
                },
                vault: {
                    name: 'Secret Vault',
                    description: 'A heavily secured underground chamber containing the most sensitive projects. The air hums with strange energy.',
                    exits: { up: 'laboratory' },
                    items: ['Doomsday Device', 'Alien Artifact'],
                    npcs: [],
                    explored: false,
                    locked: true,
                    events: ['activation', 'discovery']
                }
            },
            npcs: {
                'General Müller': {
                    description: 'The highest-ranking officer on the base. Cold and calculating, with a scar across his left cheek.',
                    dialogue: ['The Führer\'s vision will be realized!', 'The Amerikaner moon landing is a threat to our operations.', 'We must accelerate the invasion timeline.'],
                    items: ['Command Codes'],
                    trust: 60,
                    faction: 'loyalists',
                    combat: 4
                },
                'Dr. Vogel': {
                    description: 'Lead scientist of the base. Obsessed with creating superweapons.',
                    dialogue: ['Our anti-gravity technology surpasses anything on Earth!', 'The Haunebu-IV prototype will be ready soon.', 'We need more test subjects...'],
                    items: [],
                    trust: 50,
                    faction: 'scientists',
                    combat: 1
                },
                'Chief Engineer Krause': {
                    description: 'Grizzled engineer in charge of spacecraft development. Covered in grease and burns.',
                    dialogue: ['These crafts will rain fire upon the unbelievers!', 'I need more tungsten for the plasma cannons.', 'The Amerikaner technology is primitive compared to ours.'],
                    items: ['Hangar Key'],
                    trust: 55,
                    faction: 'scientists',
                    combat: 2
                },
                'Dr. Eisenberg': {
                    description: 'Mad scientist working on biological weapons. Wears a stained lab coat.',
                    dialogue: ['My lunar adapted soldiers will be unstoppable!', 'The serum causes... side effects.', 'Have you volunteered for testing yet?'],
                    items: ['Lab Notes'],
                    trust: 45,
                    faction: 'scientists',
                    combat: 1
                },
                'Colonel Schneider': {
                    description: 'Battle-hardened officer in charge of security. Missing an eye.',
                    dialogue: ['Discipline must be maintained, even here!', 'I suspect there are traitors among us.', 'The Russian slept here before his... accident.'],
                    items: ['Security Codes'],
                    trust: 40,
                    faction: 'security',
                    combat: 5
                },
                'Dr. Weiss': {
                    description: 'Base physician. Surprisingly compassionate for a Nazi.',
                    dialogue: ['The low gravity is affecting everyone\'s health.', 'I can treat your wounds, but hurry.', 'Some of these experiments... I have doubts.'],
                    items: ['Medkit'],
                    trust: 70,
                    faction: 'scientists',
                    combat: 1
                },
                'Armory Officer Brandt': {
                    description: 'Strict weapons master with perfect posture.',
                    dialogue: ['All weapons must be checked in and out!', 'The particle beam weapon is not ready for field testing.', 'I don\'t care what your rank is, follow procedures!'],
                    items: ['Armory Key'],
                    trust: 35,
                    faction: 'security',
                    combat: 3
                },
                'Surface Technician': {
                    description: 'A technician in a bulky spacesuit maintaining the surface equipment.',
                    dialogue: ['The radiation shielding needs reinforcement.', 'We lost another rover to meteor strikes.', 'The Earth looks beautiful today... dangerous thoughts.'],
                    items: ['Spacesuit'],
                    trust: 65,
                    faction: 'scientists',
                    combat: 2
                }
            },
            enemies: {
                'SS Guard': {
                    health: 30,
                    attack: 3,
                    defense: 2,
                    dialogue: ['Halt!', 'Identify yourself!', 'You\'re not authorized here!'],
                    loot: ['Luger P08', 'Access Card']
                },
                'Base Scientist': {
                    health: 20,
                    attack: 1,
                    defense: 1,
                    dialogue: ['Please don\'t hurt me!', 'I was forced to work here!', 'The experiments are terrible...'],
                    loot: ['Lab Notes', 'Stimulants']
                },
                'Mutant Soldier': {
                    health: 50,
                    attack: 4,
                    defense: 3,
                    dialogue: ['Grrrrr!', 'Must... obey...', 'Kill... intruders...'],
                    loot: ['Experimental Serum']
                }
            },
            flags: {
                hasCommandCodes: false,
                hasHangarKey: false,
                hasArmoryKey: false,
                hasVaultKey: false,
                knowsAboutTraitor: false,
                foundRussianDiary: false,
                haunebuProgress: 45,
                alarmTriggered: false,
                selfDestructActivated: false,
                inCombat: false
            },
            gameTime: 72 * 60 * 60, // 72 hours in seconds
            mode: 'normal', // normal, talk, use, skill, system, take, look
            savedGames: [],
            exploredLocations: ['command_center'],
            currentEnemy: null,
            combatTurn: 0,
            selectedItem: null // Track which item is selected for use
        };

        // DOM elements
        const gameScreen = document.getElementById('game-screen');
        const inventoryList = document.getElementById('inventory-list');
        const missionsList = document.getElementById('missions-list');
        const commandInput = document.getElementById('command-input');
        const submitBtn = document.getElementById('submit-btn');
        const northBtn = document.getElementById('north-btn');
        const southBtn = document.getElementById('south-btn');
        const eastBtn = document.getElementById('east-btn');
        const westBtn = document.getElementById('west-btn');
        const lookBtn = document.getElementById('look-btn');
        const inventoryBtn = document.getElementById('inventory-btn');
        const takeBtn = document.getElementById('take-btn');
        const talkBtn = document.getElementById('talk-btn');
        const useBtn = document.getElementById('use-btn');
        const skillsBtn = document.getElementById('skills-btn');
        const mapBtn = document.getElementById('map-btn');
        const missionBtn = document.getElementById('mission-btn');
        const npcButtons = document.getElementById('npc-buttons');
        const itemButtons = document.getElementById('item-buttons');
        const skillButtons = document.getElementById('skill-buttons');
        const systemButtons = document.getElementById('system-buttons');
        const takeButtons = document.getElementById('take-buttons');
        const lookButtons = document.getElementById('look-buttons');
        const useTargetButtons = document.getElementById('use-target-buttons');
        const healthBar = document.getElementById('health-bar');
        const healthText = document.getElementById('health-text');
        const timeRemaining = document.getElementById('time-remaining');
        const mapDisplay = document.getElementById('map-display');
        const mapContent = document.getElementById('map-content');
        const mapClose = document.getElementById('map-close');
        const notificationArea = document.getElementById('notification-area');
        const combatDisplay = document.getElementById('combat-display');
        const combatClose = document.getElementById('combat-close');
        const combatDescription = document.getElementById('combat-description');
        const combatOptions = document.getElementById('combat-options');
        const combatStatus = document.getElementById('combat-status');
        const loyalistRepFill = document.querySelector('#loyalist-rep .rep-fill');
        const scienceRepFill = document.querySelector('#science-rep .rep-fill');
        const securityRepFill = document.querySelector('#security-rep .rep-fill');

        // Update health display
        function updateHealth() {
            healthBar.style.width = `${gameState.health}%`;
            healthText.textContent = `HEALTH: ${gameState.health}%`;
            if (gameState.health < 30) {
                healthBar.style.background = 'linear-gradient(to right, #800000, #ff0000)';
            } else {
                healthBar.style.background = 'linear-gradient(to right, #ff0000, #ff3300)';
            }
        }

        // Update reputation display
        function updateReputation() {
            loyalistRepFill.style.width = `${gameState.reputation.loyalists}%`;
            scienceRepFill.style.width = `${gameState.reputation.scientists}%`;
            securityRepFill.style.width = `${gameState.reputation.security}%`;
        }

        // Update mission display
        function updateMissions() {
            missionsList.innerHTML = '';
            gameState.missions.active.forEach(mission => {
                const li = document.createElement('li');
                li.className = 'mission';
                li.textContent = mission.title;
                missionsList.appendChild(li);
            });
        }

        // Update time display
        function updateTime() {
            const hours = Math.floor(gameState.gameTime / 3600);
            const minutes = Math.floor((gameState.gameTime % 3600) / 60);
            const seconds = gameState.gameTime % 60;
            timeRemaining.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Show notification
        function showNotification(message, type = 'normal') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            // Apply type-specific styling
            if (type === 'danger') {
                notification.style.borderColor = 'var(--danger-color)';
                notification.style.color = 'var(--danger-color)';
            } else if (type === 'success') {
                notification.style.borderColor = 'var(--success-color)';
                notification.style.color = 'var(--success-color)';
            } else if (type === 'mission') {
                notification.style.borderColor = 'var(--mission-color)';
                notification.style.color = 'var(--mission-color)';
            }
            
            notification.textContent = message;
            notificationArea.appendChild(notification);
            
            // Remove after delay
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Game timer
        function startGameTimer() {
            setInterval(() => {
                if (gameState.gameTime > 0 && !gameState.flags.selfDestructActivated) {
                    gameState.gameTime--;
                    updateTime();
                    
                    // Time-based events
                    if (gameState.gameTime === 60 * 60) {
                        displayText(`!ALERT! One hour remains until Haunebu fleet launch!`);
                        showNotification('One hour remaining!', 'danger');
                    } else if (gameState.gameTime === 30 * 60) {
                        displayText(`!URGENT! Final preparations underway. Only 30 minutes remain!`);
                        showNotification('30 minutes remaining!', 'danger');
                        gameState.flags.haunebuProgress = 85;
                    } else if (gameState.gameTime === 0) {
                        displayText(`!CRITICAL FAILURE! The Haunebu fleet has launched toward Earth!`);
                        displayText(`The entire base shakes as alarms blare. All personnel are scrambling to evacuate.`);
                        displayText(`GAME OVER - YOU FAILED`);
                        disableControls();
                    }
                    
                    // Random time-based events
                    if (Math.random() < 0.001) {
                        triggerRandomEvent();
                    }
                }
            }, 1000);
        }

        // Display text in game screen with typewriter effect
        function displayText(text) {
            const p = document.createElement('p');
            gameScreen.appendChild(p);
            
            // Process special text classes
            text = text.replace(/\*(.*?)\*/g, '<span class="npc">$1</span>');
            text = text.replace(/\[(.*?)\]/g, '<span class="item">$1</span>');
            text = text.replace(/\((.*?)\)/g, '<span class="location">$1</span>');
            text = text.replace(/!(.*?)!/g, '<span class="danger">$1</span>');
            text = text.replace(/~(.*?)~/g, '<span class="success">$1</span>');
            text = text.replace(/@(.*?)@/g, '<span class="mission">$1</span>');
            text = text.replace(/#(.*?)#/g, '<span class="skill">$1</span>');
            text = text.replace(/\$L(.*?)\$L/g, '<span class="loyalist">$1</span>');
            text = text.replace(/\$S(.*?)\$S/g, '<span class="science">$1</span>');
            text = text.replace(/\$D(.*?)\$D/g, '<span class="security">$1</span>');
            
            p.innerHTML = text;
            gameScreen.scrollTop = gameScreen.scrollHeight;
        }

        // Update inventory display
        function updateInventory() {
            inventoryList.innerHTML = '';
            gameState.inventory.forEach(item => {
                const li = document.createElement('li');
                if (item.type === 'weapon') {
                    li.textContent = `${item.name} (${item.ammo}/${item.maxAmmo})`;
                } else {
                    li.textContent = item.name;
                }
                inventoryList.appendChild(li);
            });
        }

        // Describe current location
        function describeLocation() {
            const location = gameState.locations[gameState.currentLocation];
            let description = `*${location.name}*\n${location.description}\n\n`;
            
            // Mark location as explored
            if (!gameState.exploredLocations.includes(gameState.currentLocation)) {
                gameState.exploredLocations.push(gameState.currentLocation);
                updateMap();
                showNotification(`Discovered: ${location.name}`, 'success');
            }
            
            // List exits
            description += `EXITS: ${Object.keys(location.exits).join(', ').toUpperCase()}\n`;
            
            // List items if any
            if (location.items.length > 0) {
                description += `ITEMS: ${location.items.map(item => `[${item}]`).join(', ')}\n`;
            }
            
            // List NPCs if any
            if (location.npcs.length > 0) {
                description += `PEOPLE: ${location.npcs.map(npc => `*${npc}*`).join(', ')}`;
            }
            
            displayText(description);
            
            // Check for random combat encounter
            if (!gameState.flags.inCombat && Math.random() < 0.1 && location.npcs.length === 0) {
                startCombat();
            }
            
            // Check for location events
            if (location.events && Math.random() < 0.15) {
                triggerLocationEvent();
            }
        }

        // Update map display
        function updateMap() {
            let mapText = `
        [Medical Bay${gameState.exploredLocations.includes('medical') ? ' (✓)' : ''}]
            |
[Officers Quarters${gameState.exploredLocations.includes('quarters') ? ' (✓)' : ''}]---[Command Center${gameState.exploredLocations.includes('command_center') ? ' (✓)' : ''}]---[Hangar Bay${gameState.exploredLocations.includes('hangar') ? ' (✓)' : ''}]---[Armory${gameState.exploredLocations.includes('armory') ? ' (✓)' : ''}]
            |                   |
        [Laboratory${gameState.exploredLocations.includes('laboratory') ? ' (✓)' : ''}]        [Surface${gameState.exploredLocations.includes('surface') ? ' (✓)' : ''}]
            |
        [Vault${gameState.exploredLocations.includes('vault') ? ' (✓)' : ''}]
            `;
            mapContent.textContent = mapText;
        }

        // Show map
        function showMap() {
            updateMap();
            mapDisplay.style.display = 'block';
        }

        // Move to a new location
        function move(direction) {
            if (gameState.flags.inCombat) {
                displayText(`!You can't move while in combat!`);
                return;
            }
            
            const location = gameState.locations[gameState.currentLocation];
            if (location.exits[direction]) {
                const newLocation = location.exits[direction];
                
                // Check for locked locations
                if (gameState.locations[newLocation].locked) {
                    if (newLocation === 'vault' && !gameState.flags.hasVaultKey) {
                        displayText(`!The vault is secured with a heavy blast door. You need a special key to open it.!`);
                        return;
                    }
                }
                
                gameState.currentLocation = newLocation;
                exitMode();
                describeLocation();
                
                // Random events
                if (Math.random() < 0.2) {
                    triggerRandomEvent();
                }
                
                // Location-specific events
                if (newLocation === 'laboratory' && !gameState.missions.active.some(m => m.id === 'investigate_lab')) {
                    addMission('investigate_lab', 'Investigate the laboratory', 'Discover what experiments Dr. Eisenberg is conducting');
                }
            } else {
                displayText(`You can't go that way.`);
            }
        }

        // Trigger random event
        function triggerRandomEvent() {
            const events = [
                `A loud alarm sounds briefly before being silenced. *Dr. Vogel* mutters about !security breaches!.`,
                `The base shakes slightly from a distant explosion. *Chief Engineer Krause* curses about !structural integrity!.`,
                `You overhear two technicians whispering about !supply shortages! and !mutiny!.`,
                `A strange glow emanates from the laboratory. *Dr. Eisenberg* cackles madly.`,
                `The lights flicker as power is diverted to the !Haunebu prototype!. Progress now at ${gameState.flags.haunebuProgress += 5}%`,
                `A technician runs past you in a panic, dropping a [Tool Kit]. ~You pick it up.~`,
                `*Colonel Schneider* barks orders at a group of soldiers about !increased security patrols!.`,
                `A meteor impact rattles the base. *Surface Technician* reports !minor damage to sector 4!.`,
                `$LGeneral Müller$L announces a !security drill! over the intercom. All personnel report to stations.`,
                `$SDr. Weiss$S quietly mentions that some scientists are having !ethical doubts! about the project.`,
                `$DColonel Schneider$D institutes new !security measures! after a reported breach.`
            ];
            
            // Add item if event suggests it
            if (events[5] === `A technician runs past you in a panic, dropping a [Tool Kit]. ~You pick it up.~`) {
                gameState.inventory.push({ name: 'Tool Kit', type: 'tool' });
                updateInventory();
            }
            
            const eventText = events[Math.floor(Math.random() * events.length)];
            displayText(eventText);
            showNotification('Event: ' + eventText.replace(/[\[\]*!~@#$L$S$D]/g, '').substring(0, 30) + '...');
        }

        // Trigger location-specific event
        function triggerLocationEvent() {
            const location = gameState.locations[gameState.currentLocation];
            if (location.events && location.events.length > 0) {
                const event = location.events[Math.floor(Math.random() * location.events.length)];
                
                const eventOutcomes = {
                    'alarm': `!Security alarms blare suddenly! *General Müller* orders everyone to remain calm.`,
                    'meeting': `$LHigh-ranking officers$L are gathered around a map of Earth, planning invasion targets.`,
                    'test_flight': `A !Haunebu prototype! hovers briefly before crashing into the far wall. Technicians scramble.`,
                    'sabotage': `You notice !cut wires! on one of the spacecraft. Someone is sabotaging the fleet.`,
                    'experiment': `A !screaming test subject! bursts from a containment chamber before being subdued.`,
                    'containment_breach': `!Biohazard warning! The lab is sealed as a containment procedure begins.`,
                    'private_conversation': `You overhear two officers discussing a !possible traitor! in their ranks.`,
                    'theft': `!Security is investigating! stolen equipment. They eye you suspiciously.`,
                    'awakening': `A !cryo-chamber opens! unexpectedly, revealing a confused scientist from 1945.`,
                    'treatment': `$SDr. Weiss$S tends to a wounded soldier, showing unexpected compassion.`,
                    'inspection': `$DColonel Schneider$D is conducting a !weapons inventory!. He watches you closely.`,
                    'meteor_shower': `The surface is pelted by !micrometeorites!. You take cover behind a rover.`,
                    'equipment_failure': `A moon rover !explodes! unexpectedly. The technician curses the shoddy parts.`,
                    'activation': `The !doomsday device! hums to life momentarily before powering down.`,
                    'discovery': `The !alien artifact! glows brighter as you approach it, reacting to your presence.`
                };
                
                if (eventOutcomes[event]) {
                    displayText(eventOutcomes[event]);
                    showNotification('Event: ' + eventOutcomes[event].replace(/[\[\]*!~@#$L$S$D]/g, '').substring(0, 30) + '...');
                    
                    // Special event consequences
                    if (event === 'sabotage' && !gameState.missions.active.some(m => m.id === 'find_saboteur')) {
                        addMission('find_saboteur', 'Find the saboteur', 'Discover who is damaging the spacecraft');
                    }
                }
            }
        }

        // Add a new mission
        function addMission(id, title, description) {
            if (!gameState.missions.active.some(m => m.id === id)) {
                gameState.missions.active.push({
                    id,
                    title,
                    description,
                    completed: false
                });
                displayText(`@New Mission: ${title}@`);
                showNotification(`New Mission: ${title}`, 'mission');
                updateMissions();
            }
        }

        // Complete a mission
        function completeMission(id) {
            const missionIndex = gameState.missions.active.findIndex(m => m.id === id);
            if (missionIndex !== -1) {
                const mission = gameState.missions.active[missionIndex];
                mission.completed = true;
                gameState.missions.active.splice(missionIndex, 1);
                gameState.missions.completed.push(mission);
                displayText(`~Mission Complete: ${mission.title}~`);
                showNotification(`Mission Complete: ${mission.title}`, 'success');
                updateMissions();
                
                // Mission rewards
                if (id === 'report_muller') {
                    displayText(`~General Müller promotes you and gives you access to restricted areas.~`);
                    gameState.reputation.loyalists += 10;
                    updateReputation();
                }
                
                if (id === 'investigate_lab') {
                    displayText(`~You discover disturbing experiments. Dr. Eisenberg offers you [Experimental Serum] as hush money.~`);
                    gameState.inventory.push({ name: 'Experimental Serum', type: 'medical' });
                    updateInventory();
                    gameState.reputation.scientists -= 5;
                    updateReputation();
                }
                
                return true;
            }
            return false;
        }

        // Look at something
        function lookAt(target) {
            const location = gameState.locations[gameState.currentLocation];
            
            if (!target) {
                describeLocation();
                return;
            }
            
            // Check if target is an NPC
            if (location.npcs.includes(target)) {
                const npc = gameState.npcs[target];
                displayText(`*${target}*: ${npc.description} Trust: ${npc.trust}/100`);
                return;
            }
            
            // Check if target is an item in the location
            if (location.items.includes(target)) {
                const itemDescriptions = {
                    'Top Secret Files': 'Classified documents detailing the invasion plan. Marked "Eisenmond Projekt".',
                    'Command Console': 'A computer terminal with access to base systems. #Technical skill# required to hack.',
                    'Welding Torch': 'A high-temperature tool used for spacecraft repairs. Could be used as a weapon.',
                    'Spare Parts': 'Mysterious components for the Haunebu crafts. Valuable to engineers.',
                    'Experimental Serum': 'A glowing green liquid in a vial. Labeled "Testsubjekt nur".',
                    'Weapon Blueprints': 'Schematics for advanced energy weapons. Marked "Geheime Reichssache".',
                    'Personal Diary': 'A leather-bound journal belonging to a Russian scientist.',
                    'Security Codes': 'Access codes for restricted areas. Could bypass some security.',
                    'Medkit': 'Standard medical supplies, low on morphine. Restores 30% health.',
                    'Stimulants': 'Performance-enhancing drugs. Temporary boost to #Combat# and #Stealth#.',
                    'Sturmgewehr 44': 'Advanced assault rifle with extended magazine. 30 rounds.',
                    'Energy Cell': 'Pulsing blue device that hums with power. Powers high-tech weapons.',
                    'Plasma Pistol': 'Experimental energy weapon. 10 shots before recharge needed.',
                    'Moon Rover': 'Vehicle for lunar surface travel. Requires [Oxygen Tank] to operate.',
                    'Oxygen Tank': 'Essential for extended surface excursions.',
                    'Doomsday Device': 'A terrifying weapon capable of destroying cities. The core pulses ominously.',
                    'Alien Artifact': 'A strange metallic object of unknown origin. It feels warm to the touch.',
                    'Lab Notes': 'Disturbing sketches of human experiments. Some pages are stained.',
                    'Armory Key': 'Biometric key for advanced weapons locker.',
                    'Hangar Key': 'Heavy metal key for the main hangar doors.',
                    'Command Codes': 'Encrypted sequence for base self-destruct.',
                    'Spacesuit': 'Required for extended lunar surface activity.',
                    'Tool Kit': 'Assortment of tools useful for repairs and modifications.'
                };
                displayText(`[${target}]: ${itemDescriptions[target]}`);
                return;
            }
            
            // Check if target is in inventory
            const inventoryItem = gameState.inventory.find(item => item.name.toLowerCase() === target.toLowerCase());
            if (inventoryItem) {
                const inventoryDescriptions = {
                    'Luger P08': 'Standard issue sidearm. Well-maintained. 8 round capacity.',
                    'SS Uniform': 'Black uniform with silver insignia. Impeccably pressed. Grants access to most areas.',
                    'Base Access Card': 'Keycard with your photo and clearance level. Basic access only.',
                    'Command Codes': 'Encrypted sequence for base self-destruct. Highest clearance required.',
                    'Hangar Key': 'Heavy metal key for the main hangar doors.',
                    'Lab Notes': 'Disturbing sketches of human experiments. Some pages are stained.',
                    'Security Codes': 'Access codes for restricted areas. Could bypass some security.',
                    'Armory Key': 'Biometric key for advanced weapons locker.',
                    'Spacesuit': 'Required for extended lunar surface activity.',
                    'Tool Kit': 'Assortment of tools useful for repairs and modifications.'
                };
                displayText(`[${inventoryItem.name}]: ${inventoryDescriptions[inventoryItem.name]}`);
                return;
            }
            
            displayText(`You don't see any ${target} here.`);
        }

        // Take an item
        function takeItem(itemName) {
            if (gameState.flags.inCombat) {
                displayText(`!You can't take items while in combat!`);
                return;
            }
            
            const location = gameState.locations[gameState.currentLocation];
            const itemIndex = location.items.findIndex(item => item.toLowerCase() === itemName.toLowerCase());
            
            if (itemIndex !== -1) {
                const item = location.items[itemIndex];
                location.items.splice(itemIndex, 1);
                
                // Special items that set flags
                if (item === 'Command Codes') gameState.flags.hasCommandCodes = true;
                if (item === 'Hangar Key') gameState.flags.hasHangarKey = true;
                if (item === 'Armory Key') gameState.flags.hasArmoryKey = true;
                if (item === 'Vault Key') gameState.flags.hasVaultKey = true;
                if (item === 'Personal Diary') {
                    gameState.flags.foundRussianDiary = true;
                    displayText(`~You found a Russian scientist's diary detailing how he was forced to work on the base. It mentions a traitor among the Nazis who helped him.~`);
                    addMission('find_traitor', 'Find the traitor', 'Discover who helped the Russian scientist');
                }
                
                // Add to inventory with appropriate type
                const itemTypes = {
                    'Luger P08': 'weapon',
                    'Sturmgewehr 44': 'weapon',
                    'Plasma Pistol': 'weapon',
                    'Medkit': 'medical',
                    'Experimental Serum': 'medical',
                    'Stimulants': 'medical',
                    'Base Access Card': 'key',
                    'Command Codes': 'key',
                    'Hangar Key': 'key',
                    'Armory Key': 'key',
                    'Vault Key': 'key',
                    'Security Codes': 'key',
                    'Tool Kit': 'tool',
                    'Welding Torch': 'tool'
                };
                
                const newItem = {
                    name: item,
                    type: itemTypes[item] || 'misc'
                };
                
                if (newItem.type === 'weapon') {
                    if (item === 'Luger P08') {
                        newItem.ammo = 6;
                        newItem.maxAmmo = 8;
                    } else if (item === 'Sturmgewehr 44') {
                        newItem.ammo = 30;
                        newItem.maxAmmo = 30;
                    } else if (item === 'Plasma Pistol') {
                        newItem.ammo = 10;
                        newItem.maxAmmo = 10;
                    }
                }
                
                gameState.inventory.push(newItem);
                displayText(`~You took the [${item}].~`);
                showNotification(`Acquired: ${item}`, 'success');
                updateInventory();
            } else {
                displayText(`There is no [${itemName}] here to take.`);
            }
        }

        // Talk to an NPC
        function talkTo(npcName) {
            if (gameState.flags.inCombat) {
                displayText(`!You can't talk while in combat!`);
                return;
            }
            
            const location = gameState.locations[gameState.currentLocation];
            
            if (location.npcs.includes(npcName)) {
                const npc = gameState.npcs[npcName];
                
                // Base dialogue
                const dialogue = npc.dialogue[Math.floor(Math.random() * npc.dialogue.length)];
                displayText(`*${npcName}* says: "${dialogue}"`);
                
                // Special dialogue if flags are set
                if (npcName === 'General Müller') {
                    if (gameState.flags.foundRussianDiary && !gameState.flags.knowsAboutTraitor) {
                        displayText(`*General Müller* leans in close: "Have you discovered something about the traitor? Report to me immediately with any findings!"`);
                    }
                    
                    if (gameState.missions.active.some(m => m.id === 'report_muller')) {
                        if (completeMission('report_muller')) {
                            displayText(`*General Müller*: "Good. Your first assignment is to inspect the laboratory. Dr. Eisenberg's work is... concerning."`);
                            addMission('investigate_lab', 'Investigate the laboratory', 'Discover what experiments Dr. Eisenberg is conducting');
                        }
                    }
                }
                
                // Check if NPC has an item to give
                if (npc.items.length > 0 && Math.random() < 0.3) {
                    const item = npc.items[0];
                    npc.items.splice(0, 1);
                    gameState.inventory.push({ name: item, type: 'key' });
                    displayText(`~*${npcName}* gives you [${item}].~`);
                    showNotification(`Received: ${item} from ${npcName}`, 'success');
                    updateInventory();
                }
                
                // Increase trust
                if (Math.random() < 0.5) {
                    npc.trust = Math.min(100, npc.trust + 5);
                }
                
                // Special interactions based on reputation
                if (npcName === 'Dr. Weiss' && gameState.reputation.scientists > 70) {
                    displayText(`*Dr. Weiss* whispers: "I can't stand what we're doing here. There are others who feel the same."`);
                }
                
                // Faction reputation changes
                if (npc.faction === 'loyalists') {
                    gameState.reputation.loyalists = Math.min(100, gameState.reputation.loyalists + 2);
                } else if (npc.faction === 'scientists') {
                    gameState.reputation.scientists = Math.min(100, gameState.reputation.scientists + 2);
                } else if (npc.faction === 'security') {
                    gameState.reputation.security = Math.min(100, gameState.reputation.security + 2);
                }
                updateReputation();
            } else {
                displayText(`*${npcName}* is not here.`);
            }
        }

        // Use an item on a target
        function useItemOnTarget(itemName, target) {
            const inventoryItem = gameState.inventory.find(item => item.name.toLowerCase() === itemName.toLowerCase());
            if (!inventoryItem) {
                displayText(`You don't have [${itemName}].`);
                return;
            }

            const location = gameState.locations[gameState.currentLocation];
            
            // Check if target is valid (either NPC or item in location)
            const validTarget = location.npcs.includes(target) || location.items.includes(target);
            if (!validTarget) {
                displayText(`There is no ${target} here to use [${itemName}] on.`);
                return;
            }

            // Specific use cases
            if (itemName === 'Security Codes' && target === 'Command Console') {
                displayText(`~You use the [Security Codes] on the [Command Console]. Access granted to restricted systems.~`);
                gameState.flags.alarmTriggered = true;
                gameState.reputation.security -= 20;
                updateReputation();
                return;
            }

            if (itemName === 'Welding Torch' && target === 'Command Console') {
                if (gameState.skills.technical >= 3) {
                    displayText(`~You use the [Welding Torch] to bypass security on the [Command Console]. Access granted.~`);
                    gameState.flags.alarmTriggered = true;
                    gameState.reputation.security -= 15;
                    updateReputation();
                } else {
                    displayText(`!You lack the #Technical# skills to modify the console with the [Welding Torch].!`);
                }
                return;
            }

            if (itemName === 'Hangar Key' && target === 'Chief Engineer Krause') {
                displayText(`~You show the [Hangar Key] to *Chief Engineer Krause*. "Ah good, you have proper clearance. Let me show you the prototype."~`);
                gameState.npcs['Chief Engineer Krause'].trust += 10;
                return;
            }

            if (itemName === 'Personal Diary' && target === 'General Müller') {
                displayText(`~You show the [Personal Diary] to *General Müller*. His face darkens. "This confirms my suspicions. There is a traitor among us."~`);
                gameState.flags.knowsAboutTraitor = true;
                if (completeMission('find_traitor')) {
                    addMission('confront_traitor', 'Confront the traitor', 'Identify and deal with the mole in the base');
                }
                return;
            }

            // Default response if no specific interaction
            displayText(`You use [${itemName}] on ${location.npcs.includes(target) ? `*${target}*` : `[${target}]`}, but nothing notable happens.`);
        }

        // Use an item
        function useItem(itemName, target = null) {
            if (target) {
                useItemOnTarget(itemName, target);
                return;
            }

            const inventoryItem = gameState.inventory.find(item => item.name.toLowerCase() === itemName.toLowerCase());
            
            if (!inventoryItem) {
                displayText(`You don't have [${itemName}].`);
                return;
            }
            
            const location = gameState.locations[gameState.currentLocation];
            
            // Weapon usage
            if (inventoryItem.type === 'weapon') {
                if (gameState.flags.inCombat) {
                    combatAction('attack', inventoryItem.name);
                    return;
                }
                
                if (inventoryItem.ammo > 0) {
                    inventoryItem.ammo--;
                    displayText(`!You fire your [${inventoryItem.name}]! The shot echoes through the base.`);
                    updateInventory();
                    
                    // Chance to attract attention
                    if (Math.random() < 0.7) {
                        displayText(`!*General Müller* storms in, furious at the unauthorized weapon discharge!`);
                        if (location.npcs.includes('General Müller')) {
                            displayText(`"This is unacceptable! Report to the armory for disciplinary action!"`);
                            gameState.health -= 10;
                            gameState.reputation.loyalists -= 5;
                            gameState.reputation.security -= 10;
                            updateHealth();
                            updateReputation();
                        } else {
                            location.npcs.push('General Müller');
                        }
                    }
                } else {
                    displayText(`Your [${inventoryItem.name}] is out of ammo.`);
                }
                return;
            }
            
            // Key item usage
            if (inventoryItem.type === 'key') {
                if (inventoryItem.name === 'Hangar Key' && gameState.currentLocation === 'hangar') {
                    displayText(`~You unlock the main hangar doors, revealing the massive Haunebu-III prototype. The craft hums with anti-gravity energy.~`);
                    return;
                }
                
                if (inventoryItem.name === 'Armory Key' && gameState.currentLocation === 'armory') {
                    displayText(`~You access the advanced weapons locker, revealing experimental particle beam weapons.~`);
                    return;
                }
                
                if (inventoryItem.name === 'Command Codes' && gameState.currentLocation === 'command_center') {
                    displayText(`!WARNING! Entering these codes will activate the base self-destruct sequence. Are you sure? (type "CONFIRM DESTRUCTION" to proceed)`);
                    return;
                }
                
                if (inventoryItem.name === 'Security Codes' && gameState.currentLocation === 'command_center') {
                    displayText(`~You use the [Security Codes] to access restricted systems.~`);
                    return;
                }
            }
            
            // Medical item usage
            if (inventoryItem.type === 'medical') {
                if (inventoryItem.name === 'Medkit') {
                    gameState.health = Math.min(100, gameState.health + 30);
                    displayText(`~You use the [Medkit] and feel better. Health: ${gameState.health}%~`);
                    updateHealth();
                    
                    // Remove from inventory
                    const itemIndex = gameState.inventory.findIndex(item => item.name === 'Medkit');
                    if (itemIndex !== -1) {
                        gameState.inventory.splice(itemIndex, 1);
                        updateInventory();
                    }
                    return;
                }
                
                if (inventoryItem.name === 'Stimulants') {
                    displayText(`~You inject the [Stimulants]. Your senses sharpen and reflexes improve temporarily.~`);
                    gameState.skills.combat += 2;
                    gameState.skills.stealth += 2;
                    
                    // Remove after use
                    const itemIndex = gameState.inventory.findIndex(item => item.name === 'Stimulants');
                    if (itemIndex !== -1) {
                        gameState.inventory.splice(itemIndex, 1);
                        updateInventory();
                    }
                    
                    // Effects wear off after some time
                    setTimeout(() => {
                        gameState.skills.combat -= 2;
                        gameState.skills.stealth -= 2;
                        displayText(`!The effects of the stimulants wear off. Your abilities return to normal.!`);
                    }, 60000);
                    return;
                }
            }
            
            // Experimental serum
            if (inventoryItem.name === 'Experimental Serum') {
                displayText(`!You inject the [Experimental Serum]! Your vision swims as your muscles convulse.`);
                
                // Random effect
                const effect = Math.random();
                if (effect < 0.3) {
                    displayText(`~You feel incredibly strong! (Temporary health boost)~`);
                    gameState.health = Math.min(100, gameState.health + 50);
                } else if (effect < 0.6) {
                    displayText(`!The serum makes you violently ill! (Health damage)!`);
                    gameState.health -= 40;
                } else {
                    displayText(`Your skin tingles strangely but nothing else happens.`);
                }
                
                updateHealth();
                
                // Remove from inventory
                const itemIndex = gameState.inventory.findIndex(item => item.name === 'Experimental Serum');
                if (itemIndex !== -1) {
                    gameState.inventory.splice(itemIndex, 1);
                    updateInventory();
                }
                return;
            }
            
            // Tool usage
            if (inventoryItem.type === 'tool') {
                if (inventoryItem.name === 'Tool Kit' && location.items.includes('Command Console')) {
                    if (gameState.skills.technical >= 3) {
                        displayText(`~You use the [Tool Kit] to hack the [Command Console]. Access granted to security systems.~`);
                        gameState.flags.alarmTriggered = true;
                        gameState.reputation.security -= 20;
                        updateReputation();
                    } else {
                        displayText(`!You attempt to hack the console but lack the #Technical skill#. The system rejects your access.!`);
                    }
                    return;
                }
                
                if (inventoryItem.name === 'Welding Torch') {
                    displayText(`!You activate the [Welding Torch]. It could be used to cut through metal or as a weapon.!`);
                    return;
                }
            }
            
            // If no specific use case found, show targets the item can be used on
            showUseTargets(itemName);
        }

        // Show possible targets for using an item
        function showUseTargets(itemName) {
            gameState.mode = 'use-target';
            gameState.selectedItem = itemName;
            const location = gameState.locations[gameState.currentLocation];
            
            useTargetButtons.innerHTML = '';
            useTargetButtons.style.display = 'block';
            
            // Add title
            const title = document.createElement('div');
            title.className = 'modal-title';
            title.textContent = `USE ${itemName} ON:`;
            useTargetButtons.appendChild(title);
            
            // Add NPC buttons if any
            if (location.npcs.length > 0) {
                location.npcs.forEach(npc => {
                    const btn = document.createElement('button');
                    btn.textContent = npc;
                    btn.addEventListener('click', () => {
                        useItem(itemName, npc);
                        exitMode();
                    });
                    useTargetButtons.appendChild(btn);
                });
            }
            
            // Add item buttons if any
            if (location.items.length > 0) {
                location.items.forEach(item => {
                    const btn = document.createElement('button');
                    btn.textContent = item;
                    btn.addEventListener('click', () => {
                        useItem(itemName, item);
                        exitMode();
                    });
                    useTargetButtons.appendChild(btn);
                });
            }
            
            // Add cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'CANCEL';
            cancelBtn.addEventListener('click', exitMode);
            useTargetButtons.appendChild(cancelBtn);
            
            // If no valid targets, show message
            if (location.npcs.length === 0 && location.items.length === 0) {
                const noTargetsBtn = document.createElement('button');
                noTargetsBtn.textContent = 'NOTHING TO USE ON HERE';
                noTargetsBtn.disabled = true;
                useTargetButtons.appendChild(noTargetsBtn);
                displayText(`There's nothing here to use [${itemName}] on.`);
            }
        }

        // Start combat encounter
        function startCombat() {
            const enemyTypes = Object.keys(gameState.enemies);
            const enemyType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
            gameState.currentEnemy = {
                type: enemyType,
                ...gameState.enemies[enemyType]
            };
            
            gameState.flags.inCombat = true;
            gameState.combatTurn = 0;
            
            combatDescription.textContent = `You are facing a ${enemyType}!`;
            combatStatus.textContent = `Your health: ${gameState.health}% | Enemy health: ${gameState.currentEnemy.health}%`;
            
            combatDisplay.style.display = 'block';
            toggleControls(false);
        }

        // Combat action
        function combatAction(action, itemName = null) {
            if (!gameState.flags.inCombat) return;
            
            gameState.combatTurn++;
            
            let playerDamage = 0;
            let enemyDamage = 0;
            let message = '';
            
            // Player action
            switch(action) {
                case 'attack':
                    if (itemName) {
                        const weapon = gameState.inventory.find(item => item.name === itemName);
                        if (weapon && weapon.type === 'weapon' && weapon.ammo > 0) {
                            weapon.ammo--;
                            updateInventory();
                            playerDamage = Math.max(1, Math.floor(Math.random() * 5) + gameState.skills.combat);
                            message = `You fire your [${itemName}] at the ${gameState.currentEnemy.type}! `;
                        } else {
                            message = `Your [${itemName}] is out of ammo or not a weapon! `;
                        }
                    } else {
                        playerDamage = Math.max(1, Math.floor(Math.random() * 3) + gameState.skills.combat);
                        message = `You attack the ${gameState.currentEnemy.type}! `;
                    }
                    break;
                    
                case 'intimidate':
                    if (Math.random() < 0.3 + (gameState.skills.social * 0.1)) {
                        message = `You intimidate the ${gameState.currentEnemy.type}! They hesitate. `;
                        enemyDamage = -2; // Enemy gets weaker
                    } else {
                        message = `Your intimidation attempt fails! `;
                    }
                    break;
                    
                case 'flee':
                    if (Math.random() < 0.5 + (gameState.skills.stealth * 0.1)) {
                        message = `You successfully flee from combat!`;
                        endCombat();
                        return;
                    } else {
                        message = `You fail to escape! `;
                    }
                    break;
                    
                case 'use':
                    if (itemName) {
                        const item = gameState.inventory.find(item => item.name === itemName);
                        if (item) {
                            if (item.type === 'medical') {
                                gameState.health = Math.min(100, gameState.health + 30);
                                message = `You use [${itemName}] and recover some health! `;
                                updateHealth();
                                
                                // Remove from inventory if consumable
                                if (itemName === 'Medkit' || itemName === 'Stimulants') {
                                    const itemIndex = gameState.inventory.findIndex(item => item.name === itemName);
                                    if (itemIndex !== -1) {
                                        gameState.inventory.splice(itemIndex, 1);
                                        updateInventory();
                                    }
                                }
                            } else {
                                message = `[${itemName}] has no effect in combat! `;
                            }
                        }
                    }
                    break;
            }
            
            // Apply player damage
            if (playerDamage > 0) {
                gameState.currentEnemy.health -= playerDamage;
                message += `You deal ${playerDamage} damage. `;
            }
            
            // Enemy action (if still alive)
            if (gameState.currentEnemy.health > 0) {
                enemyDamage += Math.max(1, Math.floor(Math.random() * gameState.currentEnemy.attack) - gameState.skills.stealth);
                if (enemyDamage > 0) {
                    gameState.health -= enemyDamage;
                    message += `The ${gameState.currentEnemy.type} hits you for ${enemyDamage} damage!`;
                    updateHealth();
                } else {
                    message += `The ${gameState.currentEnemy.type} misses!`;
                }
            }
            
            // Update combat status
            combatStatus.textContent = `Your health: ${gameState.health}% | ${gameState.currentEnemy.type} health: ${Math.max(0, gameState.currentEnemy.health)}%`;
            displayText(message);
            
            // Check for combat end
            if (gameState.currentEnemy.health <= 0) {
                endCombat(true);
            } else if (gameState.health <= 0) {
                endCombat(false);
            }
        }

        // End combat
        function endCombat(victory) {
            if (victory) {
                const enemyType = gameState.currentEnemy.type;
                const loot = gameState.currentEnemy.loot[Math.floor(Math.random() * gameState.currentEnemy.loot.length)];
                
                displayText(`~You defeated the ${enemyType}!~`);
                if (loot) {
                    displayText(`~The ${enemyType} dropped [${loot}].~`);
                    gameState.inventory.push({ name: loot, type: loot === 'Medkit' ? 'medical' : 'misc' });
                    updateInventory();
                }
                
                // Reputation changes
                gameState.reputation.security += 5;
                updateReputation();
            } else {
                displayText(`!You were defeated by the ${gameState.currentEnemy.type}!`);
                displayText(`You wake up in the medical bay with reduced health.`);
                gameState.health = 30;
                gameState.currentLocation = 'medical';
                updateHealth();
                describeLocation();
            }
            
            gameState.flags.inCombat = false;
            gameState.currentEnemy = null;
            combatDisplay.style.display = 'none';
            toggleControls(true);
        }

        // Use a skill
        function useSkill(skill) {
            const location = gameState.locations[gameState.currentLocation];
            
            switch(skill) {
                case 'combat':
                    if (location.npcs.length > 0) {
                        const npc = location.npcs[0];
                        if (gameState.skills.combat >= 3) {
                            displayText(`!You intimidate *${npc}* with your combat prowess! They back down.~`);
                            gameState.npcs[npc].trust -= 10;
                        } else {
                            displayText(`!Your attempt to intimidate fails. *${npc}* seems unimpressed.!`);
                        }
                    } else {
                        displayText(`There's no one here to use your #Combat# skills on.`);
                    }
                    break;
                    
                case 'technical':
                    if (location.items.includes('Command Console')) {
                        if (gameState.skills.technical >= 3) {
                            displayText(`~You use your #Technical# skills to access restricted systems on the [Command Console].~`);
                            gameState.flags.alarmTriggered = true;
                            gameState.reputation.security -= 20;
                            updateReputation();
                        } else {
                            displayText(`!You lack the necessary #Technical# skills to hack this system.!`);
                        }
                    } else {
                        displayText(`There's nothing technical here to interact with.`);
                    }
                    break;
                    
                case 'social':
                    if (location.npcs.length > 0) {
                        const npc = location.npcs[0];
                        if (gameState.skills.social >= 3) {
                            displayText(`~You charm *${npc}* with your social skills. They seem more friendly.~`);
                            gameState.npcs[npc].trust += 10;
                        } else {
                            displayText(`!Your attempt at conversation falls flat. *${npc}* seems uninterested.!`);
                        }
                    } else {
                        displayText(`There's no one here to talk to.`);
                    }
                    break;
                    
                case 'stealth':
                    if (location.npcs.length > 0) {
                        if (gameState.skills.stealth >= 3) {
                            displayText(`~You use your #Stealth# skills to slip past *${location.npcs[0]}* unnoticed.~`);
                        } else {
                            displayText(`!You're not stealthy enough and *${location.npcs[0]}* spots you immediately.!`);
                        }
                    } else {
                        displayText(`You move quietly, but there's no one here to notice you.`);
                    }
                    break;
            }
            
            exitMode();
        }

        // Improve a skill
        function improveSkill(skill) {
            if (gameState.skills[skill] < 5) {
                gameState.skills[skill]++;
                displayText(`~Your #${skill.charAt(0).toUpperCase() + skill.slice(1)}# skill has improved to level ${gameState.skills[skill]}!~`);
                showNotification(`Skill Improved: ${skill}`, 'success');
            } else {
                displayText(`!Your #${skill.charAt(0).toUpperCase() + skill.slice(1)}# skill is already at maximum level.!`);
            }
            exitMode();
        }

        // Process special commands
        function processSpecialCommand(command) {
            command = command.toUpperCase();
            
            if (command === 'CONFIRM DESTRUCTION') {
                if (gameState.inventory.some(item => item.name === 'Command Codes')) {
                    gameState.flags.selfDestructActivated = true;
                    displayText(`!FINAL WARNING! Base self-destruct sequence initiated! 60 seconds until detonation!`);
                    displayText(`The entire base shakes as alarms blare. All personnel are scrambling to evacuate.`);
                    
                    // Game ending
                    setTimeout(() => {
                        displayText(`!The lunar base explodes in a massive fireball, destroying all Nazi presence on the moon!~`);
                        displayText(`~You have prevented the Fourth Reich from returning to Earth. The world is safe... for now.~`);
                        displayText(`~GAME OVER - YOU WIN~`);
                        disableControls();
                    }, 3000);
                    return true;
                }
            }
            
            if (command === 'HELP') {
                displayText(`Available commands:
- Movement: north, south, east, west (or n, s, e, w)
- Actions: look, take [item], talk [npc], use [item], skills
- Inventory: inventory (or i)
- Missions: missions (or m)
- Map: map
- System: save, load, settings
- Special: help, quit

Click buttons or type commands. Your goal is to either help complete the invasion plans or stop the Nazi moon base.

Skills:
#Combat# - Affects weapon effectiveness and intimidation
#Technical# - Allows hacking and repairs
#Social# - Improves NPC interactions
#Stealth# - Helps avoid detection

Factions:
$LLoyalists$L - Base leadership
$SScientists$S - Research and development
$DSecurity$D - Base protection and discipline`);
                return true;
            }
            
            if (command === 'QUIT') {
                displayText(`~Game ended. Refresh page to restart.~`);
                disableControls();
                return true;
            }
            
            if (command === 'SAVE') {
                saveGame();
                return true;
            }
            
            if (command === 'LOAD') {
                loadGame();
                return true;
            }
            
            if (command === 'MISSIONS' || command === 'M') {
                showMissions();
                return true;
            }
            
            if (command === 'MAP') {
                showMap();
                return true;
            }
            
            if (command === 'SETTINGS') {
                displayText(`Settings:
- Text speed: Normal
- Sound: Off
- Notifications: On
- Color scheme: Classic`);
                return true;
            }
            
            return false;
        }

        // Save game state
        function saveGame() {
            const saveData = JSON.stringify(gameState);
            const saveName = `Save_${new Date().toLocaleString()}`;
            gameState.savedGames.push({ name: saveName, data: saveData });
            localStorage.setItem('lunarWolfSaves', JSON.stringify(gameState.savedGames));
            displayText(`~Game saved as "${saveName}"~`);
            showNotification('Game saved successfully', 'success');
        }

        // Load game state
        function loadGame() {
            const saves = JSON.parse(localStorage.getItem('lunarWolfSaves'));
            if (saves && saves.length > 0) {
                // For simplicity, load the most recent save
                const saveData = saves[saves.length - 1].data;
                Object.assign(gameState, JSON.parse(saveData));
                displayText(`~Game loaded successfully.~`);
                showNotification('Game loaded', 'success');
                updateInventory();
                updateMissions();
                updateHealth();
                updateTime();
                updateReputation();
                describeLocation();
            } else {
                displayText(`!No saved games found.!`);
                showNotification('No saved games found', 'danger');
            }
        }

        // Show mission details
        function showMissions() {
            displayText(`@ACTIVE MISSIONS@`);
            if (gameState.missions.active.length === 0) {
                displayText(`No active missions.`);
            } else {
                gameState.missions.active.forEach(mission => {
                    displayText(`@${mission.title}@: ${mission.description}`);
                });
            }
            
            displayText(`@COMPLETED MISSIONS@`);
            if (gameState.missions.completed.length === 0) {
                displayText(`No completed missions yet.`);
            } else {
                gameState.missions.completed.forEach(mission => {
                    displayText(`@${mission.title}@: ${mission.description}`);
                });
            }
        }

        // Enter system mode
        function enterSystemMode() {
            gameState.mode = 'system';
            
            systemButtons.innerHTML = '';
            systemButtons.style.display = 'block';
            
            // Add title
            const title = document.createElement('div');
            title.className = 'modal-title';
            title.textContent = 'SYSTEM MENU';
            systemButtons.appendChild(title);
            
            // Add system buttons
            const systemActions = [
                { text: 'SAVE GAME', action: 'save' },
                { text: 'LOAD GAME', action: 'load' },
                { text: 'SETTINGS', action: 'settings' },
                { text: 'HELP', action: 'help' },
                { text: 'QUIT GAME', action: 'quit' },
                { text: 'CANCEL', action: 'cancel' }
            ];
            
            systemActions.forEach(action => {
                const btn = document.createElement('button');
                btn.textContent = action.text;
                btn.addEventListener('click', () => {
                    if (action.action === 'cancel') {
                        exitMode();
                    } else {
                        processCommand(action.action);
                        exitMode();
                    }
                });
                systemButtons.appendChild(btn);
            });
            
            // Disable other controls
            toggleControls(false);
        }

        // Disable controls when game ends
        function disableControls() {
            commandInput.disabled = true;
            submitBtn.disabled = true;
            northBtn.disabled = true;
            southBtn.disabled = true;
            eastBtn.disabled = true;
            westBtn.disabled = true;
            lookBtn.disabled = true;
            inventoryBtn.disabled = true;
            takeBtn.disabled = true;
            talkBtn.disabled = true;
            useBtn.disabled = true;
            skillsBtn.disabled = true;
            mapBtn.disabled = true;
            missionBtn.disabled = true;
        }

        // Enter talk mode - show NPC buttons
        function enterTalkMode() {
            gameState.mode = 'talk';
            const location = gameState.locations[gameState.currentLocation];
            
            npcButtons.innerHTML = '';
            npcButtons.style.display = 'grid';
            
            // Add title
            const title = document.createElement('div');
            title.className = 'modal-title';
            title.textContent = 'TALK TO:';
            npcButtons.appendChild(title);
            
            // Add NPC buttons
            if (location.npcs.length > 0) {
                location.npcs.forEach(npc => {
                    const btn = document.createElement('button');
                    btn.textContent = npc;
                    btn.addEventListener('click', () => {
                        talkTo(npc);
                        exitMode();
                    });
                    npcButtons.appendChild(btn);
                });
            } else {
                const noNpcsBtn = document.createElement('button');
                noNpcsBtn.textContent = 'NO ONE HERE';
                noNpcsBtn.disabled = true;
                npcButtons.appendChild(noNpcsBtn);
            }
            
            // Add cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'CANCEL';
            cancelBtn.addEventListener('click', exitMode);
            npcButtons.appendChild(cancelBtn);
            
            // Disable other controls
            toggleControls(false);
        }

        // Enter use mode - show item buttons
        function enterUseMode() {
            gameState.mode = 'use';
            
            itemButtons.innerHTML = '';
            itemButtons.style.display = 'grid';
            
            // Add title
            const title = document.createElement('div');
            title.className = 'modal-title';
            title.textContent = 'USE ITEM:';
            itemButtons.appendChild(title);
            
            // Add inventory item buttons
            if (gameState.inventory.length > 0) {
                gameState.inventory.forEach(item => {
                    const btn = document.createElement('button');
                    btn.textContent = item.name;
                    btn.addEventListener('click', () => {
                        // Check if this item can be used on something
                        const location = gameState.locations[gameState.currentLocation];
                        const hasTargets = location.npcs.length > 0 || location.items.length > 0;
                        
                        if (item.type === 'weapon' || item.type === 'medical' || !hasTargets) {
                            // Use item directly if it's a weapon, medical item, or no targets available
                            useItem(item.name);
                            exitMode();
                        } else {
                            // Show targets this item can be used on
                            showUseTargets(item.name);
                        }
                    });
                    itemButtons.appendChild(btn);
                });
            } else {
                const noItemsBtn = document.createElement('button');
                noItemsBtn.textContent = 'INVENTORY EMPTY';
                noItemsBtn.disabled = true;
                itemButtons.appendChild(noItemsBtn);
            }
            
            // Add cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'CANCEL';
            cancelBtn.addEventListener('click', exitMode);
            itemButtons.appendChild(cancelBtn);
            
            // Disable other controls
            toggleControls(false);
        }

        // Enter take mode - show items in current location
        function enterTakeMode() {
            if (gameState.flags.inCombat) {
                displayText(`!You can't take items while in combat!`);
                return;
            }
            
            gameState.mode = 'take';
            const location = gameState.locations[gameState.currentLocation];
            
            takeButtons.innerHTML = '';
            takeButtons.style.display = 'grid';
            
            // Add title
            const title = document.createElement('div');
            title.className = 'modal-title';
            title.textContent = 'TAKE ITEM:';
            takeButtons.appendChild(title);
            
            // Add item buttons
            if (location.items.length > 0) {
                location.items.forEach(item => {
                    const btn = document.createElement('button');
                    btn.textContent = item;
                    btn.addEventListener('click', () => {
                        takeItem(item);
                        exitMode();
                    });
                    takeButtons.appendChild(btn);
                });
            } else {
                const noItemsBtn = document.createElement('button');
                noItemsBtn.textContent = 'NO ITEMS HERE';
                noItemsBtn.disabled = true;
                takeButtons.appendChild(noItemsBtn);
            }
            
            // Add cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'CANCEL';
            cancelBtn.addEventListener('click', exitMode);
            takeButtons.appendChild(cancelBtn);
            
            // Disable other controls
            toggleControls(false);
        }

        // Enter skills mode
        function enterSkillsMode() {
            gameState.mode = 'skill';
            
            skillButtons.innerHTML = '';
            skillButtons.style.display = 'grid';
            
            // Add title
            const title = document.createElement('div');
            title.className = 'modal-title';
            title.textContent = 'SKILLS:';
            skillButtons.appendChild(title);
            
            // Add skill use buttons
            const skills = ['combat', 'technical', 'social', 'stealth'];
            skills.forEach(skill => {
                const btn = document.createElement('button');
                btn.textContent = `${skill.toUpperCase()} (${gameState.skills[skill]}/5)`;
                btn.addEventListener('click', () => useSkill(skill));
                skillButtons.appendChild(btn);
            });
            
            // Add skill improve buttons
            skills.forEach(skill => {
                const btn = document.createElement('button');
                btn.textContent = `IMPROVE ${skill.toUpperCase()}`;
                btn.addEventListener('click', () => improveSkill(skill));
                skillButtons.appendChild(btn);
            });
            
            // Add cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'CANCEL';
            cancelBtn.addEventListener('click', exitMode);
            skillButtons.appendChild(cancelBtn);
            
            // Disable other controls
            toggleControls(false);
        }

        // Enter look mode - show items and NPCs that can be examined
        function enterLookMode() {
            gameState.mode = 'look';
            const location = gameState.locations[gameState.currentLocation];
            
            lookButtons.innerHTML = '';
            lookButtons.style.display = 'block';
            
            // Add title
            const title = document.createElement('div');
            title.className = 'modal-title';
            title.textContent = 'EXAMINE:';
            lookButtons.appendChild(title);
            
            // Add NPC buttons
            if (location.npcs.length > 0) {
                location.npcs.forEach(npc => {
                    const btn = document.createElement('button');
                    btn.textContent = npc;
                    btn.addEventListener('click', () => {
                        lookAt(npc);
                        exitMode();
                    });
                    lookButtons.appendChild(btn);
                });
            }
            
            // Add item buttons
            if (location.items.length > 0) {
                location.items.forEach(item => {
                    const btn = document.createElement('button');
                    btn.textContent = item;
                    btn.addEventListener('click', () => {
                        lookAt(item);
                        exitMode();
                    });
                    lookButtons.appendChild(btn);
                });
            }
            
            // Add inventory item buttons
            gameState.inventory.forEach(item => {
                const btn = document.createElement('button');
                    btn.textContent = item.name;
                    btn.addEventListener('click', () => {
                        lookAt(item.name);
                        exitMode();
                    });
                    lookButtons.appendChild(btn);
            });
            
            // Add location button
            const locationBtn = document.createElement('button');
            locationBtn.textContent = 'ROOM';
            locationBtn.addEventListener('click', () => {
                lookAt();
                exitMode();
            });
            lookButtons.appendChild(locationBtn);
            
            // Add cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'CANCEL';
            cancelBtn.addEventListener('click', exitMode);
            lookButtons.appendChild(cancelBtn);
            
            // Disable other controls
            toggleControls(false);
        }

        // Exit any special mode
        function exitMode() {
            gameState.mode = 'normal';
            npcButtons.style.display = 'none';
            itemButtons.style.display = 'none';
            skillButtons.style.display = 'none';
            systemButtons.style.display = 'none';
            takeButtons.style.display = 'none';
            lookButtons.style.display = 'none';
            useTargetButtons.style.display = 'none';
            gameState.selectedItem = null;
            toggleControls(true);
        }

        // Toggle control buttons
        function toggleControls(enabled) {
            northBtn.disabled = !enabled;
            southBtn.disabled = !enabled;
            eastBtn.disabled = !enabled;
            westBtn.disabled = !enabled;
            lookBtn.disabled = !enabled;
            inventoryBtn.disabled = !enabled;
            takeBtn.disabled = !enabled;
            talkBtn.disabled = !enabled;
            useBtn.disabled = !enabled;
            skillsBtn.disabled = !enabled;
            mapBtn.disabled = !enabled;
            missionBtn.disabled = !enabled;
            commandInput.disabled = !enabled;
            submitBtn.disabled = !enabled;
        }

        // Process player input
        function processCommand(command) {
            if (!command) return;
            
            command = command.trim().toLowerCase();
            
            // Handle special commands first
            if (processSpecialCommand(command.toUpperCase())) return;
            
            // Movement commands
            if (['north', 'south', 'east', 'west', 'n', 's', 'e', 'w', 'up', 'down', 'u', 'd'].includes(command)) {
                const directionMap = {
                    north: 'north', south: 'south', east: 'east', west: 'west',
                    n: 'north', s: 'south', e: 'east', w: 'west',
                    up: 'up', down: 'down', u: 'up', d: 'down'
                };
                move(directionMap[command]);
                return;
            }
            
            // Look command
            if (command.startsWith('look ')) {
                const target = command.substring(5);
                lookAt(target);
                return;
            }
            
            if (command === 'look') {
                lookAt();
                return;
            }
            
            // Take command
            if (command.startsWith('take ')) {
                const item = command.substring(5);
                takeItem(item);
                return;
            }
            
            if (command === 'take') {
                enterTakeMode();
                return;
            }
            
            // Talk command
            if (command.startsWith('talk ')) {
                const npc = command.substring(5);
                talkTo(npc);
                return;
            }
            
            if (command === 'talk') {
                enterTalkMode();
                return;
            }
            
            // Use command
            if (command.startsWith('use ')) {
                const parts = command.substring(4).split(' on ');
                if (parts.length === 2) {
                    useItem(parts[0], parts[1]);
                } else {
                    useItem(parts[0]);
                }
                return;
            }
            
            if (command === 'use') {
                enterUseMode();
                return;
            }
            
            // Skills command
            if (command === 'skills') {
                enterSkillsMode();
                return;
            }
            
            // System command
            if (command === 'system') {
                enterSystemMode();
                return;
            }
            
            // Inventory command
            if (['inventory', 'i', 'inv'].includes(command)) {
                displayText(`You are carrying: ${gameState.inventory.map(item => `[${item.name}]`).join(', ')}`);
                return;
            }
            
            // Missions command
            if (['missions', 'm'].includes(command)) {
                showMissions();
                return;
            }
            
            // Map command
            if (command === 'map') {
                showMap();
                return;
            }
            
            // Unknown command
            displayText(`Unknown command. Type 'help' for instructions.`);
        }

        // Event listeners
        submitBtn.addEventListener('click', () => {
            const command = commandInput.value;
            displayText(`> ${command}`);
            processCommand(command);
            commandInput.value = '';
        });

        commandInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const command = commandInput.value;
                displayText(`> ${command}`);
                processCommand(command);
                commandInput.value = '';
            }
        });

        // Direction buttons
        northBtn.addEventListener('click', () => {
            displayText(`> north`);
            move('north');
        });

        southBtn.addEventListener('click', () => {
            displayText(`> south`);
            move('south');
        });

        eastBtn.addEventListener('click', () => {
            displayText(`> east`);
            move('east');
        });

        westBtn.addEventListener('click', () => {
            displayText(`> west`);
            move('west');
        });

        // Action buttons
        lookBtn.addEventListener('click', () => {
            displayText(`> look`);
            enterLookMode();
        });

        inventoryBtn.addEventListener('click', () => {
            displayText(`> inventory`);
            displayText(`You are carrying: ${gameState.inventory.map(item => `[${item.name}]`).join(', ')}`);
        });

        takeBtn.addEventListener('click', enterTakeMode);

        talkBtn.addEventListener('click', enterTalkMode);

        useBtn.addEventListener('click', enterUseMode);
        
        skillsBtn.addEventListener('click', enterSkillsMode);
        
        mapBtn.addEventListener('click', () => {
            displayText(`> map`);
            showMap();
        });
        
        missionBtn.addEventListener('click', () => {
            displayText(`> missions`);
            showMissions();
        });
        
        mapClose.addEventListener('click', () => {
            mapDisplay.style.display = 'none';
        });
        
        combatClose.addEventListener('click', () => {
            displayText(`!You can't exit combat that way!`);
        });
        
        // Combat option event delegation
        combatOptions.addEventListener('click', (e) => {
            if (e.target.classList.contains('combat-option')) {
                const action = e.target.dataset.action;
                if (action === 'use') {
                    // Show inventory for use in combat
                    enterUseMode();
                    combatDisplay.style.display = 'none';
                } else {
                    combatAction(action);
                }
            }
        });

        // Initialize game
        updateInventory();
        updateMissions();
        updateHealth();
        updateTime();
        updateReputation();
        updateMap();
        describeLocation();
        displayText(`Type 'help' for instructions.`);
        startGameTimer();
        
        // Focus input on touch devices
        if ('ontouchstart' in window) {
            commandInput.focus();
        }
    </script>
</body>
</html>
