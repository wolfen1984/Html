<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vampires vs Werewolves - Deck Builder++</title>
<style>
    :root {
        --vampire-red: #c33;
        --werewolf-blue: #36c;
        --common: #888;
        --rare: #3cf;
        --epic: #d13;
        --legendary: #fd0;
        --ancient: #a0f;
    }
    
    @font-face {
        font-family: 'MedievalSharp';
        src: url('https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap');
    }
    
    body { 
        background: #111 url('https://images.unsplash.com/photo-1518709268805-4e9042af9f23?q=80&w=1000') no-repeat center center fixed; 
        background-size: cover;
        color: #eee; 
        font-family: 'MedievalSharp', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        text-align: center; 
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }
    
    #game-container { 
        max-width: 1100px; 
        margin: 20px auto; 
        padding: 25px; 
        background-color: rgba(0, 0, 0, 0.85);
        border-radius: 15px;
        box-shadow: 0 0 25px rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h1 {
        font-size: 3rem;
        margin-bottom: 25px;
        text-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        background: linear-gradient(to right, var(--vampire-red), var(--werewolf-blue));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        letter-spacing: 2px;
    }
    
    h2 {
        font-size: 2rem;
        margin-top: 0;
        color: #fff;
        text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
    }
    
    button { 
        background: linear-gradient(to bottom, #444, #333);
        color: #eee; 
        padding: 12px 25px; 
        border: none; 
        margin: 8px; 
        font-size: 16px; 
        cursor: pointer; 
        border-radius: 8px;
        transition: all 0.3s;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        font-weight: bold;
        min-width: 200px;
        font-family: 'MedievalSharp', sans-serif;
        letter-spacing: 1px;
    }
    
    button:hover { 
        transform: translateY(-3px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
    }
    
    button:active {
        transform: translateY(0);
    }
    
    .vampire-btn {
        background: linear-gradient(to bottom, var(--vampire-red), #800);
        text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
    }
    
    .werewolf-btn {
        background: linear-gradient(to bottom, var(--werewolf-blue), #006);
        text-shadow: 0 0 5px rgba(0, 100, 255, 0.5);
    }
    
    .gold-btn {
        background: linear-gradient(to bottom, #daa520, #b8860b);
        text-shadow: 0 0 5px rgba(218, 165, 32, 0.5);
    }
    
    .hidden { display: none; }
    
    #stats, #battle-log, #hand, #inventory, #reward-screen, #shop { 
        background: rgba(0, 0, 0, 0.7); 
        padding: 20px; 
        margin: 20px 0; 
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }
    
    .card-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin: 25px 0;
    }
    
    .card { 
        display: flex;
        flex-direction: column;
        background: linear-gradient(to bottom right, #333, #222);
        margin: 5px; 
        padding: 15px; 
        width: 160px; 
        height: 220px; 
        border-radius: 12px; 
        cursor: pointer; 
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    }
    
    .card:hover { 
        transform: translateY(-8px) scale(1.03);
        box-shadow: 0 12px 20px rgba(0, 0, 0, 0.5);
    }
    
    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
    }
    
    .common { border-top: 6px solid var(--common); }
    .rare { border-top: 6px solid var(--rare); }
    .epic { border-top: 6px solid var(--epic); }
    .legendary { border-top: 6px solid var(--legendary); }
    .ancient { border-top: 6px solid var(--ancient); }
    
    .card h4 {
        margin: 5px 0;
        font-size: 1.3rem;
        color: #fff;
        text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
        flex: 0 0 auto;
    }
    
    .card p {
        margin: 5px 0;
        font-size: 0.95rem;
        flex: 1;
    }
    
    .card-cost {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #ffcc00;
        border: 1px solid #ffcc00;
    }
    
    .inventory-item { 
        cursor: pointer; 
        display: block; 
        margin: 12px 5px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        transition: all 0.2s;
        text-align: left;
        position: relative;
    }
    
    .inventory-item:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(5px);
    }
    
    .inventory-item::after {
        content: '‚Üí';
        position: absolute;
        right: 10px;
        opacity: 0;
        transition: all 0.2s;
    }
    
    .inventory-item:hover::after {
        opacity: 1;
        right: 15px;
    }
    
    #battle-log {
        max-height: 200px;
        overflow-y: auto;
        text-align: left;
        padding: 15px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 8px;
        font-size: 0.95rem;
    }
    
    #battle-log p {
        margin: 8px 0;
        padding: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        border-left: 3px solid transparent;
        transition: all 0.2s;
    }
    
    #battle-log p:hover {
        background: rgba(255, 255, 255, 0.05);
        border-left: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    .health-bar {
        height: 25px;
        background: #333;
        border-radius: 12px;
        margin: 15px 0;
        overflow: hidden;
        position: relative;
        border: 1px solid rgba(0, 0, 0, 0.5);
    }
    
    .health-fill {
        height: 100%;
        background: linear-gradient(to right, #f00, #f80);
        transition: width 0.5s;
    }
    
    .health-text {
        position: absolute;
        width: 100%;
        text-align: center;
        line-height: 25px;
        font-weight: bold;
        text-shadow: 0 0 5px #000;
        font-size: 0.9rem;
    }
    
    .energy-display {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 20px 0;
    }
    
    .energy-orb {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #ff0, #f80);
        box-shadow: 0 0 8px #fc0;
        transition: all 0.3s;
    }
    
    .energy-orb.empty {
        background: #333;
        box-shadow: none;
        transform: scale(0.8);
    }
    
    .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.95);
        padding: 15px;
        border-radius: 8px;
        z-index: 100;
        max-width: 250px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
    }
    
    .card:hover .tooltip {
        opacity: 1;
    }
    
    .rarity-label {
        font-size: 0.85rem;
        font-weight: bold;
        padding: 3px 10px;
        border-radius: 12px;
        display: inline-block;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .common-label { background-color: var(--common); color: #000; }
    .rare-label { background-color: var(--rare); color: #000; }
    .epic-label { background-color: var(--epic); color: #fff; }
    .legendary-label { background-color: var(--legendary); color: #000; }
    .ancient-label { background-color: var(--ancient); color: #fff; }
    
    .enemy-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.5);
        margin: 0 auto 15px;
        border: 3px solid rgba(255, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
    }
    
    .player-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.5);
        margin: 0 auto 15px;
        border: 3px solid rgba(0, 100, 255, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
    }
    
    .vampire-avatar {
        border-color: var(--vampire-red);
        background: linear-gradient(to bottom right, #300, #800);
    }
    
    .werewolf-avatar {
        border-color: var(--werewolf-blue);
        background: linear-gradient(to bottom right, #003, #006);
    }
    
    .status-effect {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 0.8rem;
        margin: 0 3px;
    }
    
    .buff { background: rgba(0, 255, 0, 0.2); border: 1px solid #0f0; }
    .debuff { background: rgba(255, 0, 0, 0.2); border: 1px solid #f00; }
    .bleed { background: rgba(150, 0, 0, 0.3); border: 1px solid #a00; }
    .block { background: rgba(0, 100, 255, 0.2); border: 1px solid #06f; }
    
    
      .card-back {
        background: linear-gradient(135deg, #333 25%, #222 25%, #222 50%, #333 50%, #333 75%, #222 75%);
        background-size: 20px 20px;
        border: 3px solid #444;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 1.5rem;
    }
    
    .card-back.vampire {
        border-color: var(--vampire-red);
    }
    
    .card-back.werewolf {
        border-color: var(--werewolf-blue);
    }
    
    @media (max-width: 768px) {
        #game-container {
            margin: 10px;
            padding: 15px;
        }
        
        .card {
            width: 140px;
            height: 200px;
        }
        
        h1 {
            font-size: 2rem;
        }
        
        button {
            min-width: 160px;
            padding: 10px 15px;
        }
    }
</style>
</head>
<body>
<div id="game-container">
    <h1>Vampires vs Werewolves - Deck Builder++</h1>

    <!-- CLASS SELECTION -->
    <div id="class-selection">
        <p>Choose your faction:</p>
        <button class="vampire-btn" onclick="chooseClass('Vampire')">Vampire</button>
        <button class="werewolf-btn" onclick="chooseClass('Werewolf')">Werewolf</button>
        
        <div style="margin: 25px 0; display: flex; justify-content: center; gap: 40px;">
            <div style="text-align: center;">
                <div class="player-avatar vampire-avatar">üßõ</div>
                <h3>Vampires</h3>
                <ul style="text-align: left; list-style-type: none; padding: 0;">
                    <li>‚úîÔ∏è Lifesteal abilities</li>
                    <li>‚úîÔ∏è Shadow magic</li>
                    <li>‚úîÔ∏è Lower health</li>
                    <li>‚úîÔ∏è Blood-based powers</li>
                </ul>
            </div>
            <div style="text-align: center;">
                <div class="player-avatar werewolf-avatar">üê∫</div>
                <h3>Werewolves</h3>
                <ul style="text-align: left; list-style-type: none; padding: 0;">
                    <li>‚úîÔ∏è Higher health</li>
                    <li>‚úîÔ∏è Stronger attacks</li>
                    <li>‚úîÔ∏è Pack tactics</li>
                    <li>‚úîÔ∏è Regeneration</li>
                </ul>
            </div>
        </div>
        
       
    </div>

    <!-- PLAYER STATS -->
    <div id="stats" class="hidden">
        <h2 id="class-name"></h2>
        <div id="player-avatar"></div>
        
        <div class="health-bar">
            <div class="health-fill" id="player-health-fill"></div>
            <div class="health-text" id="player-health-text"></div>
        </div>
        
        <div style="margin: 15px 0;">
            <span style="color: gold; font-weight: bold;">Gold: <span id="gold-display">0</span></span>
            <span style="margin-left: 20px; color: #3cf;">Level: <span id="level-display">1</span></span>
        </div>
        
        <div id="status-effects" style="margin: 15px 0;"></div>
        
        <button class="vampire-btn" onclick="startBattle()">Start Battle</button>
        <button class="werewolf-btn" onclick="enterShop()">Enter Shop</button>
        <button class="gold-btn" onclick="viewDeck()">View Deck</button>
        
        <div id="deck-info" style="margin-top: 20px;">
            <p>Deck: <span id="deck-count">0</span> cards | Discard: <span id="discard-count">0</span> cards</p>
            <p>Next Enemy: <span id="next-enemy">Hunter</span></p>
        </div>
    </div>

    <!-- BATTLE SCREEN -->
    <div id="battle" class="hidden">
        <h2 id="battle-title"></h2>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="flex: 1; text-align: left;">
                <h3>You</h3>
                <div id="battle-player-avatar"></div>
                <div class="health-bar">
                    <div class="health-fill" id="battle-player-health-fill"></div>
                    <div class="health-text" id="battle-player-health-text"></div>
                </div>
                <div id="battle-status-effects" style="margin-top: 10px;"></div>
            </div>
            
            <div style="flex: 1; text-align: right;">
                <h3 id="enemy-name">Enemy</h3>
                <div id="enemy-avatar"></div>
                <div class="health-bar">
                    <div class="health-fill" id="enemy-health-fill"></div>
                    <div class="health-text" id="enemy-health-text"></div>
                </div>
                <div id="enemy-status-effects" style="margin-top: 10px;"></div>
            </div>
        </div>
        
        <div class="energy-display" id="energy-display"></div>

        <div id="hand" class="card-container"></div>

        <div>
            <button class="vampire-btn" onclick="endTurn()">End Turn</button>
            <button class="werewolf-btn" onclick="toggleInventory()">Inventory (<span id="inventory-count">0</span>)</button>
            <button onclick="viewDiscard()">View Discard</button>
        </div>

        <div id="inventory" class="hidden"></div>
        <div id="battle-log"></div>
    </div>

    <!-- REWARD SCREEN -->
    <div id="reward-screen" class="hidden">
        <h2>Choose a reward:</h2>
        <div style="margin-bottom: 20px;">
            <button onclick="skipReward()">Skip Reward</button>
            <button onclick="getRandomCardReward()">Random Card (3 choices)</button>
            <button onclick="getGoldReward()">Take <span id="gold-reward-amount">50</span> Gold</button>
            <button onclick="getPotionReward()">Receive Potions</button>
        </div>
        <div id="reward-cards" class="card-container"></div>
    </div>

    <!-- SHOP -->
    <div id="shop" class="hidden">
        <h2>Shop - (Gold: <span id="gold" style="color: gold;">0</span>)</h2>
        
        <div style="margin: 20px 0; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
            <button onclick="buyPotion()">Health Potion (15 gold)</button>
            <button onclick="buyEnergyPotion()">Energy Potion (20 gold)</button>
            <button onclick="upgradeMaxHP()">Upgrade Max HP (25 gold)</button>
            <button onclick="upgradeEnergy()">Upgrade Max Energy (30 gold)</button>
            <button onclick="removeCard()">Remove Card (25 gold)</button>
        </div>
        
        <h3>Cards for Sale:</h3>
        <div id="shop-cards" class="card-container"></div>
        
        <button onclick="exitShop()">Exit Shop</button>
        <button onclick="rerollShop()">Reroll Shop (10 gold)</button>
    </div>
</div>

<!-- DECK VIEW MODAL -->
<div id="deck-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('deck-modal')">√ó</button>
        <h2>Your Deck (<span id="modal-deck-count">0</span> cards)</h2>
        <div id="modal-deck" class="card-container"></div>
    </div>
</div>

<!-- DISCARD VIEW MODAL -->
<div id="discard-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('discard-modal')">√ó</button>
        <h2>Discard Pile (<span id="modal-discard-count">0</span> cards)</h2>
        <div id="modal-discard" class="card-container"></div>
    </div>
</div>

            <h3>Card Types:</h3>
            <ul>
                <li><span style="color: var(--common);">Common</span>: Basic cards</li>
                <li><span style="color: var(--rare);">Rare</span>: Stronger effects</li>
                <li><span style="color: var(--epic);">Epic</span>: Powerful abilities</li>
                <li><span style="color: var(--legendary);">Legendary</span>: Game-changing effects</li>
                <li><span style="color: var(--ancient);">Ancient</span>: Ultra rare and powerful</li>
            </ul>
            
            <h3>Status Effects:</h3>
            <ul>
                <li><span class="buff">Buffs</span>: Temporary bonuses</li>
                <li><span class="debuff">Debuffs</span>: Negative effects</li>
                <li><span class="bleed">Bleed</span>: Damage over time</li>
                <li><span class="block">Block</span>: Reduces incoming damage</li>
            </ul>
        </div>
    </div>
</div>

<script>
// Game State
let player = {
    class: "",
    maxHP: 0,
    hp: 0,
    inventory: [],
    deck: [],
    level: 1,
    xp: 0,
    maxEnergy: 2,
    buffs: []
};

let deck = [];
let hand = [];
let discard = [];
let energy = 0;
let gold = 50;
let buffedAttack = 0;
let block = 0;
let evadeNextAttack = false;
let enemyBleedStacks = 0;
let enemyBleedDamage = 0;
let shopRerollCost = 10;
let energyCarryover = 0; // New variable to track unused energy

// Card Database
const vampireCards = [
    {name:"Bite", cost:1, effect:"attack", value:8, rarity:"common", description:"Deal 8 damage", class:"Vampire"},
    {name:"Blood Drain", cost:2, effect:"lifesteal", value:6, rarity:"rare", description:"Deal 6 damage and heal for 6", class:"Vampire"},
    {name:"Dark Mist", cost:1, effect:"buff", value:3, rarity:"common", description:"Gain +3 attack next turn", class:"Vampire"},
    {name:"Night Slash", cost:2, effect:"attack", value:10, rarity:"epic", description:"Deal 10 damage", class:"Vampire"},
    {name:"Vampiric Touch", cost:3, effect:"lifesteal", value:12, rarity:"epic", description:"Deal 12 damage and heal for 12", class:"Vampire"},
    {name:"Shadow Step", cost:1, effect:"evade", value:0, rarity:"rare", description:"Avoid next enemy attack", class:"Vampire"},
    {name:"Blood Frenzy", cost:2, effect:"multistrike", value:5, rarity:"rare", description:"Deal 5 damage twice", class:"Vampire"},
    {name:"Moonlight", cost:0, effect:"heal", value:5, rarity:"common", description:"Heal 5 HP", class:"Vampire"},
    {name:"Sanguine Shield", cost:2, effect:"block", value:8, rarity:"rare", description:"Gain 8 block", class:"Vampire"},
    {name:"Hemorrhage", cost:3, effect:"bleed", value:4, rarity:"epic", description:"Enemy takes 4 damage each turn for 3 turns", class:"Vampire"},
    {name:"Blood Pact", cost:1, effect:"sacrifice", value:5, rarity:"rare", description:"Lose 5 HP, draw 2 cards", class:"Vampire"},
    {name:"Nosferatu's Kiss", cost:4, effect:"lifesteal", value:15, rarity:"legendary", description:"Deal 15 damage and heal for 15", class:"Vampire"},
    {name:"Shadow Veil", cost:2, effect:"evade", value:0, rarity:"epic", description:"Avoid next 2 enemy attacks", class:"Vampire"},
    {name:"Crimson Ritual", cost:3, effect:"buff", value:5, rarity:"rare", description:"Gain +5 attack next 2 turns", class:"Vampire"},
    {name:"Blood Moon", cost:4, effect:"aoe", value:10, rarity:"legendary", description:"Deal 10 damage to all enemies", class:"Vampire"},
    {name:"Eternal Thirst", cost:2, effect:"lifesteal", value:8, rarity:"epic", description:"Deal 8 damage and heal for 8", class:"Vampire"},
    {name:"Soul Siphon", cost:3, effect:"drain", value:10, rarity:"ancient", description:"Deal 10 damage, heal for half", class:"Vampire"}
];

const werewolfCards = [
    {name:"Claw Swipe", cost:1, effect:"attack", value:7, rarity:"common", description:"Deal 7 damage", class:"Werewolf"},
    {name:"Howl", cost:1, effect:"buff", value:4, rarity:"common", description:"Gain +4 attack next turn", class:"Werewolf"},
    {name:"Regenerate", cost:2, effect:"heal", value:8, rarity:"rare", description:"Heal 8 HP", class:"Werewolf"},
    {name:"Rend", cost:2, effect:"attack", value:12, rarity:"epic", description:"Deal 12 damage", class:"Werewolf"},
    {name:"Savage Strike", cost:3, effect:"attack", value:18, rarity:"epic", description:"Deal 18 damage", class:"Werewolf"},
    {name:"Pack Tactics", cost:1, effect:"draw", value:1, rarity:"rare", description:"Draw 1 card", class:"Werewolf"},
    {name:"Feral Roar", cost:2, effect:"buff", value:6, rarity:"rare", description:"Gain +6 attack next turn", class:"Werewolf"},
    {name:"Pounce", cost:1, effect:"attack", value:5, rarity:"common", description:"Deal 5 damage", class:"Werewolf"},
    {name:"Tough Hide", cost:2, effect:"block", value:10, rarity:"rare", description:"Gain 10 block", class:"Werewolf"},
    {name:"Moon Frenzy", cost:3, effect:"multistrike", value:8, rarity:"legendary", description:"Deal 8 damage three times", class:"Werewolf"},
    {name:"Alpha Howl", cost:2, effect:"buff", value:8, rarity:"epic", description:"Gain +8 attack next turn", class:"Werewolf"},
    {name:"Lunar Blessing", cost:3, effect:"heal", value:15, rarity:"epic", description:"Heal 15 HP", class:"Werewolf"},
    {name:"Pack Leader", cost:2, effect:"draw", value:2, rarity:"rare", description:"Draw 2 cards", class:"Werewolf"},
    {name:"Fury Swipes", cost:1, effect:"multistrike", value:4, rarity:"common", description:"Deal 4 damage twice", class:"Werewolf"},
    {name:"Moon's Wrath", cost:4, effect:"attack", value:25, rarity:"legendary", description:"Deal 25 damage", class:"Werewolf"},
    {name:"Primal Roar", cost:3, effect:"aoe", value:12, rarity:"legendary", description:"Deal 12 damage to all enemies", class:"Werewolf"},
    {name:"Eclipse Strike", cost:5, effect:"attack", value:30, rarity:"ancient", description:"Deal 30 damage", class:"Werewolf"}
];

const neutralCards = [
    {name:"Quick Strike", cost:0, effect:"attack", value:3, rarity:"common", description:"Deal 3 damage"},
    {name:"Defend", cost:1, effect:"block", value:5, rarity:"common", description:"Gain 5 block"},
    {name:"Power Up", cost:1, effect:"energy", value:1, rarity:"rare", description:"Gain 1 energy"},
    {name:"Second Wind", cost:1, effect:"heal", value:4, rarity:"common", description:"Heal 4 HP"},
    {name:"Precision Strike", cost:2, effect:"attack", value:9, rarity:"rare", description:"Deal 9 damage"},
    {name:"Adrenaline", cost:0, effect:"draw", value:1, rarity:"rare", description:"Draw 1 card"},
    {name:"Counter", cost:2, effect:"counter", value:6, rarity:"epic", description:"Deal 6 damage when attacked"},
    {name:"Taunt", cost:1, effect:"taunt", value:0, rarity:"common", description:"Enemy is more likely to attack next turn"},
    {name:"Dodge", cost:1, effect:"evade", value:0, rarity:"rare", description:"50% chance to avoid next attack"},
    {name:"Rejuvenate", cost:2, effect:"heal", value:8, rarity:"rare", description:"Heal 8 HP"},
    {name:"Double Strike", cost:2, effect:"multistrike", value:5, rarity:"epic", description:"Deal 5 damage twice"},
    {name:"Last Stand", cost:3, effect:"laststand", value:15, rarity:"legendary", description:"Deal 15 damage when below 25% HP"}
];

let enemies = [
    { name:"Hunter", hp:40, maxHP:40, attack:6, ability:"buff", reward:15, description:"Gains strength each turn", avatar:"üèπ" },
    { name:"Paladin", hp:60, maxHP:60, attack:8, ability:"smite", reward:25, description:"Occasionally smites for massive damage", avatar:"‚öîÔ∏è" },
    { name:"Demon Lord", hp:100, maxHP:100, attack:12, ability:"fireball", reward:40, description:"Casts devastating fire spells", avatar:"üëπ" },
    { name:"Undead Horde", hp:80, maxHP:80, attack:10, ability:"summon", reward:30, description:"Summons reinforcements", avatar:"‚ò†Ô∏è" },
    { name:"Dark Sorcerer", hp:70, maxHP:70, attack:15, ability:"curse", reward:35, description:"Inflicts debilitating curses", avatar:"üßô" },
    { name:"Dragon", hp:120, maxHP:120, attack:20, ability:"firebreath", reward:50, description:"Breathes fire every turn", avatar:"üê≤" },
    { name:"Necromancer", hp:90, maxHP:90, attack:12, ability:"raise", reward:45, description:"Raises fallen enemies", avatar:"üßü" },
    { name:"Vampire Hunter", hp:75, maxHP:75, attack:18, ability:"silver", reward:40, description:"Specialized against vampires", avatar:"üßõ‚Äç‚ôÇÔ∏è" },
    { name:"Werewolf Hunter", hp:85, maxHP:85, attack:16, ability:"silver", reward:40, description:"Specialized against werewolves", avatar:"üê∫‚Äç‚û°Ô∏è" },
    { name:"Ancient Lich", hp:150, maxHP:150, attack:25, ability:"darkmagic", reward:75, description:"Master of dark arts", avatar:"üíÄ" }
];

let currentEnemyIndex = 0;
let enemy = {};
let currentBattleEffects = [];
let enemyEffects = [];

// Game Functions
function chooseClass(chosenClass) {
    if (chosenClass === "Vampire") {
        player = { 
            class: "Vampire", 
            maxHP: 60,
            hp: 60,
            inventory: ["Health Potion", "Energy Potion"],
            deck: [
                getCardByName("Bite"),
                getCardByName("Blood Drain"),
                getCardByName("Dark Mist"),
                getCardByName("Moonlight"),
                getCardByName("Quick Strike"),
                getCardByName("Defend")
            ],
            level: 1,
            xp: 0,
            maxEnergy: 2
        };
    } else {
        player = { 
            class: "Werewolf", 
            maxHP: 70,
            hp: 70,
            inventory: ["Health Potion", "Energy Potion"],
            deck: [
                getCardByName("Claw Swipe"),
                getCardByName("Howl"),
                getCardByName("Regenerate"),
                getCardByName("Pounce"),
                getCardByName("Defend"),
                getCardByName("Quick Strike")
            ],
            level: 1,
            xp: 0,
            maxEnergy: 2
        };
    }

    deck = [...player.deck];
    shuffleDeck(deck);
    document.getElementById("class-selection").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
    document.getElementById("class-name").innerText = `You are a ${player.class}`;
    
    // Set avatar
    const avatar = player.class === "Vampire" ? "üßõ" : "üê∫";
    document.getElementById("player-avatar").innerHTML = `<div class="player-avatar ${player.class.toLowerCase()}-avatar">${avatar}</div>`;
    document.getElementById("battle-player-avatar").innerHTML = `<div class="player-avatar ${player.class.toLowerCase()}-avatar">${avatar}</div>`;
    
    updatePlayerStats();
    updateDeckInfo();
    updateNextEnemy();
}

function getCardByName(name) {
    // Check vampire cards
    for (let card of vampireCards) {
        if (card.name === name) return {...card};
    }
    
    // Check werewolf cards
    for (let card of werewolfCards) {
        if (card.name === name) return {...card};
    }
    
    // Check neutral cards
    for (let card of neutralCards) {
        if (card.name === name) return {...card};
    }
    
    return null;
}

function shuffleDeck(deck) {
    for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
    }
}

function updatePlayerStats() {
    const healthPercent = (player.hp / player.maxHP) * 100;
    document.getElementById("player-health-fill").style.width = `${healthPercent}%`;
    document.getElementById("player-health-text").innerText = `${player.hp}/${player.maxHP}`;
    document.getElementById("battle-player-health-fill").style.width = `${healthPercent}%`;
    document.getElementById("battle-player-health-text").innerText = `${player.hp}/${player.maxHP}`;
    document.getElementById("gold-display").innerText = gold;
    document.getElementById("level-display").innerText = player.level;
    document.getElementById("inventory-count").innerText = player.inventory.length;
    
    // Update status effects
    updateStatusEffects();
}

function updateStatusEffects() {
    const effectsDiv = document.getElementById("status-effects");
    const battleEffectsDiv = document.getElementById("battle-status-effects");
    effectsDiv.innerHTML = "";
    battleEffectsDiv.innerHTML = "";
    
    if (buffedAttack > 0) {
        effectsDiv.innerHTML += `<span class="status-effect buff">+${buffedAttack} Attack</span>`;
        battleEffectsDiv.innerHTML += `<span class="status-effect buff">+${buffedAttack} Attack</span>`;
    }
    
    if (block > 0) {
        effectsDiv.innerHTML += `<span class="status-effect block">${block} Block</span>`;
        battleEffectsDiv.innerHTML += `<span class="status-effect block">${block} Block</span>`;
    }
    
    if (evadeNextAttack) {
        effectsDiv.innerHTML += `<span class="status-effect buff">Evade</span>`;
        battleEffectsDiv.innerHTML += `<span class="status-effect buff">Evade</span>`;
    }
}

function updateEnemyStatusEffects() {
    const effectsDiv = document.getElementById("enemy-status-effects");
    effectsDiv.innerHTML = "";
    
    if (enemyBleedStacks > 0) {
        effectsDiv.innerHTML += `<span class="status-effect bleed">Bleed (${enemyBleedStacks})</span>`;
    }
}

function updateDeckInfo() {
    document.getElementById("deck-count").innerText = deck.length;
    document.getElementById("discard-count").innerText = discard.length;
    document.getElementById("modal-deck-count").innerText = deck.length + hand.length;
    document.getElementById("modal-discard-count").innerText = discard.length;
}

function updateNextEnemy() {
    if (currentEnemyIndex < enemies.length) {
        document.getElementById("next-enemy").innerText = enemies[currentEnemyIndex].name;
    } else {
        document.getElementById("next-enemy").innerText = "Final Boss";
    }
}

function startBattle() {
    enemy = {...enemies[currentEnemyIndex]};
    document.getElementById("stats").classList.add("hidden");
    document.getElementById("battle").classList.remove("hidden");
    document.getElementById("battle-title").innerText = `Battle ${currentEnemyIndex+1}: ${enemy.name}`;
    document.getElementById("enemy-name").innerText = enemy.name;
    
    // Set enemy avatar
    document.getElementById("enemy-avatar").innerHTML = `<div class="enemy-avatar">${enemy.avatar}</div>`;
    
    // Reset battle state
    block = 0;
    evadeNextAttack = false;
    buffedAttack = 0;
    enemyBleedStacks = 0;
    enemyBleedDamage = 0;
    currentBattleEffects = [];
    enemyEffects = [];
    energyCarryover = 0; // Reset energy carryover at start of battle
    
    updateEnemyStats();
    energy = player.maxEnergy;
    updateEnergyDisplay();
    drawCards(5); // Draw 5 cards at start of battle
    renderInventory();
    log(`A wild ${enemy.name} appears! ${enemy.description}`);
}

function updateEnemyStats() {
    const healthPercent = (enemy.hp / enemy.maxHP) * 100;
    document.getElementById("enemy-health-fill").style.width = `${healthPercent}%`;
    document.getElementById("enemy-health-text").innerText = `${enemy.hp}/${enemy.maxHP}`;
    updateEnemyStatusEffects();
}

function updateEnergyDisplay() {
    let energyDiv = document.getElementById("energy-display");
    energyDiv.innerHTML = "";
    for (let i = 0; i < player.maxEnergy; i++) {
        const orb = document.createElement("div");
        orb.className = "energy-orb" + (i < energy ? "" : " empty");
        energyDiv.appendChild(orb);
    }
}

function drawCards(amount = 5) {
    // If deck is empty, shuffle discard into deck
    if (deck.length === 0) {
        if (discard.length === 0) {
            log("No cards left to draw!");
            return;
        }
        deck = [...discard];
        discard = [];
        shuffleDeck(deck);
        log("Shuffled discard pile into deck!");
    }
    
    // Draw cards
    let cardsDrawn = 0;
    for (let i = 0; i < amount && deck.length > 0; i++) {
        let card = deck.shift();
        if (card) {
            hand.push(card);
            cardsDrawn++;
        }
    }
    
    if (cardsDrawn > 0) {
        log(`Drew ${cardsDrawn} card${cardsDrawn > 1 ? 's' : ''}`);
    }
    
    renderHand();
    updateDeckInfo();
}

function renderHand() {
    let handDiv = document.getElementById("hand");
    handDiv.innerHTML = "";
    
    hand.forEach((card, index) => {
        const cardElement = document.createElement("div");
        cardElement.className = `card ${card.rarity}`;
        cardElement.onclick = () => playCard(index);
        
        // Rarity label
        const rarityLabel = document.createElement("div");
        rarityLabel.className = `rarity-label ${card.rarity}-label`;
        rarityLabel.textContent = card.rarity.charAt(0).toUpperCase() + card.rarity.slice(1);
        
        // Cost orb
        const costOrb = document.createElement("div");
        costOrb.className = "card-cost";
        costOrb.textContent = card.cost;
        
        // Card content
        const cardName = document.createElement("h4");
        cardName.textContent = card.name;
        
        const cardEffect = document.createElement("p");
        cardEffect.textContent = card.description;
        cardEffect.style.marginTop = "10px";
        cardEffect.style.fontSize = "0.9rem";
        cardEffect.style.color = "#ccc";
        
        // Tooltip
        const tooltip = document.createElement("div");
        tooltip.className = "tooltip";
        tooltip.innerHTML = `<strong>${card.name}</strong><br>${card.description}<br><br>Cost: ${card.cost}<br>Rarity: ${card.rarity}`;
        
        // Append elements
        cardElement.appendChild(rarityLabel);
        cardElement.appendChild(costOrb);
        cardElement.appendChild(cardName);
        cardElement.appendChild(cardEffect);
        cardElement.appendChild(tooltip);
        
        handDiv.appendChild(cardElement);
    });
}

function playCard(index) {
    if (index >= hand.length) return;
    
    let card = hand[index];
    if (energy < card.cost) {
        log("‚ö†Ô∏è Not enough energy!");
        return;
    }
    
    energy -= card.cost;
    updateEnergyDisplay();

    // Card effects
    let effectApplied = false;
    
    if (card.effect === "attack") {
        const totalDamage = card.value + buffedAttack;
        enemy.hp -= totalDamage;
        log(`üó°Ô∏è ${card.name} deals ${totalDamage} damage!`);
        effectApplied = true;
    } 
    else if (card.effect === "lifesteal") {
        const totalDamage = card.value + buffedAttack;
        enemy.hp -= totalDamage;
        player.hp = Math.min(player.hp + totalDamage, player.maxHP);
        log(`ü©∏ ${card.name} drains ${totalDamage} HP!`);
        effectApplied = true;
    } 
    else if (card.effect === "buff") {
        buffedAttack += card.value;
        log(`üí™ ${card.name} powers you up (+${card.value} attack next turn)!`);
        effectApplied = true;
    } 
    else if (card.effect === "heal") {
        player.hp = Math.min(player.hp + card.value, player.maxHP);
        log(`üß™ ${card.name} heals ${card.value} HP`);
        effectApplied = true;
    }
    else if (card.effect === "evade") {
        evadeNextAttack = true;
        if (card.name === "Shadow Veil") {
            evadeNextAttack = 2; // Special case for Shadow Veil
        }
        log(`üëª ${card.name} - Next enemy attack will miss!`);
        effectApplied = true;
    }
    else if (card.effect === "multistrike") {
        const hits = card.name === "Moon Frenzy" ? 3 : 
                    card.name === "Blood Frenzy" ? 2 : 
                    card.name === "Fury Swipes" ? 2 : 2;
        const totalDamage = (card.value + buffedAttack) * hits;
        enemy.hp -= totalDamage;
        log(`‚ö° ${card.name} hits ${hits} times for ${card.value + buffedAttack} damage each (${totalDamage} total)!`);
        effectApplied = true;
    }
    else if (card.effect === "block") {
        block += card.value;
        log(`üõ°Ô∏è ${card.name} gives you ${card.value} block`);
        effectApplied = true;
    }
    else if (card.effect === "energy") {
        energy += card.value;
        updateEnergyDisplay();
        log(`‚ö° ${card.name} gives you ${card.value} energy`);
        effectApplied = true;
    }
    else if (card.effect === "draw") {
        drawCards(card.value);
        log(`üé¥ ${card.name} lets you draw ${card.value} card${card.value > 1 ? 's' : ''}`);
        effectApplied = true;
    }
    else if (card.effect === "bleed") {
        enemyBleedStacks = 3;
        enemyBleedDamage = card.value;
        log(`ü©∏ ${card.name} makes enemy bleed for ${card.value} damage for 3 turns`);
        effectApplied = true;
    }
    else if (card.effect === "sacrifice") {
        player.hp -= card.value;
        drawCards(2);
        log(`üíÄ ${card.name} - Lose ${card.value} HP to draw 2 cards`);
        effectApplied = true;
    }
    else if (card.effect === "aoe") {
        // For future multi-enemy battles
        enemy.hp -= card.value;
        log(`üåÄ ${card.name} deals ${card.value} damage to all enemies!`);
        effectApplied = true;
    }
    else if (card.effect === "drain") {
        const damage = card.value;
        enemy.hp -= damage;
        player.hp = Math.min(player.hp + Math.floor(damage/2), player.maxHP);
        log(`‚ö∞Ô∏è ${card.name} deals ${damage} damage and heals for ${Math.floor(damage/2)}`);
        effectApplied = true;
    }
    else if (card.effect === "laststand" && player.hp <= Math.floor(player.maxHP * 0.25)) {
        enemy.hp -= card.value;
        log(`‚öîÔ∏è ${card.name} - Last Stand deals ${card.value} damage!`);
        effectApplied = true;
    }
    
    if (effectApplied) {
        // Discard the card
        discard.push(card);
        hand.splice(index, 1);
        renderHand();
        updateDeckInfo();
        
        // Update stats displays
        updatePlayerStats();
        updateEnemyStats();

        // Win check
        if (enemy.hp <= 0) {
            enemy.hp = 0;
            updateEnemyStats();
            victory();
            return;
        }
    }
}

function enemyTurn() {
    // Apply bleed damage if active
    if (enemyBleedStacks > 0) {
        enemy.hp -= enemyBleedDamage;
        enemyBleedStacks--;
        log(`ü©∏ Enemy bleeds for ${enemyBleedDamage} damage! (${enemyBleedStacks} turns remaining)`);
        updateEnemyStats();
        
        if (enemy.hp <= 0) {
            enemy.hp = 0;
            updateEnemyStats();
            victory();
            return;
        }
    }
    
    if (evadeNextAttack) {
        if (typeof evadeNextAttack === 'number') {
            evadeNextAttack--;
            if (evadeNextAttack <= 0) {
                evadeNextAttack = false;
                log(`üëª You evade the enemy's attack! (No more evades left)`);
            } else {
                log(`üëª You evade the enemy's attack! (${evadeNextAttack} evades remaining)`);
            }
        } else {
            log(`üëª You evade the enemy's attack!`);
            evadeNextAttack = false;
        }
        return;
    }
    
    let damageTaken = 0;
    
    if (enemy.ability === "buff") {
        enemy.attack += 2;
        log(`${enemy.name} enrages! Attack +2 (now ${enemy.attack})`);
    } 
    else if (enemy.ability === "smite" && Math.random() < 0.3) {
        const smiteDamage = enemy.attack + 5;
        damageTaken = Math.max(0, smiteDamage - block);
        block = Math.max(0, block - smiteDamage);
        player.hp -= damageTaken;
        log(`‚òÑÔ∏è ${enemy.name} uses Smite! Deals ${smiteDamage} damage (${block > 0 ? `${block} blocked` : ''})`);
    } 
    else if (enemy.ability === "fireball" && Math.random() < 0.4) {
        const fireDamage = 10;
        damageTaken = Math.max(0, fireDamage - block);
        block = Math.max(0, block - fireDamage);
        player.hp -= damageTaken;
        log(`üî• ${enemy.name} casts Fireball! Deals ${fireDamage} damage (${block > 0 ? `${block} blocked` : ''})`);
    } 
    else if (enemy.ability === "summon" && Math.random() < 0.25) {
        enemy.hp += 10;
        log(`${enemy.name} summons reinforcements! +10 HP`);
        updateEnemyStats();
    }
    else if (enemy.ability === "curse" && Math.random() < 0.3) {
        player.hp -= 5;
        log(`‚ò†Ô∏è ${enemy.name} curses you! Lose 5 HP`);
    }
    else if (enemy.ability === "firebreath") {
        const fireDamage = 8;
        damageTaken = Math.max(0, fireDamage - block);
        block = Math.max(0, block - fireDamage);
        player.hp -= damageTaken;
        log(`üî• ${enemy.name} breathes fire! Deals ${fireDamage} damage (${block > 0 ? `${block} blocked` : ''})`);
    }
    else if (enemy.ability === "raise") {
        // For future multi-enemy battles
        log(`${enemy.name} attempts to raise the dead...`);
    }
    else if (enemy.ability === "silver") {
        const silverDamage = enemy.attack + 3;
        damageTaken = Math.max(0, silverDamage - block);
        block = Math.max(0, block - silverDamage);
        player.hp -= damageTaken;
        log(`‚öîÔ∏è ${enemy.name} uses silver weapons! Deals ${silverDamage} damage (${block > 0 ? `${block} blocked` : ''})`);
    }
    else if (enemy.ability === "darkmagic") {
        const magicDamage = 15;
        damageTaken = Math.max(0, magicDamage - block);
        block = Math.max(0, block - magicDamage);
        player.hp -= damageTaken;
        log(`‚ò†Ô∏è ${enemy.name} casts dark magic! Deals ${magicDamage} damage (${block > 0 ? `${block} blocked` : ''})`);
    }
    else {
        // Normal attack
        damageTaken = Math.max(0, enemy.attack - block);
        block = Math.max(0, block - enemy.attack);
        player.hp -= damageTaken;
        log(`${enemy.name} attacks for ${enemy.attack} damage (${block > 0 ? `${block} blocked` : ''})`);
    }
    
    // Reset block after turn
    block = 0;
    
    updatePlayerStats();
    if (player.hp <= 0) {
        player.hp = 0;
        updatePlayerStats();
        endGame(false);
    }
}

function endTurn() {
    log("--- End of Turn ---");
    
    // Apply buffed attack if any
    if (buffedAttack > 0) {
        log(`üí™ Your attack bonus fades`);
        buffedAttack = 0;
    }
    
    // Track unused energy for next turn
    if (energy > 0) {
        energyCarryover = energy; // Store unused energy
        log(`‚ö° You have ${energy} unused energy that will carry over to next turn`);
    } else {
        energyCarryover = 0; // Reset if no energy left
    }
    
    // Enemy turn
    if (enemy.hp > 0) {
        enemyTurn();
    }
    
    // Reset energy and draw cards
    energy = player.maxEnergy + energyCarryover; // Add carryover to max energy
    if (energy > player.maxEnergy + 10) { // Cap at maxEnergy + 3
        energy = player.maxEnergy + 10;
    }
    updateEnergyDisplay();
    discard.push(...hand);
    hand = [];
    drawCards(5);
    
    log("--- New Turn ---");
}

function toggleInventory() {
    document.getElementById("inventory").classList.toggle("hidden");
}

function renderInventory() {
    let invDiv = document.getElementById("inventory");
    invDiv.innerHTML = "<h3>Inventory</h3>";
    
    if (player.inventory.length === 0) {
        invDiv.innerHTML += "<p>Your inventory is empty</p>";
        return;
    }
    
    player.inventory.forEach((item, index) => {
        const itemElement = document.createElement("div");
        itemElement.className = "inventory-item";
        itemElement.textContent = item;
        itemElement.onclick = () => useItem(index);
        
        // Add tooltip
        const tooltip = document.createElement("div");
        tooltip.className = "tooltip";
        
        if (item === "Health Potion") {
            tooltip.textContent = "Restores 20 HP";
        } else if (item === "Energy Potion") {
            tooltip.textContent = "Restores all energy";
        }
        
        itemElement.appendChild(tooltip);
        invDiv.appendChild(itemElement);
    });
}

function useItem(index) {
    if (index >= player.inventory.length) return;
    
    let item = player.inventory[index];
    
    if (item === "Health Potion") {
        player.hp = Math.min(player.hp + 20, player.maxHP);
        log("üß™ Used Health Potion! +20 HP");
    } 
    else if (item === "Energy Potion") {
        energy = player.maxEnergy;
        updateEnergyDisplay();
        log("‚ö° Used Energy Potion! Energy restored");
    }
    
    player.inventory.splice(index, 1);
    updatePlayerStats();
    renderInventory();
}

function victory() {
    const xpGain = 10 + currentEnemyIndex * 5;
    player.xp += xpGain;
    gold += enemy.reward;
    
    // Check for level up
    const xpNeeded = player.level * 20;
    if (player.xp >= xpNeeded) {
        player.level++;
        player.xp = 0;
        player.maxHP += 5;
        player.hp = player.maxHP;
        log(`üéâ Level Up! You are now level ${player.level}! +5 Max HP`);
    }
    
    log(`üéâ Victory! You defeated ${enemy.name} and earned ${enemy.reward} gold and ${xpGain} XP!`);
    
    setTimeout(() => {
        currentEnemyIndex++;
        document.getElementById("battle").classList.add("hidden");
        
        if (currentEnemyIndex < enemies.length) {
            rewardScreen();
        } else {
            endGame(true);
        }
    }, 1500);
}

function rewardScreen() {
    document.getElementById("reward-screen").classList.remove("hidden");
    document.getElementById("gold-reward-amount").textContent = Math.floor(enemy.reward * 1.5);
    
    // Clear previous rewards
    document.getElementById("reward-cards").innerHTML = "";
    updatePlayerStats();
    updateNextEnemy();
}

function getRandomCardReward() {
    let rewardDiv = document.getElementById("reward-cards");
    rewardDiv.innerHTML = "";
    
    // Get all possible cards for the player's class
    let classCards = player.class === "Vampire" ? vampireCards : werewolfCards;
    let allCards = [...classCards, ...neutralCards];
    
    // Choose 3 random cards (with higher chance for better rarity)
    let rewards = [];
    for (let i = 0; i < 3; i++) {
        let rarityRoll = Math.random();
        let rarity;
        
        if (rarityRoll < 0.5) rarity = "common";
        else if (rarityRoll < 0.8) rarity = "rare";
        else if (rarityRoll < 0.95) rarity = "epic";
        else if (rarityRoll < 0.99) rarity = "legendary";
        else rarity = "ancient";
        
        // Filter cards by rarity and pick one randomly
        let eligibleCards = allCards.filter(card => card.rarity === rarity);
        if (eligibleCards.length === 0) {
            // Fallback to any rarity if none available for selected rarity
            eligibleCards = allCards;
        }
        
        let card = {...eligibleCards[Math.floor(Math.random() * eligibleCards.length)]};
        rewards.push(card);
    }
    
    rewards.forEach(card => {
        const cardElement = document.createElement("div");
        cardElement.className = `card ${card.rarity}`;
        cardElement.onclick = () => chooseReward(card);
        
        // Rarity label
        const rarityLabel = document.createElement("div");
        rarityLabel.className = `rarity-label ${card.rarity}-label`;
        rarityLabel.textContent = card.rarity.charAt(0).toUpperCase() + card.rarity.slice(1);
        
        // Cost orb
        const costOrb = document.createElement("div");
        costOrb.className = "card-cost";
        costOrb.textContent = card.cost;
        
        // Card content
        const cardName = document.createElement("h4");
        cardName.textContent = card.name;
        
        const cardEffect = document.createElement("p");
        cardEffect.textContent = card.description;
        cardEffect.style.marginTop = "10px";
        cardEffect.style.fontSize = "0.9rem";
        cardEffect.style.color = "#ccc";
        
        // Append elements
        cardElement.appendChild(rarityLabel);
        cardElement.appendChild(costOrb);
        cardElement.appendChild(cardName);
        cardElement.appendChild(cardEffect);
        
        rewardDiv.appendChild(cardElement);
    });
}

function getGoldReward() {
    const goldAmount = Math.floor(enemy.reward * 1.5);
    gold += goldAmount;
    log(`üí∞ You received ${goldAmount} gold!`);
    document.getElementById("reward-screen").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
    updatePlayerStats();
}

function getPotionReward() {
    player.inventory.push("Health Potion", "Energy Potion");
    log(`üß¥ You received Health Potion and Energy Potion!`);
    document.getElementById("reward-screen").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
    updatePlayerStats();
}

function chooseReward(card) {
    deck.push({...card});
    log(`‚ú® Added ${card.name} to your deck!`);
    document.getElementById("reward-screen").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
    updatePlayerStats();
    updateDeckInfo();
}

function skipReward() {
    document.getElementById("reward-screen").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
}

function enterShop() {
    document.getElementById("stats").classList.add("hidden");
    document.getElementById("shop").classList.remove("hidden");
    document.getElementById("gold").innerText = gold;
    renderShop();
}

function renderShop() {
    let shopDiv = document.getElementById("shop-cards");
    shopDiv.innerHTML = "";
    
    // Get all possible cards for the player's class
    let classCards = player.class === "Vampire" ? vampireCards : werewolfCards;
    let allCards = [...classCards, ...neutralCards];
    
    // Select 6 random cards to offer (weighted by rarity)
    let shopOffers = [];
    for (let i = 0; i < 6; i++) {
        let rarityRoll = Math.random();
        let rarity;
        
        if (rarityRoll < 0.6) rarity = "common";
        else if (rarityRoll < 0.85) rarity = "rare";
        else if (rarityRoll < 0.97) rarity = "epic";
        else if (rarityRoll < 0.99) rarity = "legendary";
        else rarity = "ancient";
        
        // Filter cards by rarity and pick one randomly
        let eligibleCards = allCards.filter(card => card.rarity === rarity);
        if (eligibleCards.length === 0) {
            // Fallback to any rarity if none available for selected rarity
            eligibleCards = allCards;
        }
        
        let card = {...eligibleCards[Math.floor(Math.random() * eligibleCards.length)]};
        shopOffers.push(card);
    }
    
    shopOffers.forEach(card => {
        const cardElement = document.createElement("div");
        cardElement.className = `card ${card.rarity}`;
        cardElement.onclick = () => buyCard(card);
        
        // Rarity label
        const rarityLabel = document.createElement("div");
        rarityLabel.className = `rarity-label ${card.rarity}-label`;
        rarityLabel.textContent = card.rarity.charAt(0).toUpperCase() + card.rarity.slice(1);
        
        // Cost orb
        const costOrb = document.createElement("div");
        costOrb.className = "card-cost";
        costOrb.textContent = getCardCost(card);
        
        // Card content
        const cardName = document.createElement("h4");
        cardName.textContent = card.name;
        
        const cardEffect = document.createElement("p");
        cardEffect.textContent = card.description;
        cardEffect.style.marginTop = "10px";
        cardEffect.style.fontSize = "0.9rem";
        cardEffect.style.color = "#ccc";
        
        const cardPrice = document.createElement("p");
        cardPrice.textContent = `${getCardCost(card)} gold`;
        cardPrice.style.color = "gold";
        cardPrice.style.fontWeight = "bold";
        
        // Append elements
        cardElement.appendChild(rarityLabel);
        cardElement.appendChild(costOrb);
        cardElement.appendChild(cardName);
        cardElement.appendChild(cardEffect);
        cardElement.appendChild(cardPrice);
        
        shopDiv.appendChild(cardElement);
    });
}

function getCardCost(card) {
    switch(card.rarity) {
        case "common": return 20;
        case "rare": return 35;
        case "epic": return 60;
        case "legendary": return 100;
        case "ancient": return 150;
        default: return 25;
    }
}

function buyCard(card) {
    const cost = getCardCost(card);
    if (gold < cost) {
        alert(`Not enough gold! Need ${cost} gold.`);
        return;
    }
    
    deck.push({...card});
    gold -= cost;
    document.getElementById("gold").innerText = gold;
    updatePlayerStats();
    log(`Purchased ${card.name} for ${cost} gold!`);
    renderShop();
}

function buyPotion() {
    if (gold < 15) {
        alert("Not enough gold! Need 15 gold.");
        return;
    }
    
    player.inventory.push("Health Potion");
    gold -= 15;
    document.getElementById("gold").innerText = gold;
    updatePlayerStats();
    log(`Purchased Health Potion for 15 gold!`);
}

function buyEnergyPotion() {
    if (gold < 20) {
        alert("Not enough gold! Need 20 gold.");
        return;
    }
    
    player.inventory.push("Energy Potion");
    gold -= 20;
    document.getElementById("gold").innerText = gold;
    updatePlayerStats();
    log(`Purchased Energy Potion for 20 gold!`);
}

function upgradeMaxHP() {
    if (gold < 25) {
        alert("Not enough gold! Need 25 gold.");
        return;
    }
    
    player.maxHP += 10;
    player.hp += 10;
    gold -= 25;
    document.getElementById("gold").innerText = gold;
    updatePlayerStats();
    log(`Upgraded max HP by 10 for 25 gold!`);
}

function upgradeEnergy() {
    if (gold < 30) {
        alert("Not enough gold! Need 30 gold.");
        return;
    }
    
    player.maxEnergy += 1;
    gold -= 30;
    document.getElementById("gold").innerText = gold;
    updatePlayerStats();
    log(`Upgraded max energy to ${player.maxEnergy} for 30 gold!`);
}

function removeCard() {
    if (gold < 25) {
        alert("Not enough gold! Need 25 gold.");
        return;
    }
    
    if (deck.length + hand.length <= 5) {
        alert("Your deck is too small to remove cards!");
        return;
    }
    
    showDeckForRemoval();
}

function showDeckForRemoval() {
    const modal = document.getElementById("deck-modal");
    modal.classList.remove("hidden");
    
    const modalDeck = document.getElementById("modal-deck");
    modalDeck.innerHTML = "";
    
    // Combine deck and hand for removal
    const allCards = [...deck, ...hand];
    
    if (allCards.length === 0) {
        modalDeck.innerHTML = "<p>No cards to remove</p>";
        return;
    }
    
    allCards.forEach((card, index) => {
        const cardElement = document.createElement("div");
        cardElement.className = `card ${card.rarity}`;
        cardElement.onclick = () => removeCardFromDeck(index, card);
        
        // Rarity label
        const rarityLabel = document.createElement("div");
        rarityLabel.className = `rarity-label ${card.rarity}-label`;
        rarityLabel.textContent = card.rarity.charAt(0).toUpperCase() + card.rarity.slice(1);
        
        // Cost orb
        const costOrb = document.createElement("div");
        costOrb.className = "card-cost";
        costOrb.textContent = card.cost;
        
        // Card content
        const cardName = document.createElement("h4");
        cardName.textContent = card.name;
        
        const cardEffect = document.createElement("p");
        cardEffect.textContent = card.description;
        cardEffect.style.marginTop = "10px";
        cardEffect.style.fontSize = "0.9rem";
        cardEffect.style.color = "#ccc";
        
        // Append elements
        cardElement.appendChild(rarityLabel);
        cardElement.appendChild(costOrb);
        cardElement.appendChild(cardName);
        cardElement.appendChild(cardEffect);
        
        modalDeck.appendChild(cardElement);
    });
}

function removeCardFromDeck(index, card) {
    // Check if card is in hand or deck
    if (index < deck.length) {
        deck.splice(index, 1);
    } else {
        hand.splice(index - deck.length, 1);
    }
    
    gold -= 25;
    document.getElementById("gold").innerText = gold;
    updatePlayerStats();
    updateDeckInfo();
    log(`Removed ${card.name} from your deck for 25 gold`);
    closeModal("deck-modal");
}

function rerollShop() {
    if (gold < shopRerollCost) {
        alert(`Not enough gold! Need ${shopRerollCost} gold.`);
        return;
    }
    
    gold -= shopRerollCost;
    shopRerollCost += 5; // Increase cost for next reroll
    document.getElementById("gold").innerText = gold;
    renderShop();
    log(`Rerolled shop for ${shopRerollCost-5} gold (next reroll: ${shopRerollCost} gold)`);
    updatePlayerStats();
}

function exitShop() {
    shopRerollCost = 10; // Reset reroll cost
    document.getElementById("shop").classList.add("hidden");
    document.getElementById("stats").classList.remove("hidden");
}

function viewDeck() {
    const modal = document.getElementById("deck-modal");
    modal.classList.remove("hidden");
    
    const modalDeck = document.getElementById("modal-deck");
    modalDeck.innerHTML = "";
    
    // Combine deck and hand for viewing
    const allCards = [...deck, ...hand];
    
    if (allCards.length === 0) {
        modalDeck.innerHTML = "<p>Your deck is empty</p>";
        return;
    }
    
    // Group cards by type
    const cardGroups = {
        attack: [],
        heal: [],
        buff: [],
        block: [],
        other: []
    };
    
    allCards.forEach(card => {
        if (card.effect === "attack" || card.effect === "lifesteal" || card.effect === "multistrike" || card.effect === "bleed") {
            cardGroups.attack.push(card);
        } else if (card.effect === "heal" || card.effect === "drain") {
            cardGroups.heal.push(card);
        } else if (card.effect === "buff") {
            cardGroups.buff.push(card);
        } else if (card.effect === "block") {
            cardGroups.block.push(card);
        } else {
            cardGroups.other.push(card);
        }
    });
    
    // Display by groups
    const groupNames = {
        attack: "Attack Cards",
        heal: "Healing Cards",
        buff: "Buff Cards",
        block: "Defense Cards",
        other: "Other Cards"
    };
    
    for (const [group, cards] of Object.entries(cardGroups)) {
        if (cards.length > 0) {
            const groupHeader = document.createElement("h3");
            groupHeader.textContent = groupNames[group];
            groupHeader.style.marginTop = "20px";
            groupHeader.style.color = "#aaa";
            modalDeck.appendChild(groupHeader);
            
            cards.forEach(card => {
                const cardElement = document.createElement("div");
                cardElement.className = `card ${card.rarity}`;
                
                // Rarity label
                const rarityLabel = document.createElement("div");
                rarityLabel.className = `rarity-label ${card.rarity}-label`;
                rarityLabel.textContent = card.rarity.charAt(0).toUpperCase() + card.rarity.slice(1);
                
                // Cost orb
                const costOrb = document.createElement("div");
                costOrb.className = "card-cost";
                costOrb.textContent = card.cost;
                
                // Card content
                const cardName = document.createElement("h4");
                cardName.textContent = card.name;
                
                const cardEffect = document.createElement("p");
                cardEffect.textContent = card.description;
                cardEffect.style.marginTop = "10px";
                cardEffect.style.fontSize = "0.9rem";
                cardEffect.style.color = "#ccc";
                
                // Append elements
                cardElement.appendChild(rarityLabel);
                cardElement.appendChild(costOrb);
                cardElement.appendChild(cardName);
                cardElement.appendChild(cardEffect);
                
                modalDeck.appendChild(cardElement);
            });
        }
    }
}

function viewDiscard() {
    const modal = document.getElementById("discard-modal");
    modal.classList.remove("hidden");
    
    const modalDiscard = document.getElementById("modal-discard");
    modalDiscard.innerHTML = "";
    
    if (discard.length === 0) {
        modalDiscard.innerHTML = "<p>Your discard pile is empty</p>";
        return;
    }
    
    discard.forEach(card => {
        const cardElement = document.createElement("div");
        cardElement.className = `card ${card.rarity}`;
        
        // Rarity label
        const rarityLabel = document.createElement("div");
        rarityLabel.className = `rarity-label ${card.rarity}-label`;
        rarityLabel.textContent = card.rarity.charAt(0).toUpperCase() + card.rarity.slice(1);
        
        // Cost orb
        const costOrb = document.createElement("div");
        costOrb.className = "card-cost";
        costOrb.textContent = card.cost;
        
        // Card content
        const cardName = document.createElement("h4");
        cardName.textContent = card.name;
        
        const cardEffect = document.createElement("p");
        cardEffect.textContent = card.description;
        cardEffect.style.marginTop = "10px";
        cardEffect.style.fontSize = "0.9rem";
        cardEffect.style.color = "#ccc";
        
        // Append elements
        cardElement.appendChild(rarityLabel);
        cardElement.appendChild(costOrb);
        cardElement.appendChild(cardName);
        cardElement.appendChild(cardEffect);
        
        modalDiscard.appendChild(cardElement);
    });
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add("hidden");
}

function log(message) {
    let logDiv = document.getElementById("battle-log");
    logDiv.innerHTML += `<p>${message}</p>`;
    logDiv.scrollTop = logDiv.scrollHeight;
}

function endGame(victory) {
    if (victory) {
        alert(`üèÜ Congratulations! You defeated all enemies and won the game with ${gold} gold at level ${player.level}!`);
    } else {
        alert("‚ò†Ô∏è Game Over - You were defeated in battle");
    }
    location.reload();
}
</script>
</body>
</html>
