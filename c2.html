<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Castle of the Undead - Text Adventure</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'VT323', monospace;
            background-color: #000;
            color: #0f0;
            line-height: 1.4;
            height: 100vh;
            overflow: hidden;
            touch-action: pan-x pan-y;
            padding: 5px;
        }
        
        .container {
            max-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 2px solid #0f0;
            background-color: #000;
            padding: 8px;
            gap: 8px;
        }
        
        .header {
            text-align: center;
            padding: 8px 5px;
            border-bottom: 1px dashed #0f0;
            flex-shrink: 0;
        }
        
        .game-title {
            font-size: 1.8rem;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            margin-bottom: 5px;
        }
        
        .level-title {
            font-size: 1.2rem;
            color: #0f0;
        }
        
        .screen {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #0f0;
            padding: 12px;
            background-color: #111;
            font-size: 1.1rem;
            line-height: 1.5;
            min-height: 0;
            scroll-behavior: smooth;
        }
        
        .screen::-webkit-scrollbar {
            width: 8px;
        }
        
        .screen::-webkit-scrollbar-thumb {
            background-color: #0f0;
        }
        
        .output-text {
            margin-bottom: 8px;
            animation: typing 0.05s steps(1, end);
            word-wrap: break-word;
        }
        
        .npc-text {
            color: #0af;
        }
        
        .merchant-text {
            color: #ffa500;
        }
        
        .skeleton-text {
            color: #8a2be2;
        }
        
        .player-text {
            color: #8f8;
        }
        
        .important-text {
            color: #ff0;
            font-weight: bold;
        }
        
        .danger-text {
            color: #f00;
        }
        
        .success-text {
            color: #0f0;
        }
        
        .gold-text {
            color: #ffd700;
            text-shadow: 0 0 3px #ffd700;
        }
        
        .ghost-text {
            color: #add8e6;
            text-shadow: 0 0 3px #add8e6;
        }
        
        .lich-text {
            color: #8b0000;
            text-shadow: 0 0 3px #8b0000;
        }
        
        .action-panel {
            display: none;
            border: 1px solid #0f0;
            padding: 10px;
            background-color: #111;
            flex-shrink: 0;
        }
        
        .action-title {
            color: #0f0;
            margin-bottom: 10px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .action-choices {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .button {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 14px 8px;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.1s;
            touch-action: manipulation;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
        }
        
        .button:active {
            background-color: #0f0;
            color: #000;
        }
        
        .command-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            flex-shrink: 0;
        }
        
        .command-button {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 14px 5px;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.1s;
            touch-action: manipulation;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .command-button:active {
            background-color: #0f0;
            color: #000;
        }
        
        .code-input {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border: 1px solid #0f0;
            background-color: #111;
            margin-top: 10px;
        }
        
        .code-display {
            font-size: 1.8rem;
            letter-spacing: 8px;
            margin-bottom: 15px;
            padding: 5px 15px;
            border: 1px solid #0f0;
            min-width: 200px;
            text-align: center;
        }
        
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .keypad-button {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }
        
        .keypad-controls {
            display: flex;
            gap: 10px;
        }
        
        .keypad-control-button {
            padding: 10px 15px;
            min-width: 80px;
        }
        
        .inventory-panel {
            display: none;
            border: 1px solid #0f0;
            padding: 10px;
            background-color: #111;
            flex-shrink: 0;
        }
        
        .inventory-title {
            color: #0f0;
            margin-bottom: 10px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            border: 1px dashed #0f0;
            padding: 8px 10px;
            font-size: 1rem;
            min-width: 100px;
            text-align: center;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 8px 5px;
            border-top: 1px dashed #0f0;
            flex-shrink: 0;
            font-size: 0.9rem;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        @keyframes typing {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Responsive adjustments */
        @media (max-height: 700px) {
            .button, .command-button {
                padding: 10px 5px;
                font-size: 1rem;
                min-height: 40px;
            }
            
            .game-title {
                font-size: 1.5rem;
            }
            
            .level-title {
                font-size: 1rem;
            }
        }
        
        @media (max-height: 600px) {
            .screen {
                font-size: 1rem;
                padding: 8px;
            }
            
            .button, .command-button {
                padding: 8px 4px;
                min-height: 36px;
            }
            
            .keypad-button {
                width: 50px;
                height: 50px;
            }
        }
        
        .conversation-log {
            border-top: 1px dashed #0f0;
            margin-top: 10px;
            padding-top: 10px;
        }
        
        .conversation-title {
            color: #0f0;
            font-size: 1rem;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="game-title">CASTLE OF THE UNDEAD</div>
            <div class="level-title" id="levelTitle">TEXT ADVENTURE - CASTLE INTERIOR</div>
        </div>
        
        <div class="screen" id="gameScreen">
            <div class="output-text">CASTLE OF THE UNDEAD - Enhanced Text Adventure</div>
            <div class="output-text">Copyright (C) 1985 Nightfall Productions</div>
            <div class="output-text">Loading saved game... OK</div>
            <div class="output-text">Initializing level 3... OK</div>
            <div class="output-text">Initializing castle interior... OK</div>
            <div class="output-text">----------------------------------------</div>
            <div class="output-text" id="currentOutput">You step into the dark interior of the castle. The massive doors close behind you with an ominous THUD. The air is thick with dust and the scent of decay. You stand in a grand entry hall with a sweeping staircase ahead. Tattered banners hang from the walls. To your left, a doorway leads to what looks like a library. To your right, an archway leads to a dining hall. In the center of the room, a ghostly apparition floats silently.</div>
        </div>
        
        <!-- Action Panel for choices -->
        <div class="action-panel" id="actionPanel">
            <div class="action-title" id="actionTitle">Select Action</div>
            <div class="action-choices" id="actionChoices">
                <!-- Dynamic buttons will be inserted here -->
            </div>
        </div>
        
        <!-- Code Input Interface -->
        <div class="code-input" id="codeInput">
            <div class="code-display" id="codeDisplay">____</div>
            <div class="keypad">
                <!-- Keypad buttons will be generated by JavaScript -->
            </div>
            <div class="keypad-controls">
                <button class="button keypad-control-button" id="enterCodeBtn">ENTER</button>
                <button class="button keypad-control-button" id="clearCodeBtn">CLEAR</button>
                <button class="button keypad-control-button" id="cancelCodeBtn">CANCEL</button>
            </div>
        </div>
        
        <!-- Main Command Buttons -->
        <div class="command-buttons">
            <button class="command-button" id="lookBtn">LOOK</button>
            <button class="command-button" id="interactBtn">INTERACT</button>
            <button class="command-button" id="inventoryBtn">INVENTORY</button>
            <button class="command-button" id="talkBtn">TALK</button>
            <button class="command-button" id="useBtn">USE ITEM</button>
            <button class="command-button" id="moveBtn">MOVE</button>
            <button class="command-button" id="examineBtn">EXAMINE</button>
            <button class="command-button" id="helpBtn">HELP</button>
        </div>
        
        <!-- Inventory Panel -->
        <div class="inventory-panel" id="inventoryPanel">
            <div class="inventory-title">INVENTORY</div>
            <div class="inventory-items" id="inventoryItems">
                <div class="inventory-item">Empty</div>
            </div>
        </div>
        
        <div class="status-bar">
            <div>Location: <span id="locationValue">CASTLE INTERIOR</span></div>
            <div>Health: <span id="healthValue">100</span>%</div>
            <div>Gold: <span class="gold-text" id="goldValue">0</span></div>
            <div>Score: <span id="scoreValue">0</span></div>
        </div>
    </div>

    <script>
        // Load saved game state from localStorage
        let gameState = {
            currentLocation: "castleInterior",
            inventory: [],
            score: 0,
            health: 100,
            gold: 0,
            // Level 3 variables
            ghostSpoken: false,
            libraryExamined: false,
            diningHallExamined: false,
            hasAncientTome: false,
            hasCrystalShard: false,
            hasGhostlyKey: false,
            ghostPuzzleSolved: false,
            libraryPuzzleSolved: false,
            diningHallSecretFound: false,
            throneRoomUnlocked: false,
            lichEncountered: false,
            // Previous levels' variables (will be loaded)
            gateLocked: false,
            plaqueRead: false,
            guardSpoken: false,
            lanternLit: true,
            codeKnown: false,
            codeEntered: false,
            guardHelpful: false,
            guardFriendly: false,
            guardHostile: false,
            riddleSolved: false,
            hasNote: false,
            hasKey: false,
            hasTorch: false,
            hasCoinPurse: false,
            guardBribed: false,
            guardInfoBought: false,
            guardServiceBought: false,
            conversationHistory: [],
            merchantSpoken: false,
            hoodedSkeletonSpoken: false,
            hasSilverLocket: false,
            locketGivenToSkeleton: false,
            merchantScammed: false,
            boughtCursedItem: false,
            courtyardExamined: false,
            level2Complete: true
        };
        
        // DOM elements
        const gameScreen = document.getElementById('gameScreen');
        const actionPanel = document.getElementById('actionPanel');
        const actionTitle = document.getElementById('actionTitle');
        const actionChoices = document.getElementById('actionChoices');
        const codeInput = document.getElementById('codeInput');
        const codeDisplay = document.getElementById('codeDisplay');
        const inventoryPanel = document.getElementById('inventoryPanel');
        const inventoryItems = document.getElementById('inventoryItems');
        const healthValue = document.getElementById('healthValue');
        const scoreValue = document.getElementById('scoreValue');
        const goldValue = document.getElementById('goldValue');
        const locationValue = document.getElementById('locationValue');
        const levelTitle = document.getElementById('levelTitle');
        
        // Current code input
        let currentCode = "";
        
        // Auto-scroll functionality
        let autoScrollEnabled = true;
        let userScrolledUp = false;
        
        // Setup scroll tracking
        gameScreen.addEventListener('scroll', function() {
            // Check if user is scrolled to bottom (within 50px)
            const isAtBottom = gameScreen.scrollHeight - gameScreen.clientHeight - gameScreen.scrollTop <= 50;
            userScrolledUp = !isAtBottom;
        });
        
        // Initialize the game
        function initGame() {
            // Load saved state if available
            if (localStorage.getItem('castleUndeadGameState')) {
                try {
                    const savedState = JSON.parse(localStorage.getItem('castleUndeadGameState'));
                    // Merge saved state with our default state
                    Object.assign(gameState, savedState);
                    // Ensure we're in the right location for level 3
                    gameState.currentLocation = "castleInterior";
                    addToOutput("Game progress loaded successfully!", "success-text");
                    addToOutput(`Welcome back! You have ${gameState.score} points and ${gameState.gold} gold.`, "important-text");
                } catch (e) {
                    console.error("Error loading saved game:", e);
                    addToOutput("Error loading saved game. Starting fresh.", "danger-text");
                }
            } else {
                addToOutput("No saved game found. Starting new level.", "important-text");
            }
            
            updateStatus();
            addToOutput("Touch commands to play. Goal: Find the source of the castle's curse.", "important-text");
            addToOutput("Tip: The ghost might know secrets about this place.", "ghost-text");
            setupKeypad();
            setupEventListeners();
            
            // Show any special items from previous levels
            if (gameState.inventory.includes("cursed dagger")) {
                addToOutput("The cursed dagger pulses with dark energy as you enter the castle...", "danger-text");
            }
            if (gameState.inventory.includes("lucky charm")) {
                addToOutput("Your lucky charm feels cold to the touch...", "important-text");
            }
        }
        
        // Set up event listeners for buttons
        function setupEventListeners() {
            console.log("Setting up event listeners...");
            
            // Command buttons
            document.getElementById('lookBtn').addEventListener('click', handleLook);
            document.getElementById('interactBtn').addEventListener('click', handleInteract);
            document.getElementById('inventoryBtn').addEventListener('click', handleInventory);
            document.getElementById('talkBtn').addEventListener('click', handleTalk);
            document.getElementById('useBtn').addEventListener('click', handleUseItem);
            document.getElementById('moveBtn').addEventListener('click', handleMove);
            document.getElementById('examineBtn').addEventListener('click', handleExamine);
            document.getElementById('helpBtn').addEventListener('click', handleHelp);
            
            // Code input buttons
            document.getElementById('enterCodeBtn').addEventListener('click', checkCode);
            document.getElementById('clearCodeBtn').addEventListener('click', clearCode);
            document.getElementById('cancelCodeBtn').addEventListener('click', hideCodeInput);
            
            console.log("Event listeners set up successfully");
        }
        
        // Set up the keypad for code entry
        function setupKeypad() {
            const keypad = document.querySelector('.keypad');
            keypad.innerHTML = '';
            
            // Create buttons 1-9
            for (let i = 1; i <= 9; i++) {
                const button = document.createElement('button');
                button.className = 'button keypad-button';
                button.textContent = i;
                button.addEventListener('click', () => addToCode(i.toString()));
                keypad.appendChild(button);
            }
            
            // Add 0 button at the end
            const zeroButton = document.createElement('button');
            zeroButton.className = 'button keypad-button';
            zeroButton.textContent = '0';
            zeroButton.addEventListener('click', () => addToCode('0'));
            keypad.appendChild(zeroButton);
        }
        
        // Add text to the game screen with auto-scroll
        function addToOutput(text, className = "") {
            const newLine = document.createElement("div");
            newLine.className = `output-text ${className}`;
            newLine.textContent = text;
            gameScreen.appendChild(newLine);
            
            // Auto-scroll if enabled and user hasn't manually scrolled up
            if (!userScrolledUp) {
                gameScreen.scrollTop = gameScreen.scrollHeight;
            }
        }
        
        // Add conversation to log
        function addConversation(speaker, text, npcType = "ghost") {
            let speakerName, speakerClass;
            
            switch(speaker) {
                case "player":
                    speakerName = "You";
                    speakerClass = "player-text";
                    break;
                case "ghost":
                    speakerName = "Ghostly Apparition";
                    speakerClass = "ghost-text";
                    break;
                case "lich":
                    speakerName = "Lich King";
                    speakerClass = "lich-text";
                    break;
                case "guard":
                    speakerName = "Skeleton Guard";
                    speakerClass = "npc-text";
                    break;
                case "merchant":
                    speakerName = "Merchant";
                    speakerClass = "merchant-text";
                    break;
                case "skeleton":
                    speakerName = "Hooded Skeleton";
                    speakerClass = "skeleton-text";
                    break;
                default:
                    speakerName = speaker;
                    speakerClass = "npc-text";
            }
            
            addToOutput(`${speakerName}: ${text}`, speakerClass);
            
            // Add to conversation history
            gameState.conversationHistory.push({speaker, text});
        }
        
        // Update status display
        function updateStatus() {
            healthValue.textContent = gameState.health;
            scoreValue.textContent = gameState.score;
            goldValue.textContent = gameState.gold;
            
            // Update location display
            if (gameState.currentLocation === "castleInterior") {
                locationValue.textContent = "CASTLE INTERIOR";
                levelTitle.textContent = "TEXT ADVENTURE - CASTLE INTERIOR";
            } else if (gameState.currentLocation === "library") {
                locationValue.textContent = "LIBRARY";
                levelTitle.textContent = "TEXT ADVENTURE - LIBRARY";
            } else if (gameState.currentLocation === "diningHall") {
                locationValue.textContent = "DINING HALL";
                levelTitle.textContent = "TEXT ADVENTURE - DINING HALL";
            } else if (gameState.currentLocation === "throneRoom") {
                locationValue.textContent = "THRONE ROOM";
                levelTitle.textContent = "TEXT ADVENTURE - THRONE ROOM";
            }
        }
        
        // Show action panel with choices
        function showActionPanel(title, choices, callback) {
            actionTitle.textContent = title;
            actionChoices.innerHTML = '';
            
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'button';
                button.textContent = choice.text;
                button.addEventListener('click', () => {
                    hideActionPanel();
                    callback(choice.value, choice.text);
                });
                actionChoices.appendChild(button);
            });
            
            actionPanel.style.display = 'block';
        }
        
        // Hide action panel
        function hideActionPanel() {
            actionPanel.style.display = 'none';
        }
        
        // Show code input interface
        function showCodeInput() {
            codeInput.style.display = 'flex';
            currentCode = "";
            updateCodeDisplay();
        }
        
        // Hide code input interface
        function hideCodeInput() {
            codeInput.style.display = 'none';
        }
        
        // Add digit to code
        function addToCode(digit) {
            if (currentCode.length < 4) {
                currentCode += digit;
                updateCodeDisplay();
            }
        }
        
        // Update code display
        function updateCodeDisplay() {
            let display = currentCode;
            for (let i = currentCode.length; i < 4; i++) {
                display += "_";
            }
            codeDisplay.textContent = display;
        }
        
        // Clear code input
        function clearCode() {
            currentCode = "";
            updateCodeDisplay();
        }
        
        // Check entered code (for library puzzle)
        function checkCode() {
            if (gameState.currentLocation === "library" && currentCode === "7321") {
                addToOutput("You hear a clicking sound from the bookshelf. A hidden compartment opens!", "success-text");
                addToOutput("Inside, you find a GHOSTLY KEY and a CRYSTAL SHARD!", "success-text");
                gameState.inventory.push("ghostly key");
                gameState.inventory.push("crystal shard");
                gameState.hasGhostlyKey = true;
                gameState.hasCrystalShard = true;
                gameState.libraryPuzzleSolved = true;
                gameState.score += 75;
                updateInventory();
                updateStatus();
                hideCodeInput();
            } else if (gameState.currentLocation === "library") {
                addToOutput("Nothing happens. The mechanism remains locked.", "danger-text");
                gameState.health -= 5;
                updateStatus();
            } else {
                addToOutput("The code pad doesn't respond here.", "important-text");
            }
        }
        
        // Update inventory display
        function updateInventory() {
            inventoryItems.innerHTML = "";
            
            if (gameState.inventory.length === 0) {
                const emptyItem = document.createElement("div");
                emptyItem.className = "inventory-item";
                emptyItem.textContent = "Empty";
                inventoryItems.appendChild(emptyItem);
            } else {
                gameState.inventory.forEach(item => {
                    const itemElement = document.createElement("div");
                    itemElement.className = "inventory-item";
                    itemElement.textContent = item.toUpperCase();
                    inventoryItems.appendChild(itemElement);
                });
            }
        }
        
        // Look command
        function handleLook() {
            console.log("LOOK button clicked");
            if (gameState.currentLocation === "castleInterior") {
                addToOutput("You stand in the grand entry hall of the castle. Dust covers everything. A ghostly apparition floats in the center of the room. To your left, a doorway leads to a library. To your right, an archway leads to a dining hall. A sweeping staircase ahead leads to an upper level, but it's blocked by a spectral barrier.");
                
                if (gameState.ghostPuzzleSolved) {
                    addToOutput("The spectral barrier on the staircase has dissipated!", "success-text");
                }
            } else if (gameState.currentLocation === "library") {
                addToOutput("The library is filled with ancient, dusty tomes. Shelves line the walls, some collapsed. A large stone fireplace dominates one wall. On a central table, you see an open book with strange symbols. A small numeric keypad is embedded in one of the bookshelves.");
                
                if (!gameState.libraryExamined) {
                    addToOutput("You notice some books seem to glow with faint magical energy.", "important-text");
                    gameState.libraryExamined = true;
                }
            } else if (gameState.currentLocation === "diningHall") {
                addToOutput("A massive dining hall with a long table that could seat fifty. The table is set with tarnished silver and cracked plates. At the head of the table sits a spectral figure, unmoving. Tapestries on the walls depict ancient battles. One tapestry looks newer than the others.");
                
                if (!gameState.diningHallExamined) {
                    addToOutput("You notice something glinting under the head chair.", "important-text");
                    gameState.diningHallExamined = true;
                }
            } else if (gameState.currentLocation === "throneRoom") {
                addToOutput("The throne room is vast and cold. At the far end sits an empty throne made of bone and obsidian. The air crackles with dark energy. Shadows seem to move on their own. This is clearly the source of the castle's curse.");
                
                if (gameState.lichEncountered) {
                    addToOutput("The Lich King's shattered remains lie before the throne.", "danger-text");
                }
            }
        }
        
        // Interact command
        function handleInteract() {
            console.log("INTERACT button clicked");
            if (gameState.currentLocation === "castleInterior") {
                showActionPanel("INTERACT WITH:", [
                    {text: "GHOSTLY APPARITION", value: "ghost"},
                    {text: "MAIN STAIRCASE", value: "staircase"},
                    {text: "TATTERED BANNERS", value: "banners"},
                    {text: "DUSTY TAPESTRIES", value: "tapestries"},
                    {text: "SEARCH ENTRY HALL", value: "search"}
                ], handleInteriorInteractChoice);
            } else if (gameState.currentLocation === "library") {
                showActionPanel("INTERACT WITH:", [
                    {text: "ANCIENT TOMES", value: "tomes"},
                    {text: "STONE FIREPLACE", value: "fireplace"},
                    {text: "OPEN BOOK ON TABLE", value: "book"},
                    {text: "NUMERIC KEYPAD", value: "keypad"},
                    {text: "SEARCH LIBRARY", value: "search"}
                ], handleLibraryInteractChoice);
            } else if (gameState.currentLocation === "diningHall") {
                showActionPanel("INTERACT WITH:", [
                    {text: "SPECTRAL FIGURE", value: "spectral_figure"},
                    {text: "DINING TABLE", value: "table"},
                    {text: "TAPESTRIES", value: "tapestries"},
                    {text: "HEAD CHAIR", value: "head_chair"},
                    {text: "SEARCH DINING HALL", value: "search"}
                ], handleDiningHallInteractChoice);
            } else if (gameState.currentLocation === "throneRoom") {
                showActionPanel("INTERACT WITH:", [
                    {text: "OBSIDIAN THRONE", value: "throne"},
                    {text: "ANCIENT BRAZIER", value: "brazier"},
                    {text: "SHADOWS", value: "shadows"},
                    {text: "SEARCH THRONE ROOM", value: "search"},
                    {text: "APPROACH THRONE", value: "approach_throne"}
                ], handleThroneRoomInteractChoice);
            }
        }
        
        // Handle interior interact choice
        function handleInteriorInteractChoice(choice) {
            switch(choice) {
                case "ghost":
                    if (!gameState.ghostSpoken) {
                        addToOutput("The ghost turns toward you, its form shimmering. It seems to be waiting for you to speak.", "ghost-text");
                    } else {
                        addToOutput("The ghost watches you intently.", "ghost-text");
                    }
                    break;
                    
                case "staircase":
                    if (!gameState.ghostPuzzleSolved) {
                        addToOutput("A shimmering spectral barrier blocks the staircase. It pulses with ghostly energy.", "ghost-text");
                        addToOutput("You'll need to find a way to dispel this barrier.", "important-text");
                    } else {
                        addToOutput("The staircase is now clear. You can ascend to the throne room.", "success-text");
                    }
                    break;
                    
                case "banners":
                    addToOutput("You examine the tattered banners. They depict the crest of the castle's former lords - a skull with a crown. One banner is less dusty than the others.");
                    if (!gameState.hasAncientTome) {
                        const findChance = Math.random();
                        if (findChance > 0.6) {
                            addToOutput("Behind the cleaner banner, you find a hidden ANCIENT TOME!", "success-text");
                            gameState.inventory.push("ancient tome");
                            gameState.hasAncientTome = true;
                            gameState.score += 30;
                            updateInventory();
                            updateStatus();
                        } else {
                            addToOutput("You find nothing of value behind the banners.");
                        }
                    } else {
                        addToOutput("You've already searched the banners.");
                    }
                    break;
                    
                case "tapestries":
                    addToOutput("The tapestries depict scenes of the castle's glory days. One shows the lord receiving guests, another shows a great feast. The stitching is incredibly detailed.");
                    break;
                    
                case "search":
                    addToOutput("You search the entry hall thoroughly.", "important-text");
                    const searchChance = Math.random();
                    if (searchChance > 0.7 && gameState.gold < 50) {
                        const foundGold = Math.floor(Math.random() * 30) + 10;
                        gameState.gold += foundGold;
                        addToOutput(`You find ${foundGold} gold coins hidden in a crack in the floor!`, "gold-text");
                        gameState.score += 15;
                        updateStatus();
                    } else {
                        addToOutput("You find nothing but dust and decay.");
                    }
                    break;
            }
        }
        
        // Handle library interact choice
        function handleLibraryInteractChoice(choice) {
            switch(choice) {
                case "tomes":
                    addToOutput("You browse the ancient tomes. Most are written in languages you don't understand. One book titled 'Chronicles of the Undead' seems familiar.");
                    if (gameState.hasAncientTome) {
                        addToOutput("Your ancient tome would be right at home here.", "important-text");
                    }
                    break;
                    
                case "fireplace":
                    addToOutput("The stone fireplace is cold and filled with ashes. Carved into the mantle are the words: 'Knowledge is the key to all doors.'");
                    break;
                    
                case "book":
                    addToOutput("The open book on the table shows a diagram of the castle. A note in the margin reads: 'The code is the year the curse began: 7321.'", "important-text");
                    if (!gameState.libraryPuzzleSolved) {
                        addToOutput("This might be the code for the keypad on the bookshelf.", "success-text");
                    }
                    break;
                    
                case "keypad":
                    if (!gameState.libraryPuzzleSolved) {
                        addToOutput("A numeric keypad is embedded in the bookshelf. It has four digits.", "important-text");
                        showCodeInput();
                    } else {
                        addToOutput("The keypad is now inactive. The hidden compartment is open.");
                    }
                    break;
                    
                case "search":
                    addToOutput("You search through the library...", "important-text");
                    if (!gameState.hasAncientTome) {
                        const findChance = Math.random();
                        if (findChance > 0.5) {
                            addToOutput("You find an ANCIENT TOME hidden behind some other books!", "success-text");
                            gameState.inventory.push("ancient tome");
                            gameState.hasAncientTome = true;
                            gameState.score += 30;
                            updateInventory();
                            updateStatus();
                        } else {
                            addToOutput("You find only dust and cobwebs.");
                        }
                    } else {
                        addToOutput("You've already thoroughly searched the library.");
                    }
                    break;
            }
        }
        
        // Handle dining hall interact choice
        function handleDiningHallInteractChoice(choice) {
            switch(choice) {
                case "spectral_figure":
                    addToOutput("The spectral figure at the head of the table doesn't move. It seems trapped in eternal contemplation.", "ghost-text");
                    if (gameState.hasCrystalShard) {
                        addToOutput("Your crystal shard glows when you approach the figure.", "important-text");
                    }
                    break;
                    
                case "table":
                    addToOutput("You examine the dining table. The silverware is tarnished, the plates are cracked. One plate has a peculiar symbol etched into it.");
                    if (!gameState.diningHallSecretFound) {
                        const findChance = Math.random();
                        if (findChance > 0.6) {
                            addToOutput("Under one of the plates, you find a small SILVER AMULET!", "success-text");
                            gameState.inventory.push("silver amulet");
                            gameState.diningHallSecretFound = true;
                            gameState.score += 40;
                            updateInventory();
                            updateStatus();
                        }
                    }
                    break;
                    
                case "tapestries":
                    addToOutput("You examine the tapestries. One depicts a great battle against skeletal warriors. Another shows the castle lord performing a dark ritual.");
                    if (gameState.hasAncientTome) {
                        addToOutput("The ritual in the tapestry matches a diagram in your ancient tome.", "important-text");
                    }
                    break;
                    
                case "head_chair":
                    addToOutput("You examine the chair at the head of the table. It's ornately carved with skull motifs.");
                    if (gameState.diningHallExamined && !gameState.diningHallSecretFound) {
                        addToOutput("You find a SILVER AMULET tucked into the cushion!", "success-text");
                        gameState.inventory.push("silver amulet");
                        gameState.diningHallSecretFound = true;
                        gameState.score += 40;
                        updateInventory();
                        updateStatus();
                    }
                    break;
                    
                case "search":
                    addToOutput("You search the dining hall...", "important-text");
                    const searchChance = Math.random();
                    if (searchChance > 0.7) {
                        const foundGold = Math.floor(Math.random() * 40) + 20;
                        gameState.gold += foundGold;
                        addToOutput(`You find ${foundGold} gold coins in a hidden drawer!`, "gold-text");
                        gameState.score += 20;
                        updateStatus();
                    } else {
                        addToOutput("You find nothing but dust and memories.");
                    }
                    break;
            }
        }
        
        // Handle throne room interact choice
        function handleThroneRoomInteractChoice(choice) {
            switch(choice) {
                case "throne":
                    if (!gameState.lichEncountered) {
                        addToOutput("As you approach the throne, the shadows coalesce into a towering figure - the LICH KING!", "lich-text");
                        addToOutput("'FOOL! You dare enter my domain!' the Lich King booms.", "lich-text");
                        gameState.lichEncountered = true;
                        
                        setTimeout(() => {
                            showActionPanel("FACE THE LICH KING:", [
                                {text: "FIGHT", value: "fight"},
                                {text: "NEGOTIATE", value: "negotiate"},
                                {text: "USE CRYSTAL SHARD", value: "use_crystal"},
                                {text: "USE SILVER AMULET", value: "use_amulet"},
                                {text: "FLEE", value: "flee"}
                            ], handleLichEncounter);
                        }, 1000);
                    } else {
                        addToOutput("The obsidian throne sits empty. The Lich King has been defeated.", "success-text");
                    }
                    break;
                    
                case "brazier":
                    addToOutput("The ancient brazier contains cold, black ashes. They seem to absorb light rather than reflect it.");
                    break;
                    
                case "shadows":
                    addToOutput("The shadows seem to writhe and move. They whisper unintelligible words that chill you to the bone.");
                    gameState.health -= 5;
                    updateStatus();
                    addToOutput("The shadows drain your vitality!", "danger-text");
                    break;
                    
                case "search":
                    if (!gameState.lichEncountered) {
                        addToOutput("Searching the throne room seems dangerous with the dark energy present.", "danger-text");
                    } else {
                        addToOutput("You search the throne room after defeating the Lich King.", "important-text");
                        const foundGold = Math.floor(Math.random() * 100) + 50;
                        gameState.gold += foundGold;
                        addToOutput(`You find ${foundGold} gold coins in the Lich King's treasure chest!`, "gold-text");
                        gameState.score += 100;
                        updateStatus();
                    }
                    break;
                    
                case "approach_throne":
                    if (!gameState.lichEncountered) {
                        addToOutput("You cautiously approach the throne...", "important-text");
                        setTimeout(() => {
                            addToOutput("The LICH KING materializes before you!", "lich-text");
                            gameState.lichEncountered = true;
                            
                            setTimeout(() => {
                                showActionPanel("FACE THE LICH KING:", [
                                    {text: "FIGHT", value: "fight"},
                                    {text: "NEGOTIATE", value: "negotiate"},
                                    {text: "USE CRYSTAL SHARD", value: "use_crystal"},
                                    {text: "USE SILVER AMULET", value: "use_amulet"},
                                    {text: "FLEE", value: "flee"}
                                ], handleLichEncounter);
                            }, 500);
                        }, 500);
                    }
                    break;
            }
        }
        
        // Handle Lich King encounter
        function handleLichEncounter(choice) {
            switch(choice) {
                case "fight":
                    if (gameState.inventory.includes("rusty sword") || gameState.inventory.includes("cursed dagger")) {
                        addConversation("player", "I'll fight you!");
                        addConversation("lich", "FOOLISH MORTAL! Your weapons are useless against my power!");
                        addToOutput("You attack the Lich King, but your weapon passes through him harmlessly!", "danger-text");
                        gameState.health -= 30;
                        updateStatus();
                        addToOutput("The Lich King counterattacks with dark magic!", "danger-text");
                        
                        if (gameState.health <= 0) {
                            addToOutput("You have been defeated! GAME OVER.", "danger-text");
                            document.querySelectorAll('.button, .command-button').forEach(btn => btn.disabled = true);
                        }
                    } else {
                        addConversation("player", "I'll fight you!");
                        addConversation("lich", "WITH BARE HANDS? YOU AMUSE ME!");
                        addToOutput("You have no effective weapons! The Lich King laughs at your attempt.", "danger-text");
                        gameState.health -= 50;
                        updateStatus();
                        
                        if (gameState.health <= 0) {
                            addToOutput("You have been defeated! GAME OVER.", "danger-text");
                            document.querySelectorAll('.button, .command-button').forEach(btn => btn.disabled = true);
                        }
                    }
                    break;
                    
                case "negotiate":
                    addConversation("player", "Perhaps we can reach an agreement...");
                    addConversation("lich", "WHAT COULD YOU POSSIBLY OFFER ME? I HAVE ETERNAL LIFE AND POWER!");
                    
                    setTimeout(() => {
                        showActionPanel("OFFER:", [
                            {text: "Offer gold", value: "offer_gold"},
                            {text: "Offer to serve", value: "offer_serve"},
                            {text: "Ask for mercy", value: "ask_mercy"}
                        ], handleLichNegotiation);
                    }, 500);
                    break;
                    
                case "use_crystal":
                    if (gameState.inventory.includes("crystal shard")) {
                        addConversation("player", "Behold the power of this crystal!");
                        addConversation("lich", "WHAT? THAT CRYSTAL... IT HOLDS PURIFYING ENERGY! NO!");
                        addToOutput("The crystal shard glows with intense white light!", "success-text");
                        addToOutput("The Lich King screams as the light washes over him!", "success-text");
                        addToOutput("The dark energy in the room dissipates!", "success-text");
                        addToOutput("YOU HAVE DEFEATED THE LICH KING!", "success-text");
                        
                        // Remove crystal from inventory
                        const crystalIndex = gameState.inventory.indexOf("crystal shard");
                        if (crystalIndex > -1) {
                            gameState.inventory.splice(crystalIndex, 1);
                        }
                        
                        gameState.score += 500;
                        gameState.gold += 200;
                        updateInventory();
                        updateStatus();
                        
                        addToOutput("The curse on the castle has been broken! LEVEL 3 COMPLETE!", "success-text");
                        addToOutput("More adventures await in future updates...", "important-text");
                    } else {
                        addConversation("player", "I have a crystal shard... oh wait, no I don't.");
                        addConversation("lich", "TRYING TO TRICK ME? YOU WILL SUFFER!");
                        gameState.health -= 20;
                        updateStatus();
                    }
                    break;
                    
                case "use_amulet":
                    if (gameState.inventory.includes("silver amulet")) {
                        addConversation("player", "This amulet will stop you!");
                        addConversation("lich", "A SILVER AMULET? IT BURNS! BUT IT IS NOT ENOUGH!");
                        addToOutput("The silver amulet glows, causing the Lich King to recoil!", "success-text");
                        addToOutput("However, he recovers quickly and attacks!", "danger-text");
                        gameState.health -= 15;
                        updateStatus();
                        
                        // Amulet is consumed
                        const amuletIndex = gameState.inventory.indexOf("silver amulet");
                        if (amuletIndex > -1) {
                            gameState.inventory.splice(amuletIndex, 1);
                        }
                        updateInventory();
                    } else {
                        addConversation("player", "I have a protective amulet... actually, no I don't.");
                        addConversation("lich", "YOUR DECEPTION ANNOYS ME!");
                        gameState.health -= 25;
                        updateStatus();
                    }
                    break;
                    
                case "flee":
                    addConversation("player", "I need to get out of here!");
                    addConversation("lich", "RUN, LITTLE MORTAL! YOU CANNOT ESCAPE MY DOMAIN!");
                    addToOutput("You flee back to the castle interior!", "important-text");
                    gameState.currentLocation = "castleInterior";
                    updateStatus();
                    break;
            }
        }
        
        // Handle Lich negotiation
        function handleLichNegotiation(choice) {
            switch(choice) {
                case "offer_gold":
                    if (gameState.gold >= 100) {
                        addConversation("player", "I can offer you gold...");
                        addConversation("lich", "GOLD? I HAVE NO NEED FOR MORTAL TRINKETS! BUT... I WILL TAKE IT AND STILL DESTROY YOU!");
                        gameState.gold = 0;
                        addToOutput("The Lich King takes all your gold and attacks anyway!", "danger-text");
                        gameState.health -= 40;
                        updateStatus();
                    } else {
                        addConversation("lich", "YOU HAVE PITIFULLY LITTLE GOLD! YOU INSULT ME!");
                        gameState.health -= 30;
                        updateStatus();
                    }
                    break;
                    
                case "offer_serve":
                    addConversation("player", "I could serve you...");
                    addConversation("lich", "ANOTHER MINION? VERY WELL... BUT YOU MUST PROVE YOUR LOYALTY BY SACRIFICING YOUR HEALTH!");
                    addToOutput("The Lich King drains your life force as a 'test of loyalty'!", "danger-text");
                    gameState.health -= 60;
                    updateStatus();
                    
                    if (gameState.health <= 0) {
                        addToOutput("You have been drained completely! GAME OVER.", "danger-text");
                        document.querySelectorAll('.button, .command-button').forEach(btn => btn.disabled = true);
                    } else {
                        addToOutput("The Lich King accepts you as a minion. You are now undead.", "important-text");
                        addToOutput("You 'win' but at what cost? GAME COMPLETE (Bad Ending).", "danger-text");
                    }
                    break;
                    
                case "ask_mercy":
                    addConversation("player", "Please, show mercy...");
                    addConversation("lich", "MERCY? I KNOW NOT OF SUCH THINGS! DIE!");
                    gameState.health -= 50;
                    updateStatus();
                    
                    if (gameState.health <= 0) {
                        addToOutput("You have been destroyed! GAME OVER.", "danger-text");
                        document.querySelectorAll('.button, .command-button').forEach(btn => btn.disabled = true);
                    }
                    break;
            }
        }
        
        // Inventory command
        function handleInventory() {
            console.log("INVENTORY button clicked");
            if (inventoryPanel.style.display === "block") {
                inventoryPanel.style.display = "none";
            } else {
                inventoryPanel.style.display = "block";
                updateInventory();
            }
        }
        
        // Talk command
        function handleTalk() {
            console.log("TALK button clicked");
            if (gameState.currentLocation === "castleInterior") {
                handleGhostTalk();
            } else if (gameState.currentLocation === "library") {
                addToOutput("There's no one to talk to in the library.", "important-text");
            } else if (gameState.currentLocation === "diningHall") {
                showActionPanel("TALK TO:", [
                    {text: "SPECTRAL FIGURE", value: "spectral_figure"},
                    {text: "TO THE ROOM", value: "room"}
                ], handleDiningHallTalkChoice);
            } else if (gameState.currentLocation === "throneRoom") {
                if (gameState.lichEncountered) {
                    addConversation("lich", "WHAT MORE DO YOU WANT, MORTAL? PREPARE TO DIE!");
                } else {
                    addToOutput("The throne room is silent, but you feel a malevolent presence watching you.", "danger-text");
                }
            }
        }
        
        // Handle dining hall talk choice
        function handleDiningHallTalkChoice(choice) {
            if (choice === "spectral_figure") {
                addConversation("player", "Hello? Can you hear me?");
                addToOutput("The spectral figure slowly turns its head toward you.", "ghost-text");
                addConversation("ghost", "...The master... must be stopped... the crystal...");
                addToOutput("The figure fades away before saying more.", "ghost-text");
            } else if (choice === "room") {
                addConversation("player", "Is anyone here?");
                addToOutput("Only echoes answer you.", "important-text");
            }
        }
        
        // Handle ghost talk
        function handleGhostTalk() {
            if (!gameState.ghostSpoken) {
                addConversation("ghost", "Living one... you should not be here. The castle is cursed.");
                gameState.ghostSpoken = true;
                
                setTimeout(() => {
                    showActionPanel("RESPOND TO GHOST:", [
                        {text: "Who are you?", value: "who_are_you"},
                        {text: "How do I break the curse?", value: "break_curse"},
                        {text: "What is blocking the staircase?", value: "staircase_block"},
                        {text: "I mean no harm", value: "no_harm"}
                    ], handleGhostResponse);
                }, 500);
            } else {
                showActionPanel("TALK TO GHOST:", [
                    {text: "Tell me about the curse", value: "about_curse"},
                    {text: "How do I reach the throne room?", value: "reach_throne"},
                    {text: "What should I look for?", value: "what_look_for"},
                    {text: "Farewell", value: "goodbye"}
                ], handleGhostResponse);
            }
        }
        
        // Handle ghost responses
        function handleGhostResponse(choice, choiceText) {
            addConversation("player", choiceText, "ghost");
            
            switch(choice) {
                case "who_are_you":
                    addConversation("ghost", "I was once the castle steward, Alaric. When the curse fell, I was trapped here, unable to move on. The Lich King in the throne room holds my spirit bound.");
                    break;
                    
                case "break_curse":
                    addConversation("ghost", "The curse originates from the Lich King on the throne. To break it, you must defeat him. But you will need a purifying crystal from the library.");
                    if (!gameState.ghostPuzzleSolved) {
                        addConversation("ghost", "First, you must help me. Answer my riddle to dispel the barrier on the staircase.");
                        
                        setTimeout(() => {
                            showActionPanel("ANSWER THE RIDDLE:", [
                                {text: "I speak without a mouth and hear without ears. What am I?", value: "riddle_question"}
                            ], () => {
                                showActionPanel("ANSWER:", [
                                    {text: "ECHO", value: "echo"},
                                    {text: "WIND", value: "wind"},
                                    {text: "GHOST", value: "ghost"},
                                    {text: "BOOK", value: "book"}
                                ], handleGhostRiddle);
                            });
                        }, 500);
                    }
                    break;
                    
                case "staircase_block":
                    addConversation("ghost", "A spectral barrier protects the staircase. It responds to knowledge. Answer my riddle correctly, and I will lower it for you.");
                    
                    setTimeout(() => {
                        showActionPanel("ANSWER THE RIDDLE:", [
                            {text: "I speak without a mouth and hear without ears. What am I?", value: "riddle_question"}
                        ], () => {
                            showActionPanel("ANSWER:", [
                                {text: "ECHO", value: "echo"},
                                {text: "WIND", value: "wind"},
                                {text: "GHOST", value: "ghost"},
                                {text: "BOOK", value: "book"}
                            ], handleGhostRiddle);
                        });
                    }, 500);
                    break;
                    
                case "no_harm":
                    addConversation("ghost", "Your intentions matter not. The castle consumes all who enter. But perhaps... you are different.");
                    gameState.ghostPuzzleSolved = true;
                    addToOutput("The ghost seems to trust you. The spectral barrier on the staircase dissipates!", "success-text");
                    gameState.score += 50;
                    updateStatus();
                    break;
                    
                case "about_curse":
                    addConversation("ghost", "The lord sought immortality through dark magic. He succeeded, but at the cost of his humanity and all who lived here. Now he is the Lich King, and we are all trapped.");
                    break;
                    
                case "reach_throne":
                    if (!gameState.ghostPuzzleSolved) {
                        addConversation("ghost", "First, answer my riddle to prove your wisdom.");
                        setTimeout(() => {
                            showActionPanel("ANSWER THE RIDDLE:", [
                                {text: "I speak without a mouth and hear without ears. What am I?", value: "riddle_question"}
                            ], () => {
                                showActionPanel("ANSWER:", [
                                    {text: "ECHO", value: "echo"},
                                    {text: "WIND", value: "wind"},
                                    {text: "GHOST", value: "ghost"},
                                    {text: "BOOK", value: "book"}
                                ], handleGhostRiddle);
                            });
                        }, 500);
                    } else {
                        addConversation("ghost", "The staircase is now clear. But be warned: the Lich King is powerful. You will need the crystal shard from the library to defeat him.");
                    }
                    break;
                    
                case "what_look_for":
                    addConversation("ghost", "Search the library for a crystal shard. It holds purifying energy. Also, look for an ancient tome - it may contain useful knowledge.");
                    break;
                    
                case "goodbye":
                    addConversation("ghost", "Farewell, living one. May fortune favor you.");
                    break;
            }
        }
        
        // Handle ghost riddle
        function handleGhostRiddle(answer, answerText) {
            addConversation("player", answerText, "ghost");
            
            if (answer === "echo") {
                addConversation("ghost", "Correct! An echo speaks without a mouth and hears without ears. You have proven your wisdom.");
                addToOutput("The ghost nods approvingly. The spectral barrier on the staircase dissipates!", "success-text");
                gameState.ghostPuzzleSolved = true;
                gameState.score += 50;
                updateStatus();
            } else {
                addConversation("ghost", "Incorrect. Perhaps you need to think more deeply.");
                addToOutput("The spectral barrier remains.", "ghost-text");
            }
        }
        
        // Use item command
        function handleUseItem() {
            console.log("USE ITEM button clicked");
            if (gameState.inventory.length === 0) {
                addToOutput("Your inventory is empty. There's nothing to use.");
                return;
            }
            
            const choices = gameState.inventory.map((item, index) => ({
                text: item.toUpperCase(),
                value: item
            }));
            
            showActionPanel("USE WHICH ITEM?", choices, handleUseItemChoice);
        }
        
        // Handle use item choice
        function handleUseItemChoice(item) {
            addToOutput(`You try to use the ${item.toUpperCase()}.`, "important-text");
            
            switch(item) {
                case "healing potion":
                    if (gameState.health < 100) {
                        gameState.health = Math.min(100, gameState.health + 50);
                        addToOutput("You drink the healing potion and feel revitalized! (+50 health)", "success-text");
                        // Remove from inventory
                        const potionIndex = gameState.inventory.indexOf("healing potion");
                        if (potionIndex > -1) {
                            gameState.inventory.splice(potionIndex, 1);
                        }
                        updateInventory();
                        updateStatus();
                    } else {
                        addToOutput("You're already at full health. Save the potion for later.");
                    }
                    break;
                    
                case "rusty sword":
                    addToOutput("You swing the rusty sword through the air. It feels unbalanced but serviceable.");
                    if (gameState.currentLocation === "throneRoom" && gameState.lichEncountered) {
                        addToOutput("The sword seems inadequate against a spectral foe like the Lich King.", "danger-text");
                    }
                    break;
                    
                case "cursed dagger":
                    addToOutput("The cursed dagger pulses with dark energy. Using it makes you feel weaker.", "danger-text");
                    gameState.health -= 5;
                    updateStatus();
                    if (gameState.currentLocation === "throneRoom" && gameState.lichEncountered) {
                        addToOutput("The Lich King laughs. 'A CURSED DAGGER? I CREATED THAT CURSE!'", "lich-text");
                    }
                    break;
                    
                case "lucky charm":
                    addToOutput("You rub the lucky charm. Nothing happens. Maybe it needs time to work?", "important-text");
                    break;
                    
                case "ancient tome":
                    addToOutput("You read from the ancient tome. It contains knowledge of the castle's history and the curse.");
                    if (!gameState.libraryPuzzleSolved) {
                        addToOutput("The book mentions: 'The year of the curse was 7321.' This might be useful.", "success-text");
                    }
                    if (gameState.currentLocation === "throneRoom") {
                        addToOutput("The tome contains a passage about defeating liches with purifying crystals.", "important-text");
                    }
                    break;
                    
                case "crystal shard":
                    if (gameState.currentLocation === "throneRoom" && gameState.lichEncountered) {
                        addToOutput("You wield the crystal shard against the Lich King!", "success-text");
                        handleLichEncounter("use_crystal");
                    } else if (gameState.currentLocation === "diningHall") {
                        addToOutput("The crystal shard glows near the spectral figure.", "important-text");
                        addToOutput("The figure becomes more substantial and whispers: 'Use it... against... the master...'", "ghost-text");
                    } else {
                        addToOutput("The crystal shard glows with a soft, purifying light. It feels warm in your hand.");
                    }
                    break;
                    
                case "silver amulet":
                    addToOutput("The silver amulet feels cool against your skin. It offers some protection against dark energies.");
                    gameState.health += 10;
                    if (gameState.health > 100) gameState.health = 100;
                    updateStatus();
                    break;
                    
                case "ghostly key":
                    if (gameState.currentLocation === "castleInterior" && gameState.ghostPuzzleSolved) {
                        addToOutput("The ghostly key doesn't seem to fit anything here.", "important-text");
                    } else {
                        addToOutput("The ghostly key shimmers with ethereal energy. It might unlock something spectral.");
                    }
                    break;
                    
                default:
                    addToOutput("Nothing happens.");
                    break;
            }
        }
        
        // Move command
        function handleMove() {
            console.log("MOVE button clicked");
            if (gameState.currentLocation === "castleInterior") {
                showActionPanel("MOVE WHERE?", [
                    {text: "ENTER LIBRARY", value: "library"},
                    {text: "ENTER DINING HALL", value: "diningHall"},
                    {text: "ASCEND STAIRCASE", value: "staircase"},
                    {text: "RETURN TO COURTYARD", value: "courtyard"}
                ], handleInteriorMoveChoice);
            } else if (gameState.currentLocation === "library") {
                showActionPanel("MOVE WHERE?", [
                    {text: "RETURN TO ENTRY HALL", value: "castleInterior"},
                    {text: "EXAMINE FIREPLACE CLOSELY", value: "fireplace"},
                    {text: "CHECK UPPER SHELVES", value: "upper_shelves"}
                ], handleLibraryMoveChoice);
            } else if (gameState.currentLocation === "diningHall") {
                showActionPanel("MOVE WHERE?", [
                    {text: "RETURN TO ENTRY HALL", value: "castleInterior"},
                    {text: "APPROACH HEAD OF TABLE", value: "head_table"},
                    {text: "EXAMINE KITCHEN DOOR", value: "kitchen"}
                ], handleDiningHallMoveChoice);
            } else if (gameState.currentLocation === "throneRoom") {
                showActionPanel("MOVE WHERE?", [
                    {text: "RETURN TO ENTRY HALL", value: "castleInterior"},
                    {text: "APPROACH THRONE", value: "approach_throne"},
                    {text: "EXAMINE SIDE CHAMBERS", value: "side_chambers"}
                ], handleThroneRoomMoveChoice);
            }
        }
        
        // Handle interior move choice
        function handleInteriorMoveChoice(choice) {
            switch(choice) {
                case "library":
                    addToOutput("You enter the castle library.", "important-text");
                    gameState.currentLocation = "library";
                    updateStatus();
                    setTimeout(() => {
                        addToOutput("The library is filled with ancient, dusty tomes. Shelves line the walls, some collapsed.");
                    }, 300);
                    break;
                    
                case "diningHall":
                    addToOutput("You enter the dining hall.", "important-text");
                    gameState.currentLocation = "diningHall";
                    updateStatus();
                    setTimeout(() => {
                        addToOutput("A massive dining hall with a long table that could seat fifty.");
                    }, 300);
                    break;
                    
                case "staircase":
                    if (gameState.ghostPuzzleSolved) {
                        addToOutput("You ascend the staircase to the throne room.", "important-text");
                        gameState.currentLocation = "throneRoom";
                        updateStatus();
                        setTimeout(() => {
                            addToOutput("The throne room is vast and cold. At the far end sits an empty throne made of bone and obsidian.");
                        }, 300);
                    } else {
                        addToOutput("A spectral barrier blocks the staircase. You need to find a way to dispel it.", "ghost-text");
                    }
                    break;
                    
                case "courtyard":
                    addToOutput("You return to the courtyard. (Note: To go back to previous level, you would need to load c1.html)", "important-text");
                    // In a real implementation, you might redirect back or have a multi-level game
                    break;
            }
        }
        
        // Handle library move choice
        function handleLibraryMoveChoice(choice) {
            switch(choice) {
                case "castleInterior":
                    addToOutput("You return to the entry hall.", "important-text");
                    gameState.currentLocation = "castleInterior";
                    updateStatus();
                    break;
                    
                case "fireplace":
                    addToOutput("You examine the fireplace closely. The ashes are cold. There's an inscription: 'Knowledge illuminates the darkest paths.'");
                    break;
                    
                case "upper_shelves":
                    addToOutput("You try to reach the upper shelves but they're too high. You'd need a ladder.");
                    break;
            }
        }
        
        // Handle dining hall move choice
        function handleDiningHallMoveChoice(choice) {
            switch(choice) {
                case "castleInterior":
                    addToOutput("You return to the entry hall.", "important-text");
                    gameState.currentLocation = "castleInterior";
                    updateStatus();
                    break;
                    
                case "head_table":
                    addToOutput("You approach the head of the table. The spectral figure watches you.", "ghost-text");
                    break;
                    
                case "kitchen":
                    addToOutput("The kitchen door is locked. It would require a key.");
                    break;
            }
        }
        
        // Handle throne room move choice
        function handleThroneRoomMoveChoice(choice) {
            switch(choice) {
                case "castleInterior":
                    addToOutput("You return to the entry hall.", "important-text");
                    gameState.currentLocation = "castleInterior";
                    updateStatus();
                    break;
                    
                case "approach_throne":
                    addToOutput("You cautiously approach the throne...", "important-text");
                    if (!gameState.lichEncountered) {
                        setTimeout(() => {
                            addToOutput("The LICH KING materializes before you!", "lich-text");
                            gameState.lichEncountered = true;
                            
                            setTimeout(() => {
                                showActionPanel("FACE THE LICH KING:", [
                                    {text: "FIGHT", value: "fight"},
                                    {text: "NEGOTIATE", value: "negotiate"},
                                    {text: "USE CRYSTAL SHARD", value: "use_crystal"},
                                    {text: "USE SILVER AMULET", value: "use_amulet"},
                                    {text: "FLEE", value: "flee"}
                                ], handleLichEncounter);
                            }, 500);
                        }, 500);
                    }
                    break;
                    
                case "side_chambers":
                    addToOutput("The side chambers are dark and filled with shadows. Entering seems dangerous.", "danger-text");
                    break;
            }
        }
        
        // Examine command
        function handleExamine() {
            console.log("EXAMINE button clicked");
            if (gameState.currentLocation === "castleInterior") {
                showActionPanel("EXAMINE WHAT?", [
                    {text: "GHOSTLY APPARITION", value: "ghost"},
                    {text: "STAIRCASE CARVINGS", value: "carvings"},
                    {text: "ENTRY DOORS", value: "doors"},
                    {text: "WALL SCONCES", value: "sconces"},
                    {text: "FLOOR TILES", value: "tiles"}
                ], handleInteriorExamineChoice);
            } else if (gameState.currentLocation === "library") {
                showActionPanel("EXAMINE WHAT?", [
                    {text: "SPECIFIC TOMES", value: "specific_tomes"},
                    {text: "FIREPLACE DETAILS", value: "fireplace_details"},
                    {text: "BOOKSHELF CONSTRUCTION", value: "bookshelf"},
                    {text: "TABLE INSCRIPTIONS", value: "table"},
                    {text: "LIBRARY LADDER", value: "ladder"}
                ], handleLibraryExamineChoice);
            } else if (gameState.currentLocation === "diningHall") {
                showActionPanel("EXAMINE WHAT?", [
                    {text: "SPECTRAL FIGURE", value: "spectral_figure"},
                    {text: "TABLE SETTINGS", value: "settings"},
                    {text: "TAPESTRY DETAILS", value: "tapestry_details"},
                    {text: "CHANDELIER", value: "chandelier"},
                    {text: "FLOOR BOARDS", value: "floor"}
                ], handleDiningHallExamineChoice);
            } else if (gameState.currentLocation === "throneRoom") {
                showActionPanel("EXAMINE WHAT?", [
                    {text: "THRONE DETAILS", value: "throne_details"},
                    {text: "BRAZIER CARVINGS", value: "brazier_carvings"},
                    {text: "WALL RELIEFS", value: "reliefs"},
                    {text: "CEILING", value: "ceiling"},
                    {text: "FLOOR PATTERN", value: "floor_pattern"}
                ], handleThroneRoomExamineChoice);
            }
        }
        
        // Handle interior examine choice
        function handleInteriorExamineChoice(choice) {
            switch(choice) {
                case "ghost":
                    addToOutput("The ghostly apparition shimmers with ethereal light. It appears to be an elderly man in steward's clothing. His form is translucent and slightly faded.");
                    break;
                    
                case "carvings":
                    addToOutput("The staircase carvings depict scenes of the castle's construction. One panel shows workers being blessed by a priest.");
                    break;
                    
                case "doors":
                    addToOutput("The massive entry doors are made of dark oak banded with iron. They're closed tight and won't budge.");
                    break;
                    
                case "sconces":
                    addToOutput("The wall sconces hold burned-out torches. They haven't been lit in centuries.");
                    break;
                    
                case "tiles":
                    addToOutput("The floor tiles are arranged in a mosaic pattern showing the castle crest. Some tiles are cracked or missing.");
                    break;
            }
        }
        
        // Handle library examine choice
        function handleLibraryExamineChoice(choice) {
            switch(choice) {
                case "specific_tomes":
                    addToOutput("You examine specific tomes: 'The Art of Necromancy', 'Chronicles of the Undead', 'History of the Northern Kingdoms'. Most are too damaged to read fully.");
                    break;
                    
                case "fireplace_details":
                    addToOutput("The fireplace mantle is carved with intricate runes. Some glow faintly when you look at them.");
                    break;
                    
                case "bookshelf":
                    addToOutput("The bookshelves are made of dark wood. One shelf has a suspicious-looking seam along its edge.");
                    if (!gameState.libraryPuzzleSolved) {
                        addToOutput("The numeric keypad is set into this shelf.", "important-text");
                    }
                    break;
                    
                case "table":
                    addToOutput("The central table has inscriptions along its edges: 'Seek knowledge, find truth, break chains.'");
                    break;
                    
                case "ladder":
                    addToOutput("A rolling library ladder leans against one wall. It's sturdy enough to use.");
                    break;
            }
        }
        
        // Handle dining hall examine choice
        function handleDiningHallExamineChoice(choice) {
            switch(choice) {
                case "spectral_figure":
                    addToOutput("The spectral figure wears the robes of a noble. Its face is sorrowful. It seems unaware of its surroundings except when directly addressed.");
                    break;
                    
                case "settings":
                    addToOutput("Each place setting includes tarnished silver, a cracked plate, and a dusty goblet. The head setting has a golden plate.");
                    break;
                    
                case "tapestry_details":
                    addToOutput("The newer tapestry shows the castle lord performing a dark ritual in a circle of standing stones. A crystal shard features prominently in the scene.");
                    break;
                    
                case "chandelier":
                    addToOutput("A massive iron chandelier hangs above the table. Several crystals are missing from it.");
                    break;
                    
                case "floor":
                    addToOutput("The floorboards are warped with age. One board near the head of the table looks loose.");
                    break;
            }
        }
        
        // Handle throne room examine choice
        function handleThroneRoomExamineChoice(choice) {
            switch(choice) {
                case "throne_details":
                    addToOutput("The obsidian throne is carved with scenes of death and rebirth. Skulls are incorporated into the design. The seat is sized for a giant.");
                    break;
                    
                case "brazier_carvings":
                    addToOutput("The brazier is carved with depictions of souls being consumed by flames. The metal is ice-cold to the touch.");
                    break;
                    
                case "reliefs":
                    addToOutput("Wall reliefs show the Lich King commanding armies of undead. The detail is horrifyingly precise.");
                    break;
                    
                case "ceiling":
                    addToOutput("The ceiling is vaulted and painted with constellations. Some stars glow with faint light.");
                    break;
                    
                case "floor_pattern":
                    addToOutput("The floor is laid in a spiral pattern leading to the throne. The tiles are black and blood-red.");
                    break;
            }
        }
        
        // Help command
        function handleHelp() {
            console.log("HELP button clicked");
            addToOutput("AVAILABLE COMMANDS:", "important-text");
            addToOutput("LOOK - Describe your surroundings");
            addToOutput("INTERACT - Interact with objects in the environment");
            addToOutput("INVENTORY - View your inventory");
            addToOutput("TALK - Speak with characters (important for progression)");
            addToOutput("USE ITEM - Use an item from your inventory");
            addToOutput("MOVE - Move to a new location");
            addToOutput("EXAMINE - Closely examine an object");
            addToOutput("HELP - Show this help message");
            addToOutput("", "important-text");
            addToOutput("LEVEL 3 OBJECTIVE:", "success-text");
            addToOutput(" Explore the castle interior");
            addToOutput(" Solve the ghost's riddle to access the throne room");
            addToOutput(" Find the crystal shard in the library");
            addToOutput(" Confront and defeat the Lich King");
            addToOutput("", "important-text");
            addToOutput("TIPS:", "success-text");
            addToOutput(" Talk to the ghost in the entry hall for guidance");
            addToOutput(" Search everywhere - items from previous levels may be useful");
            addToOutput(" The library holds important secrets");
        }
        
        // Initialize the game
        initGame();
    </script>
</body>
</html>
