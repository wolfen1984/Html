<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle Vorin - Text Adventure</title>
    <style>
        body {
            background-color: #000;
            color: #c0c0c0;
            font-family: 'Courier New', monospace;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.4;
        }
        
        #game-container {
            background-color: #00008B;
            border: 2px solid #c0c0c0;
            padding: 15px;
            margin-bottom: 15px;
            height: 500px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #c0c0c0 #00008B;
        }
        
        #game-container::-webkit-scrollbar {
            width: 10px;
        }
        
        #game-container::-webkit-scrollbar-track {
            background: #00008B;
        }
        
        #game-container::-webkit-scrollbar-thumb {
            background: #c0c0c0;
        }
        
        .output {
            white-space: pre-wrap;
            margin-bottom: 10px;
        }
        
        .room-desc {
            color: #00FF00;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .response {
            color: #FFFF00;
            margin-bottom: 10px;
        }
        
        .inventory {
            color: #FFA500;
            font-style: italic;
            margin: 10px 0;
            border-top: 1px dashed #c0c0c0;
            padding-top: 5px;
        }
        
        .error {
            color: #FF0000;
        }
        
        #input-line {
            display: flex;
            align-items: center;
            background-color: #000;
            padding: 5px;
        }
        
        #prompt {
            color: #00FFFF;
            margin-right: 5px;
            font-weight: bold;
        }
        
        #command-input {
            background-color: #000;
            color: #FFFFFF;
            border: none;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            flex-grow: 1;
            outline: none;
        }
        
        #command-input:focus {
            outline: none;
        }
        
        #header {
            color: #FF0000;
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 0 0 5px #FF0000;
        }
        
        #instructions {
            color: #808080;
            font-size: 12px;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="header">
        ░█▀▀░█▀█░█▀▄░█▀█░█░░░░░█▀▀░█░█░█▀█░█▀▄░█▀▀<br>
        ░█▀▀░█▀█░█▀▄░█▀█░█░░░░░▀▀█░█▀█░█▀█░█▀▄░█▀▀<br>
        ░▀░░░▀░▀░▀░▀░▀░▀░▀▀▀░░░▀▀▀░▀░▀░▀░▀░▀░▀░▀▀▀
    </div>
    
    <div id="game-container">
        <div class="output" id="game-output"></div>
    </div>
    
    <div id="input-line">
        <span id="prompt">&gt;</span>
        <input type="text" id="command-input" autofocus>
    </div>
    
    <div id="instructions">
        Commands: N/S/E/W, LOOK, EXAMINE, TAKE, USE, TALK, READ, ATTACK, GIVE, DROP, INVENTORY
    </div>

    <script>
        // Game State - RESTORED with all original objects and puzzles
        const gameState = {
            currentRoom: 'outside_gates',
            inventory: [],
            roomStates: {
                outside_gates: {
                    gate_locked: true,
                    lantern_hanging: true,
                    chest_locked: true,
                    guard_post_locked: true,
                    gargoyle_activated: false,
                    tree_searched: false,
                    note_read: false,
                    visited: false,
                    gate_opened: false
                },
                courtyard: {
                    visited: false,
                    fountain_searched: false
                }
            },
            npcStates: {
                gatekeeper: {
                    lantern_returned: false,
                    coin_given: false,
                    herb_given: false,
                    attitude: 'hostile' // hostile, neutral, friendly
                }
            }
        };

        // Room Connections (Exits)
        const roomConnections = {
            outside_gates: {
                north: 'courtyard',
                south: null, // Blocked by fog
                east: null,
                west: null
            },
            courtyard: {
                north: 'great_hall',
                south: 'outside_gates',
                east: 'chapel',
                west: 'stable'
            }
        };

        // Room Descriptions - RESTORED FULL DESCRIPTIONS
        const rooms = {
            outside_gates: {
                name: 'Outside Castle Gates',
                desc: `The path ends before the immense outer wall of Castle Vorin. Twin stone GARGOYLES leer down from atop the rusted IRON GATE to the NORTH. A stooped old GATEKEEPER leans on a gnarled staff beside a small wooden GUARD POST, from which a LANTERN casts a feeble glow. To the side, an OLD WOODEN CHEST sits half-concealed by weeds, and a fallen TREE TRUNK lies rotting. Strange ENGRAVINGS are visible on the weather-worn castle wall.`,
                desc_short: `Outside the castle gates. The iron gate is to the NORTH.`,
                objects: ['gate', 'gargoyles', 'gatekeeper', 'guard post', 'lantern', 'chest', 'tree trunk', 'engravings', 'wall']
            },
            courtyard: {
                name: 'Inner Courtyard',
                desc: `You stand in a desolate inner courtyard. Overgrown weeds push through cracked flagstones. A dry FOUNTAIN stands in the center, its stone basin filled with murky water. To the NORTH, massive OAKEN DOORS lead into the castle proper. To the EAST, a small CHAPEL with a broken stained glass window. To the WEST, a low STABLE building with its doors hanging open. The castle GATE is behind you to the SOUTH. The air is cold and still.`,
                desc_short: `The inner courtyard. Exits: NORTH to great hall, EAST to chapel, WEST to stable, SOUTH to gates.`,
                objects: ['fountain', 'oaken doors', 'chapel', 'stable', 'weeds', 'flagstones', 'gate']
            }
        };

        // Object Descriptions - RESTORED WITH FULL DESCRIPTIONS
        const objectDescriptions = {
            // Room 1 Objects
            'gate': "The gate is formidable black iron, crisscrossed with bands of rust. A large, intricate lock is set into its center. The gargoyles above seem to watch it eternally.",
            'gargoyles': "Twin monstrosities of stone, wings folded. Their eyes are deep, dark hollows. The left one holds a chipped stone axe; the right one's claws are outstretched as if to grasp something.",
            'gatekeeper': "An ancient man wrapped in a threadbare cloak. His eyes are milky, but his grip on his staff is firm. A large iron key hangs from a cord around his neck.",
            'guard post': "A rickety wooden shed, barely large enough for one person. Its door is slightly ajar.",
            'lantern': "A simple iron lantern with cloudy glass. The candle inside is burnt low, guttering in the cold breeze.",
            'chest': "A heavy, banded chest. It is secured by a small but sturdy-looking padlock.",
            'tree trunk': "A long-dead oak, split open by time. Its hollow interior is dark and filled with damp leaves and debris.",
            'engravings': "Worn symbols are carved into the wall's foundation near the gate. They seem ritualistic. Some look like wolves, others like twisting vines.",
            'wall': "The massive stone wall of Castle Vorin, stained dark by centuries of weather.",
            
            // Room 2 Objects
            'fountain': "A once-grand marble fountain. The statue of a knight at its center is missing its head. The water in the basin is dark and still.",
            'oaken doors': "Enormous double doors bound with iron. They are closed tight. A wolf's head knocker glares at you from the left door.",
            'chapel': "A small stone chapel, its once-bright stained glass now shattered. The door creaks on its hinges.",
            'stable': "A long, low building that once housed horses. Now it smells only of mold and decay."
        };

        // Game Output Element
        const gameOutput = document.getElementById('game-output');
        const commandInput = document.getElementById('command-input');

        // Display initial room description
        function initGame() {
            displayRoomDescription();
            commandInput.focus();
        }

        // Display current room description - FIXED to show full description first time
        function displayRoomDescription() {
            const room = rooms[gameState.currentRoom];
            const roomState = gameState.roomStates[gameState.currentRoom];
            
            if (roomState.visited) {
                addOutput(`\n${room.desc_short}\n`, 'room-desc');
            } else {
                addOutput(`\n${room.desc}\n`, 'room-desc');
                roomState.visited = true;
            }
        }

        // Add output to game window
        function addOutput(text, className = '') {
            const outputDiv = document.createElement('div');
            outputDiv.className = `output ${className}`;
            outputDiv.textContent = text;
            gameOutput.appendChild(outputDiv);
            gameOutput.scrollTop = gameOutput.scrollHeight;
        }

        // Show inventory
        function showInventory() {
            if (gameState.inventory.length === 0) {
                addOutput("You are carrying nothing.", 'inventory');
            } else {
                addOutput("You are carrying: " + gameState.inventory.join(', '), 'inventory');
            }
        }

        // Normalize object names - ENHANCED with more synonyms
        function normalizeObjectName(name) {
            if (!name) return '';
            
            name = name.toLowerCase().replace(/^(the|a|an)\s+/, '');
            
            const synonyms = {
                // Directions
                'n': 'north',
                's': 'south', 
                'e': 'east',
                'w': 'west',
                
                // Room 1 Objects
                'gargoyle': 'gargoyles',
                'statues': 'gargoyles',
                'stone guardians': 'gargoyles',
                'keeper': 'gatekeeper',
                'old man': 'gatekeeper',
                'guard': 'gatekeeper',
                'post': 'guard post',
                'shed': 'guard post',
                'hut': 'guard post',
                'light': 'lantern',
                'lamp': 'lantern',
                'torch': 'lantern',
                'box': 'chest',
                'treasure chest': 'chest',
                'trunk': 'tree trunk',
                'log': 'tree trunk',
                'tree': 'tree trunk',
                'stump': 'tree trunk',
                'carving': 'engravings',
                'carvings': 'engravings',
                'writing': 'engravings',
                'symbols': 'engravings',
                'inscription': 'engravings',
                'key': 'small iron key',
                'iron key': 'small iron key',
                'small key': 'small iron key',
                'spare key': 'small iron key',
                'coin': 'gold coin',
                'gold': 'gold coin',
                'money': 'gold coin',
                'herb': 'pungent herb',
                'mint': 'pungent herb',
                'medicine': 'pungent herb',
                'wolf\'s-bane': 'pungent herb',
                'wolfbane': 'pungent herb',
                
                // Room 2 Objects
                'doors': 'oaken doors',
                'door': 'oaken doors',
                'main doors': 'oaken doors',
                'castle doors': 'oaken doors',
                'entrance': 'oaken doors',
                'church': 'chapel',
                'temple': 'chapel',
                'barn': 'stable',
                'horse barn': 'stable'
            };
            
            return synonyms[name] || name;
        }

        // Parse command with natural language
        function parseCommand(command) {
            const cmd = command.toLowerCase().trim();
            
            // Handle USE X ON Y pattern
            const useMatch = cmd.match(/^use\s+(.+?)\s+(?:on|with|to)\s+(.+)$/);
            if (useMatch) {
                return {
                    verb: 'use',
                    object: useMatch[1].trim(),
                    target: useMatch[2].trim()
                };
            }
            
            // Handle GIVE X TO Y pattern
            const giveMatch = cmd.match(/^give\s+(.+?)\s+(?:to)\s+(.+)$/);
            if (giveMatch) {
                return {
                    verb: 'give',
                    object: giveMatch[1].trim(),
                    target: giveMatch[2].trim()
                };
            }
            
            // Simple verb-object pattern
            const parts = cmd.split(/\s+/);
            const verb = parts[0];
            const object = parts.slice(1).join(' ');
            
            return {
                verb: verb,
                object: object,
                target: null
            };
        }

        // Process player command
        function processCommand(command) {
            const parsed = parseCommand(command);
            const verb = parsed.verb;
            const object = parsed.object;
            const target = parsed.target;
            
            addOutput(`> ${command}`, 'response');
            
            // Handle directional commands first
            if (['n', 'north', 's', 'south', 'e', 'east', 'w', 'west'].includes(verb)) {
                handleDirection(verb);
                return;
            }
            
            switch(verb) {
                case 'look':
                case 'examine':
                case 'x':
                    handleLook(object);
                    break;
                case 'take':
                case 'get':
                    handleTake(object);
                    break;
                case 'use':
                    handleUse(object, target);
                    break;
                case 'talk':
                case 'speak':
                    handleTalk(object);
                    break;
                case 'read':
                    handleRead(object);
                    break;
                case 'attack':
                case 'hit':
                case 'kill':
                case 'stab':
                case 'punch':
                    handleAttack(object);
                    break;
                case 'give':
                    handleGive(object, target);
                    break;
                case 'drop':
                    handleDrop(object);
                    break;
                case 'open':
                    handleOpen(object);
                    break;
                case 'search':
                case 'inspect':
                    handleSearch(object);
                    break;
                case 'inventory':
                case 'i':
                case 'inv':
                    showInventory();
                    break;
                case 'help':
                case '?':
                    showHelp();
                    break;
                case 'go':
                    // Handle "go north", "go to gate", etc.
                    if (object) {
                        const dir = normalizeObjectName(object);
                        if (['north', 'south', 'east', 'west', 'n', 's', 'e', 'w'].includes(dir)) {
                            handleDirection(dir);
                        } else if (dir === 'gate' && gameState.currentRoom === 'outside_gates') {
                            // Special case for going through gate
                            handleDirection('north');
                        } else if (dir === 'inside' && gameState.currentRoom === 'outside_gates') {
                            handleDirection('north');
                        } else {
                            addOutput(`Go where?`, 'error');
                        }
                    } else {
                        addOutput(`Go where?`, 'error');
                    }
                    break;
                default:
                    addResponse("I don't understand that command. Try LOOK, EXAMINE, TAKE, USE, TALK, READ, ATTACK, GIVE, DROP, INVENTORY, or HELP.", 'error');
            }
        }

        // Handle directional movement
        function handleDirection(direction) {
            const dir = normalizeObjectName(direction);
            const currentRoom = gameState.currentRoom;
            const connections = roomConnections[currentRoom];
            
            let exitDirection = dir;
            if (dir === 'n') exitDirection = 'north';
            if (dir === 's') exitDirection = 'south';
            if (dir === 'e') exitDirection = 'east';
            if (dir === 'w') exitDirection = 'west';
            
            const destination = connections[exitDirection];
            
            if (!destination) {
                addResponse(`You cannot go ${exitDirection}.`, 'error');
                return;
            }
            
            // Special checks for specific exits
            if (currentRoom === 'outside_gates' && exitDirection === 'north') {
                if (gameState.roomStates.outside_gates.gate_locked) {
                    addResponse("The gate is locked.", 'error');
                    return;
                }
            }
            
            // Move to new room
            gameState.currentRoom = destination;
            displayRoomDescription();
        }

        // Helper function for adding responses
        function addResponse(text, className = '') {
            const outputDiv = document.createElement('div');
            outputDiv.className = `output ${className}`;
            outputDiv.textContent = text;
            gameOutput.appendChild(outputDiv);
            gameOutput.scrollTop = gameOutput.scrollHeight;
        }

        // Command Handlers - RESTORED WITH FULL LOGIC
        function handleLook(object) {
            if (!object || object === 'around' || object === 'room') {
                displayRoomDescription();
                return;
            }
            
            const objName = normalizeObjectName(object);
            
            // Check if it's a direction
            if (['north', 'south', 'east', 'west', 'n', 's', 'e', 'w'].includes(objName)) {
                const room = rooms[gameState.currentRoom];
                const connections = roomConnections[gameState.currentRoom];
                let dir = objName;
                if (dir === 'n') dir = 'north';
                if (dir === 's') dir = 'south';
                if (dir === 'e') dir = 'east';
                if (dir === 'w') dir = 'west';
                
                const destination = connections[dir];
                if (destination) {
                    if (gameState.currentRoom === 'outside_gates' && dir === 'north') {
                        if (gameState.roomStates.outside_gates.gate_locked) {
                            addResponse("To the north is the iron gate. It is locked.");
                        } else {
                            addResponse("To the north, the iron gate stands open, leading into the courtyard.");
                        }
                    } else {
                        addResponse(`To the ${dir} you see...`);
                    }
                } else {
                    addResponse(`There is nothing notable to the ${dir}.`);
                }
                return;
            }
            
            // Room 1 specific look responses
            if (gameState.currentRoom === 'outside_gates') {
                if (objName === 'guard post') {
                    if (gameState.roomStates.outside_gates.guard_post_locked) {
                        addResponse("The guard post door is locked.");
                    } else {
                        addResponse("The guard post door is unlocked. Inside you see a bedroll and a NOTE.");
                    }
                    return;
                } else if (objName === 'tree trunk') {
                    if (gameState.roomStates.outside_gates.tree_searched) {
                        addResponse("An old hollow tree trunk. You've already searched it.");
                    } else {
                        addResponse(objectDescriptions[objName] + " There might be something inside...");
                    }
                    return;
                } else if (objName === 'gate') {
                    if (gameState.roomStates.outside_gates.gate_locked) {
                        addResponse(objectDescriptions[objName] + " It is firmly locked.");
                    } else {
                        addResponse("The iron gate stands open to the NORTH, leading into the courtyard.");
                    }
                    return;
                } else if (objName === 'gatekeeper') {
                    if (gameState.npcStates.gatekeeper.attitude === 'hostile') {
                        addResponse(objectDescriptions[objName] + " He eyes you suspiciously.");
                    } else if (gameState.npcStates.gatekeeper.attitude === 'neutral') {
                        addResponse(objectDescriptions[objName] + " He seems less hostile now.");
                    } else {
                        addResponse(objectDescriptions[objName] + " He gives you a slight nod.");
                    }
                    return;
                } else if (objName === 'note') {
                    if (!gameState.roomStates.outside_gates.guard_post_locked) {
                        addResponse("You see a folded note inside the guard post.");
                    } else {
                        addResponse("You don't see a note here.");
                    }
                    return;
                }
            }
            
            // Room 2 specific look responses
            if (gameState.currentRoom === 'courtyard') {
                if (objName === 'gate') {
                    addResponse("The iron gate behind you leads back outside to the SOUTH.");
                    return;
                }
            }
            
            // Default object descriptions
            if (objectDescriptions[objName]) {
                addResponse(objectDescriptions[objName]);
            } else {
                addResponse(`I don't see any ${object} here.`, 'error');
            }
        }

        function handleTake(object) {
            const objName = normalizeObjectName(object);
            
            if (gameState.currentRoom === 'outside_gates') {
                if (objName === 'lantern') {
                    if (gameState.roomStates.outside_gates.lantern_hanging) {
                        if (!hasItem('lantern')) {
                            gameState.inventory.push('lantern');
                            gameState.roomStates.outside_gates.lantern_hanging = false;
                            addResponse("You take the lantern from its hook. Its light wavers.");
                        } else {
                            addResponse("You already have the lantern.", 'error');
                        }
                    } else {
                        addResponse("The lantern is not here.", 'error');
                    }
                    return;
                } else if (objName === 'note') {
                    if (!gameState.roomStates.outside_gates.guard_post_locked) {
                        addResponse("You take the note. Now READ it to see what it says.");
                        gameState.roomStates.outside_gates.note_read = true;
                    } else {
                        addResponse("You don't see a note here.", 'error');
                    }
                    return;
                }
            }
            
            addResponse(`You cannot take the ${object}.`, 'error');
        }

        function handleUse(object, target) {
            const objName = normalizeObjectName(object);
            const targetName = target ? normalizeObjectName(target) : null;
            
            // Room 1 specific interactions
            if (gameState.currentRoom === 'outside_gates') {
                // USE TREE TRUNK (search it)
                if (objName === 'tree trunk' || (objName === 'trunk' && !targetName)) {
                    if (!gameState.roomStates.outside_gates.tree_searched) {
                        gameState.roomStates.outside_gates.tree_searched = true;
                        if (!hasItem('small iron key')) {
                            gameState.inventory.push('small iron key');
                            addResponse("You reach into the hollow trunk. Your fingers find a SMALL IRON KEY!");
                        }
                    } else if (!hasItem('small iron key')) {
                        addResponse("You search again but find nothing.");
                    } else {
                        addResponse("You've already searched the tree trunk.");
                    }
                    return;
                }
                
                // USE LANTERN ON GARGOYLES
                if (objName === 'lantern' && targetName === 'gargoyles') {
                    if (hasItem('lantern')) {
                        gameState.roomStates.outside_gates.gargoyle_activated = true;
                        gameState.roomStates.outside_gates.guard_post_locked = false;
                        addResponse("You hold the lantern up to the right gargoyle. Light falls into its outstretched claws. There's a soft CLICK from the guard post door!");
                    } else {
                        addResponse("You don't have the lantern.", 'error');
                    }
                    return;
                }
                
                // USE SMALL IRON KEY ON CHEST
                if (objName === 'small iron key' && targetName === 'chest') {
                    if (hasItem('small iron key')) {
                        if (gameState.roomStates.outside_gates.chest_locked) {
                            gameState.roomStates.outside_gates.chest_locked = false;
                            if (!hasItem('gold coin')) {
                                gameState.inventory.push('gold coin');
                            }
                            if (!hasItem('pungent herb')) {
                                gameState.inventory.push('pungent herb');
                            }
                            addResponse("The padlock clicks open! Inside the chest you find a GOLD COIN and some PUNGENT HERB.");
                        } else {
                            addResponse("The chest is already open.");
                        }
                    } else {
                        addResponse("You don't have the key.", 'error');
                    }
                    return;
                }
                
                // USE GATE
                if (objName === 'gate') {
                    if (gameState.roomStates.outside_gates.gate_locked) {
                        addResponse("The gate is locked tight.");
                    } else {
                        addResponse("The gate is open. You can go NORTH through it.");
                    }
                    return;
                }
                
                // USE CHEST
                if (objName === 'chest') {
                    if (gameState.roomStates.outside_gates.chest_locked) {
                        addResponse("The chest is locked.");
                    } else {
                        addResponse("The chest is open and empty.");
                    }
                    return;
                }
                
                // USE LANTERN (alone)
                if (objName === 'lantern' && !targetName) {
                    if (hasItem('lantern')) {
                        addResponse("The lantern casts a circle of weak light around you.");
                    } else {
                        addResponse("You don't have the lantern.", 'error');
                    }
                    return;
                }
            }
            
            addResponse("That doesn't seem to work.", 'error');
        }

        function handleTalk(object) {
            const objName = normalizeObjectName(object);
            
            if (objName === 'gatekeeper' && gameState.currentRoom === 'outside_gates') {
                const attitude = gameState.npcStates.gatekeeper.attitude;
                
                if (attitude === 'hostile') {
                    if (!gameState.npcStates.gatekeeper.coin_given && !gameState.npcStates.gatekeeper.herb_given) {
                        addResponse('Gatekeeper: "No one enters. Master\'s orders. The gate stays shut. Unless... you have business within?"');
                    } else if (gameState.npcStates.gatekeeper.coin_given && !gameState.npcStates.gatekeeper.herb_given) {
                        addResponse('Gatekeeper: "The coin is nice, but my old bones still ache..."');
                    } else if (!gameState.npcStates.gatekeeper.coin_given && gameState.npcStates.gatekeeper.herb_given) {
                        addResponse('Gatekeeper: "The mint helps, but these cold nights are long..."');
                    }
                } else if (attitude === 'neutral') {
                    addResponse('Gatekeeper: "You seem alright. But rules are rules."');
                } else {
                    addResponse('Gatekeeper: "The gate is open for you. Mind your step inside."');
                }
                return;
            }
            
            addResponse(`Talking to the ${object} produces no response.`);
        }

        function handleRead(object) {
            const objName = normalizeObjectName(object);
            
            if (objName === 'engravings' && gameState.currentRoom === 'outside_gates') {
                addResponse('You read the engravings: "Beware the keepers of stone. Offer light to the silent watcher, and the way may be granted."');
                return;
            }
            
            if (objName === 'note' && gameState.currentRoom === 'outside_gates') {
                if (!gameState.roomStates.outside_gates.guard_post_locked) {
                    addResponse('You read the note: "The old fool hides the spare key in his \'seat\'. Thinks I don\'t know. - M"');
                    gameState.roomStates.outside_gates.note_read = true;
                } else {
                    addResponse("You need to get into the guard post first.");
                }
                return;
            }
            
            addResponse(`There's nothing to read on the ${object}.`);
        }

        function handleAttack(object) {
            const objName = normalizeObjectName(object);
            
            if (objName === 'gatekeeper' && gameState.currentRoom === 'outside_gates') {
                addResponse('The gatekeeper raises his staff! "Think again, fool!" (Violence might not be the best approach here.)', 'error');
                return;
            }
            
            if (objName === 'chest' && gameState.currentRoom === 'outside_gates') {
                addResponse("You strike the chest. The wood is stout and the lock holds. You only hurt your hand.", 'error');
                return;
            }
            
            if (objName === 'tree trunk' && gameState.currentRoom === 'outside_gates') {
                addResponse("You kick the rotten trunk. Some wood splinters off, revealing the hollow interior more clearly.");
                if (!gameState.roomStates.outside_gates.tree_searched) {
                    gameState.roomStates.outside_gates.tree_searched = true;
                }
                return;
            }
            
            if (objName === 'gate' && gameState.currentRoom === 'outside_gates') {
                addResponse("Your attacks are useless against the solid iron gate.");
                return;
            }
            
            addResponse(`Attacking the ${object} seems pointless.`, 'error');
        }

        function handleGive(object, target) {
            if (!object) {
                addResponse("Give what?", 'error');
                return;
            }
            
            if (!target) {
                addResponse(`Give ${object} to whom?`, 'error');
                return;
            }
            
            const objName = normalizeObjectName(object);
            const targetName = normalizeObjectName(target);
            
            if (targetName !== 'gatekeeper' || gameState.currentRoom !== 'outside_gates') {
                addResponse(`The ${target} doesn't want anything from you.`);
                return;
            }
            
            // Check if player has the item
            if (!hasItem(objName)) {
                addResponse(`You don't have ${object}.`, 'error');
                return;
            }
            
            // Handle giving specific items
            if (objName === 'lantern') {
                removeItem('lantern');
                gameState.npcStates.gatekeeper.lantern_returned = true;
                addResponse('You give the lantern back to the gatekeeper. "Ah, good. The wind nips without it."');
                gameState.npcStates.gatekeeper.attitude = 'neutral';
            } else if (objName === 'gold coin') {
                removeItem('gold coin');
                gameState.npcStates.gatekeeper.coin_given = true;
                addResponse('You give the gold coin to the gatekeeper. His milky eyes widen. "A coin? For me? Well..."');
                gameState.npcStates.gatekeeper.attitude = 'neutral';
                checkGateOpen();
            } else if (objName === 'pungent herb') {
                removeItem('pungent herb');
                gameState.npcStates.gatekeeper.herb_given = true;
                addResponse('You give the herb to the gatekeeper. He sniffs it and smiles. "Ah! Wolf\'s-bane mint. For my old joints. You\'re alright, stranger."');
                gameState.npcStates.gatekeeper.attitude = 'friendly';
                checkGateOpen();
            } else {
                addResponse(`The gatekeeper doesn't want ${object}.`);
            }
        }

        function handleDrop(object) {
            const objName = normalizeObjectName(object);
            
            if (hasItem(objName)) {
                removeItem(objName);
                addResponse(`You drop the ${object}.`);
            } else {
                addResponse(`You're not carrying ${object}.`, 'error');
            }
        }

        function handleOpen(object) {
            const objName = normalizeObjectName(object);
            
            if (objName === 'gate' && gameState.currentRoom === 'outside_gates') {
                if (gameState.roomStates.outside_gates.gate_locked) {
                    addResponse("The gate is locked.");
                } else {
                    addResponse("The gate is already open.");
                }
                return;
            }
            
            if (objName === 'chest' && gameState.currentRoom === 'outside_gates') {
                if (gameState.roomStates.outside_gates.chest_locked) {
                    addResponse("The chest is locked.");
                } else {
                    addResponse("The chest is already open.");
                }
                return;
            }
            
            addResponse(`You cannot open the ${object}.`);
        }

        function handleSearch(object) {
            const objName = normalizeObjectName(object);
            
            if (objName === 'tree trunk' && gameState.currentRoom === 'outside_gates') {
                handleUse('tree trunk', null);
                return;
            }
            
            if (objName === 'chest' && gameState.currentRoom === 'outside_gates') {
                if (gameState.roomStates.outside_gates.chest_locked) {
                    addResponse("The chest is locked.");
                } else {
                    addResponse("The chest is empty.");
                }
                return;
            }
            
            addResponse(`You search the ${object} but find nothing of interest.`);
        }

        // Helper functions
        function hasItem(itemName) {
            const normalized = normalizeObjectName(itemName);
            return gameState.inventory.some(item => normalizeObjectName(item) === normalized);
        }

        function removeItem(itemName) {
            const normalized = normalizeObjectName(itemName);
            for (let i = 0; i < gameState.inventory.length; i++) {
                if (normalizeObjectName(gameState.inventory[i]) === normalized) {
                    gameState.inventory.splice(i, 1);
                    return true;
                }
            }
            return false;
        }

        function checkGateOpen() {
            if (gameState.npcStates.gatekeeper.coin_given && gameState.npcStates.gatekeeper.herb_given) {
                gameState.roomStates.outside_gates.gate_locked = false;
                gameState.roomStates.outside_gates.gate_opened = true;
                addResponse('\nThe gatekeeper takes the key from his neck and unlocks the gate. "Don\'t say I never did anything for anyone."\nThe great iron gate swings open with a deafening groan.\nYou can now go NORTH through the gate.');
            }
        }

        function showHelp() {
            addResponse("Available commands:");
            addResponse("N, S, E, W - Move in direction");
            addResponse("GO [direction] - Move (e.g., GO NORTH)");
            addResponse("LOOK or EXAMINE [object] - Look at room or object");
            addResponse("TAKE [item] - Pick up an item");
            addResponse("USE [item] ON [object] - Use an item on something");
            addResponse("TALK [person] - Speak to someone");
            addResponse("READ [object] - Read text");
            addResponse("ATTACK [object] - Attack something");
            addResponse("GIVE [item] TO [person] - Give an item");
            addResponse("DROP [item] - Drop an item");
            addResponse("OPEN [object] - Try to open something");
            addResponse("SEARCH [object] - Search something");
            addResponse("INVENTORY or I - Check your inventory");
            addResponse("\nExamples:");
            addResponse("  N (or NORTH) - Go north");
            addResponse("  USE LANTERN ON GARGOYLES");
            addResponse("  GIVE GOLD COIN TO GATEKEEPER");
            addResponse("  USE SMALL IRON KEY ON CHEST");
            addResponse("  READ ENGRAVINGS");
        }

        // Handle Enter key in input
        commandInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const command = commandInput.value;
                if (command.trim()) {
                    processCommand(command);
                    commandInput.value = '';
                }
            }
        });

        // Initialize game
        window.onload = initGame;
    </script>
</body>
</html>
