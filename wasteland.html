<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wasteland (1988) - Enhanced Android Port</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #0f0;
            overflow: hidden;
            height: 100vh;
            touch-action: manipulation;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Header styling */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 2px solid #0f0;
            margin-bottom: 10px;
        }
        
        .logo {
            font-size: 18px;
            font-weight: bold;
            color: #ff0;
            text-shadow: 0 0 5px #ff0;
        }
        
        .battery {
            font-size: 14px;
            color: #0f0;
        }
        
        /* Game screen styling */
        .game-screen {
            flex: 1;
            background-color: #000;
            border: 2px solid #0f0;
            padding: 12px;
            margin-bottom: 10px;
            overflow-y: auto;
            line-height: 1.4;
            font-size: 16px;
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.2);
        }
        
        .game-screen::-webkit-scrollbar {
            width: 6px;
        }
        
        .game-screen::-webkit-scrollbar-track {
            background: #111;
        }
        
        .game-screen::-webkit-scrollbar-thumb {
            background: #0a0;
        }
        
        /* Status bar */
        .status-bar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            padding: 8px 5px;
            border-top: 1px solid #0f0;
            border-bottom: 1px solid #0f0;
            margin-bottom: 10px;
            font-size: 14px;
            background-color: #111;
            gap: 5px;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .status-label {
            color: #ff0;
            font-size: 11px;
            margin-bottom: 2px;
        }
        
        .status-value {
            color: #0f0;
            font-weight: bold;
        }
        
        .health-bar {
            width: 100%;
            height: 6px;
            background-color: #300;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 2px;
        }
        
        .health-fill {
            height: 100%;
            background-color: #0f0;
            width: 78%;
            transition: width 0.5s;
        }
        
        /* Combat UI */
        .combat-ui {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #111;
            border: 2px solid #f00;
            border-radius: 5px;
        }
        
        .combat-ui.active {
            display: grid;
        }
        
        .combat-btn {
            background-color: #300;
            color: #f00;
            border: 1px solid #f00;
            padding: 12px 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        
        .combat-btn:active {
            background-color: #f00;
            color: #000;
        }
        
        .combat-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .combat-btn:disabled:active {
            background-color: #300;
            color: #f00;
        }
        
        /* Turn indicator */
        .turn-indicator {
            display: none;
            text-align: center;
            padding: 5px;
            margin-bottom: 5px;
            background-color: #300;
            border: 1px solid #f00;
            color: #ff0;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }
        
        .turn-indicator.active {
            display: block;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Command buttons */
        .command-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .command-btn {
            background-color: #111;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        
        .command-btn:active {
            background-color: #0a0;
            color: #000;
        }
        
        .command-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Directional controls */
        .directional-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
            max-width: 180px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .dir-btn {
            background-color: #111;
            color: #0f0;
            border: 1px solid #0f0;
            height: 50px;
            font-size: 20px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
        }
        
        .dir-btn:active {
            background-color: #0a0;
            color: #000;
        }
        
        .dir-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .dir-btn:nth-child(1) {
            grid-column: 2;
            grid-row: 1;
        }
        
        .dir-btn:nth-child(2) {
            grid-column: 1;
            grid-row: 2;
        }
        
        .dir-btn:nth-child(3) {
            grid-column: 2;
            grid-row: 2;
        }
        
        .dir-btn:nth-child(4) {
            grid-column: 3;
            grid-row: 2;
        }
        
        .dir-btn:nth-child(5) {
            grid-column: 2;
            grid-row: 3;
        }
        
        /* Action buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #ff0;
            border: 1px solid #ff0;
            padding: 12px 5px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        
        .action-btn:active {
            background-color: #ff0;
            color: #000;
        }
        
        .action-btn.combat {
            background-color: #300;
            color: #f00;
            border-color: #f00;
        }
        
        .action-btn.combat:active {
            background-color: #f00;
            color: #000;
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Inventory modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 100;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: #000;
            border: 2px solid #0f0;
            padding: 15px;
            max-width: 500px;
            margin: 20px auto;
            color: #0f0;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #0f0;
        }
        
        .modal-title {
            color: #ff0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .close-modal {
            color: #f00;
            font-size: 24px;
            cursor: pointer;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .inventory-item {
            background-color: #111;
            border: 1px solid #0f0;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .inventory-item:active {
            background-color: #0a0;
            color: #000;
        }
        
        .item-name {
            color: #0ff;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .item-desc {
            font-size: 12px;
            color: #0f0;
        }
        
        .item-stats {
            font-size: 11px;
            color: #ff0;
            margin-top: 5px;
        }
        
        /* Combat log */
        .combat-log {
            background-color: #111;
            border: 1px solid #f00;
            padding: 10px;
            margin-top: 10px;
            max-height: 120px;
            overflow-y: auto;
            font-size: 14px;
        }
        
        /* Game text styling */
        .game-text {
            margin-bottom: 8px;
        }
        
        .game-text:last-child {
            margin-bottom: 0;
        }
        
        .prompt {
            color: #0ff;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .location {
            color: #ff0;
            font-weight: bold;
        }
        
        .enemy {
            color: #f00;
            font-weight: bold;
        }
        
        .item {
            color: #0ff;
        }
        
        .damage {
            color: #f80;
            font-weight: bold;
        }
        
        .heal {
            color: #0f0;
            font-weight: bold;
        }
        
        .health {
            color: #0f0;
        }
        
        .critical {
            color: #f00;
            animation: pulse 0.5s infinite;
        }
        
        .combat-turn {
            background-color: #300;
            padding: 5px;
            margin: 5px 0;
            border-left: 3px solid #f00;
        }
        
        /* Enemy health bars */
        .enemy-info {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            background-color: #111;
            border-left: 3px solid #f00;
        }
        
        .enemy-health {
            width: 60px;
            height: 8px;
            background-color: #300;
            border-radius: 4px;
            overflow: hidden;
            margin-left: 10px;
        }
        
        .enemy-health-fill {
            height: 100%;
            background-color: #f00;
            width: 100%;
        }
        
        /* Target selection UI */
        .target-selection {
            display: none;
            margin: 10px 0;
            padding: 10px;
            background-color: #111;
            border: 1px solid #f00;
        }
        
        .target-selection.active {
            display: block;
        }
        
        .target-btn {
            background-color: #300;
            color: #f00;
            border: 1px solid #f00;
            padding: 8px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .target-btn:active {
            background-color: #f00;
            color: #000;
        }
        
        /* Mobile-specific optimizations */
        @media (max-width: 400px) {
            .command-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .combat-ui {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .command-btn {
                padding: 8px 4px;
                font-size: 13px;
            }
            
            .action-btn {
                padding: 10px 4px;
                font-size: 14px;
            }
            
            .game-screen {
                font-size: 15px;
            }
            
            .status-bar {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
        }
        
        /* Prevent text selection */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with battery and time -->
        <div class="header">
            <div class="logo">WASTELAND ENHANCED</div>
            <div class="battery">
                <i class="fas fa-battery-three-quarters"></i> 84% | 14:32
            </div>
        </div>
        
        <!-- Main game screen -->
        <div class="game-screen" id="gameScreen">
            <div class="turn-indicator" id="turnIndicator">ENEMY TURN</div>
            <div class="game-text">
                <span class="location">LAS VEGAS RUINS - OUTSKIRTS</span>
            </div>
            <div class="game-text">The desert wind blows dust across the broken highway. In the distance, the skeletal remains of old casinos stand against a blood-red sky.</div>
            <div class="game-text">Your radiation meter clicks steadily. Water: 32%. Party status: HEALTHY.</div>
            <div class="game-text">Ahead, you see a pack of <span class="enemy">MUTATED COYOTES</span> scavenging near an overturned car.</div>
            <div class="game-text">To the east, what might be an intact building. To the west, the road continues toward the city center.</div>
            <div class="game-text">>> <span class='prompt'>_</span></div>
        </div>
        
        <!-- Target selection -->
        <div class="target-selection" id="targetSelection">
            <div style="color: #ff0; margin-bottom: 5px;">Select target:</div>
            <div id="targetButtons"></div>
        </div>
        
        <!-- Combat UI -->
        <div class="combat-ui" id="combatUI">
            <button class="combat-btn" data-action="attack" id="attackBtn">ATTACK</button>
            <button class="combat-btn" data-action="aim" id="aimBtn">AIMED SHOT</button>
            <button class="combat-btn" data-action="item" id="itemBtn">USE ITEM</button>
            <button class="combat-btn" data-action="defend" id="defendBtn">DEFEND</button>
            <button class="combat-btn" data-action="flee" id="fleeBtn">FLEE</button>
            <button class="combat-btn" data-action="special" id="specialBtn">SPECIAL</button>
        </div>
        
        <!-- Status bar -->
        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">HEALTH</span>
                <span class="status-value health" id="healthValue">78%</span>
                <div class="health-bar">
                    <div class="health-fill" id="healthBar"></div>
                </div>
            </div>
            <div class="status-item">
                <span class="status-label">RADS</span>
                <span class="status-value" id="radsValue">12%</span>
            </div>
            <div class="status-item">
                <span class="status-label">WATER</span>
                <span class="status-value" id="waterValue">32%</span>
            </div>
            <div class="status-item">
                <span class="status-label">AMMO</span>
                <span class="status-value" id="ammoValue">146</span>
            </div>
            <div class="status-item">
                <span class="status-label">KARMA</span>
                <span class="status-value" id="karmaValue">+24</span>
            </div>
        </div>
        
        <!-- Command buttons -->
        <div class="command-buttons">
            <button class="command-btn" data-command="LOOK" id="lookBtn">LOOK</button>
            <button class="command-btn" data-command="TAKE" id="takeBtn">TAKE</button>
            <button class="command-btn" data-command="USE" id="useBtn">USE</button>
            <button class="command-btn" data-command="TALK" id="talkBtn">TALK</button>
            <button class="command-btn" data-command="INV" id="invBtn">INVENTORY</button>
            <button class="command-btn" data-command="MAP" id="mapBtn">MAP</button>
            <button class="command-btn" data-command="CHAR" id="charBtn">CHARACTER</button>
            <button class="command-btn" data-command="SAVE" id="saveBtn">SAVE</button>
        </div>
        
        <!-- Directional controls -->
        <div class="directional-controls">
            <button class="dir-btn" data-dir="N" id="northBtn"><i class="fas fa-arrow-up"></i></button>
            <button class="dir-btn" data-dir="W" id="westBtn"><i class="fas fa-arrow-left"></i></button>
            <button class="dir-btn" data-dir="WAIT" id="waitBtn">WAIT</button>
            <button class="dir-btn" data-dir="E" id="eastBtn"><i class="fas fa-arrow-right"></i></button>
            <button class="dir-btn" data-dir="S" id="southBtn"><i class="fas fa-arrow-down"></i></button>
        </div>
        
        <!-- Action buttons -->
        <div class="action-buttons">
            <button class="action-btn combat" id="combatBtn">COMBAT MODE</button>
            <button class="action-btn" id="menuBtn">MENU</button>
        </div>
    </div>
    
    <!-- Inventory Modal -->
    <div class="modal" id="inventoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">INVENTORY</div>
                <div class="close-modal" id="closeInventory">&times;</div>
            </div>
            <div class="inventory-grid" id="inventoryGrid">
                <!-- Inventory items will be generated here -->
            </div>
            <div class="combat-log" id="inventoryLog">
                Select an item to use or examine
            </div>
        </div>
    </div>
    
    <!-- Character Modal -->
    <div class="modal" id="characterModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">RANGER DOSSIER</div>
                <div class="close-modal" id="closeCharacter">&times;</div>
            </div>
            <div id="characterContent">
                <!-- Character info will be generated here -->
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const gameScreen = document.getElementById('gameScreen');
        const combatUI = document.getElementById('combatUI');
        const turnIndicator = document.getElementById('turnIndicator');
        const targetSelection = document.getElementById('targetSelection');
        const targetButtons = document.getElementById('targetButtons');
        
        // Button elements
        const attackBtn = document.getElementById('attackBtn');
        const aimBtn = document.getElementById('aimBtn');
        const itemBtn = document.getElementById('itemBtn');
        const defendBtn = document.getElementById('defendBtn');
        const fleeBtn = document.getElementById('fleeBtn');
        const specialBtn = document.getElementById('specialBtn');
        const combatBtn = document.getElementById('combatBtn');
        const menuBtn = document.getElementById('menuBtn');
        
        // Command buttons
        const lookBtn = document.getElementById('lookBtn');
        const takeBtn = document.getElementById('takeBtn');
        const useBtn = document.getElementById('useBtn');
        const talkBtn = document.getElementById('talkBtn');
        const invBtn = document.getElementById('invBtn');
        const mapBtn = document.getElementById('mapBtn');
        const charBtn = document.getElementById('charBtn');
        const saveBtn = document.getElementById('saveBtn');
        
        // Directional buttons
        const northBtn = document.getElementById('northBtn');
        const westBtn = document.getElementById('westBtn');
        const waitBtn = document.getElementById('waitBtn');
        const eastBtn = document.getElementById('eastBtn');
        const southBtn = document.getElementById('southBtn');
        
        // Modal elements
        const inventoryModal = document.getElementById('inventoryModal');
        const characterModal = document.getElementById('characterModal');
        const closeInventory = document.getElementById('closeInventory');
        const closeCharacter = document.getElementById('closeCharacter');
        const inventoryGrid = document.getElementById('inventoryGrid');
        const characterContent = document.getElementById('characterContent');
        const inventoryLog = document.getElementById('inventoryLog');
        
        // Status elements
        const healthValue = document.getElementById('healthValue');
        const healthBar = document.getElementById('healthBar');
        const radsValue = document.getElementById('radsValue');
        const waterValue = document.getElementById('waterValue');
        const ammoValue = document.getElementById('ammoValue');
        const karmaValue = document.getElementById('karmaValue');
        
        // Game state
        let gameHistory = [];
        let currentLocation = "LAS VEGAS RUINS - OUTSKIRTS";
        let combatMode = false;
        let inCombat = false;
        let enemies = [];
        let playerTurn = true;
        let isSelectingTarget = false;
        let currentAction = null;
        let isDefending = false;
        
        // Player stats
        const player = {
            name: "Angela Deth",
            level: 7,
            health: 78,
            maxHealth: 78,
            rads: 12,
            water: 32,
            ammo: 146,
            karma: 24,
            skills: {
                rifles: 85,
                pistols: 72,
                melee: 65,
                firstAid: 72,
                demolition: 68,
                lockpick: 60
            },
            equippedWeapon: "Assault Rifle"
        };
        
        // Inventory system
        const inventory = [
            { id: 1, name: "Assault Rifle", type: "weapon", damage: "12-18", ammo: 142, desc: "Pre-war military rifle", equipped: true },
            { id: 2, name: "9mm Pistol", type: "weapon", damage: "6-10", ammo: 24, desc: "Standard sidearm", equipped: false },
            { id: 3, name: "Combat Knife", type: "weapon", damage: "4-8", desc: "Sharp military knife", equipped: false },
            { id: 4, name: "Medkit", type: "heal", uses: 3, power: 25, desc: "Restores 25 HP per use" },
            { id: 5, name: "Canteen", type: "water", uses: 5, power: 20, desc: "Restores 20% water" },
            { id: 6, name: "Geiger Counter", type: "tool", desc: "Measures radiation levels" },
            { id: 7, name: "Lockpicks", type: "tool", quantity: 6, desc: "For opening locked containers" },
            { id: 8, name: "$247", type: "money", desc: "Pre-war currency" },
            { id: 9, name: "RadAway", type: "heal", uses: 2, power: 15, desc: "Reduces radiation by 15%" },
            { id: 10, name: "Frag Grenade", type: "weapon", damage: "20-30", quantity: 2, desc: "Area damage explosive" }
        ];
        
        // Enemy templates
        const enemyTemplates = {
            coyote: { name: "Mutated Coyote", health: 25, maxHealth: 25, damage: "4-8", accuracy: 65, exp: 15 },
            raider: { name: "Desert Raider", health: 40, maxHealth: 40, damage: "6-12", accuracy: 70, exp: 25 },
            scorpion: { name: "Giant Scorpion", health: 35, maxHealth: 35, damage: "5-10", accuracy: 60, exp: 20 },
            mutant: { name: "Radiation Mutant", health: 50, maxHealth: 50, damage: "8-15", accuracy: 75, exp: 35 }
        };
        
        // Initialize game
        function initGame() {
            // Update status displays
            updateStatus();
            
            // Add event listeners to combat buttons
            attackBtn.addEventListener('click', () => {
                if (!playerTurn) return;
                if (enemies.length === 0) {
                    addGameText("No enemies to attack!", "damage");
                    return;
                }
                if (enemies.length === 1) {
                    performAttack(0); // Auto-attack if only one enemy
                } else {
                    showTargetSelection('attack');
                }
            });
            
            aimBtn.addEventListener('click', () => {
                if (!playerTurn) return;
                if (player.ammo < 5) {
                    addGameText("Not enough ammo for aimed shot!", "damage");
                    return;
                }
                if (enemies.length === 0) {
                    addGameText("No enemies to attack!", "damage");
                    return;
                }
                if (enemies.length === 1) {
                    performAimedShot(0);
                } else {
                    showTargetSelection('aim');
                }
            });
            
            itemBtn.addEventListener('click', () => {
                if (!playerTurn && inCombat) return;
                showInventoryModal();
            });
            
            defendBtn.addEventListener('click', () => {
                if (!playerTurn) return;
                performDefend();
            });
            
            fleeBtn.addEventListener('click', () => {
                if (!playerTurn) return;
                attemptFlee();
            });
            
            specialBtn.addEventListener('click', () => {
                if (!playerTurn) return;
                performSpecial();
            });
            
            // Combat mode toggle
            combatBtn.addEventListener('click', toggleCombatMode);
            
            // Menu button
            menuBtn.addEventListener('click', showMenu);
            
            // Command buttons
            const commandBtns = [lookBtn, takeBtn, useBtn, talkBtn, invBtn, mapBtn, charBtn, saveBtn];
            commandBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const command = btn.getAttribute('data-command');
                    executeCommand(command);
                });
            });
            
            // Directional buttons
            const dirBtns = [northBtn, westBtn, waitBtn, eastBtn, southBtn];
            dirBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (inCombat) {
                        addGameText("Cannot move while in combat!", "damage");
                        return;
                    }
                    const dir = btn.getAttribute('data-dir');
                    if (dir === 'WAIT') {
                        addGameText("You wait and observe your surroundings...");
                        addGameText(">> <span class='prompt'>_</span>");
                    } else {
                        moveDirection(dir);
                    }
                });
            });
            
            // Modal close buttons
            closeInventory.addEventListener('click', () => {
                inventoryModal.style.display = 'none';
            });
            
            closeCharacter.addEventListener('click', () => {
                characterModal.style.display = 'none';
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === inventoryModal) {
                    inventoryModal.style.display = 'none';
                }
                if (e.target === characterModal) {
                    characterModal.style.display = 'none';
                }
            });
            
            // Update UI based on initial state
            updateUIState();
            
            // Add initial game text
            addGameText("Wasteland Enhanced v2.1 - Initialized");
            addGameText("Welcome back, Desert Ranger.");
            addGameText(">> <span class='prompt'>_</span>");
        }
        
        // Update UI state (enable/disable buttons based on game state)
        function updateUIState() {
            const inCombatState = inCombat;
            const playerTurnState = playerTurn;
            
            // Combat buttons
            attackBtn.disabled = !playerTurnState || !inCombatState;
            aimBtn.disabled = !playerTurnState || !inCombatState;
            itemBtn.disabled = !playerTurnState && inCombatState; // Can use items anytime except enemy turn
            defendBtn.disabled = !playerTurnState || !inCombatState;
            fleeBtn.disabled = !playerTurnState || !inCombatState;
            specialBtn.disabled = !playerTurnState || !inCombatState;
            
            // Command buttons (disabled during enemy turn)
            const commandBtns = [lookBtn, takeBtn, useBtn, talkBtn, invBtn, mapBtn, charBtn, saveBtn];
            commandBtns.forEach(btn => {
                btn.disabled = inCombatState && !playerTurnState;
            });
            
            // Directional buttons
            const dirBtns = [northBtn, westBtn, waitBtn, eastBtn, southBtn];
            dirBtns.forEach(btn => {
                btn.disabled = inCombatState;
            });
            
            // Combat mode button
            combatBtn.disabled = inCombatState;
            
            // Update turn indicator
            if (inCombatState) {
                if (playerTurnState) {
                    turnIndicator.textContent = "YOUR TURN";
                    turnIndicator.style.backgroundColor = "#030";
                    turnIndicator.style.borderColor = "#0f0";
                    turnIndicator.classList.add('active');
                } else {
                    turnIndicator.textContent = "ENEMY TURN";
                    turnIndicator.style.backgroundColor = "#300";
                    turnIndicator.style.borderColor = "#f00";
                    turnIndicator.classList.add('active');
                }
            } else {
                turnIndicator.classList.remove('active');
            }
        }
        
        // Update status display
        function updateStatus() {
            healthValue.textContent = `${player.health}%`;
            healthBar.style.width = `${(player.health / player.maxHealth) * 100}%`;
            
            // Change health bar color based on health
            if (player.health < 30) {
                healthBar.style.backgroundColor = '#f00';
            } else if (player.health < 60) {
                healthBar.style.backgroundColor = '#f80';
            } else {
                healthBar.style.backgroundColor = '#0f0';
            }
            
            radsValue.textContent = `${player.rads}%`;
            waterValue.textContent = `${player.water}%`;
            ammoValue.textContent = player.ammo;
            karmaValue.textContent = `+${player.karma}`;
        }
        
        // Add text to game screen
        function addGameText(text, className = "") {
            const textElement = document.createElement('div');
            textElement.classList.add('game-text');
            if (className) {
                textElement.classList.add(className);
            }
            textElement.innerHTML = text;
            
            // Add combat turn wrapper if in combat
            if (inCombat && (text.includes("damage") || text.includes("hits") || text.includes("misses") || 
                text.includes("defeated") || text.includes("CRITICAL") || text.includes("flees"))) {
                const combatTurnElement = document.createElement('div');
                combatTurnElement.classList.add('combat-turn');
                combatTurnElement.appendChild(textElement);
                gameScreen.appendChild(combatTurnElement);
            } else {
                gameScreen.appendChild(textElement);
            }
            
            // Scroll to bottom
            gameScreen.scrollTop = gameScreen.scrollHeight;
            
            // Add to history
            gameHistory.push({text, className, timestamp: new Date()});
            
            // Limit history size
            if (gameHistory.length > 100) {
                gameHistory.shift();
            }
        }
        
        // Execute a command
        function executeCommand(command) {
            if (inCombat && !playerTurn) {
                addGameText("Cannot act during enemy turn!", "damage");
                return;
            }
            
            addGameText(">> " + command);
            
            // Simulate command responses
            switch(command) {
                case 'LOOK':
                    addGameText("You survey the area carefully...");
                    if (inCombat) {
                        addGameText(`${enemies.length} enemies remain.`);
                        enemies.forEach((enemy, i) => {
                            const healthPercent = Math.round((enemy.health / enemy.maxHealth) * 100);
                            addGameText(`${enemy.name} ${i+1}: ${healthPercent}% health`);
                        });
                    } else {
                        addGameText("3 <span class='enemy'>MUTATED COYOTES</span> are circling 50 yards ahead.");
                        addGameText("Broken asphalt and rusted vehicles litter the highway.");
                        addGameText("A glint of metal catches your eye near the overturned car.");
                        addGameText("To the east, a partially collapsed building with an intact door.");
                    }
                    break;
                    
                case 'TAKE':
                    if (inCombat) {
                        addGameText("Cannot search for items during combat!", "damage");
                        break;
                    }
                    addGameText("You search the area...");
                    if (Math.random() > 0.5) {
                        addGameText("You found <span class='item'>5 AMMO</span> and a <span class='item'>RUSTY KNIFE</span>!");
                        player.ammo += 5;
                        updateStatus();
                    } else {
                        addGameText("Nothing useful here.");
                    }
                    break;
                    
                case 'USE':
                    addGameText("Select an item from your inventory to use.");
                    showInventoryModal();
                    break;
                    
                case 'TALK':
                    addGameText("There's no one here to talk to except the coyotes, and they don't seem friendly.");
                    break;
                    
                case 'INV':
                    showInventoryModal();
                    break;
                    
                case 'MAP':
                    showMap();
                    break;
                    
                case 'CHAR':
                    showCharacterModal();
                    break;
                    
                case 'SAVE':
                    saveGame();
                    break;
            }
            
            if (command !== 'INV' && command !== 'CHAR') {
                addGameText(">> <span class='prompt'>_</span>");
            }
        }
        
        // Move in a direction
        function moveDirection(direction) {
            if (inCombat) {
                addGameText("Cannot move while in combat!", "damage");
                return;
            }
            
            addGameText("Moving " + direction + "...");
            
            // Simulate movement outcome
            const locations = {
                N: "MOUNTAIN PASS",
                S: "DESERT WASTES", 
                E: "RUINED BUILDING",
                W: "VEGAS CITY CENTER"
            };
            
            if (locations[direction]) {
                currentLocation = locations[direction];
                addGameText(`You arrive at: <span class="location">${currentLocation}</span>`);
                
                // Location-specific descriptions
                if (direction === 'E') {
                    addGameText("The building appears to be an old pre-war store. The door is slightly ajar.");
                    addGameText("Faint sounds come from inside...");
                } else if (direction === 'W') {
                    addGameText("The ruins of old casinos loom ahead. Radiation levels are elevated.");
                    player.rads += 5;
                    updateStatus();
                }
            } else {
                addGameText("You proceed cautiously through the wasteland.");
            }
            
            // Random encounter chance
            if (direction !== 'WAIT' && Math.random() > 0.6 && !inCombat) {
                setTimeout(() => {
                    triggerRandomEncounter();
                }, 500);
            }
            
            addGameText(">> <span class='prompt'>_</span>");
        }
        
        // Toggle combat mode
        function toggleCombatMode() {
            if (inCombat) {
                addGameText("Cannot exit combat mode while enemies are present!", "damage");
                return;
            }
            
            combatMode = !combatMode;
            
            if (combatMode) {
                combatBtn.innerHTML = "EXIT COMBAT";
                combatBtn.classList.add('combat');
                combatUI.classList.add('active');
                addGameText("<span class='enemy'>COMBAT MODE ENGAGED!</span> Weapons hot.");
            } else {
                combatBtn.innerHTML = "COMBAT MODE";
                combatBtn.classList.remove('combat');
                combatUI.classList.remove('active');
                addGameText("Combat mode disengaged.");
            }
            
            addGameText(">> <span class='prompt'>_</span>");
            updateUIState();
        }
        
        // Trigger random encounter
        function triggerRandomEncounter() {
            if (inCombat) return;
            
            inCombat = true;
            combatMode = true;
            combatBtn.innerHTML = "EXIT COMBAT";
            combatBtn.classList.add('combat');
            combatUI.classList.add('active');
            playerTurn = true;
            
            // Generate enemies
            enemies = [];
            const enemyCount = Math.floor(Math.random() * 3) + 1;
            
            for (let i = 0; i < enemyCount; i++) {
                const enemyTypes = ['coyote', 'raider', 'scorpion'];
                const type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                const enemy = {
                    ...enemyTemplates[type], 
                    id: i,
                    health: enemyTemplates[type].health,
                    maxHealth: enemyTemplates[type].maxHealth
                };
                enemies.push(enemy);
            }
            
            addGameText(`<span class="enemy">COMBAT INITIATED!</span>`, "critical");
            addGameText(`You encounter ${enemies.length} ${enemies.length === 1 ? 'enemy' : 'enemies'}!`);
            
            // Display enemy info
            displayEnemies();
            
            updateUIState();
            addGameText("Your turn. Choose an action.");
        }
        
        // Display enemies in combat
        function displayEnemies() {
            // Remove existing enemy displays
            document.querySelectorAll('.enemy-info').forEach(el => el.remove());
            
            // Add new enemy displays
            enemies.forEach((enemy, index) => {
                const enemyElement = document.createElement('div');
                enemyElement.classList.add('enemy-info');
                enemyElement.innerHTML = `
                    <span class="enemy">${enemy.name} ${index + 1}</span>
                    <div class="enemy-health">
                        <div class="enemy-health-fill" id="enemyHealth${index}" 
                             style="width: ${(enemy.health / enemy.maxHealth) * 100}%"></div>
                    </div>
                `;
                gameScreen.appendChild(enemyElement);
            });
        }
        
        // Show target selection UI
        function showTargetSelection(action) {
            if (enemies.length === 0) return;
            
            currentAction = action;
            isSelectingTarget = true;
            targetSelection.classList.add('active');
            targetButtons.innerHTML = '';
            
            enemies.forEach((enemy, index) => {
                const healthPercent = Math.round((enemy.health / enemy.maxHealth) * 100);
                const btn = document.createElement('button');
                btn.classList.add('target-btn');
                btn.textContent = `${enemy.name} ${index + 1} (${healthPercent}%)`;
                btn.addEventListener('click', () => {
                    selectTarget(index);
                });
                targetButtons.appendChild(btn);
            });
            
            // Add cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.classList.add('target-btn');
            cancelBtn.textContent = "CANCEL";
            cancelBtn.style.backgroundColor = "#333";
            cancelBtn.addEventListener('click', () => {
                cancelTargetSelection();
            });
            targetButtons.appendChild(cancelBtn);
        }
        
        // Select a target
        function selectTarget(enemyIndex) {
            isSelectingTarget = false;
            targetSelection.classList.remove('active');
            
            if (currentAction === 'attack') {
                performAttack(enemyIndex);
            } else if (currentAction === 'aim') {
                performAimedShot(enemyIndex);
            }
            
            currentAction = null;
        }
        
        // Cancel target selection
        function cancelTargetSelection() {
            isSelectingTarget = false;
            targetSelection.classList.remove('active');
            currentAction = null;
            addGameText("Action cancelled.");
        }
        
        // Perform a standard attack
        function performAttack(enemyIndex) {
            if (enemies.length === 0 || enemyIndex >= enemies.length) {
                endCombat();
                return;
            }
            
            const enemy = enemies[enemyIndex];
            
            // Calculate damage
            const weapon = inventory.find(item => item.equipped);
            let damage = 0;
            
            if (weapon && weapon.damage) {
                const [min, max] = weapon.damage.split('-').map(Number);
                damage = Math.floor(Math.random() * (max - min + 1)) + min;
                
                // Skill bonus
                const skillBonus = Math.floor(player.skills.rifles / 10);
                damage += skillBonus;
                
                // Consume ammo if ranged weapon
                if (weapon.ammo !== undefined) {
                    if (weapon.ammo > 0) {
                        weapon.ammo--;
                        player.ammo--;
                        updateStatus();
                    } else {
                        addGameText("Weapon is out of ammo!", "damage");
                        playerTurn = true; // Give player another chance
                        updateUIState();
                        return;
                    }
                }
            } else {
                // Default unarmed damage
                damage = Math.floor(Math.random() * 4) + 2;
            }
            
            // Apply damage
            enemy.health -= damage;
            
            // Update enemy health display
            const enemyHealthBar = document.getElementById(`enemyHealth${enemyIndex}`);
            if (enemyHealthBar) {
                const healthPercent = Math.max(0, (enemy.health / enemy.maxHealth) * 100);
                enemyHealthBar.style.width = `${healthPercent}%`;
                
                if (healthPercent < 30) {
                    enemyHealthBar.style.backgroundColor = '#f00';
                } else if (healthPercent < 60) {
                    enemyHealthBar.style.backgroundColor = '#f80';
                }
            }
            
            addGameText(`You hit ${enemy.name} ${enemyIndex + 1} for <span class="damage">${damage} damage</span>!`);
            
            // Check if enemy is defeated
            if (enemy.health <= 0) {
                addGameText(`<span class="enemy">${enemy.name} ${enemyIndex + 1} is defeated!</span>`);
                enemies.splice(enemyIndex, 1);
                
                // Update display
                displayEnemies();
                
                // Gain karma
                player.karma += 5;
                updateStatus();
            }
            
            // Check if combat is over
            if (enemies.length === 0) {
                endCombat();
                return;
            }
            
            // Switch to enemy turn
            playerTurn = false;
            updateUIState();
            setTimeout(enemyTurn, 1500);
        }
        
        // Perform aimed shot
        function performAimedShot(enemyIndex) {
            if (player.ammo < 5) {
                addGameText("Not enough ammo for aimed shot!", "damage");
                playerTurn = true; // Give player another chance
                updateUIState();
                return;
            }
            
            player.ammo -= 5;
            updateStatus();
            
            if (enemies.length === 0 || enemyIndex >= enemies.length) {
                endCombat();
                return;
            }
            
            const enemy = enemies[enemyIndex];
            
            // Aimed shots do more damage
            const weapon = inventory.find(item => item.equipped);
            const [min, max] = weapon.damage.split('-').map(Number);
            let damage = Math.floor(Math.random() * (max * 2 - min * 2 + 1)) + min * 2;
            
            // Skill bonus (doubled for aimed shot)
            const skillBonus = Math.floor(player.skills.rifles / 10) * 2;
            damage += skillBonus;
            
            // Critical chance
            let isCritical = false;
            if (Math.random() > 0.7) {
                damage *= 2;
                isCritical = true;
            }
            
            enemy.health -= damage;
            
            // Update enemy health display
            const enemyHealthBar = document.getElementById(`enemyHealth${enemyIndex}`);
            if (enemyHealthBar) {
                const healthPercent = Math.max(0, (enemy.health / enemy.maxHealth) * 100);
                enemyHealthBar.style.width = `${healthPercent}%`;
            }
            
            if (isCritical) {
                addGameText(`<span class='critical'>CRITICAL HIT!</span> Aimed shot hits ${enemy.name} ${enemyIndex + 1} for <span class="damage">${damage} damage</span>!`);
            } else {
                addGameText(`Aimed shot hits ${enemy.name} ${enemyIndex + 1} for <span class="damage">${damage} damage</span>!`);
            }
            
            if (enemy.health <= 0) {
                addGameText(`<span class="enemy">${enemy.name} ${enemyIndex + 1} is defeated!</span>`);
                enemies.splice(enemyIndex, 1);
                displayEnemies();
            }
            
            if (enemies.length === 0) {
                endCombat();
                return;
            }
            
            playerTurn = false;
            updateUIState();
            setTimeout(enemyTurn, 1500);
        }
        
        // Perform defend action
        function performDefend() {
            isDefending = true;
            addGameText("You take a defensive stance. Next enemy attack will be reduced.");
            playerTurn = false;
            updateUIState();
            setTimeout(enemyTurn, 1500);
        }
        
        // Attempt to flee
        function attemptFlee() {
            const fleeChance = 60 + player.karma; // Higher karma = better flee chance
            
            if (Math.random() * 100 < fleeChance) {
                addGameText("You successfully flee from combat!", "heal");
                endCombat();
            } else {
                addGameText("Failed to flee! Enemies get a free attack.", "damage");
                playerTurn = false;
                updateUIState();
                setTimeout(enemyTurn, 1500);
            }
        }
        
        // Perform special action
        function performSpecial() {
            addGameText("No special abilities available yet.");
            // Could implement skills/perks here
            // For now, just end turn
            playerTurn = false;
            updateUIState();
            setTimeout(enemyTurn, 1500);
        }
        
        // Enemy turn
        function enemyTurn() {
            if (enemies.length === 0 || player.health <= 0) {
                endCombat();
                return;
            }
            
            addGameText("--- ENEMY TURN ---");
            
            // Each enemy attacks
            enemies.forEach((enemy, index) => {
                if (enemy.health > 0 && player.health > 0) {
                    // Calculate hit chance
                    if (Math.random() * 100 < enemy.accuracy) {
                        const [min, max] = enemy.damage.split('-').map(Number);
                        let damage = Math.floor(Math.random() * (max - min + 1)) + min;
                        
                        // Reduce damage if defending
                        if (isDefending) {
                            damage = Math.max(1, Math.floor(damage * 0.5));
                            addGameText(`[Defense reduces damage!]`);
                        }
                        
                        player.health -= damage;
                        updateStatus();
                        
                        addGameText(`${enemy.name} ${index + 1} hits you for <span class="damage">${damage} damage</span>!`);
                        
                        // Check if player is dead
                        if (player.health <= 0) {
                            player.health = 0;
                            updateStatus();
                            addGameText("<span class='critical'>YOU HAVE BEEN DEFEATED!</span>");
                            endCombat();
                            return;
                        }
                    } else {
                        addGameText(`${enemy.name} ${index + 1} misses!`);
                    }
                }
            });
            
            // Reset defense
            isDefending = false;
            
            // Switch back to player turn
            playerTurn = true;
            updateUIState();
            addGameText("--- YOUR TURN ---");
            addGameText("Choose an action.");
        }
        
        // End combat
        function endCombat() {
            inCombat = false;
            combatMode = false;
            isDefending = false;
            playerTurn = true;
            
            combatBtn.innerHTML = "COMBAT MODE";
            combatBtn.classList.remove('combat');
            combatUI.classList.remove('active');
            
            // Remove enemy displays
            document.querySelectorAll('.enemy-info').forEach(el => el.remove());
            
            if (player.health > 0) {
                addGameText("Combat ended.", "heal");
                
                if (enemies.length === 0) {
                    addGameText("All enemies defeated!", "heal");
                    
                    // Loot chance
                    if (Math.random() > 0.3) {
                        const foundAmmo = Math.floor(Math.random() * 10) + 5;
                        player.ammo += foundAmmo;
                        player.karma += 3;
                        updateStatus();
                        addGameText(`You find <span class='item'>+${foundAmmo} Ammo</span> and <span class='item'>+3 Karma</span> on the bodies.`);
                    }
                } else {
                    addGameText("You escaped from combat.");
                }
            } else {
                addGameText("You have been defeated. Game over.", "critical");
                // Could add respawn logic here
            }
            
            enemies = [];
            updateUIState();
            addGameText(">> <span class='prompt'>_</span>");
        }
        
        // Show inventory modal
        function showInventoryModal() {
            inventoryGrid.innerHTML = '';
            
            inventory.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.classList.add('inventory-item');
                itemElement.innerHTML = `
                    <div class="item-name">${item.name}</div>
                    <div class="item-desc">${item.desc}</div>
                    ${item.damage ? `<div class="item-stats">DMG: ${item.damage}</div>` : ''}
                    ${item.ammo !== undefined ? `<div class="item-stats">Ammo: ${item.ammo}</div>` : ''}
                    ${item.uses !== undefined ? `<div class="item-stats">Uses: ${item.uses}</div>` : ''}
                    ${item.equipped ? `<div class="item-stats">[EQUIPPED]</div>` : ''}
                `;
                
                itemElement.addEventListener('click', () => {
                    useInventoryItem(item, index);
                });
                
                inventoryGrid.appendChild(itemElement);
            });
            
            inventoryModal.style.display = 'block';
        }
        
        // Use inventory item
        function useInventoryItem(item, index) {
            let message = '';
            
            switch(item.type) {
                case 'weapon':
                    if (item.equipped) {
                        message = `${item.name} is already equipped`;
                    } else {
                        // Unequip current weapon
                        inventory.forEach(i => i.equipped = false);
                        item.equipped = true;
                        message = `Equipped ${item.name}`;
                    }
                    break;
                    
                case 'heal':
                    if (item.uses > 0) {
                        if (item.name === 'Medkit') {
                            player.health = Math.min(player.maxHealth, player.health + item.power);
                            message = `Used ${item.name}. Healed ${item.power} HP.`;
                        } else if (item.name === 'RadAway') {
                            player.rads = Math.max(0, player.rads - item.power);
                            message = `Used ${item.name}. Reduced radiation by ${item.power}%.`;
                        }
                        item.uses--;
                        updateStatus();
                        
                        // If in combat, end turn after using healing item
                        if (inCombat) {
                            playerTurn = false;
                            updateUIState();
                            inventoryModal.style.display = 'none';
                            setTimeout(enemyTurn, 1000);
                        }
                    } else {
                        message = `${item.name} has no uses left`;
                    }
                    break;
                    
                case 'water':
                    if (item.uses > 0) {
                        player.water = Math.min(100, player.water + item.power);
                        item.uses--;
                        updateStatus();
                        message = `Drank from ${item.name}. Water increased by ${item.power}%.`;
                        
                        if (inCombat) {
                            playerTurn = false;
                            updateUIState();
                            inventoryModal.style.display = 'none';
                            setTimeout(enemyTurn, 1000);
                        }
                    } else {
                        message = `${item.name} is empty`;
                    }
                    break;
                    
                default:
                    message = `You examine the ${item.name}: ${item.desc}`;
            }
            
            inventoryLog.textContent = message;
            
            // Update inventory display
            showInventoryModal();
        }
        
        // Show character modal
        function showCharacterModal() {
            characterContent.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="color: #ff0; font-size: 16px; margin-bottom: 5px;">${player.name}</div>
                    <div>Rank: Sergeant | Level: ${player.level}</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div style="background-color: #111; padding: 10px; border-radius: 4px;">
                        <div style="color: #ff0; margin-bottom: 5px;">COMBAT SKILLS</div>
                        <div>Rifles: ${player.skills.rifles}%</div>
                        <div>Pistols: ${player.skills.pistols}%</div>
                        <div>Melee: ${player.skills.melee}%</div>
                    </div>
                    
                    <div style="background-color: #111; padding: 10px; border-radius: 4px;">
                        <div style="color: #ff0; margin-bottom: 5px;">SUPPORT SKILLS</div>
                        <div>First Aid: ${player.skills.firstAid}%</div>
                        <div>Demolition: ${player.skills.demolition}%</div>
                        <div>Lockpick: ${player.skills.lockpick}%</div>
                    </div>
                </div>
                
                <div style="background-color: #111; padding: 10px; border-radius: 4px;">
                    <div style="color: #ff0; margin-bottom: 5px;">STATUS EFFECTS</div>
                    <div>Radiation: ${player.rads}% ${player.rads > 30 ? '(DANGER)' : ''}</div>
                    <div>Hydration: ${player.water}% ${player.water < 20 ? '(DEHYDRATED)' : ''}</div>
                    <div>Karma: ${player.karma} ${player.karma > 50 ? '(HERO)' : player.karma < 0 ? '(OUTCAST)' : ''}</div>
                </div>
            `;
            
            characterModal.style.display = 'block';
        }
        
        // Show map
        function showMap() {
            addGameText("=== AREA MAP ===");
            addGameText("N: Mountain Pass [RAD HIGH]");
            addGameText("S: Desert Wastes [SAFE]");
            addGameText("E: Ruined Building [?]");
            addGameText("W: Vegas City Center [RAD MED]");
            addGameText("Your position: " + currentLocation);
            addGameText(">> <span class='prompt'>_</span>");
        }
        
        // Show menu
        function showMenu() {
            addGameText("=== SYSTEM MENU ===");
            addGameText("1. Save Game");
            addGameText("2. Load Game");
            addGameText("3. Game Options");
            addGameText("4. View Manual");
            addGameText("5. Exit to DOS");
            addGameText("Select option or press MENU to close");
        }
        
        // Save game
        function saveGame() {
            addGameText("Saving game to tape...");
            setTimeout(() => {
                addGameText("Game saved successfully to Slot 3.");
                addGameText(">> <span class='prompt'>_</span>");
            }, 800);
        }
        
        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', initGame);
        
        // Prevent context menu on long press
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            return false;
        });
    </script>
</body>
</html>
