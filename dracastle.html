<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dracula's Castle</title>
    <style>
        :root {
            --red: #f00;
            --dark-red: #800;
            --light-red: #f88;
            --blue: #00f;
            --light-blue: #aaf;
            --green: #0f0;
            --dark-green: #0a0;
            --yellow: #ff0;
            --purple: #a0a;
            --black: #000;
            --dark-gray: #222;
            --gray: #444;
            --light-gray: #ccc;
            --white: #fff;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'Times New Roman', serif;
            background-color: var(--black);
            color: var(--white);
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            background: radial-gradient(circle at center, var(--dark-gray), var(--black));
        }
        
        #game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 12px;
            gap: 10px;
        }
        
        #header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border: 2px solid var(--red);
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255,0,0,0.3);
        }
        
        .stat-panel {
            display: flex;
            flex-direction: column;
            background-color: rgba(20, 0, 0, 0.6);
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--dark-red);
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            font-size: 14px;
        }
        
        .stat-name {
            color: var(--light-gray);
        }
        
        .stat-value {
            font-weight: bold;
            color: var(--white);
        }
        
        .bar-container {
            width: 100%;
            height: 14px;
            background-color: var(--dark-gray);
            border: 1px solid var(--gray);
            border-radius: 4px;
            margin: 4px 0;
            overflow: hidden;
        }
        
        .hp-bar {
            height: 100%;
            background: linear-gradient(to right, var(--dark-green), var(--green));
            width: 100%;
        }
        
        .mp-bar {
            height: 100%;
            background: linear-gradient(to right, var(--blue), var(--light-blue));
            width: 100%;
        }
        
        .xp-bar {
            height: 100%;
            background: linear-gradient(to right, var(--purple), var(--yellow));
            width: 0%;
        }
        
        #enemy-hp {
            background: linear-gradient(to right, var(--dark-red), var(--red));
        }
        
        #game-screen {
            flex-grow: 1;
            background-color: rgba(10, 0, 0, 0.8);
            border: 2px solid var(--red);
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            font-size: 16px;
            box-shadow: inset 0 0 15px rgba(255,0,0,0.2);
            line-height: 1.4;
        }
        
        #action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        #combat-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
        }
        
        button {
            padding: 12px 8px;
            font-size: 16px;
            background: var(--red);
            color: var(--white);
            border: 1px solid var(--dark-red);
            border-radius: 8px;
            cursor: pointer;
            text-shadow: 0 1px 2px var(--black);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            font-weight: bold;
            transition: all 0.1s;
            position: relative;
            overflow: hidden;
        }
        
        button:active {
            background: #c00;
            transform: translateY(2px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        button:disabled {
            background: var(--gray);
            color: var(--dark-gray);
            text-shadow: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        button::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        button:active::after {
            opacity: 1;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            padding: 20px;
            z-index: 100;
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: rgba(20, 0, 0, 0.8);
            border: 2px solid var(--red);
            border-radius: 8px;
            padding: 15px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--dark-red);
        }
        
        .close-btn {
            padding: 8px 15px;
            background: var(--red);
            font-size: 14px;
        }
        
        .item-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
        }
        
        .card {
            border: 1px solid var(--dark-red);
            padding: 12px;
            background-color: rgba(30, 0, 0, 0.6);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .card h3 {
            color: var(--light-red);
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .card p {
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--light-gray);
        }
        
        .card button {
            width: 100%;
            margin-top: 8px;
            padding: 8px;
            font-size: 14px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .tab-btn {
            flex: 1;
            padding: 10px;
            background: var(--dark-red);
            border: none;
            color: var(--white);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            background: var(--red);
        }
        
        .tab-btn:first-child {
            border-radius: 8px 0 0 8px;
        }
        
        .tab-btn:last-child {
            border-radius: 0 8px 8px 0;
        }
        
        /* Text styles */
        .location-title {
            color: var(--red);
            font-size: 1.4em;
            margin-bottom: 8px;
            text-shadow: 0 0 8px var(--red);
            font-weight: bold;
        }
        
        .location-description {
            margin-bottom: 12px;
            font-style: italic;
            color: var(--light-gray);
            line-height: 1.4;
        }
        
        .enemy-encounter {
            color: var(--red);
            font-weight: bold;
            margin: 12px 0;
            text-shadow: 0 0 5px var(--red);
            font-size: 1.1em;
        }
        
        .combat-log {
            margin-bottom: 8px;
            padding: 6px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        
        .player-action {
            color: var(--light-blue);
            font-weight: bold;
        }
        
        .enemy-action {
            color: var(--light-red);
            font-weight: bold;
        }
        
        .damage {
            color: var(--red);
        }
        
        .heal {
            color: var(--green);
        }
        
        .magic {
            color: var(--light-blue);
        }
        
        .gold {
            color: var(--yellow);
        }
        
        .xp {
            color: var(--purple);
        }
        
        .rare {
            color: var(--yellow);
            font-weight: bold;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 0.5s ease-in-out;
        }
        
        /* Responsive adjustments */
        @media (max-height: 700px) {
            #game-container {
                padding: 8px;
            }
            
            button {
                padding: 10px 6px;
                font-size: 14px;
            }
            
            .card {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="header">
            <div class="stat-panel" id="player-stats">
                <div class="stat-row">
                    <span class="stat-name">Player</span>
                    <span class="stat-value">Lvl <span id="player-level">1</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">HP:</span>
                    <span class="stat-value"><span id="player-hp-text">100</span>/<span id="player-max-hp">100</span></span>
                </div>
                <div class="bar-container">
                    <div class="hp-bar" id="player-hp"></div>
                </div>
                <div class="stat-row">
                    <span class="stat-name">MP:</span>
                    <span class="stat-value"><span id="player-mp-text">20</span>/<span id="player-max-mp">20</span></span>
                </div>
                <div class="bar-container">
                    <div class="mp-bar" id="player-mp"></div>
                </div>
                <div class="stat-row">
                    <span class="stat-name">XP:</span>
                    <span class="stat-value"><span id="player-xp">0</span>/<span id="player-next-xp">100</span></span>
                </div>
                <div class="bar-container">
                    <div class="xp-bar" id="player-xp-bar"></div>
                </div>
            </div>
            <div class="stat-panel" id="enemy-stats">
                <div class="stat-row">
                    <span class="stat-name" id="enemy-name"></span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">HP:</span>
                    <span class="stat-value" id="enemy-hp-text"></span>
                </div>
                <div class="bar-container">
                    <div class="hp-bar" id="enemy-hp"></div>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Weapon:</span>
                    <span class="stat-value" id="enemy-weapon"></span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Gold:</span>
                    <span class="stat-value gold" id="player-gold">10</span>
                </div>
            </div>
        </div>
        
        <div id="game-screen">
            <div class="location-title">Castle Gate</div>
            <div class="location-description">The massive iron gates stand before you, slightly ajar. Beyond lies the courtyard of Dracula's castle.</div>
            <div class="combat-log">Welcome to Dracula's Castle! The ancient fortress looms before you, its crumbling towers piercing the stormy sky. You must navigate through the castle, defeat its monstrous inhabitants, and ultimately face Dracula himself.</div>
            <div class="combat-log">You stand before the castle gates. The heavy iron doors creak ominously in the wind.</div>
        </div>
        
        <div id="action-buttons">
            <button id="look-button">Look Around</button>
            <button id="move-button">Move</button>
            <button id="talk-button" disabled>Talk</button>
            <button id="take-button" disabled>Take</button>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                <button id="map-button">Map</button>
                <button id="journal-button">Journal</button>
            </div>
        </div>
        
        <div id="combat-buttons">
            <button id="fight-button" disabled>Fight</button>
            <button id="magic-button">Magic</button>
            <button id="inventory-button">Inventory</button>
            <button id="flee-button" disabled>Flee</button>
        </div>
    </div>
    
    <!-- Inventory Modal -->
    <div id="inventory" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Inventory</h2>
                <button class="close-btn" id="close-inventory">Close</button>
            </div>
            <div class="tab-buttons">
                <button class="tab-btn active" id="items-tab">Items</button>
                <button class="tab-btn" id="weapons-tab">Weapons</button>
                <button class="tab-btn" id="key-items-tab">Key Items</button>
            </div>
            <div id="inventory-items" class="item-grid">
                <!-- Items will be added here dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Spellbook Modal -->
    <div id="spellbook" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Spellbook</h2>
                <button class="close-btn" id="close-spellbook">Close</button>
            </div>
            <div id="spells-list" class="item-grid">
                <!-- Spells will be added here dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Map Modal -->
    <div id="map-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Castle Map</h2>
                <button class="close-btn" id="close-map">Close</button>
            </div>
            <div id="map-display">
                <!-- Map will be rendered here -->
            </div>
        </div>
    </div>
    
    <!-- Journal Modal -->
    <div id="journal-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Adventure Journal</h2>
                <button class="close-btn" id="close-journal">Close</button>
            </div>
            <div id="journal-entries">
                <!-- Journal entries will be added here -->
            </div>
        </div>
    </div>
    
    <script>
        // Game state
        const gameState = {
            player: {
                name: "Van Helsing",
                hp: 100,
                maxHp: 100,
                mp: 20,
                maxMp: 20,
                weapon: { 
                    name: "Fists", 
                    damage: 2,
                    description: "Your bare hands - better than nothing"
                },
                armor: null,
                gold: 10,
                inventory: [
                    { 
                        name: "Health Potion", 
                        type: "consumable", 
                        effect: "heal", 
                        value: 20, 
                        description: "Restores 20 HP", 
                        price: 10,
                        rarity: "common"
                    },
                    { 
                        name: "Mana Potion", 
                        type: "consumable", 
                        effect: "restoreMP", 
                        value: 15, 
                        description: "Restores 15 MP", 
                        price: 15,
                        rarity: "common"
                    },
                    { 
                        name: "Rusty Dagger", 
                        type: "weapon", 
                        damage: 4, 
                        description: "A basic weapon for self-defense", 
                        price: 15,
                        rarity: "common"
                    }
                ],
                spells: [
                    { 
                        name: "Fire Bolt", 
                        type: "offensive", 
                        cost: 5, 
                        damage: 8, 
                        description: "Hurls a bolt of fire at the enemy",
                        element: "fire",
                        unlocked: true,
                        level: 1
                    }
                ],
                level: 1,
                xp: 0,
                nextLevelXp: 100,
                spellSlots: 2,
                knownSpells: 1,
                perks: [],
                journal: [
                    "Entered Dracula's Castle through the main gate",
                    "The castle seems abandoned but I sense dark presences"
                ]
            },
            currentEnemy: null,
            inCombat: false,
            currentLocation: "gate",
            gameTime: 0,
            defeatedEnemies: [],
            discoveredLocations: ["gate"],
            locations: {
                gate: {
                    name: "Castle Gate",
                    description: "The massive iron gates stand before you, slightly ajar. Beyond lies the courtyard of Dracula's castle.",
                    items: [],
                    enemies: [],
                    connections: ["courtyard"],
                    visited: true,
                    npc: null,
                    explored: true
                },
                courtyard: {
                    name: "Courtyard",
                    description: "A crumbling courtyard overgrown with thorny vines. The moonlight casts eerie shadows through the skeletal trees.",
                    items: [
                        { 
                            name: "Silver Cross", 
                            type: "item", 
                            description: "A blessed silver cross that might protect against evil", 
                            effect: "fearReduction", 
                            price: 25,
                            rarity: "uncommon"
                        },
                        { 
                            name: "Scroll of Magic Missile", 
                            type: "spell", 
                            spell: "Magic Missile", 
                            description: "Teaches the Magic Missile spell", 
                            price: 40,
                            rarity: "rare"
                        }
                    ],
                    enemies: ["zombie"],
                    connections: ["gate", "greatHall"],
                    visited: false,
                    npc: {
                        name: "Wandering Merchant",
                        dialogue: ["Care to browse my wares, traveler?", "The castle gets more dangerous the further you go.", "I wouldn't go in there if I were you..."],
                        trade: ["Health Potion", "Mana Potion", "Silver Dagger", "Scroll of Magic Missile"],
                        attitude: "neutral"
                    },
                    explored: false
                },
                greatHall: {
                    name: "Great Hall",
                    description: "A vast hall with a broken chandelier and tattered banners. The air smells of dust and decay.",
                    items: [
                        { 
                            name: "Steel Sword", 
                            type: "weapon", 
                            damage: 8, 
                            description: "A well-balanced sword that deals decent damage", 
                            price: 40,
                            rarity: "uncommon"
                        },
                        { 
                            name: "Scroll of Fireball", 
                            type: "spell", 
                            spell: "Fireball", 
                            description: "Teaches the Fireball spell", 
                            price: 60,
                            rarity: "rare"
                        }
                    ],
                    enemies: ["ghost"],
                    connections: ["courtyard", "diningHall", "library"],
                    visited: false,
                    npc: null,
                    explored: false
                },
                diningHall: {
                    name: "Dining Hall",
                    description: "A long table set with rotten food and tarnished silverware. Rats scurry away as you enter.",
                    items: [
                        { 
                            name: "Health Potion", 
                            type: "consumable", 
                            effect: "heal", 
                            value: 20, 
                            description: "Restores 20 HP", 
                            price: 10,
                            rarity: "common"
                        },
                        { 
                            name: "Silver Plate", 
                            type: "item", 
                            description: "A valuable silver serving plate", 
                            price: 30,
                            rarity: "uncommon"
                        }
                    ],
                    enemies: ["giantBat"],
                    connections: ["greatHall", "kitchen"],
                    visited: false,
                    npc: null,
                    explored: false
                },
                library: {
                    name: "Library",
                    description: "Floor-to-ceiling bookshelves filled with ancient tomes. Some books float in mid-air, pages turning by themselves.",
                    items: [
                        { 
                            name: "Magic Tome", 
                            type: "item", 
                            description: "Contains knowledge that might be useful against Dracula", 
                            price: 50,
                            rarity: "rare"
                        },
                        { 
                            name: "Scroll of Lightning", 
                            type: "spell", 
                            spell: "Lightning", 
                            description: "Teaches the Lightning spell", 
                            price: 75,
                            rarity: "rare"
                        }
                    ],
                    enemies: [],
                    connections: ["greatHall", "towerStairs"],
                    visited: false,
                    npc: {
                        name: "Mad Librarian",
                        dialogue: ["The master... he waits in the tower...", "The books... they whisper terrible things...", "Leave this place while you still can!"],
                        trade: ["Health Potion", "Magic Tome", "Scroll of Lightning"],
                        attitude: "fearful"
                    },
                    explored: false
                },
                kitchen: {
                    name: "Kitchen",
                    description: "A filthy kitchen with rusted implements. A cauldron bubbles with some unidentifiable substance.",
                    items: [
                        { 
                            name: "Meat Cleaver", 
                            type: "weapon", 
                            damage: 6, 
                            description: "Heavy and sharp, but unwieldy", 
                            price: 30,
                            rarity: "common"
                        },
                        { 
                            name: "Mystery Stew", 
                            type: "consumable", 
                            effect: "random", 
                            description: "Who knows what this will do?", 
                            price: 5,
                            rarity: "uncommon"
                        }
                    ],
                    enemies: ["swarmOfRats"],
                    connections: ["diningHall"],
                    visited: false,
                    npc: null,
                    explored: false
                },
                towerStairs: {
                    name: "Tower Stairs",
                    description: "A spiraling staircase leading up into darkness. The stones are slick with something dark and sticky.",
                    items: [
                        { 
                            name: "Scroll of Vampiric Drain", 
                            type: "spell", 
                            spell: "Vampiric Drain", 
                            description: "Teaches the Vampiric Drain spell", 
                            price: 100,
                            rarity: "rare"
                        }
                    ],
                    enemies: ["vampireSpawn"],
                    connections: ["library", "throneRoom"],
                    visited: false,
                    npc: null,
                    explored: false
                },
                throneRoom: {
                    name: "Throne Room",
                    description: "A grand chamber with a massive throne of black stone. The air hums with dark energy.",
                    items: [
                        { 
                            name: "Holy Water", 
                            type: "consumable", 
                            effect: "damage", 
                            value: 30, 
                            description: "Deals 30 damage to undead", 
                            target: "enemy", 
                            price: 30,
                            rarity: "uncommon"
                        },
                        { 
                            name: "Scroll of Divine Smite", 
                            type: "spell", 
                            spell: "Divine Smite", 
                            description: "Teaches the Divine Smite spell", 
                            price: 150,
                            rarity: "epic"
                        }
                    ],
                    enemies: ["dracula"],
                    connections: ["towerStairs"],
                    visited: false,
                    npc: null,
                    explored: false
                }
            },
            enemies: {
                zombie: {
                    name: "Zombie",
                    hp: 30,
                    maxHp: 30,
                    weapon: { name: "Rotten Fists", damage: 3 },
                    description: "A shambling corpse with glowing red eyes and a hunger for flesh.",
                    deathMessage: "The zombie collapses into a pile of bones and rotting flesh.",
                    xp: 20,
                    gold: 5,
                    weakTo: ["fire", "holy"],
                    resistantTo: ["poison"],
                    loot: [
                        { item: "Rotting Flesh", chance: 0.5 },
                        { item: "Tattered Cloth", chance: 0.3 }
                    ]
                },
                ghost: {
                    name: "Restless Ghost",
                    hp: 25,
                    maxHp: 25,
                    weapon: { name: "Ethereal Touch", damage: 5 },
                    description: "A translucent figure that wails mournfully as it attacks.",
                    deathMessage: "The ghost lets out a final sigh as it fades from existence.",
                    xp: 30,
                    gold: 8,
                    weakTo: ["holy", "lightning"],
                    resistantTo: ["physical"],
                    loot: [
                        { item: "Ectoplasm", chance: 0.4 },
                        { item: "Haunted Locket", chance: 0.2 }
                    ]
                },
                giantBat: {
                    name: "Giant Bat",
                    hp: 20,
                    maxHp: 20,
                    weapon: { name: "Sharp Fangs", damage: 4 },
                    description: "A bat the size of a large dog, with glowing eyes and leathery wings.",
                    deathMessage: "The bat screeches as it crashes to the ground.",
                    xp: 15,
                    gold: 3,
                    weakTo: ["lightning", "fire"],
                    resistantTo: [],
                    loot: [
                        { item: "Bat Wing", chance: 0.6 },
                        { item: "Fang", chance: 0.4 }
                    ]
                },
                swarmOfRats: {
                    name: "Swarm of Rats",
                    hp: 15,
                    maxHp: 15,
                    weapon: { name: "Gnawing Teeth", damage: 2 },
                    description: "Dozens of large, aggressive rats that attack in a frenzy.",
                    deathMessage: "The rats scatter, leaving behind their dead and dying.",
                    xp: 10,
                    gold: 2,
                    weakTo: ["fire"],
                    resistantTo: [],
                    loot: [
                        { item: "Rat Tail", chance: 0.8 },
                        { item: "Diseased Fur", chance: 0.3 }
                    ]
                },
                vampireSpawn: {
                    name: "Vampire Spawn",
                    hp: 40,
                    maxHp: 40,
                    weapon: { name: "Vampiric Claws", damage: 7 },
                    description: "A pale, fanged creature with inhuman speed and strength.",
                    deathMessage: "The vampire spawn bursts into flames and crumbles to ash.",
                    xp: 50,
                    gold: 15,
                    weakTo: ["holy", "fire"],
                    resistantTo: ["dark"],
                    loot: [
                        { item: "Vampire Fang", chance: 0.5 },
                        { item: "Dark Essence", chance: 0.3 }
                    ]
                },
                dracula: {
                    name: "Dracula",
                    hp: 100,
                    maxHp: 100,
                    weapon: { name: "Dark Magic", damage: 10 },
                    description: "The lord of the castle, his eyes burning with centuries of malice.",
                    deathMessage: "Dracula lets out an unearthly scream as his body turns to dust. The castle trembles as his curse is broken!",
                    xp: 200,
                    gold: 100,
                    weakTo: ["holy"],
                    resistantTo: ["dark", "physical"],
                    loot: [
                        { item: "Dracula's Ring", chance: 1.0 },
                        { item: "Ancient Tome", chance: 0.5 }
                    ]
                }
            },
            spellDatabase: {
                "Magic Missile": {
                    name: "Magic Missile",
                    type: "offensive",
                    cost: 3,
                    damage: 6,
                    description: "Fires a bolt of pure magical energy that never misses",
                    element: "arcane",
                    level: 1
                },
                "Fireball": {
                    name: "Fireball",
                    type: "offensive",
                    cost: 8,
                    damage: 12,
                    description: "Hurls an explosive ball of fire at enemies",
                    element: "fire",
                    level: 2
                },
                "Lightning": {
                    name: "Lightning",
                    type: "offensive",
                    cost: 7,
                    damage: 10,
                    description: "Strikes the enemy with a bolt of lightning",
                    element: "lightning",
                    level: 2
                },
                "Vampiric Drain": {
                    name: "Vampiric Drain",
                    type: "drain",
                    cost: 10,
                    damage: 8,
                    heal: 4,
                    description: "Drains life from the enemy to heal yourself",
                    element: "dark",
                    level: 3
                },
                "Divine Smite": {
                    name: "Divine Smite",
                    type: "offensive",
                    cost: 15,
                    damage: 20,
                    description: "Calls upon divine power to smite undead foes",
                    element: "holy",
                    level: 4
                },
                "Cure Wounds": {
                    name: "Cure Wounds",
                    type: "healing",
                    cost: 6,
                    heal: 15,
                    description: "Heals your wounds with magical energy",
                    element: "holy",
                    level: 1
                },
                "Shadow Bolt": {
                    name: "Shadow Bolt",
                    type: "offensive",
                    cost: 5,
                    damage: 9,
                    description: "Hurls a bolt of dark energy at the enemy",
                    element: "dark",
                    level: 2
                }
            },
            itemDatabase: {
                "Health Potion": { 
                    name: "Health Potion", 
                    type: "consumable", 
                    effect: "heal", 
                    value: 20, 
                    description: "Restores 20 HP", 
                    price: 10,
                    rarity: "common"
                },
                "Mana Potion": { 
                    name: "Mana Potion", 
                    type: "consumable", 
                    effect: "restoreMP", 
                    value: 15, 
                    description: "Restores 15 MP", 
                    price: 15,
                    rarity: "common"
                },
                "Silver Dagger": { 
                    name: "Silver Dagger", 
                    type: "weapon", 
                    damage: 5, 
                    description: "Effective against undead", 
                    price: 25,
                    rarity: "uncommon"
                },
                "Steel Sword": { 
                    name: "Steel Sword", 
                    type: "weapon", 
                    damage: 8, 
                    description: "A well-balanced sword", 
                    price: 40,
                    rarity: "uncommon"
                },
                "Holy Water": { 
                    name: "Holy Water", 
                    type: "consumable", 
                    effect: "damage", 
                    value: 30, 
                    description: "Deals 30 damage to undead", 
                    price: 30,
                    rarity: "uncommon"
                },
                "Dracula's Ring": {
                    name: "Dracula's Ring",
                    type: "item",
                    description: "A powerful artifact once worn by the vampire lord",
                    price: 500,
                    rarity: "legendary"
                }
            },
            mapData: {
                "gate": { x: 50, y: 90, connections: ["courtyard"] },
                "courtyard": { x: 50, y: 70, connections: ["gate", "greatHall"] },
                "greatHall": { x: 50, y: 50, connections: ["courtyard", "diningHall", "library"] },
                "diningHall": { x: 30, y: 50, connections: ["greatHall", "kitchen"] },
                "kitchen": { x: 20, y: 50, connections: ["diningHall"] },
                "library": { x: 70, y: 50, connections: ["greatHall", "towerStairs"] },
                "towerStairs": { x: 70, y: 30, connections: ["library", "throneRoom"] },
                "throneRoom": { x: 70, y: 10, connections: ["towerStairs"] }
            }
        };

        // DOM elements
        const gameScreen = document.getElementById("game-screen");
        const playerHpText = document.getElementById("player-hp-text");
        const playerMaxHpText = document.getElementById("player-max-hp");
        const playerHpBar = document.getElementById("player-hp");
        const playerMpText = document.getElementById("player-mp-text");
        const playerMaxMpText = document.getElementById("player-max-mp");
        const playerMpBar = document.getElementById("player-mp");
        const playerLevel = document.getElementById("player-level");
        const playerXp = document.getElementById("player-xp");
        const playerNextXp = document.getElementById("player-next-xp");
        const playerXpBar = document.getElementById("player-xp-bar");
        const playerGold = document.getElementById("player-gold");
        const enemyName = document.getElementById("enemy-name");
        const enemyHpText = document.getElementById("enemy-hp-text");
        const enemyHpBar = document.getElementById("enemy-hp");
        const enemyWeapon = document.getElementById("enemy-weapon");
        const lookButton = document.getElementById("look-button");
        const moveButton = document.getElementById("move-button");
        const talkButton = document.getElementById("talk-button");
        const takeButton = document.getElementById("take-button");
        const fightButton = document.getElementById("fight-button");
        const magicButton = document.getElementById("magic-button");
        const inventoryButton = document.getElementById("inventory-button");
        const fleeButton = document.getElementById("flee-button");
        const inventory = document.getElementById("inventory");
        const inventoryItems = document.getElementById("inventory-items");
        const closeInventory = document.getElementById("close-inventory");
        const spellbook = document.getElementById("spellbook");
        const spellsList = document.getElementById("spells-list");
        const closeSpellbook = document.getElementById("close-spellbook");
        const mapModal = document.getElementById("map-modal");
        const mapDisplay = document.getElementById("map-display");
        const closeMap = document.getElementById("close-map");
        const journalModal = document.getElementById("journal-modal");
        const journalEntries = document.getElementById("journal-entries");
        const closeJournal = document.getElementById("close-journal");
        const itemsTab = document.getElementById("items-tab");
        const weaponsTab = document.getElementById("weapons-tab");
        const keyItemsTab = document.getElementById("key-items-tab");
        const mapButton = document.getElementById("map-button");
        const journalButton = document.getElementById("journal-button");

        // Game functions
        function updateUI() {
            // Update player stats
            playerHpText.textContent = gameState.player.hp;
            playerMaxHpText.textContent = gameState.player.maxHp;
            playerHpBar.style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
            playerMpText.textContent = gameState.player.mp;
            playerMaxMpText.textContent = gameState.player.maxMp;
            playerMpBar.style.width = `${(gameState.player.mp / gameState.player.maxMp) * 100}%`;
            playerLevel.textContent = gameState.player.level;
            playerXp.textContent = gameState.player.xp;
            playerNextXp.textContent = gameState.player.nextLevelXp;
            playerXpBar.style.width = `${(gameState.player.xp / gameState.player.nextLevelXp) * 100}%`;
            playerGold.textContent = gameState.player.gold;
            
            // Update location info
            const location = gameState.locations[gameState.currentLocation];
            document.querySelector(".location-title").textContent = location.name;
            document.querySelector(".location-description").textContent = location.description;
            
            // Update enemy stats if in combat
            if (gameState.inCombat) {
                enemyName.textContent = gameState.currentEnemy.name;
                enemyHpText.textContent = `${gameState.currentEnemy.hp}/${gameState.currentEnemy.maxHp}`;
                enemyHpBar.style.width = `${(gameState.currentEnemy.hp / gameState.currentEnemy.maxHp) * 100}%`;
                enemyWeapon.textContent = `${gameState.currentEnemy.weapon.name} (${gameState.currentEnemy.weapon.damage} DMG)`;
                
                // Show enemy stats
                document.getElementById("enemy-stats").style.display = "flex";
                
                // Enable combat buttons
                fightButton.disabled = false;
                fleeButton.disabled = false;
                talkButton.disabled = true;
                takeButton.disabled = true;
            } else {
                // Hide enemy stats
                document.getElementById("enemy-stats").style.display = "none";
                
                // Disable combat buttons
                fightButton.disabled = true;
                fleeButton.disabled = true;
                
                // Check if there's an NPC to talk to
                if (location.npc) {
                    talkButton.disabled = false;
                } else {
                    talkButton.disabled = true;
                }
                
                // Check if there are items to take
                if (location.items.length > 0) {
                    takeButton.disabled = false;
                } else {
                    takeButton.disabled = true;
                }
            }
        }

        function addToGameScreen(text, className = "") {
            const div = document.createElement("div");
            div.className = "combat-log" + (className ? " " + className : "");
            div.textContent = text;
            div.style.animation = "fadeIn 0.3s ease-in";
            gameScreen.appendChild(div);
            gameScreen.scrollTop = gameScreen.scrollHeight;
        }

        function clearGameScreen() {
            // Keep the location title and description
            while (gameScreen.children.length > 2) {
                gameScreen.removeChild(gameScreen.lastChild);
            }
        }

        function lookAround() {
            clearGameScreen();
            const location = gameState.locations[gameState.currentLocation];
            
            if (!location.visited) {
                addToGameScreen("This place is new to you.");
                location.visited = true;
                
                // Add to discovered locations if not already there
                if (!gameState.discoveredLocations.includes(gameState.currentLocation)) {
                    gameState.discoveredLocations.push(gameState.currentLocation);
                }
                
                // Add to journal
                addJournalEntry(`Discovered the ${location.name}`);
            }
            
            if (location.enemies.length > 0 && !gameState.inCombat) {
                const enemyType = location.enemies[0];
                const enemy = gameState.enemies[enemyType];
                addToGameScreen(`A ${enemy.name} appears!`, "enemy-encounter");
                addToGameScreen(enemy.description, "combat-log");
                startCombat(enemyType);
            }
            
            if (location.items.length > 0) {
                addToGameScreen("You see the following items:");
                location.items.forEach(item => {
                    const rarityClass = item.rarity === "rare" || item.rarity === "epic" || item.rarity === "legendary" ? "rare" : "";
                    addToGameScreen(`- ${item.name}: ${item.description}`, rarityClass);
                });
            }
            
            // Mark location as explored
            location.explored = true;
            
            updateUI();
        }

        function move() {
            const location = gameState.locations[gameState.currentLocation];
            
            if (gameState.inCombat) {
                addToGameScreen("You can't move while in combat!", "combat-log");
                return;
            }
            
            clearGameScreen();
            
            if (location.connections.length === 1) {
                // Only one way to go
                gameState.currentLocation = location.connections[0];
                addToGameScreen(`You move to the ${gameState.locations[gameState.currentLocation].name}.`);
                addJournalEntry(`Moved to ${gameState.locations[gameState.currentLocation].name}`);
                lookAround();
            } else {
                // Multiple paths
                addToGameScreen("Where would you like to go?");
                location.connections.forEach(conn => {
                    const btn = document.createElement("button");
                    btn.textContent = gameState.locations[conn].name;
                    btn.onclick = function() {
                        gameState.currentLocation = conn;
                        addToGameScreen(`You move to the ${gameState.locations[gameState.currentLocation].name}.`);
                        addJournalEntry(`Moved to ${gameState.locations[gameState.currentLocation].name}`);
                        gameScreen.removeChild(btn);
                        lookAround();
                        updateUI();
                    };
                    gameScreen.appendChild(btn);
                });
            }
        }

        function talk() {
            const location = gameState.locations[gameState.currentLocation];
            
            if (gameState.inCombat) {
                addToGameScreen("The enemy isn't interested in talking!", "combat-log");
                return;
            }
            
            clearGameScreen();
            
            if (location.npc) {
                const npc = location.npc;
                const randomDialogue = npc.dialogue[Math.floor(Math.random() * npc.dialogue.length)];
                addToGameScreen(`${npc.name} says: "${randomDialogue}"`);
                addJournalEntry(`Talked to ${npc.name}: "${randomDialogue}"`);
                
                if (npc.trade && npc.trade.length > 0) {
                    addToGameScreen(`${npc.name} offers to trade:`);
                    npc.trade.forEach(itemName => {
                        const item = gameState.itemDatabase[itemName] || gameState.spellDatabase[itemName.replace("Scroll of ", "")];
                        const btn = document.createElement("button");
                        btn.textContent = `${item.name} - ${item.price} gold`;
                        btn.onclick = function() {
                            if (gameState.player.gold >= item.price) {
                                gameState.player.gold -= item.price;
                                
                                if (itemName.startsWith("Scroll of ")) {
                                    const spellName = itemName.replace("Scroll of ", "");
                                    if (!gameState.player.spells.some(s => s.name === spellName)) {
                                        const newSpell = JSON.parse(JSON.stringify(gameState.spellDatabase[spellName]));
                                        newSpell.unlocked = true;
                                        gameState.player.spells.push(newSpell);
                                        gameState.player.knownSpells++;
                                        addToGameScreen(`You learned the ${spellName} spell!`, "magic");
                                        addJournalEntry(`Learned new spell: ${spellName}`);
                                    } else {
                                        addToGameScreen(`You already know ${spellName}.`, "combat-log");
                                    }
                                } else {
                                    gameState.player.inventory.push(JSON.parse(JSON.stringify(item)));
                                    addToGameScreen(`You obtained ${item.name}.`, "player-action");
                                }
                                
                                addToGameScreen(`You bought ${item.name} for ${item.price} gold.`, "gold");
                                updateUI();
                            } else {
                                addToGameScreen("You don't have enough gold!", "combat-log");
                            }
                        };
                        gameScreen.appendChild(btn);
                    });
                }
            } else {
                addToGameScreen("There's no one here to talk to.");
            }
        }

        function takeItem() {
            const location = gameState.locations[gameState.currentLocation];
            
            if (gameState.inCombat) {
                addToGameScreen("You can't take items while in combat!", "combat-log");
                return;
            }
            
            clearGameScreen();
            
            if (location.items.length > 0) {
                const item = location.items[0]; // Take first item
                
                if (item.type === "spell") {
                    // Check if player already knows the spell
                    const spellName = item.spell;
                    if (!gameState.player.spells.some(s => s.name === spellName)) {
                        const newSpell = JSON.parse(JSON.stringify(gameState.spellDatabase[spellName]));
                        newSpell.unlocked = true;
                        gameState.player.spells.push(newSpell);
                        gameState.player.knownSpells++;
                        addToGameScreen(`You learned the ${spellName} spell!`, "magic");
                        addJournalEntry(`Learned new spell: ${spellName}`);
                    } else {
                        addToGameScreen(`You already know ${spellName}.`, "combat-log");
                    }
                } else {
                    gameState.player.inventory.push(item);
                    addToGameScreen(`You took the ${item.name}.`, "player-action");
                    addJournalEntry(`Found item: ${item.name}`);
                }
                
                location.items.splice(0, 1);
                
                if (item.type === "weapon" && item.damage > gameState.player.weapon.damage) {
                    addToGameScreen(`Would you like to equip the ${item.name}?`);
                    const equipBtn = document.createElement("button");
                    equipBtn.textContent = `Equip ${item.name}`;
                    equipBtn.onclick = function() {
                        gameState.player.weapon = item;
                        addToGameScreen(`You equipped the ${item.name}.`, "player-action");
                        addJournalEntry(`Equipped new weapon: ${item.name}`);
                        gameScreen.removeChild(equipBtn);
                        updateUI();
                    };
                    gameScreen.appendChild(equipBtn);
                }
            } else {
                addToGameScreen("There are no items to take here.");
            }
            
            updateUI();
        }

        function startCombat(enemyType) {
            gameState.inCombat = true;
            gameState.currentEnemy = JSON.parse(JSON.stringify(gameState.enemies[enemyType]));
            addJournalEntry(`Encountered a ${gameState.currentEnemy.name}`);
            updateUI();
        }

        function endCombat(victory) {
            const location = gameState.locations[gameState.currentLocation];
            
            if (victory) {
                addToGameScreen(gameState.currentEnemy.deathMessage, "combat-log");
                addJournalEntry(`Defeated a ${gameState.currentEnemy.name}`);
                
                // Reward player
                gameState.player.gold += gameState.currentEnemy.gold;
                gameState.player.xp += gameState.currentEnemy.xp;
                addToGameScreen(`You gained ${gameState.currentEnemy.xp} XP and found ${gameState.currentEnemy.gold} gold!`, "xp");
                
                // Check for loot
                gameState.currentEnemy.loot.forEach(loot => {
                    if (Math.random() < loot.chance) {
                        const lootItem = gameState.itemDatabase[loot.item] || { 
                            name: loot.item, 
                            type: "item", 
                            description: "A mysterious item", 
                            price: 10 
                        };
                        gameState.player.inventory.push(lootItem);
                        addToGameScreen(`The enemy dropped ${lootItem.name}!`, "player-action");
                    }
                });
                
                // Track defeated enemies
                if (!gameState.defeatedEnemies.includes(gameState.currentEnemy.name)) {
                    gameState.defeatedEnemies.push(gameState.currentEnemy.name);
                }
                
                // Check for level up
                checkLevelUp();
                
                // Remove enemy from location
                if (location.enemies.length > 0) {
                    location.enemies.splice(0, 1);
                }
                
                // Check if player defeated Dracula
                if (gameState.currentEnemy.name === "Dracula") {
                    addToGameScreen("CONGRATULATIONS! You have defeated Dracula and broken his curse!", "heal");
                    addToGameScreen("The castle begins to crumble as you make your escape. You are victorious!", "heal");
                    addJournalEntry("DEFEATED DRACULA AND COMPLETED THE QUEST!");
                    // Game over - player won
                    fightButton.disabled = true;
                    fleeButton.disabled = true;
                    return;
                }
            } else {
                addToGameScreen("You managed to escape from the enemy!", "combat-log");
                addJournalEntry(`Fled from a ${gameState.currentEnemy.name}`);
            }
            
            gameState.inCombat = false;
            gameState.currentEnemy = null;
            updateUI();
        }

        function checkLevelUp() {
            if (gameState.player.xp >= gameState.player.nextLevelXp) {
                gameState.player.level++;
                const prevMaxHp = gameState.player.maxHp;
                const prevMaxMp = gameState.player.maxMp;
                
                gameState.player.xp -= gameState.player.nextLevelXp;
                gameState.player.nextLevelXp = Math.floor(gameState.player.nextLevelXp * 1.5);
                gameState.player.maxHp += 10 + Math.floor(gameState.player.level / 2);
                gameState.player.hp = gameState.player.maxHp;
                gameState.player.maxMp += 5 + Math.floor(gameState.player.level / 3);
                gameState.player.mp = gameState.player.maxMp;
                
                addToGameScreen(`LEVEL UP! You are now level ${gameState.player.level}!`, "heal");
                addToGameScreen(`Your maximum HP increased from ${prevMaxHp} to ${gameState.player.maxHp}.`, "heal");
                addToGameScreen(`Your maximum MP increased from ${prevMaxMp} to ${gameState.player.maxMp}.`, "magic");
                addJournalEntry(`Reached level ${gameState.player.level}`);
                
                // Check for new spell slots every 3 levels
                if (gameState.player.level % 3 === 0) {
                    gameState.player.spellSlots++;
                    addToGameScreen(`You gained an additional spell slot! (Total: ${gameState.player.spellSlots})`, "magic");
                }
                
                // Check for new spells at certain levels
                if (gameState.player.level === 2 && !gameState.player.spells.some(s => s.name === "Cure Wounds")) {
                    const newSpell = JSON.parse(JSON.stringify(gameState.spellDatabase["Cure Wounds"]));
                    newSpell.unlocked = true;
                    gameState.player.spells.push(newSpell);
                    gameState.player.knownSpells++;
                    addToGameScreen("You learned a new spell: Cure Wounds!", "magic");
                    addJournalEntry("Learned new spell: Cure Wounds");
                }
                
                if (gameState.player.level === 4 && !gameState.player.spells.some(s => s.name === "Shadow Bolt")) {
                    const newSpell = JSON.parse(JSON.stringify(gameState.spellDatabase["Shadow Bolt"]));
                    newSpell.unlocked = true;
                    gameState.player.spells.push(newSpell);
                    gameState.player.knownSpells++;
                    addToGameScreen("You learned a new spell: Shadow Bolt!", "magic");
                    addJournalEntry("Learned new spell: Shadow Bolt");
                }
                
                // Add pulse animation to level display
                playerLevel.classList.add("pulse");
                setTimeout(() => playerLevel.classList.remove("pulse"), 1000);
            }
        }

        function attack() {
            if (!gameState.inCombat) return;
            
            // Player attacks
            let playerDamage = Math.max(1, Math.floor(Math.random() * gameState.player.weapon.damage) + 1);
            
            // Critical hit chance (5%)
            if (Math.random() < 0.05) {
                playerDamage *= 2;
                addToGameScreen(`Critical hit!`, "damage");
            }
            
            gameState.currentEnemy.hp -= playerDamage;
            addToGameScreen(`You hit the ${gameState.currentEnemy.name} with your ${gameState.player.weapon.name} for ${playerDamage} damage!`, "player-action damage");
            
            // Check if enemy is dead
            if (gameState.currentEnemy.hp <= 0) {
                gameState.currentEnemy.hp = 0;
                endCombat(true);
                return;
            }
            
            // Enemy attacks back
            const enemyDamage = Math.max(1, Math.floor(Math.random() * gameState.currentEnemy.weapon.damage) + 1);
            gameState.player.hp -= enemyDamage;
            addToGameScreen(`The ${gameState.currentEnemy.name} hits you with its ${gameState.currentEnemy.weapon.name} for ${enemyDamage} damage!`, "enemy-action damage");
            
            // Check if player is dead
            if (gameState.player.hp <= 0) {
                gameState.player.hp = 0;
                addToGameScreen("You have been defeated! Game over.", "damage");
                addJournalEntry("GAME OVER - DEFEATED IN BATTLE");
                fightButton.disabled = true;
                fleeButton.disabled = true;
            }
            
            updateUI();
        }

        function castSpell(spellName) {
            if (!gameState.inCombat) {
                addToGameScreen("You can only cast spells in combat!", "combat-log");
                return;
            }
            
            const spell = gameState.player.spells.find(s => s.name === spellName);
            
            if (!spell || !spell.unlocked) {
                addToGameScreen("You don't know that spell!", "combat-log");
                return;
            }
            
            if (gameState.player.mp < spell.cost) {
                addToGameScreen("Not enough MP to cast that spell!", "combat-log");
                return;
            }
            
            // Deduct MP
            gameState.player.mp -= spell.cost;
            addToGameScreen(`You cast ${spell.name} (${spell.cost} MP)!`, "magic");
            
            // Handle spell effects
            if (spell.type === "offensive") {
                let damage = spell.damage;
                
                // Check for elemental weaknesses
                if (gameState.currentEnemy.weakTo && gameState.currentEnemy.weakTo.includes(spell.element)) {
                    damage = Math.floor(damage * 1.5);
                    addToGameScreen(`The ${gameState.currentEnemy.name} is weak to ${spell.element}!`, "combat-log");
                }
                
                // Check for resistances
                if (gameState.currentEnemy.resistantTo && gameState.currentEnemy.resistantTo.includes(spell.element)) {
                    damage = Math.floor(damage * 0.5);
                    addToGameScreen(`The ${gameState.currentEnemy.name} resists ${spell.element}!`, "combat-log");
                }
                
                gameState.currentEnemy.hp -= damage;
                addToGameScreen(`Your ${spell.name} hits the ${gameState.currentEnemy.name} for ${damage} damage!`, "player-action damage");
                
                // Check if enemy is dead
                if (gameState.currentEnemy.hp <= 0) {
                    gameState.currentEnemy.hp = 0;
                    endCombat(true);
                    return;
                }
            } else if (spell.type === "healing") {
                const healAmount = spell.heal;
                gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
                addToGameScreen(`You healed ${healAmount} HP.`, "heal");
            } else if (spell.type === "drain") {
                let damage = spell.damage;
                
                // Check for resistances
                if (gameState.currentEnemy.resistantTo && gameState.currentEnemy.resistantTo.includes(spell.element)) {
                    damage = Math.floor(damage * 0.5);
                    addToGameScreen(`The ${gameState.currentEnemy.name} resists ${spell.element}!`, "combat-log");
                }
                
                gameState.currentEnemy.hp -= damage;
                const healAmount = spell.heal;
                gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
                addToGameScreen(`You drained ${damage} HP from the enemy and healed ${healAmount} HP!`, "player-action damage");
                
                if (gameState.currentEnemy.hp <= 0) {
                    gameState.currentEnemy.hp = 0;
                    endCombat(true);
                    return;
                }
            }
            
            // Enemy still gets to attack after spell
            if (gameState.inCombat) {
                const enemyDamage = Math.max(1, Math.floor(Math.random() * gameState.currentEnemy.weapon.damage) + 1);
                gameState.player.hp -= enemyDamage;
                addToGameScreen(`The ${gameState.currentEnemy.name} hits you with its ${gameState.currentEnemy.weapon.name} for ${enemyDamage} damage!`, "enemy-action damage");
                
                if (gameState.player.hp <= 0) {
                    gameState.player.hp = 0;
                    addToGameScreen("You have been defeated! Game over.", "damage");
                    addJournalEntry("GAME OVER - DEFEATED IN BATTLE");
                    fightButton.disabled = true;
                    fleeButton.disabled = true;
                }
            }
            
            updateUI();
        }

        function flee() {
            if (!gameState.inCombat) return;
            
            // Calculate flee chance based on player and enemy level difference
            const levelDifference = gameState.player.level - (gameState.currentEnemy.level || 1);
            const baseChance = 0.7;
            const adjustedChance = Math.min(0.95, Math.max(0.3, baseChance + (levelDifference * 0.05)));
            
            if (Math.random() < adjustedChance) {
                endCombat(false);
            } else {
                addToGameScreen("You failed to escape!", "combat-log");
                
                // Enemy gets a free attack
                const enemyDamage = Math.max(1, Math.floor(Math.random() * gameState.currentEnemy.weapon.damage) + 1);
                gameState.player.hp -= enemyDamage;
                addToGameScreen(`The ${gameState.currentEnemy.name} hits you as you try to flee for ${enemyDamage} damage!`, "enemy-action damage");
                
                if (gameState.player.hp <= 0) {
                    gameState.player.hp = 0;
                    addToGameScreen("You have been defeated! Game over.", "damage");
                    addJournalEntry("GAME OVER - DEFEATED IN BATTLE");
                    fightButton.disabled = true;
                    fleeButton.disabled = true;
                }
            }
            
            updateUI();
        }

        function showInventory() {
            // Clear inventory display
            inventoryItems.innerHTML = "";
            
            // Filter items by type
            const itemsToShow = gameState.player.inventory.filter(item => {
                if (itemsTab.classList.contains("active")) return item.type === "consumable";
                if (weaponsTab.classList.contains("active")) return item.type === "weapon";
                if (keyItemsTab.classList.contains("active")) return item.type === "item";
                return true;
            });
            
            if (itemsToShow.length === 0) {
                inventoryItems.innerHTML = `<div class="card"><p>No items in this category</p></div>`;
            } else {
                // Add each item to inventory
                itemsToShow.forEach((item, index) => {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "card";
                    if (item.rarity === "rare" || item.rarity === "epic" || item.rarity === "legendary") {
                        itemDiv.classList.add("rare");
                    }
                    
                    itemDiv.innerHTML = `
                        <h3>${item.name}</h3>
                        <p>${item.description}</p>
                        ${item.type === "consumable" ? `<button onclick="useItem(${index})">Use</button>` : ""}
                        ${item.type === "weapon" ? `<button onclick="equipWeapon(${index})">Equip</button>` : ""}
                        ${item.type === "item" ? `<button onclick="examineItem(${index})">Examine</button>` : ""}
                    `;
                    inventoryItems.appendChild(itemDiv);
                });
            }
            
            // Show inventory
            inventory.style.display = "flex";
        }

        function useItem(index) {
            const item = gameState.player.inventory[index];
            
            if (item.type === "consumable") {
                if (item.effect === "heal") {
                    const healAmount = item.value;
                    gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
                    addToGameScreen(`You used ${item.name} and healed ${healAmount} HP.`, "heal");
                    addJournalEntry(`Used item: ${item.name} (healed ${healAmount} HP)`);
                } else if (item.effect === "restoreMP") {
                    const restoreAmount = item.value;
                    gameState.player.mp = Math.min(gameState.player.maxMp, gameState.player.mp + restoreAmount);
                    addToGameScreen(`You used ${item.name} and restored ${restoreAmount} MP.`, "magic");
                    addJournalEntry(`Used item: ${item.name} (restored ${restoreAmount} MP)`);
                } else if (item.effect === "damage" && gameState.inCombat) {
                    gameState.currentEnemy.hp -= item.value;
                    addToGameScreen(`You used ${item.name} on the ${gameState.currentEnemy.name} for ${item.value} damage!`, "player-action damage");
                    addJournalEntry(`Used item: ${item.name} (dealt ${item.value} damage)`);
                    
                    if (gameState.currentEnemy.hp <= 0) {
                        gameState.currentEnemy.hp = 0;
                        endCombat(true);
                    }
                } else if (item.effect === "random") {
                    const randomEffect = Math.random();
                    if (randomEffect < 0.4) {
                        // Positive effect
                        const healAmount = 10 + Math.floor(Math.random() * 20);
                        gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
                        addToGameScreen(`The stew was surprisingly good! You healed ${healAmount} HP.`, "heal");
                    } else if (randomEffect < 0.8) {
                        // Negative effect
                        const damage = 5 + Math.floor(Math.random() * 15);
                        gameState.player.hp = Math.max(0, gameState.player.hp - damage);
                        addToGameScreen(`The stew was terrible! You took ${damage} damage.`, "damage");
                    } else {
                        // Strange effect
                        const mpRestore = 10 + Math.floor(Math.random() * 20);
                        gameState.player.mp = Math.min(gameState.player.maxMp, gameState.player.mp + mpRestore);
                        addToGameScreen(`The stew had magical properties! You regained ${mpRestore} MP.`, "magic");
                    }
                }
                
                // Remove item from inventory
                gameState.player.inventory.splice(index, 1);
                
                // Close inventory if empty
                if (gameState.player.inventory.length === 0) {
                    inventory.style.display = "none";
                } else {
                    showInventory(); // Refresh display
                }
            }
            
            updateUI();
        }

        function equipWeapon(index) {
            const item = gameState.player.inventory[index];
            
            if (item.type === "weapon") {
                // Store the old weapon
                const oldWeapon = gameState.player.weapon;
                
                // Equip the new weapon
                gameState.player.weapon = item;
                
                // Remove the equipped weapon from inventory
                gameState.player.inventory.splice(index, 1);
                
                // Add the old weapon back to inventory if it's not fists
                if (oldWeapon.name !== "Fists") {
                    gameState.player.inventory.push(oldWeapon);
                }
                
                addToGameScreen(`You equipped the ${item.name}.`, "player-action");
                addJournalEntry(`Equipped weapon: ${item.name}`);
                
                // Close inventory and refresh display
                inventory.style.display = "none";
                showInventory();
            }
            
            updateUI();
        }

        function examineItem(index) {
            const item = gameState.player.inventory[index];
            
            // Close inventory first
            inventory.style.display = "none";
            
            // Show examination in main game screen
            clearGameScreen();
            addToGameScreen(`You examine the ${item.name}:`, "player-action");
            addToGameScreen(item.description, "combat-log");
            
            if (item.type === "weapon") {
                addToGameScreen(`Damage: ${item.damage}`, "combat-log");
            } else if (item.type === "consumable") {
                if (item.effect === "heal") {
                    addToGameScreen(`Restores ${item.value} HP`, "heal");
                } else if (item.effect === "restoreMP") {
                    addToGameScreen(`Restores ${item.value} MP`, "magic");
                }
            }
            
            if (item.rarity === "rare" || item.rarity === "epic" || item.rarity === "legendary") {
                addToGameScreen("This item seems particularly valuable!", "rare");
            }
            
            addJournalEntry(`Examined item: ${item.name}`);
        }

        function showSpellbook() {
            // Clear spells display
            spellsList.innerHTML = "";
            
            // Add each spell to spellbook
            gameState.player.spells.forEach(spell => {
                if (spell.unlocked) {
                    const spellDiv = document.createElement("div");
                    spellDiv.className = "card";
                    if (spell.level >= 3) {
                        spellDiv.classList.add("rare");
                    }
                    
                    spellDiv.innerHTML = `
                        <h3>${spell.name} (Lvl ${spell.level})</h3>
                        <p>${spell.description}</p>
                        <p><strong>Cost:</strong> ${spell.cost} MP</p>
                        ${spell.type === "offensive" ? `<p><strong>Damage:</strong> ${spell.damage}</p>` : ""}
                        ${spell.type === "healing" ? `<p><strong>Heal:</strong> ${spell.heal}</p>` : ""}
                        ${spell.type === "drain" ? `<p><strong>Damage:</strong> ${spell.damage}, <strong>Heal:</strong> ${spell.heal}</p>` : ""}
                        <p><strong>Element:</strong> ${spell.element}</p>
                        <button onclick="castSpell('${spell.name}')">Cast</button>
                    `;
                    spellsList.appendChild(spellDiv);
                }
            });
            
            if (gameState.player.spells.filter(s => s.unlocked).length === 0) {
                spellsList.innerHTML = `<div class="card"><p>You haven't learned any spells yet</p></div>`;
            }
            
            // Show spellbook
            spellbook.style.display = "flex";
        }

        function showMap() {
            mapDisplay.innerHTML = `
                <svg width="100%" height="400" viewBox="0 0 100 100" style="background-color: rgba(10,0,0,0.5); border: 1px solid var(--dark-red); border-radius: 8px;">
                    ${Object.entries(gameState.mapData).map(([locationId, data]) => {
                        const location = gameState.locations[locationId];
                        const isCurrent = gameState.currentLocation === locationId;
                        const isDiscovered = gameState.discoveredLocations.includes(locationId);
                        const isExplored = location?.explored;
                        
                        if (!isDiscovered) return '';
                        
                        const connections = data.connections.map(connId => {
                            const connData = gameState.mapData[connId];
                            if (!gameState.discoveredLocations.includes(connId)) return '';
                            return `<line x1="${data.x}" y1="${data.y}" x2="${connData.x}" y2="${connData.y}" stroke="${isExplored ? '#f00' : '#800'}" stroke-width="1" stroke-dasharray="${isExplored ? '0' : '2,2'}" />`;
                        }).join('');
                        
                        return `
                            ${connections}
                            <circle cx="${data.x}" cy="${data.y}" r="${isCurrent ? 5 : 3}" fill="${isCurrent ? '#f00' : (isExplored ? '#a00' : '#500')}" stroke="#fff" stroke-width="1" />
                            <text x="${data.x}" y="${data.y - 7}" text-anchor="middle" fill="${isExplored ? '#fff' : '#888'}" font-size="4">${location.name}</text>
                        `;
                    }).join('')}
                </svg>
                <p style="margin-top: 10px; text-align: center;">
                    Current location: <strong>${gameState.locations[gameState.currentLocation].name}</strong>
                </p>
                <p style="text-align: center; color: #aaa;">
                    ${gameState.discoveredLocations.length} of ${Object.keys(gameState.locations).length} locations discovered
                </p>
            `;
            
            mapModal.style.display = "flex";
        }

        function addJournalEntry(text) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString();
            gameState.player.journal.push(`[${timestamp}] ${text}`);
            
            // Keep journal to a reasonable size
            if (gameState.player.journal.length > 50) {
                gameState.player.journal.shift();
            }
        }

        function showJournal() {
            journalEntries.innerHTML = gameState.player.journal
                .map(entry => `<div class="card"><p>${entry}</p></div>`)
                .reverse()
                .join('');
            
            journalModal.style.display = "flex";
        }

        // Event listeners
        lookButton.addEventListener("click", lookAround);
        moveButton.addEventListener("click", move);
        talkButton.addEventListener("click", talk);
        takeButton.addEventListener("click", takeItem);
        fightButton.addEventListener("click", attack);
        magicButton.addEventListener("click", showSpellbook);
        inventoryButton.addEventListener("click", showInventory);
        fleeButton.addEventListener("click", flee);
        mapButton.addEventListener("click", showMap);
        journalButton.addEventListener("click", showJournal);
        
        // Modal close buttons
        closeInventory.addEventListener("click", () => inventory.style.display = "none");
        closeSpellbook.addEventListener("click", () => spellbook.style.display = "none");
        closeMap.addEventListener("click", () => mapModal.style.display = "none");
        closeJournal.addEventListener("click", () => journalModal.style.display = "none");
        
        // Tab buttons
        itemsTab.addEventListener("click", function() {
            itemsTab.classList.add("active");
            weaponsTab.classList.remove("active");
            keyItemsTab.classList.remove("active");
            showInventory();
        });
        
        weaponsTab.addEventListener("click", function() {
            weaponsTab.classList.add("active");
            itemsTab.classList.remove("active");
            keyItemsTab.classList.remove("active");
            showInventory();
        });
        
        keyItemsTab.addEventListener("click", function() {
            keyItemsTab.classList.add("active");
            itemsTab.classList.remove("active");
            weaponsTab.classList.remove("active");
            showInventory();
        });

        // Initialize game
        updateUI();
        
        // Make functions available globally for HTML buttons
        window.useItem = useItem;
        window.equipWeapon = equipWeapon;
        window.examineItem = examineItem;
        window.castSpell = castSpell;
    </script>
</body>
</html>
