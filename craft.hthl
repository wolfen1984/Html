<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dreadwood Mountain</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #0a0a1a;
            color: #00ff00;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(10, 30, 10, 0.3) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 20, 40, 0.3) 0%, transparent 20%);
        }
        
        #game-container {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            max-height: 900px;
            position: relative;
            border: 4px solid #00ff00;
            box-shadow: 
                0 0 20px rgba(0, 255, 0, 0.7),
                inset 0 0 20px rgba(0, 255, 0, 0.3);
            overflow: hidden;
            background-color: #050510;
        }
        
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            padding: 15px;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .active {
            display: flex;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px dashed #00ff00;
        }
        
        .title {
            font-size: 22px;
            color: #ff00ff;
            text-shadow: 0 0 10px #ff00ff;
            margin-bottom: 5px;
            letter-spacing: 1px;
        }
        
        .subtitle {
            font-size: 12px;
            color: #00ffff;
            margin-bottom: 10px;
        }
        
        .player-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(0, 20, 40, 0.7);
            border: 2px solid #0088ff;
            border-radius: 4px;
            font-size: 10px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            color: #ffff00;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 15px;
            background-color: rgba(0, 10, 20, 0.7);
            border: 2px solid #00ff00;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.6;
        }
        
        /* Scrollbar styling */
        .content-area::-webkit-scrollbar {
            width: 8px;
        }
        
        .content-area::-webkit-scrollbar-track {
            background: rgba(0, 30, 0, 0.5);
        }
        
        .content-area::-webkit-scrollbar-thumb {
            background: #00ff00;
            border-radius: 4px;
        }
        
        .buttons-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .button {
            background-color: #002200;
            color: #00ff00;
            border: 2px solid #00ff00;
            border-radius: 4px;
            padding: 12px 5px;
            font-family: 'Press Start 2P', cursive;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.1s;
            text-align: center;
            text-shadow: 0 0 5px #00ff00;
        }
        
        .button:active {
            background-color: #00aa00;
            color: #ffffff;
            transform: scale(0.98);
        }
        
        .button-primary {
            background-color: #220022;
            border-color: #ff00ff;
            color: #ff88ff;
            text-shadow: 0 0 5px #ff00ff;
        }
        
        .button-primary:active {
            background-color: #880088;
        }
        
        .button-danger {
            background-color: #330000;
            border-color: #ff0000;
            color: #ff8888;
            text-shadow: 0 0 5px #ff0000;
        }
        
        .button-danger:active {
            background-color: #880000;
        }
        
        .button-success {
            background-color: #003300;
            border-color: #00ff00;
            color: #88ff88;
            text-shadow: 0 0 5px #00ff00;
        }
        
        .button-success:active {
            background-color: #008800;
        }
        
        .location-info {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(0, 40, 80, 0.5);
            border: 1px solid #0088ff;
            border-radius: 4px;
        }
        
        .area-description {
            font-size: 11px;
            color: #88ffff;
            margin-top: 5px;
            line-height: 1.5;
        }
        
        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            background-color: rgba(0, 30, 60, 0.7);
            border: 1px solid #0088ff;
            border-radius: 4px;
        }
        
        .item-name {
            color: #ffff00;
        }
        
        .item-count {
            color: #00ff00;
            font-size: 14px;
        }
        
        .crafting-recipe {
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(20, 0, 40, 0.7);
            border: 1px solid #aa00ff;
            border-radius: 4px;
        }
        
        .recipe-title {
            color: #ff88ff;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .recipe-stats {
            color: #ffff88;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .recipe-materials {
            font-size: 10px;
            color: #88ff88;
            margin-bottom: 10px;
        }
        
        .enemy-display {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: rgba(40, 0, 0, 0.7);
            border: 2px solid #ff0000;
            border-radius: 4px;
        }
        
        .enemy-name {
            color: #ff6666;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .enemy-stats {
            display: flex;
            justify-content: space-around;
            font-size: 11px;
            margin-bottom: 10px;
        }
        
        .combat-log {
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 15px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 1px solid #ffff00;
            border-radius: 4px;
            font-size: 11px;
            display: flex;
            flex-direction: column;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px dotted rgba(255, 255, 0, 0.3);
        }
        
        .player-log {
            color: #88ff88;
        }
        
        .enemy-log {
            color: #ff8888;
        }
        
        .event-log {
            color: #8888ff;
        }
        
        .critical-log {
            color: #ff0000;
            text-shadow: 0 0 5px #ff0000;
            animation: criticalFlash 0.3s;
        }
        
        @keyframes criticalFlash {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .game-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 40, 0.9);
            border: 3px solid #0088ff;
            padding: 20px;
            border-radius: 8px;
            z-index: 100;
            text-align: center;
            max-width: 90%;
            display: none;
        }
        
        .message-text {
            font-size: 14px;
            margin-bottom: 15px;
            color: #ffff00;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .nav-button {
            width: 32%;
            padding: 10px 5px;
            font-size: 10px;
        }
        
        .xp-bar-container, .hp-bar-container {
            width: 100%;
            height: 10px;
            background-color: #002200;
            border: 1px solid #00ff00;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .xp-bar, .hp-bar {
            height: 100%;
            background-color: #00ff00;
            transition: width 0.5s;
        }
        
        .hp-bar {
            background-color: #ff0000;
        }
        
        .game-area-image {
            text-align: center;
            margin: 15px 0;
            font-size: 40px;
        }
        
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #002200;
            border: 2px solid #00ff00;
            color: #00ff00;
            font-size: 16px;
            cursor: pointer;
            z-index: 10;
        }
        
        .category-tabs {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            border-bottom: 2px solid #aa00ff;
        }
        
        .category-tab {
            flex: 1;
            padding: 8px;
            text-align: center;
            background-color: rgba(20, 0, 40, 0.5);
            border: none;
            border-bottom: 2px solid transparent;
            color: #aa88ff;
            font-family: 'Press Start 2P', cursive;
            font-size: 9px;
            cursor: pointer;
        }
        
        .category-tab.active {
            background-color: rgba(40, 0, 80, 0.8);
            border-bottom: 2px solid #ff00ff;
            color: #ff88ff;
        }
        
        .skill-points-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #550055;
            border: 2px solid #ff00ff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ff88ff;
            font-size: 12px;
            z-index: 10;
            display: none;
        }
        
        .skill-button {
            margin: 5px 0;
            padding: 8px;
            font-size: 10px;
            background-color: #004400;
            border: 2px solid #00aa00;
            color: #88ff88;
        }
        
        .skill-button.unlocked {
            background-color: #006600;
            border-color: #00ff00;
            color: #ffffff;
        }
        
        .skill-button.locked {
            background-color: #442200;
            border-color: #885500;
            color: #888888;
        }
        
        .save-slot {
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(0, 40, 80, 0.7);
            border: 2px solid #0088ff;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .save-slot:hover {
            background-color: rgba(0, 60, 120, 0.7);
        }
        
        .save-info {
            color: #88ffff;
            font-size: 10px;
        }
        
        .save-level {
            color: #ffff00;
            font-size: 12px;
        }
        
        @media (max-width: 500px) {
            .title {
                font-size: 18px;
            }
            
            .button {
                font-size: 9px;
                padding: 10px 5px;
            }
            
            .content-area {
                font-size: 10px;
            }
            
            .recipe-title {
                font-size: 12px;
            }
            
            .category-tab {
                font-size: 8px;
                padding: 6px 2px;
            }
        }
        
        /* Animation for critical hits */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .critical-hit {
            animation: shake 0.3s;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Sound toggle button -->
        <button class="sound-toggle" id="sound-toggle">üîä</button>
        
        <!-- Skill points indicator -->
        <div class="skill-points-indicator" id="skill-points-indicator">0</div>
        
        <!-- Main Menu Screen -->
        <div id="main-menu" class="screen active">
            <div class="header">
                <h1 class="title">DREADWOOD MOUNTAIN</h1>
                <div class="subtitle">A RETRO 80s ADVENTURE</div>
            </div>
            
            <div class="content-area" style="justify-content: center; align-items: center; display: flex; flex-direction: column;">
                <div class="game-area-image">
                    üå≤‚õ∞Ô∏èüåä
                </div>
                <div style="text-align: center; margin-bottom: 30px;">
                    <p>You stand at the edge of Dreadwood Forest.</p>
                    <p>The mountain looms above, reflected in the lake's dark waters.</p>
                    <p>Danger and treasure await...</p>
                </div>
            </div>
            
            <div class="buttons-container">
                <button class="button button-primary" onclick="startGame()">NEW GAME</button>
                <button class="button" onclick="showScreen('save-screen')">LOAD GAME</button>
            </div>
            
            <div class="navigation">
                <button class="button nav-button" onclick="showScreen('skills-screen')">SKILLS</button>
                <button class="button nav-button" onclick="showScreen('instructions')">INSTRUCTIONS</button>
                <button class="button nav-button" onclick="showScreen('credits')">CREDITS</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="header">
                <h2 class="title">DREADWOOD MOUNTAIN</h2>
                <div class="player-stats">
                    <div class="stat">
                        <div>LEVEL</div>
                        <div id="player-level" class="stat-value">1</div>
                    </div>
                    <div class="stat">
                        <div>HEALTH</div>
                        <div id="player-hp" class="stat-value">50/50</div>
                    </div>
                    <div class="stat">
                        <div>XP</div>
                        <div id="player-xp" class="stat-value">0/100</div>
                    </div>
                    <div class="stat">
                        <div>AREA</div>
                        <div id="current-area" class="stat-value">FOREST</div>
                    </div>
                </div>
                
                <div class="location-info">
                    <div id="location-name">Dreadwood Forest</div>
                    <div id="location-description" class="area-description">Thick, ancient trees block much of the sunlight. Strange noises echo in the distance.</div>
                </div>
            </div>
            
            <div class="content-area" id="game-content">
                <!-- Content will be filled by JavaScript -->
                <p>Welcome to Dreadwood Mountain! Explore, gather, craft, and fight to survive.</p>
                <p>Use the buttons below to navigate through the game.</p>
            </div>
            
            <div class="buttons-container">
                <button class="button" onclick="goToGathering()">GATHER</button>
                <button class="button" onclick="goToCrafting()">CRAFT</button>
                <button class="button" onclick="goToCombat()">COMBAT</button>
            </div>
            
            <div class="navigation">
                <button class="button nav-button" onclick="saveGameToSlot(1)">QUICK SAVE</button>
                <button class="button nav-button" onclick="changeArea('forest')">FOREST</button>
                <button class="button nav-button" onclick="changeArea('mountain')">MOUNTAIN</button>
                <button class="button nav-button" onclick="changeArea('lake')">LAKE</button>
            </div>
        </div>
        
        <!-- Gathering Screen -->
        <div id="gathering-screen" class="screen">
            <div class="header">
                <h2 class="title">GATHERING</h2>
                <div class="subtitle" id="gather-area">Forest Area</div>
            </div>
            
            <div class="content-area" id="gather-content">
                <p>Search the area for useful materials.</p>
                <p>Different areas have different resources.</p>
                <div id="gather-results"></div>
            </div>
            
            <div class="buttons-container">
                <button class="button button-primary" onclick="gatherMaterials()">SEARCH AREA</button>
                <button class="button" onclick="showScreen('game-screen')">BACK</button>
            </div>
            
            <div class="navigation">
                <button class="button nav-button" onclick="changeGatherArea('forest')">FOREST</button>
                <button class="button nav-button" onclick="changeGatherArea('mountain')">MOUNTAIN</button>
                <button class="button nav-button" onclick="changeGatherArea('lake')">LAKE</button>
            </div>
        </div>
        
        <!-- Crafting Screen -->
        <div id="crafting-screen" class="screen">
            <div class="header">
                <h2 class="title">CRAFTING</h2>
                <div class="subtitle">Create Weapons, Armor & Consumables</div>
            </div>
            
            <div class="category-tabs">
                <button class="category-tab active" onclick="showCraftingCategory('weapons')">WEAPONS</button>
                <button class="category-tab" onclick="showCraftingCategory('armor')">ARMOR</button>
                <button class="category-tab" onclick="showCraftingCategory('consumables')">CONSUMABLES</button>
            </div>
            
            <div class="content-area" id="crafting-content">
                <p>Use your gathered materials to craft useful items.</p>
                <div id="crafting-recipes"></div>
            </div>
            
            <div class="buttons-container">
                <button class="button" onclick="showScreen('game-screen')">BACK</button>
            </div>
        </div>
        
        <!-- Combat Screen -->
        <div id="combat-screen" class="screen">
            <div class="header">
                <h2 class="title">COMBAT</h2>
                <div class="subtitle" id="combat-area">Forest Encounter</div>
            </div>
            
            <div class="content-area">
                <div class="enemy-display">
                    <div class="enemy-name" id="enemy-name">Forest Goblin</div>
                    <div class="enemy-stats">
                        <div>HP: <span id="enemy-hp">30</span>/<span id="enemy-max-hp">30</span></div>
                        <div>DMG: <span id="enemy-dmg">3-6</span></div>
                        <div>XP: <span id="enemy-xp">20</span></div>
                    </div>
                    <div id="enemy-image" class="game-area-image">üëπ</div>
                </div>
                
                <div class="combat-log" id="combat-log">
                    <div class="log-entry event-log">Combat started!</div>
                </div>
            </div>
            
            <div class="buttons-container">
                <button class="button button-danger" onclick="playerAttack()">ATTACK</button>
                <button class="button" onclick="usePotion()">USE POTION</button>
                <button class="button" onclick="useSpecialItem()">SPECIAL</button>
            </div>
            
            <div class="navigation">
                <button class="button nav-button" onclick="fleeCombat()">FLEE</button>
                <button class="button nav-button" onclick="showScreen('game-screen')">RETREAT</button>
            </div>
        </div>
        
        <!-- Skills Screen -->
        <div id="skills-screen" class="screen">
            <div class="header">
                <h2 class="title">SKILL TREE</h2>
                <div class="subtitle">Unlock powerful abilities</div>
            </div>
            
            <div class="content-area" id="skills-content">
                <p>Spend skill points to unlock permanent bonuses.</p>
                <p id="skill-points-display">Skill Points Available: <span id="available-skill-points">0</span></p>
                <div id="skills-list"></div>
            </div>
            
            <div class="buttons-container">
                <button class="button button-success" onclick="resetSkills()" id="reset-skills-btn">RESET SKILLS (Cost: 100 gold)</button>
                <button class="button" onclick="showScreen('game-screen')">BACK TO GAME</button>
            </div>
        </div>
        
        <!-- Save/Load Screen -->
        <div id="save-screen" class="screen">
            <div class="header">
                <h2 class="title">SAVE & LOAD</h2>
                <div class="subtitle">Manage your game saves</div>
            </div>
            
            <div class="content-area" id="save-content">
                <p>Select a save slot to load or save your game.</p>
                <div id="save-slots"></div>
            </div>
            
            <div class="buttons-container">
                <button class="button button-primary" onclick="showScreen('main-menu')">BACK</button>
                <button class="button" onclick="deleteAllSaves()">DELETE ALL SAVES</button>
            </div>
        </div>
        
        <!-- Instructions Screen -->
        <div id="instructions" class="screen">
            <div class="header">
                <h2 class="title">INSTRUCTIONS</h2>
            </div>
            
            <div class="content-area">
                <p><strong>DREADWOOD MOUNTAIN</strong></p>
                <p>Explore three areas:</p>
                <p><strong>FOREST:</strong> Find herbs, wood, and encounter weak enemies.</p>
                <p><strong>MOUNTAIN:</strong> Mine ore, find gems, face stronger foes.</p>
                <p><strong>LAKE:</strong> Fish, collect shells, battle aquatic creatures.</p>
                <p>Gather materials to craft weapons, armor, and consumables.</p>
                <p>Fight enemies to gain XP, gold, and unlock skill points.</p>
                <p>Spend skill points to unlock permanent bonuses.</p>
                <p>Save your game frequently!</p>
                <p style="margin-top: 15px; color: #ffff00;">Toggle sound with üîä button</p>
                <p style="color: #ff88ff;">Skills: Unlock new abilities every few levels</p>
                <p style="color: #88ffff;">Save System: 5 save slots with auto-save</p>
            </div>
            
            <div class="buttons-container">
                <button class="button button-primary" onclick="showScreen('main-menu')">BACK</button>
            </div>
        </div>
        
        <!-- Credits Screen -->
        <div id="credits" class="screen">
            <div class="header">
                <h2 class="title">CREDITS</h2>
            </div>
            
            <div class="content-area">
                <p><strong>DREADWOOD MOUNTAIN</strong></p>
                <p>A retro 80s-inspired mobile game</p>
                <p>Created with HTML, CSS & JavaScript</p>
                <p>Designed for Android portrait view</p>
                <p>Font: Press Start 2P</p>
                <p>Inspired by classic RPGs</p>
                <p>¬© 2023 Retro Game Studio</p>
                <p style="margin-top: 20px; color: #ffff00;">Enhanced with:</p>
                <p>‚Ä¢ Advanced Save System</p>
                <p>‚Ä¢ Skill Tree with 12 abilities</p>
                <p>‚Ä¢ Balanced Crafting Recipes</p>
                <p>‚Ä¢ Dynamic Enemy Scaling</p>
                <p>‚Ä¢ Critical Hit System</p>
            </div>
            
            <div class="buttons-container">
                <button class="button button-primary" onclick="showScreen('main-menu')">BACK</button>
            </div>
        </div>
        
        <!-- Game Message Modal -->
        <div id="game-message" class="game-message">
            <div class="message-text" id="message-text">Message goes here</div>
            <button class="button" onclick="hideMessage()">OK</button>
        </div>
    </div>

    <script>
        // Enhanced Game State with Skills and Gold
        const gameState = {
            player: {
                name: "Adventurer",
                level: 1,
                xp: 0,
                xpToNextLevel: 100,
                hp: 50,
                maxHp: 50,
                attack: 5,
                defense: 2,
                gold: 100,
                skillPoints: 0,
                criticalChance: 5, // 5% base critical chance
                criticalMultiplier: 1.5,
                weapon: { name: "Rusty Dagger", damage: "3-5", type: "weapon", tier: 1 },
                armor: { name: "Leather Tunic", defense: 2, type: "armor", tier: 1 },
                potions: 3,
                specialItems: {
                    bombs: 0,
                    poisonDaggers: 0,
                    strengthElixirs: 0,
                    defenseTonics: 0
                }
            },
            skills: {
                gatherer: { level: 0, maxLevel: 5, description: "+1 extra material when gathering", cost: 1 },
                blacksmith: { level: 0, maxLevel: 3, description: "-10% crafting material cost per level", cost: 2 },
                survivor: { level: 0, maxLevel: 5, description: "+10 max HP per level", cost: 1 },
                sharpshooter: { level: 0, maxLevel: 5, description: "+1 base attack per level", cost: 1 },
                alchemist: { level: 0, maxLevel: 3, description: "+25% potion effectiveness per level", cost: 2 },
                scavenger: { level: 0, maxLevel: 3, description: "+15% gold from enemies per level", cost: 2 },
                dodger: { level: 0, maxLevel: 3, description: "+5% dodge chance per level", cost: 2 },
                berserker: { level: 0, maxLevel: 3, description: "+2% critical chance per level", cost: 2 },
                toughSkin: { level: 0, maxLevel: 3, description: "+1 defense per level", cost: 2 },
                treasureHunter: { level: 0, maxLevel: 3, description: "+10% better loot chance per level", cost: 2 },
                poisonMaster: { level: 0, maxLevel: 3, description: "Poison lasts 1 extra turn per level", cost: 2 },
                explosiveExpert: { level: 0, maxLevel: 3, description: "+25% bomb damage per level", cost: 2 }
            },
            inventory: {
                herbs: 0,
                wood: 0,
                ore: 0,
                gems: 0,
                fish: 0,
                shells: 0,
                spiderSilk: 0,
                wolfPelt: 0,
                batWings: 0,
                serpentScales: 0
            },
            currentArea: "forest",
            combatActive: false,
            enemy: null,
            craftingCategory: "weapons",
            gameTime: 0,
            stats: {
                enemiesDefeated: 0,
                materialsGathered: 0,
                itemsCrafted: 0,
                goldEarned: 0,
                damageDealt: 0,
                damageTaken: 0,
                criticalHits: 0
            }
        };

        // Save Slots (5 slots)
        const SAVE_SLOTS = 5;
        const SAVE_KEY_PREFIX = "dreadwood_save_";
        
        // Enhanced Game Data with balanced recipes
        const gameData = {
            areas: {
                forest: {
                    name: "Dreadwood Forest",
                    description: "Thick, ancient trees block much of the sunlight. Strange noises echo in the distance.",
                    materials: ["herbs", "wood", "spiderSilk", "wolfPelt"],
                    enemies: ["Forest Goblin", "Giant Spider", "Wolf", "Treant"],
                    enemyStats: {
                        "Forest Goblin": { 
                            hp: 30, maxHp: 30, attack: "3-6", xp: 20, gold: "5-15",
                            special: null, weakTo: "fire"
                        },
                        "Giant Spider": { 
                            hp: 25, maxHp: 25, attack: "2-5", xp: 15, gold: "3-10",
                            special: "poison", weakTo: "crushing"
                        },
                        "Wolf": { 
                            hp: 35, maxHp: 35, attack: "4-7", xp: 25, gold: "7-18",
                            special: "bleed", weakTo: "piercing"
                        },
                        "Treant": { 
                            hp: 45, maxHp: 45, attack: "5-8", xp: 35, gold: "12-25",
                            special: "root", weakTo: "fire"
                        }
                    }
                },
                mountain: {
                    name: "Stonepeak Mountain",
                    description: "Steep cliffs and winding paths. The air grows thin and cold.",
                    materials: ["ore", "gems", "batWings"],
                    enemies: ["Mountain Troll", "Rock Golem", "Cave Bat", "Stone Giant"],
                    enemyStats: {
                        "Mountain Troll": { 
                            hp: 50, maxHp: 50, attack: "6-10", xp: 40, gold: "15-30",
                            special: "regeneration", weakTo: "fire"
                        },
                        "Rock Golem": { 
                            hp: 60, maxHp: 60, attack: "5-9", xp: 50, gold: "20-35",
                            special: "armored", weakTo: "crushing"
                        },
                        "Cave Bat": { 
                            hp: 20, maxHp: 20, attack: "2-4", xp: 15, gold: "3-8",
                            special: "sonic", weakTo: "piercing"
                        },
                        "Stone Giant": { 
                            hp: 70, maxHp: 70, attack: "8-12", xp: 60, gold: "25-45",
                            special: "stun", weakTo: "magic"
                        }
                    }
                },
                lake: {
                    name: "Blackwater Lake",
                    description: "Dark, still waters reflect the ominous mountain above. Something moves beneath the surface.",
                    materials: ["fish", "shells", "serpentScales"],
                    enemies: ["Lake Serpent", "Giant Frog", "Water Spirit", "Kraken"],
                    enemyStats: {
                        "Lake Serpent": { 
                            hp: 40, maxHp: 40, attack: "5-8", xp: 35, gold: "10-25",
                            special: "poison", weakTo: "lightning"
                        },
                        "Giant Frog": { 
                            hp: 30, maxHp: 30, attack: "3-7", xp: 25, gold: "5-15",
                            special: "tongue", weakTo: "piercing"
                        },
                        "Water Spirit": { 
                            hp: 35, maxHp: 35, attack: "4-7", xp: 30, gold: "8-20",
                            special: "heal", weakTo: "fire"
                        },
                        "Kraken": { 
                            hp: 80, maxHp: 80, attack: "10-15", xp: 80, gold: "50-100",
                            special: "tentacle", weakTo: "lightning"
                        }
                    }
                }
            },
            craftingRecipes: {
                weapons: [
                    { 
                        name: "Iron Sword", 
                        materials: { ore: 2, wood: 1 },
                        result: { name: "Iron Sword", damage: "6-9", type: "weapon", tier: 2 },
                        description: "A sturdy iron sword. Basic but reliable.",
                        tier: 2,
                        requiredLevel: 2
                    },
                    { 
                        name: "Oak Bow", 
                        materials: { wood: 3, herbs: 1 },
                        result: { name: "Oak Bow", damage: "5-8", type: "weapon", tier: 2 },
                        description: "A simple bow made from strong oak. Good for ranged attacks.",
                        tier: 2,
                        requiredLevel: 2
                    },
                    { 
                        name: "Crystal Dagger", 
                        materials: { gems: 1, ore: 2 },
                        result: { name: "Crystal Dagger", damage: "7-11", type: "weapon", tier: 3 },
                        description: "A sharp dagger with a crystal blade. Deals high damage.",
                        tier: 3,
                        requiredLevel: 5
                    },
                    { 
                        name: "Mountain Hammer", 
                        materials: { ore: 4, gems: 1 },
                        result: { name: "Mountain Hammer", damage: "8-13", type: "weapon", tier: 3 },
                        description: "A heavy hammer made from mountain ore. Powerful but slow.",
                        tier: 3,
                        requiredLevel: 5
                    },
                    { 
                        name: "Wolf Fang Blade", 
                        materials: { wolfPelt: 1, ore: 2, wood: 1 },
                        result: { name: "Wolf Fang Blade", damage: "9-14", type: "weapon", tier: 4 },
                        description: "A blade carved from wolf fangs. Swift and deadly.",
                        tier: 4,
                        requiredLevel: 8
                    },
                    { 
                        name: "Serpent Spear", 
                        materials: { serpentScales: 2, wood: 3, ore: 1 },
                        result: { name: "Serpent Spear", damage: "10-15", type: "weapon", tier: 4 },
                        description: "A spear tipped with serpent scales. Has a chance to poison.",
                        tier: 4,
                        requiredLevel: 8
                    }
                ],
                armor: [
                    { 
                        name: "Leather Armor", 
                        materials: { wood: 1, herbs: 1 },
                        result: { name: "Leather Armor", defense: 3, type: "armor", tier: 2 },
                        description: "Light leather armor. Better than your tunic.",
                        tier: 2,
                        requiredLevel: 2
                    },
                    { 
                        name: "Iron Chestplate", 
                        materials: { ore: 3, wood: 1 },
                        result: { name: "Iron Chestplate", defense: 5, type: "armor", tier: 3 },
                        description: "Solid iron armor. Provides good protection.",
                        tier: 3,
                        requiredLevel: 5
                    },
                    { 
                        name: "Shell Shield", 
                        materials: { shells: 2, wood: 1 },
                        result: { name: "Shell Shield", defense: 4, type: "armor", tier: 2 },
                        description: "A shield made from lake shells. Surprisingly strong.",
                        tier: 2,
                        requiredLevel: 2
                    },
                    { 
                        name: "Spider Silk Robe", 
                        materials: { spiderSilk: 2, herbs: 1 },
                        result: { name: "Spider Silk Robe", defense: 5, type: "armor", tier: 3 },
                        description: "Light armor woven from spider silk. Agile and protective.",
                        tier: 3,
                        requiredLevel: 5
                    },
                    { 
                        name: "Wolf Hide Armor", 
                        materials: { wolfPelt: 2, wood: 1, herbs: 1 },
                        result: { name: "Wolf Hide Armor", defense: 6, type: "armor", tier: 4 },
                        description: "Armor made from wolf pelts. Provides warmth and protection.",
                        tier: 4,
                        requiredLevel: 8
                    },
                    { 
                        name: "Crystal Mail", 
                        materials: { gems: 2, ore: 1 },
                        result: { name: "Crystal Mail", defense: 7, type: "armor", tier: 4 },
                        description: "Armor embedded with crystals. Excellent protection.",
                        tier: 4,
                        requiredLevel: 8
                    }
                ],
                consumables: [
                    { 
                        name: "Health Potion", 
                        materials: { herbs: 1, fish: 1 },
                        result: { name: "Health Potion", type: "potion", heal: 20 },
                        description: "Restores 20 HP when used in combat.",
                        tier: 1,
                        requiredLevel: 1
                    },
                    { 
                        name: "Strength Elixir", 
                        materials: { gems: 1, herbs: 2 },
                        result: { name: "Strength Elixir", type: "elixir", effect: "+3 ATK for next battle" },
                        description: "Temporarily boosts your attack power.",
                        tier: 3,
                        requiredLevel: 5
                    },
                    { 
                        name: "Mountain Brew", 
                        materials: { ore: 1, herbs: 1, fish: 1 },
                        result: { name: "Mountain Brew", type: "potion", heal: 30 },
                        description: "A potent healing brew. Restores 30 HP.",
                        tier: 2,
                        requiredLevel: 3
                    },
                    { 
                        name: "Forest Bomb", 
                        materials: { herbs: 2, ore: 1, wood: 1 },
                        result: { name: "Forest Bomb", type: "bomb", damage: "15-25" },
                        description: "A makeshift explosive. Deals 15-25 damage to enemy.",
                        tier: 2,
                        requiredLevel: 3
                    },
                    { 
                        name: "Poison Dagger", 
                        materials: { herbs: 3, ore: 1, spiderSilk: 1 },
                        result: { name: "Poison Dagger", type: "poisonDagger", damage: "10 + poison" },
                        description: "A poisoned throwing dagger. Deals 10 damage and poisons enemy.",
                        tier: 3,
                        requiredLevel: 5
                    },
                    { 
                        name: "Greater Health Potion", 
                        materials: { herbs: 3, fish: 1, gems: 1 },
                        result: { name: "Greater Health Potion", type: "potion", heal: 50 },
                        description: "A powerful healing potion. Restores 50 HP.",
                        tier: 4,
                        requiredLevel: 8
                    }
                ]
            }
        };

        // Sound System
        const soundSystem = {
            audioContext: null,
            soundEnabled: true,
            
            init() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            },
            
            playBeep(frequency, duration, type = 'sine') {
                if (!this.soundEnabled || !this.audioContext) return;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = type;
                    
                    gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    console.log("Sound error:", e);
                }
            },
            
            playButtonClick() {
                this.playBeep(800, 0.05, 'square');
            },
            
            playSuccess() {
                this.playBeep(1200, 0.1, 'sine');
                setTimeout(() => this.playBeep(1500, 0.1, 'sine'), 100);
            },
            
            playCombatHit() {
                this.playBeep(300, 0.1, 'sawtooth');
            },
            
            playCombatMiss() {
                this.playBeep(200, 0.2, 'sine');
            },
            
            playLevelUp() {
                this.playBeep(523, 0.1, 'sine'); // C
                setTimeout(() => this.playBeep(659, 0.1, 'sine'), 100); // E
                setTimeout(() => this.playBeep(784, 0.2, 'sine'), 200); // G
            },
            
            playNotification() {
                this.playBeep(1000, 0.2, 'sine');
            },
            
            playDamage() {
                this.playBeep(200, 0.15, 'sawtooth');
            },
            
            playHeal() {
                this.playBeep(600, 0.2, 'sine');
                setTimeout(() => this.playBeep(800, 0.15, 'sine'), 150);
            },
            
            playExplosion() {
                this.playBeep(100, 0.3, 'sawtooth');
                setTimeout(() => this.playBeep(80, 0.2, 'sawtooth'), 50);
            },
            
            playPoison() {
                this.playBeep(400, 0.3, 'triangle');
                setTimeout(() => this.playBeep(350, 0.2, 'triangle'), 150);
            },
            
            playCritical() {
                this.playBeep(600, 0.1, 'square');
                setTimeout(() => this.playBeep(900, 0.1, 'square'), 50);
                setTimeout(() => this.playBeep(1200, 0.2, 'square'), 100);
            },
            
            playGold() {
                this.playBeep(800, 0.1, 'sine');
                setTimeout(() => this.playBeep(1000, 0.1, 'sine'), 100);
                setTimeout(() => this.playBeep(1200, 0.1, 'sine'), 200);
            },
            
            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                gameState.soundEnabled = this.soundEnabled;
                document.getElementById('sound-toggle').textContent = this.soundEnabled ? 'üîä' : 'üîá';
                
                if (this.soundEnabled && !this.audioContext) {
                    this.init();
                }
                
                // Play a test sound when enabling
                if (this.soundEnabled) {
                    setTimeout(() => this.playButtonClick(), 100);
                }
            }
        };

        // ==================== SAVE SYSTEM ====================
        
        function saveGameToSlot(slotNumber, showNotification = true) {
    try {
        const saveData = {
            timestamp: Date.now(),
            gameState: JSON.parse(JSON.stringify(gameState)), // Deep clone
            version: "1.1"
        };
        
        localStorage.setItem(`${SAVE_KEY_PREFIX}${slotNumber}`, JSON.stringify(saveData));
        
        // Auto-save to slot 1
        if (slotNumber === 1) {
            localStorage.setItem(`${SAVE_KEY_PREFIX}auto`, JSON.stringify(saveData));
        }
        
        // Only show message if showNotification is true (not for auto-saves)
        if (showNotification) {
            showMessage(`Game saved to slot ${slotNumber}!`);
            soundSystem.playSuccess();
        }
        return true;
    } catch (error) {
        console.error("Save error:", error);
        if (showNotification) {
            showMessage("Failed to save game!");
        }
        return false;
    }
}
        function loadGameFromSlot(slotNumber) {
            try {
                const saveData = localStorage.getItem(`${SAVE_KEY_PREFIX}${slotNumber}`);
                if (!saveData) {
                    showMessage(`No save data in slot ${slotNumber}`);
                    soundSystem.playNotification();
                    return false;
                }
                
                const parsedData = JSON.parse(saveData);
                
                // Check version compatibility
                if (parsedData.version !== "1.1") {
                    showMessage("Save file version mismatch. Some features may not work.");
                }
                
                // Restore game state
                Object.assign(gameState, parsedData.gameState);
                
                showMessage(`Game loaded from slot ${slotNumber}!`);
                soundSystem.playSuccess();
                
                updateGameScreen();
                updateSkillsScreen();
                showScreen('game-screen');
                return true;
            } catch (error) {
                console.error("Load error:", error);
                showMessage("Failed to load game!");
                return false;
            }
        }
        
        function deleteSaveSlot(slotNumber) {
            if (confirm(`Delete save slot ${slotNumber}?`)) {
                localStorage.removeItem(`${SAVE_KEY_PREFIX}${slotNumber}`);
                if (slotNumber === 1) {
                    localStorage.removeItem(`${SAVE_KEY_PREFIX}auto`);
                }
                showMessage(`Slot ${slotNumber} deleted!`);
                updateSaveScreen();
                soundSystem.playNotification();
            }
        }
        
        function deleteAllSaves() {
            if (confirm("Delete ALL save slots? This cannot be undone!")) {
                for (let i = 1; i <= SAVE_SLOTS; i++) {
                    localStorage.removeItem(`${SAVE_KEY_PREFIX}${i}`);
                }
                localStorage.removeItem(`${SAVE_KEY_PREFIX}auto`);
                showMessage("All saves deleted!");
                updateSaveScreen();
                soundSystem.playNotification();
            }
        }
        
        function autoSave() {
    if (gameState.player.level > 1) { // Don't auto-save at level 1
        saveGameToSlot(1, false); // Pass false to not show notification
    }
}
        
        function updateSaveScreen() {
            const content = document.getElementById('save-slots');
            let html = '';
            
            for (let i = 1; i <= SAVE_SLOTS; i++) {
                const saveData = localStorage.getItem(`${SAVE_KEY_PREFIX}${i}`);
                
                if (saveData) {
                    try {
                        const parsed = JSON.parse(saveData);
                        const date = new Date(parsed.timestamp);
                        const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        html += `
                            <div class="save-slot" onclick="loadGameFromSlot(${i})">
                                <div class="save-level">Slot ${i}: Level ${parsed.gameState.player.level} ${parsed.gameState.player.name}</div>
                                <div class="save-info">${timeStr}</div>
                                <div class="save-info">Gold: ${parsed.gameState.player.gold} | Area: ${parsed.gameState.currentArea}</div>
                                <div style="margin-top: 5px;">
                                    <button class="button button-danger" style="padding: 5px; font-size: 9px;" onclick="event.stopPropagation(); deleteSaveSlot(${i})">DELETE</button>
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        html += `<div class="save-slot">Slot ${i}: Corrupted Save</div>`;
                    }
                } else {
                    html += `
                        <div class="save-slot" onclick="saveGameToSlot(${i}); updateSaveScreen();">
                            <div class="save-level">Slot ${i}: Empty</div>
                            <div class="save-info">Click to save current game here</div>
                        </div>
                    `;
                }
            }
            
            // Check for auto-save
            const autoSave = localStorage.getItem(`${SAVE_KEY_PREFIX}auto`);
            if (autoSave) {
                try {
                    const parsed = JSON.parse(autoSave);
                    const date = new Date(parsed.timestamp);
                    const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    html += `
                        <div class="save-slot" style="border-color: #ff8800;" onclick="loadGameFromSlot(1)">
                            <div class="save-level">‚≠ê Auto-Save: Level ${parsed.gameState.player.level} ${parsed.gameState.player.name}</div>
                            <div class="save-info">${timeStr}</div>
                            <div class="save-info">Gold: ${parsed.gameState.player.gold} | Area: ${parsed.gameState.currentArea}</div>
                        </div>
                    `;
                } catch (e) {
                    // Ignore corrupted auto-save
                }
            }
            
            content.innerHTML = html;
        }
        
        // ==================== SKILL SYSTEM ====================
        
        function updateSkillsScreen() {
            const content = document.getElementById('skills-list');
            const pointsDisplay = document.getElementById('available-skill-points');
            
            pointsDisplay.textContent = gameState.player.skillPoints;
            
            // Show/hide skill points indicator
            const indicator = document.getElementById('skill-points-indicator');
            if (gameState.player.skillPoints > 0) {
                indicator.textContent = gameState.player.skillPoints;
                indicator.style.display = 'flex';
            } else {
                indicator.style.display = 'none';
            }
            
            let html = '';
            
            // Calculate skill effects
            const skillEffects = calculateSkillEffects();
            
            for (const [skillId, skill] of Object.entries(gameState.skills)) {
                const canAfford = gameState.player.skillPoints >= skill.cost;
                const canUpgrade = skill.level < skill.maxLevel;
                const skillName = skillId.charAt(0).toUpperCase() + skillId.slice(1);
                
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background-color: rgba(0, 40, 0, 0.5); border-radius: 4px; border: 2px solid ${canUpgrade ? '#00aa00' : '#555555'}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #ffff00;">${skillName}</strong> 
                                <span style="color: #88ff88;">(Level ${skill.level}/${skill.maxLevel})</span>
                            </div>
                            <div style="color: #ffff88;">Cost: ${skill.cost} point(s)</div>
                        </div>
                        <div style="margin: 5px 0; font-size: 10px; color: #88ffff;">${skill.description}</div>
                        <div style="font-size: 9px; color: #ff88ff;">
                            Current effect: ${getSkillEffectDescription(skillId, skill.level)}
                        </div>
                        <button class="button skill-button ${canUpgrade ? (canAfford ? 'button-success' : 'locked') : 'unlocked'}" 
                                onclick="upgradeSkill('${skillId}')"
                                ${!canUpgrade || !canAfford ? 'disabled' : ''}>
                            ${canUpgrade ? 'UPGRADE' : 'MAX LEVEL'}
                        </button>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            
            // Update reset button visibility
            document.getElementById('reset-skills-btn').style.display = 
                Object.values(gameState.skills).some(s => s.level > 0) ? 'block' : 'none';
        }
        
        function upgradeSkill(skillId) {
            const skill = gameState.skills[skillId];
            
            if (!skill || skill.level >= skill.maxLevel) {
                showMessage("Skill is already at maximum level!");
                soundSystem.playNotification();
                return;
            }
            
            if (gameState.player.skillPoints < skill.cost) {
                showMessage("Not enough skill points!");
                soundSystem.playNotification();
                return;
            }
            
            gameState.player.skillPoints -= skill.cost;
            skill.level++;
            
            // Apply skill effects immediately
            applySkillEffects();
            
            updateSkillsScreen();
            updateGameScreen();
            showMessage(`${skillId} upgraded to level ${skill.level}!`);
            soundSystem.playSuccess();
        }
        
        function calculateSkillEffects() {
            const skills = gameState.skills;
            const effects = {
                extraMaterials: skills.gatherer.level,
                craftingDiscount: skills.blacksmith.level * 0.1,
                extraMaxHp: skills.survivor.level * 10,
                extraAttack: skills.sharpshooter.level,
                potionBonus: skills.alchemist.level * 0.25,
                goldBonus: skills.scavenger.level * 0.15,
                dodgeChance: skills.dodger.level * 5,
                criticalChance: skills.berserker.level * 2,
                extraDefense: skills.toughSkin.level,
                lootChance: skills.treasureHunter.level * 0.1,
                poisonDuration: skills.poisonMaster.level,
                bombDamage: skills.explosiveExpert.level * 0.25
            };
            
            return effects;
        }
        
        function applySkillEffects() {
            const effects = calculateSkillEffects();
            
            // Apply survivor HP bonus
            gameState.player.maxHp = 50 + effects.extraMaxHp;
            
            // Apply sharpshooter attack bonus
            gameState.player.attack = 5 + effects.extraAttack;
            
            // Apply tough skin defense bonus
            gameState.player.defense = 2 + effects.extraDefense;
            
            // Apply berserker critical chance
            gameState.player.criticalChance = 5 + effects.criticalChance;
            
            // Ensure current HP doesn't exceed max HP
            if (gameState.player.hp > gameState.player.maxHp) {
                gameState.player.hp = gameState.player.maxHp;
            }
        }
        
        function getSkillEffectDescription(skillId, level) {
            switch(skillId) {
                case 'gatherer': return `+${level} extra material(s) when gathering`;
                case 'blacksmith': return `-${level * 10}% crafting cost`;
                case 'survivor': return `+${level * 10} max HP`;
                case 'sharpshooter': return `+${level} base attack`;
                case 'alchemist': return `+${level * 25}% potion effectiveness`;
                case 'scavenger': return `+${level * 15}% gold from enemies`;
                case 'dodger': return `+${level * 5}% dodge chance`;
                case 'berserker': return `+${level * 2}% critical chance`;
                case 'toughSkin': return `+${level} defense`;
                case 'treasureHunter': return `+${level * 10}% better loot`;
                case 'poisonMaster': return `Poison lasts +${level} turn(s)`;
                case 'explosiveExpert': return `+${level * 25}% bomb damage`;
                default: return "Unknown effect";
            }
        }
        
        function resetSkills() {
            if (gameState.player.gold < 100) {
                showMessage("You need 100 gold to reset skills!");
                soundSystem.playNotification();
                return;
            }
            
            if (confirm("Reset all skills for 100 gold? This will refund all skill points.")) {
                let totalPoints = 0;
                for (const [skillId, skill] of Object.entries(gameState.skills)) {
                    totalPoints += skill.level * skill.cost;
                    skill.level = 0;
                }
                
                gameState.player.skillPoints += totalPoints;
                gameState.player.gold -= 100;
                
                // Reset base stats
                applySkillEffects();
                
                updateSkillsScreen();
                updateGameScreen();
                showMessage(`Skills reset! ${totalPoints} skill points refunded.`);
                soundSystem.playSuccess();
            }
        }
        
        function awardSkillPoint() {
            // Award skill points every 3 levels
            if (gameState.player.level % 3 === 0) {
                gameState.player.skillPoints++;
                showMessage(`You earned a skill point! You now have ${gameState.player.skillPoints} skill points.`);
                updateSkillsScreen();
            }
        }
        
        // ==================== GAME FUNCTIONS ====================
        
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.getElementById(screenId).classList.add('active');
            
            // Play sound
            soundSystem.playButtonClick();
            
            // Update UI when showing certain screens
            if (screenId === 'game-screen') {
                updateGameScreen();
            } else if (screenId === 'gathering-screen') {
                updateGatheringScreen();
            } else if (screenId === 'crafting-screen') {
                updateCraftingScreen();
            } else if (screenId === 'skills-screen') {
                updateSkillsScreen();
            } else if (screenId === 'save-screen') {
                updateSaveScreen();
            } else if (screenId === 'combat-screen') {
                if (!gameState.combatActive) {
                    startCombat();
                }
            }
        }

        function startGame() {
            // Reset game state
            gameState.player = {
                name: "Adventurer",
                level: 1,
                xp: 0,
                xpToNextLevel: 100,
                hp: 50,
                maxHp: 50,
                attack: 5,
                defense: 2,
                gold: 100,
                skillPoints: 0,
                criticalChance: 5,
                criticalMultiplier: 1.5,
                weapon: { name: "Rusty Dagger", damage: "3-5", type: "weapon", tier: 1 },
                armor: { name: "Leather Tunic", defense: 2, type: "armor", tier: 1 },
                potions: 3,
                specialItems: {
                    bombs: 0,
                    poisonDaggers: 0,
                    strengthElixirs: 0,
                    defenseTonics: 0
                }
            };
            
            // Reset skills
            for (const skillId in gameState.skills) {
                gameState.skills[skillId].level = 0;
            }
            
            gameState.inventory = {
                herbs: 0,
                wood: 0,
                ore: 0,
                gems: 0,
                fish: 0,
                shells: 0,
                spiderSilk: 0,
                wolfPelt: 0,
                batWings: 0,
                serpentScales: 0
            };
            
            gameState.currentArea = "forest";
            gameState.combatActive = false;
            gameState.gameTime = 0;
            gameState.stats = {
                enemiesDefeated: 0,
                materialsGathered: 0,
                itemsCrafted: 0,
                goldEarned: 0,
                damageDealt: 0,
                damageTaken: 0,
                criticalHits: 0
            };
            
            applySkillEffects();
            showScreen('game-screen');
            showMessage("Welcome to Dreadwood Mountain! Gather materials, craft gear, and fight enemies to survive!");
            soundSystem.playSuccess();
            
            // Auto-save new game
            setTimeout(() => saveGameToSlot(1), 500);
        }

        function updateGameScreen() {
            // Update player stats
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('player-hp').textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
            document.getElementById('player-xp').textContent = `${gameState.player.xp}/${gameState.player.xpToNextLevel}`;
            
            // Update XP and HP bars
            const xpPercent = (gameState.player.xp / gameState.player.xpToNextLevel) * 100;
            const xpBar = document.querySelector('#player-xp').previousElementSibling;
            if (xpBar) {
                xpBar.querySelector('.xp-bar').style.width = `${xpPercent}%`;
            }
            
            const hpPercent = (gameState.player.hp / gameState.player.maxHp) * 100;
            const hpBar = document.querySelector('#player-hp').previousElementSibling;
            if (hpBar) {
                hpBar.querySelector('.hp-bar').style.width = `${hpPercent}%`;
            }
            
            // Update area info
            const area = gameData.areas[gameState.currentArea];
            document.getElementById('current-area').textContent = gameState.currentArea.toUpperCase();
            document.getElementById('location-name').textContent = area.name;
            document.getElementById('location-description').textContent = area.description;
            
            // Update game content
            const content = document.getElementById('game-content');
            const skillEffects = calculateSkillEffects();
            
            content.innerHTML = `
                <p>You are in the ${area.name}.</p>
                <p><strong>Gold:</strong> ${gameState.player.gold} ‚≠ê</p>
                <p><strong>Equipped Weapon:</strong> ${gameState.player.weapon.name} (DMG: ${gameState.player.weapon.damage})</p>
                <p><strong>Equipped Armor:</strong> ${gameState.player.armor.name} (DEF: ${gameState.player.armor.defense})</p>
                <p><strong>Health Potions:</strong> ${gameState.player.potions}</p>
                <p><strong>Stats:</strong> ATK ${gameState.player.attack} | DEF ${gameState.player.defense} | Crit ${gameState.player.criticalChance}%</p>
                <div style="margin-top: 15px;">
                    <p><strong>Inventory:</strong></p>
                    ${Object.entries(gameState.inventory).map(([item, count]) => 
                        count > 0 ? `<div class="inventory-item"><span class="item-name">${item.charAt(0).toUpperCase() + item.slice(1).replace(/([A-Z])/g, ' $1')}</span><span class="item-count">${count}</span></div>` : ''
                    ).join('')}
                    ${Object.values(gameState.inventory).every(count => count === 0) ? '<p>Your inventory is empty. Go gather materials!</p>' : ''}
                </div>
                <div style="margin-top: 15px; font-size: 10px; color: #8888ff;">
                    <p><strong>Skill Effects:</strong></p>
                    <p>Extra Materials: +${skillEffects.extraMaterials}</p>
                    <p>Crafting Discount: ${Math.round(skillEffects.craftingDiscount * 100)}%</p>
                    <p>Gold Bonus: ${Math.round(skillEffects.goldBonus * 100)}%</p>
                </div>
            `;
        }

        function changeArea(area) {
            gameState.currentArea = area;
            updateGameScreen();
            showMessage(`You travel to the ${gameData.areas[area].name}.`);
            soundSystem.playButtonClick();
            
            // Auto-save when changing areas
            autoSave();
        }

        function goToGathering() {
            showScreen('gathering-screen');
        }

        function updateGatheringScreen() {
            const area = gameData.areas[gameState.currentArea];
            document.getElementById('gather-area').textContent = area.name;
            
            const content = document.getElementById('gather-content');
            content.innerHTML = `
                <p>Searching the ${area.name} for materials.</p>
                <p>Available materials here: ${area.materials.map(m => m.charAt(0).toUpperCase() + m.slice(1).replace(/([A-Z])/g, ' $1')).join(', ')}</p>
                <div id="gather-results"></div>
            `;
        }

        function changeGatherArea(area) {
            gameState.currentArea = area;
            updateGatheringScreen();
            soundSystem.playButtonClick();
        }

        function gatherMaterials() {
            soundSystem.playButtonClick();
            
            const area = gameData.areas[gameState.currentArea];
            const materials = area.materials;
            const skillEffects = calculateSkillEffects();
            
            // Base materials to find (1-3)
            const baseMaterials = Math.floor(Math.random() * 3) + 1;
            // Add skill bonus
            const extraMaterials = skillEffects.extraMaterials;
            const totalMaterials = baseMaterials + extraMaterials;
            
            const foundMaterials = [];
            
            for (let i = 0; i < totalMaterials; i++) {
                const material = materials[Math.floor(Math.random() * materials.length)];
                gameState.inventory[material]++;
                foundMaterials.push(material);
            }
            
            // Update stats
            gameState.stats.materialsGathered += totalMaterials;
            
            // Display results
            const resultsDiv = document.getElementById('gather-results');
            resultsDiv.innerHTML = `
                <p>You search the area and find:</p>
                ${foundMaterials.map(material => 
                    `<p><strong>${material.charAt(0).toUpperCase() + material.slice(1).replace(/([A-Z])/g, ' $1')}</strong> x1</p>`
                ).join('')}
                ${extraMaterials > 0 ? `<p style="color: #88ff88;">Skill bonus: +${extraMaterials} extra material(s)!</p>` : ''}
                <p style="margin-top: 10px;">Your inventory has been updated.</p>
            `;
            
            // Play success sound
            soundSystem.playSuccess();
            
            // Small chance of enemy encounter
            if (Math.random() < 0.2) {
                setTimeout(() => {
                    showMessage("While gathering, you are ambushed by an enemy!");
                    soundSystem.playNotification();
                    goToCombat();
                }, 1000);
            }
            
            // Auto-save after gathering
            setTimeout(autoSave, 100);
        }

        function goToCrafting() {
            showScreen('crafting-screen');
        }

        function updateCraftingScreen() {
            showCraftingCategory(gameState.craftingCategory);
        }

        function showCraftingCategory(category) {
            gameState.craftingCategory = category;
            
            // Update active tab
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const recipes = gameData.craftingRecipes[category];
            const content = document.getElementById('crafting-content');
            const skillEffects = calculateSkillEffects();
            
            // Filter recipes by player level
            const availableRecipes = recipes.filter(recipe => 
                gameState.player.level >= recipe.requiredLevel
            );
            
            // Group recipes by tier
            const tierGroups = {
                1: [],
                2: [],
                3: [],
                4: []
            };
            
            availableRecipes.forEach(recipe => {
                tierGroups[recipe.tier].push(recipe);
            });
            
            let recipeHTML = '';
            
            // Display recipes by tier
            for (let tier = 1; tier <= 4; tier++) {
                if (tierGroups[tier].length > 0) {
                    recipeHTML += `<p style="color: #ffff00; margin-top: 15px; margin-bottom: 10px;">Tier ${tier} Items:</p>`;
                    
                    tierGroups[tier].forEach(recipe => {
                        // Apply skill discount to material costs
                        const discountedMaterials = {};
                        for (const [material, amount] of Object.entries(recipe.materials)) {
                            const discountedAmount = Math.max(1, Math.floor(amount * (1 - skillEffects.craftingDiscount)));
                            discountedMaterials[material] = discountedAmount;
                        }
                        
                        const canCraft = Object.entries(discountedMaterials).every(([material, amount]) => 
                            gameState.inventory[material] >= amount
                        );
                        
                        // Get stat info for display
                        let statInfo = "";
                        if (recipe.result.type === "weapon") {
                            statInfo = `DMG: ${recipe.result.damage}`;
                        } else if (recipe.result.type === "armor") {
                            statInfo = `DEF: ${recipe.result.defense}`;
                        } else if (recipe.result.type === "potion") {
                            statInfo = `Heal: ${recipe.result.heal} HP`;
                        } else if (recipe.result.type === "bomb") {
                            statInfo = `DMG: ${recipe.result.damage}`;
                        } else if (recipe.result.type === "poisonDagger") {
                            statInfo = `DMG: ${recipe.result.damage}`;
                        } else if (recipe.result.effect) {
                            statInfo = `Effect: ${recipe.result.effect}`;
                        }
                        
                        recipeHTML += `
                            <div class="crafting-recipe">
                                <div class="recipe-title">${recipe.name} (Level ${recipe.requiredLevel}+)</div>
                                <div class="recipe-stats">${statInfo}</div>
                                <div class="recipe-materials">
                                    <p>${recipe.description}</p>
                                    <p style="margin-top: 8px; font-size: 9px;">Requires: ${Object.entries(discountedMaterials).map(([material, amount]) => 
                                        `<span style="color: ${gameState.inventory[material] >= amount ? '#00ff00' : '#ff6666'}">${material.charAt(0).toUpperCase() + material.slice(1).replace(/([A-Z])/g, ' $1')} x${amount}</span>`
                                    ).join(', ')}</p>
                                    ${skillEffects.craftingDiscount > 0 ? `<p style="color: #88ff88; font-size: 8px;">Skill discount applied!</p>` : ''}
                                </div>
                                <button class="button ${canCraft ? 'button-primary' : ''}" 
                                        onclick="craftItem('${category}', '${recipe.name}')"
                                        ${!canCraft ? 'disabled' : ''}>
                                    ${canCraft ? 'CRAFT' : 'NEED MATERIALS'}
                                </button>
                            </div>
                        `;
                    });
                }
            }
            
            if (recipeHTML === '') {
                recipeHTML = `<p>You need to level up to unlock more crafting recipes!</p>`;
            }
            
            content.innerHTML = `
                <p>Crafting ${category.toUpperCase()}:</p>
                ${recipeHTML}
            `;
        }

        function craftItem(category, itemName) {
            soundSystem.playButtonClick();
            
            const recipes = gameData.craftingRecipes[category];
            const recipe = recipes.find(r => r.name === itemName);
            const skillEffects = calculateSkillEffects();
            
            if (!recipe) {
                showMessage("Recipe not found!");
                return;
            }
            
            // Check level requirement
            if (gameState.player.level < recipe.requiredLevel) {
                showMessage(`You need to be level ${recipe.requiredLevel} to craft this item!`);
                soundSystem.playNotification();
                return;
            }
            
            // Apply skill discount to material costs
            const discountedMaterials = {};
            for (const [material, amount] of Object.entries(recipe.materials)) {
                const discountedAmount = Math.max(1, Math.floor(amount * (1 - skillEffects.craftingDiscount)));
                discountedMaterials[material] = discountedAmount;
            }
            
            // Check if player has materials
            const canCraft = Object.entries(discountedMaterials).every(([material, amount]) => 
                gameState.inventory[material] >= amount
            );
            
            if (!canCraft) {
                showMessage(`You don't have enough materials to craft ${itemName}.`);
                soundSystem.playNotification();
                return;
            }
            
            // Deduct materials (with discount applied)
            Object.entries(discountedMaterials).forEach(([material, amount]) => {
                gameState.inventory[material] -= amount;
            });
            
            // Apply result
            const result = recipe.result;
            
            if (category === 'weapons') {
                gameState.player.weapon = result;
                showMessage(`You crafted a ${itemName}! (DMG: ${result.damage})`);
                soundSystem.playSuccess();
            } else if (category === 'armor') {
                gameState.player.armor = result;
                showMessage(`You crafted ${itemName}! (DEF: ${result.defense})`);
                soundSystem.playSuccess();
            } else if (category === 'consumables') {
                if (result.type === "potion") {
                    // Apply alchemist skill bonus
                    const healAmount = skillEffects.potionBonus > 0 ? 
                        Math.floor(result.heal * (1 + skillEffects.potionBonus)) : result.heal;
                    gameState.player.potions++;
                    showMessage(`You crafted a ${itemName}! (Heals: ${healAmount} HP)`);
                } else if (result.type === "bomb") {
                    gameState.player.specialItems.bombs++;
                    showMessage(`You crafted a ${itemName}! (Deals: ${result.damage} damage)`);
                } else if (result.type === "poisonDagger") {
                    gameState.player.specialItems.poisonDaggers++;
                    showMessage(`You crafted a ${itemName}! (Deals: ${result.damage})`);
                } else if (result.type === "elixir") {
                    if (result.name === "Strength Elixir") {
                        gameState.player.specialItems.strengthElixirs++;
                        showMessage(`You crafted a ${itemName}! (${result.effect})`);
                    } else if (result.name === "Defense Tonic") {
                        gameState.player.specialItems.defenseTonics++;
                        showMessage(`You crafted a ${itemName}! (${result.effect})`);
                    }
                }
                soundSystem.playSuccess();
            }
            
            // Update stats
            gameState.stats.itemsCrafted++;
            
            updateCraftingScreen();
            updateGameScreen();
            
            // Auto-save after crafting
            setTimeout(autoSave, 100);
        }

        function goToCombat() {
            showScreen('combat-screen');
        }

        function startCombat() {
            gameState.combatActive = true;
            
            const area = gameData.areas[gameState.currentArea];
            const enemies = area.enemies;
            
            // Select enemy based on player level
            let enemyName;
            if (gameState.player.level < 3) {
                enemyName = enemies[0]; // Weakest enemy
            } else if (gameState.player.level < 6) {
                enemyName = enemies[Math.floor(Math.random() * 2)]; // First two enemies
            } else if (gameState.player.level < 10) {
                enemyName = enemies[Math.floor(Math.random() * 3)]; // First three enemies
            } else {
                enemyName = enemies[Math.floor(Math.random() * enemies.length)]; // Any enemy
            }
            
            const enemyStats = area.enemyStats[enemyName];
            
            // Scale enemy stats based on player level (balanced scaling)
            const scaleFactor = 1 + (gameState.player.level - 1) * 0.1; // Reduced from 0.2 to 0.1
            const scaledHp = Math.floor(enemyStats.hp * scaleFactor);
            const scaledMaxHp = Math.floor(enemyStats.maxHp * scaleFactor);
            const scaledXp = Math.floor(enemyStats.xp * scaleFactor);
            
            // Calculate scaled damage
            const damageRange = enemyStats.attack.split('-').map(Number);
            const scaledMinDmg = Math.floor(damageRange[0] * scaleFactor);
            const scaledMaxDmg = Math.floor(damageRange[1] * scaleFactor);
            const scaledAttack = `${scaledMinDmg}-${scaledMaxDmg}`;
            
            // Calculate gold reward
            const goldRange = enemyStats.gold.split('-').map(Number);
            const minGold = Math.floor(goldRange[0] * scaleFactor);
            const maxGold = Math.floor(goldRange[1] * scaleFactor);
            
            gameState.enemy = {
                name: enemyName,
                hp: scaledHp,
                maxHp: scaledMaxHp,
                attack: scaledAttack,
                xp: scaledXp,
                gold: `${minGold}-${maxGold}`,
                special: enemyStats.special,
                weakTo: enemyStats.weakTo,
                isPoisoned: false,
                poisonTurns: 0,
                isStunned: false
            };
            
            updateCombatScreen();
            
            const combatLog = document.getElementById('combat-log');
            combatLog.innerHTML = `<div class="log-entry event-log">A ${enemyName} appears! ${enemyStats.special ? `(Special: ${enemyStats.special})` : ''}</div>`;
            scrollCombatLogToBottom();
            
            soundSystem.playNotification();
        }

        function updateCombatScreen() {
            if (!gameState.enemy) return;
            
            const enemy = gameState.enemy;
            document.getElementById('enemy-name').textContent = enemy.name;
            document.getElementById('enemy-hp').textContent = enemy.hp;
            document.getElementById('enemy-max-hp').textContent = enemy.maxHp;
            document.getElementById('enemy-dmg').textContent = enemy.attack;
            document.getElementById('enemy-xp').textContent = enemy.xp;
            
            // Set enemy emoji based on type
            const enemyImage = document.getElementById('enemy-image');
            if (enemy.name.includes("Goblin")) enemyImage.textContent = "üëπ";
            else if (enemy.name.includes("Spider")) enemyImage.textContent = "üï∑Ô∏è";
            else if (enemy.name.includes("Wolf")) enemyImage.textContent = "üê∫";
            else if (enemy.name.includes("Treant")) enemyImage.textContent = "üå≥";
            else if (enemy.name.includes("Troll")) enemyImage.textContent = "üë∫";
            else if (enemy.name.includes("Golem")) enemyImage.textContent = "üóø";
            else if (enemy.name.includes("Bat")) enemyImage.textContent = "ü¶á";
            else if (enemy.name.includes("Giant")) enemyImage.textContent = "üëπ";
            else if (enemy.name.includes("Serpent")) enemyImage.textContent = "üêç";
            else if (enemy.name.includes("Frog")) enemyImage.textContent = "üê∏";
            else if (enemy.name.includes("Spirit")) enemyImage.textContent = "üëª";
            else if (enemy.name.includes("Kraken")) enemyImage.textContent = "üêô";
            else enemyImage.textContent = "üëæ";
            
            // Show status effects
            if (enemy.isPoisoned) {
                enemyImage.textContent += " üíÄ";
            }
            if (enemy.isStunned) {
                enemyImage.textContent += " üí´";
            }
            
            document.getElementById('combat-area').textContent = `${gameData.areas[gameState.currentArea].name} Combat`;
        }

        function scrollCombatLogToBottom() {
            const combatLog = document.getElementById('combat-log');
            combatLog.scrollTop = combatLog.scrollHeight;
        }

        function addCombatLog(text, type = "event", isCritical = false) {
            const combatLog = document.getElementById('combat-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}-log ${isCritical ? 'critical-log' : ''}`;
            entry.textContent = text;
            combatLog.appendChild(entry);
            scrollCombatLogToBottom();
        }

        function playerAttack() {
            if (!gameState.combatActive || !gameState.enemy) return;
            
            soundSystem.playButtonClick();
            
            const combatLog = document.getElementById('combat-log');
            
            // Check for stun
            if (gameState.enemy.isStunned) {
                addCombatLog(`${gameState.enemy.name} is stunned and cannot act!`, "event");
                gameState.enemy.isStunned = false;
                updateCombatScreen();
                setTimeout(() => {
                    checkEnemyStatusEffects();
                    enemyAttack();
                }, 500);
                return;
            }
            
            // Player attack
            const weaponDamage = gameState.player.weapon.damage.split('-').map(Number);
            const baseDamage = Math.floor(Math.random() * (weaponDamage[1] - weaponDamage[0] + 1)) + weaponDamage[0];
            const attackBonus = gameState.player.attack;
            let totalDamage = baseDamage + attackBonus;
            
            // Check for critical hit
            const isCritical = Math.random() * 100 < gameState.player.criticalChance;
            if (isCritical) {
                totalDamage = Math.floor(totalDamage * gameState.player.criticalMultiplier);
                gameState.stats.criticalHits++;
                soundSystem.playCritical();
            }
            
            gameState.enemy.hp -= totalDamage;
            gameState.stats.damageDealt += totalDamage;
            
            if (isCritical) {
                addCombatLog(`CRITICAL HIT! You attack for ${totalDamage} damage!`, "player", true);
            } else {
                addCombatLog(`You attack for ${totalDamage} damage!`, "player");
            }
            soundSystem.playCombatHit();
            
            // Check if enemy is defeated
            if (gameState.enemy.hp <= 0) {
                enemyDefeated();
                return;
            }
            
            // Apply poison damage if enemy is poisoned
            if (gameState.enemy.isPoisoned && gameState.enemy.poisonTurns > 0) {
                checkEnemyStatusEffects();
                if (gameState.enemy.hp <= 0) {
                    enemyDefeated();
                    return;
                }
            }
            
            updateCombatScreen();
            
            // Enemy attack
            setTimeout(() => {
                enemyAttack();
            }, 500);
        }

        function enemyAttack() {
            const enemy = gameState.enemy;
            
            // Enemy attack
            const enemyDamageRange = enemy.attack.split('-').map(Number);
            const enemyAttack = Math.floor(Math.random() * (enemyDamageRange[1] - enemyDamageRange[0] + 1)) + enemyDamageRange[0];
            
            // Apply player defense and dodge chance
            const skillEffects = calculateSkillEffects();
            const dodgeRoll = Math.random() * 100;
            
            if (dodgeRoll < skillEffects.dodgeChance) {
                addCombatLog(`${enemy.name} attacks but you dodge!`, "event");
                soundSystem.playCombatMiss();
            } else {
                const damageTaken = Math.max(1, enemyAttack - gameState.player.armor.defense);
                gameState.player.hp -= damageTaken;
                gameState.stats.damageTaken += damageTaken;
                
                addCombatLog(`${enemy.name} attacks for ${damageTaken} damage!`, "enemy");
                soundSystem.playDamage();
                
                // Check if player is defeated
                if (gameState.player.hp <= 0) {
                    gameState.player.hp = 0;
                    addCombatLog(`You have been defeated!`, "event");
                    addCombatLog(`Game over! You will be revived with half health.`, "event");
                    
                    setTimeout(() => {
                        gameState.player.hp = Math.floor(gameState.player.maxHp / 2);
                        gameState.combatActive = false;
                        showScreen('game-screen');
                        soundSystem.playNotification();
                        autoSave();
                    }, 2000);
                }
            }
            
            updateCombatScreen();
        }

        function enemyDefeated() {
            const enemy = gameState.enemy;
            enemy.hp = 0;
            
            addCombatLog(`You defeated the ${enemy.name}!`, "event");
            
            // Award XP
            gameState.player.xp += enemy.xp;
            addCombatLog(`You gained ${enemy.xp} XP!`, "event");
            
            // Award gold with scavenger skill bonus
            const skillEffects = calculateSkillEffects();
            const goldRange = enemy.gold.split('-').map(Number);
            const baseGold = Math.floor(Math.random() * (goldRange[1] - goldRange[0] + 1)) + goldRange[0];
            const bonusGold = Math.floor(baseGold * skillEffects.goldBonus);
            const totalGold = baseGold + bonusGold;
            
            gameState.player.gold += totalGold;
            gameState.stats.goldEarned += totalGold;
            
            addCombatLog(`You found ${totalGold} gold! ${bonusGold > 0 ? `(+${bonusGold} skill bonus)` : ''}`, "event");
            soundSystem.playGold();
            
            // Award random material from area with treasure hunter skill bonus
            const areaMaterials = gameData.areas[gameState.currentArea].materials;
            const randomMaterial = areaMaterials[Math.floor(Math.random() * areaMaterials.length)];
            gameState.inventory[randomMaterial]++;
            
            let lootMessage = `You found ${randomMaterial.charAt(0).toUpperCase() + randomMaterial.slice(1).replace(/([A-Z])/g, ' $1')}!`;
            
            // Chance for rare material based on skill
            if (Math.random() < (0.1 + skillEffects.lootChance)) {
                const rareMaterials = ["gems", "serpentScales", "wolfPelt", "batWings"];
                const rareMaterial = rareMaterials[Math.floor(Math.random() * rareMaterials.length)];
                if (areaMaterials.includes(rareMaterial) || Math.random() < 0.3) {
                    gameState.inventory[rareMaterial]++;
                    lootMessage += ` And rare ${rareMaterial.charAt(0).toUpperCase() + rareMaterial.slice(1).replace(/([A-Z])/g, ' $1')}!`;
                }
            }
            
            addCombatLog(lootMessage, "event");
            
            // Update stats
            gameState.stats.enemiesDefeated++;
            
            // Check for level up
            checkLevelUp();
            
            gameState.combatActive = false;
            updateCombatScreen();
            soundSystem.playSuccess();
            
            // Auto-save after combat
            setTimeout(autoSave, 100);
        }

        function checkEnemyStatusEffects() {
            const enemy = gameState.enemy;
            
            if (enemy.isPoisoned && enemy.poisonTurns > 0) {
                const poisonDamage = 5;
                enemy.hp -= poisonDamage;
                enemy.poisonTurns--;
                addCombatLog(`${enemy.name} takes ${poisonDamage} poison damage!`, "event");
                soundSystem.playPoison();
                
                if (enemy.hp <= 0) {
                    enemyDefeated();
                    return true;
                }
                
                if (enemy.poisonTurns === 0) {
                    enemy.isPoisoned = false;
                    addCombatLog(`The poison wears off.`, "event");
                }
            }
            
            return false;
        }

        function usePotion() {
            soundSystem.playButtonClick();
            
            if (gameState.player.potions <= 0) {
                addCombatLog("You don't have any potions left!", "event");
                soundSystem.playNotification();
                return;
            }
            
            gameState.player.potions--;
            const skillEffects = calculateSkillEffects();
            const baseHeal = 20; // Basic potion heals 20
            const bonusHeal = skillEffects.potionBonus > 0 ? Math.floor(baseHeal * skillEffects.potionBonus) : 0;
            const totalHeal = baseHeal + bonusHeal;
            
            gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + totalHeal);
            
            addCombatLog(`You use a health potion and heal ${totalHeal} HP! ${bonusHeal > 0 ? `(+${bonusHeal} skill bonus)` : ''}`, "event");
            soundSystem.playHeal();
            
            updateCombatScreen();
            
            // Enemy still attacks after potion use
            setTimeout(() => {
                enemyAttack();
            }, 500);
        }

        function useSpecialItem() {
            soundSystem.playButtonClick();
            
            // Check what special items player has
            if (gameState.player.specialItems.strengthElixirs > 0) {
                useStrengthElixir();
            } else if (gameState.player.specialItems.defenseTonics > 0) {
                useDefenseTonic();
            } else if (gameState.player.specialItems.bombs > 0) {
                useBomb();
            } else if (gameState.player.specialItems.poisonDaggers > 0) {
                usePoisonDagger();
            } else {
                addCombatLog("You don't have any special items!", "event");
                soundSystem.playNotification();
            }
        }

        function useStrengthElixir() {
            if (gameState.player.specialItems.strengthElixirs <= 0) return;
            
            gameState.player.specialItems.strengthElixirs--;
            gameState.player.attack += 3;
            
            addCombatLog(`You drink a Strength Elixir! Attack increased by 3 for this battle!`, "event");
            soundSystem.playSuccess();
            
            updateCombatScreen();
            
            // Enemy still attacks
            setTimeout(() => {
                enemyAttack();
            }, 500);
        }

        function useDefenseTonic() {
            if (gameState.player.specialItems.defenseTonics <= 0) return;
            
            gameState.player.specialItems.defenseTonics--;
            gameState.player.defense += 3;
            
            addCombatLog(`You drink a Defense Tonic! Defense increased by 3 for this battle!`, "event");
            soundSystem.playSuccess();
            
            updateCombatScreen();
            
            // Enemy still attacks
            setTimeout(() => {
                enemyAttack();
            }, 500);
        }

        function useBomb() {
            if (gameState.player.specialItems.bombs <= 0) return;
            
            gameState.player.specialItems.bombs--;
            const skillEffects = calculateSkillEffects();
            const baseDamage = Math.floor(Math.random() * 11) + 15; // 15-25 damage
            const bonusDamage = Math.floor(baseDamage * skillEffects.bombDamage);
            const totalDamage = baseDamage + bonusDamage;
            
            gameState.enemy.hp -= totalDamage;
            
            addCombatLog(`You throw a bomb for ${totalDamage} damage! ${bonusDamage > 0 ? `(+${bonusDamage} skill bonus)` : ''}`, "player");
            soundSystem.playExplosion();
            
            // Check if enemy is defeated
            if (gameState.enemy.hp <= 0) {
                enemyDefeated();
                return;
            }
            
            updateCombatScreen();
            
            // Enemy attack
            setTimeout(() => {
                enemyAttack();
            }, 500);
        }

        function usePoisonDagger() {
            if (gameState.player.specialItems.poisonDaggers <= 0) return;
            
            gameState.player.specialItems.poisonDaggers--;
            const skillEffects = calculateSkillEffects();
            const daggerDamage = 10;
            gameState.enemy.hp -= daggerDamage;
            gameState.enemy.isPoisoned = true;
            gameState.enemy.poisonTurns = 3 + skillEffects.poisonDuration;
            
            addCombatLog(`You throw a poison dagger for ${daggerDamage} damage!`, "player");
            addCombatLog(`${gameState.enemy.name} is poisoned for ${gameState.enemy.poisonTurns} turns!`, "event");
            soundSystem.playPoison();
            
            // Check if enemy is defeated
            if (gameState.enemy.hp <= 0) {
                enemyDefeated();
                return;
            }
            
            updateCombatScreen();
            
            // Enemy attack
            setTimeout(() => {
                enemyAttack();
            }, 500);
        }

        function fleeCombat() {
            soundSystem.playButtonClick();
            
            if (!gameState.combatActive) return;
            
            const fleeSuccess = Math.random() < 0.5; // 50% chance to flee
            
            if (fleeSuccess) {
                addCombatLog(`You successfully fled from combat!`, "event");
                gameState.combatActive = false;
                soundSystem.playSuccess();
                
                setTimeout(() => {
                    showScreen('game-screen');
                }, 1500);
            } else {
                addCombatLog(`You failed to flee!`, "event");
                soundSystem.playCombatMiss();
                
                // Enemy attacks when flee fails
                setTimeout(() => {
                    enemyAttack();
                }, 500);
            }
        }

        function checkLevelUp() {
            while (gameState.player.xp >= gameState.player.xpToNextLevel) {
                gameState.player.level++;
                gameState.player.xp -= gameState.player.xpToNextLevel;
                gameState.player.xpToNextLevel = Math.floor(gameState.player.xpToNextLevel * 1.4); // Reduced from 1.5
                
                // Apply skill effects to get updated stats
                applySkillEffects();
                
                // Award skill point every 3 levels
                awardSkillPoint();
                
                addCombatLog(`You leveled up! You are now level ${gameState.player.level}!`, "event");
                addCombatLog(`Max HP: ${gameState.player.maxHp} | Attack: ${gameState.player.attack} | Defense: ${gameState.player.defense}`, "event");
                soundSystem.playLevelUp();
            }
        }

        function showMessage(text) {
            document.getElementById('message-text').textContent = text;
            document.getElementById('game-message').style.display = 'block';
            soundSystem.playNotification();
        }

        function hideMessage() {
            document.getElementById('game-message').style.display = 'none';
            soundSystem.playButtonClick();
        }

        // Initialize the game
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize sound system
            soundSystem.init();
            
            // Set up sound toggle button
            document.getElementById('sound-toggle').addEventListener('click', () => {
                soundSystem.toggleSound();
            });
            
            // Update HP and XP bars initially
            const hpBarContainer = document.querySelector('#player-hp').previousElementSibling;
            if (hpBarContainer) {
                hpBarContainer.innerHTML = '<div class="hp-bar" style="width: 100%"></div>';
            }
            
            const xpBarContainer = document.querySelector('#player-xp').previousElementSibling;
            if (xpBarContainer) {
                xpBarContainer.innerHTML = '<div class="xp-bar" style="width: 0%"></div>';
            }
            
            // Make buttons more responsive on mobile and add sound
            document.querySelectorAll('.button').forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.transform = 'scale(1)';
                });
                
                button.addEventListener('click', function() {
                    soundSystem.playButtonClick();
                });
            });
            
            // Set up category tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.category-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            
            // Initialize sound toggle button text
            document.getElementById('sound-toggle').textContent = soundSystem.soundEnabled ? 'üîä' : 'üîá';
            
            // Check for auto-save on load
            const autoSave = localStorage.getItem(`${SAVE_KEY_PREFIX}auto`);
            if (autoSave) {
                try {
                    const parsed = JSON.parse(autoSave);
                    const timeSinceSave = Date.now() - parsed.timestamp;
                    const hoursSinceSave = timeSinceSave / (1000 * 60 * 60);
                    
                    if (hoursSinceSave < 24) { // Only show if save is less than 24 hours old
                        document.querySelector('button[onclick="showScreen(\'save-screen\')"]').textContent = "CONTINUE";
                    }
                } catch (e) {
                    // Ignore corrupted auto-save
                }
            }
            
            // Start game time counter
            setInterval(() => {
                gameState.gameTime++;
                // Auto-save every 5 minutes
                if (gameState.gameTime % 300 === 0 && gameState.player.level > 1) {
                    autoSave();
                }
            }, 1000);
        });
    </script>
</body>
</html>
