<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DreadWood: Bloodstone Keep</title>
    <style>
        /* Bloodstone-themed colors - deep reds and crimsons */
        body {
            font-family: 'Courier New', monospace;
            background-color: #1a0a0a;
            color: #ff3333;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            border: 2px solid #ff3333;
            background-color: #000;
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #ff3333;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #ff3333;
            text-shadow: 0 0 5px #ff3333;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
        }
        
        h2 {
            color: #ff6666;
            border-bottom: 1px solid #ff6666;
            padding-bottom: 5px;
            margin-top: 25px;
        }
        
        .screen {
            display: none;
        }
        
        .active-screen {
            display: block;
        }
        
        .stats-bar {
            background-color: #2a0a0a;
            border: 1px solid #ff3333;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-value {
            color: #ffff33;
            font-weight: bold;
        }
        
        .inventory {
            background-color: #221111;
            border: 1px solid #ff6666;
            padding: 10px;
            margin: 15px 0;
            min-height: 60px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #442222;
            border: 1px solid #ff6666;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
        }
        
        .story-text {
            background-color: #111111;
            border: 1px solid #ff3333;
            padding: 15px;
            margin: 20px 0;
            min-height: 150px;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #332222;
            color: #ff3333;
            border: 2px solid #ff3333;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #553333;
            color: #ff9999;
            border-color: #ff9999;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #330000;
            color: #ff6666;
            border: 2px solid #ff6666;
            padding: 10px 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #550000;
            color: #ff9999;
        }
        
        .dice-roll {
            background-color: #332222;
            border: 1px solid #ff3333;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ffff33;
        }
        
        .game-over {
            color: #ff3333;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #ff3333;
        }
        
        .success {
            color: #33ff33;
            font-weight: bold;
        }
        
        .damage {
            color: #ff3333;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9933;
            font-weight: bold;
        }
        
        .bloodstone {
            color: #ff3366;
            font-weight: bold;
            text-shadow: 0 0 3px #ff3366;
        }
        
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #330033;
            color: #ff33ff;
            border: 2px solid #ff33ff;
            padding: 15px 30px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #550055;
            color: #ff99ff;
        }
        
        .retro-notice {
            text-align: center;
            color: #888888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333333;
            padding-top: 10px;
        }
        
        .warning-dialog {
            background-color: #332222;
            border: 2px solid #ff3333;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .warning-text {
            color: #ff9933;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .dialog-btn {
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid;
        }
        
        .dialog-btn-yes {
            background-color: #223322;
            color: #33ff33;
            border-color: #33ff33;
        }
        
        .dialog-btn-no {
            background-color: #332222;
            color: #ff3333;
            border-color: #ff3333;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 10px;
                font-size: 14px;
            }
            
            .dialog-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DREADWOOD</h1>
            <h2>BLOODSTONE KEEP</h2>
            <div class="retro-notice">Level 4 - The Fortress That Bleeds</div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item">SKILL: <span id="stat-skill" class="stat-value">0</span></div>
                <div class="stat-item">STAMINA: <span id="stat-stamina" class="stat-value">0</span>/<span id="stat-maxstamina" class="stat-value">0</span></div>
                <div class="stat-item">LUCK: <span id="stat-luck" class="stat-value">0</span></div>
                <div class="stat-item">GOLD: <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <h2>INVENTORY</h2>
            <div class="inventory" id="inventory">
                <!-- Inventory will be loaded from saved game -->
            </div>
            
            <h2>THE ADVENTURE</h2>
            <div class="story-text" id="story-text">
                <p>Before you stands <span class="bloodstone">BLOODSTONE KEEP</span>, a fortress hewn from crimson stone that seems to weep red droplets. The air tastes of iron and ancient magic. Legends say the stones were soaked in dragon's blood, granting them unnatural properties. The entrance yawns like a hungry maw. How will you approach this foreboding place?</p>
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <button class="choice-btn" onclick="loadSection(1)">Approach the Main Gate</button>
                <button class="choice-btn" onclick="loadSection(2)">Search for a Secret Entrance</button>
                <button class="choice-btn" onclick="loadSection(3)">Scale the Outer Wall</button>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useLuck()">TEST LUCK</button>
                <button class="action-btn" onclick="checkInventory()">INVENTORY</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="showNewGameWarning()">START NEW GAME</button>
            </div>
        </div>
        
        <!-- Warning Dialog for New Game -->
        <div id="warning-dialog" class="screen">
            <div class="warning-dialog">
                <div class="warning-text">WARNING: Starting a new game will delete ALL your current progress!</div>
                <p>Your current character, stats, inventory, and gold will be permanently erased.</p>
                <p>You will return to the beginning of the game to create a new character.</p>
                <div class="dialog-buttons">
                    <button class="dialog-btn dialog-btn-yes" onclick="startNewGame()">YES, START NEW GAME</button>
                    <button class="dialog-btn dialog-btn-no" onclick="cancelNewGame()">NO, KEEP MY CHARACTER</button>
                </div>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>VICTORY!</h2>
            <div class="story-text">
                <p>You have conquered <span class="bloodstone">BLOODSTONE KEEP</span>!</p>
                <p>Beyond the keep stretches the <span class="enemy">ASHEN WASTES</span>, a desolate landscape of volcanic ash and bubbling geysers. The air is thick with sulfur and the ground trembles with distant eruptions.</p>
                <p>Your journey continues... All your stats, gold, and inventory will carry over to the next chapter.</p>
                <div class="stats-bar">
                    <div class="stat-item">SKILL: <span id="next-stat-skill" class="stat-value">0</span></div>
                    <div class="stat-item">STAMINA: <span id="next-stat-stamina" class="stat-value">0</span></div>
                    <div class="stat-item">LUCK: <span id="next-stat-luck" class="stat-value">0</span></div>
                    <div class="stat-item">GOLD: <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO ASHEN WASTES</button>
            </div>
        </div>
        
        <div class="retro-notice">
            DREADWOOD - A Retro Gamebook Adventure<br>
            Level 4: Bloodstone Keep
        </div>
    </div>

    <script>
        // Game state (loaded from localStorage)
        let gameState = JSON.parse(localStorage.getItem('dreadwoodGameState')) || {
            playerClass: 'warrior',
            skill: 12,
            maxStamina: 20,
            stamina: 20,
            luck: 12,
            gold: 50,
            inventory: ['Dagger', 'Leather Armor'],
            weapons: [{name: 'Dagger', damage: '1d6'}],
            armor: [{name: 'Leather Armor', defense: 1}],
            currentWeaponIndex: 0,
            currentArmorIndex: 0,
            currentSection: 0,
            gameComplete: false
        };
        
        // Combat state for multi-round battles
        let combatState = {
            active: false,
            enemyName: '',
            enemyStamina: 0,
            enemyCurrentStamina: 0,
            enemySkill: 0,
            nextSection: 0,
            round: 1
        };
        
        // FIX: Reset currentSection when starting a new level
        if (gameState.currentSection === 200 || gameState.gameComplete) {
            gameState.currentSection = 0;
            gameState.gameComplete = false;
        }
        
        // Ensure indices exist
        if (gameState.currentWeaponIndex === undefined) {
            gameState.currentWeaponIndex = gameState.weapons.length - 1;
        }
        if (gameState.currentArmorIndex === undefined) {
            gameState.currentArmorIndex = gameState.armor.length - 1;
        }
        
        // Level 4 story sections - BLOODSTONE KEEP
        const storySections = {
            0: {
                text: "Before you stands <span class='bloodstone'>BLOODSTONE KEEP</span>, a fortress hewn from crimson stone that seems to weep red droplets. The air tastes of iron and ancient magic. Legends say the stones were soaked in dragon's blood, granting them unnatural properties. The entrance yawns like a hungry maw. How will you approach this foreboding place?",
                choices: [
                    {text: "Approach the Main Gate", nextSection: 1, skillCheck: false},
                    {text: "Search for a Secret Entrance", nextSection: 2, skillCheck: false},
                    {text: "Scale the Outer Wall", nextSection: 3, skillCheck: false}
                ]
            },
            1: {
                text: "You approach the massive iron-banded gate. Two stone gargoyles flank the entrance, their eyes glowing with crimson light. As you near, one speaks in a grinding stone voice: 'None may enter Bloodstone Keep without answering the Riddle of Blood.'",
                choices: [
                    {text: "Ask to hear the riddle", nextSection: 4, skillCheck: false},
                    {text: "Attack the gargoyles", nextSection: 5, skillCheck: false},
                    {text: "Try to find another way around", nextSection: 6, skillCheck: false}
                ]
            },
            2: {
                text: "You circle the keep, searching the crimson stone walls. After some time, you find a hidden alcove covered in vines. Behind them is a small door with a strange lock shaped like a bleeding heart.",
                choices: [
                    {text: "Try to pick the lock", nextSection: 7, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Force the door open", nextSection: 8, skillCheck: false},
                    {text: "Search for a key", nextSection: 9, skillCheck: false}
                ]
            },
            3: {
                text: "You find a section of wall with good handholds. The crimson stone is rough and porous, making climbing possible but treacherous. Red liquid seeps from the stones, making them slick.",
                choices: [
                    {text: "Attempt to climb the wall", nextSection: 10, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Look for climbing gear", nextSection: 11, skillCheck: false},
                    {text: "Try a different approach", nextSection: 0, skillCheck: false}
                ]
            },
            4: {
                text: "The gargoyle speaks: 'I flow without life, I cry without eyes. Kings have spilt me in sacrifice, warriors wear me as prize. What am I?'",
                choices: [
                    {text: "Answer: 'Blood'", nextSection: 12, skillCheck: false},
                    {text: "Answer: 'Wine'", nextSection: 13, skillCheck: false},
                    {text: "Answer: 'Tears'", nextSection: 14, skillCheck: false},
                    {text: "Attack instead of answering", nextSection: 5, skillCheck: false}
                ]
            },
            5: {
                text: "You attack the stone gargoyles! They come to life, stone wings spreading! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 501, skillCheck: false}
                ]
            },
            501: {
                text: "You face the Stone Gargoyles! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 502, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat
                    combatState.active = true;
                    combatState.enemyName = "Stone Gargoyles";
                    combatState.enemyStamina = 18;
                    combatState.enemyCurrentStamina = 18;
                    combatState.enemySkill = 10;
                    combatState.nextSection = 27; // Where to go after combat
                    combatState.round = 1;
                    
                    return "Stone Gargoyles: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            6: {
                text: "You retreat from the gate and continue searching the keep's perimeter. You find a drainage grate leading underground.",
                choices: [
                    {text: "Enter through the drainage grate", nextSection: 17, skillCheck: false},
                    {text: "Keep searching", nextSection: 2, skillCheck: false}
                ]
            },
            7: {
                text: "You attempt to pick the lock...",
                choices: [
                    {text: "Roll for skill", nextSection: 701, skillCheck: false}
                ]
            },
            701: {
                text: "", // Will be filled by skill check
                choices: [
                    {text: "Continue", nextSection: 702, skillCheck: false}
                ],
                action: function() {
                    const diceRoll = rollDiceHelper(2, 6);
                    const success = diceRoll <= gameState.skill + 3; // +3 for difficulty 13
                    
                    window.checkResult = success;
                    
                    let resultText = `You roll ${diceRoll}. Your SKILL is ${gameState.skill}. `;
                    resultText += success ? 
                        `<span class="success">Success!</span>` : 
                        `<span class="damage">Failure!</span>`;
                    
                    storySections[702].text = success ? 
                        "You successfully pick the lock! The door swings open silently, revealing a dark passage." : 
                        "The lock is too complex. You break your lockpick trying to open it.";
                    
                    storySections[702].choices = success ? 
                        [{text: "Enter the secret passage", nextSection: 18, skillCheck: false}] :
                        [{text: "Try another approach", nextSection: 19, skillCheck: false}];
                    
                    return resultText;
                }
            },
            702: {
                text: "", // Filled by skill check
                choices: [] // Filled by skill check
            },
            8: {
                text: "You put your shoulder against the door and push with all your might. The door groans but doesn't budge. You take 3 Stamina from the strain.",
                choices: [
                    {text: "Try again with more force", nextSection: 20, skillCheck: false},
                    {text: "Give up and try another way", nextSection: 0, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina -= 3;
                    updateStatsDisplay();
                    return "You strain against the door and lose 3 Stamina!";
                }
            },
            9: {
                text: "You search the area around the hidden door. In a nearby bush, you find a skeleton clutching an iron key shaped like a bleeding heart.",
                choices: [
                    {text: "Take the key and open the door", nextSection: 21, skillCheck: false},
                    {text: "Search the skeleton for other items", nextSection: 22, skillCheck: false}
                ]
            },
            10: {
                text: "You attempt to climb the wall...",
                choices: [
                    {text: "Roll for skill", nextSection: 1001, skillCheck: false}
                ]
            },
            1001: {
                text: "", // Will be filled by skill check
                choices: [
                    {text: "Continue", nextSection: 1002, skillCheck: false}
                ],
                action: function() {
                    const diceRoll = rollDiceHelper(2, 6);
                    const success = diceRoll <= gameState.skill + 2; // +2 for difficulty 12
                    
                    window.checkResult = success;
                    
                    let resultText = `You roll ${diceRoll}. Your SKILL is ${gameState.skill}. `;
                    resultText += success ? 
                        `<span class="success">Success!</span>` : 
                        `<span class="damage">Failure!</span>`;
                    
                    if (success) {
                        storySections[1002].text = "You skillfully scale the wall, avoiding the slippery patches. You reach the top and drop into a courtyard.";
                        storySections[1002].choices = [{text: "Explore the courtyard", nextSection: 23, skillCheck: false}];
                    } else {
                        gameState.stamina -= 8;
                        updateStatsDisplay();
                        storySections[1002].text = "You slip on the bloody stone! You fall and take 8 damage.";
                        storySections[1002].choices = [{text: "Nurse your wounds and try another way", nextSection: 24, skillCheck: false}];
                    }
                    
                    return resultText;
                }
            },
            1002: {
                text: "", // Filled by skill check
                choices: [] // Filled by skill check
            },
            11: {
                text: "You search the area and find an old rope with a grappling hook left by a previous adventurer. It's frayed but might work.",
                choices: [
                    {text: "Use the grappling hook to scale the wall", nextSection: 25, skillCheck: true, checkType: 'luck', difficulty: 11},
                    {text: "Try climbing without it", nextSection: 10, skillCheck: false}
                ]
            },
            12: {
                text: "The gargoyle's eyes glow brighter. 'CORRECT. Blood is the answer. Blood is the key. Blood is the keep.' The massive gate groans open. You may enter.",
                choices: [
                    {text: "Enter Bloodstone Keep", nextSection: 26, skillCheck: false}
                ]
            },
            13: {
                text: "The gargoyle rumbles angrily. 'INCORRECT. Wine is but a pale imitation.' The gargoyle attacks!",
                choices: [
                    {text: "Defend yourself!", nextSection: 1301, skillCheck: false}
                ]
            },
            1301: {
                text: "The angry gargoyle attacks! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 1302, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat
                    combatState.active = true;
                    combatState.enemyName = "Angry Gargoyle";
                    combatState.enemyStamina = 15;
                    combatState.enemyCurrentStamina = 15;
                    combatState.enemySkill = 9;
                    combatState.nextSection = 27;
                    combatState.round = 1;
                    
                    return "Angry Gargoyle: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            14: {
                text: "The gargoyle shakes its head. 'INCORRECT. Tears are but water with memory.' The gargoyle attacks!",
                choices: [
                    {text: "Defend yourself!", nextSection: 1401, skillCheck: false}
                ]
            },
            1401: {
                text: "The angry gargoyle attacks! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 1402, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat
                    combatState.active = true;
                    combatState.enemyName = "Angry Gargoyle";
                    combatState.enemyStamina = 15;
                    combatState.enemyCurrentStamina = 15;
                    combatState.enemySkill = 9;
                    combatState.nextSection = 27;
                    combatState.round = 1;
                    
                    return "Angry Gargoyle: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            17: {
                text: "You pry open the drainage grate and slip inside. It's dark and smells foul, but it leads into the keep's lower levels.",
                choices: [
                    {text: "Follow the drainage tunnel", nextSection: 29, skillCheck: false}
                ]
            },
            18: {
                text: "You enter a narrow, dark passage that winds upward. The walls here also weep crimson liquid. You emerge in a storage room filled with casks and crates.",
                choices: [
                    {text: "Search the storage room", nextSection: 30, skillCheck: false},
                    {text: "Continue into the keep", nextSection: 31, skillCheck: false}
                ]
            },
            19: {
                text: "Unable to open the secret door, you return to the main approach.",
                choices: [
                    {text: "Go to the main gate", nextSection: 1, skillCheck: false}
                ]
            },
            20: {
                text: "You strain against the door again. With a loud crack, it gives way! But the noise has alerted something inside...",
                choices: [
                    {text: "Enter cautiously", nextSection: 32, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina -= 4;
                    updateStatsDisplay();
                    return "You force the door open, losing 4 more Stamina!";
                }
            },
            21: {
                text: "You take the key and unlock the door. It opens silently. Inside, a dark passage leads upward.",
                choices: [
                    {text: "Enter and lock the door behind you", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Bleeding Heart Key");
                    updateInventoryDisplay();
                    return "You take the Bleeding Heart Key!";
                }
            },
            22: {
                text: "You search the skeleton and find not only the key, but also 25 Gold and a journal. The last entry reads: 'The Blood Cult knows I'm here. Must find the Bloodstone Shard before they sacrifice me to it.'",
                choices: [
                    {text: "Take everything and enter", nextSection: 34, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 25;
                    gameState.inventory.push("Bleeding Heart Key", "Dead Adventurer's Journal");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    return "You find 25 Gold, the Bleeding Heart Key, and a journal!";
                }
            },
            23: {
                text: "You're in a central courtyard. In the middle stands a fountain flowing with crimson liquid. Around the courtyard are several doors and a staircase leading up to a tower.",
                choices: [
                    {text: "Examine the fountain", nextSection: 35, skillCheck: false},
                    {text: "Enter the main keep doors", nextSection: 36, skillCheck: false},
                    {text: "Climb the tower staircase", nextSection: 37, skillCheck: false},
                    {text: "Check the side doors", nextSection: 38, skillCheck: false}
                ]
            },
            24: {
                text: "Battered from your fall, you decide to try the main gate instead.",
                choices: [
                    {text: "Approach the main gate", nextSection: 1, skillCheck: false}
                ]
            },
            25: {
                text: "You attempt to use the grappling hook...",
                choices: [
                    {text: "Roll for luck", nextSection: 2501, skillCheck: false}
                ]
            },
            2501: {
                text: "", // Will be filled by skill check
                choices: [
                    {text: "Continue", nextSection: 2502, skillCheck: false}
                ],
                action: function() {
                    const diceRoll = rollDiceHelper(2, 6);
                    const success = diceRoll <= gameState.luck + 1; // +1 for difficulty 11
                    
                    window.checkResult = success;
                    
                    let resultText = `You roll ${diceRoll}. Your LUCK is ${gameState.luck}. `;
                    resultText += success ? 
                        `<span class="success">Success!</span>` : 
                        `<span class="damage">Failure!</span>`;
                    
                    if (success) {
                        storySections[2502].text = "The grappling hook holds! You climb the rope and reach the top of the wall.";
                        storySections[2502].choices = [{text: "Enter the courtyard", nextSection: 23, skillCheck: false}];
                    } else {
                        gameState.stamina -= 6;
                        updateStatsDisplay();
                        storySections[2502].text = "The rope breaks! You fall and take 6 damage.";
                        storySections[2502].choices = [{text: "Try another approach", nextSection: 0, skillCheck: false}];
                    }
                    
                    return resultText;
                }
            },
            2502: {
                text: "", // Filled by skill check
                choices: [] // Filled by skill check
            },
            26: {
                text: "You pass through the massive gate into a grand entrance hall. Tapestries depicting blood rituals cover the walls. Ahead, a staircase leads up, and corridors branch left and right.",
                choices: [
                    {text: "Take the left corridor", nextSection: 39, skillCheck: false},
                    {text: "Take the right corridor", nextSection: 40, skillCheck: false},
                    {text: "Climb the staircase", nextSection: 41, skillCheck: false},
                    {text: "Examine the tapestries", nextSection: 42, skillCheck: true, checkType: 'skill', difficulty: 11}
                ]
            },
            27: {
                text: "With the gargoyle defeated, you enter the keep.",
                choices: [
                    {text: "Enter the main hall", nextSection: 26, skillCheck: false}
                ]
            },
            29: {
                text: "You follow the foul-smelling drainage tunnel. It leads to a dungeon area. You hear moaning from cells and see strange, blood-covered symbols on the walls.",
                choices: [
                    {text: "Explore the dungeon", nextSection: 44, skillCheck: false},
                    {text: "Find a way up to the main levels", nextSection: 45, skillCheck: false}
                ]
            },
            30: {
                text: "You search the storage room and find several useful items: a barrel of clean water (restores 4 Stamina), a tinderbox, and a crossbow with 10 bolts.",
                choices: [
                    {text: "Take the supplies and continue", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 4);
                    gameState.inventory.push("Crossbow", "Bolts (10)", "Tinderbox");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    return "You drink clean water (+4 Stamina) and find a Crossbow, Bolts, and Tinderbox!";
                }
            },
            31: {
                text: "You leave the storage room and enter a corridor. You can hear chanting coming from somewhere deeper in the keep.",
                choices: [
                    {text: "Follow the sound of chanting", nextSection: 47, skillCheck: false},
                    {text: "Go in the opposite direction", nextSection: 48, skillCheck: false}
                ]
            },
            32: {
                text: "You enter just as two Blood Cult guards come running to investigate the noise!",
                choices: [
                    {text: "Fight the guards", nextSection: 3201, skillCheck: false},
                    {text: "Try to hide", nextSection: 50, skillCheck: true, checkType: 'skill', difficulty: 12}
                ]
            },
            3201: {
                text: "You face the Blood Cult guards! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 3202, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat
                    combatState.active = true;
                    combatState.enemyName = "Blood Cult Guards";
                    combatState.enemyStamina = 14;
                    combatState.enemyCurrentStamina = 14;
                    combatState.enemySkill = 9;
                    combatState.nextSection = 77;
                    combatState.round = 1;
                    
                    return "Blood Cult Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            33: {
                text: "You lock the door behind you. The passage is narrow and dark. After climbing for what feels like ages, you emerge in a bedroom that seems to belong to a cult leader.",
                choices: [
                    {text: "Search the bedroom", nextSection: 51, skillCheck: false},
                    {text: "Leave quietly", nextSection: 52, skillCheck: false}
                ]
            },
            34: {
                text: "With key, gold, and journal in hand, you enter the secret passage. The journal mentions a 'Bloodstone Shard' hidden somewhere in the keep.",
                choices: [
                    {text: "Follow the passage upward", nextSection: 53, skillCheck: false}
                ]
            },
            35: {
                text: "The fountain flows with what looks and smells like blood, but when you touch it, it feels like water. A plaque reads: 'The Blood of Dragons gives life to stone.' There's a chalice on the fountain's edge.",
                choices: [
                    {text: "Drink from the fountain", nextSection: 54, skillCheck: false},
                    {text: "Take the chalice", nextSection: 55, skillCheck: false},
                    {text: "Leave it and explore elsewhere", nextSection: 23, skillCheck: false}
                ]
            },
            36: {
                text: "The main doors lead to a grand hall similar to the entrance from the front gate. This seems to be the heart of the keep.",
                choices: [
                    {text: "Explore the grand hall", nextSection: 56, skillCheck: false}
                ]
            },
            37: {
                text: "You climb the tower staircase. It winds upward to a door at the top. Through a window slit, you can see you're high above the courtyard.",
                choices: [
                    {text: "Enter the tower room", nextSection: 57, skillCheck: false},
                    {text: "Look out the window first", nextSection: 58, skillCheck: false}
                ]
            },
            38: {
                text: "You try the side doors. One is locked, one leads to a kitchen, and one opens to an armory.",
                choices: [
                    {text: "Enter the kitchen", nextSection: 59, skillCheck: false},
                    {text: "Enter the armory", nextSection: 60, skillCheck: false},
                    {text: "Try to pick the locked door", nextSection: 61, skillCheck: true, checkType: 'skill', difficulty: 12}
                ]
            },
            39: {
                text: "The left corridor leads to a library. Shelves groan under the weight of ancient tomes. A robed figure stands with its back to you, reading a large book.",
                choices: [
                    {text: "Approach the figure", nextSection: 62, skillCheck: false},
                    {text: "Sneak past to examine the books", nextSection: 63, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Attack the figure", nextSection: 64, skillCheck: false}
                ]
            },
            40: {
                text: "The right corridor leads to a barracks. Several Blood Cult warriors are resting here. They haven't noticed you yet.",
                choices: [
                    {text: "Attack the warriors", nextSection: 65, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 66, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Retreat and try another path", nextSection: 26, skillCheck: false}
                ]
            },
            41: {
                text: "The staircase leads to an upper gallery overlooking the entrance hall. From here, you can see more of the keep's layout.",
                choices: [
                    {text: "Continue upward", nextSection: 67, skillCheck: false},
                    {text: "Look for hidden passages", nextSection: 68, skillCheck: true, checkType: 'luck', difficulty: 10}
                ]
            },
            42: {
                text: "You examine the tapestries...",
                choices: [
                    {text: "Roll for skill", nextSection: 4201, skillCheck: false}
                ]
            },
            4201: {
                text: "", // Will be filled by skill check
                choices: [
                    {text: "Continue", nextSection: 4202, skillCheck: false}
                ],
                action: function() {
                    const diceRoll = rollDiceHelper(2, 6);
                    const success = diceRoll <= gameState.skill + 1; // +1 for difficulty 11
                    
                    window.checkResult = success;
                    
                    let resultText = `You roll ${diceRoll}. Your SKILL is ${gameState.skill}. `;
                    resultText += success ? 
                        `<span class="success">Success!</span>` : 
                        `<span class="damage">Failure!</span>`;
                    
                    if (success) {
                        gameState.inventory.push("Knowledge of Bloodstone Shard");
                        updateInventoryDisplay();
                        storySections[4202].text = "You study the tapestries and learn about the Blood Cult's rituals. One shows a 'Bloodstone Shard' being used to control the keep's power.";
                    } else {
                        storySections[4202].text = "The tapestries are too faded and bloody to make out clearly.";
                    }
                    
                    storySections[4202].choices = [{text: "Continue exploring", nextSection: 26, skillCheck: false}];
                    
                    return resultText;
                }
            },
            4202: {
                text: "", // Filled by skill check
                choices: [] // Filled by skill check
            },
            44: {
                text: "You explore the dungeon. In one cell, a prisoner whispers to you: 'The High Priest has the Shard in the Sanctum. Stop the ritual or all is lost!'",
                choices: [
                    {text: "Free the prisoner", nextSection: 69, skillCheck: false},
                    {text: "Ask about the ritual", nextSection: 70, skillCheck: false},
                    {text: "Ignore them and continue", nextSection: 45, skillCheck: false}
                ]
            },
            45: {
                text: "You find stairs leading up from the dungeon. They emerge near the kitchen area.",
                choices: [
                    {text: "Enter the kitchen", nextSection: 59, skillCheck: false}
                ]
            },
            46: {
                text: "Armed with new supplies, you continue from the storage room into the keep proper.",
                choices: [
                    {text: "Follow the corridor", nextSection: 31, skillCheck: false}
                ]
            },
            47: {
                text: "You follow the chanting. It grows louder, leading you to a large set of double doors. Through them, you can hear many voices chanting in unison.",
                choices: [
                    {text: "Open the doors slightly and look", nextSection: 71, skillCheck: false},
                    {text: "Burst in aggressively", nextSection: 72, skillCheck: false},
                    {text: "Look for another way to observe", nextSection: 73, skillCheck: false}
                ]
            },
            48: {
                text: "You go away from the chanting and find yourself in a residential area. These seem to be the living quarters of the cult members.",
                choices: [
                    {text: "Search the quarters", nextSection: 74, skillCheck: false},
                    {text: "Return to follow the chanting", nextSection: 47, skillCheck: false}
                ]
            },
            50: {
                text: "You try to hide from the guards...",
                choices: [
                    {text: "Roll for skill", nextSection: 5001, skillCheck: false}
                ]
            },
            5001: {
                text: "", // Will be filled by skill check
                choices: [
                    {text: "Continue", nextSection: 5002, skillCheck: false}
                ],
                action: function() {
                    const diceRoll = rollDiceHelper(2, 6);
                    const success = diceRoll <= gameState.skill + 2; // +2 for difficulty 12
                    
                    window.checkResult = success;
                    
                    let resultText = `You roll ${diceRoll}. Your SKILL is ${gameState.skill}. `;
                    resultText += success ? 
                        `<span class="success">Success!</span>` : 
                        `<span class="damage">Failure!</span>`;
                    
                    if (success) {
                        storySections[5002].text = "You hide in shadows as the guards pass by, then slip away unseen.";
                        storySections[5002].choices = [{text: "Continue deeper into the keep", nextSection: 77, skillCheck: false}];
                    } else {
                        storySections[5002].text = "You're spotted! The guards attack!";
                        storySections[5002].choices = [{text: "Fight the guards", nextSection: 3201, skillCheck: false}];
                    }
                    
                    return resultText;
                }
            },
            5002: {
                text: "", // Filled by skill check
                choices: [] // Filled by skill check
            },
            51: {
                text: "You search the bedroom and find 50 Gold, a ceremonial dagger made of bloodstone, and a note: 'The ritual begins at moonrise. The Shard must be fully charged.'",
                choices: [
                    {text: "Take everything and leave", nextSection: 78, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 50;
                    gameState.weapons.push({name: 'Bloodstone Dagger', damage: '1d6+3'});
                    gameState.inventory.push("Bloodstone Dagger", "Cultist's Note");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    return "You find 50 Gold, a Bloodstone Dagger, and a cultist's note!";
                }
            },
            52: {
                text: "You leave the bedroom quietly and find yourself in an upper corridor overlooking part of the keep.",
                choices: [
                    {text: "Explore the upper corridor", nextSection: 79, skillCheck: false}
                ]
            },
            53: {
                text: "Following the journal's hints, you navigate toward where the Bloodstone Shard might be kept. The passage ends at a secret door overlooking a large ceremonial chamber.",
                choices: [
                    {text: "Look through the secret door", nextSection: 80, skillCheck: false}
                ]
            },
            54: {
                text: "You drink from the fountain. The liquid tastes like copper and cinnamon. You feel a surge of energy! Your Stamina is fully restored and your Skill increases by 1!",
                choices: [
                    {text: "Continue exploring", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina = gameState.maxStamina;
                    gameState.skill += 1;
                    updateStatsDisplay();
                    return "You drink from the fountain! Stamina fully restored and Skill +1!";
                }
            },
            55: {
                text: "You take the chalice. It's made of silver and set with red gems.",
                choices: [
                    {text: "Continue exploring", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Silver Chalice");
                    updateInventoryDisplay();
                    return "You take the Silver Chalice!";
                }
            },
            56: {
                text: "The grand hall is immense. At the far end, a throne sits empty. Tapestries here show a massive red gem - the Bloodstone Shard - being used in ancient battles.",
                choices: [
                    {text: "Approach the throne", nextSection: 81, skillCheck: false},
                    {text: "Examine the tapestries closely", nextSection: 82, skillCheck: false},
                    {text: "Look for exits", nextSection: 83, skillCheck: false}
                ]
            },
            57: {
                text: "The tower room is an observatory. A large telescope points at the sky, and astrological charts cover the walls. A robed astrologer turns as you enter.",
                choices: [
                    {text: "Talk to the astrologer", nextSection: 84, skillCheck: false},
                    {text: "Attack immediately", nextSection: 85, skillCheck: false},
                    {text: "Ask about the Bloodstone Shard", nextSection: 86, skillCheck: false}
                ]
            },
            58: {
                text: "You look out the window. You have a commanding view of the surrounding lands. You also spot a secret entrance on the north wall you missed earlier.",
                choices: [
                    {text: "Enter the tower room", nextSection: 57, skillCheck: false},
                    {text: "Climb down to check the secret entrance", nextSection: 87, skillCheck: false}
                ]
            },
            59: {
                text: "The kitchen is surprisingly well-stocked. Several cultists are preparing food. They freeze when they see you.",
                choices: [
                    {text: "Attack the cultists", nextSection: 88, skillCheck: false},
                    {text: "Pretend you belong", nextSection: 89, skillCheck: true, checkType: 'luck', difficulty: 12},
                    {text: "Back out slowly", nextSection: 90, skillCheck: false}
                ]
            },
            60: {
                text: "The armory contains weapons and armor. You see several bloodstone-tipped spears and crimson armor. A lone armorer is polishing a breastplate.",
                choices: [
                    {text: "Take weapons and armor", nextSection: 91, skillCheck: false},
                    {text: "Talk to the armorer", nextSection: 92, skillCheck: false},
                    {text: "Knock out the armorer", nextSection: 93, skillCheck: false}
                ]
            },
            61: {
                text: "You attempt to pick the locked door...",
                choices: [
                    {text: "Roll for skill", nextSection: 6101, skillCheck: false}
                ]
            },
            6101: {
                text: "", // Will be filled by skill check
                choices: [
                    {text: "Continue", nextSection: 6102, skillCheck: false}
                ],
                action: function() {
                    const diceRoll = rollDiceHelper(2, 6);
                    const success = diceRoll <= gameState.skill + 2; // +2 for difficulty 12
                    
                    window.checkResult = success;
                    
                    let resultText = `You roll ${diceRoll}. Your SKILL is ${gameState.skill}. `;
                    resultText += success ? 
                        `<span class="success">Success!</span>` : 
                        `<span class="damage">Failure!</span>`;
                    
                    if (success) {
                        storySections[6102].text = "You pick the lock! The door opens to reveal a private study.";
                        storySections[6102].choices = [{text: "Enter the study", nextSection: 94, skillCheck: false}];
                    } else {
                        storySections[6102].text = "The lock resists your attempts. It's magically sealed.";
                        storySections[6102].choices = [{text: "Try another door", nextSection: 38, skillCheck: false}];
                    }
                    
                    return resultText;
                }
            },
            6102: {
                text: "", // Filled by skill check
                choices: [] // Filled by skill check
            },
            62: {
                text: "The robed figure turns. It's a Blood Cult scribe. 'You are not one of us. The High Priest will want to speak with you.' He reaches for a bell rope.",
                choices: [
                    {text: "Attack before he can ring the bell", nextSection: 95, skillCheck: false},
                    {text: "Try to reason with him", nextSection: 96, skillCheck: true, checkType: 'luck', difficulty: 13},
                    {text: "Run back the way you came", nextSection: 97, skillCheck: false}
                ]
            },
            63: {
                text: "You attempt to sneak past the scribe...",
                choices: [
                    {text: "Roll for skill", nextSection: 6301, skillCheck: false}
                ]
            },
            6301: {
                text: "", // Will be filled by skill check
                choices: [
                    {text: "Continue", nextSection: 6302, skillCheck: false}
                ],
                action: function() {
                    const diceRoll = rollDiceHelper(2, 6);
                    const success = diceRoll <= gameState.skill + 3; // +3 for difficulty 13
                    
                    window.checkResult = success;
                    
                    let resultText = `You roll ${diceRoll}. Your SKILL is ${gameState.skill}. `;
                    resultText += success ? 
                        `<span class="success">Success!</span>` : 
                        `<span class="damage">Failure!</span>`;
                    
                    if (success) {
                        gameState.inventory.push("Bloodstone Chronicles Book");
                        updateInventoryDisplay();
                        storySections[6302].text = "You sneak past the figure and examine the books. One titled 'The Bloodstone Chronicles' contains valuable information about the Shard's weaknesses.";
                        storySections[6302].choices = [{text: "Take the book and leave", nextSection: 98, skillCheck: false}];
                    } else {
                        storySections[6302].text = "You bump into a shelf! The figure turns and sees you!";
                        storySections[6302].choices = [{text: "Prepare to fight", nextSection: 64, skillCheck: false}];
                    }
                    
                    return resultText;
                }
            },
            6302: {
                text: "", // Filled by skill check
                choices: [] // Filled by skill check
            },
            64: {
                text: "You attack the cult scribe! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 6401, skillCheck: false}
                ]
            },
            6401: {
                text: "You face the Blood Cult Scribe! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 6402, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat
                    combatState.active = true;
                    combatState.enemyName = "Blood Cult Scribe";
                    combatState.enemyStamina = 8;
                    combatState.enemyCurrentStamina = 8;
                    combatState.enemySkill = 7;
                    combatState.nextSection = 100;
                    combatState.round = 1;
                    
                    return "Blood Cult Scribe: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            65: {
                text: "You attack the resting warriors! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 6501, skillCheck: false}
                ]
            },
            6501: {
                text: "You face the Blood Cult Warriors! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 6502, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat
                    combatState.active = true;
                    combatState.enemyName = "Blood Cult Warriors";
                    combatState.enemyStamina = 20;
                    combatState.enemyCurrentStamina = 20;
                    combatState.enemySkill = 11;
                    combatState.nextSection = 102;
                    combatState.round = 1;
                    
                    return "Blood Cult Warriors: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            66: {
                text: "You attempt to sneak past the warriors...",
                choices: [
                    {text: "Roll for skill", nextSection: 6601, skillCheck: false}
                ]
            },
            6601: {
                text: "", // Will be filled by skill check
                choices: [
                    {text: "Continue", nextSection: 6602, skillCheck: false}
                ],
                action: function() {
                    const diceRoll = rollDiceHelper(2, 6);
                    const success = diceRoll <= gameState.skill + 4; // +4 for difficulty 14
                    
                    window.checkResult = success;
                    
                    let resultText = `You roll ${diceRoll}. Your SKILL is ${gameState.skill}. `;
                    resultText += success ? 
                        `<span class="success">Success!</span>` : 
                        `<span class="damage">Failure!</span>`;
                    
                    if (success) {
                        storySections[6602].text = "You successfully sneak past the barracks and continue deeper into the keep.";
                        storySections[6602].choices = [{text: "Continue exploring", nextSection: 103, skillCheck: false}];
                    } else {
                        storySections[6602].text = "You're spotted! The warriors attack!";
                        storySections[6602].choices = [{text: "Fight the warriors", nextSection: 65, skillCheck: false}];
                    }
                    
                    return resultText;
                }
            },
            6602: {
                text: "", // Filled by skill check
                choices: [] // Filled by skill check
            },
            80: {
                text: "Through the secret door, you see a large ceremonial chamber below. Dozens of cultists chant around a central altar. On the altar glows the BLOODSTONE SHARD, a massive crimson gem pulsating with power. The High Priest stands before it, preparing for a ritual.",
                choices: [
                    {text: "Attack immediately from above", nextSection: 104, skillCheck: false},
                    {text: "Sneak down for a closer approach", nextSection: 105, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Disrupt the ritual somehow", nextSection: 106, skillCheck: false}
                ]
            },
            104: {
                text: "You leap down into the ceremonial chamber, surprising the cultists! The High Priest turns, furious. 'You dare interrupt the Ascension?'",
                choices: [
                    {text: "Attack the High Priest", nextSection: 107, skillCheck: false},
                    {text: "Grab the Bloodstone Shard", nextSection: 108, skillCheck: false}
                ]
            },
            107: {
                text: "You face the High Priest of the Blood Cult! Prepare for the final battle!",
                choices: [
                    {text: "Begin the battle!", nextSection: 10701, skillCheck: false}
                ]
            },
            10701: {
                text: "You face the High Priest! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 10702, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat
                    combatState.active = true;
                    combatState.enemyName = "High Priest of Blood";
                    combatState.enemyStamina = 25;
                    combatState.enemyCurrentStamina = 25;
                    combatState.enemySkill = 13;
                    combatState.nextSection = 110;
                    combatState.round = 1;
                    
                    return "High Priest of Blood: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            110: {
                text: "You defeat the High Priest! The cultists scatter in panic. The Bloodstone Shard lies on the altar, pulsing with power.",
                choices: [
                    {text: "Take the Bloodstone Shard", nextSection: 111, skillCheck: false},
                    {text: "Destroy the Shard", nextSection: 112, skillCheck: false}
                ]
            },
            111: {
                text: "You take the Bloodstone Shard. It feels warm in your hands, and you sense great power within it. With the cult defeated, you have conquered Bloodstone Keep!",
                choices: [
                    {text: "Claim your victory", nextSection: 200, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Bloodstone Shard");
                    gameState.gold += 150;
                    gameState.skill += 2;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                    return "You claim the Bloodstone Shard! +150 Gold, +2 Skill!";
                }
            },
            112: {
                text: "You smash the Bloodstone Shard with your weapon! It explodes in a burst of crimson light. The keep trembles, and the blood-red stone begins to fade to normal gray. You have broken the keep's curse!",
                choices: [
                    {text: "Escape the crumbling keep", nextSection: 200, skillCheck: false}
                ],
                action: function() {
                    gameState.luck += 3;
                    gameState.gold += 100;
                    updateStatsDisplay();
                    return "You destroy the Bloodstone Shard! +3 Luck, +100 Gold!";
                }
            },
            // Combat sections (502, 1302, 1402, 3202, 6402, 6502, 10702)
            502: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 503, skillCheck: false}
                ]
            },
            503: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 502, skillCheck: false}
                ]
            },
            1302: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 1303, skillCheck: false}
                ]
            },
            1303: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 1302, skillCheck: false}
                ]
            },
            1402: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 1403, skillCheck: false}
                ]
            },
            1403: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 1402, skillCheck: false}
                ]
            },
            3202: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 3203, skillCheck: false}
                ]
            },
            3203: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 3202, skillCheck: false}
                ]
            },
            6402: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 6403, skillCheck: false}
                ]
            },
            6403: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 6402, skillCheck: false}
                ]
            },
            6502: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 6503, skillCheck: false}
                ]
            },
            6503: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 6502, skillCheck: false}
                ]
            },
            10702: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 10703, skillCheck: false}
                ]
            },
            10703: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 10702, skillCheck: false}
                ]
            },
            // Fill in remaining sections with placeholders
            67: { text: "You continue upward...", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            68: { text: "You look for hidden passages...", choices: [{text: "Roll for luck", nextSection: 6801, skillCheck: false}] },
            6801: { 
                text: "", 
                choices: [{text: "Continue", nextSection: 6802, skillCheck: false}],
                action: function() {
                    const diceRoll = rollDiceHelper(2, 6);
                    const success = diceRoll <= gameState.luck; // difficulty 10
                    
                    window.checkResult = success;
                    
                    let resultText = `You roll ${diceRoll}. Your LUCK is ${gameState.luck}. `;
                    resultText += success ? 
                        `<span class="success">Success!</span>` : 
                        `<span class="damage">Failure!</span>`;
                    
                    if (success) {
                        storySections[6802].text = "You find a hidden passage!";
                        storySections[6802].choices = [{text: "Take the hidden passage", nextSection: 80, skillCheck: false}];
                    } else {
                        storySections[6802].text = "No hidden passages found.";
                        storySections[6802].choices = [{text: "Continue upward", nextSection: 80, skillCheck: false}];
                    }
                    
                    return resultText;
                }
            },
            6802: { text: "", choices: [] },
            69: { text: "You free the prisoner.", choices: [{text: "Continue", nextSection: 45, skillCheck: false}] },
            70: { text: "The prisoner tells you about the ritual.", choices: [{text: "Continue", nextSection: 45, skillCheck: false}] },
            71: { text: "You peek through the doors.", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            72: { text: "You burst in!", choices: [{text: "Continue", nextSection: 104, skillCheck: false}] },
            73: { text: "You find another vantage point.", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            74: { text: "You search the quarters.", choices: [{text: "Continue", nextSection: 47, skillCheck: false}] },
            77: { text: "You continue deeper...", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            78: { text: "You leave with your loot.", choices: [{text: "Continue", nextSection: 52, skillCheck: false}] },
            79: { text: "You explore the upper corridor.", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            81: { text: "You approach the throne.", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            82: { text: "You examine the tapestries.", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            83: { text: "You look for exits.", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            84: { text: "You talk to the astrologer.", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            85: { text: "You attack the astrologer!", choices: [{text: "Begin the battle!", nextSection: 8501, skillCheck: false}] },
            8501: {
                text: "You face the Cult Astrologer! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 8502, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat
                    combatState.active = true;
                    combatState.enemyName = "Cult Astrologer";
                    combatState.enemyStamina = 12;
                    combatState.enemyCurrentStamina = 12;
                    combatState.enemySkill = 8;
                    combatState.nextSection = 80;
                    combatState.round = 1;
                    
                    return "Cult Astrologer: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            8502: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 8503, skillCheck: false}
                ]
            },
            8503: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 8502, skillCheck: false}
                ]
            },
            86: { text: "You ask about the Shard.", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            87: { text: "You check the secret entrance.", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            88: { text: "You attack the kitchen cultists! Prepare for combat!", choices: [{text: "Begin the battle!", nextSection: 8801, skillCheck: false}] },
            8801: {
                text: "You face the Kitchen Cultists! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 8802, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat
                    combatState.active = true;
                    combatState.enemyName = "Kitchen Cultists";
                    combatState.enemyStamina = 16;
                    combatState.enemyCurrentStamina = 16;
                    combatState.enemySkill = 8;
                    combatState.nextSection = 90;
                    combatState.round = 1;
                    
                    return "Kitchen Cultists: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            8802: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 8803, skillCheck: false}
                ]
            },
            8803: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 8802, skillCheck: false}
                ]
            },
            89: { text: "You pretend to belong...", choices: [{text: "Roll for luck", nextSection: 8901, skillCheck: false}] },
            8901: {
                text: "",
                choices: [{text: "Continue", nextSection: 8902, skillCheck: false}],
                action: function() {
                    const diceRoll = rollDiceHelper(2, 6);
                    const success = diceRoll <= gameState.luck + 2; // +2 for difficulty 12
                    
                    window.checkResult = success;
                    
                    let resultText = `You roll ${diceRoll}. Your LUCK is ${gameState.luck}. `;
                    resultText += success ? 
                        `<span class="success">Success!</span>` : 
                        `<span class="damage">Failure!</span>`;
                    
                    if (success) {
                        storySections[8902].text = "They believe you! You blend in with the kitchen staff.";
                        storySections[8902].choices = [{text: "Continue", nextSection: 90, skillCheck: false}];
                    } else {
                        storySections[8902].text = "They don't believe you! The cultists attack!";
                        storySections[8902].choices = [{text: "Fight back", nextSection: 88, skillCheck: false}];
                    }
                    
                    return resultText;
                }
            },
            8902: { text: "", choices: [] },
            90: { text: "You leave the kitchen.", choices: [{text: "Continue", nextSection: 38, skillCheck: false}] },
            91: { text: "You take weapons and armor.", choices: [{text: "Continue", nextSection: 60, skillCheck: false}] },
            92: { text: "You talk to the armorer.", choices: [{text: "Continue", nextSection: 60, skillCheck: false}] },
            93: { text: "You knock out the armorer.", choices: [{text: "Continue", nextSection: 91, skillCheck: false}] },
            94: { text: "You enter the study.", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            95: { text: "You attack the scribe before he can ring the bell! Prepare for combat!", choices: [{text: "Begin the battle!", nextSection: 9501, skillCheck: false}] },
            9501: {
                text: "You face the Blood Cult Scribe! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 9502, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat
                    combatState.active = true;
                    combatState.enemyName = "Blood Cult Scribe";
                    combatState.enemyStamina = 10;
                    combatState.enemyCurrentStamina = 10;
                    combatState.enemySkill = 8;
                    combatState.nextSection = 100;
                    combatState.round = 1;
                    
                    return "Blood Cult Scribe: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            9502: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 9503, skillCheck: false}
                ]
            },
            9503: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 9502, skillCheck: false}
                ]
            },
            96: { text: "You try to reason with the scribe...", choices: [{text: "Roll for luck", nextSection: 9601, skillCheck: false}] },
            9601: {
                text: "",
                choices: [{text: "Continue", nextSection: 9602, skillCheck: false}],
                action: function() {
                    const diceRoll = rollDiceHelper(2, 6);
                    const success = diceRoll <= gameState.luck + 3; // +3 for difficulty 13
                    
                    window.checkResult = success;
                    
                    let resultText = `You roll ${diceRoll}. Your LUCK is ${gameState.luck}. `;
                    resultText += success ? 
                        `<span class="success">Success!</span>` : 
                        `<span class="damage">Failure!</span>`;
                    
                    if (success) {
                        storySections[9602].text = "He lets you go! The scribe decides not to raise the alarm.";
                        storySections[9602].choices = [{text: "Continue", nextSection: 97, skillCheck: false}];
                    } else {
                        storySections[9602].text = "He doesn't believe you! The scribe attacks!";
                        storySections[9602].choices = [{text: "Fight back", nextSection: 95, skillCheck: false}];
                    }
                    
                    return resultText;
                }
            },
            9602: { text: "", choices: [] },
            97: { text: "You run back.", choices: [{text: "Continue", nextSection: 26, skillCheck: false}] },
            98: { text: "You take the book and leave.", choices: [{text: "Continue", nextSection: 97, skillCheck: false}] },
            100: { text: "After defeating the scribe...", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            102: { text: "After defeating the warriors...", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            103: { text: "You continue exploring.", choices: [{text: "Continue", nextSection: 80, skillCheck: false}] },
            105: { text: "You attempt to sneak down...", choices: [{text: "Roll for skill", nextSection: 10501, skillCheck: false}] },
            10501: {
                text: "",
                choices: [{text: "Continue", nextSection: 10502, skillCheck: false}],
                action: function() {
                    const diceRoll = rollDiceHelper(2, 6);
                    const success = diceRoll <= gameState.skill + 4; // +4 for difficulty 14
                    
                    window.checkResult = success;
                    
                    let resultText = `You roll ${diceRoll}. Your SKILL is ${gameState.skill}. `;
                    resultText += success ? 
                        `<span class="success">Success!</span>` : 
                        `<span class="damage">Failure!</span>`;
                    
                    if (success) {
                        storySections[10502].text = "You sneak down successfully! You reach the altar unseen.";
                        storySections[10502].choices = [{text: "Grab the Shard", nextSection: 108, skillCheck: false}];
                    } else {
                        storySections[10502].text = "You're spotted! The High Priest sees you!";
                        storySections[10502].choices = [{text: "Attack", nextSection: 107, skillCheck: false}];
                    }
                    
                    return resultText;
                }
            },
            10502: { text: "", choices: [] },
            106: { text: "You try to disrupt the ritual.", choices: [{text: "Continue", nextSection: 107, skillCheck: false}] },
            108: { text: "You grab the Shard!", choices: [{text: "Continue", nextSection: 107, skillCheck: false}] },
            // VICTORY SECTION - Player completes the level
            200: {
                text: "You have conquered <span class='bloodstone'>BLOODSTONE KEEP</span>! Whether you claimed the Shard or destroyed it, the cult is broken and the keep's power is yours to command or dissipate. Beyond the keep, the <span class='enemy'>ASHEN WASTES</span> await - a volcanic hellscape that will test your mettle like never before.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-skill').textContent = gameState.skill;
                    document.getElementById('next-stat-stamina').textContent = gameState.stamina;
                    document.getElementById('next-stat-luck').textContent = gameState.luck;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    return "You've completed Level 4: Bloodstone Keep!";
                }
            }
        };

        // Initialize game
        function initGame() {
            updateStatsDisplay();
            updateInventoryDisplay();
            
            // If we have a current section from saved game, load it
            if (gameState.currentSection > 0 && storySections[gameState.currentSection]) {
                loadSection(gameState.currentSection);
            } else {
                loadSection(0);
            }
        }
        
        // Show warning dialog for new game
        function showNewGameWarning() {
            document.getElementById('screen-game').classList.remove('active-screen');
            document.getElementById('warning-dialog').classList.add('active-screen');
        }
        
        // Cancel new game and return to game screen
        function cancelNewGame() {
            document.getElementById('warning-dialog').classList.remove('active-screen');
            document.getElementById('screen-game').classList.add('active-screen');
        }
        
        // Start new game - reset everything
        function startNewGame() {
            localStorage.removeItem('dreadwoodGameState');
            gameState = {
                playerClass: '',
                skill: 0,
                maxStamina: 0,
                stamina: 0,
                luck: 0,
                gold: 0,
                inventory: [],
                weapons: [],
                armor: [],
                currentWeaponIndex: 0,
                currentArmorIndex: 0,
                currentSection: 0,
                gameComplete: false
            };
            window.location.href = 'level1.html';
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-skill').textContent = gameState.skill;
            document.getElementById('stat-stamina').textContent = gameState.stamina;
            document.getElementById('stat-maxstamina').textContent = gameState.maxStamina;
            document.getElementById('stat-luck').textContent = gameState.luck;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Show current equipped weapon
            if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                const weapon = gameState.weapons[gameState.currentWeaponIndex];
                const weaponSpan = document.createElement('span');
                weaponSpan.className = 'inventory-item';
                weaponSpan.id = 'inv-weapon';
                weaponSpan.textContent = `${weapon.name} (${weapon.damage})`;
                inventoryDiv.appendChild(weaponSpan);
            }
            
            // Show current equipped armor
            if (gameState.armor && gameState.armor.length > 0 && gameState.currentArmorIndex >= 0) {
                const armor = gameState.armor[gameState.currentArmorIndex];
                const armorSpan = document.createElement('span');
                armorSpan.className = 'inventory-item';
                armorSpan.id = 'inv-armor';
                armorSpan.textContent = `${armor.name} (${armor.defense} DEF)`;
                inventoryDiv.appendChild(armorSpan);
            }
            
            // Show gold
            const goldSpan = document.createElement('span');
            goldSpan.className = 'inventory-item';
            goldSpan.textContent = `${gameState.gold} Gold`;
            inventoryDiv.appendChild(goldSpan);
            
            // Show other inventory items
            if (gameState.inventory) {
                gameState.inventory.forEach(item => {
                    // Don't show items that are currently equipped as weapons/armor
                    const isCurrentWeapon = gameState.weapons[gameState.currentWeaponIndex] && 
                        gameState.weapons[gameState.currentWeaponIndex].name === item;
                    const isCurrentArmor = gameState.armor[gameState.currentArmorIndex] && 
                        gameState.armor[gameState.currentArmorIndex].name === item;
                    
                    if (!isCurrentWeapon && !isCurrentArmor) {
                        const itemSpan = document.createElement('span');
                        itemSpan.className = 'inventory-item';
                        itemSpan.textContent = item;
                        inventoryDiv.appendChild(itemSpan);
                    }
                });
            }
        }
        
        // Load story section
        function loadSection(sectionId) {
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p>Your adventure in Bloodstone Keep continues... The crimson halls echo with your footsteps.</p>";
                document.getElementById('choice-buttons').innerHTML = `
                    <button class="choice-btn" onclick="loadSection(0)">Return to Keep Entrance</button>
                    <button class="choice-btn" onclick="loadSection(80)">Head to Ceremonial Chamber</button>
                `;
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 502 || sectionId === 503 || sectionId === 1302 || sectionId === 1303 || 
                                 sectionId === 1402 || sectionId === 1403 || sectionId === 3202 || sectionId === 3203 ||
                                 sectionId === 6402 || sectionId === 6403 || sectionId === 6502 || sectionId === 6503 ||
                                 sectionId === 8502 || sectionId === 8503 || sectionId === 8802 || sectionId === 8803 ||
                                 sectionId === 9502 || sectionId === 9503 || sectionId === 10702 || sectionId === 10703);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended, show victory and continue to next section
                    const goldReward = Math.floor(Math.random() * 40) + 20;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find ${goldReward} Gold on the body.`;
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                section.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    button.onclick = function() {
                        if (choice.skillCheck) {
                            performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                        } else {
                            loadSection(choice.nextSection);
                        }
                    };
                    choiceButtons.appendChild(button);
                });
            }
            
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            const playerAttack = rollDiceHelper(2, 6) + gameState.skill;
            const enemyAttack = rollDiceHelper(2, 6) + combatState.enemySkill;
            
            let resultText = `<span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Stamina: ${gameState.stamina}, Enemy Stamina: ${combatState.enemyCurrentStamina}<br>`;
            resultText += `You attack with ${playerAttack} vs enemy's ${enemyAttack}.<br>`;
            
            if (playerAttack > enemyAttack) {
                // Player hits
                let damage = 0;
                if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                    const weapon = gameState.weapons[gameState.currentWeaponIndex];
                    if (weapon.damage === '1d6') damage = rollDiceHelper(1, 6);
                    else if (weapon.damage === '1d6+1') damage = rollDiceHelper(1, 6) + 1;
                    else if (weapon.damage === '1d6+2') damage = rollDiceHelper(1, 6) + 2;
                    else if (weapon.damage === '1d6+3') damage = rollDiceHelper(1, 6) + 3;
                    else if (weapon.damage === '2d4') damage = rollDiceHelper(2, 4);
                    else if (weapon.damage === '2d6') damage = rollDiceHelper(2, 6);
                    else if (weapon.damage === '3d6') damage = rollDiceHelper(3, 6);
                    else damage = rollDiceHelper(1, 6);
                } else {
                    damage = rollDiceHelper(1, 6);
                }
                
                combatState.enemyCurrentStamina -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                
                if (combatState.enemyCurrentStamina <= 0) {
                    combatState.active = false;
                    return resultText;
                }
                
                // Enemy counterattacks
                const enemyDamage = rollDiceHelper(1, 6);
                gameState.stamina -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits back for ${enemyDamage} damage!</span>`;
                
            } else if (playerAttack < enemyAttack) {
                // Enemy hits
                const enemyDamage = rollDiceHelper(1, 6);
                gameState.stamina -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
            } else {
                // Tie
                resultText += "The attacks cancel each other out!";
            }
            
            updateStatsDisplay();
            
            // Check if player died
            if (gameState.stamina <= 0) {
                combatState.active = false;
                resultText += `<br><span class="game-over">You have been defeated by the ${combatState.enemyName}! Game Over.</span>`;
                setTimeout(() => {
                    localStorage.removeItem('dreadwoodGameState');
                    location.reload();
                }, 3000);
            }
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            const diceRoll = rollDiceHelper(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Luck
        function useLuck() {
            if (gameState.luck <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Luck left!</div>`;
                return;
            }
            
            const diceRoll = rollDiceHelper(2, 6);
            const success = diceRoll <= gameState.luck;
            
            gameState.luck -= 1;
            updateStatsDisplay();
            
            let resultText = `You test your Luck... Roll: ${diceRoll}, Luck: ${gameState.luck + 1}. `;
            resultText += success ? 
                `<span class="success">Lucky!</span> Something good happens.` : 
                `<span class="damage">Unlucky!</span> Something bad happens.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                const goodEffects = [
                    "You find 20 Gold in a hidden compartment!",
                    "You avoid a blood trap!",
                    "A friendly spirit guides you to a secret passage.",
                    "You discover a healing shrine! Restore 8 Stamina.",
                    "You find a powerful bloodstone charm! +1 to Skill for this level."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Gold")) {
                    gameState.gold += 20;
                } else if (effect.includes("Stamina")) {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 8);
                } else if (effect.includes("+1 to Skill")) {
                    gameState.skill += 1;
                }
            } else {
                const badEffects = [
                    "You trigger a blood curse! Lose 5 Stamina.",
                    "You're surrounded by cultists! Prepare for battle.",
                    "You get lost in identical crimson corridors.",
                    "Your weapon is temporarily corroded by blood magic. -1 damage next fight.",
                    "You fall through a false floor into a pit! Take 6 damage."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Stamina")) {
                    gameState.stamina -= 5;
                } else if (effect.includes("6 damage")) {
                    gameState.stamina -= 6;
                } else if (effect.includes("surrounded")) {
                    // Trigger combat
                    setTimeout(() => {
                        combatState.active = true;
                        combatState.enemyName = "Blood Cultists";
                        combatState.enemyStamina = 12;
                        combatState.enemyCurrentStamina = 12;
                        combatState.enemySkill = 8;
                        combatState.nextSection = gameState.currentSection;
                        combatState.round = 0;
                        loadSection(502); // Use gargoyle combat section
                    }, 1000);
                }
                
                if (gameState.stamina <= 0) {
                    document.getElementById('story-text').innerHTML += `<div class="game-over">You have been defeated! Game Over.</div>`;
                    setTimeout(() => {
                        localStorage.removeItem('dreadwoodGameState');
                        location.reload();
                    }, 3000);
                }
            }
            
            updateStatsDisplay();
            updateInventoryDisplay();
        }
        
        // Check inventory
        function checkInventory() {
            let inventoryText = "<h3>Your Inventory:</h3>";
            
            // Show current equipped weapon
            if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                const weapon = gameState.weapons[gameState.currentWeaponIndex];
                inventoryText += `<p><strong>Equipped Weapon:</strong> ${weapon.name} (${weapon.damage} damage)</p>`;
            }
            
            // Show all available weapons
            inventoryText += "<p><strong>Available Weapons:</strong><br>";
            gameState.weapons.forEach((weapon, index) => {
                const isEquipped = index === gameState.currentWeaponIndex;
                inventoryText += `${isEquipped ? " " : ""}${weapon.name} (${weapon.damage})`;
                if (!isEquipped) {
                    inventoryText += ` <button onclick="equipWeapon(${index})" style="font-size:10px; padding:2px 5px;">Equip</button>`;
                }
                inventoryText += "<br>";
            });
            inventoryText += "</p>";
            
            // Show all armor
            inventoryText += "<p><strong>Armor:</strong><br>";
            gameState.armor.forEach((armor, index) => {
                const isEquipped = index === gameState.currentArmorIndex;
                inventoryText += `${isEquipped ? " " : ""}${armor.name} (${armor.defense} DEF)`;
                if (!isEquipped) {
                    inventoryText += ` <button onclick="equipArmor(${index})" style="font-size:10px; padding:2px 5px;">Equip</button>`;
                }
                inventoryText += "<br>";
            });
            inventoryText += "</p>";
            
            inventoryText += `<p><strong>Gold:</strong> ${gameState.gold}</p>`;
            
            // Show other items
            if (gameState.inventory && gameState.inventory.length > 0) {
                inventoryText += `<p><strong>Other Items:</strong> `;
                const otherItems = gameState.inventory.filter(item => {
                    // Don't show items that are weapons/armor
                    const isWeapon = gameState.weapons.some(w => w.name === item);
                    const isArmor = gameState.armor.some(a => a.name === item);
                    return !isWeapon && !isArmor;
                });
                inventoryText += otherItems.join(', ') || 'None';
                inventoryText += `</p>`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${inventoryText}</div>`;
        }
        
        // Equip weapon function
        function equipWeapon(index) {
            if (index >= 0 && index < gameState.weapons.length) {
                gameState.currentWeaponIndex = index;
                updateInventoryDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped ${gameState.weapons[index].name}!</div>`;
                saveGame();
            }
        }
        
        // Equip armor function
        function equipArmor(index) {
            if (index >= 0 && index < gameState.armor.length) {
                gameState.currentArmorIndex = index;
                updateInventoryDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped ${gameState.armor[index].name}!</div>`;
                saveGame();
            }
        }
        
        // Save game
        function saveGame() {
            // Ensure indices are valid before saving
            if (gameState.currentWeaponIndex >= gameState.weapons.length) {
                gameState.currentWeaponIndex = gameState.weapons.length - 1;
            }
            if (gameState.currentArmorIndex >= gameState.armor.length) {
                gameState.currentArmorIndex = gameState.armor.length - 1;
            }
            
            localStorage.setItem('dreadwoodGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">Game saved!</div>`;
        }
        
        // Go to next level
        function goToNextLevel() {
            // Save game state for level 5
            localStorage.setItem('dreadwoodGameState', JSON.stringify(gameState));
            // Redirect to level 5
            window.location.href = 'level5.html';
        }
        
        // Utility function to roll dice
        function rollDiceHelper(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
    </script>
</body>
</html>
