<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DreadWood: Bloodstone Keep</title>
    <style>
        /* STYLE with castle/keep theme colors */
        body {
            font-family: 'Courier New', monospace;
            background-color: #1a0a0a;
            color: #ff3333;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            border: 2px solid #ff3333;
            background-color: #000;
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #ff3333;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #ff3333;
            text-shadow: 0 0 5px #ff3333;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
        }
        
        h2 {
            color: #ff6633;
            border-bottom: 1px solid #ff6633;
            padding-bottom: 5px;
            margin-top: 25px;
        }
        
        .screen {
            display: none;
        }
        
        .active-screen {
            display: block;
        }
        
        .stats-bar {
            background-color: #221111;
            border: 1px solid #ff3333;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-value {
            color: #ffff33;
            font-weight: bold;
        }
        
        .inventory {
            background-color: #221111;
            border: 1px solid #ff6633;
            padding: 10px;
            margin: 15px 0;
            min-height: 60px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #332222;
            border: 1px solid #ff6633;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
        }
        
        .story-text {
            background-color: #111111;
            border: 1px solid #ff3333;
            padding: 15px;
            margin: 20px 0;
            min-height: 150px;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #332222;
            color: #ff3333;
            border: 2px solid #ff3333;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #443333;
            color: #ff9933;
            border-color: #ff9933;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #330000;
            color: #ff6633;
            border: 2px solid #ff6633;
            padding: 10px 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #550000;
            color: #ff9966;
        }
        
        .dice-roll {
            background-color: #332222;
            border: 1px solid #ff3333;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ffff33;
        }
        
        .game-over {
            color: #ff3333;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #ff3333;
        }
        
        .success {
            color: #33ff33;
            font-weight: bold;
        }
        
        .damage {
            color: #ff3333;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9933;
            font-weight: bold;
        }
        
        .treasure {
            color: #ffcc00;
            font-weight: bold;
        }
        
        .secret {
            color: #9933ff;
            font-weight: bold;
        }
        
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #330000;
            color: #ff6633;
            border: 2px solid #ff6633;
            padding: 15px 30px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #550000;
            color: #ff9966;
        }
        
        .retro-notice {
            text-align: center;
            color: #888888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333333;
            padding-top: 10px;
        }
        
        .warning-dialog {
            background-color: #332222;
            border: 2px solid #ff3333;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .warning-text {
            color: #ff9933;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .dialog-btn {
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid;
        }
        
        .dialog-btn-yes {
            background-color: #332222;
            color: #ff3333;
            border-color: #ff3333;
        }
        
        .dialog-btn-no {
            background-color: #332222;
            color: #ff3333;
            border-color: #ff3333;
        }
        
        .castle-map {
            background-color: #111111;
            border: 1px solid #ff3333;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre;
            font-size: 12px;
            overflow-x: auto;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 10px;
                font-size: 14px;
            }
            
            .dialog-buttons {
                flex-direction: column;
            }
            
            .castle-map {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DREADWOOD</h1>
            <h2>BLOODSTONE KEEP</h2>
            <div class="retro-notice">Level 4 - The Fortress of Crimson Shadows</div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item">SKILL: <span id="stat-skill" class="stat-value">0</span></div>
                <div class="stat-item">STAMINA: <span id="stat-stamina" class="stat-value">0</span>/<span id="stat-maxstamina" class="stat-value">0</span></div>
                <div class="stat-item">LUCK: <span id="stat-luck" class="stat-value">0</span></div>
                <div class="stat-item">GOLD: <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <h2>INVENTORY</h2>
            <div class="inventory" id="inventory">
                <!-- Inventory will be loaded from saved game -->
            </div>
            
            <h2>THE ADVENTURE</h2>
            <div class="story-text" id="story-text">
                <p>BLOODSTONE KEEP rises before you - a fortress carved from crimson-hued stone that seems to bleed in the twilight. Its towers pierce the gloom like bloody spears. Legends say the Keep holds ancient secrets and terrible power. To continue your quest, you must pass through this accursed place and reach the ASHEN WASTES beyond.</p>
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <button class="choice-btn" onclick="loadSection(1)">Approach the Main Gate</button>
                <button class="choice-btn" onclick="loadSection(2)">Search for a Secret Entrance</button>
                <button class="choice-btn" onclick="loadSection(3)">Scale the Outer Wall</button>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useLuck()">TEST LUCK</button>
                <button class="action-btn" onclick="checkInventory()">INVENTORY</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="showNewGameWarning()">START NEW GAME</button>
            </div>
        </div>
        
        <!-- Warning Dialog for New Game -->
        <div id="warning-dialog" class="screen">
            <div class="warning-dialog">
                <div class="warning-text">WARNING: Starting a new game will delete ALL your current progress!</div>
                <p>Your current character, stats, inventory, and gold will be permanently erased.</p>
                <p>You will return to the beginning of the game to create a new character.</p>
                <div class="dialog-buttons">
                    <button class="dialog-btn dialog-btn-yes" onclick="startNewGame()">YES, START NEW GAME</button>
                    <button class="dialog-btn dialog-btn-no" onclick="cancelNewGame()">NO, KEEP MY CHARACTER</button>
                </div>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>VICTORY!</h2>
            <div class="story-text">
                <p>You have conquered BLOODSTONE KEEP!</p>
                <p>Through courage, cunning, or sheer force, you've navigated the deadly fortress and emerged victorious. Beyond the Keep's far walls stretch the barren ASHEN WASTES - a land of ash and memory where your journey continues.</p>
                <p>All your stats, gold, and inventory will carry over to the next chapter.</p>
                <div class="stats-bar">
                    <div class="stat-item">SKILL: <span id="next-stat-skill" class="stat-value">0</span></div>
                    <div class="stat-item">STAMINA: <span id="next-stat-stamina" class="stat-value">0</span></div>
                    <div class="stat-item">LUCK: <span id="next-stat-luck" class="stat-value">0</span></div>
                    <div class="stat-item">GOLD: <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO ASHEN WASTES</button>
            </div>
        </div>
        
        <div class="retro-notice">
            DREADWOOD - A Retro Gamebook Adventure<br>
            Level 4: Bloodstone Keep
        </div>
    </div>

    <script>
        // Game state (loaded from localStorage)
        let gameState = JSON.parse(localStorage.getItem('dreadwoodGameState')) || {
            playerClass: 'warrior',
            skill: 10,
            maxStamina: 18,
            stamina: 18,
            luck: 10,
            gold: 100,
            inventory: ['Dagger', 'Leather Armor'],
            weapons: [{name: 'Dagger', damage: '1d6'}],
            armor: [{name: 'Leather Armor', defense: 1}],
            currentSection: 0,
            gameComplete: false
        };
        
        // Track keep-specific conditions
        let keepConditions = {
            hasMap: false,
            foundSecretPassage: false,
            disguised: false,
            allianceMade: false,
            bloodstoneActivated: false
        };
        
        // Level 4 story sections - BLOODSTONE KEEP
        const storySections = {
            0: {
                text: "BLOODSTONE KEEP rises before you - a fortress carved from crimson-hued stone that seems to bleed in the twilight. Its towers pierce the gloom like bloody spears. Legends say the Keep holds ancient secrets and terrible power. To continue your quest, you must pass through this accursed place and reach the ASHEN WASTES beyond.",
                choices: [
                    {text: "Approach the main gate openly", nextSection: 1, skillCheck: false},
                    {text: "Search for a secret entrance along the walls", nextSection: 2, skillCheck: false},
                    {text: "Attempt to scale the outer wall under cover of darkness", nextSection: 3, skillCheck: false}
                ]
            },
            1: {
                text: "You approach the massive iron-banded gates of Bloodstone Keep. Two guards in crimson armor stand watch. 'Halt! State your business at the Keep of Blood!' one commands, hand on his sword.",
                choices: [
                    {text: "Claim to be a mercenary seeking employment", nextSection: 4, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Say you're a messenger with important news", nextSection: 5, skillCheck: true, checkType: 'luck', difficulty: 11},
                    {text: "Attack the guards", nextSection: 6, skillCheck: false},
                    {text: "Attempt to bribe your way in", nextSection: 7, skillCheck: false}
                ]
            },
            2: {
                text: "You skirt the perimeter of the Keep, searching the crimson stonework for hidden entrances. The walls are slick with moisture that looks disturbingly like blood. After an hour of searching, you find three possibilities:",
                choices: [
                    {text: "A drainage grate that might lead to the sewers", nextSection: 8, skillCheck: false},
                    {text: "A crack in the stonework wide enough to squeeze through", nextSection: 9, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "An old delivery entrance partially concealed by vines", nextSection: 10, skillCheck: false}
                ]
            },
            3: {
                text: "You wait for nightfall and approach the western wall, which seems less guarded. The crimson stone is rough and provides some handholds, but it's a dangerous climb.",
                choices: [
                    {text: "Attempt the climb", nextSection: 11, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Use a grappling hook if you have one", nextSection: 12, skillCheck: false},
                    {text: "Look for a better spot to climb", nextSection: 13, skillCheck: false}
                ]
            },
            4: {
                text: "You claim to be a mercenary seeking work...",
                choices: [
                    {text: "Continue", nextSection: 14, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        keepConditions.disguised = true;
                        return "The guard nods. 'We could use another sword. Report to the barracks for assignment.' You're admitted to the Keep.";
                    } else {
                        gameState.stamina -= 3;
                        updateStatsDisplay();
                        return "The guard eyes you suspiciously. 'You don't look like any mercenary I've seen.' He shoves you back, causing you to lose 3 Stamina.";
                    }
                }
            },
            5: {
                text: "You claim to be a messenger with urgent news...",
                choices: [
                    {text: "Continue", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "The guard seems concerned. 'Very well, proceed to the Great Hall. But don't cause trouble.' You're let inside.";
                    } else {
                        return "The guard laughs. 'Nice try. We haven't had messengers from outside in months.' He bars your way.";
                    }
                }
            },
            6: {
                text: "You attack the gate guards! Roll for combat!",
                choices: [
                    {text: "Roll for attack", nextSection: 16, skillCheck: false}
                ],
                action: function() {
                    return startCombat("Bloodstone Guard", 15, 10, 17);
                }
            },
            7: {
                text: "'Perhaps we could come to an arrangement?' you say, jingling your coin purse.",
                choices: [
                    {text: "Offer 20 Gold", nextSection: 18, skillCheck: false},
                    {text: "Offer 50 Gold", nextSection: 19, skillCheck: false},
                    {text: "Try to haggle", nextSection: 20, skillCheck: true, checkType: 'luck', difficulty: 12}
                ]
            },
            8: {
                text: "You pry open the rusty drainage grate and slip into the darkness below. The smell is foul, and you're soon wading through knee-deep water in what appears to be the Keep's sewers.",
                choices: [
                    {text: "Follow the water flow", nextSection: 21, skillCheck: false},
                    {text: "Go against the current", nextSection: 22, skillCheck: false},
                    {text: "Search for a way up into the Keep", nextSection: 23, skillCheck: false}
                ]
            },
            9: {
                text: "You attempt to squeeze through the crack in the stonework...",
                choices: [
                    {text: "Continue", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        keepConditions.foundSecretPassage = true;
                        return "You squeeze through the narrow crack and find yourself in a hidden passage within the walls!";
                    } else {
                        gameState.stamina -= 4;
                        updateStatsDisplay();
                        return "You get stuck! After struggling free, you take 4 damage from scraping against the rough stone.";
                    }
                }
            },
            10: {
                text: "The old delivery entrance is partially overgrown but the door appears unlocked. You push it open and slip inside, finding yourself in a dusty storage room.",
                choices: [
                    {text: "Search the storage room", nextSection: 25, skillCheck: false},
                    {text: "Proceed into the Keep proper", nextSection: 26, skillCheck: false},
                    {text: "Try to find servant's clothing to disguise yourself", nextSection: 27, skillCheck: false}
                ]
            },
            11: {
                text: "You attempt the dangerous climb up the Keep's wall...",
                choices: [
                    {text: "Continue", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "You scale the wall successfully and pull yourself onto a narrow walkway near the top!";
                    } else {
                        const damage = rollDiceHelper(1, 8);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        return "You slip and fall! You take " + damage + " damage from the fall.";
                    }
                }
            },
            12: {
                text: "You use a grappling hook to assist your climb...",
                choices: [
                    {text: "Continue", nextSection: 29, skillCheck: false}
                ],
                action: function() {
                    // Check if player has grappling hook
                    const hasHook = gameState.inventory.includes("Grappling Hook");
                    if (hasHook) {
                        return "The grappling hook makes the climb much easier! You reach the top safely.";
                    } else {
                        gameState.stamina -= 5;
                        updateStatsDisplay();
                        return "You don't have a grappling hook! You attempt to climb anyway and slip, falling and taking 5 damage.";
                    }
                }
            },
            13: {
                text: "You search for a better climbing spot and find a section where the stones are more uneven. It still looks difficult.",
                choices: [
                    {text: "Climb here", nextSection: 30, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Return to the gate", nextSection: 1, skillCheck: false}
                ]
            },
            14: {
                text: window.checkResult ? 
                    "Admitted as a mercenary, you enter the Keep's courtyard. A sergeant directs you toward the barracks." : 
                    "Refused entry, you must find another way in.",
                choices: [
                    window.checkResult ? 
                        {text: "Go to the barracks as directed", nextSection: 31, skillCheck: false} :
                        {text: "Try another approach", nextSection: 0, skillCheck: false}
                ]
            },
            15: {
                text: window.checkResult ? 
                    "Admitted as a messenger, you enter the Keep's main courtyard." : 
                    "Your deception fails and you're turned away.",
                choices: [
                    window.checkResult ? 
                        {text: "Proceed to the Great Hall as instructed", nextSection: 32, skillCheck: false} :
                        {text: "Try another approach", nextSection: 0, skillCheck: false}
                ]
            },
            16: {
                text: "", // Combat results
                choices: [
                    {text: "Enter the Keep through the now-unguarded gate", nextSection: 33, skillCheck: false}
                ]
            },
            17: {
                text: "With the guards defeated, you enter Bloodstone Keep. The gate opens into a large courtyard with several buildings.",
                choices: [
                    {text: "Head toward the main keep building", nextSection: 34, skillCheck: false},
                    {text: "Search the guard barracks", nextSection: 35, skillCheck: false},
                    {text: "Investigate the stables", nextSection: 36, skillCheck: false}
                ]
            },
            18: {
                text: "You offer 20 Gold to the guards...",
                choices: [
                    {text: "Continue", nextSection: 37, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 20) {
                        gameState.gold -= 20;
                        updateStatsDisplay();
                        return "The guard pockets the gold. 'Make it quick, and stay out of trouble.' He opens the gate.";
                    } else {
                        return "You don't have enough gold! The guard scowls at you.";
                    }
                }
            },
            19: {
                text: "You offer 50 Gold to the guards...",
                choices: [
                    {text: "Continue", nextSection: 38, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 50) {
                        gameState.gold -= 50;
                        updateStatsDisplay();
                        return "The guard's eyes widen. 'Very generous! The captain's in the Great Hall if you need him.' You're admitted with a smile.";
                    } else {
                        return "You don't have enough gold! The guard looks disappointed.";
                    }
                }
            },
            20: {
                text: "You attempt to haggle with the guards...",
                choices: [
                    {text: "Continue", nextSection: 39, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const cost = Math.floor(Math.random() * 15) + 10;
                        gameState.gold -= cost;
                        updateStatsDisplay();
                        return "You haggle successfully! The guard accepts " + cost + " Gold and lets you in.";
                    } else {
                        return "Your haggling annoys the guard. 'Enough! Pay 30 Gold or get lost!'";
                    }
                }
            },
            21: {
                text: "Following the water flow, you come to a larger chamber where several sewer channels converge. In the center of the chamber is a stone platform with a strange altar.",
                choices: [
                    {text: "Examine the altar", nextSection: 40, skillCheck: false},
                    {text: "Continue following the main channel", nextSection: 41, skillCheck: false},
                    {text: "Take one of the side channels", nextSection: 42, skillCheck: false}
                ]
            },
            22: {
                text: "Going against the current is difficult, but you soon find a metal ladder leading up to a grate. Light filters down from above.",
                choices: [
                    {text: "Climb the ladder", nextSection: 43, skillCheck: false},
                    {text: "Continue against the current", nextSection: 44, skillCheck: false}
                ]
            },
            23: {
                text: "Searching for a way up, you find a rusted metal door set into the sewer wall. It's locked, but looks old and weak.",
                choices: [
                    {text: "Try to force the door open", nextSection: 45, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Look for another way up", nextSection: 46, skillCheck: false},
                    {text: "Return to the entrance", nextSection: 47, skillCheck: false}
                ]
            },
            24: {
                text: window.checkResult ? 
                    "You find yourself in a narrow secret passage that runs within the Keep's walls. It's dark but passable." : 
                    "After freeing yourself, you decide the crack is too dangerous.",
                choices: [
                    window.checkResult ? 
                        {text: "Follow the passage", nextSection: 48, skillCheck: false} :
                        {text: "Try a different entrance", nextSection: 0, skillCheck: false}
                ]
            },
            25: {
                text: "The storage room contains old crates and barrels. Searching them, you find various supplies that might be useful.",
                choices: [
                    {text: "Take a cloak for disguise", nextSection: 49, skillCheck: false},
                    {text: "Search for weapons or armor", nextSection: 50, skillCheck: false},
                    {text: "Look for food or healing items", nextSection: 51, skillCheck: false},
                    {text: "Leave the room and explore", nextSection: 26, skillCheck: false}
                ]
            },
            26: {
                text: "Leaving the storage room, you find yourself in a corridor. To the left, you hear clanging from what might be a kitchen. To the right, stairs lead upward.",
                choices: [
                    {text: "Go left toward the kitchen sounds", nextSection: 52, skillCheck: false},
                    {text: "Go right up the stairs", nextSection: 53, skillCheck: false},
                    {text: "Continue straight down the corridor", nextSection: 54, skillCheck: false}
                ]
            },
            27: {
                text: "You search for servant's clothing and find some old uniforms in a chest. They might help you blend in.",
                choices: [
                    {text: "Put on a servant's uniform", nextSection: 55, skillCheck: false},
                    {text: "Take a uniform but don't wear it yet", nextSection: 56, skillCheck: false},
                    {text: "Leave the uniforms", nextSection: 25, skillCheck: false}
                ]
            },
            28: {
                text: window.checkResult ? 
                    "From the walkway, you can see the Keep's layout below. A door leads inside from here." : 
                    "You lie injured at the base of the wall.",
                choices: [
                    window.checkResult ? 
                        {text: "Enter through the door", nextSection: 57, skillCheck: false} :
                        {text: "Try another approach", nextSection: 0, skillCheck: false}
                ]
            },
            29: {
                text: "You successfully climb the wall using the grappling hook and find yourself on a high walkway.",
                choices: [
                    {text: "Enter the Keep through a nearby window", nextSection: 58, skillCheck: false},
                    {text: "Follow the walkway", nextSection: 59, skillCheck: false}
                ]
            },
            30: {
                text: window.checkResult ? 
                    "You find better handholds here and climb successfully to the top of the wall!" : 
                    "This spot isn't any better. You fall and take damage.",
                choices: [
                    window.checkResult ? 
                        {text: "Enter the Keep from the wall", nextSection: 60, skillCheck: false} :
                        {text: "Give up on climbing", nextSection: 0, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult) {
                        const damage = rollDiceHelper(1, 6);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                    }
                }
            },
            31: {
                text: "You find the barracks - a long building filled with bunk beds and weapons racks. A few off-duty guards glance at you but don't question your presence.",
                choices: [
                    {text: "Try to learn the Keep's layout from the guards", nextSection: 61, skillCheck: true, checkType: 'luck', difficulty: 12},
                    {text: "Search for useful equipment", nextSection: 62, skillCheck: false},
                    {text: "Leave the barracks and explore", nextSection: 63, skillCheck: false}
                ]
            },
            32: {
                text: "Following directions to the Great Hall, you enter a massive chamber with a high ceiling. Tapestries depicting bloody battles cover the walls. At the far end sits a throne, currently empty.",
                choices: [
                    {text: "Examine the tapestries", nextSection: 64, skillCheck: false},
                    {text: "Approach the throne", nextSection: 65, skillCheck: false},
                    {text: "Look for another exit from the hall", nextSection: 66, skillCheck: false}
                ]
            },
            33: {
                text: "With the guards defeated, you hurry through the gate before reinforcements arrive.",
                choices: [
                    {text: "Hide the bodies", nextSection: 67, skillCheck: false},
                    {text: "Run deeper into the Keep", nextSection: 68, skillCheck: false}
                ]
            },
            34: {
                text: "The main keep is a towering structure of blood-red stone. The heavy oak doors stand slightly ajar.",
                choices: [
                    {text: "Enter the main keep", nextSection: 69, skillCheck: false},
                    {text: "Circle around to look for another entrance", nextSection: 70, skillCheck: false}
                ]
            },
            35: {
                text: "The guard barracks contain sleeping quarters and an armory. Currently, only a single guard is present, polishing his armor.",
                choices: [
                    {text: "Attack the guard", nextSection: 71, skillCheck: false},
                    {text: "Try to sneak past him", nextSection: 72, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Talk to the guard", nextSection: 73, skillCheck: false}
                ]
            },
            36: {
                text: "The stables contain a few horses and a cart. A young stable hand is mucking out stalls.",
                choices: [
                    {text: "Question the stable hand", nextSection: 74, skillCheck: false},
                    {text: "Search for useful items", nextSection: 75, skillCheck: false},
                    {text: "Hide in the stables", nextSection: 76, skillCheck: false}
                ]
            },
            37: {
                text: gameState.gold >= 20 ? 
                    "The guard takes your gold and lets you pass into the Keep's courtyard." : 
                    "You can't afford the bribe.",
                choices: [
                    gameState.gold >= 20 ? 
                        {text: "Enter the courtyard", nextSection: 77, skillCheck: false} :
                        {text: "Try another approach", nextSection: 0, skillCheck: false}
                ]
            },
            38: {
                text: gameState.gold >= 50 ? 
                    "The guard happily takes your substantial bribe and gives you directions to the Great Hall." : 
                    "You don't have enough gold for such a large bribe.",
                choices: [
                    gameState.gold >= 50 ? 
                        {text: "Follow the directions to the Great Hall", nextSection: 32, skillCheck: false} :
                        {text: "Try a smaller bribe", nextSection: 18, skillCheck: false}
                ]
            },
            39: {
                text: window.checkResult ? 
                    "You successfully haggle and enter the Keep." : 
                    "Your haggling fails and the guard demands 30 Gold.",
                choices: [
                    window.checkResult ? 
                        {text: "Enter the Keep", nextSection: 77, skillCheck: false} :
                        {text: "Pay 30 Gold", nextSection: 78, skillCheck: false}
                ]
            },
            40: {
                text: "The altar is made of black stone with red veins running through it. A depression in the center holds a dark liquid. Strange symbols are carved around the edge.",
                choices: [
                    {text: "Touch the liquid", nextSection: 79, skillCheck: false},
                    {text: "Try to read the symbols", nextSection: 80, skillCheck: true, checkType: 'luck', difficulty: 13},
                    {text: "Leave the altar alone", nextSection: 41, skillCheck: false}
                ]
            },
            41: {
                text: "Following the main channel, you eventually come to a waterfall where the sewage plunges into darkness. A metal walkway runs alongside it.",
                choices: [
                    {text: "Take the walkway", nextSection: 81, skillCheck: false},
                    {text: "Return the way you came", nextSection: 82, skillCheck: false}
                ]
            },
            42: {
                text: "You take a side channel that gradually ascends. After a while, you find a stone staircase leading up out of the sewers.",
                choices: [
                    {text: "Climb the stairs", nextSection: 83, skillCheck: false}
                ]
            },
            43: {
                text: "You climb the ladder and push open the grate at the top. You emerge in a kitchen garden within the Keep's walls.",
                choices: [
                    {text: "Hide in the garden", nextSection: 84, skillCheck: false},
                    {text: "Head toward the kitchen door", nextSection: 85, skillCheck: false}
                ]
            },
            44: {
                text: "Continuing against the current, you find the source: a pipe pouring clean water into the sewer. Above it is a drainage opening from the Keep's upper levels.",
                choices: [
                    {text: "Climb up through the drainage opening", nextSection: 86, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Go back", nextSection: 82, skillCheck: false}
                ]
            },
            45: {
                text: "You attempt to force the rusted door open...",
                choices: [
                    {text: "Continue", nextSection: 87, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "The door gives way with a loud screech! Beyond is a cellar filled with barrels and crates.";
                    } else {
                        gameState.stamina -= 3;
                        updateStatsDisplay();
                        return "The door won't budge! You strain against it and take 3 damage from the effort.";
                    }
                }
            },
            46: {
                text: "Searching further, you find a narrow chimney-like shaft with iron rungs set into the stone.",
                choices: [
                    {text: "Climb the shaft", nextSection: 88, skillCheck: true, checkType: 'skill', difficulty: 12}
                ]
            },
            47: {
                text: "You return to the drainage grate entrance.",
                choices: [
                    {text: "Exit the sewers", nextSection: 0, skillCheck: false},
                    {text: "Try a different path in the sewers", nextSection: 21, skillCheck: false}
                ]
            },
            48: {
                text: "The secret passage winds through the walls. You pass arrow slits that provide glimpses of the Keep's interior. Eventually, you come to a junction.",
                choices: [
                    {text: "Go left", nextSection: 89, skillCheck: false},
                    {text: "Go right", nextSection: 90, skillCheck: false},
                    {text: "Continue straight", nextSection: 91, skillCheck: false}
                ]
            },
            49: {
                text: "You find a dusty but serviceable cloak that might help you blend in.",
                choices: [
                    {text: "Put on the cloak and continue", nextSection: 92, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Disguise Cloak");
                    keepConditions.disguised = true;
                    updateInventoryDisplay();
                    return "You take the cloak. It should help you move through the Keep unnoticed.";
                }
            },
            50: {
                text: "Searching for weapons, you find an old but sharp short sword and a leather jerkin that offers some protection.",
                choices: [
                    {text: "Take the sword and jerkin", nextSection: 93, skillCheck: false},
                    {text: "Leave them", nextSection: 25, skillCheck: false}
                ]
            },
            51: {
                text: "You find a crate of preserved rations and a small bottle of healing salve.",
                choices: [
                    {text: "Take the supplies", nextSection: 94, skillCheck: false},
                    {text: "Leave them", nextSection: 25, skillCheck: false}
                ]
            },
            52: {
                text: "The kitchen is bustling with activity. Cooks and servants prepare food. No one seems to notice you at first.",
                choices: [
                    {text: "Try to blend in with the servants", nextSection: 95, skillCheck: false},
                    {text: "Ask for directions", nextSection: 96, skillCheck: false},
                    {text: "Sneak through the kitchen", nextSection: 97, skillCheck: true, checkType: 'skill', difficulty: 11}
                ]
            },
            53: {
                text: "The stairs lead up to a corridor on the next level. This area appears more well-kept, with torches in sconces and better furnishings.",
                choices: [
                    {text: "Explore the corridor", nextSection: 98, skillCheck: false},
                    {text: "Listen at the nearest door", nextSection: 99, skillCheck: false}
                ]
            },
            54: {
                text: "Continuing down the corridor, you come to a heavy door with a barred window. Peering through, you see a dungeon cellblock.",
                choices: [
                    {text: "Enter the dungeon", nextSection: 100, skillCheck: false},
                    {text: "Go back", nextSection: 26, skillCheck: false}
                ]
            },
            55: {
                text: "You put on a servant's uniform. It's a bit musty but fits reasonably well.",
                choices: [
                    {text: "Leave the storage room disguised as a servant", nextSection: 101, skillCheck: false}
                ],
                action: function() {
                    keepConditions.disguised = true;
                    return "The servant's uniform should allow you to move through the Keep with less suspicion.";
                }
            },
            56: {
                text: "You take a servant's uniform but don't put it on yet.",
                choices: [
                    {text: "Return to searching the room", nextSection: 25, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Servant's Uniform");
                    updateInventoryDisplay();
                }
            },
            57: {
                text: "The door opens into a guard tower. Luckily, it's currently unoccupied. A spiral staircase leads down into the Keep.",
                choices: [
                    {text: "Descend the staircase", nextSection: 102, skillCheck: false}
                ]
            },
            58: {
                text: "You climb through the window into what appears to be a noble's bedchamber. The room is lavishly furnished but currently empty.",
                choices: [
                    {text: "Search the room", nextSection: 103, skillCheck: false},
                    {text: "Leave quickly", nextSection: 104, skillCheck: false}
                ]
            },
            59: {
                text: "The walkway connects several towers. You can see much of the Keep from this height.",
                choices: [
                    {text: "Enter the nearest tower", nextSection: 105, skillCheck: false},
                    {text: "Continue along the walkway", nextSection: 106, skillCheck: false}
                ]
            },
            60: {
                text: "From the top of the wall, you have a good view of the Keep's layout. A guard patrol approaches in the distance!",
                choices: [
                    {text: "Hide until they pass", nextSection: 107, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Jump down into the courtyard", nextSection: 108, skillCheck: false}
                ]
            },
            61: {
                text: window.checkResult ? 
                    "You strike up a conversation with a guard who draws you a crude map of the Keep's main areas." : 
                    "The guards are suspicious and tell you to mind your own business.",
                choices: [
                    {text: "Continue", nextSection: 109, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        keepConditions.hasMap = true;
                        return "You now have a basic map of Bloodstone Keep!";
                    }
                }
            },
            62: {
                text: "Searching the barracks, you find a better sword, a helmet, and 30 Gold in a guard's footlocker.",
                choices: [
                    {text: "Take the equipment and gold", nextSection: 110, skillCheck: false},
                    {text: "Leave it and go", nextSection: 63, skillCheck: false}
                ]
            },
            63: {
                text: "Leaving the barracks, you're back in the courtyard. Where to now?",
                choices: [
                    {text: "Enter the main keep", nextSection: 34, skillCheck: false},
                    {text: "Check the stables", nextSection: 36, skillCheck: false},
                    {text: "Look for the postern gate", nextSection: 111, skillCheck: false}
                ]
            },
            64: {
                text: "The tapestries depict ancient battles, coronations, and strange rituals involving blood and stone. One shows a massive red gem being placed in a castle's foundation.",
                choices: [
                    {text: "Examine the gem tapestry more closely", nextSection: 112, skillCheck: false},
                    {text: "Return to exploring the hall", nextSection: 32, skillCheck: false}
                ]
            },
            65: {
                text: "Approaching the throne, you notice it's made of the same blood-red stone as the Keep. The armrests are carved to look like clawed hands.",
                choices: [
                    {text: "Sit on the throne", nextSection: 113, skillCheck: false},
                    {text: "Search behind the throne", nextSection: 114, skillCheck: false},
                    {text: "Leave the throne alone", nextSection: 32, skillCheck: false}
                ]
            },
            66: {
                text: "Besides the main entrance, you find two other doors in the Great Hall.",
                choices: [
                    {text: "Take the left door", nextSection: 115, skillCheck: false},
                    {text: "Take the right door", nextSection: 116, skillCheck: false},
                    {text: "Go back through the main entrance", nextSection: 117, skillCheck: false}
                ]
            },
            67: {
                text: "You drag the guards' bodies out of sight. Searching them, you find keys, 40 Gold, and a map of the guard patrols.",
                choices: [
                    {text: "Take the items and proceed", nextSection: 118, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 40;
                    gameState.inventory.push("Guard Keys", "Patrol Map");
                    keepConditions.hasMap = true;
                    updateStatsDisplay();
                    updateInventoryDisplay();
                }
            },
            68: {
                text: "You run deeper into the Keep, hoping to lose yourself in its corridors before more guards arrive.",
                choices: [
                    {text: "Hide in an alcove", nextSection: 119, skillCheck: false},
                    {text: "Keep running", nextSection: 120, skillCheck: false}
                ]
            },
            69: {
                text: "Inside the main keep, you find yourself in a grand entrance hall with marble floors and tapestries. Stairs lead up, and corridors branch left and right.",
                choices: [
                    {text: "Go upstairs", nextSection: 121, skillCheck: false},
                    {text: "Take the left corridor", nextSection: 122, skillCheck: false},
                    {text: "Take the right corridor", nextSection: 123, skillCheck: false}
                ]
            },
            70: {
                text: "Circling the main keep, you find a servants' entrance and a delivery ramp leading to a lower level.",
                choices: [
                    {text: "Use the servants' entrance", nextSection: 124, skillCheck: false},
                    {text: "Take the delivery ramp down", nextSection: 125, skillCheck: false}
                ]
            },
            71: {
                text: "You attack the lone guard in the barracks! Roll for combat!",
                choices: [
                    {text: "Roll for attack", nextSection: 126, skillCheck: false}
                ],
                action: function() {
                    return startCombat("Barracks Guard", 12, 9, 127);
                }
            },
            72: {
                text: "You attempt to sneak past the guard...",
                choices: [
                    {text: "Continue", nextSection: 128, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "You slip past the guard unnoticed and find the armory!";
                    } else {
                        return "The guard spots you! 'Hey! You're not supposed to be in here!'";
                    }
                }
            },
            73: {
                text: "'Afternoon,' you say to the guard. He looks up from his polishing. 'You new? Haven't seen you around.'",
                choices: [
                    {text: "Say you just arrived", nextSection: 129, skillCheck: false},
                    {text: "Ask about the Keep's defenses", nextSection: 130, skillCheck: true, checkType: 'luck', difficulty: 14},
                    {text: "Make an excuse and leave", nextSection: 63, skillCheck: false}
                ]
            },
            74: {
                text: "'Excuse me,' you say to the stable hand. He looks up nervously. 'Y-yes, sir?'",
                choices: [
                    {text: "Ask about ways out of the Keep", nextSection: 131, skillCheck: false},
                    {text: "Ask about the Keep's layout", nextSection: 132, skillCheck: false},
                    {text: "Threaten him for information", nextSection: 133, skillCheck: false}
                ]
            },
            75: {
                text: "Searching the stables, you find a saddlebag containing 25 Gold, a healing poultice, and a set of lockpicks.",
                choices: [
                    {text: "Take the items", nextSection: 134, skillCheck: false},
                    {text: "Leave them", nextSection: 36, skillCheck: false}
                ]
            },
            76: {
                text: "You hide in an empty stall. After a while, you hear guards searching the courtyard for an intruder!",
                choices: [
                    {text: "Stay hidden", nextSection: 135, skillCheck: false},
                    {text: "Try to escape while they search elsewhere", nextSection: 136, skillCheck: false}
                ]
            },
            77: {
                text: "You enter the main courtyard of Bloodstone Keep. Various buildings surround the open space, and guards patrol regularly.",
                choices: [
                    {text: "Head toward the main keep", nextSection: 34, skillCheck: false},
                    {text: "Look for a less obvious entrance", nextSection: 137, skillCheck: false},
                    {text: "Observe the guard patrol patterns", nextSection: 138, skillCheck: false}
                ]
            },
            78: {
                text: gameState.gold >= 30 ? 
                    "You reluctantly pay 30 Gold and are admitted to the Keep." : 
                    "You don't have 30 Gold. The guard pushes you away.",
                choices: [
                    gameState.gold >= 30 ? 
                        {text: "Enter the Keep", nextSection: 77, skillCheck: false} :
                        {text: "Leave and try another approach", nextSection: 0, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 30) {
                        gameState.gold -= 30;
                        updateStatsDisplay();
                    }
                }
            },
            79: {
                text: "Touching the dark liquid, your finger comes away stained red. The liquid feels warm and seems to pulse with a faint energy.",
                choices: [
                    {text: "Taste it", nextSection: 139, skillCheck: false},
                    {text: "Wipe it off quickly", nextSection: 140, skillCheck: false}
                ]
            },
            80: {
                text: window.checkResult ? 
                    "You recognize the symbols as an ancient language. They speak of 'the Heartstone' and 'the price of power'." : 
                    "The symbols are unfamiliar and make your head ache to look at.",
                choices: [
                    {text: "Continue", nextSection: 141, skillCheck: false}
                ]
            },
            81: {
                text: "The walkway leads to a metal door that opens into a basement level of the Keep. You've found a way in!",
                choices: [
                    {text: "Enter through the door", nextSection: 142, skillCheck: false}
                ]
            },
            82: {
                text: "You return to the chamber with the altar.",
                choices: [
                    {text: "Try a different path", nextSection: 42, skillCheck: false},
                    {text: "Go back to the entrance", nextSection: 47, skillCheck: false}
                ]
            },
            83: {
                text: "The stairs lead up to a wooden door. You open it cautiously and find yourself in a cellar filled with wine barrels.",
                choices: [
                    {text: "Explore the cellar", nextSection: 143, skillCheck: false},
                    {text: "Proceed upward", nextSection: 144, skillCheck: false}
                ]
            },
            84: {
                text: "You hide among the plants in the garden. After some time, a servant comes to pick herbs but doesn't notice you.",
                choices: [
                    {text: "Wait until dark", nextSection: 145, skillCheck: false},
                    {text: "Approach the servant", nextSection: 146, skillCheck: false},
                    {text: "Sneak toward the kitchen", nextSection: 147, skillCheck: false}
                ]
            },
            85: {
                text: "You approach the kitchen door and peer inside. Cooks and servants are busy preparing a meal.",
                choices: [
                    {text: "Enter the kitchen", nextSection: 52, skillCheck: false},
                    {text: "Wait for an opportunity to slip in unnoticed", nextSection: 148, skillCheck: false}
                ]
            },
            86: {
                text: "You attempt to climb up through the drainage opening...",
                choices: [
                    {text: "Continue", nextSection: 149, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "You climb successfully and emerge in a washroom on an upper level of the Keep!";
                    } else {
                        gameState.stamina -= 5;
                        updateStatsDisplay();
                        return "You slip and fall back into the sewer, taking 5 damage.";
                    }
                }
            },
            87: {
                text: window.checkResult ? 
                    "The cellar contains food stores and supplies. A staircase leads up." : 
                    "The door remains stubbornly closed.",
                choices: [
                    window.checkResult ? 
                        {text: "Explore the cellar", nextSection: 150, skillCheck: false} :
                        {text: "Try another approach", nextSection: 46, skillCheck: false}
                ]
            },
            88: {
                text: window.checkResult ? 
                    "You climb the shaft and emerge in a closet on an upper level." : 
                    "You slip and fall partway down, taking damage.",
                choices: [
                    window.checkResult ? 
                        {text: "Exit the closet", nextSection: 151, skillCheck: false} :
                        {text: "Try again or go back", nextSection: 152, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult) {
                        const damage = rollDiceHelper(1, 4);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                    }
                }
            },
            89: {
                text: "The left passage leads to a peephole overlooking the Great Hall. You can see and hear what happens there without being seen.",
                choices: [
                    {text: "Watch for a while", nextSection: 153, skillCheck: false},
                    {text: "Continue along the passage", nextSection: 154, skillCheck: false}
                ]
            },
            90: {
                text: "The right passage ends at a ladder leading up to a trapdoor.",
                choices: [
                    {text: "Climb the ladder", nextSection: 155, skillCheck: false},
                    {text: "Go back", nextSection: 48, skillCheck: false}
                ]
            },
            91: {
                text: "Continuing straight, the passage becomes narrower. You find a small niche containing a chest!",
                choices: [
                    {text: "Open the chest", nextSection: 156, skillCheck: false},
                    {text: "Leave it and continue", nextSection: 157, skillCheck: false}
                ]
            },
            92: {
                text: "With your new cloak helping you blend in, you leave the storage room and enter the corridor beyond.",
                choices: [
                    {text: "Proceed cautiously", nextSection: 26, skillCheck: false}
                ]
            },
            93: {
                text: "You take the short sword and leather jerkin. They're better than what you have.",
                choices: [
                    {text: "Equip them and continue", nextSection: 158, skillCheck: false}
                ],
                action: function() {
                    gameState.weapons.push({name: 'Short Sword', damage: '2d4'});
                    gameState.armor.push({name: 'Leather Jerkin', defense: 2});
                    updateInventoryDisplay();
                    return "You equip the Short Sword (2d4 damage) and Leather Jerkin (2 DEF).";
                }
            },
            94: {
                text: "You take the preserved rations and healing salve.",
                choices: [
                    {text: "Continue", nextSection: 159, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Preserved Rations", "Healing Salve");
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 5);
                    updateInventoryDisplay();
                    updateStatsDisplay();
                    return "You take the supplies and use the healing salve, restoring 5 Stamina.";
                }
            },
            95: {
                text: "You grab a tray of bread and try to look like you belong. Most servants ignore you, focused on their work.",
                choices: [
                    {text: "Carry the tray out of the kitchen", nextSection: 160, skillCheck: false},
                    {text: "Put the tray down and slip away", nextSection: 161, skillCheck: false}
                ]
            },
            96: {
                text: "'Excuse me,' you say to a cook. 'I'm new. Where should I take this?' You hold up an empty bowl.",
                choices: [
                    {text: "The cook gives you directions to the servants' hall", nextSection: 162, skillCheck: false}
                ]
            },
            97: {
                text: "You attempt to sneak through the busy kitchen...",
                choices: [
                    {text: "Continue", nextSection: 163, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "You slip through the kitchen unnoticed and reach a door on the far side.";
                    } else {
                        gameState.stamina -= 2;
                        updateStatsDisplay();
                        return "You bump into a servant carrying a pot of hot soup! You're scalded and take 2 damage as the kitchen erupts in chaos.";
                    }
                }
            },
            98: {
                text: "The corridor has several doors. From behind one, you hear voices arguing.",
                choices: [
                    {text: "Listen at the door with voices", nextSection: 164, skillCheck: false},
                    {text: "Try the first door on the left", nextSection: 165, skillCheck: false},
                    {text: "Try the first door on the right", nextSection: 166, skillCheck: false}
                ]
            },
            99: {
                text: "You listen at the nearest door but hear nothing. The door is unlocked.",
                choices: [
                    {text: "Open the door", nextSection: 167, skillCheck: false},
                    {text: "Continue down the corridor", nextSection: 98, skillCheck: false}
                ]
            },
            100: {
                text: "The dungeon is cold and damp. Torches flicker in wall sconces. You hear moaning from some of the cells.",
                choices: [
                    {text: "Search for keys", nextSection: 168, skillCheck: false},
                    {text: "Talk to the prisoners", nextSection: 169, skillCheck: false},
                    {text: "Leave the dungeon", nextSection: 26, skillCheck: false}
                ]
            },
            // VICTORY SECTION - Player completes the Keep
            200: {
                text: "You have successfully navigated Bloodstone Keep! Whether through stealth, combat, or cunning, you've passed through the fortress of crimson stone. Ahead lies the ASHEN WASTES, a barren land where your quest continues.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-skill').textContent = gameState.skill;
                    document.getElementById('next-stat-stamina').textContent = gameState.stamina;
                    document.getElementById('next-stat-luck').textContent = gameState.luck;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Clear keep conditions
                    keepConditions.hasMap = false;
                    keepConditions.foundSecretPassage = false;
                    keepConditions.disguised = false;
                    keepConditions.allianceMade = false;
                    keepConditions.bloodstoneActivated = false;
                    
                    return "You've completed Level 4: Bloodstone Keep!";
                }
            }
        };
        
        // Add more sections to reach victory
        storySections[101] = {text: "Disguised as a servant, you move through the Keep with less suspicion.", choices: [{text: "Explore the Keep", nextSection: 170, skillCheck: false}]};
        storySections[102] = {text: "Descending the staircase, you reach a corridor in the Keep's upper levels.", choices: [{text: "Explore", nextSection: 171, skillCheck: false}]};
        storySections[103] = {text: "Searching the noble's chamber, you find 100 Gold, a fine cloak, and a map showing a secret passage out of the Keep!", choices: [{text: "Take the treasure and follow the map", nextSection: 200, skillCheck: false}], action: function() { gameState.gold += 100; gameState.inventory.push("Fine Cloak", "Secret Passage Map"); updateStatsDisplay(); updateInventoryDisplay(); }};
        storySections[104] = {text: "You leave the bedchamber quickly and find yourself in a hallway.", choices: [{text: "Explore the hallway", nextSection: 172, skillCheck: false}]};
        storySections[105] = {text: "The tower contains a guard post, currently empty. A spiral staircase leads down.", choices: [{text: "Descend the stairs", nextSection: 173, skillCheck: false}]};
        storySections[106] = {text: "The walkway leads to a tower that provides access to the Keep's far wall - your way out!", choices: [{text: "Take the route to the far wall", nextSection: 200, skillCheck: false}]};
        storySections[107] = {text: window.checkResult ? "You hide successfully as the patrol passes." : "The patrol spots you!", choices: [window.checkResult ? {text: "Continue to the exit", nextSection: 200, skillCheck: false} : {text: "Fight or flee", nextSection: 174, skillCheck: false}]};
        storySections[108] = {text: "You jump down into the courtyard and run for the far gate!", choices: [{text: "Make for the exit", nextSection: 200, skillCheck: false}]};
        storySections[109] = {text: keepConditions.hasMap ? "With your new map, you can navigate the Keep more effectively." : "The guards are watching you suspiciously.", choices: [{text: "Leave the barracks", nextSection: 63, skillCheck: false}]};
        storySections[110] = {text: "You take the better equipment and gold.", choices: [{text: "Leave the barracks", nextSection: 63, skillCheck: false}], action: function() { gameState.gold += 30; gameState.weapons.push({name: 'Longsword', damage: '2d6'}); updateStatsDisplay(); updateInventoryDisplay(); }};
        storySections[111] = {text: "You find the postern gate - a small, less guarded exit on the Keep's far side!", choices: [{text: "Use the postern gate to exit", nextSection: 200, skillCheck: false}]};
        storySections[112] = {text: "The tapestry shows the 'Heartstone' - a massive red gem that powers the Keep. According to the imagery, it's in the foundation.", choices: [{text: "Return to exploring", nextSection: 32, skillCheck: false}]};
        storySections[113] = {text: "As you sit on the throne, you feel a surge of power! But dark thoughts fill your mind...", choices: [{text: "Get off the throne quickly", nextSection: 175, skillCheck: false}], action: function() { gameState.skill += 2; gameState.luck -= 2; updateStatsDisplay(); }};
        storySections[114] = {text: "Behind the throne, you find a hidden lever. Pulling it reveals a secret passage!", choices: [{text: "Enter the secret passage", nextSection: 176, skillCheck: false}]};
        storySections[115] = {text: "The left door leads to the Keep's library.", choices: [{text: "Explore the library", nextSection: 177, skillCheck: false}]};
        storySections[116] = {text: "The right door leads to the armory and training yard.", choices: [{text: "Explore the armory", nextSection: 178, skillCheck: false}]};
        storySections[117] = {text: "You return to the courtyard.", choices: [{text: "Explore elsewhere", nextSection: 77, skillCheck: false}]};
        storySections[118] = {text: "With the guard keys and patrol map, you can move through the Keep more safely.", choices: [{text: "Proceed deeper into the Keep", nextSection: 179, skillCheck: false}]};
        storySections[119] = {text: "Hiding in an alcove, you wait until the search passes, then continue.", choices: [{text: "Continue through the Keep", nextSection: 180, skillCheck: false}]};
        storySections[120] = {text: "You keep running and eventually lose your pursuers in the Keep's maze-like corridors.", choices: [{text: "Look for an exit", nextSection: 181, skillCheck: false}]};
        storySections[121] = {text: "Upstairs, you find the living quarters and possibly the lord's chambers.", choices: [{text: "Explore the upper level", nextSection: 182, skillCheck: false}]};
        storySections[122] = {text: "The left corridor leads to the Great Hall.", choices: [{text: "Enter the Great Hall", nextSection: 32, skillCheck: false}]};
        storySections[123] = {text: "The right corridor leads to a chapel dedicated to some dark deity.", choices: [{text: "Enter the chapel", nextSection: 183, skillCheck: false}]};
        storySections[124] = {text: "The servants' entrance leads to the kitchen areas.", choices: [{text: "Enter the kitchen area", nextSection: 184, skillCheck: false}]};
        storySections[125] = {text: "The delivery ramp leads to the cellars.", choices: [{text: "Explore the cellars", nextSection: 185, skillCheck: false}]};
        storySections[126] = {text: "", choices: [{text: "Continue", nextSection: 127, skillCheck: false}]};
        storySections[127] = {text: "After defeating the guard, you search the armory and find excellent equipment!", choices: [{text: "Take what you need and go", nextSection: 186, skillCheck: false}], action: function() { gameState.weapons.push({name: 'Bloodstone Blade', damage: '3d4'}); gameState.armor.push({name: 'Guard Captain Armor', defense: 3}); updateInventoryDisplay(); }};
        storySections[128] = {text: window.checkResult ? "You reach the armory unseen." : "The guard confronts you.", choices: [window.checkResult ? {text: "Search the armory", nextSection: 187, skillCheck: false} : {text: "Fight the guard", nextSection: 71, skillCheck: false}]};
        storySections[129] = {text: "'Yeah, just got assigned today,' you say. The guard nods. 'Welcome to Bloodstone. Don't touch the red stones - they're cursed.'", choices: [{text: "Ask about the red stones", nextSection: 188, skillCheck: false}, {text: "Thank him and leave", nextSection: 63, skillCheck: false}]};
        storySections[130] = {text: window.checkResult ? "The guard, feeling chatty, tells you about weak points in the Keep's defenses and a little-used exit." : "The guard becomes suspicious. 'Why do you want to know that?'", choices: [window.checkResult ? {text: "Thank him and use the information", nextSection: 200, skillCheck: false} : {text: "Make an excuse and leave", nextSection: 63, skillCheck: false}]};
        storySections[131] = {text: "'The postern gate is rarely guarded after dark,' the stable hand whispers. 'And the old escape tunnel in the east wall is collapsed but passable if you're careful.'", choices: [{text: "Thank him and use this information", nextSection: 200, skillCheck: false}, {text: "Threaten him for more information", nextSection: 133, skillCheck: false}]};
        storySections[132] = {text: "The stable hand draws a crude map in the dirt showing the Keep's layout and the quickest route to the far wall.", choices: [{text: "Memorize the route and go", nextSection: 200, skillCheck: false}], action: function() { keepConditions.hasMap = true; }};
        storySections[133] = {text: "You threaten the stable hand. Terrified, he tells you everything he knows about secret passages and guard schedules.", choices: [{text: "Use his information to escape", nextSection: 200, skillCheck: false}], action: function() { keepConditions.hasMap = true; }};
        storySections[134] = {text: "You take the items from the saddlebag.", choices: [{text: "Leave the stables", nextSection: 189, skillCheck: false}], action: function() { gameState.gold += 25; gameState.inventory.push("Lockpicks", "Healing Poultice"); updateStatsDisplay(); updateInventoryDisplay(); }};
        storySections[135] = {text: "The guards search the stables but don't find you. After they leave, you emerge.", choices: [{text: "Look for an exit", nextSection: 190, skillCheck: false}]};
        storySections[136] = {text: "You slip out while the guards search another area and make your way toward the Keep's far wall.", choices: [{text: "Continue to the exit", nextSection: 200, skillCheck: false}]};
        storySections[137] = {text: "You find a side entrance used by servants, less guarded than the main gate.", choices: [{text: "Use the servant's entrance", nextSection: 191, skillCheck: false}]};
        storySections[138] = {text: "Watching the guards, you notice a pattern. There's a 10-minute window when the path to the far wall is unguarded!", choices: [{text: "Wait for the window and make your move", nextSection: 200, skillCheck: false}]};
        storySections[139] = {text: "Tasting the liquid, you feel a surge of power but also a dark craving. Your Skill increases but your Luck decreases.", choices: [{text: "Continue", nextSection: 192, skillCheck: false}], action: function() { gameState.skill += 2; gameState.luck -= 1; updateStatsDisplay(); }};
        storySections[140] = {text: "You wipe the liquid off quickly. Your finger tingles for hours afterward.", choices: [{text: "Leave the altar", nextSection: 41, skillCheck: false}]};
        storySections[141] = {text: window.checkResult ? "The knowledge might be useful later." : "The symbols give you a headache.", choices: [{text: "Leave the altar", nextSection: 41, skillCheck: false}]};
        storySections[142] = {text: "The basement is filled with storage crates. A staircase leads up into the Keep.", choices: [{text: "Climb the stairs", nextSection: 193, skillCheck: false}]};
        storySections[143] = {text: "The wine cellar contains valuable vintages. You also find a trapdoor leading to a tunnel that goes under the Keep's walls!", choices: [{text: "Take the tunnel to escape", nextSection: 200, skillCheck: false}]};
        storySections[144] = {text: "Going up from the cellar, you enter the Keep's kitchen storage area.", choices: [{text: "Proceed into the Keep", nextSection: 194, skillCheck: false}]};
        storySections[145] = {text: "You wait in the garden until nightfall, then slip through the darkened Keep to the far wall.", choices: [{text: "Exit under cover of darkness", nextSection: 200, skillCheck: false}]};
        storySections[146] = {text: "You approach the servant. Startled, she drops her basket. 'Please don't hurt me!' she whispers.", choices: [{text: "Ask for help", nextSection: 195, skillCheck: false}, {text: "Threaten her for information", nextSection: 196, skillCheck: false}]};
        storySections[147] = {text: "You sneak toward the kitchen while the servant is distracted.", choices: [{text: "Enter the kitchen", nextSection: 52, skillCheck: false}]};
        storySections[148] = {text: "You wait until a servant exits with trash, then slip inside while the door is open.", choices: [{text: "Enter the kitchen", nextSection: 52, skillCheck: false}]};
        storySections[149] = {text: window.checkResult ? "You emerge in a washroom. From here, you can navigate to the Keep's exit." : "You fail to climb and must try another way.", choices: [window.checkResult ? {text: "Make your way to the exit", nextSection: 200, skillCheck: false} : {text: "Try another approach", nextSection: 82, skillCheck: false}]};
        storySections[150] = {text: "The cellar contains food stores. You also find a map showing servant passages through the Keep.", choices: [{text: "Take the map and use the passages", nextSection: 200, skillCheck: false}], action: function() { keepConditions.hasMap = true; }};
        storySections[151] = {text: "Exiting the closet, you find yourself in a hallway on an upper level of the Keep.", choices: [{text: "Explore", nextSection: 197, skillCheck: false}]};
        storySections[152] = {text: "You decide to try a different approach.", choices: [{text: "Go back", nextSection: 46, skillCheck: false}]};
        storySections[153] = {text: "Watching the Great Hall, you see the Keep's captain giving orders. You learn about guard changes and weak points in the defenses.", choices: [{text: "Use this knowledge to plan your escape", nextSection: 200, skillCheck: false}]};
        storySections[154] = {text: "The passage continues and eventually leads to a hidden exit behind a tapestry in a lesser-used corridor.", choices: [{text: "Take the hidden exit", nextSection: 200, skillCheck: false}]};
        storySections[155] = {text: "The trapdoor opens into a storage room. From here, you can reach the Keep's outer wall.", choices: [{text: "Make for the outer wall", nextSection: 200, skillCheck: false}]};
        storySections[156] = {text: "The chest contains 200 Gold, a magical amulet, and a key that unlocks a secret gate in the outer wall!", choices: [{text: "Take the treasure and use the key to escape", nextSection: 200, skillCheck: false}], action: function() { gameState.gold += 200; gameState.inventory.push("Magical Amulet", "Secret Gate Key"); updateStatsDisplay(); updateInventoryDisplay(); }};
        storySections[157] = {text: "You leave the chest and continue. The passage eventually leads to a hidden door that opens near the Keep's exit.", choices: [{text: "Take the hidden door to the exit", nextSection: 200, skillCheck: false}]};
        storySections[158] = {text: "Better equipped, you feel more confident navigating the Keep.", choices: [{text: "Continue exploring", nextSection: 26, skillCheck: false}]};
        storySections[159] = {text: "With supplies replenished, you continue through the Keep.", choices: [{text: "Leave the storage room", nextSection: 26, skillCheck: false}]};
        storySections[160] = {text: "Carrying the tray, you pass through several rooms unchallenged. Eventually, you reach an area near the Keep's outer wall.", choices: [{text: "Drop the tray and make for the exit", nextSection: 200, skillCheck: false}]};
        storySections[161] = {text: "You put the tray down and slip out of the kitchen into a corridor.", choices: [{text: "Explore the corridor", nextSection: 198, skillCheck: false}]};
        storySections[162] = {text: "Following the cook's directions, you find the servants' hall and from there, a route to the Keep's less guarded areas.", choices: [{text: "Follow the route to the exit", nextSection: 200, skillCheck: false}]};
        storySections[163] = {text: window.checkResult ? "You successfully navigate the kitchen." : "You cause a commotion and must flee.", choices: [window.checkResult ? {text: "Continue through the Keep", nextSection: 199, skillCheck: false} : {text: "Flee the kitchen", nextSection: 161, skillCheck: false}]};
        storySections[164] = {text: "Listening at the door, you hear two nobles arguing about the Keep's defenses. You learn about a secret passage to the outside.", choices: [{text: "Use this information to find the secret passage", nextSection: 200, skillCheck: false}]};
        storySections[165] = {text: "The door opens to a study. On the desk is a map showing patrol routes and a little-used exit.", choices: [{text: "Take the map and use the exit", nextSection: 200, skillCheck: false}], action: function() { keepConditions.hasMap = true; }};
        storySections[166] = {text: "The door is locked. It might contain something valuable, but you don't have a key.", choices: [{text: "Try another door", nextSection: 98, skillCheck: false}]};
        storySections[167] = {text: "The room is a small chapel with an altar to a dark god. Behind the altar is a hidden panel leading to a tunnel out!", choices: [{text: "Take the tunnel to escape", nextSection: 200, skillCheck: false}]};
        storySections[168] = {text: "You find keys hanging on a hook. With them, you could free prisoners or unlock doors.", choices: [{text: "Take the keys", nextSection: 201, skillCheck: false}], action: function() { gameState.inventory.push("Dungeon Keys"); updateInventoryDisplay(); }};
        storySections[169] = {text: "One prisoner whispers: 'The east wall has a weak spot where the stones are crumbling. You can squeeze through at night when the guard changes.'", choices: [{text: "Thank the prisoner and use this information", nextSection: 200, skillCheck: false}]};
        storySections[170] = {text: "Your servant disguise works well. You're able to move through the Keep and reach the far wall.", choices: [{text: "Exit the Keep", nextSection: 200, skillCheck: false}]};
        storySections[171] = {text: "From the upper corridor, you find a route to the Keep's outer defenses.", choices: [{text: "Take the route to the exit", nextSection: 200, skillCheck: false}]};
        storySections[172] = {text: "The hallway leads to a staircase going down. Taking it, you eventually reach an area near the Keep's exit.", choices: [{text: "Make for the exit", nextSection: 200, skillCheck: false}]};
        storySections[173] = {text: "Descending the tower stairs, you reach ground level near the Keep's outer wall.", choices: [{text: "Find a way through the wall", nextSection: 200, skillCheck: false}]};
        storySections[174] = {text: "The patrol spots you! You must fight or flee.", choices: [{text: "Fight the patrol", nextSection: 202, skillCheck: false}, {text: "Flee toward the exit", nextSection: 203, skillCheck: false}]};
        storySections[175] = {text: "You quickly get off the throne, shaken by the experience but feeling stronger.", choices: [{text: "Leave the Great Hall", nextSection: 66, skillCheck: false}]};
        storySections[176] = {text: "The secret passage leads through the walls and emerges outside the Keep!", choices: [{text: "Take the passage to escape", nextSection: 200, skillCheck: false}]};
        storySections[177] = {text: "In the library, you find historical records that mention a collapsed tunnel in the east wall that can still be navigated.", choices: [{text: "Find and use the collapsed tunnel", nextSection: 200, skillCheck: false}]};
        storySections[178] = {text: "The armory has excellent equipment, but more importantly, you find a guard's journal mentioning a postern gate that's often left unbarred.", choices: [{text: "Find and use the postern gate", nextSection: 200, skillCheck: false}]};
        storySections[179] = {text: "With your map and keys, you navigate to the Keep's far side and find an exit.", choices: [{text: "Exit the Keep", nextSection: 200, skillCheck: false}]};
        storySections[180] = {text: "Having avoided the search, you make your way to the Keep's perimeter and find a way out.", choices: [{text: "Exit the Keep", nextSection: 200, skillCheck: false}]};
        storySections[181] = {text: "Lost in the corridors, you eventually stumble upon a little-used gate in the outer wall.", choices: [{text: "Use the gate to exit", nextSection: 200, skillCheck: false}]};
        storySections[182] = {text: "In the lord's chambers, you find a secret escape route designed for the Keep's ruler in case of siege.", choices: [{text: "Use the lord's escape route", nextSection: 200, skillCheck: false}]};
        storySections[183] = {text: "The chapel has a hidden door behind the altar that leads to a tunnel under the walls.", choices: [{text: "Take the tunnel to escape", nextSection: 200, skillCheck: false}]};
        storySections[184] = {text: "Through the kitchen areas, you find a delivery exit that leads outside.", choices: [{text: "Use the delivery exit", nextSection: 200, skillCheck: false}]};
        storySections[185] = {text: "In the cellars, you find an old escape tunnel dug during a long-ago siege.", choices: [{text: "Take the escape tunnel", nextSection: 200, skillCheck: false}]};
        storySections[186] = {text: "Armed with the Bloodstone Blade and Captain's Armor, you fight your way to the Keep's exit.", choices: [{text: "Fight through to the exit", nextSection: 200, skillCheck: false}]};
        storySections[187] = {text: "The armory has good weapons and armor. You also find a map showing guard posts and patrol gaps.", choices: [{text: "Use the map to find a safe exit", nextSection: 200, skillCheck: false}], action: function() { keepConditions.hasMap = true; }};
        storySections[188] = {text: "'The red stones are what give the Keep its name,' the guard explains. 'They drink blood and give power. Stay away from them.'", choices: [{text: "Thank him and leave", nextSection: 63, skillCheck: false}]};
        storySections[189] = {text: "With new supplies, you leave the stables and look for an exit.", choices: [{text: "Search for a way out", nextSection: 190, skillCheck: false}]};
        storySections[190] = {text: "Using your wits and the items you've gathered, you find a way through the Keep's defenses to the outside.", choices: [{text: "Exit the Keep", nextSection: 200, skillCheck: false}]};
        storySections[191] = {text: "Through the servant's entrance, you navigate to the Keep's perimeter and find an exit.", choices: [{text: "Exit the Keep", nextSection: 200, skillCheck: false}]};
        storySections[192] = {text: "The power surge fades but leaves you changed. You continue through the sewers.", choices: [{text: "Leave the altar chamber", nextSection: 41, skillCheck: false}]};
        storySections[193] = {text: "From the basement, you find a route to the Keep's outer wall and an exit.", choices: [{text: "Take the route to the exit", nextSection: 200, skillCheck: false}]};
        storySections[194] = {text: "From the kitchen storage, you make your way through the Keep to an exit.", choices: [{text: "Find and use an exit", nextSection: 200, skillCheck: false}]};
        storySections[195] = {text: "The servant, pitying you, shows you a secret way servants use to leave the Keep after hours.", choices: [{text: "Take the servant's secret way", nextSection: 200, skillCheck: false}]};
        storySections[196] = {text: "Terrified, the servant tells you about a drainage tunnel that leads outside.", choices: [{text: "Use the drainage tunnel to escape", nextSection: 200, skillCheck: false}]};
        storySections[197] = {text: "From the upper hallway, you find a route down to the Keep's exit.", choices: [{text: "Take the route to the exit", nextSection: 200, skillCheck: false}]};
        storySections[198] = {text: "The corridor leads to the Keep's less guarded areas and eventually to an exit.", choices: [{text: "Find and use an exit", nextSection: 200, skillCheck: false}]};
        storySections[199] = {text: "Past the kitchen, you find a route to the Keep's outer defenses.", choices: [{text: "Take the route to the exit", nextSection: 200, skillCheck: false}]};
        storySections[201] = {text: "With the dungeon keys, you could free prisoners or explore locked areas.", choices: [{text: "Free the prisoners", nextSection: 204, skillCheck: false}, {text: "Explore locked doors", nextSection: 205, skillCheck: false}]};
        storySections[202] = {text: "You face the guard patrol in combat!", choices: [{text: "Roll for attack", nextSection: 206, skillCheck: false}], action: function() { return startCombat("Guard Patrol", 20, 12, 207); }};
        storySections[203] = {text: "You flee toward the exit with the patrol in pursuit!", choices: [{text: "Try to lose them", nextSection: 208, skillCheck: true, checkType: 'luck', difficulty: 13}]};
        storySections[204] = {text: "Freeing the prisoners causes a distraction! In the chaos, you slip out of the Keep.", choices: [{text: "Use the distraction to escape", nextSection: 200, skillCheck: false}]};
        storySections[205] = {text: "Using the keys, you unlock a door that leads to a secret passage out of the Keep.", choices: [{text: "Take the secret passage to escape", nextSection: 200, skillCheck: false}]};
        storySections[206] = {text: "", choices: [{text: "Continue", nextSection: 207, skillCheck: false}]};
        storySections[207] = {text: "After a fierce battle, you defeat the patrol and make your way to the Keep's exit.", choices: [{text: "Exit the Keep", nextSection: 200, skillCheck: false}]};
        storySections[208] = {text: window.checkResult ? "You lose the patrol in the Keep's maze-like corridors and find an exit." : "The patrol corners you!", choices: [window.checkResult ? {text: "Exit the Keep", nextSection: 200, skillCheck: false} : {text: "Fight the patrol", nextSection: 202, skillCheck: false}]};
        
        // Initialize game
        function initGame() {
            updateStatsDisplay();
            updateInventoryDisplay();
            
            // If we have a current section from saved game, load it
            if (gameState.currentSection > 0) {
                loadSection(gameState.currentSection);
            } else {
                loadSection(0);
            }
        }
        
        // Show warning dialog for new game
        function showNewGameWarning() {
            // Show warning dialog
            document.getElementById('screen-game').classList.remove('active-screen');
            document.getElementById('warning-dialog').classList.add('active-screen');
        }
        
        // Cancel new game and return to game screen
        function cancelNewGame() {
            document.getElementById('warning-dialog').classList.remove('active-screen');
            document.getElementById('screen-game').classList.add('active-screen');
        }
        
        // Start new game - reset everything
        function startNewGame() {
            // Clear all saved game data
            localStorage.removeItem('dreadwoodGameState');
            
            // Reset game state to completely empty
            gameState = {
                playerClass: '',
                skill: 0,
                maxStamina: 0,
                stamina: 0,
                luck: 0,
                gold: 0,
                inventory: [],
                weapons: [],
                armor: [],
                currentSection: 0,
                gameComplete: false
            };
            
            // Redirect to level1.html to start fresh
            window.location.href = 'level1.html';
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-skill').textContent = gameState.skill;
            document.getElementById('stat-stamina').textContent = gameState.stamina;
            document.getElementById('stat-maxstamina').textContent = gameState.maxStamina;
            document.getElementById('stat-luck').textContent = gameState.luck;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Show current weapon
            if (gameState.weapons && gameState.weapons.length > 0) {
                const weapon = gameState.weapons[gameState.weapons.length - 1];
                inventoryDiv.innerHTML += `<span class="inventory-item">${weapon.name} (${weapon.damage})</span>`;
            }
            
            // Show armor
            if (gameState.armor && gameState.armor.length > 0) {
                const armor = gameState.armor[gameState.armor.length - 1];
                inventoryDiv.innerHTML += `<span class="inventory-item">${armor.name} (${armor.defense} DEF)</span>`;
            }
            
            // Show gold
            inventoryDiv.innerHTML += `<span class="inventory-item">${gameState.gold} Gold</span>`;
            
            // Show other inventory items
            if (gameState.inventory) {
                gameState.inventory.forEach(item => {
                    if (item !== 'Dagger' && item !== 'Leather Armor') {
                        inventoryDiv.innerHTML += `<span class="inventory-item">${item}</span>`;
                    }
                });
            }
        }
        
        // Load story section
        function loadSection(sectionId) {
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                // If section doesn't exist yet, show a placeholder
                document.getElementById('story-text').innerHTML = "<p>Your adventure in Bloodstone Keep continues... More content will be added in future updates!</p>";
                document.getElementById('choice-buttons').innerHTML = `
                    <button class="choice-btn" onclick="loadSection(0)">Return to Keep Entrance</button>
                `;
                return;
            }
            
            let storyText = section.text;
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p>";
            
            // Clear and add choice buttons
            const choiceButtons = document.getElementById('choice-buttons');
            choiceButtons.innerHTML = '';
            
            section.choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = choice.text;
                button.onclick = function() {
                    if (choice.skillCheck) {
                        performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                    } else {
                        loadSection(choice.nextSection);
                    }
                };
                choiceButtons.appendChild(button);
            });
            
            // Save game progress
            saveGame();
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            const diceRoll = rollDiceHelper(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Start combat
        function startCombat(enemyName, enemyStamina, enemySkill, nextSection) {
            const playerAttack = rollDiceHelper(2, 6) + gameState.skill;
            const enemyAttack = rollDiceHelper(2, 6) + enemySkill;
            
            let resultText = `<span class="enemy">BATTLE: ${enemyName}</span> (Skill: ${enemySkill}, Stamina: ${enemyStamina})<br>`;
            resultText += `You attack with ${playerAttack} vs enemy's ${enemyAttack}.<br>`;
            
            if (playerAttack > enemyAttack) {
                // Calculate damage based on current weapon
                let damage = 0;
                if (gameState.weapons && gameState.weapons.length > 0) {
                    const weapon = gameState.weapons[gameState.weapons.length - 1];
                    if (weapon.damage === '1d6') damage = rollDiceHelper(1, 6);
                    else if (weapon.damage === '1d6+1') damage = rollDiceHelper(1, 6) + 1;
                    else if (weapon.damage === '2d4') damage = rollDiceHelper(2, 4);
                    else if (weapon.damage === '2d6') damage = rollDiceHelper(2, 6);
                    else if (weapon.damage === '3d4') damage = rollDiceHelper(3, 4);
                    else if (weapon.damage === '3d6') damage = rollDiceHelper(3, 6);
                    else damage = rollDiceHelper(1, 6); // Default
                } else {
                    damage = rollDiceHelper(1, 6);
                }
                
                resultText += `<span class="success">You hit for ${damage} damage!</span>`;
                
                if (enemyStamina - damage <= 0) {
                    resultText += `<br><span class="success">You defeated the ${enemyName}!</span>`;
                    // Player gets some gold for victory
                    const goldReward = Math.floor(Math.random() * 50) + 20;
                    gameState.gold += goldReward;
                    resultText += `<br>You find ${goldReward} Gold on the body.`;
                } else {
                    enemyStamina -= damage;
                    resultText += `<br>The ${enemyName} has ${enemyStamina} Stamina remaining.`;
                    // Enemy counterattacks
                    const enemyDamage = rollDiceHelper(1, 6);
                    gameState.stamina -= enemyDamage;
                    resultText += `<br><span class="damage">The ${enemyName} hits back for ${enemyDamage} damage!</span>`;
                }
            } else if (playerAttack < enemyAttack) {
                const damage = rollDiceHelper(1, 6);
                gameState.stamina -= damage;
                resultText += `<span class="damage">You are hit for ${damage} damage!</span>`;
            } else {
                resultText += "The attacks cancel each other out!";
            }
            
            updateStatsDisplay();
            
            // Check if player died
            if (gameState.stamina <= 0) {
                resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                // Reset game after delay
                setTimeout(() => {
                    localStorage.removeItem('dreadwoodGameState');
                    location.reload();
                }, 3000);
            }
            
            // Store combat result in appropriate section
            if (storySections[nextSection]) {
                storySections[nextSection].text = resultText;
            }
            
            return resultText;
        }
        
        // Use Luck
        function useLuck() {
            if (gameState.luck <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Luck left!</div>`;
                return;
            }
            
            const diceRoll = rollDiceHelper(2, 6);
            const success = diceRoll <= gameState.luck;
            
            gameState.luck -= 1;
            updateStatsDisplay();
            
            let resultText = `You test your Luck... Roll: ${diceRoll}, Luck: ${gameState.luck + 1}. `;
            resultText += success ? 
                `<span class="success">Lucky!</span> Something good happens.` : 
                `<span class="damage">Unlucky!</span> Something bad happens.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            // Apply Luck effect
            if (success) {
                // Good effect
                const goodEffects = [
                    "You find 50 Gold in a forgotten niche!",
                    "A guard patrol passes by without noticing you!",
                    "You discover a hidden passage that shortcuts to the Keep's exit!",
                    "You find a healing potion in an abandoned room!",
                    "A friendly servant gives you directions to a secret exit!"
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Gold")) {
                    gameState.gold += 50;
                    updateStatsDisplay();
                } else if (effect.includes("potion")) {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 6);
                    updateStatsDisplay();
                } else if (effect.includes("passage") || effect.includes("directions")) {
                    // Shortcut to victory
                    setTimeout(() => {
                        loadSection(200);
                    }, 1000);
                }
            } else {
                // Bad effect
                const badEffects = [
                    "You trigger a trap! Take 4 damage.",
                    "You're spotted by a guard patrol!",
                    "You get lost in identical corridors!",
                    "You accidentally alert the guards to your presence!",
                    "Your gold purse tears, losing 30 Gold!"
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.stamina -= 4;
                    if (gameState.stamina <= 0) {
                        document.getElementById('story-text').innerHTML += `<div class="game-over">You have been defeated! Game Over.</div>`;
                        setTimeout(() => {
                            localStorage.removeItem('dreadwoodGameState');
                            location.reload();
                        }, 3000);
                    }
                    updateStatsDisplay();
                } else if (effect.includes("Gold")) {
                    gameState.gold = Math.max(0, gameState.gold - 30);
                    updateStatsDisplay();
                } else if (effect.includes("spotted") || effect.includes("alert")) {
                    // Trigger combat with guards
                    setTimeout(() => {
                        startCombat("Alerted Guards", 15, 10, 207);
                    }, 1000);
                } else if (effect.includes("lost")) {
                    // Return to a random earlier section
                    const lostSections = [0, 1, 2, 3];
                    const randomSection = lostSections[Math.floor(Math.random() * lostSections.length)];
                    setTimeout(() => {
                        loadSection(randomSection);
                    }, 1000);
                }
            }
            
            updateInventoryDisplay();
        }
        
        // Check inventory
        function checkInventory() {
            let inventoryText = "<h3>Your Inventory:</h3>";
            
            if (gameState.weapons && gameState.weapons.length > 0) {
                const weapon = gameState.weapons[gameState.weapons.length - 1];
                inventoryText += `<p><strong>Weapon:</strong> ${weapon.name} (${weapon.damage} damage)</p>`;
            }
            
            if (gameState.armor && gameState.armor.length > 0) {
                const armor = gameState.armor[gameState.armor.length - 1];
                inventoryText += `<p><strong>Armor:</strong> ${armor.name} (${armor.defense} DEF)</p>`;
            }
            
            inventoryText += `<p><strong>Gold:</strong> ${gameState.gold}</p>`;
            
            if (gameState.inventory && gameState.inventory.length > 0) {
                inventoryText += `<p><strong>Other Items:</strong> `;
                const otherItems = gameState.inventory.filter(item => 
                    item !== 'Dagger' && item !== 'Leather Armor' && 
                    !gameState.weapons.some(w => w.name === item) &&
                    !gameState.armor.some(a => a.name === item)
                );
                inventoryText += otherItems.join(', ') || 'None';
                inventoryText += `</p>`;
            }
            
            // Show keep conditions
            inventoryText += `<p><strong>Keep Knowledge:</strong> `;
            const conditions = [];
            if (keepConditions.hasMap) conditions.push("Has Map");
            if (keepConditions.foundSecretPassage) conditions.push("Found Secret Passage");
            if (keepConditions.disguised) conditions.push("Disguised");
            if (keepConditions.allianceMade) conditions.push("Has Ally");
            if (keepConditions.bloodstoneActivated) conditions.push("Bloodstone Power");
            inventoryText += conditions.join(', ') || 'None';
            inventoryText += `</p>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${inventoryText}</div>`;
        }
        
        // Save game
        function saveGame() {
            // Save both game state and keep conditions
            const saveData = {
                ...gameState,
                keepConditions: keepConditions
            };
            localStorage.setItem('dreadwoodGameState', JSON.stringify(saveData));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">Game saved!</div>`;
        }
        
        // Go to next level
        function goToNextLevel() {
            // Save game state for level 5
            const saveData = {
                ...gameState,
                keepConditions: keepConditions
            };
            localStorage.setItem('dreadwoodGameState', JSON.stringify(saveData));
            // In a complete game, this would redirect to level5.html
            // For now, we'll just show a message since level5 doesn't exist yet
            alert("Level 5: Ashen Wastes coming soon! Your game has been saved.");
            // Uncomment when level5.html exists:
            // window.location.href = 'level5.html';
        }
        
        // Utility function to roll dice
        function rollDiceHelper(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = function() {
            // Load keep conditions from saved game if they exist
            const savedGame = JSON.parse(localStorage.getItem('dreadwoodGameState'));
            if (savedGame && savedGame.keepConditions) {
                keepConditions = savedGame.keepConditions;
            }
            
            initGame();
        };
    </script>
</body>
</html>
