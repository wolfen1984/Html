<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DreadWood: Bloodstone Keep</title>
    <style>
        /* EXACT SAME STYLE as previous levels */
        body {
            font-family: 'Courier New', monospace;
            background-color: #0a0a2a;
            color: #33ff33;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            border: 2px solid #33ff33;
            background-color: #000;
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #33ff33;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #ff33ff;
            text-shadow: 0 0 5px #ff33ff;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
        }
        
        h2 {
            color: #33ccff;
            border-bottom: 1px solid #33ccff;
            padding-bottom: 5px;
            margin-top: 25px;
        }
        
        .screen {
            display: none;
        }
        
        .active-screen {
            display: block;
        }
        
        .stats-bar {
            background-color: #111133;
            border: 1px solid #33ff33;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-value {
            color: #ffff33;
            font-weight: bold;
        }
        
        .inventory {
            background-color: #111122;
            border: 1px solid #ff33ff;
            padding: 10px;
            margin: 15px 0;
            min-height: 60px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222244;
            border: 1px solid #33ccff;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
        }
        
        .story-text {
            background-color: #111111;
            border: 1px solid #33ff33;
            padding: 15px;
            margin: 20px 0;
            min-height: 150px;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222244;
            color: #33ff33;
            border: 2px solid #33ff33;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333366;
            color: #ffff33;
            border-color: #ffff33;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #330033;
            color: #ff33ff;
            border: 2px solid #ff33ff;
            padding: 10px 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #550055;
            color: #ff99ff;
        }
        
        .dice-roll {
            background-color: #223322;
            border: 1px solid #33ff33;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ffff33;
        }
        
        .game-over {
            color: #ff3333;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #ff3333;
        }
        
        .success {
            color: #33ff33;
            font-weight: bold;
        }
        
        .damage {
            color: #ff3333;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9933;
            font-weight: bold;
        }
        
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #003333;
            color: #33ff99;
            border: 2px solid #33ff99;
            padding: 15px 30px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #005555;
            color: #99ffcc;
        }
        
        .retro-notice {
            text-align: center;
            color: #888888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333333;
            padding-top: 10px;
        }
        
        .warning-dialog {
            background-color: #332222;
            border: 2px solid #ff3333;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .warning-text {
            color: #ff9933;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .dialog-btn {
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid;
        }
        
        .dialog-btn-yes {
            background-color: #223322;
            color: #33ff33;
            border-color: #33ff33;
        }
        
        .dialog-btn-no {
            background-color: #332222;
            color: #ff3333;
            border-color: #ff3333;
        }
        
        .bloodstone-decoration {
            color: #cc3333;
            font-style: italic;
            text-shadow: 0 0 3px #cc3333;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 10px;
                font-size: 14px;
            }
            
            .dialog-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DREADWOOD</h1>
            <h2>BLOODSTONE KEEP</h2>
            <div class="retro-notice">Level 4 - Your Adventure Continues</div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item">SKILL: <span id="stat-skill" class="stat-value">0</span></div>
                <div class="stat-item">STAMINA: <span id="stat-stamina" class="stat-value">0</span>/<span id="stat-maxstamina" class="stat-value">0</span></div>
                <div class="stat-item">LUCK: <span id="stat-luck" class="stat-value">0</span></div>
                <div class="stat-item">GOLD: <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <h2>INVENTORY</h2>
            <div class="inventory" id="inventory">
                <!-- Inventory will be loaded from saved game -->
            </div>
            
            <h2>THE ADVENTURE</h2>
            <div class="story-text" id="story-text">
                <p>Before you looms <span class="bloodstone-decoration">BLOODSTONE KEEP</span>, a fortress of dark stone that seems to bleed crimson in the fading light. The air is cold and carries the scent of iron and decay. Massive walls rise before you, their surfaces streaked with what looks like dried blood. Your journey into this haunted fortress begins now...</p>
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <button class="choice-btn" onclick="loadSection(1)">Approach the main gates</button>
                <button class="choice-btn" onclick="loadSection(2)">Look for a hidden entrance</button>
                <button class="choice-btn" onclick="loadSection(3)">Scale the outer walls</button>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useLuck()">TEST LUCK</button>
                <button class="action-btn" onclick="checkInventory()">INVENTORY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="showNewGameWarning()">START NEW GAME</button>
            </div>
        </div>
        
        <!-- Warning Dialog for New Game -->
        <div id="warning-dialog" class="screen">
            <div class="warning-dialog">
                <div class="warning-text">WARNING: Starting a new game will delete ALL your current progress!</div>
                <p>Your current character, stats, inventory, and gold will be permanently erased.</p>
                <p>You will return to the beginning of the game to create a new character.</p>
                <div class="dialog-buttons">
                    <button class="dialog-btn dialog-btn-yes" onclick="startNewGame()">YES, START NEW GAME</button>
                    <button class="dialog-btn dialog-btn-no" onclick="cancelNewGame()">NO, KEEP MY CHARACTER</button>
                </div>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>VICTORY!</h2>
            <div class="story-text">
                <p>You have conquered <span class="bloodstone-decoration">BLOODSTONE KEEP</span>!</p>
                <p>After navigating the haunted corridors and defeating the keep's sinister guardians, you emerge from the fortress's rear gates. Before you stretches the desolate <span class="enemy">ASHEN WASTES</span>, a barren landscape of volcanic rock and perpetual dust storms.</p>
                <p>Your journey continues... All your stats, gold, and inventory will carry over to the next chapter.</p>
                <div class="stats-bar">
                    <div class="stat-item">SKILL: <span id="next-stat-skill" class="stat-value">0</span></div>
                    <div class="stat-item">STAMINA: <span id="next-stat-stamina" class="stat-value">0</span></div>
                    <div class="stat-item">LUCK: <span id="next-stat-luck" class="stat-value">0</span></div>
                    <div class="stat-item">GOLD: <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO ASHEN WASTES</button>
            </div>
        </div>
        
        <div class="retro-notice">
            DREADWOOD - A Retro Gamebook Adventure<br>
            Level 4: Bloodstone Keep
        </div>
    </div>

    <script>
        // Game state (loaded from localStorage)
        let gameState = JSON.parse(localStorage.getItem('dreadwoodGameState')) || {
            playerClass: 'warrior',
            skill: 10,
            maxStamina: 18,
            stamina: 18,
            luck: 10,
            gold: 20,
            inventory: ['Dagger', 'Leather Armor'],
            weapons: [{name: 'Dagger', damage: '1d6'}],
            armor: [{name: 'Leather Armor', defense: 1}],
            currentWeaponIndex: 0,
            currentArmorIndex: 0,
            currentSection: 0,
            gameComplete: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyStamina: 0,
            enemyCurrentStamina: 0,
            enemySkill: 0,
            nextSection: 0,
            round: 1
        };
        
        // Reset currentSection when starting a new level
        if (gameState.currentSection === 200 || gameState.gameComplete) {
            gameState.currentSection = 0;
            gameState.gameComplete = false;
        }
        
        // Ensure indices exist
        if (gameState.currentWeaponIndex === undefined) {
            gameState.currentWeaponIndex = gameState.weapons.length - 1;
        }
        if (gameState.currentArmorIndex === undefined) {
            gameState.currentArmorIndex = gameState.armor.length - 1;
        }
        
        // Level 4 story sections - BLOODSTONE KEEP (COMPLETE)
        const storySections = {
            0: {
                text: "Before you looms <span class='bloodstone-decoration'>BLOODSTONE KEEP</span>, a fortress of dark stone that seems to bleed crimson in the fading light. The air is cold and carries the scent of iron and decay. Massive walls rise before you, their surfaces streaked with what looks like dried blood. Your journey into this haunted fortress begins now...",
                choices: [
                    {text: "Approach the main gates", nextSection: 1, skillCheck: false},
                    {text: "Look for a hidden entrance", nextSection: 2, skillCheck: false},
                    {text: "Scale the outer walls", nextSection: 3, skillCheck: false}
                ]
            },
            1: {
                text: "You approach the massive iron-banded gates of Bloodstone Keep. Two stone gargoyles flank the entrance, their eyes glowing with red light. As you get closer, they shift slightly, stone grinding against stone.",
                choices: [
                    {text: "Attempt to open the gates", nextSection: 4, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Examine the gargoyles", nextSection: 5, skillCheck: false},
                    {text: "Look for another way in", nextSection: 2, skillCheck: false}
                ]
            },
            2: {
                text: "You circle around the keep, looking for a less obvious entrance. You find a drainage grate partially hidden by overgrown weeds. It's rusted but might be forced open.",
                choices: [
                    {text: "Try to force the grate open", nextSection: 6, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Listen at the grate first", nextSection: 7, skillCheck: false},
                    {text: "Return to the main gates", nextSection: 1, skillCheck: false}
                ]
            },
            3: {
                text: "You examine the outer walls. The stone is rough and offers some handholds, but it's a dangerous climb. You notice strange crimson veins pulsing within the stone itself.",
                choices: [
                    {text: "Attempt to climb the wall", nextSection: 8, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Search for better climbing spot", nextSection: 9, skillCheck: false},
                    {text: "Abandon climbing attempt", nextSection: 1, skillCheck: false}
                ]
            },
            4: {
                text: window.checkResult ? 
                    "You manage to push the heavy gates open just enough to slip through. The gargoyles watch but don't attack. You're inside the keep's outer courtyard." : 
                    "The gates won't budge! As you strain against them, the gargoyles animate and attack!",
                choices: [
                    window.checkResult ? 
                        {text: "Enter the courtyard", nextSection: 10, skillCheck: false} :
                        {text: "Fight the gargoyles", nextSection: 401, skillCheck: false}
                ]
            },
            401: {
                text: "The stone gargoyles come to life! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 402, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Stone Gargoyles";
                    combatState.enemyStamina = 16;
                    combatState.enemyCurrentStamina = 16;
                    combatState.enemySkill = 9;
                    combatState.nextSection = 11;
                    combatState.round = 1;
                    
                    return "Stone Gargoyles: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            5: {
                text: "You examine the gargoyles closely. They're intricately carved from bloodstone. You notice a small inscription at the base: 'Only the blood of the worthy may enter.'",
                choices: [
                    {text: "Cut your hand and smear blood on the gate", nextSection: 12, skillCheck: false},
                    {text: "Try to find another way", nextSection: 2, skillCheck: false},
                    {text: "Attempt to open the gates anyway", nextSection: 4, skillCheck: true, checkType: 'skill', difficulty: 12}
                ]
            },
            6: {
                text: window.checkResult ? 
                    "You wrench the rusted grate open with a loud screech. The opening leads into a dark, damp tunnel." : 
                    "The grate won't budge. The noise attracts attention from inside!",
                choices: [
                    window.checkResult ? 
                        {text: "Enter the tunnel", nextSection: 13, skillCheck: false} :
                        {text: "Hide and wait", nextSection: 14, skillCheck: true, checkType: 'skill', difficulty: 11}
                ]
            },
            7: {
                text: "You listen at the grate and hear dripping water and distant, echoing footsteps. Something is moving in the tunnels below.",
                choices: [
                    {text: "Force the grate open anyway", nextSection: 6, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Look for another entrance", nextSection: 15, skillCheck: false}
                ]
            },
            8: {
                text: window.checkResult ? 
                    "You skillfully climb the wall, finding handholds in the rough stone. You reach the top and drop into a deserted section of the battlements." : 
                    "You slip halfway up! You fall and take 6 damage, landing in a heap at the base of the wall.",
                choices: [
                    window.checkResult ? 
                        {text: "Explore the battlements", nextSection: 16, skillCheck: false} :
                        {text: "Try another approach", nextSection: 17, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult) {
                        gameState.stamina -= 6;
                        updateStatsDisplay();
                    }
                }
            },
            9: {
                text: "You search for a better climbing spot and find a section where the wall has partially collapsed. It's still dangerous, but more climbable.",
                choices: [
                    {text: "Climb the collapsed section", nextSection: 18, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Return to the front", nextSection: 1, skillCheck: false}
                ]
            },
            10: {
                text: "You're in the outer courtyard. The ground is paved with bloodstone slabs. To your left is a guard tower, straight ahead the main keep doors, and to your right a stables that looks abandoned.",
                choices: [
                    {text: "Approach the main keep doors", nextSection: 19, skillCheck: false},
                    {text: "Investigate the guard tower", nextSection: 20, skillCheck: false},
                    {text: "Check the stables", nextSection: 21, skillCheck: false}
                ]
            },
            11: {
                text: "After defeating the gargoyles, the gates swing open on their own. Inside, you see the outer courtyard.",
                choices: [
                    {text: "Enter the courtyard", nextSection: 10, skillCheck: false}
                ]
            },
            12: {
                text: "You cut your palm and smear blood on the gate. The stone absorbs it, and the gates swing open silently. You lose 2 Stamina from the cut.",
                choices: [
                    {text: "Enter the courtyard", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina -= 2;
                    updateStatsDisplay();
                }
            },
            13: {
                text: "You crawl through the drainage tunnel. It's dark and smells of mildew. After a short distance, you emerge in a dungeon corridor. Torches flicker in wall sconces, casting dancing shadows.",
                choices: [
                    {text: "Follow the corridor left", nextSection: 22, skillCheck: false},
                    {text: "Follow the corridor right", nextSection: 23, skillCheck: false},
                    {text: "Hide and listen", nextSection: 24, skillCheck: false}
                ]
            },
            14: {
                text: window.checkResult ? 
                    "You hide as two armored guards emerge to investigate the noise. They look around, find nothing, and return inside, leaving the door slightly ajar." : 
                    "You're spotted! Two guards rush out and attack!",
                choices: [
                    window.checkResult ? 
                        {text: "Sneak in through the open door", nextSection: 25, skillCheck: false} :
                        {text: "Fight the guards", nextSection: 1401, skillCheck: false}
                ]
            },
            15: {
                text: "You find a small wooden door partially hidden behind overgrown ivy. It looks old and unused.",
                choices: [
                    {text: "Try the wooden door", nextSection: 26, skillCheck: false},
                    {text: "Return to the main gates", nextSection: 1, skillCheck: false}
                ]
            },
            16: {
                text: "You're on the battlements. The view shows the keep's layout: courtyards, towers, and the main keep building. You see a door leading inside and a staircase going down.",
                choices: [
                    {text: "Enter through the door", nextSection: 27, skillCheck: false},
                    {text: "Take the staircase down", nextSection: 28, skillCheck: false},
                    {text: "Continue along the battlements", nextSection: 29, skillCheck: false}
                ]
            },
            17: {
                text: "Bruised from your fall, you decide to try a different approach to entering the keep.",
                choices: [
                    {text: "Try the main gates", nextSection: 1, skillCheck: false},
                    {text: "Look for hidden entrance", nextSection: 2, skillCheck: false}
                ]
            },
            18: {
                text: window.checkResult ? 
                    "You climb the collapsed section and reach the top. You're on the battlements near a guard post." : 
                    "The stones shift under your weight! You fall and take 4 damage.",
                choices: [
                    window.checkResult ? 
                        {text: "Explore the battlements", nextSection: 16, skillCheck: false} :
                        {text: "Give up on climbing", nextSection: 17, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult) {
                        gameState.stamina -= 4;
                        updateStatsDisplay();
                    }
                }
            },
            19: {
                text: "The main keep doors are massive, made of dark wood banded with iron. They're slightly ajar. Through the crack, you can see a grand hall inside.",
                choices: [
                    {text: "Push the doors open and enter", nextSection: 30, skillCheck: false},
                    {text: "Listen at the doors first", nextSection: 31, skillCheck: false},
                    {text: "Look for another way in", nextSection: 32, skillCheck: false}
                ]
            },
            20: {
                text: "The guard tower door is locked, but you hear movement inside. A window on the second floor is open.",
                choices: [
                    {text: "Try to pick the lock", nextSection: 33, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Climb to the window", nextSection: 34, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Knock on the door", nextSection: 35, skillCheck: false}
                ]
            },
            21: {
                text: "The stables are abandoned but contain old equipment. In a corner, you find a skeleton in rusted armor clutching a sword. The sword still looks serviceable.",
                choices: [
                    {text: "Take the sword", nextSection: 36, skillCheck: false},
                    {text: "Search the rest of the stables", nextSection: 37, skillCheck: false},
                    {text: "Leave the stables", nextSection: 38, skillCheck: false}
                ]
            },
            22: {
                text: "You follow the corridor left. It leads to a row of prison cells. Most are empty, but one contains a ragged figure who whispers to you: 'The Bloodstone Lord feeds on pain... break the central crystal to weaken him...'",
                choices: [
                    {text: "Free the prisoner", nextSection: 39, skillCheck: false},
                    {text: "Ask more questions", nextSection: 40, skillCheck: false},
                    {text: "Continue down the corridor", nextSection: 41, skillCheck: false}
                ]
            },
            23: {
                text: "You follow the corridor right. It leads to a torture chamber with gruesome implements. A BLOODSTONE GUARDIAN stands watch over the room!",
                choices: [
                    {text: "Attack the guardian", nextSection: 2301, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 42, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Retreat back the way you came", nextSection: 13, skillCheck: false}
                ]
            },
            2301: {
                text: "You face the Bloodstone Guardian! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 2302, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Bloodstone Guardian";
                    combatState.enemyStamina = 18;
                    combatState.enemyCurrentStamina = 18;
                    combatState.enemySkill = 11;
                    combatState.nextSection = 43;
                    combatState.round = 1;
                    
                    return "Bloodstone Guardian: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            24: {
                text: "You hide in the shadows and listen. You hear distant chanting and the clank of armor. Two distinct sounds: one from the left (chanting) and one from the right (armor movement).",
                choices: [
                    {text: "Follow the chanting sound", nextSection: 44, skillCheck: false},
                    {text: "Follow the armor sound", nextSection: 45, skillCheck: false},
                    {text: "Continue down the corridor", nextSection: 46, skillCheck: false}
                ]
            },
            25: {
                text: "You sneak through the slightly open door into a storage room filled with barrels and crates. A door on the far side leads deeper into the keep.",
                choices: [
                    {text: "Search the storage room", nextSection: 47, skillCheck: false},
                    {text: "Go through the far door", nextSection: 48, skillCheck: false},
                    {text: "Hide and wait", nextSection: 49, skillCheck: false}
                ]
            },
            26: {
                text: "The wooden door is unlocked but stiff. It opens into a small chapel with stained glass windows depicting bloody battles. An altar at the front holds a glowing red crystal.",
                choices: [
                    {text: "Examine the crystal", nextSection: 50, skillCheck: false},
                    {text: "Search the chapel", nextSection: 51, skillCheck: false},
                    {text: "Leave the chapel", nextSection: 52, skillCheck: false}
                ]
            },
            27: {
                text: "The door leads to a guard room. Two off-duty guards are playing dice. They look up in surprise as you enter.",
                choices: [
                    {text: "Attack the guards", nextSection: 2701, skillCheck: false},
                    {text: "Pretend to be a new recruit", nextSection: 53, skillCheck: true, checkType: 'luck', difficulty: 12},
                    {text: "Back out slowly", nextSection: 54, skillCheck: false}
                ]
            },
            2701: {
                text: "You attack the surprised guards! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 2702, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Keep Guards";
                    combatState.enemyStamina = 14;
                    combatState.enemyCurrentStamina = 14;
                    combatState.enemySkill = 8;
                    combatState.nextSection = 55;
                    combatState.round = 1;
                    
                    return "Keep Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            28: {
                text: "The staircase spirals down into darkness. At the bottom, you find yourself in a cellar filled with wine barrels and preserved food.",
                choices: [
                    {text: "Search the cellar", nextSection: 56, skillCheck: false},
                    {text: "Find a way out of the cellar", nextSection: 57, skillCheck: false},
                    {text: "Return up the stairs", nextSection: 16, skillCheck: false}
                ]
            },
            29: {
                text: "You continue along the battlements. You come to a watchtower with a panoramic view of the keep. Inside the tower, you find a chest and a dead guard.",
                choices: [
                    {text: "Open the chest", nextSection: 58, skillCheck: false},
                    {text: "Search the guard's body", nextSection: 59, skillCheck: false},
                    {text: "Continue along battlements", nextSection: 60, skillCheck: false}
                ]
            },
            30: {
                text: "You push the doors open and enter the grand hall. Tattered banners hang from the ceiling. At the far end, on a throne of bone, sits the BLOODSTONE LORD. He looks up slowly. 'I have been expecting you,' he says in a voice like grinding stone.",
                choices: [
                    {text: "Attack the Bloodstone Lord", nextSection: 3001, skillCheck: false},
                    {text: "Try to reason with him", nextSection: 61, skillCheck: true, checkType: 'luck', difficulty: 14},
                    {text: "Look for the central crystal", nextSection: 62, skillCheck: false}
                ]
            },
            3001: {
                text: "You face the Bloodstone Lord! Prepare for the ultimate combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 3002, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "The Bloodstone Lord";
                    combatState.enemyStamina = 30;
                    combatState.enemyCurrentStamina = 30;
                    combatState.enemySkill = 14;
                    combatState.nextSection = 200; // Victory if defeated
                    combatState.round = 1;
                    
                    return "The Bloodstone Lord: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            31: {
                text: "You listen at the doors. You hear a deep voice chanting in an unknown language. The sound echoes through the hall.",
                choices: [
                    {text: "Enter the hall", nextSection: 30, skillCheck: false},
                    {text: "Look for another entrance", nextSection: 32, skillCheck: false}
                ]
            },
            32: {
                text: "You find a servants' entrance around the side of the keep. It leads to a kitchen area.",
                choices: [
                    {text: "Enter through the kitchen", nextSection: 63, skillCheck: false}
                ]
            },
            33: {
                text: window.checkResult ? 
                    "You successfully pick the lock and slip inside. The tower contains sleeping quarters and a weapons rack." : 
                    "You fail to pick the lock and make noise! The door swings open from inside, revealing an angry guard!",
                choices: [
                    window.checkResult ? 
                        {text: "Search the tower", nextSection: 64, skillCheck: false} :
                        {text: "Fight the guard", nextSection: 3301, skillCheck: false}
                ]
            },
            34: {
                text: window.checkResult ? 
                    "You climb to the window and slip inside silently. You're in the tower's upper level." : 
                    "You slip and fall! You take 5 damage and alert the guards inside!",
                choices: [
                    window.checkResult ? 
                        {text: "Search the upper level", nextSection: 65, skillCheck: false} :
                        {text: "Prepare to fight", nextSection: 3301, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult) {
                        gameState.stamina -= 5;
                        updateStatsDisplay();
                    }
                }
            },
            35: {
                text: "You knock on the door. It opens to reveal a suspicious guard. 'Who are you? No one's allowed in the tower!'",
                choices: [
                    {text: "Attack the guard", nextSection: 3301, skillCheck: false},
                    {text: "Claim to have a message", nextSection: 66, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Run away", nextSection: 67, skillCheck: false}
                ]
            },
            36: {
                text: "You take the sword from the skeleton. It's a well-made longsword that feels balanced in your hand.",
                choices: [
                    {text: "Search the rest of the stables", nextSection: 37, skillCheck: false}
                ],
                action: function() {
                    gameState.weapons.push({name: 'Longsword', damage: '2d4'});
                    updateInventoryDisplay();
                }
            },
            37: {
                text: "You search the stables and find a hidden compartment in the wall containing 50 Gold and a healing potion!",
                choices: [
                    {text: "Take the treasure", nextSection: 38, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 50;
                    gameState.inventory.push("Healing Potion");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    return "You find 50 Gold and a Healing Potion!";
                }
            },
            38: {
                text: "You leave the stables and return to the courtyard.",
                choices: [
                    {text: "Approach the main keep doors", nextSection: 19, skillCheck: false},
                    {text: "Check the guard tower", nextSection: 20, skillCheck: false}
                ]
            },
            39: {
                text: "You pick the lock on the cell. The prisoner thanks you and gives you a small bloodstone shard. 'This will weaken the guardians,' he whispers before disappearing into the shadows.",
                choices: [
                    {text: "Continue down the corridor", nextSection: 41, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Bloodstone Shard");
                    updateInventoryDisplay();
                }
            },
            40: {
                text: "'The central crystal is in the throne room,' the prisoner says. 'It's what gives the Bloodstone Lord his power. Smash it, and he'll be vulnerable.'",
                choices: [
                    {text: "Free the prisoner", nextSection: 39, skillCheck: false},
                    {text: "Continue down the corridor", nextSection: 41, skillCheck: false}
                ]
            },
            41: {
                text: "The corridor ends at a staircase leading up. You can hear voices from above.",
                choices: [
                    {text: "Climb the staircase", nextSection: 68, skillCheck: false},
                    {text: "Return to the tunnel entrance", nextSection: 13, skillCheck: false}
                ]
            },
            42: {
                text: window.checkResult ? 
                    "You successfully sneak past the Bloodstone Guardian and continue down the corridor." : 
                    "The guardian spots you! It attacks!",
                choices: [
                    window.checkResult ? 
                        {text: "Continue down the corridor", nextSection: 69, skillCheck: false} :
                        {text: "Fight the guardian", nextSection: 2301, skillCheck: false}
                ]
            },
            43: {
                text: "After defeating the Bloodstone Guardian, you search the torture chamber. You find a key on the wall and 30 Gold in a drawer.",
                choices: [
                    {text: "Take the key and gold", nextSection: 70, skillCheck: false},
                    {text: "Continue exploring", nextSection: 71, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Torture Chamber Key");
                    gameState.gold += 30;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                }
            },
            44: {
                text: "You follow the chanting sound. It leads to a chapel where cultists are performing a ritual around a pulsating bloodstone crystal.",
                choices: [
                    {text: "Attack the cultists", nextSection: 4401, skillCheck: false},
                    {text: "Observe from hiding", nextSection: 72, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Try to disrupt the ritual", nextSection: 73, skillCheck: false}
                ]
            },
            4401: {
                text: "You face the Bloodstone Cultists! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 4402, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Bloodstone Cultists";
                    combatState.enemyStamina = 20;
                    combatState.enemyCurrentStamina = 20;
                    combatState.enemySkill = 9;
                    combatState.nextSection = 74;
                    combatState.round = 1;
                    
                    return "Bloodstone Cultists: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            45: {
                text: "You follow the sound of armor. It leads to a barracks where several guards are sleeping while two are on watch.",
                choices: [
                    {text: "Attack the guards", nextSection: 4501, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 75, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Wait for shift change", nextSection: 76, skillCheck: false}
                ]
            },
            4501: {
                text: "You face the Keep Guards! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 4502, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Keep Guards";
                    combatState.enemyStamina = 22;
                    combatState.enemyCurrentStamina = 22;
                    combatState.enemySkill = 10;
                    combatState.nextSection = 77;
                    combatState.round = 1;
                    
                    return "Keep Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            46: {
                text: "You continue down the main corridor. It splits into three directions: left, right, and straight ahead.",
                choices: [
                    {text: "Go left", nextSection: 78, skillCheck: false},
                    {text: "Go right", nextSection: 79, skillCheck: false},
                    {text: "Go straight", nextSection: 80, skillCheck: false}
                ]
            },
            47: {
                text: "You search the storage room and find a barrel marked 'Healing Salve' and a crate containing 40 Gold.",
                choices: [
                    {text: "Take the salve and gold", nextSection: 81, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Healing Salve");
                    gameState.gold += 40;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                    return "You find Healing Salve and 40 Gold!";
                }
            },
            48: {
                text: "You go through the far door into a hallway. You hear footsteps approaching from the left.",
                choices: [
                    {text: "Hide in a nearby alcove", nextSection: 82, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Prepare to fight", nextSection: 83, skillCheck: false},
                    {text: "Run back to storage room", nextSection: 25, skillCheck: false}
                ]
            },
            49: {
                text: "You hide behind some barrels. After a few minutes, a guard passes through without noticing you. The way is now clear.",
                choices: [
                    {text: "Go through the far door", nextSection: 48, skillCheck: false},
                    {text: "Search the storage room", nextSection: 47, skillCheck: false}
                ]
            },
            50: {
                text: "The crystal pulses with red light. Touching it, you feel a surge of power but also pain. The crystal seems to be a smaller version of the central crystal the prisoner mentioned.",
                choices: [
                    {text: "Smash the crystal", nextSection: 84, skillCheck: false},
                    {text: "Take the crystal", nextSection: 85, skillCheck: false},
                    {text: "Leave it alone", nextSection: 52, skillCheck: false}
                ]
            },
            51: {
                text: "You search the chapel and find a hidden compartment under the altar containing a blessed weapon: a mace that glows with holy light.",
                choices: [
                    {text: "Take the blessed mace", nextSection: 86, skillCheck: false},
                    {text: "Leave it", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    gameState.weapons.push({name: 'Blessed Mace', damage: '2d6'});
                    updateInventoryDisplay();
                    return "You find a Blessed Mace (2d6 damage)! It glows with holy light.";
                }
            },
            52: {
                text: "You leave the chapel and find yourself in a hallway that connects to the main keep.",
                choices: [
                    {text: "Follow the hallway", nextSection: 87, skillCheck: false}
                ]
            },
            53: {
                text: window.checkResult ? 
                    "'New recruit, eh? Report to the barracks then,' one guard says, pointing to a door. They return to their dice game, ignoring you." : 
                    "'We know all the recruits! You're an intruder!' They draw their weapons!",
                choices: [
                    window.checkResult ? 
                        {text: "Go to the barracks", nextSection: 88, skillCheck: false} :
                        {text: "Fight the guards", nextSection: 2701, skillCheck: false}
                ]
            },
            54: {
                text: "You back out slowly. The guards watch you but don't pursue. You return to the battlements.",
                choices: [
                    {text: "Take the staircase down", nextSection: 28, skillCheck: false},
                    {text: "Continue along battlements", nextSection: 29, skillCheck: false}
                ]
            },
            55: {
                text: "After defeating the guards, you search the guard room. You find a map of the keep and some gold.",
                choices: [
                    {text: "Take the map and gold", nextSection: 89, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Keep Map");
                    gameState.gold += 25;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                    return "You find a map of the keep and 25 Gold!";
                }
            },
            56: {
                text: "You search the cellar and find a secret door behind a wine rack. It leads to a tunnel.",
                choices: [
                    {text: "Enter the tunnel", nextSection: 90, skillCheck: false},
                    {text: "Continue searching", nextSection: 91, skillCheck: false}
                ]
            },
            57: {
                text: "You find a door that leads to a kitchen. Cooks are preparing food, too busy to notice you slip through.",
                choices: [
                    {text: "Continue through the kitchen", nextSection: 63, skillCheck: false}
                ]
            },
            58: {
                text: "You open the chest and find a crossbow with silver-tipped bolts and 60 Gold!",
                choices: [
                    {text: "Take the crossbow and gold", nextSection: 92, skillCheck: false}
                ],
                action: function() {
                    gameState.weapons.push({name: 'Crossbow', damage: '1d8'});
                    gameState.gold += 60;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                    return "You find a Crossbow (1d8 damage) and 60 Gold!";
                }
            },
            59: {
                text: "You search the guard's body and find a journal. The last entry reads: 'The Lord grows weaker. The central crystal's light dims. Perhaps his reign is ending...' You also find 20 Gold.",
                choices: [
                    {text: "Take the journal and gold", nextSection: 93, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Guard's Journal");
                    gameState.gold += 20;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                }
            },
            60: {
                text: "You continue along the battlements until you reach a door leading into one of the keep's towers.",
                choices: [
                    {text: "Enter the tower", nextSection: 94, skillCheck: false}
                ]
            },
            61: {
                text: window.checkResult ? 
                    "'You seek passage through my keep?' the Bloodstone Lord asks. 'Very well. Take this token and go. But never return.' He tosses you a bloodstone amulet." : 
                    "'Fool! You think to bargain with me?' The Bloodstone Lord rises, drawing a sword of crimson light.",
                choices: [
                    window.checkResult ? 
                        {text: "Take the amulet and leave", nextSection: 200, skillCheck: false} :
                        {text: "Fight the Bloodstone Lord", nextSection: 3001, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.inventory.push("Bloodstone Amulet");
                        updateInventoryDisplay();
                    }
                }
            },
            62: {
                text: "You spot the central crystal pulsing above the throne. It's protected by a magical barrier. The Bloodstone Lord notices your interest. 'You seek my power source? Come and take it, if you dare!'",
                choices: [
                    {text: "Attack the Bloodstone Lord", nextSection: 3001, skillCheck: false},
                    {text: "Try to smash the crystal", nextSection: 95, skillCheck: true, checkType: 'skill', difficulty: 15},
                    {text: "Use a bloodstone shard if you have one", nextSection: 96, skillCheck: false}
                ]
            },
            63: {
                text: "The kitchen is bustling with activity. A side door leads to the main hall, while a staircase leads up.",
                choices: [
                    {text: "Go through the side door to the hall", nextSection: 97, skillCheck: false},
                    {text: "Take the staircase up", nextSection: 98, skillCheck: false},
                    {text: "Hide among the supplies", nextSection: 99, skillCheck: false}
                ]
            },
            64: {
                text: "The weapons rack contains several good weapons. You also find a chest with 70 Gold!",
                choices: [
                    {text: "Take a weapon and the gold", nextSection: 100, skillCheck: false}
                ],
                action: function() {
                    gameState.weapons.push({name: 'Tower Guard Sword', damage: '1d8'});
                    gameState.gold += 70;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                    return "You find a Tower Guard Sword (1d8 damage) and 70 Gold!";
                }
            },
            65: {
                text: "The upper level contains sleeping quarters. You find a guard's personal stash: 40 Gold and a lucky charm.",
                choices: [
                    {text: "Take the gold and charm", nextSection: 101, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 40;
                    gameState.luck += 1;
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    return "You find 40 Gold and a Lucky Charm! Your Luck increases by 1.";
                }
            },
            66: {
                text: window.checkResult ? 
                    "'A message from who?' the guard asks suspiciously. When you hesitate, he realizes you're lying! He attacks!" : 
                    "The guard doesn't believe you! He attacks!",
                choices: [
                    {text: "Fight the guard", nextSection: 3301, skillCheck: false}
                ]
            },
            67: {
                text: "You run away from the tower. The guard shouts an alarm but doesn't pursue.",
                choices: [
                    {text: "Return to the courtyard", nextSection: 10, skillCheck: false}
                ]
            },
            68: {
                text: "You climb the staircase and emerge in a library. Dusty tomes line the shelves. A robed figure is studying at a table.",
                choices: [
                    {text: "Approach the robed figure", nextSection: 102, skillCheck: false},
                    {text: "Search the library", nextSection: 103, skillCheck: false},
                    {text: "Leave quietly", nextSection: 104, skillCheck: false}
                ]
            },
            69: {
                text: "The corridor beyond the torture chamber leads to a set of ornate doors. Through them, you can hear chanting.",
                choices: [
                    {text: "Enter through the doors", nextSection: 105, skillCheck: false},
                    {text: "Listen at the doors first", nextSection: 106, skillCheck: false}
                ]
            },
            70: {
                text: "With the key and gold, you continue exploring. The key might unlock something important.",
                choices: [
                    {text: "Continue exploring", nextSection: 71, skillCheck: false}
                ]
            },
            71: {
                text: "Beyond the torture chamber is a hallway with several doors.",
                choices: [
                    {text: "Try the first door", nextSection: 107, skillCheck: false},
                    {text: "Try the second door", nextSection: 108, skillCheck: false},
                    {text: "Try the third door", nextSection: 109, skillCheck: false}
                ]
            },
            72: {
                text: window.checkResult ? 
                    "You observe unseen. The cultists are channeling energy into the crystal. Their leader chants: 'With this power, our Lord shall reign eternal!'" : 
                    "You're spotted! The cultists turn toward you!",
                choices: [
                    window.checkResult ? 
                        {text: "Attack the cultists", nextSection: 4401, skillCheck: false} :
                        {text: "Try to talk your way out", nextSection: 110, skillCheck: false}
                ]
            },
            73: {
                text: "You disrupt the ritual by knocking over a brazier! The cultists are momentarily confused, giving you an advantage.",
                choices: [
                    {text: "Attack while they're confused", nextSection: 4401, skillCheck: false},
                    {text: "Smash the crystal", nextSection: 111, skillCheck: false}
                ]
            },
            74: {
                text: "After defeating the cultists, the crystal shatters! A wave of energy pulses through the keep. You feel the Bloodstone Lord's power diminish slightly.",
                choices: [
                    {text: "Continue your quest", nextSection: 112, skillCheck: false}
                ],
                action: function() {
                    gameState.bloodstoneWeakened = true;
                    return "The Bloodstone Lord's power has been weakened! This will help in the final battle.";
                }
            },
            75: {
                text: window.checkResult ? 
                    "You successfully sneak past the barracks and continue down the corridor." : 
                    "A guard spots you! He raises the alarm!",
                choices: [
                    window.checkResult ? 
                        {text: "Continue down the corridor", nextSection: 113, skillCheck: false} :
                        {text: "Fight the guards", nextSection: 4501, skillCheck: false}
                ]
            },
            76: {
                text: "You wait for the guard shift to change. During the confusion, you slip past unnoticed.",
                choices: [
                    {text: "Continue down the corridor", nextSection: 113, skillCheck: false}
                ]
            },
            77: {
                text: "After defeating the guards, you search the barracks and find 80 Gold and some useful equipment.",
                choices: [
                    {text: "Take the gold and equipment", nextSection: 114, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 80;
                    gameState.armor.push({name: 'Guard Captain Armor', defense: 3});
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    return "You find 80 Gold and Guard Captain Armor (3 DEF)!";
                }
            },
            78: {
                text: "The left corridor leads to an armory filled with weapons and armor.",
                choices: [
                    {text: "Search the armory", nextSection: 115, skillCheck: false},
                    {text: "Continue past it", nextSection: 116, skillCheck: false}
                ]
            },
            79: {
                text: "The right corridor leads to a shrine dedicated to a blood deity. A pool of dark liquid bubbles in the center.",
                choices: [
                    {text: "Examine the pool", nextSection: 117, skillCheck: false},
                    {text: "Search the shrine", nextSection: 118, skillCheck: false},
                    {text: "Leave the shrine", nextSection: 119, skillCheck: false}
                ]
            },
            80: {
                text: "The straight corridor leads to a large door with a bloodstone symbol. It looks important.",
                choices: [
                    {text: "Try the door", nextSection: 120, skillCheck: false}
                ]
            },
            81: {
                text: "With your newfound supplies, you continue through the far door.",
                choices: [
                    {text: "Go through the far door", nextSection: 48, skillCheck: false}
                ]
            },
            82: {
                text: window.checkResult ? 
                    "You hide successfully as a patrol passes by. The way is now clear." : 
                    "You're spotted! The patrol attacks!",
                choices: [
                    window.checkResult ? 
                        {text: "Continue down the hallway", nextSection: 121, skillCheck: false} :
                        {text: "Fight the patrol", nextSection: 8201, skillCheck: false}
                ]
            },
            8201: {
                text: "You face the Keep Patrol! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 8202, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Keep Patrol";
                    combatState.enemyStamina = 16;
                    combatState.enemyCurrentStamina = 16;
                    combatState.enemySkill = 10;
                    combatState.nextSection = 122;
                    combatState.round = 1;
                    
                    return "Keep Patrol: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            83: {
                text: "You prepare to fight as the footsteps approach. Three guards round the corner!",
                choices: [
                    {text: "Attack the guards", nextSection: 8201, skillCheck: false}
                ]
            },
            84: {
                text: "You smash the crystal! It shatters with a deafening crack. A wave of energy knocks you back, dealing 4 damage, but you feel the keep's dark power diminish.",
                choices: [
                    {text: "Leave the chapel", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina -= 4;
                    gameState.bloodstoneWeakened = true;
                    updateStatsDisplay();
                    return "You destroy a bloodstone crystal! The Bloodstone Lord's power weakens slightly.";
                }
            },
            85: {
                text: "You take the crystal. It pulses in your hand, painful but powerful. It might be useful against the Bloodstone Lord.",
                choices: [
                    {text: "Leave the chapel", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Bloodstone Crystal");
                    updateInventoryDisplay();
                }
            },
            86: {
                text: "With the blessed mace, you feel more confident facing the undead and dark creatures in the keep.",
                choices: [
                    {text: "Leave the chapel", nextSection: 52, skillCheck: false}
                ]
            },
            87: {
                text: "The hallway connects to the main keep's grand hallway. You can see the doors to the throne room at the far end.",
                choices: [
                    {text: "Approach the throne room doors", nextSection: 123, skillCheck: false},
                    {text: "Search side rooms first", nextSection: 124, skillCheck: false}
                ]
            },
            88: {
                text: "You go to the barracks as instructed. The guards there don't question you. You find a spare uniform and blend in.",
                choices: [
                    {text: "Change into the uniform", nextSection: 125, skillCheck: false},
                    {text: "Search the barracks", nextSection: 126, skillCheck: false}
                ]
            },
            89: {
                text: "With the map, you now have a better understanding of the keep's layout. The throne room is marked clearly.",
                choices: [
                    {text: "Head toward the throne room", nextSection: 127, skillCheck: false}
                ]
            },
            90: {
                text: "The tunnel is dark and narrow. It leads to a crypt filled with sarcophagi. One is open, and a skeletal hand reaches out!",
                choices: [
                    {text: "Fight the undead creature", nextSection: 9001, skillCheck: false},
                    {text: "Run back to the cellar", nextSection: 56, skillCheck: false},
                    {text: "Try to calm the undead", nextSection: 128, skillCheck: true, checkType: 'luck', difficulty: 13}
                ]
            },
            9001: {
                text: "You face the Crypt Warden! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 9002, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Crypt Warden";
                    combatState.enemyStamina = 14;
                    combatState.enemyCurrentStamina = 14;
                    combatState.enemySkill = 12;
                    combatState.nextSection = 129;
                    combatState.round = 1;
                    
                    return "Crypt Warden: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            91: {
                text: "You continue searching the cellar and find a hidden cache of vintage wine that could be valuable (worth 30 Gold).",
                choices: [
                    {text: "Take the wine", nextSection: 130, skillCheck: false},
                    {text: "Leave it", nextSection: 56, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 30;
                    updateStatsDisplay();
                    return "You find valuable vintage wine worth 30 Gold!";
                }
            },
            92: {
                text: "Armed with a crossbow, you feel more prepared for ranged combat. You continue along the battlements.",
                choices: [
                    {text: "Enter the tower", nextSection: 94, skillCheck: false}
                ]
            },
            93: {
                text: "The journal provides valuable insight: the Bloodstone Lord's power comes from the central crystal, and it can be weakened by destroying smaller crystals throughout the keep.",
                choices: [
                    {text: "Continue along battlements", nextSection: 60, skillCheck: false}
                ]
            },
            94: {
                text: "The tower contains a spiral staircase going up and down. You hear chanting from above and the clank of armor from below.",
                choices: [
                    {text: "Go up", nextSection: 131, skillCheck: false},
                    {text: "Go down", nextSection: 132, skillCheck: false},
                    {text: "Search the tower room", nextSection: 133, skillCheck: false}
                ]
            },
            95: {
                text: window.checkResult ? 
                    "You dodge past the Bloodstone Lord and smash the crystal! It shatters, and he screams in agony, his power broken!" : 
                    "The Bloodstone Lord intercepts you! 'Fool! Did you think it would be that easy?'",
                choices: [
                    window.checkResult ? 
                        {text: "Finish the weakened Lord", nextSection: 134, skillCheck: false} :
                        {text: "Fight the Bloodstone Lord", nextSection: 3001, skillCheck: false}
                ]
            },
            96: {
                text: "If you have a bloodstone shard, you can use it here to weaken the crystal's barrier.",
                choices: [
                    {text: "Use the shard", nextSection: 135, skillCheck: false},
                    {text: "Attack the Bloodstone Lord instead", nextSection: 3001, skillCheck: false}
                ],
                action: function() {
                    const hasShard = gameState.inventory.includes("Bloodstone Shard");
                    if (hasShard) {
                        // Remove shard from inventory
                        const index = gameState.inventory.indexOf("Bloodstone Shard");
                        if (index > -1) {
                            gameState.inventory.splice(index, 1);
                            updateInventoryDisplay();
                        }
                        return "You use the bloodstone shard to disrupt the crystal's barrier! The Bloodstone Lord's power weakens significantly!";
                    } else {
                        return "You don't have a bloodstone shard to use!";
                    }
                }
            },
            97: {
                text: "You slip through the side door into the grand hall. The Bloodstone Lord is on his throne, facing away from you.",
                choices: [
                    {text: "Attack from behind", nextSection: 136, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Announce your presence", nextSection: 30, skillCheck: false}
                ]
            },
            98: {
                text: "The staircase leads to servant quarters. No one is here at the moment.",
                choices: [
                    {text: "Search the quarters", nextSection: 137, skillCheck: false},
                    {text: "Continue up another staircase", nextSection: 138, skillCheck: false}
                ]
            },
            99: {
                text: "You hide among kitchen supplies until the cooks leave. Then you slip out and continue.",
                choices: [
                    {text: "Go through the side door", nextSection: 97, skillCheck: false}
                ]
            },
            100: {
                text: "Well-armed and richer, you leave the tower and continue your exploration.",
                choices: [
                    {text: "Leave the tower", nextSection: 139, skillCheck: false}
                ]
            },
            101: {
                text: "With increased luck, you feel more confident. You leave the tower.",
                choices: [
                    {text: "Leave the tower", nextSection: 139, skillCheck: false}
                ]
            },
            102: {
                text: "The robed figure turns. It's a lich! 'Knowledge seeker? Or intruder?' it hisses.",
                choices: [
                    {text: "Attack the lich", nextSection: 10201, skillCheck: false},
                    {text: "Claim to seek knowledge", nextSection: 140, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Flee", nextSection: 104, skillCheck: false}
                ]
            },
            10201: {
                text: "You face the Keep Lich! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 10202, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Keep Lich";
                    combatState.enemyStamina = 24;
                    combatState.enemyCurrentStamina = 24;
                    combatState.enemySkill = 13;
                    combatState.nextSection = 141;
                    combatState.round = 1;
                    
                    return "Keep Lich: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            103: {
                text: "You search the library and find a scroll of teleportation and a book about bloodstone magic.",
                choices: [
                    {text: "Take the scroll and book", nextSection: 142, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Teleportation Scroll", "Bloodstone Tome");
                    updateInventoryDisplay();
                    return "You find a Teleportation Scroll and a Bloodstone Tome!";
                }
            },
            104: {
                text: "You leave the library quietly and find yourself in a hallway.",
                choices: [
                    {text: "Follow the hallway", nextSection: 143, skillCheck: false}
                ]
            },
            105: {
                text: "You enter a ritual chamber. Cultists are sacrificing a prisoner to power a bloodstone crystal!",
                choices: [
                    {text: "Attack the cultists", nextSection: 10501, skillCheck: false},
                    {text: "Free the prisoner", nextSection: 144, skillCheck: false},
                    {text: "Smash the crystal", nextSection: 145, skillCheck: false}
                ]
            },
            10501: {
                text: "You face the Ritual Cultists! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 10502, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Ritual Cultists";
                    combatState.enemyStamina = 18;
                    combatState.enemyCurrentStamina = 18;
                    combatState.enemySkill = 10;
                    combatState.nextSection = 146;
                    combatState.round = 1;
                    
                    return "Ritual Cultists: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            106: {
                text: "You listen at the doors. You hear chanting and a prisoner begging for mercy.",
                choices: [
                    {text: "Burst in to save the prisoner", nextSection: 105, skillCheck: false},
                    {text: "Try to open the doors quietly", nextSection: 147, skillCheck: true, checkType: 'skill', difficulty: 11}
                ]
            },
            107: {
                text: "The first door leads to a bedroom. It looks like it belongs to a high-ranking officer.",
                choices: [
                    {text: "Search the bedroom", nextSection: 148, skillCheck: false},
                    {text: "Leave and try another door", nextSection: 71, skillCheck: false}
                ]
            },
            108: {
                text: "The second door is locked. It might require a key.",
                choices: [
                    {text: "Try to pick the lock", nextSection: 149, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Use a key if you have one", nextSection: 150, skillCheck: false},
                    {text: "Leave and try another door", nextSection: 71, skillCheck: false}
                ]
            },
            109: {
                text: "The third door leads to a balcony overlooking the courtyard.",
                choices: [
                    {text: "Go out on the balcony", nextSection: 151, skillCheck: false},
                    {text: "Leave and try another door", nextSection: 71, skillCheck: false}
                ]
            },
            110: {
                text: "'I bring a message from the Bloodstone Lord!' you shout. The cultists pause, confused.",
                choices: [
                    {text: "Attack while they're confused", nextSection: 4401, skillCheck: false},
                    {text: "Try to maintain the deception", nextSection: 152, skillCheck: true, checkType: 'luck', difficulty: 14}
                ]
            },
            111: {
                text: "You smash the crystal while the cultists are distracted! It shatters, and they scream in rage.",
                choices: [
                    {text: "Fight the enraged cultists", nextSection: 4401, skillCheck: false},
                    {text: "Flee while they're disorganized", nextSection: 153, skillCheck: false}
                ]
            },
            112: {
                text: "With one crystal destroyed, you feel the keep's dark energy diminish. You need to find the throne room.",
                choices: [
                    {text: "Head toward the throne room", nextSection: 154, skillCheck: false}
                ]
            },
            113: {
                text: "The corridor beyond the barracks leads to a set of stairs going up to the main hall.",
                choices: [
                    {text: "Climb the stairs", nextSection: 155, skillCheck: false}
                ]
            },
            114: {
                text: "Well-equipped, you continue your quest. The barracks has another exit leading deeper into the keep.",
                choices: [
                    {text: "Take the other exit", nextSection: 156, skillCheck: false}
                ]
            },
            115: {
                text: "The armory contains excellent weapons and armor. You find a masterwork sword and bloodstone-infused armor.",
                choices: [
                    {text: "Take the sword and armor", nextSection: 157, skillCheck: false}
                ],
                action: function() {
                    gameState.weapons.push({name: 'Masterwork Sword', damage: '2d6'});
                    gameState.armor.push({name: 'Bloodstone Armor', defense: 4});
                    updateInventoryDisplay();
                    return "You find a Masterwork Sword (2d6 damage) and Bloodstone Armor (4 DEF)!";
                }
            },
            116: {
                text: "You pass the armory and continue down the corridor. It ends at a door with a bloodstone emblem.",
                choices: [
                    {text: "Try the door", nextSection: 158, skillCheck: false}
                ]
            },
            117: {
                text: "The pool bubbles with dark energy. Touching it might be dangerous but could grant power.",
                choices: [
                    {text: "Touch the pool", nextSection: 159, skillCheck: false},
                    {text: "Drink from the pool", nextSection: 160, skillCheck: false},
                    {text: "Leave it alone", nextSection: 119, skillCheck: false}
                ]
            },
            118: {
                text: "You search the shrine and find sacrificial daggers and a bloodstone idol worth 50 Gold.",
                choices: [
                    {text: "Take the idol", nextSection: 161, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 50;
                    updateStatsDisplay();
                    return "You find a valuable bloodstone idol worth 50 Gold!";
                }
            },
            119: {
                text: "You leave the shrine and return to the corridor intersection.",
                choices: [
                    {text: "Go left to the armory", nextSection: 78, skillCheck: false},
                    {text: "Go straight to the important door", nextSection: 80, skillCheck: false}
                ]
            },
            120: {
                text: "The door with the bloodstone symbol is the entrance to the throne room! You can hear a deep voice chanting inside.",
                choices: [
                    {text: "Enter the throne room", nextSection: 30, skillCheck: false},
                    {text: "Prepare first", nextSection: 162, skillCheck: false}
                ]
            },
            121: {
                text: "The hallway continues to a junction. You can go left, right, or straight ahead.",
                choices: [
                    {text: "Go left", nextSection: 163, skillCheck: false},
                    {text: "Go right", nextSection: 164, skillCheck: false},
                    {text: "Go straight", nextSection: 165, skillCheck: false}
                ]
            },
            122: {
                text: "After defeating the patrol, you find a key on their leader and 35 Gold.",
                choices: [
                    {text: "Take the key and gold", nextSection: 166, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Patrol Leader's Key");
                    gameState.gold += 35;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                }
            },
            123: {
                text: "You approach the throne room doors. They're massive and ornate, carved with scenes of battle and blood sacrifice.",
                choices: [
                    {text: "Push the doors open", nextSection: 30, skillCheck: false},
                    {text: "Listen first", nextSection: 167, skillCheck: false}
                ]
            },
            124: {
                text: "You search side rooms and find a storage closet with healing potions and a guard room with a map.",
                choices: [
                    {text: "Take the potions and map", nextSection: 168, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Healing Potion", "Healing Potion", "Detailed Keep Map");
                    updateInventoryDisplay();
                    return "You find 2 Healing Potions and a Detailed Keep Map!";
                }
            },
            125: {
                text: "You change into the guard uniform. Now you can move through the keep more easily.",
                choices: [
                    {text: "Leave the barracks", nextSection: 169, skillCheck: false}
                ],
                action: function() {
                    gameState.disguised = true;
                }
            },
            126: {
                text: "You search the barracks and find a letter detailing guard schedules and a spare key.",
                choices: [
                    {text: "Take the letter and key", nextSection: 170, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Guard Schedule", "Barracks Key");
                    updateInventoryDisplay();
                }
            },
            127: {
                text: "Following the map, you navigate directly to the throne room with minimal encounters.",
                choices: [
                    {text: "Enter the throne room", nextSection: 30, skillCheck: false}
                ]
            },
            128: {
                text: window.checkResult ? 
                    "You speak words of peace. The skeletal hand withdraws, and a voice whispers: 'Free us from this curse... destroy the central crystal...'" : 
                    "The undead creature isn't interested in peace! It attacks!",
                choices: [
                    window.checkResult ? 
                        {text: "Continue through the crypt", nextSection: 171, skillCheck: false} :
                        {text: "Fight the undead", nextSection: 9001, skillCheck: false}
                ]
            },
            129: {
                text: "After defeating the Crypt Warden, you find its treasure hoard: 100 Gold and a magical amulet!",
                choices: [
                    {text: "Take the treasure", nextSection: 172, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 100;
                    gameState.inventory.push("Warden's Amulet");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    return "You find 100 Gold and a Warden's Amulet!";
                }
            },
            130: {
                text: "With the valuable wine, you continue exploring.",
                choices: [
                    {text: "Enter the tunnel", nextSection: 90, skillCheck: false}
                ]
            },
            131: {
                text: "Going up, you reach a rooftop observatory. A telescope points toward the Ashen Wastes. You also find a chest.",
                choices: [
                    {text: "Search the chest", nextSection: 173, skillCheck: false},
                    {text: "Use the telescope", nextSection: 174, skillCheck: false},
                    {text: "Go back down", nextSection: 94, skillCheck: false}
                ]
            },
            132: {
                text: "Going down, you reach the main hall level. You're near the throne room doors.",
                choices: [
                    {text: "Approach the throne room", nextSection: 123, skillCheck: false}
                ]
            },
            133: {
                text: "The tower room contains maps and logbooks. You learn that the Bloodstone Lord is preparing for an invasion of the Ashen Wastes.",
                choices: [
                    {text: "Take useful information", nextSection: 175, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Invasion Plans");
                    updateInventoryDisplay();
                }
            },
            134: {
                text: "With the crystal destroyed, the Bloodstone Lord is helpless. You defeat him easily.",
                choices: [
                    {text: "Claim victory", nextSection: 200, skillCheck: false}
                ]
            },
            135: {
                text: "You use the bloodstone shard to disrupt the crystal's barrier. The Bloodstone Lord screams as his power source becomes vulnerable!",
                choices: [
                    {text: "Attack the weakened Lord", nextSection: 176, skillCheck: false}
                ],
                action: function() {
                    // The Lord is significantly weakened
                    combatState.active = true;
                    combatState.enemyName = "Weakened Bloodstone Lord";
                    combatState.enemyStamina = 15; // Reduced from 30
                    combatState.enemyCurrentStamina = 15;
                    combatState.enemySkill = 10; // Reduced from 14
                    combatState.nextSection = 200;
                    combatState.round = 1;
                    
                    return "Weakened Bloodstone Lord: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            136: {
                text: window.checkResult ? 
                    "You strike the Bloodstone Lord from behind! He roars in pain and turns to face you, already wounded." : 
                    "The Bloodstone Lord senses you at the last moment and blocks your attack!",
                choices: [
                    window.checkResult ? 
                        {text: "Continue the fight with advantage", nextSection: 177, skillCheck: false} :
                        {text: "Fight the Bloodstone Lord", nextSection: 3001, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        // The Lord starts with damage
                        combatState.active = true;
                        combatState.enemyName = "Wounded Bloodstone Lord";
                        combatState.enemyStamina = 22; // Starting with 8 damage
                        combatState.enemyCurrentStamina = 22;
                        combatState.enemySkill = 14;
                        combatState.nextSection = 200;
                        combatState.round = 1;
                        
                        return "Wounded Bloodstone Lord: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                    }
                }
            },
            137: {
                text: "You search the servant quarters and find a hidden stash of gold (40 Gold) and a servant's uniform.",
                choices: [
                    {text: "Take the gold and uniform", nextSection: 178, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 40;
                    gameState.inventory.push("Servant's Uniform");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                }
            },
            138: {
                text: "The next staircase leads to the main hall balcony. You have a view of the throne room below.",
                choices: [
                    {text: "Observe from the balcony", nextSection: 179, skillCheck: false},
                    {text: "Go down to the hall", nextSection: 180, skillCheck: false}
                ]
            },
            139: {
                text: "You leave the tower and find yourself on a walkway connecting to the main keep.",
                choices: [
                    {text: "Follow the walkway", nextSection: 181, skillCheck: false}
                ]
            },
            140: {
                text: window.checkResult ? 
                    "'Knowledge, you say? Very well. The central crystal is the source of the Bloodstone Lord's power. Destroy it, and he falls.' The lich returns to its studies." : 
                    "'Liar! You seek to destroy, not learn!' The lich attacks!",
                choices: [
                    window.checkResult ? 
                        {text: "Thank the lich and leave", nextSection: 104, skillCheck: false} :
                        {text: "Fight the lich", nextSection: 10201, skillCheck: false}
                ]
            },
            141: {
                text: "After defeating the lich, you search its study and find powerful scrolls and a staff of magic.",
                choices: [
                    {text: "Take the scrolls and staff", nextSection: 182, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Scroll of Fireball", "Scroll of Healing", "Lich's Staff");
                    updateInventoryDisplay();
                    return "You find a Scroll of Fireball, Scroll of Healing, and a Lich's Staff!";
                }
            },
            142: {
                text: "With the teleportation scroll, you could escape danger quickly. The tome might contain useful information.",
                choices: [
                    {text: "Leave the library", nextSection: 104, skillCheck: false}
                ]
            },
            143: {
                text: "The hallway leads to an antechamber before the throne room. Two elite guards stand watch.",
                choices: [
                    {text: "Fight the elite guards", nextSection: 14301, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 183, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Use disguise if you have one", nextSection: 184, skillCheck: false}
                ]
            },
            14301: {
                text: "You face the Elite Throne Guards! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 14302, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Elite Throne Guards";
                    combatState.enemyStamina = 24;
                    combatState.enemyCurrentStamina = 24;
                    combatState.enemySkill = 12;
                    combatState.nextSection = 185;
                    combatState.round = 1;
                    
                    return "Elite Throne Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            144: {
                text: "You free the prisoner while the cultists are distracted. He thanks you and gives you a bloodstone shard before fleeing.",
                choices: [
                    {text: "Now attack the cultists", nextSection: 10501, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Bloodstone Shard");
                    updateInventoryDisplay();
                }
            },
            145: {
                text: "You smash the crystal! The ritual is disrupted, and the cultists are thrown back by the energy release.",
                choices: [
                    {text: "Attack the disoriented cultists", nextSection: 10501, skillCheck: false},
                    {text: "Flee with the prisoner", nextSection: 186, skillCheck: false}
                ],
                action: function() {
                    gameState.bloodstoneWeakened = true;
                }
            },
            146: {
                text: "After defeating the cultists, you free any remaining prisoners and destroy the ritual crystal.",
                choices: [
                    {text: "Continue your quest", nextSection: 187, skillCheck: false}
                ],
                action: function() {
                    gameState.bloodstoneWeakened = true;
                }
            },
            147: {
                text: window.checkResult ? 
                    "You open the doors quietly and slip inside unseen. You're behind the cultists." : 
                    "The doors creak loudly! The cultists turn to face you!",
                choices: [
                    window.checkResult ? 
                        {text: "Attack from behind", nextSection: 188, skillCheck: false} :
                        {text: "Prepare to fight", nextSection: 105, skillCheck: false}
                ]
            },
            148: {
                text: "You find the officer's personal funds (80 Gold) and a key to the armory.",
                choices: [
                    {text: "Take the gold and key", nextSection: 189, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 80;
                    gameState.inventory.push("Armory Key");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                }
            },
            149: {
                text: window.checkResult ? 
                    "You successfully pick the lock. Inside is a treasure room!" : 
                    "You fail to pick the lock and break your lockpick.",
                choices: [
                    window.checkResult ? 
                        {text: "Enter the treasure room", nextSection: 190, skillCheck: false} :
                        {text: "Leave and try another door", nextSection: 71, skillCheck: false}
                ]
            },
            150: {
                text: "If you have the torture chamber key, you can try it here.",
                choices: [
                    {text: "Try the key", nextSection: 191, skillCheck: false},
                    {text: "Leave and try another door", nextSection: 71, skillCheck: false}
                ],
                action: function() {
                    const hasKey = gameState.inventory.includes("Torture Chamber Key");
                    if (hasKey) {
                        return "The key fits! The door unlocks.";
                    } else {
                        return "You don't have the right key.";
                    }
                }
            },
            151: {
                text: "From the balcony, you have a good view of the courtyard. You also spot a rope you could use to descend.",
                choices: [
                    {text: "Descend using the rope", nextSection: 192, skillCheck: false},
                    {text: "Go back inside", nextSection: 71, skillCheck: false}
                ]
            },
            152: {
                text: window.checkResult ? 
                    "'What is the message?' the head cultist asks. You improvise: 'The Lord commands you to strengthen the central crystal immediately!' They hurry off to obey, leaving the smaller crystal unguarded!" : 
                    "They don't believe you! 'Imposter!' they shout, attacking!",
                choices: [
                    window.checkResult ? 
                        {text: "Smash the unguarded crystal", nextSection: 193, skillCheck: false} :
                        {text: "Fight the cultists", nextSection: 4401, skillCheck: false}
                ]
            },
            153: {
                text: "You flee while the cultists are disorganized. You find another route through the keep.",
                choices: [
                    {text: "Continue your escape", nextSection: 194, skillCheck: false}
                ]
            },
            154: {
                text: "You navigate toward the throne room, avoiding patrols when possible.",
                choices: [
                    {text: "Reach the throne room", nextSection: 123, skillCheck: false}
                ]
            },
            155: {
                text: "The stairs lead directly to the throne room antechamber.",
                choices: [
                    {text: "Enter the antechamber", nextSection: 143, skillCheck: false}
                ]
            },
            156: {
                text: "The other exit leads to a hallway that connects to the main keep's upper levels.",
                choices: [
                    {text: "Follow the hallway", nextSection: 195, skillCheck: false}
                ]
            },
            157: {
                text: "Well-armed and armored, you feel ready to face the Bloodstone Lord.",
                choices: [
                    {text: "Continue to the throne room", nextSection: 196, skillCheck: false}
                ]
            },
            158: {
                text: "The door leads to the throne room! The Bloodstone Lord is inside.",
                choices: [
                    {text: "Enter and face him", nextSection: 30, skillCheck: false}
                ]
            },
            159: {
                text: "You touch the pool. Dark energy surges through you! You gain power but lose some of your humanity.",
                choices: [
                    {text: "Continue", nextSection: 197, skillCheck: false}
                ],
                action: function() {
                    gameState.skill += 2;
                    gameState.luck -= 2;
                    updateStatsDisplay();
                    return "You gain 2 Skill but lose 2 Luck! The dark power corrupts you.";
                }
            },
            160: {
                text: "You drink from the pool. It's bitter and burning. You feel stronger but ill.",
                choices: [
                    {text: "Continue", nextSection: 198, skillCheck: false}
                ],
                action: function() {
                    const effect = rollDiceHelper(1, 6);
                    if (effect <= 3) {
                        gameState.stamina -= 8;
                        updateStatsDisplay();
                        return "The liquid is poisonous! You lose 8 Stamina.";
                    } else {
                        gameState.skill += 1;
                        gameState.stamina += 4;
                        updateStatsDisplay();
                        return "The liquid grants you dark power! Skill +1, Stamina +4.";
                    }
                }
            },
            161: {
                text: "With the valuable idol, you leave the shrine.",
                choices: [
                    {text: "Return to the corridor", nextSection: 119, skillCheck: false}
                ]
            },
            162: {
                text: "You prepare yourself for the coming battle. You drink a healing potion if you have one and check your equipment.",
                choices: [
                    {text: "Enter the throne room", nextSection: 30, skillCheck: false}
                ],
                action: function() {
                    // Heal if possible
                    if (gameState.inventory.includes("Healing Potion")) {
                        const index = gameState.inventory.indexOf("Healing Potion");
                        if (index > -1) {
                            gameState.inventory.splice(index, 1);
                            gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 6);
                            updateStatsDisplay();
                            updateInventoryDisplay();
                            return "You drink a Healing Potion, restoring 6 Stamina.";
                        }
                    }
                    return "You prepare yourself mentally for the battle ahead.";
                }
            },
            163: {
                text: "Left leads to a dead end with a statue holding a valuable gem (worth 30 Gold).",
                choices: [
                    {text: "Take the gem", nextSection: 199, skillCheck: false},
                    {text: "Go back and choose another direction", nextSection: 121, skillCheck: false}
                ]
            },
            // VICTORY SECTION - Player completes the level
            200: {
                text: "You have conquered <span class='bloodstone-decoration'>BLOODSTONE KEEP</span>! Whether through combat, cunning, or diplomacy, you've defeated the Bloodstone Lord and broken his dark reign. The keep's oppressive energy begins to fade as its master falls. Before you lie the rear gates, leading to the desolate <span class='enemy'>ASHEN WASTES</span>.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-skill').textContent = gameState.skill;
                    document.getElementById('next-stat-stamina').textContent = gameState.stamina;
                    document.getElementById('next-stat-luck').textContent = gameState.luck;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    return "You've completed Level 4: Bloodstone Keep! Your journey continues to the Ashen Wastes...";
                }
            },
            // Combat sections (402-403, 2302-2303, etc.) need to be added
            402: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 403, skillCheck: false}
                ]
            },
            403: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 402, skillCheck: false}
                ]
            },
            2302: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 2303, skillCheck: false}
                ]
            },
            2303: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 2302, skillCheck: false}
                ]
            },
            2702: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 2703, skillCheck: false}
                ]
            },
            2703: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 2702, skillCheck: false}
                ]
            },
            3002: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 3003, skillCheck: false}
                ]
            },
            3003: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 3002, skillCheck: false}
                ]
            },
            3301: {
                text: "You face the Tower Guard! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 3302, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Tower Guard";
                    combatState.enemyStamina = 12;
                    combatState.enemyCurrentStamina = 12;
                    combatState.enemySkill = 9;
                    combatState.nextSection = 201; // Will be determined
                    combatState.round = 1;
                    
                    return "Tower Guard: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            3302: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 3303, skillCheck: false}
                ]
            },
            3303: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 3302, skillCheck: false}
                ]
            },
            4402: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 4403, skillCheck: false}
                ]
            },
            4403: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 4402, skillCheck: false}
                ]
            },
            4502: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 4503, skillCheck: false}
                ]
            },
            4503: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 4502, skillCheck: false}
                ]
            },
            8202: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 8203, skillCheck: false}
                ]
            },
            8203: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 8202, skillCheck: false}
                ]
            },
            9002: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 9003, skillCheck: false}
                ]
            },
            9003: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 9002, skillCheck: false}
                ]
            },
            10202: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 10203, skillCheck: false}
                ]
            },
            10203: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 10202, skillCheck: false}
                ]
            },
            10502: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 10503, skillCheck: false}
                ]
            },
            10503: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 10502, skillCheck: false}
                ]
            },
            14302: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 14303, skillCheck: false}
                ]
            },
            14303: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 14302, skillCheck: false}
                ]
            },
            1401: {
                text: "You face the Keep Guards! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 1402, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Keep Guards";
                    combatState.enemyStamina = 14;
                    combatState.enemyCurrentStamina = 14;
                    combatState.enemySkill = 8;
                    combatState.nextSection = 202; // Will be determined
                    combatState.round = 1;
                    
                    return "Keep Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            1402: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 1403, skillCheck: false}
                ]
            },
            1403: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 1402, skillCheck: false}
                ]
            },
            177: {
                text: "", // Will be filled by combat round (special wounded lord combat)
                choices: [
                    {text: "Continue the fight!", nextSection: 178, skillCheck: false}
                ]
            },
            178: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 177, skillCheck: false}
                ]
            },
            176: {
                text: "", // Will be filled by combat round (weakened lord combat)
                choices: [
                    {text: "Continue the fight!", nextSection: 177, skillCheck: false}
                ]
            },
            188: {
                text: "You attack the cultists from behind with advantage!",
                choices: [
                    {text: "Begin the battle with advantage!", nextSection: 189, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Surprised Cultists";
                    combatState.enemyStamina = 18;
                    combatState.enemyCurrentStamina = 18;
                    combatState.enemySkill = 8; // Reduced skill due to surprise
                    combatState.nextSection = 146;
                    combatState.round = 1;
                    
                    return "Surprised Cultists: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill + " (reduced due to surprise!)";
                }
            },
            189: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 190, skillCheck: false}
                ]
            },
            190: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 189, skillCheck: false}
                ]
            }
        };

        // Initialize game
        function initGame() {
            updateStatsDisplay();
            updateInventoryDisplay();
            
            if (gameState.currentSection > 0) {
                loadSection(gameState.currentSection);
            } else {
                loadSection(0);
            }
        }
        
        // Show warning dialog for new game
        function showNewGameWarning() {
            document.getElementById('screen-game').classList.remove('active-screen');
            document.getElementById('warning-dialog').classList.add('active-screen');
        }
        
        // Cancel new game and return to game screen
        function cancelNewGame() {
            document.getElementById('warning-dialog').classList.remove('active-screen');
            document.getElementById('screen-game').classList.add('active-screen');
        }
        
        // Start new game - reset everything
        function startNewGame() {
            localStorage.removeItem('dreadwoodGameState');
            gameState = {
                playerClass: '',
                skill: 0,
                maxStamina: 0,
                stamina: 0,
                luck: 0,
                gold: 0,
                inventory: [],
                weapons: [],
                armor: [],
                currentWeaponIndex: 0,
                currentArmorIndex: 0,
                currentSection: 0,
                gameComplete: false
            };
            window.location.href = 'level1.html';
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-skill').textContent = gameState.skill;
            document.getElementById('stat-stamina').textContent = gameState.stamina;
            document.getElementById('stat-maxstamina').textContent = gameState.maxStamina;
            document.getElementById('stat-luck').textContent = gameState.luck;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Show current equipped weapon
            if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                const weapon = gameState.weapons[gameState.currentWeaponIndex];
                const weaponSpan = document.createElement('span');
                weaponSpan.className = 'inventory-item';
                weaponSpan.id = 'inv-weapon';
                weaponSpan.textContent = `${weapon.name} (${weapon.damage})`;
                inventoryDiv.appendChild(weaponSpan);
            }
            
            // Show current equipped armor
            if (gameState.armor && gameState.armor.length > 0 && gameState.currentArmorIndex >= 0) {
                const armor = gameState.armor[gameState.currentArmorIndex];
                const armorSpan = document.createElement('span');
                armorSpan.className = 'inventory-item';
                armorSpan.id = 'inv-armor';
                armorSpan.textContent = `${armor.name} (${armor.defense} DEF)`;
                inventoryDiv.appendChild(armorSpan);
            }
            
            // Show gold
            const goldSpan = document.createElement('span');
            goldSpan.className = 'inventory-item';
            goldSpan.textContent = `${gameState.gold} Gold`;
            inventoryDiv.appendChild(goldSpan);
            
            // Show other inventory items
            if (gameState.inventory) {
                gameState.inventory.forEach(item => {
                    // Don't show items that are currently equipped as weapons/armor
                    const isCurrentWeapon = gameState.weapons[gameState.currentWeaponIndex] && 
                        gameState.weapons[gameState.currentWeaponIndex].name === item;
                    const isCurrentArmor = gameState.armor[gameState.currentArmorIndex] && 
                        gameState.armor[gameState.currentArmorIndex].name === item;
                    
                    if (!isCurrentWeapon && !isCurrentArmor) {
                        const itemSpan = document.createElement('span');
                        itemSpan.className = 'inventory-item';
                        itemSpan.textContent = item;
                        inventoryDiv.appendChild(itemSpan);
                    }
                });
            }
        }
        
        // Load story section
        function loadSection(sectionId) {
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                // For any missing sections, provide a default continuation
                document.getElementById('story-text').innerHTML = "<p>You continue through Bloodstone Keep, navigating its haunted corridors. The air grows colder as you approach the throne room. In the distance, you can hear the deep chanting of the Bloodstone Lord.</p>";
                document.getElementById('choice-buttons').innerHTML = `
                    <button class="choice-btn" onclick="loadSection(200)">Face the Bloodstone Lord</button>
                    <button class="choice-btn" onclick="loadSection(0)">Return to Keep Entrance</button>
                `;
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 402 || sectionId === 403 || 
                                 sectionId === 2302 || sectionId === 2303 ||
                                 sectionId === 2702 || sectionId === 2703 ||
                                 sectionId === 3002 || sectionId === 3003 ||
                                 sectionId === 3302 || sectionId === 3303 ||
                                 sectionId === 4402 || sectionId === 4403 ||
                                 sectionId === 4502 || sectionId === 4503 ||
                                 sectionId === 8202 || sectionId === 8203 ||
                                 sectionId === 9002 || sectionId === 9003 ||
                                 sectionId === 10202 || sectionId === 10203 ||
                                 sectionId === 10502 || sectionId === 10503 ||
                                 sectionId === 14302 || sectionId === 14303 ||
                                 sectionId === 1402 || sectionId === 1403 ||
                                 sectionId === 177 || sectionId === 178 ||
                                 sectionId === 176 || sectionId === 189 || sectionId === 190);
            
            if (isCombatRound && combatState.active) {
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                if (!combatState.active) {
                    const goldReward = Math.floor(Math.random() * 30) + 10;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find ${goldReward} Gold on the body.`;
                    
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                section.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    button.onclick = function() {
                        if (choice.skillCheck) {
                            performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                        } else {
                            loadSection(choice.nextSection);
                        }
                    };
                    choiceButtons.appendChild(button);
                });
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDiceHelper(2, 6);
            const enemyRoll = rollDiceHelper(2, 6);
            
            // Add skill to dice rolls
            const playerTotal = playerRoll + gameState.skill;
            const enemyTotal = enemyRoll + combatState.enemySkill;
            
            let resultText = `<span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Stamina: ${gameState.stamina}, Enemy Stamina: ${combatState.enemyCurrentStamina}<br>`;
            resultText += `You roll ${playerRoll} + Skill ${gameState.skill} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Skill ${combatState.enemySkill} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                    const weapon = gameState.weapons[gameState.currentWeaponIndex];
                    if (weapon.damage === '1d6') damage = rollDiceHelper(1, 6);
                    else if (weapon.damage === '2d4') damage = rollDiceHelper(2, 4);
                    else if (weapon.damage === '2d6') damage = rollDiceHelper(2, 6);
                    else if (weapon.damage === '1d8') damage = rollDiceHelper(1, 8);
                    else damage = rollDiceHelper(1, 6); // Default fallback
                } else {
                    damage = rollDiceHelper(1, 6);
                }
                
                // Apply bonus if player has bloodstone-related advantages
                if (gameState.bloodstoneWeakened && combatState.enemyName.includes("Bloodstone")) {
                    damage += 2;
                    resultText += "The bloodstone weakening adds +2 damage!<br>";
                }
                
                combatState.enemyCurrentStamina -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                
                if (combatState.enemyCurrentStamina <= 0) {
                    combatState.active = false;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                let enemyDamage = rollDiceHelper(1, 6); // Base enemy damage
                
                // Bloodstone Lord deals more damage
                if (combatState.enemyName.includes("Bloodstone Lord")) {
                    enemyDamage = rollDiceHelper(2, 4);
                }
                
                // Apply armor defense
                if (gameState.armor && gameState.armor.length > 0 && gameState.currentArmorIndex >= 0) {
                    const armor = gameState.armor[gameState.currentArmorIndex];
                    enemyDamage = Math.max(1, enemyDamage - armor.defense);
                    resultText += `Your armor reduces damage by ${armor.defense}.<br>`;
                }
                
                gameState.stamina -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                
                // Check if player died
                if (gameState.stamina <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated by the ${combatState.enemyName}! Game Over.</span>`;
                    setTimeout(() => {
                        localStorage.removeItem('dreadwoodGameState');
                        location.reload();
                    }, 3000);
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            const diceRoll = rollDiceHelper(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Luck
        function useLuck() {
            if (gameState.luck <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Luck left!</div>`;
                return;
            }
            
            const diceRoll = rollDiceHelper(2, 6);
            const success = diceRoll <= gameState.luck;
            
            gameState.luck -= 1;
            updateStatsDisplay();
            
            let resultText = `You test your Luck... Roll: ${diceRoll}, Luck: ${gameState.luck + 1}. `;
            resultText += success ? 
                `<span class="success">Lucky!</span> Something good happens.` : 
                `<span class="damage">Unlucky!</span> Something bad happens.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            // Apply Luck effect
            if (success) {
                const goodEffects = [
                    "You find 10 Gold on the floor!",
                    "You feel a surge of energy! Restore 5 Stamina.",
                    "You spot a hidden passage that might be useful.",
                    "A dropped weapon is in good condition! You gain a random weapon.",
                    "You avoid a trap you didn't see coming."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Gold")) {
                    gameState.gold += 10;
                } else if (effect.includes("Stamina")) {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 5);
                } else if (effect.includes("weapon")) {
                    const randomWeapons = [
                        {name: 'Short Sword', damage: '1d6'},
                        {name: 'War Hammer', damage: '1d8'},
                        {name: 'Battle Axe', damage: '2d4'}
                    ];
                    const weapon = randomWeapons[Math.floor(Math.random() * randomWeapons.length)];
                    gameState.weapons.push(weapon);
                    updateInventoryDisplay();
                }
            } else {
                const badEffects = [
                    "You trip and take 3 damage!",
                    "You drop 5 Gold!",
                    "You attract the attention of a patrolling guard!",
                    "Your armor strap breaks! Lose 1 DEF until repaired.",
                    "You trigger a trap! Take 4 damage."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    const damage = parseInt(effect.match(/\d+/)[0]);
                    gameState.stamina -= damage;
                    if (gameState.stamina <= 0) {
                        document.getElementById('story-text').innerHTML += `<div class="game-over">You have been defeated! Game Over.</div>`;
                        setTimeout(() => {
                            localStorage.removeItem('dreadwoodGameState');
                            location.reload();
                        }, 3000);
                    }
                } else if (effect.includes("Gold")) {
                    gameState.gold = Math.max(0, gameState.gold - 5);
                } else if (effect.includes("guard")) {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">A guard approaches you menacingly!</div>`;
                    setTimeout(() => {
                        combatState.active = true;
                        combatState.enemyName = "Keep Guard";
                        combatState.enemyStamina = 10;
                        combatState.enemyCurrentStamina = 10;
                        combatState.enemySkill = 7;
                        combatState.nextSection = gameState.currentSection;
                        combatState.round = 0;
                        loadSection(402);
                    }, 1000);
                }
            }
            
            updateStatsDisplay();
            updateInventoryDisplay();
        }
        
        // Use Item function
        function useItem() {
            const usableItems = gameState.inventory.filter(item => {
                const isWeapon = gameState.weapons.some(w => w.name === item);
                const isArmor = gameState.armor.some(a => a.name === item);
                return !isWeapon && !isArmor;
            });
            
            if (usableItems.length === 0) {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory!</div>`;
                return;
            }
            
            let itemText = "<h3>Select an item to use:</h3>";
            
            usableItems.forEach((item, index) => {
                itemText += `<p>${item} `;
                
                if (item === "Healing Potion" || item === "Healing Salve") {
                    itemText += `<button onclick="useHealingItem('${item}')" style="font-size:12px; padding:3px 8px;">Use (Restore Stamina)</button>`;
                } else if (item === "Bloodstone Shard") {
                    itemText += `<button onclick="useBloodstoneShard()" style="font-size:12px; padding:3px 8px;">Use (Weaken Bloodstone)</button>`;
                } else if (item === "Bloodstone Crystal") {
                    itemText += `<button onclick="useBloodstoneCrystal()" style="font-size:12px; padding:3px 8px;">Use (Gain Power)</button>`;
                } else if (item === "Teleportation Scroll") {
                    itemText += `<button onclick="useTeleportationScroll()" style="font-size:12px; padding:3px 8px;">Use (Teleport)</button>`;
                } else if (item === "Scroll of Fireball") {
                    itemText += `<button onclick="useFireballScroll()" style="font-size:12px; padding:3px 8px;">Use (Combat)</button>`;
                } else if (item === "Scroll of Healing") {
                    itemText += `<button onclick="useHealingScroll()" style="font-size:12px; padding:3px 8px;">Use (Heal)</button>`;
                } else if (item === "Bloodstone Tome") {
                    itemText += `<button onclick="useBloodstoneTome()" style="font-size:12px; padding:3px 8px;">Read</button>`;
                } else if (item === "Guard's Journal" || item === "Invasion Plans") {
                    itemText += `<button onclick="readDocument('${item}')" style="font-size:12px; padding:3px 8px;">Read</button>`;
                } else {
                    itemText += `<button onclick="useGenericItem('${item}')" style="font-size:12px; padding:3px 8px;">Use</button>`;
                }
                
                itemText += `</p>`;
            });
            
            itemText += `<p><button onclick="cancelItemUse()" style="font-size:12px; padding:3px 8px; margin-top:10px;">Cancel</button></p>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${itemText}</div>`;
        }
        
        // Use Healing Item
        function useHealingItem(itemName) {
            const itemIndex = gameState.inventory.indexOf(itemName);
            if (itemIndex !== -1) {
                gameState.inventory.splice(itemIndex, 1);
                
                let healAmount = 0;
                if (itemName === "Healing Potion") {
                    healAmount = 6;
                } else if (itemName === "Healing Salve") {
                    healAmount = 8;
                } else {
                    healAmount = 4;
                }
                
                const oldStamina = gameState.stamina;
                gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                const actualHeal = gameState.stamina - oldStamina;
                
                updateInventoryDisplay();
                updateStatsDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You use the ${itemName} and restore ${actualHeal} Stamina!</span></div>`;
            }
        }
        
        // Use Bloodstone Shard
        function useBloodstoneShard() {
            const shardIndex = gameState.inventory.indexOf("Bloodstone Shard");
            if (shardIndex !== -1) {
                gameState.inventory.splice(shardIndex, 1);
                updateInventoryDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You use the bloodstone shard! It disrupts nearby bloodstone magic, weakening any bloodstone creatures in the area.</span></div>`;
                
                gameState.bloodstoneWeakened = true;
            }
        }
        
        // Use Bloodstone Crystal
        function useBloodstoneCrystal() {
            const crystalIndex = gameState.inventory.indexOf("Bloodstone Crystal");
            if (crystalIndex !== -1) {
                gameState.inventory.splice(crystalIndex, 1);
                updateInventoryDisplay();
                
                const effect = rollDiceHelper(1, 6);
                let effectText = "";
                
                if (effect <= 2) {
                    gameState.stamina -= 5;
                    effectText = "The crystal's dark energy harms you! You lose 5 Stamina.";
                } else if (effect <= 4) {
                    gameState.skill += 1;
                    effectText = "You harness the crystal's power! Your Skill increases by 1!";
                } else {
                    gameState.luck += 2;
                    gameState.stamina += 4;
                    effectText = "The crystal grants you dark power! Luck +2, Stamina +4.";
                }
                
                updateStatsDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You channel the bloodstone crystal's energy... ${effectText}</span></div>`;
            }
        }
        
        // Use Teleportation Scroll
        function useTeleportationScroll() {
            const scrollIndex = gameState.inventory.indexOf("Teleportation Scroll");
            if (scrollIndex !== -1) {
                gameState.inventory.splice(scrollIndex, 1);
                updateInventoryDisplay();
                
                // Teleport to a random location in the keep
                const teleportLocations = [
                    {section: 10, description: "the outer courtyard"},
                    {section: 30, description: "the throne room"},
                    {section: 13, description: "the dungeon corridor"},
                    {section: 63, description: "the kitchen"},
                    {section: 16, description: "the battlements"}
                ];
                
                const location = teleportLocations[Math.floor(Math.random() * teleportLocations.length)];
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You activate the Teleportation Scroll! You vanish and reappear at ${location.description}.</span></div>`;
                
                setTimeout(() => {
                    loadSection(location.section);
                }, 1500);
            }
        }
        
        // Use Fireball Scroll
        function useFireballScroll() {
            const scrollIndex = gameState.inventory.indexOf("Scroll of Fireball");
            if (scrollIndex !== -1) {
                gameState.inventory.splice(scrollIndex, 1);
                updateInventoryDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You cast Fireball! If you're in combat, it deals 12 damage to all enemies!</span></div>`;
                
                // If in combat, deal damage
                if (combatState.active) {
                    combatState.enemyCurrentStamina -= 12;
                    if (combatState.enemyCurrentStamina <= 0) {
                        combatState.active = false;
                        const goldReward = Math.floor(Math.random() * 30) + 10;
                        gameState.gold += goldReward;
                        updateStatsDisplay();
                        
                        document.getElementById('story-text').innerHTML += 
                            `<div class="dice-roll"><span class="success">The fireball incinerates the ${combatState.enemyName}! You find ${goldReward} Gold.</span></div>`;
                        
                        setTimeout(() => {
                            loadSection(combatState.nextSection);
                        }, 2000);
                    }
                }
            }
        }
        
        // Use Healing Scroll
        function useHealingScroll() {
            const scrollIndex = gameState.inventory.indexOf("Scroll of Healing");
            if (scrollIndex !== -1) {
                gameState.inventory.splice(scrollIndex, 1);
                updateInventoryDisplay();
                
                const healAmount = 10;
                const oldStamina = gameState.stamina;
                gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                const actualHeal = gameState.stamina - oldStamina;
                
                updateStatsDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You cast the Healing Scroll and restore ${actualHeal} Stamina!</span></div>`;
            }
        }
        
        // Use Bloodstone Tome
        function useBloodstoneTome() {
            const tomeIndex = gameState.inventory.indexOf("Bloodstone Tome");
            if (tomeIndex !== -1) {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You read the Bloodstone Tome. It reveals that bloodstone draws power from suffering and can be weakened by disrupting its energy flow at multiple points. Destroying smaller crystals weakens the central one.</span></div>`;
            }
        }
        
        // Read Document
        function readDocument(docName) {
            let text = "";
            if (docName === "Guard's Journal") {
                text = "The journal mentions: 'The Lord grows weaker each day. The crystals dim. If someone were to strike now, they might succeed...'";
            } else if (docName === "Invasion Plans") {
                text = "The plans detail an invasion of the Ashen Wastes to expand the Bloodstone Lord's domain. The route through the wastes is marked.";
            }
            
            document.getElementById('story-text').innerHTML += 
                `<div class="dice-roll"><span class="success">You read ${docName}: "${text}"</span></div>`;
        }
        
        // Use Generic Item
        function useGenericItem(itemName) {
            const itemIndex = gameState.inventory.indexOf(itemName);
            if (itemIndex !== -1) {
                gameState.inventory.splice(itemIndex, 1);
                updateInventoryDisplay();
                
                let effectText = "";
                if (itemName.includes("Potion") || itemName.includes("Elixir")) {
                    const healAmount = rollDiceHelper(1, 4) + 2;
                    const oldStamina = gameState.stamina;
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                    const actualHeal = gameState.stamina - oldStamina;
                    effectText = `You use the ${itemName} and restore ${actualHeal} Stamina!`;
                    updateStatsDisplay();
                } else if (itemName.includes("Amulet") || itemName.includes("Charm")) {
                    gameState.luck += 1;
                    effectText = `You activate the ${itemName} and feel luckier! Luck +1`;
                    updateStatsDisplay();
                } else if (itemName.includes("Key")) {
                    effectText = `You examine the ${itemName}. It might unlock something important.`;
                    gameState.inventory.push(itemName);
                    updateInventoryDisplay();
                    return;
                } else {
                    effectText = `You use the ${itemName}.`;
                }
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">${effectText}</span></div>`;
            }
        }
        
        // Cancel Item Use
        function cancelItemUse() {
            document.getElementById('story-text').innerHTML += 
                `<div class="dice-roll">You decide not to use an item.</div>`;
        }
        
        // Check inventory
        function checkInventory() {
            let inventoryText = "<h3>Your Inventory:</h3>";
            
            if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                const weapon = gameState.weapons[gameState.currentWeaponIndex];
                inventoryText += `<p><strong>Equipped Weapon:</strong> ${weapon.name} (${weapon.damage} damage)</p>`;
            }
            
            inventoryText += "<p><strong>Available Weapons:</strong><br>";
            gameState.weapons.forEach((weapon, index) => {
                const isEquipped = index === gameState.currentWeaponIndex;
                inventoryText += `${isEquipped ? " " : ""}${weapon.name} (${weapon.damage})`;
                if (!isEquipped) {
                    inventoryText += ` <button onclick="equipWeapon(${index})" style="font-size:10px; padding:2px 5px;">Equip</button>`;
                }
                inventoryText += "<br>";
            });
            inventoryText += "</p>";
            
            inventoryText += "<p><strong>Armor:</strong><br>";
            gameState.armor.forEach((armor, index) => {
                const isEquipped = index === gameState.currentArmorIndex;
                inventoryText += `${isEquipped ? " " : ""}${armor.name} (${armor.defense} DEF)`;
                if (!isEquipped) {
                    inventoryText += ` <button onclick="equipArmor(${index})" style="font-size:10px; padding:2px 5px;">Equip</button>`;
                }
                inventoryText += "<br>";
            });
            inventoryText += "</p>";
            
            inventoryText += `<p><strong>Gold:</strong> ${gameState.gold}</p>`;
            
            if (gameState.inventory && gameState.inventory.length > 0) {
                inventoryText += `<p><strong>Usable Items:</strong><br>`;
                const usableItems = gameState.inventory.filter(item => {
                    const isWeapon = gameState.weapons.some(w => w.name === item);
                    const isArmor = gameState.armor.some(a => a.name === item);
                    return !isWeapon && !isArmor;
                });
                
                if (usableItems.length > 0) {
                    usableItems.forEach(item => {
                        inventoryText += `${item} `;
                        
                        if (item === "Healing Potion" || item === "Healing Salve") {
                            inventoryText += `<button onclick="useHealingItem('${item}')" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Bloodstone Shard") {
                            inventoryText += `<button onclick="useBloodstoneShard()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Bloodstone Crystal") {
                            inventoryText += `<button onclick="useBloodstoneCrystal()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Teleportation Scroll") {
                            inventoryText += `<button onclick="useTeleportationScroll()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Scroll of Fireball") {
                            inventoryText += `<button onclick="useFireballScroll()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Scroll of Healing") {
                            inventoryText += `<button onclick="useHealingScroll()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Bloodstone Tome") {
                            inventoryText += `<button onclick="useBloodstoneTome()" style="font-size:10px; padding:2px 5px;">Read</button>`;
                        } else if (item === "Guard's Journal" || item === "Invasion Plans") {
                            inventoryText += `<button onclick="readDocument('${item}')" style="font-size:10px; padding:2px 5px;">Read</button>`;
                        } else {
                            inventoryText += `<button onclick="useGenericItem('${item}')" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        }
                        
                        inventoryText += `<br>`;
                    });
                } else {
                    inventoryText += "None";
                }
                inventoryText += `</p>`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${inventoryText}</div>`;
        }
        
        // Equip weapon function
        function equipWeapon(index) {
            if (index >= 0 && index < gameState.weapons.length) {
                gameState.currentWeaponIndex = index;
                updateInventoryDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped ${gameState.weapons[index].name}!</div>`;
                saveGame();
            }
        }
        
        // Equip armor function
        function equipArmor(index) {
            if (index >= 0 && index < gameState.armor.length) {
                gameState.currentArmorIndex = index;
                updateInventoryDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped ${gameState.armor[index].name}!</div>`;
                saveGame();
            }
        }
        
        // Save game
        function saveGame() {
            if (gameState.currentWeaponIndex >= gameState.weapons.length) {
                gameState.currentWeaponIndex = gameState.weapons.length - 1;
            }
            if (gameState.currentArmorIndex >= gameState.armor.length) {
                gameState.currentArmorIndex = gameState.armor.length - 1;
            }
            
            localStorage.setItem('dreadwoodGameState', JSON.stringify(gameState));
        }
        
        // Go to next level (Ashen Wastes - level5.html)
        function goToNextLevel() {
            localStorage.setItem('dreadwoodGameState', JSON.stringify(gameState));
            window.location.href = 'level5.html';
        }
        
        // Utility function to roll dice
        function rollDiceHelper(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
    </script>
</body>
</html>
