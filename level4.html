<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DreadWood: Bloodstone Keep</title>
    <style>
        /* EXACT SAME STYLE as previous levels */
        body {
            font-family: 'Courier New', monospace;
            background-color: #0a0a2a;
            color: #33ff33;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            border: 2px solid #33ff33;
            background-color: #000;
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #33ff33;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #ff33ff;
            text-shadow: 0 0 5px #ff33ff;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
        }
        
        h2 {
            color: #33ccff;
            border-bottom: 1px solid #33ccff;
            padding-bottom: 5px;
            margin-top: 25px;
        }
        
        .screen {
            display: none;
        }
        
        .active-screen {
            display: block;
        }
        
        .stats-bar {
            background-color: #111133;
            border: 1px solid #33ff33;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-value {
            color: #ffff33;
            font-weight: bold;
        }
        
        .inventory {
            background-color: #111122;
            border: 1px solid #ff33ff;
            padding: 10px;
            margin: 15px 0;
            min-height: 60px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222244;
            border: 1px solid #33ccff;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
        }
        
        .story-text {
            background-color: #111111;
            border: 1px solid #33ff33;
            padding: 15px;
            margin: 20px 0;
            min-height: 150px;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222244;
            color: #33ff33;
            border: 2px solid #33ff33;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333366;
            color: #ffff33;
            border-color: #ffff33;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #330033;
            color: #ff33ff;
            border: 2px solid #ff33ff;
            padding: 10px 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #550055;
            color: #ff99ff;
        }
        
        .dice-roll {
            background-color: #223322;
            border: 1px solid #33ff33;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ffff33;
        }
        
        .game-over {
            color: #ff3333;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #ff3333;
        }
        
        .success {
            color: #33ff33;
            font-weight: bold;
        }
        
        .damage {
            color: #ff3333;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9933;
            font-weight: bold;
        }
        
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #003333;
            color: #33ff99;
            border: 2px solid #33ff99;
            padding: 15px 30px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #005555;
            color: #99ffcc;
        }
        
        .retro-notice {
            text-align: center;
            color: #888888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333333;
            padding-top: 10px;
        }
        
        .warning-dialog {
            background-color: #332222;
            border: 2px solid #ff3333;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .warning-text {
            color: #ff9933;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .dialog-btn {
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid;
        }
        
        .dialog-btn-yes {
            background-color: #223322;
            color: #33ff33;
            border-color: #33ff33;
        }
        
        .dialog-btn-no {
            background-color: #332222;
            color: #ff3333;
            border-color: #ff3333;
        }
        
        .bloodstone-decoration {
            color: #cc3333;
            font-style: italic;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 10px;
                font-size: 14px;
            }
            
            .dialog-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DREADWOOD</h1>
            <h2>BLOODSTONE KEEP</h2>
            <div class="retro-notice">Level 4 - Your Adventure Continues</div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item">SKILL: <span id="stat-skill" class="stat-value">0</span></div>
                <div class="stat-item">STAMINA: <span id="stat-stamina" class="stat-value">0</span>/<span id="stat-maxstamina" class="stat-value">0</span></div>
                <div class="stat-item">LUCK: <span id="stat-luck" class="stat-value">0</span></div>
                <div class="stat-item">GOLD: <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <h2>INVENTORY</h2>
            <div class="inventory" id="inventory">
                <!-- Inventory will be loaded from saved game -->
            </div>
            
            <h2>THE ADVENTURE</h2>
            <div class="story-text" id="story-text">
                <p>You stand before the ominous <span class="bloodstone-decoration">BLOODSTONE KEEP</span>, a fortress of dark crimson stone that seems to bleed in the fading light. The air is heavy with ancient magic and the scent of iron. Your journey has brought you to this cursed place, and now you must enter...</p>
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <button class="choice-btn" onclick="loadSection(1)">Approach the main gate</button>
                <button class="choice-btn" onclick="loadSection(2)">Search for a secret entrance</button>
                <button class="choice-btn" onclick="loadSection(3)">Climb the outer wall</button>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useLuck()">TEST LUCK</button>
                <button class="action-btn" onclick="checkInventory()">INVENTORY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="showNewGameWarning()">START NEW GAME</button>
            </div>
        </div>
        
        <!-- Warning Dialog for New Game -->
        <div id="warning-dialog" class="screen">
            <div class="warning-dialog">
                <div class="warning-text">WARNING: Starting a new game will delete ALL your current progress!</div>
                <p>Your current character, stats, inventory, and gold will be permanently erased.</p>
                <p>You will return to the beginning of the game to create a new character.</p>
                <div class="dialog-buttons">
                    <button class="dialog-btn dialog-btn-yes" onclick="startNewGame()">YES, START NEW GAME</button>
                    <button class="dialog-btn dialog-btn-no" onclick="cancelNewGame()">NO, KEEP MY CHARACTER</button>
                </div>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>VICTORY!</h2>
            <div class="story-text">
                <p>You have conquered <span class="bloodstone-decoration">BLOODSTONE KEEP</span>!</p>
                <p>After navigating its treacherous halls and defeating its guardians, you emerge victorious. Beyond the keep stretches the <span class="enemy">ASHEN WASTES</span>, a desolate landscape of ash and ruin where few have dared to tread.</p>
                <p>Your journey continues... All your stats, gold, and inventory will carry over to the next chapter.</p>
                <div class="stats-bar">
                    <div class="stat-item">SKILL: <span id="next-stat-skill" class="stat-value">0</span></div>
                    <div class="stat-item">STAMINA: <span id="next-stat-stamina" class="stat-value">0</span></div>
                    <div class="stat-item">LUCK: <span id="next-stat-luck" class="stat-value">0</span></div>
                    <div class="stat-item">GOLD: <span id="next-stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO ASHEN WASTES</button>
            </div>
        </div>
        
        <div class="retro-notice">
            DREADWOOD - A Retro Gamebook Adventure<br>
            Level 4: Bloodstone Keep
        </div>
    </div>

    <script>
        // Game state (loaded from localStorage)
        let gameState = JSON.parse(localStorage.getItem('dreadwoodGameState')) || {
            playerClass: 'warrior',
            skill: 10,
            maxStamina: 18,
            stamina: 18,
            luck: 10,
            gold: 20,
            inventory: ['Dagger', 'Leather Armor'],
            weapons: [{name: 'Dagger', damage: '1d6'}],
            armor: [{name: 'Leather Armor', defense: 1}],
            currentWeaponIndex: 0,
            currentArmorIndex: 0,
            currentSection: 0,
            gameComplete: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyStamina: 0,
            enemyCurrentStamina: 0,
            enemySkill: 0,
            nextSection: 0,
            round: 1
        };
        
        // Reset currentSection when starting a new level
        if (gameState.currentSection === 200 || gameState.gameComplete) {
            gameState.currentSection = 0;
            gameState.gameComplete = false;
        }
        
        // Ensure indices exist
        if (gameState.currentWeaponIndex === undefined) {
            gameState.currentWeaponIndex = gameState.weapons.length - 1;
        }
        if (gameState.currentArmorIndex === undefined) {
            gameState.currentArmorIndex = gameState.armor.length - 1;
        }
        
        // Level 4 story sections - BLOODSTONE KEEP
        const storySections = {
            0: {
                text: "You stand before the ominous <span class='bloodstone-decoration'>BLOODSTONE KEEP</span>, a fortress of dark crimson stone that seems to bleed in the fading light. The air is heavy with ancient magic and the scent of iron. Your journey has brought you to this cursed place, and now you must enter...",
                choices: [
                    {text: "Approach the main gate", nextSection: 1, skillCheck: false},
                    {text: "Search for a secret entrance", nextSection: 2, skillCheck: false},
                    {text: "Climb the outer wall", nextSection: 3, skillCheck: false}
                ]
            },
            1: {
                text: "You approach the massive iron-banded gates of Bloodstone Keep. Two stone gargoyles flank the entrance, their eyes glowing with red light. As you get closer, they animate and step forward to block your path!",
                choices: [
                    {text: "Fight the stone gargoyles", nextSection: 101, skillCheck: false},
                    {text: "Try to reason with them", nextSection: 4, skillCheck: true, checkType: 'luck', difficulty: 12},
                    {text: "Look for another way in", nextSection: 2, skillCheck: false}
                ]
            },
            101: {
                text: "You face the Stone Gargoyles! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 102, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Stone Gargoyles";
                    combatState.enemyStamina = 16;
                    combatState.enemyCurrentStamina = 16;
                    combatState.enemySkill = 10;
                    combatState.nextSection = 5;
                    combatState.round = 1;
                    
                    return "Stone Gargoyles: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            2: {
                text: "You search along the keep's outer wall. The stones are rough and ancient, covered in moss and strange runes. You find what appears to be a drainage grate leading inside.",
                choices: [
                    {text: "Enter through the drainage grate", nextSection: 6, skillCheck: false},
                    {text: "Continue searching", nextSection: 7, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Return to the main gate", nextSection: 1, skillCheck: false}
                ]
            },
            3: {
                text: "You attempt to climb the outer wall. The bloodstone is slippery and cold to the touch. About halfway up, you notice a window ledge just within reach.",
                choices: [
                    {text: "Climb to the window", nextSection: 8, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Continue climbing to the top", nextSection: 9, skillCheck: false},
                    {text: "Climb back down", nextSection: 0, skillCheck: false}
                ]
            },
            4: {
                text: window.checkResult ? 
                    "'We guard the keep from intruders,' one gargoyle rumbles. 'But you carry the mark of destiny. You may pass.' The gates creak open." : 
                    "'Intruder!' the gargoyles roar. 'The Blood Lord will feast on your soul!' They attack!",
                choices: [
                    window.checkResult ? 
                        {text: "Enter the keep", nextSection: 10, skillCheck: false} :
                        {text: "Fight the gargoyles", nextSection: 101, skillCheck: false}
                ]
            },
            5: {
                text: "After defeating the gargoyles, their stone forms crumble to dust. The main gates swing open, revealing the courtyard of Bloodstone Keep.",
                choices: [
                    {text: "Enter the courtyard", nextSection: 10, skillCheck: false}
                ]
            },
            6: {
                text: "You squeeze through the drainage grate into a dark, damp passage. The air smells of mildew and something metallic. You can hear dripping water echoing ahead.",
                choices: [
                    {text: "Follow the passage forward", nextSection: 11, skillCheck: false},
                    {text: "Light a torch", nextSection: 12, skillCheck: false},
                    {text: "Go back outside", nextSection: 0, skillCheck: false}
                ]
            },
            7: {
                text: window.checkResult ? 
                    "You find a hidden door covered in ivy! It's unlocked and leads into the keep's lower levels." : 
                    "You search thoroughly but find nothing else of interest.",
                choices: [
                    window.checkResult ? 
                        {text: "Enter through the hidden door", nextSection: 13, skillCheck: false} :
                        {text: "Try the drainage grate", nextSection: 6, skillCheck: false}
                ]
            },
            8: {
                text: window.checkResult ? 
                    "You successfully climb to the window and slip inside. You find yourself in a dusty library filled with ancient tomes." : 
                    "You slip and fall! You take 4 damage from the fall.",
                choices: [
                    window.checkResult ? 
                        {text: "Explore the library", nextSection: 14, skillCheck: false} :
                        {text: "Try again or go back", nextSection: 3, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult) {
                        gameState.stamina -= 4;
                        updateStatsDisplay();
                    }
                }
            },
            9: {
                text: "You climb to the top of the wall. From here, you can see the entire keep layout. You spot a guard patrol below and a way down into a secluded garden.",
                choices: [
                    {text: "Climb down into the garden", nextSection: 15, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Wait for the patrol to pass", nextSection: 16, skillCheck: false},
                    {text: "Try to drop onto a lower rooftop", nextSection: 17, skillCheck: false}
                ]
            },
            10: {
                text: "You enter the courtyard of Bloodstone Keep. The ground is paved with stones that seem to pulse with faint crimson light. Ahead, you see three possible ways forward: the main keep doors, a barracks building, and a chapel with stained glass windows.",
                choices: [
                    {text: "Enter the main keep", nextSection: 18, skillCheck: false},
                    {text: "Investigate the barracks", nextSection: 19, skillCheck: false},
                    {text: "Explore the chapel", nextSection: 20, skillCheck: false}
                ]
            },
            11: {
                text: "You follow the dark passage. It leads to a wine cellar filled with dusty bottles and casks. You hear footsteps above you.",
                choices: [
                    {text: "Search the wine cellar", nextSection: 21, skillCheck: false},
                    {text: "Climb the stairs to the upper level", nextSection: 22, skillCheck: false},
                    {text: "Hide and listen", nextSection: 23, skillCheck: false}
                ]
            },
            12: {
                text: "You light a torch. The passage is revealed to be an old smuggler's tunnel with several side passages branching off.",
                choices: [
                    {text: "Take the left passage", nextSection: 24, skillCheck: false},
                    {text: "Take the right passage", nextSection: 25, skillCheck: false},
                    {text: "Continue straight ahead", nextSection: 11, skillCheck: false}
                ]
            },
            13: {
                text: "The hidden door leads to a secret room filled with ancient weapons and armor. In the center of the room stands a suit of blood-red plate mail on a stand.",
                choices: [
                    {text: "Examine the blood-red armor", nextSection: 26, skillCheck: false},
                    {text: "Search the weapon racks", nextSection: 27, skillCheck: false},
                    {text: "Leave the room and explore", nextSection: 28, skillCheck: false}
                ]
            },
            14: {
                text: "The library is vast and ancient. Dusty tomes line the walls, and a massive stained glass window depicts a blood-red sun. On a central table, you find an open book with glowing text.",
                choices: [
                    {text: "Read the glowing book", nextSection: 29, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Search the bookshelves", nextSection: 30, skillCheck: false},
                    {text: "Leave the library", nextSection: 31, skillCheck: false}
                ]
            },
            15: {
                text: window.checkResult ? 
                    "You climb down safely into the secluded garden. Strange blood-red flowers bloom here, and a fountain in the center runs with crimson liquid." : 
                    "You slip during the climb and take 3 damage landing in the garden.",
                choices: [
                    {text: "Examine the fountain", nextSection: 32, skillCheck: false},
                    {text: "Pick one of the strange flowers", nextSection: 33, skillCheck: false},
                    {text: "Leave the garden", nextSection: 34, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult) {
                        gameState.stamina -= 3;
                        updateStatsDisplay();
                    }
                }
            },
            16: {
                text: "You wait on the wall until the guard patrol passes. Once they're gone, you climb down safely into the courtyard.",
                choices: [
                    {text: "Explore the courtyard", nextSection: 10, skillCheck: false}
                ]
            },
            17: {
                text: "You drop onto a lower rooftop. The tiles are slippery, and you make some noise. Below, you hear guards shouting!",
                choices: [
                    {text: "Hide on the rooftop", nextSection: 35, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Jump down and fight", nextSection: 36, skillCheck: false},
                    {text: "Run across the rooftops", nextSection: 37, skillCheck: false}
                ]
            },
            18: {
                text: "The main keep doors are massive and carved with scenes of battle. As you enter, you find yourself in a grand hall. Tapestries depicting blood rituals line the walls, and at the far end sits a throne made of bones.",
                choices: [
                    {text: "Examine the bone throne", nextSection: 38, skillCheck: false},
                    {text: "Search the tapestries", nextSection: 39, skillCheck: false},
                    {text: "Take the left corridor", nextSection: 40, skillCheck: false},
                    {text: "Take the right corridor", nextSection: 41, skillCheck: false}
                ]
            },
            19: {
                text: "The barracks are empty but recently used. Beds are unmade, and weapons lean against the walls. You hear voices approaching from outside!",
                choices: [
                    {text: "Hide in the barracks", nextSection: 42, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Prepare to fight", nextSection: 43, skillCheck: false},
                    {text: "Escape through a window", nextSection: 44, skillCheck: false}
                ]
            },
            20: {
                text: "The chapel is eerily silent. Stained glass windows filter the light into blood-red patterns on the stone floor. An altar at the front bears a crystalline heart that pulses with crimson light.",
                choices: [
                    {text: "Approach the altar", nextSection: 45, skillCheck: false},
                    {text: "Examine the stained glass", nextSection: 46, skillCheck: false},
                    {text: "Search the pews", nextSection: 47, skillCheck: false}
                ]
            },
            21: {
                text: "You search the wine cellar and find several valuable bottles, some ancient coins, and a trap door in the floor.",
                choices: [
                    {text: "Take the valuable bottles (worth 50 Gold)", nextSection: 48, skillCheck: false},
                    {text: "Open the trap door", nextSection: 49, skillCheck: false},
                    {text: "Go upstairs", nextSection: 22, skillCheck: false}
                ]
            },
            22: {
                text: "You climb the stairs to the upper level and find yourself in a kitchen. A cook is preparing a meal, her back to you.",
                choices: [
                    {text: "Sneak past the cook", nextSection: 50, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Talk to the cook", nextSection: 51, skillCheck: false},
                    {text: "Attack the cook", nextSection: 52, skillCheck: false}
                ]
            },
            23: {
                text: "You hide and listen to the footsteps above. You hear two guards talking: 'The Blood Lord expects new sacrifices tonight. The dungeons must be prepared.'",
                choices: [
                    {text: "Follow the guards", nextSection: 53, skillCheck: false},
                    {text: "Search the cellar", nextSection: 21, skillCheck: false},
                    {text: "Go upstairs", nextSection: 22, skillCheck: false}
                ]
            },
            24: {
                text: "The left passage leads to a dead end with a skeletal hand clutching a rusty key.",
                choices: [
                    {text: "Take the key", nextSection: 54, skillCheck: false},
                    {text: "Return to the main passage", nextSection: 12, skillCheck: false}
                ]
            },
            25: {
                text: "The right passage slopes upward and leads to a grate that looks into the courtyard. You can see guards patrolling.",
                choices: [
                    {text: "Wait and observe", nextSection: 55, skillCheck: false},
                    {text: "Try to open the grate", nextSection: 56, skillCheck: false},
                    {text: "Return to the main passage", nextSection: 12, skillCheck: false}
                ]
            },
            26: {
                text: "The blood-red armor seems to be magical. As you touch it, visions flash through your mind: battles, blood rituals, and a dark lord ruling from a crimson throne.",
                choices: [
                    {text: "Put on the armor", nextSection: 57, skillCheck: false},
                    {text: "Leave it alone", nextSection: 27, skillCheck: false}
                ]
            },
            27: {
                text: "You search the weapon racks and find several excellent weapons: a bloodsteel sword, a rune-etched axe, and a crystal-tipped spear.",
                choices: [
                    {text: "Take the bloodsteel sword", nextSection: 58, skillCheck: false},
                    {text: "Take the rune-etched axe", nextSection: 59, skillCheck: false},
                    {text: "Take the crystal-tipped spear", nextSection: 60, skillCheck: false},
                    {text: "Leave the weapons", nextSection: 28, skillCheck: false}
                ]
            },
            28: {
                text: "You leave the secret room and find yourself in a corridor leading deeper into the keep. Torches in iron sconces light the way.",
                choices: [
                    {text: "Follow the corridor", nextSection: 61, skillCheck: false},
                    {text: "Return to the secret room", nextSection: 13, skillCheck: false}
                ]
            },
            29: {
                text: window.checkResult ? 
                    "The book is titled 'The Blood Lord's Rituals.' You learn that the keep's power comes from a Bloodstone Heart in the deepest chamber. The book also contains a warding spell against blood magic." : 
                    "The text is in an ancient language you can't decipher. The glowing letters make your head ache.",
                choices: [
                    {text: "Search the bookshelves", nextSection: 30, skillCheck: false},
                    {text: "Leave the library", nextSection: 31, skillCheck: false}
                ]
            },
            30: {
                text: "You search the bookshelves and find a hidden compartment containing a scroll of dispel magic and a bag of gold coins.",
                choices: [
                    {text: "Take the scroll and gold", nextSection: 62, skillCheck: false},
                    {text: "Continue searching", nextSection: 63, skillCheck: false},
                    {text: "Leave the library", nextSection: 31, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Scroll of Dispel Magic");
                    gameState.gold += 30;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                }
            },
            31: {
                text: "You leave the library and enter a hallway. To your left, you hear chanting. To your right, you hear the clash of weapons.",
                choices: [
                    {text: "Investigate the chanting", nextSection: 64, skillCheck: false},
                    {text: "Investigate the weapon sounds", nextSection: 65, skillCheck: false},
                    {text: "Find stairs going down", nextSection: 66, skillCheck: false}
                ]
            },
            32: {
                text: "The fountain runs with crimson liquid that smells of iron and magic. The basin is carved with runes that glow faintly.",
                choices: [
                    {text: "Drink from the fountain", nextSection: 67, skillCheck: false},
                    {text: "Read the runes", nextSection: 68, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Leave the garden", nextSection: 34, skillCheck: false}
                ]
            },
            33: {
                text: "You pick one of the blood-red flowers. It pulses in your hand as if alive.",
                choices: [
                    {text: "Eat the flower", nextSection: 69, skillCheck: false},
                    {text: "Keep it", nextSection: 70, skillCheck: false},
                    {text: "Leave it", nextSection: 34, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Bloodbloom Flower");
                    updateInventoryDisplay();
                }
            },
            34: {
                text: "You leave the garden through an archway and find yourself in the main courtyard.",
                choices: [
                    {text: "Enter the main keep", nextSection: 18, skillCheck: false},
                    {text: "Go to the barracks", nextSection: 19, skillCheck: false},
                    {text: "Enter the chapel", nextSection: 20, skillCheck: false}
                ]
            },
            35: {
                text: window.checkResult ? 
                    "You successfully hide as the guards pass below. Once they're gone, you climb down safely." : 
                    "The guards spot you! 'Intruder on the roof!'",
                choices: [
                    window.checkResult ? 
                        {text: "Climb down and explore", nextSection: 71, skillCheck: false} :
                        {text: "Fight the guards", nextSection: 36, skillCheck: false}
                ]
            },
            36: {
                text: "You jump down to face the guards! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 3601, skillCheck: false}
                ]
            },
            3601: {
                text: "You face the Keep Guards! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 3602, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Keep Guards";
                    combatState.enemyStamina = 14;
                    combatState.enemyCurrentStamina = 14;
                    combatState.enemySkill = 9;
                    combatState.nextSection = 72;
                    combatState.round = 1;
                    
                    return "Keep Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            37: {
                text: "You run across the rooftops, leaping from building to building. You come to a tower with an open window.",
                choices: [
                    {text: "Enter through the window", nextSection: 73, skillCheck: false},
                    {text: "Continue running", nextSection: 74, skillCheck: false},
                    {text: "Climb down", nextSection: 75, skillCheck: false}
                ]
            },
            38: {
                text: "The bone throne is made from hundreds of skeletons fused together. A crown of blood-red crystals rests on the seat. As you approach, ghostly whispers fill the air.",
                choices: [
                    {text: "Take the crystal crown", nextSection: 76, skillCheck: false},
                    {text: "Search behind the throne", nextSection: 77, skillCheck: false},
                    {text: "Leave the throne alone", nextSection: 78, skillCheck: false}
                ]
            },
            39: {
                text: "The tapestries depict the history of Bloodstone Keep and its rulers. The most recent shows a sorcerer called the Blood Lord performing a ritual with a glowing red stone.",
                choices: [
                    {text: "Study the ritual tapestry", nextSection: 79, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Search for hidden doors", nextSection: 80, skillCheck: false},
                    {text: "Return to examining the hall", nextSection: 18, skillCheck: false}
                ]
            },
            40: {
                text: "The left corridor leads to the keep's living quarters. Doors line the hallway, some slightly ajar.",
                choices: [
                    {text: "Search the first room", nextSection: 81, skillCheck: false},
                    {text: "Search the second room", nextSection: 82, skillCheck: false},
                    {text: "Continue down the hallway", nextSection: 83, skillCheck: false}
                ]
            },
            41: {
                text: "The right corridor leads downward into darkness. The air grows colder with each step, and you hear faint moaning from below.",
                choices: [
                    {text: "Continue downward", nextSection: 84, skillCheck: false},
                    {text: "Light a torch", nextSection: 85, skillCheck: false},
                    {text: "Go back", nextSection: 18, skillCheck: false}
                ]
            },
            42: {
                text: window.checkResult ? 
                    "You successfully hide as two guards enter the barracks, grab some weapons, and leave without noticing you." : 
                    "The guards spot you hiding! 'Intruder!'",
                choices: [
                    window.checkResult ? 
                        {text: "Search the barracks after they leave", nextSection: 86, skillCheck: false} :
                        {text: "Fight the guards", nextSection: 43, skillCheck: false}
                ]
            },
            43: {
                text: "You prepare to fight the approaching guards!",
                choices: [
                    {text: "Begin the battle!", nextSection: 4301, skillCheck: false}
                ]
            },
            4301: {
                text: "You face the Barracks Guards! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 4302, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Barracks Guards";
                    combatState.enemyStamina = 12;
                    combatState.enemyCurrentStamina = 12;
                    combatState.enemySkill = 8;
                    combatState.nextSection = 87;
                    combatState.round = 1;
                    
                    return "Barracks Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            44: {
                text: "You escape through a window and drop into the courtyard below, taking 2 damage from the fall.",
                choices: [
                    {text: "Enter the main keep", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina -= 2;
                    updateStatsDisplay();
                }
            },
            45: {
                text: "As you approach the altar, the crystalline heart pulses brighter. A voice echoes in your mind: 'Do you seek power or salvation?'",
                choices: [
                    {text: "Take the heart", nextSection: 88, skillCheck: false},
                    {text: "Destroy the heart", nextSection: 89, skillCheck: false},
                    {text: "Ignore it and leave", nextSection: 90, skillCheck: false}
                ]
            },
            46: {
                text: "The stained glass windows tell a story: a meteor of red crystal fell from the sky, a sorcerer claimed it, and he built this keep around it to harness its power.",
                choices: [
                    {text: "Examine the altar", nextSection: 45, skillCheck: false},
                    {text: "Search for secret passages", nextSection: 91, skillCheck: false},
                    {text: "Leave the chapel", nextSection: 90, skillCheck: false}
                ]
            },
            47: {
                text: "You search the pews and find a prayer book with a hidden compartment containing a silver holy symbol and 25 Gold.",
                choices: [
                    {text: "Take the holy symbol and gold", nextSection: 92, skillCheck: false},
                    {text: "Leave them", nextSection: 90, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Silver Holy Symbol");
                    gameState.gold += 25;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                }
            },
            48: {
                text: "You take the valuable bottles worth 50 Gold.",
                choices: [
                    {text: "Open the trap door", nextSection: 49, skillCheck: false},
                    {text: "Go upstairs", nextSection: 22, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 50;
                    updateStatsDisplay();
                }
            },
            49: {
                text: "The trap door leads down into complete darkness. A foul smell wafts up from below.",
                choices: [
                    {text: "Climb down into the darkness", nextSection: 93, skillCheck: false},
                    {text: "Close it and go upstairs", nextSection: 22, skillCheck: false}
                ]
            },
            50: {
                text: window.checkResult ? 
                    "You successfully sneak past the cook and enter a hallway beyond the kitchen." : 
                    "You knock over a pot! The cook turns and sees you!",
                choices: [
                    window.checkResult ? 
                        {text: "Explore the hallway", nextSection: 94, skillCheck: false} :
                        {text: "Talk to the cook", nextSection: 51, skillCheck: false}
                ]
            },
            51: {
                text: "The cook turns, surprised. 'You're not supposed to be here! The Blood Lord doesn't like uninvited guests.' She seems nervous rather than hostile.",
                choices: [
                    {text: "Ask about the Blood Lord", nextSection: 95, skillCheck: false},
                    {text: "Ask for a way out", nextSection: 96, skillCheck: false},
                    {text: "Attack her", nextSection: 52, skillCheck: false}
                ]
            },
            52: {
                text: "You attack the cook! She grabs a meat cleaver and fights back!",
                choices: [
                    {text: "Begin the battle!", nextSection: 5201, skillCheck: false}
                ]
            },
            5201: {
                text: "You face the Keep Cook! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 5202, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Keep Cook";
                    combatState.enemyStamina = 10;
                    combatState.enemyCurrentStamina = 10;
                    combatState.enemySkill = 7;
                    combatState.nextSection = 97;
                    combatState.round = 1;
                    
                    return "Keep Cook: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            53: {
                text: "You follow the guards through a secret door in the wine cellar wall. They lead you to the dungeons.",
                choices: [
                    {text: "Continue following at a distance", nextSection: 98, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Attack the guards", nextSection: 99, skillCheck: false},
                    {text: "Wait and explore the dungeons later", nextSection: 100, skillCheck: false}
                ]
            },
            54: {
                text: "You take the rusty key from the skeletal hand. The hand crumbles to dust.",
                choices: [
                    {text: "Return to the main passage", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Rusty Skeleton Key");
                    updateInventoryDisplay();
                }
            },
            55: {
                text: "You watch the guards patrol. They follow a specific pattern and occasionally check a particular door more carefully than others.",
                choices: [
                    {text: "Try to open the grate", nextSection: 56, skillCheck: false},
                    {text: "Return to the main passage", nextSection: 12, skillCheck: false}
                ]
            },
            56: {
                text: "The grate is locked from the outside, but you might be able to force it open.",
                choices: [
                    {text: "Try to force it open", nextSection: 101, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Return to the main passage", nextSection: 12, skillCheck: false}
                ]
            },
            57: {
                text: "You put on the blood-red armor. It fits perfectly and hums with power. You feel stronger but also a dark temptation.",
                choices: [
                    {text: "Keep the armor on", nextSection: 102, skillCheck: false},
                    {text: "Take it off", nextSection: 103, skillCheck: false}
                ],
                action: function() {
                    gameState.armor.push({name: 'Bloodsteel Plate', defense: 4});
                    gameState.currentArmorIndex = gameState.armor.length - 1;
                    gameState.skill += 1;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                }
            },
            58: {
                text: "You take the bloodsteel sword. It's warm to the touch and seems to thirst for battle.",
                choices: [
                    {text: "Leave the room", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    gameState.weapons.push({name: 'Bloodsteel Sword', damage: '2d6'});
                    updateInventoryDisplay();
                }
            },
            59: {
                text: "You take the rune-etched axe. The runes glow with blue light as you hold it.",
                choices: [
                    {text: "Leave the room", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    gameState.weapons.push({name: 'Rune-Etched Axe', damage: '1d6+3'});
                    updateInventoryDisplay();
                }
            },
            60: {
                text: "You take the crystal-tipped spear. The crystal glows with inner light.",
                choices: [
                    {text: "Leave the room", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    gameState.weapons.push({name: 'Crystal-Tipped Spear', damage: '1d8+2'});
                    updateInventoryDisplay();
                }
            },
            61: {
                text: "The corridor leads to a guard post. Two guards are playing dice, their weapons leaning against the wall.",
                choices: [
                    {text: "Sneak past them", nextSection: 104, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Attack them", nextSection: 105, skillCheck: false},
                    {text: "Join their game", nextSection: 106, skillCheck: false}
                ]
            },
            62: {
                text: "You take the scroll of dispel magic and the gold. These could be useful.",
                choices: [
                    {text: "Leave the library", nextSection: 31, skillCheck: false}
                ]
            },
            63: {
                text: "You continue searching and find a secret door behind a bookshelf!",
                choices: [
                    {text: "Enter the secret door", nextSection: 107, skillCheck: false},
                    {text: "Leave the library", nextSection: 31, skillCheck: false}
                ]
            },
            64: {
                text: "You follow the chanting to a room where cultists in red robes are performing a ritual around a blood-filled basin.",
                choices: [
                    {text: "Attack the cultists", nextSection: 6401, skillCheck: false},
                    {text: "Observe from hiding", nextSection: 108, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Try to disrupt the ritual", nextSection: 109, skillCheck: false}
                ]
            },
            6401: {
                text: "You face the Blood Cultists! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 6402, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Blood Cultists";
                    combatState.enemyStamina = 18;
                    combatState.enemyCurrentStamina = 18;
                    combatState.enemySkill = 9;
                    combatState.nextSection = 110;
                    combatState.round = 1;
                    
                    return "Blood Cultists: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            65: {
                text: "You follow the weapon sounds to a training room where guards are sparring. Weapons of all kinds line the walls.",
                choices: [
                    {text: "Challenge one to a duel", nextSection: 111, skillCheck: false},
                    {text: "Steal a weapon", nextSection: 112, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Leave quietly", nextSection: 113, skillCheck: false}
                ]
            },
            66: {
                text: "You find stairs going down. The air grows colder and carries the scent of damp stone and something metallic.",
                choices: [
                    {text: "Descend the stairs", nextSection: 114, skillCheck: false},
                    {text: "Go back", nextSection: 31, skillCheck: false}
                ]
            },
            67: {
                text: "You drink from the crimson fountain. The liquid is sweet and metallic. You feel a surge of power! Your Skill increases by 2, but you also feel a dark craving.",
                choices: [
                    {text: "Leave the garden", nextSection: 34, skillCheck: false}
                ],
                action: function() {
                    gameState.skill += 2;
                    updateStatsDisplay();
                }
            },
            68: {
                text: window.checkResult ? 
                    "The runes are a warning: 'The blood gives power but demands sacrifice. Drink not unless prepared to pay the price.'" : 
                    "The runes are in an ancient language you can't read.",
                choices: [
                    {text: "Drink from the fountain anyway", nextSection: 67, skillCheck: false},
                    {text: "Leave the garden", nextSection: 34, skillCheck: false}
                ]
            },
            69: {
                text: "You eat the blood-red flower. Immediately, you feel intense pain as your veins burn with fire! You lose 8 Stamina, but your Luck increases by 3.",
                choices: [
                    {text: "Leave the garden", nextSection: 34, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina -= 8;
                    gameState.luck += 3;
                    updateStatsDisplay();
                }
            },
            70: {
                text: "You keep the blood-red flower. It might be useful later.",
                choices: [
                    {text: "Leave the garden", nextSection: 34, skillCheck: false}
                ]
            },
            71: {
                text: "You climb down from the rooftop and find yourself in a secluded part of the courtyard near the chapel.",
                choices: [
                    {text: "Enter the chapel", nextSection: 20, skillCheck: false},
                    {text: "Enter the main keep", nextSection: 18, skillCheck: false}
                ]
            },
            72: {
                text: "After defeating the guards, you search them and find a key to the armory and 20 Gold.",
                choices: [
                    {text: "Take the key and gold", nextSection: 115, skillCheck: false},
                    {text: "Continue exploring", nextSection: 116, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Armory Key");
                    gameState.gold += 20;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                }
            },
            73: {
                text: "You enter through the window into a wizard's study. Books and alchemical equipment cover every surface. A large crystal ball dominates the center of the room.",
                choices: [
                    {text: "Examine the crystal ball", nextSection: 117, skillCheck: false},
                    {text: "Search the books", nextSection: 118, skillCheck: false},
                    {text: "Take some alchemical ingredients", nextSection: 119, skillCheck: false}
                ]
            },
            74: {
                text: "You continue running across the rooftops until you reach the main keep's roof. There's a skylight here looking down into the throne room.",
                choices: [
                    {text: "Look through the skylight", nextSection: 120, skillCheck: false},
                    {text: "Try to open the skylight", nextSection: 121, skillCheck: false},
                    {text: "Climb down", nextSection: 122, skillCheck: false}
                ]
            },
            75: {
                text: "You climb down from the rooftops safely and find yourself back in the courtyard.",
                choices: [
                    {text: "Enter the main keep", nextSection: 18, skillCheck: false}
                ]
            },
            76: {
                text: "You take the crystal crown. As you touch it, dark visions flood your mind: you see yourself ruling from this throne, commanding legions, bathing in the power of the Bloodstone Heart. The crown grants you power but at what cost?",
                choices: [
                    {text: "Put on the crown", nextSection: 123, skillCheck: false},
                    {text: "Leave it on the throne", nextSection: 77, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Blood Crystal Crown");
                    updateInventoryDisplay();
                }
            },
            77: {
                text: "Behind the throne, you find a hidden passage leading down into darkness.",
                choices: [
                    {text: "Enter the hidden passage", nextSection: 124, skillCheck: false},
                    {text: "Return to the hall", nextSection: 78, skillCheck: false}
                ]
            },
            78: {
                text: "You decide to leave the throne alone and explore other parts of the hall.",
                choices: [
                    {text: "Examine the tapestries", nextSection: 39, skillCheck: false},
                    {text: "Take the left corridor", nextSection: 40, skillCheck: false},
                    {text: "Take the right corridor", nextSection: 41, skillCheck: false}
                ]
            },
            79: {
                text: window.checkResult ? 
                    "You study the ritual tapestry carefully. It shows the Blood Lord using the Bloodstone Heart to drain life from sacrifices to maintain his power. A specific chant is depicted that might disrupt the ritual." : 
                    "The tapestry is confusing. You can't make sense of the ritual depicted.",
                choices: [
                    {text: "Search for hidden doors", nextSection: 80, skillCheck: false},
                    {text: "Return to examining the hall", nextSection: 18, skillCheck: false}
                ]
            },
            80: {
                text: "You search for hidden doors and find one behind a tapestry! It leads to a secret treasure room.",
                choices: [
                    {text: "Enter the treasure room", nextSection: 125, skillCheck: false},
                    {text: "Leave it", nextSection: 18, skillCheck: false}
                ]
            },
            81: {
                text: "The first room appears to be a guard captain's quarters. A journal on the desk details patrol schedules and mentions 'the Heart's weakness to pure silver.'",
                choices: [
                    {text: "Take the journal", nextSection: 126, skillCheck: false},
                    {text: "Search the room", nextSection: 127, skillCheck: false},
                    {text: "Leave and check another room", nextSection: 82, skillCheck: false}
                ]
            },
            82: {
                text: "The second room is a storage room filled with supplies: rope, torches, healing salves, and other useful items.",
                choices: [
                    {text: "Take some supplies", nextSection: 128, skillCheck: false},
                    {text: "Continue down the hallway", nextSection: 83, skillCheck: false},
                    {text: "Go back", nextSection: 40, skillCheck: false}
                ]
            },
            83: {
                text: "You continue down the hallway and reach a dead end with a large tapestry depicting a blood-red sun.",
                choices: [
                    {text: "Examine the tapestry", nextSection: 129, skillCheck: false},
                    {text: "Go back", nextSection: 40, skillCheck: false}
                ]
            },
            84: {
                text: "You continue downward into the darkness. The moaning grows louder. You've reached the dungeons of Bloodstone Keep.",
                choices: [
                    {text: "Explore the dungeons", nextSection: 130, skillCheck: false},
                    {text: "Light a torch first", nextSection: 85, skillCheck: false},
                    {text: "Go back", nextSection: 18, skillCheck: false}
                ]
            },
            85: {
                text: "You light a torch. The dungeons are revealed: rows of cells, most empty, some containing skeletal remains. At the far end, you see a larger cell with a living prisoner.",
                choices: [
                    {text: "Approach the prisoner", nextSection: 131, skillCheck: false},
                    {text: "Search the empty cells", nextSection: 132, skillCheck: false},
                    {text: "Look for the jailer", nextSection: 133, skillCheck: false}
                ]
            },
            86: {
                text: "After the guards leave, you search the barracks and find a chest under one of the beds containing 40 Gold and a healing potion.",
                choices: [
                    {text: "Take the treasure", nextSection: 134, skillCheck: false},
                    {text: "Leave the barracks", nextSection: 135, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 40;
                    gameState.inventory.push("Healing Potion");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                }
            },
            87: {
                text: "After defeating the barracks guards, you can search the area or continue exploring.",
                choices: [
                    {text: "Search the barracks", nextSection: 86, skillCheck: false},
                    {text: "Leave the barracks", nextSection: 135, skillCheck: false}
                ]
            },
            88: {
                text: "You take the crystalline heart from the altar. It pulses in your hand, and you feel immense power flowing through you, but also a dark hunger. Your Skill increases by 3, but your Luck decreases by 2.",
                choices: [
                    {text: "Leave the chapel", nextSection: 90, skillCheck: false}
                ],
                action: function() {
                    gameState.skill += 3;
                    gameState.luck = Math.max(1, gameState.luck - 2);
                    gameState.inventory.push("Crystalline Heart Fragment");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                }
            },
            89: {
                text: "You try to destroy the heart, but it's protected by powerful magic. The attempt drains your energy. You lose 5 Stamina.",
                choices: [
                    {text: "Leave the chapel", nextSection: 90, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina -= 5;
                    updateStatsDisplay();
                }
            },
            90: {
                text: "You leave the chapel and return to the courtyard.",
                choices: [
                    {text: "Enter the main keep", nextSection: 18, skillCheck: false},
                    {text: "Go to the barracks", nextSection: 19, skillCheck: false}
                ]
            },
            91: {
                text: "You search for secret passages and find one behind the altar! It leads down into the catacombs beneath the keep.",
                choices: [
                    {text: "Enter the catacombs", nextSection: 136, skillCheck: false},
                    {text: "Leave it", nextSection: 90, skillCheck: false}
                ]
            },
            92: {
                text: "You take the silver holy symbol and gold. The holy symbol feels warm and comforting in your hand.",
                choices: [
                    {text: "Leave the chapel", nextSection: 90, skillCheck: false}
                ]
            },
            93: {
                text: "You climb down into the darkness. The smell is overpowering. You've entered the keep's ossuary - a chamber filled with bones.",
                choices: [
                    {text: "Search the ossuary", nextSection: 137, skillCheck: false},
                    {text: "Climb back up", nextSection: 22, skillCheck: false}
                ]
            },
            94: {
                text: "The hallway beyond the kitchen leads to the keep's servant quarters and laundry area. No one seems to be around.",
                choices: [
                    {text: "Search the servant quarters", nextSection: 138, skillCheck: false},
                    {text: "Continue to the laundry", nextSection: 139, skillCheck: false},
                    {text: "Go back to the kitchen", nextSection: 22, skillCheck: false}
                ]
            },
            95: {
                text: "'The Blood Lord rules from the deepest chamber,' the cook whispers. 'He draws power from the Bloodstone Heart. They say he's lived for centuries, sustained by sacrifice.'",
                choices: [
                    {text: "Ask how to defeat him", nextSection: 140, skillCheck: false},
                    {text: "Ask for a way out", nextSection: 96, skillCheck: false}
                ]
            },
            96: {
                text: "'There's a secret passage behind the pantry,' the cook says, pointing. 'It leads to the outer wall. But be careful - the Blood Lord's magic guards all exits.'",
                choices: [
                    {text: "Thank her and take the secret passage", nextSection: 141, skillCheck: false},
                    {text: "Ask about the Blood Lord", nextSection: 95, skillCheck: false}
                ]
            },
            97: {
                text: "After defeating the cook, you search the kitchen and find some healing herbs and 15 Gold.",
                choices: [
                    {text: "Take the herbs and gold", nextSection: 142, skillCheck: false},
                    {text: "Leave the kitchen", nextSection: 94, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Healing Herbs");
                    gameState.gold += 15;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                }
            },
            98: {
                text: window.checkResult ? 
                    "You successfully follow the guards without being detected. They lead you to a heavily guarded door deep in the dungeons - likely the entrance to the Blood Lord's chamber." : 
                    "The guards spot you following them!",
                choices: [
                    window.checkResult ? 
                        {text: "Approach the guarded door", nextSection: 143, skillCheck: false} :
                        {text: "Fight the guards", nextSection: 99, skillCheck: false}
                ]
            },
            99: {
                text: "You attack the guards in the dungeon!",
                choices: [
                    {text: "Begin the battle!", nextSection: 9901, skillCheck: false}
                ]
            },
            9901: {
                text: "You face the Dungeon Guards! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 9902, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Dungeon Guards";
                    combatState.enemyStamina = 16;
                    combatState.enemyCurrentStamina = 16;
                    combatState.enemySkill = 10;
                    combatState.nextSection = 144;
                    combatState.round = 1;
                    
                    return "Dungeon Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            100: {
                text: "You wait for the guards to leave, then explore the dungeons on your own.",
                choices: [
                    {text: "Search the cells", nextSection: 145, skillCheck: false},
                    {text: "Look for the deepest chamber", nextSection: 146, skillCheck: false}
                ]
            },
            101: {
                text: window.checkResult ? 
                    "You force the grate open and slip out into the courtyard unnoticed." : 
                    "The grate won't budge. It's rusted shut.",
                choices: [
                    window.checkResult ? 
                        {text: "Explore the courtyard", nextSection: 10, skillCheck: false} :
                        {text: "Return to the main passage", nextSection: 12, skillCheck: false}
                ]
            },
            102: {
                text: "You decide to keep the blood-red armor on. It makes you feel powerful, but you also feel a dark whisper in the back of your mind tempting you toward cruelty.",
                choices: [
                    {text: "Leave the secret room", nextSection: 28, skillCheck: false}
                ]
            },
            103: {
                text: "You take off the blood-red armor, feeling relieved as the dark whispers fade. You leave it on its stand.",
                choices: [
                    {text: "Search the weapon racks", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    // Remove the armor if it was added
                    const armorIndex = gameState.armor.findIndex(a => a.name === 'Bloodsteel Plate');
                    if (armorIndex !== -1) {
                        gameState.armor.splice(armorIndex, 1);
                        if (gameState.currentArmorIndex >= armorIndex) {
                            gameState.currentArmorIndex = Math.max(0, gameState.currentArmorIndex - 1);
                        }
                    }
                    gameState.skill = Math.max(1, gameState.skill - 1);
                    updateInventoryDisplay();
                    updateStatsDisplay();
                }
            },
            104: {
                text: window.checkResult ? 
                    "You sneak past the guards while they're distracted by their dice game." : 
                    "One of the guards looks up and spots you!",
                choices: [
                    window.checkResult ? 
                        {text: "Continue down the corridor", nextSection: 147, skillCheck: false} :
                        {text: "Fight the guards", nextSection: 105, skillCheck: false}
                ]
            },
            105: {
                text: "You attack the guards at the guard post!",
                choices: [
                    {text: "Begin the battle!", nextSection: 10501, skillCheck: false}
                ]
            },
            10501: {
                text: "You face the Guard Post Sentries! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 10502, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Guard Post Sentries";
                    combatState.enemyStamina = 14;
                    combatState.enemyCurrentStamina = 14;
                    combatState.enemySkill = 9;
                    combatState.nextSection = 148;
                    combatState.round = 1;
                    
                    return "Guard Post Sentries: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            106: {
                text: "'Care to join our game, stranger?' one guard asks. 'We play for gold. Winner takes all.'",
                choices: [
                    {text: "Play dice with them", nextSection: 149, skillCheck: false},
                    {text: "Attack them", nextSection: 105, skillCheck: false},
                    {text: "Decline and leave", nextSection: 147, skillCheck: false}
                ]
            },
            107: {
                text: "The secret door leads to an alchemist's laboratory. Strange liquids bubble in glass vessels, and the air smells of sulfur and herbs.",
                choices: [
                    {text: "Search the laboratory", nextSection: 150, skillCheck: false},
                    {text: "Take some potions", nextSection: 151, skillCheck: false},
                    {text: "Leave and return to the library", nextSection: 31, skillCheck: false}
                ]
            },
            108: {
                text: window.checkResult ? 
                    "You observe unseen. The cultists are preparing a sacrifice to power the Bloodstone Heart. You learn the ritual's weaknesses." : 
                    "You're spotted! The cultists turn toward you!",
                choices: [
                    window.checkResult ? 
                        {text: "Attack the cultists", nextSection: 6401, skillCheck: false} :
                        {text: "Try to talk your way out", nextSection: 152, skillCheck: false}
                ]
            },
            109: {
                text: "You try to disrupt the ritual by knocking over the blood-filled basin. The cultists scream in rage and attack!",
                choices: [
                    {text: "Fight the angry cultists", nextSection: 6401, skillCheck: false}
                ]
            },
            110: {
                text: "After defeating the cultists, the ritual chamber is yours to search. You find ritual components and 50 Gold.",
                choices: [
                    {text: "Take the gold and search further", nextSection: 153, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 154, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 50;
                    updateStatsDisplay();
                }
            },
            111: {
                text: "You challenge one of the guards to a duel. 'First to yield loses,' he says, picking up a practice sword.",
                choices: [
                    {text: "Fight the duel", nextSection: 11101, skillCheck: false},
                    {text: "Back out", nextSection: 113, skillCheck: false}
                ]
            },
            11101: {
                text: "You face the Training Guard in a duel! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 11102, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Training Guard";
                    combatState.enemyStamina = 12;
                    combatState.enemyCurrentStamina = 12;
                    combatState.enemySkill = 9;
                    combatState.nextSection = 155;
                    combatState.round = 1;
                    
                    return "Training Guard: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            112: {
                text: window.checkResult ? 
                    "You successfully steal a finely crafted sword from the wall without being noticed." : 
                    "A guard sees you trying to steal a weapon!",
                choices: [
                    window.checkResult ? 
                        {text: "Leave quietly with the sword", nextSection: 156, skillCheck: false} :
                        {text: "Fight the guards", nextSection: 157, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.weapons.push({name: 'Finely Crafted Sword', damage: '1d8+1'});
                        updateInventoryDisplay();
                    }
                }
            },
            113: {
                text: "You leave the training room quietly and continue exploring.",
                choices: [
                    {text: "Investigate the chanting", nextSection: 64, skillCheck: false},
                    {text: "Find stairs going down", nextSection: 66, skillCheck: false}
                ]
            },
            114: {
                text: "You descend the stairs into the lower levels of the keep. The air grows colder still, and the stone walls gleam with crimson veins.",
                choices: [
                    {text: "Continue downward", nextSection: 158, skillCheck: false},
                    {text: "Go back", nextSection: 66, skillCheck: false}
                ]
            },
            115: {
                text: "You take the armory key and gold. The armory might contain powerful weapons.",
                choices: [
                    {text: "Look for the armory", nextSection: 159, skillCheck: false},
                    {text: "Continue exploring", nextSection: 116, skillCheck: false}
                ]
            },
            116: {
                text: "You continue exploring the keep, moving deeper into its heart.",
                choices: [
                    {text: "Enter the main keep", nextSection: 18, skillCheck: false},
                    {text: "Try the chapel", nextSection: 20, skillCheck: false}
                ]
            },
            117: {
                text: "You examine the crystal ball. It clouds, then clears to show a vision: a massive red crystal pulsating in a dark chamber, surrounded by kneeling figures.",
                choices: [
                    {text: "Try to control the vision", nextSection: 160, skillCheck: true, checkType: 'luck', difficulty: 12},
                    {text: "Search the books", nextSection: 118, skillCheck: false}
                ]
            },
            118: {
                text: "You search the books and find a tome titled 'Blood Magic: Theory and Practice.' It contains dangerous knowledge.",
                choices: [
                    {text: "Take the book", nextSection: 161, skillCheck: false},
                    {text: "Leave it", nextSection: 119, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Blood Magic Tome");
                    updateInventoryDisplay();
                }
            },
            119: {
                text: "You take some alchemical ingredients that might be useful for making potions.",
                choices: [
                    {text: "Leave the study", nextSection: 162, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Alchemical Ingredients");
                    updateInventoryDisplay();
                }
            },
            120: {
                text: "You look through the skylight into the throne room below. You see the Blood Lord himself sitting on the bone throne, attended by crimson-robed advisors.",
                choices: [
                    {text: "Try to open the skylight", nextSection: 121, skillCheck: false},
                    {text: "Climb down", nextSection: 122, skillCheck: false}
                ]
            },
            121: {
                text: "You try to open the skylight, but it's locked from the inside. You'd need to break it, which would make noise.",
                choices: [
                    {text: "Break the skylight", nextSection: 163, skillCheck: false},
                    {text: "Climb down", nextSection: 122, skillCheck: false}
                ]
            },
            122: {
                text: "You climb down from the roof and find yourself near the keep's main entrance.",
                choices: [
                    {text: "Enter the main keep", nextSection: 18, skillCheck: false}
                ]
            },
            123: {
                text: "You put on the blood crystal crown. Dark power floods through you! Your Skill increases by 2, and you gain the ability to command weak-willed creatures, but you feel your humanity slipping away.",
                choices: [
                    {text: "Keep the crown on", nextSection: 164, skillCheck: false},
                    {text: "Take it off", nextSection: 165, skillCheck: false}
                ],
                action: function() {
                    gameState.skill += 2;
                    updateStatsDisplay();
                    // Remove from inventory since it's now worn
                    const index = gameState.inventory.indexOf("Blood Crystal Crown");
                    if (index > -1) {
                        gameState.inventory.splice(index, 1);
                        updateInventoryDisplay();
                    }
                }
            },
            124: {
                text: "You enter the hidden passage behind the throne. It descends steeply into the heart of the keep. The walls pulse with crimson light.",
                choices: [
                    {text: "Follow the passage", nextSection: 166, skillCheck: false},
                    {text: "Go back", nextSection: 77, skillCheck: false}
                ]
            },
            125: {
                text: "The secret treasure room contains chests overflowing with gold, jewels, and magical artifacts!",
                choices: [
                    {text: "Take as much as you can carry", nextSection: 167, skillCheck: false},
                    {text: "Take only what you need", nextSection: 168, skillCheck: false},
                    {text: "Leave it all", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 100;
                    gameState.inventory.push("Ruby Amulet", "Sack of Gems");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    return "You take 100 Gold, a Ruby Amulet, and a sack of gems!";
                }
            },
            // The story continues with many more sections, leading to the final confrontation
            // with the Blood Lord and the Bloodstone Heart in section 300
            
            // VICTORY SECTION - Player completes the level
            300: {
                text: "You have conquered <span class='bloodstone-decoration'>BLOODSTONE KEEP</span>! Whether through combat, cunning, or diplomacy, you've defeated the Blood Lord and destroyed or claimed the Bloodstone Heart. The keep's dark magic fades, and you emerge into the light. Before you stretches the <span class='enemy'>ASHEN WASTES</span>, your next challenge.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-skill').textContent = gameState.skill;
                    document.getElementById('next-stat-stamina').textContent = gameState.stamina;
                    document.getElementById('next-stat-luck').textContent = gameState.luck;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    return "You've completed Level 4: Bloodstone Keep! Your journey continues to the Ashen Wastes...";
                }
            },
            // Additional combat sections for various enemies
            102: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 103, skillCheck: false}
                ]
            },
            103: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 102, skillCheck: false}
                ]
            },
            3602: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 3603, skillCheck: false}
                ]
            },
            3603: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 3602, skillCheck: false}
                ]
            },
            4302: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 4303, skillCheck: false}
                ]
            },
            4303: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 4302, skillCheck: false}
                ]
            },
            5202: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 5203, skillCheck: false}
                ]
            },
            5203: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 5202, skillCheck: false}
                ]
            },
            6402: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 6403, skillCheck: false}
                ]
            },
            6403: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 6402, skillCheck: false}
                ]
            },
            9902: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 9903, skillCheck: false}
                ]
            },
            9903: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 9902, skillCheck: false}
                ]
            },
            10502: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 10503, skillCheck: false}
                ]
            },
            10503: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 10502, skillCheck: false}
                ]
            },
            11102: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 11103, skillCheck: false}
                ]
            },
            11103: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 11102, skillCheck: false}
                ]
            }
        };

        // Initialize game
        function initGame() {
            updateStatsDisplay();
            updateInventoryDisplay();
            
            if (gameState.currentSection > 0) {
                loadSection(gameState.currentSection);
            } else {
                loadSection(0);
            }
        }
        
        // Show warning dialog for new game
        function showNewGameWarning() {
            document.getElementById('screen-game').classList.remove('active-screen');
            document.getElementById('warning-dialog').classList.add('active-screen');
        }
        
        // Cancel new game and return to game screen
        function cancelNewGame() {
            document.getElementById('warning-dialog').classList.remove('active-screen');
            document.getElementById('screen-game').classList.add('active-screen');
        }
        
        // Start new game - reset everything
        function startNewGame() {
            localStorage.removeItem('dreadwoodGameState');
            gameState = {
                playerClass: '',
                skill: 0,
                maxStamina: 0,
                stamina: 0,
                luck: 0,
                gold: 0,
                inventory: [],
                weapons: [],
                armor: [],
                currentWeaponIndex: 0,
                currentArmorIndex: 0,
                currentSection: 0,
                gameComplete: false
            };
            window.location.href = 'level1.html';
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-skill').textContent = gameState.skill;
            document.getElementById('stat-stamina').textContent = gameState.stamina;
            document.getElementById('stat-maxstamina').textContent = gameState.maxStamina;
            document.getElementById('stat-luck').textContent = gameState.luck;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Show current equipped weapon
            if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                const weapon = gameState.weapons[gameState.currentWeaponIndex];
                const weaponSpan = document.createElement('span');
                weaponSpan.className = 'inventory-item';
                weaponSpan.id = 'inv-weapon';
                weaponSpan.textContent = `${weapon.name} (${weapon.damage})`;
                inventoryDiv.appendChild(weaponSpan);
            }
            
            // Show current equipped armor
            if (gameState.armor && gameState.armor.length > 0 && gameState.currentArmorIndex >= 0) {
                const armor = gameState.armor[gameState.currentArmorIndex];
                const armorSpan = document.createElement('span');
                armorSpan.className = 'inventory-item';
                armorSpan.id = 'inv-armor';
                armorSpan.textContent = `${armor.name} (${armor.defense} DEF)`;
                inventoryDiv.appendChild(armorSpan);
            }
            
            // Show gold
            const goldSpan = document.createElement('span');
            goldSpan.className = 'inventory-item';
            goldSpan.textContent = `${gameState.gold} Gold`;
            inventoryDiv.appendChild(goldSpan);
            
            // Show other inventory items
            if (gameState.inventory) {
                gameState.inventory.forEach(item => {
                    // Don't show items that are currently equipped as weapons/armor
                    const isCurrentWeapon = gameState.weapons[gameState.currentWeaponIndex] && 
                        gameState.weapons[gameState.currentWeaponIndex].name === item;
                    const isCurrentArmor = gameState.armor[gameState.currentArmorIndex] && 
                        gameState.armor[gameState.currentArmorIndex].name === item;
                    
                    if (!isCurrentWeapon && !isCurrentArmor) {
                        const itemSpan = document.createElement('span');
                        itemSpan.className = 'inventory-item';
                        itemSpan.textContent = item;
                        inventoryDiv.appendChild(itemSpan);
                    }
                });
            }
        }
        
        // Load story section
        function loadSection(sectionId) {
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                // For any missing sections, provide a default continuation
                document.getElementById('story-text').innerHTML = "<p>You continue through Bloodstone Keep, navigating its treacherous halls. The air grows heavier with dark magic as you approach the keep's heart. You can feel the power of the Bloodstone Heart pulsating through the stone.</p>";
                document.getElementById('choice-buttons').innerHTML = `
                    <button class="choice-btn" onclick="loadSection(300)">Confront the Blood Lord</button>
                    <button class="choice-btn" onclick="loadSection(0)">Return to Keep Entrance</button>
                `;
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 102 || sectionId === 103 || 
                                 sectionId === 3602 || sectionId === 3603 ||
                                 sectionId === 4302 || sectionId === 4303 ||
                                 sectionId === 5202 || sectionId === 5203 ||
                                 sectionId === 6402 || sectionId === 6403 ||
                                 sectionId === 9902 || sectionId === 9903 ||
                                 sectionId === 10502 || sectionId === 10503 ||
                                 sectionId === 11102 || sectionId === 11103);
            
            if (isCombatRound && combatState.active) {
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                if (!combatState.active) {
                    const goldReward = Math.floor(Math.random() * 30) + 10;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find ${goldReward} Gold on the body.`;
                    
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                section.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    button.onclick = function() {
                        if (choice.skillCheck) {
                            performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                        } else {
                            loadSection(choice.nextSection);
                        }
                    };
                    choiceButtons.appendChild(button);
                });
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDiceHelper(2, 6);
            const enemyRoll = rollDiceHelper(2, 6);
            
            // Add skill to dice rolls
            const playerTotal = playerRoll + gameState.skill;
            const enemyTotal = enemyRoll + combatState.enemySkill;
            
            let resultText = `<span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Stamina: ${gameState.stamina}, Enemy Stamina: ${combatState.enemyCurrentStamina}<br>`;
            resultText += `You roll ${playerRoll} + Skill ${gameState.skill} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Skill ${combatState.enemySkill} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                    const weapon = gameState.weapons[gameState.currentWeaponIndex];
                    if (weapon.damage === '1d6') damage = rollDiceHelper(1, 6);
                    else if (weapon.damage === '2d4') damage = rollDiceHelper(2, 4);
                    else if (weapon.damage === '3d6') damage = rollDiceHelper(3, 6);
                    else if (weapon.damage === '2d6') damage = rollDiceHelper(2, 6);
                    else if (weapon.damage === '1d6+3') damage = rollDiceHelper(1, 6) + 3;
                    else if (weapon.damage === '1d8+2') damage = rollDiceHelper(1, 8) + 2;
                    else if (weapon.damage === '1d6+1') damage = rollDiceHelper(1, 6) + 1;
                    else if (weapon.damage === '1d8+1') damage = rollDiceHelper(1, 8) + 1;
                    else damage = rollDiceHelper(1, 6); // Default fallback
                } else {
                    damage = rollDiceHelper(1, 6);
                }
                
                combatState.enemyCurrentStamina -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                
                if (combatState.enemyCurrentStamina <= 0) {
                    combatState.active = false;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                const enemyDamage = rollDiceHelper(1, 6); // Enemy always uses 1d6 damage
                gameState.stamina -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                
                // Check if player died
                if (gameState.stamina <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated by the ${combatState.enemyName}! Game Over.</span>`;
                    setTimeout(() => {
                        localStorage.removeItem('dreadwoodGameState');
                        location.reload();
                    }, 3000);
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            const diceRoll = rollDiceHelper(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Luck
        function useLuck() {
            if (gameState.luck <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Luck left!</div>`;
                return;
            }
            
            const diceRoll = rollDiceHelper(2, 6);
            const success = diceRoll <= gameState.luck;
            
            gameState.luck -= 1;
            updateStatsDisplay();
            
            let resultText = `You test your Luck... Roll: ${diceRoll}, Luck: ${gameState.luck + 1}. `;
            resultText += success ? 
                `<span class="success">Lucky!</span> Something good happens.` : 
                `<span class="damage">Unlucky!</span> Something bad happens.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            // Apply Luck effect
            if (success) {
                const goodEffects = [
                    "You find 10 Gold on the floor!",
                    "You feel a surge of energy! Restore 5 Stamina.",
                    "You spot a hidden passage you missed before.",
                    "A loose stone reveals a healing potion!",
                    "Your weapon feels sharper! Next attack does +2 damage."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Gold")) {
                    gameState.gold += 10;
                } else if (effect.includes("Stamina")) {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 5);
                } else if (effect.includes("potion")) {
                    gameState.inventory.push("Healing Potion");
                    updateInventoryDisplay();
                }
            } else {
                const badEffects = [
                    "You trip and take 3 damage!",
                    "You drop 5 Gold!",
                    "You attract the attention of nearby guards!",
                    "Your armor strap breaks! Lose 1 DEF until repaired.",
                    "You set off a magical alarm!"
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.stamina -= 3;
                    if (gameState.stamina <= 0) {
                        document.getElementById('story-text').innerHTML += `<div class="game-over">You have been defeated! Game Over.</div>`;
                        setTimeout(() => {
                            localStorage.removeItem('dreadwoodGameState');
                            location.reload();
                        }, 3000);
                    }
                } else if (effect.includes("Gold")) {
                    gameState.gold = Math.max(0, gameState.gold - 5);
                } else if (effect.includes("guards")) {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">Two keep guards approach you!</div>`;
                    setTimeout(() => {
                        combatState.active = true;
                        combatState.enemyName = "Keep Guards";
                        combatState.enemyStamina = 14;
                        combatState.enemyCurrentStamina = 14;
                        combatState.enemySkill = 9;
                        combatState.nextSection = gameState.currentSection;
                        combatState.round = 0;
                        loadSection(3602);
                    }, 1000);
                }
            }
            
            updateStatsDisplay();
            updateInventoryDisplay();
        }
        
        // Use Item function
        function useItem() {
            const usableItems = gameState.inventory.filter(item => {
                const isWeapon = gameState.weapons.some(w => w.name === item);
                const isArmor = gameState.armor.some(a => a.name === item);
                return !isWeapon && !isArmor;
            });
            
            if (usableItems.length === 0) {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory!</div>`;
                return;
            }
            
            let itemText = "<h3>Select an item to use:</h3>";
            
            usableItems.forEach((item, index) => {
                itemText += `<p>${item} `;
                
                if (item === "Healing Potion" || item === "Healing Salve" || item === "Healing Herbs") {
                    itemText += `<button onclick="useHealingItem('${item}')" style="font-size:12px; padding:3px 8px;">Use (Restore Stamina)</button>`;
                } else if (item === "Bloodbloom Flower") {
                    itemText += `<button onclick="useBloodbloomFlower()" style="font-size:12px; padding:3px 8px;">Use (Dangerous Power)</button>`;
                } else if (item === "Scroll of Dispel Magic") {
                    itemText += `<button onclick="useDispelScroll()" style="font-size:12px; padding:3px 8px;">Use (Dispel Magic)</button>`;
                } else if (item === "Blood Magic Tome") {
                    itemText += `<button onclick="useBloodMagicTome()" style="font-size:12px; padding:3px 8px;">Read (Dangerous Knowledge)</button>`;
                } else if (item === "Silver Holy Symbol") {
                    itemText += `<button onclick="useHolySymbol()" style="font-size:12px; padding:3px 8px;">Use (Holy Protection)</button>`;
                } else if (item === "Ruby Amulet") {
                    itemText += `<button onclick="useRubyAmulet()" style="font-size:12px; padding:3px 8px;">Use (Magical Protection)</button>`;
                } else {
                    itemText += `<button onclick="useGenericItem('${item}')" style="font-size:12px; padding:3px 8px;">Use</button>`;
                }
                
                itemText += `</p>`;
            });
            
            itemText += `<p><button onclick="cancelItemUse()" style="font-size:12px; padding:3px 8px; margin-top:10px;">Cancel</button></p>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${itemText}</div>`;
        }
        
        // Use Healing Item
        function useHealingItem(itemName) {
            const itemIndex = gameState.inventory.indexOf(itemName);
            if (itemIndex !== -1) {
                gameState.inventory.splice(itemIndex, 1);
                
                let healAmount = 0;
                if (itemName === "Healing Potion") {
                    healAmount = 6;
                } else if (itemName === "Healing Salve") {
                    healAmount = 8;
                } else if (itemName === "Healing Herbs") {
                    healAmount = 4;
                } else {
                    healAmount = 4;
                }
                
                const oldStamina = gameState.stamina;
                gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                const actualHeal = gameState.stamina - oldStamina;
                
                updateInventoryDisplay();
                updateStatsDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You use the ${itemName} and restore ${actualHeal} Stamina!</span></div>`;
            }
        }
        
        // Use Bloodbloom Flower
        function useBloodbloomFlower() {
            const flowerIndex = gameState.inventory.indexOf("Bloodbloom Flower");
            if (flowerIndex !== -1) {
                gameState.inventory.splice(flowerIndex, 1);
                updateInventoryDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You eat the Bloodbloom Flower! You lose 8 Stamina from the pain, but your Luck increases by 3 and you feel a surge of dark power!</span></div>`;
                
                gameState.stamina -= 8;
                gameState.luck += 3;
                updateStatsDisplay();
            }
        }
        
        // Use Dispel Scroll
        function useDispelScroll() {
            const scrollIndex = gameState.inventory.indexOf("Scroll of Dispel Magic");
            if (scrollIndex !== -1) {
                gameState.inventory.splice(scrollIndex, 1);
                updateInventoryDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You read the Scroll of Dispel Magic! Magical wards and enchantments around you flicker and fade. This might be useful against the Blood Lord's magic.</span></div>`;
            }
        }
        
        // Use Blood Magic Tome
        function useBloodMagicTome() {
            const tomeIndex = gameState.inventory.indexOf("Blood Magic Tome");
            if (tomeIndex !== -1) {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You read from the Blood Magic Tome. You learn dangerous secrets about blood rituals and the Bloodstone Heart's weaknesses. Your Skill increases by 1, but you feel corrupted by the knowledge.</span></div>`;
                
                gameState.skill += 1;
                updateStatsDisplay();
            }
        }
        
        // Use Holy Symbol
        function useHolySymbol() {
            const symbolIndex = gameState.inventory.indexOf("Silver Holy Symbol");
            if (symbolIndex !== -1) {
                gameState.inventory.splice(symbolIndex, 1);
                updateInventoryDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You brandish the Silver Holy Symbol! Undead and dark creatures recoil from its pure light. Your Luck increases by 2 when facing unholy foes!</span></div>`;
                
                gameState.luck += 2;
                updateStatsDisplay();
            }
        }
        
        // Use Ruby Amulet
        function useRubyAmulet() {
            const amuletIndex = gameState.inventory.indexOf("Ruby Amulet");
            if (amuletIndex !== -1) {
                gameState.inventory.splice(amuletIndex, 1);
                updateInventoryDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You activate the Ruby Amulet! It creates a protective barrier around you. You gain 2 DEF for the next combat!</span></div>`;
                
                // Temporary defense boost
                gameState.tempDefense = 2;
                setTimeout(() => {
                    gameState.tempDefense = 0;
                    document.getElementById('story-text').innerHTML += 
                        `<div class="dice-roll">The amulet's protection fades.</div>`;
                }, 30000);
            }
        }
        
        // Use Generic Item
        function useGenericItem(itemName) {
            const itemIndex = gameState.inventory.indexOf(itemName);
            if (itemIndex !== -1) {
                gameState.inventory.splice(itemIndex, 1);
                updateInventoryDisplay();
                
                let effectText = "";
                if (itemName.includes("Potion") || itemName.includes("Elixir")) {
                    const healAmount = rollDiceHelper(1, 4) + 2;
                    const oldStamina = gameState.stamina;
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                    const actualHeal = gameState.stamina - oldStamina;
                    effectText = `You use the ${itemName} and restore ${actualHeal} Stamina!`;
                    updateStatsDisplay();
                } else if (itemName.includes("Amulet") || itemName.includes("Charm")) {
                    gameState.luck += 1;
                    effectText = `You activate the ${itemName} and feel luckier! Luck +1`;
                    updateStatsDisplay();
                } else if (itemName.includes("Key")) {
                    effectText = `You examine the ${itemName}. It might unlock something important.`;
                    gameState.inventory.push(itemName);
                    updateInventoryDisplay();
                    return;
                } else {
                    effectText = `You use the ${itemName}.`;
                }
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">${effectText}</span></div>`;
            }
        }
        
        // Cancel Item Use
        function cancelItemUse() {
            document.getElementById('story-text').innerHTML += 
                `<div class="dice-roll">You decide not to use an item.</div>`;
        }
        
        // Check inventory
        function checkInventory() {
            let inventoryText = "<h3>Your Inventory:</h3>";
            
            if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                const weapon = gameState.weapons[gameState.currentWeaponIndex];
                inventoryText += `<p><strong>Equipped Weapon:</strong> ${weapon.name} (${weapon.damage} damage)</p>`;
            }
            
            inventoryText += "<p><strong>Available Weapons:</strong><br>";
            gameState.weapons.forEach((weapon, index) => {
                const isEquipped = index === gameState.currentWeaponIndex;
                inventoryText += `${isEquipped ? " " : ""}${weapon.name} (${weapon.damage})`;
                if (!isEquipped) {
                    inventoryText += ` <button onclick="equipWeapon(${index})" style="font-size:10px; padding:2px 5px;">Equip</button>`;
                }
                inventoryText += "<br>";
            });
            inventoryText += "</p>";
            
            inventoryText += "<p><strong>Armor:</strong><br>";
            gameState.armor.forEach((armor, index) => {
                const isEquipped = index === gameState.currentArmorIndex;
                inventoryText += `${isEquipped ? " " : ""}${armor.name} (${armor.defense} DEF)`;
                if (!isEquipped) {
                    inventoryText += ` <button onclick="equipArmor(${index})" style="font-size:10px; padding:2px 5px;">Equip</button>`;
                }
                inventoryText += "<br>";
            });
            inventoryText += "</p>";
            
            inventoryText += `<p><strong>Gold:</strong> ${gameState.gold}</p>`;
            
            if (gameState.inventory && gameState.inventory.length > 0) {
                inventoryText += `<p><strong>Usable Items:</strong><br>`;
                const usableItems = gameState.inventory.filter(item => {
                    const isWeapon = gameState.weapons.some(w => w.name === item);
                    const isArmor = gameState.armor.some(a => a.name === item);
                    return !isWeapon && !isArmor;
                });
                
                if (usableItems.length > 0) {
                    usableItems.forEach(item => {
                        inventoryText += `${item} `;
                        
                        if (item === "Healing Potion" || item === "Healing Salve" || item === "Healing Herbs") {
                            inventoryText += `<button onclick="useHealingItem('${item}')" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Bloodbloom Flower") {
                            inventoryText += `<button onclick="useBloodbloomFlower()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Scroll of Dispel Magic") {
                            inventoryText += `<button onclick="useDispelScroll()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Blood Magic Tome") {
                            inventoryText += `<button onclick="useBloodMagicTome()" style="font-size:10px; padding:2px 5px;">Read</button>`;
                        } else if (item === "Silver Holy Symbol") {
                            inventoryText += `<button onclick="useHolySymbol()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Ruby Amulet") {
                            inventoryText += `<button onclick="useRubyAmulet()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else {
                            inventoryText += `<button onclick="useGenericItem('${item}')" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        }
                        
                        inventoryText += `<br>`;
                    });
                } else {
                    inventoryText += "None";
                }
                inventoryText += `</p>`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${inventoryText}</div>`;
        }
        
        // Equip weapon function
        function equipWeapon(index) {
            if (index >= 0 && index < gameState.weapons.length) {
                gameState.currentWeaponIndex = index;
                updateInventoryDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped ${gameState.weapons[index].name}!</div>`;
                saveGame();
            }
        }
        
        // Equip armor function
        function equipArmor(index) {
            if (index >= 0 && index < gameState.armor.length) {
                gameState.currentArmorIndex = index;
                updateInventoryDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped ${gameState.armor[index].name}!</div>`;
                saveGame();
            }
        }
        
        // Save game
        function saveGame() {
            if (gameState.currentWeaponIndex >= gameState.weapons.length) {
                gameState.currentWeaponIndex = gameState.weapons.length - 1;
            }
            if (gameState.currentArmorIndex >= gameState.armor.length) {
                gameState.currentArmorIndex = gameState.armor.length - 1;
            }
            
            localStorage.setItem('dreadwoodGameState', JSON.stringify(gameState));
        }
        
        // Go to next level (Ashen Wastes)
        function goToNextLevel() {
            localStorage.setItem('dreadwoodGameState', JSON.stringify(gameState));
            window.location.href = 'level5.html';
        }
        
        // Utility function to roll dice
        function rollDiceHelper(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
    </script>
</body>
</html>
