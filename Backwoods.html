<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<title>Beneath the Backwoods</title>
<style>
:root {
  --neon-yellow: #E0FF00;
  --blood-red: #FF3333;
  --dark-bg: #0A0A0A;
  --darker-bg: #050505;
  --panel-bg: #111111;
  --border-dark: #222222;
  --text-glow: 0 0 8px rgba(224, 255, 0, 0.5);
  --psychic-blue: #00ccff;
  --holy-gold: #FFD700;
}

body {
  background-color: var(--dark-bg);
  color: var(--neon-yellow);
  font-family: 'Courier New', monospace;
  margin: 0;
  padding: 10px;
  touch-action: manipulation;
  user-select: none;
  -webkit-user-select: none;
  text-shadow: var(--text-glow);
  line-height: 1.4;
  height: 100vh;
}

#loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: #000;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

#loading-text {
  font-size: 1em;
  margin-bottom: 20px;
  animation: pulse 2s infinite;
}

#begin-game-btn {
  background-color: var(--panel-bg);
  color: var(--neon-yellow);
  border: 1px solid var(white);
  padding: 15px 30px;
  font-family: Times New Roman;
  font-size: 1.2em;
  cursor: pointer;
  border-radius: 5px;
  transition: all 0.3s;
  text-shadow: var(--text-glow);
  display: none;
}

#begin-game-btn:hover {
  background-color: var(--neon-yellow);
  color: var(--dark-bg);
  text-shadow: none;
}

@keyframes pulse {
  0% { opacity: 0.5; }
  50% { opacity: 1; }
  100% { opacity: 0.5; }
}

#game-container {
  max-width: 100%;
  margin: 0 auto;
  position: relative;
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-height: -webkit-fill-available;
  display: none; /* Initially hidden */
}

#header {
  text-align: center;
  margin-bottom: 15px;
  border-bottom: 1px solid var(--neon-yellow);
  padding-bottom: 10px;
  position: relative;
}

#game-title {
  font-size: 1.8em;
  font-weight: bold;
  color: var(--neon-yellow);
  text-shadow: 0 0 10px var(--neon-yellow);
  margin: 0;
  letter-spacing: 2px;
}

#game-subtitle {
  font-size: 0.9em;
  color: var(--blood-red);
  margin: 5px 0 0;
  font-style: italic;
}

#location {
  font-size: 1.4em;
  font-weight: bold;
  border-bottom: 1px solid var(--border-dark);
  padding-bottom: 8px;
  margin-bottom: 15px;
  color: var(--neon-yellow);
  text-shadow: var(--text-glow);
  letter-spacing: 1px;
}

#description {
  min-height: 100px;
  max-height: 30vh;
  margin-bottom: 15px;
  padding: 10px;
  background-color: var(--darker-bg);
  border: 1px solid var(--border-dark);
  border-radius: 5px;
  font-size: 1.1em;
  overflow-y: auto;
  flex: 1;
}

#stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 5px;
  margin-bottom: 15px;
  padding: 5px;
  background-color: var(--panel-bg);
  border-radius: 5px;
  border: 1px solid var(--border-dark);
}

.stat {
  margin-bottom: 0;
}

.stat-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.95em;
}

.progress-container {
  height: 8px;
  background-color: var(--border-dark);
  border-radius: 4px;
  margin-top: 3px;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  border-radius: 4px;
  transition: width 0.3s ease;
}

.hp-bar {
  background-color: var(--blood-red);
}

.sanity-bar {
  background-color: var(--neon-yellow);
}

.xp-bar {
  background: linear-gradient(90deg, #6a00ff, #00ffcc);
}

#actions {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 5px;
  margin-bottom: 15px;
}

button {
  background-color: var(--panel-bg);
  color: var(--blood-red);
  border: 1px solid var(--border-dark);
  padding: 8px;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
  cursor: pointer;
  border-radius: 5px;
  transition: all 0.2s;
  text-shadow: 0 0 5px rgba(255, 51, 51, 0.5);
  position: relative;
  overflow: hidden;
}

button:hover {
  border-color: var(--neon-yellow);
}

button:active {
  background-color: #222;
  transform: scale(0.98);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

#inventory {
  border-top: 1px solid var(--border-dark);
  padding-top: 15px;
  margin-top: 15px;
  max-height: 25vh;
  overflow-y: auto;
}

#inventory-title {
  font-weight: bold;
  margin-bottom: 10px;
  font-size: 1.1em;
}

#inventory-items {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.item {
  background-color: var(--panel-bg);
  padding: 10px;
  border: 1px solid var(--border-dark);
  border-radius: 5px;
  font-size: 0.9em;
  cursor: pointer;
  transition: all 0.2s;
  width: calc(50% - 15px);
  box-sizing: border-box;
}

.item:hover {
  border-color: var(--neon-yellow);
}

.item.selected {
  border-color: var(--neon-yellow);
  box-shadow: 0 0 8px rgba(224, 255, 0, 0.3);
}

.item-ammo {
  color: var(--blood-red);
  font-size: 0.8em;
  margin-top: 3px;
}

.item-desc {
  font-size: 0.8em;
  color: #aaa;
  margin-top: 5px;
}

/* Combat Screen */
#combat-screen {
  display: none;
  border: 1px solid var(--blood-red);
  padding: 15px;
  margin-top: 15px;
  border-radius: 5px;
  background-color: rgba(255, 51, 51, 0.05);
}

#combat-description {
  min-height: 60px;
  max-height: 20vh;
  margin-bottom: 15px;
  padding: 10px;
  background-color: rgba(0, 0, 0, 0.3);
  border-radius: 5px;
  overflow-y: auto;
}

#combat-stats {
  margin: 15px 0;
}

.combat-stat {
  margin-bottom: 10px;
}

.combat-stat-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 3px;
}

.health-bar {
  height: 10px;
  background-color: var(--border-dark);
  border-radius: 5px;
  margin: 5px 0;
  overflow: hidden;
}

.health-fill {
  height: 100%;
  transition: width 0.3s;
}

.player-health {
  background-color: var(--neon-yellow);
}

.enemy-health {
  background-color: var(--blood-red);
}

#combat-actions {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 5px;
  margin-top: 10px;
}

/* Dialog Screen */
#dialog-screen {
  display: none;
  border: 1px solid var(--neon-yellow);
  padding: 15px;
  margin-top: 15px;
  border-radius: 5px;
  background-color: rgba(224, 255, 0, 0.05);
}

#dialog-text {
  min-height: 80px;
  margin-bottom: 15px;
  padding: 10px;
  background-color: rgba(0, 0, 0, 0.3);
  border-radius: 5px;
}

#dialog-options {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.dialog-option {
  background-color: var(--panel-bg);
  color: var(--neon-yellow);
  border: 1px solid var(--border-dark);
  padding: 10px;
  text-align: left;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.2s;
}

.dialog-option:hover {
  border-color: var(--neon-yellow);
}

/* Item Select Screen */
#item-select-screen {
  display: none;
  margin-top: 15px;
  border: 1px solid var(--border-dark);
  padding: 15px;
  border-radius: 5px;
  background-color: var(--panel-bg);
}

#item-select-title {
  margin-bottom: 10px;
  font-weight: bold;
}

#item-select-options {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

/* Flicker effect for creepy moments */
@keyframes flicker {
  0% { opacity: 1; }
  25% { opacity: 0.8; }
  50% { opacity: 0.6; }
  75% { opacity: 0.8; }
  100% { opacity: 1; }
}

.flicker {
  animation: flicker 0.5s infinite;
}

/* Low sanity effects */
.low-sanity {
  background-color: #0A0505;
}

.low-sanity #description {
  border-color: var(--blood-red);
}

.low-sanity button {
  color: #FF6666;
}

/* Typewriter effect */
.typewriter {
  overflow: hidden;
  white-space: nowrap;
  margin: 0 auto;
  letter-spacing: 0.15em;
  animation: typing 3.5s steps(40, end);
}

@keyframes typing {
  from { width: 0 }
  to { width: 100% }
}

/* Notification system */
.notification {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.8);
  border: 1px solid var(--neon-yellow);
  padding: 10px 20px;
  border-radius: 5px;
  z-index: 100;
  animation: fadeInOut 3s forwards;
  display: none;
}

@keyframes fadeInOut {
  0% { opacity: 0; top: 10px; }
  10% { opacity: 1; top: 20px; }
  90% { opacity: 1; top: 20px; }
  100% { opacity: 0; top: 10px; }
}

/* Tooltip */
.tooltip {
  position: relative;
  display: inline-block;
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: 200px;
  background-color: var(--panel-bg);
  color: var(--neon-yellow);
  text-align: center;
  border-radius: 6px;
  padding: 5px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -100px;
  opacity: 0;
  transition: opacity 0.3s;
  border: 1px solid var(--border-dark);
  font-size: 0.9em;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}

/* Mobile optimizations */
@media (max-width: 600px) {
  #actions, #combat-actions {
    grid-template-columns: repeat(2, 1fr);
  }

  #stats {
    grid-template-columns: repeat(2, 1fr);
  }

  button {
    padding: 6px;
    font-size: 0.8em;
  }

  .item {
    width: 100%;
  }
}

/* Special attack cooldown */
.cooldown {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 0.8em;
}

/* Level Transition Screen */
#level-transition {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.9);
  z-index: 200;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: var(--neon-yellow);
  text-align: center;
  padding: 20px;
}

#level-transition h2 {
  font-size: 2em;
  margin-bottom: 20px;
  text-shadow: 0 0 10px var(--neon-yellow);
}

#level-transition p {
  font-size: 1.2em;
  margin-bottom: 30px;
  max-width: 80%;
}

#level-transition-buttons {
  display: flex;
  gap: 15px;
}

#level-transition-buttons button {
  padding: 10px 20px;
  font-size: 1.1em;
}
</style>
</head>
<body>
<div id="loading-screen">
  <div id="loading-text">Loading . . .</div>
  <button id="begin-game-btn" onclick="startGame()">Begin Game</button>
</div>

<div id="notification" class="notification"></div>
<div id="level-transition">
  <h2>LEVEL COMPLETE</h2>
  <p id="level-transition-text">You've explored all locations and defeated all enemies of this level. Ready to progress to the next challenge?</p>
  <div id="level-transition-buttons">
    <button onclick="proceedToNextLevel()">PROCEED</button>
    <button onclick="stayAtCurrentLevel()">STAY</button>
  </div>
</div>

<div id="game-container">
  <div id="header">
    <h1 id="game-title">BENEATH THE BACKWOODS</h1>
    <p id="game-subtitle">A mystery lurking in the trees...</p>
  </div>

  <div id="location">THE EDGE OF THE WOODS</div>
  <div id="description">
    The trees loom before you, their branches twisting like skeletal fingers. A cold wind carries whispers from the darkness within. Your flashlight beam cuts through the mist, revealing nothing... and everything.
  </div>

  <div id="stats">
    <div class="stat">
      <div class="stat-label">
        <span>HP:</span>
        <span><span id="hp">100</span>/<span id="max-hp">100</span></span>
      </div>
      <div class="progress-container">
        <div id="hp-bar" class="progress-bar hp-bar" style="width:100%"></div>
      </div>
    </div>
    <div class="stat">
      <div class="stat-label">
        <span>Level:</span>
        <span id="level">1</span>
      </div>
    </div>
    <div class="stat">
      <div class="stat-label">
        <span>Sanity:</span>
        <span><span id="sanity">80</span>/100</span>
      </div>
      <div class="progress-container">
        <div id="sanity-bar" class="progress-bar sanity-bar" style="width:80%"></div>
      </div>
    </div>
    <div class="stat">
      <div class="stat-label">
        <span>XP:</span>
        <span><span id="xp">0</span>/<span id="next-level">100</span></span>
      </div>
      <div class="progress-container">
        <div id="xp-bar" class="progress-bar xp-bar" style="width:0%"></div>
      </div>
    </div>
  </div>

  <div id="actions">
    <button onclick="move('north')">NORTH</button>
    <button onclick="move('east')">EAST</button>
    <button onclick="move('south')">SOUTH</button>
    <button onclick="move('west')">WEST</button>
    <button onclick="checkInventory()">INVENTORY</button>
    <button onclick="checkSkills()">SKILLS</button>
    <button onclick="lookAround()">LOOK</button>
    <button onclick="rest()">REST</button>
    <button id="talk-btn" style="display:none;" onclick="startTalk()">TALK</button>
    <button id="level-select-btn" style="display:none;" onclick="showLevelTransition()">LEVEL SELECT</button>
  </div>

  <div id="inventory">
    <div id="inventory-title">INVENTORY:</div>
    <div id="inventory-items">
      <div class="item" onclick="selectItem(0)">
        Flashlight
        <div class="item-desc">Illuminates dark areas</div>
      </div>
      <div class="item selected" onclick="selectItem(1)">
        Pistol
        <div class="item-ammo">5/15</div>
        <div class="item-desc">DMG: 25</div>
      </div>
      <div class="item" onclick="selectItem(2)">
        Knife
        <div class="item-desc">DMG: 10</div>
      </div>
      <div class="item" onclick="selectItem(3)">
        Medkit
        <div class="item-desc">Restores 40 HP</div>
      </div>
    </div>
  </div>

  <div id="combat-screen">
    <div id="combat-description"></div>
    <div id="combat-stats">
      <div class="combat-stat">
        <div class="combat-stat-label">
          <span>YOU:</span>
          <span><span id="player-hp">100</span>/<span id="player-max-hp">100</span></span>
        </div>
        <div class="health-bar">
          <div id="player-health-fill" class="health-fill player-health" style="width:100%"></div>
        </div>
      </div>
      <div class="combat-stat">
        <div class="combat-stat-label">
          <span>ENEMY:</span>
          <span><span id="enemy-hp">100</span>/<span id="enemy-max-hp">100</span></span>
        </div>
        <div class="health-bar">
          <div id="enemy-health-fill" class="health-fill enemy-health" style="width:100%"></div>
        </div>
      </div>
    </div>
    <div id="combat-actions">
      <button onclick="attack()">ATTACK</button>
      <button onclick="showItemSelect()">ITEM</button>
      <button onclick="flee()">FLEE</button>
      <button id="special-attack-btn" onclick="specialAttack()">PSYCHIC</button>
    </div>
  </div>

  <div id="item-select-screen">
    <div id="item-select-title">SELECT ITEM:</div>
    <div id="item-select-options"></div>
    <button onclick="hideItemSelect()" style="margin-top:10px;">CANCEL</button>
  </div>

  <div id="dialog-screen">
    <div id="dialog-text"></div>
    <div id="dialog-options"></div>
    <button onclick="exitDialog()" style="margin-top:10px;">EXIT</button>
  </div>
</div>

<script>
// Show loading screen first
window.onload = function() {
  setTimeout(function() {
    document.getElementById('loading-text').style.display = 'none';
    document.getElementById('begin-game-btn').style.display = 'block';
  }, 3000); // Show "Begin Game" button after 3 seconds
};

function startGame() {
  document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('game-container').style.display = 'flex';
  initGame();
}

// =====================
// GAME STATE & DATA
// =====================
const gameState = {
  currentLocation: 'woods_edge',
  hp: 100,
  maxHp: 100,
  level: 1,
  xp: 0,
  nextLevel: 100,
  sanity: 80,
  inventory: [
    {
      name: "Flashlight",
      type: "tool",
      uses: -1,
      description: "Standard issue flashlight. Illuminates dark areas.",
      equipped: false
    },
    {
      name: "Pistol",
      type: "weapon",
      damage: 25,
      ammo: 5,
      maxAmmo: 15,
      description: "9mm service pistol. Effective but loud.",
      equipped: true
    },
    {
      name: "Knife",
      type: "weapon",
      damage: 10,
      uses: -1,
      description: "Combat knife. Silent but requires close range.",
      equipped: false
    },
    {
      name: "Medkit",
      type: "consumable",
      hpRestore: 40,
      uses: 1,
      description: "Restores 40 HP when used.",
      equipped: false
    }
  ],
  skills: {
    investigation: 1,
    occult: 1,
    firearms: 2,
    melee: 1,
    persuasion: 1,
    stealth: 1
  },
  quests: [
    {
      id: "find_missing_agent",
      title: "Find Missing Agent",
      status: "active",
      description: "Agent Mulder disappeared near Wolf Lake. Find clues to his whereabouts.",
      progress: 0
    },
    {
      id: "strange_lights",
      title: "Investigate Strange Lights",
      status: "inactive",
      description: "Locals report mysterious lights in the woods at night.",
      progress: 0
    },
    {
      id: "black_lodge",
      title: "Enter the Black Lodge",
      status: "inactive",
      description: "Discover the secrets of the mysterious Black Lodge.",
      progress: 0
    }
  ],
  knownNpcs: [
    {
      id: "sheriff",
      name: "Sheriff Truman",
      location: "police_station",
      trust: 50,
      creepiness: 30,
      met: false
    },
    {
      id: "log_lady",
      name: "The Log Lady",
      location: "deep_woods",
      trust: 70,
      creepiness: 90,
      met: false
    }
  ],
  combat: null,
  selectedItem: 1,
  gameTime: 0,
  levelProgress: {
    locationsVisited: 0,
    enemiesDefeated: 0,
    totalLocations: 9,
    totalEnemies: 4
  },
  specialAttackCooldown: false,
  visitedLocations: [],
  // Track if level is completed (but not necessarily shown the transition screen)
  levelCompleted: false,
  // Track if level transition screen has been shown
  levelTransitionShown: false
};

// Locations for different levels
const locations = {
  level1: {
    woods_edge: {
      name: "EDGE OF THE WOODS",
      description: "The trees loom before you, their branches twisting like skeletal fingers. A cold wind carries whispers from the darkness within. The path leads deeper into the woods to the north, while to the south lies the town entrance.",
      exits: {
        north: "deep_woods",
        east: "abandoned_cabin",
        south: "town_entrance",
        west: "lakeshore"
      },
      npcs: [],
      items: [],
      encounters: ["shadow_figure", "owl"],
      visited: false,
      ambientSound: "wind_howling.mp3"
    },
    deep_woods: {
      name: "DEEP WOODS",
      description: "The canopy blocks nearly all light here. Strange symbols are carved into some trees. You feel watched. The air is thick with the scent of pine and something metallic. To the south is the way back to the woods edge.",
      exits: {
        south: "woods_edge",
        east: "clearing",
        west: "old_grove"
      },
      npcs: ["log_lady"],
      items: ["strange_feather"],
      encounters: ["shadow_figure", "man_with_no_face"],
      visited: false,
      ambientSound: "whispering_trees.mp3"
    },
    abandoned_cabin: {
      name: "ABANDONED CABIN",
      description: "The cabin's door hangs open, revealing darkness within. Faint scratching sounds come from the walls. The floorboards creak ominously as you step inside. The woods lie to the west.",
      exits: {
        west: "woods_edge",
        north: "clearing"
      },
      npcs: [],
      items: ["old_journal"],
      encounters: ["ghostly_figure", "rats"],
      visited: false,
      ambientSound: "creaking_wood.mp3"
    },
    town_entrance: {
      name: "TOWN ENTRANCE",
      description: "A rusted sign welcomes you to Wolf Lake. The few visible houses have boarded windows. The woods loom to the north, promising answers... or doom.",
      exits: {
        north: "woods_edge",
        east: "general_store",
        west: "police_station"
      },
      npcs: [],
      items: [],
      encounters: ["suspicious_townsfolk"],
      visited: false,
      ambientSound: "distant_dogs.mp3"
    },
    lakeshore: {
      name: "LAKESHORE",
      description: "The black waters of Wolf Lake lap quietly against the shore. Something moves beneath the surface, creating ripples with no apparent cause. The woods lie to the east.",
      exits: {
        east: "woods_edge",
        north: "old_grove"
      },
      npcs: [],
      items: ["rusted_key"],
      encounters: ["drowned_thing"],
      visited: false,
      ambientSound: "water_lapping.mp3"
    },
    clearing: {
      name: "FOREST CLEARING",
      description: "A circular clearing with unnaturally smooth ground. The trees here grow in a perfect ring. You feel a pressure in your ears, like a sound just beyond hearing.",
      exits: {
        south: "abandoned_cabin",
        west: "deep_woods"
      },
      npcs: [],
      items: ["strange_artifact"],
      encounters: ["man_with_no_face"],
      visited: false,
      ambientSound: "static_hum.mp3"
    },
    old_grove: {
      name: "OLD GROVE",
      description: "Ancient trees with blackened bark stand in silent vigil. The air smells of ozone and decay. Strange symbols are carved into every surface.",
      exits: {
        south: "lakeshore",
        east: "deep_woods"
      },
      npcs: ["stranger"],
      items: [],
      encounters: ["shadow_figure", "man_with_no_face"],
      visited: false,
      ambientSound: "distant_chanting.mp3"
    },
    police_station: {
      name: "POLICE STATION",
      description: "The small station has seen better days. The sheriff eyes you warily from behind the front desk. Wanted posters cover the walls, some with faces scratched out.",
      exits: {
        east: "town_entrance"
      },
      npcs: ["sheriff"],
      items: ["case_files"],
      encounters: [],
      visited: false,
      ambientSound: "radio_static.mp3"
    },
    general_store: {
      name: "GENERAL STORE",
      description: "A bell jingles as you enter. Dust covers the shelves, but some supplies remain. The shopkeeper watches you with hollow eyes.",
      exits: {
        west: "town_entrance"
      },
      npcs: ["shopkeeper"],
      items: ["ammo", "medkit"],
      encounters: [],
      visited: false,
      ambientSound: "creaking_floorboards.mp3"
    }
  },
  level2: {
    old_mill: {
      name: "OLD MILL",
      description: "The abandoned mill creaks ominously in the wind. Strange lights flicker from within. The air smells of ozone and something metallic.",
      exits: {
        south: "dark_forest",
        east: "cursed_well"
      },
      npcs: [],
      items: ["strange_device"],
      encounters: ["shadow_entity", "twisted_humanoid"],
      visited: false,
      ambientSound: "mechanical_hum.mp3"
    },
    dark_forest: {
      name: "DARK FOREST",
      description: "The trees here are blackened and twisted, their branches forming unnatural shapes against the sky. The air hums with an eerie energy.",
      exits: {
        north: "old_mill",
        east: "black_lodge",
        west: "ruined_church"
      },
      npcs: [],
      items: ["black_feather"],
      encounters: ["shadow_entity", "whispering_wraith"],
      visited: false,
      ambientSound: "distant_screams.mp3"
    },
    cursed_well: {
      name: "CURSED WELL",
      description: "An ancient stone well stands in a small clearing. The water within is black as ink, and occasionally something moves beneath its surface.",
      exits: {
        west: "old_mill",
        north: "black_lodge"
      },
      npcs: [],
      items: ["ancient_coin"],
      encounters: ["drowned_spirit", "well_ghost"],
      visited: false,
      ambientSound: "dripping_water.mp3"
    },
    black_lodge: {
      name: "BLACK LODGE",
      description: "A strange structure of blackened wood and red curtains. Time seems to move differently here. The air is thick with an oppressive presence.",
      exits: {
        south: "cursed_well",
        west: "dark_forest"
      },
      npcs: ["doppelganger"],
      items: ["red_key"],
      encounters: ["doppelganger", "lodge_spirit"],
      visited: false,
      ambientSound: "distorted_voices.mp3"
    },
    ruined_church: {
      name: "RUINED CHURCH",
      description: "The remains of a small church, its walls scorched and its altar defiled. Strange symbols cover every surface, glowing faintly in the dark.",
      exits: {
        east: "dark_forest",
        north: "graveyard"
      },
      npcs: [],
      items: ["holy_symbol"],
      encounters: ["fallen_priest", "defiled_spirit"],
      visited: false,
      ambientSound: "choir_of_damned.mp3"
    },
    graveyard: {
      name: "ANCIENT GRAVEYARD",
      description: "Tombstones tilt at impossible angles, their inscriptions long worn away. The ground is disturbed in places, as if something has dug its way out.",
      exits: {
        south: "ruined_church",
        east: "witch_hut"
      },
      npcs: [],
      items: ["bone_charm"],
      encounters: ["risen_corpse", "ghoul"],
      visited: false,
      ambientSound: "earth_moving.mp3"
    },
    witch_hut: {
      name: "WITCH'S HUT",
      description: "A crooked hut stands amidst a circle of toadstools. The smell of strange herbs and something more sinister hangs in the air.",
      exits: {
        west: "graveyard",
        north: "blood_marsh"
      },
      npcs: ["witch"],
      items: ["hex_bag"],
      encounters: ["witch_apparition", "familiar"],
      visited: false,
      ambientSound: "bubbling_cauldron.mp3"
    },
    blood_marsh: {
      name: "BLOOD MARSH",
      description: "The ground is soft and red here, the water stained like blood. Strange lights dance above the surface at night, and things move beneath the muck.",
      exits: {
        south: "witch_hut",
        east: "sacrifice_circle"
      },
      npcs: [],
      items: ["blood_vial"],
      encounters: ["marsh_creature", "will_o_wisp"],
      visited: false,
      ambientSound: "wet_footsteps.mp3"
    },
    sacrifice_circle: {
      name: "SACRIFICE CIRCLE",
      description: "A perfect circle of standing stones surrounds an altar stained black. The air crackles with residual energy from ancient rites.",
      exits: {
        west: "blood_marsh",
        north: "portal_site"
      },
      npcs: [],
      items: ["ritual_knife"],
      encounters: ["summoned_demon", "cultist"],
      visited: false,
      ambientSound: "chanting.mp3"
    },
    portal_site: {
      name: "PORTAL SITE",
      description: "The trees form a perfect ring here, their branches twisted into an arch. The air within shimmers like heat haze, revealing glimpses of somewhere... else.",
      exits: {
        south: "sacrifice_circle"
      },
      npcs: ["gatekeeper"],
      items: ["dimensional_shard"],
      encounters: ["dimensional_horror", "void_walker"],
      visited: false,
      ambientSound: "dimensional_tear.mp3"
    }
  }
};

// NPCs
const npcs = {
  sheriff: {
    name: "Sheriff Truman",
    description: "The local sheriff eyes you with suspicion but also curiosity. He's seen things he won't talk about. His hand rests near his holster as he assesses you.",
    dialog: [
      {
        question: "Ask about missing agent",
        response: "Agent Mulder? He was last seen near the old mill. But I'd stay away... things aren't right there.",
        trustReq: 30,
        sanityEffect: -5,
        questTrigger: "find_missing_agent"
      },
      {
        question: "Ask about strange occurrences",
        response: "Lights in the sky. People acting strange. Animals born wrong. You feds never believe us though.",
        trustReq: 50,
        sanityEffect: -10,
        questTrigger: "strange_lights"
      },
      {
        question: "Request backup",
        response: "I can't spare any men. Not for this. Not after what happened to Deputy Briggs.",
        trustReq: 70,
        sanityEffect: -5
      },
      {
        question: "What happened to Deputy Briggs?",
        response: "His body was found... changed. Like something had rewritten him from the inside out.",
        trustReq: 80,
        sanityEffect: -15,
        sanityCheck: 50
      }
    ],
    creepiness: 30
  },
  log_lady: {
    name: "The Log Lady",
    description: "An elderly woman cradles a log, whispering to it. She turns suddenly to look at you with unsettling clarity. Her eyes seem to see through you.",
    dialog: [
      {
        question: "Ask about your log",
        response: "The log knows. The log sees. The owls are not what they seem.",
        trustReq: 0,
        sanityEffect: -10
      },
      {
        question: "Ask about the woods",
        response: "They breathe when you're not looking. Turn around quickly... see?",
        trustReq: 40,
        sanityEffect: -15,
        sanityCheck: 30
      },
      {
        question: "Ask about the lights",
        response: "Fire walks with them. But you mustn't look directly. They take those who look.",
        trustReq: 60,
        sanityEffect: -20,
        questTrigger: "strange_lights"
      },
      {
        question: "Who are 'they'?",
        response: "The ones who come from the place where the angles are wrong. The ones who wear familiar faces.",
        trustReq: 80,
        sanityEffect: -25,
        sanityCheck: 40
      }
    ],
    creepiness: 90
  },
  shopkeeper: {
    name: "Mr. Nez",
    description: "The shopkeeper's hands shake as he rings up your purchase. He keeps glancing at the door, as if expecting someone... or something.",
    dialog: [
      {
        question: "Ask about supplies",
        response: "Got some ammo and first aid kits left. Not much call for them these days... most folks stay inside after dark.",
        trustReq: 0,
        sanityEffect: -5
      },
      {
        question: "Ask about the town",
        response: "Used to be a nice place. Then the lights started coming, and people started changing.",
        trustReq: 40,
        sanityEffect: -10
      },
      {
        question: "Ask about the lights",
        response: "They come from the old mill. But no one goes there anymore. Not if they want to stay... human.",
        trustReq: 60,
        sanityEffect: -15,
        questTrigger: "strange_lights"
      }
    ],
    creepiness: 60
  },
  stranger: {
    name: "The Stranger",
    description: "A tall figure in a long coat stands beneath the blackened trees. His face is obscured by shadows, but you feel his gaze like a physical weight.",
    dialog: [
      {
        question: "Ask who he is",
        response: "I am what remains between. The watcher at the threshold.",
        trustReq: 0,
        sanityEffect: -15
      },
      {
        question: "Ask about the symbols",
        response: "They are warnings. And invitations. The old ones left them to mark the thin places.",
        trustReq: 50,
        sanityEffect: -20,
        sanityCheck: 40
      },
      {
        question: "Ask about the missing agent",
        response: "He looked too long into the black lodge. Now he walks between worlds.",
        trustReq: 70,
        sanityEffect: -25,
        questTrigger: "find_missing_agent"
      }
    ],
    creepiness: 95
  },
  doppelganger: {
    name: "The Doppelganger",
    description: "A figure that looks exactly like you stands before you, its smile just slightly too wide. Its eyes reflect nothing but darkness.",
    dialog: [
      {
        question: "Ask who you are",
        response: "I am you, but more. I am what you could become if you embrace the darkness.",
        trustReq: 0,
        sanityEffect: -20
      },
      {
        question: "Ask about the lodge",
        response: "This place exists between worlds. Here, all possibilities are true. Even the terrible ones.",
        trustReq: 50,
        sanityEffect: -25,
        sanityCheck: 40
      },
      {
        question: "Ask about the missing agent",
        response: "He became one of us. Soon, you will too.",
        trustReq: 70,
        sanityEffect: -30,
        questTrigger: "find_missing_agent"
      }
    ],
    creepiness: 100
  },
  witch: {
    name: "The Witch",
    description: "An ancient woman stirs a bubbling cauldron. Her eyes are milky white, yet she seems to see right through you.",
    dialog: [
      {
        question: "Ask about her magic",
        response: "The old ways still hold power here, where the veil is thin. But all power comes with a price.",
        trustReq: 0,
        sanityEffect: -15
      },
      {
        question: "Ask for help",
        response: "I could help you... for a price. A lock of your hair. A drop of your blood. A moment of your time.",
        trustReq: 40,
        sanityEffect: -20,
        sanityCheck: 30
      },
      {
        question: "Ask about the portal",
        response: "The gate must not be opened! They wait on the other side, hungry and patient.",
        trustReq: 60,
        sanityEffect: -25,
        questTrigger: "black_lodge"
      }
    ],
    creepiness: 85
  },
  gatekeeper: {
    name: "The Gatekeeper",
    description: "A tall figure in tattered robes stands before the shimmering portal. Its face is hidden in shadow, but you feel its gaze like a physical weight.",
    dialog: [
      {
        question: "Ask about the portal",
        response: "This is the threshold. Beyond lies the place where the angles are wrong and time has no meaning.",
        trustReq: 0,
        sanityEffect: -25
      },
      {
        question: "Ask to pass",
        response: "None may pass without the key. And even then, none return unchanged.",
        trustReq: 50,
        sanityEffect: -30,
        sanityCheck: 50
      },
      {
        question: "Ask about the missing agent",
        response: "He passed beyond and became something else. You will too, in time.",
        trustReq: 70,
        sanityEffect: -35,
        questTrigger: "find_missing_agent"
      }
    ],
    creepiness: 100
  }
};

// Enemies
const enemies = {
  shadow_figure: {
    name: "Shadow Figure",
    hp: 50,
    maxHp: 50,
    damage: 10,
    creepiness: 70,
    xp: 25,
    description: "A humanoid shape of pure darkness steps from between the trees. Where its face should be is only a deeper blackness that seems to drink in the light around it.",
    attacks: [
      "Your skin crawls as it reaches for you with elongated fingers.",
      "It whispers your name in a voice not its own, echoing from everywhere at once.",
      "The temperature drops sharply as it moves closer, your breath visible in the suddenly frigid air."
    ],
    special: "The shadow figure's form wavers and distorts, making it hard to focus. Your attack is less effective!",
    weakness: "light",
    resistance: "psychic"
  },
  man_with_no_face: {
    name: "Man With No Face",
    hp: 80,
    maxHp: 80,
    damage: 15,
    creepiness: 90,
    xp: 40,
    description: "A man in a black suit stands perfectly still. As he turns, you see he has no facial features at all - just smooth skin where eyes, nose and mouth should be.",
    attacks: [
      "He moves impossibly fast, striking with inhuman strength that sends you sprawling.",
      "A soundless scream comes from where his mouth should be, making your head pound.",
      "His hands grip you with unnatural strength, cold seeping into your bones."
    ],
    special: "The man's blank face seems to shift momentarily, showing you something terrible. You freeze in terror!",
    weakness: "psychic",
    resistance: "physical"
  },
  owl: {
    name: "Giant Owl",
    hp: 30,
    maxHp: 30,
    damage: 5,
    creepiness: 60,
    xp: 15,
    description: "An owl the size of a man watches you with unblinking eyes. Its head rotates too far as it tracks your movements.",
    attacks: [
      "The owl swoops down, talons raking across your shoulders.",
      "It lets out a screech that sounds almost like words, disorienting you.",
      "The creature's massive wings buffet you as it attacks."
    ],
    special: "The owl's eyes glow unnaturally, freezing you in place for a moment!",
    weakness: "firearms",
    resistance: "psychic"
  },
  drowned_thing: {
    name: "Drowned Thing",
    hp: 60,
    maxHp: 60,
    damage: 12,
    creepiness: 75,
    xp: 30,
    description: "A bloated humanoid form crawls from the water, its skin pale and peeling. Where its eyes should be are only dark, empty sockets that somehow still watch you.",
    attacks: [
      "The thing grabs you with waterlogged hands, its grip impossibly strong.",
      "It vomits a stream of black water into your face, choking you.",
      "The stench of decay overwhelms you as it closes in."
    ],
    special: "The thing's form dissolves into water, reforming behind you!",
    weakness: "fire",
    resistance: "water"
  },
  ghostly_figure: {
    name: "Ghostly Figure",
    hp: 40,
    maxHp: 40,
    damage: 8,
    creepiness: 80,
    xp: 20,
    description: "A translucent figure drifts toward you, its features shifting between familiar faces. Its mournful wail sends chills down your spine.",
    attacks: [
      "The ghost passes through you, filling your body with unnatural cold.",
      "It whispers secrets in your ear that make your head swim.",
      "The figure's eyes glow red as it reaches for your throat."
    ],
    special: "The ghost phases through your attack, taking reduced damage!",
    weakness: "salt",
    resistance: "physical"
  },
  rats: {
    name: "Swarm of Rats",
    hp: 25,
    maxHp: 25,
    damage: 6,
    creepiness: 50,
    xp: 10,
    description: "Hundreds of rats pour from the walls, their eyes glowing red. They move with unnatural coordination.",
    attacks: [
      "The rats climb up your legs, biting and scratching.",
      "They form into a grotesque humanoid shape that lunges at you.",
      "The swarm surrounds you, cutting off escape."
    ],
    special: "More rats join the swarm, healing some damage!",
    weakness: "fire",
    resistance: "psychic"
  },
  suspicious_townsfolk: {
    name: "Suspicious Townsfolk",
    hp: 35,
    maxHp: 35,
    damage: 7,
    creepiness: 65,
    xp: 15,
    description: "A group of locals block your path. Their movements are jerky and their smiles don't reach their dead eyes.",
    attacks: [
      "They grab at you with too-long fingers.",
      "One whispers your name despite you never introducing yourself.",
      "Their mouths open too wide as they advance."
    ],
    special: "Their numbers seem to shift and change, confusing you!",
    weakness: "firearms",
    resistance: "none"
  },
  // Level 2 enemies
  shadow_entity: {
    name: "Shadow Entity",
    hp: 80,
    maxHp: 80,
    damage: 15,
    creepiness: 85,
    xp: 45,
    description: "A swirling mass of darkness that seems to absorb all light around it. Within its form, faces briefly appear and then dissolve into the void.",
    attacks: [
      "Tendrils of darkness lash out, leaving frostbite where they touch.",
      "It emits a soundless scream that makes your vision blur and your ears bleed.",
      "The temperature plummets as it engulfs you in its chilling embrace."
    ],
    special: "The entity splits into multiple forms, confusing you and making your attack less effective!",
    weakness: "holy",
    resistance: "physical"
  },
  twisted_humanoid: {
    name: "Twisted Humanoid",
    hp: 100,
    maxHp: 100,
    damage: 18,
    creepiness: 90,
    xp: 50,
    description: "A human figure with limbs bent at impossible angles, its joints popping as it moves. Its face is stretched into a permanent scream.",
    attacks: [
      "It contorts its body to strike from an unexpected angle, catching you off guard.",
      "The creature's mouth unhinges like a snake's, biting down with jagged teeth.",
      "Its elongated fingers dig into your flesh like claws."
    ],
    special: "The creature's form twists and reforms, making your attack less effective!",
    weakness: "fire",
    resistance: "psychic"
  },
  whispering_wraith: {
    name: "Whispering Wraith",
    hp: 60,
    maxHp: 60,
    damage: 12,
    creepiness: 80,
    xp: 35,
    description: "A spectral figure surrounded by a chorus of whispering voices. The words are indistinct but fill you with dread.",
    attacks: [
      "The whispers grow louder, making it hard to think or focus.",
      "The wraith phases through your body, leaving you chilled to the bone.",
      "It shows you flashes of your worst memories, paralyzing you with fear."
    ],
    special: "The whispers invade your mind, making you hesitate!",
    weakness: "salt",
    resistance: "physical"
  },
  drowned_spirit: {
    name: "Drowned Spirit",
    hp: 70,
    maxHp: 70,
    damage: 14,
    creepiness: 75,
    xp: 40,
    description: "A waterlogged spirit with seaweed for hair and glowing green eyes. Water constantly pours from its mouth and clothes.",
    attacks: [
      "It vomits a stream of black water that burns like acid.",
      "The spirit's cold, bloated hands grab you with unnatural strength.",
      "It drags you toward the well, trying to pull you in."
    ],
    special: "The spirit dissolves into water, reforming behind you!",
    weakness: "holy",
    resistance: "water"
  },
  doppelganger: {
    name: "Doppelganger",
    hp: 90,
    maxHp: 90,
    damage: 16,
    creepiness: 95,
    xp: 55,
    description: "A perfect copy of yourself, but with hollow black eyes and a smile that's just slightly too wide.",
    attacks: [
      "It mimics your movements perfectly, anticipating your every dodge.",
      "The doppelganger whispers your deepest fears in your own voice.",
      "It shows you visions of your own death, shaking your resolve."
    ],
    special: "The doppelganger predicts your attack and dodges at the last moment!",
    weakness: "psychic",
    resistance: "firearms"
  },
  dimensional_horror: {
    name: "Dimensional Horror",
    hp: 120,
    maxHp: 120,
    damage: 20,
    creepiness: 100,
    xp: 70,
    description: "A being that exists partially in our dimension and partially elsewhere. Its form shifts constantly, never settling on one shape.",
    attacks: [
      "Reality warps around it, making your attacks less effective.",
      "It shows you glimpses of impossible geometries that hurt your mind.",
      "The creature phases in and out of existence, striking when you least expect it."
    ],
    special: "The horror shifts dimensions, making your attack pass through it harmlessly!",
    weakness: "occult",
    resistance: "all"
  }
};

// Items
const items = {
  strange_feather: {
    name: "Strange Feather",
    type: "occult",
    description: "A feather that's too large to be from any known bird. It feels warm to the touch.",
    use: function() {
      addMessage("The feather vibrates slightly in your hand. You hear distant whispering...");
      gameState.sanity -= 5;
      updateStats();
    }
  },
  old_journal: {
    name: "Old Journal",
    type: "clue",
    description: "A water-damaged journal with frantic handwriting. Most pages are illegible.",
    use: function() {
      addMessage("You decipher a passage: 'They come from the stars but live beneath us. The trees are their sentinels.'");
      gameState.quests.find(q => q.id === "find_missing_agent").progress += 20;
    }
  },
  rusted_key: {
    name: "Rusted Key",
    type: "key",
    description: "An old iron key, heavily corroded. It feels unnaturally cold.",
    use: function() {
      addMessage("The key fits no lock you've tried. Yet sometimes, in the dark, you hear it jingle on its own...");
    }
  },
  strange_artifact: {
    name: "Strange Artifact",
    type: "occult",
    description: "A smooth black stone with impossible angles. Looking at it makes your eyes water.",
    use: function() {
      addMessage("The artifact hums in your hand. For a moment, the world seems to twist around you.");
      gameState.sanity -= 10;
      updateStats();
    }
  },
  case_files: {
    name: "Case Files",
    type: "clue",
    description: "Police reports detailing strange disappearances around Wolf Lake.",
    use: function() {
      addMessage("The files mention repeated sightings of 'tall figures' near the old mill at night.");
      gameState.quests.find(q => q.id === "find_missing_agent").progress += 15;
    }
  },
  salt_pouch: {
    name: "Salt Pouch",
    type: "consumable",
    description: "A small pouch of blessed salt. Effective against spirits.",
    uses: 3,
    use: function() {
      if (gameState.combat && enemies[gameState.combat.enemy].weakness === "salt") {
        const enemy = enemies[gameState.combat.enemy];
        const damage = 30;
        gameState.combat.enemyHp -= damage;

        addCombatMessage(`You throw salt at the ${enemy.name}! It screams as the salt burns its spectral form for ${damage} damage!`);

        // Update enemy health bar
        const enemyHealthPercent = (gameState.combat.enemyHp / enemy.maxHp) * 100;
        document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;

        this.uses--;
        if (this.uses <= 0) {
          const index = gameState.inventory.findIndex(item => item.name === "Salt Pouch");
          if (index !== -1) {
            gameState.inventory.splice(index, 1);
          }
        }
        renderInventory();

        if (gameState.combat.enemyHp <= 0) {
          setTimeout(() => endCombat(true), 1000);
        }
      } else {
        addMessage("The salt doesn't seem to have any effect here.");
      }
    }
  },
  holy_water: {
    name: "Holy Water",
    type: "consumable",
    description: "A small vial of blessed water. Can purify and harm the unnatural.",
    uses: 2,
    use: function() {
      if (gameState.combat) {
        const enemy = enemies[gameState.combat.enemy];
        let damage = 20;

        if (enemy.weakness === "holy") {
          damage = 40;
          addCombatMessage(`The holy water burns the ${enemy.name} like acid! It takes ${damage} damage!`);
        } else {
          addCombatMessage(`You splash holy water on the ${enemy.name}, dealing ${damage} damage.`);
        }

        gameState.combat.enemyHp -= damage;

        // Update enemy health bar
        const enemyHealthPercent = (gameState.combat.enemyHp / enemy.maxHp) * 100;
        document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;

        this.uses--;
        if (this.uses <= 0) {
          const index = gameState.inventory.findIndex(item => item.name === "Holy Water");
          if (index !== -1) {
            gameState.inventory.splice(index, 1);
          }
        }
        renderInventory();

        if (gameState.combat.enemyHp <= 0) {
          setTimeout(() => endCombat(true), 1000);
        }
      } else {
        addMessage("You sprinkle the holy water around you, feeling a temporary sense of protection.");
        gameState.sanity = Math.min(100, gameState.sanity + 10);
        updateStats();
      }
    }
  },
  flare: {
    name: "Flare",
    type: "consumable",
    description: "A bright emergency flare. Can scare away creatures of darkness.",
    uses: 1,
    use: function() {
      if (gameState.combat && enemies[gameState.combat.enemy].weakness === "light") {
        const enemy = enemies[gameState.combat.enemy];
        addCombatMessage(`You ignite the flare! The ${enemy.name} shrieks and recoils from the bright light!`);

        // End combat with victory
        setTimeout(() => endCombat(true), 1000);

        // Remove item after use
        const index = gameState.inventory.findIndex(item => item.name === "Flare");
        if (index !== -1) {
          gameState.inventory.splice(index, 1);
        }
        renderInventory();
      } else if (gameState.combat) {
        addCombatMessage("The flare burns brightly but doesn't seem to affect the enemy much.");

        // Remove item after use
        const index = gameState.inventory.findIndex(item => item.name === "Flare");
        if (index !== -1) {
          gameState.inventory.splice(index, 1);
        }
        renderInventory();
      } else {
        addMessage("You ignite the flare, illuminating the area brightly for a moment.");
      }
    }
  },
  ammo: {
    name: "Ammo",
    type: "ammo",
    amount: 5,
    description: "5 rounds of 9mm ammunition for your pistol.",
    use: function() {
      const pistol = gameState.inventory.find(item => item.name === "Pistol");
      if (pistol) {
        const ammoToAdd = Math.min(this.amount, pistol.maxAmmo - pistol.ammo);
        pistol.ammo += ammoToAdd;

        if (ammoToAdd > 0) {
          addMessage(`Loaded ${ammoToAdd} rounds into your pistol. Total ammo: ${pistol.ammo}/${pistol.maxAmmo}`);

          // Remove the ammo item if all ammo was used
          if (ammoToAdd === this.amount) {
            const index = gameState.inventory.findIndex(item => item.name === "Ammo");
            if (index !== -1) {
              gameState.inventory.splice(index, 1);
            }
          } else {
            // Update remaining ammo in the item
            this.amount -= ammoToAdd;
          }

          renderInventory();
        } else {
          addMessage("Your pistol is already fully loaded.");
        }
      } else {
        addMessage("You don't have a pistol to use this ammo with.");
      }
    }
  },
  medkit: {
    name: "Medkit",
    type: "consumable",
    hpRestore: 40,
    uses: 1,
    description: "Restores 40 HP when used.",
    use: function() {
      gameState.hp = Math.min(gameState.hp + this.hpRestore, gameState.maxHp);
      addMessage(`You use the medkit and restore ${this.hpRestore} HP.`);

      // Remove after use
      const index = gameState.inventory.findIndex(item => item.name === "Medkit");
      if (index !== -1) {
        gameState.inventory.splice(index, 1);
      }
      updateStats();
      renderInventory();
    }
  },
  // Level 2 items
  strange_device: {
    name: "Strange Device",
    type: "occult",
    description: "A metallic object with no visible moving parts. It hums quietly and feels warm to the touch.",
    use: function() {
      addMessage("The device pulses in your hand. For a moment, you see strange symbols floating in the air around you.");
      gameState.sanity -= 10;
      updateStats();
    }
  },
  black_feather: {
    name: "Black Feather",
    type: "occult",
    description: "A feather that's completely black, absorbing all light. It feels unnaturally heavy.",
    use: function() {
      addMessage("The feather seems to whisper to you in a language you don't understand but somehow comprehend.");
      gameState.sanity -= 8;
      updateStats();
    }
  },
  ancient_coin: {
    name: "Ancient Coin",
    type: "key",
    description: "A tarnished silver coin with strange markings. It's cold to the touch, even in warm environments.",
    use: function() {
      addMessage("The coin grows warm in your hand. You hear distant chanting for a brief moment.");
    }
  },
  red_key: {
    name: "Red Key",
    type: "key",
    description: "A key made of an unknown red metal. It pulses faintly, as if alive.",
    use: function() {
      addMessage("The key vibrates in your hand. You feel a strange pull toward the portal site.");
    }
  },
  holy_symbol: {
    name: "Holy Symbol",
    type: "tool",
    description: "A silver religious symbol that glows faintly in the presence of evil.",
    use: function() {
      addMessage("The symbol glows brightly, pushing back the darkness momentarily.");
      gameState.sanity = Math.min(100, gameState.sanity + 15);
      updateStats();
    }
  },
  bone_charm: {
    name: "Bone Charm",
    type: "occult",
    description: "A charm made from carved bone. It whispers secrets when held close to the ear.",
    use: function() {
      addMessage("The charm whispers forbidden knowledge to you. Your mind struggles to comprehend it.");
      gameState.sanity -= 12;
      updateStats();
    }
  },
  hex_bag: {
    name: "Hex Bag",
    type: "consumable",
    description: "A small cloth bag filled with strange herbs and other unidentifiable ingredients.",
    uses: 1,
    use: function() {
      if (gameState.combat) {
        const damage = 25;
        gameState.combat.enemyHp -= damage;
        addCombatMessage(`You throw the hex bag at the enemy! It explodes in a cloud of noxious smoke, dealing ${damage} damage!`);

        // Update enemy health bar
        const enemyHealthPercent = (gameState.combat.enemyHp / enemies[gameState.combat.enemy].maxHp) * 100;
        document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;

        // Remove item
        const index = gameState.inventory.findIndex(item => item.name === "Hex Bag");
        if (index !== -1) {
          gameState.inventory.splice(index, 1);
        }
        renderInventory();

        if (gameState.combat.enemyHp <= 0) {
          setTimeout(() => endCombat(true), 1000);
        }
      } else {
        addMessage("The hex bag pulses with dark energy. You decide not to open it.");
      }
    }
  },
  blood_vial: {
    name: "Blood Vial",
    type: "consumable",
    description: "A small vial filled with dark, thick liquid that moves on its own.",
    uses: 1,
    use: function() {
      gameState.hp = Math.min(gameState.hp + 50, gameState.maxHp);
      gameState.sanity = Math.max(0, gameState.sanity - 15);
      addMessage("You drink the contents of the vial. It restores your health but leaves a metallic taste and disturbing visions.");
      updateStats();

      // Remove item
      const index = gameState.inventory.findIndex(item => item.name === "Blood Vial");
      if (index !== -1) {
        gameState.inventory.splice(index, 1);
      }
      renderInventory();
    }
  },
  ritual_knife: {
    name: "Ritual Knife",
    type: "weapon",
    damage: 20,
    description: "An ornate dagger covered in ancient runes. It hums with dark energy.",
    use: function() {
      if (gameState.combat) {
        const damage = 20 + gameState.skills.occult * 3;
        gameState.combat.enemyHp -= damage;
        addCombatMessage(`You stab with the ritual knife! Dark energy courses through the blade, dealing ${damage} damage!`);

        // Update enemy health bar
        const enemyHealthPercent = (gameState.combat.enemyHp / enemies[gameState.combat.enemy].maxHp) * 100;
        document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;

        if (gameState.combat.enemyHp <= 0) {
          setTimeout(() => endCombat(true), 1000);
        }
      } else {
        addMessage("The knife pulses in your hand. You feel its dark energy calling to you.");
      }
    }
  },
  dimensional_shard: {
    name: "Dimensional Shard",
    type: "occult",
    description: "A fragment of crystal that seems to contain a swirling galaxy within. Looking at it makes your head hurt.",
    use: function() {
      addMessage("The shard shows you glimpses of other worlds, other times. Your mind struggles to process what you're seeing.");
      gameState.sanity = Math.max(0, gameState.sanity - 20);
      gameState.skills.occult += 1;
      updateStats();
    }
  }
};

// =====================
// GAME FUNCTIONS
// =====================
function initGame() {
  updateStats();
  renderInventory();
  startGameTime();
  // Show level select button if level is completed
  if (gameState.levelCompleted) {
    document.getElementById('level-select-btn').style.display = 'block';
  }
}

function showNotification(message) {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.style.display = 'block';

  // Reset animation
  notification.style.animation = 'none';
  void notification.offsetWidth; // Trigger reflow
  notification.style.animation = 'fadeInOut 3s forwards';

  setTimeout(() => {
    notification.style.display = 'none';
  }, 3000);
}

function updateStats() {
  // Update numbers
  document.getElementById('hp').textContent = gameState.hp;
  document.getElementById('max-hp').textContent = gameState.maxHp;
  document.getElementById('level').textContent = gameState.level;
  document.getElementById('xp').textContent = gameState.xp;
  document.getElementById('next-level').textContent = gameState.nextLevel;
  document.getElementById('sanity').textContent = gameState.sanity;

  // Update combat stats if in combat
  if (gameState.combat) {
    document.getElementById('player-hp').textContent = gameState.hp;
    document.getElementById('player-max-hp').textContent = gameState.maxHp;
    document.getElementById('enemy-hp').textContent = gameState.combat.enemyHp;
    document.getElementById('enemy-max-hp').textContent = enemies[gameState.combat.enemy].maxHp;
  }

  // Update progress bars
  document.getElementById('hp-bar').style.width = `${(gameState.hp / gameState.maxHp) * 100}%`;
  document.getElementById('sanity-bar').style.width = `${gameState.sanity}%`;
  document.getElementById('xp-bar').style.width = `${(gameState.xp / gameState.nextLevel) * 100}%`;

  // Sanity effects
  if (gameState.sanity < 30) {
    document.body.classList.add('low-sanity');
  } else {
    document.body.classList.remove('low-sanity');
  }
}

function startGameTime() {
  setInterval(() => {
    gameState.gameTime++;
    // Every 10 minutes, small sanity drain if in creepy location
    if (gameState.gameTime % 10 === 0) {
      const loc = getCurrentLocation();
      if (loc.npcs.length > 0) {
        const npc = npcs[loc.npcs[0]];
        if (npc && npc.creepiness > 70) {
          gameState.sanity = Math.max(0, gameState.sanity - 1);
          updateStats();
        }
      }
    }
  }, 1000);
}

function getCurrentLocation() {
  return locations[`level${gameState.level}`][gameState.currentLocation];
}

function move(direction) {
  if (gameState.combat) {
    addMessage("You can't move while in combat!");
    return;
  }

  const currentLoc = getCurrentLocation();

  // Check if direction is valid
  if (!currentLoc.exits[direction]) {
    addMessage("You can't go that way.");
    return;
  }

  gameState.currentLocation = currentLoc.exits[direction];
  const newLoc = getCurrentLocation();
  document.getElementById('location').textContent = newLoc.name;

  if (!newLoc.visited) {
    addMessage(newLoc.description);
    newLoc.visited = true;

    // Track location progress
    gameState.levelProgress.locationsVisited++;
    checkLevelCompletion();

    // Check for random encounter (higher chance in new locations)
    if (Math.random() < 0.7 && newLoc.encounters.length > 0) {
      setTimeout(() => {
        const encounter = newLoc.encounters[Math.floor(Math.random() * newLoc.encounters.length)];
        startCombat(encounter);
      }, 1000);
      return;
    }
  } else {
    addMessage(`Back at ${newLoc.name}. ${newLoc.description.split('.')[0]}.`);

    // Still possible to encounter enemies in visited locations (lower chance)
    if (Math.random() < 0.3 && newLoc.encounters.length > 0) {
      setTimeout(() => {
        const encounter = newLoc.encounters[Math.floor(Math.random() * newLoc.encounters.length)];
        startCombat(encounter);
      }, 1000);
      return;
    }
  }

  // Check for items in the location
  if (newLoc.items.length > 0 && !gameState.visitedLocations.includes(gameState.currentLocation)) {
    const itemKey = newLoc.items[0];
    const item = items[itemKey];

    setTimeout(() => {
      if (itemKey === "ammo") {
        // Special handling for ammo - add directly to pistol
        const pistol = gameState.inventory.find(item => item.name === "Pistol");
        if (pistol) {
          const ammoToAdd = Math.min(item.amount, pistol.maxAmmo - pistol.ammo);
          pistol.ammo += ammoToAdd;
          addMessage(`You found ${ammoToAdd} rounds of ammo! They've been added to your pistol. Total ammo: ${pistol.ammo}/${pistol.maxAmmo}`);
          renderInventory();
        } else {
          // If no pistol, add to inventory as normal
          addMessage(`You found ${item.name}. It's been added to your inventory.`);
          gameState.inventory.push({
            name: item.name,
            type: item.type,
            description: item.description,
            amount: item.amount
          });
          renderInventory();
        }
      } else {
        // Normal item handling
        addMessage(`You found a ${item.name}. It's been added to your inventory.`);
        gameState.inventory.push({
          name: item.name,
          type: item.type,
          description: item.description,
          uses: item.uses || -1
        });
        renderInventory();
      }

      // Mark location as visited for items
      gameState.visitedLocations.push(gameState.currentLocation);
    }, 500);
  }

  // Check for NPCs
  updateNPCPresence();
}

function checkLevelCompletion() {
  // Check if all locations visited and enemies defeated
  if (gameState.levelProgress.locationsVisited >= gameState.levelProgress.totalLocations &&
      gameState.levelProgress.enemiesDefeated >= gameState.levelProgress.totalEnemies) {
    gameState.levelCompleted = true;
    document.getElementById('level-select-btn').style.display = 'block';
    
    // Only show transition screen if it hasn't been shown before
    if (!gameState.levelTransitionShown) {
      showLevelTransition();
      gameState.levelTransitionShown = true;
    }
  }
}

function showLevelTransition() {
  document.getElementById('level-transition-text').textContent = 
    `You've explored all locations and defeated all enemies of Level ${gameState.level}. ` +
    `Ready to progress to Level ${gameState.level + 1}?`;
  document.getElementById('level-transition').style.display = 'flex';
}

function proceedToNextLevel() {
  // Level up the player
  gameState.level++;
  gameState.maxHp += 30;
  gameState.hp = gameState.maxHp;
  gameState.sanity = Math.min(100, gameState.sanity + 30);
  gameState.nextLevel = Math.floor(gameState.nextLevel * 1.5);
  
  // Improve random skill
  const skills = Object.keys(gameState.skills);
  const randomSkill = skills[Math.floor(Math.random() * skills.length)];
  gameState.skills[randomSkill]++;
  
  // Reset level progress tracking
  gameState.levelProgress = {
    locationsVisited: 0,
    enemiesDefeated: 0,
    totalLocations: 10, // Updated for level 2
    totalEnemies: 5     // Updated for level 2
  };
  
  // Reset visited locations
  gameState.visitedLocations = [];
  
  // Reset all location visited flags for the new level
  for (const loc in locations[`level${gameState.level}`]) {
    locations[`level${gameState.level}`][loc].visited = false;
  }
  
  // Start at first location of new level
  gameState.currentLocation = Object.keys(locations[`level${gameState.level}`])[0];
  
  // Reset completion flags
  gameState.levelCompleted = false;
  gameState.levelTransitionShown = false;
  
  // Update UI
  updateStats();
  document.getElementById('level-transition').style.display = 'none';
  document.getElementById('level-select-btn').style.display = 'none';
  
  // Show new level description
  const newLoc = getCurrentLocation();
  document.getElementById('location').textContent = newLoc.name;
  addMessage(
    `<strong>LEVEL UP!</strong> You are now level ${gameState.level}. ` +
    `${randomSkill.charAt(0).toUpperCase() + randomSkill.slice(1)} skill increased.\n\n` +
    newLoc.description
  );
  
  showNotification(`Welcome to Level ${gameState.level}!`);
}

function stayAtCurrentLevel() {
  document.getElementById('level-transition').style.display = 'none';
  addMessage("You decide to stay in this area a while longer...");
}

function checkXPLevelUp() {
  // Regular level up from XP (only increases stats, not actual level)
  if (gameState.xp >= gameState.nextLevel) {
    gameState.xp = 0;
    gameState.nextLevel = Math.floor(gameState.nextLevel * 1.5);
    gameState.maxHp += 15;
    gameState.hp = gameState.maxHp;
    gameState.sanity = Math.min(100, gameState.sanity + 10);

    // Improve random skill
    const skills = Object.keys(gameState.skills);
    const randomSkill = skills[Math.floor(Math.random() * skills.length)];
    gameState.skills[randomSkill]++;

    addMessage(
      "<strong>STATS IMPROVED!</strong> " +
      (randomSkill.charAt(0).toUpperCase() + randomSkill.slice(1)) + " skill increased."
    );
    updateStats();
    showNotification("Stats Improved! " + (randomSkill.charAt(0).toUpperCase() + randomSkill.slice(1)) + " skill increased.");
  }
}

function updateNPCPresence() {
  const loc = getCurrentLocation();
  const talkBtn = document.getElementById('talk-btn');

  if (loc.npcs.length > 0) {
    const npc = npcs[loc.npcs[0]];
    addMessage(`\n\n${npc.name} is here. ${npc.description}`);

    if (!talkBtn) {
      const btn = document.createElement('button');
      btn.id = 'talk-btn';
      btn.textContent = 'TALK';
      btn.onclick = () => startTalk();
      document.getElementById('actions').appendChild(btn);
    } else {
      talkBtn.style.display = 'block';
    }
  } else if (talkBtn) {
    talkBtn.style.display = 'none';
  }
}

function addMessage(text) {
  const desc = document.getElementById('description');
  desc.innerHTML = text.replace(/\n/g, '<br>');

  // Add flicker effect for creepy messages
  if (text.toLowerCase().includes("shadow") || text.toLowerCase().includes("whisper") || text.toLowerCase().includes("unnatural")) {
    desc.classList.add('flicker');
    setTimeout(() => desc.classList.remove('flicker'), 2000);
  }

  // Scroll to bottom
  desc.scrollTop = desc.scrollHeight;
}

function lookAround() {
  const loc = getCurrentLocation();
  let description = loc.description;

  if (loc.items.length > 0 && !gameState.visitedLocations.includes(gameState.currentLocation)) {
    const item = items[loc.items[0]];
    description += `\n\nYou notice a ${item.name} nearby.`;
  }

  addMessage(description);
}

function checkInventory() {
  let inventoryText = "<strong>INVENTORY:</strong><br><br>";
  gameState.inventory.forEach((item, index) => {
    inventoryText += `<strong>${item.name}</strong>`;
    if (item.type === "weapon") {
      if (item.ammo !== undefined) {
        inventoryText += ` (${item.ammo}/${item.maxAmmo})`;
      }
      inventoryText += ` [DMG: ${item.damage}]`;
    }
    if (item.uses !== undefined && item.uses > 0) {
      inventoryText += ` (${item.uses} use${item.uses !== 1 ? 's' : ''})`;
    }
    if (index === gameState.selectedItem) {
      inventoryText += " (equipped)";
    }
    inventoryText += `<br><em>${item.description}</em><br><br>`;
  });

  addMessage(inventoryText);
}

function selectItem(index) {
  const items = document.querySelectorAll('.item');
  items.forEach(item => item.classList.remove('selected'));
  items[index].classList.add('selected');

  if (gameState.inventory[index].type === "weapon") {
    gameState.selectedItem = index;
    addMessage(`Equipped ${gameState.inventory[index].name}.`);
  }
}

function renderInventory() {
  const container = document.getElementById('inventory-items');
  container.innerHTML = '';

  // Group weapons first
  const weapons = gameState.inventory.filter(item => item.type === "weapon");
  const otherItems = gameState.inventory.filter(item => item.type !== "weapon");

  weapons.forEach((item, index) => renderItem(item, index, container));
  otherItems.forEach((item, index) => renderItem(item, weapons.length + index, container));
}

function renderItem(item, index, container) {
  const itemEl = document.createElement('div');
  itemEl.className = 'item';
  if (index === gameState.selectedItem) {
    itemEl.classList.add('selected');
  }

  let itemHTML = `<div class="item-name">${item.name}</div>`;

  if (item.type === "weapon") {
    if (item.ammo !== undefined) {
      itemHTML += `<div class="item-ammo">${item.ammo}/${item.maxAmmo}</div>`;
    }
    itemHTML += `<div class="item-desc">DMG: ${item.damage}</div>`;
  } else if (item.type === "consumable") {
    if (item.hpRestore) {
      itemHTML += `<div class="item-desc">Heals: ${item.hpRestore} HP</div>`;
    }
    if (item.uses > 0) {
      itemHTML += `<div class="item-ammo">${item.uses} use${item.uses !== 1 ? 's' : ''}</div>`;
    }
  } else if (item.type === "ammo") {
    itemHTML += `<div class="item-ammo">${item.amount} rounds</div>`;
  } else {
    itemHTML += `<div class="item-desc">${item.description}</div>`;
  }

  itemEl.innerHTML = itemHTML;
  itemEl.onclick = () => selectItem(index);
  container.appendChild(itemEl);
}

function checkSkills() {
  let skillsText = "<strong>SKILLS:</strong><br><br>";
  for (const [skill, level] of Object.entries(gameState.skills)) {
    skillsText += `<strong>${skill.charAt(0).toUpperCase() + skill.slice(1)}:</strong> ${level}/5<br>`;
  }

  skillsText += "<br><strong>QUESTS:</strong><br><br>";
  gameState.quests.forEach(quest => {
    const statusColor = quest.status === "active" ? "#E0FF00" : "#666";
    skillsText += `<strong>${quest.title}</strong> <span style="color:${statusColor}">[${quest.status.toUpperCase()}]</span><br>`;
    skillsText += `<em>${quest.description}</em><br>`;
    if (quest.progress > 0) {
      skillsText += `Progress: ${quest.progress}%<br>`;
    }
    skillsText += "<br>";
  });

  skillsText += `<br><strong>LEVEL PROGRESS:</strong><br>`;
  skillsText += `Locations visited: ${gameState.levelProgress.locationsVisited}/${gameState.levelProgress.totalLocations}<br>`;
  skillsText += `Enemies defeated: ${gameState.levelProgress.enemiesDefeated}/${gameState.levelProgress.totalEnemies}<br>`;

  addMessage(skillsText);
}

function rest() {
  if (gameState.combat) {
    addMessage("You can't rest during combat!");
    return;
  }

  const hpGain = 30 + gameState.level * 5;
  const sanityGain = 10;

  gameState.hp = Math.min(gameState.hp + hpGain, gameState.maxHp);
  gameState.sanity = Math.min(gameState.sanity + sanityGain, 100);
  updateStats();

  addMessage(`You rest for a while. HP +${hpGain}, Sanity +${sanityGain}. The woods feel no less watchful.`);
}

function startTalk() {
  const loc = getCurrentLocation();
  if (loc.npcs.length > 0) {
    startDialog(loc.npcs[0]);
  }
}

function startCombat(enemyKey) {
  const enemy = enemies[enemyKey];
  gameState.combat = {
    enemy: enemyKey,
    enemyHp: enemy.hp
  };

  document.getElementById('combat-screen').style.display = 'block';
  document.getElementById('enemy-health-fill').style.width = '100%';
  document.getElementById('player-health-fill').style.width = `${(gameState.hp / gameState.maxHp) * 100}%`;

  // Update HP displays
  document.getElementById('player-hp').textContent = gameState.hp;
  document.getElementById('player-max-hp').textContent = gameState.maxHp;
  document.getElementById('enemy-hp').textContent = enemy.hp;
  document.getElementById('enemy-max-hp').textContent = enemy.maxHp;

  // Sanity check from creepy enemy
  const sanityLoss = Math.floor(enemy.creepiness / 10);
  gameState.sanity = Math.max(0, gameState.sanity - sanityLoss);
  updateStats();

  addCombatMessage(enemy.description);

  if (sanityLoss > 0) {
    setTimeout(() => {
      addCombatMessage(`The ${enemy.name}'s unnatural presence shakes you. Sanity -${sanityLoss}.`);
    }, 1500);
  }
}

function addCombatMessage(text) {
  const combatDesc = document.getElementById('combat-description');
  combatDesc.innerHTML += text.replace(/\n/g, '<br>') + '<br>';

  // Add flicker effect for creepy combat messages
  if (text.toLowerCase().includes("shadow") || text.toLowerCase().includes("unnatural") || text.toLowerCase().includes("scream")) {
    combatDesc.classList.add('flicker');
    setTimeout(() => combatDesc.classList.remove('flicker'), 2000);
  }

  // Scroll to bottom
  combatDesc.scrollTop = combatDesc.scrollHeight;
}

function attack() {
  if (!gameState.combat) return;

  const enemy = enemies[gameState.combat.enemy];
  let weapon = gameState.inventory[gameState.selectedItem];

  // Check if weapon can be used
  if (weapon.type !== "weapon") {
    addCombatMessage(`You can't attack with ${weapon.name}!`);
    return;
  }

  // Check ammo - if out of ammo, switch to fists
  if (weapon.ammo !== undefined && weapon.ammo <= 0) {
    // Find fists in inventory or create them
    let fists = gameState.inventory.find(item => item.name === "Fists");
    if (!fists) {
      fists = {
        name: "Fists",
        type: "weapon",
        damage: 5 + gameState.skills.melee,
        description: "Your bare hands. Better than nothing.",
        equipped: false
      };
      gameState.inventory.push(fists);
      renderInventory();
    }

    // Equip fists
    gameState.selectedItem = gameState.inventory.indexOf(fists);
    selectItem(gameState.selectedItem);
    addCombatMessage("Out of ammo! Switching to fists!");

    // Continue with fists attack
    weapon = fists;
  }

  // Calculate damage
  let damage = weapon.damage;

  // Apply skill bonus
  if (weapon.name === "Pistol") {
    damage += gameState.skills.firearms * 3;
    // Use ammo
    if (weapon.ammo !== undefined) {
      weapon.ammo--;
      renderInventory();
    }
  } else if (weapon.name === "Knife") {
    damage += gameState.skills.melee * 2;
  } else if (weapon.name === "Fists") {
    damage += gameState.skills.melee;
  }

  // Check for enemy resistance
  if (enemy.resistance === "physical" && weapon.name !== "Pistol") {
    damage = Math.floor(damage * 0.7);
    addCombatMessage(`The ${enemy.name} seems resistant to physical attacks!`);
  } else if (enemy.resistance === "all") {
    damage = Math.floor(damage * 0.5);
    addCombatMessage(`The ${enemy.name} resists your attack!`);
  }

  // Check for enemy weakness
  if (enemy.weakness === "firearms" && weapon.name === "Pistol") {
    damage = Math.floor(damage * 1.5);
    addCombatMessage(`The ${enemy.name} is vulnerable to firearms!`);
  }

  // Check for enemy special ability (25% chance)
  if (Math.random() < 0.25) {
    damage = Math.floor(damage * 0.7);
    addCombatMessage(enemy.special);

    setTimeout(() => {
      gameState.combat.enemyHp -= damage;
      updateCombatUI(damage, enemy);
    }, 2000);
    return;
  }

  gameState.combat.enemyHp -= damage;
  updateCombatUI(damage, enemy);
}

function updateCombatUI(damage, enemy) {
  // Update enemy health bar - ensure HP doesn't go below 0
  gameState.combat.enemyHp = Math.max(0, gameState.combat.enemyHp);
  const enemyHealthPercent = (gameState.combat.enemyHp / enemy.maxHp) * 100;
  document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
  document.getElementById('enemy-hp').textContent = gameState.combat.enemyHp;

  addCombatMessage(`You hit the ${enemy.name} with your ${gameState.inventory[gameState.selectedItem].name} for ${damage} damage!`);

  // Check if enemy defeated
  if (gameState.combat.enemyHp <= 0) {
    setTimeout(() => endCombat(true), 1000);
    return;
  }

  // Enemy attack
  setTimeout(() => {
    let enemyDamage = enemy.damage;

    // Defense from melee skill
    enemyDamage = Math.max(3, enemyDamage - gameState.skills.melee);

    // Check for player special conditions
    if (gameState.sanity < 30) {
      enemyDamage = Math.floor(enemyDamage * 1.2);
      addCombatMessage("Your low sanity makes you more vulnerable!");
    }

    gameState.hp -= enemyDamage;
    updateStats();

    // Update player health bar
    const playerHealthPercent = (gameState.hp / gameState.maxHp) * 100;
    document.getElementById('player-health-fill').style.width = `${playerHealthPercent}%`;
    document.getElementById('player-hp').textContent = gameState.hp;

    const attackText = enemy.attacks[Math.floor(Math.random() * enemy.attacks.length)];
    addCombatMessage(`${attackText}<br>You take ${enemyDamage} damage.`);

    // Check if player defeated
    if (gameState.hp <= 0) {
      setTimeout(() => endCombat(false), 1000);
    }
  }, 1500);
}

function startSpecialAttackCooldown() {
  gameState.specialAttackCooldown = true;
  const btn = document.getElementById('special-attack-btn');
  btn.disabled = true;

  // Add cooldown visual
  const cooldownDiv = document.createElement('div');
  cooldownDiv.className = 'cooldown';
  cooldownDiv.textContent = '3';
  btn.appendChild(cooldownDiv);

  let seconds = 3;
  const interval = setInterval(() => {
    seconds--;
    cooldownDiv.textContent = seconds.toString();

    if (seconds <= 0) {
      clearInterval(interval);
      btn.removeChild(cooldownDiv);
      btn.disabled = false;
      gameState.specialAttackCooldown = false;
    }
  }, 1000);
}

function specialAttack() {
  if (!gameState.combat || gameState.specialAttackCooldown) return;

  const enemy = enemies[gameState.combat.enemy];
  const sanityCost = 15 + gameState.level * 5;

  if (gameState.sanity < sanityCost) {
    addCombatMessage("You're too unsettled to focus!");
    return;
  }

  gameState.sanity -= sanityCost;
  let damage = 30 + gameState.skills.occult * 5;

  // Check for weakness
  if (enemy.weakness === "psychic") {
    damage = Math.floor(damage * 1.5);
    addCombatMessage(`The ${enemy.name} recoils as your psychic assault strikes a vulnerable spot!`);
  } else if (enemy.resistance === "psychic") {
    damage = Math.floor(damage * 0.5);
    addCombatMessage(`The ${enemy.name} seems resistant to psychic attacks!`);
  } else {
    addCombatMessage(`You focus your will and unleash psychic energy at the ${enemy.name}!`);
  }

  gameState.combat.enemyHp -= damage;

  // Update enemy health bar
  const enemyHealthPercent = (gameState.combat.enemyHp / enemy.maxHp) * 100;
  document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
  document.getElementById('enemy-hp').textContent = gameState.combat.enemyHp;

  updateStats();

  // Start cooldown
  startSpecialAttackCooldown();

  // Check if enemy defeated
  if (gameState.combat.enemyHp <= 0) {
    setTimeout(() => endCombat(true), 1000);
    return;
  }

  // Enemy attack
  setTimeout(() => {
    let enemyDamage = enemy.damage;
    enemyDamage = Math.max(3, enemyDamage - gameState.skills.melee);
    gameState.hp -= enemyDamage;
    updateStats();

    // Update player health bar
    const playerHealthPercent = (gameState.hp / gameState.maxHp) * 100;
    document.getElementById('player-health-fill').style.width = `${playerHealthPercent}%`;
    document.getElementById('player-hp').textContent = gameState.hp;

    const attackText = enemy.attacks[Math.floor(Math.random() * enemy.attacks.length)];
    addCombatMessage(`${attackText}<br>You take ${enemyDamage} damage.`);

    // Check if player defeated
    if (gameState.hp <= 0) {
      setTimeout(() => endCombat(false), 1000);
    }
  }, 1500);
}

function flee() {
  if (!gameState.combat) return;

  const enemy = enemies[gameState.combat.enemy];

  // Chance to flee based on stealth skill and enemy creepiness
  const fleeChance = 0.5 + (gameState.skills.stealth * 0.1) - (enemy.creepiness * 0.005);
  const success = Math.random() < fleeChance;

  if (success) {
    addCombatMessage("You successfully escape!");

    setTimeout(() => {
      endCombat(false);

      // Move player to random adjacent location
      const currentLoc = getCurrentLocation();
      const possibleExits = Object.values(currentLoc.exits);

      if (possibleExits.length > 0) {
        const newLoc = possibleExits[Math.floor(Math.random() * possibleExits.length)];
        gameState.currentLocation = newLoc;
        document.getElementById('location').textContent = getCurrentLocation().name;
        addMessage(`You stumble into ${getCurrentLocation().name}, heart pounding from your narrow escape.\n\n${getCurrentLocation().description}`);
        updateNPCPresence();
      }
    }, 1000);
  } else {
    const damage = Math.floor(enemy.damage * 0.7);
    gameState.hp -= damage;
    updateStats();

    // Update player health bar
    const playerHealthPercent = (gameState.hp / gameState.maxHp) * 100;
    document.getElementById('player-health-fill').style.width = `${playerHealthPercent}%`;
    document.getElementById('player-hp').textContent = gameState.hp;

    addCombatMessage(`You try to flee but the ${enemy.name} catches you! You take ${damage} damage.`);

    if (gameState.hp <= 0) {
      setTimeout(() => endCombat(false), 1000);
    }
  }
}

function endCombat(victory) {
  const enemy = enemies[gameState.combat.enemy];

  if (victory) {
    gameState.xp += enemy.xp;
    gameState.levelProgress.enemiesDefeated++;

    // Check for XP level up (stats only)
    checkXPLevelUp();
    // Check for level completion (locations + enemies)
    checkLevelCompletion();

    addCombatMessage(`You defeated the ${enemy.name}! Gained ${enemy.xp} XP.`);

    // Item drops based on enemy type
    let possibleDrops = [];

    if (enemy.weakness === "light") {
      possibleDrops.push({
        name: "Flare",
        type: "consumable",
        uses: 1,
        description: "A bright emergency flare. Can scare away creatures of darkness."
      });
    }

    if (enemy.weakness === "salt" || enemy.weakness === "holy") {
      possibleDrops.push({
        name: "Salt Pouch",
        type: "consumable",
        uses: 3,
        description: "A small pouch of blessed salt. Effective against spirits."
      });
      possibleDrops.push({
        name: "Holy Water",
        type: "consumable",
        uses: 2,
        description: "A small vial of blessed water. Can purify and harm the unnatural."
      });
    }

    // Always possible drops
    possibleDrops.push(
      {
        name: "Medkit",
        type: "consumable",
        hpRestore: 40,
        uses: 1,
        description: "Restores 40 HP when used."
      },
      {
        name: "Ammo",
        type: "ammo",
        amount: 5,
        description: "5 rounds of 9mm ammunition for your pistol."
      }
    );

    // 50% chance for item drop
    if (Math.random() < 0.5) {
      const drop = possibleDrops[Math.floor(Math.random() * possibleDrops.length)];
      
      if (drop.name === "Ammo") {
        // Special handling for ammo drops - add directly to pistol
        const pistol = gameState.inventory.find(item => item.name === "Pistol");
        if (pistol) {
          const ammoToAdd = Math.min(drop.amount, pistol.maxAmmo - pistol.ammo);
          pistol.ammo += ammoToAdd;
          addCombatMessage(`You found ${ammoToAdd} rounds of ammo! They've been added to your pistol. Total ammo: ${pistol.ammo}/${pistol.maxAmmo}`);
          renderInventory();
        } else {
          // If no pistol, add to inventory as normal
          gameState.inventory.push(drop);
          renderInventory();
          addCombatMessage(`\n\nThe enemy dropped ${drop.amount} rounds of ammo!`);
        }
      } else {
        gameState.inventory.push(drop);
        renderInventory();
        addCombatMessage(`\n\nThe enemy dropped a ${drop.name}!`);
      }
    }

    // Update quest progress if relevant
    if (enemy.name === "Giant Owl") {
      const quest = gameState.quests.find(q => q.id === "strange_lights");
      if (quest) {
        quest.progress += 15;
        if (quest.status === "inactive") quest.status = "active";
        addCombatMessage("\n\n<em>You feel this encounter relates to the strange lights phenomenon...</em>");
      }
    }

    updateStats();
  } else {
    if (gameState.hp <= 0) {
      addCombatMessage("You have been defeated... The world fades to black.");

      // Reset player but with penalties
      setTimeout(() => {
        gameState.hp = Math.floor(gameState.maxHp * 0.5);
        gameState.sanity = Math.max(10, gameState.sanity - 20);
        updateStats();

        // Move to random location
        const locationKeys = Object.keys(locations[`level${gameState.level}`]);
        const newLoc = locationKeys[Math.floor(Math.random() * locationKeys.length)];
        gameState.currentLocation = newLoc;
        document.getElementById('location').textContent = getCurrentLocation().name;

        addMessage(
          "You wake up somewhere else, your memory hazy. What did you see?\n\n" +
          getCurrentLocation().description
        );
        updateNPCPresence();
      }, 2000);
    }
  }

  setTimeout(() => {
    document.getElementById('combat-screen').style.display = 'none';
    gameState.combat = null;
  }, 3000);
}

function showItemSelect() {
  const itemSelect = document.getElementById('item-select-screen');
  const optionsDiv = document.getElementById('item-select-options');
  optionsDiv.innerHTML = '';

  gameState.inventory.forEach((item, index) => {
    if (item.type === "consumable" || item.type === "ammo") {
      const btn = document.createElement('button');
      let btnText = item.name;
      if (item.uses !== undefined && item.uses > 0) {
        btnText += ` (${item.uses} use${item.uses !== 1 ? 's' : ''})`;
      }
      if (item.amount !== undefined) {
        btnText += ` (${item.amount})`;
      }
      btn.textContent = btnText;
      btn.onclick = () => useItemInCombat(index);
      optionsDiv.appendChild(btn);
    }
  });

  if (optionsDiv.children.length === 0) {
    optionsDiv.innerHTML = '<div>No usable items</div>';
  }

  itemSelect.style.display = 'block';
}

function hideItemSelect() {
  document.getElementById('item-select-screen').style.display = 'none';
}

function useItemInCombat(index) {
  const item = gameState.inventory[index];

  if (item.type === "consumable") {
    if (item.use) {
      item.use();
    } else {
      // Default consumable behavior
      gameState.hp = Math.min(gameState.hp + item.hpRestore, gameState.maxHp);
      item.uses--;

      if (item.uses <= 0) {
        gameState.inventory.splice(index, 1);
      }

      updateStats();
      document.getElementById('player-health-fill').style.width = `${(gameState.hp / gameState.maxHp) * 100}%`;
      addCombatMessage(`You use the ${item.name} and restore ${item.hpRestore} HP.`);
      renderInventory();
    }
  } else if (item.type === "ammo") {
    item.use();
  }

  hideItemSelect();
}

function startDialog(npcKey) {
  const npc = npcs[npcKey];
  const npcState = gameState.knownNpcs.find(n => n.id === npcKey) ||
                   { id: npcKey, name: npc.name, trust: 50, creepiness: npc.creepiness, met: false };

  if (!npcState.met) {
    npcState.met = true;
    addMessage(`You meet ${npc.name} for the first time. ${npc.description}`);
    // Add to known NPCs if not already there
    if (!gameState.knownNpcs.some(n => n.id === npcKey)) {
      gameState.knownNpcs.push(npcState);
    }
  }

  document.getElementById('dialog-screen').style.display = 'block';
  document.getElementById('dialog-text').innerHTML = `<strong>${npc.name}:</strong> "What do you want to know?"`;

  const optionsDiv = document.getElementById('dialog-options');
  optionsDiv.innerHTML = '';

  npc.dialog.forEach((option, idx) => {
    if (npcState.trust >= option.trustReq) {
      // Check for sanity requirement if specified
      if (option.sanityCheck && gameState.sanity < option.sanityCheck) {
        return;
      }

      const btn = document.createElement('button');
      btn.className = 'dialog-option';
      btn.innerHTML = option.question;
      btn.onclick = () => {
        document.getElementById('dialog-text').innerHTML = `<strong>${npc.name}:</strong> "${option.response}"`;

        // Increase trust
        npcState.trust = Math.min(npcState.trust + 5, 100);

        // Apply sanity effect
        gameState.sanity = Math.max(0, gameState.sanity + option.sanityEffect);
        updateStats();

        // Trigger quest if specified
        if (option.questTrigger) {
          const quest = gameState.quests.find(q => q.id === option.questTrigger);
          if (quest && quest.status === "inactive") {
            quest.status = "active";
            document.getElementById('dialog-text').innerHTML +=
              `<br><br><em>New objective: ${quest.title}</em>`;
            showNotification(`New Quest: ${quest.title}`);
          }
        }

        // Special effects for certain responses
        if (option.response.includes("owls are not what they seem")) {
          setTimeout(() => {
            document.getElementById('dialog-text').innerHTML +=
              `<br><br>As she says this, you hear an owl hoot nearby... though it sounds almost like laughter.`;
            gameState.sanity = Math.max(0, gameState.sanity - 5);
            updateStats();
          }, 1000);
        }
      };
      optionsDiv.appendChild(btn);
    }
  });

  // Always add a "leave" option
  const leaveBtn = document.createElement('button');
  leaveBtn.className = 'dialog-option';
  leaveBtn.textContent = "Never mind";
  leaveBtn.onclick = () => {
    document.getElementById('dialog-text').innerHTML = `<strong>${npc.name}</strong> nods silently, her gaze never leaving yours.`;
  };
  optionsDiv.appendChild(leaveBtn);
}

function exitDialog() {
  document.getElementById('dialog-screen').style.display = 'none';

  // Small chance for creepy effect after dialog
  if (Math.random() < 0.3) {
    const loc = getCurrentLocation();
    if (loc.npcs.length > 0) {
      const npc = npcs[loc.npcs[0]];
      if (npc && npc.creepiness > 70) {
        setTimeout(() => {
          addMessage(`\n\nAs you turn to leave, you swear you hear ${npc.name} whisper something... but when you look back, their mouth isn't moving.`);
          gameState.sanity = Math.max(0, gameState.sanity - 5);
          updateStats();
        }, 500);
      }
    }
  }
}
</script>
</body>
</html>
