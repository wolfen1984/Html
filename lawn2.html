<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Lawn Plus</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: black;
            color: white;
        }

        #game-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 10px;
            background-color: black;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        header {
            background-color: white;
            color: black;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        #stats-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .stat {
            font-size: 0.9em;
        }

        #status-bars {
            margin-top: 10px;
        }

        .status-bar {
            margin-bottom: 5px;
        }

        progress {
            width: 70%;
            height: 15px;
        }

        .screen {
            padding: 10px;
        }

        .hidden {
            display: none;
        }

        button {
            background-color: white;
            color: black;
            border: none;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 1em;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #email-list {
            margin-bottom: 10px;
        }

        .email-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .email-item:hover {
            background-color: #f0f0f0;
        }

        .email-item.unread {
            font-weight: bold;
        }

        #schedule-display {
            margin-bottom: 10px;
        }

        .schedule-slot {
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }

        .schedule-slot.booked {
            background-color: black;
        }

        .schedule-slot.completed {
            background-color: grey;
        }

        .schedule-slot.missed {
            background-color: #ffe6e6;
            text-decoration: line-through;
        }

        .shop-item {
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            border-radius: 5px;
        }

        .shop-item button {
            width: auto;
            float: right;
        }

        #notification-area {
            position: fixed;
            bottom: 10px;
            right: 10px;
            max-width: 300px;
        }

        .notification {
            background-color: #333;
            color: white;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            opacity: 0.9;
        }

        .stress-up {
            color: #ff5555;
            font-weight: bold;
        }

        .stress-down {
            color: #55ff55;
            font-weight: bold;
        }

        .money-up {
            color: #55ff55;
            font-weight: bold;
        }

        .money-down {
            color: #ff5555;
            font-weight: bold;
        }

        #job-history {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 5px;
        }

        .job-history-item {
            padding: 3px 0;
            border-bottom: 1px solid #eee;
        }

        .bank-account {
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .bank-account h3 {
            margin-top: 0;
        }

        .account-balance {
            font-size: 1.2em;
            font-weight: bold;
            margin: 5px 0;
        }

        .email-preview {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        @media (max-width: 500px) {
            progress {
                width: 60%;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <header>
            <div id="game-header">
                <h1>Lawn Plus</h1>
                <div id="stats-bar">
                    <div class="stat"><span>Day:</span> <span id="day-display">Mon</span></div>
                    <div class="stat"><span>Time:</span> <span id="time-display">8:00 AM</span></div>
                    <div class="stat"><span>Cash:</span> $<span id="money-display">500</span> (<span id="payee-display">$0.00</span>)</div>
                </div>
                <div id="status-bars">
                    <div class="status-bar"><span>Energy:</span> <progress id="energy-bar" value="100" max="100"></progress></div>
                    <div class="status-bar"><span>Stress:</span> <progress id="stress-bar" value="20" max="100"></progress></div>
                    <div class="status-bar"><span>Reputation:</span> <progress id="rep-bar" value="50" max="100"></progress></div>
                    <div class="status-bar"><span>Petrol:</span> <progress id="petrol-display" value="100" max="100"></progress></div>
                </div>
            </div>
        </header>

        <main>
            <div id="main-menu" class="screen">
                <button id="check-email-btn">Check Email <span id="unread-count" style="float:right; background:#ff5555; border-radius:10px; padding:2px 6px; display:none">0</span></button>
                <button id="schedule-btn">View Schedule</button>
                <button id="shop-btn">Equipment Shop</button>
                <button id="bank-btn">Bank Accounts</button>
                <button id="start-day-btn">Start Work Day</button>
                <button id="next-day-btn">Advance to Next Day</button>
                <button id="history-btn">Job History</button>
            </div>

            <div id="email-screen" class="screen hidden">
                <h2>Inbox</h2>
                <div id="email-list"></div>
                <button id="back-from-email">Back</button>
            </div>

            <div id="email-detail-screen" class="screen hidden">
                <h2>Email</h2>
                <div id="email-content"></div>
                <div id="email-actions"></div>
                <button id="back-from-detail">Back to Inbox</button>
            </div>

            <div id="schedule-screen" class="screen hidden">
                <h2>Schedule</h2>
                <div id="schedule-display"></div>
                <button id="back-from-schedule">Back</button>
            </div>

            <div id="shop-screen" class="screen hidden">
                <h2>Equipment Shop</h2>
                <div id="shop-items">
                    <h3>Mowers</h3>
                    <div class="shop-category" id="mowers"></div>
                    <h3>Trimmers</h3>
                    <div class="shop-category" id="trimmers"></div>
                    <h3>Blowers</h3>
                    <div class="shop-category" id="blowers"></div>
                    <h3>Supplies</h3>
                    <div class="shop-category" id="supplies"></div>
                </div>
                <button id="back-from-shop">Back</button>
            </div>

            <div id="bank-screen" class="screen hidden">
                <h2>Bank Accounts</h2>
                
                <div class="bank-account">
                    <h3>Payee Account</h3>
                    <div class="account-balance">Balance: $<span id="payee-balance">0.00</span></div>
                    <p>Job payments are deposited here automatically</p>
                    <button id="transfer-to-savings">Transfer to Savings</button>
                    <button id="withdraw-to-cash">Withdraw to Cash</button>
                </div>
                
                <div class="bank-account">
                    <h3>Savings Account</h3>
                    <div class="account-balance">Balance: $<span id="savings-balance">0.00</span></div>
                    <p>Earns 2% interest weekly. Current rate: 2%</p>
                    <button id="transfer-from-savings">Transfer to Payee</button>
                </div>
                
                <div class="bank-account">
                    <h3>Tax Account</h3>
                    <div class="account-balance">Balance: $<span id="tax-balance">0.00</span></div>
                    <p>15% of earnings are automatically deducted for taxes</p>
                    <button id="pay-taxes" disabled>Pay Taxes (End of Month)</button>
                </div>
                
                <button id="back-from-bank">Back</button>
            </div>

            <div id="work-screen" class="screen hidden">
                <h2>Work Day - <span id="work-day">Monday</span></h2>
                <div id="current-job-display">
                    <h3>Current Job: <span id="current-job-name">None</span></h3>
                    <div>Progress: <progress id="job-progress" value="0" max="100"></progress></div>
                    <div>Time Remaining: <span id="time-remaining">0</span> minutes</div>
                    <div id="job-details"></div>
                </div>
                <div id="equipment-status">
                    <h3>Equipment Status</h3>
                    <div>Mower: <span id="mower-status">100%</span></div>
                    <div>Trimmer: <span id="trimmer-status">100%</span></div>
                    <div>Blower: <span id="blower-status">100%</span></div>
                    <div>Petrol: <span id="petrol-status">100%</span></div>
                </div>
                <button id="use-energy-drink">Use Energy Drink (0 left)</button>
                <button id="end-work-day">End Work Day</button>
                <div id="job-history"></div>
            </div>

            <div id="history-screen" class="screen hidden">
                <h2>Job History</h2>
                <div id="full-history"></div>
                <button id="back-from-history">Back</button>
            </div>

            <div id="notification-area"></div>
        </main>
    </div>
    <script>
        // Game State
        const gameState = {
            day: 0, // 0-4 (Mon-Fri)
            week: 1,
            month: 1,
            time: 8, // 8AM-5PM (8-17)
            money: 500,
            stress: 20,
            energy: 100,
            reputation: 50,
            equipment: {
                mower: '18inch',
                trimmer: 'cheap',
                blower: 'cheap',
                petrol: 100,
                trimmerCord: 100,
                mowerBelt: 100,
                energyDrinks: 0
            },
            bank: {
                payee: 0,
                savings: 0,
                tax: 0
            },
            customers: [],
            scheduledJobs: [[],[],[],[],[]], // 5 days
            emails: [],
            weather: 'sunny',
            completedJobs: 0,
            failedJobs: 0,
            currentJob: null,
            workTimer: null,
            workDayActive: false,
            currentJobIndex: 0,
            currentWorkDayTime: 8, // Tracks time during work day
            jobHistory: [],
            dailyCompleted: 0,
            dailyFailed: 0,
            energyDrinkActive: false,
            problematicCustomers: ['Thompson', 'Wilson', 'Rodriguez', 'Smith', 'Johnson'], // Expanded problematic customers
            mowedCustomers: [],
            warnedCustomers: [] // Track which customers we've warned about
        };

        // Equipment Stats
        const equipmentStats = {
            mower: {
                '18inch': { name: '18" Push Mower', speed: 1, stress: 3, price: 0, reliability: 0.95 },
                '21inch': { name: '21" Self-Propelled', speed: 1.5, stress: 2, price: 300, reliability: 0.97 },
                'zeroturn': { name: 'Zero-Turn Mower', speed: 2.5, stress: 1, price: 2000, reliability: 0.99 }
            },
            trimmer: {
                'cheap': { name: 'Basic Trimmer', speed: 1, stress: 2, price: 0, reliability: 0.9 },
                'mid': { name: 'Professional Trimmer', speed: 1.5, stress: 1, price: 200, reliability: 0.95 },
                'top': { name: 'Commercial Trimmer', speed: 2, stress: 0.5, price: 500, reliability: 0.98 }
            },
            blower: {
                'cheap': { name: 'Basic Blower', speed: 1, stress: 2, price: 0, reliability: 0.9 },
                'mid': { name: 'Professional Blower', speed: 1.5, stress: 1, price: 150, reliability: 0.94 },
                'top': { name: 'Commercial Blower', speed: 2, stress: 0.5, price: 400, reliability: 0.97 }
            }
        };

        // Job Types
        const jobTypes = {
            small: { name: 'Small Lawn', baseTime: 30, basePay: 35, reputation: 1, difficulty: 1 },
            medium: { name: 'Medium Lawn', baseTime: 45, basePay: 45, reputation: 2, difficulty: 1.5 },
            large: { name: 'Large Lawn', baseTime: 60, basePay: 65, reputation: 3, difficulty: 2 },
            xlarge: { name: 'Extra Large Lawn', baseTime: 90, basePay: 100, reputation: 5, difficulty: 3 }
        };

        // Weather Effects
        const weatherEffects = {
            sunny: { name: 'Sunny', workModifier: 1, stressModifier: 0, chance: 0.6 },
            rain: { name: 'Rain', workModifier: 0.5, stressModifier: 20, chance: 0.1 },
            cloudy: { name: 'Cloudy', workModifier: 0.9, stressModifier: -5, chance: 0.2 },
            hot: { name: 'Hot', workModifier: 0.8, stressModifier: 15, chance: 0.1 }
        };

        // Customer Names
        const customerNames = [
            'Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 
            'Miller', 'Davis', 'Garcia', 'Rodriguez', 'Wilson',
            'Martinez', 'Anderson', 'Taylor', 'Thomas', 'Moore',
            'Thompson', 'White', 'Harris', 'Clark', 'Lewis'
        ];

        // Days of Week
        const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

        // DOM Elements
        const elements = {
            dayDisplay: document.getElementById('day-display'),
            timeDisplay: document.getElementById('time-display'),
            moneyDisplay: document.getElementById('money-display'),
            payeeDisplay: document.getElementById('payee-display'),
            energyBar: document.getElementById('energy-bar'),
            stressBar: document.getElementById('stress-bar'),
            repBar: document.getElementById('rep-bar'),
            petrolDisplay: document.getElementById('petrol-display'),
            unreadCount: document.getElementById('unread-count'),
            
            screens: {
                main: document.getElementById('main-menu'),
                email: document.getElementById('email-screen'),
                emailDetail: document.getElementById('email-detail-screen'),
                schedule: document.getElementById('schedule-screen'),
                shop: document.getElementById('shop-screen'),
                bank: document.getElementById('bank-screen'),
                work: document.getElementById('work-screen'),
                history: document.getElementById('history-screen')
            },
            
            buttons: {
                checkEmail: document.getElementById('check-email-btn'),
                schedule: document.getElementById('schedule-btn'),
                shop: document.getElementById('shop-btn'),
                bank: document.getElementById('bank-btn'),
                startDay: document.getElementById('start-day-btn'),
                nextDay: document.getElementById('next-day-btn'),
                history: document.getElementById('history-btn'),
                backFromEmail: document.getElementById('back-from-email'),
                backFromDetail: document.getElementById('back-from-detail'),
                backFromSchedule: document.getElementById('back-from-schedule'),
                backFromShop: document.getElementById('back-from-shop'),
                backFromBank: document.getElementById('back-from-bank'),
                backFromHistory: document.getElementById('back-from-history'),
                endWorkDay: document.getElementById('end-work-day'),
                useEnergyDrink: document.getElementById('use-energy-drink'),
                transferToSavings: document.getElementById('transfer-to-savings'),
                withdrawToCash: document.getElementById('withdraw-to-cash'),
                transferFromSavings: document.getElementById('transfer-from-savings'),
                payTaxes: document.getElementById('pay-taxes')
            },
            
            bankDisplays: {
                payee: document.getElementById('payee-balance'),
                savings: document.getElementById('savings-balance'),
                tax: document.getElementById('tax-balance')
            },
            
            emailList: document.getElementById('email-list'),
            emailContent: document.getElementById('email-content'),
            emailActions: document.getElementById('email-actions'),
            scheduleDisplay: document.getElementById('schedule-display'),
            
            workDay: document.getElementById('work-day'),
            currentJobName: document.getElementById('current-job-name'),
            jobProgress: document.getElementById('job-progress'),
            timeRemaining: document.getElementById('time-remaining'),
            jobDetails: document.getElementById('job-details'),
            
            mowerStatus: document.getElementById('mower-status'),
            trimmerStatus: document.getElementById('trimmer-status'),
            blowerStatus: document.getElementById('blower-status'),
            petrolStatus: document.getElementById('petrol-status'),
            
            jobHistory: document.getElementById('job-history'),
            fullHistory: document.getElementById('full-history'),
            
            notificationArea: document.getElementById('notification-area')
        };

        // Initialize the game
        function initGame() {
            updateUI();
            generateInitialEmails();
            generateInitialWeather();
            
            // Set up event listeners
            elements.buttons.checkEmail.addEventListener('click', () => showScreen('email'));
            elements.buttons.schedule.addEventListener('click', () => showScreen('schedule'));
            elements.buttons.shop.addEventListener('click', () => showScreen('shop'));
            elements.buttons.bank.addEventListener('click', () => showScreen('bank'));
            elements.buttons.startDay.addEventListener('click', startWorkDay);
            elements.buttons.nextDay.addEventListener('click', advanceDay);
            elements.buttons.history.addEventListener('click', () => showScreen('history'));
            
            elements.buttons.backFromEmail.addEventListener('click', () => showScreen('main'));
            elements.buttons.backFromDetail.addEventListener('click', () => showScreen('email'));
            elements.buttons.backFromSchedule.addEventListener('click', () => showScreen('main'));
            elements.buttons.backFromShop.addEventListener('click', () => showScreen('main'));
            elements.buttons.backFromBank.addEventListener('click', () => showScreen('main'));
            elements.buttons.backFromHistory.addEventListener('click', () => showScreen('main'));
            elements.buttons.endWorkDay.addEventListener('click', endWorkDay);
            elements.buttons.useEnergyDrink.addEventListener('click', useEnergyDrink);
            
            // Bank buttons
            elements.buttons.transferToSavings.addEventListener('click', () => transferMoney('payee', 'savings'));
            elements.buttons.withdrawToCash.addEventListener('click', () => transferMoney('payee', 'cash'));
            elements.buttons.transferFromSavings.addEventListener('click', () => transferMoney('savings', 'payee'));
            
            // Set up shop items
            setupShop();
            updateHistoryDisplay();
        }

        // Show a specific screen
        function showScreen(screenName) {
            // Hide all screens first
            for (const screen in elements.screens) {
                elements.screens[screen].classList.add('hidden');
            }
            
            // Show the requested screen
            elements.screens[screenName].classList.remove('hidden');
            
            // Update screen-specific content
            if (screenName === 'email') {
                updateEmailList();
            } else if (screenName === 'schedule') {
                updateScheduleDisplay();
            } else if (screenName === 'work') {
                updateWorkScreen();
            } else if (screenName === 'history') {
                updateFullHistoryDisplay();
            } else if (screenName === 'bank') {
                updateBankDisplay();
            }
        }

        // Update the main UI elements
        function updateUI() {
            // Update day and time
            elements.dayDisplay.textContent = daysOfWeek[gameState.day];
            
            // Format time with minutes
            const currentHour = Math.floor(gameState.time);
            const currentMinutes = Math.floor((gameState.time % 1) * 60);
            const formattedMinutes = currentMinutes < 10 ? `0${currentMinutes}` : currentMinutes;
            const ampm = currentHour >= 12 ? 'PM' : 'AM';
            const displayHour = currentHour % 12 || 12;
            elements.timeDisplay.textContent = `${displayHour}:${formattedMinutes} ${ampm}`;
            
            // Update stats
            elements.moneyDisplay.textContent = gameState.money.toFixed(2);
            elements.payeeDisplay.textContent = gameState.bank.payee.toFixed(2);
            elements.energyBar.value = gameState.energy;
            elements.stressBar.value = gameState.stress;
            elements.repBar.value = gameState.reputation;
            elements.petrolDisplay.value = gameState.equipment.petrol;
            
            // Update work day button text
            elements.buttons.startDay.textContent = gameState.workDayActive ? 
                'Return to Work Day' : 'Start Work Day';
            
            // Update energy drink button
            elements.buttons.useEnergyDrink.textContent = 
                `Use Energy Drink (${gameState.equipment.energyDrinks} left)`;
            
            // Enable/disable next day button
            elements.buttons.nextDay.disabled = gameState.workDayActive;
            
            // Update unread email count
            const unreadCount = gameState.emails.filter(e => !e.read).length;
            if (unreadCount > 0) {
                elements.unreadCount.textContent = unreadCount;
                elements.unreadCount.style.display = 'inline-block';
            } else {
                elements.unreadCount.style.display = 'none';
            }
        }

        // Update bank account displays
        function updateBankDisplay() {
            elements.bankDisplays.payee.textContent = gameState.bank.payee.toFixed(2);
            elements.bankDisplays.savings.textContent = gameState.bank.savings.toFixed(2);
            elements.bankDisplays.tax.textContent = gameState.bank.tax.toFixed(2);
            
            // Enable/disable transfer buttons based on balances
            elements.buttons.transferToSavings.disabled = gameState.bank.payee <= 0;
            elements.buttons.withdrawToCash.disabled = gameState.bank.payee <= 0;
            elements.buttons.transferFromSavings.disabled = gameState.bank.savings <= 0;
        }

        // Transfer money between accounts
        function transferMoney(fromAccount, toAccount) {
            // Create dialog for amount
            const dialog = document.createElement('div');
            dialog.className = 'notification';
            dialog.innerHTML = `
                <h3>Transfer from ${fromAccount}</h3>
                <p>Available: $${gameState.bank[fromAccount].toFixed(2)}</p>
                <input type="number" id="transfer-amount" min="0" max="${gameState.bank[fromAccount]}" step="0.01" value="${gameState.bank[fromAccount]}" style="width: 100%; padding: 5px; margin: 5px 0; box-sizing: border-box;">
                <button id="confirm-transfer">Transfer</button>
                <button id="cancel-transfer">Cancel</button>
            `;
            
            elements.notificationArea.appendChild(dialog);
            
            document.getElementById('confirm-transfer').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('transfer-amount').value);
                
                if (isNaN(amount) || amount <= 0) {
                    showNotification("Please enter a valid amount");
                    return;
                }
                
                if (amount > gameState.bank[fromAccount]) {
                    showNotification("Not enough funds in source account");
                    return;
                }
                
                // Perform transfer
                gameState.bank[fromAccount] -= amount;
                
                if (toAccount === 'cash') {
                    gameState.money += amount;
                    showNotification(`Withdrew $${amount.toFixed(2)} to cash <span class="money-up">+$${amount.toFixed(2)}</span>`);
                } else {
                    gameState.bank[toAccount] += amount;
                    showNotification(`Transferred $${amount.toFixed(2)} to ${toAccount} account`);
                }
                
                // Update displays
                updateUI();
                updateBankDisplay();
                elements.notificationArea.removeChild(dialog);
            });
            
            document.getElementById('cancel-transfer').addEventListener('click', () => {
                elements.notificationArea.removeChild(dialog);
            });
        }

        // Format time (8 -> 8:00 AM, 13.5 -> 1:30 PM)
        function formatTime(hour) {
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = Math.floor(hour) % 12 || 12;
            const minutes = Math.floor((hour % 1) * 60);
            const formattedMinutes = minutes < 10 ? `0${minutes}` : minutes;
            return `${displayHour}:${formattedMinutes} ${ampm}`;
        }

        // Generate initial emails
        function generateInitialEmails() {
            // Start with a welcome email from George
            gameState.emails.push({
                id: Date.now(),
                from: 'George',
                subject: 'Welcome to Lawn Plus Pro',
                type: 'georgeWelcome',
                read: false,
                content: `Hey there,\n\nWelcome to Lawn Plus Pro! I'm George, your predecessor in this route.\n\n` +
                         `I've left you some basic equipment to get started. A few tips:\n` +
                         `1. Watch your stress levels\n` +
                         `2. Upgrade your equipment when you can\n` +
                         `3. Some customers are worse than others - I'll warn you about them\n\n` +
                         `Good luck!\n- George`
            });
            
            // Then generate 2 regular emails
            for (let i = 0; i < 2; i++) {
                generateNewEmail();
            }
        }

        // Generate initial weather
        function generateInitialWeather() {
            const weatherTypes = Object.keys(weatherEffects);
            const weights = weatherTypes.map(w => weatherEffects[w].chance);
            gameState.weather = weightedRandom(weatherTypes, weights);
        }

        // Generate a new random email
        function generateNewEmail() {
            // Chance for George to send a warning email about problematic customers
            if (Math.random() < 0.35 && gameState.problematicCustomers.length > 0) {
                const email = generateGeorgeWarning();
                gameState.emails.push(email);
                showNotification(`New email from ${email.from}: ${email.subject}`);
                return;
            }

            const types = ['jobRequest', 'complaint', 'steveOffer', 'referral'];
            const weights = [0.4, 0.15, 0.1, 0.1];
            const type = weightedRandom(types, weights);
            
            let email;
            switch (type) {
                case 'jobRequest':
                    email = generateJobRequest();
                    break;
                case 'complaint':
                    // Only generate complaints for customers we've mowed
                    if (gameState.mowedCustomers.length > 0 && Math.random() < 0.5) {
                        email = generateComplaint();
                    } else {
                        email = generateJobRequest(); // Fall back to job request
                    }
                    break;
                case 'steveOffer':
                    email = generateSteveOffer();
                    break;
                case 'referral':
                    email = generateReferral();
                    break;
            }
            
            gameState.emails.push(email);
            showNotification(`New email from ${email.from}`);
            updateUI();
        }

        // Generate an email from George warning about problematic customers
        function generateGeorgeWarning() {
            const problematicCustomer = gameState.problematicCustomers[Math.floor(Math.random() * gameState.problematicCustomers.length)];
            
            // Remove this customer from the problematic list so we don't get repeated warnings
            gameState.problematicCustomers = gameState.problematicCustomers.filter(c => c !== problematicCustomer);
            gameState.warnedCustomers.push(problematicCustomer);
            
            return {
                id: Date.now(),
                from: 'George',
                subject: 'URGENT: Warning About a Customer',
                type: 'georgeWarning',
                read: false,
                customer: problematicCustomer,
                content: `Hey there,\n\nI noticed you might be getting requests from ${problematicCustomer}. ` +
                         `Just wanted to give you a heads up - they were my WORST customer, always complaining no matter what I did!\n\n` +
                         `If you get a quote from them, take them on at your own risk! I'd charge them double if I were you.\n\n` +
                         `- George`
            };
        }

        // Generate a job request email
        function generateJobRequest() {
            // Higher chance for problematic/warned customers to request service
            let customerName;
            if (Math.random() < 0.4 && gameState.warnedCustomers.length > 0) {
                customerName = gameState.warnedCustomers[Math.floor(Math.random() * gameState.warnedCustomers.length)];
            } else {
                customerName = randomCustomerName();
            }
            
            const jobType = randomProperty(jobTypes);
            const size = jobType.name;
            const pay = calculateJobPay(jobType);
            
            // Add 50% premium for warned customers
            const finalPay = gameState.warnedCustomers.includes(customerName) ? Math.round(pay * 1.5) : pay;
            
            return {
                id: Date.now(),
                from: customerName,
                subject: `Lawn mowing request (${size})`,
                type: 'jobRequest',
                read: false,
                jobType: jobType,
                customer: customerName,
                pay: finalPay,
                content: `Hi there,\n\nI'd like to schedule a ${size.toLowerCase()} lawn mowing service. ` +
                         `Would you be available this week? I can pay $${finalPay}.\n\nThanks,\n${customerName}`
            };
        }

        // Calculate job pay with reputation bonus
        function calculateJobPay(jobType) {
            const basePay = jobType.basePay;
            const repBonus = gameState.reputation / 100; // 0-1 based on reputation
            return Math.round(basePay * (1 + repBonus * 0.5)); // Up to 50% bonus
        }

        // Generate a complaint email
        function generateComplaint() {
            // Only generate complaints for customers we've mowed
            const customerName = gameState.mowedCustomers[Math.floor(Math.random() * gameState.mowedCustomers.length)];
            const issues = [
                "You missed some spots last time",
                "The lawn wasn't trimmed properly",
                "You left clippings all over my driveway",
                "You were late for the appointment",
                "The job wasn't worth what I paid"
            ];
            const issue = issues[Math.floor(Math.random() * issues.length)];
            
            return {
                id: Date.now(),
                from: customerName,
                subject: 'Complaint about service',
                type: 'complaint',
                read: false,
                customer: customerName,
                content: `Hi,\n\nI'm not happy with your service. ${issue}. ` +
                         `Please fix this or I'll have to find another lawn service.\n\n${customerName}`
            };
        }

        // Generate an email from Steve with special offers
        function generateSteveOffer() {
            const offers = [
                { item: 'energyDrinks', quantity: 3, price: 20, desc: '3 energy drinks' },
                { item: 'petrol', amount: 50, price: 30, desc: '50% petrol refill' },
                { item: 'mowerBelt', amount: 50, price: 25, desc: 'mower belt replacement' },
                { item: 'trimmerCord', amount: 50, price: 20, desc: 'trimmer cord replacement' }
            ];
            const offer = offers[Math.floor(Math.random() * offers.length)];
            
            return {
                id: Date.now(),
                from: 'Steve',
                subject: 'Special offer just for you!',
                type: 'steveOffer',
                read: false,
                offer: offer,
                content: `Hey buddy,\n\nI've got a great deal for you today - ${offer.desc} for just $${offer.price}. ` +
                         `Let me know if you're interested!\n\nSteve`
            };
        }

        // Generate a referral email
        function generateReferral() {
            const customerName = randomCustomerName();
            const friendName = randomCustomerName();
            while (friendName === customerName) {
                friendName = randomCustomerName();
            }
            
            return {
                id: Date.now(),
                from: customerName,
                subject: 'Friend Referral',
                type: 'referral',
                read: false,
                customer: friendName,
                content: `Hi,\n\nMy friend ${friendName} is looking for lawn service. ` +
                         `I told them you do great work! Maybe you can help them out?\n\n${customerName}`
            };
        }

        // Update the email list display
        function updateEmailList() {
            elements.emailList.innerHTML = '';
            
            gameState.emails.forEach(email => {
                const emailElement = document.createElement('div');
                emailElement.className = `email-item ${email.read ? '' : 'unread'}`;
                emailElement.innerHTML = `
                    <strong>${email.from}</strong><br>
                    <div class="email-preview">${email.subject}</div>
                `;
                emailElement.addEventListener('click', () => showEmailDetail(email.id));
                elements.emailList.appendChild(emailElement);
            });
        }

        // Show email detail
        function showEmailDetail(emailId) {
            const email = gameState.emails.find(e => e.id === emailId);
            if (!email) return;
            
            email.read = true;
            elements.emailContent.textContent = email.content;
            elements.emailActions.innerHTML = '';
            
            switch (email.type) {
                case 'jobRequest':
                    const acceptBtn = document.createElement('button');
                    acceptBtn.textContent = 'Accept Job ($' + email.pay + ')';
                    acceptBtn.addEventListener('click', () => {
                        acceptJob(email);
                        showScreen('schedule');
                    });
                    
                    const rejectBtn = document.createElement('button');
                    rejectBtn.textContent = 'Reject';
                    rejectBtn.addEventListener('click', () => {
                        gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                        showScreen('email');
                    });
                    
                    elements.emailActions.appendChild(acceptBtn);
                    elements.emailActions.appendChild(rejectBtn);
                    break;
                    
                case 'complaint':
                    const fixBtn = document.createElement('button');
                    fixBtn.textContent = 'Offer to Fix (Cost: $20)';
                    fixBtn.addEventListener('click', () => {
                        if (canAfford(20)) {
                            deductMoney(20);
                            gameState.reputation += 5;
                            gameState.stress = Math.max(0, gameState.stress - 5);
                            gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                            showNotification(`You resolved ${email.from}'s complaint. Reputation +5 <span class="stress-down">Stress -5</span>`);
                            showScreen('email');
                            updateUI();
                        } else {
                            showNotification("Not enough money to fix this complaint");
                        }
                    });
                    
                    const ignoreBtn = document.createElement('button');
                    ignoreBtn.textContent = 'Ignore';
                    ignoreBtn.addEventListener('click', () => {
                        gameState.reputation -= 5;
                        gameState.stress = Math.min(100, gameState.stress + 10);
                        gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                        showNotification(`You ignored ${email.from}'s complaint. Reputation -5 <span class="stress-up">Stress +10</span>`);
                        showScreen('email');
                        updateUI();
                    });
                    
                    elements.emailActions.appendChild(fixBtn);
                    elements.emailActions.appendChild(ignoreBtn);
                    break;
                    
                case 'steveOffer':
                    const buyBtn = document.createElement('button');
                    buyBtn.textContent = 'Buy (' + email.offer.desc + ' for $' + email.offer.price + ')';
                    buyBtn.addEventListener('click', () => {
                        if (canAfford(email.offer.price)) {
                            deductMoney(email.offer.price);
                            
                            if (email.offer.item === 'energyDrinks') {
                                gameState.equipment.energyDrinks += email.offer.quantity;
                            } else if (email.offer.item === 'petrol') {
                                gameState.equipment.petrol = Math.min(100, gameState.equipment.petrol + email.offer.amount);
                            } else if (email.offer.item === 'mowerBelt') {
                                gameState.equipment.mowerBelt = Math.min(100, gameState.equipment.mowerBelt + email.offer.amount);
                            } else if (email.offer.item === 'trimmerCord') {
                                gameState.equipment.trimmerCord = Math.min(100, gameState.equipment.trimmerCord + email.offer.amount);
                            }
                            
                            gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                            showNotification(`Purchased ${email.offer.desc} from Steve`);
                            showScreen('email');
                            updateUI();
                        } else {
                            showNotification("Not enough money for this offer");
                        }
                    });
                    
                    const declineBtn = document.createElement('button');
                    declineBtn.textContent = 'Decline';
                    declineBtn.addEventListener('click', () => {
                        gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                        showScreen('email');
                    });
                    
                    elements.emailActions.appendChild(buyBtn);
                    elements.emailActions.appendChild(declineBtn);
                    break;
                    
                case 'referral':
                    const thanksBtn = document.createElement('button');
                    thanksBtn.textContent = 'Thank Customer';
                    thanksBtn.addEventListener('click', () => {
                        gameState.reputation += 3;
                        gameState.stress = Math.max(0, gameState.stress - 5);
                        gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                        showNotification(`Thanked ${email.from} for referral. Reputation +3 <span class="stress-down">Stress -5</span>`);
                        showScreen('email');
                        updateUI();
                    });
                    
                    elements.emailActions.appendChild(thanksBtn);
                    break;
                    
                case 'georgeWarning':
                    const okBtn = document.createElement('button');
                    okBtn.textContent = 'OK';
                    okBtn.addEventListener('click', () => {
                        gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                        showScreen('email');
                    });
                    
                    elements.emailActions.appendChild(okBtn);
                    break;
                    
                case 'georgeWelcome':
                    const gotItBtn = document.createElement('button');
                    gotItBtn.textContent = 'Got it!';
                    gotItBtn.addEventListener('click', () => {
                        gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                        showScreen('email');
                    });
                    
                    elements.emailActions.appendChild(gotItBtn);
                    break;
            }
            
            showScreen('emailDetail');
            updateUI();
        }

        // Check if player can afford something (cash + payee)
        function canAfford(amount) {
            return (gameState.money + gameState.bank.payee) >= amount;
        }

        // Deduct money from accounts (cash first, then payee)
        function deductMoney(amount) {
            if (gameState.money >= amount) {
                gameState.money -= amount;
                return;
            }
            
            // Use cash first, then payee
            const remaining = amount - gameState.money;
            gameState.money = 0;
            gameState.bank.payee -= remaining;
        }

        // Accept a job from an email
        function acceptJob(email) {
            // Create a job object
            const job = {
                id: Date.now(),
                customer: email.customer,
                type: email.jobType,
                pay: email.pay,
                scheduled: false,
                completed: false,
                missed: false
            };
            
            // Add to jobs list
            gameState.customers.push(job);
            
            // Remove the email
            gameState.emails = gameState.emails.filter(e => e.id !== email.id);
            
            showNotification(`Accepted job from ${email.customer}. Now schedule it!`);
            updateUI();
        }

        // Update the schedule display
        function updateScheduleDisplay() {
            elements.scheduleDisplay.innerHTML = '';
            
            // Show all days with time slots
            for (let day = 0; day < 5; day++) {
                const dayElement = document.createElement('div');
                dayElement.innerHTML = `<h3>${daysOfWeek[day]}</h3>`;
                
                // Show all time slots (8AM-5PM)
                for (let hour = 8; hour <= 17; hour++) {
                    const slotElement = document.createElement('div');
                    slotElement.className = 'schedule-slot';
                    
                    // Check if this slot is booked
                    const job = gameState.scheduledJobs[day].find(j => j.time === hour);
                    
                    if (job) {
                        if (job.completed) {
                            slotElement.classList.add('completed');
                            slotElement.innerHTML = `${formatTime(hour)} - ${job.customer} (${job.type.name}) - COMPLETED`;
                        } else if (job.missed) {
                            slotElement.classList.add('missed');
                            slotElement.innerHTML = `${formatTime(hour)} - ${job.customer} (${job.type.name}) - MISSED`;
                        } else {
                            slotElement.classList.add('booked');
                            slotElement.innerHTML = `${formatTime(hour)} - ${job.customer} (${job.type.name})`;
                        }
                    } else {
                        slotElement.innerHTML = `${formatTime(hour)} - Available`;
                        slotElement.addEventListener('click', () => showScheduleJobDialog(day, hour));
                    }
                    
                    dayElement.appendChild(slotElement);
                }
                
                elements.scheduleDisplay.appendChild(dayElement);
            }
        }

        // Show dialog to schedule a job
        function showScheduleJobDialog(day, hour) {
            // Get unscheduled jobs
            const unscheduledJobs = gameState.customers.filter(job => !job.scheduled);
            
            if (unscheduledJobs.length === 0) {
                showNotification("No jobs to schedule");
                return;
            }
            
            // Create a dialog
            const dialog = document.createElement('div');
            dialog.className = 'notification';
            dialog.innerHTML = `<h3>Schedule Job at ${formatTime(hour)} on ${daysOfWeek[day]}</h3>`;
            
            // Add job options
            unscheduledJobs.forEach(job => {
                const jobBtn = document.createElement('button');
                jobBtn.textContent = `${job.customer} - ${job.type.name} ($${job.pay})`;
                jobBtn.addEventListener('click', () => {
                    scheduleJob(job.id, day, hour);
                    elements.notificationArea.removeChild(dialog);
                });
                dialog.appendChild(jobBtn);
            });
            
            // Add cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.addEventListener('click', () => {
                elements.notificationArea.removeChild(dialog);
            });
            dialog.appendChild(cancelBtn);
            
            elements.notificationArea.appendChild(dialog);
        }

        // Schedule a job
        function scheduleJob(jobId, day, hour) {
            const jobIndex = gameState.customers.findIndex(j => j.id === jobId);
            if (jobIndex === -1) return;
            
            const job = gameState.customers[jobIndex];
            job.scheduled = true;
            job.day = day;
            job.time = hour;
            
            // Add to scheduled jobs
            gameState.scheduledJobs[day].push(job);
            
            // Remove from customers list
            gameState.customers.splice(jobIndex, 1);
            
            showNotification(`Scheduled job for ${job.customer} on ${daysOfWeek[day]} at ${formatTime(hour)}`);
            updateScheduleDisplay();
        }

        // Set up the shop
        function setupShop() {
            // Mowers
            const mowersDiv = document.getElementById('mowers');
            mowersDiv.innerHTML = '';
            for (const mower in equipmentStats.mower) {
                const item = equipmentStats.mower[mower];
                if (item.price === 0) continue; // Skip already owned
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                itemDiv.innerHTML = `
                    <strong>${item.name}</strong><br>
                    Speed: ${item.speed}x, Stress: ${item.stress}<br>
                    Reliability: ${Math.round(item.reliability * 100)}%<br>
                    Price: $${item.price}
                `;
                
                const buyBtn = document.createElement('button');
                buyBtn.textContent = 'Buy';
                buyBtn.addEventListener('click', () => buyEquipment('mower', mower, item.price));
                
                itemDiv.appendChild(buyBtn);
                mowersDiv.appendChild(itemDiv);
            }
            
            // Trimmers
            const trimmersDiv = document.getElementById('trimmers');
            trimmersDiv.innerHTML = '';
            for (const trimmer in equipmentStats.trimmer) {
                const item = equipmentStats.trimmer[trimmer];
                if (item.price === 0) continue;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                itemDiv.innerHTML = `
                    <strong>${item.name}</strong><br>
                    Speed: ${item.speed}x, Stress: ${item.stress}<br>
                    Reliability: ${Math.round(item.reliability * 100)}%<br>
                    Price: $${item.price}
                `;
                
                const buyBtn = document.createElement('button');
                buyBtn.textContent = 'Buy';
                buyBtn.addEventListener('click', () => buyEquipment('trimmer', trimmer, item.price));
                
                itemDiv.appendChild(buyBtn);
                trimmersDiv.appendChild(itemDiv);
            }
            
            // Blowers
            const blowersDiv = document.getElementById('blowers');
            blowersDiv.innerHTML = '';
            for (const blower in equipmentStats.blower) {
                const item = equipmentStats.blower[blower];
                if (item.price === 0) continue;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                itemDiv.innerHTML = `
                    <strong>${item.name}</strong><br>
                    Speed: ${item.speed}x, Stress: ${item.stress}<br>
                    Reliability: ${Math.round(item.reliability * 100)}%<br>
                    Price: $${item.price}
                `;
                
                const buyBtn = document.createElement('button');
                buyBtn.textContent = 'Buy';
                buyBtn.addEventListener('click', () => buyEquipment('blower', blower, item.price));
                
                itemDiv.appendChild(buyBtn);
                blowersDiv.appendChild(itemDiv);
            }
            
            // Supplies
            const suppliesDiv = document.getElementById('supplies');
            suppliesDiv.innerHTML = '';
            
            // Petrol
            const petrolDiv = document.createElement('div');
            petrolDiv.className = 'shop-item';
            petrolDiv.innerHTML = `
                <strong>Petrol Refill</strong><br>
                Restores petrol to 100%<br>
                Price: $50
            `;
            
            const petrolBtn = document.createElement('button');
            petrolBtn.textContent = 'Buy';
            petrolBtn.addEventListener('click', () => {
                if (canAfford(50)) {
                    deductMoney(50);
                    gameState.equipment.petrol = 100;
                    showNotification("Petrol refilled to 100%");
                    updateUI();
                    updateBankDisplay();
                } else {
                    showNotification("Not enough money in cash or payee account");
                }
            });
            petrolDiv.appendChild(petrolBtn);
            suppliesDiv.appendChild(petrolDiv);
            
            // Energy Drinks
            const energyDiv = document.createElement('div');
            energyDiv.className = 'shop-item';
            energyDiv.innerHTML = `
                <strong>Energy Drink (3-pack)</strong><br>
                Restores 50 energy each<br>
                Price: $30
            `;
            
            const energyBtn = document.createElement('button');
            energyBtn.textContent = 'Buy';
            energyBtn.addEventListener('click', () => {
                if (canAfford(30)) {
                    deductMoney(30);
                    gameState.equipment.energyDrinks += 3;
                    showNotification("Bought 3 energy drinks");
                    updateUI();
                    updateBankDisplay();
                } else {
                    showNotification("Not enough money in cash or payee account");
                }
            });
            energyDiv.appendChild(energyBtn);
            suppliesDiv.appendChild(energyDiv);
            
            // Mower Belt
            const beltDiv = document.createElement('div');
            beltDiv.className = 'shop-item';
            beltDiv.innerHTML = `
                <strong>Mower Belt Replacement</strong><br>
                Restores mower belt to 100%<br>
                Price: $40
            `;
            
            const beltBtn = document.createElement('button');
            beltBtn.textContent = 'Buy';
            beltBtn.addEventListener('click', () => {
                if (canAfford(40)) {
                    deductMoney(40);
                    gameState.equipment.mowerBelt = 100;
                    showNotification("Mower belt replaced");
                    updateUI();
                    updateBankDisplay();
                } else {
                    showNotification("Not enough money in cash or payee account");
                }
            });
            beltDiv.appendChild(beltBtn);
            suppliesDiv.appendChild(beltDiv);
            
            // Trimmer Cord
            const cordDiv = document.createElement('div');
            cordDiv.className = 'shop-item';
            cordDiv.innerHTML = `
                <strong>Trimmer Cord Replacement</strong><br>
                Restores trimmer cord to 100%<br>
                Price: $25
            `;
            
            const cordBtn = document.createElement('button');
            cordBtn.textContent = 'Buy';
            cordBtn.addEventListener('click', () => {
                if (canAfford(25)) {
                    deductMoney(25);
                    gameState.equipment.trimmerCord = 100;
                    showNotification("Trimmer cord replaced");
                    updateUI();
                    updateBankDisplay();
                } else {
                    showNotification("Not enough money in cash or payee account");
                }
            });
            cordDiv.appendChild(cordBtn);
            suppliesDiv.appendChild(cordDiv);
        }

        // Buy equipment
        function buyEquipment(type, model, price) {
            if (canAfford(price)) {
                deductMoney(price);
                gameState.equipment[type] = model;
                showNotification(`Purchased ${equipmentStats[type][model].name}`);
                updateUI();
                updateBankDisplay();
                setupShop();
            } else {
                showNotification(`Not enough money. Need $${price}, have $${(gameState.money + gameState.bank.payee).toFixed(2)} total (Cash: $${gameState.money.toFixed(2)}, Payee: $${gameState.bank.payee.toFixed(2)})`);
            }
        }

        // Start the work day
        function startWorkDay() {
            if (gameState.scheduledJobs[gameState.day].length === 0) {
                showNotification("No jobs scheduled for today");
                return;
            }
            
            gameState.workDayActive = true;
            gameState.currentJobIndex = 0;
            gameState.currentWorkDayTime = 8; // Start at 8am
            gameState.dailyCompleted = 0;
            gameState.dailyFailed = 0;
            gameState.energyDrinkActive = false;
            
            // Sort jobs by scheduled time
            gameState.scheduledJobs[gameState.day].sort((a, b) => a.time - b.time);
            
            startNextJob();
            showScreen('work');
            updateUI();
        }

        // Start the next job
        function startNextJob() {
            // Check if we've completed all jobs
            if (gameState.currentJobIndex >= gameState.scheduledJobs[gameState.day].length) {
                endWorkDay();
                return;
            }
            
            // Get the next job
            gameState.currentJob = gameState.scheduledJobs[gameState.day][gameState.currentJobIndex];
            
            // Skip completed jobs
            if (gameState.currentJob.completed || gameState.currentJob.missed) {
                gameState.currentJobIndex++;
                startNextJob();
                return;
            }
            
            // Set work day time to either job's scheduled time or current time (if running late)
            gameState.currentWorkDayTime = Math.max(gameState.currentWorkDayTime, gameState.currentJob.time);
            
            // Check if we're too late for this job (after 5pm)
            if (gameState.currentWorkDayTime >= 17) {
                missJob();
                return;
            }
            
            // Calculate job time based on equipment and weather
            const mowerSpeed = equipmentStats.mower[gameState.equipment.mower].speed;
            const weatherMod = weatherEffects[gameState.weather].workModifier;
            const jobTime = gameState.currentJob.type.baseTime / 60 / mowerSpeed / weatherMod; // Convert to hours
            
            gameState.currentJob.timeRemaining = jobTime * 60; // In minutes for display
            gameState.currentJob.progress = 0;
            gameState.currentJob.originalTimeRemaining = gameState.currentJob.timeRemaining; // Store original time
            
            // Add to job history
            addToJobHistory(`Started job for ${gameState.currentJob.customer} (${gameState.currentJob.type.name}) at ${formatTime(gameState.currentWorkDayTime)}`);
            
            // Start work timer
            if (gameState.workTimer) {
                clearInterval(gameState.workTimer);
            }
            
            gameState.workTimer = setInterval(workOnJob, 1000);
            updateWorkScreen();
        }

        // Work on the current job
        function workOnJob() {
            if (!gameState.currentJob) return;
            
            // Get equipment and weather modifiers
            const mowerSpeed = equipmentStats.mower[gameState.equipment.mower].speed;
            const weatherMod = weatherEffects[gameState.weather].workModifier;
            const totalJobTime = gameState.currentJob.type.baseTime / 60 / mowerSpeed / weatherMod; // In hours
            
            // Check if job is complete
            if (gameState.currentJob.timeRemaining <= 0) {
                completeJob();
                return;
            }
            
            // Calculate speed multiplier (2x if energy drink is active)
            const speedMultiplier = gameState.energyDrinkActive ? 2 : 1;
            
            // Reduce time remaining (in minutes)
            gameState.currentJob.timeRemaining -= (1 * speedMultiplier);
            
            // Update progress
            const elapsedTime = (gameState.currentJob.originalTimeRemaining - gameState.currentJob.timeRemaining) / gameState.currentJob.originalTimeRemaining;
            gameState.currentJob.progress = elapsedTime * 100;
            
            // Advance time by 1 minute (1/60 of an hour)
            gameState.currentWorkDayTime += (1/60) / speedMultiplier;
            
            // Reduce equipment condition (petrol consumption reduced by 50%)
            const equipmentReliability = equipmentStats.mower[gameState.equipment.mower].reliability;
            gameState.equipment.petrol = Math.max(0, gameState.equipment.petrol - (0.25 * (1/equipmentReliability) * speedMultiplier));
            gameState.equipment.mowerBelt = Math.max(0, gameState.equipment.mowerBelt - (0.2 * (1/equipmentReliability) * speedMultiplier));
            gameState.equipment.trimmerCord = Math.max(0, gameState.equipment.trimmerCord - (0.1 * (1/equipmentReliability) * speedMultiplier));
            
            // Get equipment stress reduction
            const mowerStress = equipmentStats.mower[gameState.equipment.mower].stress;
            const trimmerStress = equipmentStats.trimmer[gameState.equipment.trimmer].stress;
            const blowerStress = equipmentStats.blower[gameState.equipment.blower].stress;
            const equipmentStressMod = (mowerStress + trimmerStress + blowerStress) / 3;
            
            // Reduce energy and increase stress
            gameState.energy = Math.max(0, gameState.energy - (0.5 * weatherEffects[gameState.weather].stressModifier / 20 * speedMultiplier));
            gameState.stress = Math.min(100, gameState.stress + (0.3 * weatherEffects[gameState.weather].stressModifier / 20 * speedMultiplier * equipmentStressMod));
            
            // Check for equipment failure
            if (gameState.equipment.petrol <= 0) {
                showNotification("Out of petrol! Job failed");
                failJob();
                return;
            }
            
            if (gameState.equipment.mowerBelt <= 0) {
                showNotification("Mower belt broke! Job failed");
                failJob();
                return;
            }
            
            if (gameState.equipment.trimmerCord <= 0) {
                showNotification("Trimmer cord broke! Job failed");
                failJob();
                return;
            }
            
            // Check if work day is over (after 5pm)
            if (gameState.currentWorkDayTime >= 17) {
                showNotification("Work day ended - it's after 5pm!");
                endWorkDay();
                return;
            }
            
            // Update UI
            updateWorkScreen();
            updateUI();
        }

        // Complete the current job
        function completeJob() {
            clearInterval(gameState.workTimer);
            
            // Mark job as completed
            gameState.currentJob.completed = true;
            gameState.dailyCompleted++;
            
            // Add customer to mowed customers list if not already there
            if (!gameState.mowedCustomers.includes(gameState.currentJob.customer)) {
                gameState.mowedCustomers.push(gameState.currentJob.customer);
            }
            
            // Pay the player (to payee account)
            const grossPay = gameState.currentJob.pay;
            const taxAmount = grossPay * 0.15; // 15% tax
            const netPay = grossPay - taxAmount;
            
            gameState.bank.payee += netPay;
            gameState.bank.tax += taxAmount;
            
            gameState.completedJobs++;
            gameState.reputation = Math.min(100, gameState.reputation + gameState.currentJob.type.reputation);
            
            // Add tip based on reputation (goes to payee account)
            const tipChance = gameState.reputation / 100;
            if (Math.random() < tipChance) {
                const tipAmount = Math.round(gameState.currentJob.pay * 0.2); // 20% tip
                gameState.bank.payee += tipAmount;
                gameState.stress = Math.max(0, gameState.stress - 5);
                showNotification(`Bonus: ${gameState.currentJob.customer} gave you a $${tipAmount} tip! <span class="stress-down">Stress -5</span> <span class="money-up">+$${tipAmount}</span>`);
            }
            
            addToJobHistory(`Completed job for ${gameState.currentJob.customer} at ${formatTime(gameState.currentWorkDayTime)}. Earned $${netPay.toFixed(2)} ($${taxAmount.toFixed(2)} tax)`);
            showNotification(`Completed job for ${gameState.currentJob.customer}. Earned $${netPay.toFixed(2)} ($${taxAmount.toFixed(2)} tax) <span class="stress-down">Stress -5</span> <span class="money-up">+$${netPay.toFixed(2)}</span>`);
            
            // Reset energy drink effect
            gameState.energyDrinkActive = false;
            
            // Move to next job
            gameState.currentJobIndex++;
            startNextJob();
        }

        // Fail the current job
        function failJob() {
            clearInterval(gameState.workTimer);
            
            // Mark job as failed
            gameState.currentJob.missed = true;
            gameState.dailyFailed++;
            
            gameState.failedJobs++;
            gameState.reputation = Math.max(0, gameState.reputation - 5);
            gameState.stress = Math.min(100, gameState.stress + 10);
            
            addToJobHistory(`Failed job for ${gameState.currentJob.customer} at ${formatTime(gameState.currentWorkDayTime)}`);
            showNotification(`Failed job for ${gameState.currentJob.customer}. Reputation -5 <span class="stress-up">Stress +10</span>`);
            
            // Reset energy drink effect
            gameState.energyDrinkActive = false;
            
            // Move to next job
            gameState.currentJobIndex++;
            startNextJob();
        }

        // Miss a job (too late in the day)
        function missJob() {
            gameState.currentJob.missed = true;
            gameState.dailyFailed++;
            
            gameState.failedJobs++;
            gameState.reputation = Math.max(0, gameState.reputation - 3);
            gameState.stress = Math.min(100, gameState.stress + 5);
            
            addToJobHistory(`Missed job for ${gameState.currentJob.customer} (too late)`);
            showNotification(`Missed job for ${gameState.currentJob.customer} - it's too late in the day <span class="stress-up">Stress +5</span>`);
            
            // Reset energy drink effect
            gameState.energyDrinkActive = false;
            
            // Move to next job
            gameState.currentJobIndex++;
            startNextJob();
        }

        // Use an energy drink
        function useEnergyDrink() {
            if (gameState.equipment.energyDrinks > 0) {
                gameState.equipment.energyDrinks--;
                gameState.energy = Math.min(100, gameState.energy + 50);
                gameState.energyDrinkActive = true;
                showNotification("Energy drink used! +50 energy and 2x work speed for current job");
                updateUI();
            } else {
                showNotification("No energy drinks left");
            }
        }

        // Add entry to job history
        function addToJobHistory(message) {
            const now = new Date();
            const timestamp = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
            gameState.jobHistory.unshift(`${timestamp} - ${message}`);
            
            // Keep only the last 50 entries
            if (gameState.jobHistory.length > 50) {
                gameState.jobHistory.pop();
            }
            
            updateHistoryDisplay();
        }

        // Update job history display
        function updateHistoryDisplay() {
            elements.jobHistory.innerHTML = '';
            gameState.jobHistory.slice(0, 5).forEach(entry => {
                const item = document.createElement('div');
                item.className = 'job-history-item';
                item.textContent = entry;
                elements.jobHistory.appendChild(item);
            });
        }

        // Update full history display
        function updateFullHistoryDisplay() {
            elements.fullHistory.innerHTML = '';
            gameState.jobHistory.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'job-history-item';
                item.textContent = entry;
                elements.fullHistory.appendChild(item);
            });
        }

        // Update the work screen
        function updateWorkScreen() {
            if (!gameState.currentJob) return;
            
            elements.workDay.textContent = daysOfWeek[gameState.day];
            elements.currentJobName.textContent = `${gameState.currentJob.customer} - ${gameState.currentJob.type.name}`;
            elements.jobProgress.value = gameState.currentJob.progress;
            elements.timeRemaining.textContent = Math.ceil(gameState.currentJob.timeRemaining);
            
            elements.jobDetails.innerHTML = `
                Pay: $${gameState.currentJob.pay.toFixed(2)}<br>
                Weather: ${weatherEffects[gameState.weather].name}<br>
                Equipment: ${equipmentStats.mower[gameState.equipment.mower].name}
            `;
            
            // Update equipment status
            elements.mowerStatus.textContent = `${Math.round(gameState.equipment.mowerBelt)}%`;
            elements.trimmerStatus.textContent = `${Math.round(gameState.equipment.trimmerCord)}%`;
            elements.blowerStatus.textContent = '100%';
            elements.petrolStatus.textContent = `${Math.round(gameState.equipment.petrol)}%`;
            
            // Update time display during work day
            const currentHour = Math.floor(gameState.currentWorkDayTime);
            const currentMinutes = Math.floor((gameState.currentWorkDayTime % 1) * 60);
            const formattedMinutes = currentMinutes < 10 ? `0${currentMinutes}` : currentMinutes;
            const ampm = currentHour >= 12 ? 'PM' : 'AM';
            const displayHour = currentHour % 12 || 12;
            elements.timeDisplay.textContent = `${displayHour}:${formattedMinutes} ${ampm}`;
        }

        // End the work day
        function endWorkDay() {
            if (gameState.workTimer) {
                clearInterval(gameState.workTimer);
            }
            
            gameState.workDayActive = false;
            gameState.currentJob = null;
            gameState.energyDrinkActive = false;
            
            // Update game time to end of work day (5pm)
            gameState.time = 17;
            
            // Randomly change weather for next day
            const weatherTypes = Object.keys(weatherEffects);
            const weights = weatherTypes.map(w => weatherEffects[w].chance);
            gameState.weather = weightedRandom(weatherTypes, weights);
            
            // Generate summary notification
            if (gameState.dailyCompleted > 0 || gameState.dailyFailed > 0) {
                showNotification(`Work day complete: ${gameState.dailyCompleted} jobs done, ${gameState.dailyFailed} failed`);
            }
            
            // Generate new emails
            if (Math.random() < 0.7) {
                generateNewEmail();
            }
            
            showScreen('main');
            updateUI();
        }

        // Advance to the next day
        function advanceDay() {
            gameState.day++;
            
            // Check if week is over
            if (gameState.day >= 5) {
                gameState.day = 0;
                gameState.week++;
                
                // Pay interest on savings
                const interest = gameState.bank.savings * 0.02; // 2% interest
                gameState.bank.savings += interest;
                showNotification(`Savings account earned $${interest.toFixed(2)} interest <span class="money-up">+$${interest.toFixed(2)}</span>`);
                
                // Check if month is over (4 weeks)
                if (gameState.week > 4) {
                    gameState.week = 1;
                    gameState.month++;
                    
                    // Pay taxes (tax account is emptied)
                    const taxAmount = gameState.bank.tax;
                    gameState.bank.tax = 0;
                    showNotification(`Taxes paid for the month: $${taxAmount.toFixed(2)} <span class="money-down">-$${taxAmount.toFixed(2)}</span>`);
                }
                
                // Reset completed status for all jobs
                for (let day = 0; day < 5; day++) {
                    gameState.scheduledJobs[day].forEach(job => {
                        job.completed = false;
                        job.missed = false;
                    });
                }
                
                payWeeklyExpenses();
            }
            
            // Reset time to morning
            gameState.time = 8;
            
            // Recover some energy and reduce stress
            gameState.energy = Math.min(100, gameState.energy + 30);
            gameState.stress = Math.max(0, gameState.stress - 10);
            
            // Randomly generate new emails
            if (Math.random() < 0.5) {
                generateNewEmail();
            }
            
            updateUI();
            showNotification(`It's now ${daysOfWeek[gameState.day]}. Weather: ${weatherEffects[gameState.weather].name}`);
        }

        // Pay weekly expenses
        function payWeeklyExpenses() {
            const baseExpenses = 100;
            const equipmentExpenses = 
                (equipmentStats.mower[gameState.equipment.mower].price > 0 ? 20 : 0) +
                (equipmentStats.trimmer[gameState.equipment.trimmer].price > 0 ? 10 : 0) +
                (equipmentStats.blower[gameState.equipment.blower].price > 0 ? 10 : 0);
            
            const totalExpenses = baseExpenses + equipmentExpenses;
            
            // Try to deduct from payee account first, then from cash
            if (gameState.bank.payee >= totalExpenses) {
                gameState.bank.payee -= totalExpenses;
            } else if (gameState.money >= totalExpenses) {
                gameState.money -= totalExpenses;
            } else if (gameState.bank.payee + gameState.money >= totalExpenses) {
                const remaining = totalExpenses - gameState.bank.payee;
                gameState.money -= remaining;
                gameState.bank.payee = 0;
            } else {
                // Not enough money - game over?
                showNotification("Warning: Couldn't pay all weekly expenses!");
            }
            
            showNotification(`Paid weekly expenses: $${totalExpenses} (Base: $${baseExpenses}, Equipment: $${equipmentExpenses}) <span class="money-down">-$${totalExpenses.toFixed(2)}</span>`);
            
            // Check for game over
            if (gameState.money <= 0 && gameState.bank.payee <= 0 && gameState.bank.savings <= 0) {
                showNotification("Game Over - You ran out of money!");
                // Could add restart logic here
            }
        }

        // Show a notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = message;
            
            elements.notificationArea.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Helper function to get random property from object
        function randomProperty(obj) {
            const keys = Object.keys(obj);
            return obj[keys[Math.floor(Math.random() * keys.length)]];
        }

        // Helper function to get random customer name
        function randomCustomerName() {
            return customerNames[Math.floor(Math.random() * customerNames.length)];
        }

        // Helper function for weighted random selection
        function weightedRandom(items, weights) {
            let totalWeight = weights.reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;
            let weightSum = 0;
            
            for (let i = 0; i < items.length; i++) {
                weightSum += weights[i];
                if (random <= weightSum) return items[i];
            }
            
            return items[0];
        }

        // Initialize the game when the page loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
