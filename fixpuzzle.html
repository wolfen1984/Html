<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle of the Damned - Complete Expanded RPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000000;
            font-family: 'Courier New', monospace;
            color: #85f285;
            line-height: 1.4;
            padding: 10px;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            border: 1px solid #85f285;
            padding: 10px;
            position: relative;
            background-color: #000000;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #85f285;
        }
        
        h1 {
            color: #85f285;
            font-size: 1.8rem;
            letter-spacing: 1px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .subtitle {
            color: #85f285;
            font-size: 0.9rem;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .game-area {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .screen-container {
            flex: 3;
            min-width: 400px;
            background-color: #000000;
            border: 1px solid #85f285;
            padding: 10px;
        }
        
        .game-screen {
            background-color: #000000;
            color: #85f285;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            padding: 10px;
            height: 600px;
            overflow-y: auto;
            border: 1px solid #85f285;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .game-screen::-webkit-scrollbar {
            width: 10px;
        }
        
        .game-screen::-webkit-scrollbar-track {
            background: #000000;
        }
        
        .game-screen::-webkit-scrollbar-thumb {
            background: #85f285;
            border: 1px solid #85f285;
        }
        
        .side-panel {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .player-info, .controls, .inventory, .quest-log, .map-container {
            border: 1px solid #85f285;
            padding: 10px;
            background-color: #000000;
        }
        
        h3 {
            color: #85f285;
            text-align: center;
            margin-bottom: 10px;
            font-size: 1rem;
            text-transform: uppercase;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }
        
        .stat-name {
            color: #85f285;
        }
        
        .stat-value {
            color: #85f285;
        }
        
        .health-bar-container, .mana-bar-container {
            margin-bottom: 10px;
        }
        
        .bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.7rem;
        }
        
        .bar {
            height: 12px;
            background-color: #000000;
            border: 1px solid #85f285;
            overflow: hidden;
        }
        
        .health-bar {
            height: 100%;
            background-color: #85f285;
            width: 80%;
        }
        
        .mana-bar {
            height: 100%;
            background-color: #85f285;
            width: 60%;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        button {
            background-color: #000000;
            color: #85f285;
            border: 1px solid #85f285;
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            padding: 6px;
            cursor: pointer;
            text-align: center;
            text-transform: uppercase;
        }
        
        button:hover {
            background-color: #0a2a0a;
        }
        
        button:active {
            background-color: #1a5a1a;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .game-input {
            display: flex;
            margin-top: 5px;
        }
        
        input {
            flex: 1;
            background-color: #000000;
            color: #85f285;
            border: 1px solid #85f285;
            font-family: 'Courier New', monospace;
            padding: 6px;
            font-size: 0.8rem;
        }
        
        input:focus {
            outline: none;
            border-color: #85f285;
        }
        
        .submit-btn {
            background-color: #000000;
            border: 1px solid #85f285;
            padding: 6px 10px;
            margin-left: 5px;
        }
        
        .inventory-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }
        
        .item {
            background-color: #000000;
            border: 1px solid #85f285;
            padding: 4px;
            text-align: center;
            font-size: 0.6rem;
            cursor: pointer;
        }
        
        .item:hover {
            background-color: #0a2a0a;
        }
        
        .quest-item {
            font-size: 0.6rem;
            margin-bottom: 5px;
            padding: 4px;
            border-left: 1px solid #85f285;
        }
        
        .mini-map {
            font-family: monospace;
            font-size: 8px;
            line-height: 0.8;
            white-space: pre;
        }
        
        .current-room {
            background-color: #85f285;
            color: #000000;
        }
        
        .visited-room {
            color: #85f285;
        }
        
        .unvisited-room {
            color: #333333;
        }
        
        .footer {
            text-align: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #85f285;
            font-size: 0.7rem;
            color: #85f285;
        }
        
        @media (max-width: 1000px) {
            .game-area {
                flex-direction: column;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .subtitle {
                font-size: 0.8rem;
            }
            
            .game-screen {
                height: 400px;
                font-size: 12px;
            }
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .game-over {
            color: #85f285;
            font-size: 1.2rem;
            text-align: center;
            margin-top: 20px;
            border: 1px solid #85f285;
            padding: 10px;
        }
        
        .victory {
            color: #85f285;
            font-size: 1.2rem;
            text-align: center;
            margin-top: 20px;
            border: 1px solid #85f285;
            padding: 10px;
        }
        
        .combat-log {
            color: #ff6b6b;
        }
        
        .item-log {
            color: #4ecdc4;
        }
        
        .quest-log-text {
            color: #ffd93d;
        }
        
        .npc-log {
            color: #a29bfe;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1>CASTLE OF THE DAMNED - COMPLETE EDITION</h1>
            <div class="subtitle">AN EXPANDED RPG WITH 50+ ROOMS | 12 QUESTS | 25 ENEMIES | 60 ITEMS</div>
        </div>
        
        <div class="game-area">
            <div class="screen-container">
                <div class="game-screen" id="game-screen">
CASTLE OF THE DAMNED - COMPLETE EDITION
========================================

You stand before the ominous gates of the
Castle of the Damned. Legends speak of
untold treasures, ancient puzzles, and
forgotten souls trapped within its walls.

The heavy oak doors creak open slowly,
revealing a dark, foreboding entrance hall.
Torches flicker on the walls, casting
dancing shadows that seem to beckon you
forward.

What will you do?
> 
                </div>
            </div>
            
            <div class="side-panel">
                <div class="player-info">
                    <h3>HERO STATS</h3>
                    <div class="stat">
                        <span class="stat-name">NAME:</span>
                        <span class="stat-value" id="player-name">VALERIAN</span>
                    </div>
                    <div class="stat">
                        <span class="stat-name">CLASS:</span>
                        <span class="stat-value" id="player-class">KNIGHT</span>
                    </div>
                    <div class="stat">
                        <span class="stat-name">LEVEL:</span>
                        <span class="stat-value" id="player-level">1</span>
                    </div>
                    
                    <div class="health-bar-container">
                        <div class="bar-label">
                            <span>HEALTH</span>
                            <span id="health-text">80/100</span>
                        </div>
                        <div class="bar">
                            <div class="health-bar" id="health-bar"></div>
                        </div>
                    </div>
                    
                    <div class="mana-bar-container">
                        <div class="bar-label">
                            <span>MANA</span>
                            <span id="mana-text">40/60</span>
                        </div>
                        <div class="bar">
                            <div class="mana-bar" id="mana-bar"></div>
                        </div>
                    </div>
                    
                    <div class="stat">
                        <span class="stat-name">ATTACK:</span>
                        <span class="stat-value" id="player-attack">12</span>
                    </div>
                    <div class="stat">
                        <span class="stat-name">DEFENSE:</span>
                        <span class="stat-value" id="player-defense">10</span>
                    </div>
                    <div class="stat">
                        <span class="stat-name">GOLD:</span>
                        <span class="stat-value" id="player-gold">50</span>
                    </div>
                </div>
                
                <div class="controls">
                    <h3>ACTIONS</h3>
                    <div class="action-buttons">
                        <button id="fight-btn">FIGHT</button>
                        <button id="spell-btn">CAST SPELL</button>
                        <button id="item-btn">USE ITEM</button>
                        <button id="flee-btn">FLEE</button>
                        <button id="rest-btn">REST</button>
                        <button id="explore-btn">EXPLORE</button>
                    </div>
                    
                    <div class="game-input">
                        <input type="text" id="command-input" placeholder="ENTER COMMAND..." autocomplete="off">
                        <button class="submit-btn" id="submit-btn">SEND</button>
                    </div>
                </div>
                
                <div class="map-container">
                    <h3>CASTLE MAP</h3>
                    <div class="mini-map" id="mini-map"></div>
                </div>
                
                <div class="inventory">
                    <h3>INVENTORY</h3>
                    <div class="inventory-items" id="inventory-items">
                        <div class="item">HEALTH POTION (2)</div>
                        <div class="item">MANA POTION (1)</div>
                        <div class="item">TORCH</div>
                        <div class="item">IRON KEY</div>
                        <div class="item">SILVER DAGGER</div>
                        <div class="item">OLD LETTER</div>
                    </div>
                </div>
                
                <div class="quest-log">
                    <h3>ACTIVE QUESTS</h3>
                    <div id="quest-list">
                        <div class="quest-item">Find the Four Elemental Orbs</div>
                        <div class="quest-item">Help the Ghostly Knight</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE DAMNED - COMPLETE EDITION | 50+ ROOMS | 12 QUESTS | 25 ENEMY TYPES | 60 ITEMS
        </div>
    </div>

    <script>
        // ===============================
        // GAME STATE - COMPLETE EDITION
        // ===============================
        const gameState = {
            player: {
                name: "VALERIAN",
                class: "KNIGHT",
                level: 1,
                health: 80,
                maxHealth: 100,
                mana: 40,
                maxMana: 60,
                attack: 12,
                defense: 10,
                gold: 50,
                experience: 0,
                nextLevelExp: 100,
                equippedWeapon: null,
                equippedArmor: null,
                spells: ["LIGHT", "HEAL"],
                keys: []
            },
            
            inventory: [
                { name: "HEALTH POTION", count: 2, type: "consumable", description: "Restores 30 HP", use: "heal", value: 20 },
                { name: "MANA POTION", count: 1, type: "consumable", description: "Restores 25 MP", use: "mana", value: 25 },
                { name: "TORCH", count: 1, type: "tool", description: "Lights dark areas", use: "light", value: 5 },
                { name: "IRON KEY", count: 1, type: "key", description: "Opens iron doors", use: "unlock", value: 10 },
                { name: "SILVER DAGGER", count: 1, type: "weapon", description: "+3 Attack vs undead", use: "equip", value: 50 },
                { name: "OLD LETTER", count: 1, type: "quest", description: "A faded letter from the king", use: "read", value: 1 }
            ],
            
            currentEnemy: null,
            gameActive: true,
            currentRoom: "entrance_hall",
            roomsVisited: ["entrance_hall"],
            
            // ===============================
            // 50+ ROOMS DEFINITION
            // ===============================
            rooms: {
                // Main Castle - Ground Floor (15 rooms)
                entrance_hall: {
                    name: "Entrance Hall",
                    description: "A grand hall with marble floors and faded tapestries. The massive entrance doors loom behind you.",
                    exits: { north: "great_hall", east: "guard_room", west: "chapel", south: "courtyard" },
                    items: ["rusty_sword", "torn_cloak"],
                    npcs: [],
                    enemies: ["skeleton_guard"],
                    locked: false,
                    dark: false,
                    visited: true
                },
                great_hall: {
                    name: "Great Hall",
                    description: "An enormous hall with a long banquet table covered in dust. Chandeliers hang from the high ceiling.",
                    exits: { north: "throne_room", south: "entrance_hall", east: "kitchen", west: "library" },
                    items: ["silver_goblet", "candleholder"],
                    npcs: ["ghostly_butler"],
                    enemies: [],
                    locked: false,
                    dark: false,
                    visited: false
                },
                throne_room: {
                    name: "Throne Room",
                    description: "The royal throne sits on a dais. Shadows dance across the obsidian throne.",
                    exits: { south: "great_hall", east: "royal_chambers", west: "council_room" },
                    items: ["crown", "royal_scepter"],
                    npcs: [],
                    enemies: ["shadow_dragon"],
                    locked: true,
                    key: "royal_key",
                    dark: true,
                    visited: false
                },
                guard_room: {
                    name: "Guard Room",
                    description: "Rusted weapons and armor line the walls. Training dummies stand in corners.",
                    exits: { west: "entrance_hall", north: "armory", east: "barracks" },
                    items: ["iron_helmet", "training_sword"],
                    npcs: [],
                    enemies: ["skeleton_warrior", "zombie_guard"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                armory: {
                    name: "Armory",
                    description: "Weapons of all kinds fill racks. Shields hang on the walls.",
                    exits: { south: "guard_room", east: "forge", west: "treasury" },
                    items: ["steel_sword", "iron_shield", "crossbow"],
                    npcs: ["ghostly_knight"],
                    enemies: ["animated_armor"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                chapel: {
                    name: "Chapel",
                    description: "A holy place now desecrated. Stained glass windows are shattered.",
                    exits: { east: "entrance_hall", north: "library", down: "crypt" },
                    items: ["holy_symbol", "prayer_book"],
                    npcs: ["fallen_priest"],
                    enemies: ["cursed_priest", "ghost"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                library: {
                    name: "Grand Library",
                    description: "Thousands of books line the shelves. Some float in mid-air.",
                    exits: { south: "chapel", east: "great_hall", north: "study", west: "observatory" },
                    items: ["spell_scroll", "ancient_tome"],
                    npcs: ["trapped_mage", "ghost_librarian"],
                    enemies: ["book_wyrm"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                kitchen: {
                    name: "Royal Kitchen",
                    description: "Massive ovens and cooking implements. Rotten food fills barrels.",
                    exits: { west: "great_hall", north: "pantry", east: "servants_quarters" },
                    items: ["kitchen_knife", "spice_sack"],
                    npcs: ["ghost_cook"],
                    enemies: ["rat_swarm", "kitchen_golem"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                courtyard: {
                    name: "Central Courtyard",
                    description: "An overgrown courtyard with a dried-up fountain. Moonlight filters through clouds.",
                    exits: { north: "entrance_hall", east: "stables", west: "gardens", south: "gatehouse" },
                    items: ["fountain_coin", "garden_shears"],
                    npcs: ["mad_gardener"],
                    enemies: ["giant_spider", "courtyard_gargoyle"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                barracks: {
                    name: "Barracks",
                    description: "Rows of bunk beds covered in dust. Personal belongings are scattered about.",
                    exits: { west: "guard_room", north: "officers_quarters", east: "training_yard" },
                    items: ["soldier_diary", "iron_key"],
                    npcs: [],
                    enemies: ["skeleton_soldier", "ghost_soldier"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                forge: {
                    name: "Blacksmith's Forge",
                    description: "The forge still glows with magical embers. Anvils and hammers lie about.",
                    exits: { west: "armory", north: "ore_storage" },
                    items: ["enchanted_hammer", "mithril_ingot"],
                    npcs: ["ghost_blacksmith"],
                    enemies: ["fire_elemental"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                treasury: {
                    name: "Royal Treasury",
                    description: "Piles of gold and jewels fill the room. Magical wards flicker on the walls.",
                    exits: { east: "armory" },
                    items: ["gold_coins", "ruby", "emerald", "diamond"],
                    npcs: [],
                    enemies: ["treasure_golem", "mimic"],
                    locked: true,
                    key: "treasury_key",
                    dark: false,
                    visited: false
                },
                study: {
                    name: "Royal Study",
                    description: "A scholar's study with maps and star charts. A large telescope points skyward.",
                    exits: { south: "library", up: "observatory_tower" },
                    items: ["star_chart", "magnifying_glass"],
                    npcs: ["royal_astronomer"],
                    enemies: ["ink_elemental"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                pantry: {
                    name: "Food Pantry",
                    description: "Shelves of preserved food, now rotten and magical.",
                    exits: { south: "kitchen" },
                    items: ["magical_apple", "preserved_meat"],
                    npcs: [],
                    enemies: ["rot_golem", "giant_rat"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                stables: {
                    name: "Royal Stables",
                    description: "Empty horse stalls with spectral horses still visible.",
                    exits: { west: "courtyard" },
                    items: ["horse_saddle", "riding_crop"],
                    npcs: ["ghost_stablehand"],
                    enemies: ["nightmare_steed"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                
                // Upper Floors (15 rooms)
                royal_chambers: {
                    name: "Royal Chambers",
                    description: "Luxurious bedrooms for the royal family. Velvet curtains hang in tatters.",
                    exits: { west: "throne_room", east: "queens_chambers", north: "princes_room" },
                    items: ["royal_jewelry", "silken_robe"],
                    npcs: ["ghost_queen"],
                    enemies: ["royal_guard_ghost"],
                    locked: true,
                    key: "chamber_key",
                    dark: false,
                    visited: false
                },
                council_room: {
                    name: "Council Room",
                    description: "A round table with high-backed chairs. Maps of the kingdom cover the walls.",
                    exits: { east: "throne_room", north: "war_room" },
                    items: ["council_seal", "kingdom_map"],
                    npcs: ["ghost_councillor"],
                    enemies: ["phantom_knight"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                observatory: {
                    name: "Observatory",
                    description: "A dome with a massive telescope. Star charts cover every surface.",
                    exits: { east: "library", down: "study" },
                    items: ["telescope_lens", "astrology_chart"],
                    npcs: [],
                    enemies: ["star_spawn"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                servants_quarters: {
                    name: "Servants' Quarters",
                    description: "Small, simple rooms for the castle staff.",
                    exits: { west: "kitchen", up: "servants_loft" },
                    items: ["servant_key", "linen_cloth"],
                    npcs: ["ghost_maid"],
                    enemies: ["poltergeist"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                gardens: {
                    name: "Royal Gardens",
                    description: "Overgrown magical gardens. Strange plants glow in the moonlight.",
                    exits: { east: "courtyard", north: "maze_entrance", west: "greenhouse" },
                    items: ["magical_herb", "garden_key"],
                    npcs: ["dryad"],
                    enemies: ["thorn_beast", "vine_creeper"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                officers_quarters: {
                    name: "Officers' Quarters",
                    description: "Better appointed rooms for military officers.",
                    exits: { south: "barracks" },
                    items: ["officers_sword", "tactical_map"],
                    npcs: ["ghost_captain"],
                    enemies: ["spectral_officer"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                training_yard: {
                    name: "Training Yard",
                    description: "An outdoor training area with targets and practice dummies.",
                    exits: { west: "barracks" },
                    items: ["training_dummy", "practice_sword"],
                    npcs: [],
                    enemies: ["training_golem"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                ore_storage: {
                    name: "Ore Storage",
                    description: "Raw materials for the forge. Glowing ores fill bins.",
                    exits: { south: "forge" },
                    items: ["iron_ore", "gold_ore", "magic_crystal"],
                    npcs: [],
                    enemies: ["rock_golem"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                observatory_tower: {
                    name: "Observatory Tower",
                    description: "The highest point in the castle. The view is breathtaking.",
                    exits: { down: "study" },
                    items: ["star_compass", "cloud_jewel"],
                    npcs: [],
                    enemies: ["wind_elemental"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                queens_chambers: {
                    name: "Queen's Chambers",
                    description: "Elegant chambers with a large canopied bed.",
                    exits: { west: "royal_chambers" },
                    items: ["queens_crown", "perfume_bottle"],
                    npcs: [],
                    enemies: ["cursed_handmaiden"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                princes_room: {
                    name: "Prince's Room",
                    description: "A child's room with toys and a small bed.",
                    exits: { south: "royal_chambers" },
                    items: ["wooden_sword", "royal_doll"],
                    npcs: ["ghost_prince"],
                    enemies: ["toy_soldier_golem"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                war_room: {
                    name: "War Room",
                    description: "Military planning room with battle maps and miniature armies.",
                    exits: { south: "council_room" },
                    items: ["battle_plans", "general_badge"],
                    npcs: [],
                    enemies: ["phantom_strategist"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                servants_loft: {
                    name: "Servants' Loft",
                    description: "A cramped attic space for lower servants.",
                    exits: { down: "servants_quarters" },
                    items: ["hidden_diary", "spare_key"],
                    npcs: [],
                    enemies: ["dust_bunny_swarm"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                maze_entrance: {
                    name: "Hedge Maze Entrance",
                    description: "The entrance to a massive hedge maze.",
                    exits: { south: "gardens", north: "maze_center", east: "maze_east", west: "maze_west" },
                    items: ["maze_map_fragment"],
                    npcs: [],
                    enemies: ["hedge_beast"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                greenhouse: {
                    name: "Royal Greenhouse",
                    description: "Glass structure filled with exotic, dangerous plants.",
                    exits: { east: "gardens" },
                    items: ["venus_flytrap_seed", "healing_herb"],
                    npcs: [],
                    enemies: ["carnivorous_plant", "spore_cloud"],
                    locked: true,
                    key: "greenhouse_key",
                    dark: false,
                    visited: false
                },
                
                // Lower Floors and Dungeons (20+ rooms)
                crypt: {
                    name: "Royal Crypt",
                    description: "Stone coffins line the walls. The air is cold and still.",
                    exits: { up: "chapel", north: "crypt_depths", east: "catacombs" },
                    items: ["funerary_urn", "grave_dirt"],
                    npcs: ["mourning_ghost"],
                    enemies: ["crypt_wraith", "skeleton_lord"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                gatehouse: {
                    name: "Gatehouse",
                    description: "The castle's main gate control room.",
                    exits: { north: "courtyard", down: "guard_tunnel" },
                    items: ["gate_key", "portcullis_control"],
                    npcs: [],
                    enemies: ["gate_gargoyle", "portcullis_golem"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                catacombs: {
                    name: "Catacombs",
                    description: "Tunnels filled with bones stacked in patterns.",
                    exits: { west: "crypt", north: "ossuary", east: "burial_chamber" },
                    items: ["ancient_bone", "catacomb_key"],
                    npcs: ["bone_collector"],
                    enemies: ["bone_golem", "crypt_creeper"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                guard_tunnel: {
                    name: "Guard Tunnel",
                    description: "Secret tunnel for guards to move around the castle.",
                    exits: { up: "gatehouse", east: "dungeon_entrance", west: "escape_tunnel" },
                    items: ["tunnel_map", "guard_torch"],
                    npcs: [],
                    enemies: ["tunnel_snake", "cave_crawler"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                dungeon_entrance: {
                    name: "Dungeon Entrance",
                    description: "Heavy iron doors leading to the dungeon proper.",
                    exits: { west: "guard_tunnel", down: "dungeon_hall" },
                    items: ["jailor_key"],
                    npcs: ["dungeon_jailor"],
                    enemies: ["prison_guard"],
                    locked: true,
                    key: "dungeon_key",
                    dark: true,
                    visited: false
                },
                dungeon_hall: {
                    name: "Dungeon Hall",
                    description: "A corridor lined with prison cells. Moans echo from within.",
                    exits: { up: "dungeon_entrance", north: "torture_chamber", east: "high_security", south: "prison_cells" },
                    items: ["prison_key", "shackles"],
                    npcs: ["prisoner_ghost"],
                    enemies: ["dungeon_warden", "chain_golem"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                torture_chamber: {
                    name: "Torture Chamber",
                    description: "Gruesome devices fill this room. The walls are stained.",
                    exits: { south: "dungeon_hall" },
                    items: ["torture_device", "confession_letter"],
                    npcs: ["torturer_ghost"],
                    enemies: ["pain_elemental"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                prison_cells: {
                    name: "Prison Cells",
                    description: "Rows of iron-barred cells. Some still contain skeletal remains.",
                    exits: { north: "dungeon_hall" },
                    items: ["prisoner_diary", "makeshift_shiv"],
                    npcs: ["wrongly_accused_ghost"],
                    enemies: ["prisoner_zombie"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                high_security: {
                    name: "High Security Cell",
                    description: "A single, heavily reinforced cell for special prisoners.",
                    exits: { west: "dungeon_hall" },
                    items: ["high_security_key", "prisoner_notes"],
                    npcs: ["ancient_prisoner"],
                    enemies: ["security_golem"],
                    locked: true,
                    key: "high_security_key",
                    dark: true,
                    visited: false
                },
                escape_tunnel: {
                    name: "Escape Tunnel",
                    description: "A secret tunnel for escaping the castle.",
                    exits: { east: "guard_tunnel", west: "tunnel_exit" },
                    items: ["escape_plan", "tunnel_pick"],
                    npcs: [],
                    enemies: ["tunnel_ooze", "rockfall"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                tunnel_exit: {
                    name: "Tunnel Exit",
                    description: "The exit of the escape tunnel, hidden in the forest.",
                    exits: { east: "escape_tunnel" },
                    items: ["forest_berries", "hidden_cache"],
                    npcs: ["forest_hermit"],
                    enemies: ["forest_troll"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                crypt_depths: {
                    name: "Crypt Depths",
                    description: "Older, more elaborate tombs of ancient rulers.",
                    exits: { south: "crypt", down: "ancient_tomb" },
                    items: ["ancient_sarcophagus", "royal_sigil"],
                    npcs: ["ancient_king_ghost"],
                    enemies: ["tomb_guardian", "mummy"],
                    locked: true,
                    key: "crypt_key",
                    dark: true,
                    visited: false
                },
                ossuary: {
                    name: "Ossuary",
                    description: "A room where bones are artistically arranged.",
                    exits: { south: "catacombs" },
                    items: ["skull_lantern", "bone_charm"],
                    npcs: [],
                    enemies: ["bone_horror", "skull_swarm"],
                    locked: false,
                    dark: true,
                    visited: false
                },
                burial_chamber: {
                    name: "Burial Chamber",
                    description: "A chamber for important burials with treasure.",
                    exits: { west: "catacombs" },
                    items: ["burial_treasure", "funerary_mask"],
                    npcs: [],
                    enemies: ["grave_keeper", "burial_guardian"],
                    locked: true,
                    key: "burial_key",
                    dark: true,
                    visited: false
                },
                maze_center: {
                    name: "Maze Center",
                    description: "The center of the hedge maze with a stone pedestal.",
                    exits: { south: "maze_entrance", north: "maze_north", east: "maze_east", west: "maze_west" },
                    items: ["maze_center_key", "stone_tablet"],
                    npcs: ["maze_keeper"],
                    enemies: ["minotaur"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                maze_north: {
                    name: "Maze North Path",
                    description: "Twisting path through the hedge maze.",
                    exits: { south: "maze_center" },
                    items: [],
                    npcs: [],
                    enemies: ["hedge_beast"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                maze_east: {
                    name: "Maze East Path",
                    description: "Twisting path through the hedge maze.",
                    exits: { west: "maze_center" },
                    items: ["maze_map_fragment"],
                    npcs: [],
                    enemies: ["thorn_beast"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                maze_west: {
                    name: "Maze West Path",
                    description: "Twisting path through the hedge maze.",
                    exits: { east: "maze_center" },
                    items: ["maze_map_fragment"],
                    npcs: [],
                    enemies: ["vine_creeper"],
                    locked: false,
                    dark: false,
                    visited: false
                },
                ancient_tomb: {
                    name: "Ancient Tomb",
                    description: "The tomb of the castle's founder. Powerful magic lingers here.",
                    exits: { up: "crypt_depths" },
                    items: ["founders_sword", "founders_crown", "elemental_orb_fire"],
                    npcs: ["founder_ghost"],
                    enemies: ["tomb_lord", "cursed_pharaoh"],
                    locked: true,
                    key: "tomb_key",
                    dark: true,
                    visited: false
                },
                // Special Rooms
                elemental_chamber_fire: {
                    name: "Fire Elemental Chamber",
                    description: "A chamber filled with volcanic heat and lava flows.",
                    exits: { south: "great_hall" },
                    items: ["fire_orb", "lava_shard"],
                    npcs: ["fire_elemental_lord"],
                    enemies: ["fire_drake", "magma_golem"],
                    locked: true,
                    key: "fire_key",
                    dark: false,
                    visited: false
                },
                elemental_chamber_water: {
                    name: "Water Elemental Chamber",
                    description: "An underground grotto with a subterranean lake.",
                    exits: { south: "great_hall" },
                    items: ["water_orb", "pearl"],
                    npcs: ["water_nymph"],
                    enemies: ["water_elemental", "kraken_tentacle"],
                    locked: true,
                    key: "water_key",
                    dark: false,
                    visited: false
                },
                elemental_chamber_earth: {
                    name: "Earth Elemental Chamber",
                    description: "A cavern deep within the castle foundations.",
                    exits: { south: "great_hall" },
                    items: ["earth_orb", "crystal_geode"],
                    npcs: ["earth_elemental"],
                    enemies: ["stone_colossus", "cave_troll"],
                    locked: true,
                    key: "earth_key",
                    dark: true,
                    visited: false
                },
                elemental_chamber_air: {
                    name: "Air Elemental Chamber",
                    description: "A room at the highest tower, open to the sky.",
                    exits: { down: "observatory_tower" },
                    items: ["air_orb", "cloud_crystal"],
                    npcs: ["air_elemental"],
                    enemies: ["storm_elemental", "thunderbird"],
                    locked: true,
                    key: "air_key",
                    dark: false,
                    visited: false
                }
            },
            
            gameLog: [],
            quests: {
                elementalOrbs: { 
                    active: true, 
                    progress: { fire: false, water: false, earth: false, air: false },
                    description: "Find the Four Elemental Orbs",
                    reward: "Elemental Amulet",
                    location: "elemental_chamber_fire"
                },
                ghostlyKnight: { 
                    active: true, 
                    completed: false, 
                    description: "Help the Ghostly Knight find peace",
                    reward: "Guardian Key",
                    location: "armory"
                },
                libraryPuzzle: { 
                    active: false, 
                    completed: false, 
                    description: "Solve the library's book puzzle",
                    reward: "Ancient Scroll",
                    location: "library"
                },
                treasuryRaid: {
                    active: false,
                    completed: false,
                    description: "Raid the royal treasury",
                    reward: "1000 Gold",
                    location: "treasury"
                },
                rescueMaid: {
                    active: false,
                    completed: false,
                    description: "Rescue the ghost maid's lost locket",
                    reward: "Maid's Blessing",
                    location: "servants_quarters"
                },
                blacksmithRequest: {
                    active: false,
                    completed: false,
                    description: "Bring mithril to the ghost blacksmith",
                    reward: "Enchanted Sword",
                    location: "forge"
                },
                mazeChallenge: {
                    active: false,
                    completed: false,
                    description: "Navigate the hedge maze and defeat the minotaur",
                    reward: "Maze Champion Trophy",
                    location: "maze_center"
                },
                royalFamily: {
                    active: false,
                    completed: false,
                    description: "Help the royal family ghosts find peace",
                    reward: "Royal Favor",
                    location: "royal_chambers"
                },
                dungeonEscape: {
                    active: false,
                    completed: false,
                    description: "Help the wrongly accused ghost escape",
                    reward: "Prisoner's Gratitude",
                    location: "prison_cells"
                },
                astronomerQuest: {
                    active: false,
                    completed: false,
                    description: "Help the royal astronomer complete his star chart",
                    reward: "Star Compass",
                    location: "observatory"
                },
                gardenerQuest: {
                    active: false,
                    completed: false,
                    description: "Help the mad gardener with his magical plants",
                    reward: "Golden Seed",
                    location: "gardens"
                },
                founderTomb: {
                    active: false,
                    completed: false,
                    description: "Explore the ancient tomb of the castle founder",
                    reward: "Founder's Legacy",
                    location: "ancient_tomb"
                }
            },
            puzzles: {
                libraryBooks: { solved: false, clue: "The order is: History, Magic, Science, Poetry" },
                elementalDoors: { solved: false, clue: "Each door requires its corresponding orb" },
                hedgeMaze: { solved: false, clue: "Follow the moss on the hedges" },
                observatoryPuzzle: { solved: false, clue: "Align the stars with the constellations" }
            },
            npcs: {
                ghostly_knight: { 
                    name: "SIR ALISTAIR", 
                    location: "armory", 
                    dialogue: 0,
                    questGiven: false,
                    questCompleted: false,
                    dialogueOptions: [
                        "Who are you?",
                        "What happened here?",
                        "How can I help?",
                        "About that ancestral sword..."
                    ]
                },
                trapped_mage: { 
                    name: "ARCHMAGE ELDRIN", 
                    location: "library", 
                    dialogue: 0,
                    needsHelp: true,
                    dialogueOptions: [
                        "How did you get trapped?",
                        "How can I free you?",
                        "Tell me about the castle",
                        "Teach me a spell"
                    ]
                },
                ghostly_butler: {
                    name: "JEEVES THE BUTLER",
                    location: "great_hall",
                    dialogue: 0,
                    dialogueOptions: [
                        "What is your role here?",
                        "Who lived in this castle?",
                        "Where can I find treasure?",
                        "Any advice for me?"
                    ]
                },
                fallen_priest: {
                    name: "PRIEST BENEDICT",
                    location: "chapel",
                    dialogue: 0,
                    dialogueOptions: [
                        "What happened to this chapel?",
                        "Can you bless my weapons?",
                        "Tell me about the crypt below",
                        "Pray for me"
                    ]
                },
                ghost_cook: {
                    name: "CHEF MARCELLE",
                    location: "kitchen",
                    dialogue: 0,
                    needsIngredients: true,
                    dialogueOptions: [
                        "What were you cooking?",
                        "Do you need help?",
                        "Any recipes I should know?",
                        "Where are the spices?"
                    ]
                },
                mad_gardener: {
                    name: "GARDENER THORN",
                    location: "courtyard",
                    dialogue: 0,
                    needsHelp: true,
                    dialogueOptions: [
                        "Why are you still gardening?",
                        "What's wrong with the plants?",
                        "Can I help with the garden?",
                        "Tell me about the hedge maze"
                    ]
                },
                ghost_blacksmith: {
                    name: "SMITH HAMMERFIST",
                    location: "forge",
                    dialogue: 0,
                    needsMithril: true,
                    dialogueOptions: [
                        "Can you repair my gear?",
                        "What happened to the forge?",
                        "Do you need any materials?",
                        "Forge me a weapon"
                    ]
                },
                royal_astronomer: {
                    name: "ASTRONOMER CELESTE",
                    location: "observatory",
                    dialogue: 0,
                    needsStarChart: true,
                    dialogueOptions: [
                        "What are you observing?",
                        "Tell me about the stars",
                        "Can you teach me astronomy?",
                        "Help me navigate"
                    ]
                },
                ghost_queen: {
                    name: "QUEEN ISABELLA",
                    location: "royal_chambers",
                    dialogue: 0,
                    needsHelp: true,
                    dialogueOptions: [
                        "Your Majesty, what happened?",
                        "Where is the king?",
                        "How can I help your family?",
                        "Tell me about the curse"
                    ]
                },
                ghost_prince: {
                    name: "PRince EDWARD",
                    location: "princes_room",
                    dialogue: 0,
                    lostToy: true,
                    dialogueOptions: [
                        "Where are your parents?",
                        "Are you scared here?",
                        "What games did you play?",
                        "Can I help you find something?"
                    ]
                },
                dryad: {
                    name: "NYMPH ELARA",
                    location: "gardens",
                    dialogue: 0,
                    needsProtection: true,
                    dialogueOptions: [
                        "Who are you?",
                        "What's happening to the garden?",
                        "How can I help the plants?",
                        "Tell me about magical herbs"
                    ]
                },
                forest_hermit: {
                    name: "HERMIT ORION",
                    location: "tunnel_exit",
                    dialogue: 0,
                    knowsSecrets: true,
                    dialogueOptions: [
                        "Who are you?",
                        "Why live out here?",
                        "What do you know of the castle?",
                        "Can you teach me survival?"
                    ]
                },
                ancient_prisoner: {
                    name: "MORDRED THE WISE",
                    location: "high_security",
                    dialogue: 0,
                    knowsAncientMagic: true,
                    dialogueOptions: [
                        "Why were you imprisoned?",
                        "What do you know of magic?",
                        "Can you teach me ancient spells?",
                        "How do I break the curse?"
                    ]
                },
                founder_ghost: {
                    name: "FOUNDER ARCTURUS",
                    location: "ancient_tomb",
                    dialogue: 0,
                    finalQuest: true,
                    dialogueOptions: [
                        "Who built this castle?",
                        "What caused the curse?",
                        "How can I lift the curse?",
                        "What is your final wish?"
                    ]
                }
            },
            discoveredItems: {
                fireOrb: false,
                waterOrb: false,
                earthOrb: false,
                airOrb: false,
                ancientScroll: false,
                foundersSword: false,
                royalCrown: false,
                elementalAmulet: false
            },
            killedEnemies: {},
            gameTime: 0,
            difficulty: 1
        };

        // ===============================
        // ENEMIES DEFINITIONS (25+ types)
        // ===============================
        const enemies = {
            // Basic undead
            skeleton_guard: {
                name: "SKELETON GUARD",
                health: 25,
                maxHealth: 25,
                attack: 8,
                defense: 4,
                gold: 10,
                experience: 20,
                type: "undead",
                weakness: "blunt",
                resistance: "piercing",
                special: null
            },
            skeleton_warrior: {
                name: "SKELETON WARRIOR",
                health: 35,
                maxHealth: 35,
                attack: 12,
                defense: 6,
                gold: 15,
                experience: 30,
                type: "undead",
                weakness: "blunt",
                resistance: "slashing",
                special: "bone_shield"
            },
            zombie_guard: {
                name: "ROTTING ZOMBIE",
                health: 40,
                maxHealth: 40,
                attack: 10,
                defense: 3,
                gold: 12,
                experience: 25,
                type: "undead",
                weakness: "fire",
                resistance: "poison",
                special: "disease"
            },
            ghost: {
                name: "WRAITH",
                health: 30,
                maxHealth: 30,
                attack: 15,
                defense: 2,
                gold: 20,
                experience: 35,
                type: "spirit",
                weakness: "holy",
                resistance: "physical",
                special: "phase"
            },
            crypt_wraith: {
                name: "CRYPT WRAITH",
                health: 50,
                maxHealth: 50,
                attack: 18,
                defense: 5,
                gold: 30,
                experience: 50,
                type: "spirit",
                weakness: "holy",
                resistance: "magic",
                special: "life_drain"
            },
            skeleton_lord: {
                name: "SKELETON LORD",
                health: 80,
                maxHealth: 80,
                attack: 20,
                defense: 10,
                gold: 50,
                experience: 80,
                type: "undead",
                weakness: "holy",
                resistance: "physical",
                special: "summon_skeletons"
            },
            
            // Constructs and golems
            animated_armor: {
                name: "ANIMATED ARMOR",
                health: 45,
                maxHealth: 45,
                attack: 14,
                defense: 12,
                gold: 25,
                experience: 40,
                type: "construct",
                weakness: "lightning",
                resistance: "slashing",
                special: "armor_plate"
            },
            treasure_golem: {
                name: "TREASURE GOLEM",
                health: 100,
                maxHealth: 100,
                attack: 18,
                defense: 15,
                gold: 100,
                experience: 120,
                type: "construct",
                weakness: "blunt",
                resistance: "magic",
                special: "gold_armor"
            },
            kitchen_golem: {
                name: "KITCHEN GOLEM",
                health: 60,
                maxHealth: 60,
                attack: 16,
                defense: 8,
                gold: 30,
                experience: 50,
                type: "construct",
                weakness: "water",
                resistance: "fire",
                special: "utensil_throw"
            },
            stone_colossus: {
                name: "STONE COLOSSUS",
                health: 150,
                maxHealth: 150,
                attack: 25,
                defense: 20,
                gold: 150,
                experience: 200,
                type: "construct",
                weakness: "blunt",
                resistance: "slashing",
                special: "earthquake"
            },
            training_golem: {
                name: "TRAINING GOLEM",
                health: 70,
                maxHealth: 70,
                attack: 15,
                defense: 10,
                gold: 35,
                experience: 60,
                type: "construct",
                weakness: "water",
                resistance: "physical",
                special: "training_attack"
            },
            
            // Elementals
            fire_elemental: {
                name: "FIRE ELEMENTAL",
                health: 55,
                maxHealth: 55,
                attack: 20,
                defense: 5,
                gold: 40,
                experience: 65,
                type: "elemental",
                weakness: "water",
                resistance: "fire",
                special: "fire_aura"
            },
            water_elemental: {
                name: "WATER ELEMENTAL",
                health: 65,
                maxHealth: 65,
                attack: 15,
                defense: 8,
                gold: 45,
                experience: 70,
                type: "elemental",
                weakness: "lightning",
                resistance: "water",
                special: "heal"
            },
            earth_elemental: {
                name: "EARTH ELEMENTAL",
                health: 90,
                maxHealth: 90,
                attack: 18,
                defense: 15,
                gold: 60,
                experience: 90,
                type: "elemental",
                weakness: "ice",
                resistance: "earth",
                special: "stone_skin"
            },
            air_elemental: {
                name: "AIR ELEMENTAL",
                health: 50,
                maxHealth: 50,
                attack: 22,
                defense: 3,
                gold: 50,
                experience: 75,
                type: "elemental",
                weakness: "earth",
                resistance: "air",
                special: "tornado"
            },
            
            // Magical creatures
            book_wyrm: {
                name: "BOOK WYRM",
                health: 40,
                maxHealth: 40,
                attack: 16,
                defense: 7,
                gold: 35,
                experience: 55,
                type: "magical",
                weakness: "fire",
                resistance: "magic",
                special: "ink_spray"
            },
            mimic: {
                name: "MIMIC",
                health: 70,
                maxHealth: 70,
                attack: 22,
                defense: 10,
                gold: 80,
                experience: 100,
                type: "magical",
                weakness: "none",
                resistance: "all",
                special: "surprise_attack"
            },
            nightmare_steed: {
                name: "NIGHTMARE STEED",
                health: 75,
                maxHealth: 75,
                attack: 20,
                defense: 12,
                gold: 70,
                experience: 95,
                type: "magical",
                weakness: "holy",
                resistance: "dark",
                special: "nightmare_charge"
            },
            star_spawn: {
                name: "STAR SPAWN",
                health: 60,
                maxHealth: 60,
                attack: 25,
                defense: 6,
                gold: 65,
                experience: 85,
                type: "magical",
                weakness: "earth",
                resistance: "cosmic",
                special: "cosmic_ray"
            },
            
            // Bosses
            shadow_dragon: {
                name: "SHADOW DRAGON",
                health: 300,
                maxHealth: 300,
                attack: 35,
                defense: 20,
                gold: 500,
                experience: 400,
                type: "dragon",
                weakness: "light",
                resistance: "dark",
                special: "shadow_breath"
            },
            minotaur: {
                name: "MINOTAUR",
                health: 200,
                maxHealth: 200,
                attack: 30,
                defense: 18,
                gold: 300,
                experience: 300,
                type: "mythical",
                weakness: "none",
                resistance: "physical",
                special: "charge"
            },
            tomb_lord: {
                name: "TOMB LORD",
                health: 250,
                maxHealth: 250,
                attack: 28,
                defense: 22,
                gold: 400,
                experience: 350,
                type: "undead",
                weakness: "holy",
                resistance: "dark",
                special: "necromancy"
            },
            
            // Special
            rat_swarm: {
                name: "RAT SWARM",
                health: 30,
                maxHealth: 30,
                attack: 5,
                defense: 1,
                gold: 5,
                experience: 15,
                type: "beast",
                weakness: "fire",
                resistance: "none",
                special: "swarm"
            },
            giant_spider: {
                name: "GIANT SPIDER",
                health: 45,
                maxHealth: 45,
                attack: 12,
                defense: 6,
                gold: 25,
                experience: 35,
                type: "beast",
                weakness: "fire",
                resistance: "poison",
                special: "web"
            },
            cave_troll: {
                name: "CAVE TROLL",
                health: 120,
                maxHealth: 120,
                attack: 25,
                defense: 14,
                gold: 100,
                experience: 130,
                type: "giant",
                weakness: "fire",
                resistance: "physical",
                special: "regeneration"
            },
            cursed_pharaoh: {
                name: "CURSED PHARAOH",
                health: 180,
                maxHealth: 180,
                attack: 32,
                defense: 16,
                gold: 350,
                experience: 320,
                type: "undead",
                weakness: "holy",
                resistance: "curse",
                special: "mummy_curse"
            }
        };

        // ===============================
        // ITEMS DATABASE (60+ items)
        // ===============================
        const itemDatabase = {
            // Weapons
            rusty_sword: { name: "RUSTY SWORD", type: "weapon", attack: 3, value: 10, description: "An old, corroded sword" },
            training_sword: { name: "TRAINING SWORD", type: "weapon", attack: 2, value: 5, description: "A wooden practice sword" },
            steel_sword: { name: "STEEL SWORD", type: "weapon", attack: 8, value: 50, description: "A well-made steel blade" },
            silver_dagger: { name: "SILVER DAGGER", type: "weapon", attack: 5, value: 75, description: "+3 vs undead, silver-plated" },
            officers_sword: { name: "OFFICER'S SWORD", type: "weapon", attack: 10, value: 120, description: "An elegant military sword" },
            founders_sword: { name: "FOUNDER'S SWORD", type: "weapon", attack: 15, value: 300, description: "The legendary sword of the castle founder" },
            enchanted_sword: { name: "ENCHANTED SWORD", type: "weapon", attack: 12, value: 200, description: "Glows with magical energy" },
            crossbow: { name: "CROSSBOW", type: "weapon", attack: 9, value: 80, description: "A heavy crossbow with bolts" },
            kitchen_knife: { name: "KITCHEN KNIFE", type: "weapon", attack: 4, value: 2, description: "Sharp kitchen utility knife" },
            makeshift_shiv: { name: "MAKESHIFT SHIV", type: "weapon", attack: 2, value: 1, description: "A crude prison weapon" },
            
            // Armor
            torn_cloak: { name: "TORN CLOAK", type: "armor", defense: 1, value: 5, description: "A tattered cloak" },
            iron_helmet: { name: "IRON HELMET", type: "armor", defense: 2, value: 20, description: "Basic protective helmet" },
            iron_shield: { name: "IRON SHIELD", type: "armor", defense: 3, value: 30, description: "A sturdy iron shield" },
            silken_robe: { name: "SILKEN ROBE", type: "armor", defense: 1, value: 100, description: "A royal silk robe" },
            horse_saddle: { name: "HORSE SADDLE", type: "armor", defense: 2, value: 40, description: "A comfortable riding saddle" },
            
            // Consumables
            health_potion: { name: "HEALTH POTION", type: "consumable", heal: 30, value: 20, description: "Restores 30 HP" },
            mana_potion: { name: "MANA POTION", type: "consumable", mana: 25, value: 25, description: "Restores 25 MP" },
            magical_apple: { name: "MAGICAL APPLE", type: "consumable", heal: 50, value: 40, description: "A glowing magical fruit" },
            preserved_meat: { name: "PRESERVED MEAT", type: "consumable", heal: 20, value: 10, description: "Magically preserved meat" },
            healing_herb: { name: "HEALING HERB", type: "consumable", heal: 15, value: 8, description: "A medicinal herb" },
            forest_berries: { name: "FOREST BERRIES", type: "consumable", heal: 10, value: 5, description: "Fresh wild berries" },
            
            // Keys
            iron_key: { name: "IRON KEY", type: "key", value: 10, description: "Opens iron doors" },
            jailor_key: { name: "JAILOR KEY", type: "key", value: 15, description: "Jailor's master key" },
            prison_key: { name: "PRISON KEY", type: "key", value: 10, description: "Opens prison cells" },
            treasury_key: { name: "TREASURY KEY", type: "key", value: 50, description: "Opens the royal treasury" },
            chamber_key: { name: "CHAMBER KEY", type: "key", value: 40, description: "Opens royal chambers" },
            dungeon_key: { name: "DUNGEON KEY", type: "key", value: 20, description: "Opens dungeon entrance" },
            high_security_key: { name: "HIGH SECURITY KEY", type: "key", value: 30, description: "Opens high security cell" },
            crypt_key: { name: "CRYPT KEY", type: "key", value: 25, description: "Opens crypt depths" },
            burial_key: { name: "BURIAL KEY", type: "key", value: 35, description: "Opens burial chamber" },
            tomb_key: { name: "TOMB KEY", type: "key", value: 100, description: "Opens ancient tomb" },
            fire_key: { name: "FIRE KEY", type: "key", value: 60, description: "Opens fire elemental chamber" },
            water_key: { name: "WATER KEY", type: "key", value: 60, description: "Opens water elemental chamber" },
            earth_key: { name: "EARTH KEY", type: "key", value: 60, description: "Opens earth elemental chamber" },
            air_key: { name: "AIR KEY", type: "key", value: 60, description: "Opens air elemental chamber" },
            royal_key: { name: "ROYAL KEY", type: "key", value: 150, description: "Opens throne room" },
            garden_key: { name: "GARDEN KEY", type: "key", value: 20, description: "Opens greenhouse" },
            servant_key: { name: "SERVANT KEY", type: "key", value: 5, description: "Opens servants' areas" },
            guardian_key: { name: "GUARDIAN KEY", type: "key", value: 80, description: "Given by the ghostly knight" },
            maze_center_key: { name: "MAZE CENTER KEY", type: "key", value: 40, description: "Found in maze center" },
            
            // Quest Items
            old_letter: { name: "OLD LETTER", type: "quest", value: 1, description: "A faded letter from the king" },
            spell_scroll: { name: "SPELL SCROLL", type: "quest", value: 100, description: "Teaches a random spell" },
            ancient_scroll: { name: "ANCIENT SCROLL", type: "quest", value: 200, description: "Teaches the FIREBALL spell" },
            soldiers_diary: { name: "SOLDIER'S DIARY", type: "quest", value: 5, description: "A soldier's personal journal" },
            prisoner_diary: { name: "PRISONER'S DIARY", type: "quest", value: 5, description: "A prisoner's writings" },
            confession_letter: { name: "CONFESSION LETTER", type: "quest", value: 10, description: "A forced confession" },
            hidden_diary: { name: "HIDDEN DIARY", type: "quest", value: 8, description: "A servant's secret diary" },
            battle_plans: { name: "BATTLE PLANS", type: "quest", value: 25, description: "Military strategy documents" },
            escape_plan: { name: "ESCAPE PLAN", type: "quest", value: 15, description: "Detailed escape route" },
            prisoners_notes: { name: "PRISONER'S NOTES", type: "quest", value: 20, description: "Ancient magical notes" },
            star_chart: { name: "STAR CHART", type: "quest", value: 75, description: "Detailed astronomical chart" },
            astrology_chart: { name: "ASTROLOGY CHART", type: "quest", value: 60, description: "Magical star alignments" },
            kingdom_map: { name: "KINGDOM MAP", type: "quest", value: 50, description: "Map of the entire kingdom" },
            tactical_map: { name: "TACTICAL MAP", type: "quest", value: 30, description: "Military tactical map" },
            tunnel_map: { name: "TUNNEL MAP", type: "quest", value: 25, description: "Map of secret tunnels" },
            maze_map_fragment: { name: "MAZE MAP FRAGMENT", type: "quest", value: 10, description: "Part of a maze map" },
            stone_tablet: { name: "STONE TABLET", type: "quest", value: 80, description: "Ancient inscribed tablet" },
            
            // Treasure
            silver_goblet: { name: "SILVER GOBLET", type: "treasure", value: 40, description: "A silver drinking vessel" },
            candleholder: { name: "CANDLEHOLDER", type: "treasure", value: 25, description: "Ornate brass candleholder" },
            crown: { name: "ROYAL CROWN", type: "treasure", value: 500, description: "The king's crown" },
            royal_scepter: { name: "ROYAL SCEPTER", type: "treasure", value: 400, description: "Symbol of royal authority" },
            queens_crown: { name: "QUEEN'S CROWN", type: "treasure", value: 300, description: "The queen's jeweled crown" },
            founders_crown: { name: "FOUNDER'S CROWN", type: "treasure", value: 600, description: "The founder's ancient crown" },
            gold_coins: { name: "GOLD COINS", type: "treasure", value: 100, description: "A pouch of gold coins" },
            ruby: { name: "RUBY", type: "treasure", value: 200, description: "A perfect red ruby" },
            emerald: { name: "EMERALD", type: "treasure", value: 200, description: "A flawless green emerald" },
            diamond: { name: "DIAMOND", type: "treasure", value: 300, description: "A brilliant diamond" },
            royal_jewelry: { name: "ROYAL JEWELRY", type: "treasure", value: 250, description: "A set of royal jewelry" },
            perfume_bottle: { name: "PERFUME BOTTLE", type: "treasure", value: 80, description: "Crystal perfume bottle" },
            burial_treasure: { name: "BURIAL TREASURE", type: "treasure", value: 350, description: "Ancient burial goods" },
            funerary_mask: { name: "FUNERARY MASK", type: "treasure", value: 280, description: "Gold funeral mask" },
            hidden_cache: { name: "HIDDEN CACHE", type: "treasure", value: 150, description: "A hidden stash of valuables" },
            
            // Magical Items
            torch: { name: "TORCH", type: "tool", value: 5, description: "Lights dark areas" },
            spectral_lens: { name: "SPECTRAL LENS", type: "tool", value: 120, description: "Allows seeing invisible things" },
            holy_symbol: { name: "HOLY SYMBOL", type: "magic", value: 80, description: "Protects against undead" },
            prayer_book: { name: "PRAYER BOOK", type: "magic", value: 60, description: "Holy prayers and blessings" },
            ancient_tome: { name: "ANCIENT TOME", type: "magic", value: 180, description: "Book of ancient knowledge" },
            council_seal: { name: "COUNCIL SEAL", type: "magic", value: 90, description: "Magical council authority seal" },
            general_badge: { name: "GENERAL'S BADGE", type: "magic", value: 70, description: "Military command badge" },
            magnifying_glass: { name: "MAGNIFYING GLASS", type: "tool", value: 30, description: "Examines small details" },
            star_compass: { name: "STAR COMPASS", type: "magic", value: 140, description: "Navigates by the stars" },
            cloud_jewel: { name: "CLOUD JEWEL", type: "magic", value: 160, description: "A jewel that floats like a cloud" },
            enchanted_hammer: { name: "ENCHANTED HAMMER", type: "magic", value: 110, description: "A blacksmith's magical hammer" },
            royal_doll: { name: "ROYAL DOLL", type: "magic", value: 45, description: "A prince's enchanted doll" },
            wooden_sword: { name: "WOODEN SWORD", type: "magic", value: 20, description: "A child's magical practice sword" },
            skull_lantern: { name: "SKULL LANTERN", type: "magic", value: 95, description: "A lantern made from a skull" },
            bone_charm: { name: "BONE CHARM", type: "magic", value: 65, description: "A magical bone talisman" },
            funerary_urn: { name: "FUNERARY URN", type: "magic", value: 55, description: "An urn containing ashes" },
            grave_dirt: { name: "GRAVE DIRT", type: "magic", value: 10, description: "Dirt from a grave" },
            ancient_bone: { name: "ANCIENT BONE", type: "magic", value: 35, description: "A bone of great age" },
            royal_sigil: { name: "ROYAL SIGIL", type: "magic", value: 130, description: "The royal family's magical sigil" },
            venus_flytrap_seed: { name: "VENUS FLYTRAP SEED", type: "magic", value: 85, description: "A magical carnivorous plant seed" },
            golden_seed: { name: "GOLDEN SEED", type: "magic", value: 200, description: "A seed that grows golden plants" },
            maze_champion_trophy: { name: "MAZE CHAMPION TROPHY", type: "magic", value: 300, description: "Award for defeating the minotaur" },
            elemental_amulet: { name: "ELEMENTAL AMULET", type: "magic", value: 500, description: "Combines all elemental powers" },
            maid_blessing: { name: "MAID'S BLESSING", type: "magic", value: 75, description: "A ghost maid's blessing" },
            prisoners_gratitude: { name: "PRISONER'S GRATITUDE", type: "magic", value: 60, description: "A freed prisoner's thanks" },
            royal_favor: { name: "ROYAL FAVOR", type: "magic", value: 400, description: "The royal family's favor" },
            founders_legacy: { name: "FOUNDER'S LEGACY", type: "magic", value: 600, description: "The founder's final gift" },
            
            // Materials
            mithril_ingot: { name: "MITHRIL INGOT", type: "material", value: 150, description: "Rare magical metal" },
            iron_ore: { name: "IRON ORE", type: "material", value: 15, description: "Raw iron ore" },
            gold_ore: { name: "GOLD ORE", type: "material", value: 50, description: "Raw gold ore" },
            magic_crystal: { name: "MAGIC CRYSTAL", type: "material", value: 100, description: "A crystal filled with magic" },
            spice_sack: { name: "SPICE SACK", type: "material", value: 30, description: "A sack of rare spices" },
            linen_cloth: { name: "LINEN CLOTH", type: "material", value: 5, description: "Quality linen fabric" },
            riding_crop: { name: "RIDING CROP", type: "material", value: 20, description: "A horse riding crop" },
            garden_shears: { name: "GARDEN SHEARS", type: "material", value: 15, description: "Gardening shears" },
            fountain_coin: { name: "FOUNTAIN COIN", type: "material", value: 5, description: "A coin from the fountain" },
            magical_herb: { name: "MAGICAL HERB", type: "material", value: 25, description: "A herb with magical properties" },
            shackles: { name: "SHACKLES", type: "material", value: 10, description: "Iron prisoner shackles" },
            torture_device: { name: "TORTURE DEVICE", type: "material", value: 40, description: "A cruel torture tool" },
            tunnel_pick: { name: "TUNNEL PICK", type: "material", value: 25, description: "A pick for tunnel digging" },
            guard_torch: { name: "GUARD TORCH", type: "material", value: 8, description: "A guard's torch" },
            catacomb_key: { name: "CATACOMB KEY", type: "material", value: 20, description: "Opens catacomb doors" },
            spare_key: { name: "SPARE KEY", type: "material", value: 5, description: "A spare key" },
            lava_shard: { name: "LAVA SHARD", type: "material", value: 80, description: "A shard of cooled lava" },
            pearl: { name: "PEARL", type: "material", value: 120, description: "A perfect pearl" },
            crystal_geode: { name: "CRYSTAL GEODE", type: "material", value: 90, description: "A geode filled with crystals" },
            cloud_crystal: { name: "CLOUD CRYSTAL", type: "material", value: 110, description: "A crystal light as air" },
            
            // Elemental Orbs
            fire_orb: { name: "FIRE ORB", type: "orb", value: 250, description: "Glows with inner fire" },
            water_orb: { name: "WATER ORB", type: "orb", value: 250, description: "Cold to the touch" },
            earth_orb: { name: "EARTH ORB", type: "orb", value: 250, description: "Feels like solid stone" },
            air_orb: { name: "AIR ORB", type: "orb", value: 250, description: "Almost weightless" },
            elemental_orb_fire: { name: "ELEMENTAL ORB (FIRE)", type: "orb", value: 300, description: "Master fire elemental orb" }
        };

        // ===============================
        // DOM ELEMENTS
        // ===============================
        const gameScreen = document.getElementById('game-screen');
        const commandInput = document.getElementById('command-input');
        const submitBtn = document.getElementById('submit-btn');
        const fightBtn = document.getElementById('fight-btn');
        const spellBtn = document.getElementById('spell-btn');
        const itemBtn = document.getElementById('item-btn');
        const fleeBtn = document.getElementById('flee-btn');
        const restBtn = document.getElementById('rest-btn');
        const exploreBtn = document.getElementById('explore-btn');
        const miniMap = document.getElementById('mini-map');
        
        // Player stat elements
        const playerNameEl = document.getElementById('player-name');
        const playerClassEl = document.getElementById('player-class');
        const playerLevelEl = document.getElementById('player-level');
        const healthText = document.getElementById('health-text');
        const manaText = document.getElementById('mana-text');
        const healthBar = document.getElementById('health-bar');
        const manaBar = document.getElementById('mana-bar');
        const playerAttackEl = document.getElementById('player-attack');
        const playerDefenseEl = document.getElementById('player-defense');
        const playerGoldEl = document.getElementById('player-gold');
        const inventoryItemsEl = document.getElementById('inventory-items');
        const questListEl = document.getElementById('quest-list');

        // ===============================
        // INITIALIZE GAME
        // ===============================
        function initGame() {
            updatePlayerStats();
            updateInventoryDisplay();
            updateQuestDisplay();
            updateMiniMap();
            
            // Add initial game text
            addGameText("\nType HELP for commands or use the action buttons.");
            addGameText("\nClick on items in inventory to use them.");
            addGameText("\nThe castle has over 50 rooms to explore!");
            addGameText("\n> ");
            
            // Focus on input
            commandInput.focus();
            
            // Set up event listeners
            submitBtn.addEventListener('click', processCommand);
            commandInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    processCommand();
                }
            });
            
            // Action button listeners
            fightBtn.addEventListener('click', () => {
                if (gameState.currentEnemy) {
                    addGameText("\n> FIGHT");
                    playerAttack();
                } else {
                    addGameText("\nThere is no enemy to fight!");
                    addGameText("> ");
                }
            });
            
            spellBtn.addEventListener('click', () => {
                if (gameState.currentEnemy) {
                    addGameText("\n> CAST FIREBALL");
                    castSpell("FIREBALL");
                } else {
                    addGameText("\nYou cast a light spell, illuminating the room.");
                    addGameText("> ");
                }
            });
            
            itemBtn.addEventListener('click', () => {
                showInventory();
            });
            
            fleeBtn.addEventListener('click', () => {
                if (gameState.currentEnemy) {
                    addGameText("\n> FLEE");
                    fleeCombat();
                } else {
                    addGameText("\nYou are not in combat. Use GO to move.");
                    addGameText("> ");
                }
            });
            
            restBtn.addEventListener('click', () => {
                addGameText("\n> REST");
                rest();
            });
            
            exploreBtn.addEventListener('click', () => {
                addGameText("\n> EXPLORE");
                explore();
            });
        }

        // ===============================
        // DISPLAY FUNCTIONS
        // ===============================
        function updatePlayerStats() {
            const p = gameState.player;
            
            playerNameEl.textContent = p.name;
            playerClassEl.textContent = p.class;
            playerLevelEl.textContent = p.level;
            
            const healthPercent = (p.health / p.maxHealth) * 100;
            const manaPercent = (p.mana / p.maxMana) * 100;
            
            healthText.textContent = `${p.health}/${p.maxHealth}`;
            manaText.textContent = `${p.mana}/${p.maxMana}`;
            
            healthBar.style.width = `${healthPercent}%`;
            manaBar.style.width = `${manaPercent}%`;
            
            // Calculate total attack/defense including equipment
            let totalAttack = p.attack;
            let totalDefense = p.defense;
            
            if (p.equippedWeapon) {
                const weapon = gameState.inventory.find(item => item.name === p.equippedWeapon);
                if (weapon) {
                    if (weapon.name === "SILVER DAGGER") totalAttack += 3;
                    if (weapon.name === "FOUNDER'S SWORD") totalAttack += 15;
                    if (weapon.name === "ENCHANTED SWORD") totalAttack += 12;
                    if (weapon.name === "STEEL SWORD") totalAttack += 8;
                }
            }
            
            playerAttackEl.textContent = totalAttack;
            playerDefenseEl.textContent = totalDefense;
            playerGoldEl.textContent = p.gold;
        }

        function updateInventoryDisplay() {
            inventoryItemsEl.innerHTML = '';
            
            gameState.inventory.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = `item`;
                itemEl.textContent = `${item.name}${item.count > 1 ? ` (${item.count})` : ''}`;
                itemEl.title = item.description;
                itemEl.addEventListener('click', () => {
                    useInventoryItem(item.name, index);
                });
                inventoryItemsEl.appendChild(itemEl);
            });
            
            // Fill empty slots
            const emptySlots = 12 - gameState.inventory.length;
            for (let i = 0; i < emptySlots; i++) {
                const emptyEl = document.createElement('div');
                emptyEl.className = 'item';
                emptyEl.textContent = "---";
                inventoryItemsEl.appendChild(emptyEl);
            }
        }

        function updateQuestDisplay() {
            questListEl.innerHTML = '';
            
            Object.values(gameState.quests).forEach(quest => {
                if (quest.active && !quest.completed) {
                    const questEl = document.createElement('div');
                    questEl.className = 'quest-item';
                    
                    if (quest.progress) {
                        const completed = Object.values(quest.progress).filter(v => v).length;
                        questEl.textContent = `${quest.description} (${completed}/4)`;
                    } else {
                        questEl.textContent = quest.description;
                    }
                    
                    questListEl.appendChild(questEl);
                }
            });
        }

        function updateMiniMap() {
            const mapWidth = 11;
            const mapHeight = 11;
            const centerX = 5;
            const centerY = 5;
            
            let mapGrid = [];
            
            // Initialize grid
            for (let y = 0; y < mapHeight; y++) {
                mapGrid[y] = [];
                for (let x = 0; x < mapWidth; x++) {
                    mapGrid[y][x] = ' ';
                }
            }
            
            // Room positions (simplified representation)
            const roomPositions = {
                'entrance_hall': [5, 5],
                'great_hall': [5, 4],
                'throne_room': [5, 3],
                'guard_room': [6, 5],
                'armory': [6, 4],
                'chapel': [4, 5],
                'library': [4, 4],
                'kitchen': [6, 3],
                'courtyard': [5, 6],
                'barracks': [7, 5],
                'forge': [7, 4],
                'treasury': [5, 2],
                'study': [3, 4],
                'pantry': [7, 3],
                'stables': [6, 6],
                'royal_chambers': [6, 2],
                'council_room': [4, 3],
                'observatory': [3, 5],
                'servants_quarters': [7, 2],
                'gardens': [4, 6],
                'officers_quarters': [8, 5],
                'training_yard': [8, 4],
                'ore_storage': [8, 3],
                'observatory_tower': [2, 4],
                'queens_chambers': [7, 1],
                'princes_room': [6, 1],
                'war_room': [4, 2],
                'servants_loft': [8, 2],
                'maze_entrance': [3, 6],
                'greenhouse': [4, 7],
                'crypt': [4, 4],
                'gatehouse': [5, 7],
                'catacombs': [3, 4],
                'guard_tunnel': [6, 7],
                'dungeon_entrance': [7, 7],
                'dungeon_hall': [7, 6],
                'torture_chamber': [7, 5],
                'prison_cells': [8, 6],
                'high_security': [8, 7],
                'escape_tunnel': [5, 8],
                'tunnel_exit': [4, 8],
                'crypt_depths': [4, 3],
                'ossuary': [3, 3],
                'burial_chamber': [2, 4],
                'maze_center': [3, 5],
                'maze_north': [3, 4],
                'maze_east': [4, 5],
                'maze_west': [2, 5],
                'ancient_tomb': [4, 2],
                'elemental_chamber_fire': [9, 3],
                'elemental_chamber_water': [9, 4],
                'elemental_chamber_earth': [9, 5],
                'elemental_chamber_air': [9, 6]
            };
            
            // Place rooms on map
            Object.keys(roomPositions).forEach(roomId => {
                const [x, y] = roomPositions[roomId];
                if (x >= 0 && x < mapWidth && y >= 0 && y < mapHeight) {
                    if (roomId === gameState.currentRoom) {
                        mapGrid[y][x] = '@'; // Current room
                    } else if (gameState.roomsVisited.includes(roomId)) {
                        mapGrid[y][x] = '.'; // Visited room
                    } else if (gameState.rooms[roomId]) {
                        mapGrid[y][x] = '?'; // Discovered but not visited
                    }
                }
            });
            
            // Build map string
            let mapString = '';
            for (let y = 0; y < mapHeight; y++) {
                for (let x = 0; x < mapWidth; x++) {
                    const cell = mapGrid[y][x];
                    if (cell === '@') {
                        mapString += `<span class="current-room">${cell}</span>`;
                    } else if (cell === '.') {
                        mapString += `<span class="visited-room">${cell}</span>`;
                    } else if (cell === '?') {
                        mapString += `<span class="unvisited-room">${cell}</span>`;
                    } else {
                        mapString += `<span class="unvisited-room">${cell}</span>`;
                    }
                }
                mapString += '\n';
            }
            
            miniMap.innerHTML = mapString;
        }

        function addGameText(text, type = "normal") {
            let styledText = text;
            
            if (type === "combat") {
                styledText = `<span class="combat-log">${text}</span>`;
            } else if (type === "item") {
                styledText = `<span class="item-log">${text}</span>`;
            } else if (type === "quest") {
                styledText = `<span class="quest-log-text">${text}</span>`;
            } else if (type === "npc") {
                styledText = `<span class="npc-log">${text}</span>`;
            }
            
            gameScreen.innerHTML += styledText;
            gameScreen.scrollTop = gameScreen.scrollHeight;
            gameState.gameLog.push(text);
        }

        // ===============================
        // COMMAND PROCESSING
        // ===============================
        function processCommand() {
            if (!gameState.gameActive) return;
            
            const command = commandInput.value.trim().toUpperCase();
            commandInput.value = '';
            
            if (!command) return;
            
            addGameText(command);
            
            // Process command
            const cmdParts = command.split(' ');
            const mainCmd = cmdParts[0];
            const args = cmdParts.slice(1).join(' ');
            
            switch(mainCmd) {
                case "HELP":
                    showHelp();
                    break;
                case "LOOK":
                case "L":
                    lookAround();
                    break;
                case "STATS":
                    showStats();
                    break;
                case "INVENTORY":
                case "I":
                    showInventory();
                    break;
                case "GO":
                    move(args);
                    break;
                case "USE":
                    useItem(args);
                    break;
                case "EQUIP":
                    equipItem(args);
                    break;
                case "TALK":
                    if (args.startsWith("TO ")) {
                        talkToNPC(args.substring(3));
                    } else {
                        addGameText("\nUse: TALK TO [NPC NAME]");
                        addGameText("\n> ");
                    }
                    break;
                case "EXAMINE":
                case "EXAM":
                    examineItem(args);
                    break;
                case "READ":
                    readItem(args);
                    break;
                case "SOLVE":
                    solvePuzzle(args);
                    break;
                case "ATTACK":
                case "FIGHT":
                    if (gameState.currentEnemy) {
                        playerAttack();
                    } else {
                        addGameText("\nThere is no enemy to fight!");
                        addGameText("\n> ");
                    }
                    break;
                case "CAST":
                    castSpell(args);
                    break;
                case "FLEE":
                case "RUN":
                    if (gameState.currentEnemy) {
                        fleeCombat();
                    } else {
                        addGameText("\nYou are not in combat.");
                        addGameText("\n> ");
                    }
                    break;
                case "REST":
                    rest();
                    break;
                case "EXPLORE":
                    explore();
                    break;
                case "QUESTS":
                    showQuests();
                    break;
                case "MAP":
                    showMap();
                    break;
                case "SEARCH":
                    searchRoom();
                    break;
                case "TAKE":
                    takeItem(args);
                    break;
                case "DROP":
                    dropItem(args);
                    break;
                case "SELL":
                    sellItem(args);
                    break;
                case "BUY":
                    buyItem(args);
                    break;
                default:
                    addGameText(`\nI don't understand "${command}". Type HELP for commands.`);
                    addGameText("\n> ");
            }
        }

        // ===============================
        // CORE GAME FUNCTIONS
        // ===============================
        function showHelp() {
            addGameText("\n\n=== COMPLETE COMMAND LIST ===\n");
            addGameText("LOOK/L - Examine surroundings\n");
            addGameText("GO [direction] - Move (NORTH, SOUTH, EAST, WEST, UP, DOWN)\n");
            addGameText("TALK TO [npc] - Talk to an NPC\n");
            addGameText("USE [item] - Use an item\n");
            addGameText("EQUIP [item] - Equip weapon/armor\n");
            addGameText("EXAMINE [item] - Examine item details\n");
            addGameText("READ [item] - Read readable items\n");
            addGameText("SOLVE [puzzle] - Attempt to solve puzzle\n");
            addGameText("ATTACK/FIGHT - Attack enemy\n");
            addGameText("CAST [spell] - Cast spell\n");
            addGameText("INVENTORY/I - Check inventory\n");
            addGameText("STATS - Check status\n");
            addGameText("QUESTS - Check active quests\n");
            addGameText("REST - Rest to recover HP/MP\n");
            addGameText("FLEE - Run from combat\n");
            addGameText("EXPLORE - Search the area\n");
            addGameText("MAP - Show castle map\n");
            addGameText("SEARCH - Search the room thoroughly\n");
            addGameText("TAKE [item] - Take item from room\n");
            addGameText("DROP [item] - Drop item from inventory\n");
            addGameText("SELL [item] - Sell item to NPC (if available)\n");
            addGameText("BUY [item] - Buy item from NPC (if available)\n");
            addGameText("\nClick on items in inventory to use them!\n");
            addGameText("\n> ");
        }

        function lookAround() {
            const room = gameState.rooms[gameState.currentRoom];
            
            addGameText("\n\n" + room.name.toUpperCase());
            addGameText("\n" + room.description);
            
            // Show exits
            addGameText("\n\nExits:");
            Object.keys(room.exits).forEach(dir => {
                const targetRoom = room.exits[dir];
                if (targetRoom && gameState.rooms[targetRoom]) {
                    addGameText(` ${dir.toUpperCase()} to ${gameState.rooms[targetRoom].name}`);
                }
            });
            
            // Show NPCs
            if (room.npcs && room.npcs.length > 0) {
                addGameText("\n\nNPCs here:");
                room.npcs.forEach(npcId => {
                    const npc = gameState.npcs[npcId];
                    if (npc) {
                        addGameText(` ${npc.name}`);
                    }
                });
            }
            
            // Show items
            if (room.items && room.items.length > 0) {
                addGameText("\n\nItems here:");
                room.items.forEach(itemId => {
                    const item = itemDatabase[itemId];
                    if (item) {
                        addGameText(` ${item.name}`);
                    }
                });
            }
            
            // Show enemies
            if (gameState.currentEnemy) {
                addGameText(`\n\nA ${gameState.currentEnemy.name} is here!`);
            } else if (room.enemies && room.enemies.length > 0) {
                addGameText("\n\nThis area seems dangerous...");
            }
            
            // Room-specific features
            if (room.locked) {
                addGameText("\n\nThe door is locked.");
            }
            
            if (room.dark && !hasLightSource()) {
                addGameText("\n\nIt's very dark in here.");
            }
            
            addGameText("\n> ");
        }

        function move(direction) {
            if (!direction) {
                addGameText("\nGo where? (NORTH, SOUTH, EAST, WEST, UP, DOWN)");
                addGameText("\n> ");
                return;
            }
            
            if (gameState.currentEnemy) {
                addGameText("\nYou cannot move while in combat!");
                addGameText("\n> ");
                return;
            }
            
            const dir = direction.toLowerCase();
            const room = gameState.rooms[gameState.currentRoom];
            
            if (!room.exits[dir]) {
                addGameText(`\nYou cannot go ${direction} from here.`);
                addGameText("\n> ");
                return;
            }
            
            const targetRoomId = room.exits[dir];
            
            if (!gameState.rooms[targetRoomId]) {
                addGameText(`\nThe way ${direction} is blocked.`);
                addGameText("\n> ");
                return;
            }
            
            const targetRoom = gameState.rooms[targetRoomId];
            
            // Check if room is locked
            if (targetRoom.locked) {
                const requiredKey = targetRoom.key;
                const hasKey = gameState.inventory.some(item => 
                    item.name.toLowerCase().includes(requiredKey) || 
                    item.name === requiredKey.toUpperCase()
                );
                
                if (!hasKey) {
                    addGameText(`\nThe ${targetRoom.name} is locked. You need a key.`);
                    addGameText("\n> ");
                    return;
                }
            }
            
            // Move to room
            gameState.currentRoom = targetRoomId;
            
            if (!gameState.roomsVisited.includes(targetRoomId)) {
                gameState.roomsVisited.push(targetRoomId);
            }
            
            addGameText(`\nYou go ${direction}...`);
            addGameText(`\n\nYou are now in the ${targetRoom.name}.`);
            
            // Check for darkness
            if (targetRoom.dark && !hasLightSource()) {
                addGameText("\nIt's pitch black. You can't see anything.");
                addGameText("\n(Use a TORCH or cast LIGHT)");
            } else {
                // Describe room if visible
                addGameText(`\n${targetRoom.description}`);
                
                // Check for NPCs
                if (targetRoom.npcs && targetRoom.npcs.length > 0) {
                    addGameText("\n\nYou see:");
                    targetRoom.npcs.forEach(npcId => {
                        const npc = gameState.npcs[npcId];
                        if (npc) {
                            addGameText(` ${npc.name}`);
                        }
                    });
                }
            }
            
            // Chance for enemy encounter
            if (targetRoom.enemies && targetRoom.enemies.length > 0) {
                const encounterChance = 0.4;
                if (Math.random() < encounterChance) {
                    const enemyType = targetRoom.enemies[Math.floor(Math.random() * targetRoom.enemies.length)];
                    encounterEnemy(enemyType);
                    return;
                }
            }
            
            // Update map
            updateMiniMap();
            
            addGameText("\n> ");
        }

        function encounterEnemy(enemyType = null) {
            const room = gameState.rooms[gameState.currentRoom];
            
            if (!enemyType && room.enemies && room.enemies.length > 0) {
                enemyType = room.enemies[Math.floor(Math.random() * room.enemies.length)];
            }
            
            if (!enemyType) {
                // Random enemy from all enemies
                const enemyTypes = Object.keys(enemies);
                enemyType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
            }
            
            if (!enemies[enemyType]) {
                enemyType = "skeleton_guard"; // Fallback
            }
            
            gameState.currentEnemy = JSON.parse(JSON.stringify(enemies[enemyType]));
            
            // Scale enemy based on player level
            const levelScale = Math.max(1, gameState.player.level * 0.5);
            gameState.currentEnemy.health = Math.floor(gameState.currentEnemy.health * levelScale);
            gameState.currentEnemy.maxHealth = gameState.currentEnemy.health;
            gameState.currentEnemy.attack = Math.floor(gameState.currentEnemy.attack * levelScale);
            gameState.currentEnemy.defense = Math.floor(gameState.currentEnemy.defense * levelScale);
            gameState.currentEnemy.gold = Math.floor(gameState.currentEnemy.gold * levelScale);
            gameState.currentEnemy.experience = Math.floor(gameState.currentEnemy.experience * levelScale);
            
            addGameText(`\n\nA ${gameState.currentEnemy.name} appears!`, "combat");
            addGameText(`\nHP: ${gameState.currentEnemy.health}/${gameState.currentEnemy.maxHealth}`);
            addGameText(`\nType: ${gameState.currentEnemy.type.toUpperCase()}`);
            if (gameState.currentEnemy.weakness && gameState.currentEnemy.weakness !== "none") {
                addGameText(`\nWeakness: ${gameState.currentEnemy.weakness.toUpperCase()}`);
            }
            if (gameState.currentEnemy.resistance && gameState.currentEnemy.resistance !== "none") {
                addGameText(`\nResistance: ${gameState.currentEnemy.resistance.toUpperCase()}`);
            }
            addGameText("\n\n> ");
            
            // Enable action buttons
            toggleActionButtons(true);
        }

        function searchRoom() {
            const room = gameState.rooms[gameState.currentRoom];
            
            if (gameState.currentEnemy) {
                addGameText("\nYou cannot search while in combat!");
                addGameText("\n> ");
                return;
            }
            
            addGameText("\nYou search the area carefully...");
            
            // Chance to find hidden items
            const searchRoll = Math.random();
            
            if (searchRoll < 0.3 && room.items && room.items.length > 0) {
                const itemId = room.items[Math.floor(Math.random() * room.items.length)];
                const item = itemDatabase[itemId];
                
                if (item) {
                    addGameText(`\nYou find a ${item.name}!`, "item");
                    
                    // Add to inventory
                    const existingItem = gameState.inventory.find(i => i.name === item.name);
                    if (existingItem) {
                        existingItem.count++;
                    } else {
                        gameState.inventory.push({
                            name: item.name,
                            count: 1,
                            type: item.type,
                            description: item.description,
                            use: getItemUse(item.type),
                            value: item.value
                        });
                    }
                    
                    // Remove from room
                    const itemIndex = room.items.indexOf(itemId);
                    if (itemIndex > -1) {
                        room.items.splice(itemIndex, 1);
                    }
                    
                    updateInventoryDisplay();
                }
            } else if (searchRoll < 0.5) {
                const goldFound = Math.floor(Math.random() * 50) + 10;
                gameState.player.gold += goldFound;
                addGameText(`\nYou find ${goldFound} gold pieces!`, "item");
                updatePlayerStats();
            } else if (searchRoll < 0.7) {
                addGameText("\nYou find nothing of value.");
            } else {
                addGameText("\nYour searching attracts attention!");
                encounterEnemy();
                return;
            }
            
            addGameText("\n> ");
        }

        function takeItem(itemName) {
            const room = gameState.rooms[gameState.currentRoom];
            
            if (!room.items || room.items.length === 0) {
                addGameText("\nThere are no items here to take.");
                addGameText("\n> ");
                return;
            }
            
            // Find item in room
            let itemId = null;
            let foundItem = null;
            
            for (const id of room.items) {
                const item = itemDatabase[id];
                if (item && item.name.toLowerCase().includes(itemName.toLowerCase())) {
                    itemId = id;
                    foundItem = item;
                    break;
                }
            }
            
            if (!foundItem) {
                addGameText(`\nThere is no "${itemName}" here.`);
                addGameText("\n> ");
                return;
            }
            
            // Add to inventory
            const existingItem = gameState.inventory.find(i => i.name === foundItem.name);
            if (existingItem) {
                existingItem.count++;
            } else {
                gameState.inventory.push({
                    name: foundItem.name,
                    count: 1,
                    type: foundItem.type,
                    description: foundItem.description,
                    use: getItemUse(foundItem.type),
                    value: foundItem.value
                });
            }
            
            // Remove from room
            const itemIndex = room.items.indexOf(itemId);
            if (itemIndex > -1) {
                room.items.splice(itemIndex, 1);
            }
            
            addGameText(`\nYou take the ${foundItem.name}.`, "item");
            updateInventoryDisplay();
            addGameText("\n> ");
        }

        function dropItem(itemName) {
            const itemIndex = gameState.inventory.findIndex(i => 
                i.name.toLowerCase().includes(itemName.toLowerCase())
            );
            
            if (itemIndex === -1) {
                addGameText(`\nYou don't have a "${itemName}".`);
                addGameText("\n> ");
                return;
            }
            
            const item = gameState.inventory[itemIndex];
            
            // Add to room items
            const room = gameState.rooms[gameState.currentRoom];
            if (!room.items) room.items = [];
            
            // Find item ID from database
            let itemId = null;
            for (const [id, dbItem] of Object.entries(itemDatabase)) {
                if (dbItem.name === item.name) {
                    itemId = id;
                    break;
                }
            }
            
            if (itemId) {
                room.items.push(itemId);
            }
            
            // Remove from inventory
            item.count--;
            if (item.count <= 0) {
                gameState.inventory.splice(itemIndex, 1);
            }
            
            addGameText(`\nYou drop the ${item.name}.`);
            updateInventoryDisplay();
            addGameText("\n> ");
        }

        function useInventoryItem(itemName, index) {
            const item = gameState.inventory[index];
            if (!item) return;
            
            addGameText(`\n> USE ${itemName}`);
            
            switch(item.use) {
                case "heal":
                    useHealthPotion(item, index);
                    break;
                case "mana":
                    useManaPotion(item, index);
                    break;
                case "light":
                    useTorch();
                    break;
                case "equip":
                    equipItem(itemName);
                    break;
                case "read":
                    readItem(itemName);
                    break;
                case "learn":
                    learnFromItem(itemName);
                    break;
                case "see":
                    useSpectralLens();
                    break;
                case "unlock":
                    tryUnlockDoor(itemName);
                    break;
                default:
                    addGameText(`\nYou use the ${itemName}.`);
                    addGameText("\n> ");
            }
        }

        function useHealthPotion(item, index) {
            const healAmount = 30;
            gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + healAmount);
            addGameText(`\nYou drink the HEALTH POTION and restore ${healAmount} HP!`, "combat");
            
            item.count--;
            if (item.count <= 0) {
                gameState.inventory.splice(index, 1);
            }
            
            updatePlayerStats();
            updateInventoryDisplay();
            addGameText("\n> ");
        }

        function useManaPotion(item, index) {
            const manaAmount = 25;
            gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + manaAmount);
            addGameText(`\nYou drink the MANA POTION and restore ${manaAmount} MP!`, "combat");
            
            item.count--;
            if (item.count <= 0) {
                gameState.inventory.splice(index, 1);
            }
            
            updatePlayerStats();
            updateInventoryDisplay();
            addGameText("\n> ");
        }

        function equipItem(itemName) {
            const item = gameState.inventory.find(i => i.name === itemName);
            
            if (!item) {
                addGameText(`\nYou don't have a ${itemName}.`);
                addGameText("\n> ");
                return;
            }
            
            if (item.type !== "weapon" && item.type !== "armor") {
                addGameText(`\n${itemName} cannot be equipped.`);
                addGameText("\n> ");
                return;
            }
            
            if (item.type === "weapon") {
                gameState.player.equippedWeapon = itemName;
                addGameText(`\nYou equip the ${itemName}.`);
            }
            
            updatePlayerStats();
            addGameText("\n> ");
        }

        function playerAttack() {
            if (!gameState.currentEnemy) return;
            
            let playerDmg = Math.max(1, gameState.player.attack + Math.floor(Math.random() * 6) - 2);
            const enemyDmg = Math.max(1, gameState.currentEnemy.attack + Math.floor(Math.random() * 4) - 2);
            
            // Check for weapon bonuses
            if (gameState.player.equippedWeapon === "SILVER DAGGER" && 
                (gameState.currentEnemy.type === "undead" || gameState.currentEnemy.type === "spirit")) {
                playerDmg += 3;
                addGameText("\nYour SILVER DAGGER glows against the undead foe!", "combat");
            }
            
            // Check for enemy weaknesses
            if (gameState.currentEnemy.weakness === "blunt" && gameState.player.equippedWeapon?.includes("HAMMER")) {
                playerDmg += 5;
                addGameText("\nThe enemy is weak to blunt weapons!", "combat");
            }
            if (gameState.currentEnemy.weakness === "holy" && hasHolyItem()) {
                playerDmg += 8;
                addGameText("\nYour holy item glows with power!", "combat");
            }
            
            // Check for enemy resistances
            if (gameState.currentEnemy.resistance === "slashing" && !gameState.player.equippedWeapon?.includes("HAMMER")) {
                playerDmg = Math.floor(playerDmg * 0.7);
                addGameText("\nThe enemy resists slashing damage!", "combat");
            }
            
            // Player hits enemy
            gameState.currentEnemy.health -= playerDmg;
            addGameText(`\nYou hit the ${gameState.currentEnemy.name} for ${playerDmg} damage!`, "combat");
            
            if (gameState.currentEnemy.health <= 0) {
                defeatEnemy();
                return;
            }
            
            // Enemy hits player
            const actualDmg = Math.max(1, enemyDmg - Math.floor(gameState.player.defense / 3));
            gameState.player.health -= actualDmg;
            addGameText(`\nThe ${gameState.currentEnemy.name} hits you for ${actualDmg} damage!`, "combat");
            
            updatePlayerStats();
            
            if (gameState.player.health <= 0) {
                gameOver();
                return;
            }
            
            addGameText(`\nYour HP: ${gameState.player.health}/${gameState.player.maxHealth}`);
            addGameText(`\nEnemy HP: ${gameState.currentEnemy.health}/${gameState.currentEnemy.maxHealth}`);
            addGameText("\n> ");
        }

        function castSpell(spellName) {
            if (!spellName) {
                addGameText("\nCast what spell? (You know: " + gameState.player.spells.join(", ") + ")");
                addGameText("\n> ");
                return;
            }
            
            spellName = spellName.toUpperCase();
            
            if (!gameState.player.spells.includes(spellName)) {
                addGameText(`\nYou don't know the spell "${spellName}".`);
                addGameText("\n> ");
                return;
            }
            
            if (gameState.player.mana < 10) {
                addGameText("\nNot enough mana!");
                addGameText("\n> ");
                return;
            }
            
            gameState.player.mana -= 10;
            
            if (spellName === "FIREBALL") {
                if (!gameState.currentEnemy) {
                    addGameText("\nYou cast FIREBALL at the wall. The stone blackens.");
                    addGameText("\n> ");
                    return;
                }
                
                let spellDmg = 15 + Math.floor(Math.random() * 10);
                
                // Bonus damage against certain enemies
                if (gameState.currentEnemy.type === "undead" || gameState.currentEnemy.weakness === "fire") {
                    spellDmg += 5;
                    addGameText("\nThe enemy is weak to fire!", "combat");
                }
                
                gameState.currentEnemy.health -= spellDmg;
                addGameText(`\nYou cast FIREBALL for ${spellDmg} damage!`, "combat");
                
                if (gameState.currentEnemy.health <= 0) {
                    defeatEnemy();
                    return;
                }
            } else if (spellName === "HEAL") {
                const healAmount = 20 + Math.floor(Math.random() * 10);
                gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + healAmount);
                addGameText(`\nYou cast HEAL and restore ${healAmount} HP!`, "combat");
                updatePlayerStats();
            } else if (spellName === "LIGHT") {
                addGameText("\nYou cast LIGHT. The room illuminates.");
                // Light spell lasts for a while
            } else {
                addGameText(`\nYou cast ${spellName}.`, "combat");
            }
            
            // Enemy attacks back if in combat
            if (gameState.currentEnemy && spellName !== "HEAL") {
                const enemyDmg = Math.max(1, gameState.currentEnemy.attack + Math.floor(Math.random() * 4) - 2);
                const actualDmg = Math.max(1, enemyDmg - Math.floor(gameState.player.defense / 3));
                gameState.player.health -= actualDmg;
                addGameText(`\nThe ${gameState.currentEnemy.name} hits you for ${actualDmg} damage!`, "combat");
                
                updatePlayerStats();
                
                if (gameState.player.health <= 0) {
                    gameOver();
                    return;
                }
                
                addGameText(`\nYour HP: ${gameState.player.health}/${gameState.player.maxHealth}`);
                addGameText(`\nEnemy HP: ${gameState.currentEnemy.health}/${gameState.currentEnemy.maxHealth}`);
            }
            
            addGameText(`\nYour MP: ${gameState.player.mana}/${gameState.player.maxMana}`);
            addGameText("\n> ");
        }

        function fleeCombat() {
            if (!gameState.currentEnemy) return;
            
            const fleeChance = 0.6;
            
            if (Math.random() < fleeChance) {
                addGameText(`\nYou successfully flee from the ${gameState.currentEnemy.name}!`, "combat");
                gameState.currentEnemy = null;
                toggleActionButtons(false);
            } else {
                addGameText(`\nYou fail to flee!`, "combat");
                
                // Enemy gets a free attack
                const enemyDmg = Math.max(1, gameState.currentEnemy.attack + Math.floor(Math.random() * 4));
                const actualDmg = Math.max(1, enemyDmg - Math.floor(gameState.player.defense / 3));
                gameState.player.health -= actualDmg;
                addGameText(`\nThe ${gameState.currentEnemy.name} hits you for ${actualDmg} damage as you try to run!`, "combat");
                
                updatePlayerStats();
                
                if (gameState.player.health <= 0) {
                    gameOver();
                    return;
                }
            }
            
            addGameText("\n> ");
        }

        function defeatEnemy() {
            addGameText(`\nYou defeated the ${gameState.currentEnemy.name}!`, "combat");
            
            // Gain rewards
            const goldGained = gameState.currentEnemy.gold;
            const expGained = gameState.currentEnemy.experience;
            
            gameState.player.gold += goldGained;
            gameState.player.experience += expGained;
            
            addGameText(`\nYou gain ${expGained} EXP and ${goldGained} GOLD!`, "item");
            
            // Track killed enemy
            const enemyType = gameState.currentEnemy.name.toLowerCase().replace(/ /g, '_');
            gameState.killedEnemies[enemyType] = (gameState.killedEnemies[enemyType] || 0) + 1;
            
            // Special enemy drops
            const dropChance = Math.random();
            if (dropChance < 0.3) {
                // Drop a random item
                const itemTypes = ["consumable", "material", "treasure"];
                const randomType = itemTypes[Math.floor(Math.random() * itemTypes.length)];
                
                // Find an item of this type
                const possibleItems = Object.values(itemDatabase).filter(item => 
                    item.type === randomType && item.value < 100
                );
                
                if (possibleItems.length > 0) {
                    const droppedItem = possibleItems[Math.floor(Math.random() * possibleItems.length)];
                    addGameText(`\nThe enemy drops a ${droppedItem.name}!`, "item");
                    
                    const existingItem = gameState.inventory.find(i => i.name === droppedItem.name);
                    if (existingItem) {
                        existingItem.count++;
                    } else {
                        gameState.inventory.push({
                            name: droppedItem.name,
                            count: 1,
                            type: droppedItem.type,
                            description: droppedItem.description,
                            use: getItemUse(droppedItem.type),
                            value: droppedItem.value
                        });
                    }
                    updateInventoryDisplay();
                }
            }
            
            // Check for level up
            checkLevelUp();
            
            // Check for boss defeat
            if (gameState.currentEnemy.name === "SHADOW DRAGON") {
                gameVictory();
                return;
            }
            
            if (gameState.currentEnemy.name === "MINOTAUR") {
                gameState.quests.mazeChallenge.completed = true;
                gameState.quests.mazeChallenge.active = false;
                addGameText("\n\n=== QUEST COMPLETE ===", "quest");
                addGameText("\nYou have defeated the Minotaur!", "quest");
                addGameText("\nThe Maze Champion Trophy appears before you.", "item");
                
                // Add trophy
                gameState.inventory.push({
                    name: "MAZE CHAMPION TROPHY",
                    count: 1,
                    type: "magic",
                    description: "Award for defeating the minotaur",
                    use: "trophy",
                    value: 300
                });
                
                updateQuestDisplay();
                updateInventoryDisplay();
            }
            
            gameState.currentEnemy = null;
            toggleActionButtons(false);
            
            addGameText("\n> ");
            updatePlayerStats();
        }

        function checkLevelUp() {
            if (gameState.player.experience >= gameState.player.nextLevelExp) {
                gameState.player.level++;
                gameState.player.experience -= gameState.player.nextLevelExp;
                gameState.player.nextLevelExp = Math.floor(gameState.player.nextLevelExp * 1.5);
                
                // Stat increases
                gameState.player.maxHealth += 20;
                gameState.player.health = gameState.player.maxHealth;
                gameState.player.maxMana += 10;
                gameState.player.mana = gameState.player.maxMana;
                gameState.player.attack += 3;
                gameState.player.defense += 2;
                
                // Learn new spell every 3 levels
                if (gameState.player.level % 3 === 0) {
                    const newSpells = ["SHIELD", "FROSTBOLT", "TELEPORT", "SUMMON"];
                    const newSpell = newSpells[Math.floor(Math.random() * newSpells.length)];
                    if (!gameState.player.spells.includes(newSpell)) {
                        gameState.player.spells.push(newSpell);
                        addGameText(`\nYou learn the ${newSpell} spell!`, "quest");
                    }
                }
                
                addGameText(`\n\n=== LEVEL UP! ===`, "quest");
                addGameText(`\nYou are now level ${gameState.player.level}!`, "quest");
                addGameText(`\nYour stats have improved!`, "quest");
                
                updatePlayerStats();
            }
        }

        function rest() {
            if (gameState.currentEnemy) {
                addGameText("\nYou cannot rest while in combat!", "combat");
                addGameText("\n> ");
                return;
            }
            
            const hpRecovered = Math.floor(gameState.player.maxHealth * 0.3);
            const mpRecovered = Math.floor(gameState.player.maxMana * 0.4);
            
            gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + hpRecovered);
            gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + mpRecovered);
            
            addGameText(`\nYou rest and recover ${hpRecovered} HP and ${mpRecovered} MP.`, "combat");
            
            // Chance of being ambushed while resting
            if (Math.random() < 0.3) {
                addGameText("\n\nWhile resting, you are ambushed!", "combat");
                encounterEnemy();
            } else {
                addGameText("\n> ");
            }
            
            updatePlayerStats();
        }

        function explore() {
            if (gameState.currentEnemy) {
                addGameText("\nYou cannot explore while in combat!", "combat");
                addGameText("\n> ");
                return;
            }
            
            addGameText("\nYou explore the area thoroughly...");
            
            const room = gameState.rooms[gameState.currentRoom];
            const exploreRoll = Math.random();
            
            if (exploreRoll < 0.4 && room.items && room.items.length > 0) {
                // Find an item
                const itemId = room.items[Math.floor(Math.random() * room.items.length)];
                const item = itemDatabase[itemId];
                
                if (item) {
                    addGameText(`\nYou discover a ${item.name}!`, "item");
                    
                    // Add to inventory
                    const existingItem = gameState.inventory.find(i => i.name === item.name);
                    if (existingItem) {
                        existingItem.count++;
                    } else {
                        gameState.inventory.push({
                            name: item.name,
                            count: 1,
                            type: item.type,
                            description: item.description,
                            use: getItemUse(item.type),
                            value: item.value
                        });
                    }
                    
                    // Remove from room
                    const itemIndex = room.items.indexOf(itemId);
                    if (itemIndex > -1) {
                        room.items.splice(itemIndex, 1);
                    }
                    
                    updateInventoryDisplay();
                }
            } else if (exploreRoll < 0.7) {
                const goldFound = Math.floor(Math.random() * 100) + 20;
                gameState.player.gold += goldFound;
                addGameText(`\nYou find ${goldFound} gold pieces hidden away!`, "item");
                updatePlayerStats();
            } else if (exploreRoll < 0.85) {
                addGameText("\nYou find nothing of value.");
            } else {
                addGameText("\nYour exploration attracts unwanted attention!");
                encounterEnemy();
                return;
            }
            
            // Special room discoveries
            if (gameState.currentRoom === "elemental_hall") {
                const orbs = ["WATER ORB", "EARTH ORB", "AIR ORB"];
                const foundOrb = orbs[Math.floor(Math.random() * orbs.length)];
                
                // Check if already found
                const alreadyHasOrb = gameState.inventory.some(item => item.name === foundOrb);
                if (!alreadyHasOrb && exploreRoll < 0.3) {
                    gameState.inventory.push({
                        name: foundOrb,
                        count: 1,
                        type: "orb",
                        description: foundOrb === "WATER ORB" ? "Cold to the touch" : 
                                    foundOrb === "EARTH ORB" ? "Feels like solid stone" : "Almost weightless",
                        use: "elemental",
                        value: 250
                    });
                    
                    // Update quest progress
                    if (foundOrb === "WATER ORB") gameState.quests.elementalOrbs.progress.water = true;
                    if (foundOrb === "EARTH ORB") gameState.quests.elementalOrbs.progress.earth = true;
                    if (foundOrb === "AIR ORB") gameState.quests.elementalOrbs.progress.air = true;
                    
                    addGameText(`\nYou find a ${foundOrb}!`, "item");
                    updateQuestDisplay();
                    updateInventoryDisplay();
                }
            }
            
            addGameText("\n> ");
        }

        function showMap() {
            addGameText("\n\n=== CASTLE MAP ===");
            addGameText("\nYou have visited " + gameState.roomsVisited.length + " of " + Object.keys(gameState.rooms).length + " rooms.");
            addGameText("\nCurrent location: " + gameState.rooms[gameState.currentRoom].name);
            
            // Show nearby rooms
            const room = gameState.rooms[gameState.currentRoom];
            addGameText("\n\nNearby areas:");
            Object.keys(room.exits).forEach(dir => {
                const targetRoomId = room.exits[dir];
                if (targetRoomId && gameState.rooms[targetRoomId]) {
                    const visited = gameState.roomsVisited.includes(targetRoomId) ? "(visited)" : "(unexplored)";
                    addGameText(`\n${dir.toUpperCase()}: ${gameState.rooms[targetRoomId].name} ${visited}`);
                }
            });
            
            addGameText("\n\n> ");
        }

        function talkToNPC(npcName) {
            const room = gameState.rooms[gameState.currentRoom];
            
            // Find NPC in current room
            let npcId = null;
            let npc = null;
            
            for (const id of room.npcs || []) {
                const potentialNPC = gameState.npcs[id];
                if (potentialNPC && potentialNPC.name.toLowerCase().includes(npcName.toLowerCase())) {
                    npcId = id;
                    npc = potentialNPC;
                    break;
                }
            }
            
            if (!npc) {
                addGameText(`\n${npcName} is not here.`);
                addGameText("\n> ");
                return;
            }
            
            addGameText(`\n\n${npc.name}:`, "npc");
            
            // Handle different NPCs
            if (npcId === "ghostly_knight") {
                handleGhostKnightDialogue(npc);
            } else if (npcId === "trapped_mage") {
                handleTrappedMageDialogue(npc);
            } else if (npcId === "ghostly_butler") {
                addGameText('\n"Welcome to Castle Damned, sir. I am Jeeves, the butler. Or rather, I was."');
                addGameText('\n"The castle has been... disturbed... for centuries now."');
                addGameText('\n"If you seek the throne room, you will need the royal key. Only the queen knows where it is."');
            } else if (npcId === "fallen_priest") {
                addGameText('\n"Bless you, child. This chapel was once a place of peace."');
                addGameText('\n"Now it is a gateway to the crypts below. Be careful down there."');
                addGameText('\n"The dead do not rest easily in this cursed place."');
            } else if (npcId === "ghost_cook") {
                addGameText('\n"Zut alors! My kitchen is in ruins!"');
                addGameText('\n"If you find any magical herbs in the garden, bring them to me."');
                addGameText('\n"I can make a meal that will restore your strength greatly."');
                
                if (!gameState.quests.blacksmithRequest.active) {
                    gameState.quests.blacksmithRequest.active = true;
                    updateQuestDisplay();
                }
            } else if (npcId === "mad_gardener") {
                addGameText('\n"The plants... they whisper to me... they hunger..."');
                addGameText('\n"Somewhere in the maze, there is a golden seed."');
                addGameText('\n"Find it for me, and I will give you something precious."');
                
                if (!gameState.quests.gardenerQuest.active) {
                    gameState.quests.gardenerQuest.active = true;
                    updateQuestDisplay();
                }
            } else if (npcId === "ghost_blacksmith") {
                addGameText('\n"Clang! Clang! The forge still burns with magical fire."');
                addGameText('\n"Bring me mithril from the ore storage, and I will forge you a weapon worthy of a king."');
                
                if (!gameState.quests.blacksmithRequest.active) {
                    gameState.quests.blacksmithRequest.active = true;
                    updateQuestDisplay();
                }
            } else if (npcId === "royal_astronomer") {
                addGameText('\n"Look to the stars! They tell of great changes."');
                addGameText('\n"My star chart is incomplete. Find the missing fragments in the observatory tower."');
                addGameText('\n"I will reward you with a magical compass."');
                
                if (!gameState.quests.astronomerQuest.active) {
                    gameState.quests.astronomerQuest.active = true;
                    updateQuestDisplay();
                }
            } else if (npcId === "ghost_queen") {
                addGameText('\n"Who dares enter the royal chambers?"');
                addGameText('\n"Ah, a living soul. How long it has been..."');
                addGameText('\n"My family is trapped here. Help us find peace, and the castle may be cleansed."');
                
                if (!gameState.quests.royalFamily.active) {
                    gameState.quests.royalFamily.active = true;
                    updateQuestDisplay();
                }
            } else if (npcId === "ghost_prince") {
                addGameText('\n"Hello! Do you want to play?"');
                addGameText('\n"I lost my wooden sword. Can you find it for me?"');
                addGameText('\n"It should be in my room somewhere..."');
            } else if (npcId === "dryad") {
                addGameText('\n"Greetings, mortal. I am Elara, guardian of these gardens."');
                addGameText('\n"The plants are sick with dark magic. Find the source in the greenhouse."');
                addGameText('\n"Clean it, and the gardens will bloom once more."');
            } else if (npcId === "forest_hermit") {
                addGameText('\n"You found my hideaway. Few know of this place."');
                addGameText('\n"The castle\'s curse grows stronger each year."');
                addGameText('\n"Only by gathering all elemental orbs can it be broken."');
            } else if (npcId === "ancient_prisoner") {
                addGameText('\n"Finally, someone with the courage to speak to old Mordred!"');
                addGameText('\n"I know ancient magic that could help you."');
                addGameText('\n"Free me from this cell, and I will share my knowledge."');
            } else if (npcId === "founder_ghost") {
                addGameText('\n"I am Arcturus, founder of this castle."');
                addGameText('\n"My pride brought this curse upon us all."');
                addGameText('\n"Take my sword. Use it to defeat the shadow dragon in the throne room."');
                addGameText('\n"Only then will the curse be lifted."');
                
                if (!gameState.quests.founderTomb.active) {
                    gameState.quests.founderTomb.active = true;
                    updateQuestDisplay();
                }
            } else {
                addGameText('\n"... ... ..."');
                addGameText('\n(The ghost seems lost in thought)');
            }
            
            addGameText("\n> ");
        }

        function handleGhostKnightDialogue(npc) {
            if (!npc.questGiven) {
                addGameText('\n"Brave adventurer... I am Sir Alistair, cursed to guard this armory for eternity."');
                addGameText('\n"Find my ancestral sword in the ancient tomb and return it to me."');
                addGameText('\n"I shall grant you passage to the throne room."');
                npc.questGiven = true;
                gameState.quests.ghostKnight.description = "Find Sir Alistair's ancestral sword in the ancient tomb";
            } else if (!npc.questCompleted) {
                const hasSword = gameState.inventory.some(item => item.name === "FOUNDER'S SWORD");
                if (hasSword) {
                    addGameText('\n"You found my sword! Thank you, adventurer. Take this GUARDIAN KEY."');
                    addGameText('\n"It will unlock the throne room door."');
                    addGameText('\n"Sir Alistair fades away, finally at peace."', "npc");
                    
                    // Remove sword from inventory
                    const swordIndex = gameState.inventory.findIndex(item => item.name === "FOUNDER'S SWORD");
                    if (swordIndex !== -1) {
                        gameState.inventory.splice(swordIndex, 1);
                    }
                    
                    // Add guardian key
                    gameState.inventory.push({
                        name: "GUARDIAN KEY",
                        count: 1,
                        type: "key",
                        description: "Unlocks the Guardian's Chamber",
                        use: "unlock",
                        value: 80
                    });
                    
                    npc.questCompleted = true;
                    gameState.quests.ghostKnight.completed = true;
                    gameState.quests.ghostKnight.active = false;
                    
                    // Give experience reward
                    gameState.player.experience += 100;
                    checkLevelUp();
                    
                    updateInventoryDisplay();
                    updateQuestDisplay();
                } else {
                    addGameText('\n"Have you found my ancestral sword yet? It should be in the ancient tomb."');
                }
            } else {
                addGameText('\n(The ghostly knight has found peace and is no longer here.)');
            }
        }

        function handleTrappedMageDialogue(npc) {
            if (npc.needsHelp) {
                addGameText('\n"Help! I\'m trapped by this magical barrier!"');
                addGameText('\n"The books on the shelves must be arranged in the correct order to dispel it."');
                addGameText('\n"The correct order is hinted in the library\'s history section..."');
                
                if (!gameState.quests.libraryPuzzle.active) {
                    gameState.quests.libraryPuzzle.active = true;
                    updateQuestDisplay();
                }
            } else {
                addGameText('\n"Thank you for freeing me! Take this ANCIENT SCROLL as reward."');
                addGameText('\n"The mage teleports away."', "npc");
            }
        }

        function examineItem(itemName) {
            const item = gameState.inventory.find(i => 
                i.name.toLowerCase().includes(itemName.toLowerCase())
            );
            
            if (!item) {
                addGameText(`\nYou don't have a "${itemName}".`);
                addGameText("\n> ");
                return;
            }
            
            addGameText(`\n${item.name}: ${item.description}`);
            addGameText(`\nType: ${item.type.toUpperCase()}`);
            addGameText(`\nValue: ${item.value} gold`);
            
            if (item.type === "weapon") {
                addGameText("\nThis is a weapon that can be equipped.");
            } else if (item.type === "key") {
                addGameText("\nThis key might unlock something important.");
            } else if (item.type === "orb") {
                addGameText("\nThis orb radiates elemental power.");
            }
            
            addGameText("\n> ");
        }

        function readItem(itemName) {
            const item = gameState.inventory.find(i => 
                i.name.toLowerCase().includes(itemName.toLowerCase())
            );
            
            if (!item) {
                addGameText(`\nYou don't have a "${itemName}".`);
                addGameText("\n> ");
                return;
            }
            
            if (itemName.toUpperCase().includes("LETTER")) {
                addGameText('\n\nYou read the faded letter:');
                addGameText('\n"...the four orbs must be placed in their respective chambers..."');
                addGameText('\n"...only then will the path to the throne room open..."');
                addGameText('\n"...beware the shadow dragon that guards the throne..."');
                addGameText('\n"The rest is too faded to read."');
            } else if (itemName.toUpperCase().includes("DIARY")) {
                addGameText('\n\nYou read the diary:');
                addGameText('\n"Day 45: The castle grows colder each day."');
                addGameText('\n"Day 67: Strange sounds come from the crypt at night."');
                addGameText('\n"Day 89: I saw a shadow moving without a source of light..."');
                addGameText('\n"The entries stop abruptly."');
            } else if (itemName.toUpperCase().includes("SCROLL")) {
                learnFromItem(itemName);
                return;
            } else {
                addGameText(`\nThe ${item.name} has nothing readable.`);
            }
            
            addGameText("\n> ");
        }

        function learnFromItem(itemName) {
            if (itemName.toUpperCase().includes("ANCIENT SCROLL")) {
                addGameText("\nYou study the ANCIENT SCROLL and learn the FIREBALL spell!", "quest");
                addGameText("\nThe scroll crumbles to dust.");
                
                // Remove scroll from inventory
                const scrollIndex = gameState.inventory.findIndex(item => 
                    item.name.includes("ANCIENT SCROLL")
                );
                if (scrollIndex !== -1) {
                    gameState.inventory.splice(scrollIndex, 1);
                }
                
                // Player now knows fireball
                if (!gameState.player.spells.includes("FIREBALL")) {
                    gameState.player.spells.push("FIREBALL");
                }
                
                gameState.quests.libraryPuzzle.completed = true;
                gameState.quests.libraryPuzzle.active = false;
                updateQuestDisplay();
                updateInventoryDisplay();
            } else if (itemName.toUpperCase().includes("SPELL SCROLL")) {
                const newSpells = ["LIGHTNING", "ICE_SHARD", "TELEPORT", "INVISIBILITY"];
                const newSpell = newSpells[Math.floor(Math.random() * newSpells.length)];
                
                addGameText(`\nYou study the SPELL SCROLL and learn the ${newSpell} spell!`, "quest");
                addGameText("\nThe scroll crumbles to dust.");
                
                // Remove scroll from inventory
                const scrollIndex = gameState.inventory.findIndex(item => 
                    item.name.includes("SPELL SCROLL")
                );
                if (scrollIndex !== -1) {
                    gameState.inventory.splice(scrollIndex, 1);
                }
                
                // Player learns new spell
                if (!gameState.player.spells.includes(newSpell)) {
                    gameState.player.spells.push(newSpell);
                }
                
                updateInventoryDisplay();
            }
            
            addGameText("\n> ");
        }

        function useTorch() {
            const hasTorch = gameState.inventory.some(item => item.name === "TORCH");
            
            if (!hasTorch) {
                addGameText("\nYou don't have a TORCH.");
                addGameText("\n> ");
                return;
            }
            
            addGameText("\nYou light the TORCH. The room becomes brighter.");
            
            const room = gameState.rooms[gameState.currentRoom];
            if (room.dark) {
                addGameText("\nYou can now see clearly.");
                
                // Reveal hidden items in dark rooms
                if (room.items && room.items.length > 0) {
                    addGameText("\nIn the newfound light, you see:");
                    room.items.forEach(itemId => {
                        const item = itemDatabase[itemId];
                        if (item) {
                            addGameText(` ${item.name}`);
                        }
                    });
                }
            }
            
            // Special torch effects
            if (gameState.currentRoom === "dungeon_hall") {
                addGameText("\nThe torchlight reveals a hidden door in the wall!");
                // Could add a secret exit here
            }
            
            addGameText("\n> ");
        }

        function useSpectralLens() {
            const hasLens = gameState.inventory.some(item => item.name === "SPECTRAL LENS");
            
            if (!hasLens) {
                addGameText("\nYou don't have a SPECTRAL LENS.");
                addGameText("\n> ");
                return;
            }
            
            addGameText("\nYou look through the SPECTRAL LENS...");
            
            const room = gameState.rooms[gameState.currentRoom];
            
            // Special room revelations
            if (gameState.currentRoom === "armory") {
                addGameText("\nYou see a hidden compartment behind the third suit of armor!");
                addGameText("\nInside, you find a FIRE ORB!", "item");
                
                if (!gameState.discoveredItems.fireOrb) {
                    gameState.inventory.push({
                        name: "FIRE ORB",
                        count: 1,
                        type: "orb",
                        description: "Glows with inner fire",
                        use: "elemental",
                        value: 250
                    });
                    
                    gameState.discoveredItems.fireOrb = true;
                    gameState.quests.elementalOrbs.progress.fire = true;
                    updateQuestDisplay();
                    updateInventoryDisplay();
                }
            } else if (gameState.currentRoom === "library") {
                addGameText("\nYou see invisible writing on the bookshelves!");
                addGameText("\nIt reads: 'History first, then Magic, Science, and Poetry.'");
                gameState.puzzles.libraryBooks.clue = "The order is: History, Magic, Science, Poetry";
            } else if (gameState.currentRoom.includes("crypt") || gameState.currentRoom.includes("tomb")) {
                addGameText("\nYou see ghostly figures moving through the walls.");
                addGameText("\nThey point to a specific section of the wall...");
                // Could reveal a secret passage
            } else {
                addGameText("\nYou don't see anything unusual.");
            }
            
            addGameText("\n> ");
        }

        function tryUnlockDoor(keyName) {
            const room = gameState.rooms[gameState.currentRoom];
            
            if (!room.locked) {
                addGameText("\nThere's nothing to unlock here.");
                addGameText("\n> ");
                return;
            }
            
            const hasKey = gameState.inventory.some(item => 
                item.name.toLowerCase().includes(keyName.toLowerCase()) ||
                item.name.toLowerCase().includes(room.key.toLowerCase())
            );
            
            if (!hasKey) {
                addGameText(`\nYou don't have the right key to unlock this door.`);
                addGameText("\n> ");
                return;
            }
            
            // Unlock the room
            room.locked = false;
            addGameText(`\nYou use the ${keyName} to unlock the door.`);
            addGameText("\nThe door creaks open.");
            
            // Special unlocks
            if (gameState.currentRoom === "throne_room") {
                addGameText("\nThe throne room is now accessible!");
                addGameText("\nBeware the shadow dragon within!", "combat");
            }
            
            addGameText("\n> ");
        }

        function solvePuzzle(puzzle) {
            if (gameState.currentRoom !== "library") {
                addGameText("\nThere's no puzzle to solve here.");
                addGameText("\n> ");
                return;
            }
            
            if (puzzle.toUpperCase() === "BOOKS") {
                addGameText("\nEnter the correct order of bookshelves (comma separated):");
                addGameText("\nExample: HISTORY, MAGIC, SCIENCE, POETRY");
                addGameText("\n> ");
                
                // In a full implementation, we would wait for player input
                // For now, we'll simulate solving it
                const correctOrder = "HISTORY,MAGIC,SCIENCE,POETRY";
                
                // Check if player has the clue
                if (gameState.puzzles.libraryBooks.clue) {
                    addGameText(`\nYou recall: "${gameState.puzzles.libraryBooks.clue}"`);
                }
                
                // Simulate solving
                if (Math.random() > 0.5) {
                    addGameText("\nYou arrange the books in the correct order!");
                    addGameText("\nThe magical barrier dissipates! The trapped mage is freed.", "npc");
                    addGameText('\n"Thank you! Take this ANCIENT SCROLL as reward."', "npc");
                    
                    gameState.npcs.trapped_mage.needsHelp = false;
                    gameState.puzzles.libraryBooks.solved = true;
                    gameState.quests.libraryPuzzle.completed = true;
                    gameState.quests.libraryPuzzle.active = false;
                    
                    // Add ancient scroll to inventory
                    gameState.inventory.push({
                        name: "ANCIENT SCROLL",
                        count: 1,
                        type: "quest",
                        description: "Teaches the FIREBALL spell",
                        use: "learn",
                        value: 200
                    });
                    
                    updateInventoryDisplay();
                    updateQuestDisplay();
                } else {
                    addGameText("\nNothing happens. The order seems incorrect.");
                }
            } else {
                addGameText(`\n"${puzzle}" is not a puzzle you can solve here.`);
            }
            
            addGameText("\n> ");
        }

        function showStats() {
            const p = gameState.player;
            addGameText("\n\n=== YOUR STATS ===");
            addGameText(`\nNAME: ${p.name}`);
            addGameText(`\nCLASS: ${p.class}`);
            addGameText(`\nLEVEL: ${p.level}`);
            addGameText(`\nHEALTH: ${p.health}/${p.maxHealth}`);
            addGameText(`\nMANA: ${p.mana}/${p.maxMana}`);
            addGameText(`\nATTACK: ${playerAttackEl.textContent}`);
            addGameText(`\nDEFENSE: ${playerDefenseEl.textContent}`);
            addGameText(`\nGOLD: ${p.gold}`);
            addGameText(`\nEXP: ${p.experience}/${p.nextLevelExp}`);
            addGameText(`\nEQUIPPED: ${p.equippedWeapon || "None"}`);
            addGameText(`\nSPELLS: ${p.spells.join(", ")}`);
            addGameText(`\nROOMS EXPLORED: ${gameState.roomsVisited.length}/${Object.keys(gameState.rooms).length}`);
            addGameText(`\nENEMIES DEFEATED: ${Object.keys(gameState.killedEnemies).length}`);
            
            addGameText("\n> ");
        }

        function showInventory() {
            addGameText("\n\n=== INVENTORY ===");
            
            if (gameState.inventory.length === 0) {
                addGameText("\nYour inventory is empty.");
            } else {
                // Group items by type
                const byType = {};
                gameState.inventory.forEach(item => {
                    if (!byType[item.type]) byType[item.type] = [];
                    byType[item.type].push(item);
                });
                
                Object.keys(byType).forEach(type => {
                    addGameText(`\n\n${type.toUpperCase()}:`);
                    byType[type].forEach(item => {
                        addGameText(`\n${item.name} x${item.count} - ${item.description} (${item.value} gold)`);
                    });
                });
            }
            
            addGameText("\n\n> ");
        }

        function showQuests() {
            addGameText("\n\n=== ACTIVE QUESTS ===");
            
            let hasQuests = false;
            Object.entries(gameState.quests).forEach(([key, quest]) => {
                if (quest.active && !quest.completed) {
                    hasQuests = true;
                    addGameText(`\n\n${quest.description}`, "quest");
                    
                    if (quest.progress) {
                        const completed = Object.values(quest.progress).filter(v => v).length;
                        addGameText(`\nProgress: ${completed}/4 orbs found`);
                    }
                    
                    if (quest.reward) {
                        addGameText(`\nReward: ${quest.reward}`);
                    }
                    
                    if (quest.location && gameState.rooms[quest.location]) {
                        addGameText(`\nLocation: ${gameState.rooms[quest.location].name}`);
                    }
                }
            });
            
            if (!hasQuests) {
                addGameText("\nNo active quests.");
                addGameText("\nTalk to NPCs to get quests!");
            }
            
            // Show completed quests
            const completedQuests = Object.values(gameState.quests).filter(q => q.completed);
            if (completedQuests.length > 0) {
                addGameText("\n\n=== COMPLETED QUESTS ===");
                completedQuests.forEach(quest => {
                    addGameText(`\n${quest.description} `, "quest");
                });
            }
            
            addGameText("\n\n> ");
        }

        function toggleActionButtons(inCombat) {
            fightBtn.disabled = !inCombat;
            spellBtn.disabled = !inCombat;
            fleeBtn.disabled = !inCombat;
            restBtn.disabled = inCombat;
            exploreBtn.disabled = inCombat;
        }

        function hasLightSource() {
            return gameState.inventory.some(item => 
                item.name === "TORCH" || 
                gameState.player.spells.includes("LIGHT")
            );
        }

        function hasHolyItem() {
            return gameState.inventory.some(item => 
                item.name.includes("HOLY") || 
                item.name.includes("PRAYER")
            );
        }

        function getItemUse(itemType) {
            switch(itemType) {
                case "weapon": return "equip";
                case "consumable": return "heal";
                case "key": return "unlock";
                case "orb": return "elemental";
                case "tool": return "use";
                case "magic": return "use";
                case "quest": return "read";
                default: return "use";
            }
        }

        function gameOver() {
            addGameText("\n\n=== GAME OVER ===", "combat");
            addGameText("\nYou have been defeated...", "combat");
            addGameText("\nThe Castle of the Damned claims another soul.", "combat");
            addGameText("\n\nRooms explored: " + gameState.roomsVisited.length);
            addGameText("\nLevel reached: " + gameState.player.level);
            addGameText("\nGold collected: " + gameState.player.gold);
            addGameText("\n\nPress F5 to play again.");
            
            gameState.gameActive = false;
            toggleActionButtons(false);
            commandInput.disabled = true;
            submitBtn.disabled = true;
        }

        function gameVictory() {
            // Check if all quests completed
            const allOrbsFound = gameState.quests.elementalOrbs.progress ? 
                Object.values(gameState.quests.elementalOrbs.progress).every(v => v) : false;
            
            addGameText("\n\n=== VICTORY! ===", "quest");
            addGameText("\nYou have defeated the Shadow Dragon!", "quest");
            
            if (allOrbsFound) {
                addGameText("\nWith all Elemental Orbs collected, the castle's curse is completely lifted.", "quest");
                addGameText("\nSunlight streams through the windows for the first time in centuries.", "quest");
                addGameText("\nThe ghosts fade away, finally at peace.", "quest");
                addGameText("\nTreasure beyond imagination is now yours!", "item");
            } else {
                addGameText("\nThe castle's curse is weakened but not fully broken.", "quest");
                addGameText("\nSome ghosts remain, and treasures are still locked away...", "quest");
                addGameText("\nPerhaps you should find all the elemental orbs?", "quest");
            }
            
            addGameText("\n\n=== FINAL STATISTICS ===");
            addGameText("\nLevel: " + gameState.player.level);
            addGameText("\nGold: " + gameState.player.gold);
            addGameText("\nRooms explored: " + gameState.roomsVisited.length + "/" + Object.keys(gameState.rooms).length);
            addGameText("\nQuests completed: " + Object.values(gameState.quests).filter(q => q.completed).length + "/" + Object.keys(gameState.quests).length);
            addGameText("\nEnemies defeated: " + Object.keys(gameState.killedEnemies).length);
            
            addGameText("\n\nCongratulations! You have completed Castle of the Damned!");
            addGameText("\n\nPress F5 to play again.");
            
            gameState.gameActive = false;
            toggleActionButtons(false);
            commandInput.disabled = true;
            submitBtn.disabled = true;
        }

        // ===============================
        // INITIALIZE THE GAME
        // ===============================
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
