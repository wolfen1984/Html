<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DreadWood: Swamp of Sorrows</title>
    <style>
        /* EXACT SAME STYLE as previous levels with swamp-themed colors */
        body {
            font-family: 'Courier New', monospace;
            background-color: #0a1a0a;
            color: #33ff33;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            border: 2px solid #33ff33;
            background-color: #000;
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #33ff33;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #33cc33;
            text-shadow: 0 0 5px #33cc33;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
        }
        
        h2 {
            color: #33ccff;
            border-bottom: 1px solid #33ccff;
            padding-bottom: 5px;
            margin-top: 25px;
        }
        
        .screen {
            display: none;
        }
        
        .active-screen {
            display: block;
        }
        
        .stats-bar {
            background-color: #0a2a0a;
            border: 1px solid #33ff33;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-value {
            color: #ffff33;
            font-weight: bold;
        }
        
        .inventory {
            background-color: #112211;
            border: 1px solid #33cc33;
            padding: 10px;
            margin: 15px 0;
            min-height: 60px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #224422;
            border: 1px solid #33ccff;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
        }
        
        .story-text {
            background-color: #111111;
            border: 1px solid #33ff33;
            padding: 15px;
            margin: 20px 0;
            min-height: 150px;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #223322;
            color: #33ff33;
            border: 2px solid #33ff33;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #335533;
            color: #ffff33;
            border-color: #ffff33;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #003300;
            color: #33cc33;
            border: 2px solid #33cc33;
            padding: 10px 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #005500;
            color: #99ff99;
        }
        
        .dice-roll {
            background-color: #223322;
            border: 1px solid #33ff33;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ffff33;
        }
        
        .game-over {
            color: #ff3333;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #ff3333;
        }
        
        .success {
            color: #33ff33;
            font-weight: bold;
        }
        
        .damage {
            color: #ff3333;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9933;
            font-weight: bold;
        }
        
        .poison {
            color: #cc33ff;
            font-weight: bold;
        }
        
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #003333;
            color: #33ff99;
            border: 2px solid #33ff99;
            padding: 15px 30px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #005555;
            color: #99ffcc;
        }
        
        .retro-notice {
            text-align: center;
            color: #888888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333333;
            padding-top: 10px;
        }
        
        .warning-dialog {
            background-color: #332222;
            border: 2px solid #ff3333;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .warning-text {
            color: #ff9933;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .dialog-btn {
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid;
        }
        
        .dialog-btn-yes {
            background-color: #223322;
            color: #33ff33;
            border-color: #33ff33;
        }
        
        .dialog-btn-no {
            background-color: #332222;
            color: #ff3333;
            border-color: #ff3333;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 10px;
                font-size: 14px;
            }
            
            .dialog-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DREADWOOD</h1>
            <h2>SWAMP OF SORROWS</h2>
            <div class="retro-notice">Level 3 - The Foul Bog Awaits</div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item">SKILL: <span id="stat-skill" class="stat-value">0</span></div>
                <div class="stat-item">STAMINA: <span id="stat-stamina" class="stat-value">0</span>/<span id="stat-maxstamina" class="stat-value">0</span></div>
                <div class="stat-item">LUCK: <span id="stat-luck" class="stat-value">0</span></div>
                <div class="stat-item">GOLD: <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <h2>INVENTORY</h2>
            <div class="inventory" id="inventory">
                <!-- Inventory will be loaded from saved game -->
            </div>
            
            <h2>THE ADVENTURE</h2>
            <div class="story-text" id="story-text">
                <p>You stand at the edge of the SWAMP OF SORROWS. A foul mist hangs over stagnant water, and twisted trees claw at the gray sky. The air reeks of decay. Somewhere in this fetid bog lies the path to BLOODSTONE KEEP. Choose your entry point carefully...</p>
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <button class="choice-btn" onclick="loadSection(1)">Follow the Old Boardwalk</button>
                <button class="choice-btn" onclick="loadSection(2)">Wade through the Murky Water</button>
                <button class="choice-btn" onclick="loadSection(3)">Search for Higher Ground</button>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useLuck()">TEST LUCK</button>
                <button class="action-btn" onclick="checkInventory()">INVENTORY</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="showNewGameWarning()">START NEW GAME</button>
            </div>
        </div>
        
        <!-- Warning Dialog for New Game -->
        <div id="warning-dialog" class="screen">
            <div class="warning-dialog">
                <div class="warning-text">WARNING: Starting a new game will delete ALL your current progress!</div>
                <p>Your current character, stats, inventory, and gold will be permanently erased.</p>
                <p>You will return to the beginning of the game to create a new character.</p>
                <div class="dialog-buttons">
                    <button class="dialog-btn dialog-btn-yes" onclick="startNewGame()">YES, START NEW GAME</button>
                    <button class="dialog-btn dialog-btn-no" onclick="cancelNewGame()">NO, KEEP MY CHARACTER</button>
                </div>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>VICTORY!</h2>
            <div class="story-text">
                <p>You have survived the SWAMP OF SORROWS!</p>
                <p>Emerging from the foul bog, you see it ahead: BLOODSTONE KEEP, a fortress of dark stone that seems to bleed crimson in the dying light. Legends say it holds ancient secrets and terrible guardians.</p>
                <p>Your journey continues... All your stats, gold, and inventory will carry over to the next chapter.</p>
                <div class="stats-bar">
                    <div class="stat-item">SKILL: <span id="next-stat-skill" class="stat-value">0</span></div>
                    <div class="stat-item">STAMINA: <span id="next-stat-stamina" class="stat-value">0</span></div>
                    <div class="stat-item">LUCK: <span id="next-stat-luck" class="stat-value">0</span></div>
                    <div class="stat-item">GOLD: <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO BLOODSTONE KEEP</button>
            </div>
        </div>
        
        <div class="retro-notice">
            DREADWOOD - A Retro Gamebook Adventure<br>
            Level 3: Swamp of Sorrows
        </div>
    </div>

    <script>
        // Game state (loaded from localStorage)
        let gameState = JSON.parse(localStorage.getItem('dreadwoodGameState')) || {
            playerClass: 'warrior',
            skill: 12,
            maxStamina: 20,
            stamina: 20,
            luck: 12,
            gold: 50,
            inventory: ['Dagger', 'Leather Armor'],
            weapons: [{name: 'Dagger', damage: '1d6'}],
            armor: [{name: 'Leather Armor', defense: 1}],
            currentWeaponIndex: 0,
            currentArmorIndex: 0,
            currentSection: 0,
            gameComplete: false
        };
        
        // FIX: Reset currentSection when starting a new level
        // Level 2 ends at section 200, so if we're coming from level 2, reset to start of level 3
        if (gameState.currentSection === 200 || gameState.gameComplete) {
            gameState.currentSection = 0;
            gameState.gameComplete = false;
        }
        
        // Ensure indices exist
        if (gameState.currentWeaponIndex === undefined) {
            gameState.currentWeaponIndex = gameState.weapons.length - 1;
        }
        if (gameState.currentArmorIndex === undefined) {
            gameState.currentArmorIndex = gameState.armor.length - 1;
        }
        
        // Level 3 story sections - SWAMP OF SORROWS
        const storySections = {
            0: {
                text: "You stand at the edge of the SWAMP OF SORROWS. A foul mist hangs over stagnant water, and twisted trees claw at the gray sky. The air reeks of decay. Somewhere in this fetid bog lies the path to BLOODSTONE KEEP. Choose your entry point carefully...",
                choices: [
                    {text: "Follow the Old Boardwalk", nextSection: 1, skillCheck: false},
                    {text: "Wade through the Murky Water", nextSection: 2, skillCheck: false},
                    {text: "Search for Higher Ground", nextSection: 3, skillCheck: false}
                ]
            },
            1: {
                text: "You step onto a creaking wooden boardwalk that disappears into the mist. The planks are rotten in places. Ahead, you see a fork in the path.",
                choices: [
                    {text: "Take the left path", nextSection: 4, skillCheck: false},
                    {text: "Take the right path", nextSection: 5, skillCheck: false},
                    {text: "Check the boards for stability first", nextSection: 6, skillCheck: true, checkType: 'luck', difficulty: 10}
                ]
            },
            2: {
                text: "You wade into the cold, murky water. It reaches your waist. Something brushes against your leg!",
                choices: [
                    {text: "Quickly move forward", nextSection: 7, skillCheck: false},
                    {text: "Look down to see what touched you", nextSection: 8, skillCheck: false},
                    {text: "Use your weapon to probe ahead", nextSection: 9, skillCheck: false}
                ]
            },
            3: {
                text: "You search for higher ground and find a narrow ridge of solid earth winding through the swamp. The going is slow but firm.",
                choices: [
                    {text: "Follow the ridge", nextSection: 10, skillCheck: false},
                    {text: "Search the ridge for useful plants", nextSection: 11, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Return to the swamp edge", nextSection: 0, skillCheck: false}
                ]
            },
            4: {
                text: "The left path leads to an abandoned fishing shack perched on stilts over the water. The door hangs open, creaking in the wind.",
                choices: [
                    {text: "Enter the shack", nextSection: 12, skillCheck: false},
                    {text: "Check around the shack first", nextSection: 13, skillCheck: false},
                    {text: "Continue past the shack", nextSection: 14, skillCheck: false}
                ]
            },
            5: {
                text: "The right path leads deeper into thickening mist. You hear strange croaking sounds and see glowing eyes in the fog.",
                choices: [
                    {text: "Press forward cautiously", nextSection: 15, skillCheck: false},
                    {text: "Try to hide and observe", nextSection: 16, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Make noise to scare whatever it is", nextSection: 17, skillCheck: false}
                ]
            },
            6: {
                text: window.checkResult ? 
                    "You carefully test the boards and avoid a rotten section that would have collapsed under your weight!" : 
                    "You step on a rotten board and it breaks! You fall into the water below, taking 3 damage.",
                choices: [
                    window.checkResult ? 
                        {text: "Continue carefully", nextSection: 18, skillCheck: false} :
                        {text: "Climb back up, injured", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult) {
                        gameState.stamina -= 3;
                        updateStatsDisplay();
                    }
                }
            },
            7: {
                text: "You hurry forward, splashing through the water. Suddenly, the ground gives way and you're in deep water! Something wraps around your ankle!",
                choices: [
                    {text: "Try to cut yourself free", nextSection: 19, skillCheck: false},
                    {text: "Dive down to see what has you", nextSection: 20, skillCheck: false},
                    {text: "Use a Luck point to escape", nextSection: 21, skillCheck: false}
                ]
            },
            8: {
                text: "You look down into the murky water. A pale, bloated face stares back at you! It's a DROWNED ONE, an undead swamp creature!",
                choices: [
                    {text: "Attack it in the water", nextSection: 22, skillCheck: false},
                    {text: "Try to reach solid ground first", nextSection: 23, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Scream and flail to scare it", nextSection: 24, skillCheck: false}
                ]
            },
            9: {
                text: "You use your weapon to probe ahead and discover the water gets deeper. You also feel something solid - a sunken chest!",
                choices: [
                    {text: "Dive for the chest", nextSection: 25, skillCheck: false},
                    {text: "Mark the spot and continue", nextSection: 26, skillCheck: false},
                    {text: "Leave it and press on", nextSection: 27, skillCheck: false}
                ]
            },
            10: {
                text: "The ridge winds through the swamp, providing solid footing. You come across a strange stone marker covered in moss and strange symbols.",
                choices: [
                    {text: "Examine the marker", nextSection: 28, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Ignore it and continue", nextSection: 29, skillCheck: false},
                    {text: "Make a camp here to rest", nextSection: 30, skillCheck: false}
                ]
            },
            11: {
                text: window.checkResult ? 
                    "You find some useful swamp plants: healing moss that restores 4 Stamina, and venomous thornberries that could be used as poison." : 
                    "You find nothing but mud and foul-smelling fungi.",
                choices: [
                    window.checkResult ? 
                        {text: "Take the plants and continue", nextSection: 31, skillCheck: false} :
                        {text: "Continue along the ridge", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 4);
                        gameState.inventory.push("Healing Moss", "Thornberry Poison");
                        updateStatsDisplay();
                        updateInventoryDisplay();
                    }
                }
            },
            12: {
                text: "Inside the shack, you find signs of recent occupation. A cold fire pit, empty food tins, and a journal. The last entry reads: 'The will-o-wisps led me here. I can hear their whispers. Must resist...'",
                choices: [
                    {text: "Read more of the journal", nextSection: 32, skillCheck: false},
                    {text: "Search the shack for supplies", nextSection: 33, skillCheck: false},
                    {text: "Leave quickly - this place feels wrong", nextSection: 34, skillCheck: false}
                ]
            },
            13: {
                text: "Behind the shack, you find a small boat tied to a post. It looks seaworthy. You also notice strange glowing lights moving through the trees nearby.",
                choices: [
                    {text: "Take the boat", nextSection: 35, skillCheck: false},
                    {text: "Investigate the lights", nextSection: 36, skillCheck: false},
                    {text: "Return to the front and enter", nextSection: 12, skillCheck: false}
                ]
            },
            14: {
                text: "You continue past the shack. The boardwalk ends at a large, still pool covered in green scum. In the center is a small island with a stone ruin.",
                choices: [
                    {text: "Swim to the island", nextSection: 37, skillCheck: false},
                    {text: "Look for another way across", nextSection: 38, skillCheck: false},
                    {text: "Turn back and try another path", nextSection: 4, skillCheck: false}
                ]
            },
            15: {
                text: "You press forward. The croaking grows louder. Suddenly, giant frogs the size of dogs leap from the water onto the boardwalk! They have glowing eyes and dripping fangs.",
                choices: [
                    {text: "Fight the swamp frogs", nextSection: 39, skillCheck: false},
                    {text: "Try to scare them away with fire", nextSection: 40, skillCheck: false},
                    {text: "Run back the way you came", nextSection: 41, skillCheck: false}
                ]
            },
            16: {
                text: window.checkResult ? 
                    "You hide successfully and observe the creatures: they're giant frogs that seem to be guarding something. You spot a path around them." : 
                    "You're spotted! The frogs leap toward you aggressively!",
                choices: [
                    window.checkResult ? 
                        {text: "Take the hidden path", nextSection: 42, skillCheck: false} :
                        {text: "Prepare to fight", nextSection: 39, skillCheck: false}
                ]
            },
            17: {
                text: "You shout and bang your weapon against the boards. The croaking stops suddenly. Then a massive shape emerges from the water - a frog the size of a horse!",
                choices: [
                    {text: "Fight the giant frog", nextSection: 43, skillCheck: false},
                    {text: "Try to tame or befriend it", nextSection: 44, skillCheck: true, checkType: 'luck', difficulty: 14},
                    {text: "Run for your life", nextSection: 45, skillCheck: false}
                ]
            },
            18: {
                text: "You continue along the boardwalk until it ends at a wider, more solid path made of stone slabs. This looks like an ancient road through the swamp.",
                choices: [
                    {text: "Follow the stone path", nextSection: 46, skillCheck: false},
                    {text: "Check for traps or dangers", nextSection: 47, skillCheck: true, checkType: 'skill', difficulty: 11}
                ]
            },
            19: {
                text: "You slash at whatever has your ankle. You hit something fleshy and it lets go. You scramble onto a half-submerged log, panting. You've taken 4 damage from the struggle.",
                choices: [
                    {text: "Catch your breath, then continue", nextSection: 48, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina -= 4;
                    updateStatsDisplay();
                }
            },
            20: {
                text: "You dive down and see it's a water weed, not a creature. You easily pull free. As you surface, you spot a bubble trail leading to a cave entrance in a muddy bank.",
                choices: [
                    {text: "Investigate the cave", nextSection: 49, skillCheck: false},
                    {text: "Ignore it and continue", nextSection: 50, skillCheck: false}
                ]
            },
            21: {
                text: "You use a point of Luck and your foot comes free miraculously. You swim to a muddy island and climb out, exhausted but unharmed.",
                choices: [
                    {text: "Rest on the island", nextSection: 51, skillCheck: false}
                ],
                action: function() {
                    gameState.luck -= 1;
                    updateStatsDisplay();
                }
            },
            22: {
                text: "You attack the Drowned One in the water! Combat is difficult while waist-deep!",
                choices: [
                    {text: "Roll for attack", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    return startCombat("Drowned One", 10, 7, 53, true);
                }
            },
            23: {
                text: window.checkResult ? 
                    "You reach solid ground just as the creature grabs for you. Now you can fight it properly!" : 
                    "You slip in the mud! The creature grabs your leg and bites! You take 5 damage.",
                choices: [
                    window.checkResult ? 
                        {text: "Fight from solid ground", nextSection: 54, skillCheck: false} :
                        {text: "Fight while injured", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult) {
                        gameState.stamina -= 5;
                        updateStatsDisplay();
                    }
                }
            },
            24: {
                text: "Your screaming and flailing actually works! The Drowned One seems confused and sinks back beneath the water.",
                choices: [
                    {text: "Quickly move away", nextSection: 55, skillCheck: false}
                ]
            },
            25: {
                text: "You dive down and retrieve the chest. It's heavy! You drag it to a muddy bank and force it open. Inside: 40 Gold, a rusted but usable short sword, and a curious amulet shaped like a frog.",
                choices: [
                    {text: "Take the treasure", nextSection: 56, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 40;
                    gameState.weapons.push({name: 'Rusted Short Sword', damage: '1d6+1'});
                    gameState.inventory.push("Rusted Short Sword", "Frog Amulet");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    return "You find 40 Gold, a Rusted Short Sword (1d6+1 damage), and a Frog Amulet!";
                }
            },
            26: {
                text: "You mark the spot with a piece of cloth tied to a branch. Perhaps you'll return if you survive the swamp.",
                choices: [
                    {text: "Continue wading", nextSection: 57, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Swamp Map Marker");
                    updateInventoryDisplay();
                }
            },
            27: {
                text: "You leave the chest and continue wading. The water gets shallower ahead, and you reach a muddy shore with strange footprints.",
                choices: [
                    {text: "Follow the footprints", nextSection: 58, skillCheck: false},
                    {text: "Go around the area", nextSection: 59, skillCheck: false}
                ]
            },
            28: {
                text: window.checkResult ? 
                    "You decipher some of the symbols. It's a warning: 'Beware the Lizard King. He sleeps in the deep mud. Do not wake him.' There's also a crude map showing a safe path." : 
                    "The symbols make no sense to you, but the marker gives you an uneasy feeling.",
                choices: [
                    {text: "Continue along the ridge", nextSection: 60, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.inventory.push("Swamp Warning Marker Knowledge");
                        updateInventoryDisplay();
                    }
                }
            },
            29: {
                text: "You ignore the marker and continue. The ridge descends gradually into a area of bubbling mud pits and strange, carnivorous plants.",
                choices: [
                    {text: "Try to navigate through carefully", nextSection: 61, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Turn back and find another way", nextSection: 10, skillCheck: false}
                ]
            },
            30: {
                text: "You make a small camp. As you rest, you regain 6 Stamina. But during the night, you hear strange whispers in the swamp...",
                choices: [
                    {text: "Investigate the whispers", nextSection: 62, skillCheck: false},
                    {text: "Ignore them and try to sleep", nextSection: 63, skillCheck: true, checkType: 'luck', difficulty: 11},
                    {text: "Break camp immediately", nextSection: 64, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 6);
                    updateStatsDisplay();
                }
            },
            31: {
                text: "With your newfound swamp plants, you continue along the ridge. It leads to a clearing with a strange sight: a circle of standing stones covered in vines.",
                choices: [
                    {text: "Enter the stone circle", nextSection: 65, skillCheck: false},
                    {text: "Examine from a distance", nextSection: 66, skillCheck: false},
                    {text: "Avoid it entirely", nextSection: 67, skillCheck: false}
                ]
            },
            32: {
                text: "You read more of the journal: 'The will-o-wisps promise treasure but lead to doom. I saw one lead a traveler into quicksand yesterday. Must leave this place soon.' Under the journal, you find a silver dagger.",
                choices: [
                    {text: "Take the silver dagger and leave", nextSection: 68, skillCheck: false},
                    {text: "Search the rest of the shack", nextSection: 69, skillCheck: false},
                    {text: "Leave immediately", nextSection: 34, skillCheck: false}
                ],
                action: function() {
                    gameState.weapons.push({name: 'Silver Dagger', damage: '1d6+2'});
                    gameState.inventory.push("Silver Dagger");
                    updateInventoryDisplay();
                    return "You find a Silver Dagger (+2 damage against undead)!";
                }
            },
            33: {
                text: "You search the shack and find 20 Gold, a waterskin, and a tinderbox. You also find a map showing a safe path through part of the swamp.",
                choices: [
                    {text: "Take the supplies and leave", nextSection: 70, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 20;
                    gameState.inventory.push("Swamp Map", "Tinderbox");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                }
            },
            34: {
                text: "You leave the shack feeling uneasy. The boardwalk continues deeper into the swamp.",
                choices: [
                    {text: "Continue along the boardwalk", nextSection: 71, skillCheck: false},
                    {text: "Try a different path", nextSection: 5, skillCheck: false}
                ]
            },
            35: {
                text: "You take the boat. It's small but sturdy. You can now travel through the swamp without getting wet.",
                choices: [
                    {text: "Paddle toward the glowing lights", nextSection: 72, skillCheck: false},
                    {text: "Paddle away from the lights", nextSection: 73, skillCheck: false},
                    {text: "Return to the shack", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Small Boat");
                    updateInventoryDisplay();
                }
            },
            36: {
                text: "You approach the glowing lights cautiously. They're will-o-wisps - floating balls of light that seem to beckon you. One drifts close and you hear a faint whisper: 'Follow... treasure...'",
                choices: [
                    {text: "Follow the will-o-wisp", nextSection: 74, skillCheck: false},
                    {text: "Ignore it and return to the shack", nextSection: 12, skillCheck: false},
                    {text: "Try to capture or attack it", nextSection: 75, skillCheck: false}
                ]
            },
            37: {
                text: "You swim to the island. The water is cold and foul-smelling. As you climb onto the island, you see the ruin is actually a small stone altar. On it rests a glowing green gem.",
                choices: [
                    {text: "Take the gem", nextSection: 76, skillCheck: false},
                    {text: "Examine the altar first", nextSection: 77, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Swim back immediately", nextSection: 78, skillCheck: false}
                ]
            },
            38: {
                text: "You look for another way across and find a fallen tree that forms a natural bridge to the island.",
                choices: [
                    {text: "Cross the tree bridge", nextSection: 79, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Return to the shack", nextSection: 12, skillCheck: false}
                ]
            },
            39: {
                text: "You fight the giant swamp frogs!",
                choices: [
                    {text: "Roll for attack", nextSection: 80, skillCheck: false}
                ],
                action: function() {
                    return startCombat("Swamp Frogs", 12, 8, 81);
                }
            },
            40: {
                text: "You try to light a torch to scare the frogs, but everything is damp. The frogs seem amused by your attempts and move closer!",
                choices: [
                    {text: "Fight them", nextSection: 39, skillCheck: false},
                    {text: "Run", nextSection: 41, skillCheck: false}
                ]
            },
            41: {
                text: "You run back along the boardwalk. The frogs give chase but soon stop. You're safe but have lost your way.",
                choices: [
                    {text: "Try a different path", nextSection: 82, skillCheck: false}
                ]
            },
            42: {
                text: "You take the hidden path around the frogs. It leads to a sunken temple partially submerged in the swamp. The entrance is dark and foreboding.",
                choices: [
                    {text: "Enter the sunken temple", nextSection: 83, skillCheck: false},
                    {text: "Continue past it", nextSection: 84, skillCheck: false}
                ]
            },
            43: {
                text: "You face the giant frog! It's massive!",
                choices: [
                    {text: "Roll for attack", nextSection: 85, skillCheck: false}
                ],
                action: function() {
                    return startCombat("Giant Swamp Frog", 20, 10, 86);
                }
            },
            44: {
                text: window.checkResult ? 
                    "The giant frog seems curious rather than hostile. It croaks softly and nudges you gently with its head. It might be friendly!" : 
                    "The frog isn't interested in friendship. It attacks!",
                choices: [
                    window.checkResult ? 
                        {text: "Try to ride or befriend it", nextSection: 87, skillCheck: false} :
                        {text: "Fight it", nextSection: 43, skillCheck: false}
                ]
            },
            45: {
                text: "You run for your life! The giant frog gives chase but you manage to lose it in the thick mist. You're exhausted and have lost 3 Stamina from the panic.",
                choices: [
                    {text: "Catch your breath", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina -= 3;
                    updateStatsDisplay();
                }
            },
            46: {
                text: "You follow the stone path. It seems ancient and well-constructed. After a while, you come to a stone archway covered in moss. Beyond it, the path continues into darker parts of the swamp.",
                choices: [
                    {text: "Pass through the archway", nextSection: 89, skillCheck: false},
                    {text: "Investigate the archway", nextSection: 90, skillCheck: true, checkType: 'skill', difficulty: 13}
                ]
            },
            47: {
                text: window.checkResult ? 
                    "You spot several pressure plates on the path! You carefully avoid them." : 
                    "You trigger a trap! Poison darts shoot from the trees! You take 6 damage.",
                choices: [
                    {text: "Continue carefully", nextSection: 91, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult) {
                        gameState.stamina -= 6;
                        updateStatsDisplay();
                    }
                }
            },
            83: {
                text: "You enter the sunken temple. Inside, you find ancient murals depicting a lizard king ruling the swamp. At the center of the temple is a pedestal with the Lizard King's Crown!",
                choices: [
                    {text: "Take the crown", nextSection: 92, skillCheck: false},
                    {text: "Study the murals first", nextSection: 93, skillCheck: false}
                ]
            },
            92: {
                text: "As you take the crown, the temple rumbles! The Lizard King's mummy awakens!",
                choices: [
                    {text: "Fight the Lizard King", nextSection: 94, skillCheck: false},
                    {text: "Try to use the crown to control it", nextSection: 95, skillCheck: true, checkType: 'luck', difficulty: 15}
                ]
            },
            94: {
                text: "You battle the ancient Lizard King!",
                choices: [
                    {text: "Roll for attack", nextSection: 96, skillCheck: false}
                ],
                action: function() {
                    return startCombat("Lizard King Mummy", 25, 14, 97);
                }
            },
            97: {
                text: "You defeat the Lizard King! With his crown in hand, you feel a strange power. The swamp seems less hostile now.",
                choices: [
                    {text: "Leave the temple with the crown", nextSection: 98, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 100;
                    gameState.inventory.push("Lizard King's Crown");
                    gameState.skill += 1;
                    updateStatsDisplay();
                    updateInventoryDisplay();
                }
            },
            98: {
                text: "With the Lizard King's Crown, you command respect from the swamp creatures. They clear a path for you, and you easily navigate to the far side of the swamp. You've reached the edge!",
                choices: [
                    {text: "Exit the Swamp of Sorrows", nextSection: 200, skillCheck: false}
                ]
            },
            // VICTORY SECTION - Player completes the level
            200: {
                text: "After many trials in the Swamp of Sorrows, you finally reach the far side. The foul bog gives way to solid ground, and ahead you see the dark silhouette of BLOODSTONE KEEP against the crimson sky. You have survived Level 3!",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-skill').textContent = gameState.skill;
                    document.getElementById('next-stat-stamina').textContent = gameState.stamina;
                    document.getElementById('next-stat-luck').textContent = gameState.luck;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    return "You've completed Level 3: Swamp of Sorrows!";
                }
            }
        };
        
        // Initialize game
        function initGame() {
            updateStatsDisplay();
            updateInventoryDisplay();
            
            // If we have a current section from saved game, load it
            if (gameState.currentSection > 0 && storySections[gameState.currentSection]) {
                loadSection(gameState.currentSection);
            } else {
                loadSection(0);
            }
        }
        
        // Show warning dialog for new game
        function showNewGameWarning() {
            document.getElementById('screen-game').classList.remove('active-screen');
            document.getElementById('warning-dialog').classList.add('active-screen');
        }
        
        // Cancel new game and return to game screen
        function cancelNewGame() {
            document.getElementById('warning-dialog').classList.remove('active-screen');
            document.getElementById('screen-game').classList.add('active-screen');
        }
        
        // Start new game - reset everything
        function startNewGame() {
            localStorage.removeItem('dreadwoodGameState');
            gameState = {
                playerClass: '',
                skill: 0,
                maxStamina: 0,
                stamina: 0,
                luck: 0,
                gold: 0,
                inventory: [],
                weapons: [],
                armor: [],
                currentWeaponIndex: 0,
                currentArmorIndex: 0,
                currentSection: 0,
                gameComplete: false
            };
            window.location.href = 'level1.html';
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-skill').textContent = gameState.skill;
            document.getElementById('stat-stamina').textContent = gameState.stamina;
            document.getElementById('stat-maxstamina').textContent = gameState.maxStamina;
            document.getElementById('stat-luck').textContent = gameState.luck;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Show current equipped weapon
            if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                const weapon = gameState.weapons[gameState.currentWeaponIndex];
                const weaponSpan = document.createElement('span');
                weaponSpan.className = 'inventory-item';
                weaponSpan.id = 'inv-weapon';
                weaponSpan.textContent = `${weapon.name} (${weapon.damage})`;
                inventoryDiv.appendChild(weaponSpan);
            }
            
            // Show current equipped armor
            if (gameState.armor && gameState.armor.length > 0 && gameState.currentArmorIndex >= 0) {
                const armor = gameState.armor[gameState.currentArmorIndex];
                const armorSpan = document.createElement('span');
                armorSpan.className = 'inventory-item';
                armorSpan.id = 'inv-armor';
                armorSpan.textContent = `${armor.name} (${armor.defense} DEF)`;
                inventoryDiv.appendChild(armorSpan);
            }
            
            // Show gold
            const goldSpan = document.createElement('span');
            goldSpan.className = 'inventory-item';
            goldSpan.textContent = `${gameState.gold} Gold`;
            inventoryDiv.appendChild(goldSpan);
            
            // Show other inventory items
            if (gameState.inventory) {
                gameState.inventory.forEach(item => {
                    // Don't show items that are currently equipped as weapons/armor
                    const isCurrentWeapon = gameState.weapons[gameState.currentWeaponIndex] && 
                        gameState.weapons[gameState.currentWeaponIndex].name === item;
                    const isCurrentArmor = gameState.armor[gameState.currentArmorIndex] && 
                        gameState.armor[gameState.currentArmorIndex].name === item;
                    
                    if (!isCurrentWeapon && !isCurrentArmor) {
                        const itemSpan = document.createElement('span');
                        itemSpan.className = 'inventory-item';
                        itemSpan.textContent = item;
                        inventoryDiv.appendChild(itemSpan);
                    }
                });
            }
        }
        
        // Load story section
        function loadSection(sectionId) {
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p>Your adventure in the Swamp of Sorrows continues... The path ahead is unclear.</p>";
                document.getElementById('choice-buttons').innerHTML = `
                    <button class="choice-btn" onclick="loadSection(0)">Return to Swamp Edge</button>
                `;
                return;
            }
            
            let storyText = section.text;
            
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p>";
            
            const choiceButtons = document.getElementById('choice-buttons');
            choiceButtons.innerHTML = '';
            
            section.choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = choice.text;
                button.onclick = function() {
                    if (choice.skillCheck) {
                        performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                    } else {
                        loadSection(choice.nextSection);
                    }
                };
                choiceButtons.appendChild(button);
            });
            
            saveGame();
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            const diceRoll = rollDiceHelper(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Start combat
        function startCombat(enemyName, enemyStamina, enemySkill, nextSection, inWater = false) {
            const playerAttack = rollDiceHelper(2, 6) + gameState.skill;
            const enemyAttack = rollDiceHelper(2, 6) + enemySkill;
            
            let resultText = `<span class="enemy">BATTLE: ${enemyName}</span> (Skill: ${enemySkill}, Stamina: ${enemyStamina})<br>`;
            if (inWater) resultText += `<span class="poison">[Fighting in water: -1 to damage]</span><br>`;
            resultText += `You attack with ${playerAttack} vs enemy's ${enemyAttack}.<br>`;
            
            if (playerAttack > enemyAttack) {
                // Calculate damage based on current equipped weapon
                let damage = 0;
                if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                    const weapon = gameState.weapons[gameState.currentWeaponIndex];
                    if (weapon.damage === '1d6') damage = rollDiceHelper(1, 6);
                    else if (weapon.damage === '1d6+1') damage = rollDiceHelper(1, 6) + 1;
                    else if (weapon.damage === '1d6+2') damage = rollDiceHelper(1, 6) + 2;
                    else if (weapon.damage === '2d4') damage = rollDiceHelper(2, 4);
                    else if (weapon.damage === '2d6') damage = rollDiceHelper(2, 6);
                    else if (weapon.damage === '3d6') damage = rollDiceHelper(3, 6);
                    else damage = rollDiceHelper(1, 6);
                } else {
                    damage = rollDiceHelper(1, 6);
                }
                
                if (inWater) damage = Math.max(1, damage - 1);
                
                resultText += `<span class="success">You hit for ${damage} damage!</span>`;
                
                if (enemyStamina - damage <= 0) {
                    resultText += `<br><span class="success">You defeated the ${enemyName}!</span>`;
                    const goldReward = Math.floor(Math.random() * 30) + 10;
                    gameState.gold += goldReward;
                    resultText += `<br>You find ${goldReward} Gold.`;
                } else {
                    enemyStamina -= damage;
                    resultText += `<br>The ${enemyName} has ${enemyStamina} Stamina remaining.`;
                    const enemyDamage = rollDiceHelper(1, 6);
                    gameState.stamina -= enemyDamage;
                    resultText += `<br><span class="damage">The ${enemyName} hits back for ${enemyDamage} damage!</span>`;
                }
            } else if (playerAttack < enemyAttack) {
                const damage = rollDiceHelper(1, 6);
                gameState.stamina -= damage;
                resultText += `<span class="damage">You are hit for ${damage} damage!</span>`;
            } else {
                resultText += "The attacks cancel each other out!";
            }
            
            updateStatsDisplay();
            
            if (gameState.stamina <= 0) {
                resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                setTimeout(() => {
                    localStorage.removeItem('dreadwoodGameState');
                    location.reload();
                }, 3000);
            }
            
            if (storySections[nextSection]) {
                storySections[nextSection].text = resultText;
            }
            
            return resultText;
        }
        
        // Use Luck
        function useLuck() {
            if (gameState.luck <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Luck left!</div>`;
                return;
            }
            
            const diceRoll = rollDiceHelper(2, 6);
            const success = diceRoll <= gameState.luck;
            
            gameState.luck -= 1;
            updateStatsDisplay();
            
            let resultText = `You test your Luck... Roll: ${diceRoll}, Luck: ${gameState.luck + 1}. `;
            resultText += success ? 
                `<span class="success">Lucky!</span> Something good happens.` : 
                `<span class="damage">Unlucky!</span> Something bad happens.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                const goodEffects = [
                    "You find 10 Gold in the mud!",
                    "You avoid a patch of poisonous gas!",
                    "A friendly swamp creature guides you to safer ground.",
                    "You discover a healing spring! Restore 6 Stamina.",
                    "You find a better path through the swamp."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Gold")) {
                    gameState.gold += 10;
                } else if (effect.includes("Stamina")) {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 6);
                }
            } else {
                const badEffects = [
                    "You step in quicksand! Lose 4 Stamina escaping.",
                    "You're bitten by swamp insects! Take 3 damage and lose 1 Luck.",
                    "You get lost in the mist. Valuable time is wasted.",
                    "Your food supply is spoiled by swamp water.",
                    "You attract the attention of something large and hungry..."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Stamina")) {
                    gameState.stamina -= 4;
                } else if (effect.includes("3 damage")) {
                    gameState.stamina -= 3;
                    gameState.luck = Math.max(0, gameState.luck - 1);
                }
                
                if (gameState.stamina <= 0) {
                    document.getElementById('story-text').innerHTML += `<div class="game-over">You have been defeated! Game Over.</div>`;
                    setTimeout(() => {
                        localStorage.removeItem('dreadwoodGameState');
                        location.reload();
                    }, 3000);
                }
            }
            
            updateStatsDisplay();
            updateInventoryDisplay();
        }
        
        // Check inventory
        function checkInventory() {
            let inventoryText = "<h3>Your Inventory:</h3>";
            
            // Show current equipped weapon
            if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                const weapon = gameState.weapons[gameState.currentWeaponIndex];
                inventoryText += `<p><strong>Equipped Weapon:</strong> ${weapon.name} (${weapon.damage} damage)</p>`;
            }
            
            // Show all available weapons
            inventoryText += "<p><strong>Available Weapons:</strong><br>";
            gameState.weapons.forEach((weapon, index) => {
                const isEquipped = index === gameState.currentWeaponIndex;
                inventoryText += `${isEquipped ? " " : ""}${weapon.name} (${weapon.damage})`;
                if (!isEquipped) {
                    inventoryText += ` <button onclick="equipWeapon(${index})" style="font-size:10px; padding:2px 5px;">Equip</button>`;
                }
                inventoryText += "<br>";
            });
            inventoryText += "</p>";
            
            // Show all armor
            inventoryText += "<p><strong>Armor:</strong><br>";
            gameState.armor.forEach((armor, index) => {
                const isEquipped = index === gameState.currentArmorIndex;
                inventoryText += `${isEquipped ? " " : ""}${armor.name} (${armor.defense} DEF)`;
                if (!isEquipped) {
                    inventoryText += ` <button onclick="equipArmor(${index})" style="font-size:10px; padding:2px 5px;">Equip</button>`;
                }
                inventoryText += "<br>";
            });
            inventoryText += "</p>";
            
            inventoryText += `<p><strong>Gold:</strong> ${gameState.gold}</p>`;
            
            // Show other items
            if (gameState.inventory && gameState.inventory.length > 0) {
                inventoryText += `<p><strong>Other Items:</strong> `;
                const otherItems = gameState.inventory.filter(item => {
                    // Don't show items that are weapons/armor
                    const isWeapon = gameState.weapons.some(w => w.name === item);
                    const isArmor = gameState.armor.some(a => a.name === item);
                    return !isWeapon && !isArmor;
                });
                inventoryText += otherItems.join(', ') || 'None';
                inventoryText += `</p>`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${inventoryText}</div>`;
        }
        
        // Equip weapon function
        function equipWeapon(index) {
            if (index >= 0 && index < gameState.weapons.length) {
                gameState.currentWeaponIndex = index;
                updateInventoryDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped ${gameState.weapons[index].name}!</div>`;
                saveGame();
            }
        }
        
        // Equip armor function
        function equipArmor(index) {
            if (index >= 0 && index < gameState.armor.length) {
                gameState.currentArmorIndex = index;
                updateInventoryDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped ${gameState.armor[index].name}!</div>`;
                saveGame();
            }
        }
        
        // Save game
        function saveGame() {
            // Ensure indices are valid before saving
            if (gameState.currentWeaponIndex >= gameState.weapons.length) {
                gameState.currentWeaponIndex = gameState.weapons.length - 1;
            }
            if (gameState.currentArmorIndex >= gameState.armor.length) {
                gameState.currentArmorIndex = gameState.armor.length - 1;
            }
            
            localStorage.setItem('dreadwoodGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">Game saved!</div>`;
        }
        
        // Go to next level
        function goToNextLevel() {
            // Save game state for level 4
            localStorage.setItem('dreadwoodGameState', JSON.stringify(gameState));
            // Redirect to level 4
            window.location.href = 'level4.html';
        }
        
        // Utility function to roll dice
        function rollDiceHelper(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
    </script>
</body>
</html>
