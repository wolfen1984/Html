<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DreadWood: Swamp of Sorrows</title>
    <style>
        /* SAME STYLE as previous levels with swamp theme colors */
        body {
            font-family: 'Courier New', monospace;
            background-color: #0a1a0a;
            color: #33ff33;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            border: 2px solid #33ff33;
            background-color: #000;
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #33ff33;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #33ff99;
            text-shadow: 0 0 5px #33ff99;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
        }
        
        h2 {
            color: #33ccff;
            border-bottom: 1px solid #33ccff;
            padding-bottom: 5px;
            margin-top: 25px;
        }
        
        .screen {
            display: none;
        }
        
        .active-screen {
            display: block;
        }
        
        .stats-bar {
            background-color: #112211;
            border: 1px solid #33ff33;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-value {
            color: #ffff33;
            font-weight: bold;
        }
        
        .inventory {
            background-color: #112211;
            border: 1px solid #33ff99;
            padding: 10px;
            margin: 15px 0;
            min-height: 60px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #223322;
            border: 1px solid #33ccff;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
        }
        
        .story-text {
            background-color: #111111;
            border: 1px solid #33ff33;
            padding: 15px;
            margin: 20px 0;
            min-height: 150px;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #223322;
            color: #33ff33;
            border: 2px solid #33ff33;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #335533;
            color: #ffff33;
            border-color: #ffff33;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #003322;
            color: #33ff99;
            border: 2px solid #33ff99;
            padding: 10px 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #005544;
            color: #99ffcc;
        }
        
        .dice-roll {
            background-color: #223322;
            border: 1px solid #33ff33;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ffff33;
        }
        
        .game-over {
            color: #ff3333;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #ff3333;
        }
        
        .success {
            color: #33ff33;
            font-weight: bold;
        }
        
        .damage {
            color: #ff3333;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9933;
            font-weight: bold;
        }
        
        .poison {
            color: #9933ff;
            font-weight: bold;
        }
        
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #003333;
            color: #33ff99;
            border: 2px solid #33ff99;
            padding: 15px 30px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #005555;
            color: #99ffcc;
        }
        
        .retro-notice {
            text-align: center;
            color: #888888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333333;
            padding-top: 10px;
        }
        
        .warning-dialog {
            background-color: #332222;
            border: 2px solid #ff3333;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .warning-text {
            color: #ff9933;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .dialog-btn {
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid;
        }
        
        .dialog-btn-yes {
            background-color: #223322;
            color: #33ff33;
            border-color: #33ff33;
        }
        
        .dialog-btn-no {
            background-color: #332222;
            color: #ff3333;
            border-color: #ff3333;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 10px;
                font-size: 14px;
            }
            
            .dialog-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DREADWOOD</h1>
            <h2>SWAMP OF SORROWS</h2>
            <div class="retro-notice">Level 3 - Your Adventure Continues</div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item">SKILL: <span id="stat-skill" class="stat-value">0</span></div>
                <div class="stat-item">STAMINA: <span id="stat-stamina" class="stat-value">0</span>/<span id="stat-maxstamina" class="stat-value">0</span></div>
                <div class="stat-item">LUCK: <span id="stat-luck" class="stat-value">0</span></div>
                <div class="stat-item">GOLD: <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <h2>INVENTORY</h2>
            <div class="inventory" id="inventory">
                <!-- Inventory will be loaded from saved game -->
            </div>
            
            <h2>THE ADVENTURE</h2>
            <div class="story-text" id="story-text">
                <p>Before you stretches the SWAMP OF SORROWS - a vast, mist-shrouded bog that reeks of decay and despair. Gnarled trees rise from murky waters, their branches like skeletal fingers clutching at the grey sky. Strange cries echo through the mist. You must cross this forsaken place to reach BLOODSTONE KEEP.</p>
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <button class="choice-btn" onclick="loadSection(1)">Follow the Overgrown Path</button>
                <button class="choice-btn" onclick="loadSection(2)">Wade Through the Murky Waters</button>
                <button class="choice-btn" onclick="loadSection(3)">Search for Dry Ground</button>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useLuck()">TEST LUCK</button>
                <button class="action-btn" onclick="checkInventory()">INVENTORY</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="showNewGameWarning()">START NEW GAME</button>
            </div>
        </div>
        
        <!-- Warning Dialog for New Game -->
        <div id="warning-dialog" class="screen">
            <div class="warning-dialog">
                <div class="warning-text">WARNING: Starting a new game will delete ALL your current progress!</div>
                <p>Your current character, stats, inventory, and gold will be permanently erased.</p>
                <p>You will return to the beginning of the game to create a new character.</p>
                <div class="dialog-buttons">
                    <button class="dialog-btn dialog-btn-yes" onclick="startNewGame()">YES, START NEW GAME</button>
                    <button class="dialog-btn dialog-btn-no" onclick="cancelNewGame()">NO, KEEP MY CHARACTER</button>
                </div>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>VICTORY!</h2>
            <div class="story-text">
                <p>You have survived the SWAMP OF SORROWS!</p>
                <p>After battling swamp creatures, avoiding poisonous plants, and navigating treacherous waters, you finally reach solid ground. In the distance, the ominous silhouette of BLOODSTONE KEEP stands against the darkening sky.</p>
                <p>Your journey continues... All your stats, gold, and inventory will carry over to the next chapter.</p>
                <div class="stats-bar">
                    <div class="stat-item">SKILL: <span id="next-stat-skill" class="stat-value">0</span></div>
                    <div class="stat-item">STAMINA: <span id="next-stat-stamina" class="stat-value">0</span></div>
                    <div class="stat-item">LUCK: <span id="next-stat-luck" class="stat-value">0</span></div>
                    <div class="stat-item">GOLD: <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO BLOODSTONE KEEP</button>
            </div>
        </div>
        
        <div class="retro-notice">
            DREADWOOD - A Retro Gamebook Adventure<br>
            Level 3: Swamp of Sorrows
        </div>
    </div>

    <script>
        // Game state (loaded from localStorage)
        let gameState = JSON.parse(localStorage.getItem('dreadwoodGameState')) || {
            playerClass: 'warrior',
            skill: 10,
            maxStamina: 18,
            stamina: 18,
            luck: 10,
            gold: 50,
            inventory: ['Dagger', 'Leather Armor'],
            weapons: [{name: 'Dagger', damage: '1d6'}],
            armor: [{name: 'Leather Armor', defense: 1}],
            currentSection: 0,
            gameComplete: false
        };
        
        // Track swamp-specific conditions
        let swampConditions = {
            poisoned: false,
            lost: false,
            foundBoat: false,
            hasTorch: false
        };
        
        // Level 3 story sections - SWAMP OF SORROWS
        const storySections = {
            0: {
                text: "Before you stretches the SWAMP OF SORROWS - a vast, mist-shrouded bog that reeks of decay and despair. Gnarled trees rise from murky waters, their branches like skeletal fingers clutching at the grey sky. Strange cries echo through the mist. You must cross this forsaken place to reach BLOODSTONE KEEP.",
                choices: [
                    {text: "Follow the overgrown path along the swamp's edge", nextSection: 1, skillCheck: false},
                    {text: "Wade through the murky waters to take a direct route", nextSection: 2, skillCheck: false},
                    {text: "Search for higher, dry ground to navigate from", nextSection: 3, skillCheck: false}
                ]
            },
            1: {
                text: "You follow a narrow, overgrown path that skirts the swamp's edge. The ground is soft and squelches underfoot. Ahead, you see a rickety wooden bridge spanning a particularly foul-looking section of water.",
                choices: [
                    {text: "Cross the rickety bridge", nextSection: 4, skillCheck: true, checkType: 'luck', difficulty: 10},
                    {text: "Try to find a way around the bridge", nextSection: 5, skillCheck: false},
                    {text: "Turn back and try a different route", nextSection: 0, skillCheck: false}
                ]
            },
            2: {
                text: "You wade into the murky, chest-deep water. It's cold and smells of rot. Strange shapes move beneath the surface. About fifty feet in, you realize the water is getting deeper.",
                choices: [
                    {text: "Continue wading forward", nextSection: 6, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Swim instead of wade", nextSection: 7, skillCheck: false},
                    {text: "Turn back to solid ground", nextSection: 0, skillCheck: false}
                ]
            },
            3: {
                text: "You search for higher ground and find a moss-covered hillock that provides a better view. From here, you can see several possible routes through the swamp.",
                choices: [
                    {text: "Head toward what looks like an ancient stone path", nextSection: 8, skillCheck: false},
                    {text: "Make for a cluster of large trees that might provide cover", nextSection: 9, skillCheck: false},
                    {text: "Follow the flight of large birds heading northwest", nextSection: 10, skillCheck: false}
                ]
            },
            4: {
                text: "You attempt to cross the rickety bridge...",
                choices: [
                    {text: "Continue", nextSection: 11, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "The bridge holds! You cross safely to the other side.";
                    } else {
                        gameState.stamina -= 5;
                        updateStatsDisplay();
                        return "The bridge collapses beneath you! You fall into the foul water, taking 5 damage from the impact and swallowing some of the nasty liquid.";
                    }
                }
            },
            5: {
                text: "You try to find a way around the bridge. After some searching, you discover what looks like an animal trail through dense undergrowth.",
                choices: [
                    {text: "Follow the animal trail", nextSection: 12, skillCheck: false},
                    {text: "Return to the bridge and reconsider", nextSection: 1, skillCheck: false}
                ]
            },
            6: {
                text: "You continue wading through the deepening water...",
                choices: [
                    {text: "Continue", nextSection: 13, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "You navigate the deep water successfully, finding a submerged log to help you cross a particularly deep section.";
                    } else {
                        swampConditions.poisoned = true;
                        gameState.stamina -= 4;
                        updateStatsDisplay();
                        return "You step into a deep hole and go under! You swallow foul water and emerge coughing. You feel sick and take 4 damage from the experience.";
                    }
                }
            },
            7: {
                text: "You decide to swim instead of wade. The water is easier to move through, but something brushes against your leg...",
                choices: [
                    {text: "Swim faster", nextSection: 14, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Stop and investigate", nextSection: 15, skillCheck: false},
                    {text: "Return to wading", nextSection: 2, skillCheck: false}
                ]
            },
            8: {
                text: "You make your way toward the ancient stone path. The stones are slick with algae but mostly above water. As you walk, you notice strange carvings on some of the stones.",
                choices: [
                    {text: "Examine the carvings", nextSection: 16, skillCheck: false},
                    {text: "Ignore them and continue", nextSection: 17, skillCheck: false},
                    {text: "Follow the path in the opposite direction", nextSection: 18, skillCheck: false}
                ]
            },
            9: {
                text: "You head toward the cluster of large trees. As you approach, you realize they're ancient willows with branches that touch the water. Between them hangs a thick mist.",
                choices: [
                    {text: "Enter the willow grove", nextSection: 19, skillCheck: false},
                    {text: "Circle around the grove", nextSection: 20, skillCheck: false},
                    {text: "Climb one of the willows for a better view", nextSection: 21, skillCheck: true, checkType: 'skill', difficulty: 13}
                ]
            },
            10: {
                text: "You follow the large birds. They lead you to a relatively dry island with the remains of a campsite. There's a partially sunken boat tied to a tree.",
                choices: [
                    {text: "Investigate the campsite", nextSection: 22, skillCheck: false},
                    {text: "Examine the boat", nextSection: 23, skillCheck: false},
                    {text: "Continue following the birds", nextSection: 24, skillCheck: false}
                ]
            },
            11: {
                text: window.checkResult ? 
                    "You safely cross the bridge and find yourself on a slightly drier path that seems well-traveled." : 
                    "You climb out of the water on the far side of the bridge, soaked and injured.",
                choices: [
                    {text: "Follow the dry path", nextSection: 25, skillCheck: false}
                ]
            },
            12: {
                text: "The animal trail winds through thick brush. You hear growling ahead. A large swamp wolf emerges from the undergrowth, its fur matted and eyes glowing with hunger.",
                choices: [
                    {text: "Fight the swamp wolf", nextSection: 26, skillCheck: false},
                    {text: "Try to scare it away", nextSection: 27, skillCheck: true, checkType: 'luck', difficulty: 11},
                    {text: "Climb a tree to escape", nextSection: 28, skillCheck: true, checkType: 'skill', difficulty: 10}
                ]
            },
            13: {
                text: window.checkResult ? 
                    "Using the submerged log, you cross to a muddy island with several strange plants growing on it." : 
                    "Feeling sick from the foul water, you struggle to a muddy island to rest.",
                choices: [
                    {text: "Examine the strange plants", nextSection: 29, skillCheck: false},
                    {text: "Rest on the island", nextSection: 30, skillCheck: false},
                    {text: "Continue through the water", nextSection: 31, skillCheck: false}
                ]
            },
            14: {
                text: "You swim faster, trying to escape whatever brushed against you...",
                choices: [
                    {text: "Continue", nextSection: 32, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "You outswim the creature and reach a muddy bank safely.";
                    } else {
                        gameState.stamina -= 6;
                        updateStatsDisplay();
                        return "The creature grabs your leg! It's a swamp eel with razor-sharp teeth. You kick free, but not before taking 6 damage.";
                    }
                }
            },
            15: {
                text: "You stop swimming and look beneath the murky water. A pale, humanoid face stares back at you before disappearing!",
                choices: [
                    {text: "Dive down to investigate", nextSection: 33, skillCheck: false},
                    {text: "Swim away as fast as you can", nextSection: 34, skillCheck: false},
                    {text: "Prepare for combat", nextSection: 35, skillCheck: false}
                ]
            },
            16: {
                text: "The carvings are ancient and worn, but you can make out images of serpent-men worshipping a giant lizard. One carving shows a treasure chamber deep in the swamp.",
                choices: [
                    {text: "Follow the path in the direction indicated by the carvings", nextSection: 36, skillCheck: false},
                    {text: "Ignore the carvings and continue your original way", nextSection: 17, skillCheck: false},
                    {text: "Make a rubbing of the carvings to study later", nextSection: 37, skillCheck: false}
                ]
            },
            17: {
                text: "You ignore the carvings and continue along the stone path. It leads you to a circular clearing with a stone altar in the center. The altar is stained dark and has iron manacles attached.",
                choices: [
                    {text: "Examine the altar", nextSection: 38, skillCheck: false},
                    {text: "Quickly leave the clearing", nextSection: 39, skillCheck: false},
                    {text: "Search the area around the altar", nextSection: 40, skillCheck: false}
                ]
            },
            18: {
                text: "You follow the path in the opposite direction. It gradually descends into deeper water until you're wading again. Ahead, you see bubbles rising to the surface.",
                choices: [
                    {text: "Investigate the bubbles", nextSection: 41, skillCheck: false},
                    {text: "Avoid the bubbles and go around", nextSection: 42, skillCheck: false},
                    {text: "Throw something at the bubbles", nextSection: 43, skillCheck: false}
                ]
            },
            19: {
                text: "You enter the willow grove. The mist is thick here, and the light dim. You hear whispers in the rustling leaves. Shapes seem to move just at the edge of your vision.",
                choices: [
                    {text: "Call out to whoever might be there", nextSection: 44, skillCheck: false},
                    {text: "Draw your weapon and proceed cautiously", nextSection: 45, skillCheck: false},
                    {text: "Try to find the source of the whispers", nextSection: 46, skillCheck: true, checkType: 'luck', difficulty: 12}
                ]
            },
            20: {
                text: "You circle around the willow grove. The ground here is firmer, and you make good progress until you come to a wide channel of deep, fast-moving water.",
                choices: [
                    {text: "Try to swim across", nextSection: 47, skillCheck: false},
                    {text: "Look for a crossing point", nextSection: 48, skillCheck: false},
                    {text: "Build a raft from nearby materials", nextSection: 49, skillCheck: true, checkType: 'skill', difficulty: 14}
                ]
            },
            21: {
                text: "You attempt to climb one of the willows for a better view...",
                choices: [
                    {text: "Continue", nextSection: 50, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "You climb high enough to see over the mist. To the northwest, you spot what looks like solid ground and possibly a structure! To the east, you see shimmering lights over the water.";
                    } else {
                        gameState.stamina -= 3;
                        updateStatsDisplay();
                        return "You slip and fall from the tree, taking 3 damage. From the ground, you notice something glinting in the mud where you landed.";
                    }
                }
            },
            22: {
                text: "The campsite is old but not ancient. You find the remains of a fire, some rusted cooking implements, and a waterlogged journal. The last entry reads: 'The whispers are getting louder. Jenkins disappeared last night. We're leaving the boat and trying for high ground.'",
                choices: [
                    {text: "Read more of the journal", nextSection: 51, skillCheck: false},
                    {text: "Search for supplies", nextSection: 52, skillCheck: false},
                    {text: "Take the journal and continue", nextSection: 53, skillCheck: false}
                ]
            },
            23: {
                text: "The boat is old but appears seaworthy if bailed out. It's a small rowboat with one oar still inside.",
                choices: [
                    {text: "Bail out the boat and use it", nextSection: 54, skillCheck: false},
                    {text: "Search the boat for supplies", nextSection: 55, skillCheck: false},
                    {text: "Leave the boat and continue on foot", nextSection: 56, skillCheck: false}
                ]
            },
            24: {
                text: "You continue following the birds. They lead you to a tall, dead tree covered in nests. At the base of the tree, you find bones and several shiny objects.",
                choices: [
                    {text: "Examine the bones", nextSection: 57, skillCheck: false},
                    {text: "Collect the shiny objects", nextSection: 58, skillCheck: false},
                    {text: "Climb the tree to see the nests", nextSection: 59, skillCheck: false}
                ]
            },
            25: {
                text: "The dry path leads to a hut built on stilts over the water. Smoke rises from a chimney, and a dim light glows in the window.",
                choices: [
                    {text: "Approach the hut cautiously", nextSection: 60, skillCheck: false},
                    {text: "Call out to whoever lives there", nextSection: 61, skillCheck: false},
                    {text: "Avoid the hut and continue past", nextSection: 62, skillCheck: false}
                ]
            },
            26: {
                text: "You face the swamp wolf! Roll for combat!",
                choices: [
                    {text: "Roll for attack", nextSection: 63, skillCheck: false}
                ],
                action: function() {
                    return startCombat("Swamp Wolf", 14, 9, 64);
                }
            },
            27: {
                text: "You attempt to scare the wolf away...",
                choices: [
                    {text: "Continue", nextSection: 65, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "The wolf snarls but backs away, disappearing into the undergrowth. You continue along the trail.";
                    } else {
                        gameState.stamina -= 4;
                        updateStatsDisplay();
                        return "The wolf isn't scared! It attacks, biting your arm before you drive it off with your weapon. You take 4 damage.";
                    }
                }
            },
            28: {
                text: "You attempt to climb a tree to escape the wolf...",
                choices: [
                    {text: "Continue", nextSection: 66, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "You scramble up the tree just as the wolf leaps. It circles below for a while before giving up and leaving.";
                    } else {
                        gameState.stamina -= 5;
                        updateStatsDisplay();
                        return "You slip while climbing! The wolf bites your leg before you manage to kick it away and climb higher. You take 5 damage.";
                    }
                }
            },
            29: {
                text: "The plants on the island are strange indeed. Some glow with a faint blue light. Others have pods that pulse rhythmically. One plant has beautiful red flowers that smell sweet.",
                choices: [
                    {text: "Collect some glowing plants", nextSection: 67, skillCheck: false},
                    {text: "Examine the pulsing pods", nextSection: 68, skillCheck: false},
                    {text: "Pick the red flowers", nextSection: 69, skillCheck: false},
                    {text: "Leave the plants alone and rest", nextSection: 30, skillCheck: false}
                ]
            },
            30: {
                text: "You rest on the island, recovering some strength. While resting, you notice something metallic glinting in the mud nearby.",
                choices: [
                    {text: "Investigate the glinting object", nextSection: 70, skillCheck: false},
                    {text: "Continue through the swamp", nextSection: 31, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 4);
                    updateStatsDisplay();
                    return "You rest and recover 4 Stamina.";
                }
            },
            31: {
                text: "You leave the island and continue wading through the swamp. The water gets shallower ahead, and you can see a line of trees marking what might be the swamp's edge.",
                choices: [
                    {text: "Head for the trees", nextSection: 71, skillCheck: false},
                    {text: "Follow a stream of clearer water", nextSection: 72, skillCheck: false}
                ]
            },
            32: {
                text: window.checkResult ? 
                    "You reach a muddy bank and pull yourself out of the water, safe from whatever was chasing you." : 
                    "You escape the eel and reach a muddy bank, wounded but alive.",
                choices: [
                    {text: "Explore the area", nextSection: 73, skillCheck: false}
                ]
            },
            33: {
                text: "You take a deep breath and dive beneath the murky water. The face you saw belongs to a statue! It's part of a sunken temple or shrine.",
                choices: [
                    {text: "Explore the sunken structure", nextSection: 74, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Surface and swim away", nextSection: 34, skillCheck: false}
                ]
            },
            34: {
                text: "You swim away as fast as you can. After what feels like an eternity, you reach a mudflat where you can stand again.",
                choices: [
                    {text: "Catch your breath", nextSection: 75, skillCheck: false},
                    {text: "Immediately continue moving", nextSection: 76, skillCheck: false}
                ]
            },
            35: {
                text: "You draw your weapon, ready for combat. The pale face emerges from the water attached to a slimy, humanoid body with webbed hands and feet. It's a Swamp Ghoul!",
                choices: [
                    {text: "Attack the Swamp Ghoul", nextSection: 77, skillCheck: false},
                    {text: "Try to communicate with it", nextSection: 78, skillCheck: true, checkType: 'luck', difficulty: 14},
                    {text: "Swim away while keeping it in sight", nextSection: 79, skillCheck: false}
                ]
            },
            // VICTORY SECTION - Player completes the swamp
            200: {
                text: "After hours of treacherous travel through the Swamp of Sorrows, you finally reach solid ground. The foul mists recede behind you, and ahead rises the ominous silhouette of BLOODSTONE KEEP. You've survived Level 3!",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-skill').textContent = gameState.skill;
                    document.getElementById('next-stat-stamina').textContent = gameState.stamina;
                    document.getElementById('next-stat-luck').textContent = gameState.luck;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Clear swamp conditions
                    swampConditions.poisoned = false;
                    swampConditions.lost = false;
                    
                    return "You've completed Level 3: Swamp of Sorrows!";
                }
            }
        };
        
        // Add more sections to reach victory
        storySections[36] = {text: "Following the carving's direction leads you to a dry path out of the swamp!", choices: [{text: "Follow the path to safety", nextSection: 200, skillCheck: false}]};
        storySections[37] = {text: "You make a rubbing of the carvings. They might be valuable to scholars.", choices: [{text: "Continue along the path", nextSection: 17, skillCheck: false}], action: function() { gameState.inventory.push("Ancient Carving Rubbing"); updateInventoryDisplay(); }};
        storySections[38] = {text: "The altar is ancient and stained with what looks like old blood. You find a ceremonial dagger made of black stone lodged in a crack.", choices: [{text: "Take the dagger", nextSection: 80, skillCheck: false}, {text: "Leave it", nextSection: 39, skillCheck: false}]};
        storySections[39] = {text: "You quickly leave the clearing and find a game trail that leads northwest.", choices: [{text: "Follow the trail", nextSection: 81, skillCheck: false}]};
        storySections[40] = {text: "Searching around the altar, you find a hidden compartment with 50 Gold and a map showing a safe route through the swamp!", choices: [{text: "Take the treasure and follow the map", nextSection: 200, skillCheck: false}], action: function() { gameState.gold += 50; gameState.inventory.push("Swamp Map"); updateStatsDisplay(); updateInventoryDisplay(); }};
        storySections[41] = {text: "The bubbles are coming from a hot spring! The water is warm and clean here.", choices: [{text: "Rest in the hot spring", nextSection: 82, skillCheck: false}, {text: "Continue", nextSection: 42, skillCheck: false}]};
        storySections[42] = {text: "You avoid the bubbles and find a narrow land bridge crossing the deep water.", choices: [{text: "Cross the land bridge", nextSection: 83, skillCheck: false}]};
        storySections[43] = {text: "You throw a rock at the bubbles. A giant frog emerges and croaks angrily before diving back down.", choices: [{text: "Quickly move past while it's gone", nextSection: 84, skillCheck: false}]};
        storySections[44] = {text: "'Who goes there?' a voice echoes back. A figure materializes from the mist - an old hermit who lives in the swamp.", choices: [{text: "Ask for directions", nextSection: 85, skillCheck: false}, {text: "Attack the hermit", nextSection: 86, skillCheck: false}]};
        storySections[45] = {text: "You proceed cautiously through the grove. The whispers grow louder, but no enemies appear. You find a dry path leading out.", choices: [{text: "Follow the dry path", nextSection: 87, skillCheck: false}]};
        storySections[46] = {text: window.checkResult ? "You find the source: wind through strange hollow reeds creates the whispering sound." : "The whispers seem to come from everywhere at once, disorienting you.", choices: [window.checkResult ? {text: "Continue through the grove", nextSection: 88, skillCheck: false} : {text: "Flee the grove", nextSection: 89, skillCheck: false}]};
        storySections[47] = {text: "You swim across the channel successfully and find yourself on the far side of the swamp!", choices: [{text: "Continue to dry land", nextSection: 200, skillCheck: false}]};
        storySections[48] = {text: "You find a place where fallen trees create a natural bridge across the channel.", choices: [{text: "Cross carefully", nextSection: 90, skillCheck: true, checkType: 'skill', difficulty: 11}]};
        storySections[49] = {text: window.checkResult ? "You build a serviceable raft and paddle across the channel." : "Your raft falls apart mid-channel, and you have to swim the rest of the way.", choices: [{text: "Continue", nextSection: 91, skillCheck: false}]};
        storySections[50] = {text: window.checkResult ? "You spot a route to safety from the treetop!" : "You find a silver locket in the mud where you fell.", choices: [window.checkResult ? {text: "Head toward the solid ground", nextSection: 92, skillCheck: false} : {text: "Take the locket and continue", nextSection: 93, skillCheck: false}], action: function() { if(!window.checkResult) { gameState.inventory.push("Silver Locket"); updateInventoryDisplay(); } }};
        storySections[51] = {text: "The journal tells of a 'Whispering Mist' that drives men mad and a 'safe route marked by red mushrooms'.", choices: [{text: "Look for red mushrooms", nextSection: 94, skillCheck: false}, {text: "Take the journal and go", nextSection: 53, skillCheck: false}]};
        storySections[52] = {text: "You find a waterproof pack containing dried rations, a tinderbox, and 20 Gold.", choices: [{text: "Take the supplies", nextSection: 95, skillCheck: false}], action: function() { gameState.gold += 20; gameState.inventory.push("Tinderbox", "Dried Rations"); updateStatsDisplay(); updateInventoryDisplay(); swampConditions.hasTorch = true; }};
        storySections[53] = {text: "With the journal in hand, you continue through the swamp.", choices: [{text: "Follow the journal's clues", nextSection: 96, skillCheck: false}]};
        storySections[54] = {text: "You bail out the boat and row across the swamp, making excellent progress.", choices: [{text: "Row toward what looks like dry land", nextSection: 200, skillCheck: false}], action: function() { swampConditions.foundBoat = true; }};
        storySections[55] = {text: "In the boat, you find fishing gear, a lantern with oil, and a compass that always points toward dry land!", choices: [{text: "Take the compass and use the boat", nextSection: 97, skillCheck: false}], action: function() { gameState.inventory.push("Swamp Compass"); updateInventoryDisplay(); }};
        storySections[56] = {text: "You leave the boat and continue on foot, soon finding a trail of stepping stones across the water.", choices: [{text: "Cross using the stepping stones", nextSection: 98, skillCheck: true, checkType: 'skill', difficulty: 12}]};
        storySections[57] = {text: "The bones are human, and recently picked clean. Whatever killed this person might still be nearby.", choices: [{text: "Leave quickly", nextSection: 99, skillCheck: false}, {text: "Search the bones for belongings", nextSection: 100, skillCheck: false}]};
        storySections[58] = {text: "The shiny objects are coins and jewelry worth 40 Gold!", choices: [{text: "Take the treasure and leave", nextSection: 101, skillCheck: false}], action: function() { gameState.gold += 40; updateStatsDisplay(); }};
        storySections[59] = {text: "From the treetop, you see a clear route to the swamp's edge!", choices: [{text: "Follow the route you spotted", nextSection: 200, skillCheck: false}]};
        storySections[60] = {text: "You approach the hut. The door creaks open, and a wizened old swamp dweller peers out. 'Lost, are ye?'", choices: [{text: "Ask for help", nextSection: 102, skillCheck: false}, {text: "Attack the swamp dweller", nextSection: 103, skillCheck: false}]};
        storySections[61] = {text: "'Hello! Is anyone there?' you call. The door opens, and an old woman gestures you inside.", choices: [{text: "Enter the hut", nextSection: 104, skillCheck: false}, {text: "Decline and continue", nextSection: 62, skillCheck: false}]};
        storySections[62] = {text: "You bypass the hut and soon find a well-worn trail that leads out of the swamp.", choices: [{text: "Follow the trail", nextSection: 200, skillCheck: false}]};
        storySections[63] = {text: "", choices: [{text: "Continue", nextSection: 64, skillCheck: false}]};
        storySections[64] = {text: "After defeating the wolf, you continue along the trail which leads to a dry ridge overlooking the swamp.", choices: [{text: "Follow the ridge", nextSection: 105, skillCheck: false}]};
        storySections[65] = {text: window.checkResult ? "The wolf leaves and you continue safely." : "You fight off the wolf and continue, wounded.", choices: [{text: "Continue along the trail", nextSection: 106, skillCheck: false}]};
        storySections[66] = {text: window.checkResult ? "You wait until the wolf leaves, then climb down and continue." : "You tend to your wounds, then continue when safe.", choices: [{text: "Continue along the trail", nextSection: 106, skillCheck: false}]};
        storySections[67] = {text: "The glowing plants might be useful as light sources or for their possible magical properties.", choices: [{text: "Take some and continue", nextSection: 107, skillCheck: false}], action: function() { gameState.inventory.push("Glowing Swamp Plants"); updateInventoryDisplay(); }};
        storySections[68] = {text: "As you examine the pods, one bursts, spraying you with spores. You feel dizzy but also strangely energized.", choices: [{text: "Continue", nextSection: 108, skillCheck: false}], action: function() { const effect = rollDiceHelper(1, 6); if(effect <= 3) { gameState.stamina -= 3; gameState.skill += 1; } else { gameState.stamina += 3; gameState.luck -= 1; } updateStatsDisplay(); }};
        storySections[69] = {text: "The red flowers have a sweet, hypnotic scent. You feel lightheaded but happy.", choices: [{text: "Take some flowers", nextSection: 109, skillCheck: false}, {text: "Leave them", nextSection: 30, skillCheck: false}]};
        storySections[70] = {text: "The glinting object is a sword! It's old but well-made, with a serpent design on the hilt.", choices: [{text: "Take the sword", nextSection: 110, skillCheck: false}, {text: "Leave it", nextSection: 31, skillCheck: false}]};
        storySections[71] = {text: "The trees mark the edge of the swamp! You've made it through!", choices: [{text: "Exit the swamp", nextSection: 200, skillCheck: false}]};
        storySections[72] = {text: "The clear water stream leads to a waterfall that pours into a deep pool. There's a cave behind the waterfall.", choices: [{text: "Enter the cave", nextSection: 111, skillCheck: false}, {text: "Continue following the stream", nextSection: 112, skillCheck: false}]};
        storySections[73] = {text: "The muddy bank leads to a drier area with a path heading northwest.", choices: [{text: "Follow the path", nextSection: 113, skillCheck: false}]};
        storySections[74] = {text: window.checkResult ? "You explore the sunken temple and find a golden idol worth 100 Gold!" : "You almost drown exploring the temple but escape with a smaller treasure worth 30 Gold.", choices: [{text: "Surface and continue", nextSection: 114, skillCheck: false}], action: function() { const gold = window.checkResult ? 100 : 30; gameState.gold += gold; updateStatsDisplay(); }};
        storySections[75] = {text: "You rest on the mudflat, catching your breath. The swamp seems quieter here.", choices: [{text: "Continue", nextSection: 115, skillCheck: false}], action: function() { gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 3); updateStatsDisplay(); }};
        storySections[76] = {text: "You keep moving despite exhaustion. You find animal tracks leading to higher ground.", choices: [{text: "Follow the tracks", nextSection: 116, skillCheck: false}]};
        storySections[77] = {text: "You battle the Swamp Ghoul!", choices: [{text: "Roll for attack", nextSection: 117, skillCheck: false}], action: function() { return startCombat("Swamp Ghoul", 16, 11, 118); }};
        storySections[78] = {text: window.checkResult ? "The ghoul seems to understand you. It points northwest before diving back underwater." : "The ghoul hisses and attacks!", choices: [window.checkResult ? {text: "Head northwest", nextSection: 119, skillCheck: false} : {text: "Fight the ghoul", nextSection: 117, skillCheck: false}]};
        storySections[79] = {text: "You swim away while keeping the ghoul in sight. It follows for a while but eventually gives up.", choices: [{text: "Continue swimming", nextSection: 120, skillCheck: false}]};
        storySections[80] = {text: "The black stone dagger feels cold and heavy in your hand. It seems magical.", choices: [{text: "Take it and leave the clearing", nextSection: 39, skillCheck: false}], action: function() { gameState.weapons.push({name: 'Obsidian Ritual Dagger', damage: '2d4'}); updateInventoryDisplay(); }};
        storySections[81] = {text: "The game trail leads you to a hunting blind overlooking a dry path through the swamp.", choices: [{text: "Take the dry path", nextSection: 200, skillCheck: false}]};
        storySections[82] = {text: "The hot spring water has healing properties! You feel revitalized.", choices: [{text: "Continue your journey", nextSection: 121, skillCheck: false}], action: function() { gameState.stamina = gameState.maxStamina; swampConditions.poisoned = false; updateStatsDisplay(); }};
        storySections[83] = {text: "You cross the land bridge safely and find yourself on the far side of the deep water.", choices: [{text: "Continue", nextSection: 122, skillCheck: false}]};
        storySections[84] = {text: "While the frog is submerged, you quickly pass the area and find a dry path ahead.", choices: [{text: "Follow the dry path", nextSection: 123, skillCheck: false}]};
        storySections[85] = {text: "'The way out is marked by stone cairns,' the hermit says. 'Follow them northwest.' He gives you a charm for protection.", choices: [{text: "Thank him and follow the cairns", nextSection: 124, skillCheck: false}], action: function() { gameState.inventory.push("Swamp Protection Charm"); gameState.luck += 1; updateInventoryDisplay(); updateStatsDisplay(); }};
        storySections[86] = {text: "You attack the hermit! Roll for combat!", choices: [{text: "Roll for attack", nextSection: 125, skillCheck: false}], action: function() { return startCombat("Swamp Hermit", 12, 8, 126); }};
        storySections[87] = {text: "The dry path leads you out of the willow grove and toward higher ground.", choices: [{text: "Continue toward high ground", nextSection: 127, skillCheck: false}]};
        storySections[88] = {text: "Knowing the whispers are natural, you proceed confidently through the grove and find an exit.", choices: [{text: "Exit the grove", nextSection: 128, skillCheck: false}]};
        storySections[89] = {text: "You flee the disorienting grove and find yourself back at the swamp's edge.", choices: [{text: "Try a different route", nextSection: 0, skillCheck: false}]};
        storySections[90] = {text: window.checkResult ? "You cross the fallen tree bridge safely." : "You slip and fall into the water but manage to swim across.", choices: [{text: "Continue on the far side", nextSection: 129, skillCheck: false}], action: function() { if(!window.checkResult) { gameState.stamina -= 3; updateStatsDisplay(); } }};
        storySections[91] = {text: window.checkResult ? "You paddle safely across on your raft." : "You swim the rest of the way, exhausted.", choices: [{text: "Continue from here", nextSection: 130, skillCheck: false}], action: function() { if(!window.checkResult) { gameState.stamina -= 4; updateStatsDisplay(); } }};
        storySections[92] = {text: "Heading toward the solid ground you spotted, you soon find a dry trail out of the swamp.", choices: [{text: "Follow the trail", nextSection: 200, skillCheck: false}]};
        storySections[93] = {text: "With the locket, you continue through the swamp. It seems to bring you luck.", choices: [{text: "Continue", nextSection: 131, skillCheck: false}], action: function() { gameState.luck += 1; updateStatsDisplay(); }};
        storySections[94] = {text: "Looking for red mushrooms, you find a trail of them marking a safe path through the swamp!", choices: [{text: "Follow the mushroom trail", nextSection: 200, skillCheck: false}]};
        storySections[95] = {text: "With new supplies, you feel better equipped to handle the swamp.", choices: [{text: "Continue your journey", nextSection: 132, skillCheck: false}]};
        storySections[96] = {text: "Using clues from the journal, you navigate dangerous areas safely and find a route out.", choices: [{text: "Follow the safe route", nextSection: 200, skillCheck: false}]};
        storySections[97] = {text: "With the compass guiding you, you row directly toward dry land.", choices: [{text: "Follow the compass", nextSection: 200, skillCheck: false}]};
        storySections[98] = {text: window.checkResult ? "You cross the stepping stones safely." : "You slip on a slick stone and fall in, but continue.", choices: [{text: "Continue from here", nextSection: 133, skillCheck: false}], action: function() { if(!window.checkResult) { gameState.stamina -= 2; updateStatsDisplay(); } }};
        storySections[99] = {text: "You leave the bones quickly and find a path heading away from the danger.", choices: [{text: "Follow the path", nextSection: 134, skillCheck: false}]};
        storySections[100] = {text: "Searching the bones, you find a silver ring and a map showing a safe route!", choices: [{text: "Take the items and follow the map", nextSection: 200, skillCheck: false}], action: function() { gameState.inventory.push("Silver Ring", "Bone Map"); updateInventoryDisplay(); }};
        storySections[101] = {text: "With the treasure, you hurry away from the dangerous area and find a trail leading out.", choices: [{text: "Follow the trail", nextSection: 200, skillCheck: false}]};
        storySections[102] = {text: "'I can show ye the way out... for a price. 20 Gold.'", choices: [{text: "Pay 20 Gold", nextSection: 135, skillCheck: false}, {text: "Refuse and find your own way", nextSection: 136, skillCheck: false}]};
        storySections[103] = {text: "You attack the swamp dweller! Roll for combat!", choices: [{text: "Roll for attack", nextSection: 137, skillCheck: false}], action: function() { return startCombat("Swamp Dweller", 10, 7, 138); }};
        storySections[104] = {text: "Inside, the old woman offers you tea and directions. 'The northern path is safest. Avoid the sinkholes to the east.'", choices: [{text: "Thank her and take the northern path", nextSection: 139, skillCheck: false}, {text: "Suspect treachery and leave", nextSection: 62, skillCheck: false}]};
        storySections[105] = {text: "The ridge provides a clear view and dry walking all the way to the swamp's edge.", choices: [{text: "Follow the ridge out", nextSection: 200, skillCheck: false}]};
        storySections[106] = {text: "The trail continues and eventually leads to a dry causeway through the swamp.", choices: [{text: "Take the causeway", nextSection: 140, skillCheck: false}]};
        storySections[107] = {text: "With the glowing plants as possible light sources, you continue through a dark area of the swamp.", choices: [{text: "Use the plants to light your way", nextSection: 141, skillCheck: false}]};
        storySections[108] = {text: "The spores' effects wear off as you continue through the swamp.", choices: [{text: "Continue your journey", nextSection: 142, skillCheck: false}]};
        storySections[109] = {text: "The flowers make you feel happy but slightly disconnected from reality. They might be valuable to alchemists.", choices: [{text: "Continue with the flowers", nextSection: 143, skillCheck: false}], action: function() { gameState.inventory.push("Red Swamp Flowers"); updateInventoryDisplay(); }};
        storySections[110] = {text: "You take the serpent sword. It's well-balanced and sharp.", choices: [{text: "Continue with your new weapon", nextSection: 144, skillCheck: false}], action: function() { gameState.weapons.push({name: 'Serpent Sword', damage: '2d6'}); updateInventoryDisplay(); }};
        storySections[111] = {text: "Behind the waterfall is a dry cave with ancient paintings on the walls showing the way out of the swamp!", choices: [{text: "Follow the painted directions", nextSection: 200, skillCheck: false}]};
        storySections[112] = {text: "The stream leads to a river that flows out of the swamp. You can follow it to safety.", choices: [{text: "Follow the river out", nextSection: 200, skillCheck: false}]};
        storySections[113] = {text: "The path leads northwest and gradually rises out of the swamp.", choices: [{text: "Follow the rising path", nextSection: 145, skillCheck: false}]};
        storySections[114] = {text: "With your treasure, you surface and continue through the swamp, wealthier but tired.", choices: [{text: "Continue toward dry land", nextSection: 146, skillCheck: false}]};
        storySections[115] = {text: "Restored, you continue and find a trail marked with red ribbons - someone's safe route!", choices: [{text: "Follow the ribbon trail", nextSection: 200, skillCheck: false}]};
        storySections[116] = {text: "The animal tracks lead to a dry game trail that heads out of the swamp.", choices: [{text: "Follow the game trail", nextSection: 200, skillCheck: false}]};
        storySections[117] = {text: "", choices: [{text: "Continue", nextSection: 118, skillCheck: false}]};
        storySections[118] = {text: "After defeating the ghoul, you find it was guarding a chest with 60 Gold and a map!", choices: [{text: "Take the treasure and follow the map", nextSection: 200, skillCheck: false}], action: function() { gameState.gold += 60; gameState.inventory.push("Ghoul's Map"); updateStatsDisplay(); updateInventoryDisplay(); }};
        storySections[119] = {text: "Heading northwest as the ghoul indicated, you find a series of stone markers leading out of the swamp.", choices: [{text: "Follow the stone markers", nextSection: 200, skillCheck: false}]};
        storySections[120] = {text: "You swim until exhausted, then wade to a muddy island to rest.", choices: [{text: "Rest and continue", nextSection: 147, skillCheck: false}]};
        storySections[121] = {text: "Healed and refreshed, you easily navigate the remaining swamp and find the exit.", choices: [{text: "Exit the swamp", nextSection: 200, skillCheck: false}]};
        storySections[122] = {text: "From here, you can see higher ground to the north.", choices: [{text: "Head for high ground", nextSection: 148, skillCheck: false}]};
        storySections[123] = {text: "The dry path leads gradually upward out of the swamp mists.", choices: [{text: "Follow the upward path", nextSection: 149, skillCheck: false}]};
        storySections[124] = {text: "Following the stone cairns, you make steady progress out of the swamp.", choices: [{text: "Continue following the cairns", nextSection: 200, skillCheck: false}]};
        storySections[125] = {text: "", choices: [{text: "Continue", nextSection: 126, skillCheck: false}]};
        storySections[126] = {text: "After defeating the hermit, you search his hut and find a detailed map of the swamp with safe routes marked.", choices: [{text: "Take the map and follow a safe route", nextSection: 200, skillCheck: false}], action: function() { gameState.inventory.push("Hermit's Detailed Swamp Map"); updateInventoryDisplay(); }};
        storySections[127] = {text: "The high ground provides a clear route with firm footing all the way to the swamp's edge.", choices: [{text: "Follow the high ground out", nextSection: 200, skillCheck: false}]};
        storySections[128] = {text: "Exiting the grove, you find yourself on a dry ridge that leads out of the swamp.", choices: [{text: "Follow the ridge", nextSection: 200, skillCheck: false}]};
        storySections[129] = {text: "On the far side of the channel, you find a well-worn path heading northwest.", choices: [{text: "Follow the path", nextSection: 150, skillCheck: false}]};
        storySections[130] = {text: "Having crossed the channel, you can see the swamp's edge not far ahead.", choices: [{text: "Head for the edge", nextSection: 151, skillCheck: false}]};
        storySections[131] = {text: "The lucky locket seems to guide you, as you find easy paths through difficult terrain.", choices: [{text: "Continue following your luck", nextSection: 152, skillCheck: false}]};
        storySections[132] = {text: "Better equipped, you make good time through the swamp and soon spot dry land ahead.", choices: [{text: "Head for dry land", nextSection: 200, skillCheck: false}]};
        storySections[133] = {text: "After crossing the stepping stones, you find a dry trail that leads out of the swamp.", choices: [{text: "Follow the trail", nextSection: 200, skillCheck: false}]};
        storySections[134] = {text: "The path leads away from danger and toward what looks like the swamp's northern edge.", choices: [{text: "Continue to the northern edge", nextSection: 153, skillCheck: false}]};
        storySections[135] = {text: "You pay the swamp dweller, and he gives you clear directions through the safest route.", choices: [{text: "Follow his directions", nextSection: 200, skillCheck: false}], action: function() { if(gameState.gold >= 20) { gameState.gold -= 20; updateStatsDisplay(); } }};
        storySections[136] = {text: "You refuse to pay and instead follow animal trails that seem to head northwest.", choices: [{text: "Follow the animal trails", nextSection: 154, skillCheck: false}]};
        storySections[137] = {text: "", choices: [{text: "Continue", nextSection: 138, skillCheck: false}]};
        storySections[138] = {text: "After the fight, you find the dweller's map collection showing all the safe swamp routes.", choices: [{text: "Take a map and follow it out", nextSection: 200, skillCheck: false}], action: function() { gameState.inventory.push("Dweller's Swamp Maps"); updateInventoryDisplay(); }};
        storySections[139] = {text: "Taking the northern path as advised, you avoid the dangerous sinkholes and make good progress.", choices: [{text: "Continue on the northern path", nextSection: 155, skillCheck: false}]};
        storySections[140] = {text: "The causeway is an ancient raised road that leads straight out of the swamp.", choices: [{text: "Follow the ancient causeway", nextSection: 200, skillCheck: false}]};
        storySections[141] = {text: "The glowing plants illuminate a dark tunnel through thick vegetation - a shortcut!", choices: [{text: "Take the shortcut", nextSection: 156, skillCheck: false}]};
        storySections[142] = {text: "Continuing through the swamp, you find a hunter's trail that leads to dry ground.", choices: [{text: "Follow the hunter's trail", nextSection: 200, skillCheck: false}]};
        storySections[143] = {text: "With the strange flowers, you feel oddly confident navigating the swamp's dangers.", choices: [{text: "Continue with renewed confidence", nextSection: 157, skillCheck: false}]};
        storySections[144] = {text: "Armed with the serpent sword, you cut through thick vegetation that would have slowed you down.", choices: [{text: "Continue making your own path", nextSection: 158, skillCheck: false}]};
        storySections[145] = {text: "The path continues rising until you're completely out of the swamp mists.", choices: [{text: "You've reached the edge!", nextSection: 200, skillCheck: false}]};
        storySections[146] = {text: "Tired but wealthy, you follow the clearest path toward what looks like solid ground.", choices: [{text: "Head for solid ground", nextSection: 200, skillCheck: false}]};
        storySections[147] = {text: "After resting, you continue and soon find signs of recent travel - a clear path out.", choices: [{text: "Follow the traveled path", nextSection: 200, skillCheck: false}]};
        storySections[148] = {text: "The high ground proves to be a ridge that runs along the swamp's edge.", choices: [{text: "Follow the ridge out", nextSection: 200, skillCheck: false}]};
        storySections[149] = {text: "The upward path leads you out of the swamp and onto firm, dry land.", choices: [{text: "Step onto dry land", nextSection: 200, skillCheck: false}]};
        storySections[150] = {text: "The northwest path leads steadily out of the swamp's worst areas.", choices: [{text: "Continue northwest", nextSection: 159, skillCheck: false}]};
        storySections[151] = {text: "The swamp's edge is close now - you can see trees that aren't waterlogged.", choices: [{text: "Head for the normal trees", nextSection: 200, skillCheck: false}]};
        storySections[152] = {text: "Your luck holds as you find one easy route after another through the swamp.", choices: [{text: "Continue following your lucky path", nextSection: 200, skillCheck: false}]};
        storySections[153] = {text: "The northern edge is indeed the swamp's boundary. You've made it!", choices: [{text: "Exit the swamp", nextSection: 200, skillCheck: false}]};
        storySections[154] = {text: "The animal trails converge into a single clear path heading out of the swamp.", choices: [{text: "Follow the clear path", nextSection: 200, skillCheck: false}]};
        storySections[155] = {text: "The northern path proves to be the quickest route out of the Swamp of Sorrows.", choices: [{text: "Continue to the exit", nextSection: 200, skillCheck: false}]};
        storySections[156] = {text: "The shortcut through the vegetation saves hours of travel and brings you near the swamp's edge.", choices: [{text: "Exit the swamp from here", nextSection: 200, skillCheck: false}]};
        storySections[157] = {text: "Your confidence proves justified as you navigate directly to the safest exit.", choices: [{text: "Take the safe exit", nextSection: 200, skillCheck: false}]};
        storySections[158] = {text: "Cutting your own path with the serpent sword, you make straight for dry land.", choices: [{text: "Reach dry land", nextSection: 200, skillCheck: false}]};
        storySections[159] = {text: "Continuing northwest, you soon leave the swamp's foul mists behind.", choices: [{text: "Exit the swamp", nextSection: 200, skillCheck: false}]};
        
        // Initialize game
        function initGame() {
            updateStatsDisplay();
            updateInventoryDisplay();
            
            // If we have a current section from saved game, load it
            if (gameState.currentSection > 0) {
                loadSection(gameState.currentSection);
            } else {
                loadSection(0);
            }
        }
        
        // Show warning dialog for new game
        function showNewGameWarning() {
            // Show warning dialog
            document.getElementById('screen-game').classList.remove('active-screen');
            document.getElementById('warning-dialog').classList.add('active-screen');
        }
        
        // Cancel new game and return to game screen
        function cancelNewGame() {
            document.getElementById('warning-dialog').classList.remove('active-screen');
            document.getElementById('screen-game').classList.add('active-screen');
        }
        
        // Start new game - reset everything
        function startNewGame() {
            // Clear all saved game data
            localStorage.removeItem('dreadwoodGameState');
            
            // Reset game state to completely empty
            gameState = {
                playerClass: '',
                skill: 0,
                maxStamina: 0,
                stamina: 0,
                luck: 0,
                gold: 0,
                inventory: [],
                weapons: [],
                armor: [],
                currentSection: 0,
                gameComplete: false
            };
            
            // Redirect to level1.html to start fresh
            window.location.href = 'level1.html';
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-skill').textContent = gameState.skill;
            document.getElementById('stat-stamina').textContent = gameState.stamina;
            document.getElementById('stat-maxstamina').textContent = gameState.maxStamina;
            document.getElementById('stat-luck').textContent = gameState.luck;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Show current weapon
            if (gameState.weapons && gameState.weapons.length > 0) {
                const weapon = gameState.weapons[gameState.weapons.length - 1];
                inventoryDiv.innerHTML += `<span class="inventory-item">${weapon.name} (${weapon.damage})</span>`;
            }
            
            // Show armor
            if (gameState.armor && gameState.armor.length > 0) {
                const armor = gameState.armor[gameState.armor.length - 1];
                inventoryDiv.innerHTML += `<span class="inventory-item">${armor.name} (${armor.defense} DEF)</span>`;
            }
            
            // Show gold
            inventoryDiv.innerHTML += `<span class="inventory-item">${gameState.gold} Gold</span>`;
            
            // Show other inventory items
            if (gameState.inventory) {
                gameState.inventory.forEach(item => {
                    if (item !== 'Dagger' && item !== 'Leather Armor') {
                        inventoryDiv.innerHTML += `<span class="inventory-item">${item}</span>`;
                    }
                });
            }
        }
        
        // Load story section
        function loadSection(sectionId) {
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                // If section doesn't exist yet, show a placeholder
                document.getElementById('story-text').innerHTML = "<p>Your adventure in the Swamp of Sorrows continues... More content will be added in future updates!</p>";
                document.getElementById('choice-buttons').innerHTML = `
                    <button class="choice-btn" onclick="loadSection(0)">Return to Swamp Entrance</button>
                `;
                return;
            }
            
            let storyText = section.text;
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            // Check for swamp conditions
            if (swampConditions.poisoned) {
                const poisonDamage = rollDiceHelper(1, 3);
                gameState.stamina -= poisonDamage;
                storyText += `<br><br><span class="poison">The swamp poison courses through your veins! You lose ${poisonDamage} Stamina.</span>`;
                updateStatsDisplay();
                
                // Chance to recover from poison
                if (rollDiceHelper(1, 6) >= 5) {
                    swampConditions.poisoned = false;
                    storyText += `<br><span class="success">You fight off the poison! You feel better.</span>`;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p>";
            
            // Clear and add choice buttons
            const choiceButtons = document.getElementById('choice-buttons');
            choiceButtons.innerHTML = '';
            
            section.choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = choice.text;
                button.onclick = function() {
                    if (choice.skillCheck) {
                        performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                    } else {
                        loadSection(choice.nextSection);
                    }
                };
                choiceButtons.appendChild(button);
            });
            
            // Save game progress
            saveGame();
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            const diceRoll = rollDiceHelper(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Start combat
        function startCombat(enemyName, enemyStamina, enemySkill, nextSection) {
            const playerAttack = rollDiceHelper(2, 6) + gameState.skill;
            const enemyAttack = rollDiceHelper(2, 6) + enemySkill;
            
            let resultText = `<span class="enemy">BATTLE: ${enemyName}</span> (Skill: ${enemySkill}, Stamina: ${enemyStamina})<br>`;
            resultText += `You attack with ${playerAttack} vs enemy's ${enemyAttack}.<br>`;
            
            if (playerAttack > enemyAttack) {
                // Calculate damage based on current weapon
                let damage = 0;
                if (gameState.weapons && gameState.weapons.length > 0) {
                    const weapon = gameState.weapons[gameState.weapons.length - 1];
                    if (weapon.damage === '1d6') damage = rollDiceHelper(1, 6);
                    else if (weapon.damage === '1d6+1') damage = rollDiceHelper(1, 6) + 1;
                    else if (weapon.damage === '2d6') damage = rollDiceHelper(2, 6);
                    else if (weapon.damage === '2d4') damage = rollDiceHelper(2, 4);
                    else if (weapon.damage === '3d6') damage = rollDiceHelper(3, 6);
                    else damage = rollDiceHelper(1, 6); // Default
                } else {
                    damage = rollDiceHelper(1, 6);
                }
                
                resultText += `<span class="success">You hit for ${damage} damage!</span>`;
                
                if (enemyStamina - damage <= 0) {
                    resultText += `<br><span class="success">You defeated the ${enemyName}!</span>`;
                    // Player gets some gold for victory
                    const goldReward = Math.floor(Math.random() * 40) + 10;
                    gameState.gold += goldReward;
                    resultText += `<br>You find ${goldReward} Gold on the body.`;
                } else {
                    enemyStamina -= damage;
                    resultText += `<br>The ${enemyName} has ${enemyStamina} Stamina remaining.`;
                    // Enemy counterattacks
                    const enemyDamage = rollDiceHelper(1, 6);
                    gameState.stamina -= enemyDamage;
                    resultText += `<br><span class="damage">The ${enemyName} hits back for ${enemyDamage} damage!</span>`;
                }
            } else if (playerAttack < enemyAttack) {
                const damage = rollDiceHelper(1, 6);
                gameState.stamina -= damage;
                resultText += `<span class="damage">You are hit for ${damage} damage!</span>`;
            } else {
                resultText += "The attacks cancel each other out!";
            }
            
            updateStatsDisplay();
            
            // Check if player died
            if (gameState.stamina <= 0) {
                resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                // Reset game after delay
                setTimeout(() => {
                    localStorage.removeItem('dreadwoodGameState');
                    location.reload();
                }, 3000);
            }
            
            // Store combat result in appropriate section
            if (storySections[nextSection]) {
                storySections[nextSection].text = resultText;
            }
            
            return resultText;
        }
        
        // Use Luck
        function useLuck() {
            if (gameState.luck <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Luck left!</div>`;
                return;
            }
            
            const diceRoll = rollDiceHelper(2, 6);
            const success = diceRoll <= gameState.luck;
            
            gameState.luck -= 1;
            updateStatsDisplay();
            
            let resultText = `You test your Luck... Roll: ${diceRoll}, Luck: ${gameState.luck + 1}. `;
            resultText += success ? 
                `<span class="success">Lucky!</span> Something good happens.` : 
                `<span class="damage">Unlucky!</span> Something bad happens.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            // Apply Luck effect
            if (success) {
                // Good effect
                const goodEffects = [
                    "You find 15 Gold in a sunken chest!",
                    "You discover a healing spring! Restore 6 Stamina.",
                    "You avoid a patch of poisonous plants you didn't see before.",
                    "A friendly swamp creature leads you to a safe path!",
                    "You find a rare herb that cures swamp sickness!"
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Gold")) {
                    gameState.gold += 15;
                } else if (effect.includes("Stamina")) {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 6);
                } else if (effect.includes("sickness")) {
                    swampConditions.poisoned = false;
                } else if (effect.includes("safe path")) {
                    // This could lead to a shortcut
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">The creature shows you a hidden trail!</div>`;
                    setTimeout(() => {
                        loadSection(200); // Shortcut to victory!
                    }, 1000);
                }
            } else {
                // Bad effect
                const badEffects = [
                    "You step into quicksand! Struggle free losing 4 Stamina.",
                    "You're attacked by leeches! Lose 3 Stamina and 5 Gold falls from your pack.",
                    "You inhale poisonous spores! You feel sick.",
                    "You attract a swarm of biting insects!",
                    "You get hopelessly lost in the mist!"
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Stamina")) {
                    const damage = effect.includes("4") ? 4 : 3;
                    gameState.stamina -= damage;
                    if (effect.includes("Gold")) {
                        gameState.gold = Math.max(0, gameState.gold - 5);
                    }
                    if (gameState.stamina <= 0) {
                        document.getElementById('story-text').innerHTML += `<div class="game-over">You have been defeated! Game Over.</div>`;
                        setTimeout(() => {
                            localStorage.removeItem('dreadwoodGameState');
                            location.reload();
                        }, 3000);
                    }
                } else if (effect.includes("poisonous")) {
                    swampConditions.poisoned = true;
                } else if (effect.includes("lost")) {
                    swampConditions.lost = true;
                    // Return to a random earlier section
                    const lostSections = [0, 1, 2, 3];
                    const randomSection = lostSections[Math.floor(Math.random() * lostSections.length)];
                    setTimeout(() => {
                        loadSection(randomSection);
                    }, 1000);
                }
            }
            
            updateStatsDisplay();
            updateInventoryDisplay();
        }
        
        // Check inventory
        function checkInventory() {
            let inventoryText = "<h3>Your Inventory:</h3>";
            
            if (gameState.weapons && gameState.weapons.length > 0) {
                const weapon = gameState.weapons[gameState.weapons.length - 1];
                inventoryText += `<p><strong>Weapon:</strong> ${weapon.name} (${weapon.damage} damage)</p>`;
            }
            
            if (gameState.armor && gameState.armor.length > 0) {
                const armor = gameState.armor[gameState.armor.length - 1];
                inventoryText += `<p><strong>Armor:</strong> ${armor.name} (${armor.defense} DEF)</p>`;
            }
            
            inventoryText += `<p><strong>Gold:</strong> ${gameState.gold}</p>`;
            
            if (gameState.inventory && gameState.inventory.length > 0) {
                inventoryText += `<p><strong>Other Items:</strong> `;
                const otherItems = gameState.inventory.filter(item => 
                    item !== 'Dagger' && item !== 'Leather Armor' && 
                    !gameState.weapons.some(w => w.name === item) &&
                    !gameState.armor.some(a => a.name === item)
                );
                inventoryText += otherItems.join(', ') || 'None';
                inventoryText += `</p>`;
            }
            
            // Show swamp conditions
            inventoryText += `<p><strong>Swamp Conditions:</strong> `;
            const conditions = [];
            if (swampConditions.poisoned) conditions.push("Poisoned");
            if (swampConditions.lost) conditions.push("Lost");
            if (swampConditions.foundBoat) conditions.push("Has Boat");
            if (swampConditions.hasTorch) conditions.push("Has Light");
            inventoryText += conditions.join(', ') || 'Normal';
            inventoryText += `</p>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${inventoryText}</div>`;
        }
        
        // Save game
        function saveGame() {
            // Save both game state and swamp conditions
            const saveData = {
                ...gameState,
                swampConditions: swampConditions
            };
            localStorage.setItem('dreadwoodGameState', JSON.stringify(saveData));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">Game saved!</div>`;
        }
        
        // Go to next level
        function goToNextLevel() {
            // Save game state for level 4
            const saveData = {
                ...gameState,
                swampConditions: swampConditions
            };
            localStorage.setItem('dreadwoodGameState', JSON.stringify(saveData));
            // In a complete game, this would redirect to level4.html
            // For now, we'll just show a message since level4 doesn't exist yet
            alert("Level 4: Bloodstone Keep coming soon! Your game has been saved.");
            // Uncomment when level4.html exists:
            // window.location.href = 'level4.html';
        }
        
        // Utility function to roll dice
        function rollDiceHelper(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = function() {
            // Load swamp conditions from saved game if they exist
            const savedGame = JSON.parse(localStorage.getItem('dreadwoodGameState'));
            if (savedGame && savedGame.swampConditions) {
                swampConditions = savedGame.swampConditions;
            }
            
            initGame();
        };
    </script>
</body>
</html>
