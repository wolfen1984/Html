<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASTLE OF THE UNDEAD - Level 9: The Castle's Dungeon</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Dungeon Dark Red/Black/Iron theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(80, 0, 0, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(80, 0, 0, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #ff0040;
            background-color: #000;
            box-shadow: 0 0 20px rgba(255, 0, 64, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(80, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #ff0040;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #ff6666;
            text-shadow: 0 0 5px #ff0040;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #ff0040;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #ff0040;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #200;
            color: #ff6666;
            border-color: #ff6666;
        }
        
        .level-number.current {
            background-color: #ff0040;
            color: #fff;
            border-color: #ff6666;
            box-shadow: 0 0 8px #ff0040;
            text-shadow: 0 0 2px #000;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #ff0040;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #ff6666;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #ff0040;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #ff6666;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #ff0040;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #ff6666;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff6666;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #ff0040;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #ff0040;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #ff6666;
            border-color: #ff6666;
            box-shadow: 0 0 10px rgba(255, 102, 102, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #ff0040;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #ff6666;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #ff0040;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #ff6666;
            border-color: #ff6666;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #330000;
            border: 1px solid #ff0040;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ff6666;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #440011;
            border: 1px solid #ff6666;
            padding: 10px;
            margin: 10px 0;
            color: #ff6666;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #8ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        .prisoner {
            color: #aaf;
            font-weight: bold;
        }
        
        .guard {
            color: #ccc;
            font-weight: bold;
        }
        
        .experiment {
            color: #8f8;
            font-weight: bold;
        }
        
        .torturer {
            color: #f84;
            font-weight: bold;
        }
        
        .bloodmage {
            color: #f66;
            font-weight: bold;
        }
        
        .mutant {
            color: #8f6;
            font-weight: bold;
        }
        
        .warden {
            color: #ff6666;
            font-weight: bold;
            text-shadow: 0 0 3px #ff0040;
        }
        
        .cellblock {
            color: #ff6666;
            font-weight: bold;
        }
        
        .chains {
            color: #aaa;
            font-weight: bold;
        }
        
        .torture {
            color: #f44;
            font-weight: bold;
        }
        
        .ritual {
            color: #f6f;
            font-weight: bold;
        }
        
        .scream {
            color: #f88;
            font-weight: bold;
            font-style: italic;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #ff0040;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            fontSize: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #ff0040;
            color: #fff;
            border-color: #ff6666;
            box-shadow: 0 0 15px #ff0040;
        }
        
        /* Dungeon Map Display */
        .dungeon-map {
            background-color: #330000;
            border: 1px solid #ff0040;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.8;
            color: #ff6666;
        }
        
        .map-row {
            display: flex;
        }
        
        .map-cell {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #660000;
        }
        
        .map-cell.player {
            background-color: #ff6666;
            color: #000;
        }
        
        .map-cell.explored {
            background-color: #330000;
        }
        
        .map-cell.unexplored {
            background-color: #110000;
        }
        
        .map-cell.exit {
            background-color: #ff0;
            color: #000;
        }
        
        .map-cell.cellblock {
            background-color: #440000;
        }
        
        .map-cell.torture {
            background-color: #660000;
        }
        
        .map-cell.lab {
            background-color: #004400;
        }
        
        /* Blood Pool Animation */
        .blood-animation {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #330000;
            border: 1px solid #ff0040;
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0% { border-color: #ff0040; }
            50% { border-color: #ff6666; }
            100% { border-color: #ff0040; }
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #ff0040;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #ff0040;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #ff6666;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CASTLE OF THE UNDEAD</h1>
            <h2>LEVEL 9: THE CASTLE'S DUNGEON</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number completed">2</div>
            <div class="level-number completed">3</div>
            <div class="level-number completed">4</div>
            <div class="level-number completed">5</div>
            <div class="level-number completed">6</div>
            <div class="level-number completed">7</div>
            <div class="level-number completed">8</div>
            <div class="level-number current">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Level Intro Screen -->
        <div id="screen-intro" class="screen active-screen">
            <h2>THE DUNGEON</h2>
            <div class="story-text">
                <p>The massive iron door clangs shut behind you, sealing you in Valerius's personal dungeon. The air is thick with the scent of blood, rust, and fear. Faint screams echo through the stone corridors, punctuated by the clanking of chains.</p>
                <p>This is where Valerius conducts his most terrible experiments, creating new types of undead servants from both living and dead subjects. The walls are stained dark with blood, and the stone floor is slick with moisture and other, less identifiable fluids.</p>
                <p>You stand at the entrance to the dungeon's main corridor. To the left, you hear the cries of prisoners. To the right, the sound of metal on stone and low chanting. Ahead, the corridor descends deeper into darkness.</p>
                <p>Somewhere in this nightmare, Valerius perfects his methods. You must navigate this hell to reach his personal quarters and end his reign of terror.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="intro-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="intro-stat-health" class="stat-value">0</span>/<span id="intro-stat-maxhealth" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="intro-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="intro-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="startLevel9()">ENTER THE DUNGEON</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>VALERIUS'S DUNGEON</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Dungeon Map Screen -->
        <div id="screen-map" class="screen">
            <h2>DUNGEON MAP</h2>
            <div class="story-text">
                <p>As you explore the dungeon, you piece together a map of its terrible layout:</p>
                
                <div class="dungeon-map" id="dungeon-map">
                    <!-- Map will be generated here -->
                </div>
                
                <p><strong>Key:</strong> <span style="color:#ff6666">■</span> = Your Position | <span style="color:#ff0">■</span> = Exit to Master Quarters | <span style="color:#330000">■</span> = Explored | <span style="color:#110000">■</span> = Unexplored | <span style="color:#440000">■</span> = Cellblock | <span style="color:#660000">■</span> = Torture Chamber | <span style="color:#004400">■</span> = Laboratory</p>
                <p>You've explored <span id="explored-percent">0</span>% of the dungeon.</p>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="closeMap()">RETURN TO DUNGEON</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL 9 COMPLETE!</h2>
            <div class="story-text">
                <p>You have survived the horrors of Valerius's dungeon and found the entrance to his personal quarters!</p>
                <p>A reinforced oaken door stands before you, carved with the Vorlak family crest. Beyond it lies Valerius's personal sanctuary, where he plans his conquests and stores his most valuable treasures.</p>
                <p>This is it - the final confrontation. Valerius awaits in his master quarters, protected by his most powerful servants and dark magic.</p>
                <p>All your stats, gold, and inventory will carry over to Level 10: The Master Quarters Keep.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #330000; border: 1px solid #ff0040;">
                    <h3 style="color: #ff6666; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">ENTER THE MASTER QUARTERS - LEVEL 10</button>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE UNDEAD - A Retro Vampire Hunt Adventure<br>
            Level 9: The Castle's Dungeon
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects for dungeon
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'chains':
                    playBeep(100, 0.3, 'square');
                    setTimeout(() => playBeep(150, 0.3, 'square'), 300);
                    break;
                case 'scream':
                    playBeep(800, 0.5, 'sawtooth');
                    setTimeout(() => playBeep(600, 0.3, 'sawtooth'), 500);
                    break;
                case 'guard':
                    playBeep(300, 0.2, 'square');
                    setTimeout(() => playBeep(200, 0.2, 'square'), 200);
                    break;
                case 'experiment':
                    playBeep(500, 0.3, 'sine');
                    setTimeout(() => playBeep(400, 0.3, 'sine'), 300);
                    setTimeout(() => playBeep(300, 0.3, 'sine'), 600);
                    break;
                case 'torture':
                    playBeep(200, 0.4, 'sawtooth');
                    break;
                case 'blood':
                    playBeep(250, 0.3, 'sine');
                    setTimeout(() => playBeep(200, 0.3, 'sine'), 300);
                    break;
                case 'mutant':
                    playBeep(150, 0.4, 'square');
                    break;
                case 'warden':
                    playBeep(400, 0.2, 'sawtooth');
                    setTimeout(() => playBeep(300, 0.2, 'sawtooth'), 200);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - loaded from Level 8
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Rusty Sword',
            equippedArmor: 'Leather Armor',
            currentSection: 1,
            gameComplete: false,
            level: 9,
            // Level 9 specific flags
            exploredDungeonSections: [],
            dungeonMap: {},
            currentPosition: {x: 2, y: 2},
            exitFound: false,
            exitPosition: {x: 8, y: 8},
            // Encounters
            wardenDefeated: false,
            tortureChamberCleared: false,
            laboratoryDestroyed: false,
            prisonersFreed: false,
            bloodMageDefeated: false,
            // Special items
            hasWardenKey: false,
            hasDungeonMap: false,
            hasTortureTools: false,
            hasBloodVial: false,
            hasLaboratoryNotes: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            isGroup: false,
            groupCount: 0
        };
        
        // Random event tracking
        let randomEvents = {
            screamsHeard: 0,
            chainsRattle: false,
            bloodDrips: false,
            whispers: false
        };
        
        // Dungeon map generation
        function generateDungeonMap() {
            const map = [];
            const width = 11;
            const height = 11;
            
            // Initialize empty map
            for (let y = 0; y < height; y++) {
                map[y] = [];
                for (let x = 0; x < width; x++) {
                    map[y][x] = {
                        explored: false,
                        type: 'corridor',
                        connections: []
                    };
                }
            }
            
            // Create main path to exit
            let x = 2, y = 2;
            const path = [];
            
            while (x < width - 3 || y < height - 3) {
                path.push({x, y});
                
                if (Math.random() > 0.5 && x < width - 3) {
                    x++;
                } else if (y < height - 3) {
                    y++;
                }
            }
            
            // Add exit at end
            gameState.exitPosition = {x, y};
            map[y][x].type = 'exit';
            
            // Add some branches
            for (let i = 0; i < 5; i++) {
                const branchStart = path[Math.floor(Math.random() * path.length)];
                let bx = branchStart.x;
                let by = branchStart.y;
                const branchLength = Math.floor(Math.random() * 4) + 2;
                
                for (let j = 0; j < branchLength; j++) {
                    if (Math.random() > 0.5 && bx > 1) {
                        bx--;
                    } else if (by > 1) {
                        by--;
                    }
                    if (bx >= 0 && bx < width && by >= 0 && by < height) {
                        path.push({x: bx, y: by});
                    }
                }
            }
            
            // Mark all path cells as corridor
            path.forEach(pos => {
                if (pos.x >= 0 && pos.x < width && pos.y >= 0 && pos.y < height) {
                    map[pos.y][pos.x].type = 'corridor';
                }
            });
            
            // Add some special rooms
            const specialRooms = [
                {x: 4, y: 1, type: 'warden'},
                {x: 1, y: 4, type: 'cellblock'},
                {x: 7, y: 3, type: 'torture'},
                {x: 3, y: 7, type: 'laboratory'},
                {x: 9, y: 5, type: 'storage'}
            ];
            
            specialRooms.forEach(room => {
                if (room.x >= 0 && room.x < width && room.y >= 0 && room.y < height) {
                    map[room.y][room.x].type = room.type;
                }
            });
            
            gameState.dungeonMap = map;
            return map;
        }
        
        // Game story sections for Level 9
        const storySections = {
            1: {
                text: "You stand in the main corridor of Valerius's dungeon. The air is thick with the scent of blood and decay. Torches flicker in iron sconces, casting dancing shadows on the blood-stained walls. To your left, you hear the clanking of chains and muffled sobs. To your right, the sound of metal grinding and low chanting. Ahead, the corridor descends into deeper darkness.",
                choices: [
                    {text: "Go left toward the cellblocks", nextSection: 2, skillCheck: false},
                    {text: "Go right toward the sounds of metal and chanting", nextSection: 3, skillCheck: false},
                    {text: "Continue straight down the corridor", nextSection: 4, skillCheck: false},
                    {text: "Try to map the dungeon in your mind", nextSection: 5, skillCheck: true, checkType: 'agility', difficulty: 14}
                ],
                action: function() {
                    // Record starting position as explored
                    const posKey = `${gameState.currentPosition.x},${gameState.currentPosition.y}`;
                    if (!gameState.exploredDungeonSections.includes(posKey)) {
                        gameState.exploredDungeonSections.push(posKey);
                    }
                    
                    // Random dungeon sounds
                    if (Math.random() > 0.7) {
                        randomEvents.screamsHeard++;
                        playSound('scream');
                        return "<br><span class='scream'>A blood-curdling scream echoes through the corridors...</span>";
                    }
                    return "";
                }
            },
            2: {
                text: "You follow the sounds of chains to a heavy iron door. Peering through the barred window, you see rows of cells filled with wretched prisoners. Some are still alive, others... less so. A brutish guard with a whip stands watch at the far end.",
                choices: [
                    {text: "Attempt to open the cellblock door", nextSection: 6, skillCheck: true, checkType: 'strength', difficulty: 16},
                    {text: "Try to distract the guard", nextSection: 7, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Look for another way in", nextSection: 8, skillCheck: false},
                    {text: "Return to the main corridor", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('chains');
                    return "The prisoners' chains rattle as they shift in their cells.";
                }
            },
            3: {
                text: "You follow the sound of metal grinding and chanting to a large chamber. Inside, you see robed figures gathered around a stone altar, performing a dark ritual. Strange, twisted creatures shuffle in cages nearby.",
                choices: [
                    {text: "Observe the ritual from hiding", nextSection: 9, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Interrupt the ritual", nextSection: 10, skillCheck: false},
                    {text: "Try to free the caged creatures", nextSection: 11, skillCheck: false},
                    {text: "Retreat quietly", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('ritual');
                    return "<span class='bloodmage'>Blood Mages</span> chant in low voices as they prepare their dark work.";
                }
            },
            4: {
                text: "You continue down the main corridor. It descends gradually, the air growing colder and the scent of blood stronger. You pass iron doors marked with strange symbols, some of which are faintly glowing.",
                choices: [
                    {text: "Check the first door on the left", nextSection: 12, skillCheck: false},
                    {text: "Check the first door on the right", nextSection: 13, skillCheck: false},
                    {text: "Continue to the end of the corridor", nextSection: 14, skillCheck: false},
                    {text: "Examine the glowing symbols", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    if (Math.random() > 0.7) {
                        randomEvents.bloodDrips = true;
                        playSound('blood');
                        return "<br><span class='blood'>Fresh blood drips from the ceiling above you.</span>";
                    }
                    return "";
                }
            },
            5: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 16, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.hasDungeonMap = true;
                        addToInventory('Mental Dungeon Map');
                        playSound('success');
                        return "You successfully create a mental map of the dungeon layout. This will help you navigate.";
                    } else {
                        playSound('failure');
                        return "The twisting corridors are too confusing. You can't form a clear mental map.";
                    }
                }
            },
            6: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 17, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You force the iron door open with a loud creak! The guard turns toward the noise.";
                    } else {
                        playSound('failure');
                        return "The door is too heavy. You cannot budge it.";
                    }
                }
            },
            7: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You create a noise down the corridor. The guard goes to investigate, giving you a chance to enter.";
                    } else {
                        playSound('failure');
                        return "Your distraction fails! The guard spots you immediately.";
                    }
                }
            },
            8: {
                text: "Looking for another way in, you find a narrow ventilation shaft. It's tight, but you might be able to squeeze through.",
                choices: [
                    {text: "Try to crawl through the shaft", nextSection: 19, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Return to trying the door", nextSection: 6, skillCheck: false}
                ],
                action: function() {
                    playSound('chains');
                    return "The shaft smells of mold and something worse.";
                }
            },
            9: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 20, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You observe unseen. The blood mages are preparing to transform a prisoner into some kind of undead creature. You learn the ritual's patterns.";
                    } else {
                        // Blood mages notice you
                        combatState.active = true;
                        combatState.enemyName = "Blood Mages";
                        combatState.enemyHealth = 70;
                        combatState.enemyCurrentHealth = 70;
                        combatState.enemyStrength = 14;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 8;
                        combatState.nextSection = 21;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 3;
                        
                        playSound('bloodmage');
                        return "The blood mages notice you!<br><br><span class='bloodmage'>Blood Mages (3)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            10: {
                text: "You interrupt the ritual! The blood mages turn toward you, their chanting turning to angry incantations.",
                choices: [
                    {text: "Fight the blood mages", nextSection: 22, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Angered Blood Mages";
                    combatState.enemyHealth = 80;
                    combatState.enemyCurrentHealth = 80;
                    combatState.enemyStrength = 15;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 23;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 3;
                    
                    playSound('bloodmage');
                    return "<span class='bloodmage'>Angered Blood Mages (3)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            11: {
                text: "You attempt to free the caged creatures. As you approach, you realize they're not natural animals - they're twisted experiments, part human, part beast.",
                choices: [
                    {text: "Continue trying to free them", nextSection: 24, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Leave them caged", nextSection: 25, skillCheck: false}
                ],
                action: function() {
                    playSound('mutant');
                    return "<span class='mutant'>The creatures</span> snarl and snap at you through the bars.";
                }
            },
            12: {
                text: "The first door on the left opens into a torture chamber. Racks, iron maidens, and other terrible devices fill the room. A hulking figure with blood-stained leather apron stands with his back to you, sharpening a blade.",
                choices: [
                    {text: "Attack the torturer", nextSection: 26, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 27, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Search the room for useful items", nextSection: 28, skillCheck: false},
                    {text: "Back out quietly", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    playSound('torture');
                    return "<span class='torturer'>The Master Torturer</span> hums a grim tune as he works.";
                }
            },
            13: {
                text: "The first door on the right leads to a storage room. Shelves line the walls, filled with jars of strange substances, surgical tools, and rolled parchments.",
                choices: [
                    {text: "Search the shelves", nextSection: 29, skillCheck: false},
                    {text: "Take any useful-looking items", nextSection: 30, skillCheck: false},
                    {text: "Examine the parchments", nextSection: 31, skillCheck: false},
                    {text: "Leave the storage room", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The room smells of chemicals and decay.";
                }
            },
            14: {
                text: "You reach the end of the corridor. A heavy wooden door reinforced with iron bands stands before you. From beyond it, you hear the sound of multiple voices and the clinking of armor.",
                choices: [
                    {text: "Listen at the door", nextSection: 32, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Try to open the door", nextSection: 33, skillCheck: false},
                    {text: "Look for another way", nextSection: 34, skillCheck: false},
                    {text: "Return up the corridor", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    playSound('guard');
                    return "This seems to be a guard barracks or armory.";
                }
            },
            15: {
                text: "The glowing symbols on the doors are vampire runes. You recognize some from your previous encounters. They seem to mark what's behind each door: 'Suffering', 'Transformation', 'Storage', and 'Master'.",
                choices: [
                    {text: "Check the 'Suffering' door", nextSection: 12, skillCheck: false},
                    {text: "Check the 'Transformation' door", nextSection: 35, skillCheck: false},
                    {text: "Check the 'Storage' door", nextSection: 13, skillCheck: false},
                    {text: "Check the 'Master' door", nextSection: 36, skillCheck: false}
                ],
                action: function() {
                    return "The runes pulse faintly with dark energy.";
                }
            },
            16: {
                text: "After your mapping attempt, you return to exploring.",
                choices: [
                    {text: "Go left toward the cellblocks", nextSection: 2, skillCheck: false},
                    {text: "Go right toward the sounds of metal and chanting", nextSection: 3, skillCheck: false},
                    {text: "Continue straight down the corridor", nextSection: 4, skillCheck: false}
                ]
            },
            17: {
                text: "You enter the cellblock. The guard turns toward you, raising his whip. 'No one's allowed in here!' he growls.",
                choices: [
                    {text: "Fight the guard", nextSection: 37, skillCheck: false},
                    {text: "Try to reason with him", nextSection: 38, skillCheck: false},
                    {text: "Use any authority items you have", nextSection: 39, skillCheck: false, requirement: function() { 
                        return gameState.inventory.some(item => item.includes('Signet') || item.includes('Amulet') || item.includes('Crown'));
                    }},
                    {text: "Retreat and close the door", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('guard');
                    return "<span class='guard'>Dungeon Guard</span>: 'You shouldn't be here, stranger.'";
                }
            },
            18: {
                text: "With the guard distracted, you slip into the cellblock. The prisoners notice you immediately, their eyes wide with fear and hope.",
                choices: [
                    {text: "Try to free the prisoners", nextSection: 40, skillCheck: false},
                    {text: "Ask about the dungeon layout", nextSection: 41, skillCheck: false},
                    {text: "Search for keys", nextSection: 42, skillCheck: false},
                    {text: "Leave before the guard returns", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('prisoner');
                    return "<span class='prisoner'>A prisoner</span> whispers: 'Please, help us...'";
                }
            },
            19: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 43, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You squeeze through the ventilation shaft and drop into the cellblock, unnoticed by the guard.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You get stuck in the shaft! It takes painful effort to free yourself, dealing " + damage + " damage.";
                    }
                }
            },
            20: {
                text: "Having observed the ritual, you slip away unnoticed. You now know the blood mages' methods.",
                choices: [
                    {text: "Return to the main corridor", nextSection: 1, skillCheck: false},
                    {text: "Try to sabotage their work", nextSection: 44, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Blood Ritual Knowledge');
                    playSound('item');
                    return "You gain valuable knowledge about blood magic rituals.";
                }
            },
            21: {
                text: "With the blood mages defeated, their ritual chamber falls silent. The caged creatures whimper in their cages.",
                choices: [
                    {text: "Free the caged creatures", nextSection: 45, skillCheck: false},
                    {text: "Search the ritual chamber", nextSection: 46, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    gameState.bloodMageDefeated = true;
                    const goldFound = rollDice(6, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the blood mages! You find <span class='gold'>" + goldFound + " Gold</span> and various ritual components.";
                }
            },
            22: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 48, skillCheck: false}
                ]
            },
            23: {
                text: "With the angered blood mages defeated, you stand in the ritual chamber.",
                choices: [
                    {text: "Free the caged creatures", nextSection: 45, skillCheck: false},
                    {text: "Search the ritual chamber", nextSection: 46, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    gameState.bloodMageDefeated = true;
                    const goldFound = rollDice(7, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the blood mages! You find <span class='gold'>" + goldFound + " Gold</span> among their robes.";
                }
            },
            24: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 49, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully open the cages! The creatures, however, don't seem grateful - they snarl at you before scurrying off into the darkness.";
                    } else {
                        // Creatures attack
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "One of the creatures bites you as you try to free it, dealing " + damage + " damage!";
                    }
                }
            },
            25: {
                text: "You decide to leave the creatures caged. They continue to whimper and snarl as you retreat.",
                choices: [
                    {text: "Observe the ritual", nextSection: 9, skillCheck: false},
                    {text: "Interrupt the ritual", nextSection: 10, skillCheck: false},
                    {text: "Return to the main corridor", nextSection: 1, skillCheck: false}
                ]
            },
            26: {
                text: "You attack the torturer! He turns with surprising speed, his eyes narrowing as he raises his blood-stained blade.",
                choices: [
                    {text: "Fight the torturer", nextSection: 50, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Master Torturer";
                    combatState.enemyHealth = 85;
                    combatState.enemyCurrentHealth = 85;
                    combatState.enemyStrength = 16;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 51;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('torture');
                    return "<span class='torturer'>Master Torturer</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            27: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip past the torturer unnoticed. He continues sharpening his blade, humming to himself.";
                    } else {
                        // Torturer notices and attacks
                        combatState.active = true;
                        combatState.enemyName = "Alerted Torturer";
                        combatState.enemyHealth = 75;
                        combatState.enemyCurrentHealth = 75;
                        combatState.enemyStrength = 15;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 8;
                        combatState.nextSection = 53;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('torture');
                        return "The torturer notices you!<br><br><span class='torturer'>Alerted Torturer</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            28: {
                text: "You search the torture chamber while the torturer is occupied. In a cabinet, you find various tools and a few personal items.",
                choices: [
                    {text: "Take the tools", nextSection: 54, skillCheck: false},
                    {text: "Take the personal items", nextSection: 55, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> in a small lockbox.";
                }
            },
            29: {
                text: "You search the storage room shelves. Among the jars and tools, you find several useful items.",
                choices: [
                    {text: "Take surgical tools", nextSection: 56, skillCheck: false},
                    {text: "Take chemical substances", nextSection: 57, skillCheck: false},
                    {text: "Take the parchments", nextSection: 31, skillCheck: false},
                    {text: "Leave the storage room", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> hidden behind some jars.";
                }
            },
            30: {
                text: "You take various useful-looking items from the storage room.",
                choices: [
                    {text: "Leave the storage room", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Surgical Tools');
                    addToInventory('Strange Chemicals');
                    playSound('item');
                    return "You take <span class='item'>Surgical Tools</span> and <span class='item'>Strange Chemicals</span>. They might have uses.";
                }
            },
            31: {
                text: "The parchments contain detailed notes on Valerius's experiments: methods for creating various undead, notes on blood magic, and anatomical diagrams.",
                choices: [
                    {text: "Take the notes", nextSection: 58, skillCheck: false},
                    {text: "Search the shelves", nextSection: 29, skillCheck: false}
                ],
                action: function() {
                    gameState.hasLaboratoryNotes = true;
                    addToInventory('Valerius Experiment Notes');
                    playSound('item');
                    return "You take <span class='item'>Valerius Experiment Notes</span>. This knowledge could be invaluable against him.";
                }
            },
            32: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 59, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You hear guards talking inside: '...the master wants the new batch ready by tomorrow...' '...the warden is in a foul mood since that prisoner escaped...'";
                    } else {
                        playSound('failure');
                        return "You can't make out what's being said through the thick door.";
                    }
                }
            },
            33: {
                text: "You try to open the reinforced door. It's locked from the inside.",
                choices: [
                    {text: "Try to force it open", nextSection: 60, skillCheck: true, checkType: 'strength', difficulty: 20},
                    {text: "Look for another way", nextSection: 34, skillCheck: false},
                    {text: "Return up the corridor", nextSection: 4, skillCheck: false}
                ]
            },
            34: {
                text: "Looking for another way, you find a small service hatch near the ceiling. It looks like it might connect to the next room.",
                choices: [
                    {text: "Try to climb up to the hatch", nextSection: 61, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Try to force the door", nextSection: 60, skillCheck: false},
                    {text: "Return up the corridor", nextSection: 4, skillCheck: false}
                ]
            },
            35: {
                text: "The 'Transformation' door leads to a laboratory filled with strange equipment: bubbling vats, surgical tables, and cages containing... things that were once human.",
                choices: [
                    {text: "Examine the laboratory", nextSection: 62, skillCheck: false},
                    {text: "Search for notes or plans", nextSection: 63, skillCheck: false},
                    {text: "Try to destroy the equipment", nextSection: 64, skillCheck: false},
                    {text: "Leave the laboratory", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    playSound('experiment');
                    return "<span class='experiment'>This is where Valerius creates his undead servants.</span>";
                }
            },
            36: {
                text: "The 'Master' door is larger and more ornate than the others. It's locked with a complex mechanism. This must lead to the warden's quarters or something equally important.",
                choices: [
                    {text: "Try to pick the lock", nextSection: 65, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Try to force the door", nextSection: 66, skillCheck: true, checkType: 'strength', difficulty: 22},
                    {text: "Look for a key", nextSection: 67, skillCheck: false},
                    {text: "Return to the corridor", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    return "This door feels important. Something valuable must be behind it.";
                }
            },
            37: {
                text: "You fight the dungeon guard! He's strong and well-trained.",
                choices: [
                    {text: "Fight the guard", nextSection: 68, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Dungeon Guard";
                    combatState.enemyHealth = 70;
                    combatState.enemyCurrentHealth = 70;
                    combatState.enemyStrength = 15;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 69;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('guard');
                    return "<span class='guard'>Dungeon Guard</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            38: {
                text: "You try to reason with the guard. 'I'm here to stop Valerius,' you say. The guard laughs harshly. 'Another fool with a death wish. The master rewards loyalty, not rebellion.'",
                choices: [
                    {text: "Attack the guard", nextSection: 37, skillCheck: false},
                    {text: "Try to bribe him", nextSection: 70, skillCheck: false},
                    {text: "Use any authority items you have", nextSection: 39, skillCheck: false}
                ],
                action: function() {
                    return "<span class='guard'>Dungeon Guard</span>: 'Leave now, and I might forget I saw you.'";
                }
            },
            39: {
                text: "You show the guard any authority items you have.",
                choices: [
                    {text: "Show Valerius Signet Ring if you have it", nextSection: 71, skillCheck: false, requirement: 'Valerius Signet Ring'},
                    {text: "Show Ancient Vampire Amulet if you have it", nextSection: 72, skillCheck: false, requirement: 'Ancient Vampire Amulet'},
                    {text: "Show Skeleton King Crown if you have it", nextSection: 73, skillCheck: false, requirement: 'Skeleton King Crown'},
                    {text: "Return to other options", nextSection: 17, skillCheck: false}
                ],
                action: function() {
                    // This will be handled by the specific choice
                    return "";
                }
            },
            40: {
                text: "You try to free the prisoners. Their cells are locked with heavy padlocks.",
                choices: [
                    {text: "Try to break the locks", nextSection: 74, skillCheck: true, checkType: 'strength', difficulty: 18},
                    {text: "Look for keys", nextSection: 42, skillCheck: false},
                    {text: "Ask the prisoners about keys", nextSection: 75, skillCheck: false}
                ],
                action: function() {
                    playSound('prisoner');
                    return "<span class='prisoner'>A prisoner</span>: 'The guard has the keys on his belt!'";
                }
            },
            41: {
                text: "You ask the prisoners about the dungeon layout. One of them, an older man with haunted eyes, speaks up: 'I've been here... a long time. I know the ways.'",
                choices: [
                    {text: "Ask for directions", nextSection: 76, skillCheck: false},
                    {text: "Ask about Valerius", nextSection: 77, skillCheck: false},
                    {text: "Ask about dangers", nextSection: 78, skillCheck: false}
                ]
            },
            42: {
                text: "You search for keys. The guard's body has a heavy ring of keys on his belt.",
                choices: [
                    {text: "Take the keys", nextSection: 79, skillCheck: false},
                    {text: "Try to free the prisoners", nextSection: 40, skillCheck: false}
                ],
                action: function() {
                    gameState.hasWardenKey = true;
                    addToInventory('Guard Key Ring');
                    playSound('item');
                    return "You take the <span class='item'>Guard Key Ring</span>. These should open the cells.";
                }
            },
            43: {
                text: "After entering through the ventilation shaft, you're in the cellblock. The guard hasn't noticed you yet.",
                choices: [
                    {text: "Try to free the prisoners", nextSection: 40, skillCheck: false},
                    {text: "Sneak past the guard", nextSection: 80, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Attack the guard from behind", nextSection: 81, skillCheck: false}
                ]
            },
            44: {
                text: "You attempt to sabotage the blood mages' work. Their ritual components are laid out on the altar.",
                choices: [
                    {text: "Contaminate the blood vials", nextSection: 82, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Steal the ritual focus", nextSection: 83, skillCheck: false},
                    {text: "Destroy the altar", nextSection: 84, skillCheck: false}
                ],
                action: function() {
                    playSound('ritual');
                    return "The blood mages are focused on their ritual. You might be able to disrupt it.";
                }
            },
            45: {
                text: "You free the caged creatures. They burst from their cages, snarling and confused. Instead of attacking you, they turn on each other, then scatter into the darkness.",
                choices: [
                    {text: "Search the ritual chamber", nextSection: 46, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    playSound('mutant');
                    return "The creatures' rampage will cause chaos in the dungeon.";
                }
            },
            46: {
                text: "You search the ritual chamber. Among the blood mages' belongings, you find valuable items.",
                choices: [
                    {text: "Take everything useful", nextSection: 85, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(8, 10);
                    gameState.gold += goldFound;
                    addToInventory('Blood Mage Robes');
                    gameState.hasBloodVial = true;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span>, <span class='item'>Blood Mage Robes</span>, and a <span class='item'>Vial of Powerful Blood</span>.";
                }
            },
            47: {
                text: "You leave the ritual chamber and return to the main corridor.",
                choices: [
                    {text: "Go left toward the cellblocks", nextSection: 2, skillCheck: false},
                    {text: "Continue straight down the corridor", nextSection: 4, skillCheck: false}
                ]
            },
            48: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 22, skillCheck: false}
                ]
            },
            49: {
                text: "After dealing with the caged creatures, you're back in the ritual chamber.",
                choices: [
                    {text: "Observe the ritual", nextSection: 9, skillCheck: false},
                    {text: "Interrupt the ritual", nextSection: 10, skillCheck: false},
                    {text: "Return to the main corridor", nextSection: 1, skillCheck: false}
                ]
            },
            50: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 86, skillCheck: false}
                ]
            },
            51: {
                text: "With the torturer defeated, the torture chamber is yours to search.",
                choices: [
                    {text: "Search the chamber thoroughly", nextSection: 87, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    gameState.tortureChamberCleared = true;
                    const goldFound = rollDice(6, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the torturer! You find <span class='gold'>" + goldFound + " Gold</span> hidden in his apron.";
                }
            },
            52: {
                text: "Having slipped past the torturer, you find yourself in a smaller chamber beyond the torture room. This appears to be his personal quarters.",
                choices: [
                    {text: "Search the quarters", nextSection: 89, skillCheck: false},
                    {text: "Continue through to the next area", nextSection: 90, skillCheck: false},
                    {text: "Return through the torture chamber", nextSection: 4, skillCheck: false}
                ]
            },
            53: {
                text: "With the alerted torturer defeated, you can explore the chamber.",
                choices: [
                    {text: "Search the chamber", nextSection: 87, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    gameState.tortureChamberCleared = true;
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the torturer and find <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            54: {
                text: "You take the torture tools. They're cruel-looking but might have other uses.",
                choices: [
                    {text: "Leave the chamber", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    gameState.hasTortureTools = true;
                    addToInventory('Torturer Tools');
                    playSound('item');
                    return "You take the <span class='item'>Torturer Tools</span>. They're heavy and sharp.";
                }
            },
            55: {
                text: "You take the personal items from the cabinet. Among them is a locket with a faded portrait.",
                choices: [
                    {text: "Leave the chamber", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Torturer Locket');
                    playSound('item');
                    return "You take a <span class='item'>Torturer Locket</span>. Even monsters have loved ones, it seems.";
                }
            },
            56: {
                text: "You take the surgical tools. They're well-made and sharp.",
                choices: [
                    {text: "Take the chemical substances", nextSection: 57, skillCheck: false},
                    {text: "Leave the storage room", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Surgical Tools');
                    playSound('item');
                    return "You take <span class='item'>Surgical Tools</span>. They could be used for healing or... other purposes.";
                }
            },
            57: {
                text: "You take the chemical substances. The labels are in vampire script, but you recognize some as poisons, others as preserving agents.",
                choices: [
                    {text: "Take the surgical tools", nextSection: 56, skillCheck: false},
                    {text: "Leave the storage room", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Chemical Substances');
                    playSound('item');
                    return "You take <span class='item'>Chemical Substances</span>. Handle with care.";
                }
            },
            58: {
                text: "With Valerius's notes in hand, you search the rest of the storage room.",
                choices: [
                    {text: "Search the shelves", nextSection: 29, skillCheck: false},
                    {text: "Leave the storage room", nextSection: 4, skillCheck: false}
                ]
            },
            59: {
                text: "After listening at the door, you have a better idea of what's inside.",
                choices: [
                    {text: "Try to open the door", nextSection: 33, skillCheck: false},
                    {text: "Look for another way", nextSection: 34, skillCheck: false},
                    {text: "Return up the corridor", nextSection: 4, skillCheck: false}
                ]
            },
            60: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 91, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With great effort, you force the reinforced door open! It groans in protest but yields.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The door doesn't budge. You strain yourself, taking " + damage + " damage.";
                    }
                }
            },
            61: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 92, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You climb up to the service hatch and slip through. You're now in the guard barracks, unnoticed.";
                    } else {
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You slip and fall, taking " + damage + " damage!";
                    }
                }
            },
            62: {
                text: "The laboratory is a nightmare of science and dark magic. Vats bubble with strange fluids, surgical tables are stained with blood, and notes are scattered everywhere.",
                choices: [
                    {text: "Examine the vats", nextSection: 93, skillCheck: false},
                    {text: "Search for notes or plans", nextSection: 63, skillCheck: false},
                    {text: "Try to destroy the equipment", nextSection: 64, skillCheck: false},
                    {text: "Leave the laboratory", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    playSound('experiment');
                    return "This place is an abomination.";
                }
            },
            63: {
                text: "You find detailed notes on Valerius's experiments. They describe the process of creating various undead servants from living subjects.",
                choices: [
                    {text: "Take the notes", nextSection: 94, skillCheck: false},
                    {text: "Examine the vats", nextSection: 93, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Laboratory Experiment Notes');
                    playSound('item');
                    return "You take <span class='item'>Laboratory Experiment Notes</span>. The details are horrifying.";
                }
            },
            64: {
                text: "You attempt to destroy the laboratory equipment. It's well-made and sturdy.",
                choices: [
                    {text: "Smash the vats", nextSection: 95, skillCheck: true, checkType: 'strength', difficulty: 18},
                    {text: "Overturn the surgical tables", nextSection: 96, skillCheck: false},
                    {text: "Set fire to the notes", nextSection: 97, skillCheck: false}
                ],
                action: function() {
                    playSound('experiment');
                    return "Destroying this place would be a blow to Valerius's work.";
                }
            },
            65: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 98, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully pick the lock! The door swings open silently.";
                    } else {
                        playSound('failure');
                        return "The lock is too complex. You cannot pick it.";
                    }
                }
            },
            66: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 99, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With immense strength, you force the door open! The lock breaks with a loud snap.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The door doesn't budge. You strain yourself, taking " + damage + " damage.";
                    }
                }
            },
            67: {
                text: "You look for a key to the 'Master' door. There's no obvious keyhole, but you notice a hidden panel next to the door.",
                choices: [
                    {text: "Examine the hidden panel", nextSection: 100, skillCheck: false},
                    {text: "Try to pick the lock", nextSection: 65, skillCheck: false},
                    {text: "Return to the corridor", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    return "The panel is cleverly concealed but not invisible to a careful eye.";
                }
            },
            68: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 101, skillCheck: false}
                ]
            },
            69: {
                text: "With the guard defeated, you can now explore the cellblock freely.",
                choices: [
                    {text: "Free the prisoners", nextSection: 40, skillCheck: false},
                    {text: "Search the guard's body", nextSection: 42, skillCheck: false},
                    {text: "Search the cellblock", nextSection: 102, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the guard! You find <span class='gold'>" + goldFound + " Gold</span> on his body.";
                }
            },
            70: {
                text: "You try to bribe the guard. He eyes your gold pouch. 'Tempting,' he says, 'but Valerius pays better... and punishes betrayal worse.'",
                choices: [
                    {text: "Attack the guard", nextSection: 37, skillCheck: false},
                    {text: "Offer more gold", nextSection: 103, skillCheck: false},
                    {text: "Use any authority items you have", nextSection: 39, skillCheck: false}
                ],
                action: function() {
                    return "<span class='guard'>Dungeon Guard</span>: 'Nice try. Now leave.'";
                }
            },
            71: {
                text: "You show the Valerius Signet Ring. The guard's eyes widen. 'My lord's seal... Forgive me, I didn't know you were on the master's business.' He steps aside.",
                choices: [
                    {text: "Enter the cellblock", nextSection: 104, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "";
                }
            },
            72: {
                text: "You show the Ancient Vampire Amulet. The guard recognizes it. 'An ancient artifact... You have the right to be here.' He steps aside.",
                choices: [
                    {text: "Enter the cellblock", nextSection: 104, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "";
                }
            },
            73: {
                text: "You show the Skeleton King Crown. The guard bows slightly. 'A crown of authority... Pass, your majesty.' He steps aside.",
                choices: [
                    {text: "Enter the cellblock", nextSection: 104, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "";
                }
            },
            74: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 105, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.prisonersFreed = true;
                        playSound('success');
                        return "You break the locks! The prisoners flood out of their cells, thanking you profusely before fleeing toward the exit.";
                    } else {
                        playSound('failure');
                        return "The locks are too strong. You cannot break them.";
                    }
                }
            },
            75: {
                text: "You ask the prisoners about keys. One says, 'The warden has a master key. He's in his quarters at the dungeon's heart.'",
                choices: [
                    {text: "Try to break the locks", nextSection: 74, skillCheck: false},
                    {text: "Look for the warden's quarters", nextSection: 106, skillCheck: false}
                ],
                action: function() {
                    playSound('prisoner');
                    return "<span class='prisoner'>Another prisoner adds</span>: 'But be careful. The warden is... not human anymore.'";
                }
            },
            76: {
                text: "The prisoner gives you directions: 'The warden's quarters are to the east. The laboratories are south. The exit to the master's quarters is at the lowest level, guarded by the warden himself.'",
                choices: [
                    {text: "Ask about Valerius", nextSection: 77, skillCheck: false},
                    {text: "Ask about dangers", nextSection: 78, skillCheck: false},
                    {text: "Try to free the prisoners", nextSection: 40, skillCheck: false}
                ]
            },
            77: {
                text: "You ask about Valerius. The prisoners shudder. 'He comes here sometimes,' one says. 'To select subjects for his experiments. He takes the strongest, the healthiest...'",
                choices: [
                    {text: "Ask for directions", nextSection: 76, skillCheck: false},
                    {text: "Ask about dangers", nextSection: 78, skillCheck: false}
                ],
                action: function() {
                    return "<span class='prisoner'>Another whispers</span>: 'He's worse than any monster. He creates monsters.'";
                }
            },
            78: {
                text: "You ask about dangers. 'The guards are bad enough,' a prisoner says. 'But there are worse things. Experiments that escaped their cages. The warden, who's become something... else. And the blood mages in the ritual chamber.'",
                choices: [
                    {text: "Ask for directions", nextSection: 76, skillCheck: false},
                    {text: "Ask about Valerius", nextSection: 77, skillCheck: false}
                ],
                action: function() {
                    return "<span class='prisoner'>An old man adds</span>: 'And the walls themselves seem to watch sometimes.'";
                }
            },
            79: {
                text: "With the guard's keys, you can now free the prisoners.",
                choices: [
                    {text: "Free the prisoners", nextSection: 107, skillCheck: false},
                    {text: "Search the cellblock", nextSection: 102, skillCheck: false}
                ],
                action: function() {
                    playSound('chains');
                    return "The prisoners watch you with hope in their eyes.";
                }
            },
            80: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 108, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip past the guard unnoticed. He continues his patrol, unaware of your presence.";
                    } else {
                        // Guard notices
                        combatState.active = true;
                        combatState.enemyName = "Alerted Dungeon Guard";
                        combatState.enemyHealth = 65;
                        combatState.enemyCurrentHealth = 65;
                        combatState.enemyStrength = 14;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 8;
                        combatState.nextSection = 109;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('guard');
                        return "The guard notices you!<br><br><span class='guard'>Alerted Dungeon Guard</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            81: {
                text: "You attack the guard from behind, taking him by surprise!",
                choices: [
                    {text: "Continue the attack", nextSection: 110, skillCheck: false}
                ],
                action: function() {
                    // Surprise round advantage
                    const surpriseDamage = rollDice(3, 6);
                    
                    combatState.active = true;
                    combatState.enemyName = "Surprised Dungeon Guard";
                    combatState.enemyHealth = 70 - surpriseDamage;
                    combatState.enemyCurrentHealth = 70 - surpriseDamage;
                    combatState.enemyStrength = 13; // Lower due to surprise
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 111;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('combat');
                    return "You strike from behind for " + surpriseDamage + " damage!<br><br><span class='guard'>Surprised Dungeon Guard</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            82: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 112, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully contaminate the blood vials! The ritual will fail or backfire.";
                    } else {
                        // Blood mages notice
                        combatState.active = true;
                        combatState.enemyName = "Enraged Blood Mages";
                        combatState.enemyHealth = 85;
                        combatState.enemyCurrentHealth = 85;
                        combatState.enemyStrength = 16;
                        combatState.enemyDamageDice = 3;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 113;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 3;
                        
                        playSound('bloodmage');
                        return "The blood mages catch you tampering!<br><br><span class='bloodmage'>Enraged Blood Mages (3)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            83: {
                text: "You steal the ritual focus from the altar. It's a crystal that pulses with dark energy.",
                choices: [
                    {text: "Quickly leave the chamber", nextSection: 114, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Destroy the focus", nextSection: 115, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Dark Ritual Focus');
                    playSound('item');
                    return "You take the <span class='item'>Dark Ritual Focus</span>. The blood mages will be unable to complete their ritual without it.";
                }
            },
            84: {
                text: "You attempt to destroy the altar. It's made of solid stone.",
                choices: [
                    {text: "Smash it with your weapon", nextSection: 116, skillCheck: true, checkType: 'strength', difficulty: 20},
                    {text: "Use holy water if you have it", nextSection: 117, skillCheck: false, requirement: 'Holy Water'},
                    {text: "Return to other options", nextSection: 44, skillCheck: false}
                ],
                action: function() {
                    playSound('ritual');
                    return "The altar is the center of the blood mages' power here.";
                }
            },
            85: {
                text: "With the blood mages' belongings, you leave the ritual chamber.",
                choices: [
                    {text: "Leave the chamber", nextSection: 47, skillCheck: false}
                ]
            },
            86: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 50, skillCheck: false}
                ]
            },
            87: {
                text: "You search the torture chamber thoroughly. In addition to the obvious tools, you find hidden compartments and secret stashes.",
                choices: [
                    {text: "Take everything valuable", nextSection: 118, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(7, 10);
                    gameState.gold += goldFound;
                    addToInventory('Torturer Hidden Stash');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Torturer Hidden Stash</span> containing rare items.";
                }
            },
            88: {
                text: "You leave the torture chamber and return to the corridor.",
                choices: [
                    {text: "Check the 'Transformation' door", nextSection: 35, skillCheck: false},
                    {text: "Check the 'Storage' door", nextSection: 13, skillCheck: false},
                    {text: "Check the 'Master' door", nextSection: 36, skillCheck: false},
                    {text: "Return to the main corridor", nextSection: 4, skillCheck: false}
                ]
            },
            89: {
                text: "The torturer's quarters are surprisingly neat. A small bed, a desk, and a chest. The desk has papers, the chest is locked.",
                choices: [
                    {text: "Search the desk", nextSection: 119, skillCheck: false},
                    {text: "Try to open the chest", nextSection: 120, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Continue through to the next area", nextSection: 90, skillCheck: false}
                ]
            },
            90: {
                text: "You continue through the torturer's quarters to a door on the far side. It leads to a narrow staircase descending deeper into the dungeon.",
                choices: [
                    {text: "Descend the staircase", nextSection: 121, skillCheck: false},
                    {text: "Return to search the quarters", nextSection: 89, skillCheck: false}
                ]
            },
            91: {
                text: "After trying to force the door, you consider other options.",
                choices: [
                    {text: "Look for another way", nextSection: 34, skillCheck: false},
                    {text: "Return up the corridor", nextSection: 4, skillCheck: false}
                ]
            },
            92: {
                text: "After attempting to climb to the service hatch, you're either in the guard barracks or back in the corridor.",
                choices: [
                    {text: "Try to force the door", nextSection: 60, skillCheck: false},
                    {text: "Return up the corridor", nextSection: 4, skillCheck: false}
                ]
            },
            93: {
                text: "The vats contain strange, bubbling fluids. Some have recognizable shapes floating in them - body parts, entire bodies in various stages of transformation.",
                choices: [
                    {text: "Destroy the vats", nextSection: 122, skillCheck: false},
                    {text: "Search for notes or plans", nextSection: 63, skillCheck: false},
                    {text: "Leave the laboratory", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    playSound('experiment');
                    return "This is where Valerius's undead are 'born'.";
                }
            },
            94: {
                text: "With the laboratory notes, you examine the vats.",
                choices: [
                    {text: "Examine the vats", nextSection: 93, skillCheck: false},
                    {text: "Try to destroy the equipment", nextSection: 64, skillCheck: false}
                ]
            },
            95: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 123, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.laboratoryDestroyed = true;
                        playSound('success');
                        return "You smash the vats! Strange fluids flood the floor, and the laboratory is ruined. Valerius will have to start over.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The vats are reinforced! Shards fly as you strike, dealing " + damage + " damage to you.";
                    }
                }
            },
            96: {
                text: "You overturn the surgical tables. Equipment clatters to the floor, breaking.",
                choices: [
                    {text: "Continue destroying equipment", nextSection: 124, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "You wreck the surgical tables! This laboratory is now less functional.";
                }
            },
            97: {
                text: "You set fire to the notes. They burn quickly, destroying Valerius's research.",
                choices: [
                    {text: "Continue destroying equipment", nextSection: 124, skillCheck: false}
                ],
                action: function() {
                    gameState.laboratoryDestroyed = true;
                    playSound('success');
                    return "The notes burn to ash! Valuable knowledge is lost forever.";
                }
            },
            98: {
                text: "The 'Master' door opens into a lavish office. This is clearly the warden's quarters. A large desk dominates the room, and weapons are displayed on the walls.",
                choices: [
                    {text: "Search the desk", nextSection: 125, skillCheck: false},
                    {text: "Examine the weapons", nextSection: 126, skillCheck: false},
                    {text: "Search for a master key", nextSection: 127, skillCheck: false},
                    {text: "Leave the quarters", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    playSound('warden');
                    return "The warden's quarters are surprisingly opulent for a dungeon.";
                }
            },
            99: {
                text: "After forcing the 'Master' door open, you enter the warden's quarters.",
                choices: [
                    {text: "Search the quarters", nextSection: 128, skillCheck: false},
                    {text: "Leave the quarters", nextSection: 4, skillCheck: false}
                ]
            },
            100: {
                text: "The hidden panel contains a keyhole. It requires a specific key.",
                choices: [
                    {text: "Try the Guard Key Ring if you have it", nextSection: 129, skillCheck: false, requirement: 'Guard Key Ring'},
                    {text: "Try any other keys you have", nextSection: 130, skillCheck: false, requirement: function() { 
                        return gameState.inventory.some(item => item.includes('Key'));
                    }},
                    {text: "Try to pick the lock", nextSection: 65, skillCheck: false},
                    {text: "Return to the corridor", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    return "The keyhole is intricate, designed for a specific key.";
                }
            },
            101: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 68, skillCheck: false}
                ]
            },
            102: {
                text: "You search the cellblock. In addition to the cells, there's a guard station with supplies.",
                choices: [
                    {text: "Take the supplies", nextSection: 131, skillCheck: false},
                    {text: "Free the prisoners", nextSection: 40, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    addToInventory('Guard Station Supplies');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and <span class='item'>Guard Station Supplies</span>.";
                }
            },
            103: {
                text: "You offer more gold to the guard. He hesitates, then shakes his head. 'No. My loyalty is to Valerius. Now die!'",
                choices: [
                    {text: "Fight the guard", nextSection: 37, skillCheck: false}
                ],
                action: function() {
                    return "<span class='guard'>Dungeon Guard</span>: 'You should have left when you had the chance!'";
                }
            },
            104: {
                text: "The guard lets you pass into the cellblock. The prisoners watch you warily.",
                choices: [
                    {text: "Try to free the prisoners", nextSection: 40, skillCheck: false},
                    {text: "Ask about the dungeon layout", nextSection: 41, skillCheck: false},
                    {text: "Continue through the cellblock", nextSection: 132, skillCheck: false}
                ]
            },
            105: {
                text: "After trying to break the locks, you consider other options.",
                choices: [
                    {text: "Look for keys", nextSection: 42, skillCheck: false},
                    {text: "Ask the prisoners about keys", nextSection: 75, skillCheck: false}
                ]
            },
            106: {
                text: "You decide to look for the warden's quarters to get the master key.",
                choices: [
                    {text: "Check the 'Master' door in the main corridor", nextSection: 36, skillCheck: false},
                    {text: "Ask prisoners for more specific directions", nextSection: 133, skillCheck: false}
                ]
            },
            107: {
                text: "You use the guard's keys to free the prisoners. They flood out of their cells, thanking you before fleeing toward the exit.",
                choices: [
                    {text: "Search the cellblock", nextSection: 102, skillCheck: false},
                    {text: "Continue through the cellblock", nextSection: 132, skillCheck: false}
                ],
                action: function() {
                    gameState.prisonersFreed = true;
                    playSound('success');
                    return "You free the prisoners! They promise to tell others of your bravery as they escape.";
                }
            },
            108: {
                text: "Having dealt with the guard (one way or another), you're in the cellblock.",
                choices: [
                    {text: "Try to free the prisoners", nextSection: 40, skillCheck: false},
                    {text: "Continue through the cellblock", nextSection: 132, skillCheck: false}
                ]
            },
            109: {
                text: "With the alerted guard defeated, you can explore the cellblock.",
                choices: [
                    {text: "Free the prisoners", nextSection: 40, skillCheck: false},
                    {text: "Search the guard's body", nextSection: 42, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the guard and find <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            110: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 134, skillCheck: false}
                ]
            },
            111: {
                text: "With the surprised guard defeated, you have the cellblock to yourself.",
                choices: [
                    {text: "Free the prisoners", nextSection: 40, skillCheck: false},
                    {text: "Search the guard's body", nextSection: 42, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(6, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the guard! You find <span class='gold'>" + goldFound + " Gold</span> on his body.";
                }
            },
            112: {
                text: "After your attempt to contaminate the blood vials, the ritual chamber is in chaos.",
                choices: [
                    {text: "Quickly leave", nextSection: 114, skillCheck: false},
                    {text: "Take advantage of the chaos", nextSection: 135, skillCheck: false}
                ]
            },
            113: {
                text: "With the enraged blood mages defeated, the ritual chamber is yours.",
                choices: [
                    {text: "Free the caged creatures", nextSection: 45, skillCheck: false},
                    {text: "Search the ritual chamber", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    gameState.bloodMageDefeated = true;
                    const goldFound = rollDice(9, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the blood mages! You find <span class='gold'>" + goldFound + " Gold</span> and valuable ritual components.";
                }
            },
            114: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 136, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip away from the ritual chamber unnoticed, the Dark Ritual Focus in hand.";
                    } else {
                        // Blood mages give chase
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The blood mages spot you escaping! One hurls a bolt of dark energy that grazes you, dealing " + damage + " damage.";
                    }
                }
            },
            115: {
                text: "You destroy the Dark Ritual Focus. It shatters with a sound like breaking glass, releasing dark energy that dissipates harmlessly.",
                choices: [
                    {text: "Quickly leave the chamber", nextSection: 114, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Dark Ritual Focus');
                    playSound('success');
                    return "The ritual focus is destroyed! The blood mages' power is significantly weakened.";
                }
            },
            116: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 137, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You smash the altar! It cracks and crumbles, dark energy leaking from the fractures.";
                    } else {
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The altar resists your attack! Dark energy lashes back at you, dealing " + damage + " damage.";
                    }
                }
            },
            117: {
                text: "You use holy water on the altar. It sizzles and cracks, the dark energy within dissipating.",
                choices: [
                    {text: "Finish destroying it", nextSection: 138, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Holy Water');
                    playSound('success');
                    return "The <span class='item'>Holy Water</span> causes the altar to fracture! The blood mages' power source is destroyed.";
                }
            },
            118: {
                text: "With the torturer's stash, you leave the torture chamber.",
                choices: [
                    {text: "Leave the chamber", nextSection: 88, skillCheck: false}
                ]
            },
            119: {
                text: "The desk contains various papers: supply lists, prisoner records, and personal notes. One note mentions 'the warden's new form' with fear.",
                choices: [
                    {text: "Take any useful papers", nextSection: 139, skillCheck: false},
                    {text: "Try to open the chest", nextSection: 120, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Torturer Notes');
                    playSound('item');
                    return "You take <span class='item'>Torturer Notes</span>. They contain disturbing details.";
                }
            },
            120: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 140, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(8, 10);
                        gameState.gold += goldFound;
                        addToInventory('Torturer Treasure');
                        updateStatsDisplay();
                        playSound('item');
                        return "You open the chest! Inside is <span class='gold'>" + goldFound + " Gold</span> and <span class='item'>Torturer Treasure</span>.";
                    } else {
                        playSound('failure');
                        return "The chest is securely locked. You cannot open it.";
                    }
                }
            },
            121: {
                text: "You descend the narrow staircase. It leads to a lower level of the dungeon, darker and colder than the upper levels. The air smells of damp stone and something... hungry.",
                choices: [
                    {text: "Explore the lower level", nextSection: 141, skillCheck: false},
                    {text: "Return up the staircase", nextSection: 90, skillCheck: false}
                ],
                action: function() {
                    playSound('chains');
                    return "This feels like the heart of the dungeon's darkness.";
                }
            },
            122: {
                text: "You attempt to destroy the vats in the laboratory.",
                choices: [
                    {text: "Smash them with your weapon", nextSection: 95, skillCheck: false},
                    {text: "Use the chemicals to create an explosion", nextSection: 142, skillCheck: false, requirement: 'Chemical Substances'},
                    {text: "Search for notes or plans", nextSection: 63, skillCheck: false}
                ]
            },
            123: {
                text: "After destroying the vats, the laboratory is in ruins.",
                choices: [
                    {text: "Continue destroying equipment", nextSection: 124, skillCheck: false},
                    {text: "Leave the laboratory", nextSection: 4, skillCheck: false}
                ]
            },
            124: {
                text: "You continue wrecking the laboratory equipment. By the time you're done, the place is unusable.",
                choices: [
                    {text: "Leave the laboratory", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    gameState.laboratoryDestroyed = true;
                    playSound('success');
                    return "The laboratory is completely destroyed! Valerius's work here is ruined.";
                }
            },
            125: {
                text: "The warden's desk is covered in papers. Some are administrative, others are... disturbing. Diagrams of experiments, lists of 'subjects', and notes from Valerius himself.",
                choices: [
                    {text: "Take the valuable papers", nextSection: 143, skillCheck: false},
                    {text: "Examine the weapons", nextSection: 126, skillCheck: false},
                    {text: "Search for a master key", nextSection: 127, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Warden Papers');
                    playSound('item');
                    return "You take <span class='item'>Warden Papers</span>. They contain valuable information.";
                }
            },
            126: {
                text: "The weapons on the wall are well-made. Some are conventional, others are designed for specific... purposes.",
                choices: [
                    {text: "Take a weapon", nextSection: 144, skillCheck: false},
                    {text: "Search the desk", nextSection: 125, skillCheck: false}
                ],
                action: function() {
                    return "One weapon in particular catches your eye - a silvered mace that would be effective against undead.";
                }
            },
            127: {
                text: "You search for a master key. In a drawer of the desk, you find an ornate key made of dark iron.",
                choices: [
                    {text: "Take the key", nextSection: 145, skillCheck: false},
                    {text: "Search the desk", nextSection: 125, skillCheck: false}
                ],
                action: function() {
                    gameState.hasWardenKey = true;
                    addToInventory('Warden Master Key');
                    playSound('item');
                    return "You find the <span class='item'>Warden Master Key</span>! This should open most doors in the dungeon.";
                }
            },
            128: {
                text: "You search the warden's quarters after forcing your way in.",
                choices: [
                    {text: "Search the desk", nextSection: 125, skillCheck: false},
                    {text: "Examine the weapons", nextSection: 126, skillCheck: false},
                    {text: "Leave the quarters", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(10, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> in a strongbox.";
                }
            },
            129: {
                text: "You try the Guard Key Ring in the hidden panel. One of the keys fits! The 'Master' door unlocks with a satisfying click.",
                choices: [
                    {text: "Enter the warden's quarters", nextSection: 98, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The key works! The door unlocks.";
                }
            },
            130: {
                text: "You try various keys you have. None of them fit the intricate lock.",
                choices: [
                    {text: "Try to pick the lock", nextSection: 65, skillCheck: false},
                    {text: "Return to the corridor", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    playSound('failure');
                    return "None of your keys work in this lock.";
                }
            },
            131: {
                text: "With the guard station supplies, you consider the prisoners.",
                choices: [
                    {text: "Free the prisoners", nextSection: 40, skillCheck: false},
                    {text: "Continue through the cellblock", nextSection: 132, skillCheck: false}
                ]
            },
            132: {
                text: "You continue through the cellblock to a door at the far end. It leads to another corridor, this one even darker than the first.",
                choices: [
                    {text: "Follow the new corridor", nextSection: 146, skillCheck: false},
                    {text: "Return to the main corridor", nextSection: 1, skillCheck: false}
                ]
            },
            133: {
                text: "You ask the prisoners for more specific directions to the warden's quarters. 'Through the 'Master' door in the main corridor,' one says. 'But be warned - the warden is always there, and he's... changed.'",
                choices: [
                    {text: "Check the 'Master' door", nextSection: 36, skillCheck: false},
                    {text: "Try to free the prisoners", nextSection: 40, skillCheck: false}
                ],
                action: function() {
                    playSound('prisoner');
                    return "<span class='prisoner'>Another adds</span>: 'He wasn't always like this. Valerius did something to him.'";
                }
            },
            134: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 110, skillCheck: false}
                ]
            },
            135: {
                text: "You take advantage of the chaos in the ritual chamber to search it thoroughly.",
                choices: [
                    {text: "Search the ritual chamber", nextSection: 46, skillCheck: false},
                    {text: "Quickly leave", nextSection: 114, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "In the chaos, you quickly grab <span class='gold'>" + goldFound + " Gold</span> from the altar.";
                }
            },
            136: {
                text: "After leaving the ritual chamber, you return to the main corridor.",
                choices: [
                    {text: "Go left toward the cellblocks", nextSection: 2, skillCheck: false},
                    {text: "Continue straight down the corridor", nextSection: 4, skillCheck: false}
                ]
            },
            137: {
                text: "After your attempt to destroy the altar, the ritual chamber is in disarray.",
                choices: [
                    {text: "Free the caged creatures", nextSection: 45, skillCheck: false},
                    {text: "Search the ritual chamber", nextSection: 46, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 47, skillCheck: false}
                ]
            },
            138: {
                text: "You finish destroying the altar with the holy water. It crumbles to dust.",
                choices: [
                    {text: "Free the caged creatures", nextSection: 45, skillCheck: false},
                    {text: "Search the ritual chamber", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The altar is completely destroyed! The blood mages' power in this chamber is gone.";
                }
            },
            139: {
                text: "With the torturer's notes, you try to open the chest.",
                choices: [
                    {text: "Try to open the chest", nextSection: 120, skillCheck: false},
                    {text: "Continue through to the next area", nextSection: 90, skillCheck: false}
                ]
            },
            140: {
                text: "After dealing with the chest, you continue through the torturer's quarters.",
                choices: [
                    {text: "Continue through to the next area", nextSection: 90, skillCheck: false},
                    {text: "Return to the torture chamber", nextSection: 4, skillCheck: false}
                ]
            },
            141: {
                text: "The lower level of the dungeon is even more oppressive than the upper levels. The corridors are narrower, the darkness deeper. You hear strange scrabbling sounds in the shadows.",
                choices: [
                    {text: "Follow the main corridor", nextSection: 147, skillCheck: false},
                    {text: "Investigate the scrabbling sounds", nextSection: 148, skillCheck: false},
                    {text: "Search for a way back up", nextSection: 149, skillCheck: false}
                ],
                action: function() {
                    if (Math.random() > 0.7) {
                        randomEvents.whispers = true;
                        playSound('scream');
                        return "<br><span class='scream'>You hear whispering in the darkness, but can't make out the words...</span>";
                    }
                    return "";
                }
            },
            142: {
                text: "You use the chemicals to create an explosion! The vats shatter, flooding the laboratory with their contents.",
                choices: [
                    {text: "Get out quickly!", nextSection: 150, skillCheck: true, checkType: 'agility', difficulty: 15}
                ],
                action: function() {
                    removeFromInventory('Chemical Substances');
                    playSound('experiment');
                    return "The chemicals react violently with the vat contents!";
                }
            },
            143: {
                text: "With the warden's papers, you examine the weapons.",
                choices: [
                    {text: "Examine the weapons", nextSection: 126, skillCheck: false},
                    {text: "Search for a master key", nextSection: 127, skillCheck: false},
                    {text: "Leave the quarters", nextSection: 4, skillCheck: false}
                ]
            },
            144: {
                text: "You take a weapon from the wall - the silvered mace. It's well-balanced and effective against undead.",
                choices: [
                    {text: "Search the desk", nextSection: 125, skillCheck: false},
                    {text: "Search for a master key", nextSection: 127, skillCheck: false}
                ],
                action: function() {
                    gameState.equippedWeapon = 'Silvered Mace';
                    updateInventoryDisplay();
                    playSound('item');
                    return "You equip the <span class='item'>Silvered Mace</span>. It's a powerful weapon against undead.";
                }
            },
            145: {
                text: "With the Warden Master Key, you have access to most of the dungeon.",
                choices: [
                    {text: "Search the desk", nextSection: 125, skillCheck: false},
                    {text: "Examine the weapons", nextSection: 126, skillCheck: false},
                    {text: "Leave the quarters", nextSection: 4, skillCheck: false}
                ]
            },
            146: {
                text: "The new corridor from the cellblock leads to a junction. You can go left, right, or continue straight.",
                choices: [
                    {text: "Go left", nextSection: 151, skillCheck: false},
                    {text: "Go right", nextSection: 152, skillCheck: false},
                    {text: "Continue straight", nextSection: 153, skillCheck: false},
                    {text: "Return to the cellblock", nextSection: 132, skillCheck: false}
                ]
            },
            147: {
                text: "You follow the main corridor of the lower level. It eventually leads to a large iron door that radiates dark energy. This must be the entrance to the deepest part of the dungeon.",
                choices: [
                    {text: "Try to open the iron door", nextSection: 154, skillCheck: false},
                    {text: "Examine the door", nextSection: 155, skillCheck: false},
                    {text: "Return the way you came", nextSection: 141, skillCheck: false}
                ],
                action: function() {
                    playSound('warden');
                    return "Something powerful awaits beyond this door.";
                }
            },
            148: {
                text: "You investigate the scrabbling sounds. They lead you to a nest of strange, rat-like creatures with too many eyes. They're feeding on... something you'd rather not identify.",
                choices: [
                    {text: "Attack the creatures", nextSection: 156, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 157, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Retreat", nextSection: 141, skillCheck: false}
                ],
                action: function() {
                    playSound('mutant');
                    return "<span class='mutant'>Dungeon Rat-Things</span> screech as they notice you.";
                }
            },
            149: {
                text: "You search for a way back up to the upper levels. You find a spiral staircase leading upward.",
                choices: [
                    {text: "Ascend the staircase", nextSection: 158, skillCheck: false},
                    {text: "Continue exploring the lower level", nextSection: 141, skillCheck: false}
                ]
            },
            150: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 159, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.laboratoryDestroyed = true;
                        playSound('success');
                        return "You escape just as the laboratory explodes behind you! Valerius's work is destroyed.";
                    } else {
                        const damage = rollDice(4, 6);
                        gameState.health -= damage;
                        gameState.laboratoryDestroyed = true;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The explosion catches you! You take " + damage + " damage, but the laboratory is destroyed.";
                    }
                }
            },
            151: {
                text: "Going left leads to a dead end with a pile of bones. Something glints among them.",
                choices: [
                    {text: "Search the bones", nextSection: 160, skillCheck: false},
                    {text: "Return to the junction", nextSection: 146, skillCheck: false}
                ]
            },
            152: {
                text: "Going right leads to a small chapel of sorts, but dedicated to dark powers. A black altar stands at the far end.",
                choices: [
                    {text: "Examine the dark chapel", nextSection: 161, skillCheck: false},
                    {text: "Search the chapel", nextSection: 162, skillCheck: false},
                    {text: "Return to the junction", nextSection: 146, skillCheck: false}
                ],
                action: function() {
                    playSound('ritual');
                    return "This place feels even more evil than the rest of the dungeon.";
                }
            },
            153: {
                text: "Continuing straight leads to a set of stairs going down even further. The air grows colder with each step.",
                choices: [
                    {text: "Descend the stairs", nextSection: 163, skillCheck: false},
                    {text: "Return to the junction", nextSection: 146, skillCheck: false}
                ]
            },
            154: {
                text: "You try to open the large iron door. It's locked with a complex mechanism.",
                choices: [
                    {text: "Try the Warden Master Key if you have it", nextSection: 164, skillCheck: false, requirement: 'Warden Master Key'},
                    {text: "Try to force the door", nextSection: 165, skillCheck: true, checkType: 'strength', difficulty: 24},
                    {text: "Look for another way", nextSection: 166, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Examine the door", nextSection: 155, skillCheck: false}
                ]
            },
            155: {
                text: "The iron door is covered in runes that glow with dark energy. They seem to be both a lock and a warning. The runes say: 'Beyond lies the Heart of Darkness. Only the Worthy may enter.'",
                choices: [
                    {text: "Try to open the iron door", nextSection: 154, skillCheck: false},
                    {text: "Try to dispel the runes", nextSection: 167, skillCheck: false},
                    {text: "Return the way you came", nextSection: 141, skillCheck: false}
                ]
            },
            156: {
                text: "You attack the dungeon rat-things! They swarm toward you with surprising speed.",
                choices: [
                    {text: "Fight the creatures", nextSection: 168, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Dungeon Rat-Things";
                    combatState.enemyHealth = 50;
                    combatState.enemyCurrentHealth = 50;
                    combatState.enemyStrength = 10;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 4;
                    combatState.nextSection = 169;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 6;
                    
                    playSound('mutant');
                    return "<span class='mutant'>Dungeon Rat-Things (6)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            157: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 170, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip past the rat-things unnoticed. They continue their feeding, unaware of your presence.";
                    } else {
                        // Rat-things attack
                        combatState.active = true;
                        combatState.enemyName = "Alerted Rat-Things";
                        combatState.enemyHealth = 40;
                        combatState.enemyCurrentHealth = 40;
                        combatState.enemyStrength = 9;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 4;
                        combatState.nextSection = 171;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 4;
                        
                        playSound('mutant');
                        return "The rat-things notice you!<br><br><span class='mutant'>Alerted Rat-Things (4)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            158: {
                text: "You ascend the spiral staircase back to the upper levels of the dungeon.",
                choices: [
                    {text: "Return to the main corridor", nextSection: 1, skillCheck: false},
                    {text: "Explore nearby areas", nextSection: 4, skillCheck: false}
                ]
            },
            159: {
                text: "After the laboratory explosion, you're back in the corridor.",
                choices: [
                    {text: "Return to the main corridor", nextSection: 1, skillCheck: false}
                ]
            },
            160: {
                text: "Searching the bones, you find a few items of value among the remains.",
                choices: [
                    {text: "Take the items", nextSection: 172, skillCheck: false},
                    {text: "Return to the junction", nextSection: 146, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    addToInventory('Bone Pile Findings');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and some <span class='item'>Bone Pile Findings</span>.";
                }
            },
            161: {
                text: "The dark chapel is dedicated to some ancient evil. The altar is stained black with old blood. There are no windows, only torches that burn with unnatural green flame.",
                choices: [
                    {text: "Search the chapel", nextSection: 162, skillCheck: false},
                    {text: "Examine the altar", nextSection: 173, skillCheck: false},
                    {text: "Return to the junction", nextSection: 146, skillCheck: false}
                ],
                action: function() {
                    return "A sense of dread fills this place.";
                }
            },
            162: {
                text: "You search the dark chapel. Behind the altar, you find a hidden compartment.",
                choices: [
                    {text: "Open the compartment", nextSection: 174, skillCheck: false},
                    {text: "Examine the altar", nextSection: 173, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> in offering bowls.";
                }
            },
            163: {
                text: "You descend the stairs to the lowest level of the dungeon. The air is freezing, and the darkness is almost absolute. At the bottom, you see a faint red glow.",
                choices: [
                    {text: "Approach the red glow", nextSection: 175, skillCheck: false},
                    {text: "Return up the stairs", nextSection: 153, skillCheck: false}
                ],
                action: function() {
                    playSound('warden');
                    return "This must be the very heart of the dungeon.";
                }
            },
            164: {
                text: "You use the Warden Master Key in the lock. It turns smoothly, and the massive iron door swings open, revealing a large chamber beyond.",
                choices: [
                    {text: "Enter the chamber", nextSection: 176, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The key works perfectly. The door opens without a sound.";
                }
            },
            165: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 177, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.exitFound = true;
                        gameState.gameComplete = true;
                        showScreen('screen-next');
                        document.getElementById('next-stat-strength').textContent = gameState.strength;
                        document.getElementById('next-stat-health').textContent = gameState.health;
                        document.getElementById('next-stat-agility').textContent = gameState.agility;
                        document.getElementById('next-stat-gold').textContent = gameState.gold;
                        
                        // Display inventory that will carry over
                        const inventoryDisplay = document.getElementById('next-inventory-display');
                        inventoryDisplay.innerHTML = '';
                        
                        // Show equipped items
                        const equippedDiv = document.createElement('div');
                        equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                        inventoryDisplay.appendChild(equippedDiv);
                        
                        // Show other inventory
                        if (gameState.inventory.length > 0) {
                            const invDiv = document.createElement('div');
                            invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                            inventoryDisplay.appendChild(invDiv);
                        }
                        
                        playSound('level');
                        
                        // Save completed level state
                        gameState.level = 10;
                        saveGame();
                        
                        return "";
                    } else {
                        const damage = rollDice(4, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The door doesn't budge. The dark runes flash, dealing " + damage + " damage to you.";
                    }
                }
            },
            166: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 178, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.exitFound = true;
                        gameState.gameComplete = true;
                        showScreen('screen-next');
                        document.getElementById('next-stat-strength').textContent = gameState.strength;
                        document.getElementById('next-stat-health').textContent = gameState.health;
                        document.getElementById('next-stat-agility').textContent = gameState.agility;
                        document.getElementById('next-stat-gold').textContent = gameState.gold;
                        
                        // Display inventory that will carry over
                        const inventoryDisplay = document.getElementById('next-inventory-display');
                        inventoryDisplay.innerHTML = '';
                        
                        // Show equipped items
                        const equippedDiv = document.createElement('div');
                        equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                        inventoryDisplay.appendChild(equippedDiv);
                        
                        // Show other inventory
                        if (gameState.inventory.length > 0) {
                            const invDiv = document.createElement('div');
                            invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                            inventoryDisplay.appendChild(invDiv);
                        }
                        
                        playSound('level');
                        
                        // Save completed level state
                        gameState.level = 10;
                        saveGame();
                        
                        return "";
                    } else {
                        playSound('failure');
                        return "You find no alternative way to open the door. It requires a specific key or immense strength.";
                    }
                }
            },
            167: {
                text: "You attempt to dispel the dark runes on the door. They're incredibly powerful ancient magic.",
                choices: [
                    {text: "Try to open the door anyway", nextSection: 154, skillCheck: false},
                    {text: "Return the way you came", nextSection: 141, skillCheck: false}
                ],
                action: function() {
                    playSound('ritual');
                    return "The runes are too powerful to dispel without specialized knowledge or artifacts.";
                }
            },
            168: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 179, skillCheck: false}
                ]
            },
            169: {
                text: "With the dungeon rat-things defeated, you can continue exploring.",
                choices: [
                    {text: "Search the nest area", nextSection: 180, skillCheck: false},
                    {text: "Continue exploring the lower level", nextSection: 141, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(2, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the rat-things! You find <span class='gold'>" + goldFound + " Gold</span> in their nest.";
                }
            },
            170: {
                text: "Having slipped past the rat-things, you continue exploring the lower level.",
                choices: [
                    {text: "Continue exploring", nextSection: 141, skillCheck: false},
                    {text: "Return to the upper levels", nextSection: 149, skillCheck: false}
                ]
            },
            171: {
                text: "With the alerted rat-things defeated, you can continue.",
                choices: [
                    {text: "Search the nest area", nextSection: 180, skillCheck: false},
                    {text: "Continue exploring the lower level", nextSection: 141, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(1, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You defeat the rat-things and find <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            172: {
                text: "With the items from the bone pile, you return to the junction.",
                choices: [
                    {text: "Return to the junction", nextSection: 146, skillCheck: false}
                ]
            },
            173: {
                text: "The altar in the dark chapel is made of black stone. It feels cold to the touch, even through your gloves. There are grooves in the top for blood to flow through.",
                choices: [
                    {text: "Search the chapel", nextSection: 162, skillCheck: false},
                    {text: "Try to destroy the altar", nextSection: 181, skillCheck: false},
                    {text: "Return to the junction", nextSection: 146, skillCheck: false}
                ]
            },
            174: {
                text: "The hidden compartment contains dark ritual items and some treasure.",
                choices: [
                    {text: "Take everything", nextSection: 182, skillCheck: false},
                    {text: "Examine the altar", nextSection: 173, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(6, 10);
                    gameState.gold += goldFound;
                    addToInventory('Dark Ritual Items');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and <span class='item'>Dark Ritual Items</span>.";
                }
            },
            175: {
                text: "You approach the red glow. It comes from a large chamber at the very bottom of the dungeon. In the center of the chamber stands a monstrous figure - the Warden, transformed into something barely human.",
                choices: [
                    {text: "Confront the Warden", nextSection: 183, skillCheck: false},
                    {text: "Observe from hiding", nextSection: 184, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Retreat up the stairs", nextSection: 163, skillCheck: false}
                ],
                action: function() {
                    playSound('warden');
                    return "<span class='warden'>The Warden</span> towers over you, his form twisted by Valerius's experiments.";
                }
            },
            176: {
                text: "You enter the large chamber beyond the iron door. In the center stands the Warden, a monstrous figure who has been transformed by Valerius's experiments. He turns toward you, his eyes glowing with dark energy.",
                choices: [
                    {text: "Confront the Warden", nextSection: 183, skillCheck: false}
                ],
                action: function() {
                    playSound('warden');
                    return "<span class='warden'>The Warden</span>: 'So... another fool comes to die. Valerius will be pleased with a new subject.'";
                }
            },
            177: {
                text: "After trying to force the door, you consider other options.",
                choices: [
                    {text: "Look for another way", nextSection: 166, skillCheck: false},
                    {text: "Examine the door", nextSection: 155, skillCheck: false}
                ]
            },
            178: {
                text: "After looking for another way, you return to trying the door.",
                choices: [
                    {text: "Try to open the iron door", nextSection: 154, skillCheck: false},
                    {text: "Examine the door", nextSection: 155, skillCheck: false}
                ]
            },
            179: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 156, skillCheck: false}
                ]
            },
            180: {
                text: "You search the rat-thing nest area. Among the debris, you find a few items.",
                choices: [
                    {text: "Take the items", nextSection: 185, skillCheck: false},
                    {text: "Continue exploring the lower level", nextSection: 141, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Rat-thing Nest Loot');
                    playSound('item');
                    return "You find some <span class='item'>Rat-thing Nest Loot</span>. It's not much, but it might be useful.";
                }
            },
            181: {
                text: "You attempt to destroy the dark altar. It's made of incredibly durable stone.",
                choices: [
                    {text: "Smash it with your weapon", nextSection: 186, skillCheck: true, checkType: 'strength', difficulty: 22},
                    {text: "Use holy water if you have it", nextSection: 187, skillCheck: false, requirement: 'Holy Water'},
                    {text: "Return to other options", nextSection: 173, skillCheck: false}
                ]
            },
            182: {
                text: "With the dark ritual items, you examine the altar.",
                choices: [
                    {text: "Examine the altar", nextSection: 173, skillCheck: false},
                    {text: "Return to the junction", nextSection: 146, skillCheck: false}
                ]
            },
            183: {
                text: "You confront the Warden! He's a massive, twisted creature, part man, part something else. Dark energy crackles around him.",
                choices: [
                    {text: "Fight the Warden", nextSection: 188, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "The Warden";
                    combatState.enemyHealth = 120;
                    combatState.enemyCurrentHealth = 120;
                    combatState.enemyStrength = 20;
                    combatState.enemyDamageDice = 4;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 189;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('warden');
                    return "<span class='warden'>The Warden</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            184: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 190, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You observe the Warden unseen. He seems to be guarding a door on the far side of the chamber - the exit to Valerius's quarters!";
                    } else {
                        // Warden notices you
                        combatState.active = true;
                        combatState.enemyName = "Alerted Warden";
                        combatState.enemyHealth = 110;
                        combatState.enemyCurrentHealth = 110;
                        combatState.enemyStrength = 19;
                        combatState.enemyDamageDice = 4;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 191;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('warden');
                        return "The Warden notices you!<br><br><span class='warden'>Alerted Warden</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            185: {
                text: "With the nest loot, you continue exploring.",
                choices: [
                    {text: "Continue exploring the lower level", nextSection: 141, skillCheck: false}
                ]
            },
            186: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 192, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You smash the dark altar! It cracks and crumbles, the dark energy within dissipating.";
                    } else {
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The altar resists your attack! Dark energy lashes back, dealing " + damage + " damage.";
                    }
                }
            },
            187: {
                text: "You use holy water on the dark altar. It sizzles and cracks, the dark energy within leaking out.",
                choices: [
                    {text: "Finish destroying it", nextSection: 193, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Holy Water');
                    playSound('success');
                    return "The <span class='item'>Holy Water</span> causes the altar to fracture! Its power is broken.";
                }
            },
            188: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 194, skillCheck: false}
                ]
            },
            189: {
                text: "With the Warden defeated, the path to Valerius's quarters is open! Beyond the door the Warden was guarding, you see a staircase leading upward to the master quarters.",
                choices: [
                    {text: "Enter the master quarters", nextSection: 195, skillCheck: false}
                ],
                action: function() {
                    gameState.wardenDefeated = true;
                    gameState.exitFound = true;
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 10;
                    saveGame();
                    
                    return "";
                }
            },
            190: {
                text: "After observing the Warden, you prepare to confront him.",
                choices: [
                    {text: "Confront the Warden", nextSection: 183, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 196, skillCheck: true, checkType: 'agility', difficulty: 20},
                    {text: "Retreat up the stairs", nextSection: 163, skillCheck: false}
                ]
            },
            191: {
                text: "With the alerted Warden defeated, the path is open.",
                choices: [
                    {text: "Enter the master quarters", nextSection: 195, skillCheck: false}
                ],
                action: function() {
                    gameState.wardenDefeated = true;
                    gameState.exitFound = true;
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 10;
                    saveGame();
                    
                    return "";
                }
            },
            192: {
                text: "After your attempt to destroy the altar, the dark chapel is in disarray.",
                choices: [
                    {text: "Search the chapel", nextSection: 162, skillCheck: false},
                    {text: "Return to the junction", nextSection: 146, skillCheck: false}
                ]
            },
            193: {
                text: "You finish destroying the dark altar with holy water. It crumbles to dust.",
                choices: [
                    {text: "Search the chapel", nextSection: 162, skillCheck: false},
                    {text: "Return to the junction", nextSection: 146, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The dark altar is completely destroyed! Its evil influence is gone.";
                }
            },
            194: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 188, skillCheck: false}
                ]
            },
            195: {
                text: "YOU HAVE DEFEATED THE WARDEN! The path to Valerius's personal quarters is now open. You stand at the bottom of a grand staircase leading upward to the final confrontation.",
                choices: [],
                action: function() {
                    // This is handled in section 189
                    return "";
                }
            },
            196: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 197, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.exitFound = true;
                        gameState.gameComplete = true;
                        showScreen('screen-next');
                        document.getElementById('next-stat-strength').textContent = gameState.strength;
                        document.getElementById('next-stat-health').textContent = gameState.health;
                        document.getElementById('next-stat-agility').textContent = gameState.agility;
                        document.getElementById('next-stat-gold').textContent = gameState.gold;
                        
                        // Display inventory that will carry over
                        const inventoryDisplay = document.getElementById('next-inventory-display');
                        inventoryDisplay.innerHTML = '';
                        
                        // Show equipped items
                        const equippedDiv = document.createElement('div');
                        equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                        inventoryDisplay.appendChild(equippedDiv);
                        
                        // Show other inventory
                        if (gameState.inventory.length > 0) {
                            const invDiv = document.createElement('div');
                            invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                            inventoryDisplay.appendChild(invDiv);
                        }
                        
                        playSound('level');
                        
                        // Save completed level state
                        gameState.level = 10;
                        saveGame();
                        
                        return "";
                    } else {
                        // Warden notices
                        combatState.active = true;
                        combatState.enemyName = "Warden Catching You";
                        combatState.enemyHealth = 100;
                        combatState.enemyCurrentHealth = 100;
                        combatState.enemyStrength = 18;
                        combatState.enemyDamageDice = 3;
                        combatState.enemyDamageSides = 8;
                        combatState.nextSection = 198;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('warden');
                        return "The Warden catches you trying to sneak past!<br><br><span class='warden'>Warden Catching You</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            197: {
                text: "You successfully sneak past the Warden! The path to Valerius's quarters is now open.",
                choices: [
                    {text: "Enter the master quarters", nextSection: 195, skillCheck: false}
                ]
            },
            198: {
                text: "With the Warden defeated after catching you, the path is open.",
                choices: [
                    {text: "Enter the master quarters", nextSection: 195, skillCheck: false}
                ],
                action: function() {
                    gameState.wardenDefeated = true;
                    gameState.exitFound = true;
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 10;
                    saveGame();
                    
                    return "";
                }
            }
        };
        
        // Initialize game for Level 9
        function initGame() {
            // Load game state from Level 8
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 9 (coming from Level 8)
                if (savedState.level === 9) {
                    Object.assign(gameState, savedState);
                    
                    // Update intro screen with loaded stats
                    document.getElementById('intro-stat-strength').textContent = gameState.strength;
                    document.getElementById('intro-stat-health').textContent = gameState.health;
                    document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('intro-stat-agility').textContent = gameState.agility;
                    document.getElementById('intro-stat-gold').textContent = gameState.gold;
                    
                    // Generate dungeon map if not already generated
                    if (!gameState.dungeonMap || Object.keys(gameState.dungeonMap).length === 0) {
                        generateDungeonMap();
                    }
                    
                    showScreen('screen-intro');
                    return;
                } else if (savedState.level === 8) {
                    // If coming directly from Level 8 without completing it
                    alert("You must complete Level 8 first!");
                    window.location.href = 'l8.html';
                    return;
                } else if (savedState.level === 7) {
                    // If saved level is 7, redirect to level 7
                    alert("You need to complete Level 7 first!");
                    window.location.href = 'l7.html';
                    return;
                } else {
                    // If no valid save, start from beginning
                    alert("No valid saved game found. Starting from Level 1.");
                    window.location.href = 'l1.html';
                    return;
                }
            } else {
                // No saved game found
                alert("No saved game found. Starting from Level 1.");
                window.location.href = 'l1.html';
                return;
            }
        }
        
        function startLevel9() {
            playSound('click');
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item) && item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Show dungeon map
        function showDungeonMap() {
            playSound('click');
            
            // Update explored percentage
            const totalCells = 11 * 11; // 11x11 grid
            const exploredCells = gameState.exploredDungeonSections.length;
            const exploredPercent = Math.round((exploredCells / totalCells) * 100);
            document.getElementById('explored-percent').textContent = exploredPercent;
            
            // Generate map display
            const mapDiv = document.getElementById('dungeon-map');
            mapDiv.innerHTML = '';
            
            for (let y = 0; y < 11; y++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'map-row';
                
                for (let x = 0; x < 11; x++) {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'map-cell';
                    
                    // Check if this is player position
                    if (gameState.currentPosition.x === x && gameState.currentPosition.y === y) {
                        cellDiv.className += ' player';
                        cellDiv.textContent = 'P';
                    }
                    // Check if this is exit position
                    else if (gameState.exitPosition.x === x && gameState.exitPosition.y === y) {
                        cellDiv.className += ' exit';
                        cellDiv.textContent = 'E';
                    }
                    // Check if explored
                    else if (gameState.exploredDungeonSections.includes(`${x},${y}`)) {
                        // Check room type
                        if (gameState.dungeonMap[y] && gameState.dungeonMap[y][x]) {
                            const roomType = gameState.dungeonMap[y][x].type;
                            if (roomType === 'cellblock') {
                                cellDiv.className += ' cellblock';
                                cellDiv.textContent = 'C';
                            } else if (roomType === 'torture') {
                                cellDiv.className += ' torture';
                                cellDiv.textContent = 'T';
                            } else if (roomType === 'laboratory') {
                                cellDiv.className += ' lab';
                                cellDiv.textContent = 'L';
                            } else {
                                cellDiv.className += ' explored';
                                cellDiv.textContent = '.';
                            }
                        } else {
                            cellDiv.className += ' explored';
                            cellDiv.textContent = '.';
                        }
                    }
                    // Unexplored
                    else {
                        cellDiv.className += ' unexplored';
                        cellDiv.textContent = '?';
                    }
                    
                    rowDiv.appendChild(cellDiv);
                }
                
                mapDiv.appendChild(rowDiv);
            }
            
            showScreen('screen-map');
        }
        
        function closeMap() {
            playSound('click');
            showScreen('screen-game');
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Potion' || item === 'Mountain Potion' || item === 'Ancient Vampire Wine' || item === 'Vial of Magical Water') {
                const healAmount = item === 'Mountain Potion' ? rollDice(3, 6) + 10 : 
                                 item === 'Ancient Vampire Wine' ? rollDice(2, 8) + 5 : 
                                 item === 'Vial of Magical Water' ? rollDice(2, 6) : rollDice(2, 6) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Holy Water') {
                message = "The <span class='item'>Holy Water</span> is blessed and could harm undead, vampires, or dark artifacts.";
            } else if (item === 'Vial of Ancient Blood' || item === 'Vial of Powerful Blood') {
                message = "The <span class='item'>" + item + "</span> contains powerful vampiric essence. It might be useful for rituals or bargaining.";
            } else if (item === 'Mental Dungeon Map') {
                showDungeonMap();
                return;
            } else if (item === 'Guard Key Ring' || item === 'Warden Master Key' || item === 'Simple Iron Key') {
                message = "The <span class='item'>" + item + "</span> might unlock doors in the dungeon.";
            } else if (item === 'Silvered Mace') {
                gameState.equippedWeapon = 'Silvered Mace';
                updateInventoryDisplay();
                message = "You equip the <span class='item'>Silvered Mace</span>. It's effective against undead.";
            } else if (item === 'Crystal Staff') {
                gameState.equippedWeapon = 'Crystal Staff';
                updateInventoryDisplay();
                message = "You equip the <span class='item'>Crystal Staff</span>. It's a powerful magical weapon.";
            } else if (item === 'Necromancer Robes') {
                gameState.equippedArmor = 'Necromancer Robes';
                updateInventoryDisplay();
                message = "You wear the <span class='item'>Necromancer Robes</span>. They offer protection against dark magic.";
            } else if (item === 'Blood Mage Robes') {
                gameState.equippedArmor = 'Blood Mage Robes';
                updateInventoryDisplay();
                message = "You wear the <span class='item'>Blood Mage Robes</span>. They might help you blend in or provide protection.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Sword' && 
                gameState.equippedArmor === 'Leather Armor') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Record current position as explored
            const posKey = `${gameState.currentPosition.x},${gameState.currentPosition.y}`;
            if (!gameState.exploredDungeonSections.includes(posKey)) {
                gameState.exploredDungeonSections.push(posKey);
            }
            
            // Check for random dungeon events
            if (Math.random() > 0.7) {
                randomEvents.chainsRattle = true;
                playSound('chains');
                storyText += "<br><br><span class='chains'>Chains rattle somewhere nearby, though you see no one...</span>";
            }
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 48 || sectionId === 86 || sectionId === 101 || 
                                   sectionId === 110 || sectionId === 134 || sectionId === 168 || 
                                   sectionId === 179 || sectionId === 188 || sectionId === 194);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    let goldReward = 0;
                    
                    if (combatState.enemyName.includes("Guard")) {
                        goldReward = Math.floor(Math.random() * 50) + 25;
                    } else if (combatState.enemyName.includes("Torturer")) {
                        goldReward = Math.floor(Math.random() * 60) + 30;
                        gameState.tortureChamberCleared = true;
                    } else if (combatState.enemyName.includes("Blood Mage")) {
                        goldReward = Math.floor(Math.random() * 70) + 35;
                        gameState.bloodMageDefeated = true;
                    } else if (combatState.enemyName.includes("Rat-Thing")) {
                        goldReward = Math.floor(Math.random() * 20) + 10;
                    } else if (combatState.enemyName.includes("Warden")) {
                        goldReward = Math.floor(Math.random() * 100) + 50;
                        gameState.wardenDefeated = true;
                    }
                    
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    
                    if (goldReward > 0) {
                        storyText += `<br>You find <span class="gold">${goldReward} Gold</span>.`;
                    }
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    if (typeof choice.requirement === 'function') {
                        return choice.requirement();
                    }
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue exploring the dungeon";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                let weaponType = gameState.equippedWeapon;
                
                // Special weapon bonuses
                if (weaponType.includes('Silver')) {
                    // Silver weapons deal extra damage to undead/vampires
                    damage = rollDice(2, 6) + 4;
                    if (combatState.enemyName.includes('undead') || combatState.enemyName.includes('Warden')) {
                        damage += 5; // Extra vs undead
                        resultText += `<span class="item">Your silver weapon is especially effective!</span><br>`;
                    }
                } else if (weaponType === 'Crystal Staff') {
                    damage = rollDice(3, 6) + 3; // Magical weapon
                    if (combatState.enemyName.includes('Warden') || combatState.enemyName.includes('Blood Mage')) {
                        damage += 4; // Extra vs magical creatures
                        resultText += `<span class="item">The crystal staff glows with power!</span><br>`;
                    }
                } else if (weaponType === 'Ancient Ritual Dagger') {
                    damage = rollDice(2, 6) + 3;
                    if (combatState.enemyName.includes('undead') || combatState.enemyName.includes('vampire') || combatState.enemyName.includes('Blood Mage')) {
                        damage += 3;
                        resultText += `<span class="item">The ritual dagger channels anti-magic energy!</span><br>`;
                    }
                } else if (weaponType.includes('Shovel')) {
                    damage = rollDice(2, 6) + 1; // Shovel as weapon
                } else {
                    damage = rollDice(2, 6);
                }
                
                // Item bonuses
                if (gameState.inventory.includes('Holy Water') && (combatState.enemyName.includes('undead') || combatState.enemyName.includes('Warden') || combatState.enemyName.includes('Blood Mage'))) {
                    damage += 5;
                    resultText += `<span class="item">Holy water burns the creature!</span><br>`;
                }
                
                if (gameState.inventory.includes('Ancient Ritual Dagger') && (combatState.enemyName.includes('undead') || combatState.enemyName.includes('Blood Mage'))) {
                    damage += 3;
                    resultText += `<span class="item">Your ritual dagger is effective!</span><br>`;
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                let enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                
                // Group enemies attack together
                if (combatState.isGroup && (combatState.enemyName.includes('Rat-Thing') || combatState.enemyName.includes('Blood Mage'))) {
                    enemyDamage += Math.floor(combatState.groupCount * 1.5); // Extra damage for group
                    if (combatState.groupCount > 1) {
                        resultText += `The enemies attack as a group!<br>`;
                    }
                }
                
                // Blood Mage special attack
                if (combatState.enemyName.includes('Blood Mage')) {
                    if (Math.random() > 0.7) {
                        enemyDamage += rollDice(2, 6); // Extra blood magic damage
                        resultText += `The blood mage's magic tears at your life force!<br>`;
                    }
                }
                
                // Warden special attack
                if (combatState.enemyName.includes('Warden')) {
                    if (Math.random() > 0.7) {
                        enemyDamage += rollDice(3, 6); // Extra powerful attack
                        resultText += `The Warden's transformed form strikes with terrible force!<br>`;
                    }
                }
                
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('castleUndeadGameState');
                        window.location.href = 'l1.html';
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You dodge a trap!",
                    "You move silently past a guard.",
                    "You climb a difficult obstacle.",
                    "You slip through a narrow passage."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip and take 3 damage!",
                    "You make noise and alert nearby enemies.",
                    "You get tangled in chains or debris.",
                    "You knock something over, making noise."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 3;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 9 (this page)
                if (savedState.level === 9) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 9.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 10 with updated level
            gameState.level = 10;
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            // Redirect to level 10 (The Master Quarters Keep)
            window.location.href = 'l10.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
