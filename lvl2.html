<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Island of Lost Souls - Level 2: Forest of Dreadwood</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Green/Black/White theme with proper contrast */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(0, 50, 0, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 50, 0, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #0a0;
            background-color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 50, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #0a0;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #0f0;
            text-shadow: 0 0 5px #0a0;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #0a0;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #0a0;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #050;
            color: #0f0;
            border-color: #0f0;
        }
        
        .level-number.current {
            background-color: #0a0;
            color: #fff;
            border-color: #0f0;
            box-shadow: 0 0 8px #0f0;
            text-shadow: 0 0 2px #000;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #0a0;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #0f0;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #0a0;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #0f0;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #0a0;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #0f0;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #0f0;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #0a0;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #0a0;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #0f0;
            border-color: #0f0;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #0a0;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #0f0;
        }
        
        /* New Game Button */
        .new-game-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #a00;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .new-game-btn:hover, .new-game-btn:active {
            background-color: #500;
            color: #f00;
            border-color: #f00;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }
        
        .new-game-btn::after {
            content: "!";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a00;
            font-weight: bold;
        }
        
        .new-game-btn:hover::after {
            color: #f00;
        }
        
        /* Top Controls */
        .top-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        
        .top-control-btn {
            background: #111;
            border: 1px solid #0a0;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            transition: all 0.2s;
        }
        
        .top-control-btn:hover {
            background: #222;
            color: #0f0;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #0a0;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #0f0;
            border-color: #0f0;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #111;
            border: 1px solid #0a0;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #0f0;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #222;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
            color: #0f0;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f00;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f00;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #0f0;
            font-weight: bold;
        }
        
        .damage {
            color: #f00;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9900;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #0ff;
            font-weight: bold;
        }
        
        .cursed {
            color: #a0f;
            font-weight: bold;
            text-shadow: 0 0 3px #f0f;
        }
        
        .magic {
            color: #0cf;
            font-weight: bold;
            text-shadow: 0 0 3px #0ff;
        }
        
        .undead {
            color: #8b8;
            font-weight: bold;
            text-shadow: 0 0 3px #0f0;
        }
        
        .forest {
            color: #6b8;
            font-weight: bold;
            text-shadow: 0 0 3px #0f0;
        }
        
        .beast {
            color: #b85;
            font-weight: bold;
            text-shadow: 0 0 3px #f80;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #0a0;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #0a0;
            color: #fff;
            border-color: #0f0;
            box-shadow: 0 0 15px #0f0;
        }
        
        /* Merchant Item Display */
        .merchant-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .merchant-item {
            background-color: #222;
            border: 1px solid #0a0;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: #fff;
        }
        
        .merchant-item:hover {
            background-color: #333;
            border-color: #0f0;
        }
        
        .merchant-item h3 {
            color: #0f0;
            margin: 0 0 5px 0;
            font-size: 16px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .merchant-item p {
            color: #fff;
            font-size: 14px;
            margin: 0;
        }
        
        .merchant-cost {
            color: #ff0;
            font-weight: bold;
            margin-top: 5px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #0a0;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Character Creation Stats */
        .char-stats {
            background-color: #111;
            border: 1px solid #0a0;
            padding: 15px;
            margin: 15px 0;
        }
        
        .stat-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            color: #fff;
        }
        
        .stat-name {
            color: #0f0;
        }
        
        /* Class specific colors */
        .wizard {
            color: #0cf;
        }
        
        .warrior {
            color: #f00;
        }
        
        .necromancer {
            color: #a0f;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .merchant-items {
                grid-template-columns: 1fr;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Top Controls -->
        <div class="top-controls">
            <div class="top-control-btn" onclick="toggleSound()">
                SOUND: <span id="sound-status">ON</span>
            </div>
            <div class="top-control-btn" onclick="newGame()">
                NEW GAME
            </div>
        </div>
        
        <div class="header">
            <h1>ISLAND OF LOST SOULS</h1>
            <h2>LEVEL 2: FOREST OF DREADWOOD</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number current">2</div>
            <div class="level-number">3</div>
            <div class="level-number">4</div>
            <div class="level-number">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">MAGIC:</span> <span id="stat-magic" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
                <div class="stat-item" id="dark-power-stat" style="display: none;"><span class="stat-label">DARK POWER:</span> <span id="stat-darkpower" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>FOREST OF DREADWOOD</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useClassAbility()">CLASS ABILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
                <button class="new-game-btn" onclick="newGame()">NEW GAME</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL 2 COMPLETE!</h2>
            <div class="story-text">
                <p>You have survived the Forest of Dreadwood!</p>
                <p>As you emerge from the dark forest, the jagged peaks of the Mountains of Moor rise before you. A treacherous path winds up into the cold heights, where ancient secrets await.</p>
                <p>All your stats, gold, and inventory will carry over to Level 3: Mountains of Moor.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">MAGIC:</span> <span id="next-stat-magic" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #111; border: 1px solid #0a0;">
                    <h3 style="color: #0f0; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO LEVEL 3: MOUNTAINS OF MOOR</button>
            </div>
        </div>
        
        <div class="footer">
            ISLAND OF LOST SOULS - A Cursed Island Adventure<br>
            Level 2: Forest of Dreadwood
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'magic':
                    playBeep(900, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.2, 'sine'), 150);
                    break;
                case 'cursed':
                    playBeep(150, 0.4, 'sawtooth');
                    setTimeout(() => playBeep(100, 0.4, 'sawtooth'), 400);
                    break;
                case 'undead':
                    playBeep(300, 0.2, 'sine');
                    setTimeout(() => playBeep(250, 0.2, 'sine'), 200);
                    break;
                case 'forest':
                    playBeep(600, 0.1, 'sine');
                    setTimeout(() => playBeep(400, 0.2, 'sine'), 100);
                    break;
                case 'beast':
                    playBeep(200, 0.2, 'sawtooth');
                    setTimeout(() => playBeep(150, 0.3, 'sawtooth'), 200);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - will be loaded from localStorage
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            magic: 0,
            darkPower: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Fists',
            equippedArmor: 'Tattered Clothes',
            currentSection: 200, // Starting section for Level 2
            gameComplete: false,
            level: 2,
            forestCleared: false,
            guardianFavor: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            enemyType: '' // 'beast', 'cursed', 'undead', 'plant'
        };
        
        // Game story sections for Level 2 - Forest of Dreadwood
        const storySections = {
            200: {
                text: "You stand at the edge of the Forest of Dreadwood. The trees here are twisted and dark, their branches reaching like gnarled claws. The air is thick with the scent of damp earth and decay. Strange noises echo from the darkness within.",
                choices: [
                    {text: "Follow the main path (most direct route)", nextSection: 201, skillCheck: false},
                    {text: "Take the overgrown animal trail (might be safer)", nextSection: 202, skillCheck: true, checkType: 'agility', difficulty: 12},
                    {text: "Search for a hidden entrance (could find secrets)", nextSection: 203, skillCheck: true, checkType: 'agility', difficulty: 14}
                ]
            },
            201: {
                text: "You follow the main path into the forest. The canopy blocks most of the light, creating an eerie twilight. You hear rustling in the bushes to your left.",
                choices: [
                    {text: "Investigate the rustling", nextSection: 204, skillCheck: false},
                    {text: "Ignore it and continue", nextSection: 205, skillCheck: true, checkType: 'agility', difficulty: 10},
                    {text: "Draw your weapon and prepare", nextSection: 206, skillCheck: false}
                ]
            },
            202: {
                text: "You take the overgrown animal trail. It's narrow and winding, but seems less traveled. You notice strange markings on some of the trees.",
                choices: [
                    {text: "Examine the markings", nextSection: 207, skillCheck: false},
                    {text: "Continue on the trail", nextSection: 208, skillCheck: false},
                    {text: "Use magic to understand the markings", nextSection: 209, skillCheck: false, requirement: 'magic', minValue: 8}
                ]
            },
            203: {
                text: "You search the forest edge and find a hidden entrance behind a curtain of thick vines. It leads into a dark, narrow passage between two massive trees.",
                choices: [
                    {text: "Enter the hidden passage", nextSection: 210, skillCheck: false},
                    {text: "Mark it and take the main path", nextSection: 201, skillCheck: false}
                ]
            },
            204: {
                text: "You cautiously approach the rustling bushes. Suddenly, a <span class='beast'>CORRUPTED WOLF</span> leaps out! Its fur is patchy and its eyes glow with unnatural red light.",
                choices: [
                    {text: "Fight the wolf", nextSection: 211, skillCheck: false},
                    {text: "Try to scare it away", nextSection: 212, skillCheck: true, checkType: 'strength', difficulty: 13},
                    {text: "Use a calming spell if you can", nextSection: 213, skillCheck: false, requirement: 'magic', minValue: 10}
                ]
            },
            205: {
                text: "You ignore the rustling and continue down the path...",
                choices: [
                    {text: "Continue", nextSection: 214, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully avoid whatever was in the bushes and continue down the path.";
                    } else {
                        playSound('failure');
                        return "The rustling follows you! A <span class='beast'>Corrupted Wolf</span> bursts from the bushes, blocking your path!";
                    }
                }
            },
            206: {
                text: "You draw your weapon. The rustling stops momentarily, then a <span class='beast'>CORRUPTED WOLF</span> emerges, growling low in its throat.",
                choices: [
                    {text: "Attack first", nextSection: 211, skillCheck: false},
                    {text: "Hold your ground defensively", nextSection: 215, skillCheck: false}
                ]
            },
            207: {
                text: "The markings on the trees appear to be crude symbols carved into the bark. They look ancient and possibly magical.",
                choices: [
                    {text: "Try to decipher them", nextSection: 216, skillCheck: true, checkType: 'magic', difficulty: 12},
                    {text: "Continue on the trail", nextSection: 208, skillCheck: false},
                    {text: "Make a rubbing of the symbols", nextSection: 217, skillCheck: false}
                ]
            },
            208: {
                text: "You continue along the animal trail. The forest grows darker as you go deeper. You come to a small clearing with a moss-covered stone altar at its center.",
                choices: [
                    {text: "Examine the altar", nextSection: 218, skillCheck: false},
                    {text: "Search the clearing", nextSection: 219, skillCheck: false},
                    {text: "Continue past the clearing", nextSection: 220, skillCheck: false}
                ]
            },
            209: {
                text: "You focus your magical senses on the tree markings...",
                choices: [
                    {text: "See what you discover", nextSection: 221, skillCheck: false}
                ],
                action: function() {
                    if (gameState.magic >= 8) {
                        playSound('magic');
                        return "The markings are protective symbols! They were carved to ward off dark creatures. Following this marked trail might be safer.";
                    } else {
                        playSound('failure');
                        return "Your magic isn't strong enough to decipher the markings.";
                    }
                }
            },
            210: {
                text: "You enter the hidden passage. It's dark and narrow, but it seems to bypass much of the forest's dangers. After a while, you emerge into a different part of the forest.",
                choices: [
                    {text: "Continue from here", nextSection: 222, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The hidden passage was a shortcut! You've avoided several potential dangers.";
                }
            },
            211: {
                text: "The Corrupted Wolf snarls and prepares to attack! Its claws look sharp and possibly venomous.",
                choices: [
                    {text: "Fight the wolf", nextSection: 223, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Corrupted Wolf";
                    combatState.enemyHealth = 35;
                    combatState.enemyCurrentHealth = 35;
                    combatState.enemyStrength = 10;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 224;
                    combatState.round = 1;
                    combatState.enemyType = 'beast';
                    
                    playSound('beast');
                    return "<span class='beast'>Corrupted Wolf</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            212: {
                text: "You roar and brandish your weapon, trying to scare the wolf away...",
                choices: [
                    {text: "See if it worked", nextSection: 225, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "The wolf hesitates, then turns and runs back into the bushes. You've scared it off!";
                    } else {
                        playSound('failure');
                        return "Your attempt fails! The wolf attacks!";
                    }
                }
            },
            213: {
                text: "You attempt to use magic to calm the wolf...",
                choices: [
                    {text: "See the result", nextSection: 226, skillCheck: false}
                ],
                action: function() {
                    if (gameState.magic >= 10) {
                        playSound('magic');
                        return "You successfully calm the wolf with magic. It whimpers, then pads away peacefully. You gain <span class='item'>Wolf's Gratitude</span>.";
                    } else {
                        playSound('failure');
                        return "Your magic isn't strong enough. The wolf attacks!";
                    }
                }
            },
            214: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue down the path", nextSection: 227, skillCheck: false}
                ]
            },
            215: {
                text: "You hold your ground, weapon ready. The wolf circles you warily, then suddenly lunges!",
                choices: [
                    {text: "Defend and counterattack", nextSection: 223, skillCheck: false}
                ]
            },
            216: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue on the trail", nextSection: 208, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        addToInventory('Forest Rune Knowledge');
                        return "You successfully decipher the markings! They're protective runes. You gain <span class='item'>Forest Rune Knowledge</span>.";
                    } else {
                        playSound('failure');
                        return "You can't make sense of the markings. They remain a mystery.";
                    }
                }
            },
            217: {
                text: "You make a rubbing of the symbols on a piece of cloth or paper from your supplies.",
                choices: [
                    {text: "Continue on the trail", nextSection: 208, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Rune Rubbings');
                    playSound('item');
                    return "You create <span class='item'>Rune Rubbings</span> of the symbols. A scholar might pay for these, or they might be useful later.";
                }
            },
            218: {
                text: "The stone altar is ancient and covered in moss. Strange symbols are carved into its surface. There's a shallow depression in the center that might have held offerings.",
                choices: [
                    {text: "Search around the altar", nextSection: 228, skillCheck: false},
                    {text: "Make an offering", nextSection: 229, skillCheck: false},
                    {text: "Attempt to read the symbols", nextSection: 230, skillCheck: true, checkType: 'magic', difficulty: 14}
                ]
            },
            219: {
                text: "You search the clearing around the altar. In the undergrowth, you find some interesting items.",
                choices: [
                    {text: "Take what you find", nextSection: 231, skillCheck: false},
                    {text: "Return to the altar", nextSection: 218, skillCheck: false}
                ],
                action: function() {
                    const findChance = Math.random();
                    if (findChance > 0.7) {
                        const goldFound = rollDice(3, 8);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        playSound('item');
                        return "You find a small, rotting pouch containing <span class='gold'>" + goldFound + " Gold</span> coins.";
                    } else if (findChance > 0.4) {
                        addToInventory('Forest Berries');
                        playSound('item');
                        return "You find some <span class='item'>Forest Berries</span>. They look edible and might have medicinal properties.";
                    } else if (findChance > 0.2) {
                        addToInventory('Ancient Arrowhead');
                        playSound('item');
                        return "You find an <span class='item'>Ancient Arrowhead</span> made of flint. It's well-crafted and could be valuable or useful.";
                    } else {
                        playSound('item');
                        return "You find some useful herbs and add them to your supplies.";
                    }
                }
            },
            220: {
                text: "You continue past the clearing. The trail becomes steeper as you climb upward. You notice the temperature dropping.",
                choices: [
                    {text: "Continue upward", nextSection: 232, skillCheck: false},
                    {text: "Rest before continuing", nextSection: 233, skillCheck: false}
                ]
            },
            221: {
                text: "", // Filled by action
                choices: [
                    {text: "Follow the marked trail", nextSection: 208, skillCheck: false}
                ]
            },
            222: {
                text: "You emerge from the hidden passage into a part of the forest where the trees are even larger. Giant roots create natural stairs leading upward. You can see glimpses of mountains through the canopy.",
                choices: [
                    {text: "Climb the root stairs", nextSection: 234, skillCheck: true, checkType: 'agility', difficulty: 10},
                    {text: "Search the area first", nextSection: 235, skillCheck: false}
                ]
            },
            223: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 236, skillCheck: false}
                ]
            },
            224: {
                text: "", // After combat
                choices: [
                    {text: "Search the wolf's body", nextSection: 237, skillCheck: false},
                    {text: "Continue down the path", nextSection: 227, skillCheck: false}
                ]
            },
            225: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue down the path", nextSection: 227, skillCheck: false}
                ]
            },
            226: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue down the path", nextSection: 227, skillCheck: false}
                ]
            },
            227: {
                text: "You continue along the main path. The forest grows denser, and strange glowing fungi begin to appear on tree trunks. The path forks ahead.",
                choices: [
                    {text: "Take the left fork (looks less traveled)", nextSection: 238, skillCheck: false},
                    {text: "Take the right fork (wider and clearer)", nextSection: 239, skillCheck: false},
                    {text: "Examine the glowing fungi", nextSection: 240, skillCheck: false}
                ]
            },
            228: {
                text: "Searching around the altar, you find some items partially buried in the moss.",
                choices: [
                    {text: "Take what you find", nextSection: 241, skillCheck: false},
                    {text: "Return to examining the altar", nextSection: 218, skillCheck: false}
                ],
                action: function() {
                    const findChance = Math.random();
                    if (findChance > 0.8) {
                        addToInventory('Altar Offering Bowl');
                        playSound('item');
                        return "You find a small <span class='item'>Altar Offering Bowl</span> made of tarnished silver. It might be valuable.";
                    } else if (findChance > 0.5) {
                        const goldFound = rollDice(2, 10);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        playSound('item');
                        return "You find <span class='gold'>" + goldFound + " Gold</span> coins scattered around the altar.";
                    } else {
                        addToInventory('Sacred Herbs');
                        playSound('item');
                        return "You find some dried <span class='item'>Sacred Herbs</span> that still retain a faint magical aura.";
                    }
                }
            },
            229: {
                text: "You decide to make an offering at the altar. What will you offer?",
                choices: [
                    {text: "Offer some gold", nextSection: 242, skillCheck: false},
                    {text: "Offer an item from your inventory", nextSection: 243, skillCheck: false},
                    {text: "Offer a prayer instead", nextSection: 244, skillCheck: false}
                ]
            },
            230: {
                text: "You study the symbols carved into the altar...",
                choices: [
                    {text: "See what you discover", nextSection: 245, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('magic');
                        return "You decipher the symbols! This altar was dedicated to a forest spirit that protects travelers. You gain the <span class='item'>Altar's Blessing</span>.";
                    } else {
                        playSound('failure');
                        return "The symbols remain mysterious to you. They seem important but you can't understand them.";
                    }
                }
            },
            231: {
                text: "You've taken what you found in the clearing.",
                choices: [
                    {text: "Examine the altar", nextSection: 218, skillCheck: false},
                    {text: "Continue past the clearing", nextSection: 220, skillCheck: false}
                ]
            },
            232: {
                text: "You continue climbing upward. The air grows colder and thinner. You notice patches of snow on the ground. The trees are beginning to thin out.",
                choices: [
                    {text: "Press on through the cold", nextSection: 246, skillCheck: true, checkType: 'strength', difficulty: 12},
                    {text: "Find shelter to rest", nextSection: 247, skillCheck: false}
                ]
            },
            233: {
                text: "You find a relatively safe spot to rest. The forest is quiet here.",
                choices: [
                    {text: "Continue your journey", nextSection: 232, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 8) + Math.floor(gameState.strength / 3);
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    playSound('success');
                    return "You rest and recover your strength. You heal " + actualHeal + " Health.";
                }
            },
            234: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue climbing", nextSection: 248, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You easily climb the root stairs. The path leads upward efficiently.";
                    } else {
                        playSound('failure');
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "You slip while climbing and take <span class='damage'>" + damage + " damage</span>! But you manage to continue upward.";
                    }
                }
            },
            235: {
                text: "You search the area around the giant roots. Beneath one particularly large root, you find something interesting.",
                choices: [
                    {text: "Take what you find", nextSection: 249, skillCheck: false},
                    {text: "Climb the root stairs", nextSection: 234, skillCheck: true, checkType: 'agility', difficulty: 10}
                ],
                action: function() {
                    const findChance = Math.random();
                    if (findChance > 0.7) {
                        addToInventory('Giant's Tooth');
                        playSound('item');
                        return "You find a massive <span class='item'>Giant's Tooth</span>! It's as long as your forearm and could be valuable or useful.";
                    } else if (findChance > 0.4) {
                        const goldFound = rollDice(2, 12);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        playSound('item');
                        return "You find a hidden cache containing <span class='gold'>" + goldFound + " Gold</span> coins!";
                    } else {
                        addToInventory('Root Resin');
                        playSound('item');
                        return "You collect some <span class='item'>Root Resin</span> from the giant tree. It's sticky and has a pleasant, earthy scent.";
                    }
                }
            },
            236: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 223, skillCheck: false}
                ]
            },
            237: {
                text: "Searching the corrupted wolf's body, you find...",
                choices: [
                    {text: "Continue your journey", nextSection: 227, skillCheck: false}
                ],
                action: function() {
                    const findChance = Math.random();
                    if (findChance > 0.6) {
                        addToInventory('Wolf Pelt');
                        playSound('item');
                        return "You skin the wolf and take its <span class='item'>Wolf Pelt</span>. It's corrupted but might still be valuable or useful.";
                    } else if (findChance > 0.3) {
                        addToInventory('Corrupted Fangs');
                        playSound('item');
                        return "You extract the wolf's <span class='item'>Corrupted Fangs</span>. They radiate dark energy.";
                    } else {
                        playSound('item');
                        return "You find nothing of value on the wolf's body.";
                    }
                }
            },
            238: {
                text: "You take the left fork. The path is narrow and overgrown, but you notice fewer of the glowing fungi. Ahead, you see a small, crystal-clear stream.",
                choices: [
                    {text: "Drink from the stream", nextSection: 250, skillCheck: false},
                    {text: "Follow the stream", nextSection: 251, skillCheck: false},
                    {text: "Cross the stream and continue", nextSection: 252, skillCheck: true, checkType: 'agility', difficulty: 11}
                ]
            },
            239: {
                text: "You take the right fork. The path is wider and clearer. However, you notice the glowing fungi are more numerous here, and they pulse with an eerie light.",
                choices: [
                    {text: "Continue down the path", nextSection: 253, skillCheck: false},
                    {text: "Collect some glowing fungi", nextSection: 254, skillCheck: false},
                    {text: "Use magic to examine the fungi", nextSection: 255, skillCheck: false, requirement: 'magic', minValue: 7}
                ]
            },
            240: {
                text: "You examine the glowing fungi up close. They emit a soft blue light and seem to pulse rhythmically, almost like a heartbeat.",
                choices: [
                    {text: "Touch the fungi", nextSection: 256, skillCheck: false},
                    {text: "Collect some samples", nextSection: 257, skillCheck: false},
                    {text: "Return to the path fork", nextSection: 227, skillCheck: false}
                ]
            },
            241: {
                text: "You've taken what you found around the altar.",
                choices: [
                    {text: "Make an offering", nextSection: 229, skillCheck: false},
                    {text: "Attempt to read the symbols", nextSection: 230, skillCheck: true, checkType: 'magic', difficulty: 14},
                    {text: "Continue past the clearing", nextSection: 220, skillCheck: false}
                ]
            },
            242: {
                text: "You place some gold coins in the offering bowl on the altar.",
                choices: [
                    {text: "See what happens", nextSection: 258, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 20) {
                        gameState.gold -= 20;
                        updateStatsDisplay();
                        playSound('magic');
                        gameState.maxHealth += 5;
                        gameState.health += 5;
                        updateStatsDisplay();
                        return "You offer <span class='gold'>20 Gold</span> to the forest spirit. A warm light envelops you, and you feel stronger! <span class='success'>Maximum Health +5</span>";
                    } else {
                        playSound('failure');
                        return "You don't have enough gold to make a proper offering.";
                    }
                }
            },
            243: {
                text: "You search your inventory for something to offer...",
                choices: [
                    {text: "Offer nothing and leave", nextSection: 220, skillCheck: false}
                ],
                action: function() {
                    // Check for specific items that would be good offerings
                    const goodOfferings = ['Sacred Herbs', 'Forest Berries', 'Rune Rubbings', 'Ancient Arrowhead'];
                    const offering = gameState.inventory.find(item => goodOfferings.includes(item));
                    
                    if (offering) {
                        removeFromInventory(offering);
                        playSound('magic');
                        const healAmount = rollDice(2, 8) + 5;
                        const oldHealth = gameState.health;
                        gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                        const actualHeal = gameState.health - oldHealth;
                        return "You offer your <span class='item'>" + offering + "</span> to the forest spirit. A healing energy flows through you, restoring " + actualHeal + " Health!";
                    } else {
                        playSound('failure');
                        return "You don't have anything suitable to offer the forest spirit.";
                    }
                }
            },
            244: {
                text: "You kneel and offer a sincere prayer to whatever spirit might be listening.",
                choices: [
                    {text: "Continue your journey", nextSection: 220, skillCheck: false}
                ],
                action: function() {
                    playSound('magic');
                    gameState.agility += 1;
                    updateStatsDisplay();
                    return "You feel lighter and more nimble after your prayer. <span class='success'>Agility +1</span>";
                }
            },
            245: {
                text: "", // Filled by action
                choices: [
                    {text: "Make an offering", nextSection: 229, skillCheck: false},
                    {text: "Continue past the clearing", nextSection: 220, skillCheck: false}
                ]
            },
            246: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue upward", nextSection: 259, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You push through the cold and altitude without difficulty. The forest is definitely thinning now.";
                    } else {
                        playSound('failure');
                        const damage = rollDice(1, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "The cold and altitude take their toll. You take <span class='damage'>" + damage + " damage</span> from exposure but press on.";
                    }
                }
            },
            247: {
                text: "You find a small cave-like formation under some giant roots. It's sheltered from the wind and relatively dry.",
                choices: [
                    {text: "Rest here", nextSection: 260, skillCheck: false},
                    {text: "Search the shelter first", nextSection: 261, skillCheck: false}
                ]
            },
            248: {
                text: "You continue climbing. The giant roots eventually give way to a rocky slope. You're approaching the tree line. The air is much colder now.",
                choices: [
                    {text: "Push on to the tree line", nextSection: 262, skillCheck: false},
                    {text: "Rest and prepare", nextSection: 263, skillCheck: false}
                ]
            },
            249: {
                text: "You've taken what you found under the giant root.",
                choices: [
                    {text: "Climb the root stairs", nextSection: 234, skillCheck: true, checkType: 'agility', difficulty: 10}
                ]
            },
            250: {
                text: "You kneel and drink from the clear stream. The water is cold and refreshing.",
                choices: [
                    {text: "Continue following the stream", nextSection: 251, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 6) + 2;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    playSound('success');
                    return "The pure forest water refreshes you, healing " + actualHeal + " Health.";
                }
            },
            251: {
                text: "You follow the stream upstream. It leads you to a beautiful, secluded glade with a small waterfall. The air here feels peaceful and clean.",
                choices: [
                    {text: "Rest in the glade", nextSection: 264, skillCheck: false},
                    {text: "Examine the waterfall", nextSection: 265, skillCheck: false},
                    {text: "Continue your journey", nextSection: 266, skillCheck: false}
                ]
            },
            252: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue on the path", nextSection: 267, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You easily cross the stream and continue on the path.";
                    } else {
                        playSound('failure');
                        gameState.health -= 2;
                        updateStatsDisplay();
                        return "You slip on a wet stone and get soaked, but manage to cross. You take <span class='damage'>2 damage</span> from the fall.";
                    }
                }
            },
            253: {
                text: "You continue down the path with numerous glowing fungi. The pulsing light creates an eerie atmosphere. Suddenly, you notice movement among the fungi - they seem to be reacting to your presence!",
                choices: [
                    {text: "Continue cautiously", nextSection: 268, skillCheck: true, checkType: 'agility', difficulty: 13},
                    {text: "Try to avoid the fungi", nextSection: 269, skillCheck: false},
                    {text: "Use magic to calm them", nextSection: 270, skillCheck: false, requirement: 'magic', minValue: 9}
                ]
            },
            254: {
                text: "You carefully collect samples of the glowing fungi.",
                choices: [
                    {text: "Continue down the path", nextSection: 253, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Glowing Fungi Samples');
                    playSound('item');
                    return "You collect <span class='item'>Glowing Fungi Samples</span>. They continue to pulse with soft light in your pack.";
                }
            },
            255: {
                text: "You use your magic to examine the glowing fungi...",
                choices: [
                    {text: "See what you discover", nextSection: 271, skillCheck: false}
                ],
                action: function() {
                    if (gameState.magic >= 7) {
                        playSound('magic');
                        return "Your magical examination reveals that the fungi are sensitive to movement and can release spores that cause hallucinations. Best to move carefully!";
                    } else {
                        playSound('failure');
                        return "Your magic isn't strong enough to properly examine the fungi.";
                    }
                }
            },
            256: {
                text: "You reach out and touch one of the glowing fungi. It feels cool and slightly moist. As you touch it, it pulses brighter for a moment.",
                choices: [
                    {text: "Pull your hand back", nextSection: 272, skillCheck: false},
                    {text: "Touch more of them", nextSection: 273, skillCheck: false}
                ]
            },
            257: {
                text: "You collect samples of the glowing fungi, carefully placing them in your pack.",
                choices: [
                    {text: "Take the left fork", nextSection: 238, skillCheck: false},
                    {text: "Take the right fork", nextSection: 239, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Glowing Fungi Samples');
                    playSound('item');
                    return "You collect <span class='item'>Glowing Fungi Samples</span>. They glow softly in your pack.";
                }
            },
            258: {
                text: "After making your offering, you feel a sense of peace in the clearing.",
                choices: [
                    {text: "Continue past the clearing", nextSection: 220, skillCheck: false}
                ]
            },
            259: {
                text: "You push upward through the thinning forest. The trees are now sparse and stunted. You can see rocky slopes ahead - the beginning of the Mountains of Moor.",
                choices: [
                    {text: "Continue to the tree line", nextSection: 274, skillCheck: false},
                    {text: "Look back at how far you've come", nextSection: 275, skillCheck: false}
                ]
            },
            260: {
                text: "You rest in the sheltered spot, protected from the cold wind.",
                choices: [
                    {text: "Continue your journey", nextSection: 259, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 10) + 5;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    playSound('success');
                    return "You rest warmly in the shelter and recover " + actualHeal + " Health.";
                }
            },
            261: {
                text: "You search the sheltered area before resting. In a corner, you find something interesting.",
                choices: [
                    {text: "Take it and rest", nextSection: 260, skillCheck: false},
                    {text: "Just rest", nextSection: 260, skillCheck: false}
                ],
                action: function() {
                    const findChance = Math.random();
                    if (findChance > 0.7) {
                        addToInventory('Climbing Gear');
                        playSound('item');
                        return "You find some discarded <span class='item'>Climbing Gear</span> - pitons and a small hammer. This will help with mountain climbing!";
                    } else if (findChance > 0.4) {
                        const goldFound = rollDice(1, 15);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        playSound('item');
                        return "You find a small pouch with <span class='gold'>" + goldFound + " Gold</span> coins, left by a previous traveler.";
                    } else {
                        addToInventory('Warm Fur Blanket');
                        playSound('item');
                        return "You find a <span class='item'>Warm Fur Blanket</span>. It will help against the mountain cold.";
                    }
                }
            },
            262: {
                text: "You push on and finally reach the tree line. The forest ends abruptly, giving way to rocky alpine terrain. The Mountains of Moor rise majestically before you.",
                choices: [
                    {text: "Continue into the mountains", nextSection: 300, skillCheck: false}
                ]
            },
            263: {
                text: "You take a moment to rest and prepare for the final push out of the forest.",
                choices: [
                    {text: "Continue to the tree line", nextSection: 262, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    gameState.strength += 1;
                    updateStatsDisplay();
                    return "You prepare yourself mentally and physically. <span class='success'>Strength +1</span>";
                }
            },
            264: {
                text: "You rest in the peaceful glade. The sound of the waterfall is soothing, and the air is clean and pure.",
                choices: [
                    {text: "Continue your journey", nextSection: 266, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(2, 6) + 4;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    playSound('success');
                    return "The peaceful glade restores your spirit. You heal " + actualHeal + " Health.";
                }
            },
            265: {
                text: "You examine the waterfall closely. Behind the falling water, you can see what looks like a small cave opening.",
                choices: [
                    {text: "Enter the cave behind the waterfall", nextSection: 276, skillCheck: false},
                    {text: "Return to the glade", nextSection: 264, skillCheck: false}
                ]
            },
            266: {
                text: "You leave the peaceful glade and continue through the forest. The path becomes steeper as you climb toward higher ground.",
                choices: [
                    {text: "Continue climbing", nextSection: 277, skillCheck: false}
                ]
            },
            267: {
                text: "You continue on the path after crossing the stream. The forest begins to change - the trees are taller and older here.",
                choices: [
                    {text: "Continue forward", nextSection: 278, skillCheck: false},
                    {text: "Climb a tree to get your bearings", nextSection: 279, skillCheck: true, checkType: 'agility', difficulty: 13}
                ]
            },
            268: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue down the path", nextSection: 280, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You move carefully and quietly past the reactive fungi without disturbing them.";
                    } else {
                        playSound('failure');
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "You disturb the fungi! They release clouds of spores that cause disorientation. You take <span class='damage'>" + damage + " damage</span> and feel dizzy.";
                    }
                }
            },
            269: {
                text: "You try to avoid the fungi by staying to the very edge of the path.",
                choices: [
                    {text: "See if you succeed", nextSection: 281, skillCheck: false}
                ],
                action: function() {
                    const successChance = Math.random();
                    if (successChance > 0.5) {
                        playSound('success');
                        return "You successfully avoid most of the fungi and continue down the path.";
                    } else {
                        playSound('failure');
                        gameState.health -= 3;
                        updateStatsDisplay();
                        return "You accidentally brush against some fungi. They release spores that make you cough violently. You take <span class='damage'>3 damage</span>.";
                    }
                }
            },
            270: {
                text: "You use magic to calm the reactive fungi...",
                choices: [
                    {text: "See the result", nextSection: 282, skillCheck: false}
                ],
                action: function() {
                    if (gameState.magic >= 9) {
                        playSound('magic');
                        return "Your magic successfully calms the fungi. They stop pulsing and become still, allowing you to pass safely.";
                    } else {
                        playSound('failure');
                        gameState.health -= 4;
                        updateStatsDisplay();
                        return "Your magic isn't strong enough! The fungi react violently, releasing more spores. You take <span class='damage'>4 damage</span>.";
                    }
                }
            },
            271: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue down the path cautiously", nextSection: 268, skillCheck: true, checkType: 'agility', difficulty: 13}
                ]
            },
            272: {
                text: "You pull your hand back quickly. Your fingers tingle slightly where they touched the fungi.",
                choices: [
                    {text: "Take the left fork", nextSection: 238, skillCheck: false},
                    {text: "Take the right fork", nextSection: 239, skillCheck: false}
                ]
            },
            273: {
                text: "You touch several of the glowing fungi. They pulse brighter in response, and you notice the pulsing seems to be spreading through the fungal network.",
                choices: [
                    {text: "Stop touching them", nextSection: 283, skillCheck: false},
                    {text: "Continue touching them", nextSection: 284, skillCheck: false}
                ]
            },
            274: {
                text: "You stand at the tree line, looking out at the rocky slopes of the Mountains of Moor. The forest behind you seems less intimidating from here.",
                choices: [
                    {text: "Begin the mountain ascent", nextSection: 300, skillCheck: false}
                ]
            },
            275: {
                text: "You look back the way you came. The Forest of Dreadwood stretches out below, a sea of dark green. You've come a long way from the Village of the Damned.",
                choices: [
                    {text: "Continue to the tree line", nextSection: 274, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "Looking back at how far you've come fills you with determination. You're ready to face the mountains.";
                }
            },
            276: {
                text: "You slip behind the waterfall into a small, damp cave. The air is cool and misty. The cave contains a few interesting items.",
                choices: [
                    {text: "Take what you find", nextSection: 285, skillCheck: false},
                    {text: "Return to the glade", nextSection: 264, skillCheck: false}
                ],
                action: function() {
                    const findChance = Math.random();
                    if (findChance > 0.8) {
                        addToInventory('Waterfall Crystal');
                        playSound('item');
                        return "You find a beautiful <span class='item'>Waterfall Crystal</span> that glows with soft blue light. It radiates pure magic.";
                    } else if (findChance > 0.5) {
                        const goldFound = rollDice(3, 10);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        playSound('item');
                        return "You find a watertight chest containing <span class='gold'>" + goldFound + " Gold</span> coins!";
                    } else {
                        addToInventory('Moss Agate');
                        playSound('item');
                        return "You find a polished <span class='item'>Moss Agate</span> stone. It's beautiful and might be valuable.";
                    }
                }
            },
            277: {
                text: "You continue climbing through the forest. The trees are beginning to thin, and you can feel the temperature dropping. Patches of snow appear on the ground.",
                choices: [
                    {text: "Continue upward", nextSection: 286, skillCheck: false},
                    {text: "Gather some snow for water", nextSection: 287, skillCheck: false}
                ]
            },
            278: {
                text: "You continue forward through the ancient forest. The trees here are massive, their trunks wider than houses. You feel very small among them.",
                choices: [
                    {text: "Continue through the ancient trees", nextSection: 288, skillCheck: false},
                    {text: "Search for a way around", nextSection: 289, skillCheck: false}
                ]
            },
            279: {
                text: "You attempt to climb one of the tall trees to get a better view of your surroundings...",
                choices: [
                    {text: "See what you can see", nextSection: 290, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully climb high enough to see over the canopy. You can see the mountains ahead and choose the best path forward.";
                    } else {
                        playSound('failure');
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "You slip and fall from the tree, taking <span class='damage'>" + damage + " damage</span>. You'll have to find another way.";
                    }
                }
            },
            280: {
                text: "You continue down the path past the glowing fungi. The forest begins to change - the air grows colder and the trees become more stunted.",
                choices: [
                    {text: "Continue forward", nextSection: 291, skillCheck: false}
                ]
            },
            281: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue down the path", nextSection: 280, skillCheck: false}
                ]
            },
            282: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue down the path", nextSection: 280, skillCheck: false}
                ]
            },
            283: {
                text: "You stop touching the fungi. The pulsing gradually subsides back to its normal rhythm.",
                choices: [
                    {text: "Take the left fork", nextSection: 238, skillCheck: false},
                    {text: "Take the right fork", nextSection: 239, skillCheck: false}
                ]
            },
            284: {
                text: "You continue touching the fungi. The pulsing spreads rapidly through the fungal network until the entire area is pulsing in unison. Then... everything goes dark for a moment.",
                choices: [
                    {text: "What happened?", nextSection: 292, skillCheck: false}
                ],
                action: function() {
                    playSound('magic');
                    const visionChance = Math.random();
                    if (visionChance > 0.7) {
                        gameState.magic += 2;
                        updateStatsDisplay();
                        return "You experience a strange vision of the forest's history! Your magical senses are heightened. <span class='success'>Magic +2</span>";
                    } else if (visionChance > 0.3) {
                        gameState.health -= 5;
                        updateStatsDisplay();
                        return "The fungal network overwhelms your senses! You take <span class='damage'>5 damage</span> from psychic feedback.";
                    } else {
                        addToInventory('Fungal Insight');
                        return "You gain strange knowledge from the fungal network. You now understand the forest better. You gain <span class='item'>Fungal Insight</span>.";
                    }
                }
            },
            285: {
                text: "You've taken what you found in the cave behind the waterfall.",
                choices: [
                    {text: "Return to the glade", nextSection: 264, skillCheck: false}
                ]
            },
            286: {
                text: "You push upward through the thinning forest. Snow crunches under your feet. You're definitely approaching the tree line.",
                choices: [
                    {text: "Continue to the tree line", nextSection: 293, skillCheck: false}
                ]
            },
            287: {
                text: "You gather some clean snow and melt it in your hands to drink.",
                choices: [
                    {text: "Continue upward", nextSection: 286, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    const healAmount = rollDice(1, 4);
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    return "The cold, clean water refreshes you, healing " + actualHeal + " Health.";
                }
            },
            288: {
                text: "You walk among the ancient, massive trees. The air here is still and silent. You come to a circular clearing where the largest tree of all stands - an ancient oak that must be thousands of years old.",
                choices: [
                    {text: "Approach the ancient oak", nextSection: 294, skillCheck: false},
                    {text: "Search the clearing", nextSection: 295, skillCheck: false},
                    {text: "Leave this place quietly", nextSection: 296, skillCheck: false}
                ]
            },
            289: {
                text: "You search for and find a path that goes around the area with the massive ancient trees. It's longer but might be safer.",
                choices: [
                    {text: "Take the longer path", nextSection: 297, skillCheck: false}
                ]
            },
            290: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue through the ancient trees", nextSection: 288, skillCheck: false},
                    {text: "Search for a way around", nextSection: 289, skillCheck: false}
                ]
            },
            291: {
                text: "The path continues upward. The air is definitely colder now. You notice animal tracks in the mud - large tracks that look like they belong to a bear or something even bigger.",
                choices: [
                    {text: "Follow the tracks", nextSection: 298, skillCheck: false},
                    {text: "Avoid the tracks", nextSection: 299, skillCheck: false}
                ]
            },
            292: {
                text: "When your vision clears, the fungi have returned to their normal pulsing rhythm. You feel different somehow.",
                choices: [
                    {text: "Take the left fork", nextSection: 238, skillCheck: false},
                    {text: "Take the right fork", nextSection: 239, skillCheck: false}
                ]
            },
            293: {
                text: "You reach the tree line! The forest ends, giving way to rocky alpine terrain. The Mountains of Moor rise before you, their peaks shrouded in mist.",
                choices: [
                    {text: "Enter the mountains", nextSection: 300, skillCheck: false}
                ]
            },
            294: {
                text: "You approach the ancient oak. Its bark is deeply furrowed, and its branches spread wide. You sense great age and wisdom from this tree.",
                choices: [
                    {text: "Touch the tree", nextSection: 301, skillCheck: false},
                    {text: "Speak to the tree", nextSection: 302, skillCheck: false},
                    {text: "Make an offering", nextSection: 303, skillCheck: false}
                ]
            },
            295: {
                text: "You search the clearing around the ancient oak. At the base of the tree, you find something remarkable.",
                choices: [
                    {text: "Take what you find", nextSection: 304, skillCheck: false},
                    {text: "Leave it be", nextSection: 294, skillCheck: false}
                ],
                action: function() {
                    const findChance = Math.random();
                    if (findChance > 0.8) {
                        addToInventory('Acorn of the Ancients');
                        playSound('magic');
                        return "You find a perfect, glowing <span class='item'>Acorn of the Ancients</span>. It pulses with powerful life magic.";
                    } else if (findChance > 0.5) {
                        gameState.maxHealth += 10;
                        gameState.health += 10;
                        updateStatsDisplay();
                        playSound('magic');
                        return "You find and eat some miraculous herbs growing at the tree's base. You feel revitalized! <span class='success'>Maximum Health +10</span>";
                    } else {
                        addToInventory('Ancient Bark');
                        playSound('item');
                        return "You carefully take a piece of <span class='item'>Ancient Bark</span> from the tree. It feels warm to the touch.";
                    }
                }
            },
            296: {
                text: "You decide to leave this sacred place quietly, respecting its ancient power.",
                choices: [
                    {text: "Continue through the forest", nextSection: 305, skillCheck: false}
                ]
            },
            297: {
                text: "You take the longer path around the ancient trees. It adds time to your journey, but you avoid whatever power resides in that clearing.",
                choices: [
                    {text: "Continue on the path", nextSection: 306, skillCheck: false}
                ]
            },
            298: {
                text: "You follow the large animal tracks. They lead you to a cave entrance partially hidden by brush. You can hear heavy breathing from within.",
                choices: [
                    {text: "Enter the cave", nextSection: 307, skillCheck: false},
                    {text: "Back away quietly", nextSection: 308, skillCheck: true, checkType: 'agility', difficulty: 14}
                ]
            },
            299: {
                text: "You carefully avoid the animal tracks, giving whatever made them a wide berth.",
                choices: [
                    {text: "Continue upward", nextSection: 309, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "You successfully avoid whatever large creature made those tracks. Smart move.";
                }
            },
            300: {
                text: "CONGRATULATIONS! You have survived the Forest of Dreadwood. You stand at the edge of the mountains, looking up at the cold, rocky slopes of the Mountains of Moor. Your journey continues...",
                choices: [],
                action: function() {
                    gameState.forestCleared = true;
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-magic').textContent = gameState.magic;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    // Show special stats for necromancer
                    if (gameState.playerClass === 'necromancer' && gameState.darkPower > 0) {
                        const darkDiv = document.createElement('div');
                        darkDiv.innerHTML = `<strong>Dark Power:</strong> ${gameState.darkPower}`;
                        darkDiv.style.color = '#a0f';
                        inventoryDisplay.appendChild(darkDiv);
                    }
                    
                    // Check for special items that might affect next level
                    const specialItems = [];
                    if (gameState.inventory.includes('Climbing Gear') || gameState.inventory.some(item => item.includes('Climbing'))) {
                        specialItems.push('Climbing Gear will help in the mountains');
                    }
                    if (gameState.inventory.includes('Warm Fur Blanket') || gameState.equippedArmor.includes('Fur')) {
                        specialItems.push('Warm clothing will protect against mountain cold');
                    }
                    
                    if (specialItems.length > 0) {
                        const specialDiv = document.createElement('div');
                        specialDiv.innerHTML = `<strong>Special Advantages:</strong><br>${specialItems.join('<br>')}`;
                        specialDiv.style.color = '#0f0';
                        specialDiv.style.marginTop = '10px';
                        inventoryDisplay.appendChild(specialDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 3;
                    saveGame();
                    
                    return "";
                }
            },
            301: {
                text: "You place your hand on the ancient oak's bark. Immediately, you feel a connection - a flow of knowledge and memories from centuries past.",
                choices: [
                    {text: "Receive the knowledge", nextSection: 310, skillCheck: false},
                    {text: "Break the connection", nextSection: 311, skillCheck: false}
                ]
            },
            302: {
                text: "You speak respectfully to the ancient tree, asking for guidance or wisdom.",
                choices: [
                    {text: "Listen for a response", nextSection: 312, skillCheck: false}
                ]
            },
            303: {
                text: "You search for something to offer the ancient oak as a sign of respect.",
                choices: [
                    {text: "Make an offering", nextSection: 313, skillCheck: false},
                    {text: "You have nothing to offer", nextSection: 314, skillCheck: false}
                ]
            },
            304: {
                text: "You've taken what you found at the base of the ancient oak.",
                choices: [
                    {text: "Touch the tree", nextSection: 301, skillCheck: false},
                    {text: "Speak to the tree", nextSection: 302, skillCheck: false},
                    {text: "Leave this place", nextSection: 296, skillCheck: false}
                ]
            },
            305: {
                text: "You continue through the forest, leaving the ancient clearing behind. The path begins to climb more steeply.",
                choices: [
                    {text: "Continue climbing", nextSection: 315, skillCheck: false}
                ]
            },
            306: {
                text: "You continue on the longer path. It eventually rejoins the main path higher up the slope.",
                choices: [
                    {text: "Continue upward", nextSection: 316, skillCheck: false}
                ]
            },
            307: {
                text: "You enter the cave cautiously. Inside, you find a <span class='beast'>HUGE FOREST BEAR</span> sleeping on a pile of leaves and bones. It hasn't noticed you yet.",
                choices: [
                    {text: "Back out quietly", nextSection: 317, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Search the cave while it sleeps", nextSection: 318, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Attack the sleeping bear", nextSection: 319, skillCheck: false}
                ]
            },
            308: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue upward", nextSection: 309, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You back away silently and the creature in the cave doesn't wake. You continue on your way.";
                    } else {
                        playSound('failure');
                        return "You step on a twig! The bear wakes up and charges out of the cave!";
                    }
                }
            },
            309: {
                text: "You continue upward, avoiding the creature's territory. The trees are definitely thinning now.",
                choices: [
                    {text: "Continue to the tree line", nextSection: 320, skillCheck: false}
                ]
            },
            310: {
                text: "The ancient oak shares its wisdom with you. You see visions of the forest through the ages, learn about its creatures, and understand its rhythms.",
                choices: [
                    {text: "Thank the tree and leave", nextSection: 321, skillCheck: false}
                ],
                action: function() {
                    playSound('magic');
                    gameState.agility += 2;
                    gameState.magic += 1;
                    updateStatsDisplay();
                    addToInventory('Ancient Oak Wisdom');
                    return "You receive the oak's wisdom! <span class='success'>Agility +2, Magic +1</span>. You also gain <span class='item'>Ancient Oak Wisdom</span>.";
                }
            },
            311: {
                text: "You break the connection with the ancient oak. The tree seems to understand and doesn't resist.",
                choices: [
                    {text: "Leave the clearing", nextSection: 296, skillCheck: false}
                ]
            },
            312: {
                text: "A deep, slow voice echoes in your mind, not through your ears but directly to your consciousness: 'WHY HAVE YOU COME TO THIS PLACE, TRAVELER?'",
                choices: [
                    {text: "'I seek to pass through the forest'", nextSection: 322, skillCheck: false},
                    {text: "'I seek to break the island's curse'", nextSection: 323, skillCheck: false},
                    {text: "'I seek knowledge and power'", nextSection: 324, skillCheck: false}
                ]
            },
            313: {
                text: "You make an offering to the ancient oak. What do you offer?",
                choices: [
                    {text: "Offer something from your inventory", nextSection: 325, skillCheck: false},
                    {text: "Offer a lock of your hair", nextSection: 326, skillCheck: false},
                    {text: "Offer a drop of your blood", nextSection: 327, skillCheck: false}
                ]
            },
            314: {
                text: "You have nothing suitable to offer the ancient oak. You bow respectfully instead.",
                choices: [
                    {text: "Leave the clearing", nextSection: 296, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "Your respectful bow seems to be accepted. You leave the clearing with a sense of peace.";
                }
            },
            315: {
                text: "You climb steadily upward. The air grows colder with every step. You can see your breath now.",
                choices: [
                    {text: "Continue climbing", nextSection: 328, skillCheck: false}
                ]
            },
            316: {
                text: "You continue upward on the rejoined path. The forest is definitely thinning out.",
                choices: [
                    {text: "Continue to the tree line", nextSection: 329, skillCheck: false}
                ]
            },
            317: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue upward", nextSection: 309, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully back out of the cave without waking the bear. You continue on your way, relieved.";
                    } else {
                        playSound('failure');
                        return "You trip on a rock as you back out! The bear wakes with a roar and charges!";
                    }
                }
            },
            318: {
                text: "", // Filled by action
                choices: [
                    {text: "See what happens", nextSection: 330, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        const goldFound = rollDice(4, 10);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        addToInventory('Bear Claw Necklace');
                        return "You successfully search the cave while the bear sleeps! You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Bear Claw Necklace</span> from the bear's previous victims.";
                    } else {
                        playSound('failure');
                        return "You knock over some bones! The bear wakes up and attacks!";
                    }
                }
            },
            319: {
                text: "You attack the sleeping bear! It wakes with a roar of pain and fury!",
                choices: [
                    {text: "Fight the bear", nextSection: 331, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Forest Bear";
                    combatState.enemyHealth = 50;
                    combatState.enemyCurrentHealth = 50;
                    combatState.enemyStrength = 14;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 332;
                    combatState.round = 1;
                    combatState.enemyType = 'beast';
                    
                    playSound('beast');
                    return "<span class='beast'>Forest Bear</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            320: {
                text: "You reach the tree line! The forest ends here, giving way to rocky mountain slopes. You've made it through the Forest of Dreadwood!",
                choices: [
                    {text: "Enter the Mountains of Moor", nextSection: 300, skillCheck: false}
                ]
            },
            321: {
                text: "You thank the ancient oak for its wisdom and leave the clearing with new understanding.",
                choices: [
                    {text: "Continue through the forest", nextSection: 305, skillCheck: false}
                ]
            },
            322: {
                text: "'PASSING THROUGH IS ALLOWED,' the tree responds. 'BUT RESPECT THE FOREST AND IT WILL RESPECT YOU. THE PATH AHEAD IS DANGEROUS. FOLLOW THE MARKED TREES.'",
                choices: [
                    {text: "Thank the tree and leave", nextSection: 333, skillCheck: false}
                ],
                action: function() {
                    playSound('forest');
                    addToInventory('Tree Markings Knowledge');
                    return "The ancient oak gives you guidance. You gain <span class='item'>Tree Markings Knowledge</span> to help navigate the forest.";
                }
            },
            323: {
                text: "'A NOBLE GOAL,' the tree says. 'THE CURSE AFFECTS THIS FOREST TOO. THE MASTER'S POWER REACHES EVEN HERE. BREAK THE CURSE AND THE FOREST WILL HEAL.'",
                choices: [
                    {text: "Ask how to break the curse", nextSection: 334, skillCheck: false},
                    {text: "Thank the tree and leave", nextSection: 333, skillCheck: false}
                ]
            },
            324: {
                text: "'POWER COMES WITH RESPONSIBILITY,' the tree warns. 'SEEK WISDOM MORE THAN POWER. BUT IF YOU MUST HAVE POWER, USE IT TO HEAL, NOT TO HARM.'",
                choices: [
                    {text: "Accept the advice", nextSection: 335, skillCheck: false},
                    {text: "Demand power anyway", nextSection: 336, skillCheck: false}
                ]
            },
            325: {
                text: "You search your inventory for something to offer the ancient oak.",
                choices: [
                    {text: "Make an offering", nextSection: 337, skillCheck: false},
                    {text: "You have nothing suitable", nextSection: 314, skillCheck: false}
                ],
                action: function() {
                    // Check for natural items that would be good offerings
                    const goodOfferings = ['Forest Berries', 'Sacred Herbs', 'Ancient Bark', 'Root Resin', 'Moss Agate'];
                    const offering = gameState.inventory.find(item => goodOfferings.includes(item));
                    
                    if (offering) {
                        removeFromInventory(offering);
                        playSound('magic');
                        gameState.maxHealth += 8;
                        gameState.health += 8;
                        updateStatsDisplay();
                        return "You offer your <span class='item'>" + offering + "</span> to the ancient oak. It accepts your offering, and you feel vitality flow into you. <span class='success'>Maximum Health +8</span>";
                    } else {
                        return "You don't have anything suitable to offer the ancient oak.";
                    }
                }
            },
            326: {
                text: "You cut a lock of your hair and place it at the base of the ancient oak.",
                choices: [
                    {text: "See what happens", nextSection: 338, skillCheck: false}
                ],
                action: function() {
                    playSound('magic');
                    gameState.agility += 3;
                    updateStatsDisplay();
                    return "The ancient oak accepts your personal offering. You feel more connected to the natural world. <span class='success'>Agility +3</span>";
                }
            },
            327: {
                text: "You prick your finger and let a drop of blood fall onto the ancient oak's roots.",
                choices: [
                    {text: "See what happens", nextSection: 339, skillCheck: false}
                ],
                action: function() {
                    playSound('magic');
                    gameState.strength += 2;
                    gameState.health -= 5; // Cost of blood
                    updateStatsDisplay();
                    return "The ancient oak accepts your blood offering. You feel stronger but weaker at the same time. <span class='success'>Strength +2</span>, <span class='damage'>Health -5</span>";
                }
            },
            328: {
                text: "You climb higher. The trees are sparse now, and you can see patches of sky between them. You're almost out of the forest!",
                choices: [
                    {text: "Push on to the tree line", nextSection: 340, skillCheck: false}
                ]
            },
            329: {
                text: "You continue upward and finally reach the tree line! The forest ends, giving way to rocky mountain terrain.",
                choices: [
                    {text: "Enter the mountains", nextSection: 300, skillCheck: false}
                ]
            },
            330: {
                text: "", // Filled by action
                choices: [
                    {text: "Continue upward", nextSection: 309, skillCheck: false}
                ]
            },
            331: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 341, skillCheck: false}
                ]
            },
            332: {
                text: "", // After combat
                choices: [
                    {text: "Search the cave", nextSection: 342, skillCheck: false},
                    {text: "Continue upward", nextSection: 309, skillCheck: false}
                ]
            },
            333: {
                text: "You thank the ancient oak for its guidance and leave the clearing.",
                choices: [
                    {text: "Continue through the forest", nextSection: 305, skillCheck: false}
                ]
            },
            334: {
                text: "'THE CURSE IS CENTERED IN THE CASTLE IN THE MOUNTAINS,' the tree explains. 'DESTROY THE HEART OF THE ISLAND THERE. BUT BEWARE - THE MASTER IS POWERFUL.'",
                choices: [
                    {text: "Thank the tree and leave", nextSection: 333, skillCheck: false}
                ]
            },
            335: {
                text: "You accept the ancient oak's wise advice.",
                choices: [
                    {text: "Thank the tree and leave", nextSection: 333, skillCheck: false}
                ],
                action: function() {
                    playSound('magic');
                    gameState.magic += 2;
                    updateStatsDisplay();
                    return "The ancient oak approves of your humility. It grants you a gift of wisdom. <span class='success'>Magic +2</span>";
                }
            },
            336: {
                text: "You demand power from the ancient oak, showing disrespect.",
                choices: [
                    {text: "See what happens", nextSection: 343, skillCheck: false}
                ],
                action: function() {
                    playSound('failure');
                    gameState.health -= 10;
                    updateStatsDisplay();
                    return "The ancient oak is displeased with your arrogance. A root lashes out and strikes you! You take <span class='damage'>10 damage</span> and are thrown from the clearing.";
                }
            },
            337: {
                text: "", // Filled by action
                choices: [
                    {text: "Thank the tree and leave", nextSection: 333, skillCheck: false}
                ]
            },
            338: {
                text: "The ancient oak accepts your hair offering.",
                choices: [
                    {text: "Thank the tree and leave", nextSection: 333, skillCheck: false}
                ]
            },
            339: {
                text: "The ancient oak accepts your blood offering.",
                choices: [
                    {text: "Thank the tree and leave", nextSection: 333, skillCheck: false}
                ]
            },
            340: {
                text: "You make one final push and emerge from the Forest of Dreadwood! You stand at the tree line, looking up at the cold, rocky slopes of the Mountains of Moor.",
                choices: [
                    {text: "Begin the mountain ascent", nextSection: 300, skillCheck: false}
                ]
            },
            341: {
                text: "", // Combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 331, skillCheck: false}
                ]
            },
            342: {
                text: "With the bear defeated, you search its cave thoroughly.",
                choices: [
                    {text: "Take what you find", nextSection: 344, skillCheck: false},
                    {text: "Continue upward", nextSection: 309, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    addToInventory('Bear Pelt');
                    addToInventory('Sharp Claws');
                    playSound('item');
                    return "You search the cave and find <span class='gold'>" + goldFound + " Gold</span> from the bear's victims. You also take the <span class='item'>Bear Pelt</span> and <span class='item'>Sharp Claws</span>.";
                }
            },
            343: {
                text: "You're thrown from the clearing, landing hard on the forest floor. The ancient oak's displeasure is clear.",
                choices: [
                    {text: "Continue through the forest", nextSection: 305, skillCheck: false}
                ]
            },
            344: {
                text: "You've taken everything valuable from the bear's cave.",
                choices: [
                    {text: "Continue upward", nextSection: 309, skillCheck: false}
                ]
            }
        };
        
        // Initialize game
        function initGame() {
            // Load game state from localStorage
            const savedGame = localStorage.getItem('islandLostSoulsGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 2 (this page)
                if (savedState.level === 2) {
                    Object.assign(gameState, savedState);
                    
                    // Update stats display
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    
                    // Show dark power stat if necromancer
                    if (gameState.playerClass === 'necromancer' && gameState.darkPower > 0) {
                        document.getElementById('dark-power-stat').style.display = 'block';
                        document.getElementById('stat-darkpower').textContent = gameState.darkPower;
                    }
                    
                    // Start the game
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    return;
                } else if (savedState.level === 1) {
                    // If coming from level 1, update level to 2
                    gameState.level = 2;
                    gameState.currentSection = 200;
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    
                    // Show dark power stat if necromancer
                    if (gameState.playerClass === 'necromancer' && gameState.darkPower > 0) {
                        document.getElementById('dark-power-stat').style.display = 'block';
                        document.getElementById('stat-darkpower').textContent = gameState.darkPower;
                    }
                    
                    // Start the game
                    showScreen('screen-game');
                    loadSection(200);
                    return;
                }
            }
            
            // If no saved game or wrong level, start from beginning
            alert("No saved game found for Level 2. Starting from Level 1...");
            window.location.href = 'lvl1.html';
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-magic').textContent = gameState.magic;
            document.getElementById('stat-gold').textContent = gameState.gold;
            
            // Update dark power if necromancer
            if (gameState.playerClass === 'necromancer') {
                document.getElementById('dark-power-stat').style.display = 'block';
                document.getElementById('stat-darkpower').textContent = gameState.darkPower;
            }
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item)) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/12`;
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            // Healing items
            if (item === 'Healing Herbs' || item === 'Old Healing Potion' || item === 'Forest Berries' || item === 'Sacred Herbs') {
                const healAmount = rollDice(1, 10) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Moonwell Water') {
                const healAmount = rollDice(2, 8) + 10;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory('Moonwell Water');
                playSound('magic');
                message = `You drink the <span class='item'>Moonwell Water</span> and restore ${actualHeal} Health! You also feel magically refreshed.`;
                gameState.magic += 2;
                updateStatsDisplay();
            } else if (item === 'Ship\'s Lantern') {
                message = "The <span class='item'>Ship's Lantern</span> provides light in dark areas. It might help in dark caves or at night.";
            } else if (item === 'Length of Rope') {
                message = "The <span class='item'>Length of Rope</span> could be useful for climbing or securing things in the mountains.";
            } else if (item === 'Lockpicks') {
                message = "The <span class='item'>Lockpicks</span> might help with locked doors or chests.";
            } else if (item === 'Waterlogged Spellbook') {
                message = "The <span class='item'>Waterlogged Spellbook</span> contains basic spells. Some pages are still legible.";
            } else if (item === 'Climbing Gear') {
                message = "The <span class='item'>Climbing Gear</span> will be essential for navigating the mountain slopes ahead.";
            } else if (item === 'Warm Fur Blanket') {
                message = "The <span class='item'>Warm Fur Blanket</span> will help protect against the cold mountain temperatures.";
            } else if (item === 'Waterfall Crystal') {
                message = "The <span class='item'>Waterfall Crystal</span> glows with soft blue light and radiates pure magic. It might have special properties.";
            } else if (item === 'Acorn of the Ancients') {
                const healAmount = rollDice(3, 6) + 10;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory('Acorn of the Ancients');
                playSound('magic');
                message = `You consume the <span class='item'>Acorn of the Ancients</span>! It releases powerful life energy, restoring ${actualHeal} Health and increasing your maximum health by 5!`;
                gameState.maxHealth += 5;
                updateStatsDisplay();
            } else if (item === 'Bear Pelt') {
                message = "The <span class='item'>Bear Pelt</span> is warm and thick. It could be used as a cloak or blanket against the cold.";
                // Option to equip it as armor
                if (confirm("Would you like to equip the Bear Pelt as armor?")) {
                    gameState.equippedArmor = 'Bear Pelt Cloak';
                    updateInventoryDisplay();
                    message += "<br>You equip the Bear Pelt as a cloak!";
                }
            } else if (item === 'Sharp Claws' || item === 'Corrupted Fangs' || item === 'Ancient Arrowhead') {
                message = `The <span class='item'>${item}</span> could be used as a weapon or tool.`;
                // Option to equip as weapon
                if (confirm(`Would you like to equip the ${item} as a weapon?`)) {
                    gameState.equippedWeapon = item;
                    updateInventoryDisplay();
                    message += `<br>You equip the ${item} as a weapon!`;
                }
            } else if (item.includes('Rune') || item.includes('Knowledge') || item.includes('Insight') || item.includes('Wisdom')) {
                message = `Your <span class='item'>${item}</span> gives you special understanding or abilities related to its nature.`;
            } else if (item === 'Wolf\'s Gratitude') {
                message = "The <span class='item'>Wolf's Gratitude</span> means forest creatures may be less hostile toward you.";
            } else if (item === 'Altar\'s Blessing' || item === 'Guardian\'s Favor' || item === 'Guardian\'s Ultimate Blessing' || item === 'Blessing of the Damned') {
                message = `The <span class='item'>${item}</span> provides you with spiritual protection and favor.`;
            } else if (item === 'Glowing Fungi Samples') {
                message = "The <span class='item'>Glowing Fungi Samples</span> pulse with soft light. They might have magical properties.";
            } else if (item === 'Ancient Bark') {
                message = "The <span class='item'>Ancient Bark</span> feels warm to the touch and radiates ancient power.";
            } else if (item === 'Root Resin') {
                message = "The <span class='item'>Root Resin</span> is sticky and has healing properties when applied to wounds.";
                // Option to use as healing
                if (confirm("Use Root Resin to heal wounds?")) {
                    const healAmount = rollDice(1, 8) + 3;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    removeFromInventory('Root Resin');
                    playSound('item');
                    message = `You apply the <span class='item'>Root Resin</span> to your wounds, healing ${actualHeal} Health!`;
                    updateStatsDisplay();
                }
            } else if (item === 'Moss Agate') {
                message = "The <span class='item'>Moss Agate</span> is a beautiful green stone that might be valuable or have earth-related magical properties.";
            } else if (item === 'Giant\'s Tooth') {
                message = "The <span class='item'>Giant's Tooth</span> is massive and could be fashioned into a powerful weapon or used as a valuable trade item.";
            } else if (item === 'Altar Offering Bowl') {
                message = "The <span class='item'>Altar Offering Bowl</span> is made of tarnished silver. It's valuable and might have ritual significance.";
            } else if (item === 'Bear Claw Necklace') {
                message = "The <span class='item'>Bear Claw Necklace</span> might intimidate lesser creatures or mark you as a powerful hunter.";
            } else if (item === 'Rune Rubbings') {
                message = "The <span class='item'>Rune Rubbings</span> show protective symbols from the forest. A scholar might pay well for these.";
            } else if (item === 'Fungal Insight') {
                message = "Your <span class='item'>Fungal Insight</span> gives you understanding of the forest's fungal networks and their properties.";
            } else if (item === 'Tree Markings Knowledge') {
                message = "Your <span class='item'>Tree Markings Knowledge</span> helps you navigate the forest by understanding the markings on trees.";
            } else if (item === 'Cursed Rat Teeth') {
                message = "The <span class='item'>Cursed Rat Teeth</span> radiate dark energy. They might be useful for necromancy or could be valuable to the right buyer.";
            } else if (item === 'Silver Locket') {
                message = "The <span class='item'>Silver Locket</span> contains a faded portrait of a happy couple, now long lost to the island's curse.";
            } else if (item === 'Ghostly Insight') {
                message = "Your <span class='item'>Ghostly Insight</span> gives you understanding of cursed souls and the island's tragedy.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Fists' && 
                gameState.equippedArmor === 'Tattered Clothes') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Use class ability
        function useClassAbility() {
            playSound('click');
            
            let abilityText = "<div class='dice-roll'>";
            
            if (gameState.playerClass === 'wizard') {
                abilityText += "<strong>Wizard Abilities:</strong><br>";
                abilityText += "You can attempt to cast spells using your Magic stat.<br>";
                abilityText += `<button onclick="castSpell('light')" class="action-btn" style="margin: 5px;">Cast Light</button> `;
                abilityText += `<button onclick="castSpell('shield')" class="action-btn" style="margin: 5px;">Cast Shield</button> `;
                abilityText += `<button onclick="castSpell('detect_magic')" class="action-btn" style="margin: 5px;">Detect Magic</button> `;
                abilityText += `<button onclick="castSpell('calm_animal')" class="action-btn" style="margin: 5px;">Calm Animal</button>`;
            } else if (gameState.playerClass === 'warrior') {
                abilityText += "<strong>Warrior Abilities:</strong><br>";
                abilityText += "You can use combat techniques.<br>";
                abilityText += `<button onclick="warriorAbility('intimidate')" class="action-btn" style="margin: 5px;">Intimidate Foe</button> `;
                abilityText += `<button onclick="warriorAbility('power_attack')" class="action-btn" style="margin: 5px;">Power Attack</button> `;
                abilityText += `<button onclick="warriorAbility('second_wind')" class="action-btn" style="margin: 5px;">Second Wind</button> `;
                abilityText += `<button onclick="warriorAbility('endure_elements')" class="action-btn" style="margin: 5px;">Endure Elements</button>`;
            } else if (gameState.playerClass === 'necromancer') {
                abilityText += "<strong>Necromancer Abilities:</strong><br>";
                abilityText += "You can use dark powers. Current Dark Power: " + gameState.darkPower + "<br>";
                abilityText += `<button onclick="necromancerAbility('command_undead')" class="action-btn" style="margin: 5px;">Command Undead (2 DP)</button> `;
                abilityText += `<button onclick="necromancerAbility('sense_death')" class="action-btn" style="margin: 5px;">Sense Death (0 DP)</button> `;
                abilityText += `<button onclick="necromancerAbility('dark_healing')" class="action-btn" style="margin: 5px;">Dark Healing (1 DP)</button> `;
                abilityText += `<button onclick="necromancerAbility('corrupt_nature')" class="action-btn" style="margin: 5px;">Corrupt Nature (3 DP)</button>`;
            }
            
            abilityText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Ability use cancelled.</div>'" class="action-btn">Cancel</button>`;
            abilityText += "</div>";
            
            document.getElementById('story-text').innerHTML += abilityText;
        }
        
        // Wizard spells
        function castSpell(spell) {
            playSound('magic');
            let message = "";
            const magicCheck = rollDice(2, 6);
            
            if (magicCheck <= gameState.magic) {
                // Success
                playSound('success');
                if (spell === 'light') {
                    message = `You successfully cast Light! The area around you brightens. Useful in dark forests and caves.`;
                } else if (spell === 'shield') {
                    message = `You successfully cast Shield! A magical barrier surrounds you, providing temporary protection.`;
                } else if (spell === 'detect_magic') {
                    message = `You successfully cast Detect Magic! You sense magical auras in the area.`;
                } else if (spell === 'calm_animal') {
                    message = `You successfully cast Calm Animal! Forest creatures become less aggressive toward you.`;
                }
            } else {
                // Failure
                playSound('failure');
                message = `You fail to cast the spell properly. The magic fizzles.`;
                // Minor backlash
                gameState.health -= 1;
                updateStatsDisplay();
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Warrior abilities
        function warriorAbility(ability) {
            playSound('combat');
            let message = "";
            
            if (ability === 'intimidate') {
                const strengthCheck = rollDice(2, 6);
                if (strengthCheck <= gameState.strength) {
                    playSound('success');
                    message = `You roar and intimidate your foes! They may think twice before attacking.`;
                } else {
                    playSound('failure');
                    message = `Your attempt to intimidate fails. The foes are unimpressed.`;
                }
            } else if (ability === 'power_attack') {
                message = `You prepare for a powerful attack. Your next combat strike will be stronger.`;
            } else if (ability === 'second_wind') {
                const healAmount = rollDice(1, 6) + Math.floor(gameState.strength / 2);
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                playSound('success');
                message = `You catch your second wind and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (ability === 'endure_elements') {
                message = `You steel yourself against the elements. You'll be more resistant to cold, heat, and fatigue.`;
                playSound('success');
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Necromancer abilities
        function necromancerAbility(ability) {
            playSound('cursed');
            let message = "";
            
            if (ability === 'command_undead') {
                if (gameState.darkPower >= 2) {
                    gameState.darkPower -= 2;
                    playSound('success');
                    message = `You exert your will over undead creatures! Lesser undead may obey your commands.`;
                    updateStatsDisplay();
                } else {
                    playSound('failure');
                    message = `You don't have enough Dark Power to command undead.`;
                }
            } else if (ability === 'sense_death') {
                message = `You attune yourself to the presence of death. You can sense undead and areas of great suffering.`;
                playSound('success');
            } else if (ability === 'dark_healing') {
                if (gameState.darkPower >= 1) {
                    const healAmount = rollDice(1, 8) + gameState.darkPower;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    gameState.darkPower -= 1;
                    playSound('success');
                    message = `You drain life energy from your surroundings and restore ${actualHeal} Health!`;
                    updateStatsDisplay();
                } else {
                    playSound('failure');
                    message = `You don't have enough Dark Power for dark healing.`;
                }
            } else if (ability === 'corrupt_nature') {
                if (gameState.darkPower >= 3) {
                    gameState.darkPower -= 3;
                    playSound('success');
                    message = `You corrupt the natural world around you! Plants wither and animals flee. Useful for clearing paths or creating fear.`;
                    updateStatsDisplay();
                } else {
                    playSound('failure');
                    message = `You don't have enough Dark Power to corrupt nature.`;
                }
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 223 || sectionId === 236 || sectionId === 331 || 
                                  sectionId === 341);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    const goldReward = Math.floor(Math.random() * 40) + 15;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find <span class="gold">${goldReward} Gold</span> on the remains.`;
                    
                    // Class-specific combat rewards
                    if (gameState.playerClass === 'necromancer' && combatState.enemyType === 'undead') {
                        gameState.darkPower += 2;
                        storyText += `<br><span class="necromancer">You absorb dark energy from the undead! Dark Power +2</span>`;
                        updateStatsDisplay();
                    } else if (gameState.playerClass === 'necromancer' && combatState.enemyType === 'beast') {
                        gameState.darkPower += 1;
                        storyText += `<br><span class="necromancer">You absorb some dark energy from the corrupted beast! Dark Power +1</span>`;
                        updateStatsDisplay();
                    }
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    // Check for item requirements
                    if (choice.requirement) {
                        if (choice.requirement === 'magic') {
                            return gameState.magic >= choice.minValue;
                        }
                        return gameState.inventory.includes(choice.requirement) || 
                               gameState.equippedWeapon === choice.requirement ||
                               gameState.equippedArmor === choice.requirement;
                    }
                    return true;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue through the forest";
                    button.onclick = function() {
                        loadSection(200); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add appropriate stat to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                if (gameState.equippedWeapon === 'Fists') damage = rollDice(1, 4) + Math.floor(gameState.strength / 3);
                else if (gameState.equippedWeapon === 'Broken Sword' || gameState.equippedWeapon === 'Sharp Claws') damage = rollDice(1, 8) + Math.floor(gameState.strength / 2);
                else if (gameState.equippedWeapon === 'Staff') damage = rollDice(1, 6) + Math.floor(gameState.strength / 3);
                else if (gameState.equippedWeapon === 'Ritual Dagger') damage = rollDice(1, 4) + Math.floor(gameState.strength / 3);
                else if (gameState.equippedWeapon === 'Ancient Arrowhead') damage = rollDice(1, 6) + Math.floor(gameState.strength / 2);
                else if (gameState.equippedWeapon === 'Corrupted Fangs') damage = rollDice(1, 6) + Math.floor(gameState.strength / 3) + 2; // +2 for poison
                else damage = rollDice(1, 6) + Math.floor(gameState.strength / 3); // Default
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                const enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('islandLostSoulsGameState');
                        location.reload();
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }

        // New Game function
        function newGame() {
            playSound('click');
            
            if (confirm("Are you sure you want to start a new game? All current progress will be lost!")) {
                // Clear the saved game from localStorage
                localStorage.removeItem('islandLostSoulsGameState');
                
                // Redirect to level 1
                window.location.href = 'lvl1.html';
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('islandLostSoulsGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('islandLostSoulsGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 2 (this page)
                if (savedState.level === 2) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    
                    // Show dark power stat if necromancer
                    if (gameState.playerClass === 'necromancer' && gameState.darkPower > 0) {
                        document.getElementById('dark-power-stat').style.display = 'block';
                        document.getElementById('stat-darkpower').textContent = gameState.darkPower;
                    }
                    
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 2.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 3 with updated level
            gameState.level = 3;
            localStorage.setItem('islandLostSoulsGameState', JSON.stringify(gameState));
            // Redirect to level 3
            window.location.href = 'lvl3.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
