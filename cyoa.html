<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fighting Fantasy: The Port of Peril</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #0a0a0a;
            color: #e0e0c0;
            line-height: 1.4;
            padding: 0;
            overflow-x: hidden;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect fill="%23e0e0c0" width="100" height="100"/></svg>');
        }

        #game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        #main-menu {
            display: flex;
        }

        .active {
            display: flex !important;
        }

        .header {
            text-align: center;
            padding: 8px;
            border-bottom: 1px solid #e0e0c0;
            margin-bottom: 0;
            flex-shrink: 0;
            flex-grow: 0;
            background-color: #1a1a1a;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            min-height: 0;
            margin: 0;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            background-color: #0f0f0f;
        }

        .compact-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            justify-content: flex-start;
        }

        .footer {
            padding: 8px;
            border-top: 1px solid #e0e0c0;
            margin-top: 0;
            flex-shrink: 0;
            flex-grow: 0;
            background-color: #1a1a1a;
        }

        button {
            background-color: #1a1a1a;
            color: #e0e0c0;
            border: 1px solid #e0e0c0;
            padding: 12px 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 2px 0;
            cursor: pointer;
            width: 100%;
            min-height: 50px;
            flex-shrink: 0;
            transition: all 0.1s ease;
        }

        button:active {
            background-color: #3a3a1a;
            color: #ffffa0;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap;
            border: 1px solid #e0e0c0;
            padding: 8px;
            background-color: #1a1a1a;
        }

        .stat-box {
            text-align: center;
            padding: 5px;
            min-width: 80px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #ffffa0;
        }

        .battle-area {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .combatant {
            text-align: center;
            width: 48%;
            min-width: 150px;
            margin-bottom: 10px;
            border: 1px solid #e0e0c0;
            padding: 10px;
            background-color: #1a1a1a;
        }

        .combatant-ascii {
            font-size: 12px;
            line-height: 1;
            margin: 5px 0;
            white-space: pre;
        }

        .health-bar {
            width: 100%;
            height: 10px;
            background-color: #333;
            margin: 5px 0;
        }

        .health-fill {
            height: 100%;
            background-color: #a05050;
        }

        .story-text {
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .choice-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .choice-btn {
            text-align: left;
            padding: 12px;
            background-color: #1a1a1a;
            border: 1px solid #e0e0c0;
            color: #e0e0c0;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .choice-btn:active {
            background-color: #3a3a1a;
            color: #ffffa0;
        }

        .dice-roll {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border: 1px dashed #e0e0c0;
            background-color: #1a1a1a;
        }

        .dice-result {
            font-size: 24px;
            font-weight: bold;
            color: #ffffa0;
            margin: 5px 0;
        }

        .combat-log {
            height: 120px;
            overflow-y: auto;
            border: 1px solid #e0e0c0;
            padding: 8px;
            margin-top: 10px;
            font-size: 13px;
            flex-shrink: 0;
            background-color: #1a1a1a;
        }

        .inventory {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 5px;
            margin-top: 10px;
        }

        .item {
            width: 48%;
            margin-bottom: 5px;
            border: 1px solid #e0e0c0;
            padding: 8px;
            min-width: 140px;
            background-color: #1a1a1a;
        }

        .item-special {
            border-color: #ffffa0;
            background-color: #2a2a1a;
        }

        .item-equipped {
            border-color: #a0ffa0;
            background-color: #1a2a1a;
        }

        .luck-test {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ffffa0;
            background-color: #2a2a1a;
        }

        .luck-result {
            font-weight: bold;
            margin: 5px 0;
            color: #ffffa0;
        }

        .success {
            color: #a0ffa0;
        }

        .failure {
            color: #ffa0a0;
        }

        .scrollable-container {
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            -webkit-overflow-scrolling: touch;
            padding: 5px;
            display: flex;
            flex-direction: column;
        }

        .game-over {
            text-align: center;
            padding: 20px;
        }

        .game-over-message {
            font-size: 18px;
            margin: 15px 0;
            color: #ffffa0;
        }

        .victory-message {
            color: #a0ffa0;
        }

        .defeat-message {
            color: #ffa0a0;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .critical-hit {
            color: #ffffa0;
            font-weight: bold;
            animation: pulse 0.5s infinite;
        }

        .monster-name {
            color: #ffa0a0;
            font-weight: bold;
        }

        .market-item {
            border: 1px solid #e0e0c0;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .item-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            width: 100%;
        }

        .item-action-btn {
            flex: 1;
            padding: 6px;
            font-size: 12px;
        }

        @media (max-height: 700px) {
            .header {
                padding: 5px;
            }
            
            .header pre {
                font-size: 10px;
                line-height: 1;
            }
            
            .header h2 {
                font-size: 16px;
            }
            
            .content {
                padding: 8px;
            }
            
            button {
                padding: 10px 6px;
                min-height: 40px;
                font-size: 13px;
            }
            
            .footer {
                padding: 5px;
            }
        }

        @media (max-height: 500px) {
            .header pre {
                display: none;
            }
            
            .header {
                padding: 3px;
            }
            
            .content {
                padding: 5px;
            }
            
            button {
                padding: 8px 4px;
                min-height: 36px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Main Menu Screen -->
        <div id="main-menu" class="screen active">
            <div class="header">
                <pre>
  _____ _    _ _____ _______ ______  _______ ______  
 |  ___| |  | |_   _|__   __|  ____|/ /_   _|  ____| 
 | |__ | |  | | | |    | |  | |__   ' /  | | | |__    
 |  __|| |  | | | |    | |  |  __|  <   | | |  __|   
 | |   | |__| |_| |_   | |  | |    . \ _| |_| |____  
 |_|    \____/|_____|  |_|  |_|    |\_|_____|______| 
                </pre>
                <h2>THE PORT OF PERIL</h2>
            </div>
            <div class="content">
                <div class="compact-list">
                    <button id="new-game">BEGIN YOUR QUEST</button>
                    <button id="continue-game">CONTINUE QUEST</button>
                    <button id="rules-btn">HOW TO PLAY</button>
                    <div class="stats" style="margin-top: 15px;">
                        <div class="stat-box">
                            <div>Skill</div>
                            <div class="stat-value">-</div>
                        </div>
                        <div class="stat-box">
                            <div>Stamina</div>
                            <div class="stat-value">-</div>
                        </div>
                        <div class="stat-box">
                            <div>Luck</div>
                            <div class="stat-value">-</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #a0a0a0;">
                        A Fighting Fantasy Gamebook Adventure
                    </div>
                </div>
            </div>
            <div class="footer">
                <p>Roll the dice and test your luck!</p>
            </div>
        </div>

        <!-- Story Screen -->
        <div id="story-screen" class="screen">
            <div class="header">
                <h2 id="story-title">THE PORT OF PERIL</h2>
                <div class="stats" style="margin: 5px 0 0 0; padding: 4px; font-size: 12px;">
                    <div>Skill: <span id="header-skill">0</span></div>
                    <div>Stamina: <span id="header-stamina">0</span>/<span id="header-max-stamina">0</span></div>
                    <div>Luck: <span id="header-luck">0</span></div>
                    <div>Gold: <span id="header-gold">0</span></div>
                </div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="story-text" id="story-text">
                        <!-- Story text will appear here -->
                    </div>
                    <div class="choice-list" id="choice-list">
                        <!-- Choice buttons will appear here -->
                    </div>
                    <div id="dice-roll-section" style="display: none;">
                        <div class="dice-roll">
                            <div>Rolling 2 dice...</div>
                            <div class="dice-result" id="dice-result">?</div>
                            <div id="dice-total"></div>
                        </div>
                        <button id="continue-after-roll">CONTINUE</button>
                    </div>
                    <div id="luck-test-section" style="display: none;">
                        <div class="luck-test">
                            <h3>Test Your Luck</h3>
                            <div>Roll 2 dice. If the total is less than or equal to your Luck, you are lucky!</div>
                            <div class="dice-result" id="luck-dice-result">?</div>
                            <div class="luck-result" id="luck-result"></div>
                            <div>Your Luck will decrease by 1 after this test.</div>
                        </div>
                        <button id="continue-after-luck">CONTINUE</button>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="inventory-btn">INVENTORY</button>
                <button id="market-btn">MARKET</button>
                <button id="save-game">SAVE GAME</button>
            </div>
        </div>

        <!-- Combat Screen -->
        <div id="combat-screen" class="screen">
            <div class="header">
                <h2>COMBAT</h2>
                <div class="stats" style="margin: 5px 0 0 0; padding: 4px; font-size: 12px;">
                    <div>Skill: <span id="combat-skill">0</span></div>
                    <div>Stamina: <span id="combat-stamina">0</span>/<span id="combat-max-stamina">0</span></div>
                    <div>Luck: <span id="combat-luck">0</span></div>
                </div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="battle-area">
                        <div class="combatant">
                            <h3>YOU</h3>
                            <div class="combatant-ascii">
    /\
   /  \
  /    \
 /______\
   |  |
   |  |
  /    \
                            </div>
                            <div>Skill: <span id="player-combat-skill">0</span></div>
                            <div>Stamina: <span id="player-combat-stamina">0</span></div>
                            <div class="health-bar">
                                <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
                            </div>
                        </div>
                        <div class="combatant">
                            <h3 id="enemy-name">ENEMY</h3>
                            <div class="combatant-ascii" id="enemy-ascii">
     /\
    /**\
   /****\
  /______\
   |    |
   |    |
  /      \
                            </div>
                            <div>Skill: <span id="enemy-skill">0</span></div>
                            <div>Stamina: <span id="enemy-stamina">0</span></div>
                            <div class="health-bar">
                                <div class="health-fill" id="enemy-health-fill" style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="combat-log" id="combat-log">
                        <!-- Combat log will appear here -->
                    </div>
                    <div class="dice-roll" id="combat-dice-roll" style="display: none;">
                        <h4>Combat Round</h4>
                        <div>Your Attack Strength: <span id="player-attack">0</span></div>
                        <div>Enemy Attack Strength: <span id="enemy-attack">0</span></div>
                        <div id="combat-result"></div>
                    </div>
                    <button id="attack-btn" style="margin-top: 10px;">ATTACK</button>
                    <button id="use-luck-combat" style="display: none;">TEST YOUR LUCK</button>
                    <button id="flee-combat" style="background-color: #3a1a1a;">FLEE</button>
                    <button id="victory-continue" style="display: none; background-color: #1a3a1a;">CONTINUE YOUR QUEST</button>
                </div>
            </div>
        </div>

        <!-- Inventory Screen -->
        <div id="inventory-screen" class="screen">
            <div class="header">
                <h2>INVENTORY</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="stats">
                        <div class="stat-box">
                            <div>Skill</div>
                            <div class="stat-value" id="inv-skill">0</div>
                        </div>
                        <div class="stat-box">
                            <div>Stamina</div>
                            <div class="stat-value" id="inv-stamina">0</div>
                        </div>
                        <div class="stat-box">
                            <div>Luck</div>
                            <div class="stat-value" id="inv-luck">0</div>
                        </div>
                        <div class="stat-box">
                            <div>Gold</div>
                            <div class="stat-value" id="inv-gold">0</div>
                        </div>
                    </div>
                    
                    <h3>Provisions: <span id="provisions-count">0</span></h3>
                    <button id="eat-provision" style="margin-bottom: 10px;">EAT PROVISION (Restore 4 Stamina)</button>
                    
                    <h3>Equipped Items:</h3>
                    <div id="equipped-items">
                        <!-- Equipped items will appear here -->
                    </div>
                    
                    <h3>Backpack:</h3>
                    <div id="inventory-list">
                        <!-- Inventory items will appear here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-inventory">BACK TO STORY</button>
            </div>
        </div>

        <!-- Market Screen -->
        <div id="market-screen" class="screen">
            <div class="header">
                <h2>MARKETPLACE</h2>
                <div>Your Gold: <span id="market-gold">0</span></div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="market-items">
                        <!-- Market items will appear here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-market">BACK TO STORY</button>
            </div>
        </div>

        <!-- Rules Screen -->
        <div id="rules-screen" class="screen">
            <div class="header">
                <h2>HOW TO PLAY</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="story-text">
                        <h3>Fighting Fantasy Game System</h3>
                        <p>In this adventure, you control the action by making choices and rolling dice.</p>
                        
                        <h4>Your Attributes:</h4>
                        <ul style="margin-left: 20px; margin-bottom: 15px;">
                            <li><strong>SKILL</strong>: Your fighting ability. Determines how good you are in combat.</li>
                            <li><strong>STAMINA</strong>: Your health. If it reaches zero, you die.</li>
                            <li><strong>LUCK</strong>: Your good fortune. Test your Luck to change your fate.</li>
                        </ul>
                        
                        <h4>Combat:</h4>
                        <p>When you enter combat, you and your enemy roll 2 dice and add your Skill scores.</p>
                        <p>The higher score wins and inflicts 2 damage on the loser.</p>
                        <p>If scores are equal, you both miss.</p>
                        
                        <h4>Testing Your Luck:</h4>
                        <p>You may Test Your Luck in certain situations. Roll 2 dice:</p>
                        <ul style="margin-left: 20px;">
                            <li>If the total is LESS than or equal to your current Luck: You are Lucky!</li>
                            <li>If the total is GREATER than your current Luck: You are Unlucky!</li>
                        </ul>
                        <p>Each time you Test Your Luck, your Luck score decreases by 1.</p>
                        
                        <h4>Provisions:</h4>
                        <p>You begin with 10 Provisions. Each Provision restores 4 Stamina when eaten.</p>
                        <p>You can eat Provisions during your adventure (except during combat).</p>

                        <h4>Equipment:</h4>
                        <p>You can find and purchase weapons, armor, and magical items.</p>
                        <p>Weapons increase your Skill in combat.</p>
                        <p>Armor increases your maximum Stamina.</p>
                        <p>Magical items provide special abilities.</p>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-rules">BACK TO MAIN MENU</button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen">
            <div class="header">
                <h2>YOUR QUEST IS OVER</h2>
            </div>
            <div class="content">
                <div class="game-over">
                    <pre>
   _____                         ____
  / ____|                       / __ \
 | |  __  __ _ _ __ ___   ___  | |  | |_   _____ _ __
 | | |_ |/ _` | '_ ` _ \ / _ \ | |  | \ \ / / _ \ '__|
 | |__| | (_| | | | | | |  __/ | |__| |\ V /  __/ |
  \_____|\__,_|_| |_| |_|\___|  \____/  \_/ \___|_|
                    </pre>
                    <div class="game-over-message" id="game-over-message">
                        You have failed in your quest.
                    </div>
                    <div style="margin: 20px 0;">
                        <div>Your journey ended at: <span id="game-over-location">Unknown</span></div>
                        <div>You reached paragraph: <span id="game-over-paragraph">0</span></div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="restart-after-game-over">TRY AGAIN</button>
                <button id="main-menu-after-game-over">MAIN MENU</button>
            </div>
        </div>
    </div>

    <script>
    // ============== FIGHTING FANTASY GAME STATE ==============
    const gameState = {
        player: {
            baseSkill: 0,
            skill: 0,
            baseStamina: 0,
            stamina: 0,
            maxStamina: 0,
            baseLuck: 0,
            luck: 0,
            gold: 0,
            provisions: 10,
            inventory: [],
            equipped: {
                weapon: null,
                armor: null,
                accessory: null
            }
        },
        currentParagraph: 1,
        currentEnemy: null,
        combatRound: 0,
        currentCombatVictoryParagraph: null,
        lastLuckTest: null,
        marketItems: [
            {
                id: "basic_sword",
                name: "Iron Sword",
                type: "weapon",
                cost: 25,
                skillBonus: 1,
                description: "A sturdy iron sword that increases your Skill by 1."
            },
            {
                id: "fine_sword",
                name: "Steel Sword",
                type: "weapon",
                cost: 50,
                skillBonus: 2,
                description: "A finely crafted steel sword that increases your Skill by 2."
            },
            {
                id: "magic_sword",
                name: "Enchanted Sword",
                type: "weapon",
                cost: 100,
                skillBonus: 3,
                description: "A magical sword that glows with power. Increases your Skill by 3."
            },
            {
                id: "leather_armor",
                name: "Leather Armor",
                type: "armor",
                cost: 20,
                staminaBonus: 4,
                description: "Light leather armor that increases your maximum Stamina by 4."
            },
            {
                id: "chainmail",
                name: "Chainmail",
                type: "armor",
                cost: 40,
                staminaBonus: 8,
                description: "Heavy chainmail armor that increases your maximum Stamina by 8."
            },
            {
                id: "plate_armor",
                name: "Plate Armor",
                type: "armor",
                cost: 80,
                staminaBonus: 12,
                description: "Full plate armor that increases your maximum Stamina by 12."
            },
            {
                id: "luck_charm",
                name: "Lucky Charm",
                type: "accessory",
                cost: 30,
                luckBonus: 2,
                description: "A small charm that increases your Luck by 2."
            },
            {
                id: "healing_potion",
                name: "Healing Potion",
                type: "consumable",
                cost: 15,
                effect: "heal",
                value: 10,
                description: "Restores 10 Stamina when used."
            },
            {
                id: "provisions",
                name: "Provisions",
                type: "consumable",
                cost: 5,
                effect: "provision",
                value: 1,
                description: "A day's worth of food. Restores 4 Stamina when eaten."
            }
        ],
        story: {
            1: {
                title: "The Port of Peril",
                text: "You stand at the gates of the notorious Port of Peril, a haven for pirates, thieves, and cutthroats. Your quest is to find the legendary Amulet of Kings, said to be hidden somewhere in this dangerous city. The salty sea air fills your lungs as you consider your options. Will you:",
                choices: [
                    { text: "Enter the tavern to gather information", next: 2 },
                    { text: "Head to the market district to buy supplies", next: 3 },
                    { text: "Explore the docks looking for clues", next: 4 }
                ]
            },
            2: {
                title: "The Rusty Cutlass Tavern",
                text: "You push open the heavy wooden door of the Rusty Cutlass Tavern. The air is thick with smoke and the smell of stale ale. Rough-looking sailors eye you suspiciously from shadowy corners. The bartender, a one-eyed man with a scar across his face, wipes a glass with a dirty rag. 'What'll it be, stranger?' he grunts.",
                choices: [
                    { text: "Ask about the Amulet of Kings", next: 5 },
                    { text: "Order a drink and listen to conversations", next: 6 },
                    { text: "Challenge a patron to a dice game", next: 7 },
                    { text: "Leave the tavern", next: 1 }
                ]
            },
            3: {
                title: "The Market District",
                text: "The market district is a bustling maze of stalls and shops. Merchants shout their wares, from exotic spices to suspicious-looking potions. You notice a weapons merchant, an armor smith, and a mysterious fortune teller's tent.",
                choices: [
                    { text: "Visit the weapons merchant", next: 8 },
                    { text: "Check the armor smith's wares", next: 9 },
                    { text: "Consult the fortune teller", next: 10 },
                    { text: "Return to the city gates", next: 1 }
                ]
            },
            4: {
                title: "The Docks",
                text: "The docks are crowded with ships of all sizes, from small fishing boats to massive galleons. Sailors load and unload cargo, while seabirds cry overhead. You notice a suspicious-looking ship with black sails and a group of thugs harassing a merchant.",
                choices: [
                    { text: "Investigate the black-sailed ship", next: 11 },
                    { text: "Help the merchant being harassed", next: 12 },
                    { text: "Search the warehouses for clues", next: 13 },
                    { text: "Return to the city gates", next: 1 }
                ]
            },
            5: {
                title: "Asking About the Amulet",
                text: "The bartender's eye widens at the mention of the Amulet. 'That's dangerous talk, friend,' he whispers. 'The last person who asked about that ended up at the bottom of the harbor. But if you're determined, talk to Old Man Hemlock. He lives in the old lighthouse. Now buy a drink or get out.'",
                choices: [
                    { text: "Buy a drink (1 Gold)", next: 14 },
                    { text: "Leave the tavern", next: 1 }
                ]
            },
            6: {
                title: "Listening In",
                text: "You order an ale and find a dark corner to observe the tavern's patrons. After a while, you overhear two sailors talking about a 'secret meeting at midnight in the old catacombs.' One mentions something about a 'powerful artifact' being moved tonight. This could be your chance!",
                choices: [
                    { text: "Follow the sailors when they leave", next: 15 },
                    { text: "Ask them about the artifact", next: 16 },
                    { text: "Return to the city gates", next: 1 }
                ]
            },
            7: {
                title: "Dice Game",
                text: "You approach a table where a grizzled pirate is playing dice alone. 'Care for a game, landlubber?' he sneers. 'Ten gold says you can't beat me.'",
                choices: [
                    { text: "Accept the challenge", next: 17 },
                    { text: "Decline and leave", next: 2 }
                ]
            },
            8: {
                title: "Weapons Merchant",
                text: "The weapons merchant shows you his wares. 'For a skilled adventurer like yourself, I have just the thing,' he says, showing you various swords and weapons.",
                choices: [
                    { text: "Browse weapons", next: 18 },
                    { text: "Return to the market", next: 3 }
                ]
            },
            9: {
                title: "Armor Smith",
                text: "The armor smith displays various pieces of armor. 'This will protect you better than what you're wearing,' he says.",
                choices: [
                    { text: "Browse armor", next: 19 },
                    { text: "Return to the market", next: 3 }
                ]
            },
            10: {
                title: "Fortune Teller",
                text: "The fortune teller gazes into her crystal ball. 'I see danger in your future... and great treasure. The Amulet you seek is hidden beneath the city, in the catacombs. But beware - dark forces protect it.' She gives you a small luck charm.",
                reward: {
                    inventory: [{
                        id: "fortune_charm",
                        name: "Fortune Teller's Charm",
                        type: "accessory",
                        luckBonus: 1,
                        description: "A small charm given by the fortune teller. Increases Luck by 1."
                    }]
                },
                choices: [
                    { text: "Thank her and leave", next: 3 }
                ]
            },
            11: {
                title: "The Black-Sailed Ship",
                text: "As you approach the suspicious ship, two armed guards block your path. 'No one boards the Sea Serpent without the captain's permission,' one growls. They don't look like they'll let you pass peacefully.",
                choices: [
                    { text: "Try to fight your way past", next: 20 },
                    { text: "Attempt to bribe them (5 Gold)", next: 21 },
                    { text: "Leave and come back later", next: 4 }
                ]
            },
            12: {
                title: "Street Thugs",
                text: "Three rough-looking thugs surround a terrified merchant. 'Hand over your gold, old man!' one of them snarls. They notice you approaching. 'Stay out of this, stranger, if you know what's good for you!'",
                combat: {
                    enemy: "thugs",
                    skill: 7,
                    stamina: 8,
                    ascii: `     /\\    /\\    /\\
    /  \\  /  \\  /  \\
   | () || () || () |
   |    ||    ||    |
  /      \\/      \\/      \\`,
                    victory: 22,
                    defeat: 100
                }
            },
            13: {
                title: "Warehouse Search",
                text: "You sneak into a nearby warehouse. Inside, you find crates of various goods. As you search, you discover a hidden compartment containing a map of the city's underground catacombs! This could be invaluable for your quest.",
                reward: {
                    inventory: [{
                        id: "catacomb_map",
                        name: "Catacomb Map",
                        type: "special",
                        description: "A detailed map of the underground catacombs beneath the city."
                    }]
                },
                choices: [
                    { text: "Take the map and leave", next: 23 },
                    { text: "Continue searching the warehouse", next: 24 }
                ]
            },
            14: {
                title: "Buying a Drink",
                text: "You slide a gold coin across the bar. The bartender pours you a mug of questionable-looking ale. 'Old Man Hemlock, you say? He's a strange one. Lives out in the lighthouse, like I said. But be careful - they say the place is haunted.'",
                choices: [
                    { text: "Ask for directions to the lighthouse", next: 25 },
                    { text: "Finish your drink and leave", next: 2 }
                ]
            },
            15: {
                title: "Following the Sailors",
                text: "You discreetly follow the sailors through the winding streets of the Port. They lead you to a hidden entrance in the cliffs overlooking the sea. This must be the entrance to the catacombs they mentioned!",
                choices: [
                    { text: "Enter the catacombs", next: 26 },
                    { text: "Wait and observe", next: 27 },
                    { text: "Return to the city", next: 1 }
                ]
            },
            16: {
                title: "Confronting the Sailors",
                text: "You approach the sailors. 'I couldn't help but overhear your conversation about an artifact,' you say. They immediately become hostile. 'You've heard too much!' one snarls, drawing a dagger.",
                combat: {
                    enemy: "sailors",
                    skill: 8,
                    stamina: 10,
                    ascii: `     /\\         /\\
    /  \\       /  \\
   |    |     |    |
   |    |     |    |
  /      \\   /      \\`,
                    victory: 28,
                    defeat: 100
                }
            },
            17: {
                title: "Dice Game Result",
                text: "You sit down to play dice with the pirate.",
                choices: [
                    { text: "Roll the dice", next: 29 }
                ]
            },
            18: {
                title: "Weapons Market",
                text: "The weapons merchant shows you his selection of swords and other weapons.",
                choices: [
                    { text: "Visit the market to buy weapons", next: 30 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            19: {
                title: "Armor Market",
                text: "The armor smith shows you various pieces of protective gear.",
                choices: [
                    { text: "Visit the market to buy armor", next: 31 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            20: {
                title: "Ship Guards",
                text: "You decide to fight your way past the guards. They draw their weapons and prepare for battle.",
                combat: {
                    enemy: "guards",
                    skill: 9,
                    stamina: 12,
                    ascii: `     /\\         /\\
    /  \\       /  \\
   | [] |     | [] |
   |    |     |    |
  /      \\   /      \\`,
                    victory: 32,
                    defeat: 100
                }
            },
            21: {
                title: "Bribing the Guards",
                text: "You discreetly offer the guards 5 gold coins. They glance at each other, then one pockets the money. 'Alright, you can take a quick look. But if the captain finds out, we never saw you.'",
                choices: [
                    { text: "Board the ship", next: 33 },
                    { text: "Change your mind and leave", next: 4 }
                ]
            },
            22: {
                title: "Grateful Merchant",
                text: "The thugs lie unconscious on the ground. The merchant thanks you profusely. 'Thank you, brave adventurer! Those ruffians would have taken everything I have. Please, take this reward.' He hands you 10 Gold and a healing potion.",
                reward: {
                    gold: 10,
                    inventory: [{
                        id: "merchant_potion",
                        name: "Healing Potion",
                        type: "consumable",
                        effect: "heal",
                        value: 10,
                        description: "Restores 10 Stamina when used."
                    }]
                },
                choices: [
                    { text: "Continue exploring the docks", next: 4 }
                ]
            },
            23: {
                title: "Map Found",
                text: "You take the catacomb map and quickly leave the warehouse before anyone notices you. The map shows secret passages and chambers beneath the city. This could be the key to finding the Amulet of Kings!",
                choices: [
                    { text: "Study the map", next: 34 },
                    { text: "Return to the city", next: 1 }
                ]
            },
            24: {
                title: "Continued Search",
                text: "You continue searching the warehouse but find nothing else of interest. The map is your only valuable discovery.",
                choices: [
                    { text: "Take the map and leave", next: 23 },
                    { text: "Keep searching", next: 35 }
                ]
            },
            25: {
                title: "Directions to the Lighthouse",
                text: "'The lighthouse is east of here, on the cliffs overlooking the sea,' the bartender says. 'But I'm telling you, that place isn't safe. Strange lights, weird noises... and people who go there don't always come back.'",
                choices: [
                    { text: "Head to the lighthouse", next: 36 },
                    { text: "Decide it's too dangerous", next: 2 }
                ]
            },
            26: {
                title: "The Catacombs",
                text: "You enter the dark catacombs. The air is damp and cold. Torchlight flickers in the distance - the sailors must be ahead. You follow carefully, trying to stay hidden.",
                choices: [
                    { text: "Continue following the sailors", next: 37 },
                    { text: "Explore a side passage", next: 38 },
                    { text: "Return to the entrance", next: 15 }
                ]
            },
            27: {
                title: "Observation",
                text: "You hide in the shadows and watch as the sailors enter the catacombs. After a few minutes, more people arrive - including a tall figure in dark robes who seems to be in charge. This looks like an important meeting.",
                choices: [
                    { text: "Sneak into the catacombs", next: 39 },
                    { text: "Wait to see if anyone else arrives", next: 40 },
                    { text: "Return to the city", next: 1 }
                ]
            },
            28: {
                title: "Sailors Defeated",
                text: "You defeat the sailors in combat. Searching their bodies, you find a note with instructions: 'Midnight meeting at the catacombs. Bring the key.' You also find 15 gold.",
                reward: {
                    gold: 15,
                    inventory: [{
                        id: "catacomb_key",
                        name: "Catacomb Key",
                        type: "special",
                        description: "A rusty iron key that unlocks the catacomb doors."
                    }]
                },
                choices: [
                    { text: "Head to the catacombs", next: 26 },
                    { text: "Return to the tavern", next: 2 }
                ]
            },
            29: {
                title: "Dice Game",
                text: "The pirate rolls the dice...",
                choices: [
                    { text: "Test your luck", next: 41 }
                ]
            },
            30: {
                title: "Weapons Shop",
                text: "You browse the weapons merchant's selection.",
                choices: [
                    { text: "Visit the market to browse weapons", next: 42 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            31: {
                title: "Armor Shop",
                text: "You examine the armor smith's protective gear.",
                choices: [
                    { text: "Visit the market to browse armor", next: 43 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            32: {
                title: "Guards Defeated",
                text: "You defeat the guards and board the Sea Serpent. Below deck, you find a locked chest. It looks important.",
                choices: [
                    { text: "Try to pick the lock", next: 44 },
                    { text: "Search for the key", next: 45 },
                    { text: "Leave the ship", next: 4 }
                ]
            },
            33: {
                title: "On Board the Sea Serpent",
                text: "You board the suspicious ship. Below deck, you find a locked chest. It looks important.",
                choices: [
                    { text: "Try to pick the lock", next: 44 },
                    { text: "Search for the key", next: 45 },
                    { text: "Leave the ship", next: 4 }
                ]
            },
            34: {
                title: "Studying the Map",
                text: "You study the catacomb map. It shows a complex network of tunnels beneath the city, with one chamber marked with a strange symbol. That must be where the Amulet is hidden! The map also shows a secret entrance near the marketplace.",
                choices: [
                    { text: "Go to the marketplace entrance", next: 46 },
                    { text: "Return to the city gates", next: 1 }
                ]
            },
            35: {
                title: "Lucky Find",
                text: "Your thorough search pays off! In a hidden compartment under a floorboard, you find a small bag containing 20 gold coins and a silver dagger.",
                reward: {
                    gold: 20,
                    inventory: [{
                        id: "silver_dagger",
                        name: "Silver Dagger",
                        type: "weapon",
                        skillBonus: 1,
                        description: "A finely crafted silver dagger. Increases Skill by 1."
                    }]
                },
                choices: [
                    { text: "Take your findings and leave", next: 4 }
                ]
            },
            36: {
                title: "The Lighthouse",
                text: "You arrive at the old lighthouse. It stands tall on the cliffs, its light extinguished. The door creaks open as you approach. Inside, it's dark and dusty. Suddenly, you hear a voice from the shadows: 'I've been expecting you.'",
                choices: [
                    { text: "Ask about the Amulet", next: 47 },
                    { text: "Prepare for a fight", next: 48 },
                    { text: "Flee back to the city", next: 1 }
                ]
            },
            37: {
                title: "Following the Sailors",
                text: "You follow the sailors deeper into the catacombs. They stop at a large stone door and use a key to unlock it. Inside, you can see flickering torchlight and hear voices.",
                choices: [
                    { text: "Sneak in after them", next: 49 },
                    { text: "Wait outside and listen", next: 50 },
                    { text: "Return to the entrance", next: 26 }
                ]
            },
            38: {
                title: "Side Passage",
                text: "You explore a narrow side passage. It leads to a small chamber with an ancient sarcophagus. The lid is slightly ajar...",
                choices: [
                    { text: "Open the sarcophagus", next: 51 },
                    { text: "Leave it alone and go back", next: 26 }
                ]
            },
            39: {
                title: "Sneaking In",
                text: "You slip into the catacombs unnoticed. The robed figure is addressing a group of sailors. '...and tonight we finally claim the Amulet of Kings! With its power, we will rule the Port!'",
                choices: [
                    { text: "Confront them", next: 52 },
                    { text: "Hide and wait for an opportunity", next: 53 },
                    { text: "Retreat and get help", next: 1 }
                ]
            },
            40: {
                title: "More Arrivals",
                text: "You wait patiently and see several more people arrive, all wearing the same dark robes. This is clearly a secret cult meeting. They all enter the catacombs.",
                choices: [
                    { text: "Follow them in", next: 39 },
                    { text: "Return to town to warn someone", next: 1 }
                ]
            },
            41: {
                title: "Dice Game Result",
                text: "The pirate rolls the dice and gets a total of 9. Now it's your turn to roll!",
                choices: [
                    { text: "Roll the dice", next: 54 }
                ]
            },
            42: {
                title: "Weapons Market",
                text: "You examine the weapons available for purchase.",
                choices: [
                    { text: "Visit the market to buy weapons", next: 55 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            43: {
                title: "Armor Market",
                text: "You look at the various armor pieces for sale.",
                choices: [
                    { text: "Visit the market to buy armor", next: 56 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            44: {
                title: "Picking the Lock",
                text: "You attempt to pick the lock on the chest...",
                choices: [
                    { text: "Test your luck", next: 57 }
                ]
            },
            45: {
                title: "Searching for the Key",
                text: "You search the ship's cabin and find the key hidden under the captain's bed! You unlock the chest and find 50 gold coins and a mysterious scroll.",
                reward: {
                    gold: 50,
                    inventory: [{
                        id: "mysterious_scroll",
                        name: "Mysterious Scroll",
                        type: "special",
                        description: "An ancient scroll with strange symbols. Its purpose is unknown."
                    }]
                },
                choices: [
                    { text: "Take the treasure and leave", next: 4 }
                ]
            },
            46: {
                title: "Marketplace Entrance",
                text: "Using the map, you find the hidden catacomb entrance behind a false wall in the marketplace. The passage leads downward into darkness.",
                choices: [
                    { text: "Enter the catacombs", next: 58 },
                    { text: "Return to the city", next: 1 }
                ]
            },
            47: {
                title: "Old Man Hemlock",
                text: "An old man steps out of the shadows. 'So you seek the Amulet of Kings,' he says. 'Many have tried, few have succeeded. The Amulet is protected by ancient magic in the deepest catacombs. But first, you must prove your worth.'",
                choices: [
                    { text: "How can I prove myself?", next: 59 },
                    { text: "I don't have time for games", next: 60 },
                    { text: "Leave the lighthouse", next: 1 }
                ]
            },
            48: {
                title: "Lighthouse Guardian",
                text: "A spectral figure materializes before you! 'None may pass to the sacred catacombs without proving their worth!' it intones.",
                combat: {
                    enemy: "guardian",
                    skill: 10,
                    stamina: 14,
                    ascii: `    .-.
   (   )
    | |
    | |
   _| |_
  |_____|
    | |
    | |
   /   \\
  /     \\`,
                    victory: 61,
                    defeat: 100
                }
            },
            49: {
                title: "The Cult Meeting",
                text: "You sneak into the chamber and hide behind a pillar. The robed figure holds up a glowing amulet! 'Behold! The Amulet of Kings! With its power, we shall rule this city!'",
                choices: [
                    { text: "Rush forward and grab the amulet", next: 62 },
                    { text: "Create a distraction", next: 63 },
                    { text: "Wait for a better opportunity", next: 64 }
                ]
            },
            50: {
                title: "Listening",
                text: "You listen at the door. '...the ritual must be performed at midnight. Then the Amulet's true power will be unleashed!' says the cult leader. 'We must stop anyone from interfering.'",
                choices: [
                    { text: "Burst in and attack", next: 65 },
                    { text: "Try to sneak in quietly", next: 49 },
                    { text: "Retreat and plan better", next: 26 }
                ]
            },
            51: {
                title: "The Sarcophagus",
                text: "You push open the heavy stone lid. Inside, you find a skeleton wearing ancient armor and holding a glowing sword! As you reach for it, the skeleton's eyes flash with blue light!",
                combat: {
                    enemy: "skeleton",
                    skill: 9,
                    stamina: 8,
                    ascii: `     ___
    /   \\
   | () |
    \\___/
     /|
    / |
   /  |`,
                    victory: 66,
                    defeat: 100
                }
            },
            52: {
                title: "Confronting the Cult",
                text: "You step out of the shadows. 'Stop! The Amulet doesn't belong to you!' The cult leader turns to you, his eyes burning with anger. 'Kill the intruder!'",
                combat: {
                    enemy: "cult_leader",
                    skill: 11,
                    stamina: 16,
                    ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\
    |  |
    |  |
   /    \\`,
                    victory: 67,
                    defeat: 100
                }
            },
            53: {
                title: "Waiting",
                text: "You hide behind a pillar and watch as the cult begins their ritual. The Amulet glows brighter and brighter. Soon it will be too late!",
                choices: [
                    { text: "Attack now!", next: 52 },
                    { text: "Try to steal the Amulet quietly", next: 68 },
                    { text: "Use a distraction", next: 63 }
                ]
            },
            54: {
                title: "Dice Result",
                text: "You roll the dice...",
                dynamicText: function() {
                    const playerRoll = rollDice(2);
                    const pirateRoll = 9; // Fixed from earlier
                    
                    if (playerRoll > pirateRoll) {
                        gameState.player.gold += 10;
                        return `You rolled ${playerRoll}! You win! The pirate grumbles and hands over 10 gold.`;
                    } else if (playerRoll < pirateRoll) {
                        gameState.player.gold = Math.max(0, gameState.player.gold - 10);
                        return `You rolled ${playerRoll}! You lose! The pirate laughs as you hand over 10 gold.`;
                    } else {
                        return `You rolled ${playerRoll}! It's a tie! No money changes hands.`;
                    }
                },
                choices: [
                    { text: "Continue", next: 2 }
                ]
            },
            55: {
                title: "Weapons Market",
                text: "You look at the weapons available for purchase.",
                choices: [
                    { text: "Visit the market to buy weapons", next: 69 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            56: {
                title: "Armor Market",
                text: "You examine the armor pieces for sale.",
                choices: [
                    { text: "Visit the market to buy armor", next: 70 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            57: {
                title: "Lockpicking Result",
                text: "You attempt to pick the lock...",
                dynamicText: function() {
                    const luckResult = testLuck();
                    
                    if (luckResult.lucky) {
                        gameState.player.gold += 30;
                        return `You're lucky! The lock clicks open. Inside, you find 30 gold coins!`;
                    } else {
                        return `You're unlucky! The lock won't budge. You'll need to find the key.`;
                    }
                },
                choices: [
                    { text: "Continue", next: 33 }
                ]
            },
            58: {
                title: "Catacombs from Market",
                text: "You enter the catacombs through the hidden market entrance. The passages are dark and winding. You hear faint chanting in the distance.",
                choices: [
                    { text: "Follow the chanting", next: 71 },
                    { text: "Explore the side passages", next: 38 },
                    { text: "Return to the market", next: 1 }
                ]
            },
            59: {
                title: "The Test",
                text: "'To prove your worth, you must answer this riddle,' says Old Man Hemlock. 'I speak without a mouth and hear without ears. I have no body, but I come alive with wind. What am I?'",
                choices: [
                    { text: "An echo", next: 72 },
                    { text: "A ghost", next: 73 },
                    { text: "Music", next: 74 }
                ]
            },
            60: {
                title: "Impatience",
                text: "'Fool!' shouts Old Man Hemlock. 'You are not worthy of the Amulet!' He raises his staff and a magical energy surrounds you.",
                combat: {
                    enemy: "hemlock",
                    skill: 12,
                    stamina: 18,
                    ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\
    |  |
    |  |
   /    \\`,
                    victory: 75,
                    defeat: 100
                }
            },
            61: {
                title: "Guardian Defeated",
                text: "The spectral guardian fades away. 'You have proven yourself worthy,' it says before disappearing completely. Old Man Hemlock approaches you. 'You have passed the test. The Amulet is in the deepest chamber of the catacombs. But beware - a cult seeks to claim its power tonight!'",
                choices: [
                    { text: "Head to the catacombs", next: 58 },
                    { text: "Ask for more information", next: 76 }
                ]
            },
            62: {
                title: "Grabbing the Amulet",
                text: "You rush forward and snatch the Amulet from the cult leader's hands! 'Stop him!' he screams as the cultists draw their weapons.",
                combat: {
                    enemy: "cultists",
                    skill: 8,
                    stamina: 20,
                    ascii: `     /\\    /\\    /\\
    /  \\  /  \\  /  \\
   | () || () || () |
   |    ||    ||    |
  /      \\/      \\/      \\`,
                    victory: 77,
                    defeat: 100
                }
            },
            63: {
                title: "Distraction",
                text: "You throw a rock against the far wall. The cultists turn to investigate the noise, giving you an opportunity!",
                choices: [
                    { text: "Sneak up and grab the Amulet", next: 78 },
                    { text: "Attack from behind", next: 79 },
                    { text: "Use the confusion to escape", next: 26 }
                ]
            },
            64: {
                title: "Waiting Too Long",
                text: "You wait too long! The cult leader begins the ritual. 'By the ancient powers, I claim the Amulet of Kings!' The Amulet glows with intense light, and you feel a wave of magical energy.",
                choices: [
                    { text: "Attack now!", next: 52 },
                    { text: "Flee while you still can", next: 26 }
                ]
            },
            65: {
                title: "Surprise Attack",
                text: "You burst into the chamber, taking the cult by surprise!",
                combat: {
                    enemy: "surprised_cult",
                    skill: 7,
                    stamina: 18,
                    ascii: `     /\\    /\\    /\\
    /  \\  /  \\  /  \\
   | () || () || () |
   |    ||    ||    |
  /      \\/      \\/      \\`,
                    victory: 80,
                    defeat: 100
                }
            },
            66: {
                title: "Ancient Sword",
                text: "The skeleton crumbles to dust. You take the glowing sword - it feels powerful in your hands! This ancient weapon will aid you in your quest.",
                reward: {
                    inventory: [{
                        id: "ancient_sword",
                        name: "Ancient Sword",
                        type: "weapon",
                        skillBonus: 2,
                        description: "An ancient sword that glows with magical energy. Increases Skill by 2."
                    }]
                },
                choices: [
                    { text: "Continue exploring", next: 26 }
                ]
            },
            67: {
                title: "Cult Leader Defeated",
                text: "The cult leader falls to the ground. The other cultists flee in terror. You've done it! The Amulet of Kings is yours!",
                reward: {
                    inventory: [{
                        id: "amulet_of_kings",
                        name: "Amulet of Kings",
                        type: "special",
                        description: "The legendary Amulet of Kings, said to grant its wielder great power."
                    }]
                },
                choices: [
                    { text: "Take the Amulet and escape", next: 81 }
                ]
            },
            68: {
                title: "Stealing the Amulet",
                text: "You try to sneak up and grab the Amulet, but the cult leader senses your presence!",
                combat: {
                    enemy: "alert_cult",
                    skill: 10,
                    stamina: 16,
                    ascii: `     /\\    /\\    /\\
    /  \\  /  \\  /  \\
   | () || () || () |
   |    ||    ||    |
  /      \\/      \\/      \\`,
                    victory: 82,
                    defeat: 100
                }
            },
            69: {
                title: "Weapons Market",
                text: "You browse the weapons available for purchase.",
                choices: [
                    { text: "Visit the market to buy weapons", next: 83 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            70: {
                title: "Armor Market",
                text: "You examine the armor pieces for sale.",
                choices: [
                    { text: "Visit the market to buy armor", next: 84 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            71: {
                title: "Following the Chanting",
                text: "You follow the chanting sound through the winding catacombs. It leads you to a large chamber where cultists are gathered around their leader, who holds the glowing Amulet of Kings!",
                choices: [
                    { text: "Confront them", next: 52 },
                    { text: "Sneak closer", next: 49 },
                    { text: "Set a trap", next: 85 }
                ]
            },
            72: {
                title: "Correct Answer",
                text: "'Correct!' says Old Man Hemlock. 'You are indeed worthy. The Amulet is in the deepest chamber of the catacombs, but a cult seeks to claim it tonight. You must hurry!' He gives you a magical potion.",
                reward: {
                    inventory: [{
                        id: "magic_potion",
                        name: "Magic Potion",
                        type: "consumable",
                        effect: "heal",
                        value: 20,
                        description: "A powerful healing potion that restores 20 Stamina."
                    }]
                },
                choices: [
                    { text: "Head to the catacombs immediately", next: 58 }
                ]
            },
            73: {
                title: "Wrong Answer",
                text: "'Incorrect!' says Old Man Hemlock. 'You are not worthy of the Amulet.' He raises his staff and magical energy surrounds you.",
                combat: {
                    enemy: "hemlock",
                    skill: 12,
                    stamina: 18,
                    ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\
    |  |
    |  |
   /    \\`,
                    victory: 75,
                    defeat: 100
                }
            },
            74: {
                title: "Wrong Answer",
                text: "'Incorrect!' says Old Man Hemlock. 'You are not worthy of the Amulet.' He raises his staff and magical energy surrounds you.",
                combat: {
                    enemy: "hemlock",
                    skill: 12,
                    stamina: 18,
                    ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\
    |  |
    |  |
   /    \\`,
                    victory: 75,
                    defeat: 100
                }
            },
            75: {
                title: "Hemlock Defeated",
                text: "Old Man Hemlock falls to his knees. 'You... you are more powerful than I expected. The Amulet is in the catacombs. Take it... before the cult does.'",
                choices: [
                    { text: "Head to the catacombs", next: 58 }
                ]
            },
            76: {
                title: "More Information",
                text: "'The cult is led by a powerful sorcerer named Malakar,' explains Hemlock. 'He seeks to use the Amulet to control the Port. You must stop him before the ritual is complete at midnight.' He gives you a protective amulet.",
                reward: {
                    inventory: [{
                        id: "protective_amulet",
                        name: "Protective Amulet",
                        type: "accessory",
                        luckBonus: 1,
                        description: "A protective amulet that increases your Luck by 1."
                    }]
                },
                choices: [
                    { text: "Head to the catacombs", next: 58 }
                ]
            },
            77: {
                title: "Amulet Obtained",
                text: "You fight off the cultists and escape with the Amulet of Kings! You've completed your quest!",
                reward: {
                    inventory: [{
                        id: "amulet_of_kings",
                        name: "Amulet of Kings",
                        type: "special",
                        description: "The legendary Amulet of Kings, said to grant its wielder great power."
                    }]
                },
                choices: [
                    { text: "Escape the catacombs", next: 81 }
                ]
            },
            78: {
                title: "Successful Theft",
                text: "While the cultists are distracted, you sneak up and grab the Amulet! You make a run for it before they notice!",
                reward: {
                    inventory: [{
                        id: "amulet_of_kings",
                        name: "Amulet of Kings",
                        type: "special",
                        description: "The legendary Amulet of Kings, said to grant its wielder great power."
                    }]
                },
                choices: [
                    { text: "Escape quickly", next: 81 }
                ]
            },
            79: {
                title: "Back Attack",
                text: "You attack the cultists from behind while they're distracted!",
                combat: {
                    enemy: "distracted_cult",
                    skill: 6,
                    stamina: 15,
                    ascii: `     /\\    /\\    /\\
    /  \\  /  \\  /  \\
   | () || () || () |
   |    ||    ||    |
  /      \\/      \\/      \\`,
                    victory: 86,
                    defeat: 100
                }
            },
            80: {
                title: "Cult Defeated",
                text: "You defeat the surprised cultists! The Amulet of Kings is yours!",
                reward: {
                    inventory: [{
                        id: "amulet_of_kings",
                        name: "Amulet of Kings",
                        type: "special",
                        description: "The legendary Amulet of Kings, said to grant its wielder great power."
                    }]
                },
                choices: [
                    { text: "Take the Amulet and escape", next: 81 }
                ]
            },
            81: {
                title: "VICTORY!",
                text: "You escape the catacombs with the Amulet of Kings! Your quest is complete. The Port of Peril is safe from the cult's evil plans. You return to the city as a hero, the legendary Amulet in your possession.",
                victory: true
            },
            82: {
                title: "Alert Cult Defeated",
                text: "You defeat the alert cultists and claim the Amulet of Kings!",
                reward: {
                    inventory: [{
                        id: "amulet_of_kings",
                        name: "Amulet of Kings",
                        type: "special",
                        description: "The legendary Amulet of Kings, said to grant its wielder great power."
                    }]
                },
                choices: [
                    { text: "Escape with the Amulet", next: 81 }
                ]
            },
            83: {
                title: "Weapons Market",
                text: "You look at the weapons available for purchase.",
                choices: [
                    { text: "Visit the market to buy weapons", next: 87 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            84: {
                title: "Armor Market",
                text: "You examine the armor pieces for sale.",
                choices: [
                    { text: "Visit the market to buy armor", next: 88 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            85: {
                title: "Setting a Trap",
                text: "You set up a clever trap using rubble and loose stones. When the cultists investigate the noise, you ambush them!",
                combat: {
                    enemy: "trapped_cult",
                    skill: 5,
                    stamina: 12,
                    ascii: `     /\\    /\\    /\\
    /  \\  /  \\  /  \\
   | () || () || () |
   |    ||    ||    |
  /      \\/      \\/      \\`,
                    victory: 89,
                    defeat: 100
                }
            },
            86: {
                title: "Distracted Cult Defeated",
                text: "You defeat the distracted cultists and take the Amulet of Kings!",
                reward: {
                    inventory: [{
                        id: "amulet_of_kings",
                        name: "Amulet of Kings",
                        type: "special",
                        description: "The legendary Amulet of Kings, said to grant its wielder great power."
                    }]
                },
                choices: [
                    { text: "Escape with the Amulet", next: 81 }
                ]
            },
            87: {
                title: "Weapons Market",
                text: "You browse the weapons available for purchase.",
                choices: [
                    { text: "Visit the market to buy weapons", next: 90 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            88: {
                title: "Armor Market",
                text: "You examine the armor pieces for sale.",
                choices: [
                    { text: "Visit the market to buy armor", next: 91 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            89: {
                title: "Trapped Cult Defeated",
                text: "Your trap works perfectly! You defeat the cultists and claim the Amulet of Kings!",
                reward: {
                    inventory: [{
                        id: "amulet_of_kings",
                        name: "Amulet of Kings",
                        type: "special",
                        description: "The legendary Amulet of Kings, said to grant its wielder great power."
                    }]
                },
                choices: [
                    { text: "Take the Amulet and escape", next: 81 }
                ]
            },
            90: {
                title: "Weapons Market",
                text: "You look at the weapons available for purchase.",
                choices: [
                    { text: "Visit the market to buy weapons", next: 92 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            91: {
                title: "Armor Market",
                text: "You examine the armor pieces for sale.",
                choices: [
                    { text: "Visit the market to buy armor", next: 93 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            92: {
                title: "Weapons Market",
                text: "You browse the weapons available for purchase.",
                choices: [
                    { text: "Visit the market to buy weapons", next: 94 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            93: {
                title: "Armor Market",
                text: "You examine the armor pieces for sale.",
                choices: [
                    { text: "Visit the market to buy armor", next: 95 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            94: {
                title: "Weapons Market",
                text: "You look at the weapons available for purchase.",
                choices: [
                    { text: "Visit the market to buy weapons", next: 96 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            95: {
                title: "Armor Market",
                text: "You examine the armor pieces for sale.",
                choices: [
                    { text: "Visit the market to buy armor", next: 97 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            96: {
                title: "Weapons Market",
                text: "You browse the weapons available for purchase.",
                choices: [
                    { text: "Visit the market to buy weapons", next: 98 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            97: {
                title: "Armor Market",
                text: "You examine the armor pieces for sale.",
                choices: [
                    { text: "Visit the market to buy armor", next: 99 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            98: {
                title: "Weapons Market",
                text: "You look at the weapons available for purchase.",
                choices: [
                    { text: "Visit the market to buy weapons", next: 100 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            99: {
                title: "Armor Market",
                text: "You examine the armor pieces for sale.",
                choices: [
                    { text: "Visit the market to buy armor", next: 101 },
                    { text: "Return to the market district", next: 3 }
                ]
            },
            100: {
                title: "Game Over",
                text: "Your adventure has come to a premature end. The dangers of the Port of Peril have proven too great for you.",
                gameOver: true
            },
            101: {
                title: "Market Access",
                text: "You decide to visit the market to purchase equipment.",
                choices: [
                    { text: "Go to the market", next: 102 },
                    { text: "Return to the city gates", next: 1 }
                ]
            },
            102: {
                title: "Marketplace",
                text: "You enter the bustling marketplace. Merchants call out their wares from various stalls.",
                choices: [
                    { text: "Browse weapons", next: 103 },
                    { text: "Browse armor", next: 104 },
                    { text: "Browse other items", next: 105 },
                    { text: "Leave the market", next: 1 }
                ]
            },
            103: {
                title: "Weapons Stall",
                text: "The weapons merchant shows you his selection of swords, daggers, and other arms.",
                choices: [
                    { text: "Visit the market to browse weapons", next: 106 },
                    { text: "Return to the marketplace", next: 102 }
                ]
            },
            104: {
                title: "Armor Stall",
                text: "The armor smith displays various pieces of protective gear, from leather to plate armor.",
                choices: [
                    { text: "Visit the market to browse armor", next: 107 },
                    { text: "Return to the marketplace", next: 102 }
                ]
            },
            105: {
                title: "General Goods",
                text: "A general merchant sells various useful items, from potions to provisions.",
                choices: [
                    { text: "Visit the market to browse items", next: 108 },
                    { text: "Return to the marketplace", next: 102 }
                ]
            },
            106: {
                title: "Weapons Selection",
                text: "You examine the weapons available for purchase.",
                choices: [
                    { text: "Visit the market to buy weapons", next: 109 },
                    { text: "Return to the weapons stall", next: 103 }
                ]
            },
            107: {
                title: "Armor Selection",
                text: "You look at the armor pieces available for purchase.",
                choices: [
                    { text: "Visit the market to buy armor", next: 110 },
                    { text: "Return to the armor stall", next: 104 }
                ]
            },
            108: {
                title: "Item Selection",
                text: "You browse the various items available for purchase.",
                choices: [
                    { text: "Visit the market to buy items", next: 111 },
                    { text: "Return to the general goods stall", next: 105 }
                ]
            },
            109: {
                title: "Weapons Purchase",
                text: "You consider which weapon to purchase.",
                choices: [
                    { text: "Visit the market to buy weapons", next: 112 },
                    { text: "Return to the weapons selection", next: 106 }
                ]
            },
            110: {
                title: "Armor Purchase",
                text: "You consider which armor to purchase.",
                choices: [
                    { text: "Visit the market to buy armor", next: 113 },
                    { text: "Return to the armor selection", next: 107 }
                ]
            },
            111: {
                title: "Item Purchase",
                text: "You consider which items to purchase.",
                choices: [
                    { text: "Visit the market to buy items", next: 114 },
                    { text: "Return to the item selection", next: 108 }
                ]
            },
            112: {
                title: "Weapons Final",
                text: "You make your final decision about weapon purchases.",
                choices: [
                    { text: "Visit the market to buy weapons", next: 115 },
                    { text: "Return to the weapons purchase", next: 109 }
                ]
            },
            113: {
                title: "Armor Final",
                text: "You make your final decision about armor purchases.",
                choices: [
                    { text: "Visit the market to buy armor", next: 116 },
                    { text: "Return to the armor purchase", next: 110 }
                ]
            },
            114: {
                title: "Items Final",
                text: "You make your final decision about item purchases.",
                choices: [
                    { text: "Visit the market to buy items", next: 117 },
                    { text: "Return to the item purchase", next: 111 }
                ]
            },
            115: {
                title: "Weapons Complete",
                text: "You finish browsing weapons.",
                choices: [
                    { text: "Return to the marketplace", next: 102 }
                ]
            },
            116: {
                title: "Armor Complete",
                text: "You finish browsing armor.",
                choices: [
                    { text: "Return to the marketplace", next: 102 }
                ]
            },
            117: {
                title: "Items Complete",
                text: "You finish browsing items.",
                choices: [
                    { text: "Return to the marketplace", next: 102 }
                ]
            }
        },
        enemies: {
            thugs: {
                name: "Street Thugs",
                skill: 7,
                stamina: 8,
                ascii: `     /\\    /\\    /\\
    /  \\  /  \\  /  \\
   | () || () || () |
   |    ||    ||    |
  /      \\/      \\/      \\`
            },
            guards: {
                name: "Ship Guards",
                skill: 9,
                stamina: 12,
                ascii: `     /\\         /\\
    /  \\       /  \\
   | [] |     | [] |
   |    |     |    |
  /      \\   /      \\`
            },
            sailors: {
                name: "Sailors",
                skill: 8,
                stamina: 10,
                ascii: `     /\\         /\\
    /  \\       /  \\
   |    |     |    |
   |    |     |    |
  /      \\   /      \\`
            },
            skeleton: {
                name: "Ancient Skeleton",
                skill: 9,
                stamina: 8,
                ascii: `     ___
    /   \\
   | () |
    \\___/
     /|
    / |
   /  |`
            },
            guardian: {
                name: "Spectral Guardian",
                skill: 10,
                stamina: 14,
                ascii: `    .-.
   (   )
    | |
    | |
   _| |_
  |_____|
    | |
    | |
   /   \\
  /     \\`
            },
            hemlock: {
                name: "Old Man Hemlock",
                skill: 12,
                stamina: 18,
                ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\
    |  |
    |  |
   /    \\`
            },
            cult_leader: {
                name: "Cult Leader",
                skill: 11,
                stamina: 16,
                ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\
    |  |
    |  |
   /    \\`
            },
            cultists: {
                name: "Cultists",
                skill: 8,
                stamina: 20,
                ascii: `     /\\    /\\    /\\
    /  \\  /  \\  /  \\
   | () || () || () |
   |    ||    ||    |
  /      \\/      \\/      \\`
            },
            surprised_cult: {
                name: "Surprised Cultists",
                skill: 7,
                stamina: 18,
                ascii: `     /\\    /\\    /\\
    /  \\  /  \\  /  \\
   | () || () || () |
   |    ||    ||    |
  /      \\/      \\/      \\`
            },
            alert_cult: {
                name: "Alert Cultists",
                skill: 10,
                stamina: 16,
                ascii: `     /\\    /\\    /\\
    /  \\  /  \\  /  \\
   | () || () || () |
   |    ||    ||    |
  /      \\/      \\/      \\`
            },
            distracted_cult: {
                name: "Distracted Cultists",
                skill: 6,
                stamina: 15,
                ascii: `     /\\    /\\    /\\
    /  \\  /  \\  /  \\
   | () || () || () |
   |    ||    ||    |
  /      \\/      \\/      \\`
            },
            trapped_cult: {
                name: "Trapped Cultists",
                skill: 5,
                stamina: 12,
                ascii: `     /\\    /\\    /\\
    /  \\  /  \\  /  \\
   | () || () || () |
   |    ||    ||    |
  /      \\/      \\/      \\`
            }
        }
    };

    // ============== DICE FUNCTIONS ==============
    function rollDice(numDice = 2) {
        let total = 0;
        for (let i = 0; i < numDice; i++) {
            total += Math.floor(Math.random() * 6) + 1;
        }
        return total;
    }

    function rollSkillDice(skill) {
        const diceRoll = rollDice(2);
        return diceRoll + skill;
    }

    function testLuck() {
        const luckRoll = rollDice(2);
        const isLucky = luckRoll <= gameState.player.luck;
        
        // Decrease luck after test
        gameState.player.luck = Math.max(0, gameState.player.luck - 1);
        
        return {
            roll: luckRoll,
            lucky: isLucky
        };
    }

    // ============== EQUIPMENT SYSTEM ==============
    function equipItem(item) {
        // Unequip any item of the same type first
        if (item.type === "weapon") {
            if (gameState.player.equipped.weapon) {
                unequipItem(gameState.player.equipped.weapon);
            }
            gameState.player.equipped.weapon = item;
            gameState.player.skill = gameState.player.baseSkill + (item.skillBonus || 0);
        } else if (item.type === "armor") {
            if (gameState.player.equipped.armor) {
                unequipItem(gameState.player.equipped.armor);
            }
            gameState.player.equipped.armor = item;
            const oldMaxStamina = gameState.player.maxStamina;
            gameState.player.maxStamina = gameState.player.baseStamina + (item.staminaBonus || 0);
            // Adjust current stamina if it exceeds the new max
            if (gameState.player.stamina > gameState.player.maxStamina) {
                gameState.player.stamina = gameState.player.maxStamina;
            }
        } else if (item.type === "accessory") {
            if (gameState.player.equipped.accessory) {
                unequipItem(gameState.player.equipped.accessory);
            }
            gameState.player.equipped.accessory = item;
            gameState.player.luck = gameState.player.baseLuck + (item.luckBonus || 0);
        }
        
        updateHeaderStats();
        updateInventoryScreen();
    }

    function unequipItem(item) {
        if (item.type === "weapon") {
            gameState.player.skill = gameState.player.baseSkill;
            gameState.player.equipped.weapon = null;
        } else if (item.type === "armor") {
            const oldMaxStamina = gameState.player.maxStamina;
            gameState.player.maxStamina = gameState.player.baseStamina;
            // Adjust current stamina if it exceeds the new max
            if (gameState.player.stamina > gameState.player.maxStamina) {
                gameState.player.stamina = gameState.player.maxStamina;
            }
            gameState.player.equipped.armor = null;
        } else if (item.type === "accessory") {
            gameState.player.luck = gameState.player.baseLuck;
            gameState.player.equipped.accessory = null;
        }
        
        updateHeaderStats();
        updateInventoryScreen();
    }

    function useConsumable(item) {
        if (item.effect === "heal") {
            const healAmount = Math.min(item.value, gameState.player.maxStamina - gameState.player.stamina);
            gameState.player.stamina += healAmount;
            addToLog(`You used ${item.name} and restored ${healAmount} Stamina!`);
        } else if (item.effect === "provision") {
            gameState.player.provisions += item.value;
            addToLog(`You bought ${item.value} provision(s)!`);
        }
        
        // Remove the item from inventory if it's a single-use consumable
        if (item.effect !== "provision") {
            const itemIndex = gameState.player.inventory.findIndex(i => i.id === item.id);
            if (itemIndex !== -1) {
                gameState.player.inventory.splice(itemIndex, 1);
            }
        }
        
        updateHeaderStats();
        updateInventoryScreen();
    }

    // ============== COMBAT SYSTEM ==============
    function startCombat(enemyKey, victoryParagraph) {
        gameState.currentEnemy = {
            ...gameState.enemies[enemyKey],
            currentStamina: gameState.enemies[enemyKey].stamina
        };
        
        gameState.combatRound = 0;
        gameState.currentCombatVictoryParagraph = victoryParagraph;
        
        document.getElementById('enemy-name').textContent = gameState.currentEnemy.name;
        document.getElementById('enemy-ascii').textContent = gameState.currentEnemy.ascii;
        document.getElementById('enemy-skill').textContent = gameState.currentEnemy.skill;
        document.getElementById('enemy-stamina').textContent = gameState.currentEnemy.currentStamina;
        document.getElementById('player-combat-skill').textContent = gameState.player.skill;
        document.getElementById('player-combat-stamina').textContent = gameState.player.stamina;
        
        document.getElementById('player-health-fill').style.width = '100%';
        document.getElementById('enemy-health-fill').style.width = '100%';
        
        document.getElementById('combat-log').innerHTML = `<div>Combat begins! You face a ${gameState.currentEnemy.name}.</div>`;
        
        // Show/hide appropriate buttons
        document.getElementById('attack-btn').style.display = 'block';
        document.getElementById('flee-combat').style.display = 'block';
        document.getElementById('victory-continue').style.display = 'none';
        
        showScreen('combat-screen');
    }

    function combatRound() {
        gameState.combatRound++;
        
        const playerAttack = rollSkillDice(gameState.player.skill);
        const enemyAttack = rollSkillDice(gameState.currentEnemy.skill);
        
        document.getElementById('combat-dice-roll').style.display = 'block';
        document.getElementById('player-attack').textContent = playerAttack;
        document.getElementById('enemy-attack').textContent = enemyAttack;
        
        let logMessage = '';
        
        if (playerAttack > enemyAttack) {
            // Player hits enemy
            gameState.currentEnemy.currentStamina -= 2;
            logMessage = `You hit the ${gameState.currentEnemy.name} for 2 damage!`;
            
            if (gameState.currentEnemy.currentStamina <= 0) {
                logMessage += ` The ${gameState.currentEnemy.name} is defeated!`;
                document.getElementById('attack-btn').style.display = 'none';
                document.getElementById('flee-combat').style.display = 'none';
                document.getElementById('victory-continue').style.display = 'block';
            }
        } else if (enemyAttack > playerAttack) {
            // Enemy hits player
            gameState.player.stamina -= 2;
            logMessage = `The ${gameState.currentEnemy.name} hits you for 2 damage!`;
            
            if (gameState.player.stamina <= 0) {
                logMessage += ` You have been defeated!`;
                document.getElementById('attack-btn').style.display = 'none';
                setTimeout(() => endCombat(false), 1500);
            }
        } else {
            // Tie
            logMessage = `You both miss each other!`;
        }
        
        // Update displays
        document.getElementById('player-combat-stamina').textContent = gameState.player.stamina;
        document.getElementById('enemy-stamina').textContent = gameState.currentEnemy.currentStamina;
        
        const playerHealthPercent = (gameState.player.stamina / gameState.player.maxStamina) * 100;
        const enemyHealthPercent = (gameState.currentEnemy.currentStamina / gameState.currentEnemy.stamina) * 100;
        
        document.getElementById('player-health-fill').style.width = `${playerHealthPercent}%`;
        document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
        
        document.getElementById('combat-result').textContent = logMessage;
        
        // Add to combat log
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `<strong>Round ${gameState.combatRound}:</strong> ${logMessage}`;
        document.getElementById('combat-log').appendChild(logEntry);
        document.getElementById('combat-log').scrollTop = document.getElementById('combat-log').scrollHeight;
        
        updateHeaderStats();
    }

    function endCombat(victory) {
        if (victory) {
            // Find the victory paragraph from the current story paragraph
            if (gameState.currentCombatVictoryParagraph) {
                showParagraph(gameState.currentCombatVictoryParagraph);
            } else {
                showParagraph(1); // Default to beginning if no victory paragraph specified
            }
        } else {
            showGameOver(`You were defeated by the ${gameState.currentEnemy.name}.`);
        }
    }

    // ============== STORY SYSTEM ==============
    function showParagraph(paragraphId) {
        gameState.currentParagraph = paragraphId;
        const paragraph = gameState.story[paragraphId];
        
        if (!paragraph) {
            showGameOver("Your adventure has reached an unknown path.");
            return;
        }
        
        if (paragraph.gameOver) {
            showGameOver(paragraph.text);
            return;
        }
        
        if (paragraph.victory) {
            showVictory();
            return;
        }
        
        document.getElementById('story-title').textContent = paragraph.title;
        
        // Handle dynamic text
        if (paragraph.dynamicText) {
            document.getElementById('story-text').textContent = paragraph.text + " " + paragraph.dynamicText();
        } else {
            document.getElementById('story-text').textContent = paragraph.text;
        }
        
        // Clear previous choices
        const choiceList = document.getElementById('choice-list');
        choiceList.innerHTML = '';
        
        // Hide dice and luck sections
        document.getElementById('dice-roll-section').style.display = 'none';
        document.getElementById('luck-test-section').style.display = 'none';
        
        // Make sure choice list is visible
        choiceList.style.display = 'block';
        
        // Add new choices
        if (paragraph.choices && paragraph.choices.length > 0) {
            paragraph.choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = choice.text;
                
                if (choice.cost && choice.cost > gameState.player.gold) {
                    button.disabled = true;
                    button.textContent += ` (Need ${choice.cost} Gold)`;
                }
                
                button.addEventListener('click', () => {
                    handleChoice(choice);
                });
                
                choiceList.appendChild(button);
            });
        } else if (paragraph.combat) {
            // If paragraph leads directly to combat
            const button = document.createElement('button');
            button.className = 'choice-btn';
            button.textContent = `Fight the ${paragraph.combat.enemy}`;
            button.addEventListener('click', () => {
                startCombat(paragraph.combat.enemy, paragraph.combat.victory);
            });
            choiceList.appendChild(button);
        }
        
        // Apply rewards if any
        if (paragraph.reward) {
            if (typeof paragraph.reward === 'function') {
                const reward = paragraph.reward();
                applyReward(reward);
            } else {
                applyReward(paragraph.reward);
            }
        }
        
        updateHeaderStats();
        showScreen('story-screen');
    }

    function applyReward(reward) {
        if (reward.gold) {
            gameState.player.gold += reward.gold;
            if (reward.gold > 0) {
                addToLog(`You gained ${reward.gold} gold!`);
            } else if (reward.gold < 0) {
                addToLog(`You lost ${Math.abs(reward.gold)} gold!`);
            }
        }
        if (reward.inventory) {
            gameState.player.inventory.push(...reward.inventory);
            reward.inventory.forEach(item => {
                addToLog(`You gained ${item.name}!`);
            });
        }
        if (reward.skill) {
            gameState.player.skill += reward.skill;
            gameState.player.baseSkill += reward.skill;
            addToLog(`Your Skill increased by ${reward.skill}!`);
        }
        if (reward.maxStamina) {
            gameState.player.maxStamina += reward.maxStamina;
            gameState.player.baseStamina += reward.maxStamina;
            addToLog(`Your maximum Stamina increased by ${reward.maxStamina}!`);
        }
        if (reward.stamina) {
            gameState.player.stamina += reward.stamina;
            addToLog(`Your Stamina increased by ${reward.stamina}!`);
        }
        
        updateHeaderStats();
    }

    function handleChoice(choice) {
        if (choice.cost && choice.cost > 0) {
            if (gameState.player.gold < choice.cost) {
                alert(`You need ${choice.cost} Gold for this choice!`);
                return;
            }
            gameState.player.gold -= choice.cost;
        }
        
        if (choice.test === "luck") {
            // Show luck test interface
            document.getElementById('luck-test-section').style.display = 'block';
            document.getElementById('choice-list').style.display = 'none';
            
            const luckResult = testLuck();
            document.getElementById('luck-dice-result').textContent = luckResult.roll;
            
            if (luckResult.lucky) {
                document.getElementById('luck-result').textContent = "You are Lucky!";
                document.getElementById('luck-result').className = "luck-result success";
            } else {
                document.getElementById('luck-result').textContent = "You are Unlucky!";
                document.getElementById('luck-result').className = "luck-result failure";
            }
            
            // Store the luck test result
            gameState.lastLuckTest = luckResult;
            
            updateHeaderStats();
        } else if (choice.combat) {
            startCombat(choice.combat, choice.next);
        } else {
            showParagraph(choice.next);
        }
    }

    // ============== MARKET SYSTEM ==============
    function updateMarketScreen() {
        const marketItems = document.getElementById('market-items');
        marketItems.innerHTML = '';
        
        gameState.marketItems.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'market-item';
            
            const itemInfo = document.createElement('div');
            itemInfo.innerHTML = `
                <h3>${item.name}</h3>
                <p>${item.description}</p>
                <p><strong>Cost: ${item.cost} Gold</strong></p>
            `;
            
            const buyButton = document.createElement('button');
            buyButton.className = 'item-action-btn';
            buyButton.textContent = 'Buy';
            buyButton.onclick = () => buyItem(item);
            buyButton.disabled = gameState.player.gold < item.cost;
            
            itemElement.appendChild(itemInfo);
            itemElement.appendChild(buyButton);
            marketItems.appendChild(itemElement);
        });
        
        document.getElementById('market-gold').textContent = gameState.player.gold;
    }

    function buyItem(item) {
        if (gameState.player.gold < item.cost) {
            alert("You don't have enough gold!");
            return;
        }
        
        gameState.player.gold -= item.cost;
        
        if (item.type === "consumable" && item.effect === "provision") {
            gameState.player.provisions += item.value;
            addToLog(`You bought ${item.value} provision(s) for ${item.cost} gold.`);
        } else {
            // Create a copy of the item to add to inventory
            const itemCopy = {...item};
            gameState.player.inventory.push(itemCopy);
            addToLog(`You bought ${item.name} for ${item.cost} gold.`);
        }
        
        updateMarketScreen();
        updateHeaderStats();
        updateInventoryScreen();
    }

    // ============== UI MANAGEMENT ==============
    function showScreen(screenName) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenName).classList.add('active');
    }

    function updateHeaderStats() {
        document.getElementById('header-skill').textContent = gameState.player.skill;
        document.getElementById('header-stamina').textContent = gameState.player.stamina;
        document.getElementById('header-max-stamina').textContent = gameState.player.maxStamina;
        document.getElementById('header-luck').textContent = gameState.player.luck;
        document.getElementById('header-gold').textContent = gameState.player.gold;
        
        document.getElementById('combat-skill').textContent = gameState.player.skill;
        document.getElementById('combat-stamina').textContent = gameState.player.stamina;
        document.getElementById('combat-max-stamina').textContent = gameState.player.maxStamina;
        document.getElementById('combat-luck').textContent = gameState.player.luck;
        
        document.getElementById('inv-skill').textContent = gameState.player.skill;
        document.getElementById('inv-stamina').textContent = gameState.player.stamina;
        document.getElementById('inv-luck').textContent = gameState.player.luck;
        document.getElementById('inv-gold').textContent = gameState.player.gold;
        document.getElementById('provisions-count').textContent = gameState.player.provisions;
    }

    function updateInventoryScreen() {
        const equippedItems = document.getElementById('equipped-items');
        equippedItems.innerHTML = '';
        
        // Show equipped items
        Object.keys(gameState.player.equipped).forEach(slot => {
            const item = gameState.player.equipped[slot];
            if (item) {
                const itemElement = document.createElement('div');
                itemElement.className = 'item item-equipped';
                
                let itemText = `${slot.charAt(0).toUpperCase() + slot.slice(1)}: ${item.name}`;
                if (item.skillBonus) itemText += ` (+${item.skillBonus} Skill)`;
                if (item.staminaBonus) itemText += ` (+${item.staminaBonus} Stamina)`;
                if (item.luckBonus) itemText += ` (+${item.luckBonus} Luck)`;
                
                const textElement = document.createElement('div');
                textElement.textContent = itemText;
                itemElement.appendChild(textElement);
                
                const actionsElement = document.createElement('div');
                actionsElement.className = 'item-actions';
                
                const unequipButton = document.createElement('button');
                unequipButton.className = 'item-action-btn';
                unequipButton.textContent = 'Unequip';
                unequipButton.onclick = () => unequipItem(item);
                actionsElement.appendChild(unequipButton);
                
                itemElement.appendChild(actionsElement);
                equippedItems.appendChild(itemElement);
            }
        });
        
        const inventoryList = document.getElementById('inventory-list');
        inventoryList.innerHTML = '';
        
        if (gameState.player.inventory.length === 0) {
            inventoryList.innerHTML = '<div style="text-align: center; padding: 10px; color: #a0a0a0;">Your backpack is empty</div>';
        } else {
            gameState.player.inventory.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'item item-special';
                
                let itemText = `${item.name}`;
                if (item.skillBonus) itemText += ` (+${item.skillBonus} Skill)`;
                if (item.staminaBonus) itemText += ` (+${item.staminaBonus} Stamina)`;
                if (item.luckBonus) itemText += ` (+${item.luckBonus} Luck)`;
                if (item.effect === "heal") itemText += ` (Heals ${item.value} Stamina)`;
                
                const textElement = document.createElement('div');
                textElement.textContent = itemText;
                itemElement.appendChild(textElement);
                
                const actionsElement = document.createElement('div');
                actionsElement.className = 'item-actions';
                
                if (item.type === "weapon" || item.type === "armor" || item.type === "accessory") {
                    const equipButton = document.createElement('button');
                    equipButton.className = 'item-action-btn';
                    equipButton.textContent = 'Equip';
                    equipButton.onclick = () => equipItem(item);
                    actionsElement.appendChild(equipButton);
                }
                
                if (item.type === "consumable") {
                    const useButton = document.createElement('button');
                    useButton.className = 'item-action-btn';
                    useButton.textContent = 'Use';
                    useButton.onclick = () => useConsumable(item);
                    actionsElement.appendChild(useButton);
                }
                
                itemElement.appendChild(actionsElement);
                inventoryList.appendChild(itemElement);
            });
        }
    }

    function showGameOver(message) {
        document.getElementById('game-over-message').textContent = message;
        document.getElementById('game-over-location').textContent = gameState.story[gameState.currentParagraph].title;
        document.getElementById('game-over-paragraph').textContent = gameState.currentParagraph;
        showScreen('game-over-screen');
    }

    function showVictory() {
        document.getElementById('game-over-message').textContent = "You have successfully retrieved the Amulet of Kings and saved the Port of Peril!";
        document.getElementById('game-over-message').className = "game-over-message victory-message";
        document.getElementById('game-over-location').textContent = "VICTORY!";
        document.getElementById('game-over-paragraph').textContent = gameState.currentParagraph;
        showScreen('game-over-screen');
    }

    function initializePlayer() {
        // Roll initial stats (as in Fighting Fantasy books)
        gameState.player.baseSkill = rollDice(1) + 6; // 7-12
        gameState.player.baseStamina = rollDice(2) + 12; // 14-24
        gameState.player.baseLuck = rollDice(1) + 6; // 7-12
        
        gameState.player.skill = gameState.player.baseSkill;
        gameState.player.stamina = gameState.player.baseStamina;
        gameState.player.maxStamina = gameState.player.baseStamina;
        gameState.player.luck = gameState.player.baseLuck;
        gameState.player.gold = 20; // Starting gold
        gameState.player.provisions = 10;
        gameState.player.inventory = [];
        gameState.player.equipped = {
            weapon: null,
            armor: null,
            accessory: null
        };
        
        gameState.currentParagraph = 1;
        
        updateHeaderStats();
        showParagraph(1);
    }

    function eatProvision() {
        if (gameState.player.provisions > 0) {
            gameState.player.stamina = Math.min(gameState.player.maxStamina, gameState.player.stamina + 4);
            gameState.player.provisions--;
            updateHeaderStats();
            updateInventoryScreen();
            alert("You eat a provision and restore 4 Stamina.");
        } else {
            alert("You have no provisions left!");
        }
    }

    function addToLog(message) {
        // This function would add messages to a game log if we had one
        console.log(message);
    }

    // ============== SAVE/LOAD SYSTEM ==============
    function saveGame() {
        const saveData = {
            player: gameState.player,
            currentParagraph: gameState.currentParagraph
        };
        localStorage.setItem('ffSave', JSON.stringify(saveData));
        alert("Game saved successfully!");
    }

    function loadGame() {
        const saveData = localStorage.getItem('ffSave');
        if (saveData) {
            try {
                const saved = JSON.parse(saveData);
                gameState.player = saved.player;
                gameState.currentParagraph = saved.currentParagraph;
                updateHeaderStats();
                showParagraph(gameState.currentParagraph);
            } catch (e) {
                alert("Failed to load saved game.");
            }
        } else {
            alert("No saved game found.");
        }
    }

    // ============== INITIALIZATION ==============
    document.addEventListener('DOMContentLoaded', function() {
        // Main menu buttons
        document.getElementById('new-game').addEventListener('click', initializePlayer);
        document.getElementById('continue-game').addEventListener('click', loadGame);
        document.getElementById('rules-btn').addEventListener('click', () => showScreen('rules-screen'));
        
        // Story screen buttons
        document.getElementById('inventory-btn').addEventListener('click', () => {
            updateInventoryScreen();
            showScreen('inventory-screen');
        });
        document.getElementById('market-btn').addEventListener('click', () => {
            updateMarketScreen();
            showScreen('market-screen');
        });
        document.getElementById('save-game').addEventListener('click', saveGame);
        
        // Inventory screen buttons
        document.getElementById('back-from-inventory').addEventListener('click', () => showScreen('story-screen'));
        document.getElementById('eat-provision').addEventListener('click', eatProvision);
        
        // Market screen buttons
        document.getElementById('back-from-market').addEventListener('click', () => showScreen('story-screen'));
        
        // Rules screen buttons
        document.getElementById('back-from-rules').addEventListener('click', () => showScreen('main-menu'));
        
        // Combat screen buttons
        document.getElementById('attack-btn').addEventListener('click', combatRound);
        document.getElementById('flee-combat').addEventListener('click', () => {
            if (Math.random() < 0.5) {
                // Successful flee
                document.getElementById('combat-log').innerHTML += '<div>You successfully flee from combat!</div>';
                setTimeout(() => showParagraph(1), 1500);
            } else {
                // Failed flee - enemy gets a free attack
                document.getElementById('combat-log').innerHTML += '<div>You fail to flee! The enemy attacks!</div>';
                gameState.player.stamina -= 2;
                updateHeaderStats();
                
                if (gameState.player.stamina <= 0) {
                    document.getElementById('combat-log').innerHTML += '<div>You have been defeated!</div>';
                    setTimeout(() => endCombat(false), 1500);
                }
            }
        });
        
        // Victory continue button
        document.getElementById('victory-continue').addEventListener('click', () => {
            if (gameState.currentCombatVictoryParagraph) {
                showParagraph(gameState.currentCombatVictoryParagraph);
            } else {
                showParagraph(1);
            }
        });
        
        // Luck test buttons
        document.getElementById('continue-after-luck').addEventListener('click', () => {
            // For now, just continue to the next paragraph
            // In a more complex system, we would handle different outcomes based on luck
            document.getElementById('luck-test-section').style.display = 'none';
            document.getElementById('choice-list').style.display = 'block';
        });
        
        // Game over buttons
        document.getElementById('restart-after-game-over').addEventListener('click', initializePlayer);
        document.getElementById('main-menu-after-game-over').addEventListener('click', () => showScreen('main-menu'));
    });
    </script>
</body>
</html>
