<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ASCII Space Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #000;
            color: #0af;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 18px;
        }

        #header {
            background-color: #111;
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        #stats {
            font-size: 18px;
        }

        .stat-bar {
            width: 100px;
            height: 18px;
            background-color: #333;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 4px;
        }

        .stat-fill {
            height: 100%;
            transition: width 0.3s;
        }

        #fuel-fill {
            background-color: #fa0;
        }

        #hull-fill {
            background-color: #0f0;
        }

        #game-container {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        #message-log {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px;
            height: 100px;
            overflow-y: auto;
            font-size: 18px;
            border-top: 1px solid #333;
            flex-shrink: 0;
            color: #0af;
            font-family: 'Courier New', Courier, monospace;
        }

        #controls {
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 8px;
            background-color: #111;
            border-top: 1px solid #333;
            flex-shrink: 0;
        }

        .control-btn {
            background-color: #222;
            border: 1px solid #333;
            border-radius: 4px;
            color: #0af;
            padding: 14px 5px;
            font-size: 18px;
            touch-action: manipulation;
            min-height: 50px;
            font-family: 'Courier New', Courier, monospace;
        }

        .control-btn:active {
            background-color: #333;
        }

        #btn-up {
            grid-column: 2;
            grid-row: 1;
        }

        #btn-left {
            grid-column: 1;
            grid-row: 2;
        }

        #btn-right {
            grid-column: 3;
            grid-row: 2;
        }

        #btn-down {
            grid-column: 2;
            grid-row: 3;
        }

        #btn-scan {
            grid-column: 1;
            grid-row: 1;
            font-size: 14px;
        }

        #btn-inventory {
            grid-column: 3;
            grid-row: 1;
            font-size: 14px;
        }

        #btn-wait {
            grid-column: 2;
            grid-row: 2;
            font-size: 14px;
        }

        #btn-interact {
            grid-column: 1;
            grid-row: 3;
            font-size: 14px;
        }

        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #111;
            border: 2px solid #333;
            border-radius: 4px;
            padding: 15px;
            z-index: 10;
            width: 80%;
            max-width: 300px;
            display: none;
            color: #0af;
            font-family: 'Courier New', Courier, monospace;
        }

        .modal-title {
            text-align: center;
            margin-bottom: 10px;
            color: #0af;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .modal-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .modal-item {
            padding: 8px;
            border-bottom: 1px solid #333;
            cursor: pointer;
        }

        .modal-item:hover {
            background-color: #222;
        }

        .modal-btn {
            width: 100%;
            padding: 8px;
            background-color: #222;
            border: 1px solid #333;
            border-radius: 4px;
            color: #0af;
            margin-top: 5px;
            font-family: 'Courier New', Courier, monospace;
        }

        .equipped {
            color: #0af;
            font-weight: bold;
        }

        #game-over {
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 20;
            text-align: center;
        }

        #game-over h2 {
            color: #f00;
            margin-bottom: 15px;
        }

        .hidden {
            display: none !important;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 8px;
            z-index: 30;
            text-align: center;
            color: #0af;
            font-family: 'Courier New', Courier, monospace;
        }

        #player-combat-stats {
            margin-top: 5px;
            font-size: 18px;
        }

        #system-indicator {
            font-size: 18px;
            background-color: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 10px;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 5;
            color: #0af;
            font-family: 'Courier New', Courier, monospace;
        }

        .item-details {
            font-size: 11px;
            color: #0aa;
            margin-top: 3px;
        }

        .damage-stat {
            color: #f00;
        }

        .defense-stat {
            color: #00f;
        }

        .fuel-stat {
            color: #fa0;
        }

        .special-stat {
            color: #f0f;
        }

        #auto-scan-toggle {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: #0af;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            z-index: 5;
            font-family: 'Courier New', Courier, monospace;
        }

        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.85);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 8px;
            font-size: 12px;
            z-index: 100;
            max-width: 200px;
            display: none;
            color: #0af;
            font-family: 'Courier New', Courier, monospace;
        }

        .boss-health-bar {
            position: absolute;
            top: 60px;
            left: 10px;
            right: 10px;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            z-index: 5;
            display: none;
        }

        .boss-health-fill {
            height: 100%;
            background: linear-gradient(to right, #f00, #f90);
            transition: width 0.3s;
        }

        .boss-name {
            position: absolute;
            top: 40px;
            left: 0;
            right: 0;
            text-align: center;
            font-weight: bold;
            z-index: 5;
            display: none;
            color: #f00;
            font-family: 'Courier New', Courier, monospace;
        }

        /* New styles for ship selection and abilities */
        #ship-selection {
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 25;
            text-align: center;
        }

        .ship-option {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #333;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ship-option:hover {
            border-color: #0af;
            background-color: #222;
        }

        .ship-option h3 {
            color: #0af;
            margin-bottom: 8px;
        }

        .ship-stats {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .ability-btn {
            background-color: #333;
            border: 1px solid #555;
            border-radius: 4px;
            color: #0af;
            padding: 8px 12px;
            margin: 5px;
            font-size: 14px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
        }

        .ability-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ability-btn:not(:disabled):active {
            background-color: #444;
        }

        #abilities-container {
            position: absolute;
            bottom: 60px;
            left: 10px;
            z-index: 5;
            display: flex;
            flex-wrap: wrap;
            max-width: 200px;
        }

        .quest-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: #ff0;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            z-index: 5;
            font-family: 'Courier New', Courier, monospace;
        }
        
        .star-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
    </style>
</head>
<body>
    <div id="header">
        <div id="stats">
            <div>Hull: <span id="hull">100</span>/<span id="max-hull">100</span></div>
            <div class="stat-bar">
                <div id="hull-fill" class="stat-fill"></div>
            </div>
            <div>Fuel: <span id="fuel">100</span>/<span id="max-fuel">100</span></div>
            <div class="stat-bar">
                <div id="fuel-fill" class="stat-fill"></div>
            </div>
            <div id="player-combat-stats">
                <div>Credits: <span id="credits">100</span> | Cargo: <span id="cargo">0</span>/<span id="max-cargo">10</span></div>
            </div>
        </div>
        <div>System: <span id="system">Sol</span></div>
        <div>Turn: <span id="turn">0</span></div>
    </div>
    
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        <div id="system-indicator">Sol System</div>
        <div id="quest-indicator" class="quest-indicator" style="display: none;">Mission Active</div>
        <div id="boss-health-bar" class="boss-health-bar">
            <div id="boss-health-fill" class="boss-health-fill"></div>
        </div>
        <div id="boss-name" class="boss-name"></div>
        <button id="auto-scan-toggle">Auto-Scan: ON</button>
        <div id="abilities-container"></div>
        <div id="loading">Generating star system...</div>
        
        <!-- Ship Selection Modal -->
        <div id="ship-selection" class="modal">
            <h2 class="modal-title">Choose Your Ship</h2>
            <div class="ship-option" data-ship="scout">
                <h3>Scout Ship</h3>
                <div class="ship-stats">Hull: 80 | Fuel: 120 | Cargo: 8 | Speed: Fast</div>
                <div>Special: Enhanced Sensors - Reveals more of the map</div>
            </div>
            <div class="ship-option" data-ship="freighter">
                <h3>Freighter</h3>
                <div class="ship-stats">Hull: 120 | Fuel: 80 | Cargo: 20 | Speed: Slow</div>
                <div>Special: Trade Bonus - Better prices at space stations</div>
            </div>
            <div class="ship-option" data-ship="fighter">
                <h3>Fighter</h3>
                <div class="ship-stats">Hull: 100 | Fuel: 100 | Cargo: 12 | Speed: Medium</div>
                <div>Special: Combat Boost - +25% damage in combat</div>
            </div>
        </div>
        
        <div id="inventory-modal" class="modal">
            <h3 class="modal-title">Cargo Hold</h3>
            <div id="inventory-list" class="modal-list"></div>
            <div id="equipped-items">
                <div class="modal-title">Ship Systems</div>
                <div id="equipped-list" class="modal-list"></div>
            </div>
            <button id="close-inventory" class="modal-btn">Close</button>
        </div>
        
        <!-- Space Station Modal -->
        <div id="station-modal" class="modal">
            <h3 id="station-name" class="modal-title">Space Station</h3>
            <div id="station-dialogue" class="modal-list"></div>
            <div id="station-options" class="modal-list"></div>
            <button id="close-station" class="modal-btn">Depart</button>
        </div>
        
        <div id="game-over" class="modal">
            <h2>Mission Failed</h2>
            <p>You explored <span id="final-systems">1</span> systems and achieved rank <span id="final-rank">1</span>!</p>
            <p>Credits earned: <span id="credits-earned">0</span></p>
            <p>Alien encounters: <span id="aliens-encountered">0</span></p>
            <button id="restart-btn" class="modal-btn">New Mission</button>
        </div>
    </div>
    
    <div id="message-log"></div>
    
    <div id="controls">
        <button class="control-btn" id="btn-scan">Scan</button>
        <button class="control-btn" id="btn-up">↑</button>
        <button class="control-btn" id="btn-inventory">Cargo</button>
        <button class="control-btn" id="btn-left">←</button>
        <button class="control-btn" id="btn-wait">Wait</button>
        <button class="control-btn" id="btn-right">→</button>
        <button class="control-btn" id="btn-interact">Dock</button>
        <button class="control-btn" id="btn-down">↓</button>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
        // Game constants
        const TILE_SIZE = 24;
        const MAP_WIDTH = 50;
        const MAP_HEIGHT = 30;
        const FOV_RADIUS = 6;

        // ASCII Characters for different entities
        const ASCII_EMPTY = ' ';
        const ASCII_ASTEROID = '*';
        const ASCII_PLAYER = '^';
        const ASCII_WARP = 'W';
        const ASCII_STATION = '[ ]';
        const ASCII_PLANET = 'O';
        const ASCII_ALIEN = 'A';
        const ASCII_RESOURCE = '$';
        const ASCII_DEBRIS = '+';
        const ASCII_NEBULA = '~';
        
        // Colors for ASCII
        const COLOR_EMPTY = '#000';
        const COLOR_ASTEROID = '#888';
        const COLOR_PLAYER = '#0af';
        const COLOR_WARP = '#f0f';
        const COLOR_STATION = '#0f0';
        const COLOR_PLANET = '#55f';
        const COLOR_ALIEN = '#f00';
        const COLOR_RESOURCE = '#ff0';
        const COLOR_DEBRIS = '#a50';
        const COLOR_NEBULA = '#a0f';
        const COLOR_VISIBLE = '#444';
        const COLOR_EXPLORED = '#222';
        const COLOR_UNEXPLORED = '#000';

        // Ship types
        const shipTypes = {
            'scout': { 
                name: 'Scout Ship', 
                hull: 80, 
                maxHull: 80,
                fuel: 120, 
                maxFuel: 120, 
                cargo: 8,
                speed: 1,
                color: '#0af',
                abilities: ['enhanced_sensors']
            },
            'freighter': { 
                name: 'Freighter', 
                hull: 120, 
                maxHull: 120,
                fuel: 80, 
                maxFuel: 80, 
                cargo: 20,
                speed: 1,
                color: '#0f0',
                abilities: ['trade_bonus']
            },
            'fighter': { 
                name: 'Fighter', 
                hull: 100, 
                maxHull: 100,
                fuel: 100, 
                maxFuel: 100, 
                cargo: 12,
                speed: 1,
                color: '#f00',
                abilities: ['combat_boost']
            }
        };

        // Game state
        let game = {
            map: [],
            player: {
                x: 0,
                y: 0,
                hull: 100,
                maxHull: 100,
                fuel: 100,
                maxFuel: 100,
                credits: 100,
                cargo: 0,
                maxCargo: 10,
                inventory: [],
                systems: [],
                ship: null,
                abilities: [],
                abilityCooldowns: {},
                rank: 1,
                xp: 0,
                nextRankXp: 100,
                discoveredSystems: 1,
                missions: []
            },
            aliens: [],
            resources: [],
            stations: [],
            planets: [],
            warpGates: [],
            nebulas: [],
            turn: 0,
            currentSystem: 'Sol',
            messages: [],
            aliensEncountered: 0,
            gameOver: false,
            autoScan: true,
            bossActive: false
        };

        // Canvas setup
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // Initialize canvas size
        function resizeCanvas() {
            const container = document.getElementById('game-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Tile class
        class Tile {
            constructor(blocked, blockSight = null) {
                this.blocked = blocked;
                this.blockSight = blockSight !== null ? blockSight : blocked;
                this.explored = false;
                this.visible = false;
                this.specialType = null;
            }
        }

        // Space generator
        class SpaceGenerator {
            constructor() {
                this.map = [];
            }

            generate() {
                // Show loading
                document.getElementById('loading').style.display = 'block';
                
                this.initializeMap();
                this.generateAsteroidFields();
                this.generateSpecialFeatures();
                
                document.getElementById('loading').style.display = 'none';
                return this.map;
            }

            initializeMap() {
                this.map = [];
                for (let x = 0; x < MAP_WIDTH; x++) {
                    this.map[x] = [];
                    for (let y = 0; y < MAP_HEIGHT; y++) {
                        this.map[x][y] = new Tile(false);
                    }
                }
            }

            generateAsteroidFields() {
                // Create several asteroid fields
                const fieldCount = 5 + Math.floor(Math.random() * 3);
                
                for (let i = 0; i < fieldCount; i++) {
                    const centerX = Math.floor(Math.random() * MAP_WIDTH);
                    const centerY = Math.floor(Math.random() * MAP_HEIGHT);
                    const radius = 3 + Math.floor(Math.random() * 4);
                    
                    for (let x = centerX - radius; x <= centerX + radius; x++) {
                        for (let y = centerY - radius; y <= centerY + radius; y++) {
                            if (x >= 0 && x < MAP_WIDTH && y >= 0 && y < MAP_HEIGHT) {
                                const distance = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);
                                if (distance <= radius && Math.random() < 0.7) {
                                    this.map[x][y].blocked = true;
                                    this.map[x][y].blockSight = true;
                                    this.map[x][y].specialType = 'asteroid';
                                }
                            }
                        }
                    }
                }
            }

            generateSpecialFeatures() {
                // Place warp gate (always in a corner)
                const corners = [
                    {x: 2, y: 2},
                    {x: MAP_WIDTH-3, y: 2},
                    {x: 2, y: MAP_HEIGHT-3},
                    {x: MAP_WIDTH-3, y: MAP_HEIGHT-3}
                ];
                const corner = corners[Math.floor(Math.random() * corners.length)];
                game.warpGates.push({
                    x: corner.x,
                    y: corner.y
                });
                
                // Place player away from warp gate
                let playerPos;
                do {
                    playerPos = {
                        x: Math.floor(Math.random() * (MAP_WIDTH-10)) + 5,
                        y: Math.floor(Math.random() * (MAP_HEIGHT-10)) + 5
                    };
                } while (Math.abs(playerPos.x - corner.x) < 10 && Math.abs(playerPos.y - corner.y) < 10);
                
                game.player.x = playerPos.x;
                game.player.y = playerPos.y;

                // Place space station
                let stationPos;
                let attempts = 0;
                do {
                    stationPos = {
                        x: Math.floor(Math.random() * (MAP_WIDTH-6)) + 3,
                        y: Math.floor(Math.random() * (MAP_HEIGHT-6)) + 3
                    };
                    attempts++;
                } while ((this.map[stationPos.x][stationPos.y].blocked || 
                         Math.abs(stationPos.x - game.player.x) < 8 || 
                         Math.abs(stationPos.y - game.player.y) < 8) && attempts < 50);
                
                if (attempts < 50) {
                    game.stations.push({
                        x: stationPos.x,
                        y: stationPos.y,
                        name: generateStationName(),
                        type: 'trading'
                    });
                }

                // Place planets (1-3)
                const planetCount = 1 + Math.floor(Math.random() * 3);
                for (let i = 0; i < planetCount; i++) {
                    let planetPos;
                    attempts = 0;
                    do {
                        planetPos = {
                            x: Math.floor(Math.random() * (MAP_WIDTH-4)) + 2,
                            y: Math.floor(Math.random() * (MAP_HEIGHT-4)) + 2
                        };
                        attempts++;
                    } while ((this.map[planetPos.x][planetPos.y].blocked || 
                             game.planets.some(p => Math.abs(p.x - planetPos.x) < 5 && Math.abs(p.y - planetPos.y) < 5)) && attempts < 50);
                    
                    if (attempts < 50) {
                        game.planets.push({
                            x: planetPos.x,
                            y: planetPos.y,
                            name: generatePlanetName(),
                            type: ['terrestrial', 'gas_giant', 'ice_world'][Math.floor(Math.random() * 3)]
                        });
                    }
                }

                // Place resources
                const resourceCount = 10 + Math.floor(Math.random() * 10);
                for (let i = 0; i < resourceCount; i++) {
                    let resourcePos;
                    attempts = 0;
                    do {
                        resourcePos = {
                            x: Math.floor(Math.random() * MAP_WIDTH),
                            y: Math.floor(Math.random() * MAP_HEIGHT)
                        };
                        attempts++;
                    } while ((this.map[resourcePos.x][resourcePos.y].blocked || 
                             game.resources.some(r => r.x === resourcePos.x && r.y === resourcePos.y) ||
                             game.aliens.some(a => a.x === resourcePos.x && a.y === resourcePos.y)) && attempts < 50);
                    
                    if (attempts < 50) {
                        game.resources.push({
                            x: resourcePos.x,
                            y: resourcePos.y,
                            type: ['mineral', 'gas', 'artifact'][Math.floor(Math.random() * 3)],
                            amount: 5 + Math.floor(Math.random() * 10)
                        });
                    }
                }

                // Place aliens
                const alienCount = 3 + Math.floor(Math.random() * 5);
                for (let i = 0; i < alienCount; i++) {
                    let alienPos;
                    attempts = 0;
                    do {
                        alienPos = {
                            x: Math.floor(Math.random() * MAP_WIDTH),
                            y: Math.floor(Math.random() * MAP_HEIGHT)
                        };
                        attempts++;
                    } while ((this.map[alienPos.x][alienPos.y].blocked || 
                             game.aliens.some(a => a.x === alienPos.x && a.y === alienPos.y) ||
                             Math.abs(alienPos.x - game.player.x) < 5 || 
                             Math.abs(alienPos.y - game.player.y) < 5) && attempts < 50);
                    
                    if (attempts < 50) {
                        game.aliens.push({
                            x: alienPos.x,
                            y: alienPos.y,
                            type: ['scout', 'fighter', 'hunter'][Math.floor(Math.random() * 3)],
                            hull: 20 + Math.floor(Math.random() * 30),
                            attack: 5 + Math.floor(Math.random() * 10),
                            movePattern: ['patrol', 'aggressive', 'cowardly'][Math.floor(Math.random() * 3)]
                        });
                    }
                }

                // Place nebulas
                const nebulaCount = 2 + Math.floor(Math.random() * 3);
                for (let i = 0; i < nebulaCount; i++) {
                    const centerX = Math.floor(Math.random() * MAP_WIDTH);
                    const centerY = Math.floor(Math.random() * MAP_HEIGHT);
                    const radius = 2 + Math.floor(Math.random() * 3);
                    
                    for (let x = centerX - radius; x <= centerX + radius; x++) {
                        for (let y = centerY - radius; y <= centerY + radius; y++) {
                            if (x >= 0 && x < MAP_WIDTH && y >= 0 && y < MAP_HEIGHT) {
                                const distance = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);
                                if (distance <= radius && Math.random() < 0.6) {
                                    this.map[x][y].specialType = 'nebula';
                                }
                            }
                        }
                    }
                }
            }
        }

        // Name generators
        function generateStationName() {
            const prefixes = ['Alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Orbital', 'Deep Space', 'Outpost'];
            const suffixes = ['Station', 'Hub', 'Terminal', 'Base', 'Colony', 'Outpost'];
            return `${prefixes[Math.floor(Math.random() * prefixes.length)]} ${suffixes[Math.floor(Math.random() * suffixes.length)]}`;
        }

        function generatePlanetName() {
            const names = ['Aridia', 'Cryon', 'Pyros', 'Aquaria', 'Terra Nova', 'Xylos', 'Vega', 'Centauri', 'Proxima'];
            const suffixes = ['Prime', 'Secundus', 'III', 'IV', 'V', 'VI'];
            return `${names[Math.floor(Math.random() * names.length)]} ${suffixes[Math.floor(Math.random() * suffixes.length)]}`;
        }

        // Initialize the game map
        function initializeMap() {
            const generator = new SpaceGenerator();
            game.map = generator.generate();
            updateFOV();
            document.getElementById('system-indicator').textContent = `${game.currentSystem} System`;
            render();
        }

        // Simple FOV implementation
        function updateFOV() {
            // Reset visibility
            for (let x = 0; x < MAP_WIDTH; x++) {
                for (let y = 0; y < MAP_HEIGHT; y++) {
                    game.map[x][y].visible = false;
                }
            }
            
            // Enhanced sensors for scout ship
            const sensorRange = game.player.ship === 'scout' ? FOV_RADIUS + 2 : FOV_RADIUS;
            
            // Mark tiles in a circular area around player as visible
            for (let dx = -sensorRange; dx <= sensorRange; dx++) {
                for (let dy = -sensorRange; dy <= sensorRange; dy++) {
                    const x = game.player.x + dx;
                    const y = game.player.y + dy;
                    
                    if (x >= 0 && x < MAP_WIDTH && y >= 0 && y < MAP_HEIGHT) {
                        // Simple distance check
                        if (Math.sqrt(dx*dx + dy*dy) <= sensorRange) {
                            game.map[x][y].visible = true;
                            game.map[x][y].explored = true;
                        }
                    }
                }
            }
            
            // Always make player's tile visible
            game.map[game.player.x][game.player.y].visible = true;
            game.map[game.player.x][game.player.y].explored = true;
        }

        // Rendering
        function render() {
            // Clear canvas with star background
            ctx.fillStyle = COLOR_EMPTY;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw stars in the background
            drawStars();
            
            // Set font for ASCII rendering
            ctx.font = `${TILE_SIZE}px 'Courier New', Courier, monospace`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Calculate viewport
            const viewportWidth = Math.floor(canvas.width / TILE_SIZE);
            const viewportHeight = Math.floor(canvas.height / TILE_SIZE);
            const offsetX = Math.max(0, Math.min(game.player.x - Math.floor(viewportWidth / 2), MAP_WIDTH - viewportWidth));
            const offsetY = Math.max(0, Math.min(game.player.y - Math.floor(viewportHeight / 2), MAP_HEIGHT - viewportHeight));
            
            // Draw map
            for (let x = offsetX; x < offsetX + viewportWidth && x < MAP_WIDTH; x++) {
                for (let y = offsetY; y < offsetY + viewportHeight && y < MAP_HEIGHT; y++) {
                    const tile = game.map[x][y];
                    const screenX = (x - offsetX) * TILE_SIZE + TILE_SIZE/2;
                    const screenY = (y - offsetY) * TILE_SIZE + TILE_SIZE/2;
                    
                    if (tile.visible) {
                        // Draw visible tiles
                        if (tile.blocked) {
                            ctx.fillStyle = COLOR_ASTEROID;
                            ctx.fillText(ASCII_ASTEROID, screenX, screenY);
                        } else if (tile.specialType === 'nebula') {
                            ctx.fillStyle = COLOR_NEBULA;
                            ctx.fillText(ASCII_NEBULA, screenX, screenY);
                        } else {
                            ctx.fillStyle = COLOR_VISIBLE;
                            ctx.fillText(ASCII_EMPTY, screenX, screenY);
                        }
                    } else if (tile.explored) {
                        // Draw explored but not visible tiles (fog of war)
                        ctx.fillStyle = COLOR_EXPLORED;
                        ctx.fillText(ASCII_EMPTY, screenX, screenY);
                    }
                    // Unexplored tiles remain black
                }
            }
            
            // Draw warp gates
            for (const gate of game.warpGates) {
                if (game.map[gate.x][gate.y].visible) {
                    const screenX = (gate.x - offsetX) * TILE_SIZE + TILE_SIZE/2;
                    const screenY = (gate.y - offsetY) * TILE_SIZE + TILE_SIZE/2;
                    ctx.fillStyle = COLOR_WARP;
                    ctx.fillText(ASCII_WARP, screenX, screenY);
                }
            }
            
            // Draw stations
            for (const station of game.stations) {
                if (game.map[station.x][station.y].visible) {
                    const screenX = (station.x - offsetX) * TILE_SIZE + TILE_SIZE/2;
                    const screenY = (station.y - offsetY) * TILE_SIZE + TILE_SIZE/2;
                    ctx.fillStyle = COLOR_STATION;
                    ctx.fillText(ASCII_STATION, screenX, screenY);
                }
            }
            
            // Draw planets
            for (const planet of game.planets) {
                if (game.map[planet.x][planet.y].visible) {
                    const screenX = (planet.x - offsetX) * TILE_SIZE + TILE_SIZE/2;
                    const screenY = (planet.y - offsetY) * TILE_SIZE + TILE_SIZE/2;
                    ctx.fillStyle = COLOR_PLANET;
                    ctx.fillText(ASCII_PLANET, screenX, screenY);
                }
            }
            
            // Draw resources
            for (const resource of game.resources) {
                if (game.map[resource.x][resource.y].visible) {
                    const screenX = (resource.x - offsetX) * TILE_SIZE + TILE_SIZE/2;
                    const screenY = (resource.y - offsetY) * TILE_SIZE + TILE_SIZE/2;
                    ctx.fillStyle = COLOR_RESOURCE;
                    ctx.fillText(ASCII_RESOURCE, screenX, screenY);
                }
            }
            
            // Draw aliens
            for (const alien of game.aliens) {
                if (game.map[alien.x][alien.y].visible) {
                    const screenX = (alien.x - offsetX) * TILE_SIZE + TILE_SIZE/2;
                    const screenY = (alien.y - offsetY) * TILE_SIZE + TILE_SIZE/2;
                    ctx.fillStyle = COLOR_ALIEN;
                    ctx.fillText(ASCII_ALIEN, screenX, screenY);
                    
                    // Draw health bar
                    const healthPercent = alien.hull / 50; // Assuming max hull of 50 for aliens
                    if (healthPercent < 1) {
                        ctx.fillStyle = '#333';
                        ctx.fillRect((alien.x - offsetX) * TILE_SIZE, (alien.y - offsetY) * TILE_SIZE - 5, TILE_SIZE, 3);
                        ctx.fillStyle = healthPercent > 0.5 ? '#0f0' : healthPercent > 0.25 ? '#f80' : '#f00';
                        ctx.fillRect((alien.x - offsetX) * TILE_SIZE, (alien.y - offsetY) * TILE_SIZE - 5, TILE_SIZE * healthPercent, 3);
                    }
                }
            }
            
            // Draw player
            const playerScreenX = (game.player.x - offsetX) * TILE_SIZE + TILE_SIZE/2;
            const playerScreenY = (game.player.y - offsetY) * TILE_SIZE + TILE_SIZE/2;
            ctx.fillStyle = game.player.ship ? shipTypes[game.player.ship].color : COLOR_PLAYER;
            ctx.fillText(ASCII_PLAYER, playerScreenX, playerScreenY);
        }

        // Draw star background
        function drawStars() {
            ctx.fillStyle = '#fff';
            for (let i = 0; i < 100; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() * 1.5;
                ctx.fillRect(x, y, size, size);
            }
        }

        // Auto-scan function
        function autoScan() {
            if (!game.autoScan) return;
            
            // Check for resources
            const resourceIndex = game.resources.findIndex(r => r.x === game.player.x && r.y === game.player.y);
            if (resourceIndex !== -1) {
                const resource = game.resources[resourceIndex];
                
                // Check cargo capacity
                if (game.player.cargo >= game.player.maxCargo) {
                    logMessage("Cargo hold full! Couldn't collect " + resource.type);
                    return;
                }
                
                game.player.cargo += resource.amount;
                game.resources.splice(resourceIndex, 1);
                logMessage(`Collected ${resource.amount} units of ${resource.type}.`);
                updateUI();
            }
        }

        // Game logic
        function movePlayer(dx, dy) {
            if (game.gameOver) return;
            
            const newX = game.player.x + dx;
            const newY = game.player.y + dy;
            
            // Check boundaries
            if (newX < 0 || newX >= MAP_WIDTH || newY < 0 || newY >= MAP_HEIGHT) {
                return;
            }
            
            // Check for obstacles
            if (game.map[newX][newY].blocked) {
                logMessage("Cannot navigate through asteroid field!");
                return;
            }
            
            // Check for warp gate
            const warpIndex = game.warpGates.findIndex(w => w.x === newX && w.y === newY);
            if (warpIndex !== -1) {
                warpToNewSystem();
                return;
            }
            
            // Check for space station
            const stationIndex = game.stations.findIndex(s => s.x === newX && s.y === newY);
            if (stationIndex !== -1) {
                dockWithStation(game.stations[stationIndex]);
                return;
            }
            
            // Check for aliens
            const alienIndex = game.aliens.findIndex(a => a.x === newX && a.y === newY);
            if (alienIndex !== -1) {
                spaceCombat(game.aliens[alienIndex]);
                if (game.aliens[alienIndex].hull <= 0) {
                    game.aliens.splice(alienIndex, 1);
                    game.aliensEncountered++;
                }
                game.turn++;
                updateUI();
                updateFOV();
                render();
                return;
            }
            
            // Move player
            game.player.x = newX;
            game.player.y = newY;
            game.turn++;
            
            // Use fuel
            game.player.fuel = Math.max(0, game.player.fuel - 1);
            if (game.player.fuel <= 0) {
                logMessage("Out of fuel! You're stranded in space.");
                // Could add game over condition here
            }
            
            // Auto-scan resources
            autoScan();
            
            // Move aliens
            moveAliens();
            
            // Update ability cooldowns
            updateAbilityCooldowns();
            
            // Update UI and render
            updateFOV();
            updateUI();
            render();
        }

        function updateAbilityCooldowns() {
            for (const ability in game.player.abilityCooldowns) {
                if (game.player.abilityCooldowns[ability] > 0) {
                    game.player.abilityCooldowns[ability]--;
                }
            }
            updateAbilityButtons();
        }

        function wait() {
            if (game.gameOver) return;
            
            game.turn++;
            // Move aliens
            moveAliens();
            
            // Update ability cooldowns
            updateAbilityCooldowns();
            
            updateUI();
            render();
        }

        function scan() {
            if (game.gameOver) return;
            
            // Reveal a larger area temporarily
            const scanRadius = FOV_RADIUS + 3;
            for (let dx = -scanRadius; dx <= scanRadius; dx++) {
                for (let dy = -scanRadius; dy <= scanRadius; dy++) {
                    const x = game.player.x + dx;
                    const y = game.player.y + dy;
                    
                    if (x >= 0 && x < MAP_WIDTH && y >= 0 && y < MAP_HEIGHT) {
                        if (Math.sqrt(dx*dx + dy*dy) <= scanRadius) {
                            game.map[x][y].visible = true;
                            game.map[x][y].explored = true;
                        }
                    }
                }
            }
            
            logMessage("Active scan complete. Area revealed.");
            game.turn++;
            moveAliens();
            updateUI();
            render();
        }

        function interact() {
            if (game.gameOver) return;
            
            // Check for stations adjacent to player
            for (const station of game.stations) {
                const dx = Math.abs(station.x - game.player.x);
                const dy = Math.abs(station.y - game.player.y);
                if (dx <= 1 && dy <= 1) {
                    dockWithStation(station);
                    return;
                }
            }
            
            // Check for planets adjacent to player
            for (const planet of game.planets) {
                const dx = Math.abs(planet.x - game.player.x);
                const dy = Math.abs(planet.y - game.player.y);
                if (dx <= 1 && dy <= 1) {
                    logMessage(`Scanning ${planet.name}... ${planet.type} planet. No signs of intelligent life.`);
                    return;
                }
            }
            
            logMessage("No objects to interact with.");
        }

        // Alien AI
        function moveAliens() {
            for (const alien of game.aliens) {
                // Skip if dead
                if (alien.hull <= 0) continue;
                
                // Different behaviors based on move pattern
                switch (alien.movePattern) {
                    case 'patrol':
                        movePatrolAlien(alien);
                        break;
                    case 'aggressive':
                        moveAggressiveAlien(alien);
                        break;
                    case 'cowardly':
                        moveCowardlyAlien(alien);
                        break;
                    default:
                        movePatrolAlien(alien);
                }
            }
        }

        function movePatrolAlien(alien) {
            // Patrol AI: move randomly
            if (Math.random() < 0.3) { // 30% chance to move
                const directions = [[0,1], [1,0], [0,-1], [-1,0]];
                const [dx, dy] = directions[Math.floor(Math.random() * directions.length)];
                tryMoveAlien(alien, dx, dy);
            }
        }

        function moveAggressiveAlien(alien) {
            // Aggressive AI: move toward player if in sight
            if (game.map[alien.x][alien.y].visible) {
                const dx = Math.sign(game.player.x - alien.x);
                const dy = Math.sign(game.player.y - alien.y);
                tryMoveAlien(alien, dx, dy);
            } else {
                movePatrolAlien(alien);
            }
        }

        function moveCowardlyAlien(alien) {
            // Cowardly AI: move away from player if in sight
            if (game.map[alien.x][alien.y].visible) {
                const dx = -Math.sign(game.player.x - alien.x);
                const dy = -Math.sign(game.player.y - alien.y);
                tryMoveAlien(alien, dx, dy);
            } else {
                movePatrolAlien(alien);
            }
        }

        function tryMoveAlien(alien, dx, dy) {
            const newX = alien.x + dx;
            const newY = alien.y + dy;
            
            // Check if move is valid and not into another alien or obstacle
            if (!game.map[newX][newY].blocked && 
                !game.aliens.some(a => a !== alien && a.x === newX && a.y === newY) &&
                !(game.stations.some(s => s.x === newX && s.y === newY)) &&
                !(game.planets.some(p => p.x === newX && p.y === newY))) {
                
                // Check if moving into player
                if (newX === game.player.x && newY === game.player.y) {
                    spaceCombat(alien, game.player);
                } else {
                    alien.x = newX;
                    alien.y = newY;
                }
            }
        }

        function spaceCombat(attacker, defender) {
            let damage;
            
            if (attacker === game.player) {
                // Player is attacking
                damage = 10 + Math.floor(Math.random() * 10);
                if (game.player.ship === 'fighter') {
                    damage = Math.floor(damage * 1.25); // Fighter bonus
                }
                alien.hull -= damage;
                logMessage(`You hit the alien ship for ${damage} damage.`);
                if (alien.hull <= 0) {
                    logMessage(`You destroyed the alien ship!`);
                    game.player.xp += 20;
                    checkRankUp();
                }
            } else {
                // Alien is attacking
                damage = alien.attack;
                game.player.hull -= damage;
                logMessage(`The alien ship hits you for ${damage} damage.`);
                if (game.player.hull <= 0) {
                    logMessage("Your ship has been destroyed!");
                    gameOver();
                }
            }
        }

        function checkRankUp() {
            if (game.player.xp >= game.player.nextRankXp) {
                game.player.rank++;
                game.player.xp -= game.player.nextRankXp;
                game.player.nextRankXp = Math.floor(game.player.nextRankXp * 1.5);
                
                // Increase stats
                game.player.maxHull += 10;
                game.player.hull = game.player.maxHull;
                game.player.maxFuel += 10;
                game.player.fuel = game.player.maxFuel;
                
                logMessage(`You reached rank ${game.player.rank}!`);
                logMessage(`Your ship's hull and fuel capacity increased!`);
                
                // Learn new abilities at certain ranks
                if (game.player.rank === 3) {
                    if (game.player.ship === 'scout') {
                        game.player.abilities.push('long_range_scan');
                        logMessage("You learned Long Range Scan!");
                    } else if (game.player.ship === 'freighter') {
                        game.player.abilities.push('trade_network');
                        logMessage("You established a Trade Network!");
                    } else if (game.player.ship === 'fighter') {
                        game.player.abilities.push('missile_launch');
                        logMessage("You installed Missile Launchers!");
                    }
                    updateAbilityButtons();
                }
            }
        }

        function warpToNewSystem() {
            game.player.discoveredSystems++;
            logMessage(`Warping to new star system...`);
            
            // Generate new system name
            const systemNames = ['Alpha Centauri', 'Sirius', 'Vega', 'Procyon', 'Altair', 'Arcturus', 'Capella'];
            game.currentSystem = systemNames[Math.floor(Math.random() * systemNames.length)];
            
            // Reset resources and generate new map
            game.aliens = [];
            game.resources = [];
            game.stations = [];
            game.planets = [];
            game.warpGates = [];
            game.nebulas = [];
            
            // Update system indicator
            document.getElementById('system-indicator').textContent = `${game.currentSystem} System`;
            
            // Generate new level
            initializeMap();
            updateUI();
            render();
        }

        function dockWithStation(station) {
            document.getElementById('station-name').textContent = station.name;
            const dialogueElement = document.getElementById('station-dialogue');
            const optionsElement = document.getElementById('station-options');
            
            dialogueElement.innerHTML = '';
            optionsElement.innerHTML = '';
            
            // Show station dialogue
            const dialogues = [
                "Welcome, traveler. What do you need?",
                "This station offers supplies and repairs.",
                "Looking to trade or refuel?"
            ];
            const dialogue = dialogues[Math.floor(Math.random() * dialogues.length)];
            const dialogueItem = document.createElement('div');
            dialogueItem.className = 'modal-item';
            dialogueItem.textContent = dialogue;
            dialogueElement.appendChild(dialogueItem);
            
            // Show options
            const refuelOption = document.createElement('div');
            refuelOption.className = 'modal-item';
            refuelOption.textContent = `Refuel (${calculateRefuelCost()} credits)`;
            refuelOption.addEventListener('click', () => {
                refuelShip();
                hideStationDialogue();
            });
            optionsElement.appendChild(refuelOption);
            
            const repairOption = document.createElement('div');
            repairOption.className = 'modal-item';
            repairOption.textContent = `Repair hull (${calculateRepairCost()} credits)`;
            repairOption.addEventListener('click', () => {
                repairShip();
                hideStationDialogue();
            });
            optionsElement.appendChild(repairOption);
            
            const tradeOption = document.createElement('div');
            tradeOption.className = 'modal-item';
            tradeOption.textContent = "Sell resources";
            tradeOption.addEventListener('click', () => {
                sellResources();
                hideStationDialogue();
            });
            optionsElement.appendChild(tradeOption);
            
            const closeOption = document.createElement('div');
            closeOption.className = 'modal-item';
            closeOption.textContent = "Depart";
            closeOption.addEventListener('click', hideStationDialogue);
            optionsElement.appendChild(closeOption);
            
            document.getElementById('station-modal').style.display = 'block';
        }

        function calculateRefuelCost() {
            const fuelNeeded = game.player.maxFuel - game.player.fuel;
            return Math.floor(fuelNeeded * 0.5);
        }

        function calculateRepairCost() {
            const hullDamage = game.player.maxHull - game.player.hull;
            return Math.floor(hullDamage * 1.0);
        }

        function refuelShip() {
            const cost = calculateRefuelCost();
            if (game.player.credits >= cost) {
                game.player.credits -= cost;
                game.player.fuel = game.player.maxFuel;
                logMessage(`Ship refueled for ${cost} credits.`);
            } else {
                logMessage(`Not enough credits. Need ${cost} but only have ${game.player.credits}.`);
            }
            updateUI();
        }

        function repairShip() {
            const cost = calculateRepairCost();
            if (game.player.credits >= cost) {
                game.player.credits -= cost;
                game.player.hull = game.player.maxHull;
                logMessage(`Hull repaired for ${cost} credits.`);
            } else {
                logMessage(`Not enough credits. Need ${cost} but only have ${game.player.credits}.`);
            }
            updateUI();
        }

        function sellResources() {
            if (game.player.cargo > 0) {
                const value = game.player.cargo * 5;
                if (game.player.ship === 'freighter') {
                    value = Math.floor(value * 1.2); // Freighter bonus
                }
                game.player.credits += value;
                logMessage(`Sold ${game.player.cargo} units of resources for ${value} credits.`);
                game.player.cargo = 0;
                updateUI();
            } else {
                logMessage("No resources to sell.");
            }
        }

        function hideStationDialogue() {
            document.getElementById('station-modal').style.display = 'none';
        }

        function gameOver() {
            game.gameOver = true;
            document.getElementById('final-systems').textContent = game.player.discoveredSystems;
            document.getElementById('final-rank').textContent = game.player.rank;
            document.getElementById('credits-earned').textContent = game.player.credits;
            document.getElementById('aliens-encountered').textContent = game.aliensEncountered;
            document.getElementById('game-over').style.display = 'block';
        }

        function restartGame() {
            // Reset game state
            game = {
                map: [],
                player: {
                    x: 0,
                    y: 0,
                    hull: 100,
                    maxHull: 100,
                    fuel: 100,
                    maxFuel: 100,
                    credits: 100,
                    cargo: 0,
                    maxCargo: 10,
                    inventory: [],
                    systems: [],
                    ship: null,
                    abilities: [],
                    abilityCooldowns: {},
                    rank: 1,
                    xp: 0,
                    nextRankXp: 100,
                    discoveredSystems: 1,
                    missions: []
                },
                aliens: [],
                resources: [],
                stations: [],
                planets: [],
                warpGates: [],
                nebulas: [],
                turn: 0,
                currentSystem: 'Sol',
                messages: [],
                aliensEncountered: 0,
                gameOver: false,
                autoScan: true,
                bossActive: false
            };
            
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('ship-selection').style.display = 'block';
            document.getElementById('auto-scan-toggle').textContent = 'Auto-Scan: ON';
            document.getElementById('quest-indicator').style.display = 'none';
            
            // Clear abilities container
            document.getElementById('abilities-container').innerHTML = '';
        }

        function selectShip(shipType) {
            const shipInfo = shipTypes[shipType];
            game.player.ship = shipType;
            game.player.hull = shipInfo.hull;
            game.player.maxHull = shipInfo.hull;
            game.player.fuel = shipInfo.fuel;
            game.player.maxFuel = shipInfo.fuel;
            game.player.maxCargo = shipInfo.cargo;
            game.player.abilities = [...shipInfo.abilities];
            
            // Initialize ability cooldowns
            game.player.abilities.forEach(ability => {
                game.player.abilityCooldowns[ability] = 0;
            });
            
            document.getElementById('ship-selection').style.display = 'none';
            
            // Initialize the game
            initializeMap();
            updateUI();
            updateAbilityButtons();
            logMessage(`You are piloting a ${shipInfo.name}!`);
            logMessage("Welcome to ASCII Space Explorer!");
            logMessage("Move with the directional buttons.");
            logMessage("Scan with 'Scan' and check cargo with 'Cargo'.");
            logMessage("Find the 'W' warp gates to explore new systems!");
            logMessage("Use the 'Dock' button to interact with space stations.");
            render();
        }

        function useAbility(ability) {
            if (game.player.abilityCooldowns[ability] > 0) {
                logMessage(`Ability is on cooldown for ${game.player.abilityCooldowns[ability]} more turns.`);
                return;
            }
            
            switch (ability) {
                case 'enhanced_sensors':
                    // Scout ability: reveal entire map temporarily
                    for (let x = 0; x < MAP_WIDTH; x++) {
                        for (let y = 0; y < MAP_HEIGHT; y++) {
                            game.map[x][y].visible = true;
                            game.map[x][y].explored = true;
                        }
                    }
                    logMessage("Enhanced sensors activated! Full system scan complete.");
                    game.player.abilityCooldowns[ability] = 20;
                    break;
                    
                case 'trade_bonus':
                    // Freighter ability: get bonus credits
                    const bonus = 50;
                    game.player.credits += bonus;
                    logMessage(`Trade network activated! Received ${bonus} bonus credits.`);
                    game.player.abilityCooldowns[ability] = 15;
                    break;
                    
                case 'combat_boost':
                    // Fighter ability: temporary combat boost
                    game.player.buffs = game.player.buffs || [];
                    game.player.buffs.push({
                        type: 'combat_boost',
                        duration: 5,
                        value: 0.5 // 50% damage boost
                    });
                    logMessage("Combat systems boosted! +50% damage for 5 turns.");
                    game.player.abilityCooldowns[ability] = 10;
                    break;
                    
                case 'long_range_scan':
                    // Scout rank 3 ability
                    scan();
                    logMessage("Long range scan complete!");
                    game.player.abilityCooldowns[ability] = 10;
                    break;
                    
                case 'trade_network':
                    // Freighter rank 3 ability
                    const networkBonus = 100;
                    game.player.credits += networkBonus;
                    logMessage(`Trade network established! Received ${networkBonus} credits.`);
                    game.player.abilityCooldowns[ability] = 20;
                    break;
                    
                case 'missile_launch':
                    // Fighter rank 3 ability: area damage
                    let aliensHit = 0;
                    for (let dx = -2; dx <= 2; dx++) {
                        for (let dy = -2; dy <= 2; dy++) {
                            const x = game.player.x + dx;
                            const y = game.player.y + dy;
                            const alienIndex = game.aliens.findIndex(a => a.x === x && a.y === y);
                            if (alienIndex !== -1) {
                                const damage = 25;
                                game.aliens[alienIndex].hull -= damage;
                                logMessage(`Missile hits alien for ${damage} damage!`);
                                aliensHit++;
                                
                                if (game.aliens[alienIndex].hull <= 0) {
                                    game.aliens.splice(alienIndex, 1);
                                    game.aliensEncountered++;
                                }
                            }
                        }
                    }
                    
                    if (aliensHit > 0) {
                        logMessage(`Missile volley hits ${aliensHit} alien ships!`);
                    } else {
                        logMessage("Missiles launched but no targets in range.");
                    }
                    
                    game.player.abilityCooldowns[ability] = 8;
                    break;
            }
            
            updateAbilityButtons();
            game.turn++;
            moveAliens();
            updateUI();
            render();
        }

        function updateAbilityButtons() {
            const container = document.getElementById('abilities-container');
            container.innerHTML = '';
            
            game.player.abilities.forEach(ability => {
                const button = document.createElement('button');
                button.className = 'ability-btn';
                button.textContent = ability.replace('_', ' ');
                button.disabled = game.player.abilityCooldowns[ability] > 0;
                
                if (game.player.abilityCooldowns[ability] > 0) {
                    button.title = `Cooldown: ${game.player.abilityCooldowns[ability]} turns`;
                }
                
                button.addEventListener('click', () => useAbility(ability));
                container.appendChild(button);
            });
        }

        function toggleAutoScan() {
            game.autoScan = !game.autoScan;
            document.getElementById('auto-scan-toggle').textContent = `Auto-Scan: ${game.autoScan ? 'ON' : 'OFF'}`;
            logMessage(`Auto-scan ${game.autoScan ? 'enabled' : 'disabled'}.`);
        }

        function showInventory() {
            if (game.gameOver) return;
            
            const inventoryList = document.getElementById('inventory-list');
            const equippedList = document.getElementById('equipped-list');
            
            inventoryList.innerHTML = '';
            equippedList.innerHTML = '';
            
            if (game.player.inventory.length === 0) {
                inventoryList.innerHTML = '<div class="modal-item">Cargo hold is empty</div>';
            } else {
                game.player.inventory.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'modal-item';
                    itemElement.textContent = item.name;
                    itemElement.addEventListener('click', () => {
                        useItem(index);
                        hideInventory();
                    });
                    inventoryList.appendChild(itemElement);
                });
            }
            
            // Show ship status
            const shipElement = document.createElement('div');
            shipElement.className = 'modal-item equipped';
            shipElement.innerHTML = `Ship: ${shipTypes[game.player.ship].name}<br>
                                    <span class="item-details">Hull: ${game.player.hull}/${game.player.maxHull}</span><br>
                                    <span class="item-details fuel-stat">Fuel: ${game.player.fuel}/${game.player.maxFuel}</span><br>
                                    <span class="item-details">Cargo: ${game.player.cargo}/${game.player.maxCargo}</span>`;
            equippedList.appendChild(shipElement);
            
            document.getElementById('inventory-modal').style.display = 'block';
        }

        function hideInventory() {
            document.getElementById('inventory-modal').style.display = 'none';
        }

        function useItem(index) {
            // Placeholder for item usage
            logMessage(`Used ${game.player.inventory[index].name}`);
            game.player.inventory.splice(index, 1);
            updateUI();
        }

        function logMessage(message) {
            game.messages.push(message);
            if (game.messages.length > 5) {
                game.messages.shift();
            }
            
            const messageLog = document.getElementById('message-log');
            messageLog.innerHTML = '';
            game.messages.forEach(msg => {
                const msgElement = document.createElement('div');
                msgElement.textContent = msg;
                messageLog.appendChild(msgElement);
            });
            messageLog.scrollTop = messageLog.scrollHeight;
        }

        function updateUI() {
            document.getElementById('hull').textContent = game.player.hull;
            document.getElementById('max-hull').textContent = game.player.maxHull;
            document.getElementById('hull-fill').style.width = `${(game.player.hull / game.player.maxHull) * 100}%`;
            document.getElementById('fuel').textContent = game.player.fuel;
            document.getElementById('max-fuel').textContent = game.player.maxFuel;
            document.getElementById('fuel-fill').style.width = `${(game.player.fuel / game.player.maxFuel) * 100}%`;
            document.getElementById('credits').textContent = game.player.credits;
            document.getElementById('cargo').textContent = game.player.cargo;
            document.getElementById('max-cargo').textContent = game.player.maxCargo;
            document.getElementById('system').textContent = game.currentSystem;
            document.getElementById('turn').textContent = game.turn;
        }

        // Event listeners
        document.getElementById('btn-up').addEventListener('click', () => movePlayer(0, -1));
        document.getElementById('btn-down').addEventListener('click', () => movePlayer(0, 1));
        document.getElementById('btn-left').addEventListener('click', () => movePlayer(-1, 0));
        document.getElementById('btn-right').addEventListener('click', () => movePlayer(1, 0));
        document.getElementById('btn-wait').addEventListener('click', wait);
        document.getElementById('btn-scan').addEventListener('click', scan);
        document.getElementById('btn-interact').addEventListener('click', interact);
        document.getElementById('btn-inventory').addEventListener('click', showInventory);
        document.getElementById('close-inventory').addEventListener('click', hideInventory);
        document.getElementById('close-station').addEventListener('click', hideStationDialogue);
        document.getElementById('restart-btn').addEventListener('click', restartGame);
        document.getElementById('auto-scan-toggle').addEventListener('click', toggleAutoScan);

        // Ship selection event listeners
        document.querySelectorAll('.ship-option').forEach(option => {
            option.addEventListener('click', () => {
                selectShip(option.dataset.ship);
            });
        });

        // Initialize the game with ship selection
        document.getElementById('ship-selection').style.display = 'block';
    </script>
</body>
</html>
