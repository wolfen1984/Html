<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Demon Cards</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=MedievalSharp&display=swap');
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            font-family: 'MedievalSharp', cursive;
        }
        
        body {
            background: #0a0a0a url('bk1.jpg') center/cover no-repeat fixed;
            color: #e0d8c0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            text-shadow: 1px 1px 2px #000;
        }
        
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            border: 2px solid #3a1a1a;
            box-shadow: inset 0 0 20px #300000;
        }
        
        #header {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: linear-gradient(to right, #1a0a0a, #2a0a0a, #1a0a0a);
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid #5a1a1a;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .stat {
            display: flex;
            align-items: center;
            font-family: 'Cinzel Decorative', cursive;
            font-size: 14px;
        }
        
        .stat-icon {
            margin-right: 5px;
            font-size: 16px;
            text-shadow: 0 0 5px #ff0000;
        }
        
        #combat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(10, 5, 5, 0.8);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #5a1a1a;
            box-shadow: inset 0 0 15px #200000;
            position: relative;
            overflow: hidden;
        }
        
        #combat-area::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('bk1.jpg') center/cover no-repeat;
            opacity: 0.2;
            pointer-events: none;
        }
        
        #enemy-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }
        
        #enemy {
            width: 120px;
            height: 160px;
            background: linear-gradient(135deg, #2a0a0a 0%, #1a0a0a 100%);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
            position: relative;
            border: 2px solid #5a1a1a;
            transform-style: preserve-3d;
            transition: transform 0.3s;
        }
        
        #enemy:hover {
            transform: translateY(-5px) rotateX(5deg);
        }
        
        .enemy-health {
            position: absolute;
            top: 10px;
            width: 80%;
            height: 10px;
            background: #300000;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid #5a1a1a;
        }
        
        .enemy-health-bar {
            height: 100%;
            background: linear-gradient(to right, #ff0000, #cc0000);
            width: 100%;
            transition: width 0.3s;
        }
        
        .enemy-intent {
            position: absolute;
            top: -30px;
            width: 40px;
            height: 40px;
            background: #1a0a0a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 2px solid #5a1a1a;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }
        
        #player-display {
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        
        .player-health {
            position: absolute;
            left: 10px;
            width: 100px;
            height: 10px;
            background: #300000;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid #5a1a1a;
        }
        
        .player-health-bar {
            height: 100%;
            background: linear-gradient(to right, #00aa00, #008800);
            width: 100%;
            transition: width 0.3s;
        }
        
        .player-energy {
            position: absolute;
            right: 10px;
            display: flex;
            gap: 5px;
        }
        
        .energy-orb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffcc00, #cc9900);
            border: 1px solid #ffcc00;
            box-shadow: 0 0 5px #ffcc00;
        }
        
        .energy-orb.empty {
            background: #300000;
            border-color: #5a1a1a;
            box-shadow: none;
        }
        
        #hand {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 10px 0;
            min-height: 140px;
            flex-wrap: wrap;
            z-index: 1;
        }
        
        .card {
            width: 80px;
            height: 120px;
            background: linear-gradient(135deg, #2a1a1a 0%, #1a0a0a 100%);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            color: #e0d8c0;
            font-size: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid #5a1a1a;
            cursor: pointer;
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        
        .card:hover {
            transform: translateY(-10px) rotateX(5deg);
            box-shadow: 0 8px 15px rgba(255, 0, 0, 0.3);
        }
        
        .card.selected {
            transform: translateY(-20px) rotateX(10deg);
            box-shadow: 0 10px 20px rgba(255, 0, 0, 0.5);
        }
        
        .card-name {
            font-weight: bold;
            text-align: center;
            font-family: 'Cinzel Decorative', cursive;
            font-size: 14px;
            color: #e0d8c0;
            text-shadow: 1px 1px 2px #000;
        }
        
        .card-description {
            font-size: 10px;
            text-align: center;
            flex: 1;
            display: flex;
            align-items: center;
            color: #c0b8a0;
        }
        
        .card-cost {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle at 30% 30%, #ffcc00, #cc9900);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            border: 1px solid #ffcc00;
            box-shadow: 0 0 5px #ffcc00;
            z-index: 2;
        }
        
        /* Card rarity styles */
        .card.common {
            border: 2px solid #b0b0b0;
            box-shadow: 0 0 10px rgba(176, 176, 176, 0.3);
        }
        
        .card.uncommon {
            border: 2px solid #4ecca3;
            background: linear-gradient(135deg, #2a1a1a 0%, #0a3a2a 100%);
            box-shadow: 0 0 10px rgba(78, 204, 163, 0.3);
        }
        
        .card.rare {
            border: 2px solid #4e9de6;
            background: linear-gradient(135deg, #2a1a1a 0%, #0a2a3a 100%);
            box-shadow: 0 0 10px rgba(78, 157, 230, 0.3);
        }
        
        .card.epic {
            border: 2px solid #9d4ee6;
            background: linear-gradient(135deg, #2a1a1a 0%, #3a0a5a 100%);
            box-shadow: 0 0 10px rgba(157, 78, 230, 0.3);
        }
        
        .card.legendary {
            border: 2px solid #e69d4e;
            background: linear-gradient(135deg, #2a1a1a 0%, #5a3a0a 100%);
            box-shadow: 0 0 15px rgba(230, 157, 78, 0.5);
        }
        
        .rarity-indicator {
            position: absolute;
            bottom: -5px;
            left: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            border: 1px solid currentColor;
            z-index: 2;
        }
        
        .rarity-indicator.common {
            background: #b0b0b0;
            border-color: #909090;
        }
        
        .rarity-indicator.uncommon {
            background: #4ecca3;
            border-color: #3eaa83;
        }
        
        .rarity-indicator.rare {
            background: #4e9de6;
            border-color: #3e8dc6;
        }
        
        .rarity-indicator.epic {
            background: #9d4ee6;
            border-color: #7d3ec6;
        }
        
        .rarity-indicator.legendary {
            background: #e69d4e;
            border-color: #c67d3e;
        }
        
        #deck-info {
            display: flex;
            justify-content: space-between;
            background: linear-gradient(to right, #1a0a0a, #2a0a0a, #1a0a0a);
            border-radius: 8px;
            padding: 8px;
            border: 1px solid #5a1a1a;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        
        .deck-count {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Cinzel Decorative', cursive;
            font-size: 12px;
        }
        
        #controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px 0;
            z-index: 1;
        }
        
        .btn {
            padding: 10px 20px;
            background: linear-gradient(to bottom, #4ecca3, #3eaa83);
            border: none;
            border-radius: 5px;
            color: #1a0a0a;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Cinzel Decorative', cursive;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #5a1a1a;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }
        
        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        .btn:disabled {
            background: linear-gradient(to bottom, #555, #333);
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn.end-turn {
            background: linear-gradient(to bottom, #e94560, #c72540);
            color: #fff;
        }
        
        #screen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        
        .modal {
            background: linear-gradient(135deg, #1a0a0a 0%, #2a0a0a 100%);
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #5a1a1a;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
            position: relative;
        }
        
        .modal::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('bk1.jpg') center/cover no-repeat;
            opacity: 0.1;
            pointer-events: none;
            z-index: -1;
        }
        
        .card-reward {
            display: inline-block;
            margin: 10px;
            transform: scale(0.9);
            transition: transform 0.2s;
        }
        
        .card-reward:hover {
            transform: scale(1);
        }
        
        #reward-choices {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        h2 {
            margin-bottom: 10px;
            text-align: center;
            font-family: 'Cinzel Decorative', cursive;
            color: #e0d8c0;
            text-shadow: 2px 2px 4px #000;
        }
        
        /* Achievements styles */
        #achievements-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 30% 30%, #4ecca3, #3eaa83);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 10;
            border: 1px solid #5a1a1a;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
        }
        
        #achievements-btn:hover {
            transform: scale(1.1);
        }
        
        #achievements-modal {
            display: none;
        }
        
        .achievement {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(30, 10, 10, 0.7);
            border-radius: 5px;
            border-left: 3px solid #5a1a1a;
        }
        
        .achievement-icon {
            font-size: 24px;
            margin-right: 10px;
            min-width: 30px;
            text-align: center;
        }
        
        .achievement-info {
            flex: 1;
        }
        
        .achievement-title {
            font-weight: bold;
            font-family: 'Cinzel Decorative', cursive;
        }
        
        .achievement-desc {
            font-size: 12px;
            color: #c0b8a0;
        }
        
        .achievement-progress {
            height: 5px;
            background: #300000;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(to right, #4ecca3, #3eaa83);
        }
        
        .achievement.unlocked {
            border-left: 4px solid #ffcc00;
            background: rgba(30, 20, 10, 0.7);
        }
        
        .achievement-locked {
            filter: grayscale(80%);
            opacity: 0.7;
        }
        
        /* Shop styles */
        #shop-btn {
            position: absolute;
            top: 10px;
            right: 60px;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 30% 30%, #ffcc00, #cc9900);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 10;
            border: 1px solid #5a1a1a;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
        }
        
        #shop-btn:hover {
            transform: scale(1.1);
        }
        
        #shop-modal {
            display: none;
        }
        
        #shop-items {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        
        .shop-item {
            background: rgba(30, 10, 10, 0.7);
            border-radius: 5px;
            padding: 15px;
            width: 140px;
            text-align: center;
            border: 1px solid #5a1a1a;
            transition: transform 0.2s;
        }
        
        .shop-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 10px rgba(255, 0, 0, 0.2);
        }
        
        .shop-item-price {
            color: #ffcc00;
            font-weight: bold;
            margin: 10px 0;
            font-family: 'Cinzel Decorative', cursive;
        }
        
        .buy-btn {
            padding: 5px 10px;
            font-size: 12px;
            margin-top: 5px;
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to right, #4ecca3, #3eaa83);
            color: #1a0a0a;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            animation: fadeInOut 2s ease-in-out;
            font-weight: bold;
            border: 1px solid #5a1a1a;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }
        
        /* New card types */
        .card.poison {
            border: 2px solid #6a4c93;
            background: linear-gradient(135deg, #2a1a1a 0%, #3a0a5a 100%);
            box-shadow: 0 0 10px rgba(106, 76, 147, 0.3);
        }
        
        .card.fire {
            border: 2px solid #ff7b25;
            background: linear-gradient(135deg, #2a1a1a 0%, #5a1a0a 100%);
            box-shadow: 0 0 10px rgba(255, 123, 37, 0.3);
        }
        
        .card.ice {
            border: 2px solid #4cc9f0;
            background: linear-gradient(135deg, #2a1a1a 0%, #0a3a5a 100%);
            box-shadow: 0 0 10px rgba(76, 201, 240, 0.3);
        }
        
        /* Status effects */
        .status-effect {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            margin: 2px;
            font-weight: bold;
        }
        
        .status-poison {
            background: linear-gradient(to right, #6a4c93, #4a2c73);
            color: white;
            border: 1px solid #8a6cb3;
        }
        
        .status-weak {
            background: linear-gradient(to right, #adb5bd, #8d95a0);
            color: black;
            border: 1px solid #cdd5dd;
        }
        
        .status-vulnerable {
            background: linear-gradient(to right, #ff758f, #df556f);
            color: black;
            border: 1px solid #ff95af;
        }
        
        .status-strength {
            background: linear-gradient(to right, #ff7b25, #df5b05);
            color: white;
            border: 1px solid #ff9b45;
        }
        
        /* Blood splatter effect */
        .blood-splatter {
            position: absolute;
            width: 100%;
            height: 100%;
            background: url('https://i.imgur.com/JXaQwQp.png') center/cover no-repeat;
            opacity: 0;
            pointer-events: none;
            z-index: 5;
            transition: opacity 0.3s;
        }
        
        /* Damage numbers */
        .damage-number {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: #ff0000;
            text-shadow: 0 0 5px #000;
            animation: floatUp 1s ease-out forwards;
            z-index: 10;
            pointer-events: none;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        /* Candle flicker effect */
        .candle-light {
            position: absolute;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,200,100,0.3) 0%, rgba(255,100,0,0) 70%);
            border-radius: 50%;
            filter: blur(5px);
            animation: flicker 3s infinite alternate;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes flicker {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            25% { opacity: 0.8; transform: scale(1.05); }
            50% { opacity: 0.6; transform: scale(0.95); }
            75% { opacity: 0.9; transform: scale(1.03); }
        }
        
        /* Floating particles */
        .particle {
            position: absolute;
            background: rgba(255, 0, 0, 0.3);
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            animation: float 15s infinite linear;
        }
        
        @keyframes float {
            0% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-100vh) translateX(20px); opacity: 0; }
        }
        
        /* New styles for character selection */
        .character-select {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .character-option {
            width: 100px;
            padding: 10px;
            background: rgba(30, 10, 10, 0.7);
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid #5a1a1a;
        }
        
        .character-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 10px rgba(255, 0, 0, 0.2);
        }
        
        .character-option.selected {
            border-color: #ffcc00;
            box-shadow: 0 0 15px #ffcc00;
        }
        
        .character-icon {
            font-size: 40px;
            margin-bottom: 5px;
        }
        
        /* Card tooltip */
        .card-tooltip {
            position: fixed;
            background: rgba(20, 10, 10, 0.95);
            border: 2px solid #5a1a1a;
            border-radius: 5px;
            padding: 10px;
            max-width: 200px;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
        }
        
        /* Screen shake */
        .screen-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        /* Enemy death animation */
        .enemy-death {
            animation: deathAnimation 1s ease-out forwards;
        }
        
        @keyframes deathAnimation {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(0.5); opacity: 0; }
        }
        
        /* Event modal */
        .event-option {
            margin: 10px 0;
            padding: 10px;
            background: rgba(30, 10, 10, 0.7);
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid #5a1a1a;
        }
        
        .event-option:hover {
            background: rgba(50, 20, 20, 0.7);
        }
        
        /* Save indicator */
        .save-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: #888;
        }
        
        @media (max-width: 400px) {
            .card {
                width: 70px;
                height: 105px;
                font-size: 10px;
                padding: 5px;
            }
            
            .card-name {
                font-size: 12px;
            }
            
            .card-description {
                font-size: 8px;
            }
            
            #enemy {
                width: 100px;
                height: 140px;
            }
            
            .shop-item {
                width: 120px;
                padding: 10px;
            }
            
            .character-option {
                width: 80px;
                font-size: 12px;
            }
            
            .character-icon {
                font-size: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="blood-splatter" id="blood-splatter"></div>
    <div class="candle-light" style="top: 20%; left: 10%;"></div>
    <div class="candle-light" style="bottom: 20%; right: 10%;"></div>
    
    <button id="shop-btn">🛒</button>
    <button id="achievements-btn">🏆</button>
    <div class="save-indicator" id="save-indicator">Auto-saving...</div>
    
    <div id="game-container">
        <div id="header">
            <div class="stat">
                <span class="stat-icon">💀</span>
                <span id="player-hp-text">30/30</span>
            </div>
            <div class="stat">
                <span class="stat-icon">🔥</span>
                <span id="floor-text">Floor 1</span>
            </div>
            <div class="stat">
                <span class="stat-icon">💰</span>
                <span id="gold-text">50</span>
            </div>
        </div>
        
        <div id="combat-area">
            <div id="enemy-display">
                <div class="enemy-intent" id="enemy-intent">?</div>
                <div id="enemy">
                    <div class="enemy-health">
                        <div class="enemy-health-bar" id="enemy-health-bar"></div>
                    </div>
                    <div id="enemy-name">Ghoul</div>
                    <div id="enemy-hp">15/15</div>
                    <div id="enemy-status"></div>
                </div>
            </div>
            
            <div id="player-display">
                <div class="player-health">
                    <div class="player-health-bar" id="player-health-bar"></div>
                </div>
                <div id="player-name">Occultist</div>
                <div id="player-status"></div>
                <div class="player-energy" id="player-energy">
                    <!-- Energy orbs will be added here -->
                </div>
            </div>
        </div>
        
        <div id="hand">
            <!-- Cards will be added here -->
        </div>
        
        <div id="deck-info">
            <div class="deck-count">
                <div>Deck</div>
                <div id="deck-count">10</div>
            </div>
            <div class="deck-count">
                <div>Discard</div>
                <div id="discard-count">0</div>
            </div>
            <div class="deck-count">
                <div>Draw</div>
                <div id="draw-count">5</div>
            </div>
        </div>
        
        <div id="controls">
            <button class="btn" id="draw-btn">Draw (3)</button>
            <button class="btn end-turn" id="end-turn-btn">End Turn</button>
        </div>
    </div>
    
    <div id="screen-overlay" style="display: none;">
        <div class="modal" id="start-modal">
            <h2>DEMON CARDS</h2>
            <p>A dark card game of strategy and survival</p>
            
            <div class="character-select" id="character-select">
                <div class="character-option" data-class="occultist">
                    <div class="character-icon">🔮</div>
                    <div>Occultist</div>
                    <small>Balanced deck with curses and wards</small>
                </div>
                <div class="character-option" data-class="bloodmage">
                    <div class="character-icon">🩸</div>
                    <div>Blood Mage</div>
                    <small>Powerful attacks that cost HP</small>
                </div>
                <div class="character-option" data-class="necromancer">
                    <div class="character-icon">💀</div>
                    <div>Necromancer</div>
                    <small>Poison and undead minions</small>
                </div>
            </div>
            
            <button class="btn" id="start-game-btn">Begin Ritual</button>
        </div>
        
        <div class="modal" id="reward-modal" style="display: none;">
            <h2>VICTORY!</h2>
            <p>You banished the demon!</p>
            <p>Choose a cursed card to add to your deck:</p>
            <div id="reward-choices">
                <!-- Card rewards will be added here -->
            </div>
            <button class="btn" id="take-reward-btn" style="margin-top: 20px;">Continue</button>
        </div>
        
        <div class="modal" id="game-over-modal" style="display: none;">
            <h2>DEMON'S EMBRACE</h2>
            <p>You were consumed by darkness...</p>
            <button class="btn" id="restart-btn">Try Again</button>
        </div>
        
        <div class="modal" id="achievements-modal" style="display: none;">
            <h2>OCCULT KNOWLEDGE</h2>
            <div id="achievements-list">
                <!-- Achievements will be added here -->
            </div>
            <button class="btn" id="close-achievements-btn" style="margin-top: 20px;">Close</button>
        </div>
        
        <div class="modal" id="shop-modal" style="display: none;">
            <h2>BLACK MARKET</h2>
            <p>Soul Fragments: <span id="shop-gold-display">0</span></p>
            <div id="shop-items">
                <!-- Shop items will be added here -->
            </div>
            <button class="btn" id="close-shop-btn" style="margin-top: 20px;">Leave</button>
        </div>
        
        <div class="modal" id="event-modal" style="display: none;">
            <h2 id="event-title">ENCOUNTER</h2>
            <p id="event-description"></p>
            <div id="event-options">
                <!-- Event options will be added here -->
            </div>
        </div>
    </div>
    
    <div class="card-tooltip" id="card-tooltip"></div>
    
    <script>
        // Game state
        const gameState = {
            player: {
                class: "occultist",
                maxHp: 30,
                hp: 30,
                maxEnergy: 3,
                energy: 3,
                block: 0,
                deck: [],
                discard: [],
                hand: [],
                drawPile: [],
                gold: 50,
                achievements: {},
                cardsPlayedTotal: 0,
                enemiesDefeated: 0,
                highestFloor: 1,
                damageDealt: 0,
                goldSpent: 0,
                perfectVictories: 0,
                demonsBanished: 0,
                statusEffects: {},
                relics: [],
                storyFlags: {}
            },
            enemy: {
                name: "Ghoul",
                maxHp: 15,
                hp: 15,
                block: 0,
                intent: "attack",
                intentValue: 5,
                statusEffects: {}
            },
            floor: 1,
            turn: 0,
            selectedCard: null,
            cardsPlayedThisTurn: 0,
            selectedReward: null,
            currentCombatDamageTaken: 0,
            shopInventory: [],
            lastSave: Date.now()
        };
        
        // Create floating particles
        function createParticles() {
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const size = Math.random() * 5 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                document.body.appendChild(particle);
            }
        }
        
        // Show blood effect
        function showBloodEffect() {
            const blood = document.getElementById('blood-splatter');
            blood.style.opacity = '0.7';
            setTimeout(() => {
                blood.style.opacity = '0';
            }, 1000);
        }
        
        // Show damage number
        function showDamageNumber(amount, x, y, isPlayer) {
            const damageNumber = document.createElement('div');
            damageNumber.className = 'damage-number';
            damageNumber.textContent = amount;
            damageNumber.style.left = `${x}px`;
            damageNumber.style.top = `${y}px`;
            damageNumber.style.color = isPlayer ? '#00ff00' : '#ff0000';
            document.body.appendChild(damageNumber);
            
            setTimeout(() => {
                damageNumber.remove();
            }, 1000);
        }
        
        // Screen shake effect
        function screenShake(intensity = 10) {
            const gameContainer = document.getElementById('game-container');
            gameContainer.classList.add('screen-shake');
            gameContainer.style.animationDuration = `${intensity/20}s`;
            
            setTimeout(() => {
                gameContainer.classList.remove('screen-shake');
            }, 500);
        }
        
        // Enemy death animation
        function playEnemyDeathAnimation() {
            const enemy = document.getElementById('enemy');
            enemy.classList.add('enemy-death');
            
            setTimeout(() => {
                enemy.classList.remove('enemy-death');
            }, 1000);
        }
        
        // Status effects database
        const statusEffects = {
            poison: {
                name: "Poison",
                description: "Take damage at start of turn",
                icon: "☠️",
                color: "status-poison",
                onTurnStart: (target) => {
                    const damage = target.statusEffects.poison.stacks;
                    target.hp = Math.max(0, target.hp - damage);
                    if (target === gameState.player) {
                        showNotification(`You took ${damage} poison damage!`);
                        showBloodEffect();
                    } else {
                        showNotification(`Demon took ${damage} poison damage!`);
                        const enemyElement = document.getElementById('enemy');
                        const rect = enemyElement.getBoundingClientRect();
                        showDamageNumber(damage, rect.left + rect.width/2, rect.top + rect.height/2, false);
                    }
                    target.statusEffects.poison.stacks--;
                    if (target.statusEffects.poison.stacks <= 0) {
                        delete target.statusEffects.poison;
                    }
                }
            },
            weak: {
                name: "Weak",
                description: "Deal 25% less damage",
                icon: "💢",
                color: "status-weak",
                damageModifier: 0.75
            },
            vulnerable: {
                name: "Vulnerable",
                description: "Take 50% more damage",
                icon: "🎯",
                color: "status-vulnerable",
                damageTakenModifier: 1.5
            },
            strength: {
                name: "Strength",
                description: "Deal more damage",
                icon: "💪",
                color: "status-strength",
                damageModifier: (stacks) => 1 + (0.25 * stacks)
            }
        };
        
        // Card database with rarities (updated for horror theme)
        const cardDatabase = [
            // Common cards
            { id: "dark_strike", name: "Dark Strike", cost: 1, description: "Deal 5 damage", type: "attack", effect: { damage: 5 }, rarity: "common" },
            { id: "shadow_ward", name: "Shadow Ward", cost: 1, description: "Gain 5 Block", type: "skill", effect: { block: 5 }, rarity: "common" },
            { id: "blood_dagger", name: "Blood Dagger", cost: 0, description: "Deal 3 damage", type: "attack", effect: { damage: 3 }, rarity: "common" },
            { id: "bone_shield", name: "Bone Shield", cost: 1, description: "Gain 7 Block", type: "skill", effect: { block: 7 }, rarity: "common" },
            
            // Uncommon cards
            { id: "soul_rend", name: "Soul Rend", cost: 2, description: "Deal 8 damage", type: "attack", effect: { damage: 8 }, rarity: "uncommon" },
            { id: "dark_ritual", name: "Dark Ritual", cost: 1, description: "Heal 4 HP", type: "skill", effect: { heal: 4 }, rarity: "uncommon" },
            { id: "occult_prep", name: "Occult Prep", cost: 0, description: "Draw 1 card. Gain 1 Energy", type: "skill", effect: { draw: 1, energy: 1 }, rarity: "uncommon" },
            { id: "spectral_claw", name: "Spectral Claw", cost: 1, description: "Gain 3 Block. Deal 3 damage", type: "skill", effect: { block: 3, damage: 3 }, rarity: "uncommon" },
            { id: "venomous_curse", name: "Venomous Curse", cost: 1, description: "Apply 2 Poison", type: "attack", effect: { status: { poison: 2 } }, rarity: "uncommon", cardClass: "poison" },
            { id: "hellfire", name: "Hellfire", cost: 2, description: "Deal 8 damage. Apply 1 Weak", type: "attack", effect: { damage: 8, status: { weak: 1 } }, rarity: "uncommon", cardClass: "fire" },
            
            // Rare cards
            { id: "inferno", name: "Inferno", cost: 2, description: "Deal 10 damage", type: "attack", effect: { damage: 10 }, rarity: "rare", cardClass: "fire" },
            { id: "twin_fangs", name: "Twin Fangs", cost: 1, description: "Deal 3 damage twice", type: "attack", effect: { damage: 3, hits: 2 }, rarity: "rare" },
            { id: "necrotic_wave", name: "Necrotic Wave", cost: 2, description: "Deal 4 damage to all enemies", type: "attack", effect: { damage: 4, aoe: true }, rarity: "rare" },
            { id: "demonic_ward", name: "Demonic Ward", cost: 2, description: "Gain 12 Block", type: "skill", effect: { block: 12 }, rarity: "rare" },
            { id: "plague_wind", name: "Plague Wind", cost: 2, description: "Apply 3 Poison to all enemies", type: "skill", effect: { status: { poison: 3 }, aoe: true }, rarity: "rare", cardClass: "poison" },
            { id: "frostbite", name: "Frostbite", cost: 1, description: "Deal 4 damage. Apply 1 Vulnerable", type: "attack", effect: { damage: 4, status: { vulnerable: 1 } }, rarity: "rare", cardClass: "ice" },
            
            // Epic cards
            { id: "abyssal_strike", name: "Abyssal Strike", cost: 3, description: "Deal 15 damage", type: "attack", effect: { damage: 15 }, rarity: "epic" },
            { id: "vampiric_embrace", name: "Vampiric Embrace", cost: 2, description: "Heal 8 HP", type: "skill", effect: { heal: 8 }, rarity: "epic" },
            { id: "demonic_fury", name: "Demonic Fury", cost: 0, description: "Gain 2 Energy this turn", type: "skill", effect: { energy: 2 }, rarity: "epic" },
            { id: "soul_drain", name: "Soul Drain", cost: 1, description: "Deal 6 damage. Heal 3 HP", type: "attack", effect: { damage: 6, heal: 3 }, rarity: "epic" },
            { id: "viper_bite", name: "Viper Bite", cost: 1, description: "Deal 3 damage. Apply 4 Poison", type: "attack", effect: { damage: 3, status: { poison: 4 } }, rarity: "epic", cardClass: "poison" },
            { id: "infernal_torment", name: "Infernal Torment", cost: 3, description: "Deal 8 damage to all enemies. Apply 2 Weak", type: "attack", effect: { damage: 8, status: { weak: 2 }, aoe: true }, rarity: "epic", cardClass: "fire" },
            
            // Legendary cards
            { id: "apocalypse", name: "Apocalypse", cost: 4, description: "Deal 25 damage", type: "attack", effect: { damage: 25 }, rarity: "legendary", cardClass: "fire" },
            { id: "immortality", name: "Immortality", cost: 3, description: "Gain 20 Block. Heal 10 HP", type: "skill", effect: { block: 20, heal: 10 }, rarity: "legendary" },
            { id: "time_distortion", name: "Time Distortion", cost: 3, description: "Take an extra turn", type: "skill", effect: { extraTurn: true }, rarity: "legendary" },
            { id: "black_death", name: "Black Death", cost: 3, description: "Apply 5 Poison to all enemies", type: "skill", effect: { status: { poison: 5 }, aoe: true }, rarity: "legendary", cardClass: "poison" },
            { id: "void_chill", name: "Void Chill", cost: 4, description: "Deal 15 damage. Apply 3 Vulnerable", type: "attack", effect: { damage: 15, status: { vulnerable: 3 } }, rarity: "legendary", cardClass: "ice" },
            
            // Class-specific cards
            { id: "blood_sacrifice", name: "Blood Sacrifice", cost: 0, description: "Lose 3 HP. Gain 2 Energy", type: "skill", effect: { damageSelf: 3, energy: 2 }, rarity: "uncommon", class: "bloodmage" },
            { id: "hemorrhage", name: "Hemorrhage", cost: 1, description: "Lose 5 HP. Deal 12 damage", type: "attack", effect: { damageSelf: 5, damage: 12 }, rarity: "rare", class: "bloodmage" },
            { id: "summon_ghoul", name: "Summon Ghoul", cost: 2, description: "Summon a 10 HP Ghoul to fight for you", type: "skill", effect: { summon: "ghoul" }, rarity: "uncommon", class: "necromancer" },
            { id: "necrotic_blast", name: "Necrotic Blast", cost: 1, description: "Deal 3 damage + 1 per Poison on enemy", type: "attack", effect: { damage: { base: 3, perPoison: 1 } }, rarity: "common", class: "necromancer" }
        ];
        
        // Enemy database (updated for horror theme)
        const enemyDatabase = [
            { name: "Ghoul", maxHp: 15, actions: [
                { intent: "attack", value: 5, weight: 3 },
                { intent: "block", value: 4, weight: 1 }
            ]},
            { name: "Wraith", maxHp: 20, actions: [
                { intent: "attack", value: 6, weight: 2 },
                { intent: "attack", value: 8, weight: 1 }
            ]},
            { name: "Slime", maxHp: 12, actions: [
                { intent: "attack", value: 3, weight: 2 },
                { intent: "block", value: 6, weight: 1 },
                { intent: "debuff", value: 1, weight: 1 }
            ]},
            { name: "Cultist", maxHp: 18, actions: [
                { intent: "attack", value: 7, weight: 2 },
                { intent: "block", value: 5, weight: 1 }
            ]},
            { name: "Archdemon", maxHp: 50, actions: [
                { intent: "attack", value: 15, weight: 1 },
                { intent: "attack", value: 10, weight: 2 }
            ]},
            { name: "Toxic Horror", maxHp: 25, actions: [
                { intent: "attack", value: 4, weight: 2 },
                { intent: "status", value: { poison: 2 }, weight: 2 }
            ]},
            { name: "Hellspawn", maxHp: 30, actions: [
                { intent: "attack", value: 8, weight: 2 },
                { intent: "status", value: { weak: 1 }, weight: 1 }
            ]}
        ];
        
        // Relics database (updated for horror theme)
        const relicsDatabase = [
            { id: "soul_crystal", name: "Soul Crystal", description: "Gain +1 Max Energy", price: 150, effect: (game) => { game.player.maxEnergy++; } },
            { id: "vial_of_venom", name: "Vial of Venom", description: "Start each combat with 3 Poison applied to enemy", price: 100, effect: (game) => { 
                game.player.relics.push("vial_of_venom");
            } },
            { id: "hellfire_ember", name: "Hellfire Ember", description: "Your Fire cards deal +2 damage", price: 120, effect: (game) => {
                game.player.relics.push("hellfire_ember");
            } },
            { id: "frost_shard", name: "Frost Shard", description: "Your Ice cards apply +1 Vulnerable", price: 110, effect: (game) => {
                game.player.relics.push("frost_shard");
            } },
            { id: "blood_vial", name: "Blood Vial", description: "Heal 10 HP immediately", price: 50, effect: (game) => {
                game.player.hp = Math.min(game.player.hp + 10, game.player.maxHp);
            }, consumable: true },
            { id: "bloodstone", name: "Bloodstone", description: "Blood Mage cards cost 1 less HP to use", price: 120, effect: (game) => {
                game.player.relics.push("bloodstone");
            }, class: "bloodmage" },
            { id: "necronomicon", name: "Necronomicon", description: "Your first attack each turn is played twice", price: 200, effect: (game) => {
                game.player.relics.push("necronomicon");
            }, class: "necromancer" }
        ];
        
        // Achievements database (updated for horror theme)
        const achievementsDatabase = [
            { id: "first_blood", title: "First Blood", description: "Defeat your first demon", icon: "💉", condition: (game) => game.player.enemiesDefeated >= 1, reward: { gold: 25 } },
            { id: "card_shark", title: "Cursed Hand", description: "Play 50 cards", icon: "🃏", condition: (game) => game.player.cardsPlayedTotal >= 50, reward: { card: "occult_prep" } },
            { id: "floor_5", title: "Abyss Explorer", description: "Reach floor 5", icon: "🏰", condition: (game) => game.floor >= 5, reward: { gold: 50, maxHp: 5 } },
            { id: "big_spender", title: "Soul Trader", description: "Spend 200 soul fragments", icon: "💰", condition: (game) => game.player.goldSpent >= 200, reward: { gold: 100 } },
            { id: "perfect_victory", title: "Flawless Banishing", description: "Defeat a demon without taking damage", icon: "✨", condition: (game) => game.player.perfectVictories >= 1, reward: { card: "soul_drain" } },
            { id: "deck_master", title: "Grimoire Master", description: "Have a deck with 30+ cards", icon: "📜", condition: (game) => game.player.deck.length >= 30, reward: { maxEnergy: 1 } },
            { id: "demon_slayer", title: "Demon Slayer", description: "Defeat the Archdemon", icon: "👹", condition: (game) => game.player.demonsBanished >= 1, reward: { card: "apocalypse" } },
            { id: "toxic_avenger", title: "Plague Bringer", description: "Defeat 5 enemies with poison", icon: "☠️", condition: (game) => game.player.achievements.toxic_avenger?.progress >= 5, reward: { card: "black_death" } },
            { id: "fire_master", title: "Hellfire Master", description: "Deal 100 damage with Hellfire cards", icon: "🔥", condition: (game) => game.player.achievements.fire_master?.progress >= 100, reward: { card: "infernal_torment" } },
            { id: "blood_ritual", title: "Blood Ritual", description: "Deal 50 damage with Blood Mage cards", icon: "🩸", condition: (game) => game.player.achievements.blood_ritual?.progress >= 50, reward: { card: "hemorrhage" } },
            { id: "undead_army", title: "Undead Army", description: "Summon 10 Ghouls", icon: "💀", condition: (game) => game.player.achievements.undead_army?.progress >= 10, reward: { card: "summon_ghoul" } }
        ];
        
        // Event database
        const eventDatabase = [
            {
                id: "cursed_shrine",
                title: "Cursed Shrine",
                description: "You find an ancient shrine pulsating with dark energy. A whispering voice offers power... for a price.",
                options: [
                    {
                        text: "Gain 1 Max Energy (Lose 10 Max HP)",
                        effect: (game) => {
                            game.player.maxEnergy += 1;
                            game.player.maxHp = Math.max(10, game.player.maxHp - 10);
                            game.player.hp = Math.min(game.player.hp, game.player.maxHp);
                            showNotification("Energy surges through you, but you feel weaker...");
                        }
                    },
                    {
                        text: "Gain 10 Max HP (Lose 1 Max Energy)",
                        effect: (game) => {
                            game.player.maxHp += 10;
                            game.player.maxEnergy = Math.max(1, game.player.maxEnergy - 1);
                            showNotification("Your body feels stronger, but your connection to the arcane weakens...");
                        }
                    },
                    {
                        text: "Leave it alone",
                        effect: (game) => {
                            showNotification("You wisely avoid meddling with dark forces.");
                        }
                    }
                ]
            },
            {
                id: "wounded_adventurer",
                title: "Wounded Adventurer",
                description: "A fellow demon hunter lies bleeding. You recognize them as a rival from your order.",
                options: [
                    {
                        text: "Heal them (Lose 15 HP)",
                        effect: (game) => {
                            if (game.player.hp > 15) {
                                game.player.hp -= 15;
                                game.player.gold += 75;
                                showNotification("They thank you and give you 75 soul fragments before vanishing.");
                            } else {
                                showNotification("You don't have enough health to help them.");
                            }
                        }
                    },
                    {
                        text: "Rob them",
                        effect: (game) => {
                            game.player.gold += 50;
                            game.player.storyFlags.stoleFromWounded = true;
                            showNotification("You take their pouch of soul fragments. They curse you with their dying breath.");
                        }
                    },
                    {
                        text: "Put them out of their misery",
                        effect: (game) => {
                            game.player.maxHp += 5;
                            showNotification("You end their suffering and feel a dark energy empower you.");
                        }
                    }
                ]
            },
            {
                id: "mysterious_merchant",
                title: "Mysterious Merchant",
                description: "A hooded figure offers to modify one of your cards for 50 soul fragments.",
                options: [
                    {
                        text: "Upgrade a random card (-50 gold)",
                        effect: (game) => {
                            if (game.player.gold >= 50) {
                                game.player.gold -= 50;
                                const upgradableCards = game.player.deck.filter(c => c.rarity !== "legendary");
                                if (upgradableCards.length > 0) {
                                    const card = upgradableCards[Math.floor(Math.random() * upgradableCards.length)];
                                    if (card.effect.damage) card.effect.damage += 2;
                                    if (card.effect.block) card.effect.block += 3;
                                    if (card.effect.heal) card.effect.heal += 2;
                                    showNotification(`${card.name} has been empowered!`);
                                } else {
                                    showNotification("No cards available to upgrade");
                                    game.player.gold += 50;
                                }
                            } else {
                                showNotification("Not enough soul fragments!");
                            }
                        }
                    },
                    {
                        text: "Remove a random card (-30 gold)",
                        effect: (game) => {
                            if (game.player.gold >= 30 && game.player.deck.length > 5) {
                                game.player.gold -= 30;
                                const cardIndex = Math.floor(Math.random() * game.player.deck.length);
                                const removedCard = game.player.deck.splice(cardIndex, 1)[0];
                                showNotification(`Removed ${removedCard.name} from your deck`);
                            } else if (game.player.deck.length <= 5) {
                                showNotification("Your deck is too small to remove cards");
                            } else {
                                showNotification("Not enough soul fragments!");
                            }
                        }
                    },
                    {
                        text: "Decline their offer",
                        effect: (game) => {
                            showNotification("You decide to keep your deck as it is.");
                        }
                    }
                ]
            }
        ];
        
        // Initialize game
        function initGame() {
            // Create particles
            createParticles();
            
            // Initialize player achievements
            achievementsDatabase.forEach(ach => {
                if (!gameState.player.achievements[ach.id]) {
                    gameState.player.achievements[ach.id] = {
                        unlocked: false,
                        progress: 0
                    };
                }
            });
            
            // Create starter deck based on class
            createStarterDeck();
            
            // Initialize player stats
            gameState.player.goldSpent = 0;
            gameState.player.perfectVictories = 0;
            gameState.player.demonsBanished = 0;
            gameState.currentCombatDamageTaken = 0;
            gameState.player.statusEffects = {};
            gameState.player.relics = [];
            gameState.player.storyFlags = {};
            
            // Generate initial shop inventory
            generateShopInventory();
            
            // Shuffle deck
            shuffleDeck();
            
            // Set initial draw pile
            gameState.player.drawPile = [...gameState.player.deck];
            
            // Draw initial hand
            drawCards(5);
            
            // Update UI
            updateUI();
            
            // Set enemy intent
            setEnemyIntent();
            
            // Show start screen
            showStartScreen();
            
            // Initialize auto-save
            setInterval(autoSave, 30000); // Save every 30 seconds
        }
        
        // Create starter deck based on selected class
        function createStarterDeck() {
            gameState.player.deck = [];
            
            // Common cards for all classes
            const commonCards = [
                { ...findCardById("dark_strike") }, { ...findCardById("dark_strike") },
                { ...findCardById("shadow_ward") }, { ...findCardById("shadow_ward") }
            ];
            
            // Class-specific cards
            let classCards = [];
            switch(gameState.player.class) {
                case "bloodmage":
                    classCards = [
                        { ...findCardById("blood_dagger") }, { ...findCardById("blood_dagger") },
                        { ...findCardById("blood_sacrifice") }, { ...findCardById("soul_rend") }
                    ];
                    gameState.player.maxHp = 40; // Blood Mages have more HP to offset self-damage
                    gameState.player.hp = 40;
                    break;
                case "necromancer":
                    classCards = [
                        { ...findCardById("venomous_curse") }, { ...findCardById("venomous_curse") },
                        { ...findCardById("necrotic_blast") }, { ...findCardById("summon_ghoul") }
                    ];
                    break;
                default: // Occultist
                    classCards = [
                        { ...findCardById("dark_strike") }, { ...findCardById("shadow_ward") },
                        { ...findCardById("soul_rend") }, { ...findCardById("dark_ritual") }
                    ];
            }
            
            gameState.player.deck = [...commonCards, ...classCards];
        }
        
        // Find card by ID
        function findCardById(id) {
            return cardDatabase.find(card => card.id === id);
        }
        
        // Find relic by ID
        function findRelicById(id) {
            return relicsDatabase.find(relic => relic.id === id);
        }
        
        // Shuffle deck
        function shuffleDeck() {
            for (let i = gameState.player.deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [gameState.player.deck[i], gameState.player.deck[j]] = [gameState.player.deck[j], gameState.player.deck[i]];
            }
        }
        
        // Draw cards
        function drawCards(count) {
            for (let i = 0; i < count; i++) {
                if (gameState.player.drawPile.length === 0) {
                    if (gameState.player.discard.length === 0) break;
                    
                    // Reshuffle discard into draw pile
                    gameState.player.drawPile = [...gameState.player.discard];
                    gameState.player.discard = [];
                    shuffleDeck();
                    showNotification("Deck reshuffled!");
                }
                
                const card = gameState.player.drawPile.pop();
                gameState.player.hand.push(card);
            }
            
            updateUI();
        }
        
        // Play card
        function playCard(cardIndex) {
            const card = gameState.player.hand[cardIndex];
            
            if (!card) return;
            if (gameState.player.energy < card.cost) return;
            
            gameState.selectedCard = card;
            
            // Deduct energy
            gameState.player.energy -= card.cost;
            
            // Track cards played
            gameState.player.cardsPlayedTotal++;
            
            // Apply card effect
            applyCardEffect(card);
            
            // Move card to discard
            gameState.player.hand.splice(cardIndex, 1);
            gameState.player.discard.push(card);
            
            gameState.cardsPlayedThisTurn++;
            gameState.selectedCard = null;
            
            // Check achievements
            checkAchievements();
            
            updateUI();
        }
        
        // Apply card effect
        function applyCardEffect(card) {
            const effect = card.effect;
            let damageModifier = 1;
            
            // Apply status effect modifiers
            if (gameState.player.statusEffects.weak) {
                damageModifier *= statusEffects.weak.damageModifier;
            }
            
            if (gameState.player.statusEffects.strength) {
                damageModifier *= statusEffects.strength.damageModifier(gameState.player.statusEffects.strength.stacks);
            }
            
            // Apply relic effects
            if (gameState.player.relics.includes("hellfire_ember") && card.cardClass === "fire") {
                effect.damage = (effect.damage || 0) + 2;
            }
            
            // Handle self-damage for Blood Mage cards
            if (effect.damageSelf) {
                dealDamageToPlayer(effect.damageSelf);
                showNotification(`You sacrificed ${effect.damageSelf} HP!`);
            }
            
            // Handle summon effects
            if (effect.summon) {
                if (effect.summon === "ghoul") {
                    // In a full game, this would summon a minion to fight for you
                    showNotification("A ghoul joins your side!");
                    
                    // Track for achievement
                    const progress = gameState.player.achievements.undead_army?.progress || 0;
                    gameState.player.achievements.undead_army = {
                        ...gameState.player.achievements.undead_army,
                        progress: progress + 1
                    };
                }
            }
            
            // Handle dynamic damage (like Necrotic Blast)
            if (effect.damage && typeof effect.damage === 'object') {
                let damage = effect.damage.base || 0;
                if (effect.damage.perPoison && gameState.enemy.statusEffects.poison) {
                    damage += effect.damage.perPoison * gameState.enemy.statusEffects.poison.stacks;
                }
                effect.damage = damage;
            }
            
            if (effect.damage) {
                let totalDamage = Math.floor(effect.damage * damageModifier);
                
                // Apply vulnerable if enemy has it
                if (gameState.enemy.statusEffects.vulnerable) {
                    totalDamage = Math.floor(totalDamage * statusEffects.vulnerable.damageTakenModifier);
                }
                
                if (effect.hits) {
                    totalDamage = totalDamage * effect.hits;
                }
                
                if (effect.aoe) {
                    // For area effects, we'd hit all enemies in a real game
                    dealDamageToEnemy(totalDamage);
                } else {
                    dealDamageToEnemy(totalDamage);
                }
                
                gameState.player.damageDealt += totalDamage;
                
                // Track fire damage for achievement
                if (card.cardClass === "fire") {
                    const progress = gameState.player.achievements.fire_master?.progress || 0;
                    gameState.player.achievements.fire_master = {
                        ...gameState.player.achievements.fire_master,
                        progress: progress + totalDamage
                    };
                }
                
                // Track blood mage damage for achievement
                if (gameState.player.class === "bloodmage") {
                    const progress = gameState.player.achievements.blood_ritual?.progress || 0;
                    gameState.player.achievements.blood_ritual = {
                        ...gameState.player.achievements.blood_ritual,
                        progress: progress + totalDamage
                    };
                }
            }
            
            if (effect.block) {
                gameState.player.block += effect.block;
            }
            
            if (effect.heal) {
                gameState.player.hp = Math.min(gameState.player.hp + effect.heal, gameState.player.maxHp);
            }
            
            if (effect.draw) {
                drawCards(effect.draw);
            }
            
            if (effect.energy) {
                gameState.player.energy = Math.min(gameState.player.energy + effect.energy, gameState.player.maxEnergy);
            }
            
            if (effect.status) {
                applyStatusEffects(effect.status, gameState.enemy);
            }
            
            if (effect.extraTurn) {
                gameState.player.extraTurns = (gameState.player.extraTurns || 0) + 1;
            }
            
            updateUI();
        }
        
        // Apply status effects
        function applyStatusEffects(statusEffectsObj, target) {
            for (const [status, stacks] of Object.entries(statusEffectsObj)) {
                if (!target.statusEffects[status]) {
                    target.statusEffects[status] = { stacks: 0 };
                }
                target.statusEffects[status].stacks += stacks;
                
                // Apply relic effects
                if (status === "vulnerable" && gameState.player.relics.includes("frost_shard")) {
                    target.statusEffects[status].stacks += 1;
                }
                
                showNotification(`Applied ${stacks} ${status} to ${target === gameState.player ? "yourself" : "enemy"}`);
            }
            updateUI();
        }
        
        // Deal damage to enemy
        function dealDamageToEnemy(amount) {
            if (gameState.enemy.block > 0) {
                const blocked = Math.min(gameState.enemy.block, amount);
                gameState.enemy.block -= blocked;
                amount -= blocked;
                
                if (amount <= 0) return;
            }
            
            gameState.enemy.hp = Math.max(0, gameState.enemy.hp - amount);
            
            // Show damage number
            const enemyElement = document.getElementById('enemy');
            const rect = enemyElement.getBoundingClientRect();
            showDamageNumber(amount, rect.left + rect.width/2, rect.top + rect.height/2, false);
            
            // Screen shake for big hits
            if (amount >= 10) {
                screenShake(amount);
            }
            
            // Check if enemy is defeated
            if (gameState.enemy.hp <= 0) {
                enemyDefeated();
            }
            
            updateUI();
        }
        
        // Enemy defeated
        function enemyDefeated() {
            // Play death animation
            playEnemyDeathAnimation();
            
            // Track enemy defeat
            gameState.player.enemiesDefeated++;
            
            // Check for toxic avenger achievement
            if (gameState.enemy.statusEffects.poison) {
                const progress = (gameState.player.achievements.toxic_avenger?.progress || 0) + 1;
                gameState.player.achievements.toxic_avenger = {
                    ...gameState.player.achievements.toxic_avenger,
                    progress
                };
            }
            
            if (gameState.enemy.name === "Archdemon") {
                gameState.player.demonsBanished++;
            }
            
            // Check for perfect victory (no damage taken this combat)
            if (gameState.currentCombatDamageTaken === 0) {
                gameState.player.perfectVictories++;
                showNotification("Flawless Banishing! No damage taken this fight!");
            }
            
            // Reset combat damage tracker
            gameState.currentCombatDamageTaken = 0;
            
            // Update highest floor
            if (gameState.floor > gameState.player.highestFloor) {
                gameState.player.highestFloor = gameState.floor;
            }
            
            // Check achievements
            checkAchievements();
            
            // Show reward screen
            setTimeout(() => {
                // 30% chance for an event between floors
                if (Math.random() < 0.3 && gameState.floor % 5 !== 0) {
                    showRandomEvent();
                } else {
                    showRewardScreen();
                }
            }, 1000);
        }
        
        // End player turn
        function endPlayerTurn() {
            // Discard hand
            gameState.player.discard = gameState.player.discard.concat(gameState.player.hand);
            gameState.player.hand = [];
            
            // Process status effects at start of enemy turn
            processStatusEffects(gameState.player, "player");
            
            // Enemy turn
            enemyTurn();
            
            // Check for extra turns
            if (gameState.player.extraTurns && gameState.player.extraTurns > 0) {
                gameState.player.extraTurns--;
                startPlayerTurn();
            } else {
                // Start new player turn
                startPlayerTurn();
            }
            
            updateUI();
        }
        
        // Process status effects
        function processStatusEffects(target, targetType) {
            for (const [status, data] of Object.entries(target.statusEffects)) {
                if (statusEffects[status].onTurnStart) {
                    statusEffects[status].onTurnStart(target);
                }
                
                // Decrement duration for timed status effects
                if (data.duration) {
                    data.duration--;
                    if (data.duration <= 0) {
                        delete target.statusEffects[status];
                        showNotification(`${status} wore off from ${targetType === "player" ? "you" : "enemy"}`);
                    }
                }
            }
        }
        
        // Enemy turn
        function enemyTurn() {
            // Execute enemy intent
            switch (gameState.enemy.intent) {
                case "attack":
                    let damage = gameState.enemy.intentValue;
                    
                    // Apply vulnerable if player has it
                    if (gameState.player.statusEffects.vulnerable) {
                        damage = Math.floor(damage * statusEffects.vulnerable.damageTakenModifier);
                    }
                    
                    dealDamageToPlayer(damage);
                    break;
                case "block":
                    gameState.enemy.block += gameState.enemy.intentValue;
                    break;
                case "debuff":
                    gameState.player.maxEnergy = Math.max(1, gameState.player.maxEnergy - gameState.enemy.intentValue);
                    showNotification(`Demon reduced your max energy by ${gameState.enemy.intentValue}!`);
                    break;
                case "status":
                    applyStatusEffects(gameState.enemy.intentValue, gameState.player);
                    break;
            }
            
            // Process status effects at start of player turn
            processStatusEffects(gameState.enemy, "enemy");
            
            // Set new intent for next turn
            setEnemyIntent();
        }
        
        // Deal damage to player
        function dealDamageToPlayer(amount) {
            if (gameState.player.block > 0) {
                const blocked = Math.min(gameState.player.block, amount);
                gameState.player.block -= blocked;
                amount -= blocked;
                
                if (amount <= 0) {
                    showNotification(`Blocked all damage!`);
                    return;
                }
            }
            
            if (amount > 0) {
                gameState.player.hp = Math.max(0, gameState.player.hp - amount);
                gameState.currentCombatDamageTaken += amount;
                showNotification(`You took ${amount} damage!`);
                showBloodEffect();
                
                // Show damage number
                const playerElement = document.getElementById('player-display');
                const rect = playerElement.getBoundingClientRect();
                showDamageNumber(amount, rect.left + rect.width/2, rect.top + rect.height/2, true);
                
                // Screen shake for big hits
                if (amount >= 10) {
                    screenShake(amount);
                }
            }
            
            // Check if player is defeated
            if (gameState.player.hp <= 0) {
                gameOver();
            }
            
            updateUI();
        }
        
        // Start player turn
        function startPlayerTurn() {
            gameState.turn++;
            gameState.player.energy = gameState.player.maxEnergy;
            gameState.cardsPlayedThisTurn = 0;
            gameState.player.block = 0;
            
            // Apply relic effects at start of combat
            if (gameState.turn === 1) {
                if (gameState.player.relics.includes("vial_of_venom")) {
                    applyStatusEffects({ poison: 3 }, gameState.enemy);
                }
                
                // Show story intro for floor 5
                if (gameState.floor === 5) {
                    showNotification("A powerful presence approaches... The Archdemon awakens!");
                }
            }
            
            // Draw new hand
            drawCards(5);
        }
        
        // Set enemy intent
        function setEnemyIntent() {
            const enemyType = enemyDatabase.find(e => e.name === gameState.enemy.name);
            if (!enemyType) return;
            
            // Calculate weighted random intent
            const totalWeight = enemyType.actions.reduce((sum, action) => sum + action.weight, 0);
            let random = Math.random() * totalWeight;
            let selectedAction = null;
            
            for (const action of enemyType.actions) {
                random -= action.weight;
                if (random <= 0) {
                    selectedAction = action;
                    break;
                }
            }
            
            if (selectedAction) {
                gameState.enemy.intent = selectedAction.intent;
                gameState.enemy.intentValue = selectedAction.value;
            }
        }
        
        // Generate shop inventory
        function generateShopInventory() {
            gameState.shopInventory = [];
            const availableRarities = ["common", "uncommon"];
            if (gameState.floor >= 3) availableRarities.push("rare");
            if (gameState.floor >= 5) availableRarities.push("epic");
            
            // Add 3 random cards (including class-specific ones)
            const eligibleCards = cardDatabase.filter(card => 
                availableRarities.includes(card.rarity) && 
                !card.class || card.class === gameState.player.class);
            
            for (let i = 0; i < 3; i++) {
                if (eligibleCards.length > 0) {
                    const randomCard = eligibleCards[Math.floor(Math.random() * eligibleCards.length)];
                    gameState.shopInventory.push({
                        type: "card",
                        id: randomCard.id,
                        price: getCardPrice(randomCard)
                    });
                }
            }
            
            // Add 1-2 relics (including class-specific ones)
            const availableRelics = relicsDatabase.filter(relic => 
                !gameState.player.relics.includes(relic.id) && 
                !gameState.shopInventory.some(item => item.id === relic.id) &&
                (!relic.class || relic.class === gameState.player.class));
            
            const relicCount = 1 + Math.floor(Math.random());
            for (let i = 0; i < relicCount && availableRelics.length > 0; i++) {
                const randomRelic = availableRelics[Math.floor(Math.random() * availableRelics.length)];
                gameState.shopInventory.push({
                    type: "relic",
                    id: randomRelic.id,
                    price: randomRelic.price
                });
            }
            
            // Add health potion
            gameState.shopInventory.push({
                type: "potion",
                id: "blood_vial",
                price: 50
            });
        }
        
        // Show start screen
        function showStartScreen() {
            document.getElementById('screen-overlay').style.display = 'flex';
            document.getElementById('start-modal').style.display = 'block';
            
            // Character selection
            const options = document.querySelectorAll('.character-option');
            options.forEach(option => {
                option.addEventListener('click', function() {
                    options.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.player.class = this.getAttribute('data-class');
                });
            });
            
            // Default selection
            options[0].classList.add('selected');
        }
        
        // Start game
        function startGame() {
            document.getElementById('screen-overlay').style.display = 'none';
            document.getElementById('start-modal').style.display = 'none';
            
            // Create starter deck based on selected class
            createStarterDeck();
            
            // Shuffle deck
            shuffleDeck();
            
            // Set initial draw pile
            gameState.player.drawPile = [...gameState.player.deck];
            
            // Draw initial hand
            drawCards(5);
            
            updateUI();
        }
        
        // Show reward screen
        function showRewardScreen() {
            document.getElementById('screen-overlay').style.display = 'flex';
            document.getElementById('reward-modal').style.display = 'block';
            
            // Generate 3 random card rewards
            const rewardContainer = document.getElementById('reward-choices');
            rewardContainer.innerHTML = '';
            
            // Determine available rarities based on floor progression
            const availableRarities = ["common", "uncommon"];
            if (gameState.floor >= 3) availableRarities.push("rare");
            if (gameState.floor >= 5) availableRarities.push("epic");
            if (gameState.floor >= 7) availableRarities.push("legendary");
            
            // Filter cards by available rarities and exclude starter cards
            const eligibleCards = cardDatabase.filter(card => 
                availableRarities.includes(card.rarity) && 
                !['dark_strike', 'shadow_ward', 'soul_rend', 'blood_dagger'].includes(card.id) &&
                (!card.class || card.class === gameState.player.class));
            
            // Select 3 random cards with weighted rarity distribution
            const rewardCards = [];
            for (let i = 0; i < 3; i++) {
                // Higher floors have better chance for rare cards
                const rarityRoll = Math.random();
                let targetRarity;
                
                if (rarityRoll < 0.05 && availableRarities.includes("legendary")) {
                    targetRarity = "legendary";
                } else if (rarityRoll < 0.2 && availableRarities.includes("epic")) {
                    targetRarity = "epic";
                } else if (rarityRoll < 0.5 && availableRarities.includes("rare")) {
                    targetRarity = "rare";
                } else if (rarityRoll < 0.8) {
                    targetRarity = "uncommon";
                } else {
                    targetRarity = "common";
                }
                
                // Filter cards by target rarity
                const rarityCards = eligibleCards.filter(card => card.rarity === targetRarity);
                
                // If no cards of target rarity, try next lower rarity
                if (rarityCards.length === 0) {
                    const rarityIndex = availableRarities.indexOf(targetRarity);
                    if (rarityIndex > 0) {
                        targetRarity = availableRarities[rarityIndex - 1];
                    }
                }
                
                // Select random card of target rarity
                const finalCards = eligibleCards.filter(card => card.rarity === targetRarity);
                if (finalCards.length > 0) {
                    const randomCard = finalCards[Math.floor(Math.random() * finalCards.length)];
                    if (!rewardCards.some(c => c.id === randomCard.id)) { // Avoid duplicates
                        rewardCards.push(randomCard);
                    } else {
                        // If duplicate, just pick any eligible card
                        rewardCards.push(eligibleCards[Math.floor(Math.random() * eligibleCards.length)]);
                    }
                }
            }
            
            rewardCards.forEach(card => {
                const cardElement = createCardElement(card);
                cardElement.classList.add('card-reward');
                cardElement.onclick = function() {
                    // Remove selected class from all rewards
                    document.querySelectorAll('.card-reward').forEach(el => {
                        el.classList.remove('selected');
                    });
                    // Add selected class to clicked card
                    this.classList.add('selected');
                    gameState.selectedReward = card;
                };
                rewardContainer.appendChild(cardElement);
            });
        }
        
        // Show random event
        function showRandomEvent() {
            const event = eventDatabase[Math.floor(Math.random() * eventDatabase.length)];
            const eventModal = document.getElementById('event-modal');
            
            document.getElementById('screen-overlay').style.display = 'flex';
            eventModal.style.display = 'block';
            
            document.getElementById('event-title').textContent = event.title;
            document.getElementById('event-description').textContent = event.description;
            
            const optionsContainer = document.getElementById('event-options');
            optionsContainer.innerHTML = '';
            
            event.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'event-option';
                optionElement.textContent = option.text;
                optionElement.onclick = function() {
                    option.effect(gameState);
                    eventModal.style.display = 'none';
                    setTimeout(() => {
                        showRewardScreen();
                    }, 500);
                };
                optionsContainer.appendChild(optionElement);
            });
        }
        
        // Show shop screen
        function showShop() {
            document.getElementById('screen-overlay').style.display = 'flex';
            document.getElementById('shop-modal').style.display = 'block';
            document.getElementById('shop-gold-display').textContent = gameState.player.gold;
            
            const shopContainer = document.getElementById('shop-items');
            shopContainer.innerHTML = '';
            
            gameState.shopInventory.forEach(item => {
                let itemElement;
                
                if (item.type === "card") {
                    const card = findCardById(item.id);
                    if (card) {
                        itemElement = document.createElement('div');
                        itemElement.className = 'shop-item';
                        itemElement.innerHTML = `
                            ${createCardElement(card).outerHTML}
                            <div class="shop-item-price">${item.price} Soul Fragments</div>
                            <button class="btn buy-btn" data-type="card" data-id="${card.id}" data-price="${item.price}">Buy</button>
                        `;
                    }
                } else if (item.type === "relic") {
                    const relic = findRelicById(item.id);
                    if (relic) {
                        itemElement = document.createElement('div');
                        itemElement.className = 'shop-item';
                        itemElement.innerHTML = `
                            <div class="card-name">${relic.name}</div>
                            <div class="card-description">${relic.description}</div>
                            <div class="shop-item-price">${relic.price} Soul Fragments</div>
                            <button class="btn buy-btn" data-type="relic" data-id="${relic.id}" data-price="${relic.price}">Buy</button>
                        `;
                    }
                } else if (item.type === "potion") {
                    itemElement = document.createElement('div');
                    itemElement.className = 'shop-item';
                    itemElement.innerHTML = `
                        <div class="card-name">Blood Vial</div>
                        <div class="card-description">Heals 10 HP</div>
                        <div class="shop-item-price">50 Soul Fragments</div>
                        <button class="btn buy-btn" data-type="potion" data-price="50">Buy</button>
                    `;
                }
                
                if (itemElement) {
                    shopContainer.appendChild(itemElement);
                }
            });
            
            // Add event listeners to buy buttons
            document.querySelectorAll('.buy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    const price = parseInt(this.getAttribute('data-price'));
                    const id = this.getAttribute('data-id');
                    
                    if (gameState.player.gold >= price) {
                        gameState.player.gold -= price;
                        gameState.player.goldSpent += price;
                        
                        if (type === "card") {
                            const card = findCardById(id);
                            if (card) {
                                gameState.player.deck.push({ ...card });
                                showNotification(`Added ${card.name} to your deck!`);
                            }
                        } else if (type === "relic") {
                            const relic = findRelicById(id);
                            if (relic) {
                                relic.effect(gameState);
                                showNotification(`Gained ${relic.name}: ${relic.description}`);
                                
                                // Remove relic from shop
                                gameState.shopInventory = gameState.shopInventory.filter(item => item.id !== id);
                            }
                        } else if (type === "potion") {
                            gameState.player.hp = Math.min(gameState.player.hp + 10, gameState.player.maxHp);
                            showNotification("Healed 10 HP!");
                        }
                        
                        // Update UI
                        document.getElementById('shop-gold-display').textContent = gameState.player.gold;
                        this.disabled = true;
                        this.textContent = "Sold";
                        
                        // Check achievements
                        checkAchievements();
                    } else {
                        showNotification("Not enough soul fragments!");
                    }
                });
            });
        }
        
        // Get card price based on rarity
        function getCardPrice(card) {
            switch (card.rarity) {
                case "common": return 30 + Math.floor(Math.random() * 20);
                case "uncommon": return 50 + Math.floor(Math.random() * 30);
                case "rare": return 80 + Math.floor(Math.random() * 40);
                case "epic": return 120 + Math.floor(Math.random() * 50);
                case "legendary": return 200 + Math.floor(Math.random() * 100);
                default: return 50;
            }
        }
        
        // Select reward card
        function selectRewardCard() {
            if (!gameState.selectedReward) {
                showNotification("Please select a card reward!");
                return;
            }
            
            // Add card to deck and draw pile
            const newCard = { ...gameState.selectedReward };
            gameState.player.deck.push(newCard);
            gameState.player.drawPile.push(newCard); // Add to draw pile so it can be drawn immediately
            
            showNotification(`Added ${gameState.selectedReward.name} to your deck!`);
            gameState.selectedReward = null;
            
            // Hide reward screen
            document.getElementById('screen-overlay').style.display = 'none';
            document.getElementById('reward-modal').style.display = 'none';
            
            // Move to next floor
            gameState.floor++;
            
            // Generate new enemy
            generateNewEnemy();
            
            // Generate new shop inventory
            generateShopInventory();
            
            // Start new turn
            startPlayerTurn();
            
            updateUI();
        }
        
        // Generate new enemy
        function generateNewEnemy() {
            // Reset status effects
            gameState.enemy.statusEffects = {};
            gameState.player.statusEffects = {};
            
            // Every 5 floors is a boss fight
            if (gameState.floor % 5 === 0) {
                gameState.enemy = {
                    name: "Archdemon",
                    maxHp: 50 + (gameState.floor * 3),
                    hp: 50 + (gameState.floor * 3),
                    block: 0,
                    intent: "attack",
                    intentValue: 15 + Math.floor(gameState.floor / 2),
                    statusEffects: {}
                };
            } else {
                // Normal enemy with scaling
                const baseEnemy = enemyDatabase[Math.floor(Math.random() * enemyDatabase.length)];
                const hpMultiplier = 1 + (gameState.floor * 0.15);
                const damageMultiplier = 1 + (gameState.floor * 0.1);
                
                gameState.enemy = {
                    name: baseEnemy.name,
                    maxHp: Math.floor(baseEnemy.maxHp * hpMultiplier),
                    hp: Math.floor(baseEnemy.maxHp * hpMultiplier),
                    block: 0,
                    intent: "attack",
                    intentValue: 5 + Math.floor(gameState.floor * damageMultiplier),
                    statusEffects: {}
                };
            }
            
            setEnemyIntent();
            updateUI();
        }
        
        // Game over
        function gameOver() {
            document.getElementById('screen-overlay').style.display = 'flex';
            document.getElementById('game-over-modal').style.display = 'block';
        }
        
        // Restart game
        function restartGame() {
            // Reset game state
            gameState.player = {
                class: gameState.player.class,
                maxHp: 30,
                hp: 30,
                maxEnergy: 3,
                energy: 3,
                block: 0,
                deck: [],
                discard: [],
                hand: [],
                drawPile: [],
                gold: 50,
                achievements: {},
                cardsPlayedTotal: 0,
                enemiesDefeated: 0,
                highestFloor: 1,
                damageDealt: 0,
                goldSpent: 0,
                perfectVictories: 0,
                demonsBanished: 0,
                statusEffects: {},
                relics: [],
                storyFlags: {}
            };
            
            gameState.enemy = {
                name: "Ghoul",
                maxHp: 15,
                hp: 15,
                block: 0,
                intent: "attack",
                intentValue: 5,
                statusEffects: {}
            };
            
            gameState.floor = 1;
            gameState.turn = 0;
            gameState.selectedCard = null;
            gameState.cardsPlayedThisTurn = 0;
            gameState.selectedReward = null;
            gameState.currentCombatDamageTaken = 0;
            
            document.getElementById('screen-overlay').style.display = 'none';
            document.getElementById('game-over-modal').style.display = 'none';
            
            // Reset class-specific stats
            if (gameState.player.class === "bloodmage") {
                gameState.player.maxHp = 40;
                gameState.player.hp = 40;
            }
            
            initGame();
        }
        
        // Show achievements screen
        function showAchievements() {
            document.getElementById('screen-overlay').style.display = 'flex';
            document.getElementById('achievements-modal').style.display = 'block';
            
            const achievementsList = document.getElementById('achievements-list');
            achievementsList.innerHTML = '';
            
            achievementsDatabase.forEach(ach => {
                const achievement = gameState.player.achievements[ach.id] || { unlocked: false, progress: 0 };
                const progress = ach.condition(gameState) ? 1 : (gameState.player.achievements[ach.id]?.progress || 0);
                const maxProgress = ach.condition(gameState) ? 1 : (typeof ach.condition(gameState) === 'number' ? ach.condition(gameState) : 1);
                
                const achElement = document.createElement('div');
                achElement.className = `achievement ${achievement.unlocked ? 'unlocked' : 'achievement-locked'}`;
                
                achElement.innerHTML = `
                    <div class="achievement-icon">${ach.icon}</div>
                    <div class="achievement-info">
                        <div class="achievement-title">${ach.title}</div>
                        <div class="achievement-desc">${ach.description}</div>
                        ${!achievement.unlocked ? `
                            <div class="achievement-progress">
                                <div class="achievement-progress-bar" style="width: ${(progress / maxProgress) * 100}%"></div>
                                ${maxProgress > 1 ? `<div class="achievement-progress-text">${progress}/${maxProgress}</div>` : ''}
                            </div>
                        ` : ''}
                        ${achievement.unlocked && ach.reward ? `
                            <div class="achievement-reward">Reward: ${formatReward(ach.reward)}</div>
                        ` : ''}
                    </div>
                `;
                
                achievementsList.appendChild(achElement);
            });
        }
        
        // Format reward for display
        function formatReward(reward) {
            let parts = [];
            if (reward.gold) parts.push(`${reward.gold} Soul Fragments`);
            if (reward.maxHp) parts.push(`+${reward.maxHp} Max HP`);
            if (reward.maxEnergy) parts.push(`+${reward.maxEnergy} Max Energy`);
            if (reward.card) {
                const card = findCardById(reward.card);
                if (card) parts.push(`${card.name} card`);
            }
            return parts.join(", ");
        }
        
        // Check achievements progress
        function checkAchievements() {
            let unlockedAny = false;
            
            achievementsDatabase.forEach(ach => {
                const achievement = gameState.player.achievements[ach.id] || { unlocked: false, progress: 0 };
                
                if (!achievement.unlocked && ach.condition(gameState)) {
                    achievement.unlocked = true;
                    unlockedAny = true;
                    
                    // Apply reward
                    if (ach.reward.gold) {
                        gameState.player.gold += ach.reward.gold;
                        showNotification(`Achievement Unlocked: ${ach.title} - Gained ${ach.reward.gold} soul fragments!`);
                    }
                    
                    if (ach.reward.maxHp) {
                        gameState.player.maxHp += ach.reward.maxHp;
                        gameState.player.hp += ach.reward.maxHp;
                        showNotification(`Achievement Unlocked: ${ach.title} - Gained +${ach.reward.maxHp} Max HP!`);
                    }
                    
                    if (ach.reward.maxEnergy) {
                        gameState.player.maxEnergy += ach.reward.maxEnergy;
                        showNotification(`Achievement Unlocked: ${ach.title} - Gained +${ach.reward.maxEnergy} Max Energy!`);
                    }
                    
                    if (ach.reward.card) {
                        const card = findCardById(ach.reward.card);
                        if (card) {
                            gameState.player.deck.push({ ...card });
                            showNotification(`Achievement Unlocked: ${ach.title} - Added ${card.name} to your deck!`);
                        }
                    }
                }
            });
            
            if (unlockedAny) {
                updateUI();
            }
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }
        
        // Create card element
        function createCardElement(card, index) {
            const cardElement = document.createElement('div');
            cardElement.className = `card ${card.rarity} ${card.cardClass || ''}`;
            if (index !== undefined) {
                cardElement.onclick = function() {
                    if (gameState.player.energy >= card.cost) {
                        playCard(index);
                    }
                };
                
                // Card tooltip
                cardElement.addEventListener('mousemove', function(e) {
                    const tooltip = document.getElementById('card-tooltip');
                    tooltip.style.left = `${e.clientX + 15}px`;
                    tooltip.style.top = `${e.clientY + 15}px`;
                    tooltip.style.opacity = '1';
                    
                    let tooltipText = `<strong>${card.name}</strong><br>${card.description}`;
                    if (card.cardClass === "fire") tooltipText += "<br><br>Fire: Deals direct damage";
                    if (card.cardClass === "poison") tooltipText += "<br><br>Poison: Deals damage over time";
                    if (card.cardClass === "ice") tooltipText += "<br><br>Ice: Weakens enemies";
                    
                    tooltip.innerHTML = tooltipText;
                });
                
                cardElement.addEventListener('mouseout', function() {
                    document.getElementById('card-tooltip').style.opacity = '0';
                });
            }
            
            cardElement.innerHTML = `
                <div class="card-name">${card.name}</div>
                <div class="card-description">${card.description}</div>
                <div class="card-cost">${card.cost}</div>
                <div class="rarity-indicator ${card.rarity}">${card.rarity[0].toUpperCase()}</div>
            `;
            
            return cardElement;
        }
        
        // Update status display
        function updateStatusDisplay() {
            // Player status
            const playerStatus = document.getElementById('player-status');
            playerStatus.innerHTML = '';
            
            for (const [status, data] of Object.entries(gameState.player.statusEffects)) {
                if (statusEffects[status]) {
                    const statusElement = document.createElement('span');
                    statusElement.className = `status-effect ${statusEffects[status].color}`;
                    statusElement.textContent = `${statusEffects[status].icon}${data.stacks}`;
                    statusElement.title = statusEffects[status].description;
                    playerStatus.appendChild(statusElement);
                }
            }
            
            // Enemy status
            const enemyStatus = document.getElementById('enemy-status');
            enemyStatus.innerHTML = '';
            
            for (const [status, data] of Object.entries(gameState.enemy.statusEffects)) {
                if (statusEffects[status]) {
                    const statusElement = document.createElement('span');
                    statusElement.className = `status-effect ${statusEffects[status].color}`;
                    statusElement.textContent = `${statusEffects[status].icon}${data.stacks}`;
                    statusElement.title = statusEffects[status].description;
                    enemyStatus.appendChild(statusElement);
                }
            }
        }
        
        // Update UI
        function updateUI() {
            // Player stats
            document.getElementById('player-hp-text').textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
            document.getElementById('player-health-bar').style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
            
            // Player energy
            const energyContainer = document.getElementById('player-energy');
            energyContainer.innerHTML = '';
            for (let i = 0; i < gameState.player.maxEnergy; i++) {
                const orb = document.createElement('div');
                orb.className = `energy-orb ${i < gameState.player.energy ? '' : 'empty'}`;
                energyContainer.appendChild(orb);
            }
            
            // Enemy stats
            document.getElementById('enemy-name').textContent = gameState.enemy.name;
            document.getElementById('enemy-hp').textContent = `${gameState.enemy.hp}/${gameState.enemy.maxHp}`;
            document.getElementById('enemy-health-bar').style.width = `${(gameState.enemy.hp / gameState.enemy.maxHp) * 100}%`;
            
            // Enemy intent
            const intentElement = document.getElementById('enemy-intent');
            switch (gameState.enemy.intent) {
                case "attack":
                    intentElement.textContent = `⚔️${gameState.enemy.intentValue}`;
                    break;
                case "block":
                    intentElement.textContent = `🛡️${gameState.enemy.intentValue}`;
                    break;
                case "debuff":
                    intentElement.textContent = `⚠️${gameState.enemy.intentValue}`;
                    break;
                case "status":
                    const status = Object.keys(gameState.enemy.intentValue)[0];
                    intentElement.textContent = `${statusEffects[status]?.icon || '?'}${gameState.enemy.intentValue[status]}`;
                    break;
                default:
                    intentElement.textContent = "?";
            }
            
            // Deck info
            document.getElementById('deck-count').textContent = gameState.player.deck.length;
            document.getElementById('discard-count').textContent = gameState.player.discard.length;
            document.getElementById('draw-count').textContent = gameState.player.drawPile.length;
            
            // Floor and gold
            document.getElementById('floor-text').textContent = `Floor ${gameState.floor}`;
            document.getElementById('gold-text').textContent = gameState.player.gold;
            
            // Hand
            const handContainer = document.getElementById('hand');
            handContainer.innerHTML = '';
            gameState.player.hand.forEach((card, index) => {
                const cardElement = createCardElement(card, index);
                if (gameState.player.energy < card.cost) {
                    cardElement.style.opacity = '0.5';
                }
                handContainer.appendChild(cardElement);
            });
            
            // Draw button
            document.getElementById('draw-btn').textContent = `Draw (${Math.min(3, gameState.player.drawPile.length + gameState.player.discard.length)})`;
            document.getElementById('draw-btn').disabled = gameState.player.drawPile.length + gameState.player.discard.length === 0;
            
            // Update status displays
            updateStatusDisplay();
        }
        
        // Auto-save game
        function autoSave() {
            localStorage.setItem('demonCardsSave', JSON.stringify(gameState));
            document.getElementById('save-indicator').textContent = "Game saved";
            setTimeout(() => {
                document.getElementById('save-indicator').textContent = "Auto-saving...";
            }, 2000);
        }
        
        // Load game
        function loadGame() {
            const save = localStorage.getItem('demonCardsSave');
            if (save) {
                const loadedState = JSON.parse(save);
                Object.assign(gameState, loadedState);
                showNotification("Game loaded");
                updateUI();
                return true;
            }
            return false;
        }
        
        // Initialize event listeners
        function initEventListeners() {
            document.getElementById('draw-btn').addEventListener('click', function() {
                drawCards(3);
            });
            
            document.getElementById('end-turn-btn').addEventListener('click', function() {
                endPlayerTurn();
            });
            
            document.getElementById('take-reward-btn').addEventListener('click', function() {
                selectRewardCard();
            });
            
            document.getElementById('restart-btn').addEventListener('click', function() {
                restartGame();
            });
            
            document.getElementById('achievements-btn').addEventListener('click', function() {
                showAchievements();
            });
            
            document.getElementById('close-achievements-btn').addEventListener('click', function() {
                document.getElementById('screen-overlay').style.display = 'none';
                document.getElementById('achievements-modal').style.display = 'none';
            });
            
            document.getElementById('shop-btn').addEventListener('click', function() {
                showShop();
            });
            
            document.getElementById('close-shop-btn').addEventListener('click', function() {
                document.getElementById('screen-overlay').style.display = 'none';
                document.getElementById('shop-modal').style.display = 'none';
            });
            
            document.getElementById('start-game-btn').addEventListener('click', function() {
                startGame();
            });
            
            // Mobile touch controls
            document.addEventListener('touchstart', function(e) {
                // Prevent zooming
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
        }
        
        // Initialize game when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            
            // Try to load game, otherwise start new game
            if (!loadGame()) {
                initGame();
            }
        });
    </script>
</body>
</html>
