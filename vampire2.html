<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DRACULA'S CURSE</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; font-family: 'Arial', monospace; }
body { background: #000; color: red; height: 100vh; overflow: hidden; display: flex; flex-direction: column; padding: 10px; }

#game-container { flex: 1; display: flex; flex-direction: column; gap: 10px; width: 100%; }

/* Stats */
.stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
.stat-group { display: flex; flex-direction: column; min-width: 100px; }
.bar { height: 5px; background: #300; width: 100%; position: relative; overflow: hidden; }
.bar-fill { height: 100%; transition: width 0.3s; }
.health { background: #f00; }
.sanity { background: #0f0; }

/* Content */
#content-area { flex: 1; display: flex; flex-direction: column; max-width: 600px; width: 100%; margin: 0 auto; gap: 5px; }
#scene-description { flex: 1; overflow-y: auto; border: 1px solid red; padding: 8px; min-height: 150px; }
#combat-log { min-height: 80px; border: 1px solid red; padding: 8px; display: none; }

/* Buttons */
.button-container { display: grid; gap: 5px; }
#action-buttons { grid-template-columns: 1fr 1fr; margin-bottom: 5px; }
#footer-buttons { grid-template-columns: repeat(4, 1fr); }
button { background: #000; color: red; border: 1px solid red; padding: 8px; cursor: pointer; transition: all 0.2s; }
button:active { background: red; color: #000; }
button:disabled { opacity: 0.5; }
button:hover:not(:disabled) { background: #300; }

/* Modals */
.modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); padding: 10px; display: none; z-index: 100; overflow-y: auto; }
.modal-content { border: 1px solid red; padding: 8px; height: 100%; display: flex; flex-direction: column; }
.modal-header { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid red; padding-bottom: 5px; }
.modal-body { flex: 1; overflow-y: auto; }
.close-modal { background: none; border: none; color: red; cursor: pointer; }

/* Animations */
@keyframes shake { 0%,100% { transform: translateX(0); } 20%,60% { transform: translateX(-5px); } 40%,80% { transform: translateX(5px); } }
.shake { animation: shake 0.4s; }
@keyframes flash-red { 0%,100% { background: #000; } 50% { background: #f00; } }
.flash-red { animation: flash-red 0.3s; }
.critical { animation: critical 0.5s; }
@keyframes critical { 0%,100% { color: red; } 50% { color: yellow; } }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
.poisoned { color: #0f0; animation: pulse 1s infinite; }
.bleeding { color: #f00; animation: pulse 0.5s infinite; }
.cursed { color: #800080; animation: pulse 2s infinite; }

/* Merchant */
.merchant-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed red; }

/* Damage Numbers */
.damage-number {
  position: absolute;
  font-weight: bold;
  animation: float-up 1s forwards;
}
@keyframes float-up {
  0% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(-50px); opacity: 0; }
}

/* Mobile */
@media (max-width: 600px) {
  #scene-description { min-height: 30vh; }
  button { padding: 6px 2px; font-size: 12px; }
  .stat-row { flex-direction: column; gap: 5px; }
}

/* Character Selection */
.character-select {
  border: 1px solid red;
  padding: 10px;
  margin: 10px 0;
  cursor: pointer;
  transition: all 0.3s;
}
.character-select:hover {
  background: #300;
}
.character-select h2 {
  color: #f00;
  margin-bottom: 5px;
}
</style>
</head>
<body>
<div id="game-container">
  <!-- Character Selection -->
  <div id="character-selection">
    <h1 style="text-align: center">DRACULA'S CURSE</h1>
    <p>The year is 1897. The vampire Count Dracula has taken residence in his decaying castle above the village of Bistritz.</p>
    <p style="text-align: center">CHOOSE YOUR HUNTER:</p>
    
    <div class="character-select" id="select-jonathan">
      <h2>JONATHAN HARKER</h2>
      <p><strong>Class:</strong> Diplomat | <strong>HP:</strong> 90 | <strong>SAN:</strong> 110</p>
      <p><strong>Skills:</strong> Silver Strike (2x damage with silver weapons), Parry (25% chance to block attacks)</p>
      <p><strong>Unlocks at Lvl 5:</strong> Vampire Slayer (+25% damage to vampires)</p>
      <p><strong>Unlocks at Lvl 10:</strong> Final Blow (Execute enemies below 20% HP)</p>
    </div>
    
    <div class="character-select" id="select-vanhelsing">
      <h2>VAN HELSING</h2>
      <p><strong>Class:</strong> Professor | <strong>HP:</strong> 100 | <strong>SAN:</strong> 90</p>
      <p><strong>Skills:</strong> Holy Water (double effectiveness), Vampire Knowledge (see enemy weaknesses)</p>
      <p><strong>Unlocks at Lvl 5:</strong> Alchemical Shield (Reduce damage by 30% for 2 turns)</p>
      <p><strong>Unlocks at Lvl 10:</strong> Sun Bomb (Massive damage to all undead)</p>
    </div>
    
    <div class="character-select" id="select-mina">
      <h2>MINA MURRAY</h2>
      <p><strong>Class:</strong> Occultist | <strong>HP:</strong> 80 | <strong>SAN:</strong> 120</p>
      <p><strong>Skills:</strong> Hypnosis (chance to skip enemy turn), Sixth Sense (better item finding)</p>
      <p><strong>Unlocks at Lvl 5:</strong> Clairvoyance (see hidden paths)</p>
      <p><strong>Unlocks at Lvl 10:</strong> Spirit Ward (Prevent sanity loss for 3 turns)</p>
    </div>

    <div class="character-select" id="select-quincey">
      <h2>QUINCEY MORRIS</h2>
      <p><strong>Class:</strong> Gunslinger | <strong>HP:</strong> 85 | <strong>SAN:</strong> 95</p>
      <p><strong>Skills:</strong> Quick Draw (attack first in combat), Marksmanship (+25% crit chance)</p>
      <p><strong>Unlocks at Lvl 5:</strong> Fan Fire (Attack 3 times with reduced damage)</p>
      <p><strong>Unlocks at Lvl 10:</strong> Silver Bullet (Massive single attack that ignores defenses)</p>
    </div>
    
    <div style="margin-top: 10px">
      <label>DIFFICULTY:</label>
      <select id="difficulty" style="background: #000; color: red; border: 1px solid red; padding: 5px;">
        <option value="easy">Easy</option>
        <option value="normal" selected>Normal</option>
        <option value="hard">Hard</option>
        <option value="nightmare">Nightmare</option>
      </select>
    </div>
    
    <div style="display: flex; gap: 5px; margin-top: 10px;">
      <button id="load-button" style="display: none;">LOAD GAME</button>
      <button id="new-game-plus-button" style="display: none;">NEW GAME+</button>
      <button id="settings-button">SETTINGS</button>
    </div>
  </div>

  <!-- Main Game -->
  <div id="main-game" style="display: none; height: 100%;">
    <div id="content-area">
      <!-- Stats -->
      <div class="stat-row">
        <div class="stat-group">
          <div>HP: <span id="current-hp">100</span>/<span id="max-hp">100</span></div>
          <div class="bar"><div id="player-health-fill" class="bar-fill health" style="width: 100%;"></div></div>
        </div>
        <div class="stat-group">
          <div>SAN: <span id="current-sanity">100</span>/<span id="max-sanity">100</span></div>
          <div class="bar"><div id="player-sanity-fill" class="bar-fill sanity" style="width: 100%;"></div></div>
        </div>
      </div>
      
      <div class="stat-row">
        <div class="stat-group"><div>LVL: <span id="player-level">1</span></div></div>
        <div class="stat-group"><div>GOLD: <span id="player-gold">50</span></div></div>
        <div class="stat-group"><div>DAY: <span id="game-day">1</span></div></div>
      </div>

      <!-- Location -->
      <div id="dungeon-level" style="text-align: center; font-weight: bold;">TAVERN</div>
      <div class="bar"><div id="level-progress" class="bar-fill health" style="width: 0%;"></div></div>

      <!-- Scene -->
      <div id="scene-description">
        <p>You stand in the dimly lit tavern at the foot of the Carpathian Mountains. The villagers whisper of horrors in the castle above.</p>
        <p>The barkeep eyes you warily. "You're not going up there, are you?" A merchant sits in the corner.</p>
      </div>

      <div id="combat-log"></div>

      <!-- Actions -->
      <div id="action-buttons" class="button-container">
        <button id="explore-button">EXPLORE</button>
        <button id="tavern-action">TALK</button>
        <button id="merchant-button">MERCHANT</button>
        <button id="rest-button">REST</button>
      </div>

      <!-- Weapon -->
      <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed red;">
        <span>WEAPON:</span>
        <span id="equipped-weapon-name">FISTS</span> (<span id="equipped-weapon-dmg">2</span> DMG)
      </div>

      <!-- Status Effects -->
      <div id="status-effects" style="min-height: 20px;"></div>

      <!-- Footer -->
      <div id="footer-buttons" class="button-container">
        <button id="inventory-button">INV</button>
        <button id="quests-button">QUESTS</button>
        <button id="character-button">STATS</button>
        <button id="map-button">MAP</button>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="inventory-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>INVENTORY</h2>
      <button id="close-inventory" class="close-modal">X</button>
    </div>
    <div class="modal-body">
      <h3>WEAPONS</h3>
      <div id="weapons-list"></div>
      <h3 style="margin-top: 10px;">ITEMS</h3>
      <div id="items-list"></div>
    </div>
  </div>
</div>

<!-- Merchant Modal -->
<div id="merchant-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>MERCHANT</h2>
      <button id="close-merchant" class="close-modal">X</button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom: 10px;">GOLD: <span id="merchant-gold-amount">0</span></div>
      
      <h3>BUY ITEMS</h3>
      <div id="merchant-buy-list"></div>
      
      <h3 style="margin-top: 10px;">SELL ITEMS</h3>
      <div id="merchant-sell-list"></div>
    </div>
  </div>
</div>

<!-- Character Stats Modal -->
<div id="character-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="character-name">CHARACTER</h2>
      <button id="close-character" class="close-modal">X</button>
    </div>
    <div class="modal-body">
      <div class="stat-row">
        <span>CLASS:</span>
        <span id="character-class">CLASS</span>
      </div>
      <div class="stat-row">
        <span>LEVEL:</span>
        <span id="character-level">1</span>
      </div>
      
      <h3 style="margin-top: 10px;">ATTRIBUTES</h3>
      <div class="stat-row">
        <span>STRENGTH:</span>
        <span id="character-strength">5</span>
      </div>
      <div class="stat-row">
        <span>AGILITY:</span>
        <span id="character-agility">5</span>
      </div>
      <div class="stat-row">
        <span>INTELLIGENCE:</span>
        <span id="character-intelligence">5</span>
      </div>
      
      <h3 style="margin-top: 10px;">SKILLS</h3>
      <div id="character-skills"></div>

      <h3 style="margin-top: 10px;">STATUS EFFECTS</h3>
      <div id="character-status-effects"></div>
    </div>
  </div>
</div>

<!-- Quests Modal -->
<div id="quests-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>QUESTS</h2>
      <button id="close-quests" class="close-modal">X</button>
    </div>
    <div class="modal-body">
      <h3>ACTIVE QUESTS</h3>
      <div id="active-quests"></div>
      
      <h3 style="margin-top: 10px;">COMPLETED QUESTS</h3>
      <div id="completed-quests"></div>

      <h3 style="margin-top: 10px;">SIDE QUESTS</h3>
      <div id="side-quests"></div>
    </div>
  </div>
</div>

<!-- Combat Modal -->
<div id="combat-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="combat-title">COMBAT</h2>
    </div>
    <div class="modal-body">
      <div id="enemy-display" style="border: 1px solid red; padding: 8px; margin-bottom: 5px; position: relative;">
        <h3 id="enemy-name">ENEMY</h3>
        <div>HP: <span id="enemy-hp">30</span>/<span id="enemy-max-hp">30</span></div>
        <div class="bar"><div id="enemy-hp-bar" class="bar-fill health" style="width: 100%;"></div></div>
        <div id="enemy-status-effects"></div>
      </div>

      <div id="player-display" style="border: 1px solid red; padding: 8px; margin-bottom: 5px;">
        <h3 id="player-name">PLAYER</h3>
        <div>HP: <span id="player-hp-combat">100</span>/<span id="player-max-hp-combat">100</span></div>
        <div class="bar"><div id="player-hp-bar" class="bar-fill health" style="width: 100%;"></div></div>
        <div>SAN: <span id="player-sanity-combat">100</span>/<span id="player-max-sanity-combat">100</span></div>
        <div class="bar"><div id="player-sanity-bar" class="bar-fill sanity" style="width: 100%;"></div></div>
        <div id="player-combat-status-effects"></div>
      </div>

      <div id="combat-log-modal" style="min-height: 80px; border: 1px solid red; padding: 8px;"></div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px;">
        <button id="attack-button">ATTACK</button>
        <button id="special-button">SPECIAL</button>
        <button id="use-item-button">ITEM</button>
        <button id="flee-button">FLEE</button>
      </div>
    </div>
  </div>
</div>

<!-- Game Over Modal -->
<div id="game-over-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 style="text-align: center">GAME OVER</h2>
    </div>
    <div class="modal-body" style="text-align: center;">
      <p id="game-over-text">You have been defeated!</p>
      <p>Dracula laughs as your life fades away...</p>
      <button id="try-again-button">TRY AGAIN</button>
      <button id="main-menu-button">MAIN MENU</button>
    </div>
  </div>
</div>

<!-- New Game Plus Modal -->
<div id="new-game-plus-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 style="text-align: center">NEW GAME+</h2>
    </div>
    <div class="modal-body" style="text-align: center;">
      <p>Congratulations on defeating Dracula!</p>
      <p>Start a new game with increased difficulty but keep your:</p>
      <ul style="text-align: left; margin: 10px 0;">
        <li>Level and stats</li>
        <li>Inventory (except key items)</li>
        <li>Gold</li>
        <li>Unlocked abilities</li>
      </ul>
      <p>Enemies will be stronger and smarter!</p>
      <button id="start-new-game-plus">BEGIN NEW GAME+</button>
      <button id="regular-new-game">START NORMAL GAME</button>
    </div>
  </div>
</div>

<script>
// Game State
const game = {
  player: null,
  currentEnemy: null,
  inCombat: false,
  location: 0, // 0=tavern, 1=forest, etc.
  day: 1,
  difficulty: 'normal',
  hasStake: false,
  newGamePlus: false,
  statusEffects: [],
  enemyStatusEffects: [],
  
  // Game Data
  locations: [
    { name: "TAVERN", desc: "You stand in the dimly lit tavern at the foot of the Carpathian Mountains.", enemies: [] },
    { name: "FOREST", desc: "The dark forest is filled with eerie sounds.", enemies: ["vampire-spawn", "ghoul", "banshee", "wraith"] },
    { name: "MOUNTAIN", desc: "The steep mountain path winds upward.", enemies: ["vampire-spawn", "werewolf", "ghost", "dark-priest"] },
    { name: "CASTLE GATES", desc: "The massive iron gates stand ominously open.", enemies: ["brides", "werewolf", "zombie", "shadow-beast"] },
    { name: "CASTLE HALLS", desc: "The interior is dark and foreboding.", enemies: ["brides", "vampire-spawn", "ghost", "cursed-knight"] },
    { name: "DUNGEONS", desc: "The stench of death fills the air.", enemies: ["ghoul", "zombie", "banshee", "tortured-soul"] },
    { name: "THRONE ROOM", desc: "The final confrontation.", enemies: ["dracula"] },
    { name: "SECRET CHAPEL", desc: "A hidden chapel with ancient relics.", enemies: ["fallen-paladin", "demon", "undead-priest"], hidden: true },
    { name: "ALCHEMIST'S LAB", desc: "A mysterious laboratory filled with strange equipment.", enemies: ["homunculus", "mutant", "mad-alchemist"], hidden: true }
  ],
  
  characters: {
    jonathan: { 
      name: "JONATHAN HARKER", 
      class: "Diplomat",
      hp: 90, maxHp: 90, 
      sanity: 110, maxSanity: 110,
      strength: 7, agility: 6, intelligence: 5,
      skills: ["SILVER STRIKE", "PARRY"], 
      perks: ["+10% damage with silver weapons", "25% chance to block attacks"],
      inventory: ["silver-dagger"],
      unlockedAbilities: []
    },
    vanhelsing: { 
      name: "VAN HELSING", 
      class: "Professor",
      hp: 100, maxHp: 100, 
      sanity: 90, maxSanity: 90,
      strength: 5, agility: 4, intelligence: 8,
      skills: ["HOLY WATER", "VAMPIRE KNOWLEDGE"], 
      perks: ["-25% sanity loss from undead", "See enemy weaknesses"],
      inventory: ["holy-water", "garlic"],
      unlockedAbilities: []
    },
    mina: { 
      name: "MINA MURRAY", 
      class: "Occultist",
      hp: 80, maxHp: 80, 
      sanity: 120, maxSanity: 120,
      strength: 4, agility: 7, intelligence: 7,
      skills: ["HYPNOSIS", "SIXTH SENSE"], 
      perks: ["+30% better item finding", "Chance to skip enemy turn"],
      inventory: ["occult-tome"],
      unlockedAbilities: []
    },
    quincey: {
      name: "QUINCEY MORRIS",
      class: "Gunslinger",
      hp: 85, maxHp: 85,
      sanity: 95, maxSanity: 95,
      strength: 6, agility: 8, intelligence: 4,
      skills: ["QUICK DRAW", "MARKSMANSHIP"],
      perks: ["Attack first in combat", "+25% crit chance"],
      inventory: ["revolver"],
      unlockedAbilities: []
    }
  },
  
  enemies: {
    "vampire-spawn": { name: "VAMPIRE SPAWN", hp: 30, maxHp: 30, damage: 6, xp: 25, gold: 15, weakness: ["stake", "holy"], special: "bleed" },
    "brides": { name: "DRACULA'S BRIDES", hp: 50, maxHp: 50, damage: 9, xp: 40, gold: 30, weakness: ["holy"], special: "charm" },
    "werewolf": { name: "WEREWOLF", hp: 70, maxHp: 70, damage: 12, xp: 60, gold: 45, weakness: ["silver"], special: "howl" },
    "ghoul": { name: "GHOUL", hp: 40, maxHp: 40, damage: 8, xp: 35, gold: 20, weakness: ["holy"], special: "disease" },
    "dracula": { name: "COUNT DRACULA", hp: 150, maxHp: 150, damage: 15, xp: 200, gold: 100, weakness: ["stake", "holy"], special: "transform" },
    "banshee": { name: "BANSHEE", hp: 35, maxHp: 35, damage: 7, xp: 30, gold: 25, weakness: ["silver"], special: "screech" },
    "ghost": { name: "GHOST", hp: 25, maxHp: 25, damage: 5, xp: 20, gold: 10, weakness: ["holy"], special: "phase" },
    "zombie": { name: "ZOMBIE", hp: 45, maxHp: 45, damage: 7, xp: 30, gold: 15, weakness: ["fire"], special: "grapple" },
    // New enemies
    "wraith": { name: "WRAITH", hp: 40, maxHp: 40, damage: 8, xp: 35, gold: 25, weakness: ["holy"], special: "drain" },
    "dark-priest": { name: "DARK PRIEST", hp: 60, maxHp: 60, damage: 10, xp: 50, gold: 40, weakness: ["holy"], special: "curse" },
    "shadow-beast": { name: "SHADOW BEAST", hp: 80, maxHp: 80, damage: 14, xp: 70, gold: 55, weakness: ["light"], special: "ambush" },
    "cursed-knight": { name: "CURSED KNIGHT", hp: 90, maxHp: 90, damage: 12, xp: 80, gold: 60, weakness: ["silver", "holy"], special: "counter" },
    "tortured-soul": { name: "TORTURED SOUL", hp: 30, maxHp: 30, damage: 6, xp: 25, gold: 20, weakness: ["holy"], special: "wail" },
    "fallen-paladin": { name: "FALLEN PALADIN", hp: 120, maxHp: 120, damage: 18, xp: 150, gold: 80, weakness: ["holy"], special: "smite" },
    "demon": { name: "DEMON", hp: 100, maxHp: 100, damage: 16, xp: 120, gold: 70, weakness: ["holy"], special: "firebreath" },
    "undead-priest": { name: "UNDEAD PRIEST", hp: 70, maxHp: 70, damage: 12, xp: 90, gold: 50, weakness: ["holy"], special: "unholy-blessing" },
    "homunculus": { name: "HOMUNCULUS", hp: 50, maxHp: 50, damage: 10, xp: 60, gold: 40, weakness: ["fire"], special: "regenerate" },
    "mutant": { name: "MUTANT", hp: 90, maxHp: 90, damage: 14, xp: 100, gold: 60, weakness: ["silver"], special: "mutate" },
    "mad-alchemist": { name: "MAD ALCHEMIST", hp: 80, maxHp: 80, damage: 12, xp: 110, gold: 70, weakness: ["fire"], special: "throw-potion" }
  },
  
  items: {
    "fists": { name: "FISTS", damage: 2 },
    "silver-dagger": { name: "SILVER DAGGER", damage: 8, special: "silver" },
    "wooden-stake": { name: "WOODEN STAKE", damage: 12, special: "stake" },
    "health-potion": { name: "HEALTH POTION", heal: 20 },
    "holy-water": { name: "HOLY WATER", damage: 15, special: "holy" },
    "garlic": { name: "GARLIC", damage: 5, special: "repel" },
    "occult-tome": { name: "OCCULT TOME", special: "knowledge" },
    "antidote": { name: "ANTIDOTE", special: "cure" },
    "blessed-blade": { name: "BLESSED BLADE", damage: 14, special: "holy" },
    "vampire-killer": { name: "VAMPIRE KILLER", damage: 18, special: ["silver", "holy"] },
    "revolver": { name: "REVOLVER", damage: 10, special: "silver" },
    "silver-bullet": { name: "SILVER BULLET", damage: 25, special: ["silver", "holy"], consumable: true },
    "sun-bomb": { name: "SUN BOMB", damage: 40, special: "holy", consumable: true, area: true }
  },
  
  merchantItems: [
    { id: "health-potion", name: "HEALTH POTION", price: 15, heal: 20 },
    { id: "holy-water", name: "HOLY WATER", price: 25, damage: 15, special: "holy" },
    { id: "garlic", name: "GARLIC", price: 10, damage: 5, special: "repel" },
    { id: "silver-dagger", name: "SILVER DAGGER", price: 50, damage: 8, special: "silver" },
    { id: "wooden-stake", name: "WOODEN STAKE", price: 40, damage: 12, special: "stake" },
    { id: "antidote", name: "ANTIDOTE", price: 20, special: "cure" },
    { id: "revolver", name: "REVOLVER", price: 75, damage: 10, special: "silver" },
    { id: "silver-bullet", name: "SILVER BULLET", price: 30, damage: 25, special: ["silver", "holy"], consumable: true }
  ],
  
  quests: {
    active: [
      { id: "slay-dracula", title: "SLAY DRACULA", description: "Defeat Count Dracula to lift the curse.", completed: false },
      { id: "find-stake", title: "FIND A STAKE", description: "Obtain a wooden stake to fight vampires.", completed: false }
    ],
    completed: [],
    side: [
      { id: "kill-werewolf", title: "SLAY THE WEREWOLF", description: "Defeat the werewolf haunting the mountains.", completed: false, reward: "blessed-blade" },
      { id: "find-tome", title: "FIND THE LOST TOME", description: "Recover the ancient occult tome from the dungeons.", completed: false, reward: "vampire-killer" },
      { id: "explore-chapel", title: "EXPLORE THE SECRET CHAPEL", description: "Find the hidden chapel in the castle.", completed: false, reward: "holy-water", hidden: true },
      { id: "defeat-alchemist", title: "DEFEAT THE MAD ALCHEMIST", description: "Put an end to the alchemist's experiments.", completed: false, reward: "sun-bomb", hidden: true }
    ]
  },
  
  statusEffectTypes: {
    "bleed": { name: "BLEEDING", duration: 3, damage: 2, class: "bleeding" },
    "poison": { name: "POISONED", duration: 4, damage: 1, class: "poisoned" },
    "curse": { name: "CURSED", duration: 5, damage: 0, sanityLoss: 5, class: "cursed" },
    "charmed": { name: "CHARMED", duration: 1, skipTurn: true, class: "cursed" },
    "drain": { name: "LIFE DRAIN", duration: 2, damage: 3, healEnemy: true, class: "cursed" },
    "regenerate": { name: "REGENERATING", duration: 3, heal: 5, class: "poisoned" },
    "shield": { name: "SHIELDED", duration: 2, damageReduction: 0.3, class: "poisoned" }
  },
  
  travelEvents: [
    { text: "You find a hidden path that leads to a small clearing.", effect: "findItem" },
    { text: "A strange mist surrounds you, making it hard to see.", effect: "loseSanity", amount: 5 },
    { text: "You stumble upon an abandoned campsite with some useful items.", effect: "findItem" },
    { text: "The howling wind carries whispers that chill you to the bone.", effect: "loseSanity", amount: 10 },
    { text: "You discover a shortcut through the terrain.", effect: "progressFaster" },
    { text: "A wounded traveler warns you of dangers ahead before collapsing.", effect: "findItem" },
    { text: "You find an old journal detailing secret locations in the castle.", effect: "revealHidden" },
    { text: "A mysterious figure offers you a powerful item in exchange for gold.", effect: "mysteriousMerchant" }
  ]
};

// Initialize Game
document.addEventListener('DOMContentLoaded', function() {
  // Character selection
  document.getElementById('select-jonathan').addEventListener('click', () => startGame('jonathan'));
  document.getElementById('select-vanhelsing').addEventListener('click', () => startGame('vanhelsing'));
  document.getElementById('select-mina').addEventListener('click', () => startGame('mina'));
  document.getElementById('select-quincey').addEventListener('click', () => startGame('quincey'));
  
  // Settings
  document.getElementById('settings-button').addEventListener('click', () => {
    document.getElementById('settings-modal').style.display = 'block';
  });
  
  // Check for saved game
  if (localStorage.getItem('draculasCurseSave')) {
    document.getElementById('load-button').style.display = 'block';
    document.getElementById('load-button').addEventListener('click', loadGame);
  }

  // Check for completed game
  if (localStorage.getItem('draculasCurseCompleted')) {
    document.getElementById('new-game-plus-button').style.display = 'block';
    document.getElementById('new-game-plus-button').addEventListener('click', () => {
      document.getElementById('new-game-plus-modal').style.display = 'block';
    });
  }
});

function startGame(character, isNewGamePlus = false) {
  if (isNewGamePlus) {
    // Load from completed game
    const completedGame = JSON.parse(localStorage.getItem('draculasCurseCompleted'));
    game.player = completedGame.player;
    game.newGamePlus = true;
    game.difficulty = 'hard'; // Automatically increase difficulty for NG+
  } else {
    // New game
    game.player = JSON.parse(JSON.stringify(game.characters[character]));
    game.player.gold = 50;
    game.player.level = 1;
    game.player.xp = 0;
    game.player.nextLevelXp = 100;
    game.player.equippedWeapon = "fists";
    game.player.inventory = game.player.inventory || [];
    game.player.inventory.push("health-potion", "health-potion");
    game.player.unlockedAbilities = [];
    
    // Character-specific starting items
    if (character === 'quincey') {
      game.player.inventory.push("revolver");
    }
  }
  
  game.difficulty = document.getElementById('difficulty').value;
  game.location = 0;
  game.day = 1;
  game.hasStake = false;
  game.statusEffects = [];
  game.enemyStatusEffects = [];
  
  // Apply difficulty
  applyDifficulty();
  
  // Show game UI
  document.getElementById('character-selection').style.display = 'none';
  document.getElementById('main-game').style.display = 'flex';
  
  // Update UI
  updateUI();
  bindButtons();
  
  // Start game
  updateLocation();
  if (isNewGamePlus) {
    addToScene(`You awaken with a start... the nightmare begins again. But you are stronger now.`);
  } else {
    addToScene(`You awaken in the tavern as ${game.player.name}, ready to face the horrors ahead.`);
  }
}

function applyDifficulty() {
  const modifier = {
    easy: { hp: 0.8, damage: 0.8, reward: 1.2 },
    normal: { hp: 1, damage: 1, reward: 1 },
    hard: { hp: 1.3, damage: 1.3, reward: 0.8 },
    nightmare: { hp: 1.8, damage: 1.5, reward: 0.5 }
  }[game.difficulty];
  
  // Adjust enemies
  Object.keys(game.enemies).forEach(key => {
    game.enemies[key].hp = Math.floor(game.enemies[key].hp * modifier.hp * (game.newGamePlus ? 1.5 : 1));
    game.enemies[key].maxHp = game.enemies[key].hp;
    game.enemies[key].damage = Math.floor(game.enemies[key].damage * modifier.damage * (game.newGamePlus ? 1.2 : 1));
    game.enemies[key].xp = Math.floor(game.enemies[key].xp * modifier.reward);
    game.enemies[key].gold = Math.floor(game.enemies[key].gold * modifier.reward);
  });
}

function updateUI() {
  // Stats
  document.getElementById('current-hp').textContent = game.player.hp;
  document.getElementById('max-hp').textContent = game.player.maxHp;
  document.getElementById('current-sanity').textContent = game.player.sanity;
  document.getElementById('max-sanity').textContent = game.player.maxSanity;
  document.getElementById('player-level').textContent = game.player.level;
  document.getElementById('player-gold').textContent = game.player.gold;
  document.getElementById('game-day').textContent = game.day;
  
  // Bars
  document.getElementById('player-health-fill').style.width = `${(game.player.hp / game.player.maxHp) * 100}%`;
  document.getElementById('player-sanity-fill').style.width = `${(game.player.sanity / game.player.maxSanity) * 100}%`;
  document.getElementById('level-progress').style.width = `${(game.player.xp / game.player.nextLevelXp) * 100}%`;
  
  // Weapon
  const weapon = game.items[game.player.equippedWeapon] || game.items.fists;
  document.getElementById('equipped-weapon-name').textContent = weapon.name;
  document.getElementById('equipped-weapon-dmg').textContent = weapon.damage;
  
  // Status effects
  updateStatusEffects();
}

function updateStatusEffects() {
  const statusContainer = document.getElementById('status-effects');
  statusContainer.innerHTML = '';
  
  game.statusEffects.forEach(effect => {
    const effectType = game.statusEffectTypes[effect.type];
    const span = document.createElement('span');
    span.textContent = effectType.name;
    span.className = effectType.class;
    span.style.marginRight = '5px';
    statusContainer.appendChild(span);
  });
}

function bindButtons() {
  // Main actions
  document.getElementById('explore-button').onclick = explore;
  document.getElementById('merchant-button').onclick = openMerchant;
  document.getElementById('rest-button').onclick = rest;
  document.getElementById('tavern-action').onclick = talkToBarkeep;
  
  // Modals
  document.getElementById('inventory-button').onclick = openInventory;
  document.getElementById('character-button').onclick = openCharacter;
  document.getElementById('quests-button').onclick = openQuests;
  document.getElementById('map-button').onclick = openMap;
  
  // Combat
  document.getElementById('attack-button').onclick = playerAttack;
  document.getElementById('special-button').onclick = specialAttack;
  document.getElementById('use-item-button').onclick = useItemInCombat;
  document.getElementById('flee-button').onclick = attemptFlee;
  
  // Close buttons
  document.getElementById('close-inventory').onclick = hideAllModals;
  document.getElementById('close-merchant').onclick = hideAllModals;
  document.getElementById('close-character').onclick = hideAllModals;
  document.getElementById('close-quests').onclick = hideAllModals;
  
  // Game over
  document.getElementById('try-again-button').onclick = tryAgain;
  document.getElementById('main-menu-button').onclick = returnToMainMenu;
  
  // New Game+
  document.getElementById('start-new-game-plus').onclick = () => {
    document.getElementById('new-game-plus-modal').style.display = 'none';
    const completedGame = JSON.parse(localStorage.getItem('draculasCurseCompleted'));
    startGame(completedGame.player.character, true);
  };
  document.getElementById('regular-new-game').onclick = () => {
    document.getElementById('new-game-plus-modal').style.display = 'none';
    document.getElementById('character-selection').style.display = 'flex';
  };
}

// Game Actions
function explore() {
  clearScene();
  if (game.location === 0) {
    game.location = 1;
    updateLocation();
    addToScene(game.locations[1].desc);
    
    // Random travel event
    if (Math.random() < 0.5) {
      const event = game.travelEvents[Math.floor(Math.random() * game.travelEvents.length)];
      addToScene(event.text);
      
      switch(event.effect) {
        case "findItem":
          findItem();
          break;
        case "loseSanity":
          game.player.sanity = Math.max(0, game.player.sanity - event.amount);
          updateUI();
          break;
        case "progressFaster":
          game.location = Math.min(game.location + 1, game.locations.length - 1);
          updateLocation();
          break;
        case "revealHidden":
          // Mina's ability reveals hidden locations
          if (game.player.skills.includes("CLAIRVOYANCE")) {
            game.locations.forEach(loc => {
              if (loc.hidden) loc.hidden = false;
            });
            addToScene("The journal reveals hidden locations in the castle!");
          }
          break;
        case "mysteriousMerchant":
          const rareItems = ["vampire-killer", "blessed-blade", "sun-bomb"];
          const offeredItem = rareItems[Math.floor(Math.random() * rareItems.length)];
          const price = Math.floor(game.items[offeredItem].damage * 3);
          
          if (confirm(`A mysterious figure offers you ${game.items[offeredItem].name} for ${price} gold. Accept?`)) {
            if (game.player.gold >= price) {
              game.player.gold -= price;
              game.player.inventory.push(offeredItem);
              addToScene(`You obtained ${game.items[offeredItem].name}!`);
              updateUI();
            } else {
              addToScene("You don't have enough gold for the mysterious offer.");
            }
          }
          break;
      }
    }
    
    setTimeout(() => startRandomEncounter(), 1000);
  } else {
    addToScene(`You explore the ${game.locations[game.location].name.toLowerCase()}...`);
    
    // Check for hidden areas (Mina's ability)
    if (game.player.skills.includes("CLAIRVOYANCE") && Math.random() < 0.3) {
      // Check if there are hidden locations to find
      const hiddenLocations = game.locations.filter(l => l.hidden);
      if (hiddenLocations.length > 0) {
        const foundLocation = hiddenLocations[Math.floor(Math.random() * hiddenLocations.length)];
        foundLocation.hidden = false;
        addToScene("Your sixth sense tingles... you find a hidden path to " + foundLocation.name + "!");
        return;
      }
    }
    
    if (Math.random() < 0.7) {
      setTimeout(() => startRandomEncounter(), 1000);
    } else if (Math.random() < 0.5) {
      findItem();
    } else {
      setTimeout(() => addToScene("You find nothing of interest."), 1000);
    }
  }
}

function findItem() {
  let possibleItems = ["health-potion", "holy-water", "garlic"];
  
  // Mina's Sixth Sense ability gives better items
  if (game.player.skills.includes("SIXTH SENSE")) {
    possibleItems = possibleItems.concat(["antidote", "silver-dagger"]);
  }
  
  // Higher level characters find better items
  if (game.player.level > 3) {
    possibleItems.push("wooden-stake");
  }
  if (game.player.level > 5) {
    possibleItems.push("blessed-blade");
  }
  if (game.player.level > 7) {
    possibleItems.push("vampire-killer");
  }
  
  const foundItem = possibleItems[Math.floor(Math.random() * possibleItems.length)];
  game.player.inventory.push(foundItem);
  addToScene(`You found a ${game.items[foundItem].name}!`);
}

function startRandomEncounter() {
  const enemies = game.locations[game.location].enemies;
  const enemyType = enemies[Math.floor(Math.random() * enemies.length)];
  startCombat(enemyType);
}

function startCombat(enemyType) {
  game.inCombat = true;
  game.currentEnemy = JSON.parse(JSON.stringify(game.enemies[enemyType]));
  game.enemyStatusEffects = [];
  
  // Update UI
  document.getElementById('combat-title').textContent = `COMBAT: ${game.currentEnemy.name}`;
  document.getElementById('enemy-name').textContent = game.currentEnemy.name;
  document.getElementById('enemy-hp').textContent = game.currentEnemy.hp;
  document.getElementById('enemy-max-hp').textContent = game.currentEnemy.maxHp;
  document.getElementById('enemy-hp-bar').style.width = '100%';
  
  document.getElementById('player-name').textContent = game.player.name;
  document.getElementById('player-hp-combat').textContent = game.player.hp;
  document.getElementById('player-max-hp-combat').textContent = game.player.maxHp;
  document.getElementById('player-hp-bar').style.width = `${(game.player.hp / game.player.maxHp) * 100}%`;
  document.getElementById('player-sanity-combat').textContent = game.player.sanity;
  document.getElementById('player-max-sanity-combat').textContent = game.player.maxSanity;
  document.getElementById('player-sanity-bar').style.width = `${(game.player.sanity / game.player.maxSanity) * 100}%`;
  
  // Set combat log
  const combatLog = document.getElementById('combat-log-modal');
  combatLog.innerHTML = `<p>A ${game.currentEnemy.name} ATTACKS!</p>`;
  
  // Special enemy intro
  if (enemyType === "dracula") {
    combatLog.innerHTML += `<p>"I AM DRACULA! YOU DARE CHALLENGE ME?"</p>`;
  } else if (enemyType === "werewolf") {
    combatLog.innerHTML += `<p>The beast howls as it charges at you!</p>`;
  } else if (enemyType === "fallen-paladin") {
    combatLog.innerHTML += `<p>"You shall not pass, mortal!" the corrupted paladin declares.</p>`;
  }
  
  // Show modal
  document.getElementById('combat-modal').style.display = 'block';
  updateCombatStatusEffects();
  
  // Quincey's Quick Draw ability
  if (game.player.skills.includes("QUICK DRAW") && Math.random() < 0.75) {
    setTimeout(() => {
      addCombatLog("QUICK DRAW: You attack first!");
      playerAttack();
    }, 500);
  }
}

function playerAttack() {
  if (!game.inCombat) return;
  
  // Check if charmed
  const charmed = game.statusEffects.find(e => e.type === "charmed");
  if (charmed) {
    addCombatLog(`You are charmed and can't attack!`);
    game.statusEffects = game.statusEffects.filter(e => e.type !== "charmed");
    updateStatusEffects();
    setTimeout(() => enemyAttack(), 1000);
    return;
  }
  
  const weapon = game.items[game.player.equippedWeapon] || game.items.fists;
  let damage = weapon.damage + Math.floor(Math.random() * 4);
  
  // Strength bonus
  damage += Math.floor(game.player.strength / 2);
  
  // Check for critical (Quincey's Marksmanship)
  const critChance = 0.05 + (game.player.agility / 100) + 
    (game.player.skills.includes("MARKSMANSHIP") ? 0.25 : 0);
  const isCritical = Math.random() < critChance;
  if (isCritical) damage = Math.floor(damage * 1.5);
  
  // Check for weapon special effects
  if (weapon.special && Array.isArray(weapon.special) 
      ? weapon.special.some(s => game.currentEnemy.weakness.includes(s))
      : game.currentEnemy.weakness.includes(weapon.special)) {
    damage = Math.floor(damage * 1.5);
    addCombatLog(`${weapon.name} IS EFFECTIVE!`);
  }
  
  // Jonathan's Silver Strike ability
  if (game.player.skills.includes("SILVER STRIKE") && weapon.special === "silver") {
    damage = Math.floor(damage * 2);
    addCombatLog(`SILVER STRIKE ACTIVATED!`);
  }
  
  // Jonathan's Vampire Slayer ability
  if (game.player.unlockedAbilities.includes("VAMPIRE SLAYER") && 
      (game.currentEnemy.name.includes("VAMPIRE") || game.currentEnemy.name === "COUNT DRACULA")) {
    damage = Math.floor(damage * 1.25);
    addCombatLog(`VAMPIRE SLAYER: +25% DAMAGE!`);
  }
  
  // Check for Final Blow (execute below 20%)
  if (game.player.unlockedAbilities.includes("FINAL BLOW") && 
      game.currentEnemy.hp <= game.currentEnemy.maxHp * 0.2) {
    damage = game.currentEnemy.hp;
    addCombatLog(`FINAL BLOW: Execute!`);
  }
  
  // Apply damage
  game.currentEnemy.hp -= damage;
  
  // Update UI
  const hpPercent = (game.currentEnemy.hp / game.currentEnemy.maxHp) * 100;
  document.getElementById('enemy-hp').textContent = Math.max(0, game.currentEnemy.hp);
  document.getElementById('enemy-hp-bar').style.width = `${Math.max(0, hpPercent)}%`;
  
  // Show damage number
  showDamageNumber(damage, document.getElementById('enemy-display'), isCritical);
  
  // Animation
  document.getElementById('enemy-display').classList.add('shake');
  setTimeout(() => document.getElementById('enemy-display').classList.remove('shake'), 400);
  
  addCombatLog(`YOU HIT FOR ${damage} DAMAGE!${isCritical ? ' <span class="critical">CRITICAL!</span>' : ''}`);
  
  // Apply status effects from weapon
  if (weapon.special === "silver" && Math.random() < 0.2) {
    applyEnemyStatusEffect("bleed");
  }
  
  // Check if enemy defeated
  if (game.currentEnemy.hp <= 0) {
    enemyDefeated();
    return;
  }
  
  // Enemy counterattack
  setTimeout(() => enemyAttack(), 1000);
}

function showDamageNumber(amount, parentElement, isCritical) {
  const damageNumber = document.createElement('div');
  damageNumber.className = 'damage-number';
  damageNumber.textContent = amount;
  damageNumber.style.color = isCritical ? 'yellow' : 'red';
  damageNumber.style.left = `${Math.random() * 50 + 25}%`;
  
  parentElement.appendChild(damageNumber);
  
  // Remove after animation
  setTimeout(() => {
    damageNumber.remove();
  }, 1000);
}

function enemyAttack() {
  if (!game.inCombat) return;
  
  let damage = game.currentEnemy.damage + Math.floor(Math.random() * 4);
  
  // Check for parry (Jonathan's ability)
  if (game.player.skills.includes("PARRY") && Math.random() < 0.25) {
    addCombatLog(`PARRY: You block the attack!`);
    setTimeout(() => playerAttack(), 1000);
    return;
  }
  
  // Check for shield effect
  const shield = game.statusEffects.find(e => e.type === "shield");
  if (shield) {
    damage = Math.floor(damage * (1 - game.statusEffectTypes.shield.damageReduction));
    addCombatLog(`SHIELD: Damage reduced by 30%!`);
  }
  
  // Apply status effects from enemy special
  switch(game.currentEnemy.special) {
    case "bleed":
      if (Math.random() < 0.3) {
        applyStatusEffect("bleed");
        addCombatLog(`The ${game.currentEnemy.name}'s attack makes you bleed!`);
      }
      break;
    case "charm":
      if (Math.random() < 0.3) {
        applyStatusEffect("charmed");
        addCombatLog(`${game.currentEnemy.name} CHARMS YOU! YOU CAN'T ATTACK NEXT TURN!`);
      }
      break;
    case "howl":
      if (Math.random() < 0.4) {
        damage = Math.floor(damage * 1.5);
        addCombatLog(`${game.currentEnemy.name} HOWLS, increasing its attack power!`);
      }
      break;
    case "disease":
      if (Math.random() < 0.25) {
        applyStatusEffect("poison");
        addCombatLog(`The ${game.currentEnemy.name} infects you with disease!`);
      }
      break;
    case "screech":
      game.player.sanity = Math.max(0, game.player.sanity - 10);
      updateUI();
      addCombatLog(`The ${game.currentEnemy.name} SCREECHES, damaging your sanity!`);
      break;
    case "transform":
      if (!game.currentEnemy.transformed && game.currentEnemy.hp < game.currentEnemy.maxHp / 2) {
        game.currentEnemy.transformed = true;
        game.currentEnemy.damage += 5;
        addCombatLog(`${game.currentEnemy.name} TRANSFORMS! ATTACK INCREASED!`);
      }
      break;
    case "drain":
      if (Math.random() < 0.4) {
        applyStatusEffect("drain");
        addCombatLog(`${game.currentEnemy.name} DRAINS YOUR LIFE FORCE!`);
      }
      break;
    case "regenerate":
      if (Math.random() < 0.5) {
        applyEnemyStatusEffect("regenerate");
        addCombatLog(`${game.currentEnemy.name} begins to regenerate!`);
      }
      break;
  }
  
  // Apply damage
  game.player.hp -= damage;
  updateUI();
  
  // Update combat UI
  document.getElementById('player-hp-combat').textContent = game.player.hp;
  document.getElementById('player-hp-bar').style.width = `${(game.player.hp / game.player.maxHp) * 100}%`;
  
  // Show damage number
  showDamageNumber(damage, document.getElementById('player-display'), false);
  
  // Animation
  document.getElementById('player-display').classList.add('flash-red');
  setTimeout(() => document.getElementById('player-display').classList.remove('flash-red'), 300);
  
  addCombatLog(`${game.currentEnemy.name} HITS YOU FOR ${damage} DAMAGE!`);
  
  // Apply status effects
  applyStatusEffectsDamage();
  updateCombatStatusEffects();
  
  // Check if player defeated
  if (game.player.hp <= 0) {
    playerDefeated();
  }
}

function applyStatusEffect(type) {
  const existing = game.statusEffects.find(e => e.type === type);
  if (existing) {
    existing.duration = game.statusEffectTypes[type].duration; // Refresh duration
  } else {
    game.statusEffects.push({
      type: type,
      duration: game.statusEffectTypes[type].duration
    });
  }
  updateStatusEffects();
}

function applyEnemyStatusEffect(type) {
  const existing = game.enemyStatusEffects.find(e => e.type === type);
  if (existing) {
    existing.duration = game.statusEffectTypes[type].duration; // Refresh duration
  } else {
    game.enemyStatusEffects.push({
      type: type,
      duration: game.statusEffectTypes[type].duration
    });
  }
  updateCombatStatusEffects();
}

function applyStatusEffectsDamage() {
  // Player status effects
  game.statusEffects.forEach(effect => {
    const effectType = game.statusEffectTypes[effect.type];
    if (effectType.damage) {
      game.player.hp = Math.max(0, game.player.hp - effectType.damage);
      addCombatLog(`${effectType.name}: -${effectType.damage} HP`);
    }
    if (effectType.sanityLoss) {
      game.player.sanity = Math.max(0, game.player.sanity - effectType.sanityLoss);
      addCombatLog(`${effectType.name}: -${effectType.sanityLoss} SAN`);
    }
    if (effectType.healEnemy) {
      game.currentEnemy.hp = Math.min(game.currentEnemy.maxHp, game.currentEnemy.hp + effectType.damage);
      addCombatLog(`${effectType.name}: Enemy heals ${effectType.damage} HP`);
    }
  });
  
  // Enemy status effects
  game.enemyStatusEffects.forEach(effect => {
    const effectType = game.statusEffectTypes[effect.type];
    if (effectType.damage) {
      game.currentEnemy.hp = Math.max(0, game.currentEnemy.hp - effectType.damage);
      addCombatLog(`${effectType.name}: -${effectType.damage} HP to enemy`);
    }
    if (effectType.heal) {
      game.currentEnemy.hp = Math.min(game.currentEnemy.maxHp, game.currentEnemy.hp + effectType.heal);
      addCombatLog(`${effectType.name}: Enemy heals ${effectType.heal} HP`);
    }
  });
  
  // Update durations
  game.statusEffects.forEach(effect => effect.duration--);
  game.enemyStatusEffects.forEach(effect => effect.duration--);
  
  // Remove expired effects
  game.statusEffects = game.statusEffects.filter(e => e.duration > 0);
  game.enemyStatusEffects = game.enemyStatusEffects.filter(e => e.duration > 0);
  
  updateUI();
}

function updateCombatStatusEffects() {
  const playerEffects = document.getElementById('player-combat-status-effects');
  const enemyEffects = document.getElementById('enemy-status-effects');
  
  playerEffects.innerHTML = '';
  enemyEffects.innerHTML = '';
  
  game.statusEffects.forEach(effect => {
    const effectType = game.statusEffectTypes[effect.type];
    const span = document.createElement('div');
    span.textContent = `${effectType.name} (${effect.duration})`;
    span.className = effectType.class;
    playerEffects.appendChild(span);
  });
  
  game.enemyStatusEffects.forEach(effect => {
    const effectType = game.statusEffectTypes[effect.type];
    const span = document.createElement('div');
    span.textContent = `${effectType.name} (${effect.duration})`;
    span.className = effectType.class;
    enemyEffects.appendChild(span);
  });
}

function enemyDefeated() {
  // Award XP and gold
  game.player.xp += game.currentEnemy.xp;
  game.player.gold += game.currentEnemy.gold;
  
  addCombatLog(`${game.currentEnemy.name} DEFEATED! +${game.currentEnemy.xp} XP | +${game.currentEnemy.gold} GOLD`);
  
  // Check for quest completion
  if (game.currentEnemy.name === "COUNT DRACULA") {
    completeQuest("slay-dracula");
    // Mark game as completed for New Game+
    localStorage.setItem('draculasCurseCompleted', JSON.stringify({
      player: {
        ...game.player,
        character: Object.keys(game.characters).find(key => game.characters[key].name === game.player.name)
      }
    }));
    document.getElementById('new-game-plus-button').style.display = 'block';
  } else if (game.currentEnemy.name === "WEREWOLF") {
    completeQuest("kill-werewolf");
  } else if (game.currentEnemy.name === "MAD ALCHEMIST") {
    completeQuest("defeat-alchemist");
  } else if (game.currentEnemy.name === "FALLEN PALADIN") {
    completeQuest("explore-chapel");
  }
  
  // Check for level up
  if (game.player.xp >= game.player.nextLevelXp) {
    levelUp();
  }
  
  updateUI();
  
  // End combat
  setTimeout(() => {
    game.inCombat = false;
    game.statusEffects = [];
    document.getElementById('combat-modal').style.display = 'none';
    addToScene(`You defeated the ${game.currentEnemy.name}!`);
    
    // Progress through locations
    if (game.currentEnemy.name === "COUNT DRACULA") {
      // Game completed
      addToScene("CONGRATULATIONS! You have defeated Dracula and lifted the curse!");
      addToScene("The villagers will sing songs of your bravery for generations to come.");
    } else if (game.location < game.locations.length - 1 && Math.random() < 0.3) {
      game.location++;
      updateLocation();
      addToScene(`You progress deeper into the castle...`);
      addToScene(game.locations[game.location].desc);
    }
  }, 1500);
}

function levelUp() {
  game.player.level++;
  game.player.xp -= game.player.nextLevelXp;
  game.player.nextLevelXp = Math.floor(game.player.nextLevelXp * 1.5);
  
  // Stat increases
  game.player.maxHp += 10;
  game.player.hp = game.player.maxHp;
  game.player.maxSanity += 5;
  game.player.sanity = game.player.maxSanity;
  
  // Random stat boost
  const stat = ["strength", "agility", "intelligence"][Math.floor(Math.random() * 3)];
  game.player[stat]++;
  
  // Check for ability unlocks
  if (game.player.level === 5) {
    if (game.player.name === "JONATHAN HARKER") {
      game.player.unlockedAbilities.push("VAMPIRE SLAYER");
      game.player.skills.push("VAMPIRE SLAYER");
    } else if (game.player.name === "VAN HELSING") {
      game.player.unlockedAbilities.push("ALCHEMICAL SHIELD");
      game.player.skills.push("ALCHEMICAL SHIELD");
    } else if (game.player.name === "MINA MURRAY") {
      game.player.unlockedAbilities.push("CLAIRVOYANCE");
      game.player.skills.push("CLAIRVOYANCE");
    } else if (game.player.name === "QUINCEY MORRIS") {
      game.player.unlockedAbilities.push("FAN FIRE");
      game.player.skills.push("FAN FIRE");
    }
  }
  
  if (game.player.level === 10) {
    if (game.player.name === "JONATHAN HARKER") {
      game.player.unlockedAbilities.push("FINAL BLOW");
      game.player.skills.push("FINAL BLOW");
    } else if (game.player.name === "VAN HELSING") {
      game.player.unlockedAbilities.push("SUN BOMB");
      game.player.skills.push("SUN BOMB");
    } else if (game.player.name === "MINA MURRAY") {
      game.player.unlockedAbilities.push("SPIRIT WARD");
      game.player.skills.push("SPIRIT WARD");
    } else if (game.player.name === "QUINCEY MORRIS") {
      game.player.unlockedAbilities.push("SILVER BULLET");
      game.player.skills.push("SILVER BULLET");
    }
  }
  
  addCombatLog(`LEVEL UP! NOW LEVEL ${game.player.level}`);
  addCombatLog(`+10 MAX HP | +5 MAX SANITY | +1 ${stat.toUpperCase()}`);
  
  if (game.player.level === 5 || game.player.level === 10) {
    addCombatLog(`NEW ABILITY UNLOCKED: ${game.player.unlockedAbilities[game.player.unlockedAbilities.length - 1]}!`);
  }
  
  updateUI();
}

function specialAttack() {
  if (!game.inCombat) return;
  
  if (game.player.skills.includes("SILVER STRIKE")) {
    const weapon = game.items[game.player.equippedWeapon];
    if (weapon && weapon.special === "silver") {
      playerAttack(); // Regular attack will be doubled
    } else {
      addCombatLog("YOU NEED A SILVER WEAPON!");
    }
  } else if (game.player.skills.includes("HOLY WATER")) {
    const holyWaterIndex = game.player.inventory.indexOf("holy-water");
    if (holyWaterIndex !== -1) {
      game.player.inventory.splice(holyWaterIndex, 1);
      let damage = 30; // Double effectiveness
      if (game.currentEnemy.weakness.includes("holy")) damage = Math.floor(damage * 1.5);
      
      game.currentEnemy.hp -= damage;
      document.getElementById('enemy-hp').textContent = Math.max(0, game.currentEnemy.hp);
      document.getElementById('enemy-hp-bar').style.width = `${(game.currentEnemy.hp / game.currentEnemy.maxHp) * 100}%`;
      
      addCombatLog(`YOU THROW HOLY WATER FOR ${damage} DAMAGE!`);
      
      if (game.currentEnemy.hp <= 0) {
        enemyDefeated();
      } else {
        setTimeout(() => enemyAttack(), 1000);
      }
    } else {
      addCombatLog("YOU HAVE NO HOLY WATER!");
    }
  } else if (game.player.skills.includes("HYPNOSIS")) {
    if (Math.random() < 0.6) {
      addCombatLog(`YOU HYPNOTIZE THE ${game.currentEnemy.name}! IT SKIPS ITS TURN!`);
    } else {
      addCombatLog("YOUR HYPNOSIS FAILS!");
      setTimeout(() => enemyAttack(), 1000);
    }
  } else if (game.player.skills.includes("VAMPIRE SLAYER")) {
    if (game.currentEnemy.name.includes("VAMPIRE") || game.currentEnemy.name === "COUNT DRACULA") {
      playerAttack(); // Regular attack will get the bonus
    } else {
      addCombatLog("THIS ABILITY ONLY WORKS ON VAMPIRES!");
    }
  } else if (game.player.skills.includes("ALCHEMICAL SHIELD")) {
    applyStatusEffect("shield");
    addCombatLog("ALCHEMICAL SHIELD: Damage reduced by 30% for 2 turns!");
    setTimeout(() => enemyAttack(), 1000);
  } else if (game.player.skills.includes("FAN FIRE")) {
    // Quincey's Fan Fire - attack 3 times at reduced damage
    const weapon = game.items[game.player.equippedWeapon] || game.items.fists;
    let totalDamage = 0;
    
    for (let i = 0; i < 3; i++) {
      let damage = Math.floor(weapon.damage * 0.6) + Math.floor(Math.random() * 3);
      damage += Math.floor(game.player.strength / 3);
      
      // Check for critical
      const isCritical = Math.random() < 0.05 + (game.player.agility / 100) + 
        (game.player.skills.includes("MARKSMANSHIP") ? 0.25 : 0);
      if (isCritical) damage = Math.floor(damage * 1.5);
      
      totalDamage += damage;
      addCombatLog(`Fan Fire hit for ${damage} damage${isCritical ? ' (CRIT!)' : ''}`);
    }
    
    game.currentEnemy.hp -= totalDamage;
    document.getElementById('enemy-hp').textContent = Math.max(0, game.currentEnemy.hp);
    document.getElementById('enemy-hp-bar').style.width = `${(game.currentEnemy.hp / game.currentEnemy.maxHp) * 100}%`;
    
    showDamageNumber(totalDamage, document.getElementById('enemy-display'), false);
    
    if (game.currentEnemy.hp <= 0) {
      enemyDefeated();
    } else {
      setTimeout(() => enemyAttack(), 1000);
    }
  } else if (game.player.skills.includes("SILVER BULLET")) {
    // Quincey's ultimate ability
    const silverBulletIndex = game.player.inventory.indexOf("silver-bullet");
    if (silverBulletIndex !== -1) {
      game.player.inventory.splice(silverBulletIndex, 1);
      let damage = 50;
      
      if (game.currentEnemy.weakness && 
          (game.currentEnemy.weakness.includes("silver") || game.currentEnemy.weakness.includes("holy"))) {
        damage = Math.floor(damage * 1.5);
      }
      
      game.currentEnemy.hp -= damage;
      document.getElementById('enemy-hp').textContent = Math.max(0, game.currentEnemy.hp);
      document.getElementById('enemy-hp-bar').style.width = `${(game.currentEnemy.hp / game.currentEnemy.maxHp) * 100}%`;
      
      addCombatLog(`SILVER BULLET: You deal ${damage} massive damage!`);
      
      if (game.currentEnemy.hp <= 0) {
        enemyDefeated();
      } else {
        setTimeout(() => enemyAttack(), 1000);
      }
    } else {
      addCombatLog("YOU HAVE NO SILVER BULLETS!");
    }
  } else if (game.player.skills.includes("CLAIRVOYANCE") && !game.inCombat) {
    // Handled in explore function
  } else if (game.player.skills.includes("SPIRIT WARD")) {
    applyStatusEffect("spirit-ward");
    addCombatLog("SPIRIT WARD: You're protected from sanity loss for 3 turns!");
    setTimeout(() => enemyAttack(), 1000);
  }
}

function playerDefeated() {
  addCombatLog("YOU HAVE BEEN DEFEATED!");
  setTimeout(() => {
    game.inCombat = false;
    document.getElementById('combat-modal').style.display = 'none';
    document.getElementById('game-over-modal').style.display = 'block';
  }, 1500);
}

function useItemInCombat() {
  openInventory();
}

function attemptFlee() {
  // Agility affects flee chance
  const fleeChance = 0.5 + (game.player.agility / 100);
  
  if (Math.random() < fleeChance) {
    addCombatLog("YOU SUCCESSFULLY FLEE!");
    setTimeout(() => {
      game.inCombat = false;
      document.getElementById('combat-modal').style.display = 'none';
      addToScene(`You barely escape from the ${game.currentEnemy.name}!`);
      
      // Return to previous location when fleeing
      if (game.location > 1) {
        game.location--;
        updateLocation();
      }
    }, 1000);
  } else {
    addCombatLog("FAILED TO FLEE!");
    setTimeout(() => enemyAttack(), 1000);
  }
}

// Location Functions
function updateLocation() {
  document.getElementById('dungeon-level').textContent = game.locations[game.location].name;
  
  // Update action buttons
  if (game.location === 0) {
    document.getElementById('explore-button').textContent = "LEAVE";
    document.getElementById('tavern-action').textContent = "TALK";
    document.getElementById('explore-button').onclick = leaveTavern;
    document.getElementById('tavern-action').onclick = talkToBarkeep;
    document.getElementById('merchant-button').disabled = false;
  } else {
    document.getElementById('explore-button').textContent = "EXPLORE";
    document.getElementById('tavern-action').textContent = "RETURN";
    document.getElementById('explore-button').onclick = explore;
    document.getElementById('tavern-action').onclick = returnToTavern;
    document.getElementById('merchant-button').disabled = true;
  }
}

function leaveTavern() {
  game.location = 1;
  updateLocation();
  clearScene();
  addToScene(game.locations[1].desc);
  
  // Random travel event
  if (Math.random() < 0.5) {
    const event = game.travelEvents[Math.floor(Math.random() * game.travelEvents.length)];
    addToScene(event.text);
    
    switch(event.effect) {
      case "findItem":
        findItem();
        break;
      case "loseSanity":
        game.player.sanity = Math.max(0, game.player.sanity - event.amount);
        updateUI();
        break;
      case "progressFaster":
        game.location = Math.min(game.location + 1, game.locations.length - 1);
        updateLocation();
        break;
      case "revealHidden":
        if (game.player.skills.includes("CLAIRVOYANCE")) {
          game.locations.forEach(loc => {
            if (loc.hidden) loc.hidden = false;
          });
          addToScene("The journal reveals hidden locations in the castle!");
        }
        break;
    }
  }
  
  setTimeout(() => startRandomEncounter(), 1000);
}

function returnToTavern() {
  game.location = 0;
  updateLocation();
  clearScene();
  addToScene(game.locations[0].desc);
}

function talkToBarkeep() {
  if (!game.hasStake) {
    addToScene(`"Take this," the barkeep says, sliding a WOODEN STAKE across the counter.`);
    game.player.inventory.push("wooden-stake");
    game.hasStake = true;
    completeQuest("find-stake");
  } else {
    const dialogues = [
      `"You still here? Don't say I didn't warn you," the barkeep mutters.`,
      `"The nights grow longer. Dracula's power increases," he whispers.`,
      `"The merchant has good wares, but don't trust him too much," he advises.`,
      `"They say there's a werewolf in the mountains... be careful out there."`,
      `"I heard there's a powerful weapon hidden in the castle dungeons."`,
      `"Some say there's a secret chapel in the castle with powerful relics."`,
      `"A mad alchemist was last seen in the castle's lower levels."`
    ];
    addToScene(dialogues[Math.floor(Math.random() * dialogues.length)]);
  }
}

function rest() {
  const healAmount = Math.floor(game.player.maxHp * 0.3);
  const sanityAmount = Math.floor(game.player.maxSanity * 0.2);
  
  game.player.hp = Math.min(game.player.maxHp, game.player.hp + healAmount);
  game.player.sanity = Math.min(game.player.maxSanity, game.player.sanity + sanityAmount);
  
  // Rest cures some status effects
  game.statusEffects = game.statusEffects.filter(e => !["bleed", "poison"].includes(e.type));
  updateStatusEffects();
  
  addToScene(`You rest and recover ${healAmount} HP and ${sanityAmount} sanity.`);
  updateUI();
  
  if (game.location > 0 && Math.random() < 0.2) {
    setTimeout(() => {
      addToScene(`You are ambushed while resting!`);
      startRandomEncounter();
    }, 1000);
  }
}

// Merchant Functions
function openMerchant() {
  // Update gold display
  document.getElementById('merchant-gold-amount').textContent = game.player.gold;
  
  // Create buy list
  const buyList = document.getElementById('merchant-buy-list');
  buyList.innerHTML = '';
  
  game.merchantItems.forEach(item => {
    const itemElement = document.createElement('div');
    itemElement.className = 'merchant-item';
    itemElement.innerHTML = `
      <span>${item.name} (${item.price} GOLD)</span>
      <button class="buy-button" data-id="${item.id}" data-price="${item.price}">BUY</button>
    `;
    buyList.appendChild(itemElement);
  });
  
  // Create sell list
  const sellList = document.getElementById('merchant-sell-list');
  sellList.innerHTML = '';
  
  // Count items
  const itemCounts = {};
  game.player.inventory.forEach(item => {
    if (game.items[item] && item !== "fists") {
      itemCounts[item] = (itemCounts[item] || 0) + 1;
    }
  });
  
  // Add sellable items
  Object.keys(itemCounts).forEach(itemId => {
    const item = game.items[itemId];
    const sellPrice = Math.floor((item.damage || item.heal || 5) * 2);
    
    const itemElement = document.createElement('div');
    itemElement.className = 'merchant-item';
    itemElement.innerHTML = `
      <span>${item.name} x${itemCounts[itemId]} (${sellPrice} GOLD)</span>
      <button class="sell-button" data-id="${itemId}" data-price="${sellPrice}">SELL</button>
    `;
    sellList.appendChild(itemElement);
  });
  
  // Add event listeners
  document.querySelectorAll('.buy-button').forEach(button => {
    button.addEventListener('click', function() {
      const itemId = this.dataset.id;
      const price = parseInt(this.dataset.price);
      
      if (game.player.gold >= price) {
        game.player.gold -= price;
        game.player.inventory.push(itemId);
        updateUI();
        document.getElementById('merchant-gold-amount').textContent = game.player.gold;
        addToScene(`You bought a ${game.items[itemId].name} for ${price} gold.`);
        openMerchant(); // Refresh
      } else {
        addToScene("Not enough gold!");
      }
    });
  });
  
  document.querySelectorAll('.sell-button').forEach(button => {
    button.addEventListener('click', function() {
      const itemId = this.dataset.id;
      const price = parseInt(this.dataset.price);
      
      // Remove from inventory
      const index = game.player.inventory.indexOf(itemId);
      if (index !== -1) {
        game.player.inventory.splice(index, 1);
        game.player.gold += price;
        updateUI();
        document.getElementById('merchant-gold-amount').textContent = game.player.gold;
        addToScene(`You sold a ${game.items[itemId].name} for ${price} gold.`);
        openMerchant(); // Refresh
      }
    });
  });
  
  document.getElementById('merchant-modal').style.display = 'block';
}

// Inventory Functions
function openInventory() {
  // Weapons
  const weaponsList = document.getElementById('weapons-list');
  weaponsList.innerHTML = '';
  
  // Count weapons
  const weaponCounts = {};
  game.player.inventory.forEach(item => {
    if (game.items[item]?.damage) {
      weaponCounts[item] = (weaponCounts[item] || 0) + 1;
    }
  });
  
  // Add fists (always available)
  weaponCounts["fists"] = 1;
  
  // Display weapons
  Object.keys(weaponCounts).forEach(weaponId => {
    const weapon = game.items[weaponId];
    const isEquipped = weaponId === game.player.equippedWeapon;
    
    const weaponElement = document.createElement('div');
    weaponElement.className = 'item-row';
    weaponElement.innerHTML = `
      <span>${weapon.name} (${weapon.damage} DMG)${isEquipped ? ' [EQUIPPED]' : ''}</span>
      <button class="equip-button" data-id="${weaponId}">${isEquipped ? 'UNEQUIP' : 'EQUIP'}</button>
    `;
    weaponsList.appendChild(weaponElement);
  });
  
  // Items
  const itemsList = document.getElementById('items-list');
  itemsList.innerHTML = '';
  
  // Count items
  const itemCounts = {};
  game.player.inventory.forEach(item => {
    if (game.items[item]?.heal || game.items[item]?.special === "cure") {
      itemCounts[item] = (itemCounts[item] || 0) + 1;
    }
  });
  
  // Display items
  Object.keys(itemCounts).forEach(itemId => {
    const item = game.items[itemId];
    
    const itemElement = document.createElement('div');
    itemElement.className = 'item-row';
    itemElement.innerHTML = `
      <span>${item.name} x${itemCounts[itemId]}</span>
      <button class="use-button" data-id="${itemId}">USE</button>
    `;
    itemsList.appendChild(itemElement);
  });
  
  // Add event listeners
  document.querySelectorAll('.equip-button').forEach(button => {
    button.addEventListener('click', function() {
      const weaponId = this.dataset.id;
      
      if (game.player.equippedWeapon === weaponId) {
        game.player.equippedWeapon = "fists";
        addToScene(`You unequip your weapon.`);
      } else {
        game.player.equippedWeapon = weaponId;
        addToScene(`You equip the ${game.items[weaponId].name}.`);
      }
      
      updateUI();
      openInventory(); // Refresh
    });
  });
  
  document.querySelectorAll('.use-button').forEach(button => {
    button.addEventListener('click', function() {
      const itemId = this.dataset.id;
      const item = game.items[itemId];
      
      if (item.heal) {
        const healAmount = Math.min(item.heal, game.player.maxHp - game.player.hp);
        game.player.hp += healAmount;
        
        // Remove from inventory
        const index = game.player.inventory.indexOf(itemId);
        if (index !== -1) game.player.inventory.splice(index, 1);
        
        if (game.inCombat) {
          addCombatLog(`YOU USE A ${item.name} AND HEAL ${healAmount} HP!`);
          setTimeout(() => enemyAttack(), 1000);
        } else {
          addToScene(`You use a ${item.name} and heal ${healAmount} HP.`);
        }
        
        updateUI();
        openInventory(); // Refresh
      } else if (item.special === "cure") {
        // Remove all negative status effects
        game.statusEffects = [];
        updateStatusEffects();
        
        // Remove from inventory
        const index = game.player.inventory.indexOf(itemId);
        if (index !== -1) game.player.inventory.splice(index, 1);
        
        if (game.inCombat) {
          addCombatLog(`YOU USE AN ${item.name} AND CURE ALL AILMENTS!`);
          setTimeout(() => enemyAttack(), 1000);
        } else {
          addToScene(`You use an ${item.name} and cure all ailments.`);
        }
        
        updateUI();
        openInventory(); // Refresh
      } else if (item.special === "spirit-ward") {
        applyStatusEffect("spirit-ward");
        addCombatLog("SPIRIT WARD: You're protected from sanity loss for 3 turns!");
        
        // Remove from inventory
        const index = game.player.inventory.indexOf(itemId);
        if (index !== -1) game.player.inventory.splice(index, 1);
        
        setTimeout(() => enemyAttack(), 1000);
        openInventory(); // Refresh
      }
    });
  });
  
  document.getElementById('inventory-modal').style.display = 'block';
}

// Character Stats
function openCharacter() {
  document.getElementById('character-name').textContent = game.player.name;
  document.getElementById('character-class').textContent = game.player.class;
  document.getElementById('character-level').textContent = game.player.level;
  
  document.getElementById('character-strength').textContent = game.player.strength;
  document.getElementById('character-agility').textContent = game.player.agility;
  document.getElementById('character-intelligence').textContent = game.player.intelligence;
  
  const skillsList = document.getElementById('character-skills');
  skillsList.innerHTML = '';
  
  game.player.skills.forEach(skill => {
    const skillElement = document.createElement('div');
    skillElement.textContent = ` ${skill}`;
    skillsList.appendChild(skillElement);
  });
  
  const statusEffectsList = document.getElementById('character-status-effects');
  statusEffectsList.innerHTML = '';
  
  game.statusEffects.forEach(effect => {
    const effectType = game.statusEffectTypes[effect.type];
    const effectElement = document.createElement('div');
    effectElement.textContent = ` ${effectType.name} (${effect.duration} turns)`;
    effectElement.className = effectType.class;
    statusEffectsList.appendChild(effectElement);
  });
  
  document.getElementById('character-modal').style.display = 'block';
}

// Quests
function openQuests() {
  const activeQuests = document.getElementById('active-quests');
  activeQuests.innerHTML = '';
  
  game.quests.active.forEach(quest => {
    const questElement = document.createElement('div');
    questElement.style.padding = '5px 0';
    questElement.style.borderBottom = '1px dashed red';
    questElement.innerHTML = `
      <div style="font-weight: bold;">${quest.title}</div>
      <div>${quest.description}</div>
      <div>${quest.completed ? '(Completed)' : '(Active)'}</div>
    `;
    activeQuests.appendChild(questElement);
  });
  
  const completedQuests = document.getElementById('completed-quests');
  completedQuests.innerHTML = '';
  
  game.quests.completed.forEach(quest => {
    const questElement = document.createElement('div');
    questElement.style.padding = '5px 0';
    questElement.style.borderBottom = '1px dashed red';
    questElement.innerHTML = `
      <div style="font-weight: bold; color: #0f0;">${quest.title}</div>
      <div>${quest.description}</div>
    `;
    completedQuests.appendChild(questElement);
  });
  
  const sideQuests = document.getElementById('side-quests');
  sideQuests.innerHTML = '';
  
  game.quests.side.forEach(quest => {
    if (quest.hidden && !game.player.skills.includes("CLAIRVOYANCE")) return;
    
    const questElement = document.createElement('div');
    questElement.style.padding = '5px 0';
    questElement.style.borderBottom = '1px dashed red';
    questElement.innerHTML = `
      <div style="font-weight: bold;">${quest.title}</div>
      <div>${quest.description}</div>
      <div>${quest.completed ? '(Completed)' : '(Active)'}</div>
    `;
    sideQuests.appendChild(questElement);
  });
  
  document.getElementById('quests-modal').style.display = 'block';
}

function completeQuest(questId) {
  // Main quests
  const mainQuestIndex = game.quests.active.findIndex(q => q.id === questId);
  if (mainQuestIndex !== -1) {
    const quest = game.quests.active[mainQuestIndex];
    quest.completed = true;
    
    // Move to completed
    game.quests.completed.push(quest);
    game.quests.active.splice(mainQuestIndex, 1);
    
    addToScene(`QUEST COMPLETED: ${quest.title}`);
  }
  
  // Side quests
  const sideQuestIndex = game.quests.side.findIndex(q => q.id === questId);
  if (sideQuestIndex !== -1) {
    const quest = game.quests.side[sideQuestIndex];
    quest.completed = true;
    
    // Give reward
    if (quest.reward) {
      game.player.inventory.push(quest.reward);
      addToScene(`You received ${game.items[quest.reward].name} as a reward!`);
    }
    
    addToScene(`SIDE QUEST COMPLETED: ${quest.title}`);
  }
  
  // Refresh if open
  if (document.getElementById('quests-modal').style.display === 'block') {
    openQuests();
  }
}

// Map
function openMap() {
  // Simple ASCII map showing progress
  let map = '';
  for (let i = 0; i < game.locations.length; i++) {
    if (game.locations[i].hidden && !game.player.skills.includes("CLAIRVOYANCE")) continue;
    
    if (i < game.location) {
      map += ` ${game.locations[i].name}\n`;
    } else if (i === game.location) {
      map += `X ${game.locations[i].name}\n`;
    } else {
      map += ` ${game.locations[i].name}\n`;
    }
  }
  
  alert(`MAP:\n\n${map}`);
}

// Utility Functions
function addToScene(text) {
  const scene = document.getElementById('scene-description');
  scene.innerHTML += `<p>${text}</p>`;
  scene.scrollTop = scene.scrollHeight;
}

function addCombatLog(text) {
  const log = document.getElementById('combat-log-modal');
  log.innerHTML += `<p>${text}</p>`;
  log.scrollTop = log.scrollHeight;
}

function clearScene() {
  document.getElementById('scene-description').innerHTML = '';
}

function hideAllModals() {
  document.querySelectorAll('.modal').forEach(modal => {
    modal.style.display = 'none';
  });
  
  // If in combat, return to combat modal
  if (game.inCombat) {
    document.getElementById('combat-modal').style.display = 'block';
  }
}

function tryAgain() {
  document.getElementById('game-over-modal').style.display = 'none';
  game.player.hp = game.player.maxHp;
  game.player.sanity = game.player.maxSanity;
  game.statusEffects = [];
  updateUI();
}

function returnToMainMenu() {
  document.getElementById('game-over-modal').style.display = 'none';
  document.getElementById('main-game').style.display = 'none';
  document.getElementById('character-selection').style.display = 'flex';
}

// Save/Load
function saveGame() {
  localStorage.setItem('draculasCurseSave', JSON.stringify(game));
  addToScene("Game saved successfully.");
}

function loadGame() {
  const saved = JSON.parse(localStorage.getItem('draculasCurseSave'));
  if (saved) {
    Object.assign(game, saved);
    document.getElementById('character-selection').style.display = 'none';
    document.getElementById('main-game').style.display = 'flex';
    updateUI();
    bindButtons();
    updateLocation();
    addToScene(`Game loaded. Welcome back, ${game.player.name}!`);
  }
}
</script>
</body>
</html>
