<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Might and Magic: Book One (Mobile)</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        :root {
            --primary-color: #0f0;
            --secondary-color: #0ff;
            --danger-color: #f00;
            --warning-color: #ff0;
            --bg-color: #000;
            --panel-bg: #111;
            --border-color: #333;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Press Start 2P', monospace;
            background-color: var(--bg-color);
            color: #fff;
            touch-action: manipulation;
        }
        
        .game-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 10px;
            max-width: 100%;
        }
        
        .header {
            flex-shrink: 0;
            text-align: center;
            padding: 10px 5px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .game-title {
            font-size: 18px;
            color: var(--primary-color);
            text-shadow: 0 0 5px var(--primary-color);
            margin-bottom: 5px;
            line-height: 1.3;
        }
        
        .subtitle {
            font-size: 10px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .location-bar {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 8px;
            font-size: 11px;
            color: var(--secondary-color);
            text-align: center;
            margin-top: 5px;
            border-radius: 3px;
        }
        
        .main-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            min-height: 0;
        }
        
        .game-screen {
            flex: 3;
            border: 2px solid var(--border-color);
            background-color: var(--bg-color);
            padding: 12px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.5;
            border-radius: 5px;
            min-height: 0;
        }
        
        .game-message {
            margin-bottom: 10px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .game-message.system {
            color: var(--secondary-color);
        }
        
        .game-message.combat {
            color: var(--danger-color);
        }
        
        .game-message.loot {
            color: var(--warning-color);
        }
        
        .game-message.quest {
            color: #f0f;
        }
        
        .panels-row {
            display: flex;
            gap: 10px;
            flex: 2;
            min-height: 0;
        }
        
        .panel {
            border: 2px solid var(--border-color);
            background-color: var(--panel-bg);
            padding: 10px;
            border-radius: 5px;
            overflow-y: auto;
            min-height: 0;
        }
        
        .stats-panel {
            flex: 1.2;
        }
        
        .inventory-panel {
            flex: 1;
        }
        
        .panel-title {
            color: var(--primary-color);
            font-size: 10px;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 4px;
        }
        
        .character-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .character-card {
            border: 1px solid var(--border-color);
            padding: 8px;
            border-radius: 3px;
            background-color: rgba(0, 30, 0, 0.3);
        }
        
        .char-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .char-name {
            color: var(--secondary-color);
            font-size: 9px;
        }
        
        .char-class {
            color: #aaa;
            font-size: 8px;
        }
        
        .char-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            font-size: 8px;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
        }
        
        .stat-value {
            color: var(--primary-color);
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .inventory-item {
            border: 1px solid var(--border-color);
            padding: 6px;
            border-radius: 3px;
            font-size: 9px;
            background-color: rgba(0, 20, 30, 0.3);
        }
        
        .item-name {
            color: #fff;
            margin-bottom: 2px;
        }
        
        .item-count {
            color: var(--primary-color);
            text-align: right;
            font-size: 10px;
        }
        
        .controls-area {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 5px;
        }
        
        .quick-commands {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        
        .cmd-btn {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 9px;
            padding: 8px 4px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.1s;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .cmd-btn:active {
            background-color: #222;
            transform: translateY(1px);
        }
        
        .cmd-btn.primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .cmd-btn.danger {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .cmd-btn.warning {
            color: var(--warning-color);
            border-color: var(--warning-color);
        }
        
        .input-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .prompt {
            color: var(--primary-color);
            font-size: 12px;
        }
        
        #command {
            flex: 1;
            background-color: var(--panel-bg);
            color: #fff;
            border: 1px solid var(--border-color);
            padding: 10px;
            font-family: 'Press Start 2P', monospace;
            font-size: 11px;
            border-radius: 4px;
            min-width: 0;
        }
        
        #execute {
            background-color: var(--panel-bg);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 10px 15px;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            cursor: pointer;
            border-radius: 4px;
            white-space: nowrap;
        }
        
        #execute:active {
            background-color: #0a0a0a;
        }
        
        .hp-bar, .mp-bar {
            height: 6px;
            background-color: #333;
            border-radius: 3px;
            margin-top: 2px;
            overflow: hidden;
        }
        
        .hp-fill {
            height: 100%;
            background-color: var(--danger-color);
            transition: width 0.3s;
        }
        
        .mp-fill {
            height: 100%;
            background-color: var(--secondary-color);
            transition: width 0.3s;
        }
        
        .combat-alert {
            animation: pulse 1s infinite;
            border-color: var(--danger-color) !important;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 5px var(--danger-color); }
            50% { box-shadow: 0 0 15px var(--danger-color); }
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        .tab {
            padding: 8px 12px;
            font-size: 10px;
            color: #777;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Enemy health bar */
        .enemy-health {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 8px;
            background-color: rgba(255, 0, 0, 0.1);
            border-radius: 4px;
            border: 1px solid var(--danger-color);
        }
        
        .enemy-name {
            color: var(--danger-color);
            font-size: 11px;
        }
        
        .enemy-hp-bar {
            flex: 1;
            height: 10px;
            background-color: #333;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .enemy-hp-fill {
            height: 100%;
            background-color: var(--danger-color);
            transition: width 0.3s;
        }
        
        /* Mobile optimizations */
        @media (max-height: 700px) {
            .game-screen {
                font-size: 11px;
                padding: 8px;
            }
            
            .cmd-btn {
                padding: 6px 2px;
                font-size: 8px;
            }
            
            .character-card {
                padding: 6px;
            }
        }
        
        @media (max-height: 600px) {
            .header {
                padding: 5px;
            }
            
            .game-title {
                font-size: 16px;
            }
            
            .subtitle {
                font-size: 9px;
            }
            
            .panels-row {
                flex: 1.8;
            }
        }
        
        /* Hide scrollbars but keep functionality */
        .game-screen::-webkit-scrollbar,
        .panel::-webkit-scrollbar {
            width: 5px;
        }
        
        .game-screen::-webkit-scrollbar-track,
        .panel::-webkit-scrollbar-track {
            background: #111;
        }
        
        .game-screen::-webkit-scrollbar-thumb,
        .panel::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }
        
        /* Game map modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: var(--panel-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .modal-title {
            color: var(--primary-color);
            font-size: 14px;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .game-map {
            font-family: monospace;
            font-size: 10px;
            line-height: 1.2;
            color: var(--primary-color);
            white-space: pre;
            overflow-x: auto;
        }
        
        .current-location {
            color: var(--warning-color);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="game-title">MIGHT AND MAGIC</div>
            <div class="subtitle">BOOK ONE: SECRET OF THE INNER SANCTUM</div>
            <div class="location-bar" id="location-bar">Sorpigal Gates</div>
        </div>
        
        <div class="main-area">
            <div class="game-screen" id="game-screen">
                <!-- Game messages will appear here -->
            </div>
            
            <div class="panels-row">
                <div class="panel stats-panel">
                    <div class="panel-title">PARTY</div>
                    <div class="character-info" id="character-info">
                        <!-- Character cards will appear here -->
                    </div>
                </div>
                
                <div class="panel inventory-panel">
                    <div class="tab-container">
                        <div class="tab active" data-tab="inventory">INVENTORY</div>
                        <div class="tab" data-tab="quests">QUESTS</div>
                        <div class="tab" data-tab="spells">SPELLS</div>
                    </div>
                    
                    <div class="tab-content active" id="inventory-tab">
                        <div class="inventory-grid" id="inventory-list">
                            <!-- Inventory items will appear here -->
                        </div>
                    </div>
                    
                    <div class="tab-content" id="quests-tab">
                        <div id="quests-list">
                            <!-- Quests will appear here -->
                        </div>
                    </div>
                    
                    <div class="tab-content" id="spells-tab">
                        <div id="spells-list">
                            <!-- Spells will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls-area">
            <div class="quick-commands">
                <button class="cmd-btn primary" data-cmd="north">NORTH</button>
                <button class="cmd-btn primary" data-cmd="south">SOUTH</button>
                <button class="cmd-btn primary" data-cmd="east">EAST</button>
                <button class="cmd-btn primary" data-cmd="west">WEST</button>
                <button class="cmd-btn" data-cmd="look">LOOK</button>
                <button class="cmd-btn danger" data-cmd="attack">ATTACK</button>
                <button class="cmd-btn" data-cmd="search">SEARCH</button>
                <button class="cmd-btn warning" data-cmd="rest">REST</button>
            </div>
            
            <div class="input-row">
                <span class="prompt">></span>
                <input type="text" id="command" placeholder="Type command..." autocomplete="off" autofocus>
                <button id="execute">EXEC</button>
            </div>
        </div>
    </div>
    
    <!-- Map Modal -->
    <div class="modal" id="map-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">WORLD MAP</div>
                <button class="close-modal" id="close-map">&times;</button>
            </div>
            <div class="game-map" id="game-map">
                <!-- Map will appear here -->
            </div>
        </div>
    </div>
    
    <!-- Shop Modal -->
    <div class="modal" id="shop-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="shop-title">SHOP</div>
                <button class="close-modal" id="close-shop">&times;</button>
            </div>
            <div id="shop-items">
                <!-- Shop items will appear here -->
            </div>
        </div>
    </div>

    <script>
        // Enhanced game state
        const gameState = {
            location: "sorpigal_gates",
            party: [
                { 
                    name: "SIR GALAND", 
                    class: "KNIGHT", 
                    hp: 32, 
                    hpMax: 32, 
                    mp: 0, 
                    mpMax: 0, 
                    level: 1, 
                    exp: 0,
                    expNext: 100,
                    str: 16,
                    agi: 10,
                    vit: 14,
                    int: 8,
                    weapon: "Long Sword",
                    armor: "Chainmail",
                    gold: 0
                },
                { 
                    name: "ELWYN", 
                    class: "ARCHER", 
                    hp: 22, 
                    hpMax: 22, 
                    mp: 0, 
                    mpMax: 0, 
                    level: 1, 
                    exp: 0,
                    expNext: 100,
                    str: 12,
                    agi: 16,
                    vit: 10,
                    int: 10,
                    weapon: "Short Bow",
                    armor: "Leather",
                    gold: 0
                },
                { 
                    name: "MERLIN", 
                    class: "SORCERER", 
                    hp: 16, 
                    hpMax: 16, 
                    mp: 25, 
                    mpMax: 25, 
                    level: 1, 
                    exp: 0,
                    expNext: 100,
                    str: 8,
                    agi: 10,
                    vit: 9,
                    int: 18,
                    weapon: "Oak Staff",
                    armor: "Robe",
                    gold: 0,
                    spells: ["Fireball", "Lightning", "Magic Shield"]
                },
                { 
                    name: "FAY", 
                    class: "CLERIC", 
                    hp: 20, 
                    hpMax: 20, 
                    mp: 20, 
                    mpMax: 20, 
                    level: 1, 
                    exp: 0,
                    expNext: 100,
                    str: 10,
                    agi: 9,
                    vit: 12,
                    int: 16,
                    weapon: "Mace",
                    armor: "Chainmail",
                    gold: 0,
                    spells: ["Heal", "Bless", "Cure"]
                }
            ],
            gold: 250,
            food: 14,
            torches: 8,
            keys: 3,
            potions: {
                healing: 4,
                mana: 2,
                antidote: 1
            },
            scrolls: [],
            weapons: [],
            armor: [],
            specialItems: [],
            gameActive: true,
            currentEnemy: null,
            turn: 0,
            quests: [
                { id: 1, name: "Find the Lost Amulet", description: "The innkeeper lost his family amulet in the caves east of town.", status: "active", target: "cave_treasure", reward: 150 },
                { id: 2, name: "Clear the Ruined Tower", description: "Mayor wants you to clear monsters from the tower west of town.", status: "active", target: "tower_cleared", killCount: 0, requiredKills: 5, reward: 200 },
                { id: 3, name: "Secret of the Inner Sanctum", description: "Discover the ancient secret hidden deep within the land.", status: "active", target: "find_sanctum", reward: 1000 }
            ],
            kills: {
                goblin: 0,
                skeleton: 0,
                orc: 0,
                giant_rat: 0,
                wolf: 0,
                bandit: 0
            },
            exploredLocations: ["sorpigal_gates"],
            time: {
                day: 1,
                hour: 8,
                minutes: 0
            }
        };

        // Expanded game locations
        const locations = {
            sorpigal_gates: {
                name: "Sorpigal Gates",
                description: "You stand before the gates of Sorpigal. The town walls are weathered but sturdy. Guards nod as you pass. To the NORTH lies the town square. The wilderness stretches to the EAST and WEST.",
                exits: { north: "sorpigal_square", east: "wilderness_east", west: "wilderness_west" },
                type: "town",
                shop: null,
                explored: true
            },
            sorpigal_square: {
                name: "Sorpigal Town Square",
                description: "The bustling town square of Sorpigal. Merchants hawk their wares. You see an INN to the north, a WEAPON SHOP to the east, a MAGIC SHOP to the south, and a TEMPLE to the west.",
                exits: { 
                    south: "sorpigal_gates", 
                    north: "sorpigal_inn", 
                    east: "weapon_shop", 
                    west: "temple",
                    southeast: "magic_shop"
                },
                type: "town",
                shop: null,
                explored: true
            },
            sorpigal_inn: {
                name: "Sorpigal Inn",
                description: "A warm, inviting inn with a crackling fireplace. The innkeeper smiles. 'Rest here, adventurers. 10 gold per person. Also, I have a quest for someone brave enough...'",
                exits: { south: "sorpigal_square" },
                type: "inn",
                shop: null,
                explored: true
            },
            weapon_shop: {
                name: "Weapon Shop",
                description: "The clang of metal fills the air. A burly smith shows his wares.",
                exits: { west: "sorpigal_square" },
                type: "shop",
                shop: "weapons",
                explored: true
            },
            temple: {
                name: "Temple of Light",
                description: "A serene temple with stained glass windows. The high priest offers healing and blessings.",
                exits: { east: "sorpigal_square" },
                type: "temple",
                shop: "healing",
                explored: true
            },
            magic_shop: {
                name: "Arcane Emporium",
                description: "Strange artifacts line the shelves. A wizard peers at you over his spectacles. 'Looking for magical assistance?'",
                exits: { northwest: "sorpigal_square" },
                type: "shop",
                shop: "magic",
                explored: true
            },
            wilderness_east: {
                name: "Eastern Wilderness",
                description: "Forested hills stretch before you. The path is overgrown. You hear strange noises in the distance. A dark cave entrance is visible to the EAST.",
                exits: { west: "sorpigal_gates", east: "cave_entrance", north: "forest_path" },
                type: "wilderness",
                shop: null,
                explored: false,
                encounterChance: 0.3
            },
            wilderness_west: {
                name: "Western Wilderness",
                description: "Rocky terrain with sparse vegetation. A ruined watchtower stands to the NORTH. The ground is littered with bones.",
                exits: { east: "sorpigal_gates", north: "ruined_tower", south: "rocky_pass" },
                type: "wilderness",
                shop: null,
                explored: false,
                encounterChance: 0.4
            },
            cave_entrance: {
                name: "Cave Entrance",
                description: "A dark cave mouth yawns before you. Foul air wafts from within. Your torch flickers. Strange markings are carved around the entrance.",
                exits: { west: "wilderness_east", enter: "cave_tunnel" },
                type: "dungeon",
                shop: null,
                explored: false,
                encounterChance: 0.5
            },
            cave_tunnel: {
                name: "Cave Tunnel",
                description: "Dark, damp tunnels twist in all directions. The air is cold. Water drips from the ceiling. You can go DEEPER or back to the ENTRANCE.",
                exits: { out: "cave_entrance", deeper: "cave_chamber", north: "cave_side" },
                type: "dungeon",
                shop: null,
                explored: false,
                encounterChance: 0.6
            },
            cave_chamber: {
                name: "Large Cave Chamber",
                description: "The tunnel opens into a large cavern. Strange fungi glow with faint blue light. Ancient bones are scattered about. A passage continues EAST.",
                exits: { west: "cave_tunnel", east: "cave_treasure" },
                type: "dungeon",
                shop: null,
                explored: false,
                encounterChance: 0.7
            },
            cave_treasure: {
                name: "Treasure Chamber",
                description: "A small chamber with a chest in the center. The walls glitter with embedded crystals.",
                exits: { west: "cave_chamber" },
                type: "dungeon",
                shop: null,
                explored: false,
                encounterChance: 0.2
            },
            cave_side: {
                name: "Side Tunnel",
                description: "A narrow tunnel branching off from the main cave. Something shiny glints in the darkness.",
                exits: { south: "cave_tunnel" },
                type: "dungeon",
                shop: null,
                explored: false,
                encounterChance: 0.4
            },
            ruined_tower: {
                name: "Ruined Watchtower",
                description: "A crumbling stone tower. Debris litters the floor. The upper floors have collapsed. Something moves in the shadows.",
                exits: { south: "wilderness_west", up: "tower_top" },
                type: "dungeon",
                shop: null,
                explored: false,
                encounterChance: 0.8
            },
            tower_top: {
                name: "Tower Top",
                description: "The remaining top floor of the tower. A broken telescope points westward. A chest sits in the corner.",
                exits: { down: "ruined_tower" },
                type: "dungeon",
                shop: null,
                explored: false,
                encounterChance: 0.1
            },
            forest_path: {
                name: "Forest Path",
                description: "A narrow path through dense forest. Birds chirp overhead. The path continues NORTH.",
                exits: { south: "wilderness_east", north: "old_shrine" },
                type: "wilderness",
                shop: null,
                explored: false,
                encounterChance: 0.3
            },
            old_shrine: {
                name: "Old Shrine",
                description: "A moss-covered shrine to forgotten gods. The air feels charged with magic. An inscription is barely readable.",
                exits: { south: "forest_path" },
                type: "special",
                shop: null,
                explored: false,
                encounterChance: 0.1
            },
            rocky_pass: {
                name: "Rocky Pass",
                description: "A narrow pass between sheer cliffs. The wind howls through the gap. A path leads SOUTH.",
                exits: { north: "wilderness_west", south: "bandit_camp" },
                type: "wilderness",
                shop: null,
                explored: false,
                encounterChance: 0.5
            },
            bandit_camp: {
                name: "Bandit Camp",
                description: "A makeshift camp with a smoldering fire. Several rough-looking individuals eye you warily.",
                exits: { north: "rocky_pass" },
                type: "dungeon",
                shop: null,
                explored: false,
                encounterChance: 0.9
            }
        };

        // Expanded enemy database
        const enemies = {
            goblin: { 
                name: "GOBLIN", 
                hp: 12, 
                hpMax: 12,
                attack: "1-6", 
                exp: 15, 
                gold: "5-10",
                level: 1,
                special: null
            },
            skeleton: { 
                name: "SKELETON", 
                hp: 18, 
                hpMax: 18,
                attack: "2-8", 
                exp: 25, 
                gold: "8-15",
                level: 2,
                special: "undead"
            },
            orc: { 
                name: "ORC", 
                hp: 26, 
                hpMax: 26,
                attack: "3-10", 
                exp: 40, 
                gold: "12-20",
                level: 3,
                special: null
            },
            giant_rat: { 
                name: "GIANT RAT", 
                hp: 8, 
                hpMax: 8,
                attack: "1-4", 
                exp: 8, 
                gold: "2-5",
                level: 1,
                special: "disease"
            },
            wolf: { 
                name: "WOLF", 
                hp: 15, 
                hpMax: 15,
                attack: "2-7", 
                exp: 20, 
                gold: "3-8",
                level: 2,
                special: "pack"
            },
            bandit: { 
                name: "BANDIT", 
                hp: 22, 
                hpMax: 22,
                attack: "2-9", 
                exp: 35, 
                gold: "15-30",
                level: 3,
                special: "steal"
            },
            cave_troll: { 
                name: "CAVE TROLL", 
                hp: 45, 
                hpMax: 45,
                attack: "5-15", 
                exp: 100, 
                gold: "30-60",
                level: 5,
                special: "regenerate"
            }
        };

        // Shop items
        const shops = {
            weapons: [
                { name: "Long Sword", type: "weapon", price: 80, stat: "str", bonus: 2 },
                { name: "Battle Axe", type: "weapon", price: 120, stat: "str", bonus: 3 },
                { name: "Short Bow", type: "weapon", price: 60, stat: "agi", bonus: 2 },
                { name: "Long Bow", type: "weapon", price: 150, stat: "agi", bonus: 4 },
                { name: "Oak Staff", type: "weapon", price: 40, stat: "int", bonus: 1 },
                { name: "Mage Staff", type: "weapon", price: 200, stat: "int", bonus: 5 },
                { name: "Steel Mace", type: "weapon", price: 70, stat: "str", bonus: 2 }
            ],
            armor: [
                { name: "Leather Armor", type: "armor", price: 50, defense: 2 },
                { name: "Chainmail", type: "armor", price: 120, defense: 4 },
                { name: "Plate Armor", type: "armor", price: 250, defense: 7 },
                { name: "Robe", type: "armor", price: 30, defense: 1 },
                { name: "Magic Robe", type: "armor", price: 180, defense: 3, mpBonus: 10 }
            ],
            healing: [
                { name: "Healing Potion", type: "potion", price: 30, effect: "heal", power: "20-40" },
                { name: "Antidote", type: "potion", price: 25, effect: "cure", condition: "poison" },
                { name: "Blessing", type: "service", price: 50, effect: "bless", duration: "1 day" },
                { name: "Cure Disease", type: "service", price: 100, effect: "cure", condition: "disease" },
                { name: "Resurrect", type: "service", price: 500, effect: "resurrect" }
            ],
            magic: [
                { name: "Mana Potion", type: "potion", price: 40, effect: "mana", power: "15-30" },
                { name: "Scroll of Fireball", type: "scroll", price: 80, spell: "Fireball", charges: 3 },
                { name: "Scroll of Healing", type: "scroll", price: 60, spell: "Heal", charges: 3 },
                { name: "Magic Amulet", type: "item", price: 150, effect: "mp+10" },
                { name: "Wizard Hat", type: "armor", price: 120, defense: 1, mpBonus: 15 }
            ]
        };

        // DOM elements
        const gameScreen = document.getElementById('game-screen');
        const commandInput = document.getElementById('command');
        const executeButton = document.getElementById('execute');
        const characterInfo = document.getElementById('character-info');
        const inventoryList = document.getElementById('inventory-list');
        const locationBar = document.getElementById('location-bar');
        const mapModal = document.getElementById('map-modal');
        const gameMap = document.getElementById('game-map');
        const closeMap = document.getElementById('close-map');
        const shopModal = document.getElementById('shop-modal');
        const shopTitle = document.getElementById('shop-title');
        const shopItems = document.getElementById('shop-items');
        const closeShop = document.getElementById('close-shop');
        const questsList = document.getElementById('quests-list');
        const spellsList = document.getElementById('spells-list');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const quickCommands = document.querySelectorAll('.cmd-btn[data-cmd]');

        // Initialize game
        function initGame() {
            updateCharacterDisplay();
            updateInventoryDisplay();
            updateQuestsDisplay();
            updateSpellsDisplay();
            
            addMessage("MIGHT AND MAGIC: BOOK ONE", "system");
            addMessage("Secret of the Inner Sanctum", "system");
            addMessage("-----------------------------------", "system");
            addMessage("Your party stands at the gates of Sorpigal.", "system");
            addMessage("Type 'help' for commands or use quick buttons.", "system");
            
            updateLocationBar();
            describeLocation();
            
            // Set up event listeners
            setupEventListeners();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Command input
            executeButton.addEventListener('click', executeCommand);
            commandInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') executeCommand();
            });
            
            // Quick command buttons
            quickCommands.forEach(btn => {
                btn.addEventListener('click', () => {
                    const cmd = btn.getAttribute('data-cmd');
                    processCommand(cmd);
                });
            });
            
            // Tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Modal close buttons
            closeMap.addEventListener('click', () => {
                mapModal.style.display = 'none';
            });
            
            closeShop.addEventListener('click', () => {
                shopModal.style.display = 'none';
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === mapModal) {
                    mapModal.style.display = 'none';
                }
                if (e.target === shopModal) {
                    shopModal.style.display = 'none';
                }
            });
        }

        // Switch between tabs
        function switchTab(tabId) {
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            tabContents.forEach(content => {
                if (content.id === `${tabId}-tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // Update location bar
        function updateLocationBar() {
            const loc = locations[gameState.location];
            locationBar.textContent = loc.name;
            
            // Add combat alert if enemy present
            if (gameState.currentEnemy) {
                locationBar.classList.add('combat-alert');
                locationBar.innerHTML = `${loc.name} <span style="color:#f00">[COMBAT!]</span>`;
            } else {
                locationBar.classList.remove('combat-alert');
            }
        }

        // Update character display
        function updateCharacterDisplay() {
            characterInfo.innerHTML = '';
            
            gameState.party.forEach((char, index) => {
                const hpPercent = (char.hp / char.hpMax) * 100;
                const mpPercent = char.mpMax > 0 ? (char.mp / char.mpMax) * 100 : 0;
                
                const charElement = document.createElement('div');
                charElement.className = 'character-card';
                charElement.innerHTML = `
                    <div class="char-header">
                        <div class="char-name">${char.name}</div>
                        <div class="char-class">${char.class} L${char.level}</div>
                    </div>
                    <div class="char-stats">
                        <div class="stat">
                            <span>HP:</span>
                            <span class="stat-value">${char.hp}/${char.hpMax}</span>
                        </div>
                        <div class="stat">
                            <span>MP:</span>
                            <span class="stat-value">${char.mp}/${char.mpMax}</span>
                        </div>
                        <div class="stat">
                            <span>EXP:</span>
                            <span class="stat-value">${char.exp}/${char.expNext}</span>
                        </div>
                        <div class="stat">
                            <span>STR:</span>
                            <span class="stat-value">${char.str}</span>
                        </div>
                    </div>
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: ${hpPercent}%"></div>
                    </div>
                    ${char.mpMax > 0 ? `<div class="mp-bar">
                        <div class="mp-fill" style="width: ${mpPercent}%"></div>
                    </div>` : ''}
                `;
                
                // Add click to select character for actions
                charElement.addEventListener('click', () => {
                    addMessage(`Selected ${char.name} the ${char.class}.`, "system");
                    commandInput.value = `use potion ${char.name}`;
                    commandInput.focus();
                });
                
                characterInfo.appendChild(charElement);
            });
        }

        // Update inventory display
        function updateInventoryDisplay() {
            inventoryList.innerHTML = '';
            
            const inventoryItems = [
                { name: "Gold", count: gameState.gold, color: "#ff0" },
                { name: "Food", count: gameState.food + " days", color: "#fff" },
                { name: "Torches", count: gameState.torches, color: "#fff" },
                { name: "Keys", count: gameState.keys, color: "#fff" },
                { name: "Heal Potions", count: gameState.potions.healing, color: "#f00" },
                { name: "Mana Potions", count: gameState.potions.mana, color: "#0af" },
                { name: "Antidotes", count: gameState.potions.antidote, color: "#0f0" }
            ];
            
            inventoryItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                itemElement.innerHTML = `
                    <div class="item-name">${item.name}</div>
                    <div class="item-count" style="color:${item.color}">${item.count}</div>
                `;
                
                // Add click to use item
                if (item.name.includes("Potion") || item.name === "Antidotes") {
                    itemElement.addEventListener('click', () => {
                        const itemType = item.name.toLowerCase().replace(" potions", "").replace("s", "");
                        commandInput.value = `use ${itemType}`;
                        commandInput.focus();
                        addMessage(`Ready to use ${item.name}. Type target name or press EXEC.`, "system");
                    });
                }
                
                inventoryList.appendChild(itemElement);
            });
        }

        // Update quests display
        function updateQuestsDisplay() {
            questsList.innerHTML = '';
            
            gameState.quests.forEach(quest => {
                const questElement = document.createElement('div');
                questElement.className = 'inventory-item';
                questElement.innerHTML = `
                    <div class="item-name" style="color:#f0f">${quest.name}</div>
                    <div style="font-size:8px; margin-top:4px; color:#aaa">${quest.description}</div>
                    <div style="font-size:8px; margin-top:4px; color:#0f0">Status: ${quest.status.toUpperCase()}</div>
                    ${quest.reward ? `<div style="font-size:8px; margin-top:2px; color:#ff0">Reward: ${quest.reward} gold</div>` : ''}
                `;
                
                questsList.appendChild(questElement);
            });
        }

        // Update spells display
        function updateSpellsDisplay() {
            spellsList.innerHTML = '';
            
            // Get all spells from party members
            const allSpells = [];
            gameState.party.forEach(char => {
                if (char.spells) {
                    char.spells.forEach(spell => {
                        if (!allSpells.includes(spell)) allSpells.push(spell);
                    });
                }
            });
            
            if (allSpells.length === 0) {
                spellsList.innerHTML = '<div style="color:#aaa; font-size:9px">No spells known. Visit magic shop.</div>';
                return;
            }
            
            allSpells.forEach(spell => {
                const spellElement = document.createElement('div');
                spellElement.className = 'inventory-item';
                spellElement.innerHTML = `
                    <div class="item-name" style="color:#0af">${spell}</div>
                    <div style="font-size:8px; margin-top:4px; color:#aaa">Click to cast</div>
                `;
                
                spellElement.addEventListener('click', () => {
                    commandInput.value = `cast ${spell}`;
                    commandInput.focus();
                    addMessage(`Ready to cast ${spell}. Type target or press EXEC.`, "system");
                });
                
                spellsList.appendChild(spellElement);
            });
        }

        // Add message to game screen
        function addMessage(text, type = "") {
            const messageElement = document.createElement('div');
            messageElement.className = `game-message ${type}`;
            messageElement.textContent = text;
            gameScreen.appendChild(messageElement);
            
            // Scroll to bottom
            gameScreen.scrollTop = gameScreen.scrollHeight;
        }

        // Describe current location
        function describeLocation() {
            const loc = locations[gameState.location];
            
            // Mark as explored if not already
            if (!gameState.exploredLocations.includes(gameState.location)) {
                gameState.exploredLocations.push(gameState.location);
            }
            
            addMessage(`\n[${loc.name}]`, "system");
            addMessage(loc.description, "system");
            
            // List exits
            let exitText = "Exits: ";
            const exits = Object.keys(loc.exits);
            exits.forEach((exit, index) => {
                exitText += exit.toUpperCase();
                if (index < exits.length - 1) exitText += ", ";
            });
            addMessage(exitText, "system");
            
            // Show enemy if present
            if (gameState.currentEnemy) {
                showEnemy();
            }
            
            updateLocationBar();
        }

        // Show enemy in game screen
        function showEnemy() {
            const enemy = gameState.currentEnemy;
            const hpPercent = (enemy.hp / enemy.hpMax) * 100;
            
            const enemyElement = document.createElement('div');
            enemyElement.className = 'enemy-health';
            enemyElement.innerHTML = `
                <div class="enemy-name">${enemy.name} L${enemy.level}</div>
                <div class="enemy-hp-bar">
                    <div class="enemy-hp-fill" style="width: ${hpPercent}%"></div>
                </div>
                <div style="color:#f00; font-size:10px">${enemy.hp}/${enemy.hpMax}</div>
            `;
            
            gameScreen.appendChild(enemyElement);
        }

        // Execute command
        function executeCommand() {
            const cmd = commandInput.value.trim();
            if (cmd) {
                processCommand(cmd);
                commandInput.value = '';
            }
            commandInput.focus();
        }

        // Process player command
        function processCommand(cmd) {
            if (!cmd.trim()) return;
            
            addMessage(`> ${cmd}`, "system");
            
            const parts = cmd.toLowerCase().split(' ');
            const action = parts[0];
            const target = parts.slice(1).join(' ');
            
            // Handle different commands
            switch(action) {
                case 'help':
                    showHelp();
                    break;
                case 'north': case 'south': case 'east': case 'west':
                case 'n': case 's': case 'e': case 'w':
                    move(action.charAt(0));
                    break;
                case 'enter': case 'deeper': case 'up': case 'down': case 'out':
                    move(action);
                    break;
                case 'look': case 'l':
                    describeLocation();
                    break;
                case 'rest':
                    rest();
                    break;
                case 'attack': case 'a':
                    attack(target);
                    break;
                case 'cast':
                    castSpell(target);
                    break;
                case 'search':
                    search();
                    break;
                case 'stats':
                    showStats();
                    break;
                case 'map':
                    showMap();
                    break;
                case 'save':
                    saveGame();
                    break;
                case 'load':
                    loadGame();
                    break;
                case 'quit': case 'exit':
                    quitGame();
                    break;
                case 'inventory': case 'inv': case 'i':
                    showInventory();
                    break;
                case 'buy':
                    buyItem(target);
                    break;
                case 'use':
                    useItem(target);
                    break;
                case 'quests': case 'quest':
                    showQuests();
                    break;
                case 'talk':
                    talk(target);
                    break;
                case 'time':
                    showTime();
                    break;
                default:
                    addMessage("Unknown command. Type 'help' for available commands.", "system");
            }
            
            // Random enemy encounter after movement
            if (['north', 'south', 'east', 'west', 'n', 's', 'e', 'w', 'enter', 'deeper', 'up', 'down', 'out'].includes(action)) {
                randomEncounter();
            }
            
            // Update displays
            updateCharacterDisplay();
            updateInventoryDisplay();
        }

        // Show help
        function showHelp() {
            addMessage("--- COMMANDS ---", "system");
            addMessage("MOVEMENT: north/south/east/west (or n/s/e/w)", "system");
            addMessage("ACTIONS: look, search, rest, attack, cast [spell]", "system");
            addMessage("ITEMS: inventory, buy [item], use [item]", "system");
            addMessage("INFO: stats, map, quests, time", "system");
            addMessage("SYSTEM: save, load, quit", "system");
            addMessage("Use quick buttons or type commands.", "system");
        }

        // Move to new location
        function move(direction) {
            // Handle short directions
            const dirMap = { n: 'north', s: 'south', e: 'east', w: 'west' };
            if (dirMap[direction]) direction = dirMap[direction];
            
            const loc = locations[gameState.location];
            
            if (loc.exits[direction]) {
                // Check if we need a torch in dark areas
                if (['cave_tunnel', 'cave_chamber', 'cave_treasure', 'cave_side'].includes(loc.exits[direction])) {
                    if (gameState.torches <= 0) {
                        addMessage("It's too dark to proceed without a torch!", "system");
                        return;
                    }
                }
                
                gameState.location = loc.exits[direction];
                
                // Consume food with each move
                gameState.food -= 0.1;
                if (gameState.food <= 0) {
                    gameState.food = 0;
                    addMessage("Warning: You're out of food! Your party is starving.", "danger");
                    // Apply starvation damage
                    gameState.party.forEach(char => {
                        char.hp -= 1;
                        if (char.hp < 0) char.hp = 0;
                    });
                }
                
                // Consume torch in dark areas
                if (gameState.location.includes('cave') && gameState.torches > 0) {
                    gameState.torches -= 0.2;
                    if (gameState.torches < 0) gameState.torches = 0;
                }
                
                describeLocation();
                updateInventoryDisplay();
            } else {
                addMessage("You cannot go that way.", "system");
            }
        }

        // Rest and heal
        function rest() {
            const loc = locations[gameState.location];
            
            if (loc.type === 'inn') {
                const cost = gameState.party.length * 10;
                if (gameState.gold >= cost) {
                    gameState.gold -= cost;
                    gameState.party.forEach(char => {
                        char.hp = char.hpMax;
                        char.mp = char.mpMax;
                    });
                    addMessage(`Your party rests at the inn. All HP and MP restored!`, "system");
                    addMessage(`${cost} gold deducted.`, "system");
                    
                    // Advance time
                    gameState.time.hour += 8;
                    if (gameState.time.hour >= 24) {
                        gameState.time.hour -= 24;
                        gameState.time.day += 1;
                    }
                    
                    updateCharacterDisplay();
                    updateInventoryDisplay();
                } else {
                    addMessage(`Not enough gold! Need ${cost} gold.`, "system");
                }
            } else if (loc.type === 'temple') {
                addMessage("The temple offers healing services. Try 'buy healing'", "system");
            } else {
                addMessage("It's not safe to rest here. Find an inn or temple.", "system");
            }
        }

        // Attack enemy
        function attack(target) {
            if (!gameState.currentEnemy) {
                addMessage("There's nothing to attack here.", "system");
                return;
            }
            
            const enemy = gameState.currentEnemy;
            const attacker = gameState.party[0]; // First party member attacks
            
            // Calculate damage based on attacker's strength
            const damage = Math.floor(Math.random() * 6) + Math.floor(attacker.str / 4);
            enemy.hp -= damage;
            
            addMessage(`${attacker.name} attacks the ${enemy.name} for ${damage} damage!`, "combat");
            
            if (enemy.hp <= 0) {
                addMessage(`The ${enemy.name} is defeated!`, "combat");
                
                // Calculate gold reward
                const goldRange = enemy.gold.split('-').map(Number);
                const goldReward = Math.floor(Math.random() * (goldRange[1] - goldRange[0] + 1)) + goldRange[0];
                
                addMessage(`You gain ${enemy.exp} experience and ${goldReward} gold!`, "loot");
                
                gameState.gold += goldReward;
                gameState.party.forEach(char => {
                    char.exp += enemy.exp;
                    // Check for level up
                    if (char.exp >= char.expNext) {
                        levelUp(char);
                    }
                });
                
                // Update kill count
                const enemyKey = enemy.name.toLowerCase().replace(' ', '_');
                if (gameState.kills[enemyKey] !== undefined) {
                    gameState.kills[enemyKey]++;
                    
                    // Check quest progress
                    checkQuestProgress();
                }
                
                gameState.currentEnemy = null;
                updateLocationBar();
            } else {
                addMessage(`The ${enemy.name} has ${enemy.hp} HP remaining.`, "combat");
                enemyAttack();
            }
            
            updateCharacterDisplay();
            updateInventoryDisplay();
        }

        // Enemy attacks party
        function enemyAttack() {
            if (!gameState.currentEnemy) return;
            
            const enemy = gameState.currentEnemy;
            
            // Enemy chooses a random party member to attack
            const aliveMembers = gameState.party.filter(char => char.hp > 0);
            if (aliveMembers.length === 0) return;
            
            const targetIndex = Math.floor(Math.random() * aliveMembers.length);
            const target = aliveMembers[targetIndex];
            
            // Calculate enemy damage
            const damageRange = enemy.attack.split('-').map(Number);
            const damage = Math.floor(Math.random() * (damageRange[1] - damageRange[0] + 1)) + damageRange[0];
            
            target.hp -= damage;
            if (target.hp < 0) target.hp = 0;
            
            addMessage(`The ${enemy.name} attacks ${target.name} for ${damage} damage!`, "combat");
            
            if (target.hp <= 0) {
                addMessage(`${target.name} has been knocked unconscious!`, "combat");
            }
            
            updateCharacterDisplay();
        }

        // Level up character
        function levelUp(char) {
            char.level += 1;
            char.exp -= char.expNext;
            char.expNext = Math.floor(char.expNext * 1.5);
            
            // Increase stats based on class
            if (char.class === 'KNIGHT') {
                char.hpMax += 10;
                char.str += 2;
                char.vit += 2;
            } else if (char.class === 'ARCHER') {
                char.hpMax += 6;
                char.agi += 3;
                char.str += 1;
            } else if (char.class === 'SORCERER') {
                char.hpMax += 4;
                char.mpMax += 8;
                char.int += 3;
            } else if (char.class === 'CLERIC') {
                char.hpMax += 6;
                char.mpMax += 6;
                char.int += 2;
                char.vit += 1;
            }
            
            char.hp = char.hpMax;
            char.mp = char.mpMax;
            
            addMessage(`${char.name} advanced to level ${char.level}!`, "system");
        }

        // Cast spell
        function castSpell(spellTarget) {
            // Parse spell and target
            const parts = spellTarget.split(' ');
            const spell = parts[0];
            const targetName = parts.slice(1).join(' ');
            
            // Find spellcaster
            const caster = gameState.party.find(char => 
                char.spells && char.spells.map(s => s.toLowerCase()).includes(spell.toLowerCase())
            );
            
            if (!caster) {
                addMessage("No one knows that spell!", "system");
                return;
            }
            
            if (caster.mp <= 0) {
                addMessage(`${caster.name} has no magic points left!`, "system");
                return;
            }
            
            // Determine target
            let target = null;
            if (gameState.currentEnemy && spell.toLowerCase().includes('fire') || spell.toLowerCase().includes('lightning')) {
                target = gameState.currentEnemy;
            } else if (targetName) {
                target = gameState.party.find(char => 
                    char.name.toLowerCase().includes(targetName.toLowerCase())
                );
            }
            
            if (!target) {
                addMessage("Invalid target for that spell.", "system");
                return;
            }
            
            // Cast spell
            const spellCost = 5;
            caster.mp -= spellCost;
            
            if (spell.toLowerCase().includes('fire')) {
                const damage = Math.floor(Math.random() * 15) + 10;
                target.hp -= damage;
                addMessage(`${caster.name} casts FIREBALL on ${target.name} for ${damage} damage!`, "combat");
                
                if (target.hp <= 0 && gameState.currentEnemy) {
                    addMessage(`The ${target.name} is defeated!`, "combat");
                    gameState.currentEnemy = null;
                    updateLocationBar();
                }
            } else if (spell.toLowerCase().includes('heal')) {
                const heal = Math.floor(Math.random() * 15) + 10;
                target.hp = Math.min(target.hp + heal, target.hpMax);
                addMessage(`${caster.name} casts HEAL on ${target.name} for ${heal} HP.`, "system");
            } else if (spell.toLowerCase().includes('lightning')) {
                const damage = Math.floor(Math.random() * 12) + 8;
                target.hp -= damage;
                addMessage(`${caster.name} casts LIGHTNING on ${target.name} for ${damage} damage!`, "combat");
            }
            
            updateCharacterDisplay();
        }

        // Search area
        function search() {
            const loc = locations[gameState.location];
            const searchRoll = Math.random();
            
            if (loc.type === 'dungeon' || loc.type === 'special') {
                if (searchRoll < 0.4) {
                    const goldFound = Math.floor(Math.random() * 100) + 20;
                    gameState.gold += goldFound;
                    addMessage(`You find ${goldFound} gold coins hidden in the area!`, "loot");
                } else if (searchRoll < 0.6) {
                    gameState.potions.healing += 1;
                    addMessage("You find a healing potion!", "loot");
                } else if (searchRoll < 0.7) {
                    gameState.keys += 1;
                    addMessage("You find a rusty key!", "loot");
                } else if (searchRoll < 0.8 && loc.name === "Treasure Chamber") {
                    addMessage("You find the Lost Amulet! Return it to the innkeeper.", "quest");
                    // Complete quest
                    completeQuest(1);
                } else if (searchRoll < 0.9 && loc.name === "Tower Top") {
                    addMessage("You find a treasure chest with 200 gold and a Magic Sword!", "loot");
                    gameState.gold += 200;
                    gameState.weapons.push("Magic Sword");
                } else {
                    addMessage("You find nothing of value.", "system");
                }
            } else {
                if (searchRoll < 0.2) {
                    const goldFound = Math.floor(Math.random() * 30) + 5;
                    gameState.gold += goldFound;
                    addMessage(`You find ${goldFound} gold coins!`, "loot");
                } else {
                    addMessage("You find nothing of interest.", "system");
                }
            }
            
            updateInventoryDisplay();
        }

        // Show stats
        function showStats() {
            addMessage("--- PARTY STATISTICS ---", "system");
            gameState.party.forEach(char => {
                addMessage(`${char.name} - ${char.class} Level ${char.level}`, "system");
                addMessage(`  HP: ${char.hp}/${char.hpMax}  MP: ${char.mp}/${char.mpMax}`, "system");
                addMessage(`  STR:${char.str} AGI:${char.agi} VIT:${char.vit} INT:${char.int}`, "system");
                addMessage(`  Exp: ${char.exp}/${char.expNext}`, "system");
            });
            addMessage(`Gold: ${gameState.gold}`, "system");
            addMessage(`Food: ${gameState.food.toFixed(1)} days remaining`, "system");
            addMessage(`Day: ${gameState.time.day}, Time: ${gameState.time.hour}:${gameState.time.minutes.toString().padStart(2, '0')}`, "system");
        }

        // Show map
        function showMap() {
            // Build ASCII map
            const mapLines = [
                "        [Ruined Tower]",
                "              |",
                "[Western Wild]--[Sorpigal Gates]--[Eastern Wild]",
                "      |               |               |",
                "  [Rocky Pass]   [Town Square]   [Forest Path]",
                "      |           /   |   \\           |",
                "  [Bandit Camp] [Inn]-+-[Temple] [Old Shrine]",
                "                      |",
                "                 [Weapon Shop]",
                "                      |",
                "                 [Magic Shop]",
                "",
                "[Cave Entrance]--[Cave Tunnel]--[Cave Chamber]",
                "                      |               |",
                "                 [Side Tunnel]   [Treasure]"
            ];
            
            // Highlight current location
            const locMap = {
                'sorpigal_gates': 'Sorpigal Gates',
                'sorpigal_square': 'Town Square',
                'sorpigal_inn': 'Inn',
                'weapon_shop': 'Weapon Shop',
                'temple': 'Temple',
                'magic_shop': 'Magic Shop',
                'wilderness_east': 'Eastern Wild',
                'wilderness_west': 'Western Wild',
                'cave_entrance': 'Cave Entrance',
                'cave_tunnel': 'Cave Tunnel',
                'cave_chamber': 'Cave Chamber',
                'cave_treasure': 'Treasure',
                'cave_side': 'Side Tunnel',
                'ruined_tower': 'Ruined Tower',
                'tower_top': 'Ruined Tower',
                'forest_path': 'Forest Path',
                'old_shrine': 'Old Shrine',
                'rocky_pass': 'Rocky Pass',
                'bandit_camp': 'Bandit Camp'
            };
            
            const currentLocName = locMap[gameState.location];
            let mapHtml = '';
            
            mapLines.forEach(line => {
                let formattedLine = line;
                if (currentLocName && line.includes(currentLocName)) {
                    formattedLine = line.replace(currentLocName, `<span class="current-location">${currentLocName}</span>`);
                }
                mapHtml += formattedLine + '\n';
            });
            
            gameMap.innerHTML = mapHtml;
            mapModal.style.display = 'block';
        }

        // Save game
        function saveGame() {
            try {
                localStorage.setItem('mightAndMagicMobile', JSON.stringify(gameState));
                addMessage("Game saved successfully!", "system");
            } catch (e) {
                addMessage("Error saving game: " + e.message, "system");
            }
        }

        // Load game
        function loadGame() {
            try {
                const savedGame = localStorage.getItem('mightAndMagicMobile');
                if (savedGame) {
                    const loadedState = JSON.parse(savedGame);
                    Object.assign(gameState, loadedState);
                    addMessage("Game loaded successfully!", "system");
                    updateCharacterDisplay();
                    updateInventoryDisplay();
                    updateQuestsDisplay();
                    updateSpellsDisplay();
                    describeLocation();
                } else {
                    addMessage("No saved game found.", "system");
                }
            } catch (e) {
                addMessage("Error loading game: " + e.message, "system");
            }
        }

        // Quit game
        function quitGame() {
            addMessage("Thanks for playing Might and Magic!", "system");
            addMessage("Game will reset in 3 seconds...", "system");
            setTimeout(() => {
                location.reload();
            }, 3000);
        }

        // Show inventory
        function showInventory() {
            switchTab('inventory');
            addMessage("Inventory opened. Use tabs to switch views.", "system");
        }

        // Show quests
        function showQuests() {
            switchTab('quests');
            addMessage("Quest log opened.", "system");
        }

        // Buy item
        function buyItem(item) {
            const loc = locations[gameState.location];
            
            if (!loc.shop) {
                addMessage("There's no shop here.", "system");
                return;
            }
            
            // Show shop modal if no item specified
            if (!item) {
                showShop(loc.shop);
                return;
            }
            
            // Handle specific item purchase
            const shopType = loc.shop;
            const shopItem = shops[shopType].find(i => 
                i.name.toLowerCase().includes(item.toLowerCase())
            );
            
            if (!shopItem) {
                addMessage(`That item is not available. Type 'buy' to see shop.`, "system");
                return;
            }
            
            if (gameState.gold >= shopItem.price) {
                gameState.gold -= shopItem.price;
                
                // Add item to inventory
                if (shopItem.type === 'potion') {
                    if (shopItem.effect === 'heal') {
                        gameState.potions.healing += 1;
                    } else if (shopItem.effect === 'mana') {
                        gameState.potions.mana += 1;
                    }
                } else if (shopItem.type === 'scroll') {
                    gameState.scrolls.push(shopItem.name);
                } else if (shopItem.type === 'weapon') {
                    gameState.weapons.push(shopItem.name);
                } else if (shopItem.type === 'armor') {
                    gameState.armor.push(shopItem.name);
                }
                
                addMessage(`You purchased ${shopItem.name} for ${shopItem.price} gold.`, "system");
                updateInventoryDisplay();
            } else {
                addMessage(`Not enough gold! ${shopItem.name} costs ${shopItem.price} gold.`, "system");
            }
        }

        // Show shop
        function showShop(shopType) {
            const shopData = shops[shopType];
            if (!shopData) return;
            
            shopTitle.textContent = shopType.toUpperCase() + " SHOP";
            shopItems.innerHTML = '';
            
            shopData.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                itemElement.style.marginBottom = '10px';
                itemElement.innerHTML = `
                    <div class="item-name">${item.name}</div>
                    <div style="font-size:8px; margin-top:4px; color:#aaa">${item.type.toUpperCase()}</div>
                    <div style="font-size:10px; margin-top:4px; color:#ff0">${item.price} gold</div>
                    ${item.effect ? `<div style="font-size:8px; margin-top:2px; color:#0f0">Effect: ${item.effect}</div>` : ''}
                `;
                
                // Add buy button
                const buyBtn = document.createElement('button');
                buyBtn.className = 'cmd-btn';
                buyBtn.textContent = 'BUY';
                buyBtn.style.marginTop = '8px';
                buyBtn.style.width = '100%';
                buyBtn.style.fontSize = '9px';
                buyBtn.addEventListener('click', () => {
                    if (gameState.gold >= item.price) {
                        gameState.gold -= item.price;
                        
                        // Add item to inventory
                        if (item.type === 'potion') {
                            if (item.effect === 'heal') {
                                gameState.potions.healing += 1;
                            } else if (item.effect === 'mana') {
                                gameState.potions.mana += 1;
                            }
                        } else if (item.type === 'scroll') {
                            gameState.scrolls.push(item.name);
                        }
                        
                        addMessage(`You purchased ${item.name}.`, "system");
                        updateInventoryDisplay();
                        shopModal.style.display = 'none';
                    } else {
                        addMessage(`Not enough gold!`, "system");
                    }
                });
                
                itemElement.appendChild(buyBtn);
                shopItems.appendChild(itemElement);
            });
            
            shopModal.style.display = 'block';
        }

        // Use item
        function useItem(itemTarget) {
            const parts = itemTarget.split(' ');
            const item = parts[0];
            const targetName = parts.slice(1).join(' ');
            
            // Find target character
            let target = gameState.party[0]; // Default to first character
            if (targetName) {
                target = gameState.party.find(char => 
                    char.name.toLowerCase().includes(targetName.toLowerCase())
                );
                if (!target) {
                    addMessage("No such party member.", "system");
                    return;
                }
            }
            
            if (item.includes('potion')) {
                if (item.includes('heal')) {
                    if (gameState.potions.healing > 0) {
                        const heal = Math.floor(Math.random() * 20) + 20;
                        target.hp = Math.min(target.hp + heal, target.hpMax);
                        gameState.potions.healing -= 1;
                        addMessage(`Used healing potion on ${target.name}. ${heal} HP restored.`, "system");
                    } else {
                        addMessage("No healing potions left!", "system");
                    }
                } else if (item.includes('mana')) {
                    if (gameState.potions.mana > 0) {
                        const mana = Math.floor(Math.random() * 15) + 15;
                        target.mp = Math.min(target.mp + mana, target.mpMax);
                        gameState.potions.mana -= 1;
                        addMessage(`Used mana potion on ${target.name}. ${mana} MP restored.`, "system");
                    } else {
                        addMessage("No mana potions left!", "system");
                    }
                } else if (item.includes('antidote')) {
                    if (gameState.potions.antidote > 0) {
                        gameState.potions.antidote -= 1;
                        addMessage(`Used antidote on ${target.name}. Cured poison.`, "system");
                    } else {
                        addMessage("No antidotes left!", "system");
                    }
                }
            } else if (item.includes('torch')) {
                if (gameState.torches > 0) {
                    gameState.torches -= 1;
                    addMessage("You light a torch. The area is now illuminated.", "system");
                } else {
                    addMessage("No torches left!", "system");
                }
            } else if (item.includes('food')) {
                if (gameState.food > 0) {
                    gameState.food -= 1;
                    addMessage("Your party eats a day's rations.", "system");
                } else {
                    addMessage("No food left! Your party will starve.", "system");
                }
            } else {
                addMessage("You can't use that item.", "system");
                return;
            }
            
            updateCharacterDisplay();
            updateInventoryDisplay();
        }

        // Talk to NPC
        function talk(target) {
            const loc = locations[gameState.location];
            
            if (loc.type === 'inn' && target.includes('innkeeper')) {
                addMessage("Innkeeper: 'Welcome travelers! Rest here for 10 gold each.'", "system");
                addMessage("'Also, I lost my family amulet in the caves east of town.'", "system");
                addMessage("'Find it and I'll reward you handsomely!'", "system");
            } else if (loc.type === 'temple' && target.includes('priest')) {
                addMessage("High Priest: 'May the light guide you, adventurers.'", "system");
                addMessage("'We offer healing and blessings for donations.'", "system");
            } else if (loc.type === 'shop' && target.includes('shop') || target.includes('smith') || target.includes('wizard')) {
                addMessage("'Browse my wares. Type 'buy' to see what's available.'", "system");
            } else {
                addMessage("There's no one to talk to here.", "system");
            }
        }

        // Show time
        function showTime() {
            addMessage(`Day ${gameState.time.day}, ${gameState.time.hour}:${gameState.time.minutes.toString().padStart(2, '0')}`, "system");
            addMessage(`Food remaining: ${gameState.food.toFixed(1)} days`, "system");
        }

        // Random encounter
        function randomEncounter() {
            if (gameState.currentEnemy) return;
            
            const loc = locations[gameState.location];
            if (!loc.encounterChance) return;
            
            if (Math.random() < loc.encounterChance) {
                // Determine enemy based on location
                let enemyPool = [];
                
                if (loc.type === 'wilderness') {
                    enemyPool = ['goblin', 'wolf', 'giant_rat'];
                } else if (loc.type === 'dungeon') {
                    if (loc.name.includes('cave')) {
                        enemyPool = ['skeleton', 'orc', 'giant_rat', 'cave_troll'];
                    } else if (loc.name.includes('tower')) {
                        enemyPool = ['skeleton', 'ghost'];
                    } else if (loc.name.includes('bandit')) {
                        enemyPool = ['bandit', 'bandit', 'bandit'];
                    }
                }
                
                if (enemyPool.length === 0) return;
                
                const enemyType = enemyPool[Math.floor(Math.random() * enemyPool.length)];
                const enemy = {...enemies[enemyType]};
                
                gameState.currentEnemy = enemy;
                addMessage(`\nA wild ${enemy.name} appears!`, "combat");
                updateLocationBar();
                
                // Show enemy in game screen
                showEnemy();
            }
        }

        // Check quest progress
        function checkQuestProgress() {
            // Quest 2: Clear the Ruined Tower
            const quest2 = gameState.quests.find(q => q.id === 2);
            if (quest2 && quest2.status === 'active') {
                const totalKills = Object.values(gameState.kills).reduce((a, b) => a + b, 0);
                if (totalKills >= quest2.requiredKills) {
                    completeQuest(2);
                }
            }
        }

        // Complete quest
        function completeQuest(questId) {
            const quest = gameState.quests.find(q => q.id === questId);
            if (quest && quest.status === 'active') {
                quest.status = 'completed';
                gameState.gold += quest.reward;
                addMessage(`QUEST COMPLETE: ${quest.name}`, "quest");
                addMessage(`Reward: ${quest.reward} gold received!`, "quest");
                updateQuestsDisplay();
                updateInventoryDisplay();
            }
        }

        // Initialize the game
        initGame();
    </script>
</body>
</html>
