<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dracula's Last Rise - Level 4: Outside the Castle Gates</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Blood Red/Black theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(120, 0, 0, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(120, 0, 0, 0.15) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 3px solid #cc0000;
            background-color: #000;
            box-shadow: 0 0 30px rgba(204, 0, 0, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(120, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #cc0000;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #cc0000;
            text-shadow: 0 0 8px #cc0000;
            font-size: 32px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #cc0000;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 20px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #cc0000;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #220000;
            color: #cc8888;
            border-color: #cc8888;
        }
        
        .level-number.current {
            background-color: #cc0000;
            color: #000;
            border-color: #cc0000;
            box-shadow: 0 0 12px #cc0000;
            text-shadow: 0 0 2px #000;
            font-weight: bold;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #cc0000;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #cc0000;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #cc0000;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #cc0000;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #cc0000;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #ff4444;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #cc0000;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #cc0000;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #cc0000;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #ff4444;
            border-color: #ff4444;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #cc0000;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #ff4444;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #cc0000;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #ff4444;
            border-color: #ff4444;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #330000;
            border: 1px solid #cc0000;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #cc0000;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #550000;
            border: 1px solid #ff0000;
            padding: 10px;
            margin: 10px 0;
            color: #cc0000;
            font-weight: bold;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .victory {
            color: #cc0000;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 8px #cc0000;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ffd700;
            font-weight: bold;
        }
        
        .item {
            color: #8ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        .castle-gates {
            color: #cc0000;
            font-weight: bold;
            text-shadow: 0 0 2px #cc0000;
        }
        
        .gate-guard {
            color: #fa6;
            font-weight: bold;
        }
        
        .secret-tunnel {
            color: #8cf;
            font-weight: bold;
        }
        
        .moat {
            color: #8cf;
            font-weight: bold;
        }
        
        .drawbridge {
            color: #ccc;
            font-weight: bold;
        }
        
        .castle-walls {
            color: #666;
            font-weight: bold;
        }
        
        .bat-swarm {
            color: #f48;
            font-weight: bold;
        }
        
        .vampire-spawn {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #cc0000;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #cc0000;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #ff4444;
        }
        
        /* New Game Button */
        .new-game-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #111;
            border: 1px solid #cc0000;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .new-game-btn:hover {
            background: #222;
            color: #ff4444;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            h2 {
                font-size: 16px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" id="sound-toggle">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <!-- New Game Button -->
        <div class="new-game-btn" id="new-game-btn">
            NEW GAME
        </div>
        
        <div class="header">
            <h1>DRACULA'S LAST RISE</h1>
            <h2>LEVEL 4: OUTSIDE THE CASTLE GATES</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number completed">2</div>
            <div class="level-number completed">3</div>
            <div class="level-number current">4</div>
            <div class="level-number">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/10</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>CASTLE DRACULA - OUTER GATES</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" id="use-agility-btn">USE AGILITY</button>
                <button class="action-btn" id="use-item-btn">USE ITEM</button>
                <button class="action-btn" id="save-game-btn">SAVE GAME</button>
                <button class="action-btn" id="load-game-btn">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Level Complete Screen -->
        <div id="screen-complete" class="screen">
            <h2>CASTLE GATES BREACHED!</h2>
            <div class="story-text">
                <p class="victory">YOU HAVE COMPLETED LEVEL 4!</p>
                <div style="margin-top: 15px; padding: 10px; background-color: #330000; border: 1px solid #cc0000;">
                    <p>You stand just inside the <span class="castle-gates">main gates</span> of Castle Dracula. The massive iron gates now lie broken behind you, their defenders defeated or scattered.</p>
                    <p>From your vantage point, you can see the <span class="castle-walls">castle courtyard</span> ahead - a vast, open area leading to the main keep. Storm clouds swirl ominously overhead, and the air is thick with the scent of decay and dark magic.</p>
                    <p>The <span class="vampire">Castle Courtyard</span> awaits, filled with Dracula's most loyal servants and supernatural guardians. The vampire lord himself waits somewhere deep within the castle walls, gathering his strength for the final confrontation.</p>
                </div>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">FINAL STRENGTH:</span> <span id="complete-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">FINAL HEALTH:</span> <span id="complete-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">FINAL AGILITY:</span> <span id="complete-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">FINAL GOLD:</span> <span id="complete-stat-gold" class="stat-value">0</span></div>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background-color: #003322; border: 1px solid #00ff88;">
                    <h3 style="color: #00ff88; margin-top: 0;">YOUR PROGRESS:</h3>
                    <p>You've breached the outer defenses of Castle Dracula. The gate guards are defeated, and the first line of defense has fallen.</p>
                    <p>But Dracula's power only grows stronger as you approach his inner sanctum. The <span class="vampire">Castle Courtyard</span> lies ahead - an open killing ground filled with traps, guardians, and the vampire lord's elite warriors.</p>
                    <p>From the notes you've gathered, you know that Dracula is most vulnerable at dawn, and that ancient relics within the castle could turn the tide. But first, you must survive the courtyard.</p>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" id="next-level-btn">CONTINUE TO LEVEL 5: CASTLE COURTYARD</button>
            </div>
        </div>
        
        <div class="footer">
            DRACULA'S LAST RISE - A Gothic Horror Adventure<br>
            Level 4: Outside the Castle Gates
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects for level 4
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'victory':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    setTimeout(() => playBeep(1300, 0.3, 'sine'), 500);
                    break;
                case 'gold':
                    playBeep(1000, 0.1, 'sine');
                    for(let i = 0; i < 5; i++) {
                        setTimeout(() => playBeep(800 + i*100, 0.1, 'sine'), 100 + i*100);
                    }
                    break;
                case 'vampire':
                    playBeep(200, 0.4, 'square');
                    setTimeout(() => playBeep(150, 0.4, 'square'), 400);
                    setTimeout(() => playBeep(100, 0.4, 'square'), 800);
                    break;
                case 'gate':
                    playBeep(150, 0.5, 'sine');
                    setTimeout(() => playBeep(100, 0.5, 'sine'), 500);
                    break;
                case 'moat':
                    playBeep(300, 0.3, 'sine');
                    setTimeout(() => playBeep(250, 0.3, 'sine'), 300);
                    break;
                case 'bat':
                    for(let i = 0; i < 3; i++) {
                        setTimeout(() => playBeep(600 + i*100, 0.1, 'sawtooth'), i*100);
                    }
                    break;
                case 'chain':
                    playBeep(300, 0.2, 'square');
                    setTimeout(() => playBeep(200, 0.2, 'square'), 200);
                    break;
                case 'guard':
                    playBeep(400, 0.2, 'sawtooth');
                    setTimeout(() => playBeep(350, 0.2, 'sawtooth'), 200);
                    break;
                case 'castle':
                    playBeep(250, 0.5, 'sine');
                    setTimeout(() => playBeep(200, 0.5, 'sine'), 500);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // New Game function
        function newGame() {
            playSound('click');
            if (confirm("Start a new game? This will erase your current progress.")) {
                localStorage.removeItem('draculaGameState');
                window.location.href = 'le1.html';
            }
        }
        
        // Game state object - loaded from localStorage
        const savedState = JSON.parse(localStorage.getItem('draculaGameState'));
        let gameState;
        
        // If no saved game or wrong level, create default state for Level 4
        if (!savedState || savedState.level !== 4) {
            // Create a default state for Level 4 if player comes directly without completing previous levels
            gameState = {
                playerClass: 'warrior',
                strength: 22,
                maxHealth: 75,
                health: 75,
                agility: 16,
                gold: 100,
                inventory: ['Health Potion', 'Silver Amulet', 'Torch', 'Healing Herbs', 'Castle Dracula Map'],
                equippedWeapon: 'Steel Sword',
                equippedArmor: 'Leather Armor',
                currentSection: 1,
                gameComplete: false,
                level: 4,
                // Level completion flags
                level1Complete: true,
                level2Complete: true,
                level3Complete: true,
                level4Complete: false
            };
        } else {
            // Use the saved state
            gameState = savedState;
            
            // Ensure level is set to 4
            gameState.level = 4;
            gameState.level4Complete = false;
            gameState.gameComplete = false;
            
            // Mark previous levels as completed
            gameState.level1Complete = true;
            gameState.level2Complete = true;
            gameState.level3Complete = true;
        }
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            nextSection: 0
        };
        
        // Initialize game
        function initGame() {
            // Check if Level 4 is already completed
            if (gameState.level4Complete) {
                showCompleteScreen();
                return;
            }
            
            // Update display and start the game
            updateStatsDisplay();
            updateInventoryDisplay();
            loadSection(gameState.currentSection);
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item) && item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/10`;
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Health Potion') {
                const healAmount = rollDice(2, 6) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You drink the <span class='item'>Health Potion</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Healing Herbs') {
                const healAmount = rollDice(1, 6) + 2;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>Healing Herbs</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Silver Amulet') {
                message = "The <span class='item'>Silver Amulet</span> feels warm to the touch. It offers protection against dark creatures.";
            } else if (item === 'Torch') {
                message = "The <span class='item'>Torch</span> illuminates dark places and can frighten some creatures.";
            } else if (item === 'Castle Dracula Map') {
                message = "The <span class='item'>Castle Dracula Map</span> shows the layout of the castle grounds. The main gates are marked here.";
            } else if (item === 'Gate Key') {
                message = "The <span class='item'>Gate Key</span> is heavy and ornate, made of black iron. It should open the castle gates.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0) {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
            
            // Add event listeners to the newly created buttons
            setTimeout(() => {
                const buttons = document.querySelectorAll('.action-btn');
                buttons.forEach(button => {
                    button.addEventListener('click', function() {
                        if (button.textContent === 'Cancel') {
                            document.getElementById('story-text').innerHTML += '<div class="dice-roll">Item use cancelled.</div>';
                        } else if (button.textContent === gameState.equippedWeapon || button.textContent === gameState.equippedArmor) {
                            useInventoryItem(button.textContent);
                        } else if (usableItems.includes(button.textContent)) {
                            useInventoryItem(button.textContent);
                        }
                    });
                });
            }, 100);
        }
        
        // Game story sections for Level 4
        const storySections = {
            1: {
                text: "You stand before the towering <span class='castle-gates'>main gates</span> of Castle Dracula. The gates are massive iron constructs, twice the height of a man, adorned with twisted metal depicting scenes of horror and suffering. A deep <span class='moat'>moat</span> filled with dark, stagnant water surrounds the castle walls. The air here is cold and still, carrying the scent of decay.",
                choices: [
                    {text: "Approach the main gate directly", nextSection: 2, skillCheck: false},
                    {text: "Search for another way in along the walls", nextSection: 3, skillCheck: false},
                    {text: "Examine the drawbridge mechanism", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    playSound('castle');
                    return "The <span class='vampire'>Castle Dracula</span> looms before you, a monument to darkness and despair. You've come so far, but the hardest challenges still await.";
                }
            },
            2: {
                text: "You approach the main gate cautiously. As you draw near, you notice movement on the battlements above. Two armored figures peer down at you from the gatehouse.",
                choices: [
                    {text: "Call out to the guards", nextSection: 5, skillCheck: false},
                    {text: "Hide and observe from a distance", nextSection: 6, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Prepare for combat", nextSection: 7, skillCheck: false}
                ],
                action: function() {
                    playSound('guard');
                    return "The <span class='gate-guard'>gate guards</span> seem alert and well-armed. Getting past them won't be easy.";
                }
            },
            3: {
                text: "You move away from the main gate, following the castle wall. The stonework is ancient but well-maintained, with few handholds for climbing.",
                choices: [
                    {text: "Search for a secret entrance", nextSection: 8, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Attempt to scale the wall", nextSection: 9, skillCheck: true, checkType: 'strength', difficulty: 18},
                    {text: "Return to the main gate", nextSection: 2, skillCheck: false}
                ]
            },
            4: {
                text: "You examine the drawbridge mechanism. The bridge is currently raised, spanning the moat to create a barrier. Massive chains disappear into slots in the gatehouse walls.",
                choices: [
                    {text: "Try to lower the drawbridge", nextSection: 10, skillCheck: true, checkType: 'strength', difficulty: 20},
                    {text: "Look for another way across the moat", nextSection: 11, skillCheck: false}
                ],
                action: function() {
                    playSound('chain');
                    return "The <span class='drawbridge'>drawbridge</span> is massive and heavy. Lowering it would require tremendous strength or finding the control mechanism inside the gatehouse.";
                }
            },
            5: {
                text: "You call out to the guards. One of them leans over the battlement, his face hidden behind a dark helmet.",
                choices: [
                    {text: "Demand entry", nextSection: 12, skillCheck: false},
                    {text: "Try to bluff your way in", nextSection: 13, skillCheck: true, checkType: 'agility', difficulty: 15}
                ],
                action: function() {
                    return "<span class='gate-guard'>Guard</span>: 'Who approaches the Master's domain? Speak quickly, mortal.'";
                }
            },
            6: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 14, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You hide behind a large stone and observe the guards. You notice they patrol in a regular pattern, leaving the gatehouse unguarded for brief periods.";
                    } else {
                        playSound('failure');
                        return "You're spotted! One of the guards points directly at your hiding place.";
                    }
                }
            },
            7: {
                text: "You ready your weapon. The guards see your hostile intent and sound an alarm!",
                choices: [
                    {text: "Fight!", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Gate Guards";
                    combatState.enemyHealth = 50;
                    combatState.enemyCurrentHealth = 50;
                    combatState.enemyStrength = 18;
                    combatState.nextSection = 16;
                    
                    playSound('combat');
                    return "<span class='gate-guard'>Gate Guards</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            8: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 17, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "After searching carefully, you discover a hidden drainage tunnel partially concealed by overgrown ivy. It appears to lead under the castle walls.";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "While searching, you trigger a hidden trap! A poisoned dart strikes you for " + damage + " damage.";
                    }
                }
            },
            9: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You find enough handholds to scale the wall. You reach the top and drop down into a dark corner of the courtyard.";
                    } else {
                        const damage = rollDice(2, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You lose your grip and fall from halfway up the wall, taking " + damage + " damage.";
                    }
                }
            },
            10: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With a tremendous effort, you manage to turn the crank mechanism. The drawbridge slowly lowers with a loud groaning of metal and chains!";
                    } else {
                        playSound('failure');
                        return "The mechanism is rusted and immovable. You lack the strength to lower the drawbridge.";
                    }
                }
            },
            11: {
                text: "You search for another way across the moat. The dark water looks deep and uninviting.",
                choices: [
                    {text: "Swim across the moat", nextSection: 20, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Look for a boat", nextSection: 21, skillCheck: false}
                ]
            },
            12: {
                text: "You demand entry to the castle. The guards laugh, a hollow, mocking sound.",
                choices: [
                    {text: "Attack!", nextSection: 15, skillCheck: false},
                    {text: "Try a different approach", nextSection: 5, skillCheck: false}
                ],
                action: function() {
                    return "<span class='gate-guard'>Guard</span>: 'Foolish mortal! None may enter without the Master's invitation. And you are most certainly not invited.'";
                }
            },
            13: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 22, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You claim to be a new recruit sent from the mountain church. The guards seem uncertain but lower the drawbridge slightly to get a better look at you.";
                    } else {
                        playSound('failure');
                        return "Your bluff fails. The guards recognize you as the hunter who defeated their comrades in the mountains.";
                    }
                }
            },
            14: {
                text: "From your hidden position, you notice the guards' patrol pattern. There's a 30-second window when both guards are away from the gatehouse.",
                choices: [
                    {text: "Sneak forward during the gap", nextSection: 23, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Create a distraction", nextSection: 24, skillCheck: false}
                ]
            },
            15: {
                text: "",
                choices: [
                    {text: "Attack!", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    // Execute one round of combat
                    if (combatState.active) {
                        const combatResult = executeCombatRound();
                        
                        // Check if combat is over
                        if (combatState.enemyCurrentHealth <= 0) {
                            combatState.active = false;
                            // Automatically go to victory section after a short delay
                            setTimeout(() => {
                                loadSection(combatState.nextSection);
                            }, 1500);
                            return combatResult + "<br><br><span class='success'>You defeated the guards!</span>";
                        } else if (gameState.health <= 0) {
                            combatState.active = false;
                            // Game over - will be handled in executeCombatRound
                            return combatResult;
                        }
                        
                        return combatResult;
                    }
                    return "Combat has ended.";
                }
            },
            16: {
                text: "The gate guards lie defeated. The gatehouse is now unguarded.",
                choices: [
                    {text: "Search the gatehouse", nextSection: 25, skillCheck: false},
                    {text: "Open the main gates", nextSection: 26, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You search the guards and find <span class='gold'>" + goldFound + " Gold</span> and a heavy iron key.";
                }
            },
            17: {
                text: "You enter the drainage tunnel. It's dark, cramped, and smells of decay, but it leads under the castle walls.",
                choices: [
                    {text: "Continue through the tunnel", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Gate Key');
                    playSound('item');
                    return "Inside the tunnel, you find a discarded <span class='item'>Gate Key</span>!";
                }
            },
            18: {
                text: "You're now inside the castle grounds, hidden in shadows near the outer wall.",
                choices: [
                    {text: "Move toward the main gates from inside", nextSection: 28, skillCheck: false}
                ]
            },
            19: {
                text: "The drawbridge is now lowered! You can cross the moat and approach the main gates directly.",
                choices: [
                    {text: "Cross the drawbridge", nextSection: 29, skillCheck: false}
                ],
                action: function() {
                    playSound('gate');
                    return "The <span class='drawbridge'>drawbridge</span> slams down with a thunderous crash, alerting everyone in the vicinity to your presence.";
                }
            },
            20: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 30, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You swim silently across the moat. The water is cold and foul-smelling, but you reach the other side undetected.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "Something brushes against your leg in the dark water! You panic and swim frantically, taking " + damage + " damage from unseen claws or teeth.";
                    }
                }
            },
            21: {
                text: "You search along the moat's edge and find a small, rotting boat tied to a post.",
                choices: [
                    {text: "Take the boat across", nextSection: 31, skillCheck: true, checkType: 'agility', difficulty: 14}
                ]
            },
            22: {
                text: "The drawbridge is partially lowered. The guards lean over to get a better look at you.",
                choices: [
                    {text: "Attack while they're distracted", nextSection: 32, skillCheck: false},
                    {text: "Continue the bluff", nextSection: 33, skillCheck: true, checkType: 'agility', difficulty: 16}
                ]
            },
            23: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 34, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip forward during the guards' absence and reach the gatehouse door unnoticed.";
                    } else {
                        playSound('failure');
                        return "You're spotted! One of the guards returns early and sees you.";
                    }
                }
            },
            24: {
                text: "You create a distraction by throwing a rock into the moat. The splash draws the guards' attention.",
                choices: [
                    {text: "Move forward while they investigate", nextSection: 35, skillCheck: false}
                ]
            },
            25: {
                text: "You enter the gatehouse. It's a small stone room with a winch mechanism for the drawbridge and a lever for the main gates.",
                choices: [
                    {text: "Pull the gate lever", nextSection: 36, skillCheck: false},
                    {text: "Take the stairs to the battlements", nextSection: 37, skillCheck: false}
                ]
            },
            26: {
                text: "You use the key found on the guards to unlock the main gates.",
                choices: [
                    {text: "Open the gates", nextSection: 38, skillCheck: false}
                ]
            },
            27: {
                text: "The drainage tunnel emerges inside the castle grounds, near the base of the outer wall. You're now behind the main gate defenses.",
                choices: [
                    {text: "Approach the gatehouse from behind", nextSection: 39, skillCheck: false}
                ]
            },
            28: {
                text: "You move stealthily toward the gatehouse. From this angle, you can see the guards on the battlements above.",
                choices: [
                    {text: "Sneak into the gatehouse", nextSection: 40, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Attack the guards from behind", nextSection: 41, skillCheck: false}
                ]
            },
            29: {
                text: "You cross the drawbridge. The main gates are now directly before you, imposing and formidable.",
                choices: [
                    {text: "Try to open the gates", nextSection: 42, skillCheck: false},
                    {text: "Call out to the guards", nextSection: 5, skillCheck: false}
                ]
            },
            30: {
                text: "You emerge from the moat on the other side, wet and cold but undetected.",
                choices: [
                    {text: "Approach the main gates", nextSection: 43, skillCheck: false}
                ]
            },
            31: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 44, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "The boat holds together long enough to get you across the moat. You reach the other side safely.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The rotting boat collapses halfway across! You swim the rest of the way, taking " + damage + " damage from the foul water.";
                    }
                }
            },
            32: {
                text: "You attack the distracted guards!",
                choices: [
                    {text: "Fight!", nextSection: 45, skillCheck: false}
                ],
                action: function() {
                    // Combat with advantage
                    combatState.active = true;
                    combatState.enemyName = "Distracted Gate Guards";
                    combatState.enemyHealth = 40;
                    combatState.enemyCurrentHealth = 40;
                    combatState.enemyStrength = 16;
                    combatState.nextSection = 16;
                    
                    playSound('combat');
                    return "<span class='gate-guard'>Distracted Gate Guards</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            33: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You maintain your bluff. The guards seem convinced and lower the drawbridge completely.";
                    } else {
                        playSound('failure');
                        return "Your story has inconsistencies. The guards grow suspicious and prepare for combat.";
                    }
                }
            },
            34: {
                text: "You're now inside the gatehouse. The room contains the drawbridge controls and the gate mechanism.",
                choices: [
                    {text: "Lower the drawbridge", nextSection: 47, skillCheck: false},
                    {text: "Open the main gates", nextSection: 36, skillCheck: false}
                ]
            },
            35: {
                text: "While the guards investigate the splash, you slip into the gatehouse unnoticed.",
                choices: [
                    {text: "Close and lock the door behind you", nextSection: 48, skillCheck: false}
                ]
            },
            36: {
                text: "You pull the massive lever. With a groaning of metal and stone, the main gates begin to open!",
                choices: [
                    {text: "Complete Level 4", nextSection: 49, skillCheck: false}
                ],
                action: function() {
                    playSound('gate');
                    return "The <span class='castle-gates'>main gates</span> swing open, revealing the castle courtyard beyond. You've breached the outer defenses!";
                }
            },
            37: {
                text: "You climb the stairs to the battlements. The two guards are up here, looking out over the drawbridge.",
                choices: [
                    {text: "Attack the guards from behind", nextSection: 50, skillCheck: false},
                    {text: "Try to sneak past them", nextSection: 51, skillCheck: true, checkType: 'agility', difficulty: 18}
                ]
            },
            38: {
                text: "The massive gates swing open. The way into Castle Dracula is now clear.",
                choices: [
                    {text: "Enter the castle grounds", nextSection: 49, skillCheck: false}
                ],
                action: function() {
                    playSound('gate');
                    return "The gates open with a thunderous creak that echoes through the castle grounds.";
                }
            },
            39: {
                text: "You approach the gatehouse from the inside. The guards haven't noticed you yet.",
                choices: [
                    {text: "Sneak into the gatehouse", nextSection: 52, skillCheck: true, checkType: 'agility', difficulty: 15}
                ]
            },
            40: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 53, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip into the gatehouse unnoticed. The guards remain on the battlements above.";
                    } else {
                        playSound('failure');
                        return "You're spotted! One of the guards shouts an alarm.";
                    }
                }
            },
            41: {
                text: "You attack the guards from behind!",
                choices: [
                    {text: "Fight!", nextSection: 54, skillCheck: false}
                ],
                action: function() {
                    // Combat with surprise
                    combatState.active = true;
                    combatState.enemyName = "Surprised Gate Guards";
                    combatState.enemyHealth = 45;
                    combatState.enemyCurrentHealth = 45;
                    combatState.enemyStrength = 16;
                    combatState.nextSection = 16;
                    
                    playSound('combat');
                    return "<span class='gate-guard'>Surprised Gate Guards</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            42: {
                text: "The gates are locked from the inside. You'll need to find another way to open them.",
                choices: [
                    {text: "Search for another entrance", nextSection: 3, skillCheck: false},
                    {text: "Try to break the gates down", nextSection: 55, skillCheck: true, checkType: 'strength', difficulty: 25}
                ]
            },
            43: {
                text: "You approach the main gates from the moat side. You're now at the base of the gates, but they're locked.",
                choices: [
                    {text: "Try to climb the gates", nextSection: 56, skillCheck: true, checkType: 'agility', difficulty: 19},
                    {text: "Look for another way", nextSection: 3, skillCheck: false}
                ]
            },
            44: {
                text: "You've crossed the moat and now stand before the main gates.",
                choices: [
                    {text: "Approach the gates", nextSection: 42, skillCheck: false}
                ]
            },
            45: {
                text: "",
                choices: [
                    {text: "Attack!", nextSection: 45, skillCheck: false}
                ],
                action: function() {
                    // Execute one round of combat
                    if (combatState.active) {
                        const combatResult = executeCombatRound();
                        
                        // Check if combat is over
                        if (combatState.enemyCurrentHealth <= 0) {
                            combatState.active = false;
                            // Automatically go to victory section after a short delay
                            setTimeout(() => {
                                loadSection(combatState.nextSection);
                            }, 1500);
                            return combatResult + "<br><br><span class='success'>You defeated the guards!</span>";
                        } else if (gameState.health <= 0) {
                            combatState.active = false;
                            // Game over - will be handled in executeCombatRound
                            return combatResult;
                        }
                        
                        return combatResult;
                    }
                    return "Combat has ended.";
                }
            },
            46: {
                text: "The guards lower the drawbridge completely and open a small side door in the main gates.",
                choices: [
                    {text: "Enter through the side door", nextSection: 57, skillCheck: false}
                ]
            },
            47: {
                text: "You lower the drawbridge. The noise alerts the guards on the battlements!",
                choices: [
                    {text: "Prepare for combat", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    playSound('chain');
                    return "The <span class='drawbridge'>drawbridge</span> crashes down. The guards rush down from the battlements to investigate!";
                }
            },
            48: {
                text: "You're safely inside the gatehouse with the door locked. The guards are trapped outside.",
                choices: [
                    {text: "Open the main gates", nextSection: 36, skillCheck: false}
                ]
            },
            49: {
                text: "",
                choices: []
            },
            50: {
                text: "You attack the guards on the battlements!",
                choices: [
                    {text: "Fight!", nextSection: 60, skillCheck: false}
                ],
                action: function() {
                    // Dangerous combat on narrow battlements
                    combatState.active = true;
                    combatState.enemyName = "Gate Guards on Battlements";
                    combatState.enemyHealth = 55;
                    combatState.enemyCurrentHealth = 55;
                    combatState.enemyStrength = 18;
                    combatState.nextSection = 61;
                    
                    playSound('combat');
                    return "<span class='gate-guard'>Gate Guards on Battlements</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            51: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 62, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip past the guards on the narrow battlement and reach the stairs leading down into the gatehouse.";
                    } else {
                        const damage = rollDice(2, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You're spotted! In the ensuing struggle, you're pushed off the battlement, falling to the ground below and taking " + damage + " damage.";
                    }
                }
            },
            52: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 63, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You enter the gatehouse without being noticed. The guards are still outside.";
                    } else {
                        playSound('failure');
                        return "You're spotted entering the gatehouse!";
                    }
                }
            },
            53: {
                text: "You're inside the gatehouse. The controls for the drawbridge and main gates are here.",
                choices: [
                    {text: "Open the main gates", nextSection: 36, skillCheck: false}
                ]
            },
            54: {
                text: "",
                choices: [
                    {text: "Attack!", nextSection: 54, skillCheck: false}
                ],
                action: function() {
                    // Execute one round of combat
                    if (combatState.active) {
                        const combatResult = executeCombatRound();
                        
                        // Check if combat is over
                        if (combatState.enemyCurrentHealth <= 0) {
                            combatState.active = false;
                            // Automatically go to victory section after a short delay
                            setTimeout(() => {
                                loadSection(combatState.nextSection);
                            }, 1500);
                            return combatResult + "<br><br><span class='success'>You defeated the guards!</span>";
                        } else if (gameState.health <= 0) {
                            combatState.active = false;
                            // Game over - will be handled in executeCombatRound
                            return combatResult;
                        }
                        
                        return combatResult;
                    }
                    return "Combat has ended.";
                }
            },
            55: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 65, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With a tremendous effort, you break the lock mechanism! The gates swing open.";
                    } else {
                        playSound('failure');
                        return "The gates are too strong. Your attempt to break them down fails.";
                    }
                }
            },
            56: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 66, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You climb the iron gates skillfully, reaching the top and dropping down on the other side.";
                    } else {
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You slip and fall from the gates, taking " + damage + " damage.";
                    }
                }
            },
            57: {
                text: "You enter through the side door. The guards close it behind you, trapping you in a small antechamber.",
                choices: [
                    {text: "Fight your way out", nextSection: 67, skillCheck: false},
                    {text: "Try to talk your way further in", nextSection: 68, skillCheck: true, checkType: 'agility', difficulty: 17}
                ]
            },
            58: {
                text: "The guards burst into the gatehouse!",
                choices: [
                    {text: "Fight!", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Angry Gate Guards";
                    combatState.enemyHealth = 50;
                    combatState.enemyCurrentHealth = 50;
                    combatState.enemyStrength = 18;
                    combatState.nextSection = 70;
                    
                    playSound('combat');
                    return "<span class='gate-guard'>Angry Gate Guards</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            60: {
                text: "",
                choices: [
                    {text: "Attack!", nextSection: 60, skillCheck: false}
                ],
                action: function() {
                    // Execute one round of combat
                    if (combatState.active) {
                        const combatResult = executeCombatRound();
                        
                        // Check if combat is over
                        if (combatState.enemyCurrentHealth <= 0) {
                            combatState.active = false;
                            // Automatically go to victory section after a short delay
                            setTimeout(() => {
                                loadSection(combatState.nextSection);
                            }, 1500);
                            return combatResult + "<br><br><span class='success'>You defeated the guards!</span>";
                        } else if (gameState.health <= 0) {
                            combatState.active = false;
                            // Game over - will be handled in executeCombatRound
                            return combatResult;
                        }
                        
                        return combatResult;
                    }
                    return "Combat has ended.";
                }
            },
            61: {
                text: "The guards on the battlements are defeated. You now control the gatehouse.",
                choices: [
                    {text: "Open the main gates", nextSection: 36, skillCheck: false}
                ]
            },
            62: {
                text: "You reach the gatehouse control room from the battlements.",
                choices: [
                    {text: "Open the main gates", nextSection: 36, skillCheck: false}
                ]
            },
            63: {
                text: "You're in the gatehouse. The guards haven't noticed you yet.",
                choices: [
                    {text: "Sneak to the control mechanism", nextSection: 71, skillCheck: true, checkType: 'agility', difficulty: 16}
                ]
            },
            65: {
                text: "You stand before the broken gates. The way is open.",
                choices: [
                    {text: "Enter the castle grounds", nextSection: 49, skillCheck: false}
                ]
            },
            66: {
                text: "You're now inside the castle grounds. The gatehouse is to your left.",
                choices: [
                    {text: "Approach the gatehouse", nextSection: 39, skillCheck: false}
                ]
            },
            67: {
                text: "You attack the guards in the antechamber!",
                choices: [
                    {text: "Fight!", nextSection: 73, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Antechamber Guards";
                    combatState.enemyHealth = 40;
                    combatState.enemyCurrentHealth = 40;
                    combatState.enemyStrength = 16;
                    combatState.nextSection = 74;
                    
                    playSound('combat');
                    return "<span class='gate-guard'>Antechamber Guards</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            68: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 75, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You convince the guards to take you to their captain for 'questioning'. Once in the gatehouse proper, you make your move.";
                    } else {
                        playSound('failure');
                        return "The guards see through your ruse and attack!";
                    }
                }
            },
            69: {
                text: "",
                choices: [
                    {text: "Attack!", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    // Execute one round of combat
                    if (combatState.active) {
                        const combatResult = executeCombatRound();
                        
                        // Check if combat is over
                        if (combatState.enemyCurrentHealth <= 0) {
                            combatState.active = false;
                            // Automatically go to victory section after a short delay
                            setTimeout(() => {
                                loadSection(combatState.nextSection);
                            }, 1500);
                            return combatResult + "<br><br><span class='success'>You defeated the guards!</span>";
                        } else if (gameState.health <= 0) {
                            combatState.active = false;
                            // Game over - will be handled in executeCombatRound
                            return combatResult;
                        }
                        
                        return combatResult;
                    }
                    return "Combat has ended.";
                }
            },
            70: {
                text: "The guards in the gatehouse are defeated. You now control the entrance.",
                choices: [
                    {text: "Open the main gates", nextSection: 36, skillCheck: false}
                ]
            },
            71: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 77, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You reach the control mechanism without being noticed. The main gate lever is right before you.";
                    } else {
                        playSound('failure');
                        return "You're spotted as you reach for the lever!";
                    }
                }
            },
            73: {
                text: "",
                choices: [
                    {text: "Attack!", nextSection: 73, skillCheck: false}
                ],
                action: function() {
                    // Execute one round of combat
                    if (combatState.active) {
                        const combatResult = executeCombatRound();
                        
                        // Check if combat is over
                        if (combatState.enemyCurrentHealth <= 0) {
                            combatState.active = false;
                            // Automatically go to victory section after a short delay
                            setTimeout(() => {
                                loadSection(combatState.nextSection);
                            }, 1500);
                            return combatResult + "<br><br><span class='success'>You defeated the guards!</span>";
                        } else if (gameState.health <= 0) {
                            combatState.active = false;
                            // Game over - will be handled in executeCombatRound
                            return combatResult;
                        }
                        
                        return combatResult;
                    }
                    return "Combat has ended.";
                }
            },
            74: {
                text: "The antechamber guards are defeated. You're now in the gatehouse proper.",
                choices: [
                    {text: "Open the main gates", nextSection: 36, skillCheck: false}
                ]
            },
            77: {
                text: "You pull the lever! The main gates begin to open.",
                choices: [
                    {text: "Complete Level 4", nextSection: 49, skillCheck: false}
                ],
                action: function() {
                    playSound('gate');
                    return "The <span class='castle-gates'>main gates</span> swing open with a mighty groan of metal and stone.";
                }
            }
        };
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                // Show complete screen if section 49 (completion)
                if (sectionId === 49) {
                    showCompleteScreen();
                    return;
                }
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Clear choice buttons
            const choiceButtons = document.getElementById('choice-buttons');
            choiceButtons.innerHTML = '';
            
            // If in combat, show attack button
            if (combatState.active && (
                sectionId === 15 || sectionId === 45 || sectionId === 54 || 
                sectionId === 60 || sectionId === 69 || sectionId === 73
            )) {
                const attackButton = document.createElement('button');
                attackButton.className = 'choice-btn';
                attackButton.textContent = "Attack!";
                attackButton.onclick = function() {
                    loadSection(sectionId);
                };
                choiceButtons.appendChild(attackButton);
                return;
            }
            
            // Filter choices based on requirements
            const availableChoices = section.choices.filter(choice => {
                if (!choice.requirement) return true;
                if (typeof choice.requirement === 'function') {
                    return choice.requirement();
                }
                return gameState.inventory.includes(choice.requirement) || 
                       gameState.equippedWeapon === choice.requirement ||
                       gameState.equippedArmor === choice.requirement;
            });
            
            // If no choices available (and not a special section), provide a default
            if (availableChoices.length === 0 && section.choices.length > 0) {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = "Continue";
                button.onclick = function() {
                    loadSection(1);
                };
                choiceButtons.appendChild(button);
            } else {
                availableChoices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    button.onclick = function() {
                        if (choice.skillCheck) {
                            performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                        } else {
                            loadSection(choice.nextSection);
                        }
                    };
                    choiceButtons.appendChild(button);
                });
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                let weaponType = gameState.equippedWeapon;
                
                // Weapon bonuses
                if (weaponType === 'Steel Sword') {
                    damage = rollDice(2, 8) + 3;
                } else if (weaponType === 'Silver Sword') {
                    damage = rollDice(3, 8) + 5;
                } else {
                    damage = rollDice(1, 6);
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                let enemyDamage = rollDice(2, 6);
                
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            // Check for player death
            if (gameState.health <= 0) {
                resultText += `<div class="game-over">YOU HAVE DIED</div>`;
                resultText += `<div class="dice-roll"><button class="action-btn" id="restart-btn">Restart Level 4</button></div>`;
                combatState.active = false;
                
                // Add restart button functionality
                setTimeout(() => {
                    document.getElementById('restart-btn').addEventListener('click', function() {
                        window.location.href = 'le4.html';
                    });
                }, 100);
            }
            
            return resultText;
        }
        
        // Show complete screen
        function showCompleteScreen() {
            // Update complete screen stats
            document.getElementById('complete-stat-strength').textContent = gameState.strength;
            document.getElementById('complete-stat-health').textContent = gameState.health;
            document.getElementById('complete-stat-agility').textContent = gameState.agility;
            document.getElementById('complete-stat-gold').textContent = gameState.gold;
            
            playSound('victory');
            document.getElementById('screen-game').classList.remove('active-screen');
            document.getElementById('screen-complete').classList.add('active-screen');
            
            // Save completed game state
            gameState.level4Complete = true;
            saveGame();
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 5
            gameState.level = 5;
            gameState.currentSection = 1;
            saveGame();
            
            // Redirect to level 5
            window.location.href = 'le5.html';
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                const effect = "You dodge a trap or obstacle with ease!";
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                const effect = "You stumble and take 5 damage!";
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                gameState.health -= 5;
                updateStatsDisplay();
                playSound('damage');
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('draculaGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('draculaGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 4 (this page)
                if (savedState.level === 4) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 4.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = function() {
            // Set up event listeners
            document.getElementById('sound-toggle').addEventListener('click', toggleSound);
            document.getElementById('new-game-btn').addEventListener('click', newGame);
            document.getElementById('use-agility-btn').addEventListener('click', useAgility);
            document.getElementById('use-item-btn').addEventListener('click', useItem);
            document.getElementById('save-game-btn').addEventListener('click', saveGame);
            document.getElementById('load-game-btn').addEventListener('click', loadGame);
            document.getElementById('next-level-btn').addEventListener('click', goToNextLevel);
            
            // Initialize the game
            initGame();
        };
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
