<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle Crafting - Quest System</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #111;
            color: #0f0;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            padding: 0;
            display: flex;
            flex-direction: column;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(0, 80, 0, 0.2) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(0, 80, 0, 0.2) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        #header {
            padding: 12px 10px;
            background-color: #000;
            border-bottom: 2px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 255, 0, 0.3);
            z-index: 10;
            flex-wrap: wrap;
        }
        
        #header h1 {
            font-size: 14px;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            margin-right: auto;
        }
        
        #header-stats {
            display: flex;
            gap: 15px;
            margin: 0 10px;
        }
        
        .header-stat {
            display: flex;
            align-items: center;
            font-size: 10px;
        }
        
        .header-stat i {
            margin-right: 5px;
        }
        
        #btn-back {
            background: #300;
            color: #f88;
            border: 2px solid #f88;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-left: 10px;
        }

        #btn-back:hover, #btn-back:active {
            background: #f88;
            color: #300;
            box-shadow: 0 0 10px #f88;
        }
        
        #game-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
        }
        
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 2px solid #0f0;
            border-radius: 8px;
            padding: 10px;
            overflow: hidden;
            background-color: rgba(0, 20, 0, 0.8);
            box-shadow: inset 0 0 15px rgba(0, 255, 0, 0.2), 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        /* Tab navigation */
        .tab-container {
            display: flex;
            border-bottom: 2px solid #0f0;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            border: 2px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 6px 6px 0 0;
            background-color: #000;
            color: #0f0;
            font-size: 10px;
        }
        
        .tab.active {
            background-color: #0f0;
            color: #000;
            border-color: #0f0;
        }
        
        .tab-content {
            display: none;
            padding: 10px;
            overflow-y: auto;
            height: calc(100% - 50px);
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Quest styles */
        .quest {
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }
        
        .quest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .quest-title {
            color: #af0;
            font-size: 12px;
        }
        
        .quest-level {
            font-size: 10px;
            color: #fc0;
            background: #300;
            padding: 3px 6px;
            border-radius: 10px;
        }
        
        .quest-description {
            font-size: 10px;
            color: #aaa;
            margin-bottom: 8px;
        }
        
        .quest-rewards {
            font-size: 10px;
            color: #5cf;
            margin-bottom: 8px;
        }
        
        .quest-duration {
            font-size: 10px;
            color: #f55;
            margin-bottom: 10px;
        }
        
        .quest-button {
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            font-size: 10px;
            width: 100%;
        }
        
        .quest-button:hover {
            background: #0f0;
            color: #000;
        }
        
        .quest-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Hero styles */
        .hero {
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }
        
        .hero-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .hero-name {
            color: #5cf;
            font-size: 12px;
        }
        
        .hero-level {
            font-size: 10px;
            color: #fc0;
            background: #300;
            padding: 3px 6px;
            border-radius: 10px;
        }
        
        .hero-stats {
            font-size: 10px;
            color: #aaa;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }
        
        .hero-status {
            font-size: 10px;
            color: #f55;
            margin-bottom: 10px;
        }
        
        /* Active quest styles */
        .active-quest {
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }
        
        .active-quest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .active-quest-title {
            color: #f85;
            font-size: 12px;
        }
        
        .active-quest-hero {
            font-size: 10px;
            color: #5cf;
            margin-bottom: 8px;
        }
        
        .active-quest-timer {
            font-size: 10px;
            color: #fc0;
            margin-bottom: 8px;
        }
        
        .active-quest-progress {
            height: 10px;
            background-color: #222;
            border-radius: 5px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .active-quest-progress-bar {
            height: 100%;
            background-color: #5cf;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* Completed quest styles */
        .completed-quest {
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }
        
        .completed-quest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .completed-quest-title {
            color: #af0;
            font-size: 12px;
        }
        
        .completed-quest-rewards {
            font-size: 10px;
            color: #fc0;
            margin-bottom: 8px;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 6px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast.error {
            color: #f55;
            border-color: #f55;
        }
        
        /* Empty state message */
        .empty-state {
            text-align: center;
            color: #666;
            font-size: 12px;
            padding: 20px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 480px) {
            #header h1 {
                font-size: 12px;
            }
            
            .header-stat {
                font-size: 9px;
            }
            
            .tab {
                padding: 6px 8px;
                font-size: 9px;
            }
            
            .quest-title, .hero-name, .active-quest-title, .completed-quest-title {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Castle Crafting - Quest System</h1>
        <div id="header-stats">
            <div class="header-stat">Gold: <span id="header-gold">0</span></div>
            <div class="header-stat">Materials: <span id="header-materials">0</span></div>
        </div>
        <button id="btn-back">Back to Castle</button>
    </div>
    
    <div id="game-wrapper">
        <div id="game-container">
            <div class="tab-container">
                <div class="tab active" data-tab="available">Available Quests</div>
                <div class="tab" data-tab="heroes">Heroes</div>
                <div class="tab" data-tab="active">Active Quests</div>
                <div class="tab" data-tab="completed">Completed Quests</div>
            </div>
            
            <!-- Available Quests Tab -->
            <div class="tab-content active" id="available-tab">
                <!-- Quests will be dynamically added here -->
            </div>
            
            <!-- Heroes Tab -->
            <div class="tab-content" id="heroes-tab">
                <!-- Heroes will be dynamically added here -->
            </div>
            
            <!-- Active Quests Tab -->
            <div class="tab-content" id="active-tab">
                <!-- Active quests will be dynamically added here -->
            </div>
            
            <!-- Completed Quests Tab -->
            <div class="tab-content" id="completed-tab">
                <!-- Completed quests will be dynamically added here -->
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // Quest system state
        const questState = {
            gold: 0,
            materials: 0,
            heroes: [
                {
                    id: "knight",
                    name: "Sir Gallant",
                    level: 1,
                    attack: 12,
                    defense: 15,
                    health: 100,
                    status: "available", // available, on-quest
                    currentQuest: null,
                    questEndTime: null
                },
                {
                    id: "archer",
                    name: "Elven Arrow",
                    level: 1,
                    attack: 15,
                    defense: 8,
                    health: 80,
                    status: "available",
                    currentQuest: null,
                    questEndTime: null
                },
                {
                    id: "mage",
                    name: "Merlinus",
                    level: 1,
                    attack: 18,
                    defense: 6,
                    health: 70,
                    status: "available",
                    currentQuest: null,
                    questEndTime: null
                }
            ],
            availableQuests: [
                {
                    id: "goblin-hunt",
                    title: "Goblin Hunt",
                    description: "Clear the forest of pesky goblins that have been harassing travelers.",
                    level: 1,
                    duration: 30000, // 30 seconds in milliseconds
                    rewards: { gold: 50, materials: 20 },
                    status: "available"
                },
                {
                    id: "bandit-camp",
                    title: "Bandit Camp Raid",
                    description: "Take down the bandit camp that has been preying on merchant caravans.",
                    level: 2,
                    duration: 60000, // 1 minute
                    rewards: { gold: 100, materials: 40 },
                    status: "available"
                },
                {
                    id: "dragon-eggs",
                    title: "Dragon Egg Retrieval",
                    description: "Retrieve dragon eggs from the dangerous mountain cave. High risk, high reward.",
                    level: 3,
                    duration: 120000, // 2 minutes
                    rewards: { gold: 200, materials: 80 },
                    status: "available"
                }
            ],
            activeQuests: [],
            completedQuests: [],
            lastUpdate: Date.now()
        };

        // DOM Elements
        const headerGold = document.getElementById('header-gold');
        const headerMaterials = document.getElementById('header-materials');
        const btnBack = document.getElementById('btn-back');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const toastEl = document.getElementById('toast');

        // Initialize the page
        window.addEventListener('load', () => {
            // Load game state from localStorage
            loadGameState();
            
            // Update UI with loaded data
            updateUI();
            
            // Set up tab navigation
            setupTabs();
            
            // Render all tabs
            renderAvailableQuests();
            renderHeroes();
            renderActiveQuests();
            renderCompletedQuests();
            
            // Set up event listeners
            setupEventListeners();
            
            // Set up back button
            btnBack.addEventListener('click', goBackToCastle);
            
            // Start the quest timer
            startQuestTimer();
            
            // Save game state when page is about to be unloaded
            window.addEventListener('beforeunload', saveGameState);
        });

        function loadGameState() {
            try {
                // First, check if there's a main game save and sync gold from it
                const mainSaveData = localStorage.getItem('sanctuaryRPG_save');
                if (mainSaveData) {
                    try {
                        const mainState = JSON.parse(mainSaveData);
                        if (mainState.player && mainState.player.gold !== undefined) {
                            // Update our gold from the main game state
                            questState.gold = mainState.player.gold;
                        }
                    } catch (e) {
                        console.error("Error parsing main game state:", e);
                    }
                }
                
                // Then try to load from our quest system save
                const questSaveData = localStorage.getItem('castleQuest_save');
                if (questSaveData) {
                    try {
                        const loadedState = JSON.parse(questSaveData);
                        
                        // Load heroes
                        if (loadedState.heroes) {
                            questState.heroes = loadedState.heroes;
                        }
                        
                        // Load available quests
                        if (loadedState.availableQuests) {
                            questState.availableQuests = loadedState.availableQuests;
                        }
                        
                        // Load active quests
                        if (loadedState.activeQuests) {
                            questState.activeQuests = loadedState.activeQuests;
                        }
                        
                        // Load completed quests
                        if (loadedState.completedQuests) {
                            questState.completedQuests = loadedState.completedQuests;
                        }
                        
                        // Load materials
                        if (loadedState.materials !== undefined) {
                            questState.materials = loadedState.materials;
                        }
                        
                        // Load last update time
                        if (loadedState.lastUpdate) {
                            questState.lastUpdate = loadedState.lastUpdate;
                        }
                    } catch (e) {
                        console.error("Error parsing quest system state:", e);
                    }
                }
            } catch (e) {
                console.error("Failed to load game state:", e);
            }
        }

        function saveGameState() {
            try {
                // First, update the main game state with our current gold
                const mainSaveData = localStorage.getItem('sanctuaryRPG_save');
                if (mainSaveData) {
                    try {
                        const mainState = JSON.parse(mainSaveData);
                        if (mainState.player) {
                            mainState.player.gold = questState.gold;
                            localStorage.setItem('sanctuaryRPG_save', JSON.stringify(mainState));
                        }
                    } catch (e) {
                        console.error("Error updating main game state:", e);
                    }
                }
                
                // Then save our quest system state
                const saveData = {
                    gold: questState.gold,
                    materials: questState.materials,
                    heroes: questState.heroes,
                    availableQuests: questState.availableQuests,
                    activeQuests: questState.activeQuests,
                    completedQuests: questState.completedQuests,
                    lastUpdate: Date.now()
                };
                
                // Save to localStorage
                localStorage.setItem('castleQuest_save', JSON.stringify(saveData));
            } catch (e) {
                console.error("Failed to save game state:", e);
            }
        }

        function setupTabs() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const tabId = tab.dataset.tab;
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }

        function setupEventListeners() {
            // Any additional event listeners can be set up here
        }

        function renderAvailableQuests() {
            const container = document.getElementById('available-tab');
            container.innerHTML = '';
            
            if (questState.availableQuests.length === 0) {
                container.innerHTML = '<div class="empty-state">No quests available. Check back later!</div>';
                return;
            }
            
            questState.availableQuests.forEach(quest => {
                if (quest.status !== "available") return;
                
                const questElement = document.createElement('div');
                questElement.className = 'quest';
                questElement.innerHTML = `
                    <div class="quest-header">
                        <div class="quest-title">${quest.title}</div>
                        <div class="quest-level">Level ${quest.level}</div>
                    </div>
                    <div class="quest-description">${quest.description}</div>
                    <div class="quest-rewards">Rewards: ${quest.rewards.gold} Gold, ${quest.rewards.materials} Materials</div>
                    <div class="quest-duration">Duration: ${formatDuration(quest.duration)}</div>
                    <select id="hero-select-${quest.id}" class="quest-button" style="margin-bottom: 8px;">
                        <option value="">Select a Hero</option>
                        ${questState.heroes.map(hero => 
                            hero.status === "available" ? 
                            `<option value="${hero.id}">${hero.name} (Lvl ${hero.level})</option>` : 
                            ''
                        ).join('')}
                    </select>
                    <button class="quest-button" data-quest="${quest.id}" id="start-quest-${quest.id}">Start Quest</button>
                `;
                container.appendChild(questElement);
                
                // Add event listener to the button
                const button = document.getElementById(`start-quest-${quest.id}`);
                button.addEventListener('click', () => {
                    const heroSelect = document.getElementById(`hero-select-${quest.id}`);
                    const heroId = heroSelect.value;
                    
                    if (!heroId) {
                        showToast("Please select a hero first!", "error");
                        return;
                    }
                    
                    startQuest(quest.id, heroId);
                });
            });
        }

        function renderHeroes() {
            const container = document.getElementById('heroes-tab');
            container.innerHTML = '';
            
            questState.heroes.forEach(hero => {
                const heroElement = document.createElement('div');
                heroElement.className = 'hero';
                heroElement.innerHTML = `
                    <div class="hero-header">
                        <div class="hero-name">${hero.name}</div>
                        <div class="hero-level">Level ${hero.level}</div>
                    </div>
                    <div class="hero-stats">
                        <div>Attack: ${hero.attack}</div>
                        <div>Defense: ${hero.defense}</div>
                        <div>Health: ${hero.health}</div>
                        <div>Status: ${hero.status === "available" ? "Available" : "On Quest"}</div>
                    </div>
                    ${hero.status !== "available" ? 
                        `<div class="hero-status">Currently on: ${hero.currentQuest}</div>
                         <div class="hero-status">Returns in: ${formatTimeRemaining(hero.questEndTime - Date.now())}</div>` :
                        `<div class="hero-status">Ready for adventure!</div>`
                    }
                `;
                container.appendChild(heroElement);
            });
        }

        function renderActiveQuests() {
            const container = document.getElementById('active-tab');
            container.innerHTML = '';
            
            if (questState.activeQuests.length === 0) {
                container.innerHTML = '<div class="empty-state">No active quests. Assign heroes to quests!</div>';
                return;
            }
            
            questState.activeQuests.forEach(quest => {
                const hero = questState.heroes.find(h => h.currentQuest === quest.id);
                const timeRemaining = hero.questEndTime - Date.now();
                const progressPercent = 100 - (timeRemaining / quest.duration * 100);
                
                const questElement = document.createElement('div');
                questElement.className = 'active-quest';
                questElement.innerHTML = `
                    <div class="active-quest-header">
                        <div class="active-quest-title">${quest.title}</div>
                        <div class="quest-level">Level ${quest.level}</div>
                    </div>
                    <div class="active-quest-hero">Hero: ${hero.name}</div>
                    <div class="active-quest-timer">Time remaining: ${formatTimeRemaining(timeRemaining)}</div>
                    <div class="active-quest-progress">
                        <div class="active-quest-progress-bar" id="progress-${quest.id}" style="width: ${progressPercent}%"></div>
                    </div>
                    <button class="quest-button" data-quest="${quest.id}" id="cancel-quest-${quest.id}" ${timeRemaining < 10000 ? 'disabled' : ''}>Cancel Quest</button>
                `;
                container.appendChild(questElement);
                
                // Add event listener to the cancel button if not disabled
                if (timeRemaining >= 10000) {
                    const button = document.getElementById(`cancel-quest-${quest.id}`);
                    button.addEventListener('click', () => {
                        cancelQuest(quest.id);
                    });
                }
            });
        }

        function renderCompletedQuests() {
            const container = document.getElementById('completed-tab');
            container.innerHTML = '';
            
            if (questState.completedQuests.length === 0) {
                container.innerHTML = '<div class="empty-state">No completed quests yet. Heroes need to return from their adventures!</div>';
                return;
            }
            
            questState.completedQuests.slice().reverse().forEach(quest => {
                const questElement = document.createElement('div');
                questElement.className = 'completed-quest';
                questElement.innerHTML = `
                    <div class="completed-quest-header">
                        <div class="completed-quest-title">${quest.title}</div>
                        <div class="quest-level">Level ${quest.level}</div>
                    </div>
                    <div class="quest-description">${quest.description}</div>
                    <div class="completed-quest-rewards">Rewards: ${quest.rewards.gold} Gold, ${quest.rewards.materials} Materials</div>
                    <div class="quest-duration">Completed: ${new Date(quest.completionTime).toLocaleString()}</div>
                `;
                container.appendChild(questElement);
            });
        }

        function startQuest(questId, heroId) {
            const quest = questState.availableQuests.find(q => q.id === questId);
            const hero = questState.heroes.find(h => h.id === heroId);
            
            if (!quest || !hero) return;
            
            // Check if hero is available
            if (hero.status !== "available") {
                showToast(`${hero.name} is not available for quests!`, "error");
                return;
            }
            
            // Check if hero level is sufficient
            if (hero.level < quest.level) {
                showToast(`${hero.name} is not high enough level for this quest!`, "error");
                return;
            }
            
            // Update quest status
            quest.status = "active";
            
            // Update hero status
            hero.status = "on-quest";
            hero.currentQuest = questId;
            hero.questEndTime = Date.now() + quest.duration;
            
            // Move quest to active quests
            questState.activeQuests.push({...quest});
            
            // Update UI
            updateUI();
            renderAvailableQuests();
            renderHeroes();
            renderActiveQuests();
            
            // Save game state
            saveGameState();
            
            // Show success message
            showToast(`${hero.name} has started the ${quest.title} quest!`);
        }

        function cancelQuest(questId) {
            const questIndex = questState.activeQuests.findIndex(q => q.id === questId);
            if (questIndex === -1) return;
            
            const quest = questState.activeQuests[questIndex];
            const hero = questState.heroes.find(h => h.currentQuest === questId);
            
            if (!hero) return;
            
            // Update quest status in available quests
            const availableQuest = questState.availableQuests.find(q => q.id === questId);
            if (availableQuest) {
                availableQuest.status = "available";
            }
            
            // Update hero status
            hero.status = "available";
            hero.currentQuest = null;
            hero.questEndTime = null;
            
            // Remove from active quests
            questState.activeQuests.splice(questIndex, 1);
            
            // Update UI
            updateUI();
            renderAvailableQuests();
            renderHeroes();
            renderActiveQuests();
            
            // Save game state
            saveGameState();
            
            // Show message
            showToast(`${quest.title} has been cancelled. ${hero.name} has returned.`);
        }

        function completeQuest(questId) {
            const questIndex = questState.activeQuests.findIndex(q => q.id === questId);
            if (questIndex === -1) return;
            
            const quest = questState.activeQuests[questIndex];
            const hero = questState.heroes.find(h => h.currentQuest === questId);
            
            if (!hero) return;
            
            // Update quest status in available quests
            const availableQuest = questState.availableQuests.find(q => q.id === questId);
            if (availableQuest) {
                availableQuest.status = "available";
            }
            
            // Update hero status
            hero.status = "available";
            hero.currentQuest = null;
            hero.questEndTime = null;
            
            // Add rewards
            questState.gold += quest.rewards.gold;
            questState.materials += quest.rewards.materials;
            
            // Add to completed quests with timestamp
            questState.completedQuests.push({
                ...quest,
                completionTime: Date.now(),
                hero: hero.name
            });
            
            // Remove from active quests
            questState.activeQuests.splice(questIndex, 1);
            
            // Update UI
            updateUI();
            renderAvailableQuests();
            renderHeroes();
            renderActiveQuests();
            renderCompletedQuests();
            
            // Save game state
            saveGameState();
            
            // Show success message
            showToast(`${hero.name} has completed the ${quest.title} quest and earned ${quest.rewards.gold} gold and ${quest.rewards.materials} materials!`);
        }

        function startQuestTimer() {
            // Update quest timers every second
            setInterval(() => {
                let needsUpdate = false;
                
                // Check each active quest
                questState.activeQuests.forEach(quest => {
                    const hero = questState.heroes.find(h => h.currentQuest === quest.id);
                    if (!hero) return;
                    
                    const timeRemaining = hero.questEndTime - Date.now();
                    
                    // Update progress bar if visible
                    const progressBar = document.getElementById(`progress-${quest.id}`);
                    if (progressBar) {
                        const progressPercent = 100 - (timeRemaining / quest.duration * 100);
                        progressBar.style.width = `${progressPercent}%`;
                    }
                    
                    // Check if quest is complete
                    if (timeRemaining <= 0) {
                        completeQuest(quest.id);
                        needsUpdate = true;
                    }
                });
                
                if (needsUpdate) {
                    renderActiveQuests();
                    renderHeroes();
                }
            }, 1000);
        }

        function updateUI() {
            headerGold.textContent = questState.gold;
            headerMaterials.textContent = questState.materials;
        }

        function goBackToCastle() {
            // Save game state before navigating back
            saveGameState();
            
            // Navigate back to the castle page
            window.location.href = 'sanc2.html'; // Or your castle crafting page
        }

        function showToast(message, type = "success") {
            toastEl.textContent = message;
            toastEl.className = `toast show ${type}`;
            
            setTimeout(() => {
                toastEl.className = 'toast';
            }, 3000);
        }

        function formatDuration(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            
            if (minutes > 0) {
                return `${minutes}m ${remainingSeconds}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function formatTimeRemaining(milliseconds) {
            if (milliseconds <= 0) return "Complete!";
            
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>
