<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WIZARD'S TOWER ADVENTURE</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; font-family: 'Arial', monospace; }
body { background: #0a0a2a; color: #aaf; height: 100vh; overflow: hidden; display: flex; flex-direction: column; padding: 10px; }

#game-container { flex: 1; display: flex; flex-direction: column; gap: 10px; width: 100%; }

/* Stats */
.stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
.stat-group { display: flex; flex-direction: column; min-width: 100px; }
.bar { height: 5px; background: #1a1a3a; width: 100%; position: relative; overflow: hidden; }
.bar-fill { height: 100%; transition: width 0.3s; }
.health { background: #0f0; }
.mana { background: #0af; }

/* Content */
#content-area { flex: 1; display: flex; flex-direction: column; max-width: 600px; width: 100%; margin: 0 auto; gap: 5px; }
#scene-description { flex: 1; overflow-y: auto; border: 1px solid #aaf; padding: 8px; min-height: 150px; }
#combat-log { min-height: 80px; border: 1px solid #aaf; padding: 8px; display: none; }

/* Buttons */
.button-container { display: grid; gap: 5px; }
#footer-buttons { grid-template-columns: repeat(4, 1fr); margin-bottom: 70px; }
button { background: #0a0a2a; color: #aaf; border: 1px solid #aaf; padding: 8px; cursor: pointer; transition: all 0.2s; }
button:active { background: #aaf; color: #0a0a2a; }
button:disabled { opacity: 0.5; }
button:hover:not(:disabled) { background: #1a1a4a; }

/* Mobile Controls */
#mobile-controls { display: block; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,10,42,0.9); padding: 10px; border-top: 1px solid #aaf; z-index: 50; }
.mobile-control-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
.mobile-control-btn { flex: 1; margin: 0 2px; padding: 10px; font-size: 14px; }

/* Modals */
.modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10,10,42,0.9); padding: 10px; display: none; z-index: 100; overflow-y: auto; }
.modal-content { border: 1px solid #aaf; padding: 8px; height: 100%; display: flex; flex-direction: column; }
.modal-header { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #aaf; padding-bottom: 5px; }
.modal-body { flex: 1; overflow-y: auto; }
.close-modal { background: none; border: none; color: #aaf; cursor: pointer; }

/* Animations */
@keyframes shake { 0%,100% { transform: translateX(0); } 20%,60% { transform: translateX(-5px); } 40%,80% { transform: translateX(5px); } }
.shake { animation: shake 0.4s; }
@keyframes flash-blue { 0%,100% { background: #0a0a2a; } 50% { background: #0af; } }
.flash-blue { animation: flash-blue 0.3s; }
.critical { animation: critical 0.5s; }
@keyframes critical { 0%,100% { color: #aaf; } 50% { color: yellow; } }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
.poisoned { color: #f0a; animation: pulse 1s infinite; }
.burning { color: #f80; animation: pulse 0.5s infinite; }
.cursed { color: #a0a; animation: pulse 2s infinite; }
.protected { color: #0ff; animation: pulse 1.5s infinite; }
@keyframes float-up {
  0% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(-50px); opacity: 0; }
}
@keyframes victory-glow {
  0% { box-shadow: 0 0 20px #ff0; }
  100% { box-shadow: none; }
}
.victory { animation: victory-glow 2s ease-out; }

/* Merchant */
.merchant-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #aaf; }

/* Damage Numbers */
.damage-number {
  position: absolute;
  font-weight: bold;
  animation: float-up 1s forwards;
}

/* Enemy Weakness Display */
.weakness-display {
  margin: 5px 0;
  padding: 3px;
  border: 1px dashed #ff0;
  background: #1a1a4a;
}
.weakness-item {
  display: inline-block;
  margin: 2px;
  padding: 2px 5px;
  background: #1a1a3a;
  border: 1px solid #aaf;
}

/* Mobile */
@media (max-width: 768px) {
  #scene-description { min-height: 30vh; }
  button { padding: 6px 2px; font-size: 12px; }
  .stat-row { flex-direction: column; gap: 5px; }
  .mobile-control-btn { padding: 8px 4px; font-size: 12px; }
}

/* Character Selection */
.character-select {
  border: 1px solid #aaf;
  padding: 10px;
  margin: 10px 0;
  cursor: pointer;
  transition: all 0.3s;
}
.character-select:hover {
  background: #1a1a4a;
}
.character-select h2 {
  color: #aaf;
  margin-bottom: 5px;
}

/* Save slots */
.save-slot {
  border: 1px solid #aaf;
  padding: 10px;
  margin: 5px 0;
  cursor: pointer;
}
.save-slot:hover {
  background: #1a1a4a;
}
.save-slot.active {
  background: #1a1a4a;
  border-color: #aaf;
}

/* Visual improvements */
.location-indicator {
  text-align: center;
  font-weight: bold;
  padding: 5px;
  background: #151540;
  border: 1px solid #aaf;
  margin-bottom: 5px;
}

.health-low { 
  border: 2px solid #ff4444; 
  animation: pulse 1s infinite;
}
.mana-low {
  border: 2px solid #ff4444;
  filter: hue-rotate(300deg);
}

/* ========== ENHANCED VISUAL FEEDBACK STYLES ========== */
.floating-text {
  position: absolute;
  font-weight: bold;
  pointer-events: none;
  z-index: 1000;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
  font-size: 14px;
}

.xp-gain { color: #0ff; animation: float-xp 2s ease-out; }
.gold-gain { color: gold; animation: float-gold 2s ease-out; }
.heal-gain { color: #0f0; animation: float-heal 2s ease-out; }
.mana-gain { color: #87ceeb; animation: float-mana 2s ease-out; }
.damage-taken { color: #ff4444; animation: float-damage 2s ease-out; }
.item-found { color: #ffa500; animation: float-item 2s ease-out; }

@keyframes float-xp {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
}

@keyframes float-gold {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  100% { transform: translateY(-60px) scale(1.3); opacity: 0; }
}

@keyframes float-heal {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  50% { transform: translateY(-30px) scale(1.1); opacity: 1; }
  100% { transform: translateY(-60px) scale(1.2); opacity: 0; }
}

@keyframes float-mana {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  100% { transform: translateY(-40px) scale(1.1); opacity: 0; }
}

@keyframes float-damage {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  20% { transform: translateX(-5px) translateY(-10px) scale(1.1); }
  40% { transform: translateX(5px) translateY(-20px) scale(1.2); }
  100% { transform: translateY(-50px) scale(1.1); opacity: 0; }
}

@keyframes float-item {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  100% { transform: translateY(-45px) scale(1.2) rotate(5deg); opacity: 0; }
}

/* Skill Tree Styles */
.skill-tree-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin: 15px 0;
}

.skill-category {
  border: 1px solid #444;
  padding: 10px;
  border-radius: 4px;
}

.skill-category h3 {
  text-align: center;
  margin-bottom: 10px;
  color: #aaf;
  border-bottom: 1px dashed #aaf;
  padding-bottom: 5px;
}

.skill-node {
  border: 1px solid #444;
  padding: 8px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s;
  background: #111;
  position: relative;
  margin-bottom: 8px;
}

.skill-node.available {
  border-color: #666;
  background: #222;
}

.skill-node.available:hover {
  border-color: gold;
  background: #333;
  transform: translateY(-2px);
}

.skill-node.unlocked {
  border-color: #00ff00;
  background: #1a2a1a;
  box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
}

.skill-node.locked {
  border-color: #444;
  background: #1a1a1a;
  opacity: 0.6;
  cursor: not-allowed;
}

.skill-node.requires {
  border-left: 3px solid gold;
}

.skill-cost {
  position: absolute;
  top: 5px;
  right: 5px;
  color: gold;
  font-size: 0.8em;
  background: rgba(0,0,0,0.7);
  padding: 2px 5px;
  border-radius: 3px;
}

.skill-description {
  font-size: 0.8em;
  color: #ccc;
  margin-top: 5px;
}

/* Interactive Map Styles */
#interactive-map {
  width: 100%;
  height: 400px;
  background: #0a0a1a;
  position: relative;
  border: 1px solid #aaf;
  overflow: hidden;
}

.map-location {
  position: absolute;
  width: 80px;
  height: 60px;
  border: 2px solid #333;
  background: #1a1a2a;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  font-size: 10px;
  cursor: pointer;
  transition: all 0.3s;
  padding: 5px;
}

.map-location.visited {
  border-color: #666;
  background: #2a2a3a;
}

.map-location.current {
  border-color: #aaf;
  background: #2a2a4a;
  box-shadow: 0 0 15px #aaf;
  z-index: 10;
  transform: scale(1.1);
}

.map-location.hidden {
  border-color: #444;
  background: #1a1a2a;
  opacity: 0.4;
}

.map-location.discovered {
  border-color: #ffa500;
  background: #2a2a3a;
}

.map-location.accessible {
  border-color: #00ff00;
  background: #1a2a2a;
  cursor: pointer;
}

.map-location.accessible:hover {
  border-color: #ffff00;
  background: #2a3a2a;
  transform: scale(1.15);
  box-shadow: 0 0 10px #ffff00;
}

.map-connection {
  position: absolute;
  background: #444;
  transform-origin: 0 0;
  z-index: -1;
  height: 2px;
}

.map-tooltip {
  position: absolute;
  background: rgba(10,10,42,0.95);
  border: 1px solid #aaf;
  padding: 8px;
  z-index: 100;
  pointer-events: none;
  font-size: 12px;
  max-width: 200px;
  box-shadow: 0 0 10px rgba(170,170,255,0.5);
}

.map-legend {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  margin-top: 10px;
  justify-content: center;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
}

.legend-color {
  width: 12px;
  height: 12px;
  border: 1px solid #fff;
}

/* Enhanced Button Feedback */
.button-pulse {
  animation: buttonPulse 0.3s ease-out;
}

@keyframes buttonPulse {
  0% { transform: scale(1); }
  50% { transform: scale(0.95); }
  100% { transform: scale(1); }
}

/* Achievement Popups */
.achievement-popup {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(45deg, #1a1a2a, #2a1a3a);
  border: 2px solid gold;
  padding: 15px;
  border-radius: 8px;
  z-index: 1000;
  animation: slideInRight 0.5s ease-out, slideOutRight 0.5s ease-out 2.5s forwards;
  max-width: 300px;
}

@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOutRight {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

.achievement-icon {
  font-size: 24px;
  margin-right: 10px;
  color: gold;
}

/* Sound Controls */
.sound-controls {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 1000;
  background: rgba(10,10,42,0.8);
  padding: 5px;
  border-radius: 4px;
  border: 1px solid #aaf;
}

.sound-toggle {
  background: #0a0a2a;
  border: 1px solid #aaf;
  color: #aaf;
  padding: 5px 10px;
  cursor: pointer;
  border-radius: 4px;
  font-size: 12px;
}

.sound-toggle:hover {
  background: #1a1a4a;
}

/* Enhanced Combat Animations */
.combat-float {
  animation: combatFloat 0.6s ease-out;
}

@keyframes combatFloat {
  0% { transform: translateY(0) scale(1); }
  50% { transform: translateY(-20px) scale(1.1); }
  100% { transform: translateY(-40px) scale(1); opacity: 0; }
}

/* Skill Points Display */
.skill-points-display {
  background: linear-gradient(45deg, #1a1a3a, #2a1a4a);
  border: 1px solid #0ff;
  padding: 5px 10px;
  border-radius: 4px;
  margin-left: 10px;
  font-weight: bold;
  color: #0ff;
}

/* Progress Indicators */
.level-badge {
  background: linear-gradient(45deg, #8B4513, #CD7F32);
  border-radius: 50%;
  width: 25px;
  height: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  border: 2px solid gold;
  font-size: 12px;
  margin-left: 5px;
}

/* Back Button Styles */
.back-button {
  background: #0a0a2a;
  color: #aaf;
  border: 1px solid #aaf;
  padding: 8px 15px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: bold;
  margin-top: 10px;
  width: 100%;
}

.back-button:hover {
  background: #1a1a4a;
}

.back-button:active {
  background: #aaf;
  color: #0a0a2a;
}
</style>
</head>
<body>
<!-- Sound Controls -->
<div class="sound-controls">
  <button id="sound-toggle" class="sound-toggle">ðŸ”Š SOUND: ON</button>
</div>

<div id="game-container">
  <!-- Character Selection -->
  <div id="character-selection">
    <h1 style="text-align: center">WIZARD'S TOWER ADVENTURE</h1>
    <p>The ancient Wizard's Tower stands tall against the sky, filled with magical creatures, powerful artifacts, and dangerous spells.</p>
    <p style="text-align: center">CHOOSE YOUR WIZARD:</p>
    
    <div class="character-select" id="select-elementalist">
      <h2>ELEMENTALIST</h2>
      <p><strong>Focus:</strong> Elemental Magic | <strong>HP:</strong> 80 | <strong>MANA:</strong> 120</p>
      <p><strong>Skills:</strong> Fireball (damage + burn), Ice Shard (damage + slow)</p>
      <p><strong>Unlocks at Lvl 5:</strong> Chain Lightning (hits multiple enemies)</p>
      <p><strong>Unlocks at Lvl 10:</strong> Meteor Shower (massive area damage)</p>
    </div>
    
    <div class="character-select" id="select-illusionist">
      <h2>ILLUSIONIST</h2>
      <p><strong>Focus:</strong> Mind Magic | <strong>HP:</strong> 70 | <strong>MANA:</strong> 130</p>
      <p><strong>Skills:</strong> Confusion (chance to skip enemy turn), Mirror Image (dodge chance)</p>
      <p><strong>Unlocks at Lvl 5:</strong> Mass Confusion (affects all enemies)</p>
      <p><strong>Unlocks at Lvl 10:</strong> Phantasmal Army (summon illusions to fight)</p>
    </div>
    
    <div class="character-select" id="select-necromancer">
      <h2>NECROMANCER</h2>
      <p><strong>Focus:</strong> Death Magic | <strong>HP:</strong> 90 | <strong>MANA:</strong> 110</p>
      <p><strong>Skills:</strong> Life Drain (damage + heal), Animate Dead (summon skeleton)</p>
      <p><strong>Unlocks at Lvl 5:</strong> Death Curse (damage over time)</p>
      <p><strong>Unlocks at Lvl 10:</strong> Army of the Dead (summon multiple undead)</p>
    </div>

    <div class="character-select" id="select-archmage">
      <h2>ARCHMAGE</h2>
      <p><strong>Focus:</strong> Arcane Magic | <strong>HP:</strong> 75 | <strong>MANA:</strong> 125</p>
      <p><strong>Skills:</strong> Arcane Missile (guaranteed hit), Mana Shield (convert mana to HP)</p>
      <p><strong>Unlocks at Lvl 5:</strong> Time Warp (extra turn)</p>
      <p><strong>Unlocks at Lvl 10:</strong> Disintegrate (massive single target damage)</p>
    </div>
    
    <div style="margin-top: 10px">
      <label>DIFFICULTY:</label>
      <select id="difficulty" style="background: #0a0a2a; color: #aaf; border: 1px solid #aaf; padding: 5px;">
        <option value="easy">Easy</option>
        <option value="normal" selected>Normal</option>
        <option value="hard">Hard</option>
        <option value="nightmare">Nightmare</option>
      </select>
    </div>
    
    <div style="display: flex; gap: 5px; margin-top: 10px;">
      <button id="load-button" style="display: none;">LOAD GAME</button>
      <button id="save-button" style="display: none;">SAVE GAME</button>
      <button id="new-game-plus-button" style="display: none;">NEW GAME+</button>
      <button id="settings-button">SETTINGS</button>
    </div>
  </div>

  <!-- Main Game -->
  <div id="main-game" style="display: none; height: 100%;">
    <div id="content-area">
      <!-- Stats -->
      <div class="stat-row">
        <div class="stat-group">
          <div>HP: <span id="current-hp">100</span>/<span id="max-hp">100</span></div>
          <div class="bar"><div id="player-health-fill" class="bar-fill health" style="width: 100%;"></div></div>
        </div>
        <div class="stat-group">
          <div>MANA: <span id="current-mana">100</span>/<span id="max-mana">100</span></div>
          <div class="bar"><div id="player-mana-fill" class="bar-fill mana" style="width: 100%;"></div></div>
        </div>
        <div class="stat-group">
          <div>LVL: <span id="player-level">1</span><span id="level-badge" class="level-badge">1</span></div>
          <div>SKILL: <span id="skill-points">0</span></div>
        </div>
      </div>
      
      <div class="stat-row">
        <div class="stat-group"><div>GOLD: <span id="player-gold">50</span></div></div>
        <div class="stat-group"><div>FLOOR: <span id="game-floor">1</span></div></div>
        <div class="stat-group"><div>LOC: <span id="dungeon-level">ENTRANCE</span></div></div>
      </div>

      <!-- Location -->
      <div class="location-indicator">
        <div id="location-name">TOWER ENTRANCE</div>
        <div class="bar"><div id="level-progress" class="bar-fill health" style="width: 0%;"></div></div>
      </div>

      <!-- Scene -->
      <div id="scene-description">
        <p>You stand before the ancient Wizard's Tower. The air hums with magical energy. An old wizard greets you at the entrance.</p>
        <p>"Be careful, young mage," he warns. "The tower holds many dangers, but also great power for those who can conquer it."</p>
      </div>

      <div id="combat-log"></div>

      <!-- Weapon -->
      <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed #aaf;">
        <span>STAFF:</span>
        <span id="equipped-weapon-name">BASIC STAFF</span> (<span id="equipped-weapon-dmg">3</span> DMG)
      </div>

      <!-- Status Effects -->
      <div id="status-effects" style="min-height: 20px;"></div>

      <!-- Footer -->
      <div id="footer-buttons" class="button-container" style="display: none;">
        <!-- This is now hidden as we're using mobile controls for all devices -->
      </div>
    </div>
  </div>

  <!-- Mobile Controls (Now used for all devices) -->
  <div id="mobile-controls">
    <div class="mobile-control-row">
      <button class="mobile-control-btn" id="mobile-explore">EXPLORE</button>
      <button class="mobile-control-btn" id="mobile-action">TALK</button>
      <button class="mobile-control-btn" id="mobile-merchant">MERCHANT</button>
      <button class="mobile-control-btn" id="mobile-rest">REST</button>
    </div>
    <div class="mobile-control-row">
      <button class="mobile-control-btn" id="mobile-inventory">INV</button>
      <button class="mobile-control-btn" id="mobile-quests">QUESTS</button>
      <button class="mobile-control-btn" id="mobile-character">STATS</button>
      <button class="mobile-control-btn" id="mobile-skills">SKILLS</button>
      <button class="mobile-control-btn" id="mobile-map">MAP</button>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="inventory-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>INVENTORY</h2>
      <button id="close-inventory" class="close-modal">X</button>
    </div>
    <div class="modal-body">
      <h3>STAVES</h3>
      <div id="weapons-list"></div>
      <h3 style="margin-top: 10px;">ITEMS</h3>
      <div id="items-list"></div>
      <button class="back-button" id="back-from-inventory">BACK TO GAME</button>
    </div>
  </div>
</div>

<!-- Merchant Modal -->
<div id="merchant-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>MERCHANT</h2>
      <button id="close-merchant" class="close-modal">X</button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom: 10px;">GOLD: <span id="merchant-gold-amount">0</span></div>
      
      <h3>BUY ITEMS</h3>
      <div id="merchant-buy-list"></div>
      
      <h3 style="margin-top: 10px;">SELL ITEMS</h3>
      <div id="merchant-sell-list"></div>
      <button class="back-button" id="back-from-merchant">BACK TO GAME</button>
    </div>
  </div>
</div>

<!-- Character Stats Modal -->
<div id="character-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="character-name">CHARACTER</h2>
      <button id="close-character" class="close-modal">X</button>
    </div>
    <div class="modal-body">
      <div class="stat-row">
        <span>CLASS:</span>
        <span id="character-class">CLASS</span>
      </div>
      <div class="stat-row">
        <span>LEVEL:</span>
        <span id="character-level">1</span>
      </div>
      
      <h3 style="margin-top: 10px;">ATTRIBUTES</h3>
      <div class="stat-row">
        <span>INTELLIGENCE:</span>
        <span id="character-intelligence">5</span>
      </div>
      <div class="stat-row">
        <span>WISDOM:</span>
        <span id="character-wisdom">5</span>
      </div>
      <div class="stat-row">
        <span>ARCANE POWER:</span>
        <span id="character-arcane">5</span>
      </div>
      
      <h3 style="margin-top: 10px;">SPELLS</h3>
      <div id="character-skills"></div>

      <h3 style="margin-top: 10px;">STATUS EFFECTS</h3>
      <div id="character-status-effects"></div>
      <button class="back-button" id="back-from-character">BACK TO GAME</button>
    </div>
  </div>
</div>

<!-- Skills Modal -->
<div id="skills-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>SPELL BOOK</h2>
      <button id="close-skills" class="close-modal">X</button>
    </div>
    <div class="modal-body">
      <div style="display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center;">
        <div>Skill Points: <span id="skill-points-display" class="skill-points-display">0</span></div>
        <div>Level: <span id="skills-level">1</span></div>
      </div>
      
      <div class="skill-tree-container" id="skill-tree-container">
        <!-- Skills will be populated by JavaScript -->
      </div>
      <button class="back-button" id="back-from-skills">BACK TO GAME</button>
    </div>
  </div>
</div>

<!-- Interactive Map Modal -->
<div id="interactive-map-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>TOWER MAP</h2>
      <button id="close-map" class="close-modal">X</button>
    </div>
    <div class="modal-body">
      <div id="interactive-map">
        <!-- Map will be generated by JavaScript -->
      </div>
      <div class="map-legend">
        <div class="legend-item">
          <div class="legend-color" style="background: #aaf;"></div>
          <span>Current Location</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #00ff00;"></div>
          <span>Accessible</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #666;"></div>
          <span>Visited</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #ffa500;"></div>
          <span>Discovered</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #444;"></div>
          <span>Undiscovered</span>
        </div>
      </div>
      <button class="back-button" id="back-from-map">BACK TO GAME</button>
    </div>
  </div>
</div>

<!-- Quests Modal -->
<div id="quests-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>QUESTS</h2>
      <button id="close-quests" class="close-modal">X</button>
    </div>
    <div class="modal-body">
      <h3>ACTIVE QUESTS</h3>
      <div id="active-quests"></div>
      
      <h3 style="margin-top: 10px;">COMPLETED QUESTS</h3>
      <div id="completed-quests"></div>

      <h3 style="margin-top: 10px;">SIDE QUESTS</h3>
      <div id="side-quests"></div>
      <button class="back-button" id="back-from-quests">BACK TO GAME</button>
    </div>
  </div>
</div>

<!-- Save/Load Modal -->
<div id="save-load-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>SAVE & LOAD GAME</h2>
      <button id="close-save-load" class="close-modal">X</button>
    </div>
    <div class="modal-body">
      <h3>SAVE GAME</h3>
      <div style="margin-bottom: 10px;">
        <input type="text" id="save-name" placeholder="Save name" style="background: #0a0a2a; color: #aaf; border: 1px solid #aaf; padding: 5px; width: 100%;">
        <button id="save-game-btn" style="width: 100%; margin-top: 5px;">SAVE CURRENT GAME</button>
      </div>
      
      <h3 style="margin-top: 10px;">LOAD GAME</h3>
      <div id="save-slots"></div>
      <button class="back-button" id="back-from-save-load">BACK TO GAME</button>
    </div>
  </div>
</div>

<!-- Combat Modal -->
<div id="combat-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="combat-title">COMBAT</h2>
    </div>
    <div class="modal-body">
      <div id="enemy-display" style="border: 1px solid #aaf; padding: 8px; margin-bottom: 5px; position: relative;">
        <h3 id="enemy-name">ENEMY</h3>
        <div>HP: <span id="enemy-hp">30</span>/<span id="enemy-max-hp">30</span></div>
        <div class="bar"><div id="enemy-hp-bar" class="bar-fill health" style="width: 100%;"></div></div>
        <!-- Enemy Weakness Display -->
        <div id="enemy-weakness-display" style="display: none;" class="weakness-display">
          <strong>Weaknesses:</strong> <span id="enemy-weakness-list"></span>
        </div>
        <div id="enemy-status-effects"></div>
      </div>

      <div id="player-display" style="border: 1px solid #aaf; padding: 8px; margin-bottom: 5px;">
        <h3 id="player-name">PLAYER</h3>
        <div>HP: <span id="player-hp-combat">100</span>/<span id="player-max-hp-combat">100</span></div>
        <div class="bar"><div id="player-hp-bar" class="bar-fill health" style="width: 100%;"></div></div>
        <div>MANA: <span id="player-mana-combat">100</span>/<span id="player-max-mana-combat">100</span></div>
        <div class="bar"><div id="player-mana-bar" class="bar-fill mana" style="width: 100%;"></div></div>
        <div id="player-combat-status-effects"></div>
      </div>

      <div id="combat-log-modal" style="min-height: 80px; border: 1px solid #aaf; padding: 8px;"></div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px;">
        <button id="attack-button">ATTACK</button>
        <button id="special-button">SPELL</button>
        <button id="use-item-button">ITEM</button>
        <button id="flee-button">FLEE</button>
      </div>
    </div>
  </div>
</div>

<!-- Game Over Modal -->
<div id="game-over-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 style="text-align: center">GAME OVER</h2>
    </div>
    <div class="modal-body" style="text-align: center;">
      <p id="game-over-text">You have been defeated!</p>
      <p>The magical energies overwhelm you...</p>
      <button id="try-again-button">TRY AGAIN</button>
      <button id="main-menu-button">MAIN MENU</button>
    </div>
  </div>
</div>

<!-- New Game Plus Modal -->
<div id="new-game-plus-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 style="text-align: center">NEW GAME+</h2>
    </div>
    <div class="modal-body" style="text-align: center;">
      <p>Congratulations on conquering the Wizard's Tower!</p>
      <p>Start a new game with increased difficulty but keep your:</p>
      <ul style="text-align: left; margin: 10px 0;">
        <li>Level and stats</li>
        <li>Inventory (except key items)</li>
        <li>Gold</li>
        <li>Unlocked abilities</li>
      </ul>
      <p>Enemies will be stronger and smarter!</p>
      <button id="start-new-game-plus">BEGIN NEW GAME+</button>
      <button id="regular-new-game">START NORMAL GAME</button>
    </div>
  </div>
</div>

<script>
// Game State
const game = {
  player: null,
  currentEnemy: null,
  inCombat: false,
  location: 0, // 0=entrance, 1=first floor, etc.
  floor: 1,
  difficulty: 'normal',
  statusEffects: [],
  enemyStatusEffects: [],
  saveSlots: [],
  visitedLocations: [0],
  
  // Game Data
  locations: [
    { name: "ENTRANCE", desc: "You stand before the ancient Wizard's Tower. The air hums with magical energy.", enemies: [] },
    { name: "FIRST FLOOR", desc: "The first floor is filled with magical energy. Strange runes glow on the walls.", enemies: ["goblin", "imp", "animated-armor"] },
    { name: "LIBRARY", desc: "Ancient tomes line the walls. Dust motes dance in magical light.", enemies: ["book-wyrm", "arcane-eye", "animated-tome"] },
    { name: "ALCHEMY LAB", desc: "Bubbling potions and strange apparatus fill this room.", enemies: ["homunculus", "ooze", "potion-golem"] },
    { name: "OBSERVATORY", desc: "The ceiling shows a starry sky, though it's daytime outside.", enemies: ["star-spawn", "void-walker", "cosmic-horror"] },
    { name: "THRONE ROOM", desc: "The final chamber where the Archmage awaits.", enemies: ["archmage"] },
    { name: "SECRET LAB", desc: "A hidden laboratory filled with forbidden experiments.", enemies: ["chimera", "flesh-golem"], hidden: true },
    { name: "CRYSTAL CAVE", desc: "A cave of glowing crystals deep beneath the tower.", enemies: ["crystal-golem", "shard-beast"], hidden: true },
    { name: "SPIRIT REALM", desc: "A plane of existence where spirits dwell.", enemies: ["ghost", "wraith", "specter"], hidden: true }
  ],
  
  characters: {
    elementalist: { 
      name: "ELEMENTALIST", 
      class: "Elemental Mage",
      hp: 80, maxHp: 80, 
      mana: 120, maxMana: 120,
      intelligence: 8, wisdom: 5, arcane: 7,
      skills: ["FIREBALL", "ICE SHARD"], 
      perks: ["+20% fire damage", "Chance to freeze enemies"],
      inventory: ["basic-staff"],
      unlockedAbilities: [],
      learnedSkills: []
    },
    illusionist: { 
      name: "ILLUSIONIST", 
      class: "Mind Mage",
      hp: 70, maxHp: 70, 
      mana: 130, maxMana: 130,
      intelligence: 7, wisdom: 8, arcane: 5,
      skills: ["CONFUSION", "MIRROR IMAGE"], 
      perks: ["+25% dodge chance", "Chance to confuse enemies"],
      inventory: ["basic-staff"],
      unlockedAbilities: [],
      learnedSkills: []
    },
    necromancer: { 
      name: "NECROMANCER", 
      class: "Death Mage",
      hp: 90, maxHp: 90, 
      mana: 110, maxMana: 110,
      intelligence: 6, wisdom: 7, arcane: 7,
      skills: ["LIFE DRAIN", "ANIMATE DEAD"], 
      perks: ["Drain life from enemies", "Summon skeleton allies"],
      inventory: ["basic-staff"],
      unlockedAbilities: [],
      learnedSkills: []
    },
    archmage: {
      name: "ARCHMAGE",
      class: "Arcane Mage",
      hp: 75, maxHp: 75,
      mana: 125, maxMana: 125,
      intelligence: 9, wisdom: 6, arcane: 5,
      skills: ["ARCANE MISSILE", "MANA SHIELD"],
      perks: ["Guaranteed hit spells", "Convert mana to health"],
      inventory: ["basic-staff"],
      unlockedAbilities: [],
      learnedSkills: []
    }
  },
  
  enemies: {
    "goblin": { name: "GOBLIN", hp: 25, maxHp: 25, damage: 4, xp: 20, gold: 10, weakness: ["fire"] },
    "imp": { name: "IMP", hp: 20, maxHp: 20, damage: 6, xp: 25, gold: 15, weakness: ["holy"] },
    "animated-armor": { name: "ANIMATED ARMOR", hp: 40, maxHp: 40, damage: 8, xp: 35, gold: 20, weakness: ["lightning"] },
    "book-wyrm": { name: "BOOK WYRM", hp: 35, maxHp: 35, damage: 7, xp: 30, gold: 25, weakness: ["fire"] },
    "arcane-eye": { name: "ARCANE EYE", hp: 30, maxHp: 30, damage: 9, xp: 40, gold: 30, weakness: ["physical"] },
    "animated-tome": { name: "ANIMATED TOME", hp: 25, maxHp: 25, damage: 5, xp: 25, gold: 15, weakness: ["water"] },
    "homunculus": { name: "HOMUNCULUS", hp: 45, maxHp: 45, damage: 8, xp: 45, gold: 35, weakness: ["fire"] },
    "ooze": { name: "OOZE", hp: 50, maxHp: 50, damage: 6, xp: 40, gold: 25, weakness: ["ice"] },
    "potion-golem": { name: "POTION GOLEM", hp: 60, maxHp: 60, damage: 10, xp: 55, gold: 40, weakness: ["lightning"] },
    "star-spawn": { name: "STAR SPAWN", hp: 55, maxHp: 55, damage: 12, xp: 60, gold: 45, weakness: ["dark"] },
    "void-walker": { name: "VOID WALKER", hp: 65, maxHp: 65, damage: 14, xp: 70, gold: 50, weakness: ["light"] },
    "cosmic-horror": { name: "COSMIC HORROR", hp: 80, maxHp: 80, damage: 16, xp: 85, gold: 60, weakness: ["holy"] },
    "archmage": { name: "ARCHMAGE", hp: 120, maxHp: 120, damage: 18, xp: 200, gold: 100, weakness: ["arcane"] },
    "chimera": { name: "CHIMERA", hp: 90, maxHp: 90, damage: 15, xp: 100, gold: 70, weakness: ["all"] },
    "flesh-golem": { name: "FLESH GOLEM", hp: 110, maxHp: 110, damage: 14, xp: 95, gold: 65, weakness: ["fire"] },
    "crystal-golem": { name: "CRYSTAL GOLEM", hp: 85, maxHp: 85, damage: 13, xp: 80, gold: 55, weakness: ["physical"] },
    "shard-beast": { name: "SHARD BEAST", hp: 70, maxHp: 70, damage: 11, xp: 65, gold: 45, weakness: ["lightning"] },
    "ghost": { name: "GHOST", hp: 40, maxHp: 40, damage: 9, xp: 50, gold: 30, weakness: ["holy"] },
    "wraith": { name: "WRAITH", hp: 55, maxHp: 55, damage: 12, xp: 70, gold: 45, weakness: ["light"] },
    "specter": { name: "SPECTER", hp: 65, maxHp: 65, damage: 14, xp: 85, gold: 55, weakness: ["holy"] }
  },
  
  items: {
    "basic-staff": { name: "BASIC STAFF", damage: 3 },
    "fire-staff": { name: "FIRE STAFF", damage: 8, special: "fire" },
    "ice-staff": { name: "ICE STAFF", damage: 7, special: "ice" },
    "lightning-staff": { name: "LIGHTNING STAFF", damage: 9, special: "lightning" },
    "health-potion": { name: "HEALTH POTION", heal: 20 },
    "mana-potion": { name: "MANA POTION", mana: 30 },
    "elixir": { name: "ELIXIR", heal: 40, mana: 40 },
    "scroll-fireball": { name: "FIREBALL SCROLL", damage: 25, special: "fire", consumable: true },
    "scroll-ice": { name: "ICE STORM SCROLL", damage: 20, special: "ice", consumable: true },
    "scroll-lightning": { name: "LIGHTNING BOLT SCROLL", damage: 30, special: "lightning", consumable: true }
  },
  
  merchantItems: [
    { id: "health-potion", name: "HEALTH POTION", price: 15, heal: 20 },
    { id: "mana-potion", name: "MANA POTION", price: 20, mana: 30 },
    { id: "elixir", name: "ELIXIR", price: 40, heal: 40, mana: 40 },
    { id: "fire-staff", name: "FIRE STAFF", price: 50, damage: 8, special: "fire" },
    { id: "ice-staff", name: "ICE STAFF", price: 45, damage: 7, special: "ice" },
    { id: "lightning-staff", name: "LIGHTNING STAFF", price: 55, damage: 9, special: "lightning" },
    { id: "scroll-fireball", name: "FIREBALL SCROLL", price: 30, damage: 25, special: "fire", consumable: true },
    { id: "scroll-ice", name: "ICE STORM SCROLL", price: 25, damage: 20, special: "ice", consumable: true },
    { id: "scroll-lightning", name: "LIGHTNING BOLT SCROLL", price: 35, damage: 30, special: "lightning", consumable: true }
  ],
  
  quests: {
    active: [
      { id: "defeat-archmage", title: "DEFEAT THE ARCHMAGE", description: "Confront and defeat the Archmage at the top of the tower.", completed: false },
      { id: "find-fire-staff", title: "FIND A FIRE STAFF", description: "Obtain a fire staff to enhance your magical abilities.", completed: false }
    ],
    completed: [],
    side: [
      { id: "explore-library", title: "EXPLORE THE LIBRARY", description: "Discover the secrets hidden in the tower's library.", completed: false, reward: "scroll-fireball" },
      { id: "clear-alchemy-lab", title: "CLEAR THE ALCHEMY LAB", description: "Defeat the creatures in the alchemy lab.", completed: false, reward: "elixir" },
      { id: "find-secret-lab", title: "FIND THE SECRET LAB", description: "Discover the hidden laboratory in the tower.", completed: false, reward: "lightning-staff", hidden: true },
      { id: "explore-crystal-cave", title: "EXPLORE THE CRYSTAL CAVE", description: "Journey to the crystal cave beneath the tower.", completed: false, reward: "mana-potion", hidden: true },
      { id: "visit-spirit-realm", title: "VISIT THE SPIRIT REALM", description: "Find the portal to the spirit realm.", completed: false, reward: "elixir", hidden: true }
    ]
  },
  
  statusEffectTypes: {
    "burning": { name: "BURNING", duration: 3, damage: 3, class: "burning" },
    "frozen": { name: "FROZEN", duration: 1, skipTurn: true, class: "protected" },
    "confused": { name: "CONFUSED", duration: 2, damageReduction: 0.5, class: "cursed" },
    "drained": { name: "MANA DRAINED", duration: 3, manaLoss: 5, class: "cursed" },
    "shielded": { name: "SHIELDED", duration: 2, damageReduction: 0.3, class: "protected" },
    "empowered": { name: "EMPOWERED", duration: 3, damageBonus: 0.2, class: "protected" }
  },
  
  // Skill trees for each character class
  skillTrees: {
    elementalist: {
      "fire-mastery": {
        name: "Fire Mastery",
        skills: [
          { id: "fireball-upgrade", name: "Enhanced Fireball", cost: 1, description: "Fireball deals 25% more damage", requires: [], effect: "fireball-damage" },
          { id: "burning-intensity", name: "Burning Intensity", cost: 1, description: "Burning status deals 50% more damage", requires: ["fireball-upgrade"], effect: "burning-damage" },
          { id: "fire-nova", name: "Fire Nova", cost: 2, description: "Unleash a nova of fire that hits all enemies", requires: ["burning-intensity"], effect: "fire-nova" }
        ]
      },
      "ice-mastery": {
        name: "Ice Mastery",
        skills: [
          { id: "ice-shard-upgrade", name: "Enhanced Ice Shard", cost: 1, description: "Ice Shard has 25% higher freeze chance", requires: [], effect: "ice-freeze" },
          { id: "frozen-ground", name: "Frozen Ground", cost: 1, description: "Chance to freeze all enemies when casting ice spells", requires: ["ice-shard-upgrade"], effect: "frozen-ground" },
          { id: "blizzard", name: "Blizzard", cost: 2, description: "Summon a blizzard that damages all enemies for 3 turns", requires: ["frozen-ground"], effect: "blizzard" }
        ]
      },
      "lightning-mastery": {
        name: "Lightning Mastery",
        skills: [
          { id: "chain-lightning", name: "Chain Lightning", cost: 2, description: "Lightning jumps to 2 additional enemies", requires: [], effect: "chain-lightning" },
          { id: "static-charge", name: "Static Charge", cost: 1, description: "Chance to stun enemies with lightning attacks", requires: ["chain-lightning"], effect: "static-charge" },
          { id: "storm-call", name: "Storm Call", cost: 3, description: "Summon a storm that strikes random enemies for 5 turns", requires: ["static-charge"], effect: "storm-call" }
        ]
      }
    },
    illusionist: {
      "illusion-mastery": {
        name: "Illusion Mastery",
        skills: [
          { id: "confusion-upgrade", name: "Enhanced Confusion", cost: 1, description: "Confusion lasts 1 additional turn", requires: [], effect: "confusion-duration" },
          { id: "mirror-image-upgrade", name: "Enhanced Mirror Image", cost: 1, description: "Mirror Image provides 50% dodge chance", requires: [], effect: "mirror-image-dodge" },
          { id: "mass-confusion", name: "Mass Confusion", cost: 2, description: "Confusion affects all enemies", requires: ["confusion-upgrade"], effect: "mass-confusion" }
        ]
      },
      "mind-control": {
        name: "Mind Control",
        skills: [
          { id: "mental-domination", name: "Mental Domination", cost: 2, description: "Chance to temporarily turn an enemy to your side", requires: [], effect: "mental-domination" },
          { id: "psychic-scream", name: "Psychic Scream", cost: 1, description: "AOE damage that scales with intelligence", requires: ["mental-domination"], effect: "psychic-scream" },
          { id: "mind-break", name: "Mind Break", cost: 3, description: "Instantly defeat an enemy with low health", requires: ["psychic-scream"], effect: "mind-break" }
        ]
      },
      "phantasm-mastery": {
        name: "Phantasm Mastery",
        skills: [
          { id: "phantom-warrior", name: "Phantom Warrior", cost: 2, description: "Summon a phantom warrior to fight for you", requires: [], effect: "phantom-warrior" },
          { id: "ethereal-form", name: "Ethereal Form", cost: 1, description: "Become ethereal, avoiding all physical damage for 2 turns", requires: ["phantom-warrior"], effect: "ethereal-form" },
          { id: "phantasmal-army", name: "Phantasmal Army", cost: 3, description: "Summon multiple phantoms to overwhelm your enemies", requires: ["ethereal-form"], effect: "phantasmal-army" }
        ]
      }
    },
    necromancer: {
      "death-mastery": {
        name: "Death Mastery",
        skills: [
          { id: "life-drain-upgrade", name: "Enhanced Life Drain", cost: 1, description: "Life Drain heals for 75% of damage dealt", requires: [], effect: "life-drain-heal" },
          { id: "animate-dead-upgrade", name: "Enhanced Animate Dead", cost: 1, description: "Summoned skeletons are 50% stronger", requires: [], effect: "skeleton-strength" },
          { id: "death-curse", name: "Death Curse", cost: 2, description: "Curse an enemy to take damage over time", requires: ["life-drain-upgrade"], effect: "death-curse" }
        ]
      },
      "summoning-mastery": {
        name: "Summoning Mastery",
        skills: [
          { id: "skeleton-archer", name: "Skeleton Archer", cost: 1, description: "Summon a skeleton archer that attacks from range", requires: [], effect: "skeleton-archer" },
          { id: "bone-shield", name: "Bone Shield", cost: 1, description: "Create a shield of bones that absorbs damage", requires: ["skeleton-archer"], effect: "bone-shield" },
          { id: "army-of-the-dead", name: "Army of the Dead", cost: 3, description: "Summon multiple undead minions to fight for you", requires: ["bone-shield"], effect: "army-of-the-dead" }
        ]
      },
      "curse-mastery": {
        name: "Curse Mastery",
        skills: [
          { id: "weakness-curse", name: "Weakness Curse", cost: 1, description: "Curse an enemy to deal 25% less damage", requires: [], effect: "weakness-curse" },
          { id: "decay-curse", name: "Decay Curse", cost: 1, description: "Curse an enemy to lose HP and mana each turn", requires: ["weakness-curse"], effect: "decay-curse" },
          { id: "soul-drain", name: "Soul Drain", cost: 2, description: "Drain the soul of a defeated enemy to restore HP and mana", requires: ["decay-curse"], effect: "soul-drain" }
        ]
      }
    },
    archmage: {
      "arcane-mastery": {
        name: "Arcane Mastery",
        skills: [
          { id: "arcane-missile-upgrade", name: "Enhanced Arcane Missile", cost: 1, description: "Arcane Missile fires 3 missiles instead of 1", requires: [], effect: "arcane-missile-count" },
          { id: "mana-shield-upgrade", name: "Enhanced Mana Shield", cost: 1, description: "Mana Shield absorbs 50% more damage", requires: [], effect: "mana-shield-absorb" },
          { id: "arcane-explosion", name: "Arcane Explosion", cost: 2, description: "AOE damage that scales with arcane power", requires: ["arcane-missile-upgrade"], effect: "arcane-explosion" }
        ]
      },
      "time-mastery": {
        name: "Time Mastery",
        skills: [
          { id: "time-warp", name: "Time Warp", cost: 2, description: "Gain an extra turn once per combat", requires: [], effect: "time-warp" },
          { id: "temporal-shield", name: "Temporal Shield", cost: 1, description: "Shield that rewinds time to avoid damage", requires: ["time-warp"], effect: "temporal-shield" },
          { id: "time-stop", name: "Time Stop", cost: 3, description: "Freeze time for all enemies for 1 turn", requires: ["temporal-shield"], effect: "time-stop" }
        ]
      },
      "disintegration-mastery": {
        name: "Disintegration Mastery",
        skills: [
          { id: "disintegrate", name: "Disintegrate", cost: 3, description: "Powerful single-target spell that ignores armor", requires: [], effect: "disintegrate" },
          { id: "matter-break", name: "Matter Break", cost: 1, description: "Chance to instantly destroy non-boss enemies", requires: ["disintegrate"], effect: "matter-break" },
          { id: "reality-tear", name: "Reality Tear", cost: 2, description: "Create a tear in reality that damages all enemies", requires: ["matter-break"], effect: "reality-tear" }
        ]
      }
    }
  }
};

// Sound Manager
const SoundManager = {
  audioContext: null,
  sounds: {},
  enabled: true,
  
  init() {
    try {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      this.createSounds();
      
      // Resume audio context on user interaction
      document.addEventListener('click', () => {
        if (this.audioContext.state === 'suspended') {
          this.audioContext.resume();
        }
      });
    } catch (e) {
      console.warn("Web Audio API not supported:", e);
      this.enabled = false;
    }
  },
  
  createSounds() {
    // Button click sound
    this.sounds.click = this.createBeep(523.25, 0.1, 'square');
    
    // Notification sound
    this.sounds.notification = this.createBeep(1046.5, 0.3, 'sine');
    
    // Combat sounds
    this.sounds.attack = this.createBeep(261.63, 0.2, 'square');
    this.sounds.spell = this.createBeep(783.99, 0.3, 'sine');
    this.sounds.damage = this.createBeep(220, 0.1, 'sawtooth');
    this.sounds.heal = this.createBeep(659.25, 0.2, 'sine');
    this.sounds.levelUp = this.createLevelUpSound();
    this.sounds.victory = this.createVictorySound();
  },
  
  createBeep(frequency, duration, type) {
    return () => {
      if (!this.enabled) return;
      
      const oscillator = this.audioContext.createOscillator();
      const gainNode = this.audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(this.audioContext.destination);
      
      oscillator.frequency.value = frequency;
      oscillator.type = type;
      
      gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
      
      oscillator.start(this.audioContext.currentTime);
      oscillator.stop(this.audioContext.currentTime + duration);
    };
  },
  
  createLevelUpSound() {
    return () => {
      if (!this.enabled) return;
      
      const times = [0, 0.1, 0.2, 0.3];
      const frequencies = [523.25, 659.25, 783.99, 1046.5];
      
      times.forEach((time, i) => {
        setTimeout(() => {
          const oscillator = this.audioContext.createOscillator();
          const gainNode = this.audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(this.audioContext.destination);
          
          oscillator.frequency.value = frequencies[i];
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
          
          oscillator.start(this.audioContext.currentTime);
          oscillator.stop(this.audioContext.currentTime + 0.3);
        }, time * 1000);
      });
    };
  },
  
  createVictorySound() {
    return () => {
      if (!this.enabled) return;
      
      const notes = [
        { freq: 523.25, duration: 0.2 },
        { freq: 659.25, duration: 0.2 },
        { freq: 783.99, duration: 0.2 },
        { freq: 1046.5, duration: 0.4 }
      ];
      
      let time = 0;
      notes.forEach(note => {
        setTimeout(() => {
          const oscillator = this.audioContext.createOscillator();
          const gainNode = this.audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(this.audioContext.destination);
          
          oscillator.frequency.value = note.freq;
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + note.duration);
          
          oscillator.start(this.audioContext.currentTime);
          oscillator.stop(this.audioContext.currentTime + note.duration);
        }, time * 1000);
        
        time += note.duration;
      });
    };
  },
  
  play(soundName) {
    if (this.sounds[soundName] && this.enabled) {
      this.sounds[soundName]();
    }
  },
  
  toggle() {
    this.enabled = !this.enabled;
    document.getElementById('sound-toggle').textContent = `ðŸ”Š SOUND: ${this.enabled ? 'ON' : 'OFF'}`;
  }
};

// Initialize Game
document.addEventListener('DOMContentLoaded', function() {
  // Initialize sound manager
  SoundManager.init();
  
  // Character selection
  document.getElementById('select-elementalist').addEventListener('click', () => startGame('elementalist'));
  document.getElementById('select-illusionist').addEventListener('click', () => startGame('illusionist'));
  document.getElementById('select-necromancer').addEventListener('click', () => startGame('necromancer'));
  document.getElementById('select-archmage').addEventListener('click', () => startGame('archmage'));
  
  // Settings
  document.getElementById('settings-button').addEventListener('click', () => {
    openSaveLoadModal();
    SoundManager.play('click');
  });
  
  // Sound toggle
  document.getElementById('sound-toggle').addEventListener('click', () => {
    SoundManager.toggle();
    SoundManager.play('click');
  });
  
  // Mobile controls
  document.getElementById('mobile-explore').addEventListener('click', explore);
  document.getElementById('mobile-action').addEventListener('click', () => {
    if (game.location === 0) {
      talkToWizard();
    } else {
      returnToEntrance();
    }
  });
  document.getElementById('mobile-merchant').addEventListener('click', openMerchant);
  document.getElementById('mobile-rest').addEventListener('click', rest);
  document.getElementById('mobile-inventory').addEventListener('click', openInventory);
  document.getElementById('mobile-quests').addEventListener('click', openQuests);
  document.getElementById('mobile-character').addEventListener('click', openCharacter);
  document.getElementById('mobile-skills').addEventListener('click', openSkills);
  document.getElementById('mobile-map').addEventListener('click', openMap);
  
  // Add sound to all buttons
  document.addEventListener('click', function(e) {
    if (e.target.tagName === 'BUTTON') {
      SoundManager.play('click');
    }
  });
  
  // Initialize back buttons
  document.getElementById('back-from-inventory').addEventListener('click', hideAllModals);
  document.getElementById('back-from-merchant').addEventListener('click', hideAllModals);
  document.getElementById('back-from-character').addEventListener('click', hideAllModals);
  document.getElementById('back-from-skills').addEventListener('click', closeSkills);
  document.getElementById('back-from-map').addEventListener('click', closeMap);
  document.getElementById('back-from-quests').addEventListener('click', hideAllModals);
  document.getElementById('back-from-save-load').addEventListener('click', hideAllModals);
  
  // Check for saved games
  loadSaveSlots();
});

function startGame(character) {
  game.player = JSON.parse(JSON.stringify(game.characters[character]));
  game.player.gold = 50;
  game.player.level = 1;
  game.player.xp = 0;
  game.player.nextLevelXp = 100;
  game.player.equippedWeapon = "basic-staff";
  game.player.inventory = game.player.inventory || [];
  game.player.inventory.push("health-potion", "mana-potion");
  game.player.unlockedAbilities = [];
  game.player.learnedSkills = [];
  
  game.difficulty = document.getElementById('difficulty').value;
  game.location = 0;
  game.floor = 1;
  game.statusEffects = [];
  game.enemyStatusEffects = [];
  game.visitedLocations = [0];
  
  // Show game UI
  document.getElementById('character-selection').style.display = 'none';
  document.getElementById('main-game').style.display = 'flex';
  document.getElementById('save-button').style.display = 'block';
  
  // Update UI
  updateUI();
  bindButtons();
  
  // Start game
  updateLocation();
  addToScene(`You enter the Wizard's Tower as ${game.player.name}, ready to face the magical challenges ahead.`);
  
  SoundManager.play('notification');
}

function updateUI() {
  // Stats
  document.getElementById('current-hp').textContent = game.player.hp;
  document.getElementById('max-hp').textContent = game.player.maxHp;
  document.getElementById('current-mana').textContent = game.player.mana;
  document.getElementById('max-mana').textContent = game.player.maxMana;
  document.getElementById('player-level').textContent = game.player.level;
  document.getElementById('level-badge').textContent = game.player.level;
  document.getElementById('player-gold').textContent = game.player.gold;
  document.getElementById('game-floor').textContent = game.floor;
  document.getElementById('skill-points').textContent = Math.max(0, game.player.level - 1 - (game.player.learnedSkills ? game.player.learnedSkills.length : 0));
  
  // Bars
  document.getElementById('player-health-fill').style.width = `${(game.player.hp / game.player.maxHp) * 100}%`;
  document.getElementById('player-mana-fill').style.width = `${(game.player.mana / game.player.maxMana) * 100}%`;
  document.getElementById('level-progress').style.width = `${(game.player.xp / game.player.nextLevelXp) * 100}%`;
  
  // Weapon
  const weapon = game.items[game.player.equippedWeapon] || game.items["basic-staff"];
  document.getElementById('equipped-weapon-name').textContent = weapon.name;
  document.getElementById('equipped-weapon-dmg').textContent = weapon.damage;
  
  // Status effects
  updateStatusEffects();
  
  // Visual feedback for low health/mana
  const sceneDesc = document.getElementById('scene-description');
  if (game.player.hp / game.player.maxHp < 0.3) {
    sceneDesc.classList.add('health-low');
  } else {
    sceneDesc.classList.remove('health-low');
  }
  
  if (game.player.mana / game.player.maxMana < 0.3) {
    sceneDesc.classList.add('mana-low');
  } else {
    sceneDesc.classList.remove('mana-low');
  }
  
  // Update mobile control button text
  document.getElementById('mobile-explore').textContent = game.location === 0 ? "ENTER" : "EXPLORE";
  document.getElementById('mobile-action').textContent = game.location === 0 ? "TALK" : "RETURN";
}

function updateStatusEffects() {
  const statusContainer = document.getElementById('status-effects');
  statusContainer.innerHTML = '';
  
  game.statusEffects.forEach(effect => {
    const effectType = game.statusEffectTypes[effect.type];
    const span = document.createElement('span');
    span.textContent = effectType.name;
    span.className = effectType.class;
    span.style.marginRight = '5px';
    span.style.padding = '2px 5px';
    span.style.fontSize = '0.8em';
    statusContainer.appendChild(span);
  });
}

function bindButtons() {
  // Modals
  document.getElementById('save-button').onclick = openSaveLoadModal;
  
  // Combat
  document.getElementById('attack-button').onclick = playerAttack;
  document.getElementById('special-button').onclick = specialAttack;
  document.getElementById('use-item-button').onclick = useItemInCombat;
  document.getElementById('flee-button').onclick = attemptFlee;
  
  // Close buttons
  document.getElementById('close-inventory').onclick = hideAllModals;
  document.getElementById('close-merchant').onclick = hideAllModals;
  document.getElementById('close-character').onclick = hideAllModals;
  document.getElementById('close-quests').onclick = hideAllModals;
  document.getElementById('close-save-load').onclick = hideAllModals;
  document.getElementById('close-skills').onclick = closeSkills;
  document.getElementById('close-map').onclick = closeMap;
  
  // Save/Load
  document.getElementById('save-game-btn').onclick = saveCurrentGame;
  
  // Game over
  document.getElementById('try-again-button').onclick = tryAgain;
  document.getElementById('main-menu-button').onclick = returnToMainMenu;
}

// Save System
function openSaveLoadModal() {
  document.getElementById('save-load-modal').style.display = 'block';
  loadSaveSlots();
}

function loadSaveSlots() {
  game.saveSlots = JSON.parse(localStorage.getItem('wizardsTowerSaveSlots') || '[]');
  const saveSlotsContainer = document.getElementById('save-slots');
  saveSlotsContainer.innerHTML = '';
  
  if (game.saveSlots.length === 0) {
    saveSlotsContainer.innerHTML = '<p>No saved games found.</p>';
    return;
  }
  
  game.saveSlots.forEach((slot, index) => {
    const slotElement = document.createElement('div');
    slotElement.className = 'save-slot';
    slotElement.innerHTML = `
      <div><strong>${slot.name}</strong> - Floor ${slot.gameState.floor}</div>
      <div>${slot.gameState.player.name} - Level ${slot.gameState.player.level}</div>
      <div>Location: ${slot.gameState.locations[slot.gameState.location].name}</div>
      <div>Saved: ${new Date(slot.timestamp).toLocaleString()}</div>
      <button class="load-slot-btn" data-index="${index}">LOAD</button>
      <button class="delete-slot-btn" data-index="${index}">DELETE</button>
    `;
    saveSlotsContainer.appendChild(slotElement);
  });
  
  // Add event listeners
  document.querySelectorAll('.load-slot-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const index = parseInt(this.dataset.index);
      loadGameFromSlot(index);
    });
  });
  
  document.querySelectorAll('.delete-slot-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const index = parseInt(this.dataset.index);
      deleteSaveSlot(index);
    });
  });
}

function saveCurrentGame() {
  const saveName = document.getElementById('save-name').value || `Save_${new Date().toLocaleDateString()}`;
  
  const saveData = {
    name: saveName,
    timestamp: Date.now(),
    gameState: {
      player: JSON.parse(JSON.stringify(game.player)),
      location: game.location,
      floor: game.floor,
      difficulty: game.difficulty,
      statusEffects: JSON.parse(JSON.stringify(game.statusEffects)),
      locations: JSON.parse(JSON.stringify(game.locations)),
      quests: JSON.parse(JSON.stringify(game.quests)),
      visitedLocations: JSON.parse(JSON.stringify(game.visitedLocations))
    }
  };
  
  // Check if we're updating an existing save
  const existingIndex = game.saveSlots.findIndex(slot => slot.name === saveName);
  if (existingIndex !== -1) {
    game.saveSlots[existingIndex] = saveData;
  } else {
    game.saveSlots.push(saveData);
  }
  
  // Limit to 10 save slots
  if (game.saveSlots.length > 10) {
    game.saveSlots = game.saveSlots.slice(-10);
  }
  
  localStorage.setItem('wizardsTowerSaveSlots', JSON.stringify(game.saveSlots));
  addToScene(`Game saved as "${saveName}"`);
  loadSaveSlots();
  hideAllModals();
  
  SoundManager.play('notification');
}

function loadGameFromSlot(index) {
  const saveData = game.saveSlots[index];
  if (!saveData) return;
  
  Object.assign(game, saveData.gameState);
  
  document.getElementById('character-selection').style.display = 'none';
  document.getElementById('main-game').style.display = 'flex';
  document.getElementById('save-button').style.display = 'block';
  
  updateUI();
  bindButtons();
  updateLocation();
  addToScene(`Game loaded: "${saveData.name}". Welcome back, ${game.player.name}!`);
  hideAllModals();
  
  SoundManager.play('notification');
}

function deleteSaveSlot(index) {
  game.saveSlots.splice(index, 1);
  localStorage.setItem('wizardsTowerSaveSlots', JSON.stringify(game.saveSlots));
  loadSaveSlots();
  
  SoundManager.play('click');
}

// Game Actions
function explore() {
  clearScene();
  if (game.location === 0) {
    game.location = 1;
    game.floor = 1;
    if (!game.visitedLocations.includes(1)) {
      game.visitedLocations.push(1);
    }
    updateLocation();
    addToScene(game.locations[1].desc);
    setTimeout(() => startRandomEncounter(), 1000);
  } else {
    addToScene(`You explore the ${game.locations[game.location].name.toLowerCase()}...`);
    
    if (Math.random() < 0.7) {
      setTimeout(() => startRandomEncounter(), 1000);
    } else if (Math.random() < 0.5) {
      findItem();
    } else {
      setTimeout(() => addToScene("You find nothing of interest."), 1000);
    }
  }
  
  SoundManager.play('click');
}

function findItem() {
  let possibleItems = ["health-potion", "mana-potion", "scroll-fireball"];
  
  // Higher level characters find better items
  if (game.player.level > 3) {
    possibleItems.push("fire-staff");
  }
  if (game.player.level > 5) {
    possibleItems.push("ice-staff");
  }
  if (game.player.level > 7) {
    possibleItems.push("lightning-staff");
  }
  
  const foundItem = possibleItems[Math.floor(Math.random() * possibleItems.length)];
  game.player.inventory.push(foundItem);
  addToScene(`You found a ${game.items[foundItem].name}!`);
  
  SoundManager.play('notification');
}

function startRandomEncounter() {
  const enemies = game.locations[game.location].enemies;
  const enemyType = enemies[Math.floor(Math.random() * enemies.length)];
  startCombat(enemyType);
}

function startCombat(enemyType) {
  game.inCombat = true;
  game.currentEnemy = JSON.parse(JSON.stringify(game.enemies[enemyType]));
  game.enemyStatusEffects = [];
  
  // Update UI
  document.getElementById('combat-title').textContent = `COMBAT: ${game.currentEnemy.name}`;
  document.getElementById('enemy-name').textContent = game.currentEnemy.name;
  document.getElementById('enemy-hp').textContent = game.currentEnemy.hp;
  document.getElementById('enemy-max-hp').textContent = game.currentEnemy.maxHp;
  document.getElementById('enemy-hp-bar').style.width = '100%';
  
  document.getElementById('player-name').textContent = game.player.name;
  document.getElementById('player-hp-combat').textContent = game.player.hp;
  document.getElementById('player-max-hp-combat').textContent = game.player.maxHp;
  document.getElementById('player-hp-bar').style.width = `${(game.player.hp / game.player.maxHp) * 100}%`;
  document.getElementById('player-mana-combat').textContent = game.player.mana;
  document.getElementById('player-max-mana-combat').textContent = game.player.maxMana;
  document.getElementById('player-mana-bar').style.width = `${(game.player.mana / game.player.maxMana) * 100}%`;
  
  // Set combat log
  const combatLog = document.getElementById('combat-log-modal');
  combatLog.innerHTML = `<p>A ${game.currentEnemy.name} ATTACKS!</p>`;
  
  // Show enemy weaknesses
  if (game.currentEnemy.weakness && game.currentEnemy.weakness.length > 0) {
    document.getElementById('enemy-weakness-display').style.display = 'block';
    document.getElementById('enemy-weakness-list').innerHTML = '';
    
    game.currentEnemy.weakness.forEach(weakness => {
      const weaknessElement = document.createElement('span');
      weaknessElement.className = 'weakness-item';
      weaknessElement.textContent = weakness.toUpperCase();
      document.getElementById('enemy-weakness-list').appendChild(weaknessElement);
    });
  } else {
    document.getElementById('enemy-weakness-display').style.display = 'none';
  }
  
  // Special enemy intro
  if (enemyType === "archmage") {
    combatLog.innerHTML += `<p>"FOOLISH MAGE! YOU DARE CHALLENGE ME?"</p>`;
  }
  
  // Show modal
  document.getElementById('combat-modal').style.display = 'block';
  updateCombatStatusEffects();
  
  SoundManager.play('notification');
}

function playerAttack() {
  if (!game.inCombat) return;
  
  const weapon = game.items[game.player.equippedWeapon] || game.items["basic-staff"];
  let damage = weapon.damage + Math.floor(Math.random() * 4);
  
  // Intelligence bonus
  damage += Math.floor(game.player.intelligence / 3);
  
  // Check for critical
  const critChance = 0.05 + (game.player.arcane / 200);
  const isCritical = Math.random() < critChance;
  if (isCritical) damage = Math.floor(damage * 1.5);
  
  // Check for weapon special effects
  if (weapon.special && game.currentEnemy.weakness.includes(weapon.special)) {
    damage = Math.floor(damage * 1.5);
    addCombatLog(`${weapon.name} IS EFFECTIVE!`);
  }
  
  // Apply damage
  game.currentEnemy.hp -= damage;
  
  // Update UI
  const hpPercent = (game.currentEnemy.hp / game.currentEnemy.maxHp) * 100;
  document.getElementById('enemy-hp').textContent = Math.max(0, game.currentEnemy.hp);
  document.getElementById('enemy-hp-bar').style.width = `${Math.max(0, hpPercent)}%`;
  
  // Animation
  document.getElementById('enemy-display').classList.add('shake');
  setTimeout(() => document.getElementById('enemy-display').classList.remove('shake'), 400);
  
  addCombatLog(`YOU HIT FOR ${damage} DAMAGE!${isCritical ? ' <span class="critical">CRITICAL!</span>' : ''}`);
  
  SoundManager.play('attack');
  
  // Check if enemy defeated
  if (game.currentEnemy.hp <= 0) {
    enemyDefeated();
    return;
  }
  
  // Enemy counterattack
  setTimeout(() => enemyAttack(), 1000);
}

function enemyAttack() {
  if (!game.inCombat) return;
  
  let damage = game.currentEnemy.damage + Math.floor(Math.random() * 4);
  
  // Apply damage
  game.player.hp -= damage;
  updateUI();
  
  // Update combat UI
  document.getElementById('player-hp-combat').textContent = game.player.hp;
  document.getElementById('player-hp-bar').style.width = `${(game.player.hp / game.player.maxHp) * 100}%`;
  
  // Animation
  document.getElementById('player-display').classList.add('flash-blue');
  setTimeout(() => document.getElementById('player-display').classList.remove('flash-blue'), 300);
  
  addCombatLog(`${game.currentEnemy.name} HITS YOU FOR ${damage} DAMAGE!`);
  
  SoundManager.play('damage');
  
  // Check if player defeated
  if (game.player.hp <= 0) {
    playerDefeated();
  }
}

function enemyDefeated() {
  // Award XP and gold
  game.player.xp += game.currentEnemy.xp;
  game.player.gold += game.currentEnemy.gold;
  
  addCombatLog(`${game.currentEnemy.name} DEFEATED! +${game.currentEnemy.xp} XP | +${game.currentEnemy.gold} GOLD`);
  
  // Victory animation
  document.getElementById('player-display').classList.add('victory');
  setTimeout(() => {
    document.getElementById('player-display').classList.remove('victory');
  }, 2000);
  
  // Check for quest completion
  if (game.currentEnemy.name === "ARCHMAGE") {
    completeQuest("defeat-archmage");
  }
  
  // Check for level up
  if (game.player.xp >= game.player.nextLevelXp) {
    levelUp();
  }
  
  updateUI();
  
  // End combat
  setTimeout(() => {
    game.inCombat = false;
    game.statusEffects = [];
    document.getElementById('combat-modal').style.display = 'none';
    addToScene(`You defeated the ${game.currentEnemy.name}!`);
    
    SoundManager.play('victory');
    
    // Progress through locations
    if (game.currentEnemy.name === "ARCHMAGE") {
      // Game completed
      addToScene("CONGRATULATIONS! You have defeated the Archmage and conquered the Wizard's Tower!");
      addToScene("Your name will be remembered in magical history!");
    } else if (game.location < game.locations.length - 1 && Math.random() < 0.3) {
      game.location++;
      game.floor++;
      if (!game.visitedLocations.includes(game.location)) {
        game.visitedLocations.push(game.location);
      }
      updateLocation();
      addToScene(`You ascend to the next floor...`);
      addToScene(game.locations[game.location].desc);
    }
  }, 1500);
}

function levelUp() {
  game.player.level++;
  game.player.xp -= game.player.nextLevelXp;
  game.player.nextLevelXp = Math.floor(game.player.nextLevelXp * 1.5);
  
  // Stat increases
  game.player.maxHp += 10;
  game.player.hp = game.player.maxHp;
  game.player.maxMana += 15;
  game.player.mana = game.player.maxMana;
  
  // Random stat boost
  const stat = ["intelligence", "wisdom", "arcane"][Math.floor(Math.random() * 3)];
  game.player[stat]++;
  
  // Check for ability unlocks
  if (game.player.level === 5) {
    if (game.player.name === "ELEMENTALIST") {
      game.player.unlockedAbilities.push("CHAIN LIGHTNING");
      game.player.skills.push("CHAIN LIGHTNING");
    } else if (game.player.name === "ILLUSIONIST") {
      game.player.unlockedAbilities.push("MASS CONFUSION");
      game.player.skills.push("MASS CONFUSION");
    } else if (game.player.name === "NECROMANCER") {
      game.player.unlockedAbilities.push("DEATH CURSE");
      game.player.skills.push("DEATH CURSE");
    } else if (game.player.name === "ARCHMAGE") {
      game.player.unlockedAbilities.push("TIME WARP");
      game.player.skills.push("TIME WARP");
    }
  }
  
  if (game.player.level === 10) {
    if (game.player.name === "ELEMENTALIST") {
      game.player.unlockedAbilities.push("METEOR SHOWER");
      game.player.skills.push("METEOR SHOWER");
    } else if (game.player.name === "ILLUSIONIST") {
      game.player.unlockedAbilities.push("PHANTASMAL ARMY");
      game.player.skills.push("PHANTASMAL ARMY");
    } else if (game.player.name === "NECROMANCER") {
      game.player.unlockedAbilities.push("ARMY OF THE DEAD");
      game.player.skills.push("ARMY OF THE DEAD");
    } else if (game.player.name === "ARCHMAGE") {
      game.player.unlockedAbilities.push("DISINTEGRATE");
      game.player.skills.push("DISINTEGRATE");
    }
  }
  
  addCombatLog(`LEVEL UP! NOW LEVEL ${game.player.level}`);
  addCombatLog(`+10 MAX HP | +15 MAX MANA | +1 ${stat.toUpperCase()}`);
  
  if (game.player.level === 5 || game.player.level === 10) {
    addCombatLog(`NEW ABILITY UNLOCKED: ${game.player.unlockedAbilities[game.player.unlockedAbilities.length - 1]}!`);
  }
  
  updateUI();
  
  SoundManager.play('levelUp');
}

function specialAttack() {
  if (!game.inCombat) return;
  
  // Check mana cost
  const manaCost = 15;
  if (game.player.mana < manaCost) {
    addCombatLog("NOT ENOUGH MANA!");
    return;
  }
  
  game.player.mana -= manaCost;
  updateUI();
  
  if (game.player.skills.includes("FIREBALL")) {
    let damage = 20 + Math.floor(game.player.intelligence / 2);
    
    // Check for critical
    const critChance = 0.1 + (game.player.arcane / 200);
    const isCritical = Math.random() < critChance;
    if (isCritical) damage = Math.floor(damage * 1.5);
    
    // Check if effective
    if (game.currentEnemy.weakness.includes("fire")) {
      damage = Math.floor(damage * 1.5);
      addCombatLog(`FIREBALL IS SUPER EFFECTIVE!`);
      applyEnemyStatusEffect("burning");
    }
    
    game.currentEnemy.hp -= damage;
    document.getElementById('enemy-hp').textContent = Math.max(0, game.currentEnemy.hp);
    document.getElementById('enemy-hp-bar').style.width = `${(game.currentEnemy.hp / game.currentEnemy.maxHp) * 100}%`;
    
    addCombatLog(`FIREBALL HITS FOR ${damage} DAMAGE!`);
    
    if (game.currentEnemy.hp <= 0) {
      enemyDefeated();
    } else {
      setTimeout(() => enemyAttack(), 1000);
    }
  } else if (game.player.skills.includes("ICE SHARD")) {
    let damage = 15 + Math.floor(game.player.intelligence / 2);
    
    // Check for critical
    const critChance = 0.1 + (game.player.arcane / 200);
    const isCritical = Math.random() < critChance;
    if (isCritical) damage = Math.floor(damage * 1.5);
    
    // Check if effective
    if (game.currentEnemy.weakness.includes("ice")) {
      damage = Math.floor(damage * 1.5);
      addCombatLog(`ICE SHARD IS SUPER EFFECTIVE!`);
    }
    
    // Chance to freeze
    if (Math.random() < 0.3) {
      applyEnemyStatusEffect("frozen");
      addCombatLog(`The enemy is frozen solid!`);
    }
    
    game.currentEnemy.hp -= damage;
    document.getElementById('enemy-hp').textContent = Math.max(0, game.currentEnemy.hp);
    document.getElementById('enemy-hp-bar').style.width = `${(game.currentEnemy.hp / game.currentEnemy.maxHp) * 100}%`;
    
    addCombatLog(`ICE SHARD HITS FOR ${damage} DAMAGE!`);
    
    if (game.currentEnemy.hp <= 0) {
      enemyDefeated();
    } else {
      setTimeout(() => enemyAttack(), 1000);
    }
  } else if (game.player.skills.includes("CONFUSION")) {
    if (Math.random() < 0.6) {
      applyEnemyStatusEffect("confused");
      addCombatLog(`The enemy is confused and will deal less damage!`);
      setTimeout(() => enemyAttack(), 1000);
    } else {
      addCombatLog("CONFUSION FAILED!");
      setTimeout(() => enemyAttack(), 1000);
    }
  } else if (game.player.skills.includes("LIFE DRAIN")) {
    let damage = 15 + Math.floor(game.player.intelligence / 2);
    
    // Check for critical
    const critChance = 0.1 + (game.player.arcane / 200);
    const isCritical = Math.random() < critChance;
    if (isCritical) damage = Math.floor(damage * 1.5);
    
    game.currentEnemy.hp -= damage;
    document.getElementById('enemy-hp').textContent = Math.max(0, game.currentEnemy.hp);
    document.getElementById('enemy-hp-bar').style.width = `${(game.currentEnemy.hp / game.currentEnemy.maxHp) * 100}%`;
    
    // Heal for half damage
    const healAmount = Math.floor(damage / 2);
    game.player.hp = Math.min(game.player.maxHp, game.player.hp + healAmount);
    updateUI();
    
    addCombatLog(`LIFE DRAIN HITS FOR ${damage} DAMAGE AND HEALS ${healAmount} HP!`);
    
    if (game.currentEnemy.hp <= 0) {
      enemyDefeated();
    } else {
      setTimeout(() => enemyAttack(), 1000);
    }
  } else if (game.player.skills.includes("ARCANE MISSILE")) {
    // Guaranteed hit
    let damage = 12 + Math.floor(game.player.intelligence / 2);
    
    game.currentEnemy.hp -= damage;
    document.getElementById('enemy-hp').textContent = Math.max(0, game.currentEnemy.hp);
    document.getElementById('enemy-hp-bar').style.width = `${(game.currentEnemy.hp / game.currentEnemy.maxHp) * 100}%`;
    
    addCombatLog(`ARCANE MISSILE HITS FOR ${damage} DAMAGE!`);
    
    if (game.currentEnemy.hp <= 0) {
      enemyDefeated();
    } else {
      setTimeout(() => enemyAttack(), 1000);
    }
  } else if (game.player.skills.includes("MANA SHIELD")) {
    // Convert mana to temporary HP
    const shieldAmount = Math.floor(game.player.mana * 0.3);
    game.player.mana = Math.max(0, game.player.mana - shieldAmount);
    applyStatusEffect("shielded");
    addCombatLog(`MANA SHIELD: Created a shield absorbing ${shieldAmount} damage!`);
    setTimeout(() => enemyAttack(), 1000);
  }
  
  SoundManager.play('spell');
}

function applyStatusEffect(type) {
  const existing = game.statusEffects.find(e => e.type === type);
  if (existing) {
    existing.duration = game.statusEffectTypes[type].duration; // Refresh duration
  } else {
    game.statusEffects.push({
      type: type,
      duration: game.statusEffectTypes[type].duration
    });
  }
  updateStatusEffects();
}

function applyEnemyStatusEffect(type) {
  const existing = game.enemyStatusEffects.find(e => e.type === type);
  if (existing) {
    existing.duration = game.statusEffectTypes[type].duration; // Refresh duration
  } else {
    game.enemyStatusEffects.push({
      type: type,
      duration: game.statusEffectTypes[type].duration
    });
  }
  updateCombatStatusEffects();
}

function updateCombatStatusEffects() {
  const playerEffects = document.getElementById('player-combat-status-effects');
  const enemyEffects = document.getElementById('enemy-status-effects');
  
  playerEffects.innerHTML = '';
  enemyEffects.innerHTML = '';
  
  game.statusEffects.forEach(effect => {
    const effectType = game.statusEffectTypes[effect.type];
    const span = document.createElement('div');
    span.textContent = `${effectType.name} (${effect.duration})`;
    span.className = effectType.class;
    playerEffects.appendChild(span);
  });
  
  game.enemyStatusEffects.forEach(effect => {
    const effectType = game.statusEffectTypes[effect.type];
    const span = document.createElement('div');
    span.textContent = `${effectType.name} (${effect.duration})`;
    span.className = effectType.class;
    enemyEffects.appendChild(span);
  });
}

function playerDefeated() {
  addCombatLog("YOU HAVE BEEN DEFEATED!");
  setTimeout(() => {
    game.inCombat = false;
    document.getElementById('combat-modal').style.display = 'none';
    document.getElementById('game-over-modal').style.display = 'block';
  }, 1500);
  
  SoundManager.play('damage');
}

function useItemInCombat() {
  openInventory();
}

function attemptFlee() {
  // Arcane affects flee chance
  const fleeChance = 0.5 + (game.player.arcane / 100);
  
  if (Math.random() < fleeChance) {
    addCombatLog("YOU SUCCESSFULLY FLEE!");
    setTimeout(() => {
      game.inCombat = false;
      document.getElementById('combat-modal').style.display = 'none';
      addToScene(`You barely escape from the ${game.currentEnemy.name}!`);
      
      // Return to previous location when fleeing
      if (game.location > 1) {
        game.location--;
        game.floor--;
        updateLocation();
      }
    }, 1000);
  } else {
    addCombatLog("FAILED TO FLEE!");
    setTimeout(() => enemyAttack(), 1000);
  }
  
  SoundManager.play('click');
}

// Location Functions
function updateLocation() {
  document.getElementById('location-name').textContent = game.locations[game.location].name;
  document.getElementById('dungeon-level').textContent = game.locations[game.location].name;
  updateUI(); // This will update the mobile control button text
}

function talkToWizard() {
  if (!game.player.inventory.includes("fire-staff")) {
    addToScene(`"Take this," the old wizard says, handing you a FIRE STAFF. "It will help you on your journey."`);
    game.player.inventory.push("fire-staff");
    completeQuest("find-fire-staff");
  } else {
    const dialogues = [
      `"The tower holds many secrets. Be careful, young mage," the wizard advises.`,
      `"I sense great power within you. Use it wisely," he says.`,
      `"The merchant has magical items for sale, but be careful with your gold," he warns.`,
      `"They say there's a library on the second floor filled with ancient knowledge."`,
      `"The alchemy lab is dangerous but holds powerful potions."`,
      `"Some say there's a secret laboratory hidden in the tower."`,
      `"I've heard whispers of a crystal cave deep beneath the tower."`,
      `"They say a portal to the spirit realm exists somewhere in the tower."`
    ];
    addToScene(dialogues[Math.floor(Math.random() * dialogues.length)]);
  }
  
  SoundManager.play('click');
}

function returnToEntrance() {
  game.location = 0;
  game.floor = 1;
  updateLocation();
  clearScene();
  addToScene(game.locations[0].desc);
  
  SoundManager.play('click');
}

function rest() {
  const healAmount = Math.floor(game.player.maxHp * 0.3);
  const manaAmount = Math.floor(game.player.maxMana * 0.4);
  
  game.player.hp = Math.min(game.player.maxHp, game.player.hp + healAmount);
  game.player.mana = Math.min(game.player.maxMana, game.player.mana + manaAmount);
  
  // Rest cures some status effects
  game.statusEffects = game.statusEffects.filter(e => !["burning", "drained"].includes(e.type));
  updateStatusEffects();
  
  addToScene(`You rest and recover ${healAmount} HP and ${manaAmount} mana.`);
  updateUI();
  
  SoundManager.play('heal');
  
  if (game.location > 0 && Math.random() < 0.2) {
    setTimeout(() => {
      addToScene(`You are ambushed while resting!`);
      startRandomEncounter();
    }, 1000);
  }
}

// Merchant Functions
function openMerchant() {
  // Update gold display
  document.getElementById('merchant-gold-amount').textContent = game.player.gold;
  
  // Create buy list
  const buyList = document.getElementById('merchant-buy-list');
  buyList.innerHTML = '';
  
  game.merchantItems.forEach(item => {
    const itemElement = document.createElement('div');
    itemElement.className = 'merchant-item';
    itemElement.innerHTML = `
      <span>${item.name} (${item.price} GOLD)</span>
      <button class="buy-button" data-id="${item.id}" data-price="${item.price}">BUY</button>
    `;
    buyList.appendChild(itemElement);
  });
  
  // Create sell list
  const sellList = document.getElementById('merchant-sell-list');
  sellList.innerHTML = '';
  
  // Count items
  const itemCounts = {};
  game.player.inventory.forEach(item => {
    if (game.items[item] && item !== "basic-staff") {
      itemCounts[item] = (itemCounts[item] || 0) + 1;
    }
  });
  
  // Add sellable items
  Object.keys(itemCounts).forEach(itemId => {
    const item = game.items[itemId];
    const sellPrice = Math.floor((item.damage || item.heal || item.mana || 5) * 2);
    
    const itemElement = document.createElement('div');
    itemElement.className = 'merchant-item';
    itemElement.innerHTML = `
      <span>${item.name} x${itemCounts[itemId]} (${sellPrice} GOLD)</span>
      <button class="sell-button" data-id="${itemId}" data-price="${sellPrice}">SELL</button>
    `;
    sellList.appendChild(itemElement);
  });
  
  // Add event listeners
  document.querySelectorAll('.buy-button').forEach(button => {
    button.addEventListener('click', function() {
      const itemId = this.dataset.id;
      const price = parseInt(this.dataset.price);
      
      if (game.player.gold >= price) {
        game.player.gold -= price;
        game.player.inventory.push(itemId);
        updateUI();
        document.getElementById('merchant-gold-amount').textContent = game.player.gold;
        addToScene(`You bought a ${game.items[itemId].name} for ${price} gold.`);
        openMerchant(); // Refresh
        
        SoundManager.play('click');
      } else {
        addToScene("Not enough gold!");
        SoundManager.play('notification');
      }
    });
  });
  
  document.querySelectorAll('.sell-button').forEach(button => {
    button.addEventListener('click', function() {
      const itemId = this.dataset.id;
      const price = parseInt(this.dataset.price);
      
      // Remove from inventory
      const index = game.player.inventory.indexOf(itemId);
      if (index !== -1) {
        game.player.inventory.splice(index, 1);
        game.player.gold += price;
        updateUI();
        document.getElementById('merchant-gold-amount').textContent = game.player.gold;
        addToScene(`You sold a ${game.items[itemId].name} for ${price} gold.`);
        openMerchant(); // Refresh
        
        SoundManager.play('click');
      }
    });
  });
  
  document.getElementById('merchant-modal').style.display = 'block';
}

// Inventory Functions
function openInventory() {
  // Weapons
  const weaponsList = document.getElementById('weapons-list');
  weaponsList.innerHTML = '';
  
  // Count weapons
  const weaponCounts = {};
  game.player.inventory.forEach(item => {
    if (game.items[item]?.damage) {
      weaponCounts[item] = (weaponCounts[item] || 0) + 1;
    }
  });
  
  // Add basic staff (always available)
  weaponCounts["basic-staff"] = 1;
  
  // Display weapons
  Object.keys(weaponCounts).forEach(weaponId => {
    const weapon = game.items[weaponId];
    const isEquipped = weaponId === game.player.equippedWeapon;
    
    const weaponElement = document.createElement('div');
    weaponElement.className = 'item-row';
    weaponElement.innerHTML = `
      <span>${weapon.name} (${weapon.damage} DMG)${isEquipped ? ' [EQUIPPED]' : ''}</span>
      <button class="equip-button" data-id="${weaponId}">${isEquipped ? 'UNEQUIP' : 'EQUIP'}</button>
    `;
    weaponsList.appendChild(weaponElement);
  });
  
  // Items
  const itemsList = document.getElementById('items-list');
  itemsList.innerHTML = '';
  
  // Count items
  const itemCounts = {};
  game.player.inventory.forEach(item => {
    if (game.items[item]?.heal || game.items[item]?.mana || game.items[item]?.consumable) {
      itemCounts[item] = (itemCounts[item] || 0) + 1;
    }
  });
  
  // Display items
  Object.keys(itemCounts).forEach(itemId => {
    const item = game.items[itemId];
    
    const itemElement = document.createElement('div');
    itemElement.className = 'item-row';
    itemElement.innerHTML = `
      <span>${item.name} x${itemCounts[itemId]}</span>
      <button class="use-button" data-id="${itemId}">USE</button>
    `;
    itemsList.appendChild(itemElement);
  });
  
  // Add event listeners
  document.querySelectorAll('.equip-button').forEach(button => {
    button.addEventListener('click', function() {
      const weaponId = this.dataset.id;
      
      if (game.player.equippedWeapon === weaponId) {
        game.player.equippedWeapon = "basic-staff";
        addToScene(`You unequip your staff.`);
      } else {
        game.player.equippedWeapon = weaponId;
        addToScene(`You equip the ${game.items[weaponId].name}.`);
      }
      
      updateUI();
      openInventory(); // Refresh
      
      SoundManager.play('click');
    });
  });
  
  document.querySelectorAll('.use-button').forEach(button => {
    button.addEventListener('click', function() {
      const itemId = this.dataset.id;
      const item = game.items[itemId];
      
      if (item.heal) {
        const healAmount = Math.min(item.heal, game.player.maxHp - game.player.hp);
        game.player.hp += healAmount;
        
        // Remove from inventory
        const index = game.player.inventory.indexOf(itemId);
        if (index !== -1) game.player.inventory.splice(index, 1);
        
        if (game.inCombat) {
          addCombatLog(`YOU USE A ${item.name} AND HEAL ${healAmount} HP!`);
          setTimeout(() => enemyAttack(), 1000);
        } else {
          addToScene(`You use a ${item.name} and heal ${healAmount} HP.`);
        }
        
        updateUI();
        openInventory(); // Refresh
        
        SoundManager.play('heal');
      } else if (item.mana) {
        const manaAmount = Math.min(item.mana, game.player.maxMana - game.player.mana);
        game.player.mana += manaAmount;
        
        // Remove from inventory
        const index = game.player.inventory.indexOf(itemId);
        if (index !== -1) game.player.inventory.splice(index, 1);
        
        if (game.inCombat) {
          addCombatLog(`YOU USE A ${item.name} AND RESTORE ${manaAmount} MANA!`);
          setTimeout(() => enemyAttack(), 1000);
        } else {
          addToScene(`You use a ${item.name} and restore ${manaAmount} mana.`);
        }
        
        updateUI();
        openInventory(); // Refresh
        
        SoundManager.play('heal');
      } else if (item.consumable) {
        // Scrolls - use in combat only
        if (game.inCombat) {
          let damage = item.damage;
          
          // Check if effective
          if (item.special && game.currentEnemy.weakness.includes(item.special)) {
            damage = Math.floor(damage * 1.5);
            addCombatLog(`${item.name} IS SUPER EFFECTIVE!`);
          }
          
          game.currentEnemy.hp -= damage;
          document.getElementById('enemy-hp').textContent = Math.max(0, game.currentEnemy.hp);
          document.getElementById('enemy-hp-bar').style.width = `${(game.currentEnemy.hp / game.currentEnemy.maxHp) * 100}%`;
          
          // Remove from inventory
          const index = game.player.inventory.indexOf(itemId);
          if (index !== -1) game.player.inventory.splice(index, 1);
          
          addCombatLog(`YOU USE A ${item.name} FOR ${damage} DAMAGE!`);
          
          if (game.currentEnemy.hp <= 0) {
            enemyDefeated();
          } else {
            setTimeout(() => enemyAttack(), 1000);
          }
          
          updateUI();
          openInventory(); // Refresh
          
          SoundManager.play('spell');
        } else {
          addToScene("Scrolls can only be used in combat.");
        }
      }
    });
  });
  
  document.getElementById('inventory-modal').style.display = 'block';
}

// Character Stats
function openCharacter() {
  document.getElementById('character-name').textContent = game.player.name;
  document.getElementById('character-class').textContent = game.player.class;
  document.getElementById('character-level').textContent = game.player.level;
  
  document.getElementById('character-intelligence').textContent = game.player.intelligence;
  document.getElementById('character-wisdom').textContent = game.player.wisdom;
  document.getElementById('character-arcane').textContent = game.player.arcane;
  
  const skillsList = document.getElementById('character-skills');
  skillsList.innerHTML = '';
  
  game.player.skills.forEach(skill => {
    const skillElement = document.createElement('div');
    skillElement.textContent = `â€¢ ${skill}`;
    skillsList.appendChild(skillElement);
  });
  
  const statusEffectsList = document.getElementById('character-status-effects');
  statusEffectsList.innerHTML = '';
  
  game.statusEffects.forEach(effect => {
    const effectType = game.statusEffectTypes[effect.type];
    const effectElement = document.createElement('div');
    effectElement.textContent = `â€¢ ${effectType.name} (${effect.duration} turns)`;
    effectElement.className = effectType.class;
    statusEffectsList.appendChild(effectElement);
  });
  
  document.getElementById('character-modal').style.display = 'block';
}

// Skills
function openSkills() {
  const skillPoints = Math.max(0, game.player.level - 1 - game.player.learnedSkills.length);
  document.getElementById('skill-points-display').textContent = skillPoints;
  document.getElementById('skills-level').textContent = game.player.level;
  
  const skillTreeContainer = document.getElementById('skill-tree-container');
  skillTreeContainer.innerHTML = '';
  
  const characterClass = game.player.name.toLowerCase();
  const skillTree = game.skillTrees[characterClass];
  
  if (!skillTree) {
    skillTreeContainer.innerHTML = '<p>No skills available for this class.</p>';
    return;
  }
  
  // Create skill categories
  Object.keys(skillTree).forEach(categoryKey => {
    const category = skillTree[categoryKey];
    const categoryElement = document.createElement('div');
    categoryElement.className = 'skill-category';
    
    const categoryTitle = document.createElement('h3');
    categoryTitle.textContent = category.name;
    categoryElement.appendChild(categoryTitle);
    
    // Create skill nodes
    category.skills.forEach(skill => {
      const skillNode = document.createElement('div');
      
      // Check if skill is unlocked, available, or locked
      const isUnlocked = game.player.learnedSkills.includes(skill.id);
      const hasRequirements = skill.requires.every(req => game.player.learnedSkills.includes(req));
      const canAfford = skillPoints >= skill.cost;
      
      if (isUnlocked) {
        skillNode.className = 'skill-node unlocked';
      } else if (hasRequirements && canAfford) {
        skillNode.className = 'skill-node available';
      } else {
        skillNode.className = 'skill-node locked';
      }
      
      // Add requirement indicator
      if (skill.requires.length > 0) {
        skillNode.classList.add('requires');
      }
      
      skillNode.innerHTML = `
        <div style="font-weight: bold;">${skill.name}</div>
        <div class="skill-cost">${skill.cost} SP</div>
        <div class="skill-description">${skill.description}</div>
      `;
      
      // Add click event
      if (!isUnlocked && hasRequirements && canAfford) {
        skillNode.addEventListener('click', () => {
          learnSkill(skill.id, skill.cost);
        });
      }
      
      categoryElement.appendChild(skillNode);
    });
    
    skillTreeContainer.appendChild(categoryElement);
  });
  
  document.getElementById('skills-modal').style.display = 'block';
}

function learnSkill(skillId, cost) {
  if (game.player.learnedSkills.includes(skillId)) {
    addToScene("You already know this skill!");
    return;
  }
  
  const skillPoints = Math.max(0, game.player.level - 1 - game.player.learnedSkills.length);
  if (skillPoints < cost) {
    addToScene("Not enough skill points!");
    return;
  }
  
  game.player.learnedSkills.push(skillId);
  addToScene(`You learned a new skill!`);
  
  // Apply skill effects
  applySkillEffect(skillId);
  
  // Close and reopen skills modal to refresh
  closeSkills();
  openSkills();
  
  SoundManager.play('notification');
}

function applySkillEffect(skillId) {
  // This is where we would implement the actual skill effects
  // For now, we'll just add a message
  addToScene(`Skill ${skillId} is now active!`);
}

function closeSkills() {
  document.getElementById('skills-modal').style.display = 'none';
}

// Map
function openMap() {
  const mapContainer = document.getElementById('interactive-map');
  mapContainer.innerHTML = '';
  
  // Create a simple grid layout for the map
  const mapWidth = mapContainer.offsetWidth;
  const mapHeight = mapContainer.offsetHeight;
  
  // Define positions for each location
  const locationPositions = [
    { x: mapWidth / 2 - 40, y: mapHeight - 70 }, // Entrance (bottom center)
    { x: mapWidth / 2 - 40, y: mapHeight - 140 }, // First Floor
    { x: mapWidth / 2 - 120, y: mapHeight - 210 }, // Library (left)
    { x: mapWidth / 2 + 40, y: mapHeight - 210 }, // Alchemy Lab (right)
    { x: mapWidth / 2 - 40, y: mapHeight - 280 }, // Observatory
    { x: mapWidth / 2 - 40, y: mapHeight - 350 }, // Throne Room (top center)
    { x: mapWidth / 2 - 120, y: mapHeight - 350 }, // Secret Lab (top left)
    { x: mapWidth / 2 + 40, y: mapHeight - 350 }, // Crystal Cave (top right)
    { x: mapWidth / 2 - 40, y: mapHeight - 420 }  // Spirit Realm (very top)
  ];
  
  // Create connections between locations
  const connections = [
    [0, 1], // Entrance to First Floor
    [1, 2], // First Floor to Library
    [1, 3], // First Floor to Alchemy Lab
    [2, 4], // Library to Observatory
    [3, 4], // Alchemy Lab to Observatory
    [4, 5], // Observatory to Throne Room
    [5, 6], // Throne Room to Secret Lab
    [5, 7], // Throne Room to Crystal Cave
    [5, 8]  // Throne Room to Spirit Realm
  ];
  
  // Draw connections
  connections.forEach(connection => {
    const start = locationPositions[connection[0]];
    const end = locationPositions[connection[1]];
    
    const connectionElement = document.createElement('div');
    connectionElement.className = 'map-connection';
    
    // Calculate position and rotation
    const length = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
    const angle = Math.atan2(end.y - start.y, end.x - start.x) * 180 / Math.PI;
    
    connectionElement.style.width = `${length}px`;
    connectionElement.style.left = `${start.x + 40}px`;
    connectionElement.style.top = `${start.y + 30}px`;
    connectionElement.style.transform = `rotate(${angle}deg)`;
    
    mapContainer.appendChild(connectionElement);
  });
  
  // Create location markers
  game.locations.forEach((location, index) => {
    const position = locationPositions[index];
    
    const locationElement = document.createElement('div');
    locationElement.className = 'map-location';
    locationElement.textContent = location.name;
    locationElement.style.left = `${position.x}px`;
    locationElement.style.top = `${position.y}px`;
    
    // Set location state
    if (index === game.location) {
      locationElement.classList.add('current');
    } else if (game.visitedLocations.includes(index)) {
      locationElement.classList.add('visited');
    } else if (location.hidden) {
      locationElement.classList.add('hidden');
    } else {
      locationElement.classList.add('discovered');
    }
    
    // Make accessible locations clickable
    if (game.visitedLocations.includes(index) || 
        (index > 0 && game.visitedLocations.includes(index - 1))) {
      locationElement.classList.add('accessible');
      locationElement.addEventListener('click', () => {
        if (index !== game.location) {
          game.location = index;
          game.floor = index;
          updateLocation();
          closeMap();
          addToScene(`You travel to the ${location.name}.`);
          addToScene(location.desc);
        }
      });
    }
    
    // Add tooltip
    locationElement.addEventListener('mouseenter', (e) => {
      const tooltip = document.createElement('div');
      tooltip.className = 'map-tooltip';
      tooltip.textContent = location.desc;
      tooltip.style.left = `${e.pageX + 10}px`;
      tooltip.style.top = `${e.pageY + 10}px`;
      document.body.appendChild(tooltip);
      
      locationElement._tooltip = tooltip;
    });
    
    locationElement.addEventListener('mouseleave', () => {
      if (locationElement._tooltip) {
        document.body.removeChild(locationElement._tooltip);
        locationElement._tooltip = null;
      }
    });
    
    mapContainer.appendChild(locationElement);
  });
  
  document.getElementById('interactive-map-modal').style.display = 'block';
}

function closeMap() {
  document.getElementById('interactive-map-modal').style.display = 'none';
}

// Quests
function openQuests() {
  const activeQuests = document.getElementById('active-quests');
  activeQuests.innerHTML = '';
  
  game.quests.active.forEach(quest => {
    const questElement = document.createElement('div');
    questElement.style.padding = '5px 0';
    questElement.style.borderBottom = '1px dashed #aaf';
    questElement.innerHTML = `
      <div style="font-weight: bold;">${quest.title}</div>
      <div>${quest.description}</div>
      <div>${quest.completed ? '(Completed)' : '(Active)'}</div>
    `;
    activeQuests.appendChild(questElement);
  });
  
  const completedQuests = document.getElementById('completed-quests');
  completedQuests.innerHTML = '';
  
  game.quests.completed.forEach(quest => {
    const questElement = document.createElement('div');
    questElement.style.padding = '5px 0';
    questElement.style.borderBottom = '1px dashed #aaf';
    questElement.innerHTML = `
      <div style="font-weight: bold; color: #0f0;">${quest.title}</div>
      <div>${quest.description}</div>
    `;
    completedQuests.appendChild(questElement);
  });
  
  const sideQuests = document.getElementById('side-quests');
  sideQuests.innerHTML = '';
  
  game.quests.side.forEach(quest => {
    if (!quest.hidden || game.player.level >= 5) {
      const questElement = document.createElement('div');
      questElement.style.padding = '5px 0';
      questElement.style.borderBottom = '1px dashed #aaf';
      questElement.innerHTML = `
        <div style="font-weight: bold;">${quest.title}</div>
        <div>${quest.description}</div>
        <div>${quest.completed ? '(Completed)' : '(Active)'}</div>
      `;
      sideQuests.appendChild(questElement);
    }
  });
  
  document.getElementById('quests-modal').style.display = 'block';
}

function completeQuest(questId) {
  // Main quests
  const mainQuestIndex = game.quests.active.findIndex(q => q.id === questId);
  if (mainQuestIndex !== -1) {
    const quest = game.quests.active[mainQuestIndex];
    quest.completed = true;
    
    // Move to completed
    game.quests.completed.push(quest);
    game.quests.active.splice(mainQuestIndex, 1);
    
    addToScene(`QUEST COMPLETED: ${quest.title}`);
  }
  
  // Side quests
  const sideQuestIndex = game.quests.side.findIndex(q => q.id === questId);
  if (sideQuestIndex !== -1) {
    const quest = game.quests.side[sideQuestIndex];
    quest.completed = true;
    
    // Give reward
    if (quest.reward) {
      game.player.inventory.push(quest.reward);
      addToScene(`You received ${game.items[quest.reward].name} as a reward!`);
    }
    
    addToScene(`SIDE QUEST COMPLETED: ${quest.title}`);
  }
  
  // Refresh if open
  if (document.getElementById('quests-modal').style.display === 'block') {
    openQuests();
  }
  
  SoundManager.play('notification');
}

// Utility Functions
function addToScene(text) {
  const scene = document.getElementById('scene-description');
  scene.innerHTML += `<p>${text}</p>`;
  scene.scrollTop = scene.scrollHeight;
}

function addCombatLog(text) {
  const log = document.getElementById('combat-log-modal');
  log.innerHTML += `<p>${text}</p>`;
  log.scrollTop = log.scrollHeight;
}

function clearScene() {
  document.getElementById('scene-description').innerHTML = '';
}

function hideAllModals() {
  document.querySelectorAll('.modal').forEach(modal => {
    modal.style.display = 'none';
  });
  
  // If in combat, return to combat modal
  if (game.inCombat) {
    document.getElementById('combat-modal').style.display = 'block';
  }
}

function tryAgain() {
  document.getElementById('game-over-modal').style.display = 'none';
  game.player.hp = game.player.maxHp;
  game.player.mana = game.player.maxMana;
  game.statusEffects = [];
  updateUI();
  
  SoundManager.play('click');
}

function returnToMainMenu() {
  document.getElementById('game-over-modal').style.display = 'none';
  document.getElementById('main-game').style.display = 'none';
  document.getElementById('character-selection').style.display = 'flex';
  document.getElementById('save-button').style.display = 'none';
  
  SoundManager.play('click');
}
</script>
</body>
</html>
