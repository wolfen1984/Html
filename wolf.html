<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Wolfman's Curse - Enhanced RPG</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">
<style>
/* Base Styles */
:root {
  --blood-red: #8b0000;
  --gold: #d4af37;
  --moonlight: #f5f5dc;
  --dark-bg: #0a0505;
  --wood-brown: #5a3020;
  --hp-green: #00aa00;
  --fury-orange: #ff8c00;
  --curse-purple: #ab47bc;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  margin: 0;
  padding: 0;
  background-color: var(--dark-bg);
  color: #e0d8b0;
  font-family: 'MedievalSharp', cursive;
  touch-action: manipulation;
  overflow: hidden;
  height: 100vh;
  user-select: none;
  -webkit-user-select: none;
  background-image: url('https://images.unsplash.com/photo-1518709268805-4e9042af9f23?ixlib=rb-1.2.1&auto=format&fit=crop&w=1489&q=80');
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
  background-blend-mode: multiply;
  position: relative;
}

/* Moon Phase Backgrounds */
body::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, rgba(245,245,220,0.1) 0%, rgba(10,5,5,0.9) 70%);
  opacity: 0;
  transition: opacity 1s ease;
  z-index: -1;
}

body.full-moon::before {
  opacity: 0.3;
}

body.new-moon::before {
  background: radial-gradient(circle, rgba(50,50,50,0.1) 0%, rgba(10,5,5,0.9) 70%);
  opacity: 0.2;
}

/* Particle Effects */
.particle {
  position: absolute;
  background-color: var(--gold);
  border-radius: 50%;
  pointer-events: none;
  z-index: 10;
}

.damage-number {
  position: absolute;
  color: var(--blood-red);
  font-weight: bold;
  font-size: 1.5em;
  text-shadow: 0 0 5px black;
  pointer-events: none;
  z-index: 20;
  animation: floatUp 1s forwards;
}

@keyframes floatUp {
  0% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(-50px); opacity: 0; }
}

/* Game Container */
#game-container {
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
  position: relative;
  background-color: rgba(10, 10, 10, 0.85);
  border: 2px solid var(--wood-brown);
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
  overflow: hidden;
}

/* Header Section */
#header {
  background: linear-gradient(to bottom, #1a0f0f, #0a0505);
  padding: 10px;
  border-bottom: 2px solid var(--wood-brown);
  text-align: center;
  font-size: 1.2em;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  font-family: 'Cinzel Decorative', cursive;
  text-shadow: 0 0 5px var(--blood-red);
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
  z-index: 5;
}

#equipped-weapon {
  font-size: 0.8em;
  color: var(--gold);
  font-style: italic;
}

#transformation-status {
  font-size: 0.9em;
  color: var(--gold);
  margin-left: 50px;
  text-transform: uppercase;
  letter-spacing: 1px;
  text-shadow: 0 0 3px rgba(212, 175, 55, 0.5);
}

/* Moon Phase Display */
#moon-phase-container {
  display: flex;
  align-items: center;
  gap: 5px;
}

#moon-phase {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--moonlight) 50%, transparent 50%);
  box-shadow: 0 0 10px var(--moonlight), 0 0 20px rgba(245, 245, 220, 0.5);
  position: relative;
  border: 1px solid var(--gold);
  transition: transform 0.3s;
}

#moon-phase:hover {
  transform: scale(1.1);
}

#moon-phase::after {
  content: attr(title);
  position: absolute;
  bottom: -25px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(26, 15, 15, 0.9);
  padding: 2px 5px;
  border-radius: 3px;
  font-size: 0.7em;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
  border: 1px solid var(--wood-brown);
  color: #e0d8b0;
}

#moon-phase:hover::after {
  opacity: 1;
}

/* Enemy Stats */
#enemy-stats {
  background: linear-gradient(to bottom, #1a0f0f, #0a0505);
  padding: 10px;
  border-bottom: 2px solid var(--wood-brown);
  font-size: 1em;
  text-align: center;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
  position: relative;
}

.enemy-health-container {
  flex: 1;
}

#enemy-stats .enemy-name {
  font-weight: bold;
  font-size: 12px;
  color: var(--blood-red);
  text-shadow: 0 0 3px var(--blood-red);
  font-family: 'Cinzel Decorative', cursive;
}

#enemy-stats .enemy-hp {
  color: var(--blood-red);
  font-size: 12px;
  text-shadow: 0 0 3px var(--blood-red);
}

#enemy-stats .enemy-dmg {
  color: var(--blood-red);
  margin-right: 100px;
  font-size: 12px;
  text-shadow: 0 0 3px var(--blood-red);
}

#enemy-hp-bar {
  height: 8px;
  background-color: #2a1a1a;
  margin-top: 5px;
  border-radius: 5px;
  overflow: hidden;
  border: 1px solid var(--wood-brown);
}

#enemy-hp-fill {
  height: 100%;
  background: linear-gradient(to right, var(--blood-red), #c00000);
  width: 100%;
  transition: width 0.3s;
  box-shadow: 0 0 5px rgba(192, 0, 0, 0.7);
}

/* Enemy Weakness Indicator */
.enemy-weakness {
  position: absolute;
  top: -15px;
  right: 10px;
  font-size: 0.7em;
  padding: 2px 5px;
  border-radius: 3px;
  background-color: rgba(26, 15, 15, 0.9);
  border: 1px solid var(--wood-brown);
}

/* Main Display */
#main-display {
  flex: 1;
  padding: 15px;
  background-color: rgba(10, 5, 5, 0.8);
  border-bottom: 2px solid var(--wood-brown);
  overflow-y: auto;
  font-size: 1.1em;
  line-height: 1.5;
  border-left: 1px solid #3a1a1a;
  border-right: 1px solid #3a1a1a;
  box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
  position: relative;
}

#combat-log {
  height: 100%;
  overflow-y: auto;
  padding-right: 5px;
}

.combat-entry {
  margin-bottom: 8px;
  animation: fadeIn 0.3s;
  padding: 5px;
  border-left: 2px solid transparent;
  transition: all 0.2s;
  border-radius: 3px;
}

.combat-entry:hover {
  background-color: rgba(26, 15, 15, 0.5);
  border-left: 2px solid var(--wood-brown);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Message Types */
.player-action {
  color: var(--gold);
}

.enemy-action {
  color: var(--blood-red);
}

.system-message {
  color: #a5d6a7;
  font-style: italic;
}

.loot-message {
  color: #ffd54f;
}

.transformation-message {
  color: var(--curse-purple);
  font-weight: bold;
}

.critical-hit {
  color: #ff6b6b;
  font-weight: bold;
  animation: pulse 0.5s infinite alternate;
}

@keyframes pulse {
  from { text-shadow: 0 0 5px #ff6b6b; }
  to { text-shadow: 0 0 10px #ff6b6b, 0 0 20px #ff6b6b; }
}

.dodge-message {
  color: #64b5f6;
  font-weight: bold;
}

.curse-message {
  color: var(--curse-purple);
  font-weight: bold;
}

.xp-message {
  color: #4fc3f7;
}

.level-up-message {
  color: var(--gold);
  font-weight: bold;
  animation: glow 1s infinite alternate;
  text-shadow: 0 0 5px var(--gold);
}

@keyframes glow {
  from { text-shadow: 0 0 5px var(--gold); }
  to { text-shadow: 0 0 10px var(--gold), 0 0 20px var(--gold); }
}

/* Stats Panel */
#stats-panel {
  display: flex;
  justify-content: space-between;
  background: linear-gradient(to bottom, #1a0f0f, #0a0505);
  padding: 10px;
  border-bottom: 2px solid var(--wood-brown);
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
}

.stat-box {
  text-align: center;
  flex: 1;
  position: relative;
  padding: 5px;
  border-right: 1px solid #3a1a1a;
}

.stat-box:last-child {
  border-right: none;
}

.stat-box:hover .stat-tooltip {
  display: block;
}

.stat-tooltip {
  display: none;
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(26, 15, 15, 0.95);
  padding: 5px;
  border-radius: 3px;
  font-size: 0.8em;
  white-space: nowrap;
  z-index: 100;
  border: 1px solid var(--wood-brown);
  color: #e0d8b0;
  min-width: 120px;
}

.stat-value {
  font-weight: bold;
  font-size: 1.2em;
  color: var(--gold);
  text-shadow: 0 0 3px rgba(212, 175, 55, 0.5);
}

/* Health and Fury Bars */
#hp-bar, #fury-bar {
  height: 8px;
  background-color: #2a1a1a;
  margin-top: 5px;
  border-radius: 5px;
  overflow: hidden;
  border: 1px solid var(--wood-brown);
}

#hp-fill {
  height: 100%;
  background: linear-gradient(to right, #006400, var(--hp-green));
  width: 100%;
  transition: width 0.3s;
  box-shadow: 0 0 5px rgba(0, 170, 0, 0.7);
}

#fury-fill {
  height: 100%;
  background: linear-gradient(to right, #8b0000, var(--fury-orange));
  width: 100%;
  transition: width 0.3s;
  box-shadow: 0 0 5px rgba(255, 140, 0, 0.7);
}

/* Controls */
#controls {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
  padding: 15px;
  background: linear-gradient(to bottom, #1a0f0f, #0a0505);
  border-top: 2px solid var(--wood-brown);
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.7);
  position: relative;
}

button {
  padding: 12px;
  border: none;
  border-radius: 5px;
  background: linear-gradient(to bottom, #3a2a1f, #2a1a1a);
  color: #e0d8b0;
  font-family: 'MedievalSharp', cursive;
  font-size: 1em;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
  border: 1px solid var(--wood-brown);
  text-shadow: 0 0 3px rgba(0, 0, 0, 0.7);
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
}

button::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(to bottom, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05));
  opacity: 0;
  transition: opacity 0.2s;
}

button:hover::before {
  opacity: 1;
}

button:active {
  transform: translateY(2px);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  background: linear-gradient(to bottom, #2a2a2a, #1a1a1a);
}

/* Special Ability Button */
#special-ability {
  background: linear-gradient(to bottom, #8b0000, #5a0000);
  grid-column: span 3;
  font-weight: bold;
  letter-spacing: 1px;
}

#special-ability.available {
  background: linear-gradient(to bottom, var(--gold), #8b6500);
  color: #1a0f0f;
  animation: pulse 2s infinite;
  text-shadow: none;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
  100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
}

/* Floating Action Buttons */
.floating-btn {
  position: absolute;
  bottom: 90px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(to bottom, #3a2a1f, #2a1a1a);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5em;
  z-index: 5;
  transition: transform 0.2s;
  border: 1px solid var(--wood-brown);
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
  cursor: pointer;
}

.floating-btn:hover {
  transform: scale(1.1);
  background: linear-gradient(to bottom, #4a3a2f, #3a2a1f);
}

#inventory-btn {
  right: 10px;
}

#crafting-btn {
  right: 70px;
}

#skills-btn {
  right: 130px;
}

.floating-btn::after {
  content: attr(data-count);
  position: absolute;
  top: -5px;
  right: -5px;
  background: linear-gradient(to bottom, var(--blood-red), #8b0000);
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 0.7em;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--wood-brown);
}

/* Panels (Inventory, Crafting, Skills) */
.panel {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(10, 5, 5, 0.95);
  display: none;
  flex-direction: column;
  z-index: 15;
  padding: 15px;
  box-sizing: border-box;
  border: 2px solid var(--wood-brown);
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--wood-brown);
}

.panel-header h2 {
  color: var(--gold);
  font-family: 'Cinzel Decorative', cursive;
  text-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
  margin: 0;
}

.panel-count {
  font-size: 0.9em;
  color: #e0d8b0;
  margin-left: 10px;
}

.panel-count.full {
  color: var(--blood-red);
}

.close-panel {
  padding: 8px 15px;
  background: linear-gradient(to bottom, #3a2a1f, #2a1a1a);
  border: 1px solid var(--wood-brown);
}

/* Inventory Items */
#inventory-items {
  flex: 1;
  overflow-y: auto;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  padding: 5px;
}

.item {
  padding: 10px;
  margin-bottom: 8px;
  background: linear-gradient(to bottom, #2a1a1a, #1a0f0f);
  border-left: 3px solid var(--wood-brown);
  display: flex;
  flex-direction: column;
  position: relative;
  transition: transform 0.2s;
  border-radius: 5px;
  border: 1px solid #3a1a1a;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
}

.item:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5);
  background: linear-gradient(to bottom, #3a2a1f, #2a1a1a);
}

.current-weapon {
  background: linear-gradient(to bottom, #3a2a1f, #2a1a1a);
  border-left: 3px solid var(--gold);
  grid-column: span 2;
}

.better-weapon {
  border-left: 3px solid var(--hp-green);
  animation: pulse-green 2s infinite;
}

@keyframes pulse-green {
  0% { box-shadow: 0 0 0 0 rgba(0, 170, 0, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(0, 170, 0, 0); }
  100% { box-shadow: 0 0 0 0 rgba(0, 170, 0, 0); }
}

.rare-item {
  border-left: 3px solid var(--gold);
  animation: pulse-gold 2s infinite;
}

@keyframes pulse-gold {
  0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
  100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
}

.legendary-item {
  border-left: 3px solid var(--curse-purple);
  animation: pulse-purple 2s infinite;
}

@keyframes pulse-purple {
  0% { box-shadow: 0 0 0 0 rgba(171, 71, 188, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(171, 71, 188, 0); }
  100% { box-shadow: 0 0 0 0 rgba(171, 71, 188, 0); }
}

.item-name {
  font-weight: bold;
  margin-bottom: 5px;
  color: var(--gold);
  font-family: 'Cinzel Decorative', cursive;
}

.item-description {
  font-size: 0.9em;
  color: #a0a0a0;
  margin-bottom: 5px;
  font-style: italic;
}

.item-stats {
  font-size: 0.8em;
  color: #a0a0a0;
  margin-bottom: 10px;
}

.item-actions {
  display: flex;
  gap: 10px;
  margin-top: auto;
}

.item-use, .item-equip, .item-discard {
  padding: 5px 10px;
  border-radius: 3px;
  font-size: 0.8em;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
  font-family: 'MedievalSharp', cursive;
  text-shadow: 0 0 3px rgba(0, 0, 0, 0.7);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.item-use {
  background: linear-gradient(to bottom, #2e7d32, #1b5e20);
  color: white;
}

.item-use:hover {
  background: linear-gradient(to bottom, #3e8d42, #2b6e30);
}

.item-equip {
  background: linear-gradient(to bottom, #5d4037, #3e2723);
  color: white;
}

.item-equip:hover {
  background: linear-gradient(to bottom, #6d5047, #4e3733);
}

.item-discard {
  background: linear-gradient(to bottom, var(--blood-red), #b71c1c);
  color: white;
}

.item-discard:hover {
  background: linear-gradient(to bottom, #d63838, #c72c2c);
}

.equipped {
  background: linear-gradient(to bottom, var(--gold), #8b6500);
  color: #1a0f0f;
  cursor: default;
  text-shadow: none;
}

.disabled-action {
  background: linear-gradient(to bottom, #424242, #323232) !important;
  color: #757575 !important;
  cursor: not-allowed !important;
}

/* Crafting Recipes */
#crafting-recipes {
  flex: 1;
  overflow-y: auto;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  padding: 5px;
}

.recipe {
  padding: 10px;
  background: linear-gradient(to bottom, #2a1a1a, #1a0f0f);
  border-left: 3px solid var(--wood-brown);
  display: flex;
  flex-direction: column;
  border-radius: 5px;
  border: 1px solid #3a1a1a;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
}

.recipe-name {
  font-weight: bold;
  margin-bottom: 5px;
  color: var(--gold);
  font-family: 'Cinzel Decorative', cursive;
}

.recipe-ingredients {
  font-size: 0.9em;
  margin-bottom: 10px;
  color: #a0a0a0;
}

.recipe-result {
  font-size: 0.9em;
  margin-bottom: 10px;
  color: #a5d6a7;
}

.recipe-craft {
  padding: 5px 10px;
  background: linear-gradient(to bottom, #5d4037, #3e2723);
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  margin-top: auto;
  font-family: 'MedievalSharp', cursive;
}

.recipe-craft:hover {
  background: linear-gradient(to bottom, #6d5047, #4e3733);
}

.recipe-craft:disabled {
  background: linear-gradient(to bottom, #424242, #323232);
  color: #757575;
  cursor: not-allowed;
}

/* Skills Panel */
#skills-tree {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.skill-category {
  background: linear-gradient(to bottom, #2a1a1a, #1a0f0f);
  padding: 10px;
  border-radius: 5px;
  border: 1px solid var(--wood-brown);
}

.skill-category h3 {
  color: var(--gold);
  font-family: 'Cinzel Decorative', cursive;
  margin-bottom: 10px;
  border-bottom: 1px solid var(--wood-brown);
  padding-bottom: 5px;
}

.skill {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
  padding: 5px;
  border-radius: 3px;
  background: rgba(26, 15, 15, 0.5);
}

.skill-icon {
  width: 30px;
  height: 30px;
  background-color: var(--wood-brown);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 10px;
  font-size: 0.9em;
}

.skill-info {
  flex: 1;
}

.skill-name {
  font-weight: bold;
  color: var(--gold);
}

.skill-desc {
  font-size: 0.8em;
  color: #a0a0a0;
}

.skill-unlock {
  padding: 5px 10px;
  background: linear-gradient(to bottom, #5d4037, #3e2723);
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  font-size: 0.8em;
  font-family: 'MedievalSharp', cursive;
}

.skill-unlock:hover {
  background: linear-gradient(to bottom, #6d5047, #4e3733);
}

.skill-unlock:disabled {
  background: linear-gradient(to bottom, #424242, #323232);
  color: #757575;
  cursor: not-allowed;
}

.skill-unlocked {
  background: linear-gradient(to bottom, var(--gold), #8b6500);
  color: #1a0f0f;
  cursor: default;
}

/* Game Over Screen */
#game-over {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.9);
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 20;
  text-align: center;
  background-image: url('https://images.unsplash.com/photo-1518709268805-4e9042af9f23?ixlib=rb-1.2.1&auto=format&fit=crop&w=1489&q=80');
  background-size: cover;
  background-position: center;
  background-blend-mode: multiply;
}

#game-over h1 {
  color: var(--blood-red);
  font-size: 3em;
  margin-bottom: 20px;
  text-shadow: 0 0 10px #8b0000;
  animation: pulse-red 1.5s infinite;
  font-family: 'Cinzel Decorative', cursive;
  letter-spacing: 3px;
}

@keyframes pulse-red {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

#death-message {
  font-size: 1.2em;
  margin-bottom: 30px;
  max-width: 80%;
  color: #e0d8b0;
  font-style: italic;
  text-shadow: 0 0 5px rgba(0, 0, 0, 0.7);
}

#stats-summary {
  margin-bottom: 30px;
  background-color: rgba(26, 15, 15, 0.8);
  padding: 15px;
  border-radius: 5px;
  width: 80%;
  max-width: 400px;
  border: 2px solid var(--wood-brown);
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
}

#stats-summary div {
  margin-bottom: 5px;
  color: #e0d8b0;
}

#stats-summary span {
  color: var(--gold);
  font-weight: bold;
}

#restart-btn {
  padding: 15px 30px;
  font-size: 1.2em;
  background: linear-gradient(to bottom, var(--blood-red), #8b0000);
  border: none;
  border-radius: 5px;
  color: white;
  cursor: pointer;
  transition: all 0.2s;
  font-family: 'Cinzel Decorative', cursive;
  border: 1px solid var(--wood-brown);
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
  text-transform: uppercase;
  letter-spacing: 1px;
}

#restart-btn:hover {
  background: linear-gradient(to bottom, #d00000, #9b0000);
  transform: scale(1.05);
}

/* Achievements Panel */
#achievements-panel {
  position: absolute;
  top: 120px;
  right: 10px;
  z-index: 5;
}

#achievements-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(to bottom, #3a2a1f, #2a1a1a);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2em;
  cursor: pointer;
  transition: transform 0.2s;
  border: 1px solid var(--wood-brown);
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
}

#achievements-btn:hover {
  transform: scale(1.1);
  background: linear-gradient(to bottom, #4a3a2f, #3a2a1f);
}

#achievements-list {
  position: absolute;
  top: 50px;
  right: 0;
  background-color: rgba(26, 15, 15, 0.95);
  padding: 10px;
  border-radius: 5px;
  width: 250px;
  max-height: 300px;
  overflow-y: auto;
  display: none;
  z-index: 100;
  border: 2px solid var(--wood-brown);
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
}

.achievement {
  margin-bottom: 10px;
  padding: 8px;
  background: linear-gradient(to bottom, #2a1a1a, #1a0f0f);
  border-left: 3px solid var(--wood-brown);
  border-radius: 3px;
}

.achievement.unlocked {
  border-left: 3px solid var(--gold);
}

.achievement-name {
  font-weight: bold;
  margin-bottom: 5px;
  color: #e0d8b0;
  font-family: 'Cinzel Decorative', cursive;
}

.achievement-desc {
  font-size: 0.8em;
  color: #a0a0a0;
}

.achievement-progress {
  height: 3px;
  background-color: #2a1a1a;
  margin-top: 5px;
  border-radius: 3px;
  overflow: hidden;
}

.achievement-progress-fill {
  height: 100%;
  background: linear-gradient(to right, #006400, var(--hp-green));
  width: 0%;
}

/* Settings Panel */
#settings-panel {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 5;
}

#settings-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(to bottom, #3a2a1f, #2a1a1a);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2em;
  cursor: pointer;
  transition: transform 0.2s;
  border: 1px solid var(--wood-brown);
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
}

#settings-btn:hover {
  transform: scale(1.1);
  background: linear-gradient(to bottom, #4a3a2f, #3a2a1f);
}

#settings-menu {
  position: absolute;
  top: 50px;
  left: 0;
  background-color: rgba(26, 15, 15, 0.95);
  padding: 10px;
  border-radius: 5px;
  width: 200px;
  display: none;
  z-index: 100;
  border: 2px solid var(--wood-brown);
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
}

.settings-option {
  margin-bottom: 10px;
  color: #e0d8b0;
}

.settings-option label {
  display: flex;
  align-items: center;
  cursor: pointer;
  font-size: 0.9em;
}

.settings-option input {
  margin-right: 8px;
}

#sound-toggle, #music-toggle {
  width: 20px;
  height: 20px;
  accent-color: var(--wood-brown);
}

#volume-slider {
  width: 100%;
  margin-top: 5px;
  accent-color: var(--wood-brown);
}

#tutorial-btn {
  width: 100%;
  margin-top: 10px;
  background: linear-gradient(to bottom, #3a2a1f, #2a1a1a);
  border: 1px solid var(--wood-brown);
}

/* Tutorial Panel */
#tutorial-panel {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.9);
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 30;
  text-align: center;
  padding: 20px;
  box-sizing: border-box;
}

#tutorial-content {
  max-width: 600px;
  background: linear-gradient(to bottom, #2a1a1a, #1a0f0f);
  padding: 20px;
  border-radius: 10px;
  max-height: 80vh;
  overflow-y: auto;
  border: 2px solid var(--wood-brown);
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
}

#tutorial-content h2 {
  color: var(--gold);
  margin-top: 0;
  font-family: 'Cinzel Decorative', cursive;
  border-bottom: 1px solid var(--wood-brown);
  padding-bottom: 10px;
}

#tutorial-content h3 {
  color: var(--gold);
  font-family: 'Cinzel Decorative', cursive;
  margin-top: 20px;
}

#tutorial-content p {
  margin-bottom: 15px;
  line-height: 1.5;
  color: #e0d8b0;
}

#tutorial-content ul {
  text-align: left;
  margin-bottom: 15px;
  padding-left: 20px;
  color: #e0d8b0;
}

#tutorial-content li {
  margin-bottom: 5px;
}

#close-tutorial {
  padding: 10px 20px;
  margin-top: 15px;
  background: linear-gradient(to bottom, #5d4037, #3e2723);
  border: 1px solid var(--wood-brown);
  border-radius: 5px;
  color: white;
  cursor: pointer;
  font-family: 'Cinzel Decorative', cursive;
}

/* Combo Display */
#combo-display {
  position: absolute;
  top: 10px;
  right: 60px;
  background: linear-gradient(to bottom, #2a1a1a, #1a0f0f);
  padding: 5px 10px;
  border-radius: 15px;
  font-size: 0.9em;
  display: none;
  z-index: 5;
  border: 1px solid var(--wood-brown);
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
  color: var(--gold);
  font-weight: bold;
}

.combo-active {
  animation: comboPulse 0.5s infinite alternate;
}

@keyframes comboPulse {
  from { box-shadow: 0 0 5px rgba(212, 175, 55, 0.5); }
  to { box-shadow: 0 0 15px rgba(212, 175, 55, 0.8); }
}

/* Animations */
.enemy-attack-animation {
  animation: enemyAttack 0.3s;
}

@keyframes enemyAttack {
  0% { transform: translateX(0); }
  50% { transform: translateX(-10px); }
  100% { transform: translateX(0); }
}

.player-attack-animation {
  animation: playerAttack 0.3s;
}

@keyframes playerAttack {
  0% { transform: translateX(0); }
  50% { transform: translateX(10px); }
  100% { transform: translateX(0); }
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: #1a0f0f;
}

::-webkit-scrollbar-thumb {
  background: var(--wood-brown);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #6a4030;
}

/* Responsive adjustments */
@media (max-width: 600px) {
  #header {
    font-size: 1em;
  }

  .stat-value {
    font-size: 1em;
  }

  #main-display {
    font-size: 1em;
  }

  button {
    padding: 10px;
    font-size: 0.9em;
  }

  #inventory-items, #crafting-recipes {
    grid-template-columns: 1fr;
  }
  
  #combo-display {
    right: 50px;
    font-size: 0.8em;
  }
  
  #achievements-list {
    width: 200px;
  }
  
  #settings-menu {
    width: 180px;
  }
  
  .floating-btn {
    width: 40px;
    height: 40px;
    font-size: 1.2em;
  }
  
  #inventory-btn {
    right: 10px;
    bottom: 80px;
  }
  
  #crafting-btn {
    right: 60px;
    bottom: 80px;
  }
  
  #skills-btn {
    right: 110px;
    bottom: 80px;
  }
}
</style>
</head>
<body>
<div id="game-container">
<!-- Settings Panel -->
<div id="settings-panel">
  <button id="settings-btn">⚙️</button>
  <div id="settings-menu">
    <div class="settings-option">
      <label>
        <input type="checkbox" id="sound-toggle" checked> Sound Effects
      </label>
    </div>
    <div class="settings-option">
      <label>
        <input type="checkbox" id="music-toggle" checked> Background Music
      </label>
    </div>
    <div class="settings-option">
      <label>
        <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5">
        Volume
      </label>
    </div>
    <button id="tutorial-btn" style="width: 100%; margin-top: 10px;">Show Tutorial</button>
  </div>
</div>

<!-- Achievements Panel -->
<div id="achievements-panel">
  <button id="achievements-btn">🏆</button>
  <div id="achievements-list">
    <!-- Achievements will be added here dynamically -->
  </div>
</div>

<!-- Combo Display -->
<div id="combo-display">
  Combo: <span id="combo-count">0</span>x
</div>

<!-- Header -->
<div id="header">
  <span id="transformation-status">Werewolf</span>
  <span id="equipped-weapon">Equipped: Claws</span>
  <div id="moon-phase-container">
    <div id="moon-phase" title="Waxing Crescent"></div>
    <span id="day-night-indicator">Night</span>
  </div>
</div>

<!-- Stats Panel -->
<div id="stats-panel">
  <div class="stat-box">
    <div>Floor</div>
    <div class="stat-value" id="floor">1</div>
    <div class="stat-tooltip">Current dungeon floor</div>
  </div>
  <div class="stat-box">
    <div>Level</div>
    <div class="stat-value" id="level">1</div>
    <div class="stat-tooltip">Your character level</div>
  </div>
  <div class="stat-box">
    <div>HP</div>
    <div class="stat-value" id="hp">25/25</div>
    <div id="hp-bar"><div id="hp-fill"></div></div>
    <div class="stat-tooltip">Hit Points</div>
  </div>
  <div class="stat-box">
    <div>Fury</div>
    <div class="stat-value" id="fury">0/100</div>
    <div id="fury-bar"><div id="fury-fill"></div></div>
    <div class="stat-tooltip">Build Fury for special attacks</div>
  </div>
  <div class="stat-box">
    <div>Kills</div>
    <div class="stat-value" id="kills">0</div>
    <div class="stat-tooltip">Total enemies defeated</div>
  </div>
</div>

<!-- Enemy Stats -->
<div id="enemy-stats">
  <div class="enemy-health-container">
    <div id="enemy-name" class="enemy-name">No Enemy</div>
    <div id="enemy-hp" class="enemy-hp">HP: 0/0</div>
    <div id="enemy-hp-bar"><div id="enemy-hp-fill"></div></div>
  </div>
  <div id="enemy-dmg" class="enemy-dmg">DMG: 0-0</div>
  <div id="enemy-weakness" class="enemy-weakness" style="display: none;"></div>
</div>

<!-- Main Display -->
<div id="main-display">
  <div id="combat-log">
    <div class="system-message combat-entry">The full moon rises over the cursed village...</div>
    <div class="system-message combat-entry">You feel the transformation beginning.</div>
    <div class="combat-entry">You encounter a terrified villager!</div>
  </div>
</div>

<!-- Controls -->
<div id="controls">
  <button id="attack-btn">Attack</button>
  <button id="howl-btn">Howl</button>
  <button id="rest-btn">Rest</button>
  <button id="special-ability">Lunar Frenzy (0/100)</button>
</div>

<!-- Floating Action Buttons -->
<button id="inventory-btn" class="floating-btn" data-count="3">🎒</button>
<button id="crafting-btn" class="floating-btn">⚒️</button>
<button id="skills-btn" class="floating-btn">📜</button>

<!-- Inventory Panel -->
<div id="inventory-panel" class="panel">
  <div class="panel-header">
    <h2>Inventory <span id="inventory-count">0/10</span></h2>
    <button class="close-panel" id="close-inventory">Close</button>
  </div>
  <div id="inventory-items">
    <!-- Items will be added here dynamically -->
  </div>
</div>

<!-- Crafting Panel -->
<div id="crafting-panel" class="panel">
  <div class="panel-header">
    <h2>Crafting Recipes</h2>
    <button class="close-panel" id="close-crafting">Close</button>
  </div>
  <div id="crafting-recipes">
    <!-- Recipes will be added here dynamically -->
  </div>
</div>

<!-- Skills Panel -->
<div id="skills-panel" class="panel">
  <div class="panel-header">
    <h2>Werewolf Skills</h2>
    <button class="close-panel" id="close-skills">Close</button>
  </div>
  <div id="skills-tree">
    <!-- Skills will be added here dynamically -->
  </div>
</div>

<!-- Game Over Screen -->
<div id="game-over">
  <h1>YOU DIED</h1>
  <div id="death-message">The villagers finally put you down with silver bullets.</div>
  <div id="stats-summary">
    <div>Floor Reached: <span id="final-floor">1</span></div>
    <div>Level Achieved: <span id="final-level">1</span></div>
    <div>Enemies Slain: <span id="final-kills">0</span></div>
    <div>Highest Combo: <span id="final-combo">0</span>x</div>
    <div>Achievements Unlocked: <span id="final-achievements">0</span>/15</div>
  </div>
  <button id="restart-btn">Restart</button>
</div>

<!-- Tutorial Panel -->
<div id="tutorial-panel">
  <div id="tutorial-content">
    <h2>Wolfman's Curse - Game Guide</h2>
    <p>As a cursed werewolf, you must survive as long as possible against the villagers who hunt you.</p>

    <h3>Gameplay Basics</h3>
    <ul>
      <li><strong>Attack</strong>: Deal damage to the enemy. Builds Fury.</li>
      <li><strong>Howl</strong>: Intimidate the enemy and gain Fury. Has a chance to stun.</li>
      <li><strong>Rest</strong>: Recover HP but skip your turn.</li>
      <li><strong>Lunar Frenzy</strong>: When Fury reaches 100, unleash a powerful attack that heals you.</li>
    </ul>

    <h3>Werewolf & Human Forms</h3>
    <p>The moon phase affects your transformation:</p>
    <ul>
      <li><strong>Full Moon</strong>: You're in powerful werewolf form.</li>
      <li><strong>New Moon</strong>: You revert to weaker human form.</li>
      <li>Other phases gradually transition between forms.</li>
    </ul>

    <h3>Combat System</h3>
    <ul>
      <li><strong>Combo Attacks</strong>: Consecutive attacks build combo multipliers for extra damage.</li>
      <li><strong>Critical Hits</strong>: 20% chance for 1.5x damage.</li>
      <li><strong>Dodging</strong>: 10% chance to avoid enemy attacks.</li>
      <li><strong>Perfect Fights</strong>: Defeat enemies without taking damage for bonus achievements.</li>
    </ul>

    <h3>Inventory & Crafting</h3>
    <p>Collect items from defeated enemies:</p>
    <ul>
      <li><strong>Weapons</strong>: Equip for more damage (werewolf form only).</li>
      <li><strong>Consumables</strong>: Health potions, fury elixirs, etc.</li>
      <li><strong>Crafting</strong>: Combine materials to create powerful items.</li>
    </ul>

    <h3>Progression</h3>
    <ul>
      <li>Defeat enemies to gain XP and level up.</li>
      <li>Each level increases your stats.</li>
      <li>Every 5 floors increases your max HP.</li>
      <li>Unlock achievements for special challenges.</li>
    </ul>

    <button id="close-tutorial">I'm Ready!</button>
  </div>
</div>

<!-- Audio elements -->
<audio id="attack-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-sword-attack-1686.mp3" preload="auto"></audio>
<audio id="howl-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-werewolf-howling-1720.mp3" preload="auto"></audio>
<audio id="lunar-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-magic-spell-689.mp3" preload="auto"></audio>
<audio id="item-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" preload="auto"></audio>
<audio id="levelup-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3" preload="auto"></audio>
<audio id="death-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-retro-arcade-lose-2027.mp3" preload="auto"></audio>
<audio id="background-music" loop src="https://assets.mixkit.co/music/preview/mixkit-dark-ambient-1243.mp3" preload="auto"></audio>
<audio id="crit-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" preload="auto"></audio>
<audio id="combo-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-extra-bonus-in-a-video-game-2045.mp3" preload="auto"></audio>
</div>

<script>
// Enhanced Game State
const gameState = {
  floor: 1,
  level: 1,
  xp: 0,
  maxXp: 100,
  baseMinDmg: 0,
  baseMaxDmg: 0,
  maxHp: 25,
  currentHp: 25,
  fury: 0,
  maxFury: 100,
  isTransformed: true,
  hasSilverAmulet: false,
  isCursed: false,
  curseTurns: 0,
  hasMoonstoneBoost: false,
  moonstoneTurns: 0,
  equippedWeapon: { name: "Claws", minDmg: 5, maxDmg: 10, durability: Infinity },
  inventory: [
    { name: "Silver Amulet", description: "Reduces damage taken by 2 in human form", type: "trinket", rarity: "rare" },
    { name: "Health Potion", description: "Restores 10 HP", type: "consumable", rarity: "common" },
    { name: "Rusty Dagger", type: "weapon", minDmg: 3, maxDmg: 8, durability: 10, description: "3-8 DMG, 10 uses", rarity: "common" }
  ],
  enemiesDefeated: 0,
  moonPhases: ["New Moon", "Waxing Crescent", "First Quarter", "Waxing Gibbous", "Full Moon", "Waning Gibbous", "Last Quarter", "Waning Crescent"],
  currentMoonPhase: 4, // Full Moon
  gameActive: true,
  achievements: {
    firstBlood: { unlocked: false, name: "First Blood", description: "Defeat your first enemy", progress: 0, target: 1 },
    silverSlayer: { unlocked: false, name: "Silver Slayer", description: "Defeat a Werewolf Hunter", progress: 0, target: 1 },
    cursedOne: { unlocked: false, name: "Cursed One", description: "Survive 10 floors", progress: 0, target: 10 },
    moonChild: { unlocked: false, name: "Moon Child", description: "Reach level 5", progress: 0, target: 5 },
    packLeader: { unlocked: false, name: "Pack Leader", description: "Defeat 50 enemies", progress: 0, target: 50 },
    lunarFury: { unlocked: false, name: "Lunar Fury", description: "Use Lunar Frenzy 5 times", progress: 0, target: 5 },
    collector: { unlocked: false, name: "Collector", description: "Collect 20 items", progress: 3, target: 20 },
    artisan: { unlocked: false, name: "Artisan", description: "Craft 5 items", progress: 0, target: 5 },
    survivor: { unlocked: false, name: "Survivor", description: "Reach floor 20", progress: 0, target: 20 },
    cursedHunter: { unlocked: false, name: "Cursed Hunter", description: "Defeat 5 witches", progress: 0, target: 5 },
    moonstoneMaster: { unlocked: false, name: "Moonstone Master", description: "Use 5 Moonstone Shards", progress: 0, target: 5 },
    legend: { unlocked: false, name: "Legend", description: "Reach floor 30", progress: 0, target: 30 },
    comboKing: { unlocked: false, name: "Combo King", description: "Achieve a 10x combo", progress: 0, target: 10 },
    perfectHunter: { unlocked: false, name: "Perfect Hunter", description: "Defeat an enemy without taking damage", progress: 0, target: 1 },
    masterTransmuter: { unlocked: false, name: "Master Transmuter", description: "Craft all possible items", progress: 0, target: 5 },
    alphaWolf: { unlocked: false, name: "Alpha Wolf", description: "Unlock all skills", progress: 0, target: 10 }
  },
  soundsEnabled: true,
  musicEnabled: true,
  volume: 0.5,
  lunarFrenzyUsed: 0,
  witchesDefeated: 0,
  moonstonesUsed: 0,
  itemsCrafted: 0,
  currentCombo: 0,
  highestCombo: 0,
  lastAction: null,
  perfectKills: 0,
  craftedItems: [],
  skillPoints: 0,
  unlockedSkills: [],
  currentDay: 1,
  isDaytime: false,
  reputation: 0,
  bossDefeated: false,
  // New skill-related properties
  skills: {
    savageStrikes: { unlocked: false, name: "Savage Strikes", description: "Increases critical hit chance by 10%", cost: 1 },
    lunarConnection: { unlocked: false, name: "Lunar Connection", description: "Gain more Fury during full moon", cost: 1 },
    thickHide: { unlocked: false, name: "Thick Hide", description: "Reduces damage taken by 1", cost: 2 },
    primalHowl: { unlocked: false, name: "Primal Howl", description: "Howl has 100% chance to stun", cost: 3 },
    bloodlust: { unlocked: false, name: "Bloodlust", description: "Heal for 10% of damage dealt", cost: 2 },
    moonBlessing: { unlocked: false, name: "Moon Blessing", description: "Stay transformed for 1 extra floor", cost: 2 },
    silverResistance: { unlocked: false, name: "Silver Resistance", description: "Take 50% less damage from silver", cost: 3 },
    berserker: { unlocked: false, name: "Berserker", description: "Deal more damage at low HP", cost: 2 },
    packTactics: { unlocked: false, name: "Pack Tactics", description: "Combo bonus increased by 50%", cost: 2 },
    lunarMastery: { unlocked: false, name: "Lunar Mastery", description: "Lunar Frenzy deals 25% more damage", cost: 3 }
  }
};

// Enhanced Enemy Types with Weaknesses
const enemies = [
  {
    name: "Terrified Villager",
    hp: 15,
    minDmg: 2,
    maxDmg: 5,
    xp: 10,
    special: null,
    weakness: null,
    resistance: null,
    lootChance: 0.7
  },
  {
    name: "Village Guard",
    hp: 25,
    minDmg: 4,
    maxDmg: 8,
    xp: 20,
    special: "block",
    weakness: "howl",
    resistance: "slash",
    lootChance: 0.6
  },
  {
    name: "Hunter",
    hp: 30,
    minDmg: 6,
    maxDmg: 12,
    xp: 30,
    special: "trap",
    weakness: "lunge",
    resistance: "howl",
    lootChance: 0.5
  },
  {
    name: "Priest",
    hp: 20,
    minDmg: 3,
    maxDmg: 10,
    xp: 25,
    special: "blessing",
    weakness: "slash",
    resistance: "curse",
    lootChance: 0.6
  },
  {
    name: "Werewolf Hunter",
    hp: 40,
    minDmg: 8,
    maxDmg: 15,
    xp: 50,
    special: "silver",
    weakness: null,
    resistance: "silver",
    lootChance: 0.4
  },
  {
    name: "Witch",
    hp: 25,
    minDmg: 5,
    maxDmg: 10,
    xp: 35,
    special: "curse",
    weakness: "howl",
    resistance: "curse",
    lootChance: 0.5
  },
  // Boss enemies
  {
    name: "Village Elder",
    hp: 80,
    minDmg: 10,
    maxDmg: 20,
    xp: 100,
    special: "summon",
    weakness: "lunge",
    resistance: "slash",
    lootChance: 1.0,
    isBoss: true
  },
  {
    name: "Inquisitor",
    hp: 100,
    minDmg: 15,
    maxDmg: 25,
    xp: 150,
    special: "silverstorm",
    weakness: null,
    resistance: "silver",
    lootChance: 1.0,
    isBoss: true
  }
];

// Expanded Weapons List
const weapons = [
  { name: "Rusty Dagger", type: "weapon", minDmg: 3, maxDmg: 8, durability: 10, description: "3-8 DMG, 10 uses", rarity: "common" },
  { name: "Iron Sword", type: "weapon", minDmg: 6, maxDmg: 12, durability: 15, description: "6-12 DMG, 15 uses", rarity: "uncommon" },
  { name: "Silver Axe", type: "weapon", minDmg: 8, maxDmg: 15, durability: 12, description: "8-15 DMG, 12 uses", rarity: "rare" },
  { name: "Moonlit Scythe", type: "weapon", minDmg: 10, maxDmg: 18, durability: 8, description: "10-18 DMG, 8 uses", rarity: "rare" },
  { name: "Silver Claws", type: "weapon", minDmg: 12, maxDmg: 20, durability: 5, description: "12-20 DMG, 5 uses (Legendary)", rarity: "legendary" },
  { name: "Fang of Fenrir", type: "weapon", minDmg: 15, maxDmg: 25, durability: 10, description: "15-25 DMG, 10 uses (Mythic)", rarity: "mythic" }
];

// Expanded Crafting Recipes
const craftingRecipes = [
  {
    name: "Bloodlust Tonic",
    ingredients: [{name: "Wolf Pelt", quantity: 2}, {name: "Glass Vial", quantity: 1}],
    result: {name: "Bloodlust Tonic", type: "consumable", description: "Grants 50 Fury", rarity: "uncommon"}
  },
  {
    name: "Moonstone Shard",
    ingredients: [{name: "Moon Dust", quantity: 3}, {name: "Silver Ore", quantity: 1}],
    result: {name: "Moonstone Shard", type: "consumable", description: "Boosts damage by 30% for 3 turns", rarity: "rare"}
  },
  {
    name: "Silver Amulet",
    ingredients: [{name: "Silver Ore", quantity: 1}, {name: "Leather Strap", quantity: 1}],
    result: {name: "Silver Amulet", type: "trinket", description: "Reduces damage taken by 2 in human form", rarity: "rare"}
  },
  {
    name: "Iron Sword",
    ingredients: [{name: "Iron Ingot", quantity: 2}, {name: "Wooden Handle", quantity: 1}],
    result: {name: "Iron Sword", type: "weapon", minDmg: 6, maxDmg: 12, durability: 15, description: "6-12 DMG, 15 uses", rarity: "uncommon"}
  },
  {
    name: "Health Potion",
    ingredients: [{name: "Medicinal Herb", quantity: 2}, {name: "Glass Vial", quantity: 1}],
    result: {name: "Health Potion", type: "consumable", description: "Restores 10 HP", rarity: "common"}
  },
  {
    name: "Moonlight Greatsword",
    ingredients: [{name: "Moonstone Shard", quantity: 2}, {name: "Iron Ingot", quantity: 3}, {name: "Silver Ore", quantity: 2}],
    result: {name: "Moonlight Greatsword", type: "weapon", minDmg: 15, maxDmg: 25, durability: 10, description: "15-25 DMG, 10 uses (Mythic)", rarity: "mythic"}
  }
];

// Current enemy
let currentEnemy = null;
let perfectFight = true;
let attackType = "slash"; // Can be "slash", "lunge", or "howl"

// DOM elements
const combatLog = document.getElementById('combat-log');
const floorDisplay = document.getElementById('floor');
const levelDisplay = document.getElementById('level');
const hpDisplay = document.getElementById('hp');
const hpFill = document.getElementById('hp-fill');
const furyDisplay = document.getElementById('fury');
const furyFill = document.getElementById('fury-fill');
const killsDisplay = document.getElementById('kills');
const attackBtn = document.getElementById('attack-btn');
const howlBtn = document.getElementById('howl-btn');
const restBtn = document.getElementById('rest-btn');
const specialBtn = document.getElementById('special-ability');
const inventoryBtn = document.getElementById('inventory-btn');
const craftingBtn = document.getElementById('crafting-btn');
const skillsBtn = document.getElementById('skills-btn');
const inventoryPanel = document.getElementById('inventory-panel');
const craftingPanel = document.getElementById('crafting-panel');
const skillsPanel = document.getElementById('skills-panel');
const closeInventoryBtn = document.getElementById('close-inventory');
const closeCraftingBtn = document.getElementById('close-crafting');
const closeSkillsBtn = document.getElementById('close-skills');
const inventoryItems = document.getElementById('inventory-items');
const craftingRecipesList = document.getElementById('crafting-recipes');
const skillsTree = document.getElementById('skills-tree');
const inventoryCount = document.getElementById('inventory-count');
const gameOverPanel = document.getElementById('game-over');
const deathMessage = document.getElementById('death-message');
const restartBtn = document.getElementById('restart-btn');
const moonPhaseDisplay = document.getElementById('moon-phase');
const dayNightIndicator = document.getElementById('day-night-indicator');
const equippedWeaponDisplay = document.getElementById('equipped-weapon');
const enemyNameDisplay = document.getElementById('enemy-name');
const enemyHpDisplay = document.getElementById('enemy-hp');
const enemyHpFill = document.getElementById('enemy-hp-fill');
const enemyDmgDisplay = document.getElementById('enemy-dmg');
const enemyWeaknessDisplay = document.getElementById('enemy-weakness');
const transformationStatusDisplay = document.getElementById('transformation-status');
const finalFloorDisplay = document.getElementById('final-floor');
const finalLevelDisplay = document.getElementById('final-level');
const finalKillsDisplay = document.getElementById('final-kills');
const finalComboDisplay = document.getElementById('final-combo');
const finalAchievementsDisplay = document.getElementById('final-achievements');
const achievementsBtn = document.getElementById('achievements-btn');
const achievementsList = document.getElementById('achievements-list');
const settingsBtn = document.getElementById('settings-btn');
const settingsMenu = document.getElementById('settings-menu');
const soundToggle = document.getElementById('sound-toggle');
const musicToggle = document.getElementById('music-toggle');
const volumeSlider = document.getElementById('volume-slider');
const tutorialBtn = document.getElementById('tutorial-btn');
const tutorialPanel = document.getElementById('tutorial-panel');
const closeTutorialBtn = document.getElementById('close-tutorial');
const comboDisplay = document.getElementById('combo-display');
const comboCountDisplay = document.getElementById('combo-count');

// Audio elements
const attackSound = document.getElementById('attack-sound');
const howlSound = document.getElementById('howl-sound');
const lunarSound = document.getElementById('lunar-sound');
const itemSound = document.getElementById('item-sound');
const levelupSound = document.getElementById('levelup-sound');
const deathSound = document.getElementById('death-sound');
const critSound = document.getElementById('crit-sound');
const comboSound = document.getElementById('combo-sound');
const backgroundMusic = document.getElementById('background-music');

// Create particles for visual effects
function createParticles(x, y, color, count = 10) {
  for (let i = 0; i < count; i++) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.style.backgroundColor = color;
    particle.style.width = `${Math.random() * 5 + 2}px`;
    particle.style.height = particle.style.width;
    particle.style.left = `${x}px`;
    particle.style.top = `${y}px`;
    
    const angle = Math.random() * Math.PI * 2;
    const velocity = Math.random() * 5 + 2;
    const lifetime = Math.random() * 1000 + 500;
    
    document.body.appendChild(particle);
    
    const startTime = Date.now();
    
    function update() {
      const elapsed = Date.now() - startTime;
      const progress = elapsed / lifetime;
      
      if (progress >= 1) {
        document.body.removeChild(particle);
        return;
      }
      
      particle.style.opacity = 1 - progress;
      particle.style.transform = `translate(${Math.cos(angle) * velocity * progress * 50}px, ${Math.sin(angle) * velocity * progress * 50}px)`;
      
      requestAnimationFrame(update);
    }
    
    requestAnimationFrame(update);
  }
}

// Show damage numbers
function showDamageNumber(x, y, damage, isCritical = false) {
  const damageNumber = document.createElement('div');
  damageNumber.className = 'damage-number';
  damageNumber.textContent = damage;
  damageNumber.style.left = `${x}px`;
  damageNumber.style.top = `${y}px`;
  if (isCritical) {
    damageNumber.style.color = 'gold';
    damageNumber.style.fontSize = '2em';
  }
  
  document.body.appendChild(damageNumber);
  
  setTimeout(() => {
    document.body.removeChild(damageNumber);
  }, 1000);
}

// Play sound with current volume
function playSound(sound) {
  if (!gameState.soundsEnabled) return;
  sound.currentTime = 0;
  sound.volume = gameState.volume;
  sound.play().catch(e => console.log("Audio play failed:", e));
}

// Initialize game
function initGame() {
  gameState.floor = 1;
  gameState.level = 1;
  gameState.xp = 0;
  gameState.maxXp = 100;
  gameState.baseMinDmg = 0;
  gameState.baseMaxDmg = 0;
  gameState.maxHp = 25;
  gameState.currentHp = gameState.maxHp;
  gameState.fury = 0;
  gameState.isTransformed = true;
  gameState.hasSilverAmulet = false;
  gameState.isCursed = false;
  gameState.curseTurns = 0;
  gameState.hasMoonstoneBoost = false;
  gameState.moonstoneTurns = 0;
  gameState.equippedWeapon = { name: "Claws", minDmg: 5, maxDmg: 10, durability: Infinity };
  gameState.inventory = [
    { name: "Silver Amulet", description: "Reduces damage taken by 2 in human form", type: "trinket", rarity: "rare" },
    { name: "Health Potion", description: "Restores 10 HP", type: "consumable", rarity: "common" },
    { name: "Rusty Dagger", type: "weapon", minDmg: 3, maxDmg: 8, durability: 10, description: "3-8 DMG, 10 uses", rarity: "common" }
  ];
  gameState.enemiesDefeated = 0;
  gameState.currentMoonPhase = 4;
  gameState.gameActive = true;
  gameState.lunarFrenzyUsed = 0;
  gameState.witchesDefeated = 0;
  gameState.moonstonesUsed = 0;
  gameState.itemsCrafted = 0;
  gameState.currentCombo = 0;
  gameState.highestCombo = 0;
  gameState.lastAction = null;
  gameState.perfectKills = 0;
  gameState.craftedItems = [];
  gameState.skillPoints = 0;
  gameState.unlockedSkills = [];
  gameState.currentDay = 1;
  gameState.isDaytime = false;
  gameState.reputation = 0;
  gameState.bossDefeated = false;

  // Reset skills
  Object.keys(gameState.skills).forEach(skill => {
    gameState.skills[skill].unlocked = false;
  });

  // Reset achievements progress (but keep unlocks for persistence)
  Object.keys(gameState.achievements).forEach(key => {
    gameState.achievements[key].progress = 0;
    if (key === 'collector') gameState.achievements[key].progress = 3; // Starting items
  });

  updateDisplays();
  generateEnemy();
  gameOverPanel.style.display = 'none';
  comboDisplay.style.display = 'none';

  // Start music if enabled
  if (gameState.musicEnabled) {
    backgroundMusic.volume = gameState.volume * 0.5; // Music at half volume
    backgroundMusic.play().catch(e => console.log("Music play failed:", e));
  }

  combatLog.innerHTML = `
    <div class="system-message combat-entry">The full moon rises over the cursed village...</div>
    <div class="system-message combat-entry">You feel the transformation beginning.</div>
    <div class="system-message combat-entry">Welcome to Wolfman's Curse! As a werewolf, you battle villagers under the moon's influence. Use 'Attack' to fight, 'Howl' to gain Fury, 'Rest' to recover HP (but skip a turn), and 'Lunar Frenzy' when Fury reaches 100 for a powerful attack. The Full Moon keeps you transformed, but other phases revert you to human form, limiting you to fists. Collect items and weapons in your inventory &#x1F392;, max 10 items) to aid your survival. Defeat enemies to gain XP and level up, increasing your strength. Survive as many floors as you can!</div>
  `;

  addLogEntry(`You encounter a ${currentEnemy.name}!`, 'system');
  updateAchievements();
  updateCraftingRecipes();
  updateSkillsTree();

  // Show tutorial on first play
  if (!localStorage.getItem('tutorialShown')) {
    tutorialPanel.style.display = 'flex';
    localStorage.setItem('tutorialShown', 'true');
  }
}

// Update all displays
function updateDisplays() {
  floorDisplay.textContent = gameState.floor;
  levelDisplay.textContent = gameState.level;
  hpDisplay.textContent = `${gameState.currentHp}/${gameState.maxHp}`;
  hpFill.style.width = `${(gameState.currentHp / gameState.maxHp) * 100}%`;
  furyDisplay.textContent = `${gameState.fury}/${gameState.maxFury}`;
  furyFill.style.width = `${(gameState.fury / gameState.maxFury) * 100}%`;
  killsDisplay.textContent = gameState.enemiesDefeated;
  specialBtn.textContent = `Lunar Frenzy (${gameState.fury}/${gameState.maxFury})`;
  equippedWeaponDisplay.textContent = `Equipped: ${gameState.equippedWeapon.name}${gameState.equippedWeapon.durability !== Infinity ? ` (${gameState.equippedWeapon.durability} uses)` : ''}${gameState.hasMoonstoneBoost ? ` [+Moonstone]` : ''}`;
  transformationStatusDisplay.textContent = gameState.isTransformed ? "Werewolf" : "Human";
  inventoryBtn.setAttribute('data-count', gameState.inventory.length);
  dayNightIndicator.textContent = gameState.isDaytime ? "Day" : "Night";

  // Update moon phase display
  moonPhaseDisplay.title = gameState.moonPhases[gameState.currentMoonPhase];
  updateMoonPhaseVisual();

  // Update body class for background effects
  document.body.className = '';
  if (gameState.currentMoonPhase === 4) {
    document.body.classList.add('full-moon');
  } else if (gameState.currentMoonPhase === 0) {
    document.body.classList.add('new-moon');
  }

  if (currentEnemy) {
    enemyNameDisplay.textContent = currentEnemy.name;
    enemyHpDisplay.textContent = `HP: ${Math.max(0, currentEnemy.currentHp)}/${currentEnemy.hp}`;
    enemyHpFill.style.width = `${(currentEnemy.currentHp / currentEnemy.hp) * 100}%`;
    enemyDmgDisplay.textContent = `DMG: ${currentEnemy.minDmg}-${currentEnemy.maxDmg}`;
    
    // Show enemy weakness if known
    if (gameState.level >= 3 || gameState.enemiesDefeated > 10) {
      if (currentEnemy.weakness) {
        enemyWeaknessDisplay.style.display = 'block';
        enemyWeaknessDisplay.textContent = `Weak: ${currentEnemy.weakness}`;
      } else {
        enemyWeaknessDisplay.style.display = 'none';
      }
    } else {
      enemyWeaknessDisplay.style.display = 'none';
    }
  } else {
    enemyNameDisplay.textContent = "No Enemy";
    enemyHpDisplay.textContent = "HP: 0/0";
    enemyHpFill.style.width = "0%";
    enemyDmgDisplay.textContent = "DMG: 0-0";
    enemyWeaknessDisplay.style.display = 'none';
  }

  if (gameState.fury >= gameState.maxFury) {
    specialBtn.classList.add('available');
  } else {
    specialBtn.classList.remove('available');
  }

  // Update combo display
  if (gameState.currentCombo > 0) {
    comboDisplay.style.display = 'block';
    comboCountDisplay.textContent = gameState.currentCombo;
    if (gameState.currentCombo >= 3) {
      comboDisplay.classList.add('combo-active');
    } else {
      comboDisplay.classList.remove('combo-active');
    }
  } else {
    comboDisplay.style.display = 'none';
  }

  updateInventory();
}

// Update moon phase visual
function updateMoonPhaseVisual() {
  const phase = gameState.currentMoonPhase;
  let gradient = '';

  switch(phase) {
    case 0: // New Moon
      gradient = 'transparent';
      break;
    case 1: // Waxing Crescent
      gradient = 'linear-gradient(135deg, var(--moonlight) 25%, transparent 25%)';
      break;
    case 2: // First Quarter
      gradient = 'linear-gradient(90deg, var(--moonlight) 50%, transparent 50%)';
      break;
    case 3: // Waxing Gibbous
      gradient = 'linear-gradient(45deg, var(--moonlight) 75%, transparent 75%)';
      break;
    case 4: // Full Moon
      gradient = 'var(--moonlight)';
      break;
    case 5: // Waning Gibbous
      gradient = 'linear-gradient(45deg, transparent 25%, var(--moonlight) 25%)';
      break;
    case 6: // Last Quarter
      gradient = 'linear-gradient(90deg, transparent 50%, var(--moonlight) 50%)';
      break;
    case 7: // Waning Crescent
      gradient = 'linear-gradient(135deg, transparent 75%, var(--moonlight) 75%)';
      break;
  }

  moonPhaseDisplay.style.background = gradient;
}

// Add entry to combat log
function addLogEntry(text, type = 'normal') {
  const entry = document.createElement('div');
  entry.className = 'combat-entry';

  if (type === 'player') {
    entry.classList.add('player-action');
  } else if (type === 'enemy') {
    entry.classList.add('enemy-action');
  } else if (type === 'system') {
    entry.classList.add('system-message');
  } else if (type === 'loot') {
    entry.classList.add('loot-message');
  } else if (type === 'transform') {
    entry.classList.add('transformation-message');
  } else if (type === 'critical') {
    entry.classList.add('critical-hit');
  } else if (type === 'dodge') {
    entry.classList.add('dodge-message');
  } else if (type === 'curse') {
    entry.classList.add('curse-message');
  } else if (type === 'xp') {
    entry.classList.add('xp-message');
  } else if (type === 'level-up') {
    entry.classList.add('level-up-message');
  }

  entry.textContent = text;
  combatLog.appendChild(entry);
  combatLog.scrollTop = combatLog.scrollHeight;
}

// Generate a new enemy
function generateEnemy() {
  // Reset perfect fight tracking
  perfectFight = true;

  // Check for boss fight every 5 floors
  if (gameState.floor % 5 === 0 && !gameState.bossDefeated) {
    const bossEnemies = enemies.filter(e => e.isBoss);
    currentEnemy = {...bossEnemies[Math.floor(Math.random() * bossEnemies.length)]};
    gameState.bossDefeated = true;
    addLogEntry(`A powerful ${currentEnemy.name} appears to challenge you!`, 'system');
  } else {
    // Scale enemy level with floor progression
    let enemyLevel = Math.min(Math.floor(gameState.floor / 3), enemies.length - 1);

    // Small chance to get a higher level enemy
    if (Math.random() < 0.1 && enemyLevel < enemies.length - 1) {
      enemyLevel++;
    }

    currentEnemy = {...enemies[enemyLevel]};
    gameState.bossDefeated = false;
  }

  // Scale enemy stats with floor progression
  const floorScale = 1 + (gameState.floor * 0.05);
  currentEnemy.hp = Math.floor(currentEnemy.hp * floorScale);
  currentEnemy.minDmg = Math.floor(currentEnemy.minDmg * floorScale);
  currentEnemy.maxDmg = Math.floor(currentEnemy.maxDmg * floorScale);
  currentEnemy.currentHp = currentEnemy.hp;

  // Special case for full moon and first enemy
  if (gameState.currentMoonPhase === 4 && gameState.floor === 1) {
    currentEnemy.minDmg = 1;
    currentEnemy.maxDmg = 3;
    currentEnemy.name = "Terrified Child";
    currentEnemy.special = null;
  }

  // Rare chance for a legendary enemy
  if (Math.random() < 0.05 && !currentEnemy.isBoss) {
    currentEnemy.name = "Ancient " + currentEnemy.name;
    currentEnemy.hp = Math.floor(currentEnemy.hp * 1.5);
    currentEnemy.minDmg = Math.floor(currentEnemy.minDmg * 1.3);
    currentEnemy.maxDmg = Math.floor(currentEnemy.minDmg * 1.3);
    currentEnemy.currentHp = currentEnemy.hp;
    currentEnemy.xp = Math.floor(currentEnemy.xp * 2);
    currentEnemy.lootChance = 1.0;
  }

  // Reset combo when new enemy appears
  gameState.currentCombo = 0;
  updateDisplays();
}

// Player attack
function playerAttack() {
  if (!gameState.gameActive) return;

  playSound(attackSound);
  
  // Add attack animation
  const controls = document.getElementById('controls');
  controls.classList.add('player-attack-animation');
  setTimeout(() => {
    controls.classList.remove('player-attack-animation');
  }, 300);

  // Combo system - increase damage based on consecutive attacks
  let comboMultiplier = 1;
  if (gameState.lastAction === 'attack') {
    gameState.currentCombo++;
    gameState.highestCombo = Math.max(gameState.highestCombo, gameState.currentCombo);

    // Check for Combo King achievement
    checkAchievement('comboKing', gameState.currentCombo);

    if (gameState.currentCombo >= 3) {
      comboMultiplier = 1 + (gameState.currentCombo * 0.05); // 5% bonus per combo hit
      if (gameState.skills.packTactics.unlocked) {
        comboMultiplier += 0.025 * gameState.currentCombo; // Additional 2.5% per combo if skill unlocked
      }
      playSound(comboSound);
      addLogEntry(`Combo x${gameState.currentCombo}! Damage increased!`, 'system');
    }
  } else {
    gameState.currentCombo = 1;
  }
  gameState.lastAction = 'attack';

  let damage = Math.floor(Math.random() * (gameState.equippedWeapon.maxDmg - gameState.equippedWeapon.minDmg + 1)) + gameState.equippedWeapon.minDmg;
  damage += Math.floor(gameState.baseMinDmg + (gameState.baseMaxDmg - gameState.baseMinDmg) * Math.random());
  
  // Check for critical hit
  let critChance = 0.2; // Base 20% crit chance
  if (gameState.skills.savageStrikes.unlocked) {
    critChance += 0.1; // Additional 10% from skill
  }
  
  const isCritical = Math.random() < critChance;

  if (isCritical) {
    damage = Math.floor(damage * 1.5);
    playSound(critSound);
  }

  // Moonstone boost
  if (gameState.hasMoonstoneBoost) {
    damage = Math.floor(damage * 1.3);
    addLogEntry(`Moonstone Shard boosts your attack!`, 'system');
  }

  // Check enemy resistance/weakness
  if (currentEnemy.resistance === attackType) {
    damage = Math.floor(damage * 0.7);
    addLogEntry(`The ${currentEnemy.name} resists your ${attackType} attack!`, 'enemy');
  } else if (currentEnemy.weakness === attackType) {
    damage = Math.floor(damage * 1.3);
    addLogEntry(`The ${currentEnemy.name} is weak to your ${attackType} attack!`, 'player');
  }

  // Bloodlust skill - heal for 10% of damage
  if (gameState.skills.bloodlust.unlocked) {
    const healAmount = Math.floor(damage * 0.1);
    gameState.currentHp = Math.min(gameState.currentHp + healAmount, gameState.maxHp);
    addLogEntry(`Bloodlust heals you for ${healAmount} HP!`, 'system');
  }

  if (gameState.isCursed) {
    damage = Math.floor(damage * 0.7);
    addLogEntry(`Your curse weakens your attack!`, 'curse');
  }

  // Apply combo multiplier
  damage = Math.floor(damage * comboMultiplier);

  currentEnemy.currentHp -= damage;

  // Show damage number
  const enemyRect = document.getElementById('enemy-stats').getBoundingClientRect();
  showDamageNumber(
    enemyRect.left + enemyRect.width / 2,
    enemyRect.top + enemyRect.height / 2,
    damage,
    isCritical
  );

  // Create blood particles
  createParticles(
    enemyRect.left + enemyRect.width / 2,
    enemyRect.top + enemyRect.height / 2,
    '#8b0000'
  );

  // Update weapon durability
  if (gameState.equippedWeapon.durability !== Infinity) {
    gameState.equippedWeapon.durability--;
    if (gameState.equippedWeapon.durability <= 0) {
      addLogEntry(`Your ${gameState.equippedWeapon.name} breaks!`, 'system');
      gameState.equippedWeapon = { name: "Claws", minDmg: 5, maxDmg: 10, durability: Infinity };
    }
  }

  addLogEntry(
    `You ${attackType} the ${currentEnemy.name} with ${gameState.equippedWeapon.name} for ${damage} damage${isCritical ? " (CRITICAL)" : ""}!`,
    isCritical ? 'critical' : 'player'
  );

  // Gain fury based on attack type
  let furyGain = 10;
  if (attackType === "lunge") furyGain = 15;
  if (attackType === "howl") furyGain = 5;
  
  // Lunar Connection skill - more fury during full moon
  if (gameState.skills.lunarConnection.unlocked && gameState.currentMoonPhase === 4) {
    furyGain = Math.floor(furyGain * 1.5);
  }
  
  gameState.fury = Math.min(gameState.fury + furyGain, gameState.maxFury);
  updateMoonstoneBoost();
  updateDisplays();

  if (currentEnemy.currentHp <= 0) {
    enemyDefeated();
  } else {
    setTimeout(enemyTurn, 1000);
  }
}

// Change attack type
function changeAttackType(type) {
  attackType = type;
  attackBtn.textContent = type.charAt(0).toUpperCase() + type.slice(1);
}

// Player howl
function playerHowl() {
  if (!gameState.gameActive) return;

  playSound(howlSound);

  // Reset combo
  gameState.currentCombo = 0;
  gameState.lastAction = 'howl';

  let stunChance = 0.5;
  if (gameState.skills.primalHowl.unlocked) {
    stunChance = 1.0;
  }

  if (Math.random() < stunChance) {
    addLogEntry(`Your terrifying howl causes the ${currentEnemy.name} to freeze in fear!`, 'player');
    // Stun effect - enemy skips next turn
    currentEnemy.isStunned = true;
  } else {
    addLogEntry(`You howl at the moon, but the ${currentEnemy.name} isn't impressed.`, 'player');
  }

  let furyGain = 5;
  if (gameState.skills.lunarConnection.unlocked && gameState.currentMoonPhase === 4) {
    furyGain = Math.floor(furyGain * 1.5);
  }

  gameState.fury = Math.min(gameState.fury + furyGain, gameState.maxFury);
  updateMoonstoneBoost();
  updateDisplays();

  setTimeout(enemyTurn, 1000);
}

// Player rest
function playerRest() {
  if (!gameState.gameActive) return;

  // Reset combo
  gameState.currentCombo = 0;
  gameState.lastAction = 'rest';

  let healAmount = 5;
  // Thick Hide skill - rest heals more
  if (gameState.skills.thickHide.unlocked) {
    healAmount += 2;
  }

  gameState.currentHp = Math.min(gameState.currentHp + healAmount, gameState.maxHp);
  addLogEntry(`You rest and recover ${healAmount} HP.`, 'player');
  updateMoonstoneBoost();
  updateDisplays();

  setTimeout(enemyTurn, 1000);
}

// Special ability - Lunar Frenzy
function lunarFrenzy() {
  if (!gameState.gameActive || gameState.fury < gameState.maxFury) return;

  playSound(lunarSound);
  gameState.fury = 0;
  gameState.lunarFrenzyUsed++;
  
  // Add attack animation
  const controls = document.getElementById('controls');
  controls.classList.add('player-attack-animation');
  setTimeout(() => {
    controls.classList.remove('player-attack-animation');
  }, 300);

  // Combo system - increase damage based on consecutive attacks
  let comboMultiplier = 1;
  if (gameState.lastAction === 'attack') {
    gameState.currentCombo++;
    gameState.highestCombo = Math.max(gameState.highestCombo, gameState.currentCombo);

    // Check for Combo King achievement
    checkAchievement('comboKing', gameState.currentCombo);

    if (gameState.currentCombo >= 3) {
      comboMultiplier = 1 + (gameState.currentCombo * 0.05); // 5% bonus per combo hit
      if (gameState.skills.packTactics.unlocked) {
        comboMultiplier += 0.025 * gameState.currentCombo; // Additional 2.5% per combo if skill unlocked
      }
      playSound(comboSound);
      addLogEntry(`Combo x${gameState.currentCombo}! Damage increased!`, 'system');
    }
  } else {
    gameState.currentCombo = 1;
  }
  gameState.lastAction = 'attack';

  let damage = Math.floor(Math.random() * 16) + 15;
  damage += Math.floor(gameState.baseMinDmg + (gameState.baseMaxDmg - gameState.baseMinDmg) * Math.random());

  // Lunar Mastery skill - 25% more damage
  if (gameState.skills.lunarMastery.unlocked) {
    damage = Math.floor(damage * 1.25);
  }

  if (gameState.hasMoonstoneBoost) {
    damage = Math.floor(damage * 1.3);
    addLogEntry(`Moonstone Shard boosts your Lunar Frenzy!`, 'system');
  }

  if (gameState.isCursed) {
    damage = Math.floor(damage * 0.7);
    addLogEntry(`Your curse weakens your Lunar Frenzy!`, 'curse');
  }

  // Apply combo multiplier
  damage = Math.floor(damage * comboMultiplier);

  currentEnemy.currentHp -= damage;

  // Show damage number
  const enemyRect = document.getElementById('enemy-stats').getBoundingClientRect();
  showDamageNumber(
    enemyRect.left + enemyRect.width / 2,
    enemyRect.top + enemyRect.height / 2,
    damage,
    true
  );

  // Create lunar particles
  createParticles(
    enemyRect.left + enemyRect.width / 2,
    enemyRect.top + enemyRect.height / 2,
    '#f5f5dc',
    20
  );

  addLogEntry(`You enter a LUNAR FRENZY and savagely maul the ${currentEnemy.name} for ${damage} damage!`, 'player');
  addLogEntry("The taste of blood drives you wild!", 'transform');

  // Heal from Lunar Frenzy
  let healAmount = 10;
  if (gameState.skills.thickHide.unlocked) {
    healAmount += 5;
  }
  gameState.currentHp = Math.min(gameState.currentHp + healAmount, gameState.maxHp);
  updateMoonstoneBoost();
  updateDisplays();

  // Check for Lunar Fury achievement
  checkAchievement('lunarFury', gameState.lunarFrenzyUsed);

  if (currentEnemy.currentHp <= 0) {
    enemyDefeated();
  } else {
    setTimeout(enemyTurn, 1000);
  }
}

// Update Moonstone Boost duration
function updateMoonstoneBoost() {
  if (gameState.hasMoonstoneBoost) {
    gameState.moonstoneTurns--;
    if (gameState.moonstoneTurns <= 0) {
      gameState.hasMoonstoneBoost = false;
      addLogEntry("The Moonstone Shard's power fades.", 'system');
    }
  }
}

// Enemy turn
function enemyTurn() {
  if (!gameState.gameActive) return;

  // Check for stun
  if (currentEnemy.isStunned) {
    addLogEntry(`The ${currentEnemy.name} is still recovering from your howl!`, 'system');
    currentEnemy.isStunned = false;
    updateMoonstoneBoost();
    updateDisplays();
    return;
  }

  // Add enemy attack animation
  const enemyStats = document.getElementById('enemy-stats');
  enemyStats.classList.add('enemy-attack-animation');
  setTimeout(() => {
    enemyStats.classList.remove('enemy-attack-animation');
  }, 300);

  // Player dodge chance (10%)
  if (Math.random() < 0.1) {
    addLogEntry(`You nimbly dodge the ${currentEnemy.name}'s attack!`, 'dodge');
    updateMoonstoneBoost();
    updateDisplays();
    return;
  }

  let damage;
  if (currentEnemy.special === "silver" && Math.random() < 0.3) {
    damage = Math.floor(Math.random() * 8) + 10;
    if (!gameState.isTransformed) damage += 5;
    if (gameState.hasSilverAmulet) damage = Math.max(0, damage - 2);
    
    // Silver Resistance skill
    if (gameState.skills.silverResistance.unlocked) {
      damage = Math.floor(damage * 0.5);
    }
    
    gameState.currentHp -= damage;
    addLogEntry(`The ${currentEnemy.name} shoots you with a SILVER BULLET for ${damage} damage!`, 'enemy');
    perfectFight = false;
  } else if (currentEnemy.special === "blessing" && Math.random() < 0.4) {
    addLogEntry(`The ${currentEnemy.name} blesses themselves, reducing your fury!`, 'enemy');
    gameState.fury = Math.max(0, gameState.fury - 20);
  } else if (currentEnemy.special === "block" && Math.random() < 0.3) {
    addLogEntry(`The ${currentEnemy.name} prepares to block your next attack!`, 'enemy');
  } else if (currentEnemy.special === "trap" && Math.random() < 0.2) {
    damage = Math.floor(Math.random() * 5) + 5;
    if (gameState.hasSilverAmulet) damage = Math.max(0, damage - 2);
    gameState.currentHp -= damage;
    addLogEntry(`The ${currentEnemy.name} catches you in a trap for ${damage} damage!`, 'enemy');
    perfectFight = false;
  } else if (currentEnemy.special === "curse" && Math.random() < 0.3) {
    gameState.isCursed = true;
    gameState.curseTurns = 2;
    addLogEntry(`The ${currentEnemy.name} curses you, weakening your attacks for ${gameState.curseTurns} turns!`, 'curse');
  } else if (currentEnemy.special === "summon" && Math.random() < 0.2 && currentEnemy.isBoss) {
    addLogEntry(`The ${currentEnemy.name} summons reinforcements!`, 'enemy');
    // Small heal for boss
    currentEnemy.currentHp = Math.min(currentEnemy.currentHp + 15, currentEnemy.hp);
    enemyHpFill.style.width = `${(currentEnemy.currentHp / currentEnemy.hp) * 100}%`;
  } else if (currentEnemy.special === "silverstorm" && Math.random() < 0.25 && currentEnemy.isBoss) {
    damage = Math.floor(Math.random() * 15) + 10;
    if (!gameState.isTransformed) damage += 5;
    if (gameState.hasSilverAmulet) damage = Math.max(0, damage - 2);
    
    // Silver Resistance skill
    if (gameState.skills.silverResistance.unlocked) {
      damage = Math.floor(damage * 0.5);
    }
    
    gameState.currentHp -= damage;
    addLogEntry(`The ${currentEnemy.name} unleashes a SILVER STORM for ${damage} damage!`, 'enemy');
    perfectFight = false;
  } else {
    damage = Math.floor(Math.random() * (currentEnemy.maxDmg - currentEnemy.minDmg + 1)) + currentEnemy.minDmg;
    
    // Thick Hide skill reduces damage
    if (gameState.skills.thickHide.unlocked) {
      damage = Math.max(0, damage - 1);
    }
    
    if (gameState.hasSilverAmulet && !gameState.isTransformed) damage = Math.max(0, damage - 2);
    gameState.currentHp -= damage;
    addLogEntry(`The ${currentEnemy.name} attacks you for ${damage} damage!`, 'enemy');
    perfectFight = false;
  }

  // Show damage number on player
  const playerRect = document.getElementById('stats-panel').getBoundingClientRect();
  if (damage) {
    showDamageNumber(
      playerRect.left + playerRect.width / 2,
      playerRect.top + playerRect.height / 2,
      damage
    );
  }

  // Berserker skill - deal more damage at low HP
  if (gameState.skills.berserker.unlocked && gameState.currentHp < gameState.maxHp * 0.3) {
    addLogEntry("Berserker rage fuels your fury!", 'system');
    gameState.fury = Math.min(gameState.fury + 15, gameState.maxFury);
  }

  // Update curse duration
  if (gameState.isCursed) {
    gameState.curseTurns--;
    if (gameState.curseTurns <= 0) {
      gameState.isCursed = false;
      addLogEntry("The curse wears off!", 'system');
    }
  }

  updateMoonstoneBoost();
  updateDisplays();

  if (gameState.currentHp <= 0) {
    gameOver();
  }
}

// Enemy defeated
function enemyDefeated() {
  addLogEntry(`You have slain the ${currentEnemy.name}!`, 'player');
  gameState.enemiesDefeated++;
  gameState.xp += currentEnemy.xp;
  addLogEntry(`You gain ${currentEnemy.xp} XP!`, 'xp');

  // Check for perfect fight
  if (perfectFight) {
    gameState.perfectKills++;
    addLogEntry("Perfect fight! You took no damage!", 'level-up');
    checkAchievement('perfectHunter', gameState.perfectKills);
    gameState.reputation += 1;
  }

  // Check for achievements
  if (gameState.enemiesDefeated === 1) {
    checkAchievement('firstBlood', 1);
  }

  if (currentEnemy.name.includes("Werewolf Hunter")) {
    checkAchievement('silverSlayer', 1);
  }

  if (currentEnemy.name.includes("Witch")) {
    gameState.witchesDefeated++;
    checkAchievement('cursedHunter', gameState.witchesDefeated);
  }

  checkAchievement('packLeader', gameState.enemiesDefeated);

  if (gameState.xp >= gameState.maxXp) {
    gameState.level++;
    gameState.skillPoints++;
    gameState.xp -= gameState.maxXp;
    gameState.maxXp = Math.floor(gameState.maxXp * 1.2);
    gameState.maxHp += 5;
    gameState.currentHp = gameState.maxHp;
    gameState.baseMinDmg += 1;
    gameState.baseMaxDmg += 1;
    addLogEntry(`You level up to Level ${gameState.level}! Max HP increased to ${gameState.maxHp}, base damage increased!`, 'level-up');
    addLogEntry(`You gained 1 skill point!`, 'system');
    playSound(levelupSound);

    // Check for Moon Child achievement
    checkAchievement('moonChild', gameState.level);
  }

  // Loot drop
  if ((Math.random() < currentEnemy.lootChance || currentEnemy.isBoss) && gameState.inventory.length < 10) {
    const lootTypes = [
      { name: "Health Potion", type: "consumable", description: "Restores 10 HP", rarity: "common" },
      { name: "Fury Elixir", type: "consumable", description: "Grants 30 Fury", rarity: "uncommon" },
      { name: "Moonstone Shard", type: "consumable", description: "Boosts damage by 30% for 3 turns", rarity: "rare" },
      { name: "Wolf Pelt", type: "material", description: "Can be crafted into a Bloodlust Tonic", rarity: "common" },
      { name: "Silver Ring", type: "trinket", description: "Increases luck", rarity: "uncommon" },
      { name: "Moon Dust", type: "material", description: "Used in crafting", rarity: "uncommon" },
      { name: "Silver Ore", type: "material", description: "Used in crafting", rarity: "rare" },
      { name: "Leather Strap", type: "material", description: "Used in crafting", rarity: "common" },
      { name: "Iron Ingot", type: "material", description: "Used in crafting", rarity: "uncommon" },
      { name: "Wooden Handle", type: "material", description: "Used in crafting", rarity: "common" },
      { name: "Medicinal Herb", type: "material", description: "Used in crafting", rarity: "common" },
      { name: "Glass Vial", type: "material", description: "Used in crafting", rarity: "common" },
      ...weapons
    ];

    // Adjust drop rates - better items are rarer
    let lootPool = [...lootTypes];
    if (Math.random() < 0.1) {
      // 10% chance for better loot pool
      lootPool = weapons.filter(w => w.rarity !== "mythic").concat([
        { name: "Bloodlust Tonic", type: "consumable", description: "Grants 50 Fury", rarity: "uncommon" },
        { name: "Moonstone Shard", type: "consumable", description: "Boosts damage by 30% for 3 turns", rarity: "rare" }
      ]);
    }

    let loot = {...lootPool[Math.floor(Math.random() * lootPool.length)]};

    // Special case for legendary weapon
    if (Math.random() < 0.02 && gameState.floor >= 10) {
      loot = {...weapons.find(w => w.name === "Silver Claws")};
    }

    // Bosses always drop rare or better loot
    if (currentEnemy.isBoss) {
      const bossLootPool = lootTypes.filter(item => item.rarity === "rare" || item.rarity === "legendary");
      loot = {...bossLootPool[Math.floor(Math.random() * bossLootPool.length)]};
    }

    gameState.inventory.push(loot);
    addLogEntry(`You found a ${loot.name}!`, 'loot');
    playSound(itemSound);

    // Update collector achievement
    checkAchievement('collector', gameState.inventory.length);
  } else if (gameState.inventory.length >= 10) {
    addLogEntry("Your inventory is full! Discard items to make space.", 'system');
  }

  // Increase max HP every 5 floors
  if (gameState.floor % 5 === 0) {
    gameState.maxHp += 5;
    gameState.currentHp = Math.min(gameState.currentHp + 5, gameState.maxHp);
    addLogEntry(`Your resilience grows! Max HP increased to ${gameState.maxHp}!`, 'system');
  }

  // Check for Cursed One achievement
  checkAchievement('cursedOne', gameState.floor);

  setTimeout(nextFloor, 1500);
}

// Move to next floor
function nextFloor() {
  gameState.floor++;
  
  // Advance time (each floor is 6 hours)
  gameState.isDaytime = !gameState.isDaytime;
  if (!gameState.isDaytime) {
    gameState.currentDay++;
  }
  
  // Change moon phase every night
  if (!gameState.isDaytime) {
    gameState.currentMoonPhase = (gameState.currentMoonPhase + 1) % 8;

    if (gameState.currentMoonPhase === 4) {
      addLogEntry("The FULL MOON rises! You transform into a werewolf!", 'transform');
      gameState.isTransformed = true;
    } else if (gameState.currentMoonPhase === 0) {
      addLogEntry("The NEW MOON makes you feel weak. You revert to human form.", 'transform');
      gameState.isTransformed = false;
      if (gameState.equippedWeapon.name !== "Claws") {
        addLogEntry("In human form, you can only use your fists!", 'system');
        gameState.equippedWeapon = { name: "Claws", minDmg: 5, maxDmg: 10, durability: Infinity };
      }
    }
    
    // Moon Blessing skill - stay transformed one extra floor
    if (gameState.skills.moonBlessing.unlocked && gameState.currentMoonPhase === 3) {
      addLogEntry("Moon Blessing keeps you transformed a little longer!", 'system');
    }
  }

  // Check for Survivor and Legend achievements
  checkAchievement('survivor', gameState.floor);
  checkAchievement('legend', gameState.floor);

  generateEnemy();
  addLogEntry(`You encounter a ${currentEnemy.name}!`, 'system');
  updateDisplays();
}

// Game over
function gameOver() {
  gameState.gameActive = false;
  playSound(deathSound);
  backgroundMusic.pause();

  const deathMessages = [
    "The villagers finally put you down with silver bullets.",
    "You succumb to your wounds, the curse lifting as you die.",
    "A mob of villagers tears you apart with pitchforks and torches.",
    "The hunters display your head as a trophy.",
    "Your human form returns as you take your last breath.",
    "The villagers celebrate as your werewolf form collapses.",
    "The silver burns through your heart, ending the curse forever.",
    "Your howls fade into the night as your vision darkens."
  ];

  deathMessage.textContent = deathMessages[Math.floor(Math.random() * deathMessages.length)];

  // Update final stats
  finalFloorDisplay.textContent = gameState.floor;
  finalLevelDisplay.textContent = gameState.level;
  finalKillsDisplay.textContent = gameState.enemiesDefeated;
  finalComboDisplay.textContent = gameState.highestCombo;

  // Count unlocked achievements
  const unlockedCount = Object.values(gameState.achievements).filter(a => a.unlocked).length;
  finalAchievementsDisplay.textContent = `${unlockedCount}/15`;

  gameOverPanel.style.display = 'flex';
}

// Update inventory display
function updateInventory() {
  inventoryItems.innerHTML = '';
  inventoryCount.textContent = `${gameState.inventory.length}/10`;
  if (gameState.inventory.length >= 10) {
    inventoryCount.classList.add('full');
  } else {
    inventoryCount.classList.remove('full');
  }

  // Display current weapon
  const currentWeaponElement = document.createElement('div');
  currentWeaponElement.className = 'item current-weapon';
  const currentWeaponInfo = document.createElement('div');
  currentWeaponInfo.innerHTML = `
    <div class="item-name">Current: ${gameState.equippedWeapon.name}</div>
    <div class="item-description">${gameState.equippedWeapon.description || 'Default werewolf weapon'}</div>
  `;
  const currentWeaponStats = document.createElement('div');
  currentWeaponStats.className = 'item-stats';
  const currentAvgDmg = (gameState.equippedWeapon.minDmg + gameState.equippedWeapon.maxDmg) / 2;
  currentWeaponStats.textContent = `DMG: ${gameState.equippedWeapon.minDmg}-${gameState.equippedWeapon.maxDmg} (Avg: ${currentAvgDmg.toFixed(1)}), Uses: ${gameState.equippedWeapon.durability === Infinity ? '∞' : gameState.equippedWeapon.durability}`;
  currentWeaponInfo.appendChild(currentWeaponStats);
  currentWeaponElement.appendChild(currentWeaponInfo);
  inventoryItems.appendChild(currentWeaponElement);

  // Display inventory items
  gameState.inventory.forEach((item, index) => {
    const itemElement = document.createElement('div');
    itemElement.className = 'item';
    
    // Add rarity class
    if (item.rarity === "rare") {
      itemElement.classList.add('rare-item');
    } else if (item.rarity === "legendary" || item.rarity === "mythic") {
      itemElement.classList.add('legendary-item');
    }

    // Highlight better weapons
    if (item.type === 'weapon') {
      const currentAvgDmg = (gameState.equippedWeapon.minDmg + gameState.equippedWeapon.maxDmg) / 2;
      const itemAvgDmg = (item.minDmg + item.maxDmg) / 2;
      if (itemAvgDmg > currentAvgDmg || (itemAvgDmg === currentAvgDmg && item.durability > gameState.equippedWeapon.durability)) {
        itemElement.classList.add('better-weapon');
      }
    }

    const itemInfo = document.createElement('div');
    itemInfo.innerHTML = `
      <div class="item-name">${item.name}</div>
      <div class="item-description">${item.description || ''}</div>
    `;

    if (item.type === 'weapon') {
      const itemStats = document.createElement('div');
      itemStats.className = 'item-stats';
      const itemAvgDmg = (item.minDmg + item.maxDmg) / 2;
      itemStats.textContent = `DMG: ${item.minDmg}-${item.maxDmg} (Avg: ${itemAvgDmg.toFixed(1)}), Uses: ${item.durability}`;
      itemInfo.appendChild(itemStats);
    }

    const itemActions = document.createElement('div');
    itemActions.className = 'item-actions';

    if (item.type === 'consumable') {
      const itemUse = document.createElement('div');
      itemUse.className = 'item-use';
      itemUse.textContent = 'Use';
      itemUse.onclick = () => useItem(index);
      itemActions.appendChild(itemUse);
    } else if (item.type === 'trinket' && item.name === "Silver Amulet" && !gameState.hasSilverAmulet) {
      const itemUse = document.createElement('div');
      itemUse.className = 'item-use';
      itemUse.textContent = 'Use';
      itemUse.onclick = () => useItem(index);
      itemActions.appendChild(itemUse);
    } else if (item.type === 'material') {
      const itemUse = document.createElement('div');
      itemUse.className = 'item-use';
      itemUse.textContent = 'Craft';
      itemUse.onclick = () => showCraftingOptions(index);
      itemActions.appendChild(itemUse);
    } else if (item.type === 'weapon' && gameState.isTransformed) {
      const itemEquip = document.createElement('div');
      itemEquip.className = gameState.equippedWeapon.name === item.name ? 'item-equip equipped' : 'item-equip';
      itemEquip.textContent = gameState.equippedWeapon.name === item.name ? 'Equipped' : 'Equip';
      if (gameState.equippedWeapon.name !== item.name) {
        itemEquip.onclick = () => equipItem(index);
      }
      itemActions.appendChild(itemEquip);
    } else if (item.type === 'weapon' && !gameState.isTransformed) {
      const itemEquip = document.createElement('div');
      itemEquip.className = 'item-equip disabled-action';
      itemEquip.textContent = 'Cannot Equip (Human)';
      itemActions.appendChild(itemEquip);
    }

    const itemDiscard = document.createElement('div');
    itemDiscard.className = 'item-discard';
    itemDiscard.textContent = 'Discard';
    itemDiscard.onclick = () => discardItem(index);
    itemActions.appendChild(itemDiscard);

    itemElement.appendChild(itemInfo);
    itemElement.appendChild(itemActions);
    inventoryItems.appendChild(itemElement);
  });
}

// Show crafting options for a material
function showCraftingOptions(itemIndex) {
  const item = gameState.inventory[itemIndex];
  if (!item || item.type !== 'material') return;

  // Find recipes that include this material
  const relevantRecipes = craftingRecipes.filter(recipe =>
    recipe.ingredients.some(ing => ing.name === item.name)
  );

  if (relevantRecipes.length === 0) {
    addLogEntry(`No recipes use ${item.name}.`, 'system');
    return;
  }

  // Show crafting panel with filtered recipes
  craftingRecipesList.innerHTML = '';
  relevantRecipes.forEach(recipe => {
    const recipeElement = document.createElement('div');
    recipeElement.className = 'recipe';
    
    // Add rarity class
    if (recipe.result.rarity === "rare") {
      recipeElement.classList.add('rare-item');
    } else if (recipe.result.rarity === "legendary" || recipe.result.rarity === "mythic") {
      recipeElement.classList.add('legendary-item');
    }

    const recipeName = document.createElement('div');
    recipeName.className = 'recipe-name';
    recipeName.textContent = recipe.name;

    const recipeIngredients = document.createElement('div');
    recipeIngredients.className = 'recipe-ingredients';
    recipeIngredients.textContent = 'Ingredients: ' +
      recipe.ingredients.map(ing => `${ing.quantity}x ${ing.name}`).join(', ');

    const recipeResult = document.createElement('div');
    recipeResult.className = 'recipe-result';
    recipeResult.textContent = 'Creates: ' + recipe.result.name;

    const recipeCraft = document.createElement('button');
    recipeCraft.className = 'recipe-craft';
    recipeCraft.textContent = 'Craft';

    // Check if player has all required ingredients
    const canCraft = recipe.ingredients.every(ing => {
      const count = gameState.inventory.filter(i => i.name === ing.name).length;
      return count >= ing.quantity;
    });

    if (!canCraft) {
      recipeCraft.disabled = true;
      recipeCraft.textContent = 'Need Materials';
    } else {
      recipeCraft.onclick = () => craftItem(recipe);
    }

    recipeElement.appendChild(recipeName);
    recipeElement.appendChild(recipeIngredients);
    recipeElement.appendChild(recipeResult);
    recipeElement.appendChild(recipeCraft);
    craftingRecipesList.appendChild(recipeElement);
  });

  craftingPanel.style.display = 'flex';
}

// Update crafting recipes display
function updateCraftingRecipes() {
  craftingRecipesList.innerHTML = '';
  craftingRecipes.forEach(recipe => {
    const recipeElement = document.createElement('div');
    recipeElement.className = 'recipe';
    
    // Add rarity class
    if (recipe.result.rarity === "rare") {
      recipeElement.classList.add('rare-item');
    } else if (recipe.result.rarity === "legendary" || recipe.result.rarity === "mythic") {
      recipeElement.classList.add('legendary-item');
    }

    const recipeName = document.createElement('div');
    recipeName.className = 'recipe-name';
    recipeName.textContent = recipe.name;

    const recipeIngredients = document.createElement('div');
    recipeIngredients.className = 'recipe-ingredients';
    recipeIngredients.textContent = 'Ingredients: ' +
      recipe.ingredients.map(ing => `${ing.quantity}x ${ing.name}`).join(', ');

    const recipeResult = document.createElement('div');
    recipeResult.className = 'recipe-result';
    recipeResult.textContent = 'Creates: ' + recipe.result.name;

    const recipeCraft = document.createElement('button');
    recipeCraft.className = 'recipe-craft';
    recipeCraft.textContent = 'Craft';

    // Check if player has all required ingredients
    const canCraft = recipe.ingredients.every(ing => {
      const count = gameState.inventory.filter(i => i.name === ing.name).length;
      return count >= ing.quantity;
    });

    if (!canCraft) {
      recipeCraft.disabled = true;
      recipeCraft.textContent = 'Need Materials';
    } else {
      recipeCraft.onclick = () => craftItem(recipe);
    }

    recipeElement.appendChild(recipeName);
    recipeElement.appendChild(recipeIngredients);
    recipeElement.appendChild(recipeResult);
    recipeElement.appendChild(recipeCraft);
    craftingRecipesList.appendChild(recipeElement);
  });
}

// Craft item from recipe
function craftItem(recipe) {
  // Verify player still has all required ingredients
  const canCraft = recipe.ingredients.every(ing => {
    const count = gameState.inventory.filter(i => i.name === ing.name).length;
    return count >= ing.quantity;
  });

  if (!canCraft) {
    addLogEntry("You don't have enough materials to craft this!", 'system');
    return;
  }

  // Remove ingredients
  recipe.ingredients.forEach(ing => {
    let toRemove = ing.quantity;
    for (let i = gameState.inventory.length - 1; i >= 0 && toRemove > 0; i--) {
      if (gameState.inventory[i].name === ing.name) {
        gameState.inventory.splice(i, 1);
        toRemove--;
      }
    }
  });

  // Add crafted item
  const craftedItem = {...recipe.result};
  gameState.inventory.push(craftedItem);

  playSound(itemSound);
  addLogEntry(`You crafted a ${craftedItem.name}!`, 'system');

  gameState.itemsCrafted++;

  // Track which items have been crafted
  if (!gameState.craftedItems.includes(recipe.name)) {
    gameState.craftedItems.push(recipe.name);
    checkAchievement('masterTransmuter', gameState.craftedItems.length);
  }

  checkAchievement('artisan', gameState.itemsCrafted);

  updateInventory();
  updateCraftingRecipes();
  updateDisplays();
}

// Use item
function useItem(index) {
  const item = gameState.inventory[index];
  if (!item) return;

  playSound(itemSound);

  if (item.type === 'consumable') {
    if (item.name === "Health Potion") {
      if (gameState.currentHp >= gameState.maxHp) {
        addLogEntry("Your HP is already full!", 'system');
        return;
      }
      gameState.currentHp = Math.min(gameState.currentHp + 10, gameState.maxHp);
      addLogEntry("You drink the Health Potion and restore 10 HP!", 'system');
    } else if (item.name === "Fury Elixir") {
      if (gameState.fury >= gameState.maxFury) {
        addLogEntry("Your Fury is already full!", 'system');
        return;
      }
      gameState.fury = Math.min(gameState.fury + 30, gameState.maxFury);
      addLogEntry("You drink the Fury Elixir and gain 30 Fury!", 'system');
    } else if (item.name === "Bloodlust Tonic") {
      if (gameState.fury >= gameState.maxFury) {
        addLogEntry("Your Fury is already full!", 'system');
        return;
      }
      gameState.fury = Math.min(gameState.fury + 50, gameState.maxFury);
      addLogEntry("You drink the Bloodlust Tonic, gaining 50 Fury!", 'system');
    } else if (item.name === "Moonstone Shard") {
      if (gameState.hasMoonstoneBoost) {
        addLogEntry("A Moonstone Shard is already active!", 'system');
        return;
      }
      gameState.hasMoonstoneBoost = true;
      gameState.moonstoneTurns = 3;
      gameState.moonstonesUsed++;
      addLogEntry("You activate the Moonstone Shard, boosting damage for 3 turns!", 'system');

      // Check for Moonstone Master achievement
      checkAchievement('moonstoneMaster', gameState.moonstonesUsed);
    }
    gameState.inventory.splice(index, 1);
  } else if (item.type === 'trinket' && item.name === "Silver Amulet" && !gameState.hasSilverAmulet) {
    gameState.hasSilverAmulet = true;
    addLogEntry("You wear the Silver Amulet, reducing damage taken in human form!", 'system');
    gameState.inventory.splice(index, 1);
  }

  updateInventory();
  updateDisplays();
}

// Discard item
function discardItem(index) {
  const item = gameState.inventory[index];
  if (!item) return;

  gameState.inventory.splice(index, 1);
  addLogEntry(`You discard the ${item.name}.`, 'system');
  updateInventory();
  updateDisplays();

  // Update collector achievement
  checkAchievement('collector', gameState.inventory.length);
}

// Equip item
function equipItem(index) {
  const item = gameState.inventory[index];
  if (!item || item.type !== 'weapon' || !gameState.isTransformed) {
    addLogEntry("You can only equip weapons in werewolf form!", 'system');
    return;
  }

  playSound(itemSound);
  gameState.equippedWeapon = {...item};
  addLogEntry(`You equip the ${item.name}!`, 'system');
  updateInventory();
  updateDisplays();
}

// Update skills tree display
function updateSkillsTree() {
  skillsTree.innerHTML = '';
  
  // Create skill categories
  const offensiveSkills = Object.entries(gameState.skills).filter(([key, skill]) => 
    key === 'savageStrikes' || key === 'bloodlust' || key === 'berserker' || key === 'lunarMastery'
  );
  
  const defensiveSkills = Object.entries(gameState.skills).filter(([key, skill]) => 
    key === 'thickHide' || key === 'silverResistance'
  );
  
  const utilitySkills = Object.entries(gameState.skills).filter(([key, skill]) => 
    key === 'lunarConnection' || key === 'primalHowl' || key === 'moonBlessing' || key === 'packTactics'
  );
  
  // Render offensive skills
  const offensiveCategory = document.createElement('div');
  offensiveCategory.className = 'skill-category';
  offensiveCategory.innerHTML = '<h3>Offensive Skills</h3>';
  offensiveSkills.forEach(([key, skill]) => {
    offensiveCategory.appendChild(createSkillElement(key, skill));
  });
  skillsTree.appendChild(offensiveCategory);
  
  // Render defensive skills
  const defensiveCategory = document.createElement('div');
  defensiveCategory.className = 'skill-category';
  defensiveCategory.innerHTML = '<h3>Defensive Skills</h3>';
  defensiveSkills.forEach(([key, skill]) => {
    defensiveCategory.appendChild(createSkillElement(key, skill));
  });
  skillsTree.appendChild(defensiveCategory);
  
  // Render utility skills
  const utilityCategory = document.createElement('div');
  utilityCategory.className = 'skill-category';
  utilityCategory.innerHTML = '<h3>Utility Skills</h3>';
  utilitySkills.forEach(([key, skill]) => {
    utilityCategory.appendChild(createSkillElement(key, skill));
  });
  skillsTree.appendChild(utilityCategory);
  
  // Update skill points display
  const skillPointsDisplay = document.createElement('div');
  skillPointsDisplay.className = 'skill-category';
  skillPointsDisplay.innerHTML = `<h3>Skill Points: ${gameState.skillPoints}</h3>`;
  skillsTree.insertBefore(skillPointsDisplay, skillsTree.firstChild);
}

// Create skill element for skills tree
function createSkillElement(key, skill) {
  const skillElement = document.createElement('div');
  skillElement.className = 'skill';
  
  const skillIcon = document.createElement('div');
  skillIcon.className = 'skill-icon';
  skillIcon.textContent = key.charAt(0).toUpperCase();
  skillElement.appendChild(skillIcon);
  
  const skillInfo = document.createElement('div');
  skillInfo.className = 'skill-info';
  
  const skillName = document.createElement('div');
  skillName.className = 'skill-name';
  skillName.textContent = skill.name;
  skillInfo.appendChild(skillName);
  
  const skillDesc = document.createElement('div');
  skillDesc.className = 'skill-desc';
  skillDesc.textContent = skill.description;
  skillInfo.appendChild(skillDesc);
  
  skillElement.appendChild(skillInfo);
  
  const skillUnlock = document.createElement('button');
  skillUnlock.className = skill.unlocked ? 'skill-unlock skill-unlocked' : 'skill-unlock';
  skillUnlock.textContent = skill.unlocked ? 'Unlocked' : `Unlock (${skill.cost})`;
  
  if (!skill.unlocked) {
    skillUnlock.onclick = () => unlockSkill(key);
    if (gameState.skillPoints < skill.cost) {
      skillUnlock.disabled = true;
    }
  }
  
  skillElement.appendChild(skillUnlock);
  
  return skillElement;
}

// Unlock skill
function unlockSkill(key) {
  const skill = gameState.skills[key];
  if (!skill || skill.unlocked || gameState.skillPoints < skill.cost) return;
  
  skill.unlocked = true;
  gameState.skillPoints -= skill.cost;
  gameState.unlockedSkills.push(key);
  
  playSound(levelupSound);
  addLogEntry(`You unlocked the ${skill.name} skill!`, 'level-up');
  
  // Check for Alpha Wolf achievement
  checkAchievement('alphaWolf', gameState.unlockedSkills.length);
  
  updateSkillsTree();
  updateDisplays();
}

// Check and update achievements
function checkAchievement(key, progress) {
  const achievement = gameState.achievements[key];
  if (!achievement || achievement.unlocked) return;

  achievement.progress = Math.min(progress, achievement.target);

  if (progress >= achievement.target) {
    achievement.unlocked = true;
    addLogEntry(`Achievement Unlocked: ${achievement.name}!`, 'level-up');
    playSound(levelupSound);
    updateAchievements();
  }
}

// Update achievements display
function updateAchievements() {
  achievementsList.innerHTML = '';

  Object.values(gameState.achievements).forEach(achievement => {
    const achievementElement = document.createElement('div');
    achievementElement.className = `achievement ${achievement.unlocked ? 'unlocked' : ''}`;

    const nameElement = document.createElement('div');
    nameElement.className = 'achievement-name';
    nameElement.textContent = achievement.name;
    if (achievement.unlocked) nameElement.textContent += ' ✓';

    const descElement = document.createElement('div');
    descElement.className = 'achievement-desc';
    descElement.textContent = achievement.description;

    achievementElement.appendChild(nameElement);
    achievementElement.appendChild(descElement);

    if (!achievement.unlocked) {
      const progressElement = document.createElement('div');
      progressElement.className = 'achievement-progress';

      const progressFill = document.createElement('div');
      progressFill.className = 'achievement-progress-fill';
      progressFill.style.width = `${(achievement.progress / achievement.target) * 100}%`;

      progressElement.appendChild(progressFill);
      achievementElement.appendChild(progressElement);
    }

    achievementsList.appendChild(achievementElement);
  });
}

// Event listeners
attackBtn.addEventListener('click', () => {
  // Cycle through attack types
  if (attackType === "slash") {
    changeAttackType("lunge");
  } else if (attackType === "lunge") {
    changeAttackType("howl");
  } else {
    changeAttackType("slash");
  }
  playerAttack();
});

howlBtn.addEventListener('click', playerHowl);
restBtn.addEventListener('click', playerRest);
specialBtn.addEventListener('click', lunarFrenzy);

inventoryBtn.addEventListener('click', () => {
  inventoryPanel.style.display = 'flex';
});

craftingBtn.addEventListener('click', () => {
  craftingPanel.style.display = 'flex';
  updateCraftingRecipes();
});

skillsBtn.addEventListener('click', () => {
  skillsPanel.style.display = 'flex';
  updateSkillsTree();
});

closeInventoryBtn.addEventListener('click', () => {
  inventoryPanel.style.display = 'none';
});

closeCraftingBtn.addEventListener('click', () => {
  craftingPanel.style.display = 'none';
});

closeSkillsBtn.addEventListener('click', () => {
  skillsPanel.style.display = 'none';
});

restartBtn.addEventListener('click', initGame);

achievementsBtn.addEventListener('click', () => {
  achievementsList.style.display = achievementsList.style.display === 'block' ? 'none' : 'block';
});

settingsBtn.addEventListener('click', () => {
  settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
});

tutorialBtn.addEventListener('click', () => {
  tutorialPanel.style.display = 'flex';
});

closeTutorialBtn.addEventListener('click', () => {
  tutorialPanel.style.display = 'none';
});

soundToggle.addEventListener('change', (e) => {
  gameState.soundsEnabled = e.target.checked;
});

musicToggle.addEventListener('change', (e) => {
  gameState.musicEnabled = e.target.checked;
  if (gameState.musicEnabled) {
    backgroundMusic.volume = gameState.volume * 0.5;
    backgroundMusic.play().catch(e => console.log("Music play failed:", e));
  } else {
    backgroundMusic.pause();
  }
});

volumeSlider.addEventListener('input', (e) => {
  gameState.volume = parseFloat(e.target.value);
  backgroundMusic.volume = gameState.volume * 0.5;
});

// Close panels when clicking outside
document.addEventListener('click', (e) => {
  if (!achievementsBtn.contains(e.target) && !achievementsList.contains(e.target)) {
    achievementsList.style.display = 'none';
  }

  if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) {
    settingsMenu.style.display = 'none';
  }

  if (!inventoryBtn.contains(e.target) && !inventoryPanel.contains(e.target) && e.target !== inventoryBtn) {
    inventoryPanel.style.display = 'none';
  }

  if (!craftingBtn.contains(e.target) && !craftingPanel.contains(e.target) && e.target !== craftingBtn) {
    craftingPanel.style.display = 'none';
  }
  
  if (!skillsBtn.contains(e.target) && !skillsPanel.contains(e.target) && e.target !== skillsBtn) {
    skillsPanel.style.display = 'none';
  }
});

// Start the game
initGame();
</script>
</body>
</html>
