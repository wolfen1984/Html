<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>House of Hell - Level 2: The Cellar</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset and base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'VT323', monospace;
            background-color: #000;
            color: #0f0;
            line-height: 1.4;
            padding: 10px;
            height: 100vh;
            overflow: hidden;
            position: relative;
            touch-action: manipulation;
        }
        
        /* Container */
        .container {
            max-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 2px solid #0f0;
            padding: 10px;
            background-color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px dashed #0f0;
            margin-bottom: 15px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 2rem;
            color: #ff3030;
            text-shadow: 0 0 5px #ff0000;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #0f0;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .level-indicator {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #ff0;
            font-size: 1rem;
            background-color: #000;
            border: 1px solid #0f0;
            padding: 5px 10px;
            border-radius: 10px;
            z-index: 4;
        }
        
        /* Stats Panel */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #111;
            border: 1px solid #0f0;
            border-radius: 5px;
        }
        
        .stat-item {
            text-align: center;
            padding: 3px;
            border: 1px solid #333;
            border-radius: 3px;
            position: relative;
            cursor: help;
        }
        
        .stat-item:hover {
            border-color: #0f0;
            background-color: #222;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .stat-value {
            font-size: 1.3rem;
            color: #ff0;
            font-weight: bold;
        }
        
        .stat-max {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Main Content */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            border: 1px solid #0f0;
            background-color: #111;
            margin-bottom: 15px;
            font-size: 1.2rem;
            line-height: 1.5;
            scrollbar-width: thin;
            scrollbar-color: #0f0 #000;
        }
        
        .content::-webkit-scrollbar {
            width: 10px;
        }
        
        .content::-webkit-scrollbar-track {
            background: #000;
        }
        
        .content::-webkit-scrollbar-thumb {
            background-color: #0f0;
            border-radius: 0;
        }
        
        /* Choices */
        .choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .choice-btn {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            padding: 12px 15px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .choice-btn i {
            font-size: 1.1rem;
        }
        
        .choice-btn:active, .choice-btn:hover {
            background-color: #0f0;
            color: #000;
            transform: translateY(-2px);
        }
        
        .choice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            padding-top: 10px;
            border-top: 1px dashed #0f0;
        }
        
        .control-btn {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .control-btn:active, .control-btn:hover {
            background-color: #0f0;
            color: #000;
        }
        
        /* Loading Screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .loading-text {
            color: #0f0;
            font-size: 1.5rem;
            margin-bottom: 20px;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .loading-bar {
            width: 80%;
            height: 20px;
            border: 1px solid #0f0;
            padding: 2px;
            margin-bottom: 20px;
        }
        
        .loading-progress {
            height: 100%;
            background-color: #0f0;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* Utility */
        .hidden {
            display: none !important;
        }
        
        .footer {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
            padding-top: 10px;
            border-top: 1px dashed #333;
        }
        
        /* Visual Effects */
        .screen-border {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 0, 0.1);
            animation: scanline 10s linear infinite;
            z-index: 2;
        }
        
        @keyframes scanline {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .crt-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                rgba(0, 255, 0, 0.03) 50%,
                rgba(0, 0, 0, 0.03) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 3;
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background-color: #000;
            border: 1px solid #0f0;
            color: #0f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            font-size: 1.2rem;
            border-radius: 50%;
        }
        
        /* Page Navigation */
        .page-nav {
            position: absolute;
            top: 15px;
            left: 70px;
            z-index: 5;
            background: #000;
            border: 1px solid #0f0;
            color: #0f0;
            padding: 5px 15px;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 1rem;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .page-nav:hover {
            background-color: #0f0;
            color: #000;
        }
        
        /* Responsive */
        @media (max-height: 700px) {
            h1 { font-size: 1.7rem; }
            .subtitle { font-size: 1rem; }
            .content { font-size: 1.1rem; }
            .choice-btn { padding: 10px 12px; font-size: 1.1rem; }
        }
        
        @media (max-width: 400px) {
            .container { padding: 8px; }
            h1 { font-size: 1.5rem; }
            .choice-btn { padding: 8px 10px; font-size: 1rem; }
            .page-nav { left: 60px; padding: 5px 10px; }
        }
        
        /* Death Message */
        .death-message {
            color: #ff3030;
            animation: pulse 2s infinite;
            text-align: center;
            padding: 10px;
            border: 1px solid #ff3030;
            margin: 10px 0;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Enhanced Inventory Panel */
        .inventory-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 50;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }
        
        .inventory-header {
            padding: 15px;
            background-color: #000;
            border-bottom: 2px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .inventory-title {
            color: #ff0;
            font-size: 1.5rem;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
        }
        
        .inventory-close {
            background: none;
            border: 1px solid #0f0;
            color: #0f0;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .inventory-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .inventory-item-card {
            background-color: #111;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .inventory-item-card:hover {
            transform: translateY(-5px);
            border-color: #0f0;
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.2);
        }
        
        .inventory-item-card.item-equipped {
            border-color: #ff0;
            background-color: #222;
        }
        
        .item-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #0f0;
        }
        
        .item-name {
            font-size: 1rem;
            margin-bottom: 5px;
            color: #fff;
        }
        
        .item-type {
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 5px;
        }
        
        .item-quantity {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #0f0;
            color: #000;
            font-size: 0.8rem;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .item-details {
            background-color: #000;
            border: 1px solid #0f0;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }
        
        .item-description {
            color: #ccc;
            font-size: 1rem;
            line-height: 1.4;
        }
        
        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .item-action-btn {
            flex: 1;
            padding: 8px;
            background-color: #000;
            border: 1px solid #0f0;
            color: #0f0;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .item-action-btn:hover {
            background-color: #0f0;
            color: #000;
        }
        
        .inventory-footer {
            padding: 15px;
            background-color: #000;
            border-top: 2px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .inventory-stats {
            color: #0f0;
            font-size: 1rem;
        }
        
        .inventory-empty {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2rem;
        }
        
        /* Inventory Button */
        .inventory-toggle {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 5;
            background: #000;
            border: 1px solid #0f0;
            color: #0f0;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .inventory-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .inventory-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff3030;
            color: #000;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Combat Panel */
        .combat-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            border: 2px solid #ff3030;
            padding: 20px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }
        
        .combat-title {
            color: #ff3030;
            text-align: center;
            font-size: 2rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #ff0000;
            animation: glow 2s infinite;
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 10px #ff0000; }
            50% { text-shadow: 0 0 20px #ff0000, 0 0 30px #ff3030; }
        }
        
        .combatants {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            gap: 20px;
        }
        
        .combatant {
            flex: 1;
            text-align: center;
            padding: 20px;
            border: 2px solid #0f0;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .combatant.enemy {
            border-color: #ff3030;
        }
        
        .combatant-name {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #ff0;
        }
        
        .combatant.enemy .combatant-name {
            color: #ff3030;
        }
        
        .combatant-stats {
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        
        .health-bar-container {
            margin: 10px 0;
        }
        
        .health-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        .health-bar {
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #444;
        }
        
        .health-fill {
            height: 100%;
            background-color: #0f0;
            transition: width 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .health-fill.enemy {
            background-color: #ff3030;
        }
        
        .health-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.1) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .combat-log {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #0f0;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 1.1rem;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 5px;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-bottom: 1px dotted #333;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .player-log {
            color: #0f0;
            border-left: 3px solid #0f0;
            padding-left: 10px;
        }
        
        .enemy-log {
            color: #ff3030;
            border-left: 3px solid #ff3030;
            padding-left: 10px;
        }
        
        .event-log {
            color: #ff0;
            border-left: 3px solid #ff0;
            padding-left: 10px;
        }
        
        .combat-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .combat-btn {
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            font-family: 'VT323', monospace;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
            border-radius: 5px;
        }
        
        .combat-btn:hover {
            background-color: #0f0;
            color: #000;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.3);
        }
        
        .combat-btn.attack {
            border-color: #ff3030;
            color: #ff3030;
        }
        
        .combat-btn.attack:hover {
            background-color: #ff3030;
            color: #000;
            box-shadow: 0 5px 15px rgba(255, 48, 48, 0.3);
        }
        
        .combat-btn.flee {
            border-color: #ff8000;
            color: #ff8000;
        }
        
        .combat-btn.flee:hover {
            background-color: #ff8000;
            color: #000;
        }
        
        /* Dialog Panel */
        .dialog-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.95);
            border: 2px solid #0f0;
            padding: 20px;
            z-index: 20;
            width: 90%;
            max-width: 400px;
        }
        
        .dialog-title {
            color: #0f0;
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
            border-bottom: 1px solid #0f0;
            padding-bottom: 5px;
        }
        
        .dialog-text {
            margin-bottom: 20px;
            font-size: 1.1rem;
            line-height: 1.4;
        }
        
        .dialog-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .dialog-option {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            font-family: 'VT323', monospace;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .dialog-option:hover {
            background-color: #0f0;
            color: #000;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.95);
            border: 1px solid #0f0;
            padding: 15px 20px;
            z-index: 30;
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.2);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-close {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #0f0;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .loading-tip {
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
            text-align: center;
            max-width: 80%;
        }
        
        /* Stat tooltip */
        .stat-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #000;
            border: 1px solid #0f0;
            padding: 10px;
            font-size: 0.9rem;
            white-space: nowrap;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            margin-bottom: 5px;
        }
        
        .stat-item:hover .stat-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Damage numbers */
        .damage-number {
            position: absolute;
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 0 0 5px #000;
            z-index: 100;
        }
        
        .damage-number.player {
            color: #ff3030;
        }
        
        .damage-number.enemy {
            color: #0f0;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        /* Item tooltip */
        .item-tooltip {
            position: absolute;
            background-color: #000;
            border: 1px solid #0f0;
            padding: 10px;
            font-size: 0.9rem;
            max-width: 200px;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .inventory-item-card:hover .item-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Level Complete Screen */
        .level-complete {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 60;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .level-complete h2 {
            color: #ff0;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
            animation: glow 2s infinite;
        }
        
        .level-complete p {
            font-size: 1.5rem;
            margin-bottom: 30px;
            max-width: 600px;
        }
        
        .level-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #0f0;
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
            width: 100%;
        }
        
        .level-stat {
            text-align: center;
        }
        
        .level-stat-value {
            font-size: 2rem;
            color: #0f0;
            margin-bottom: 5px;
        }
        
        .level-stat-label {
            font-size: 1rem;
            color: #aaa;
        }
        
        .level-complete-buttons {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .level-complete-btn {
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            font-family: 'VT323', monospace;
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
            border-radius: 5px;
            min-width: 150px;
        }
        
        .level-complete-btn:hover {
            background-color: #0f0;
            color: #000;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.3);
        }
        
        .level-complete-btn.next {
            background-color: #000;
            color: #ff0;
            border-color: #ff0;
        }
        
        .level-complete-btn.next:hover {
            background-color: #ff0;
            color: #000;
            box-shadow: 0 5px 15px rgba(255, 255, 0, 0.3);
        }
        
        /* Level 2 specific: darker theme for cellar */
        .cellar-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(20, 0, 0, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(10, 0, 10, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .dripping-effect {
            position: absolute;
            width: 2px;
            height: 30px;
            background: rgba(0, 255, 0, 0.1);
            animation: drip 3s infinite;
        }
        
        @keyframes drip {
            0% { transform: translateY(-30px); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="screen-border"></div>
    <div class="scanline"></div>
    <div class="crt-effect"></div>
    <div class="cellar-effect"></div>
    
    <!-- Dripping water effects -->
    <div class="dripping-effect" style="left: 20%; animation-delay: 0s;"></div>
    <div class="dripping-effect" style="left: 50%; animation-delay: 1s;"></div>
    <div class="dripping-effect" style="left: 80%; animation-delay: 2s;"></div>
    
    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="loading-text">HOUSE OF HELL</div>
        <div class="loading-text">LEVEL 2 - THE CELLAR</div>
        <div class="loading-text">LOADING ADVENTURE...</div>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <div class="loading-text" id="loadingStatus">Loading your progress from Level 1...</div>
        <div class="loading-tip">The cellar is darker and more dangerous. Watch your step.</div>
    </div>
    
    <!-- Main Game Container -->
    <div class="container hidden" id="gameContainer">
        <!-- Top Controls -->
        <button class="sound-toggle" id="soundToggle">ðŸ”Š</button>
        <button class="inventory-toggle" id="inventoryToggle" title="Inventory">
            <i class="fas fa-backpack"></i>
            <span class="inventory-badge" id="inventoryBadge">0</span>
        </button>
        
        <!-- Page Navigation -->
        <button class="page-nav" id="pageNav" title="Select Level">
            <i class="fas fa-map"></i> Level 2
        </button>
        
        <!-- Enhanced Inventory Panel -->
        <div class="inventory-panel hidden" id="inventoryPanel">
            <div class="inventory-header">
                <div class="inventory-title">INVENTORY - LEVEL 2</div>
                <button class="inventory-close" id="inventoryClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="inventory-content" id="inventoryContent">
                <!-- Items will be added here -->
            </div>
            <div class="inventory-footer">
                <div class="inventory-stats">
                    <span id="inventoryWeight">Weight: 0/10</span> | 
                    <span id="inventoryGold">Gold: 0</span> | 
                    <span id="inventoryCount">Items: 0</span>
                </div>
                <button class="item-action-btn" id="organizeInventory">
                    <i class="fas fa-sort-alpha-down"></i> Organize
                </button>
            </div>
        </div>
        
        <!-- Header -->
        <div class="header">
            <div>
                <h1>HOUSE OF HELL</h1>
                <div class="subtitle">Level 2 - The Cellar</div>
            </div>
            <div class="level-indicator">Level 2</div>
        </div>
        
        <!-- Stats Panel -->
        <div class="stats-panel">
            <div class="stat-item">
                <div class="stat-label">FEAR</div>
                <div class="stat-value" id="fearValue">0</div>
                <div class="stat-max">/20</div>
                <div class="stat-tooltip">Fear level. If it reaches 20, you go mad!</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">STAMINA</div>
                <div class="stat-value" id="staminaValue">20</div>
                <div class="stat-max">/20</div>
                <div class="stat-tooltip">Your health. If it reaches 0, you die!</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">SKILL</div>
                <div class="stat-value" id="skillValue">7</div>
                <div class="stat-max">/12</div>
                <div class="stat-tooltip">Your fighting ability. Higher is better!</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">LUCK</div>
                <div class="stat-value" id="luckValue">12</div>
                <div class="stat-max">/12</div>
                <div class="stat-tooltip">Your luck. Test it in dangerous situations!</div>
            </div>
        </div>
        
        <!-- Story Text -->
        <div class="content" id="storyText">
            <!-- Story text will appear here -->
        </div>
        
        <!-- Choices -->
        <div class="choices" id="choicesContainer">
            <!-- Choice buttons will appear here -->
        </div>
        
        <!-- Bottom Controls -->
        <div class="controls">
            <button class="control-btn" id="restartBtn">
                <i class="fas fa-redo"></i> RESTART
            </button>
            <button class="control-btn" id="saveBtn">
                <i class="fas fa-save"></i> SAVE
            </button>
            <button class="control-btn" id="loadBtn">
                <i class="fas fa-folder-open"></i> LOAD
            </button>
            <button class="control-btn" id="hintBtn">
                <i class="fas fa-lightbulb"></i> HINT
            </button>
        </div>
        
        <div class="footer">
            Based on the gamebook by Steve Jackson & Ian Livingstone | Enhanced Edition | Level 2 of 4
        </div>
        
        <!-- Enhanced Combat Panel -->
        <div class="combat-panel hidden" id="combatPanel">
            <div class="combat-title">COMBAT</div>
            <div class="combatants">
                <div class="combatant player">
                    <div class="combatant-name" id="playerCombatName">YOU</div>
                    <div class="combatant-stats">
                        <div>SKILL: <span id="playerCombatSkill">7</span></div>
                        <div>STAMINA: <span id="playerCombatStamina">20</span></div>
                        <div>LUCK: <span id="playerCombatLuck">12</span></div>
                    </div>
                    <div class="health-bar-container">
                        <div class="health-bar-label">
                            <span>HEALTH</span>
                            <span id="playerHealthText">20/20</span>
                        </div>
                        <div class="health-bar">
                            <div class="health-fill" id="playerHealthBar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="combatant enemy">
                    <div class="combatant-name" id="enemyCombatName">ENEMY</div>
                    <div class="combatant-stats">
                        <div>SKILL: <span id="enemyCombatSkill">6</span></div>
                        <div>STAMINA: <span id="enemyCombatStamina">10</span></div>
                    </div>
                    <div class="health-bar-container">
                        <div class="health-bar-label">
                            <span>HEALTH</span>
                            <span id="enemyHealthText">10/10</span>
                        </div>
                        <div class="health-bar">
                            <div class="health-fill enemy" id="enemyHealthBar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="combat-log" id="combatLog"></div>
            <div class="combat-actions" id="combatActions">
                <button class="combat-btn attack" id="combatAttack">
                    <i class="fas fa-fist-raised"></i> ATTACK
                </button>
                <button class="combat-btn" id="combatUseItem">
                    <i class="fas fa-box-open"></i> USE ITEM
                </button>
                <button class="combat-btn" id="combatLuck">
                    <i class="fas fa-dice"></i> TEST LUCK
                </button>
                <button class="combat-btn flee" id="combatFlee">
                    <i class="fas fa-running"></i> FLEE
                </button>
            </div>
        </div>
        
        <!-- Dialog Panel -->
        <div class="dialog-panel hidden" id="dialogPanel">
            <div class="dialog-title" id="dialogTitle">DIALOG</div>
            <div class="dialog-text" id="dialogText"></div>
            <div class="dialog-options" id="dialogOptions"></div>
        </div>
        
        <!-- Notification -->
        <div class="notification hidden" id="notification">
            <button class="notification-close" id="notificationClose">&times;</button>
            <div id="notificationText"></div>
        </div>
        
        <!-- Level Complete Screen -->
        <div class="level-complete hidden" id="levelComplete">
            <h2>LEVEL 2 COMPLETE!</h2>
            <p>You have survived the cellar of the House of Hell. The deeper you go, the more terrifying it becomes...</p>
            
            <div class="level-stats">
                <div class="level-stat">
                    <div class="level-stat-value" id="completeFear">0</div>
                    <div class="level-stat-label">Fear</div>
                </div>
                <div class="level-stat">
                    <div class="level-stat-value" id="completeStamina">20</div>
                    <div class="level-stat-label">Stamina</div>
                </div>
                <div class="level-stat">
                    <div class="level-stat-value" id="completeItems">0</div>
                    <div class="level-stat-label">Items</div>
                </div>
                <div class="level-stat">
                    <div class="level-stat-value" id="completeGold">0</div>
                    <div class="level-stat-label">Gold</div>
                </div>
            </div>
            
            <p>Your progress has been saved. Continue to the next level or stay and explore more.</p>
            
            <div class="level-complete-buttons">
                <button class="level-complete-btn" id="continueExploring">
                    <i class="fas fa-search"></i> Keep Exploring
                </button>
                <button class="level-complete-btn next" id="nextLevelBtn">
                    <i class="fas fa-arrow-right"></i> Next Level
                </button>
            </div>
        </div>
    </div>

<script>
// ============================================
// SOUND MANAGER
// ============================================

class SoundManager {
    constructor() {
        this.sounds = {};
        this.enabled = true;
        this.context = null;
        this.initialized = false;
        this.masterVolume = 0.7;
        
        // Sound definitions
        this.soundDefs = {
            'click': { type: 'synth', frequency: 800, duration: 0.1, volume: 0.3 },
            'hover': { type: 'synth', frequency: 600, duration: 0.05, volume: 0.2 },
            'combat_attack': { type: 'synth', frequency: 1200, duration: 0.2, volume: 0.5 },
            'combat_hit': { type: 'synth', frequency: 300, duration: 0.1, volume: 0.6 },
            'combat_miss': { type: 'synth', frequency: 200, duration: 0.1, volume: 0.4 },
            'combat_critical': { type: 'synth', frequency: 1500, duration: 0.3, volume: 0.7 },
            'item_pickup': { type: 'synth', frequency: 1000, duration: 0.2, volume: 0.4 },
            'item_use': { type: 'synth', frequency: 1200, duration: 0.3, volume: 0.5 },
            'heal': { type: 'synth', frequency: 800, duration: 0.5, volume: 0.5 },
            'damage': { type: 'synth', frequency: 400, duration: 0.2, volume: 0.6 },
            'death': { type: 'synth', frequency: 200, duration: 1.0, volume: 0.8 },
            'victory': { type: 'synth', frequency: 1500, duration: 0.5, volume: 0.6 },
            'fear': { type: 'synth', frequency: 500, duration: 0.3, volume: 0.5 },
            'menu_open': { type: 'synth', frequency: 700, duration: 0.2, volume: 0.4 },
            'menu_close': { type: 'synth', frequency: 600, duration: 0.2, volume: 0.4 },
            'level_complete': { type: 'synth', frequency: 1200, duration: 0.8, volume: 0.7 },
            'drip': { type: 'synth', frequency: 300, duration: 0.1, volume: 0.2 }
        };
    }
    
    init() {
        if (this.initialized) return;
        
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            this.context = new AudioContext();
            this.initialized = true;
            console.log("SoundManager initialized");
        } catch (e) {
            console.error("Web Audio API not supported:", e);
            this.enabled = false;
        }
    }
    
    play(soundName) {
        if (!this.enabled || !this.initialized || !this.context) return;
        
        const sound = this.soundDefs[soundName];
        if (!sound) return;
        
        if (sound.type === 'synth') {
            this.playSynth(sound.frequency, sound.duration, sound.volume);
        }
    }
    
    playSynth(frequency, duration, volume = 0.5) {
        const oscillator = this.context.createOscillator();
        const gainNode = this.context.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(this.context.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.value = volume * this.masterVolume;
        
        const now = this.context.currentTime;
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
        
        oscillator.start(now);
        oscillator.stop(now + duration);
    }
    
    playAttackSound(damage, isCritical = false) {
        if (isCritical) {
            this.play('combat_critical');
        } else if (damage > 0) {
            this.play('combat_hit');
        } else {
            this.play('combat_miss');
        }
    }
    
    toggle() {
        this.enabled = !this.enabled;
        return this.enabled;
    }
    
    setVolume(volume) {
        this.masterVolume = Math.max(0, Math.min(1, volume));
    }
}

// ============================================
// GAME DATA & MULTI-PAGE SYSTEM
// ============================================

// Game state with level tracking - LEVEL 2 SPECIFIC
const gameState = {
    currentLevel: 2, // CHANGED TO 2 FOR LEVEL 2
    currentSection: 1,
    fear: 0,
    stamina: 20,
    skill: 7,
    luck: 12,
    inventory: [],
    equippedWeapon: null,
    gold: 0,
    soundEnabled: true,
    inCombat: false,
    inDialog: false,
    combatData: null,
    npcData: null,
    inventoryOpen: false,
    visitedSections: [],
    levelsCompleted: []
};

// Item database - ADDING NEW LEVEL 2 ITEMS
const items = {
    "Silver Key": {
        name: "Silver Key",
        description: "A finely crafted silver key that might unlock certain doors in the mansion.",
        type: "key",
        weight: 0.1,
        usable: false,
        icon: "fa-key"
    },
    "Crucifix": {
        name: "Crucifix",
        description: "A religious symbol that can ward off evil spirits. Particularly effective against undead.",
        type: "tool",
        weight: 0.5,
        usable: true,
        vsUndeadDamage: 6,
        icon: "fa-cross"
    },
    "Iron Dagger": {
        name: "Iron Dagger",
        description: "A sharp iron dagger for combat. Better than nothing in a fight.",
        type: "weapon",
        weight: 1,
        usable: true,
        damage: 3,
        icon: "fa-dagger"
    },
    "Torch": {
        name: "Torch",
        description: "Provides light in dark places. May reveal hidden passages.",
        type: "tool",
        weight: 1.5,
        usable: true,
        icon: "fa-fire"
    },
    "Butcher's Knife": {
        name: "Butcher's Knife",
        description: "A large, sharp kitchen knife. Deals significant damage but is unwieldy.",
        type: "weapon",
        weight: 1.2,
        usable: true,
        damage: 4,
        icon: "fa-knife-kitchen"
    },
    "Healing Potion": {
        name: "Healing Potion",
        description: "Restores 5 STAMINA when consumed. Has a faint herbal aroma.",
        type: "consumable",
        weight: 0.5,
        usable: true,
        staminaRestore: 5,
        icon: "fa-flask"
    },
    "Lucky Charm": {
        name: "Lucky Charm",
        description: "A small charm that makes you feel luckier. Grants +1 to LUCK tests.",
        type: "trinket",
        weight: 0.2,
        usable: false,
        luckBonus: 1,
        icon: "fa-clover"
    },
    // NEW LEVEL 2 ITEMS
    "Rusty Key": {
        name: "Rusty Key",
        description: "An old, rusty iron key. It might open something in the cellar.",
        type: "key",
        weight: 0.2,
        usable: false,
        icon: "fa-key"
    },
    "Wine Bottle": {
        name: "Wine Bottle",
        description: "An old bottle of wine. Could be used as a weapon or to bribe someone.",
        type: "tool",
        weight: 1,
        usable: true,
        damage: 2,
        icon: "fa-wine-bottle"
    },
    "Iron Shackles": {
        name: "Iron Shackles",
        description: "Old, broken shackles. Heavy but could be useful.",
        type: "tool",
        weight: 2,
        usable: false,
        icon: "fa-link"
    },
    "Moldy Bread": {
        name: "Moldy Bread",
        description: "A stale loaf of bread covered in mold. Might restore 2 STAMINA if desperate.",
        type: "consumable",
        weight: 0.3,
        usable: true,
        staminaRestore: 2,
        icon: "fa-bread-slice"
    }
};

// Enemy database - ADDING NEW LEVEL 2 ENEMIES
const enemies = {
    "Cultist": {
        name: "Cultist",
        skill: 6,
        stamina: 8,
        damage: 2,
        fear: 1,
        gold: 5,
        description: "A robed figure chanting dark rituals.",
        icon: "fa-user-ninja"
    },
    "Ghost": {
        name: "Ghost",
        skill: 7,
        stamina: 10,
        damage: 3,
        fear: 3,
        gold: 0,
        weakTo: "holy",
        description: "A spectral apparition with chilling touch.",
        icon: "fa-ghost"
    },
    "Giant Rat": {
        name: "Giant Rat",
        skill: 5,
        stamina: 6,
        damage: 1,
        fear: 0,
        gold: 2,
        description: "A massive rodent with sharp teeth.",
        icon: "fa-paw"
    },
    "Zombie": {
        name: "Zombie",
        skill: 4,
        stamina: 12,
        damage: 2,
        fear: 2,
        gold: 0,
        description: "A slow-moving but resilient undead creature.",
        icon: "fa-skull"
    },
    // NEW LEVEL 2 ENEMIES
    "Mutated Rat": {
        name: "Mutated Rat",
        skill: 6,
        stamina: 10,
        damage: 2,
        fear: 1,
        gold: 3,
        description: "A giant rat twisted by dark magic.",
        icon: "fa-paw"
    },
    "Skeleton": {
        name: "Skeleton",
        skill: 5,
        stamina: 8,
        damage: 2,
        fear: 1,
        gold: 0,
        weakTo: "blunt",
        description: "Animated bones wielding a rusty sword.",
        icon: "fa-skull"
    },
    "Cave Spider": {
        name: "Cave Spider",
        skill: 7,
        stamina: 6,
        damage: 3,
        fear: 2,
        gold: 1,
        description: "A massive spider with venomous fangs.",
        icon: "fa-spider"
    }
};

// Story sections for Level 2 - THE CELLAR
const storySections = {
    1: {
        text: "The staircase descends into complete darkness. The air grows cold and damp. You hear dripping water and faint scurrying sounds. As you reach the bottom, your eyes adjust to reveal a vast cellar filled with wine barrels, crates, and strange symbols carved into the stone walls.",
        choices: [
            { text: "Light your torch (if you have one)", next: 2, requireItem: "Torch", icon: "fa-fire", sound: "click" },
            { text: "Feel your way forward in the dark", next: 3, effect: { fear: 1 }, icon: "fa-blind", sound: "click" },
            { text: "Search near the staircase", next: 4, icon: "fa-search", sound: "click" }
        ]
    },
    2: {
        text: "The torch flares to life, casting flickering shadows across the cellar. You see three passageways leading deeper into the darkness. The middle passage has strange claw marks on the walls.",
        choices: [
            { text: "Take the left passage", next: 5, icon: "fa-arrow-left", sound: "click" },
            { text: "Take the middle passage", next: 6, icon: "fa-arrow-up", sound: "click" },
            { text: "Take the right passage", next: 7, icon: "fa-arrow-right", sound: "click" }
        ]
    },
    3: {
        text: "You stumble forward in the darkness, hands outstretched. Something brushes against your face - cobwebs. You hear skittering sounds all around. Suddenly, you trip over something metallic.",
        choices: [
            { text: "Investigate what you tripped over", next: 8, icon: "fa-search", sound: "click" },
            { text: "Quickly backtrack to the staircase", next: 1, icon: "fa-arrow-left", sound: "click" },
            { text: "Call out for help", next: 9, effect: { fear: 2 }, icon: "fa-volume-up", sound: "click" }
        ]
    },
    4: {
        text: "Near the base of the staircase, you find a small alcove. Inside is a rusty key hanging on a nail, and an old wine bottle covered in dust.",
        choices: [
            { text: "Take the rusty key", action: "addItem", item: "Rusty Key", icon: "fa-key", sound: "item_pickup" },
            { text: "Take the wine bottle", action: "addItem", item: "Wine Bottle", icon: "fa-wine-bottle", sound: "item_pickup" },
            { text: "Take both items", action: "addMultiple", items: ["Rusty Key", "Wine Bottle"], icon: "fa-box-open", sound: "item_pickup" },
            { text: "Continue exploring", next: 1, icon: "fa-arrow-right", sound: "click" }
        ]
    },
    5: {
        text: "The left passage leads to a wine storage area. Rows of barrels line the walls, many broken and empty. In the corner, you spot a skeleton chained to the wall with iron shackles.",
        choices: [
            { text: "Search the skeleton", next: 10, icon: "fa-search", sound: "click" },
            { text: "Take the iron shackles", action: "addItem", item: "Iron Shackles", icon: "fa-link", sound: "item_pickup" },
            { text: "Taste the wine from a barrel", next: 11, icon: "fa-wine-glass", sound: "click" }
        ]
    },
    6: {
        text: "The middle passage slopes downward. The claw marks on the walls grow deeper and more frequent. The air smells of rot and decay. A pair of glowing red eyes appears in the darkness ahead!",
        choices: [
            { text: "Attack the creature", action: "startCombat", enemy: "Mutated Rat", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Throw your torch at it", next: 12, requireItem: "Torch", icon: "fa-fire", sound: "combat_attack" },
            { text: "Run back the way you came", next: 2, effect: { stamina: -1 }, icon: "fa-running", sound: "damage" }
        ]
    },
    7: {
        text: "The right passage opens into a natural cave formation. Stalactites drip water from the ceiling. You see mushrooms glowing with a faint blue light. In the center of the cave, a skeleton guards a wooden chest.",
        choices: [
            { text: "Approach the skeleton", action: "startCombat", enemy: "Skeleton", icon: "fa-skull", sound: "combat_attack" },
            { text: "Try to sneak past the skeleton", next: 13, icon: "fa-user-ninja", sound: "click" },
            { text: "Examine the glowing mushrooms", next: 14, icon: "fa-seedling", sound: "click" }
        ]
    },
    8: {
        text: "You feel around in the dark and find an iron bar. It's cold and slightly wet. As you pick it up, you hear a low growl nearby. Something is in the darkness with you.",
        choices: [
            { text: "Swing the iron bar blindly", next: 15, icon: "fa-baseball-bat", sound: "combat_attack" },
            { text: "Stay perfectly still", next: 16, icon: "fa-stop", sound: "click" },
            { text: "Run while swinging the bar", next: 17, effect: { stamina: -2 }, icon: "fa-running", sound: "damage" }
        ]
    },
    9: {
        text: "Your call echoes through the cellar. For a moment, there's only silence. Then you hear multiple sets of footsteps approaching from different directions. You're surrounded!",
        choices: [
            { text: "Fight whatever comes", action: "startCombat", enemy: "Cultist", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Try to hide", next: 18, icon: "fa-eye-slash", sound: "click" },
            { text: "Scream and run", next: 19, effect: { fear: 3, stamina: -3 }, icon: "fa-running", sound: "damage" }
        ]
    },
    10: {
        text: "The skeleton's bones crumble as you search it. Among the remains, you find a small leather pouch containing 8 gold coins and a moldy loaf of bread wrapped in cloth.",
        choices: [
            { text: "Take the gold", action: "addGold", amount: 8, icon: "fa-coins", sound: "item_pickup" },
            { text: "Take the moldy bread", action: "addItem", item: "Moldy Bread", icon: "fa-bread-slice", sound: "item_pickup" },
            { text: "Take both", action: "addMultiple", actions: ["addGold:8", "addItem:Moldy Bread"], icon: "fa-box-open", sound: "item_pickup" },
            { text: "Leave the remains alone", next: 5, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    11: {
        text: "You take a sip from a less-damaged barrel. The wine is bitter and sour, but drinkable. You feel slightly lightheaded but also strangely fortified.",
        choices: [
            { text: "Drink more", next: 20, effect: { stamina: 2, skill: -1 }, icon: "fa-wine-glass-alt", sound: "heal" },
            { text: "Stop drinking", next: 5, icon: "fa-stop", sound: "click" }
        ]
    },
    12: {
        text: "You throw your torch at the glowing eyes. There's a shriek and the sound of something scurrying away. The torch lands on the ground, still burning, revealing a massive mutated rat retreating into a hole in the wall.",
        choices: [
            { text: "Retrieve your torch", next: 21, effect: { stamina: 1 }, icon: "fa-fire", sound: "item_pickup" },
            { text: "Continue down the passage", next: 22, icon: "fa-arrow-right", sound: "click" },
            { text: "Go back", next: 2, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    13: {
        text: "You try to move quietly past the skeleton. Halfway across the cave, your foot dislodges a stone. The skeleton's head turns toward you with a creaking sound!",
        choices: [
            { text: "Attack the skeleton", action: "startCombat", enemy: "Skeleton", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Run for the chest", next: 23, icon: "fa-running", sound: "click" },
            { text: "Try to bribe it with wine", next: 24, requireItem: "Wine Bottle", icon: "fa-wine-bottle", sound: "click" }
        ]
    },
    14: {
        text: "The glowing mushrooms give off a soft blue light. They seem to pulsate slowly. As you touch one, a sweet scent fills the air. The light grows brighter, illuminating more of the cave.",
        choices: [
            { text: "Eat a mushroom", next: 25, effect: { stamina: 3, fear: 1 }, icon: "fa-utensils", sound: "heal" },
            { text: "Take some mushrooms", action: "addItem", item: "Healing Potion", icon: "fa-flask", sound: "item_pickup" },
            { text: "Leave them alone", next: 7, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    15: {
        text: "You swing the iron bar wildly in the darkness. It connects with something solid! There's a yelp and the sound of something retreating. You've scared off whatever was there.",
        choices: [
            { text: "Keep the iron bar", action: "addItem", item: "Butcher's Knife", icon: "fa-knife-kitchen", sound: "item_pickup" },
            { text: "Drop the bar and run", next: 3, icon: "fa-running", sound: "click" },
            { text: "Follow the sound", next: 26, icon: "fa-ear-deaf", sound: "click" }
        ]
    },
    16: {
        text: "You freeze in place, barely breathing. The growling continues for a minute, then fades away. Whatever it was has moved on. You're alone again in the darkness.",
        choices: [
            { text: "Continue forward carefully", next: 27, icon: "fa-walking", sound: "click" },
            { text: "Go back to the staircase", next: 1, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    17: {
        text: "You swing the iron bar as you run blindly. Your shoulder smashes into a stone pillar. The pain is intense, but you keep running until you reach a lit area.",
        choices: [
            { text: "Tend to your injury", next: 28, icon: "fa-first-aid", sound: "heal" },
            { text: "Keep moving despite the pain", next: 29, icon: "fa-running", sound: "click" }
        ]
    },
    18: {
        text: "You squeeze behind a large wine barrel just as three robed figures enter the area. They're chanting in a language you don't understand. One carries a bloody knife.",
        choices: [
            { text: "Stay hidden", next: 30, icon: "fa-eye-slash", sound: "click" },
            { text: "Attack from hiding", action: "startCombat", enemy: "Cultist", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Try to sneak away", next: 31, icon: "fa-user-ninja", sound: "click" }
        ]
    },
    19: {
        text: "Your scream echoes through the cellar as you run blindly. You trip and fall down a short flight of stairs, landing in a heap at the bottom. You're bruised but alive.",
        choices: [
            { text: "Assess your injuries", next: 32, icon: "fa-user-injured", sound: "click" },
            { text: "Get up and keep running", next: 33, icon: "fa-running", sound: "click" }
        ]
    },
    20: {
        text: "You drink more of the sour wine. Your head spins and your vision blurs, but you feel a surge of energy. However, your movements feel clumsy and uncoordinated.",
        choices: [
            { text: "Drink even more", next: 34, effect: { stamina: 3, skill: -2, luck: -1 }, icon: "fa-wine-bottle", sound: "heal" },
            { text: "That's enough", next: 5, icon: "fa-stop", sound: "click" }
        ]
    },
    21: {
        text: "You retrieve your torch from the ground. The mutated rat is gone. The passage continues downward, growing even darker ahead.",
        choices: [
            { text: "Continue down the passage", next: 22, icon: "fa-arrow-down", sound: "click" },
            { text: "Go back", next: 2, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    22: {
        text: "The passage ends at a heavy iron door with a rusty lock. The door is covered in strange symbols that seem to writhe in the torchlight. This looks important.",
        choices: [
            { text: "Try the rusty key", next: 35, requireItem: "Rusty Key", icon: "fa-key", sound: "click" },
            { text: "Force the door open", next: 36, icon: "fa-door-open", sound: "click" },
            { text: "Examine the symbols", next: 37, icon: "fa-eye", sound: "click" }
        ]
    },
    23: {
        text: "You dash for the chest as the skeleton lumbers toward you. You reach the chest and throw it open just as bony hands grab your shoulders!",
        choices: [
            { text: "Fight off the skeleton", action: "startCombat", enemy: "Skeleton", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Grab something from the chest", next: 38, icon: "fa-box-open", sound: "item_pickup" }
        ]
    },
    24: {
        text: "You hold out the wine bottle. The skeleton pauses, its empty eye sockets seeming to consider the offering. Slowly, it takes the bottle and retreats to a corner, cradling it like a precious treasure.",
        choices: [
            { text: "Open the chest", next: 39, icon: "fa-box-open", sound: "item_pickup" },
            { text: "Leave while it's distracted", next: 7, icon: "fa-walking", sound: "click" }
        ]
    },
    25: {
        text: "The mushroom tastes earthy and sweet. Almost immediately, you feel a warm glow spreading through your body. Your wounds feel better, but you also see strange shadows moving at the edge of your vision.",
        choices: [
            { text: "Take some for later", action: "addItem", item: "Healing Potion", icon: "fa-flask", sound: "item_pickup" },
            { text: "Return to the passage", next: 7, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    26: {
        text: "You follow the sound of retreating footsteps. They lead you to a small chamber where a wounded giant rat is nursing its injury. It sees you and bares its teeth.",
        choices: [
            { text: "Finish it off", action: "startCombat", enemy: "Giant Rat", icon: "fa-skull", sound: "combat_attack" },
            { text: "Leave it alone", next: 40, icon: "fa-dove", sound: "click" }
        ]
    },
    27: {
        text: "Moving slowly and carefully, you make your way through the darkness. Your hands brush against damp stone walls. After what seems like an eternity, you see a faint light ahead.",
        choices: [
            { text: "Move toward the light", next: 41, icon: "fa-lightbulb", sound: "click" },
            { text: "Proceed with caution", next: 42, icon: "fa-user-shield", sound: "click" }
        ]
    },
    28: {
        text: "You examine your injured shoulder. It's badly bruised but not broken. You tear a strip from your clothing to make a makeshift bandage.",
        choices: [
            { text: "Rest for a moment", next: 43, effect: { stamina: 1 }, icon: "fa-bed", sound: "heal" },
            { text: "Keep moving", next: 44, icon: "fa-walking", sound: "click" }
        ]
    },
    29: {
        text: "Ignoring the pain, you push forward. The passage opens into a larger chamber filled with spiderwebs. Something large moves in the shadows above you.",
        choices: [
            { text: "Attack the creature", action: "startCombat", enemy: "Cave Spider", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Try to avoid it", next: 45, icon: "fa-user-ninja", sound: "click" }
        ]
    },
    30: {
        text: "The cultists perform a strange ritual, chanting and drawing symbols on the floor with what looks like blood. After several minutes, they leave through a different passage.",
        choices: [
            { text: "Examine the ritual site", next: 46, icon: "fa-search", sound: "click" },
            { text: "Follow the cultists", next: 47, icon: "fa-user-secret", sound: "click" },
            { text: "Go the other way", next: 48, icon: "fa-arrow-right", sound: "click" }
        ]
    },
    31: {
        text: "You try to sneak away quietly, but your foot knocks over an empty bottle. It shatters with a loud crash! The cultists turn toward you.",
        choices: [
            { text: "Fight", action: "startCombat", enemy: "Cultist", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Run", next: 49, icon: "fa-running", sound: "click" }
        ]
    },
    32: {
        text: "You're battered and bruised but nothing seems broken. Your stamina has taken a hit from the fall. The room you're in appears to be some kind of storage area.",
        choices: [
            { text: "Search the room", next: 50, icon: "fa-search", sound: "click" },
            { text: "Find a way out", next: 51, icon: "fa-door-open", sound: "click" }
        ]
    },
    33: {
        text: "You scramble to your feet and keep running. The passage twists and turns until you reach a dead end. A ladder leads upward to a trapdoor.",
        choices: [
            { text: "Climb the ladder", next: 52, icon: "fa-arrow-up", sound: "click" },
            { text: "Search the dead end", next: 53, icon: "fa-search", sound: "click" }
        ]
    },
    34: {
        text: "You drink until the barrel is empty. The world spins around you. You stumble and fall, passing out for what feels like hours. When you wake, you have a terrible headache.",
        choices: [
            { text: "Continue exploring", next: 5, effect: { stamina: -2 }, icon: "fa-walking", sound: "damage" }
        ]
    },
    35: {
        text: "The rusty key fits perfectly in the lock. With a loud click, the door swings open. Beyond lies a chamber filled with treasure... and something else.",
        choices: [
            { text: "Enter the chamber", next: 54, icon: "fa-door-open", sound: "click" },
            { text: "Listen first", next: 55, icon: "fa-ear-deaf", sound: "click" }
        ]
    },
    36: {
        text: "You throw your shoulder against the door. It doesn't budge. On the third try, something gives way - but it's your shoulder, not the door!",
        choices: [
            { text: "Try the key (if you have it)", next: 35, requireItem: "Rusty Key", icon: "fa-key", sound: "click" },
            { text: "Give up and go back", next: 22, effect: { stamina: -3 }, icon: "fa-arrow-left", sound: "damage" }
        ]
    },
    37: {
        text: "The symbols seem to tell a story of sacrifice and dark rituals. One symbol in particular catches your eye - it's the same as the one on your crucifix, if you have it.",
        choices: [
            { text: "Touch the symbol", next: 56, icon: "fa-hand-paper", sound: "click" },
            { text: "Try the door again", next: 22, icon: "fa-door-closed", sound: "click" }
        ]
    },
    38: {
        text: "As the skeleton grabs you, you reach into the chest and pull out the first thing you touch - a heavy iron mace! You swing it just in time to block the skeleton's attack.",
        choices: [
            { text: "Fight with the mace", action: "startCombat", enemy: "Skeleton", icon: "fa-hammer", sound: "combat_attack" },
            { text: "Try to escape", next: 7, effect: { stamina: -2 }, icon: "fa-running", sound: "damage" }
        ]
    },
    39: {
        text: "The chest contains a collection of old coins (15 gold), a silver necklace, and a strange amulet that feels warm to the touch.",
        choices: [
            { text: "Take the gold", action: "addGold", amount: 15, icon: "fa-coins", sound: "item_pickup" },
            { text: "Take the amulet", action: "addItem", item: "Lucky Charm", icon: "fa-clover", sound: "item_pickup" },
            { text: "Take everything", action: "addMultiple", actions: ["addGold:15", "addItem:Lucky Charm"], icon: "fa-box-open", sound: "item_pickup" },
            { text: "Leave it", next: 7, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    40: {
        text: "You decide to show mercy and leave the wounded rat alone. As you turn to leave, you notice it's guarding a small pile of shiny objects - coins and a piece of jewelry.",
        choices: [
            { text: "Take the treasure", next: 57, icon: "fa-coins", sound: "item_pickup" },
            { text: "Leave it", next: 26, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    41: {
        text: "The light comes from a single torch burning in a sconce. You're in a circular chamber with three doors. In the center is a stone altar stained with dark patches.",
        choices: [
            { text: "Examine the altar", next: 58, icon: "fa-search", sound: "click" },
            { text: "Take the torch", next: 59, icon: "fa-fire", sound: "item_pickup" },
            { text: "Choose a door", next: 60, icon: "fa-door-closed", sound: "click" }
        ]
    },
    42: {
        text: "You move cautiously toward the light, staying in the shadows. As you get closer, you see two cultists guarding the entrance to a chamber. They haven't noticed you yet.",
        choices: [
            { text: "Attack the guards", action: "startCombat", enemy: "Cultist", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Wait for an opportunity", next: 61, icon: "fa-clock", sound: "click" },
            { text: "Find another way", next: 62, icon: "fa-route", sound: "click" }
        ]
    },
    43: {
        text: "You rest for a few minutes, catching your breath. The pain in your shoulder subsides slightly. From your resting place, you notice a crack in the wall revealing a hidden compartment.",
        choices: [
            { text: "Investigate the compartment", next: 63, icon: "fa-search", sound: "click" },
            { text: "Continue on", next: 44, icon: "fa-walking", sound: "click" }
        ]
    },
    44: {
        text: "You continue through the cellar, moving from chamber to chamber. The air grows colder, and you hear chanting in the distance. You seem to be getting closer to something important.",
        choices: [
            { text: "Follow the chanting", next: 64, icon: "fa-music", sound: "click" },
            { text: "Go away from the chanting", next: 65, icon: "fa-volume-mute", sound: "click" }
        ]
    },
    45: {
        text: "You try to sneak past the spider, but it drops from the ceiling right in front of you! Its eight eyes stare at you hungrily as it raises its front legs.",
        choices: [
            { text: "Fight the spider", action: "startCombat", enemy: "Cave Spider", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Throw something to distract it", next: 66, icon: "fa-bullseye", sound: "click" }
        ]
    },
    46: {
        text: "The ritual site is covered in strange symbols drawn in what looks like blood. In the center lies a sacrificial knife and a black candle that's still warm.",
        choices: [
            { text: "Take the knife", action: "addItem", item: "Butcher's Knife", icon: "fa-knife-kitchen", sound: "item_pickup" },
            { text: "Study the symbols", next: 67, icon: "fa-eye", sound: "click" },
            { text: "Destroy the ritual site", next: 68, icon: "fa-ban", sound: "click" }
        ]
    },
    47: {
        text: "You follow the cultists at a distance. They descend deeper into the cellar, eventually entering a large chamber where more cultists are gathered around a central pit.",
        choices: [
            { text: "Observe from hiding", next: 69, icon: "fa-eye", sound: "click" },
            { text: "Attack the cultists", action: "startCombat", enemy: "Cultist", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Find another way around", next: 70, icon: "fa-route", sound: "click" }
        ]
    },
    48: {
        text: "You go in the opposite direction from the cultists. The passage leads to a natural cave with a underground stream. The water looks clear and drinkable.",
        choices: [
            { text: "Drink the water", next: 71, effect: { stamina: 2 }, icon: "fa-tint", sound: "heal" },
            { text: "Follow the stream", next: 72, icon: "fa-water", sound: "click" },
            { text: "Go back", next: 30, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    49: {
        text: "You run as fast as you can, the cultists close behind. You round a corner and find yourself at a T-junction.",
        choices: [
            { text: "Go left", next: 73, icon: "fa-arrow-left", sound: "click" },
            { text: "Go right", next: 74, icon: "fa-arrow-right", sound: "click" },
            { text: "Hide in a niche", next: 75, icon: "fa-eye-slash", sound: "click" }
        ]
    },
    50: {
        text: "The storage area contains crates and barrels. Most are empty or contain rotten food. However, one small crate contains a healing potion and 10 gold coins.",
        choices: [
            { text: "Take the potion", action: "addItem", item: "Healing Potion", icon: "fa-flask", sound: "item_pickup" },
            { text: "Take the gold", action: "addGold", amount: 10, icon: "fa-coins", sound: "item_pickup" },
            { text: "Take both", action: "addMultiple", actions: ["addItem:Healing Potion", "addGold:10"], icon: "fa-box-open", sound: "item_pickup" },
            { text: "Look for an exit", next: 51, icon: "fa-door-open", sound: "click" }
        ]
    },
    51: {
        text: "You find a wooden door that's not locked. It leads to a corridor that seems familiar - you're back near the wine storage area.",
        choices: [
            { text: "Enter the wine storage", next: 5, icon: "fa-wine-bottle", sound: "click" },
            { text: "Go another way", next: 76, icon: "fa-route", sound: "click" }
        ]
    },
    52: {
        text: "You climb the ladder and push open the trapdoor. You emerge in what looks like a kitchen pantry. You've found a way back to the main house! But your adventure in the cellar isn't over yet.",
        choices: [
            { text: "Continue to Level 3", action: "completeLevel", icon: "fa-arrow-up", sound: "level_complete" },
            { text: "Return to the cellar", next: 33, icon: "fa-arrow-down", sound: "click" }
        ]
    },
    53: {
        text: "The dead end has a small alcove containing a skeleton holding a journal. The last entry reads: 'They're coming for me. The ritual is almost complete. If anyone finds this, destroy the amulet in the treasure chamber.'",
        choices: [
            { text: "Take the journal", action: "addItem", item: "Torch", icon: "fa-book", sound: "item_pickup" },
            { text: "Climb the ladder", next: 52, icon: "fa-arrow-up", sound: "click" }
        ]
    },
    54: {
        text: "The treasure chamber is filled with gold coins, jewels, and artifacts. But in the center stands a ghostly figure guarding the treasure. It turns toward you, its eyes glowing with malevolent light.",
        choices: [
            { text: "Fight the ghost", action: "startCombat", enemy: "Ghost", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Try to reason with it", next: 77, icon: "fa-comment", sound: "click" },
            { text: "Grab some treasure and run", next: 78, icon: "fa-running", sound: "click" }
        ]
    },
    55: {
        text: "You press your ear against the door. You hear faint chanting and what sounds like someone weeping. There's also a periodic scraping sound, like something being dragged across stone.",
        choices: [
            { text: "Open the door slowly", next: 79, icon: "fa-door-open", sound: "click" },
            { text: "Go back", next: 22, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    56: {
        text: "As you touch the symbol, your crucifix (if you have it) grows warm. The symbol glows with a soft light, and the door swings open silently. The chamber beyond is dark and silent.",
        choices: [
            { text: "Enter the chamber", next: 80, requireItem: "Crucifix", icon: "fa-door-open", sound: "click" },
            { text: "The door won't open (no crucifix)", next: 22, icon: "fa-door-closed", sound: "click" }
        ]
    },
    80: {
        text: "The chamber is empty except for a stone pedestal holding a single object: a silver amulet shaped like a crescent moon. It radiates a calming energy that reduces your fear.",
        choices: [
            { text: "Take the amulet", action: "addItem", item: "Lucky Charm", icon: "fa-clover", sound: "item_pickup" },
            { text: "Leave it", next: 22, icon: "fa-arrow-left", sound: "click" }
        ]
    }
};

// ============================================
// GAME FUNCTIONS - UPDATED FOR LEVEL 2
// ============================================

// DOM elements
const loadingScreen = document.getElementById('loading');
const gameContainer = document.getElementById('gameContainer');
const storyText = document.getElementById('storyText');
const choicesContainer = document.getElementById('choicesContainer');
const fearValue = document.getElementById('fearValue');
const staminaValue = document.getElementById('staminaValue');
const skillValue = document.getElementById('skillValue');
const luckValue = document.getElementById('luckValue');
const inventoryToggle = document.getElementById('inventoryToggle');
const inventoryPanel = document.getElementById('inventoryPanel');
const inventoryContent = document.getElementById('inventoryContent');
const inventoryWeight = document.getElementById('inventoryWeight');
const inventoryGold = document.getElementById('inventoryGold');
const inventoryCount = document.getElementById('inventoryCount');
const inventoryBadge = document.getElementById('inventoryBadge');
const inventoryClose = document.getElementById('inventoryClose');
const combatPanel = document.getElementById('combatPanel');
const playerCombatStamina = document.getElementById('playerCombatStamina');
const playerHealthBar = document.getElementById('playerHealthBar');
const playerHealthText = document.getElementById('playerHealthText');
const enemyCombatName = document.getElementById('enemyCombatName');
const enemyCombatSkill = document.getElementById('enemyCombatSkill');
const enemyCombatStamina = document.getElementById('enemyCombatStamina');
const enemyHealthBar = document.getElementById('enemyHealthBar');
const enemyHealthText = document.getElementById('enemyHealthText');
const combatLog = document.getElementById('combatLog');
const notification = document.getElementById('notification');
const notificationText = document.getElementById('notificationText');
const notificationClose = document.getElementById('notificationClose');
const levelComplete = document.getElementById('levelComplete');
const pageNav = document.getElementById('pageNav');
const completeFear = document.getElementById('completeFear');
const completeStamina = document.getElementById('completeStamina');
const completeItems = document.getElementById('completeItems');
const completeGold = document.getElementById('completeGold');
const nextLevelBtn = document.getElementById('nextLevelBtn');
const continueExploring = document.getElementById('continueExploring');

// Sound manager instance
const soundManager = new SoundManager();

// Initialize game
function initGame() {
    console.log("Initializing Level 2...");
    
    // Check for saved game state
    loadGameState();
    
    // Initialize sound manager on first user interaction
    document.addEventListener('click', () => {
        if (!soundManager.initialized) {
            soundManager.init();
        }
    }, { once: true });
    
    simulateLoading();
    setupEventListeners();
}

// Simulate loading
function simulateLoading() {
    let progress = 0;
    const interval = setInterval(() => {
        progress += 5;
        document.getElementById('loadingProgress').style.width = `${progress}%`;
        
        if (progress <= 30) {
            document.getElementById('loadingStatus').textContent = "Loading your progress from Level 1...";
        } else if (progress <= 60) {
            document.getElementById('loadingStatus').textContent = "Initializing Level 2: The Cellar...";
        } else if (progress <= 90) {
            document.getElementById('loadingStatus').textContent = "Preparing dark encounters...";
        } else {
            document.getElementById('loadingStatus').textContent = "Entering the cellar...";
        }
        
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(startGame, 500);
        }
    }, 50);
}

// Start game
function startGame() {
    loadingScreen.classList.add('hidden');
    gameContainer.classList.remove('hidden');
    loadSection(gameState.currentSection);
    updateInventoryDisplay();
    showNotification(`Welcome to Level ${gameState.currentLevel}`, "The cellar awaits. It's darker here...", "info");
    soundManager.play('menu_open');
    
    // Play occasional drip sounds for atmosphere
    setInterval(() => {
        if (gameState.soundEnabled && Math.random() > 0.7) {
            soundManager.play('drip');
        }
    }, 3000);
}

// Setup event listeners
function setupEventListeners() {
    // Inventory toggle
    inventoryToggle.addEventListener('click', () => {
        gameState.inventoryOpen = !gameState.inventoryOpen;
        inventoryPanel.classList.toggle('hidden');
        soundManager.play(gameState.inventoryOpen ? 'menu_open' : 'menu_close');
        
        if (gameState.inventoryOpen) {
            updateInventoryDisplay();
        }
    });
    
    inventoryClose.addEventListener('click', () => {
        gameState.inventoryOpen = false;
        inventoryPanel.classList.add('hidden');
        soundManager.play('menu_close');
    });
    
    // Control buttons
    document.getElementById('restartBtn').addEventListener('click', restartGame);
    document.getElementById('saveBtn').addEventListener('click', saveGame);
    document.getElementById('loadBtn').addEventListener('click', loadGame);
    document.getElementById('hintBtn').addEventListener('click', showHint);
    
    // Sound toggle
    document.getElementById('soundToggle').addEventListener('click', () => {
        gameState.soundEnabled = soundManager.toggle();
        const soundToggle = document.getElementById('soundToggle');
        soundToggle.textContent = gameState.soundEnabled ? "ðŸ”Š" : "ðŸ”‡";
        soundToggle.title = gameState.soundEnabled ? "Sound On" : "Sound Off";
        soundManager.play('click');
    });
    
    // Combat buttons
    document.getElementById('combatAttack').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('combat_attack');
            performAttack();
        }
    });
    
    document.getElementById('combatUseItem').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('click');
            showCombatItems();
        }
    });
    
    document.getElementById('combatLuck').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('click');
            testLuckInCombat();
        }
    });
    
    document.getElementById('combatFlee').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('click');
            tryFlee();
        }
    });
    
    // Notification close
    notificationClose.addEventListener('click', () => {
        notification.classList.add('hidden');
        soundManager.play('menu_close');
    });
    
    // Organize inventory button
    document.getElementById('organizeInventory').addEventListener('click', () => {
        organizeInventory();
        soundManager.play('click');
    });
    
    // Page navigation
    pageNav.addEventListener('click', () => {
        showLevelSelector();
        soundManager.play('menu_open');
    });
    
    // Level complete buttons
    nextLevelBtn.addEventListener('click', goToNextLevel);
    continueExploring.addEventListener('click', () => {
        levelComplete.classList.add('hidden');
        soundManager.play('menu_close');
    });
    
    // Add hover sounds to all buttons
    document.addEventListener('mouseover', (e) => {
        if (e.target.tagName === 'BUTTON' && !e.target.disabled && gameState.soundEnabled) {
            soundManager.play('hover');
        }
    }, true);
}

// ============================================
// MULTI-PAGE SYSTEM FUNCTIONS
// ============================================

// Save game state to localStorage
function saveGameState() {
    try {
        const saveData = {
            currentLevel: gameState.currentLevel,
            currentSection: gameState.currentSection,
            fear: gameState.fear,
            stamina: gameState.stamina,
            skill: gameState.skill,
            luck: gameState.luck,
            inventory: gameState.inventory,
            equippedWeapon: gameState.equippedWeapon,
            gold: gameState.gold,
            soundEnabled: gameState.soundEnabled,
            visitedSections: gameState.visitedSections,
            levelsCompleted: gameState.levelsCompleted
        };
        
        localStorage.setItem('houseOfHellSave', JSON.stringify(saveData));
        console.log("Game state saved to localStorage");
        return true;
    } catch (e) {
        console.error("Failed to save game state:", e);
        return false;
    }
}

// Load game state from localStorage
function loadGameState() {
    try {
        const saved = localStorage.getItem('houseOfHellSave');
        if (saved) {
            const saveData = JSON.parse(saved);
            
            // Load the saved state
            Object.assign(gameState, saveData);
            
            // Ensure we're on the right level
            gameState.currentLevel = 2;
            
            console.log("Game state loaded from localStorage for Level 2");
            return true;
        }
    } catch (e) {
        console.error("Failed to load game state:", e);
    }
    return false;
}

// Complete current level
function completeLevel() {
    soundManager.play('level_complete');
    
    // Add this level to completed levels if not already
    if (!gameState.levelsCompleted.includes(gameState.currentLevel)) {
        gameState.levelsCompleted.push(gameState.currentLevel);
    }
    
    // Save game state
    saveGameState();
    
    // Update level complete screen stats
    completeFear.textContent = gameState.fear;
    completeStamina.textContent = gameState.stamina;
    completeItems.textContent = gameState.inventory.reduce((total, item) => total + (item.quantity || 1), 0);
    completeGold.textContent = gameState.gold;
    
    // Show level complete screen
    levelComplete.classList.remove('hidden');
}

// Go to next level
function goToNextLevel() {
    const nextLevel = gameState.currentLevel + 1;
    
    // Save current state before navigating
    saveGameState();
    
    // Navigate to next level page
    soundManager.play('menu_open');
    setTimeout(() => {
        window.location.href = `level${nextLevel}.html`;
    }, 500);
}

// Show level selector
function showLevelSelector() {
    const dialogTitle = document.getElementById('dialogTitle');
    const dialogText = document.getElementById('dialogText');
    const dialogOptions = document.getElementById('dialogOptions');
    const dialogPanel = document.getElementById('dialogPanel');
    
    dialogTitle.textContent = "SELECT LEVEL";
    dialogText.textContent = "Choose which level to play. Your current progress will be saved.";
    
    dialogOptions.innerHTML = '';
    
    // Create level buttons (for up to 4 levels)
    for (let i = 1; i <= 4; i++) {
        const levelBtn = document.createElement('button');
        levelBtn.className = 'dialog-option';
        levelBtn.innerHTML = `<i class="fas fa-map"></i> Level ${i} ${gameState.levelsCompleted.includes(i) ? '(Completed)' : ''}`;
        
        if (i > gameState.currentLevel && !gameState.levelsCompleted.includes(i-1)) {
            levelBtn.disabled = true;
            levelBtn.title = "Complete previous level first";
        }
        
        if (!levelBtn.disabled) {
            levelBtn.addEventListener('click', () => {
                soundManager.play('click');
                if (i !== gameState.currentLevel) {
                    // Save current game
                    saveGameState();
                    
                    // Navigate to selected level
                    setTimeout(() => {
                        if (i === 1) {
                            window.location.href = 'level1.html';
                        } else {
                            window.location.href = `level${i}.html`;
                        }
                    }, 300);
                }
                dialogPanel.classList.add('hidden');
            });
        }
        
        dialogOptions.appendChild(levelBtn);
    }
    
    // Cancel button
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'dialog-option';
    cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
    cancelBtn.addEventListener('click', () => {
        dialogPanel.classList.add('hidden');
        soundManager.play('menu_close');
    });
    dialogOptions.appendChild(cancelBtn);
    
    dialogPanel.classList.remove('hidden');
}

// ============================================
// GAME CORE FUNCTIONS
// ============================================

// Show notification
function showNotification(title, message, type = "info") {
    notificationText.innerHTML = `<strong>${title}</strong><br>${message}`;
    notification.classList.remove('hidden');
    
    // Play appropriate sound
    if (gameState.soundEnabled) {
        if (type === "item") soundManager.play('item_pickup');
        else if (type === "heal") soundManager.play('heal');
        else if (type === "damage") soundManager.play('damage');
        else if (type === "fear") soundManager.play('fear');
        else if (type === "death") soundManager.play('death');
        else if (type === "victory") soundManager.play('victory');
        else if (type === "level_complete") soundManager.play('level_complete');
        else soundManager.play('click');
    }
    
    setTimeout(() => {
        if (!notification.classList.contains('hidden')) {
            notification.classList.add('hidden');
        }
    }, 3000);
}

// Add item to inventory
function addItem(itemName) {
    const item = items[itemName];
    if (!item) {
        console.error("Item not found:", itemName);
        return false;
    }
    
    // Check weight limit
    const currentWeight = gameState.inventory.reduce((sum, invItem) => {
        const itemData = items[invItem.name];
        return sum + (itemData?.weight || 0) * (invItem.quantity || 1);
    }, 0);
    
    if (currentWeight + item.weight > 10) {
        showNotification("Inventory Full", `Cannot carry ${itemName}. Too heavy!`, "info");
        return false;
    }
    
    // Add item
    const existingItem = gameState.inventory.find(invItem => invItem.name === itemName);
    if (existingItem) {
        existingItem.quantity = (existingItem.quantity || 1) + 1;
    } else {
        gameState.inventory.push({
            name: itemName,
            quantity: 1,
            equipped: false
        });
    }
    
    updateInventoryDisplay();
    showNotification("Item Found", `You found: ${itemName}`, "item");
    
    // Auto-save after getting item
    saveGameState();
    
    return true;
}

// Add gold
function addGold(amount) {
    gameState.gold += amount;
    showNotification("Gold Found", `You found ${amount} gold coins!`, "item");
    updateInventoryDisplay();
    saveGameState();
}

// Update inventory display
function updateInventoryDisplay() {
    inventoryContent.innerHTML = '';
    
    if (gameState.inventory.length === 0) {
        inventoryContent.innerHTML = `
            <div class="inventory-empty">
                <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 20px; color: #666;"></i>
                <div>Your inventory is empty</div>
                <div style="font-size: 0.9rem; margin-top: 10px;">Explore the cellar to find items!</div>
            </div>
        `;
    } else {
        const grid = document.createElement('div');
        grid.className = 'inventory-grid';
        
        let totalWeight = 0;
        let totalItems = 0;
        
        // Sort items by type and name
        const sortedInventory = [...gameState.inventory].sort((a, b) => {
            const itemA = items[a.name];
            const itemB = items[b.name];
            
            // Weapons first, then tools, then consumables, then keys
            const typeOrder = { weapon: 0, tool: 1, consumable: 2, key: 3, trinket: 4 };
            const orderA = typeOrder[itemA.type] || 5;
            const orderB = typeOrder[itemB.type] || 5;
            
            if (orderA !== orderB) return orderA - orderB;
            return a.name.localeCompare(b.name);
        });
        
        sortedInventory.forEach(invItem => {
            const item = items[invItem.name];
            if (!item) return;
            
            totalWeight += item.weight * (invItem.quantity || 1);
            totalItems += invItem.quantity || 1;
            
            const itemCard = document.createElement('div');
            itemCard.className = 'inventory-item-card';
            if (invItem.equipped) {
                itemCard.classList.add('item-equipped');
            }
            
            itemCard.innerHTML = `
                <div class="item-icon">
                    <i class="fas ${item.icon}"></i>
                </div>
                <div class="item-name">${invItem.name}</div>
                <div class="item-type">${item.type.toUpperCase()}</div>
                ${(invItem.quantity || 1) > 1 ? `<div class="item-quantity">${invItem.quantity}</div>` : ''}
                <div class="item-tooltip">${item.description}</div>
            `;
            
            // Add click handler
            itemCard.addEventListener('click', () => showItemDetails(invItem.name));
            
            grid.appendChild(itemCard);
        });
        
        inventoryContent.appendChild(grid);
        
        // Add item details section
        const detailsSection = document.createElement('div');
        detailsSection.className = 'item-details';
        detailsSection.id = 'itemDetails';
        detailsSection.innerHTML = `
            <div style="color: #999; text-align: center;">Click on an item for details</div>
        `;
        inventoryContent.appendChild(detailsSection);
    }
    
    // Update inventory stats
    inventoryWeight.textContent = `Weight: ${totalWeight.toFixed(1)}/10`;
    inventoryGold.textContent = `Gold: ${gameState.gold}`;
    inventoryCount.textContent = `Items: ${totalItems}`;
    
    // Update inventory badge
    inventoryBadge.textContent = totalItems;
    inventoryBadge.style.display = totalItems > 0 ? 'flex' : 'none';
}

// Show item details
function showItemDetails(itemName) {
    const item = items[itemName];
    if (!item) return;
    
    const invItem = gameState.inventory.find(i => i.name === itemName);
    if (!invItem) return;
    
    const detailsSection = document.getElementById('itemDetails');
    detailsSection.innerHTML = `
        <div style="color: #ff0; font-size: 1.2rem; margin-bottom: 10px;">
            <i class="fas ${item.icon}"></i> ${itemName}
        </div>
        <div class="item-description">${item.description}</div>
        <div style="margin-top: 10px; color: #ccc;">
            <div>Type: ${item.type.toUpperCase()}</div>
            <div>Weight: ${item.weight}</div>
            ${item.damage ? `<div>Damage: ${item.damage}</div>` : ''}
            ${item.staminaRestore ? `<div>Heals: ${item.staminaRestore} STAMINA</div>` : ''}
        </div>
        <div class="item-actions">
            ${item.usable ? `<button class="item-action-btn" onclick="useItem('${itemName}')">Use</button>` : ''}
            ${item.type === 'weapon' ? `<button class="item-action-btn" onclick="equipItem('${itemName}')">${invItem.equipped ? 'Unequip' : 'Equip'}</button>` : ''}
            <button class="item-action-btn" onclick="dropItem('${itemName}')">Drop</button>
        </div>
    `;
    
    soundManager.play('click');
}

// Use item
function useItem(itemName) {
    const item = items[itemName];
    if (!item) return;
    
    if (itemName === "Healing Potion") {
        gameState.stamina = Math.min(20, gameState.stamina + 5);
        removeItem(itemName);
        updateStats();
        showNotification("Healing Potion", "You restore 5 STAMINA", "heal");
        soundManager.play('heal');
        saveGameState();
    } else if (itemName === "Moldy Bread") {
        gameState.stamina = Math.min(20, gameState.stamina + 2);
        removeItem(itemName);
        updateStats();
        showNotification("Moldy Bread", "You restore 2 STAMINA (it was better than nothing)", "heal");
        soundManager.play('heal');
        saveGameState();
    } else if (itemName === "Wine Bottle") {
        showNotification("Wine Bottle", "You could drink this, but it might not be wise. Or use it as a weapon.", "info");
    } else {
        showNotification(itemName, item.description, "info");
    }
    
    updateInventoryDisplay();
}

// Equip item
function equipItem(itemName) {
    if (items[itemName].type !== 'weapon') return;
    
    // Unequip current weapon
    gameState.inventory.forEach(invItem => {
        if (invItem.equipped) invItem.equipped = false;
    });
    
    // Equip new weapon
    const invItem = gameState.inventory.find(i => i.name === itemName);
    invItem.equipped = !invItem.equipped;
    
    if (invItem.equipped) {
        showNotification("Item Equipped", `${itemName} is now equipped`, "info");
        gameState.equippedWeapon = itemName;
    } else {
        showNotification("Item Unequipped", `${itemName} is no longer equipped`, "info");
        gameState.equippedWeapon = null;
    }
    
    updateInventoryDisplay();
    soundManager.play('item_use');
    saveGameState();
}

// Drop item
function dropItem(itemName) {
    if (confirm(`Are you sure you want to drop ${itemName}?`)) {
        removeItem(itemName);
        showNotification("Item Dropped", `You dropped ${itemName}`, "info");
        updateInventoryDisplay();
        soundManager.play('click');
        saveGameState();
    }
}

// Organize inventory
function organizeInventory() {
    // Sort inventory alphabetically
    gameState.inventory.sort((a, b) => a.name.localeCompare(b.name));
    
    // Group by type
    const typeOrder = { weapon: 0, tool: 1, consumable: 2, key: 3, trinket: 4 };
    gameState.inventory.sort((a, b) => {
        const itemA = items[a.name];
        const itemB = items[b.name];
        const orderA = typeOrder[itemA.type] || 5;
        const orderB = typeOrder[itemB.type] || 5;
        return orderA - orderB;
    });
    
    updateInventoryDisplay();
    showNotification("Inventory Organized", "Items have been sorted by type and name", "info");
}

// Remove item
function removeItem(itemName) {
    const index = gameState.inventory.findIndex(item => item.name === itemName);
    if (index !== -1) {
        if (gameState.inventory[index].quantity > 1) {
            gameState.inventory[index].quantity--;
        } else {
            // If unequipping weapon, clear equipped weapon
            if (gameState.inventory[index].equipped) {
                gameState.equippedWeapon = null;
            }
            gameState.inventory.splice(index, 1);
        }
        return true;
    }
    return false;
}

// Update stats display
function updateStats() {
    fearValue.textContent = gameState.fear;
    staminaValue.textContent = gameState.stamina;
    skillValue.textContent = gameState.skill;
    luckValue.textContent = gameState.luck;
    
    // Color coding
    fearValue.style.color = gameState.fear > 15 ? '#ff3030' : 
                           gameState.fear > 10 ? '#ff8000' : '#ff0';
    
    staminaValue.style.color = gameState.stamina > 15 ? '#0f0' : 
                              gameState.stamina > 10 ? '#ff0' : 
                              gameState.stamina > 5 ? '#ff8000' : '#ff3030';
}

// Apply effect
function applyEffect(effect) {
    if (effect.fear) {
        gameState.fear = Math.max(0, Math.min(20, gameState.fear + effect.fear));
        if (effect.fear > 0) {
            showNotification("Fear", `Your fear increases by ${effect.fear}`, "fear");
            soundManager.play('fear');
        }
    }
    
    if (effect.stamina) {
        const oldStamina = gameState.stamina;
        gameState.stamina = Math.max(0, Math.min(20, gameState.stamina + effect.stamina));
        const change = gameState.stamina - oldStamina;
        
        if (change < 0) {
            showNotification("Damage", `You lose ${-change} STAMINA`, "damage");
            soundManager.play('damage');
        } else if (change > 0) {
            showNotification("Healed", `You restore ${change} STAMINA`, "heal");
            soundManager.play('heal');
        }
    }
    
    if (effect.skill) {
        gameState.skill = Math.max(0, Math.min(12, gameState.skill + effect.skill));
        if (effect.skill < 0) {
            showNotification("Skill Reduced", `Your skill decreases by ${-effect.skill}`, "damage");
        }
    }
    
    if (effect.luck) {
        gameState.luck = Math.max(0, Math.min(12, gameState.luck + effect.luck));
        if (effect.luck < 0) {
            showNotification("Luck Reduced", `Your luck decreases by ${-effect.luck}`, "damage");
        }
    }
    
    updateStats();
    
    // Check for death
    if (gameState.stamina <= 0) {
        showNotification("Game Over", "You have died!", "death");
        soundManager.play('death');
        setTimeout(() => {
            storyText.innerHTML += '<div class="death-message">YOU HAVE DIED<br>GAME OVER</div>';
            choicesContainer.innerHTML = '';
        }, 1000);
        return true;
    }
    
    if (gameState.fear >= 20) {
        showNotification("Game Over", "Driven mad by fear!", "death");
        soundManager.play('death');
        setTimeout(() => {
            storyText.innerHTML += '<div class="death-message">DRIVEN MAD BY FEAR<br>GAME OVER</div>';
            choicesContainer.innerHTML = '';
        }, 1000);
        return true;
    }
    
    return false;
}

// Load section
function loadSection(sectionId) {
    if (gameState.inCombat || gameState.inDialog) return;
    
    gameState.currentSection = sectionId;
    const section = storySections[sectionId];
    
    if (!section) {
        storyText.innerHTML = "<p>End of Level 2... for now.</p>";
        choicesContainer.innerHTML = "";
        return;
    }
    
    // Apply section effect if any
    if (section.effect) {
        if (applyEffect(section.effect)) return; // Return if player died
    }
    
    // Display story text
    storyText.innerHTML = `<p>${section.text}</p>`;
    storyText.scrollTop = 0;
    
    // Clear and create choices
    choicesContainer.innerHTML = "";
    
    section.choices.forEach(choice => {
        const button = document.createElement('button');
        button.className = 'choice-btn';
        
        // Check requirements
        let disabled = false;
        if (choice.requireItem) {
            const hasItem = gameState.inventory.some(item => item.name === choice.requireItem);
            if (!hasItem) {
                disabled = true;
                button.title = `Requires: ${choice.requireItem}`;
            }
        }
        
        button.disabled = disabled;
        button.innerHTML = `<i class="fas ${choice.icon}"></i> ${choice.text}`;
        
        if (!disabled) {
            button.addEventListener('click', () => {
                if (choice.sound && gameState.soundEnabled) {
                    soundManager.play(choice.sound);
                }
                handleChoice(choice);
            });
        }
        
        choicesContainer.appendChild(button);
    });
    
    // Update stats
    updateStats();
    
    // Mark as visited
    if (!gameState.visitedSections.includes(sectionId)) {
        gameState.visitedSections.push(sectionId);
    }
}

// Handle choice
function handleChoice(choice) {
    console.log("Handling choice:", choice);
    
    if (choice.action === "addItem") {
        if (addItem(choice.item)) {
            // Stay in current section after taking item
            loadSection(gameState.currentSection);
        }
    } else if (choice.action === "addMultiple") {
        if (choice.items) {
            // For array of items
            choice.items.forEach(item => addItem(item));
            loadSection(gameState.currentSection);
        } else if (choice.actions) {
            // For array of actions
            choice.actions.forEach(actionStr => {
                const [action, param] = actionStr.split(':');
                if (action === "addItem") {
                    addItem(param);
                } else if (action === "addGold") {
                    addGold(parseInt(param));
                }
            });
            loadSection(gameState.currentSection);
        }
    } else if (choice.action === "addGold") {
        addGold(choice.amount);
        loadSection(gameState.currentSection);
    } else if (choice.action === "startCombat") {
        startCombat(choice.enemy);
    } else if (choice.action === "completeLevel") {
        completeLevel();
    } else if (choice.next) {
        if (choice.effect) {
            applyEffect(choice.effect);
        }
        loadSection(choice.next);
    }
}

// Start combat
function startCombat(enemyName) {
    const enemy = enemies[enemyName];
    if (!enemy) return;
    
    gameState.inCombat = true;
    gameState.combatData = {
        enemy: enemy,
        enemyStamina: enemy.stamina,
        enemyMaxStamina: enemy.stamina,
        round: 1,
        playerMaxStamina: gameState.stamina
    };
    
    // Update UI
    enemyCombatName.textContent = enemy.name;
    enemyCombatSkill.textContent = enemy.skill;
    enemyCombatStamina.textContent = enemy.stamina;
    enemyHealthText.textContent = `${enemy.stamina}/${enemy.stamina}`;
    
    playerCombatStamina.textContent = gameState.stamina;
    playerHealthText.textContent = `${gameState.stamina}/20`;
    
    // Update health bars
    const playerHealthPercent = (gameState.stamina / 20) * 100;
    const enemyHealthPercent = 100;
    
    playerHealthBar.style.width = `${playerHealthPercent}%`;
    enemyHealthBar.style.width = `${enemyHealthPercent}%`;
    
    combatLog.innerHTML = '';
    addCombatLog(`A ${enemy.name} attacks!`, "event");
    
    // Show combat panel
    combatPanel.classList.remove('hidden');
    soundManager.play('combat_attack');
}

// Perform attack
function performAttack() {
    if (!gameState.inCombat || !gameState.combatData) return;
    
    const enemy = gameState.combatData.enemy;
    const playerSkill = gameState.skill;
    
    // Player attacks
    const playerRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + playerSkill;
    const enemyRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + enemy.skill;
    
    let damage = 0;
    let isCritical = false;
    
    if (playerRoll > enemyRoll) {
        // Player hits
        damage = 2; // Base damage
        
        // Add weapon damage if equipped
        if (gameState.equippedWeapon) {
            const weapon = items[gameState.equippedWeapon];
            damage = weapon.damage;
        }
        
        // Bonus for holy weapons vs undead
        if (enemy.weakTo === "holy" && gameState.equippedWeapon === "Crucifix") {
            damage = items["Crucifix"].vsUndeadDamage;
            addCombatLog("The crucifix glows with holy power!", "player");
        }
        
        // Bonus for blunt weapons vs skeletons
        if (enemy.weakTo === "blunt" && gameState.equippedWeapon === "Butcher's Knife") {
            damage += 2;
            addCombatLog("The heavy weapon crushes the skeleton's bones!", "player");
        }
        
        // Critical hit chance (roll of 12)
        const attackRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
        if (attackRoll === 12) {
            damage *= 2;
            isCritical = true;
            addCombatLog("CRITICAL HIT!", "player");
        }
        
        gameState.combatData.enemyStamina -= damage;
        addCombatLog(`You hit the ${enemy.name} for ${damage} damage!`, "player");
        
        // Show damage number
        showDamageNumber(enemy.name, damage, false);
        
    } else if (enemyRoll > playerRoll) {
        // Enemy hits
        damage = enemy.damage;
        gameState.stamina -= damage;
        addCombatLog(`The ${enemy.name} hits you for ${damage} damage!`, "enemy");
        
        // Show damage number
        showDamageNumber("YOU", damage, true);
        
        // Add fear
        if (enemy.fear > 0) {
            gameState.fear += enemy.fear;
            addCombatLog(`The ${enemy.name} terrifies you! (+${enemy.fear} fear)`, "enemy");
        }
    } else {
        // Tie
        addCombatLog("Your attacks clash with no effect!", "event");
    }
    
    // Play attack sound
    soundManager.playAttackSound(damage, isCritical);
    
    // Update UI
    updateCombatUI();
    
    // Check combat end
    if (!checkCombatEnd()) {
        // Enemy attacks next round if combat continues
        setTimeout(() => {
            if (gameState.inCombat) {
                enemyAttack();
            }
        }, 1000);
    }
}

// Enemy attack
function enemyAttack() {
    if (!gameState.inCombat || !gameState.combatData) return;
    
    const enemy = gameState.combatData.enemy;
    const playerSkill = gameState.skill;
    
    // Enemy attacks
    const enemyRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + enemy.skill;
    const playerRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + playerSkill;
    
    let damage = 0;
    
    if (enemyRoll > playerRoll) {
        // Enemy hits
        damage = enemy.damage;
        gameState.stamina -= damage;
        addCombatLog(`The ${enemy.name} hits you for ${damage} damage!`, "enemy");
        
        // Show damage number
        showDamageNumber("YOU", damage, true);
        
        // Add fear
        if (enemy.fear > 0) {
            gameState.fear += enemy.fear;
            addCombatLog(`The ${enemy.name} terrifies you! (+${enemy.fear} fear)`, "enemy");
        }
    } else if (playerRoll > enemyRoll) {
        // Player parries
        addCombatLog(`You parry the ${enemy.name}'s attack!`, "player");
    } else {
        // Tie
        addCombatLog("You both hesitate, waiting for an opening!", "event");
    }
    
    // Play attack sound
    soundManager.playAttackSound(damage, false);
    
    // Update UI
    updateCombatUI();
    
    // Check combat end
    checkCombatEnd();
}

// Update combat UI
function updateCombatUI() {
    playerCombatStamina.textContent = gameState.stamina;
    enemyCombatStamina.textContent = gameState.combatData.enemyStamina;
    
    const playerHealthPercent = (gameState.stamina / 20) * 100;
    const enemyHealthPercent = (gameState.combatData.enemyStamina / gameState.combatData.enemyMaxStamina) * 100;
    
    playerHealthBar.style.width = `${playerHealthPercent}%`;
    enemyHealthBar.style.width = `${enemyHealthPercent}%`;
    
    playerHealthText.textContent = `${gameState.stamina}/20`;
    enemyHealthText.textContent = `${gameState.combatData.enemyStamina}/${gameState.combatData.enemyMaxStamina}`;
    
    updateStats();
}

// Show damage number
function showDamageNumber(target, damage, isPlayer) {
    const damageNumber = document.createElement('div');
    damageNumber.className = `damage-number ${isPlayer ? 'player' : 'enemy'}`;
    damageNumber.textContent = `-${damage}`;
    damageNumber.style.left = `${50 + (Math.random() * 20 - 10)}%`;
    damageNumber.style.top = `${30 + (Math.random() * 20)}%`;
    
    document.body.appendChild(damageNumber);
    
    setTimeout(() => {
        damageNumber.remove();
    }, 1000);
}

// Add combat log entry
function addCombatLog(message, type) {
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}-log`;
    entry.textContent = `[Round ${gameState.combatData.round}] ${message}`;
    combatLog.appendChild(entry);
    combatLog.scrollTop = combatLog.scrollHeight;
    gameState.combatData.round++;
}

// Show combat items
function showCombatItems() {
    const itemsSection = document.createElement('div');
    itemsSection.innerHTML = `
        <div style="color: #ff0; margin-bottom: 10px;">Select an item to use:</div>
    `;
    
    const combatItems = gameState.inventory.filter(invItem => {
        const item = items[invItem.name];
        return item && (item.name === "Healing Potion" || item.name === "Crucifix" || item.name === "Moldy Bread");
    });
    
    if (combatItems.length === 0) {
        itemsSection.innerHTML += `
            <div style="color: #666; padding: 10px; text-align: center;">
                No usable items in combat
            </div>
        `;
    } else {
        combatItems.forEach(invItem => {
            const button = document.createElement('button');
            button.className = 'combat-btn';
            button.style.margin = '5px';
            button.textContent = `${invItem.name} (${invItem.quantity})`;
            button.addEventListener('click', () => useItemInCombat(invItem.name));
            itemsSection.appendChild(button);
        });
    }
    
    const backButton = document.createElement('button');
    backButton.className = 'combat-btn';
    backButton.style.margin = '5px';
    backButton.textContent = 'Back';
    backButton.addEventListener('click', () => {
        combatLog.innerHTML = '';
        addCombatLog("You prepare your next move...", "event");
    });
    itemsSection.appendChild(backButton);
    
    combatLog.innerHTML = '';
    combatLog.appendChild(itemsSection);
}

// Use item in combat
function useItemInCombat(itemName) {
    if (itemName === "Healing Potion") {
        const oldStamina = gameState.stamina;
        gameState.stamina = Math.min(20, gameState.stamina + 5);
        const healed = gameState.stamina - oldStamina;
        
        removeItem(itemName);
        addCombatLog(`You drink a healing potion! (+${healed} stamina)`, "player");
        soundManager.play('heal');
        
        // Enemy attacks while you use item
        setTimeout(() => {
            if (gameState.inCombat) {
                addCombatLog("The enemy attacks while you're distracted!", "event");
                enemyAttack();
            }
        }, 500);
        
    } else if (itemName === "Moldy Bread") {
        const oldStamina = gameState.stamina;
        gameState.stamina = Math.min(20, gameState.stamina + 2);
        const healed = gameState.stamina - oldStamina;
        
        removeItem(itemName);
        addCombatLog(`You eat moldy bread! (+${healed} stamina)`, "player");
        soundManager.play('heal');
        
        setTimeout(() => {
            if (gameState.inCombat) {
                enemyAttack();
            }
        }, 500);
        
    } else if (itemName === "Crucifix") {
        const enemy = gameState.combatData.enemy;
        if (enemy.weakTo === "holy") {
            gameState.combatData.enemyStamina -= 4;
            addCombatLog("The crucifix glows with holy power! The enemy recoils in pain! (-4 damage)", "player");
            showDamageNumber(enemy.name, 4, false);
            soundManager.play('combat_hit');
            
            // Enemy attacks
            setTimeout(() => {
                if (gameState.inCombat) {
                    enemyAttack();
                }
            }, 500);
        } else {
            addCombatLog("The crucifix has no effect on this enemy.", "event");
            soundManager.play('combat_miss');
        }
    }
    
    updateCombatUI();
    checkCombatEnd();
}

// Test luck in combat
function testLuckInCombat() {
    if (gameState.luck <= 0) {
        addCombatLog("You have no luck left to test!", "event");
        return;
    }
    
    gameState.luck--;
    updateStats();
    
    const luckRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
    const success = luckRoll <= gameState.luck + 1;
    
    if (success) {
        addCombatLog("You feel lucky! The enemy hesitates.", "player");
        // Skip enemy's next attack
    } else {
        addCombatLog("Your luck fails you! The enemy presses the attack.", "enemy");
        // Enemy gets a free attack
        setTimeout(() => {
            if (gameState.inCombat) {
                enemyAttack();
            }
        }, 500);
    }
    
    soundManager.play(success ? 'combat_critical' : 'combat_miss');
}

// Try to flee
function tryFlee() {
    const fleeChance = 0.4 + (gameState.luck / 20);
    if (Math.random() < fleeChance) {
        addCombatLog("You successfully flee from combat!", "player");
        endCombat(false);
        soundManager.play('victory');
        setTimeout(() => {
            combatPanel.classList.add('hidden');
        }, 1000);
    } else {
        addCombatLog("You fail to escape!", "event");
        enemyAttack();
        updateCombatUI();
        checkCombatEnd();
    }
}

// Check combat end
function checkCombatEnd() {
    if (gameState.stamina <= 0) {
        addCombatLog("You have been defeated!", "event");
        endCombat(false);
        soundManager.play('death');
        setTimeout(() => {
            combatPanel.classList.add('hidden');
            storyText.innerHTML += '<div class="death-message">DEFEATED IN COMBAT<br>GAME OVER</div>';
            choicesContainer.innerHTML = '';
        }, 1500);
        return true;
    }
    
    if (gameState.combatData.enemyStamina <= 0) {
        const enemy = gameState.combatData.enemy;
        addCombatLog(`You defeated the ${enemy.name}!`, "event");
        
        // Add gold
        if (enemy.gold > 0) {
            gameState.gold += enemy.gold;
            addCombatLog(`Found ${enemy.gold} gold!`, "event");
        }
        
        endCombat(true);
        soundManager.play('victory');
        
        setTimeout(() => {
            combatPanel.classList.add('hidden');
            loadSection(gameState.currentSection + 1);
            saveGameState(); // Auto-save after combat
        }, 2000);
        return true;
    }
    
    return false;
}

// End combat
function endCombat(victory) {
    gameState.inCombat = false;
    gameState.combatData = null;
}

// Save game
function saveGame() {
    if (saveGameState()) {
        showNotification("Game Saved", "Progress saved successfully.", "info");
        soundManager.play('click');
    } else {
        showNotification("Save Failed", "Could not save game.", "info");
    }
}

// Load game
function loadGame() {
    if (loadGameState()) {
        loadSection(gameState.currentSection);
        updateInventoryDisplay();
        updateStats();
        showNotification("Game Loaded", "Saved game loaded.", "info");
        soundManager.play('menu_open');
    } else {
        showNotification("No Save", "No saved game found.", "info");
    }
}

// Show hint
function showHint() {
    const hints = [
        "The cellar is darker than the main house. A light source helps.",
        "Some enemies have specific weaknesses - experiment!",
        "The rusty key might open something important.",
        "Cultists often gather where rituals are performed.",
        "Skeletons are vulnerable to crushing attacks.",
        "Spiders are fast but fragile.",
        "Listen carefully - you can hear what's ahead sometimes.",
        "Don't forget to use items you've collected.",
        "The exit might be hidden where you least expect it."
    ];
    const randomHint = hints[Math.floor(Math.random() * hints.length)];
    showNotification("Hint", randomHint, "info");
}

// Restart game
function restartGame() {
    if (confirm("Are you sure you want to restart Level 2? All progress for this level will be lost.")) {
        // Reset game state for this level only
        gameState.currentSection = 1;
        gameState.fear = 0;
        gameState.skill = 7; // Reset to base skill
        gameState.luck = 12; // Reset to base luck
        gameState.inCombat = false;
        gameState.inDialog = false;
        gameState.combatData = null;
        gameState.npcData = null;
        gameState.inventoryOpen = false;
        gameState.visitedSections = [];
        
        // Note: We keep inventory, gold, stamina, and equipped weapon from previous progress
        
        // Close panels
        combatPanel.classList.add('hidden');
        inventoryPanel.classList.add('hidden');
        levelComplete.classList.add('hidden');
        
        // Clear localStorage for this level only
        localStorage.removeItem('houseOfHellSave');
        
        // Reload first section
        loadSection(1);
        updateInventoryDisplay();
        updateStats();
        
        showNotification("Level 2 Restarted", "Your cellar exploration begins anew.", "info");
        soundManager.play('menu_open');
    }
}

// Start the game
window.addEventListener('DOMContentLoaded', initGame);

// Auto-save when leaving the page
window.addEventListener('beforeunload', () => {
    saveGameState();
});
</script>
</body>
</html>
