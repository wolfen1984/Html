<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tower of Terror - Level 2: The Haunted Library</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset and base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'VT323', monospace;
            background-color: #000;
            color: #a0e0a0;
            line-height: 1.4;
            padding: 10px;
            height: 100vh;
            overflow: hidden;
            position: relative;
            touch-action: manipulation;
        }
        
        /* Container */
        .container {
            max-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 2px solid #5a5a5a;
            padding: 10px;
            background-color: #0a0a0a;
            box-shadow: 0 0 20px rgba(90, 90, 90, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px dashed #5a5a5a;
            margin-bottom: 15px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 2rem;
            color: #d0a050;
            text-shadow: 0 0 5px #b08030;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #a0e0a0;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .level-indicator {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #d0a050;
            font-size: 1rem;
            background-color: #0a0a0a;
            border: 1px solid #5a5a5a;
            padding: 5px 10px;
            border-radius: 10px;
            z-index: 4;
        }
        
        /* Stats Panel */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #151515;
            border: 1px solid #5a5a5a;
            border-radius: 5px;
        }
        
        .stat-item {
            text-align: center;
            padding: 3px;
            border: 1px solid #333;
            border-radius: 3px;
            position: relative;
            cursor: help;
        }
        
        .stat-item:hover {
            border-color: #a0e0a0;
            background-color: #222;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .stat-value {
            font-size: 1.3rem;
            color: #d0a050;
            font-weight: bold;
        }
        
        .stat-max {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Main Content */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            border: 1px solid #5a5a5a;
            background-color: #151515;
            margin-bottom: 15px;
            font-size: 1.2rem;
            line-height: 1.5;
            scrollbar-width: thin;
            scrollbar-color: #5a5a5a #000;
        }
        
        .content::-webkit-scrollbar {
            width: 10px;
        }
        
        .content::-webkit-scrollbar-track {
            background: #000;
        }
        
        .content::-webkit-scrollbar-thumb {
            background-color: #5a5a5a;
            border-radius: 0;
        }
        
        /* Choices */
        .choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .choice-btn {
            background-color: #0a0a0a;
            color: #a0e0a0;
            border: 1px solid #5a5a5a;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            padding: 12px 15px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .choice-btn i {
            font-size: 1.1rem;
        }
        
        .choice-btn:active, .choice-btn:hover {
            background-color: #5a5a5a;
            color: #a0e0a0;
            transform: translateY(-2px);
            border-color: #a0e0a0;
        }
        
        .choice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            padding-top: 10px;
            border-top: 1px dashed #5a5a5a;
        }
        
        .control-btn {
            background-color: #0a0a0a;
            color: #a0e0a0;
            border: 1px solid #5a5a5a;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .control-btn:active, .control-btn:hover {
            background-color: #5a5a5a;
            color: #a0e0a0;
            border-color: #a0e0a0;
        }
        
        /* Loading Screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .loading-text {
            color: #a0e0a0;
            font-size: 1.5rem;
            margin-bottom: 20px;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .loading-bar {
            width: 80%;
            height: 20px;
            border: 1px solid #5a5a5a;
            padding: 2px;
            margin-bottom: 20px;
        }
        
        .loading-progress {
            height: 100%;
            background-color: #5a5a5a;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* Utility */
        .hidden {
            display: none !important;
        }
        
        .footer {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
            padding-top: 10px;
            border-top: 1px dashed #333;
        }
        
        /* Visual Effects */
        .screen-border {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .library-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(40, 30, 10, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(20, 10, 30, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background-color: #0a0a0a;
            border: 1px solid #5a5a5a;
            color: #a0e0a0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            font-size: 1.2rem;
            border-radius: 50%;
        }
        
        /* Page Navigation */
        .page-nav {
            position: absolute;
            top: 15px;
            left: 70px;
            z-index: 5;
            background: #0a0a0a;
            border: 1px solid #5a5a5a;
            color: #a0e0a0;
            padding: 5px 15px;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 1rem;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .page-nav:hover {
            background-color: #5a5a5a;
            color: #a0e0a0;
        }
        
        /* Responsive */
        @media (max-height: 700px) {
            h1 { font-size: 1.7rem; }
            .subtitle { font-size: 1rem; }
            .content { font-size: 1.1rem; }
            .choice-btn { padding: 10px 12px; font-size: 1.1rem; }
        }
        
        @media (max-width: 400px) {
            .container { padding: 8px; }
            h1 { font-size: 1.5rem; }
            .choice-btn { padding: 8px 10px; font-size: 1rem; }
            .page-nav { left: 60px; padding: 5px 10px; }
        }
        
        /* Death Message */
        .death-message {
            color: #d05050;
            animation: pulse 2s infinite;
            text-align: center;
            padding: 10px;
            border: 1px solid #d05050;
            margin: 10px 0;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Inventory Panel */
        .inventory-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 10, 10, 0.95);
            z-index: 50;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }
        
        .inventory-header {
            padding: 15px;
            background-color: #0a0a0a;
            border-bottom: 2px solid #5a5a5a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .inventory-title {
            color: #d0a050;
            font-size: 1.5rem;
            text-shadow: 0 0 10px rgba(208, 160, 80, 0.5);
        }
        
        .inventory-close {
            background: none;
            border: 1px solid #5a5a5a;
            color: #a0e0a0;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .inventory-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .inventory-item-card {
            background-color: #151515;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .inventory-item-card:hover {
            transform: translateY(-5px);
            border-color: #5a5a5a;
            box-shadow: 0 5px 15px rgba(90, 90, 90, 0.2);
        }
        
        .inventory-item-card.item-equipped {
            border-color: #d0a050;
            background-color: #222;
        }
        
        .item-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #5a5a5a;
        }
        
        .item-name {
            font-size: 1rem;
            margin-bottom: 5px;
            color: #a0e0a0;
        }
        
        .item-type {
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 5px;
        }
        
        .item-quantity {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #5a5a5a;
            color: #000;
            font-size: 0.8rem;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .item-details {
            background-color: #0a0a0a;
            border: 1px solid #5a5a5a;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }
        
        .item-description {
            color: #ccc;
            font-size: 1rem;
            line-height: 1.4;
        }
        
        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .item-action-btn {
            flex: 1;
            padding: 8px;
            background-color: #0a0a0a;
            border: 1px solid #5a5a5a;
            color: #a0e0a0;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .item-action-btn:hover {
            background-color: #5a5a5a;
            color: #a0e0a0;
        }
        
        .inventory-footer {
            padding: 15px;
            background-color: #0a0a0a;
            border-top: 2px solid #5a5a5a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .inventory-stats {
            color: #a0e0a0;
            font-size: 1rem;
        }
        
        .inventory-empty {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2rem;
        }
        
        /* Inventory Button */
        .inventory-toggle {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 5;
            background: #0a0a0a;
            border: 1px solid #5a5a5a;
            color: #a0e0a0;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .inventory-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(90, 90, 90, 0.5);
        }
        
        .inventory-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #d05050;
            color: #000;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Combat Panel */
        .combat-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 10, 10, 0.95);
            border: 2px solid #d05050;
            padding: 20px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }
        
        .combat-title {
            color: #d05050;
            text-align: center;
            font-size: 2rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #d05050;
            animation: glow 2s infinite;
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 10px #d05050; }
            50% { text-shadow: 0 0 20px #d05050, 0 0 30px #d05050; }
        }
        
        .combatants {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            gap: 20px;
        }
        
        .combatant {
            flex: 1;
            text-align: center;
            padding: 20px;
            border: 2px solid #5a5a5a;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .combatant.enemy {
            border-color: #d05050;
        }
        
        .combatant-name {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #d0a050;
        }
        
        .combatant.enemy .combatant-name {
            color: #d05050;
        }
        
        .combatant-stats {
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        
        .health-bar-container {
            margin: 10px 0;
        }
        
        .health-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        .health-bar {
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #444;
        }
        
        .health-fill {
            height: 100%;
            background-color: #5a5a5a;
            transition: width 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .health-fill.enemy {
            background-color: #d05050;
        }
        
        .health-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.1) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .combat-log {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #5a5a5a;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 1.1rem;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 5px;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-bottom: 1px dotted #333;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .player-log {
            color: #a0e0a0;
            border-left: 3px solid #a0e0a0;
            padding-left: 10px;
        }
        
        .enemy-log {
            color: #d05050;
            border-left: 3px solid #d05050;
            padding-left: 10px;
        }
        
        .event-log {
            color: #d0a050;
            border-left: 3px solid #d0a050;
            padding-left: 10px;
        }
        
        .combat-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .combat-btn {
            background-color: #0a0a0a;
            color: #a0e0a0;
            border: 2px solid #5a5a5a;
            font-family: 'VT323', monospace;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
            border-radius: 5px;
        }
        
        .combat-btn:hover {
            background-color: #5a5a5a;
            color: #a0e0a0;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(90, 90, 90, 0.3);
        }
        
        .combat-btn.attack {
            border-color: #d05050;
            color: #d05050;
        }
        
        .combat-btn.attack:hover {
            background-color: #d05050;
            color: #000;
            box-shadow: 0 5px 15px rgba(208, 80, 80, 0.3);
        }
        
        .combat-btn.flee {
            border-color: #d0a050;
            color: #d0a050;
        }
        
        .combat-btn.flee:hover {
            background-color: #d0a050;
            color: #000;
        }
        
        /* Dialog Panel */
        .dialog-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(10, 10, 10, 0.95);
            border: 2px solid #5a5a5a;
            padding: 20px;
            z-index: 20;
            width: 90%;
            max-width: 400px;
        }
        
        .dialog-title {
            color: #a0e0a0;
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
            border-bottom: 1px solid #5a5a5a;
            padding-bottom: 5px;
        }
        
        .dialog-text {
            margin-bottom: 20px;
            font-size: 1.1rem;
            line-height: 1.4;
        }
        
        .dialog-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .dialog-option {
            background-color: #0a0a0a;
            color: #a0e0a0;
            border: 1px solid #5a5a5a;
            font-family: 'VT323', monospace;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .dialog-option:hover {
            background-color: #5a5a5a;
            color: #a0e0a0;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(10, 10, 10, 0.95);
            border: 1px solid #5a5a5a;
            padding: 15px 20px;
            z-index: 30;
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(90, 90, 90, 0.2);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-close {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #a0e0a0;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .loading-tip {
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
            text-align: center;
            max-width: 80%;
        }
        
        /* Stat tooltip */
        .stat-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #0a0a0a;
            border: 1px solid #5a5a5a;
            padding: 10px;
            font-size: 0.9rem;
            white-space: nowrap;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            margin-bottom: 5px;
        }
        
        .stat-item:hover .stat-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Damage numbers */
        .damage-number {
            position: absolute;
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 0 0 5px #000;
            z-index: 100;
        }
        
        .damage-number.player {
            color: #d05050;
        }
        
        .damage-number.enemy {
            color: #a0e0a0;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        /* Item tooltip */
        .item-tooltip {
            position: absolute;
            background-color: #0a0a0a;
            border: 1px solid #5a5a5a;
            padding: 10px;
            font-size: 0.9rem;
            max-width: 200px;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .inventory-item-card:hover .item-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Level Complete Screen */
        .level-complete {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 10, 10, 0.95);
            z-index: 60;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .level-complete h2 {
            color: #d0a050;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(208, 160, 80, 0.5);
            animation: glow 2s infinite;
        }
        
        .level-complete p {
            font-size: 1.5rem;
            margin-bottom: 30px;
            max-width: 600px;
        }
        
        .level-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #5a5a5a;
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
            width: 100%;
        }
        
        .level-stat {
            text-align: center;
        }
        
        .level-stat-value {
            font-size: 2rem;
            color: #a0e0a0;
            margin-bottom: 5px;
        }
        
        .level-stat-label {
            font-size: 1rem;
            color: #aaa;
        }
        
        .level-complete-buttons {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .level-complete-btn {
            background-color: #0a0a0a;
            color: #a0e0a0;
            border: 2px solid #5a5a5a;
            font-family: 'VT323', monospace;
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
            border-radius: 5px;
            min-width: 150px;
        }
        
        .level-complete-btn:hover {
            background-color: #5a5a5a;
            color: #a0e0a0;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(90, 90, 90, 0.3);
        }
        
        .level-complete-btn.next {
            background-color: #0a0a0a;
            color: #d0a050;
            border-color: #d0a050;
        }
        
        .level-complete-btn.next:hover {
            background-color: #d0a050;
            color: #000;
            box-shadow: 0 5px 15px rgba(208, 160, 80, 0.3);
        }
    </style>
</head>
<body>
    <div class="screen-border"></div>
    <div class="library-effect"></div>
    
    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="loading-text">TOWER OF TERROR</div>
        <div class="loading-text">LEVEL 2 - THE HAUNTED LIBRARY</div>
        <div class="loading-text">LOADING ADVENTURE...</div>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <div class="loading-text" id="loadingStatus">Initializing your journey...</div>
        <div class="loading-tip">Welcome back, adventurer. The tower's secrets grow deeper...</div>
    </div>
    
    <!-- Main Game Container -->
    <div class="container hidden" id="gameContainer">
        <!-- Top Controls -->
        <button class="sound-toggle" id="soundToggle">ðŸ”Š</button>
        <button class="inventory-toggle" id="inventoryToggle" title="Inventory">
            <i class="fas fa-backpack"></i>
            <span class="inventory-badge" id="inventoryBadge">0</span>
        </button>
        
        <!-- Page Navigation -->
        <button class="page-nav" id="pageNav" title="Select Level">
            <i class="fas fa-map"></i> Level 2
        </button>
        
        <!-- Enhanced Inventory Panel -->
        <div class="inventory-panel hidden" id="inventoryPanel">
            <div class="inventory-header">
                <div class="inventory-title">INVENTORY - LEVEL 2</div>
                <button class="inventory-close" id="inventoryClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="inventory-content" id="inventoryContent">
                <!-- Items will be added here -->
            </div>
            <div class="inventory-footer">
                <div class="inventory-stats">
                    <span id="inventoryWeight">Weight: 0/10</span> | 
                    <span id="inventoryGold">Gold: 0</span> | 
                    <span id="inventoryCount">Items: 0</span>
                </div>
                <button class="item-action-btn" id="organizeInventory">
                    <i class="fas fa-sort-alpha-down"></i> Organize
                </button>
            </div>
        </div>
        
        <!-- Header -->
        <div class="header">
            <div>
                <h1>TOWER OF TERROR</h1>
                <div class="subtitle">Level 2 - The Haunted Library</div>
            </div>
            <div class="level-indicator">Level 2</div>
        </div>
        
        <!-- Stats Panel -->
        <div class="stats-panel">
            <div class="stat-item">
                <div class="stat-label">HEALTH</div>
                <div class="stat-value" id="healthValue">20</div>
                <div class="stat-max">/20</div>
                <div class="stat-tooltip">Your health. If it reaches 0, you die!</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">MANA</div>
                <div class="stat-value" id="manaValue">10</div>
                <div class="stat-max">/10</div>
                <div class="stat-tooltip">Magical energy for spells and abilities</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ATTACK</div>
                <div class="stat-value" id="attackValue">7</div>
                <div class="stat-max">/12</div>
                <div class="stat-tooltip">Your combat ability. Higher is better!</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">DEFENSE</div>
                <div class="stat-value" id="defenseValue">5</div>
                <div class="stat-max">/12</div>
                <div class="stat-tooltip">Damage reduction. Higher means less damage taken!</div>
            </div>
        </div>
        
        <!-- Story Text -->
        <div class="content" id="storyText">
            <!-- Story text will appear here -->
        </div>
        
        <!-- Choices -->
        <div class="choices" id="choicesContainer">
            <!-- Choice buttons will appear here -->
        </div>
        
        <!-- Bottom Controls -->
        <div class="controls">
            <button class="control-btn" id="restartBtn">
                <i class="fas fa-redo"></i> RESTART
            </button>
            <button class="control-btn" id="saveBtn">
                <i class="fas fa-save"></i> SAVE
            </button>
            <button class="control-btn" id="loadBtn">
                <i class="fas fa-folder-open"></i> LOAD
            </button>
            <button class="control-btn" id="hintBtn">
                <i class="fas fa-lightbulb"></i> HINT
            </button>
        </div>
        
        <div class="footer">
            Tower of Terror - An RPG Gamebook | Level 2 of 5
        </div>
        
        <!-- Enhanced Combat Panel -->
        <div class="combat-panel hidden" id="combatPanel">
            <div class="combat-title">COMBAT</div>
            <div class="combatants">
                <div class="combatant player">
                    <div class="combatant-name" id="playerCombatName">YOU</div>
                    <div class="combatant-stats">
                        <div>ATTACK: <span id="playerCombatAttack">7</span></div>
                        <div>HEALTH: <span id="playerCombatHealth">20</span></div>
                        <div>DEFENSE: <span id="playerCombatDefense">5</span></div>
                    </div>
                    <div class="health-bar-container">
                        <div class="health-bar-label">
                            <span>HEALTH</span>
                            <span id="playerHealthText">20/20</span>
                        </div>
                        <div class="health-bar">
                            <div class="health-fill" id="playerHealthBar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="combatant enemy">
                    <div class="combatant-name" id="enemyCombatName">ENEMY</div>
                    <div class="combatant-stats">
                        <div>ATTACK: <span id="enemyCombatAttack">6</span></div>
                        <div>HEALTH: <span id="enemyCombatHealth">10</span></div>
                    </div>
                    <div class="health-bar-container">
                        <div class="health-bar-label">
                            <span>HEALTH</span>
                            <span id="enemyHealthText">10/10</span>
                        </div>
                        <div class="health-bar">
                            <div class="health-fill enemy" id="enemyHealthBar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="combat-log" id="combatLog"></div>
            <div class="combat-actions" id="combatActions">
                <button class="combat-btn attack" id="combatAttack">
                    <i class="fas fa-fist-raised"></i> ATTACK
                </button>
                <button class="combat-btn" id="combatUseItem">
                    <i class="fas fa-box-open"></i> USE ITEM
                </button>
                <button class="combat-btn" id="combatDefend">
                    <i class="fas fa-shield-alt"></i> DEFEND
                </button>
                <button class="combat-btn flee" id="combatFlee">
                    <i class="fas fa-running"></i> FLEE
                </button>
            </div>
        </div>
        
        <!-- Dialog Panel -->
        <div class="dialog-panel hidden" id="dialogPanel">
            <div class="dialog-title" id="dialogTitle">DIALOG</div>
            <div class="dialog-text" id="dialogText"></div>
            <div class="dialog-options" id="dialogOptions"></div>
        </div>
        
        <!-- Notification -->
        <div class="notification hidden" id="notification">
            <button class="notification-close" id="notificationClose">&times;</button>
            <div id="notificationText"></div>
        </div>
        
        <!-- Level Complete Screen -->
        <div class="level-complete hidden" id="levelComplete">
            <h2>LEVEL 2 COMPLETE!</h2>
            <p>You have survived the haunted library of the Tower of Terror. The climb grows ever more perilous...</p>
            
            <div class="level-stats">
                <div class="level-stat">
                    <div class="level-stat-value" id="completeHealth">20</div>
                    <div class="level-stat-label">Health</div>
                </div>
                <div class="level-stat">
                    <div class="level-stat-value" id="completeMana">10</div>
                    <div class="level-stat-label">Mana</div>
                </div>
                <div class="level-stat">
                    <div class="level-stat-value" id="completeItems">0</div>
                    <div class="level-stat-label">Items</div>
                </div>
                <div class="level-stat">
                    <div class="level-stat-value" id="completeGold">0</div>
                    <div class="level-stat-label">Gold</div>
                </div>
            </div>
            
            <p>Your progress has been saved. Continue to the next level or stay and explore more.</p>
            
            <div class="level-complete-buttons">
                <button class="level-complete-btn" id="continueExploring">
                    <i class="fas fa-search"></i> Keep Exploring
                </button>
                <button class="level-complete-btn next" id="nextLevelBtn">
                    <i class="fas fa-arrow-right"></i> Next Level
                </button>
            </div>
        </div>
    </div>

<script>
// ============================================
// SOUND MANAGER
// ============================================

class SoundManager {
    constructor() {
        this.sounds = {};
        this.enabled = true;
        this.context = null;
        this.initialized = false;
        this.masterVolume = 0.7;
        
        // Sound definitions
        this.soundDefs = {
            'click': { type: 'synth', frequency: 800, duration: 0.1, volume: 0.3 },
            'hover': { type: 'synth', frequency: 600, duration: 0.05, volume: 0.2 },
            'combat_attack': { type: 'synth', frequency: 1200, duration: 0.2, volume: 0.5 },
            'combat_hit': { type: 'synth', frequency: 300, duration: 0.1, volume: 0.6 },
            'combat_miss': { type: 'synth', frequency: 200, duration: 0.1, volume: 0.4 },
            'combat_critical': { type: 'synth', frequency: 1500, duration: 0.3, volume: 0.7 },
            'item_pickup': { type: 'synth', frequency: 1000, duration: 0.2, volume: 0.4 },
            'item_use': { type: 'synth', frequency: 1200, duration: 0.3, volume: 0.5 },
            'heal': { type: 'synth', frequency: 800, duration: 0.5, volume: 0.5 },
            'damage': { type: 'synth', frequency: 400, duration: 0.2, volume: 0.6 },
            'death': { type: 'synth', frequency: 200, duration: 1.0, volume: 0.8 },
            'victory': { type: 'synth', frequency: 1500, duration: 0.5, volume: 0.6 },
            'door_creak': { type: 'synth', frequency: 150, duration: 0.5, volume: 0.3 },
            'menu_open': { type: 'synth', frequency: 700, duration: 0.2, volume: 0.4 },
            'menu_close': { type: 'synth', frequency: 600, duration: 0.2, volume: 0.4 },
            'level_complete': { type: 'synth', frequency: 1200, duration: 0.8, volume: 0.7 },
            'spell_cast': { type: 'synth', frequency: 900, duration: 0.4, volume: 0.5 },
            'page_turn': { type: 'synth', frequency: 500, duration: 0.3, volume: 0.4 }
        };
    }
    
    init() {
        if (this.initialized) return;
        
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            this.context = new AudioContext();
            this.initialized = true;
            console.log("SoundManager initialized");
        } catch (e) {
            console.error("Web Audio API not supported:", e);
            this.enabled = false;
        }
    }
    
    play(soundName) {
        if (!this.enabled || !this.initialized || !this.context) return;
        
        const sound = this.soundDefs[soundName];
        if (!sound) return;
        
        if (sound.type === 'synth') {
            this.playSynth(sound.frequency, sound.duration, sound.volume);
        }
    }
    
    playSynth(frequency, duration, volume = 0.5) {
        const oscillator = this.context.createOscillator();
        const gainNode = this.context.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(this.context.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.value = volume * this.masterVolume;
        
        const now = this.context.currentTime;
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
        
        oscillator.start(now);
        oscillator.stop(now + duration);
    }
    
    playAttackSound(damage, isCritical = false) {
        if (isCritical) {
            this.play('combat_critical');
        } else if (damage > 0) {
            this.play('combat_hit');
        } else {
            this.play('combat_miss');
        }
    }
    
    toggle() {
        this.enabled = !this.enabled;
        return this.enabled;
    }
    
    setVolume(volume) {
        this.masterVolume = Math.max(0, Math.min(1, volume));
    }
}

// ============================================
// GAME DATA & MULTI-PAGE SYSTEM
// ============================================

// Game state with level tracking - LEVEL 2 SPECIFIC
const gameState = {
    currentLevel: 2,
    currentSection: 1,
    health: 20,
    mana: 10,
    attack: 7,
    defense: 5,
    inventory: [],
    equippedWeapon: null,
    equippedArmor: null,
    gold: 0,
    soundEnabled: true,
    inCombat: false,
    inDialog: false,
    combatData: null,
    npcData: null,
    inventoryOpen: false,
    visitedSections: [],
    levelsCompleted: []
};

// Item database - LEVEL 2 ITEMS (can include level 1 items too)
const items = {
    // Level 1 items (carried over)
    "Rusty Key": {
        name: "Rusty Key",
        description: "An old, rusted iron key. Might unlock something in the tower.",
        type: "key",
        weight: 0.1,
        usable: false,
        icon: "fa-key"
    },
    "Healing Herb": {
        name: "Healing Herb",
        description: "A medicinal herb that restores 5 HEALTH when consumed.",
        type: "consumable",
        weight: 0.1,
        usable: true,
        healthRestore: 5,
        icon: "fa-leaf"
    },
    "Iron Shortsword": {
        name: "Iron Shortsword",
        description: "A basic iron sword. Better than fighting bare-handed.",
        type: "weapon",
        weight: 1.5,
        usable: true,
        attackBonus: 1,
        icon: "fa-sword"
    },
    "Torch": {
        name: "Torch",
        description: "Provides light in dark places. May reveal hidden passages.",
        type: "tool",
        weight: 1.5,
        usable: true,
        icon: "fa-fire"
    },
    "Leather Armor": {
        name: "Leather Armor",
        description: "Basic protective gear. Provides +1 DEFENSE.",
        type: "armor",
        weight: 2.0,
        usable: true,
        defenseBonus: 1,
        icon: "fa-vest"
    },
    "Mana Potion": {
        name: "Mana Potion",
        description: "Restores 5 MANA when consumed. Glows with a faint blue light.",
        type: "consumable",
        weight: 0.5,
        usable: true,
        manaRestore: 5,
        icon: "fa-flask"
    },
    "Lucky Charm": {
        name: "Lucky Charm",
        description: "A small charm that makes you feel luckier. Might help in critical situations.",
        type: "trinket",
        weight: 0.2,
        usable: false,
        icon: "fa-clover"
    },
    "Stone Tablet Fragment": {
        name: "Stone Tablet Fragment",
        description: "A piece of an ancient stone tablet with strange inscriptions.",
        type: "quest",
        weight: 1.0,
        usable: false,
        icon: "fa-tablet"
    },
    "Rope": {
        name: "Rope",
        description: "A coil of sturdy rope. Could be useful for climbing or tying things.",
        type: "tool",
        weight: 1.0,
        usable: true,
        icon: "fa-ring"
    },
    "Iron Dagger": {
        name: "Iron Dagger",
        description: "A small but sharp iron dagger. Quick to draw and use.",
        type: "weapon",
        weight: 0.5,
        usable: true,
        attackBonus: 1,
        icon: "fa-dagger"
    },
    "Scroll of Minor Healing": {
        name: "Scroll of Minor Healing",
        description: "A magical scroll that can heal minor wounds. Restores 8 HEALTH.",
        type: "consumable",
        weight: 0.1,
        usable: true,
        healthRestore: 8,
        icon: "fa-scroll"
    },
    // LEVEL 2 SPECIFIC ITEMS
    "Library Key": {
        name: "Library Key",
        description: "A brass key with intricate filigree. Likely opens a special section of the library.",
        type: "key",
        weight: 0.2,
        usable: false,
        icon: "fa-key"
    },
    "Ancient Tome": {
        name: "Ancient Tome",
        description: "A heavy book bound in strange leather. The pages are filled with arcane symbols.",
        type: "quest",
        weight: 2.0,
        usable: false,
        icon: "fa-book-dead"
    },
    "Silver Longsword": {
        name: "Silver Longsword",
        description: "A finely crafted silver sword. Particularly effective against undead and magical creatures.",
        type: "weapon",
        weight: 2.0,
        usable: true,
        attackBonus: 2,
        vsUndeadDamage: 4,
        icon: "fa-sword"
    },
    "Chainmail Armor": {
        name: "Chainmail Armor",
        description: "Interlocking metal rings provide good protection. Offers +2 DEFENSE.",
        type: "armor",
        weight: 3.0,
        usable: true,
        defenseBonus: 2,
        icon: "fa-vest-patches"
    },
    "Scroll of Firebolt": {
        name: "Scroll of Firebolt",
        description: "A scroll containing the Firebolt spell. Can be used in combat to deal 6 damage.",
        type: "consumable",
        weight: 0.1,
        usable: true,
        spellDamage: 6,
        icon: "fa-fire-alt"
    },
    "Enchanted Quill": {
        name: "Enchanted Quill",
        description: "A magical quill that writes on its own. Might be useful for deciphering texts.",
        type: "tool",
        weight: 0.1,
        usable: true,
        icon: "fa-feather-alt"
    },
    "Greater Healing Potion": {
        name: "Greater Healing Potion",
        description: "A potent healing elixir that restores 10 HEALTH.",
        type: "consumable",
        weight: 0.5,
        usable: true,
        healthRestore: 10,
        icon: "fa-flask-potion"
    },
    "Ghostbane Amulet": {
        name: "Ghostbane Amulet",
        description: "A silver amulet engraved with protective runes. Provides resistance to spectral attacks.",
        type: "trinket",
        weight: 0.3,
        usable: false,
        icon: "fa-gem"
    },
    "Scholar's Glasses": {
        name: "Scholar's Glasses",
        description: "Magical glasses that help decipher ancient texts and reveal hidden writing.",
        type: "tool",
        weight: 0.2,
        usable: true,
        icon: "fa-glasses"
    },
    "Book of Warding": {
        name: "Book of Warding",
        description: "A book containing protective spells. Can create a temporary magical barrier.",
        type: "consumable",
        weight: 1.5,
        usable: true,
        defenseBonusTemp: 3,
        icon: "fa-book-open"
    }
};

// Enemy database - LEVEL 2 ENEMIES (harder than Level 1)
const enemies = {
    "Phantom Librarian": {
        name: "Phantom Librarian",
        attack: 8,
        health: 18,
        damage: 3,
        gold: 15,
        description: "The ghost of a librarian who still tends to the cursed collection.",
        weakTo: "silver",
        icon: "fa-ghost"
    },
    "Book Golem": {
        name: "Book Golem",
        attack: 9,
        health: 22,
        damage: 4,
        gold: 12,
        description: "A creature made of animated books and parchment.",
        weakTo: "fire",
        icon: "fa-book"
    },
    "Knowledge Leech": {
        name: "Knowledge Leech",
        attack: 7,
        health: 15,
        damage: 2,
        gold: 8,
        description: "A spectral parasite that drains knowledge and memories.",
        weakTo: "holy",
        icon: "fa-brain"
    },
    "Arcane Guardian": {
        name: "Arcane Guardian",
        attack: 10,
        health: 25,
        damage: 5,
        gold: 20,
        description: "A magical construct created to protect the library's secrets.",
        weakTo: "magic",
        icon: "fa-robot"
    },
    "Cursed Scroll": {
        name: "Cursed Scroll",
        attack: 6,
        health: 12,
        damage: 3,
        gold: 5,
        description: "An ancient scroll that has gained malevolent sentience.",
        weakTo: "fire",
        icon: "fa-scroll"
    },
    "Wraith Scholar": {
        name: "Wraith Scholar",
        attack: 9,
        health: 20,
        damage: 4,
        gold: 18,
        description: "The tormented spirit of a mage who sought forbidden knowledge.",
        weakTo: "silver",
        icon: "fa-user-graduate"
    }
};

// Story sections for Level 2 - THE HAUNTED LIBRARY
const storySections = {
    1: {
        text: "You ascend the spiral staircase from the entryway and find yourself in an enormous library. Bookshelves stretch to a ceiling lost in shadows. The air smells of old paper, dust, and something else... something unnatural. Flickering magical lights cast strange shadows among the stacks. A whisper seems to come from everywhere at once: 'Knowledge has a price...'",
        choices: [
            { text: "Search the nearest bookshelf", next: 2, icon: "fa-search", sound: "click" },
            { text: "Follow the whispering voice", next: 3, icon: "fa-ear-deaf", sound: "click" },
            { text: "Look for an exit or staircase upward", next: 4, icon: "fa-stairs", sound: "click" }
        ]
    },
    2: {
        text: "The bookshelf contains volumes with strange titles: 'The Necronomicon', 'De Vermis Mysteriis', 'The King in Yellow'. As you pull one out, the books around it shift and a hidden compartment is revealed. Inside, you find a silver longsword and a library key.",
        choices: [
            { text: "Take the silver longsword", action: "addItem", item: "Silver Longsword", icon: "fa-sword", sound: "item_pickup" },
            { text: "Take the library key", action: "addItem", item: "Library Key", icon: "fa-key", sound: "item_pickup" },
            { text: "Take both", action: "addMultiple", items: ["Silver Longsword", "Library Key"], icon: "fa-box-open", sound: "item_pickup" },
            { text: "Leave them and search elsewhere", next: 1, icon: "fa-times", sound: "click" }
        ]
    },
    3: {
        text: "You follow the whispering through the maze of bookshelves. The voice grows clearer: '...the third tablet lies in the restricted section...' You round a corner and come face-to-face with a translucent figure in tattered robes - a Phantom Librarian!",
        choices: [
            { text: "Attack the phantom", action: "startCombat", enemy: "Phantom Librarian", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Ask about the tablet", next: 5, icon: "fa-question", sound: "click" },
            { text: "Back away slowly", next: 1, icon: "fa-walking", sound: "click" }
        ]
    },
    4: {
        text: "You search for an exit but find only more bookshelves. The library seems endless. However, you do discover a study area with several desks. On one, an enchanted quill writes by itself in a large tome. Next to it rests a pair of scholar's glasses.",
        choices: [
            { text: "Take the enchanted quill", action: "addItem", item: "Enchanted Quill", icon: "fa-feather-alt", sound: "item_pickup" },
            { text: "Take the scholar's glasses", action: "addItem", item: "Scholar's Glasses", icon: "fa-glasses", sound: "item_pickup" },
            { text: "Read what the quill is writing", next: 6, icon: "fa-book-open", sound: "page_turn" },
            { text: "Continue searching for an exit", next: 7, icon: "fa-search", sound: "click" }
        ]
    },
    5: {
        text: "'The third stone tablet?' the phantom whispers. 'It lies in the restricted section, protected by the Arcane Guardian. But first, you must prove your worth... by retrieving the Ancient Tome from the Book Golem's domain.' The phantom gestures toward a dark aisle.",
        choices: [
            { text: "Ask how to find the Book Golem", next: 8, icon: "fa-question", sound: "click" },
            { text: "Attack the phantom anyway", action: "startCombat", enemy: "Phantom Librarian", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Go search for the Book Golem", next: 9, icon: "fa-arrow-right", sound: "click" }
        ]
    },
    6: {
        text: "The quill is writing in an ancient language, but with the scholar's glasses, you can read it: 'The tower was built not as a prison, but as a conduit. The master seeks to channel energy from seven souls to open a gateway to...' The writing stops abruptly as the quill runs out of ink.",
        choices: [
            { text: "Take the quill anyway", action: "addItem", item: "Enchanted Quill", icon: "fa-feather-alt", sound: "item_pickup" },
            { text: "Take the glasses", action: "addItem", item: "Scholar's Glasses", icon: "fa-glasses", sound: "item_pickup" },
            { text: "Search for more information", next: 10, icon: "fa-search", sound: "click" }
        ]
    },
    7: {
        text: "You continue through the library and find a section with cages instead of bookshelves. Inside one, you see a shimmering potion and a scroll. The cage is locked, but the lock looks simple.",
        choices: [
            { text: "Try to pick the lock", next: 11, icon: "fa-lock-open", sound: "click" },
            { text: "Search for a key", next: 12, icon: "fa-search", sound: "click" },
            { text: "Force the cage open", next: 13, icon: "fa-hammer", sound: "click" }
        ]
    },
    8: {
        text: "'The Book Golem resides in the Archives of Forbidden Knowledge,' the phantom explains. 'Follow the black candles. But beware - it is protective of its collection.' The phantom begins to fade. 'Return with the Ancient Tome, and I shall grant you passage to the restricted section.'",
        choices: [
            { text: "Head to the Archives", next: 9, icon: "fa-arrow-right", sound: "click" },
            { text: "Ask for help or a weapon", next: 14, icon: "fa-handshake", sound: "click" },
            { text: "Attack the phantom before it fades", action: "startCombat", enemy: "Phantom Librarian", icon: "fa-fist-raised", sound: "combat_attack" }
        ]
    },
    9: {
        text: "You follow a path marked by black candles into a deeper part of the library. The air grows colder. Ahead, you see a massive creature made of books and parchment - the Book Golem! It stands guard before a pedestal holding an Ancient Tome.",
        choices: [
            { text: "Attack the Book Golem", action: "startCombat", enemy: "Book Golem", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Try to sneak past it", next: 15, icon: "fa-user-secret", sound: "click" },
            { text: "Attempt to reason with it", next: 16, icon: "fa-comment", sound: "click" }
        ]
    },
    10: {
        text: "You search the study area and find a hidden drawer in the desk. Inside is a scroll of firebolt and a greater healing potion. You also find a note: 'The third tablet is the key to binding the master. Find all three before the seventh soul is taken.'",
        choices: [
            { text: "Take the scroll of firebolt", action: "addItem", item: "Scroll of Firebolt", icon: "fa-fire-alt", sound: "item_pickup" },
            { text: "Take the greater healing potion", action: "addItem", item: "Greater Healing Potion", icon: "fa-flask-potion", sound: "item_pickup" },
            { text: "Take both", action: "addMultiple", items: ["Scroll of Firebolt", "Greater Healing Potion"], icon: "fa-box-open", sound: "item_pickup" },
            { text: "Continue exploring", next: 1, icon: "fa-arrows", sound: "click" }
        ]
    },
    11: {
        text: "You pick the lock with a bit of wire from your pack. The cage opens with a click. Inside, you find the scroll of firebolt and greater healing potion, plus 25 gold coins!",
        choices: [
            { text: "Take the scroll", action: "addItem", item: "Scroll of Firebolt", icon: "fa-fire-alt", sound: "item_pickup" },
            { text: "Take the potion", action: "addItem", item: "Greater Healing Potion", icon: "fa-flask-potion", sound: "item_pickup" },
            { text: "Take the gold", action: "addGold", amount: 25, icon: "fa-coins", sound: "item_pickup" },
            { text: "Take everything", action: "addMultiple", items: ["Scroll of Firebolt", "Greater Healing Potion"], gold: 25, icon: "fa-box-open", sound: "item_pickup" }
        ]
    },
    12: {
        text: "You search nearby and find a key hanging on a hook behind a bookshelf. It fits the cage perfectly! Inside, you find valuable items and gold.",
        choices: [
            { text: "Take the scroll of firebolt", action: "addItem", item: "Scroll of Firebolt", icon: "fa-fire-alt", sound: "item_pickup" },
            { text: "Take the greater healing potion", action: "addItem", item: "Greater Healing Potion", icon: "fa-flask-potion", sound: "item_pickup" },
            { text: "Take the 25 gold", action: "addGold", amount: 25, icon: "fa-coins", sound: "item_pickup" }
        ]
    },
    13: {
        text: "You force the cage open with a loud crash! The noise attracts attention - a Cursed Scroll detaches from a nearby shelf and unfurls menacingly, its ancient writing glowing with malevolent energy.",
        choices: [
            { text: "Fight the Cursed Scroll", action: "startCombat", enemy: "Cursed Scroll", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Grab the items and run", next: 17, icon: "fa-running", sound: "click" }
        ]
    },
    14: {
        text: "'I have little to offer,' the phantom says. 'But take this ghostbane amulet. It will protect you from spectral attacks.' The phantom hands you a silver amulet before fading completely.",
        choices: [
            { text: "Take the ghostbane amulet", action: "addItem", item: "Ghostbane Amulet", icon: "fa-gem", sound: "item_pickup" },
            { text: "Head to the Archives", next: 9, icon: "fa-arrow-right", sound: "click" }
        ]
    },
    15: {
        text: "You try to sneak past the Book Golem, moving silently between bookshelves. You're almost to the Ancient Tome when a loose floorboard creaks! The creature turns toward you, its pages rustling angrily.",
        choices: [
            { text: "Attack while it's surprised", action: "startCombat", enemy: "Book Golem", advantage: true, icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Grab the tome and run", next: 18, icon: "fa-running", sound: "click" },
            { text: "Try to calm it", next: 16, icon: "fa-dove", sound: "click" }
        ]
    },
    16: {
        text: "'I mean no harm,' you say to the Book Golem. 'I only seek knowledge.' The creature pauses, its pages settling. It gestures toward the Ancient Tome, then to a nearby bookshelf containing a book of warding.",
        choices: [
            { text: "Take the Ancient Tome", action: "addItem", item: "Ancient Tome", icon: "fa-book-dead", sound: "item_pickup" },
            { text: "Take the Book of Warding", action: "addItem", item: "Book of Warding", icon: "fa-book-open", sound: "item_pickup" },
            { text: "Take both", action: "addMultiple", items: ["Ancient Tome", "Book of Warding"], icon: "fa-box-open", sound: "item_pickup" },
            { text: "Thank the golem and leave", next: 19, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    17: {
        text: "You grab the scroll, potion, and gold, then sprint away. The Cursed Scroll gives chase but can't keep up. You've escaped with your loot, but the noise has alerted other denizens of the library.",
        choices: [
            { text: "Hide and catch your breath", next: 20, icon: "fa-eye-slash", sound: "click" },
            { text: "Keep moving", next: 1, icon: "fa-walking", sound: "click" }
        ]
    },
    18: {
        text: "You snatch the Ancient Tome from the pedestal and run! The Book Golem gives chase, but you're faster. You escape back to the main library, the heavy tome in your arms.",
        choices: [
            { text: "Examine the Ancient Tome", action: "addItem", item: "Ancient Tome", icon: "fa-book-dead", sound: "item_pickup" },
            { text: "Return to the Phantom Librarian", next: 21, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    19: {
        text: "You thank the Book Golem and leave the Archives. With the Ancient Tome in hand, you return to where you met the Phantom Librarian. The spectral figure reappears as you approach.",
        choices: [
            { text: "Present the Ancient Tome", next: 21, requireItem: "Ancient Tome", icon: "fa-hand-holding", sound: "click" },
            { text: "Attack the phantom", action: "startCombat", enemy: "Phantom Librarian", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Ask for your reward", next: 22, icon: "fa-coins", sound: "click" }
        ]
    },
    20: {
        text: "You hide behind a large bookshelf and catch your breath. While waiting, you notice a loose stone in the wall. Prying it free reveals a hidden compartment with chainmail armor inside!",
        choices: [
            { text: "Take the chainmail armor", action: "addItem", item: "Chainmail Armor", icon: "fa-vest-patches", sound: "item_pickup" },
            { text: "Continue exploring", next: 1, icon: "fa-arrows", sound: "click" }
        ]
    },
    21: {
        text: "The Phantom Librarian examines the Ancient Tome. 'Yes... this is the one. Very well, I shall grant you passage to the restricted section.' The phantom gestures, and a previously invisible door shimmers into existence between two bookshelves.",
        choices: [
            { text: "Enter the restricted section", next: 23, icon: "fa-door-open", sound: "door_creak" },
            { text: "Ask to keep the Ancient Tome", next: 24, icon: "fa-question", sound: "click" },
            { text: "Attack the phantom and take back the tome", action: "startCombat", enemy: "Phantom Librarian", icon: "fa-fist-raised", sound: "combat_attack" }
        ]
    },
    22: {
        text: "'Your reward is passage to the restricted section,' the phantom says. 'The third stone tablet awaits there. That is treasure enough.' The spectral figure seems impatient.",
        choices: [
            { text: "Accept and enter the restricted section", next: 23, requireItem: "Ancient Tome", icon: "fa-door-open", sound: "door_creak" },
            { text: "Demand something more", next: 25, icon: "fa-handshake", sound: "click" }
        ]
    },
    23: {
        text: "You enter the restricted section. The air is thick with magical energy. In the center of the room, atop a stone pedestal, rests the third stone tablet fragment. Guarding it is an Arcane Guardian - a shimmering construct of pure magical force.",
        choices: [
            { text: "Attack the Arcane Guardian", action: "startCombat", enemy: "Arcane Guardian", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Try to sneak past it", next: 26, icon: "fa-user-secret", sound: "click" },
            { text: "Use a scroll of firebolt", next: 27, requireItem: "Scroll of Firebolt", icon: "fa-fire-alt", sound: "spell_cast" }
        ]
    },
    24: {
        text: "'The tome must remain here,' the phantom insists. 'It is too dangerous to leave the library. But you may take this instead.' The phantom offers you a book of warding in exchange.",
        choices: [
            { text: "Accept the exchange", action: "tradeItem", give: "Ancient Tome", receive: "Book of Warding", icon: "fa-exchange-alt", sound: "item_pickup" },
            { text: "Refuse and attack", action: "startCombat", enemy: "Phantom Librarian", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Give up the tome and enter", next: 23, icon: "fa-door-open", sound: "door_creak" }
        ]
    },
    25: {
        text: "'Very well,' the phantom sighs. 'Take this knowledge as well.' It hands you a scroll containing information: 'The master's true name is inscribed on the central pillar of the tower. Speak it to weaken him.'",
        choices: [
            { text: "Take the scroll and enter", next: 23, icon: "fa-door-open", sound: "door_creak" },
            { text: "Attack anyway", action: "startCombat", enemy: "Phantom Librarian", icon: "fa-fist-raised", sound: "combat_attack" }
        ]
    },
    26: {
        text: "You try to sneak past the Arcane Guardian, but magical sensors detect your movement! The guardian activates and attacks.",
        choices: [
            { text: "Fight the guardian", action: "startCombat", enemy: "Arcane Guardian", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Use the book of warding", next: 28, requireItem: "Book of Warding", icon: "fa-book-open", sound: "spell_cast" }
        ]
    },
    27: {
        text: "You read the scroll of firebolt aloud. A bolt of magical fire streaks toward the Arcane Guardian, striking it for significant damage! The creature staggers but doesn't fall.",
        choices: [
            { text: "Attack while it's damaged", action: "startCombat", enemy: "Arcane Guardian", advantage: true, icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Use another item", next: 29, icon: "fa-box-open", sound: "click" }
        ]
    },
    28: {
        text: "You open the Book of Warding and read a protective incantation. A shimmering barrier forms around you, deflecting the guardian's first attack!",
        choices: [
            { text: "Attack while protected", action: "startCombat", enemy: "Arcane Guardian", defenseBoost: 3, icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Try to grab the tablet and run", next: 30, icon: "fa-running", sound: "click" }
        ]
    },
    29: {
        text: "The Arcane Guardian recovers from the firebolt and prepares to attack. You need to act quickly!",
        choices: [
            { text: "Attack with your weapon", action: "startCombat", enemy: "Arcane Guardian", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Use another scroll if you have one", next: 31, requireItem: "Scroll of Firebolt", icon: "fa-fire-alt", sound: "spell_cast" },
            { text: "Try to grab the tablet", next: 30, icon: "fa-running", sound: "click" }
        ]
    },
    30: {
        text: "You dash past the Arcane Guardian and grab the stone tablet fragment! As your hand closes around it, the guardian freezes in place, then crumbles to dust. The tablet glows with a soft light, and you feel its power.",
        choices: [
            { text: "Take the stone tablet fragment", action: "addItem", item: "Stone Tablet Fragment", icon: "fa-tablet", sound: "item_pickup" },
            { text: "Search the room before leaving", next: 32, icon: "fa-search", sound: "click" }
        ]
    },
    31: {
        text: "You use another scroll of firebolt! The magical flames strike the guardian again, and this time it collapses into a pile of inert magical components. The way to the stone tablet is clear.",
        choices: [
            { text: "Take the stone tablet fragment", action: "addItem", item: "Stone Tablet Fragment", icon: "fa-tablet", sound: "item_pickup" },
            { text: "Search the remains of the guardian", next: 33, icon: "fa-search", sound: "click" }
        ]
    },
    32: {
        text: "You search the restricted section and find a hidden alcove behind the pedestal. Inside are 50 gold coins and a note: 'Three tablets to bind the master. Four souls remain. Hurry.'",
        choices: [
            { text: "Take the gold", action: "addGold", amount: 50, icon: "fa-coins", sound: "item_pickup" },
            { text: "Take the stone tablet fragment", action: "addItem", item: "Stone Tablet Fragment", icon: "fa-tablet", sound: "item_pickup" },
            { text: "Take both", action: "addMultiple", items: ["Stone Tablet Fragment"], gold: 50, icon: "fa-box-open", sound: "item_pickup" }
        ]
    },
    33: {
        text: "Searching the remains of the Arcane Guardian, you find its core - a magical crystal that hums with power. It could be valuable or useful. The stone tablet fragment rests on the pedestal nearby.",
        choices: [
            { text: "Take the magical crystal", action: "addItem", item: "Mana Potion", icon: "fa-gem", sound: "item_pickup" },
            { text: "Take the stone tablet fragment", action: "addItem", item: "Stone Tablet Fragment", icon: "fa-tablet", sound: "item_pickup" },
            { text: "Take both", action: "addMultiple", items: ["Mana Potion", "Stone Tablet Fragment"], icon: "fa-box-open", sound: "item_pickup" }
        ]
    },
    34: {
        text: "With the third stone tablet fragment in your possession, you feel a pull from deeper within the tower. A section of the library wall slides open, revealing a staircase leading upward to Level 3. The whispers in the library grow silent as you prepare to continue your climb.",
        choices: [
            { text: "Ascend to Level 3", action: "completeLevel", icon: "fa-arrow-up", sound: "level_complete" },
            { text: "Explore the library one last time", next: 35, icon: "fa-search", sound: "click" }
        ]
    },
    35: {
        text: "You take a final look around the haunted library. The Phantom Librarian watches from the shadows but makes no move to stop you. You've found what you came for. It's time to continue upward.",
        choices: [
            { text: "Ascend to Level 3", action: "completeLevel", icon: "fa-arrow-up", sound: "level_complete" }
        ]
    }
};

// ============================================
// GAME FUNCTIONS - UPDATED FOR TOWER OF TERROR LEVEL 2
// ============================================

// DOM elements
const loadingScreen = document.getElementById('loading');
const gameContainer = document.getElementById('gameContainer');
const storyText = document.getElementById('storyText');
const choicesContainer = document.getElementById('choicesContainer');
const healthValue = document.getElementById('healthValue');
const manaValue = document.getElementById('manaValue');
const attackValue = document.getElementById('attackValue');
const defenseValue = document.getElementById('defenseValue');
const inventoryToggle = document.getElementById('inventoryToggle');
const inventoryPanel = document.getElementById('inventoryPanel');
const inventoryContent = document.getElementById('inventoryContent');
const inventoryWeight = document.getElementById('inventoryWeight');
const inventoryGold = document.getElementById('inventoryGold');
const inventoryCount = document.getElementById('inventoryCount');
const inventoryBadge = document.getElementById('inventoryBadge');
const inventoryClose = document.getElementById('inventoryClose');
const combatPanel = document.getElementById('combatPanel');
const playerCombatHealth = document.getElementById('playerCombatHealth');
const playerHealthBar = document.getElementById('playerHealthBar');
const playerHealthText = document.getElementById('playerHealthText');
const enemyCombatName = document.getElementById('enemyCombatName');
const enemyCombatAttack = document.getElementById('enemyCombatAttack');
const enemyCombatHealth = document.getElementById('enemyCombatHealth');
const enemyHealthBar = document.getElementById('enemyHealthBar');
const enemyHealthText = document.getElementById('enemyHealthText');
const combatLog = document.getElementById('combatLog');
const notification = document.getElementById('notification');
const notificationText = document.getElementById('notificationText');
const notificationClose = document.getElementById('notificationClose');
const levelComplete = document.getElementById('levelComplete');
const pageNav = document.getElementById('pageNav');
const completeHealth = document.getElementById('completeHealth');
const completeMana = document.getElementById('completeMana');
const completeItems = document.getElementById('completeItems');
const completeGold = document.getElementById('completeGold');
const nextLevelBtn = document.getElementById('nextLevelBtn');
const continueExploring = document.getElementById('continueExploring');

// Sound manager instance
const soundManager = new SoundManager();

// Initialize game
function initGame() {
    console.log("Initializing Tower of Terror Level 2...");
    
    // Check for saved game state
    loadGameState();
    
    // Initialize sound manager on first user interaction
    document.addEventListener('click', () => {
        if (!soundManager.initialized) {
            soundManager.init();
        }
    }, { once: true });
    
    simulateLoading();
    setupEventListeners();
}

// Simulate loading
function simulateLoading() {
    let progress = 0;
    const interval = setInterval(() => {
        progress += 5;
        document.getElementById('loadingProgress').style.width = `${progress}%`;
        
        if (progress <= 30) {
            document.getElementById('loadingStatus').textContent = "Loading saved game state...";
        } else if (progress <= 60) {
            document.getElementById('loadingStatus').textContent = "Loading Level 2: The Haunted Library...";
        } else if (progress <= 90) {
            document.getElementById('loadingStatus').textContent = "Preparing your continued climb...";
        } else {
            document.getElementById('loadingStatus').textContent = "Entering the haunted library...";
        }
        
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(startGame, 500);
        }
    }, 50);
}

// Start game
function startGame() {
    loadingScreen.classList.add('hidden');
    gameContainer.classList.remove('hidden');
    loadSection(gameState.currentSection);
    updateInventoryDisplay();
    showNotification(`Welcome to Level ${gameState.currentLevel}`, "The Haunted Library awaits. Knowledge has a price...", "info");
    soundManager.play('menu_open');
}

// Setup event listeners
function setupEventListeners() {
    // Inventory toggle
    inventoryToggle.addEventListener('click', () => {
        gameState.inventoryOpen = !gameState.inventoryOpen;
        inventoryPanel.classList.toggle('hidden');
        soundManager.play(gameState.inventoryOpen ? 'menu_open' : 'menu_close');
        
        if (gameState.inventoryOpen) {
            updateInventoryDisplay();
        }
    });
    
    inventoryClose.addEventListener('click', () => {
        gameState.inventoryOpen = false;
        inventoryPanel.classList.add('hidden');
        soundManager.play('menu_close');
    });
    
    // Control buttons
    document.getElementById('restartBtn').addEventListener('click', restartGame);
    document.getElementById('saveBtn').addEventListener('click', saveGame);
    document.getElementById('loadBtn').addEventListener('click', loadGame);
    document.getElementById('hintBtn').addEventListener('click', showHint);
    
    // Sound toggle
    document.getElementById('soundToggle').addEventListener('click', () => {
        gameState.soundEnabled = soundManager.toggle();
        const soundToggle = document.getElementById('soundToggle');
        soundToggle.textContent = gameState.soundEnabled ? "ðŸ”Š" : "ðŸ”‡";
        soundToggle.title = gameState.soundEnabled ? "Sound On" : "Sound Off";
        soundManager.play('click');
    });
    
    // Combat buttons
    document.getElementById('combatAttack').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('combat_attack');
            performAttack();
        }
    });
    
    document.getElementById('combatUseItem').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('click');
            showCombatItems();
        }
    });
    
    document.getElementById('combatDefend').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('click');
            defend();
        }
    });
    
    document.getElementById('combatFlee').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('click');
            tryFlee();
        }
    });
    
    // Notification close
    notificationClose.addEventListener('click', () => {
        notification.classList.add('hidden');
        soundManager.play('menu_close');
    });
    
    // Organize inventory button
    document.getElementById('organizeInventory').addEventListener('click', () => {
        organizeInventory();
        soundManager.play('click');
    });
    
    // Page navigation
    pageNav.addEventListener('click', () => {
        showLevelSelector();
        soundManager.play('menu_open');
    });
    
    // Level complete buttons
    nextLevelBtn.addEventListener('click', goToNextLevel);
    continueExploring.addEventListener('click', () => {
        levelComplete.classList.add('hidden');
        soundManager.play('menu_close');
    });
    
    // Add hover sounds to all buttons
    document.addEventListener('mouseover', (e) => {
        if (e.target.tagName === 'BUTTON' && !e.target.disabled && gameState.soundEnabled) {
            soundManager.play('hover');
        }
    }, true);
}

// ============================================
// MULTI-PAGE SYSTEM FUNCTIONS
// ============================================

// Save game state to localStorage
function saveGameState() {
    try {
        const saveData = {
            currentLevel: gameState.currentLevel,
            currentSection: gameState.currentSection,
            health: gameState.health,
            mana: gameState.mana,
            attack: gameState.attack,
            defense: gameState.defense,
            inventory: gameState.inventory,
            equippedWeapon: gameState.equippedWeapon,
            equippedArmor: gameState.equippedArmor,
            gold: gameState.gold,
            soundEnabled: gameState.soundEnabled,
            visitedSections: gameState.visitedSections,
            levelsCompleted: gameState.levelsCompleted
        };
        
        localStorage.setItem('towerOfTerrorSave', JSON.stringify(saveData));
        console.log("Game state saved to localStorage");
        return true;
    } catch (e) {
        console.error("Failed to save game state:", e);
        return false;
    }
}

// Load game state from localStorage
function loadGameState() {
    try {
        const saved = localStorage.getItem('towerOfTerrorSave');
        if (saved) {
            const saveData = JSON.parse(saved);
            
            // Check if we need to carry over inventory from Level 1
            // If this is a fresh Level 2 load (no Level 2 save), we need to initialize with Level 1 state
            if (saveData.currentLevel === 1) {
                // Player is coming from Level 1, carry over their state
                Object.assign(gameState, saveData);
                gameState.currentLevel = 2;
                gameState.currentSection = 1;
                console.log("Carrying over Level 1 state to Level 2");
            } else if (saveData.currentLevel === 2) {
                // Player has a Level 2 save, load it
                Object.assign(gameState, saveData);
                console.log("Loaded Level 2 saved game");
            }
            
            // Ensure we're on the right level
            gameState.currentLevel = 2;
            
            return true;
        } else {
            // No save exists, start fresh Level 2
            console.log("No saved game found, starting fresh Level 2");
            return false;
        }
    } catch (e) {
        console.error("Failed to load game state:", e);
        return false;
    }
}

// Complete current level
function completeLevel() {
    soundManager.play('level_complete');
    
    // Add this level to completed levels if not already
    if (!gameState.levelsCompleted.includes(gameState.currentLevel)) {
        gameState.levelsCompleted.push(gameState.currentLevel);
    }
    
    // Save game state
    saveGameState();
    
    // Update level complete screen stats
    completeHealth.textContent = gameState.health;
    completeMana.textContent = gameState.mana;
    completeItems.textContent = gameState.inventory.reduce((total, item) => total + (item.quantity || 1), 0);
    completeGold.textContent = gameState.gold;
    
    // Show level complete screen
    levelComplete.classList.remove('hidden');
}

// Go to next level
function goToNextLevel() {
    const nextLevel = gameState.currentLevel + 1;
    
    // Save current state before navigating
    saveGameState();
    
    // Navigate to next level page
    soundManager.play('menu_open');
    setTimeout(() => {
        window.location.href = `level${nextLevel}.html`;
    }, 500);
}

// Show level selector
function showLevelSelector() {
    const dialogTitle = document.getElementById('dialogTitle');
    const dialogText = document.getElementById('dialogText');
    const dialogOptions = document.getElementById('dialogOptions');
    const dialogPanel = document.getElementById('dialogPanel');
    
    dialogTitle.textContent = "SELECT LEVEL";
    dialogText.textContent = "Choose which level to play. Your current progress will be saved.";
    
    dialogOptions.innerHTML = '';
    
    // Create level buttons (for up to 5 levels)
    for (let i = 1; i <= 5; i++) {
        const levelBtn = document.createElement('button');
        levelBtn.className = 'dialog-option';
        levelBtn.innerHTML = `<i class="fas fa-map"></i> Level ${i} ${gameState.levelsCompleted.includes(i) ? '(Completed)' : ''}`;
        
        // Allow navigation to completed levels or next level
        let disabled = false;
        let tooltip = "";
        
        if (i > gameState.currentLevel + 1 && !gameState.levelsCompleted.includes(i-1)) {
            disabled = true;
            tooltip = "Complete previous level first";
        } else if (i > gameState.currentLevel && i > 1 && !gameState.levelsCompleted.includes(i-1)) {
            // For Level 3 when on Level 2: allow if Level 2 is in progress
            disabled = false;
        }
        
        if (disabled) {
            levelBtn.disabled = true;
            if (tooltip) levelBtn.title = tooltip;
        }
        
        // Always attach event listener
        levelBtn.addEventListener('click', () => {
            if (levelBtn.disabled) {
                soundManager.play('combat_miss');
                showNotification("Level Locked", tooltip || "You cannot access this level yet", "info");
                return;
            }
            
            soundManager.play('click');
            if (i !== gameState.currentLevel) {
                // Save current game
                saveGameState();
                
                // Navigate to selected level
                setTimeout(() => {
                    if (i === 1) {
                        window.location.href = 'level1.html';
                    } else if (i === 2) {
                        window.location.href = 'level2.html';
                    } else if (i === 3) {
                        window.location.href = 'level3.html';
                    } else if (i === 4) {
                        window.location.href = 'level4.html';
                    } else if (i === 5) {
                        window.location.href = 'level5.html';
                    }
                }, 300);
            }
            dialogPanel.classList.add('hidden');
        });
        
        dialogOptions.appendChild(levelBtn);
    }
    
    // Cancel button
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'dialog-option';
    cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
    cancelBtn.addEventListener('click', () => {
        dialogPanel.classList.add('hidden');
        soundManager.play('menu_close');
    });
    dialogOptions.appendChild(cancelBtn);
    
    dialogPanel.classList.remove('hidden');
}

// ============================================
// GAME CORE FUNCTIONS
// ============================================

// Show notification
function showNotification(title, message, type = "info") {
    notificationText.innerHTML = `<strong>${title}</strong><br>${message}`;
    notification.classList.remove('hidden');
    
    // Play appropriate sound
    if (gameState.soundEnabled) {
        if (type === "item") soundManager.play('item_pickup');
        else if (type === "heal") soundManager.play('heal');
        else if (type === "damage") soundManager.play('damage');
        else if (type === "death") soundManager.play('death');
        else if (type === "victory") soundManager.play('victory');
        else if (type === "level_complete") soundManager.play('level_complete');
        else if (type === "spell_cast") soundManager.play('spell_cast');
        else if (type === "page_turn") soundManager.play('page_turn');
        else soundManager.play('click');
    }
    
    setTimeout(() => {
        if (!notification.classList.contains('hidden')) {
            notification.classList.add('hidden');
        }
    }, 3000);
}

// Add item to inventory
function addItem(itemName) {
    const item = items[itemName];
    if (!item) {
        console.error("Item not found:", itemName);
        return false;
    }
    
    // Check weight limit
    const currentWeight = gameState.inventory.reduce((sum, invItem) => {
        const itemData = items[invItem.name];
        return sum + (itemData?.weight || 0) * (invItem.quantity || 1);
    }, 0);
    
    if (currentWeight + item.weight > 10) {
        showNotification("Inventory Full", `Cannot carry ${itemName}. Too heavy!`, "info");
        return false;
    }
    
    // Add item
    const existingItem = gameState.inventory.find(invItem => invItem.name === itemName);
    if (existingItem) {
        existingItem.quantity = (existingItem.quantity || 1) + 1;
    } else {
        gameState.inventory.push({
            name: itemName,
            quantity: 1,
            equipped: false
        });
    }
    
    updateInventoryDisplay();
    showNotification("Item Found", `You found: ${itemName}`, "item");
    
    // Auto-save after getting item
    saveGameState();
    
    return true;
}

// Add gold
function addGold(amount) {
    gameState.gold += amount;
    showNotification("Gold Found", `You found ${amount} gold coins!`, "item");
    updateInventoryDisplay();
    saveGameState();
}

// Trade item (for special exchanges)
function tradeItem(giveItem, receiveItem) {
    if (removeItem(giveItem)) {
        addItem(receiveItem);
        loadSection(gameState.currentSection + 1);
        return true;
    }
    return false;
}

// Update inventory display
function updateInventoryDisplay() {
    inventoryContent.innerHTML = '';
    
    if (gameState.inventory.length === 0) {
        inventoryContent.innerHTML = `
            <div class="inventory-empty">
                <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 20px; color: #666;"></i>
                <div>Your inventory is empty</div>
                <div style="font-size: 0.9rem; margin-top: 10px;">Explore the library to find items!</div>
            </div>
        `;
    } else {
        const grid = document.createElement('div');
        grid.className = 'inventory-grid';
        
        let totalWeight = 0;
        let totalItems = 0;
        
        // Sort items by type and name
        const sortedInventory = [...gameState.inventory].sort((a, b) => {
            const itemA = items[a.name];
            const itemB = items[b.name];
            
            // Weapons first, then armor, then consumables, then tools, then keys
            const typeOrder = { weapon: 0, armor: 1, consumable: 2, tool: 3, key: 4, quest: 5, trinket: 6 };
            const orderA = typeOrder[itemA.type] || 7;
            const orderB = typeOrder[itemB.type] || 7;
            
            if (orderA !== orderB) return orderA - orderB;
            return a.name.localeCompare(b.name);
        });
        
        sortedInventory.forEach(invItem => {
            const item = items[invItem.name];
            if (!item) return;
            
            totalWeight += item.weight * (invItem.quantity || 1);
            totalItems += invItem.quantity || 1;
            
            const itemCard = document.createElement('div');
            itemCard.className = 'inventory-item-card';
            if (invItem.equipped) {
                itemCard.classList.add('item-equipped');
            }
            
            itemCard.innerHTML = `
                <div class="item-icon">
                    <i class="fas ${item.icon}"></i>
                </div>
                <div class="item-name">${invItem.name}</div>
                <div class="item-type">${item.type.toUpperCase()}</div>
                ${(invItem.quantity || 1) > 1 ? `<div class="item-quantity">${invItem.quantity}</div>` : ''}
                <div class="item-tooltip">${item.description}</div>
            `;
            
            // Add click handler
            itemCard.addEventListener('click', () => showItemDetails(invItem.name));
            
            grid.appendChild(itemCard);
        });
        
        inventoryContent.appendChild(grid);
        
        // Add item details section
        const detailsSection = document.createElement('div');
        detailsSection.className = 'item-details';
        detailsSection.id = 'itemDetails';
        detailsSection.innerHTML = `
            <div style="color: #999; text-align: center;">Click on an item for details</div>
        `;
        inventoryContent.appendChild(detailsSection);
    }
    
    // Update inventory stats
    inventoryWeight.textContent = `Weight: ${totalWeight.toFixed(1)}/10`;
    inventoryGold.textContent = `Gold: ${gameState.gold}`;
    inventoryCount.textContent = `Items: ${totalItems}`;
    
    // Update inventory badge
    inventoryBadge.textContent = totalItems;
    inventoryBadge.style.display = totalItems > 0 ? 'flex' : 'none';
}

// Show item details
function showItemDetails(itemName) {
    const item = items[itemName];
    if (!item) return;
    
    const invItem = gameState.inventory.find(i => i.name === itemName);
    if (!invItem) return;
    
    const detailsSection = document.getElementById('itemDetails');
    detailsSection.innerHTML = `
        <div style="color: #d0a050; font-size: 1.2rem; margin-bottom: 10px;">
            <i class="fas ${item.icon}"></i> ${itemName}
        </div>
        <div class="item-description">${item.description}</div>
        <div style="margin-top: 10px; color: #ccc;">
            <div>Type: ${item.type.toUpperCase()}</div>
            <div>Weight: ${item.weight}</div>
            ${item.attackBonus ? `<div>Attack Bonus: +${item.attackBonus}</div>` : ''}
            ${item.vsUndeadDamage ? `<div>Vs. Undead: +${item.vsUndeadDamage} damage</div>` : ''}
            ${item.defenseBonus ? `<div>Defense Bonus: +${item.defenseBonus}</div>` : ''}
            ${item.healthRestore ? `<div>Heals: ${item.healthRestore} HEALTH</div>` : ''}
            ${item.manaRestore ? `<div>Restores: ${item.manaRestore} MANA</div>` : ''}
            ${item.spellDamage ? `<div>Spell Damage: ${item.spellDamage}</div>` : ''}
            ${item.defenseBonusTemp ? `<div>Temporary Defense: +${item.defenseBonusTemp}</div>` : ''}
        </div>
        <div class="item-actions">
            ${item.usable ? `<button class="item-action-btn" onclick="useItem('${itemName}')">Use</button>` : ''}
            ${item.type === 'weapon' ? `<button class="item-action-btn" onclick="equipItem('${itemName}', 'weapon')">${invItem.equipped ? 'Unequip' : 'Equip'}</button>` : ''}
            ${item.type === 'armor' ? `<button class="item-action-btn" onclick="equipItem('${itemName}', 'armor')">${invItem.equipped ? 'Unequip' : 'Equip'}</button>` : ''}
            <button class="item-action-btn" onclick="dropItem('${itemName}')">Drop</button>
        </div>
    `;
    
    soundManager.play('click');
}

// Use item
function useItem(itemName) {
    const item = items[itemName];
    if (!item) return;
    
    if (itemName === "Healing Herb") {
        gameState.health = Math.min(20, gameState.health + 5);
        removeItem(itemName);
        updateStats();
        showNotification("Healing Herb", "You restore 5 HEALTH", "heal");
        soundManager.play('heal');
        saveGameState();
    } else if (itemName === "Greater Healing Potion") {
        gameState.health = Math.min(20, gameState.health + 10);
        removeItem(itemName);
        updateStats();
        showNotification("Greater Healing Potion", "You restore 10 HEALTH", "heal");
        soundManager.play('heal');
        saveGameState();
    } else if (itemName === "Mana Potion") {
        gameState.mana = Math.min(10, gameState.mana + 5);
        removeItem(itemName);
        updateStats();
        showNotification("Mana Potion", "You restore 5 MANA", "heal");
        soundManager.play('heal');
        saveGameState();
    } else if (itemName === "Scroll of Minor Healing") {
        gameState.health = Math.min(20, gameState.health + 8);
        removeItem(itemName);
        updateStats();
        showNotification("Scroll of Minor Healing", "You restore 8 HEALTH", "heal");
        soundManager.play('spell_cast');
        saveGameState();
    } else if (itemName === "Scroll of Firebolt") {
        showNotification("Scroll of Firebolt", "A powerful offensive spell. Use in combat for 6 damage.", "info");
    } else if (itemName === "Book of Warding") {
        showNotification("Book of Warding", "Creates a temporary magical barrier. Use in combat for +3 defense.", "info");
    } else if (itemName === "Torch") {
        showNotification("Torch", "The torch provides light in dark areas. It might reveal hidden things.", "info");
    } else if (itemName === "Rope") {
        showNotification("Rope", "A sturdy rope that could be useful for climbing or tying things.", "info");
    } else if (itemName === "Enchanted Quill") {
        showNotification("Enchanted Quill", "The quill writes on its own. Might help decipher ancient texts.", "info");
    } else if (itemName === "Scholar's Glasses") {
        showNotification("Scholar's Glasses", "These magical glasses help read ancient languages and reveal hidden writing.", "info");
    } else {
        showNotification(itemName, item.description, "info");
    }
    
    updateInventoryDisplay();
}

// Equip item
function equipItem(itemName, type) {
    const item = items[itemName];
    if (type === 'weapon' && item.type !== 'weapon') return;
    if (type === 'armor' && item.type !== 'armor') return;
    
    // Unequip current item of that type
    gameState.inventory.forEach(invItem => {
        const itemData = items[invItem.name];
        if (itemData && itemData.type === type && invItem.equipped) {
            invItem.equipped = false;
            
            // Remove stat bonus
            if (type === 'weapon') {
                gameState.attack -= itemData.attackBonus || 0;
                gameState.equippedWeapon = null;
            } else if (type === 'armor') {
                gameState.defense -= itemData.defenseBonus || 0;
                gameState.equippedArmor = null;
            }
        }
    });
    
    // Equip new item
    const invItem = gameState.inventory.find(i => i.name === itemName);
    invItem.equipped = !invItem.equipped;
    
    if (invItem.equipped) {
        // Apply stat bonus
        if (type === 'weapon') {
            gameState.attack += item.attackBonus || 0;
            gameState.equippedWeapon = itemName;
            showNotification("Weapon Equipped", `${itemName} is now equipped (+${item.attackBonus || 0} attack)`, "info");
        } else if (type === 'armor') {
            gameState.defense += item.defenseBonus || 0;
            gameState.equippedArmor = itemName;
            showNotification("Armor Equipped", `${itemName} is now equipped (+${item.defenseBonus || 0} defense)`, "info");
        }
    } else {
        if (type === 'weapon') {
            showNotification("Weapon Unequipped", `${itemName} is no longer equipped`, "info");
        } else if (type === 'armor') {
            showNotification("Armor Unequipped", `${itemName} is no longer equipped`, "info");
        }
    }
    
    updateInventoryDisplay();
    updateStats();
    soundManager.play('item_use');
    saveGameState();
}

// Drop item
function dropItem(itemName) {
    if (confirm(`Are you sure you want to drop ${itemName}?`)) {
        // If item is equipped, unequip it first
        const invItem = gameState.inventory.find(i => i.name === itemName);
        if (invItem && invItem.equipped) {
            const item = items[itemName];
            if (item.type === 'weapon') {
                gameState.attack -= item.attackBonus || 0;
                gameState.equippedWeapon = null;
            } else if (item.type === 'armor') {
                gameState.defense -= item.defenseBonus || 0;
                gameState.equippedArmor = null;
            }
            updateStats();
        }
        
        removeItem(itemName);
        showNotification("Item Dropped", `You dropped ${itemName}`, "info");
        updateInventoryDisplay();
        soundManager.play('click');
        saveGameState();
    }
}

// Organize inventory
function organizeInventory() {
    // Sort inventory alphabetically
    gameState.inventory.sort((a, b) => a.name.localeCompare(b.name));
    
    // Group by type
    const typeOrder = { weapon: 0, armor: 1, consumable: 2, tool: 3, key: 4, quest: 5, trinket: 6 };
    gameState.inventory.sort((a, b) => {
        const itemA = items[a.name];
        const itemB = items[b.name];
        const orderA = typeOrder[itemA.type] || 7;
        const orderB = typeOrder[itemB.type] || 7;
        return orderA - orderB;
    });
    
    updateInventoryDisplay();
    showNotification("Inventory Organized", "Items have been sorted by type and name", "info");
}

// Remove item
function removeItem(itemName) {
    const index = gameState.inventory.findIndex(item => item.name === itemName);
    if (index !== -1) {
        if (gameState.inventory[index].quantity > 1) {
            gameState.inventory[index].quantity--;
        } else {
            gameState.inventory.splice(index, 1);
        }
        return true;
    }
    return false;
}

// Update stats display
function updateStats() {
    healthValue.textContent = gameState.health;
    manaValue.textContent = gameState.mana;
    attackValue.textContent = gameState.attack;
    defenseValue.textContent = gameState.defense;
    
    // Color coding
    healthValue.style.color = gameState.health > 15 ? '#a0e0a0' : 
                             gameState.health > 10 ? '#d0a050' : 
                             gameState.health > 5 ? '#d08050' : '#d05050';
    
    manaValue.style.color = gameState.mana > 7 ? '#a0a0e0' : 
                           gameState.mana > 4 ? '#a080e0' : 
                           gameState.mana > 2 ? '#a060e0' : '#a040e0';
}

// Apply effect
function applyEffect(effect) {
    if (effect.health) {
        const oldHealth = gameState.health;
        gameState.health = Math.max(0, Math.min(20, gameState.health + effect.health));
        const change = gameState.health - oldHealth;
        
        if (change < 0) {
            showNotification("Damage", `You lose ${-change} HEALTH`, "damage");
            soundManager.play('damage');
        } else if (change > 0) {
            showNotification("Healed", `You restore ${change} HEALTH`, "heal");
            soundManager.play('heal');
        }
    }
    
    if (effect.mana) {
        const oldMana = gameState.mana;
        gameState.mana = Math.max(0, Math.min(10, gameState.mana + effect.mana));
        const change = gameState.mana - oldMana;
        
        if (change < 0) {
            showNotification("Mana Drain", `You lose ${-change} MANA`, "damage");
        } else if (change > 0) {
            showNotification("Mana Restored", `You restore ${change} MANA`, "heal");
        }
    }
    
    updateStats();
    
    // Check for death
    if (gameState.health <= 0) {
        showNotification("Game Over", "You have died!", "death");
        soundManager.play('death');
        setTimeout(() => {
            storyText.innerHTML += '<div class="death-message">YOU HAVE DIED<br>GAME OVER</div>';
            choicesContainer.innerHTML = '';
        }, 1000);
        return true;
    }
    
    return false;
}

// Load section
function loadSection(sectionId) {
    if (gameState.inCombat || gameState.inDialog) return;
    
    gameState.currentSection = sectionId;
    const section = storySections[sectionId];
    
    if (!section) {
        storyText.innerHTML = "<p>End of Level 2... for now.</p>";
        choicesContainer.innerHTML = "";
        return;
    }
    
    // Apply section effect if any
    if (section.effect) {
        if (applyEffect(section.effect)) return; // Return if player died
    }
    
    // Display story text
    storyText.innerHTML = `<p>${section.text}</p>`;
    storyText.scrollTop = 0;
    
    // Clear and create choices
    choicesContainer.innerHTML = "";
    
    section.choices.forEach(choice => {
        const button = document.createElement('button');
        button.className = 'choice-btn';
        
        // Check requirements
        let disabled = false;
        if (choice.requireItem) {
            const hasItem = gameState.inventory.some(item => item.name === choice.requireItem);
            if (!hasItem) {
                disabled = true;
                button.title = `Requires: ${choice.requireItem}`;
            }
        }
        
        button.disabled = disabled;
        button.innerHTML = `<i class="fas ${choice.icon}"></i> ${choice.text}`;
        
        if (!disabled) {
            button.addEventListener('click', () => {
                if (choice.sound && gameState.soundEnabled) {
                    soundManager.play(choice.sound);
                }
                handleChoice(choice);
            });
        }
        
        choicesContainer.appendChild(button);
    });
    
    // Update stats
    updateStats();
    
    // Mark as visited
    if (!gameState.visitedSections.includes(sectionId)) {
        gameState.visitedSections.push(sectionId);
    }
}

// Handle choice
function handleChoice(choice) {
    console.log("Handling choice:", choice);
    
    if (choice.action === "addItem") {
        if (addItem(choice.item)) {
            // Stay in current section after taking item
            loadSection(gameState.currentSection);
        }
    } else if (choice.action === "addMultiple") {
        if (choice.items) {
            // For array of items
            choice.items.forEach(item => addItem(item));
            if (choice.gold) {
                addGold(choice.gold);
            }
            loadSection(gameState.currentSection);
        }
    } else if (choice.action === "addGold") {
        addGold(choice.amount);
        loadSection(gameState.currentSection);
    } else if (choice.action === "tradeItem") {
        if (tradeItem(choice.give, choice.receive)) {
            // Section will be advanced in tradeItem function
        }
    } else if (choice.action === "startCombat") {
        startCombat(choice.enemy, choice.advantage, choice.defenseBoost);
    } else if (choice.action === "completeLevel") {
        completeLevel();
    } else if (choice.next) {
        if (choice.effect) {
            applyEffect(choice.effect);
        }
        loadSection(choice.next);
    }
}

// Start combat
function startCombat(enemyName, advantage = false, defenseBoost = 0) {
    const enemy = enemies[enemyName];
    if (!enemy) return;
    
    gameState.inCombat = true;
    gameState.combatData = {
        enemy: enemy,
        enemyHealth: enemy.health,
        enemyMaxHealth: enemy.health,
        round: 1,
        playerMaxHealth: gameState.health,
        advantage: advantage,
        defending: false,
        defenseBoost: defenseBoost || 0
    };
    
    // Update UI
    enemyCombatName.textContent = enemy.name;
    enemyCombatAttack.textContent = enemy.attack;
    enemyCombatHealth.textContent = enemy.health;
    enemyHealthText.textContent = `${enemy.health}/${enemy.health}`;
    
    document.getElementById('playerCombatAttack').textContent = gameState.attack;
    playerCombatHealth.textContent = gameState.health;
    playerHealthText.textContent = `${gameState.health}/20`;
    document.getElementById('playerCombatDefense').textContent = gameState.defense + (defenseBoost || 0);
    
    // Update health bars
    const playerHealthPercent = (gameState.health / 20) * 100;
    const enemyHealthPercent = 100;
    
    playerHealthBar.style.width = `${playerHealthPercent}%`;
    enemyHealthBar.style.width = `${enemyHealthPercent}%`;
    
    combatLog.innerHTML = '';
    
    if (advantage) {
        addCombatLog(`You surprise the ${enemy.name}! You have advantage in the first round.`, "event");
    }
    
    if (defenseBoost > 0) {
        addCombatLog(`A magical barrier protects you! (+${defenseBoost} defense)`, "event");
    }
    
    addCombatLog(`A ${enemy.name} attacks!`, "event");
    
    // Show combat panel
    combatPanel.classList.remove('hidden');
    soundManager.play('combat_attack');
}

// Perform attack
function performAttack() {
    if (!gameState.inCombat || !gameState.combatData) return;
    
    const enemy = gameState.combatData.enemy;
    const playerAttack = gameState.attack;
    
    // Player attacks
    let playerRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
    
    // Advantage from surprise
    if (gameState.combatData.advantage && gameState.combatData.round === 1) {
        const advantageRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
        playerRoll = Math.max(playerRoll, advantageRoll);
    }
    
    playerRoll += playerAttack;
    const enemyRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + enemy.attack;
    
    let damage = 0;
    let isCritical = false;
    
    if (playerRoll > enemyRoll) {
        // Player hits
        damage = 2; // Base damage
        
        // Critical hit chance (roll of 12)
        const attackRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
        if (attackRoll === 12) {
            damage *= 2;
            isCritical = true;
            addCombatLog("CRITICAL HIT!", "player");
        }
        
        // Bonus damage from weapon
        if (gameState.equippedWeapon) {
            const weapon = items[gameState.equippedWeapon];
            damage = weapon.damage || damage;
            
            // Special bonus vs undead for silver weapons
            if (enemy.weakTo === "silver" && weapon.vsUndeadDamage) {
                damage = weapon.vsUndeadDamage;
                addCombatLog("The silver weapon glows with holy power!", "player");
            }
            
            // Special bonus vs constructs for magic
            if (enemy.weakTo === "magic" && weapon.spellDamage) {
                damage = weapon.spellDamage;
                addCombatLog("Magical energy disrupts the construct!", "player");
            }
        }
        
        // Bonus vs fire-weak enemies with fire spells
        if (enemy.weakTo === "fire" && gameState.combatData.usedFireSpell) {
            damage += 3;
            addCombatLog("The enemy is vulnerable to fire!", "player");
        }
        
        // Enemy defense (if any)
        damage = Math.max(1, damage);
        
        gameState.combatData.enemyHealth -= damage;
        addCombatLog(`You hit the ${enemy.name} for ${damage} damage!`, "player");
        
        // Show damage number
        showDamageNumber(enemy.name, damage, false);
        
    } else if (enemyRoll > playerRoll) {
        // Enemy hits
        if (!gameState.combatData.defending) {
            damage = enemy.damage;
            
            // Player defense reduces damage (including temporary boost)
            const totalDefense = gameState.defense + (gameState.combatData.defenseBoost || 0);
            damage = Math.max(1, damage - Math.floor(totalDefense / 2));
            
            gameState.health -= damage;
            addCombatLog(`The ${enemy.name} hits you for ${damage} damage!`, "enemy");
            
            // Show damage number
            showDamageNumber("YOU", damage, true);
        } else {
            addCombatLog(`You block the ${enemy.name}'s attack!`, "player");
            gameState.combatData.defending = false;
        }
    } else {
        // Tie
        addCombatLog("Your attacks clash with no effect!", "event");
    }
    
    // Play attack sound
    soundManager.playAttackSound(damage, isCritical);
    
    // Update UI
    updateCombatUI();
    
    // Reset advantage after first round
    if (gameState.combatData.round === 1) {
        gameState.combatData.advantage = false;
    }
    
    gameState.combatData.round++;
    
    // Check combat end
    if (!checkCombatEnd()) {
        // Enemy attacks next round if combat continues
        setTimeout(() => {
            if (gameState.inCombat) {
                enemyAttack();
            }
        }, 1000);
    }
}

// Enemy attack
function enemyAttack() {
    if (!gameState.inCombat || !gameState.combatData) return;
    
    const enemy = gameState.combatData.enemy;
    const playerAttack = gameState.attack;
    
    // Enemy attacks
    const enemyRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + enemy.attack;
    const playerRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + playerAttack;
    
    let damage = 0;
    
    if (enemyRoll > playerRoll) {
        // Enemy hits
        if (!gameState.combatData.defending) {
            damage = enemy.damage;
            
            // Player defense reduces damage (including temporary boost)
            const totalDefense = gameState.defense + (gameState.combatData.defenseBoost || 0);
            damage = Math.max(1, damage - Math.floor(totalDefense / 2));
            
            gameState.health -= damage;
            addCombatLog(`The ${enemy.name} hits you for ${damage} damage!`, "enemy");
            
            // Show damage number
            showDamageNumber("YOU", damage, true);
        } else {
            addCombatLog(`You block the ${enemy.name}'s attack!`, "player");
            gameState.combatData.defending = false;
        }
    } else if (playerRoll > enemyRoll) {
        // Player parries
        addCombatLog(`You parry the ${enemy.name}'s attack!`, "player");
    } else {
        // Tie
        addCombatLog("You both hesitate, waiting for an opening!", "event");
    }
    
    // Play attack sound
    soundManager.playAttackSound(damage, false);
    
    // Update UI
    updateCombatUI();
    
    // Check combat end
    checkCombatEnd();
}

// Defend action
function defend() {
    if (!gameState.inCombat || !gameState.combatData) return;
    
    gameState.combatData.defending = true;
    addCombatLog("You take a defensive stance, ready to block the next attack.", "player");
    soundManager.play('click');
    
    // Enemy still gets to attack
    setTimeout(() => {
        if (gameState.inCombat) {
            enemyAttack();
        }
    }, 1000);
}

// Update combat UI
function updateCombatUI() {
    playerCombatHealth.textContent = gameState.health;
    enemyCombatHealth.textContent = gameState.combatData.enemyHealth;
    
    const playerHealthPercent = (gameState.health / 20) * 100;
    const enemyHealthPercent = (gameState.combatData.enemyHealth / gameState.combatData.enemyMaxHealth) * 100;
    
    playerHealthBar.style.width = `${playerHealthPercent}%`;
    enemyHealthBar.style.width = `${enemyHealthPercent}%`;
    
    playerHealthText.textContent = `${gameState.health}/20`;
    enemyHealthText.textContent = `${gameState.combatData.enemyHealth}/${gameState.combatData.enemyMaxHealth}`;
    
    updateStats();
}

// Show damage number
function showDamageNumber(target, damage, isPlayer) {
    const damageNumber = document.createElement('div');
    damageNumber.className = `damage-number ${isPlayer ? 'player' : 'enemy'}`;
    damageNumber.textContent = `-${damage}`;
    damageNumber.style.left = `${50 + (Math.random() * 20 - 10)}%`;
    damageNumber.style.top = `${30 + (Math.random() * 20)}%`;
    
    document.body.appendChild(damageNumber);
    
    setTimeout(() => {
        damageNumber.remove();
    }, 1000);
}

// Add combat log entry
function addCombatLog(message, type) {
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}-log`;
    entry.textContent = `[Round ${gameState.combatData.round}] ${message}`;
    combatLog.appendChild(entry);
    combatLog.scrollTop = combatLog.scrollHeight;
}

// Show combat items
function showCombatItems() {
    const itemsSection = document.createElement('div');
    itemsSection.innerHTML = `
        <div style="color: #d0a050; margin-bottom: 10px;">Select an item to use:</div>
    `;
    
    const combatItems = gameState.inventory.filter(invItem => {
        const item = items[invItem.name];
        return item && (item.usable && (item.healthRestore || item.spellDamage || item.defenseBonusTemp));
    });
    
    if (combatItems.length === 0) {
        itemsSection.innerHTML += `
            <div style="color: #666; padding: 10px; text-align: center;">
                No usable items in combat
            </div>
        `;
    } else {
        combatItems.forEach(invItem => {
            const button = document.createElement('button');
            button.className = 'combat-btn';
            button.style.margin = '5px';
            button.textContent = `${invItem.name} (${invItem.quantity})`;
            button.addEventListener('click', () => useItemInCombat(invItem.name));
            itemsSection.appendChild(button);
        });
    }
    
    const backButton = document.createElement('button');
    backButton.className = 'combat-btn';
    backButton.style.margin = '5px';
    backButton.textContent = 'Back';
    backButton.addEventListener('click', () => {
        combatLog.innerHTML = '';
        addCombatLog("You prepare your next move...", "event");
    });
    itemsSection.appendChild(backButton);
    
    combatLog.innerHTML = '';
    combatLog.appendChild(itemsSection);
}

// Use item in combat
function useItemInCombat(itemName) {
    const item = items[itemName];
    
    if (itemName === "Healing Herb" || itemName === "Greater Healing Potion" || itemName === "Scroll of Minor Healing") {
        const oldHealth = gameState.health;
        gameState.health = Math.min(20, gameState.health + (item.healthRestore || 0));
        const healed = gameState.health - oldHealth;
        
        removeItem(itemName);
        addCombatLog(`You use ${itemName}! (+${healed} health)`, "player");
        
        if (itemName === "Scroll of Minor Healing") {
            soundManager.play('spell_cast');
        } else {
            soundManager.play('heal');
        }
        
        // Enemy attacks while you use item
        setTimeout(() => {
            if (gameState.inCombat) {
                addCombatLog("The enemy attacks while you're distracted!", "event");
                enemyAttack();
            }
        }, 500);
        
    } else if (itemName === "Mana Potion") {
        const oldMana = gameState.mana;
        gameState.mana = Math.min(10, gameState.mana + 5);
        const restored = gameState.mana - oldMana;
        
        removeItem(itemName);
        addCombatLog(`You drink a mana potion! (+${restored} mana)`, "player");
        soundManager.play('heal');
        
        setTimeout(() => {
            if (gameState.inCombat) {
                enemyAttack();
            }
        }, 500);
        
    } else if (itemName === "Scroll of Firebolt") {
        const enemy = gameState.combatData.enemy;
        const damage = item.spellDamage || 6;
        
        gameState.combatData.enemyHealth -= damage;
        addCombatLog(`You cast Firebolt! The ${enemy.name} takes ${damage} damage!`, "player");
        showDamageNumber(enemy.name, damage, false);
        
        // Mark that we used a fire spell (for weaknesses)
        gameState.combatData.usedFireSpell = true;
        
        removeItem(itemName);
        soundManager.play('spell_cast');
        
        setTimeout(() => {
            if (gameState.inCombat) {
                enemyAttack();
            }
        }, 500);
        
    } else if (itemName === "Book of Warding") {
        gameState.combatData.defenseBoost = item.defenseBonusTemp || 3;
        addCombatLog(`You read from the Book of Warding! A magical barrier forms around you. (+${gameState.combatData.defenseBoost} defense)`, "player");
        
        removeItem(itemName);
        soundManager.play('spell_cast');
        
        setTimeout(() => {
            if (gameState.inCombat) {
                enemyAttack();
            }
        }, 500);
    }
    
    updateCombatUI();
    checkCombatEnd();
}

// Try to flee
function tryFlee() {
    const fleeChance = 0.4 + (gameState.defense / 20);
    if (Math.random() < fleeChance) {
        addCombatLog("You successfully flee from combat!", "player");
        endCombat(false);
        soundManager.play('victory');
        setTimeout(() => {
            combatPanel.classList.add('hidden');
        }, 1000);
    } else {
        addCombatLog("You fail to escape!", "event");
        enemyAttack();
        updateCombatUI();
        checkCombatEnd();
    }
}

// Check combat end
function checkCombatEnd() {
    if (gameState.health <= 0) {
        addCombatLog("You have been defeated!", "event");
        endCombat(false);
        soundManager.play('death');
        setTimeout(() => {
            combatPanel.classList.add('hidden');
            storyText.innerHTML += '<div class="death-message">DEFEATED IN COMBAT<br>GAME OVER</div>';
            choicesContainer.innerHTML = '';
        }, 1500);
        return true;
    }
    
    if (gameState.combatData.enemyHealth <= 0) {
        const enemy = gameState.combatData.enemy;
        addCombatLog(`You defeated the ${enemy.name}!`, "event");
        
        // Add gold
        if (enemy.gold > 0) {
            gameState.gold += enemy.gold;
            addCombatLog(`Found ${enemy.gold} gold!`, "event");
        }
        
        endCombat(true);
        soundManager.play('victory');
        
        setTimeout(() => {
            combatPanel.classList.add('hidden');
            loadSection(gameState.currentSection + 1);
            saveGameState(); // Auto-save after combat
        }, 2000);
        return true;
    }
    
    return false;
}

// End combat
function endCombat(victory) {
    gameState.inCombat = false;
    gameState.combatData = null;
}

// Save game
function saveGame() {
    if (saveGameState()) {
        showNotification("Game Saved", "Progress saved successfully.", "info");
        soundManager.play('click');
    } else {
        showNotification("Save Failed", "Could not save game.", "info");
    }
}

// Load game
function loadGame() {
    if (loadGameState()) {
        loadSection(gameState.currentSection);
        updateInventoryDisplay();
        updateStats();
        showNotification("Game Loaded", "Saved game loaded.", "info");
        soundManager.play('menu_open');
    } else {
        showNotification("No Save", "No saved game found.", "info");
    }
}

// Show hint
function showHint() {
    const hints = [
        "The library is a maze of knowledge. Some books contain more than just words.",
        "Silver weapons are particularly effective against spectral enemies.",
        "The Phantom Librarian might be convinced to help you if approached correctly.",
        "Fire spells work well against paper-based enemies like the Book Golem.",
        "Magical barriers can protect you from powerful attacks.",
        "Some doors require special keys or conditions to open.",
        "Ancient tomes often contain valuable secrets.",
        "Don't forget to use your items in combat when needed.",
        "The third stone tablet fragment is your goal in this level."
    ];
    const randomHint = hints[Math.floor(Math.random() * hints.length)];
    showNotification("Hint", randomHint, "info");
}

// Restart game
function restartGame() {
    if (confirm("Are you sure you want to restart Level 2? All progress for this level will be lost.")) {
        // Reset game state for this level only
        gameState.currentSection = 1;
        gameState.inCombat = false;
        gameState.inDialog = false;
        gameState.combatData = null;
        gameState.npcData = null;
        gameState.inventoryOpen = false;
        gameState.visitedSections = [];
        
        // NOTE: We keep inventory, stats, gold from previous level
        
        // Close panels
        combatPanel.classList.add('hidden');
        inventoryPanel.classList.add('hidden');
        levelComplete.classList.add('hidden');
        
        // Clear localStorage for this level only (but keep items/stats)
        // We'll save current state first, then modify and save again
        saveGameState();
        
        // Reload first section
        loadSection(1);
        updateInventoryDisplay();
        updateStats();
        
        showNotification("Level 2 Restarted", "Your climb continues anew.", "info");
        soundManager.play('menu_open');
    }
}

// Start the game
window.addEventListener('DOMContentLoaded', initGame);

// Auto-save when leaving the page
window.addEventListener('beforeunload', () => {
    saveGameState();
});
</script>
</body>
</html>
