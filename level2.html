<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fighting Fantasy: City of Shadows - Level 2</title>
    <style>
        /* Copy all the CSS styles from Level 1 here */
        /* To save space, I'll indicate where to copy the styles */
        /* [PASTE ALL CSS FROM LEVEL 1 HERE - START] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #0a0a0a;
            color: #e0e0c0;
            line-height: 1.4;
            padding: 0;
            overflow-x: hidden;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect fill="%23e0e0c0" width="100" height="100"/></svg>');
        }

        #game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        #main-menu {
            display: flex;
        }

        .active {
            display: flex !important;
        }

        .header {
            text-align: center;
            padding: 8px;
            border-bottom: 1px solid #e0e0c0;
            margin-bottom: 0;
            flex-shrink: 0;
            flex-grow: 0;
            background-color: #1a1a1a;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            min-height: 0;
            margin: 0;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            background-color: #0f0f0f;
        }

        .compact-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            justify-content: flex-start;
        }

        .footer {
            padding: 8px;
            border-top: 1px solid #e0e0c0;
            margin-top: 0;
            flex-shrink: 0;
            flex-grow: 0;
            background-color: #1a1a1a;
        }

        button {
            background-color: #1a1a1a;
            color: #e0e0c0;
            border: 1px solid #e0e0c0;
            padding: 12px 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 2px 0;
            cursor: pointer;
            width: 100%;
            min-height: 50px;
            flex-shrink: 0;
            transition: all 0.1s ease;
        }

        button:active {
            background-color: #3a3a1a;
            color: #ffffa0;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap;
            border: 1px solid #e0e0c0;
            padding: 8px;
            background-color: #1a1a1a;
        }

        .stat-box {
            text-align: center;
            padding: 5px;
            min-width: 80px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #ffffa0;
        }

        .battle-area {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .combatant {
            text-align: center;
            width: 48%;
            min-width: 150px;
            margin-bottom: 10px;
            border: 1px solid #e0e0c0;
            padding: 10px;
            background-color: #1a1a1a;
        }

        .combatant-ascii {
            font-size: 12px;
            line-height: 1;
            margin: 5px 0;
            white-space: pre;
        }

        .health-bar {
            width: 100%;
            height: 10px;
            background-color: #333;
            margin: 5px 0;
        }

        .health-fill {
            height: 100%;
            background-color: #a05050;
        }

        .story-text {
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .choice-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .choice-btn {
            text-align: left;
            padding: 12px;
            background-color: #1a1a1a;
            border: 1px solid #e0e0c0;
            color: #e0e0c0;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .choice-btn:active {
            background-color: #3a3a1a;
            color: #ffffa0;
        }

        .dice-roll {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border: 1px dashed #e0e0c0;
            background-color: #1a1a1a;
        }

        .dice-result {
            font-size: 24px;
            font-weight: bold;
            color: #ffffa0;
            margin: 5px 0;
        }

        .combat-log {
            height: 120px;
            overflow-y: auto;
            border: 1px solid #e0e0c0;
            padding: 8px;
            margin-top: 10px;
            font-size: 13px;
            flex-shrink: 0;
            background-color: #1a1a1a;
        }

        .inventory {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 5px;
            margin-top: 10px;
        }

        .item {
            width: 48%;
            margin-bottom: 5px;
            border: 1px solid #e0e0c0;
            padding: 8px;
            min-width: 140px;
            background-color: #1a1a1a;
        }

        .item-special {
            border-color: #ffffa0;
            background-color: #2a2a1a;
        }

        .item-equipped {
            border-color: #a0ffa0;
            background-color: #1a2a1a;
        }

        .luck-test {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ffffa0;
            background-color: #2a2a1a;
        }

        .luck-result {
            font-weight: bold;
            margin: 5px 0;
            color: #ffffa0;
        }

        .success {
            color: #a0ffa0;
        }

        .failure {
            color: #ffa0a0;
        }

        .scrollable-container {
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            -webkit-overflow-scrolling: touch;
            padding: 5px;
            display: flex;
            flex-direction: column;
        }

        .game-over {
            text-align: center;
            padding: 20px;
        }

        .game-over-message {
            font-size: 18px;
            margin: 15px 0;
            color: #ffffa0;
        }

        .victory-message {
            color: #a0ffa0;
        }

        .defeat-message {
            color: #ffa0a0;
        }

        /* Popup Notification Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup-box {
            background-color: #1a1a1a;
            border: 2px solid #e0e0c0;
            padding: 20px;
            max-width: 90%;
            width: 400px;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 20px rgba(255, 255, 160, 0.3);
        }

        .popup-title {
            color: #ffffa0;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px solid #e0e0c0;
            padding-bottom: 5px;
        }

        .popup-message {
            margin: 15px 0;
            line-height: 1.5;
        }

        .popup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .popup-btn {
            flex: 1;
            padding: 10px;
            min-height: auto;
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #ff5050;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .critical-hit {
            color: #ffffa0;
            font-weight: bold;
            animation: pulse 0.5s infinite;
        }

        .monster-name {
            color: #ffa0a0;
            font-weight: bold;
        }

        .market-item {
            border: 1px solid #e0e0c0;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .item-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            width: 100%;
        }

        .item-action-btn {
            flex: 1;
            padding: 6px;
            font-size: 12px;
        }

        @media (max-height: 700px) {
            .header {
                padding: 5px;
            }
            
            .header pre {
                font-size: 10px;
                line-height: 1;
            }
            
            .header h2 {
                font-size: 16px;
            }
            
            .content {
                padding: 8px;
            }
            
            button {
                padding: 10px 6px;
                min-height: 40px;
                font-size: 13px;
            }
            
            .footer {
                padding: 5px;
            }
            
            .popup-box {
                padding: 15px;
            }
        }

        @media (max-height: 500px) {
            .header pre {
                display: none;
            }
            
            .header {
                padding: 3px;
            }
            
            .content {
                padding: 5px;
            }
            
            button {
                padding: 8px 4px;
                min-height: 36px;
                font-size: 12px;
            }
        }
        /* [PASTE ALL CSS FROM LEVEL 1 HERE - END] */
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Main Menu Screen -->
        <div id="main-menu" class="screen active">
            <div class="header">
                <pre>
  _____ _    _ _____ _______ ______  _______ ______  
 |  ___| |  | |_   _|__   __|  ____|/ /_   _|  ____| 
 | |__ | |  | | | |    | |  | |__   ' /  | | | |__    
 |  __|| |  | | | |    | |  |  __|  <   | | |  __|   
 | |   | |__| |_| |_   | |  | |    . \ _| |_| |____  
 |_|    \____/|_____|  |_|  |_|    |\_|_____|______| 
                </pre>
                <h2>CITY OF SHADOWS - LEVEL 2</h2>
            </div>
            <div class="content">
                <div class="compact-list">
                    <button id="new-game">START NEW CAMPAIGN</button>
                    <button id="continue-game">CONTINUE CAMPAIGN</button>
                    <button id="select-level">SELECT LEVEL</button>
                    <button id="campaign-progress">CAMPAIGN PROGRESS</button>
                    <button id="rules-btn">HOW TO PLAY</button>
                    
                    <div class="stats" style="margin-top: 15px;">
                        <div class="stat-box">
                            <div>Current Level</div>
                            <div class="stat-value" id="menu-current-level">-</div>
                        </div>
                        <div class="stat-box">
                            <div>Character</div>
                            <div class="stat-value" id="menu-character-level">-</div>
                        </div>
                        <div class="stat-box">
                            <div>Gold</div>
                            <div class="stat-value" id="menu-gold">-</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #a0a0a0;">
                        A Fighting Fantasy Campaign Adventure
                    </div>
                </div>
            </div>
            <div class="footer">
                <p>Welcome back, hero. New horrors await in the City of Shadows...</p>
            </div>
        </div>

        <!-- Level Select Screen -->
        <div id="level-select-screen" class="screen">
            <div class="header">
                <h2>SELECT LEVEL</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <h3>Campaign Progress</h3>
                    <p>Choose a level to play. Levels are unlocked as you complete them.</p>
                    <div id="level-buttons" class="choice-list">
                        <!-- Level buttons will be generated here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-level-select">BACK TO MAIN MENU</button>
            </div>
        </div>

        <!-- Campaign Progress Screen -->
        <div id="progress-screen" class="screen">
            <div class="header">
                <h2>CAMPAIGN PROGRESS</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="progress-content">
                        <!-- Progress will be shown here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-progress">BACK TO MAIN MENU</button>
            </div>
        </div>

        <!-- Story Screen -->
        <div id="story-screen" class="screen">
            <div class="header">
                <h2 id="story-title">CITY OF SHADOWS</h2>
                <div class="stats" style="margin: 5px 0 0 0; padding: 4px; font-size: 12px;">
                    <div>Level: <span id="header-level">2</span></div>
                    <div>Skill: <span id="header-skill">0</span></div>
                    <div>Stamina: <span id="header-stamina">0</span>/<span id="header-max-stamina">0</span></div>
                    <div>Luck: <span id="header-luck">0</span></div>
                    <div>Gold: <span id="header-gold">0</span></div>
                </div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="story-text" id="story-text">
                        <!-- Story text will appear here -->
                    </div>
                    <div class="choice-list" id="choice-list">
                        <!-- Choice buttons will appear here -->
                    </div>
                    <div id="dice-roll-section" style="display: none;">
                        <div class="dice-roll">
                            <div>Rolling 2 dice...</div>
                            <div class="dice-result" id="dice-result">?</div>
                            <div id="dice-total"></div>
                        </div>
                        <button id="continue-after-roll">CONTINUE</button>
                    </div>
                    <div id="luck-test-section" style="display: none;">
                        <div class="luck-test">
                            <h3>Test Your Luck</h3>
                            <div>Roll 2 dice. If the total is less than or equal to your Luck, you are lucky!</div>
                            <div class="dice-result" id="luck-dice-result">?</div>
                            <div class="luck-result" id="luck-result"></div>
                            <div>Your Luck will decrease by 1 after this test.</div>
                        </div>
                        <button id="continue-after-luck">CONTINUE</button>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="inventory-btn">INVENTORY</button>
                <button id="market-btn">SUPPLIES</button>
                <button id="save-game">SAVE GAME</button>
            </div>
        </div>

        <!-- Combat Screen -->
        <div id="combat-screen" class="screen">
            <div class="header">
                <h2>COMBAT</h2>
                <div class="stats" style="margin: 5px 0 0 0; padding: 4px; font-size: 12px;">
                    <div>Level: <span id="combat-level">2</span></div>
                    <div>Skill: <span id="combat-skill">0</span></div>
                    <div>Stamina: <span id="combat-stamina">0</span>/<span id="combat-max-stamina">0</span></div>
                    <div>Luck: <span id="combat-luck">0</span></div>
                </div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="battle-area">
                        <div class="combatant">
                            <h3>YOU</h3>
                            <div class="combatant-ascii">
    /\
   /  \
  /    \
 /______\
   |  |
   |  |
  /    \
                            </div>
                            <div>Skill: <span id="player-combat-skill">0</span></div>
                            <div>Stamina: <span id="player-combat-stamina">0</span></div>
                            <div class="health-bar">
                                <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
                            </div>
                        </div>
                        <div class="combatant">
                            <h3 id="enemy-name">ENEMY</h3>
                            <div class="combatant-ascii" id="enemy-ascii">
     /\
    /**\
   /****\
  /______\
   |    |
   |    |
  /      \
                            </div>
                            <div>Skill: <span id="enemy-skill">0</span></div>
                            <div>Stamina: <span id="enemy-stamina">0</span></div>
                            <div class="health-bar">
                                <div class="health-fill" id="enemy-health-fill" style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="combat-log" id="combat-log">
                        <!-- Combat log will appear here -->
                    </div>
                    <div class="dice-roll" id="combat-dice-roll" style="display: none;">
                        <h4>Combat Round</h4>
                        <div>Your Attack Strength: <span id="player-attack">0</span></div>
                        <div>Enemy Attack Strength: <span id="enemy-attack">0</span></div>
                        <div id="combat-result"></div>
                    </div>
                    <button id="attack-btn" style="margin-top: 10px;">ATTACK</button>
                    <button id="use-luck-combat" style="display: none;">TEST YOUR LUCK</button>
                    <button id="flee-combat" style="background-color: #3a1a1a;">FLEE</button>
                    <button id="victory-continue" style="display: none; background-color: #1a3a1a;">CONTINUE YOUR QUEST</button>
                </div>
            </div>
        </div>

        <!-- Inventory Screen -->
        <div id="inventory-screen" class="screen">
            <div class="header">
                <h2>INVENTORY</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="stats">
                        <div class="stat-box">
                            <div>Level</div>
                            <div class="stat-value" id="inv-level">2</div>
                        </div>
                        <div class="stat-box">
                            <div>Skill</div>
                            <div class="stat-value" id="inv-skill">0</div>
                        </div>
                        <div class="stat-box">
                            <div>Stamina</div>
                            <div class="stat-value" id="inv-stamina">0</div>
                        </div>
                        <div class="stat-box">
                            <div>Luck</div>
                            <div class="stat-value" id="inv-luck">0</div>
                        </div>
                        <div class="stat-box">
                            <div>Gold</div>
                            <div class="stat-value" id="inv-gold">0</div>
                        </div>
                    </div>
                    
                    <h3>Provisions: <span id="provisions-count">0</span></h3>
                    <button id="eat-provision" style="margin-bottom: 10px;">EAT PROVISION (Restore 4 Stamina)</button>
                    
                    <h3>Equipped Items:</h3>
                    <div id="equipped-items">
                        <!-- Equipped items will appear here -->
                    </div>
                    
                    <h3>Backpack:</h3>
                    <div id="inventory-list">
                        <!-- Inventory items will appear here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-inventory">BACK TO STORY</button>
            </div>
        </div>

        <!-- Market Screen -->
        <div id="market-screen" class="screen">
            <div class="header">
                <h2>EXPEDITION SUPPLIES</h2>
                <div>Your Gold: <span id="market-gold">0</span></div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="market-items">
                        <!-- Market items will appear here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-market">BACK TO STORY</button>
            </div>
        </div>

        <!-- Rules Screen -->
        <div id="rules-screen" class="screen">
            <div class="header">
                <h2>HOW TO PLAY</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="story-text">
                        <h3>Fighting Fantasy Game System</h3>
                        <p>In this adventure, you control the action by making choices and rolling dice.</p>
                        
                        <h4>Your Attributes:</h4>
                        <ul style="margin-left: 20px; margin-bottom: 15px;">
                            <li><strong>SKILL</strong>: Your fighting ability. Determines how good you are in combat.</li>
                            <li><strong>STAMINA</strong>: Your health. If it reaches zero, you die.</li>
                            <li><strong>LUCK</strong>: Your good fortune. Test your Luck to change your fate.</li>
                        </ul>
                        
                        <h4>Combat:</h4>
                        <p>When you enter combat, you and your enemy roll 2 dice and add your Skill scores.</p>
                        <p>The higher score wins and inflicts 2 damage on the loser.</p>
                        <p>If scores are equal, you both miss.</p>
                        
                        <h4>Testing Your Luck:</h4>
                        <p>You may Test Your Luck in certain situations. Roll 2 dice:</p>
                        <ul style="margin-left: 20px;">
                            <li>If the total is LESS than or equal to your current Luck: You are Lucky!</li>
                            <li>If the total is GREATER than your current Luck: You are Unlucky!</li>
                        </ul>
                        <p>Each time you Test Your Luck, your Luck score decreases by 1.</p>
                        
                        <h4>Provisions:</h4>
                        <p>You begin with 10 Provisions. Each Provision restores 4 Stamina when eaten.</p>
                        <p>You can eat Provisions during your adventure (except during combat).</p>

                        <h4>Equipment:</h4>
                        <p>You can find and purchase weapons, armor, and magical items.</p>
                        <p>Weapons increase your Skill in combat.</p>
                        <p>Armor increases your maximum Stamina.</p>
                        <p>Magical items provide special abilities.</p>
                        
                        <h4>Campaign System:</h4>
                        <p>This is a 5-level campaign. Your character, inventory, and gold carry over between levels.</p>
                        <p>Complete each level to unlock the next one. Save your game frequently!</p>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-rules">BACK TO MAIN MENU</button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen">
            <div class="header">
                <h2>YOUR QUEST IS OVER</h2>
            </div>
            <div class="content">
                <div class="game-over">
                    <pre>
   _____                         ____
  / ____|                       / __ \
 | |  __  __ _ _ __ ___   ___  | |  | |_   _____ _ __
 | | |_ |/ _` | '_ ` _ \ / _ \ | |  | \ \ / / _ \ '__|
 | |__| | (_| | | | | | |  __/ | |__| |\ V /  __/ |
  \_____|\__,_|_| |_| |_|\___|  \____/  \_/ \___|_|
                    </pre>
                    <div class="game-over-message" id="game-over-message">
                        You have failed in your quest.
                    </div>
                    <div style="margin: 20px 0;">
                        <div>Level: <span id="game-over-level">2</span></div>
                        <div>Location: <span id="game-over-location">Unknown</span></div>
                        <div>Paragraph: <span id="game-over-paragraph">0</span></div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="restart-after-game-over">TRY AGAIN</button>
                <button id="next-level-btn" style="background-color: #1a3a1a; display: none;">NEXT LEVEL →</button>
                <button id="main-menu-after-game-over">MAIN MENU</button>
            </div>
        </div>

        <!-- Popup Notification Container -->
        <div id="popup-container" style="display: none;"></div>
    </div>

    <script>
    // ============== POPUP NOTIFICATION SYSTEM ==============
    const notificationSystem = {
        queue: [],
        isShowing: false,
        
        show: function(title, message, options = {}) {
            const notification = { title, message, options };
            this.queue.push(notification);
            this.processQueue();
        },
        
        processQueue: function() {
            if (this.isShowing || this.queue.length === 0) return;
            
            this.isShowing = true;
            const notification = this.queue.shift();
            this.displayPopup(notification);
        },
        
        displayPopup: function(notification) {
            const popupContainer = document.getElementById('popup-container');
            const popupId = 'popup-' + Date.now();
            
            const buttonsHTML = notification.options.buttons ? 
                notification.options.buttons.map(btn => 
                    `<button class="popup-btn" onclick="${btn.action}">${btn.text}</button>`
                ).join('') :
                '<button class="popup-btn" onclick="notificationSystem.closePopup(\'' + popupId + '\')">OK</button>';
            
            const popupHTML = `
                <div class="popup-overlay" id="${popupId}">
                    <div class="popup-box">
                        <h3 class="popup-title">${notification.title}</h3>
                        <div class="popup-message">${notification.message}</div>
                        <div class="popup-buttons">
                            ${buttonsHTML}
                        </div>
                    </div>
                </div>
            `;
            
            popupContainer.innerHTML += popupHTML;
            popupContainer.style.display = 'block';
            
            const popupElement = document.getElementById(popupId);
            popupElement.style.display = 'flex';
            
            // Auto-close if timeout is set
            if (notification.options.timeout) {
                setTimeout(() => {
                    this.closePopup(popupId);
                }, notification.options.timeout);
            }
        },
        
        closePopup: function(popupId) {
            const popupElement = document.getElementById(popupId);
            if (popupElement) {
                popupElement.style.display = 'none';
                popupElement.remove();
            }
            
            this.isShowing = false;
            
            // Check if there are more notifications
            if (this.queue.length > 0) {
                setTimeout(() => this.processQueue(), 300);
            } else {
                document.getElementById('popup-container').style.display = 'none';
            }
        },
        
        showReward: function(reward) {
            let message = "You received a reward:\n";
            if (reward.gold) message += `• ${reward.gold} Gold\n`;
            if (reward.stamina) message += `• ${reward.stamina} Stamina\n`;
            if (reward.skill) message += `• ${reward.skill} Skill\n`;
            if (reward.luck) message += `• ${reward.luck} Luck\n`;
            if (reward.inventory) {
                reward.inventory.forEach(item => {
                    message += `• ${item.name}\n`;
                });
            }
            this.show("Reward Received", message);
        },
        
        showCombatResult: function(result, damage) {
            this.show("Combat Result", `${result}\n${damage ? `You took ${damage} damage.` : ''}`);
        },
        
        showDiceRoll: function(result, total) {
            this.show("Dice Roll", `You rolled: ${result}\nTotal: ${total}`);
        },
        
        showLuckTest: function(result, isLucky) {
            this.show("Test Your Luck", `You rolled: ${result}\nResult: ${isLucky ? "LUCKY!" : "UNLUCKY!"}`);
        }
    };

    // ============== FIGHTING FANTASY GAME STATE ==============
    const gameState = {
        currentLevel: 2,  // Changed to Level 2
        completedLevels: [1, 2],  // Level 2 is now completed
        player: {
            baseSkill: 0,
            skill: 0,
            baseStamina: 0,
            stamina: 0,
            maxStamina: 0,
            baseLuck: 0,
            luck: 0,
            gold: 0,
            provisions: 0,
            inventory: [],
            equipped: {
                weapon: null,
                armor: null,
                accessory: null
            }
        },
        currentParagraph: 200,  // Starting paragraph for Level 2
        currentEnemy: null,
        combatRound: 0,
        currentCombatVictoryParagraph: null,
        lastLuckTest: null,
        marketItems: [
            {
                id: "shadow_cloak",
                name: "Shadow Cloak",
                type: "armor",
                cost: 45,
                staminaBonus: 10,
                description: "A cloak that blends with shadows. Increases maximum Stamina by 10."
            },
            {
                id: "silver_dagger",
                name: "Silver Dagger",
                type: "weapon",
                cost: 35,
                skillBonus: 2,
                description: "A silver-plated dagger. Increases Skill by 2."
            },
            {
                id: "truth_amulet",
                name: "Amulet of Truth",
                type: "accessory",
                cost: 40,
                luckBonus: 3,
                description: "An amulet that reveals lies. Increases Luck by 3."
            },
            {
                id: "healing_potion",
                name: "Healing Draught",
                type: "consumable",
                cost: 25,
                effect: "heal",
                value: 12,
                description: "Restores 12 Stamina when used."
            },
            {
                id: "smoke_bomb",
                name: "Smoke Bomb",
                type: "consumable",
                cost: 20,
                effect: "escape",
                value: 1,
                description: "Can be used to escape combat with certainty."
            },
            {
                id: "holy_symbol",
                name: "Blessed Symbol",
                type: "accessory",
                cost: 35,
                luckBonus: 2,
                description: "A symbol blessed against dark creatures. Increases Luck by 2."
            },
            {
                id: "provisions",
                name: "Provisions",
                type: "consumable",
                cost: 5,
                effect: "provision",
                value: 1,
                description: "A day's worth of food. Restores 4 Stamina when eaten."
            }
        ],
        story: {
            // ============ LEVEL 2: CITY OF SHADOWS ============
            200: {
                title: "The Shadowed City",
                text: "After your victory over the necromancer Malakar, you return home a hero. But your rest is short-lived. Rumors reach you of a city consumed by perpetual darkness - Karazhan, the City of Shadows. Its people whisper of a curse that has stolen their sunlight, and worse, the shadows themselves have come to life. The city's lord has offered a hefty reward for anyone who can break the curse. You gather your equipment and set out for the shrouded city. As you approach its gates, an unnatural darkness hangs over the walls, even at midday.",
                choices: [
                    { text: "Enter through the main gate", next: 201 },
                    { text: "Look for a hidden entrance", next: 202 },
                    { text: "Investigate the perimeter first", next: 203 }
                ]
            },
            201: {
                title: "Main Gate",
                text: "The massive iron gate stands partially open. Two guards in tattered uniforms stand watch, their eyes glowing with an eerie blue light. They don't move as you approach, but their heads turn to follow you.",
                choices: [
                    { text: "Greet the guards", next: 204 },
                    { text: "Walk past without acknowledging them", next: 205 },
                    { text: "Draw your weapon cautiously", next: 206 }
                ]
            },
            202: {
                title: "Seeking a Hidden Entrance",
                text: "You circle the city walls, looking for a way in that doesn't involve the main gate. In a neglected section of the wall, you find a drainage tunnel partially hidden by overgrown vines.",
                choices: [
                    { text: "Crawl through the tunnel", next: 207 },
                    { text: "Return to the main gate", next: 201 }
                ]
            },
            203: {
                title: "City Perimeter",
                text: "Walking around the city walls, you notice something strange - no birds sing nearby, and the trees seem to bend away from the city as if afraid. You find a campsite with recent signs of habitation. A journal lies by a cold fire pit.",
                choices: [
                    { text: "Read the journal", next: 208 },
                    { text: "Search the campsite", next: 209 },
                    { text: "Continue to the main gate", next: 201 }
                ]
            },
            204: {
                title: "Speaking with the Guards",
                text: "You approach the guards. 'Halt,' one says in a hollow voice. 'State your business in Karazhan.' Their eyes glow brighter as they await your response.",
                choices: [
                    { text: "Say you're here to break the curse", next: 210 },
                    { text: "Say you're a merchant", next: 211 },
                    { text: "Attack the guards", next: 212 }
                ]
            },
            205: {
                title: "Passing Through",
                text: "You walk past the guards without a word. They don't stop you, but you feel their glowing eyes watching your back. Inside the gate, the city streets are unnaturally dark, lit only by occasional magical lanterns.",
                choices: [
                    { text: "Head toward the marketplace", next: 213 },
                    { text: "Follow the main street", next: 214 },
                    { text: "Take a narrow alley", next: 215 }
                ]
            },
            206: {
                title: "Hostile Approach",
                text: "You draw your weapon as you approach. The guards immediately react, their bodies shifting into shadowy forms!",
                combat: {
                    enemy: "shadow_guards",
                    skill: 10,
                    stamina: 16,
                    ascii: `    
    .-.     .-.
   (   )   (   )
    | |     | |
   |   |   |   |
  |     | |     |
   \\___/   \\___/
    | |     | |
   /   \\   /   \\`,
                    victory: 216,
                    defeat: 500
                }
            },
            207: {
                title: "Drainage Tunnel",
                text: "The tunnel is dark and damp. You crawl through for what seems like an eternity before emerging in a cellar filled with empty wine barrels. You can hear voices from above.",
                choices: [
                    { text: "Climb the stairs to investigate", next: 217 },
                    { text: "Search the cellar first", next: 218 }
                ]
            },
            208: {
                title: "The Journal",
                text: "The journal belongs to a scholar named Elara. The last entry reads: 'The Shadow King has returned. He dwells in the highest tower of the castle, feeding on the city's light. I have discovered the ritual to banish him, but I need three components: a Mirror of Truth, a Tear of the Sun, and the Heart of a Brave Soul. I must enter the city...' The entry ends abruptly.",
                reward: {
                    inventory: [{
                        id: "elaras_journal",
                        name: "Elara's Journal",
                        type: "special",
                        description: "Contains clues about breaking the shadow curse."
                    }]
                },
                choices: [
                    { text: "Take the journal and continue", next: 201 }
                ]
            },
            209: {
                title: "Campsite Search",
                text: "You search the campsite and find a silver whistle, some provisions, and 15 gold coins hidden under a rock.",
                reward: {
                    gold: 15,
                    provisions: 2,
                    inventory: [{
                        id: "silver_whistle",
                        name: "Silver Whistle",
                        type: "special",
                        description: "A silver whistle that might summon something."
                    }]
                },
                choices: [
                    { text: "Take the items and continue", next: 201 }
                ]
            },
            210: {
                title: "Honest Answer",
                text: "The guards look at each other, then back at you. 'Many have tried. All have failed. But if you truly wish to try, you may enter. Beware the living shadows.' They step aside to let you pass.",
                choices: [
                    { text: "Enter the city", next: 205 }
                ]
            },
            211: {
                title: "Merchant's Lie",
                text: "'What goods do you trade?' one guard asks suspiciously. You need to think fast. Test your Luck to convince them.",
                testLuck: {
                    lucky: 219,
                    unlucky: 212
                }
            },
            212: {
                title: "Guard Combat",
                text: "The guards don't believe your story! They transform into shadowy creatures and attack!",
                combat: {
                    enemy: "shadow_guards",
                    skill: 9,
                    stamina: 14,
                    ascii: `    
    .-.     .-.
   (   )   (   )
    | |     | |
   |   |   |   |
  |     | |     |
   \\___/   \\___/
    | |     | |
   /   \\   /   \\`,
                    victory: 216,
                    defeat: 500
                }
            },
            213: {
                title: "Marketplace",
                text: "The marketplace should be bustling, but instead it's nearly empty. A few desperate-looking merchants sell strange goods by magical light. One calls out to you: 'You there! You look like someone who needs special equipment for shadow hunting!'",
                choices: [
                    { text: "Talk to the merchant", next: 220 },
                    { text: "Browse the other stalls", next: 221 },
                    { text: "Leave the marketplace", next: 214 }
                ]
            },
            214: {
                title: "Main Street",
                text: "The main street leads toward a castle looming in the distance. Buildings on either side show signs of decay. Shadows seem to move independently of their sources.",
                choices: [
                    { text: "Continue toward the castle", next: 222 },
                    { text: "Investigate a side street", next: 223 },
                    { text: "Knock on a door", next: 224 }
                ]
            },
            215: {
                title: "Narrow Alley",
                text: "The alley is dark and cramped. You hear skittering sounds from the shadows. Suddenly, the shadows around you seem to thicken and take shape!",
                combat: {
                    enemy: "shadow_creature",
                    skill: 11,
                    stamina: 18,
                    ascii: `    
    .-.
   (   )
    | |
   |   |
  |     |
   \\___/
    / \\
   /   \\`,
                    victory: 225,
                    defeat: 500
                }
            },
            216: {
                title: "Guards Defeated",
                text: "The shadow guards dissolve into mist. You find a glowing key where they fell.",
                reward: {
                    inventory: [{
                        id: "glowing_key",
                        name: "Glowing Key",
                        type: "special",
                        description: "A key that glows with faint light. Might unlock something important."
                    }]
                },
                choices: [
                    { text: "Enter the city", next: 205 }
                ]
            },
            217: {
                title: "Tavern Cellar",
                text: "You emerge into a dimly lit tavern. A few patrons huddle around tables, drinking quietly. A bartender polishes glasses with a rag. They all look up as you enter.",
                choices: [
                    { text: "Approach the bartender", next: 226 },
                    { text: "Talk to the patrons", next: 227 },
                    { text: "Leave quietly", next: 228 }
                ]
            },
            218: {
                title: "Searching the Cellar",
                text: "Among the barrels, you find one that's different - it has a holy symbol carved into it. Inside, you find a silvered sword and some gold.",
                reward: {
                    gold: 25,
                    inventory: [{
                        id: "silvered_sword",
                        name: "Silvered Sword",
                        type: "weapon",
                        skillBonus: 2,
                        description: "A sword coated with silver. Effective against shadow creatures."
                    }]
                },
                choices: [
                    { text: "Take the sword and go upstairs", next: 217 }
                ]
            },
            219: {
                title: "Convincing Lie",
                text: "You manage to convince the guards you're a merchant of 'specialized goods for shadow protection.' They seem satisfied and let you pass, though they watch you suspiciously.",
                choices: [
                    { text: "Enter the city", next: 205 }
                ]
            },
            220: {
                title: "Shadow Hunter Merchant",
                text: "The merchant shows you various items: 'I've got silver-tipped arrows, light crystals, shadow-repelling charms. But my best item is this - a Sunstone. It absorbs light during the day and releases it here. Only 50 gold.'",
                choices: [
                    { text: "Buy the Sunstone (50 gold)", cost: 50, next: 229 },
                    { text: "Buy Light Crystals (30 gold)", cost: 30, next: 230 },
                    { text: "Leave without buying", next: 213 }
                ]
            },
            221: {
                title: "Other Market Stalls",
                text: "You browse other stalls. One sells 'shadow-touched' herbs, another sells maps of the city (likely inaccurate), and a third sells protective charms.",
                choices: [
                    { text: "Buy a city map (10 gold)", cost: 10, next: 231 },
                    { text: "Buy a protective charm (20 gold)", cost: 20, next: 232 },
                    { text: "Return to the main merchant", next: 220 }
                ]
            },
            222: {
                title: "Approaching the Castle",
                text: "The castle gates are sealed shut. Two massive stone golems flank the entrance, their eyes glowing with the same blue light as the gate guards. They don't move as you approach.",
                choices: [
                    { text: "Try to open the gates", next: 233 },
                    { text: "Speak to the golems", next: 234 },
                    { text: "Look for another entrance", next: 235 }
                ]
            },
            223: {
                title: "Side Street",
                text: "The side street leads to a residential area. Most houses are boarded up, but one has a faint light in the window. You hear sobbing from inside.",
                choices: [
                    { text: "Knock on the door", next: 236 },
                    { text: "Peer through the window", next: 237 },
                    { text: "Continue walking", next: 214 }
                ]
            },
            224: {
                title: "Knocking on Doors",
                text: "You knock on a random door. After a long pause, it opens a crack. An elderly woman peers out. 'What do you want? Haven't you shadows caused enough trouble?'",
                choices: [
                    { text: "Ask about the curse", next: 238 },
                    { text: "Ask about the Shadow King", next: 239 },
                    { text: "Apologize and leave", next: 214 }
                ]
            },
            225: {
                title: "Alley Cleared",
                text: "The shadow creature dissipates. In the alley, you find a small pouch containing gemstones and a note that reads: 'Meet at the old clock tower at midnight.'",
                reward: {
                    gold: 40,
                    inventory: [{
                        id: "clock_tower_note",
                        name: "Mysterious Note",
                        type: "special",
                        description: "A note about a meeting at the clock tower."
                    }]
                },
                choices: [
                    { text: "Continue down the alley", next: 240 },
                    { text: "Return to the main street", next: 214 }
                ]
            },
            226: {
                title: "Bartender Conversation",
                text: "The bartender looks you over. 'You're not from here. What brings you to our cursed city?' he asks, pouring you a drink without asking.",
                choices: [
                    { text: "Say you're here to help", next: 241 },
                    { text: "Ask about the curse", next: 242 },
                    { text: "Drink the offered beverage", next: 243 }
                ]
            },
            227: {
                title: "Talking to Patrons",
                text: "The patrons are wary but eventually open up. One says: 'The Shadow King took our sunlight three months ago. Now his creatures roam at will. The only safe places are those lit by magic or faith.' Another adds: 'They say a scholar named Elara knew how to stop him, but she disappeared.'",
                choices: [
                    { text: "Ask where Elara lived", next: 244 },
                    { text: "Ask about the Shadow King's weakness", next: 245 },
                    { text: "Thank them and leave", next: 228 }
                ]
            },
            228: {
                title: "Leaving the Tavern",
                text: "You exit the tavern onto a side street. The perpetual darkness feels even heavier here.",
                choices: [
                    { text: "Head toward the castle", next: 222 },
                    { text: "Explore the residential area", next: 223 },
                    { text: "Find the marketplace", next: 213 }
                ]
            },
            229: {
                title: "Sunstone Purchased",
                text: "The Sunstone glows warmly in your hand, providing light in a 10-foot radius. The merchant grins: 'Good choice. That'll keep the minor shadows at bay. But beware the King's personal guards - they're not afraid of light.'",
                reward: {
                    inventory: [{
                        id: "sunstone",
                        name: "Sunstone",
                        type: "accessory",
                        luckBonus: 2,
                        description: "A stone that absorbs and emits sunlight. Provides light and increases Luck by 2."
                    }]
                },
                choices: [
                    { text: "Leave the marketplace", next: 214 }
                ]
            },
            230: {
                title: "Light Crystals Purchased",
                text: "The crystals glow with steady light. 'Throw these at shadows to weaken them,' the merchant advises.",
                reward: {
                    inventory: [{
                        id: "light_crystals",
                        name: "Light Crystals",
                        type: "consumable",
                        effect: "light",
                        value: 3,
                        description: "Can be thrown to damage shadow creatures."
                    }]
                },
                choices: [
                    { text: "Leave the marketplace", next: 214 }
                ]
            },
            231: {
                title: "City Map Purchased",
                text: "The map shows the city layout, though some areas are marked 'uncharted' or 'dangerous.' It does show the castle, marketplace, and several other landmarks.",
                reward: {
                    inventory: [{
                        id: "city_map",
                        name: "City Map",
                        type: "special",
                        description: "A map of Karazhan, though not entirely accurate."
                    }]
                },
                choices: [
                    { text: "Return to the main merchant", next: 220 }
                ]
            },
            232: {
                title: "Protective Charm Purchased",
                text: "The charm is a small silver disc engraved with protective runes. It feels warm to the touch.",
                reward: {
                    inventory: [{
                        id: "protective_charm",
                        name: "Protective Charm",
                        type: "accessory",
                        luckBonus: 1,
                        description: "A charm that offers protection against dark magic. Increases Luck by 1."
                    }]
                },
                choices: [
                    { text: "Return to the main merchant", next: 220 }
                ]
            },
            233: {
                title: "Castle Gates",
                text: "The gates are magically sealed. As you touch them, the stone golems come to life! 'None may enter without the King's permission!' they boom in unison.",
                combat: {
                    enemy: "stone_golems",
                    skill: 13,
                    stamina: 24,
                    ascii: `    
     ___     ___
    /   \\   /   \\
   |     | |     |
    \\___/   \\___/
     /|\\     /|\\
    / | \\   / | \\
   /  |  \\ /  |  \\
      |       |
     / \\     / \\
    /   \\   /   \\`,
                    victory: 246,
                    defeat: 500
                }
            },
            234: {
                title: "Speaking to Golems",
                text: "You address the golems: 'I seek audience with the Shadow King.' They respond as one: 'The King sees all in his domain. If he wished to see you, you would already be before him.'",
                choices: [
                    { text: "Ask how to gain audience", next: 247 },
                    { text: "Try to force your way in", next: 233 },
                    { text: "Leave and find another way", next: 235 }
                ]
            },
            235: {
                title: "Searching for Another Entrance",
                text: "You circle the castle walls. They're smooth and high, with no visible handholds. However, you notice a drainage outlet similar to the one you used to enter the city.",
                choices: [
                    { text: "Enter the drainage outlet", next: 248 },
                    { text: "Return to the front gates", next: 222 }
                ]
            },
            236: {
                title: "The Crying House",
                text: "The door opens to reveal a woman clutching a child. 'Please, help us,' she whispers. 'My husband went out three days ago and never returned. The shadows took him.'",
                choices: [
                    { text: "Offer to look for her husband", next: 249 },
                    { text: "Ask about the Shadow King", next: 250 },
                    { text: "Give her some gold and leave", cost: 10, next: 251 }
                ]
            },
            237: {
                title: "Peering Through the Window",
                text: "Through the window, you see a family huddled together. A shadowy form seems to be trying to get in through another window!",
                choices: [
                    { text: "Break in to help", next: 252 },
                    { text: "Knock on the door", next: 236 },
                    { text: "Leave them to their fate", next: 214 }
                ]
            },
            238: {
                title: "Old Woman's Tale",
                text: "The old woman sighs. 'It started three months ago. First the days grew shorter, then the sunlight stopped reaching us entirely. The Shadow King appeared in the castle, and his creatures followed. Now we live in perpetual night.'",
                choices: [
                    { text: "Ask how to defeat him", next: 253 },
                    { text: "Thank her and leave", next: 214 }
                ]
            },
            239: {
                title: "Shadow King Information",
                text: "'He came from nowhere,' the woman says. 'Some say he's a fallen star, others a demon from the depths. All I know is he feeds on light and fear. He can't be killed by normal means.'",
                choices: [
                    { text: "Ask about his weaknesses", next: 254 },
                    { text: "Thank her and leave", next: 214 }
                ]
            },
            240: {
                title: "Alley's End",
                text: "The alley ends at a wall with a ladder leading to a rooftop. From above, you have a good view of the city.",
                choices: [
                    { text: "Climb the ladder", next: 255 },
                    { text: "Return the way you came", next: 214 }
                ]
            },
            241: {
                title: "Offering Help",
                text: "The bartender laughs bitterly. 'Another hero, eh? We've had a dozen like you. None returned. But if you're determined... talk to Old Man Gerrick. He knows things. Lives near the clock tower.'",
                reward: {
                    inventory: [{
                        id: "gerrick_clue",
                        name: "Clue about Gerrick",
                        type: "special",
                        description: "Old Man Gerrick near the clock tower might have information."
                    }]
                },
                choices: [
                    { text: "Ask where exactly", next: 256 },
                    { text: "Thank him and leave", next: 228 }
                ]
            },
            242: {
                title: "Curse Details",
                text: "'It's not just darkness,' the bartender explains. 'The shadows are alive. They take people, especially at night. But it's always night here now. The city guard tried to fight at first, but they either joined the shadows or died.'",
                choices: [
                    { text: "Ask about resistance", next: 257 },
                    { text: "Change the subject", next: 226 }
                ]
            },
            243: {
                title: "Drinking",
                text: "The drink is surprisingly good. The bartender nods approvingly. 'On the house. We need all the bravery we can get in this city.' You feel refreshed.",
                reward: {
                    stamina: 4
                },
                choices: [
                    { text: "Continue talking", next: 226 }
                ]
            },
            244: {
                title: "Elara's Residence",
                text: "'She lived in the scholars' quarter,' a patron says. 'But her house was ransacked after she disappeared. The Shadow King's agents, probably.' Another adds: 'I heard she left something hidden in the library.'",
                reward: {
                    inventory: [{
                        id: "library_clue",
                        name: "Library Clue",
                        type: "special",
                        description: "Elara might have left something in the library."
                    }]
                },
                choices: [
                    { text: "Ask where the library is", next: 258 },
                    { text: "Thank them", next: 228 }
                ]
            },
            245: {
                title: "Shadow King's Weakness",
                text: "The patrons exchange looks. One leans in close: 'They say he can't stand true sunlight. But we haven't seen the sun in months. Some say pure silver hurts him. Others say you need a special ritual.'",
                choices: [
                    { text: "Ask about the ritual", next: 259 },
                    { text: "Thank them for the information", next: 228 }
                ]
            },
            246: {
                title: "Golems Defeated",
                text: "The stone golems crumble to rubble. The castle gates swing open silently. Beyond lies a courtyard filled with moving shadows.",
                choices: [
                    { text: "Enter the courtyard", next: 260 }
                ]
            },
            247: {
                title: "Gaining Audience",
                text: "The golems respond: 'The King grants audience to those who prove worthy. Complete three tasks: retrieve the Mirror of Truth from the Hall of Echoes, obtain the Tear of the Sun from the Garden of Memories, and bring the Heart of a Brave Soul.'",
                reward: {
                    inventory: [{
                        id: "tasks_list",
                        name: "List of Tasks",
                        type: "special",
                        description: "Three tasks to gain audience with the Shadow King."
                    }]
                },
                choices: [
                    { text: "Accept the tasks", next: 261 },
                    { text: "Refuse and attack", next: 233 },
                    { text: "Leave to think", next: 235 }
                ]
            },
            248: {
                title: "Castle Drainage",
                text: "The drainage tunnel leads into the castle's lower levels. It's even darker here, and the air is cold. You hear dripping water and... whispers.",
                choices: [
                    { text: "Follow the whispers", next: 262 },
                    { text: "Explore the lower levels", next: 263 }
                ]
            },
            249: {
                title: "Searching for the Husband",
                text: "The woman gives you a locket with her husband's picture. 'His name is Tomas. He was last seen near the clock tower.'",
                reward: {
                    inventory: [{
                        id: "tomas_locket",
                        name: "Tomas's Locket",
                        type: "special",
                        description: "A locket with a picture of Tomas. Might help identify him."
                    }]
                },
                choices: [
                    { text: "Head to the clock tower", next: 264 },
                    { text: "Search nearby first", next: 265 }
                ]
            },
            250: {
                title: "Family's Knowledge",
                text: "The woman shakes her head. 'We know nothing of kings or curses. We just want to live in peace. But if you're going to the castle... beware the Hall of Mirrors. They say it shows your deepest fears.'",
                reward: {
                    inventory: [{
                        id: "hall_of_mirrors_warning",
                        name: "Warning about Hall of Mirrors",
                        type: "special",
                        description: "The Hall of Mirrors in the castle shows your deepest fears."
                    }]
                },
                choices: [
                    { text: "Thank her and continue", next: 236 }
                ]
            },
            251: {
                title: "Generosity",
                text: "The woman takes the gold with tears in her eyes. 'Bless you. May the light find you.' You feel a strange warmth, as if briefly touched by sunlight.",
                reward: {
                    luck: 1
                },
                choices: [
                    { text: "Leave the house", next: 223 }
                ]
            },
            252: {
                title: "Rescuing the Family",
                text: "You burst through the window just as a shadow creature is squeezing inside!",
                combat: {
                    enemy: "shadow_creature",
                    skill: 10,
                    stamina: 15,
                    ascii: `    
    .-.
   (   )
    | |
   |   |
  |     |
   \\___/
    / \\
   /   \\`,
                    victory: 266,
                    defeat: 500
                }
            },
            253: {
                title: "Defeating the Shadow King",
                text: "'There are legends,' the old woman says. 'A ritual involving three artifacts: something that reflects truth, something that holds light, and something that represents courage. The scholar Elara was researching this before she vanished.'",
                reward: {
                    inventory: [{
                        id: "ritual_info",
                        name: "Ritual Information",
                        type: "special",
                        description: "Information about a ritual to defeat the Shadow King."
                    }]
                },
                choices: [
                    { text: "Thank her for the information", next: 214 }
                ]
            },
            254: {
                title: "Weaknesses Revealed",
                text: "'They say he's vulnerable to things that are pure and true,' the woman whispers. 'Pure silver, sunlight, honest emotions. But these are rare in a city of shadows.'",
                choices: [
                    { text: "Thank her and leave", next: 214 }
                ]
            },
            255: {
                title: "Rooftop View",
                text: "From the rooftop, you can see the entire city. The castle dominates the center. To the east, a building that might be a library. To the west, a clock tower. North shows a walled garden.",
                choices: [
                    { text: "Head to the library", next: 267 },
                    { text: "Go to the clock tower", next: 264 },
                    { text: "Investigate the walled garden", next: 268 },
                    { text: "Climb down", next: 240 }
                ]
            },
            256: {
                title: "Gerrick's Location",
                text: "'Last house before the clock tower,' the bartender says. 'But be careful. The shadows are thick there. And Gerrick... he's not quite right in the head anymore. The shadows did something to him.'",
                choices: [
                    { text: "Thank him for the warning", next: 228 }
                ]
            },
            257: {
                title: "Resistance Movement",
                text: "The bartender lowers his voice. 'There are still some of us fighting. We meet in secret. If you're serious about helping, go to the old mill at midnight. Knock three times, pause, then twice more.'",
                reward: {
                    inventory: [{
                        id: "resistance_clue",
                        name: "Resistance Meeting Clue",
                        type: "special",
                        description: "The resistance meets at the old mill at midnight."
                    }]
                },
                choices: [
                    { text: "Nod understanding", next: 228 }
                ]
            },
            258: {
                title: "Library Location",
                text: "'In the scholars' quarter, near the eastern wall. Big building with columns. Can't miss it.'",
                reward: {
                    inventory: [{
                        id: "library_location",
                        name: "Library Location",
                        type: "special",
                        description: "The library is in the scholars' quarter near the eastern wall."
                    }]
                },
                choices: [
                    { text: "Thank them", next: 228 }
                ]
            },
            259: {
                title: "The Ritual",
                text: "One patron glances around nervously. 'Elara said you need three things: a mirror that shows truth, a container for sunlight, and... a sacrifice. A willing sacrifice of someone brave.'",
                choices: [
                    { text: "Ask for details", next: 269 },
                    { text: "Thank them", next: 228 }
                ]
            },
            260: {
                title: "Castle Courtyard",
                text: "The courtyard is filled with statues that seem to watch you. Shadows move independently here, pooling and flowing like liquid. Ahead, the main keep doors stand open. To the left, a path leads to a garden. To the right, a building that might be a hall of some kind.",
                choices: [
                    { text: "Enter the main keep", next: 270 },
                    { text: "Go to the garden", next: 271 },
                    { text: "Enter the hall to the right", next: 272 }
                ]
            },
            261: {
                title: "Accepting the Tasks",
                text: "'So be it,' the golems say. 'Begin your quest. Return when you have all three items.' The gates remain sealed, but a side passage opens to the left.",
                choices: [
                    { text: "Take the side passage", next: 273 }
                ]
            },
            262: {
                title: "Following Whispers",
                text: "The whispers lead you to a chamber where ghostly figures move through the walls. One solidifies before you: a woman in scholar's robes.",
                choices: [
                    { text: "Speak to the ghost", next: 274 },
                    { text: "Attack the ghost", next: 275 },
                    { text: "Flee", next: 248 }
                ]
            },
            263: {
                title: "Exploring Lower Levels",
                text: "You find storage rooms, a dungeon, and a chamber with strange machinery. In one room, you discover a chest containing gold and a silver mirror.",
                reward: {
                    gold: 30,
                    inventory: [{
                        id: "silver_mirror",
                        name: "Silver Mirror",
                        type: "special",
                        description: "A silver mirror that might be the Mirror of Truth."
                    }]
                },
                choices: [
                    { text: "Continue exploring", next: 276 },
                    { text: "Return to the entrance", next: 248 }
                ]
            },
            264: {
                title: "Clock Tower",
                text: "The clock tower stands tall, its clock frozen at midnight. The door is ajar. Inside, you find a man muttering to himself as he sorts through papers.",
                choices: [
                    { text: "Ask if he's Old Man Gerrick", next: 277 },
                    { text: "Search the tower", next: 278 },
                    { text: "Leave quietly", next: 255 }
                ]
            },
            265: {
                title: "Searching Nearby",
                text: "You search the area around the crying woman's house. In an alley, you find signs of a struggle and a trail leading toward the clock tower.",
                choices: [
                    { text: "Follow the trail", next: 264 },
                    { text: "Return to the woman", next: 249 }
                ]
            },
            266: {
                title: "Family Rescued",
                text: "The shadow creature dissolves. The family thanks you profusely. 'We have nothing to give you but this,' the father says, handing you a family heirloom - a silver brooch.",
                reward: {
                    gold: 20,
                    inventory: [{
                        id: "silver_brooch",
                        name: "Silver Brooch",
                        type: "accessory",
                        luckBonus: 2,
                        description: "A family heirloom that brings good fortune. Increases Luck by 2."
                    }]
                },
                choices: [
                    { text: "Ask about Tomas", next: 279 },
                    { text: "Leave the house", next: 223 }
                ]
            },
            267: {
                title: "Library",
                text: "The library is a grand building, now dark and silent. Books lie scattered everywhere. Something moves in the shadows between the shelves.",
                choices: [
                    { text: "Search for Elara's research", next: 280 },
                    { text: "Investigate the movement", next: 281 },
                    { text: "Leave the library", next: 255 }
                ]
            },
            268: {
                title: "Walled Garden",
                text: "The garden walls are high, but the gate is unlocked. Inside, you find the most amazing sight: a single beam of sunlight piercing the perpetual darkness! It shines on a crystal flower in the center.",
                choices: [
                    { text: "Approach the flower", next: 282 },
                    { text: "Look for the source of sunlight", next: 283 },
                    { text: "Leave the garden", next: 255 }
                ]
            },
            269: {
                title: "Ritual Details",
                text: "'That's all I know,' the patron says. 'Elara was secretive. She said the ritual would be dangerous, possibly fatal for whoever performed it.'",
                choices: [
                    { text: "Thank them for the information", next: 228 }
                ]
            },
            270: {
                title: "Main Keep",
                text: "The great hall is empty except for a throne at the far end. Sitting on it is a figure made of shifting shadows. 'I have been expecting you,' a voice echoes through the hall.",
                choices: [
                    { text: "Approach the throne", next: 284 },
                    { text: "Demand he lift the curse", next: 285 },
                    { text: "Attack immediately", next: 286 }
                ]
            },
            271: {
                title: "Garden of Memories",
                text: "The garden is filled with statues of people in various poses of fear or despair. In the center, a fountain holds not water, but liquid light. This must be where the Tear of the Sun is kept.",
                choices: [
                    { text: "Take the liquid light", next: 287 },
                    { text: "Examine the statues", next: 288 },
                    { text: "Return to the courtyard", next: 260 }
                ]
            },
            272: {
                title: "Hall of Echoes",
                text: "The hall is filled with mirrors. Each shows a different reflection of you - sometimes heroic, sometimes cowardly, sometimes monstrous. In the center stands a mirror that shows only truth.",
                choices: [
                    { text: "Take the Mirror of Truth", next: 289 },
                    { text: "Look at your reflections", next: 290 },
                    { text: "Leave the hall", next: 260 }
                ]
            },
            273: {
                title: "Side Passage",
                text: "The passage leads out of the castle grounds and into the city. You're back on the streets, now with a quest to complete.",
                choices: [
                    { text: "Head to the library for information", next: 267 },
                    { text: "Search for the Mirror of Truth", next: 272 },
                    { text: "Look for the Tear of the Sun", next: 271 },
                    { text: "Find a Brave Soul", next: 291 }
                ]
            },
            274: {
                title: "Ghostly Scholar",
                text: "The ghost looks at you with sad eyes. 'I am Elara. The Shadow King caught me before I could complete the ritual. My physical form is gone, but my spirit remains trapped here.'",
                choices: [
                    { text: "Ask about the ritual", next: 292 },
                    { text: "Ask how to free her", next: 293 },
                    { text: "Ask about the three artifacts", next: 294 }
                ]
            },
            275: {
                title: "Attacking the Ghost",
                text: "Your weapon passes through the ghost harmlessly. It smiles sadly. 'Violence cannot harm what is already dead. Please, let us talk.'",
                choices: [
                    { text: "Listen to the ghost", next: 274 }
                ]
            },
            276: {
                title: "Deeper Exploration",
                text: "You find a laboratory with alchemical equipment. Notes on a table detail experiments with light and shadow. One note reads: 'The Shadow King's weakness: concentrated sunlight amplified through a prism.'",
                reward: {
                    inventory: [{
                        id: "shadow_king_weakness",
                        name: "Shadow King's Weakness",
                        type: "special",
                        description: "Notes on how to defeat the Shadow King."
                    }]
                },
                choices: [
                    { text: "Take the notes and continue", next: 295 },
                    { text: "Return to the entrance", next: 248 }
                ]
            },
            277: {
                title: "Old Man Gerrick",
                text: "The man looks up, his eyes wild. 'Gerrick? No, I'm Tomas. The shadows took Gerrick weeks ago. I've been hiding here, trying to understand... trying to find a way to save my family.'",
                choices: [
                    { text: "Give him the locket", next: 296 },
                    { text: "Ask what he's discovered", next: 297 },
                    { text: "Tell him his family is safe", next: 298 }
                ]
            },
            278: {
                title: "Searching the Tower",
                text: "You find notes about the city's history, star charts, and research on light magic. One journal entry catches your eye: 'The Shadow King is not a person but a manifestation of the city's collective fear. To defeat him, one must face their own deepest fears.'",
                reward: {
                    inventory: [{
                        id: "shadow_king_nature",
                        name: "Shadow King's Nature",
                        type: "special",
                        description: "Information about what the Shadow King truly is."
                    }]
                },
                choices: [
                    { text: "Take the notes", next: 299 },
                    { text: "Continue searching", next: 300 }
                ]
            },
            279: {
                title: "Asking About Tomas",
                text: "'Tomas? That's our neighbor!' the father exclaims. 'He was taken three days ago. The shadows dragged him toward the clock tower.'",
                choices: [
                    { text: "Head to the clock tower", next: 264 },
                    { text: "Leave to continue your quest", next: 223 }
                ]
            },
            280: {
                title: "Searching for Research",
                text: "You find Elara's study. Her notes are scattered, but you piece together the ritual: 'Combine Mirror of Truth (shows what is), Tear of the Sun (holds what was), and Heart of Brave Soul (creates what could be). The combination creates a light pure enough to banish the Shadow King.'",
                reward: {
                    inventory: [{
                        id: "complete_ritual",
                        name: "Complete Ritual Instructions",
                        type: "special",
                        description: "Full instructions for the banishment ritual."
                    }]
                },
                choices: [
                    { text: "Take the notes", next: 301 },
                    { text: "Continue searching", next: 302 }
                ]
            },
            281: {
                title: "Investigating Movement",
                text: "The movement was a shadow librarian - a creature made of darkness that seems to be organizing the books. It hasn't noticed you yet.",
                choices: [
                    { text: "Attack the shadow librarian", next: 303 },
                    { text: "Try to communicate", next: 304 },
                    { text: "Sneak past it", next: 280 }
                ]
            },
            282: {
                title: "Crystal Flower",
                text: "The flower is made of pure crystal and contains a single drop of liquid light - the Tear of the Sun! As you reach for it, shadowy tendrils rise from the ground to protect it.",
                combat: {
                    enemy: "garden_shadows",
                    skill: 12,
                    stamina: 20,
                    ascii: `    
    .-.     .-.     .-.
   (   )   (   )   (   )
    | |     | |     | |
   |   |   |   |   |   |
  |     | |     | |     |
   \\___/   \\___/   \\___/
    | |     | |     | |
   /   \\   /   \\   /   \\`,
                    victory: 305,
                    defeat: 500
                }
            },
            283: {
                title: "Source of Sunlight",
                text: "The sunlight comes from a small crack in the magical darkness above the garden. A prism on a pedestal focuses it onto the flower.",
                choices: [
                    { text: "Take the prism", next: 306 },
                    { text: "Return to the flower", next: 282 }
                ]
            },
            284: {
                title: "Approaching the Throne",
                text: "The shadowy figure on the throne solidifies into a handsome man in dark robes. 'Welcome, hero. I am Valerius, once lord of this city, now its prisoner as much as its master.'",
                choices: [
                    { text: "Ask what happened", next: 307 },
                    { text: "Demand he end the curse", next: 308 },
                    { text: "Ask about the ritual", next: 309 }
                ]
            },
            285: {
                title: "Making Demands",
                text: "The Shadow King laughs. 'You think I can simply lift the curse? I am the curse, and the curse is me. We are bound together. Only the ritual Elara discovered can free us all.'",
                choices: [
                    { text: "Ask about the ritual components", next: 310 },
                    { text: "Attack", next: 286 }
                ]
            },
            286: {
                title: "Attacking the Shadow King",
                text: "You charge the throne, but your weapon passes through the shadowy form. 'Foolish. You cannot harm me with mere steel. You need the ritual.'",
                choices: [
                    { text: "Ask about the ritual", next: 309 }
                ]
            },
            287: {
                title: "Taking the Tear",
                text: "As you reach for the liquid light, the statues in the garden come to life!",
                combat: {
                    enemy: "stone_statues",
                    skill: 11,
                    stamina: 18,
                    ascii: `    
     ___     ___
    /   \\   /   \\
   |     | |     |
    \\___/   \\___/
     /|\\     /|\\
    / | \\   / | \\
   /  |  \\ /  |  \\`,
                    victory: 311,
                    defeat: 500
                }
            },
            288: {
                title: "Examining Statues",
                text: "The statues are of former citizens, frozen in their moments of greatest fear. One statue holds a note: 'The Tear is protected by memory of fear. To take it, one must face fear without succumbing.'",
                choices: [
                    { text: "Face your fears and take the Tear", next: 312 },
                    { text: "Return to the courtyard", next: 260 }
                ]
            },
            289: {
                title: "Taking the Mirror",
                text: "As you take the Mirror of Truth, your reflection shows not your face, but your deepest fear. Can you face it? Test your Luck.",
                testLuck: {
                    lucky: 313,
                    unlucky: 314
                }
            },
            290: {
                title: "Looking at Reflections",
                text: "The mirrors show different versions of you: a coward running away, a hero standing tall, a monster causing destruction, a martyr sacrificing yourself. Which is the truth? All of them, the mirrors seem to whisper.",
                choices: [
                    { text: "Take the central mirror", next: 289 },
                    { text: "Leave the hall", next: 260 }
                ]
            },
            291: {
                title: "Finding a Brave Soul",
                text: "You need someone willing to sacrifice themselves for the city. Who could be that brave?",
                choices: [
                    { text: "Offer yourself", next: 315 },
                    { text: "Find Tomas", next: 264 },
                    { text: "Find another volunteer", next: 316 }
                ]
            },
            292: {
                title: "The Ritual Explained",
                text: "'The ritual requires three components,' Elara's ghost explains. 'The Mirror of Truth shows what must be faced. The Tear of the Sun provides the power. The Heart of a Brave Soul provides the will. Combined, they create a light that can banish the Shadow King.'",
                choices: [
                    { text: "Ask where to find them", next: 317 },
                    { text: "Ask about the sacrifice", next: 318 }
                ]
            },
            293: {
                title: "Freeing Elara",
                text: "'My spirit is bound to my research,' Elara says. 'If you complete the ritual and banish the Shadow King, I will be free to move on. Please, finish what I started.'",
                choices: [
                    { text: "Promise to complete the ritual", next: 319 },
                    { text: "Ask for more help", next: 292 }
                ]
            },
            294: {
                title: "Artifact Locations",
                text: "'The Mirror is in the Hall of Echoes in the castle. The Tear is in the Garden of Memories, also in the castle. The Heart... that is not an object but a person. Someone must willingly give their life for the city.'",
                choices: [
                    { text: "Ask who would do that", next: 320 },
                    { text: "Say you'll do it", next: 315 }
                ]
            },
            295: {
                title: "Laboratory Notes",
                text: "Further notes reveal: 'The Shadow King was once Lord Valerius, who tried to use shadow magic to protect his city from invaders. The magic consumed him and the city.'",
                reward: {
                    inventory: [{
                        id: "valerius_history",
                        name: "Valerius's History",
                        type: "special",
                        description: "The tragic history of how Lord Valerius became the Shadow King."
                    }]
                },
                choices: [
                    { text: "Take all the notes", next: 321 },
                    { text: "Leave the laboratory", next: 248 }
                ]
            },
            296: {
                title: "Reunion with Locket",
                text: "Tomas takes the locket with trembling hands. 'My wife... my child... they gave you this? Are they safe?' Tears stream down his face.",
                choices: [
                    { text: "Tell him they're safe but need him", next: 322 },
                    { text: "Ask him to be the Brave Soul", next: 323 }
                ]
            },
            297: {
                title: "Tomas's Discoveries",
                text: "'I've found Gerrick's research,' Tomas says. 'He believed the Shadow King could be reasoned with, that he doesn't want to be what he's become. There might be a way to save him rather than destroy him.'",
                reward: {
                    inventory: [{
                        id: "alternative_solution",
                        name: "Alternative Solution",
                        type: "special",
                        description: "Gerrick's research suggests the Shadow King can be saved."
                    }]
                },
                choices: [
                    { text: "Ask for details", next: 324 },
                    { text: "Tell him about the ritual", next: 325 }
                ]
            },
            298: {
                title: "Good News",
                text: "Tomas's face lights up. 'They're safe? Thank the... well, there are no gods here to thank. But thank you. I must go to them!'",
                choices: [
                    { text: "Offer to escort him", next: 326 },
                    { text: "Warn him it's dangerous", next: 327 }
                ]
            },
            299: {
                title: "Important Discovery",
                text: "Another note adds: 'The Brave Soul doesn't necessarily have to die. They must be willing to die, but if the ritual is performed correctly, their sacrifice might be metaphorical rather than literal.'",
                reward: {
                    inventory: [{
                        id: "non_lethal_sacrifice",
                        name: "Non-Lethal Sacrifice",
                        type: "special",
                        description: "The Brave Soul's sacrifice might not require death."
                    }]
                },
                choices: [
                    { text: "Take this note too", next: 328 },
                    { text: "Continue searching", next: 300 }
                ]
            },
            300: {
                title: "More Searching",
                text: "You find a hidden compartment containing a silver amulet and some gold.",
                reward: {
                    gold: 25,
                    inventory: [{
                        id: "silver_amulet",
                        name: "Silver Amulet",
                        type: "accessory",
                        luckBonus: 2,
                        description: "An amulet that provides protection against shadow magic."
                    }]
                },
                choices: [
                    { text: "Take the items and leave", next: 264 }
                ]
            },
            301: {
                title: "Ritual Notes Taken",
                text: "You now have complete instructions for the ritual. You need to gather the three components and perform it at the highest point in the city at midnight.",
                choices: [
                    { text: "Leave the library", next: 255 }
                ]
            },
            302: {
                title: "Further Search",
                text: "You find Elara's personal journal. The last entry reads: 'I have discovered the truth. Valerius is not evil, just lost. The ritual can save him as well as the city. But someone must be willing to reach out to the man within the monster.'",
                reward: {
                    inventory: [{
                        id: "elaras_final_thoughts",
                        name: "Elara's Final Thoughts",
                        type: "special",
                        description: "Elara believed the Shadow King could be saved."
                    }]
                },
                choices: [
                    { text: "Take the journal", next: 329 },
                    { text: "Leave it", next: 301 }
                ]
            },
            303: {
                title: "Shadow Librarian Combat",
                text: "The shadow librarian turns toward you, its form shifting into something menacing.",
                combat: {
                    enemy: "shadow_librarian",
                    skill: 13,
                    stamina: 22,
                    ascii: `    
     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\
    |  |
    |  |
   /    \\`,
                    victory: 330,
                    defeat: 500
                }
            },
            304: {
                title: "Attempting Communication",
                text: "You try to communicate with the shadow librarian. It cocks its head, then gestures toward a specific bookshelf before returning to its work.",
                choices: [
                    { text: "Check the indicated shelf", next: 331 },
                    { text: "Attack anyway", next: 303 }
                ]
            },
            305: {
                title: "Garden Shadows Defeated",
                text: "The shadow tendrils dissolve. You take the Tear of the Sun - a crystal vial containing liquid light.",
                reward: {
                    inventory: [{
                        id: "tear_of_sun",
                        name: "Tear of the Sun",
                        type: "special",
                        description: "A vial containing pure liquid sunlight. One of three ritual components."
                    }]
                },
                choices: [
                    { text: "Take the prism as well", next: 306 },
                    { text: "Leave the garden", next: 255 }
                ]
            },
            306: {
                title: "Taking the Prism",
                text: "The prism is beautifully cut and seems to amplify light. It might be useful.",
                reward: {
                    inventory: [{
                        id: "sun_prism",
                        name: "Sun Prism",
                        type: "special",
                        description: "A prism that amplifies sunlight. Could be useful against shadows."
                    }]
                },
                choices: [
                    { text: "Return to the flower", next: 282 }
                ]
            },
            307: {
                title: "Valerius's Story",
                text: "'Our city was under siege,' Valerius explains. 'I turned to ancient shadow magic to protect us. It worked too well. The shadows consumed me and the city. Now I sustain this darkness just by existing.'",
                choices: [
                    { text: "Ask if he wants to be free", next: 332 },
                    { text: "Ask about the ritual", next: 309 }
                ]
            },
            308: {
                title: "Ending the Curse",
                text: "'I cannot end it,' Valerius says sadly. 'But you can. Perform the ritual Elara discovered. It will require sacrifice, but it can free us all.'",
                choices: [
                    { text: "Ask what sacrifice", next: 333 },
                    { text: "Say you'll do it", next: 334 }
                ]
            },
            309: {
                title: "Ritual Discussion",
                text: "'The ritual requires three things,' Valerius says. 'Truth, Light, and Courage. Bring them here at midnight, and we can end this together.'",
                choices: [
                    { text: "Ask where to find them", next: 310 },
                    { text: "Say you'll gather them", next: 335 }
                ]
            },
            310: {
                title: "Component Locations",
                text: "'The Mirror of Truth is in the Hall of Echoes. The Tear of the Sun is in the Garden of Memories. The Heart of a Brave Soul... that you must find among the people of this city. Or within yourself.'",
                choices: [
                    { text: "Say you'll be the Brave Soul", next: 315 },
                    { text: "Say you'll find someone else", next: 336 }
                ]
            },
            311: {
                title: "Statues Defeated",
                text: "The statues return to their inert state. You take the Tear of the Sun from the fountain.",
                reward: {
                    inventory: [{
                        id: "tear_of_sun",
                        name: "Tear of the Sun",
                        type: "special",
                        description: "A vial containing pure liquid sunlight. One of three ritual components."
                    }]
                },
                choices: [
                    { text: "Return to the courtyard", next: 260 }
                ]
            },
            312: {
                title: "Facing Fear",
                text: "You confront your deepest fear as shown by the statues. It's difficult, but you persevere. The Tear of the Sun floats freely to your hand.",
                reward: {
                    inventory: [{
                        id: "tear_of_sun",
                        name: "Tear of the Sun",
                        type: "special",
                        description: "A vial containing pure liquid sunlight. One of three ritual components."
                    }],
                    luck: 2
                },
                choices: [
                    { text: "Return to the courtyard", next: 260 }
                ]
            },
            313: {
                title: "Lucky Reflection",
                text: "You face your fear in the mirror and overcome it. The Mirror of Truth comes free in your hands.",
                reward: {
                    inventory: [{
                        id: "mirror_of_truth",
                        name: "Mirror of Truth",
                        type: "special",
                        description: "A mirror that shows truth. One of three ritual components."
                    }],
                    skill: 1
                },
                choices: [
                    { text: "Leave the hall", next: 260 }
                ]
            },
            314: {
                title: "Unlucky Reflection",
                text: "Your reflection frightens you, and you look away. The mirror remains stuck. You'll need to try again with more courage.",
                damage: 2,
                choices: [
                    { text: "Try again", next: 289 },
                    { text: "Leave and return later", next: 260 }
                ]
            },
            315: {
                title: "Offering Yourself",
                text: "You declare yourself willing to be the Brave Soul. Valerius looks at you with something like respect. 'Your courage is noted. But know this: the ritual may require your life.'",
                choices: [
                    { text: "Accept the risk", next: 337 },
                    { text: "Ask if there's another way", next: 338 }
                ]
            },
            316: {
                title: "Finding Another Volunteer",
                text: "Who would be willing to sacrifice themselves? Perhaps Tomas, to save his family? Or maybe there's another way...",
                choices: [
                    { text: "Go talk to Tomas", next: 264 },
                    { text: "Ask the resistance", next: 339 },
                    { text: "Return to Valerius", next: 284 }
                ]
            },
            317: {
                title: "Elara's Directions",
                text: "'The Mirror is in the castle's Hall of Echoes. The Tear is in the Garden of Memories. The Heart... that is the hardest. Someone must be willing to give everything for the city's salvation.'",
                choices: [
                    { text: "Say you'll do it", next: 315 },
                    { text: "Ask who might volunteer", next: 340 }
                ]
            },
            318: {
                title: "The Sacrifice",
                text: "'The Brave Soul must be willing to die,' Elara says. 'But my research suggests the sacrifice might be metaphorical. If the person is truly willing to die, they might not have to. The magic takes the willingness, not necessarily the life.'",
                choices: [
                    { text: "Ask how that works", next: 341 },
                    { text: "Say you understand", next: 292 }
                ]
            },
            319: {
                title: "Making the Promise",
                text: "'Thank you,' Elara's ghost says. 'I will help as much as I can from here. Remember: Valerius is not your enemy. The shadow magic is. Free him if you can.'",
                reward: {
                    luck: 2
                },
                choices: [
                    { text: "Leave to gather components", next: 248 }
                ]
            },
            320: {
                title: "Finding a Volunteer",
                text: "'I don't know,' Elara admits. 'But there are still good people in this city. Perhaps Tomas, who hides in the clock tower. Or maybe... you.'",
                choices: [
                    { text: "Say you'll consider it", next: 294 },
                    { text: "Go find Tomas", next: 264 }
                ]
            },
            321: {
                title: "Complete Notes",
                text: "You now have a complete understanding of what happened to Valerius and how he became the Shadow King.",
                choices: [
                    { text: "Leave the laboratory", next: 248 }
                ]
            },
            322: {
                title: "Family Needs",
                text: "'They need you,' you tell Tomas. 'But the city needs you too. There's a way to end the curse, but it requires a Brave Soul.'",
                choices: [
                    { text: "Ask him to be the Brave Soul", next: 323 },
                    { text: "Tell him to go to his family", next: 342 }
                ]
            },
            323: {
                title: "Asking Tomas",
                text: "Tomas considers. 'For my family... for all the families... yes. I'll do it. What must I do?'",
                choices: [
                    { text: "Explain the ritual", next: 343 },
                    { text: "Take him to the castle", next: 344 }
                ]
            },
            324: {
                title: "Gerrick's Theory",
                text: "'Gerrick believed the Shadow King could be separated from Valerius,' Tomas explains. 'The ritual doesn't have to destroy Valerius, just the shadow magic controlling him.'",
                reward: {
                    inventory: [{
                        id: "separation_ritual",
                        name: "Separation Ritual Theory",
                        type: "special",
                        description: "A theory about separating Valerius from the shadow magic."
                    }]
                },
                choices: [
                    { text: "Ask how", next: 345 },
                    { text: "Take him to meet Valerius", next: 346 }
                ]
            },
            325: {
                title: "Explaining the Ritual",
                text: "You explain what you know about the ritual. Tomas listens intently. 'So we need three things, and one of them is a person willing to die?'",
                choices: [
                    { text: "Yes", next: 347 },
                    { text: "Maybe not die, but be willing to", next: 348 }
                ]
            },
            326: {
                title: "Escorting Tomas",
                text: "You escort Tomas back to his family. The reunion is tearful and joyful. 'Now,' Tomas says, turning to you. 'How can I help save our city?'",
                choices: [
                    { text: "Ask him to be the Brave Soul", next: 349 },
                    { text: "Ask for his help gathering components", next: 350 }
                ]
            },
            327: {
                title: "Warning Tomas",
                text: "'It's dangerous out there,' you warn. 'Shadows are everywhere.' Tomas nods. 'I know. But I have to try. Will you help me get to them?'",
                choices: [
                    { text: "Offer to escort him", next: 326 },
                    { text: "Give him a weapon", next: 351 }
                ]
            },
            328: {
                title: "Non-Lethal Possibility",
                text: "This changes everything! The Brave Soul might not have to die after all.",
                choices: [
                    { text: "Take this information to Tomas", next: 264 },
                    { text: "Take it to Valerius", next: 284 }
                ]
            },
            329: {
                title: "Elara's Journal",
                text: "The journal provides crucial insight: the ritual can save Valerius, not destroy him.",
                choices: [
                    { text: "Leave the library", next: 255 }
                ]
            },
            330: {
                title: "Librarian Defeated",
                text: "The shadow librarian dissolves. Where it stood, you find a key and some interesting books.",
                reward: {
                    gold: 20,
                    inventory: [
                        {
                            id: "library_key",
                            name: "Library Key",
                            type: "special",
                            description: "A key that might unlock something in the library."
                        },
                        {
                            id: "book_of_light_magic",
                            name: "Book of Light Magic",
                            type: "special",
                            description: "A book containing spells of light."
                        }
                    ]
                },
                choices: [
                    { text: "Search Elara's study", next: 280 }
                ]
            },
            331: {
                title: "Indicated Shelf",
                text: "The shelf contains books on light magic and shadow banishment. One book in particular - 'Rituals of Purification' - seems important.",
                reward: {
                    inventory: [{
                        id: "rituals_of_purification",
                        name: "Rituals of Purification",
                        type: "special",
                        description: "A book detailing purification rituals against dark magic."
                    }]
                },
                choices: [
                    { text: "Take the book and search Elara's study", next: 280 }
                ]
            },
            332: {
                title: "Desire for Freedom",
                text: "'More than anything,' Valerius says earnestly. 'I never meant for this to happen. I wanted to protect my people, not doom them.'",
                choices: [
                    { text: "Say you'll help free him", next: 352 },
                    { text: "Ask how", next: 309 }
                ]
            },
            333: {
                title: "The Sacrifice Explained",
                text: "'Someone must be willing to give their life,' Valerius explains. 'Their courage provides the power to break the shadow magic's hold. I would do it myself, but I am the source. My sacrifice would only make the shadows stronger.'",
                choices: [
                    { text: "Say you'll be the sacrifice", next: 315 },
                    { text: "Say you'll find someone", next: 336 }
                ]
            },
            334: {
                title: "Accepting the Quest",
                text: "'Thank you,' Valerius says. 'Gather the components and return here at midnight. I will prepare for the ritual.'",
                choices: [
                    { text: "Leave to gather components", next: 260 }
                ]
            },
            335: {
                title: "Beginning the Gathering",
                text: "You now know what you need. Time to gather the components.",
                choices: [
                    { text: "Go to the Hall of Echoes", next: 272 },
                    { text: "Go to the Garden of Memories", next: 271 },
                    { text: "Find a Brave Soul", next: 291 }
                ]
            },
            336: {
                title: "Finding a Brave Soul",
                text: "You'll need to find someone willing to sacrifice themselves for the city.",
                choices: [
                    { text: "Go to the clock tower to find Tomas", next: 264 },
                    { text: "Check the resistance", next: 339 },
                    { text: "Look for other volunteers", next: 353 }
                ]
            },
            337: {
                title: "Accepting the Risk",
                text: "'Very well,' Valerius says. 'You are truly brave. Gather the other components and return at midnight. We will perform the ritual together.'",
                reward: {
                    skill: 2,
                    luck: 2
                },
                choices: [
                    { text: "Leave to gather components", next: 260 }
                ]
            },
            338: {
                title: "Seeking Alternatives",
                text: "'Perhaps,' Valerius says. 'Elara believed the sacrifice might be symbolic if the courage is true enough. But we won't know until we try.'",
                choices: [
                    { text: "Say you'll take the chance", next: 337 },
                    { text: "Say you need to think", next: 284 }
                ]
            },
            339: {
                title: "Asking the Resistance",
                text: "You go to the old mill at midnight and give the knock signal. The door opens to reveal a group of determined-looking citizens.",
                choices: [
                    { text: "Explain the situation", next: 354 },
                    { text: "Ask for a volunteer", next: 355 }
                ]
            },
            340: {
                title: "Potential Volunteers",
                text: "'Tomas in the clock tower might,' Elara says. 'Or members of the resistance. But the ritual works best if the volunteer comes forward willingly, not out of guilt or pressure.'",
                choices: [
                    { text: "Say you'll volunteer", next: 315 },
                    { text: "Go talk to Tomas", next: 264 }
                ]
            },
            341: {
                title: "Metaphorical Sacrifice",
                text: "'Magic often works on intention,' Elara explains. 'If someone is truly willing to die for the city, that intention has power. The magic might accept that intention without taking the life.'",
                choices: [
                    { text: "That makes sense", next: 318 },
                    { text: "It sounds risky", next: 356 }
                ]
            },
            342: {
                title: "Sending Tomas Home",
                text: "Tomas thanks you and hurries home. You'll need to find another Brave Soul.",
                choices: [
                    { text: "Return to the castle", next: 284 },
                    { text: "Look for another volunteer", next: 353 }
                ]
            },
            343: {
                title: "Explaining to Tomas",
                text: "You explain the ritual. Tomas listens carefully. 'So I might die, but the city will be saved? For my family... I'll do it.'",
                choices: [
                    { text: "Take him to the castle", next: 344 },
                    { text: "Tell him there might be another way", next: 357 }
                ]
            },
            344: {
                title: "Bringing Tomas to the Castle",
                text: "You bring Tomas to the castle courtyard. Valerius awaits.",
                choices: [
                    { text: "Introduce Tomas as the Brave Soul", next: 358 },
                    { text: "Ask Valerius to explain", next: 359 }
                ]
            },
            345: {
                title: "Separation Method",
                text: "'According to Gerrick's notes,' Tomas says, 'the ritual can be modified. Instead of using the Brave Soul's sacrifice to destroy the shadows, use it to separate Valerius from them. Then the shadows can be banished without killing Valerius.'",
                reward: {
                    inventory: [{
                        id: "modified_ritual",
                        name: "Modified Ritual",
                        type: "special",
                        description: "Instructions for modifying the ritual to save Valerius."
                    }]
                },
                choices: [
                    { text: "Take these notes to Valerius", next: 346 }
                ]
            },
            346: {
                title: "Meeting with Valerius",
                text: "You bring Tomas to meet Valerius with Gerrick's theory.",
                choices: [
                    { text: "Present the theory", next: 360 },
                    { text: "Let Tomas explain", next: 361 }
                ]
            },
            347: {
                title: "Confirming the Risk",
                text: "Tomas takes a deep breath. 'Then that's what I'll do. My family will be safe, and the city will be free. It's worth it.'",
                choices: [
                    { text: "Take him to the castle", next: 344 }
                ]
            },
            348: {
                title: "Clarifying the Risk",
                text: "'You need to be willing to die,' you explain. 'But you might not actually die. The magic takes the willingness as the sacrifice.' Tomas considers this. 'I'm willing. Let's do it.'",
                choices: [
                    { text: "Take him to the castle", next: 344 }
                ]
            },
            349: {
                title: "Asking Reunited Tomas",
                text: "Now that Tomas is reunited with his family, will he still be willing? He looks at his wife and child, then back at you. 'Yes. To ensure they have a future, I'll do it.'",
                choices: [
                    { text: "Take him to the castle", next: 344 }
                ]
            },
            350: {
                title: "Gathering Help",
                text: "Tomas agrees to help you gather the Mirror and Tear. With his knowledge of the city, it should be easier.",
                reward: {
                    skill: 1  // Having a companion helps
                },
                choices: [
                    { text: "Go to the castle together", next: 222 }
                ]
            },
            351: {
                title: "Arming Tomas",
                text: "You give Tomas a weapon. 'Thank you,' he says. 'I'll be careful. And... thank you for telling me about my family.'",
                choices: [
                    { text: "Wish him luck", next: 264 }
                ]
            },
            352: {
                title: "Promise to Help",
                text: "'I will free you,' you promise. Valerius looks hopeful for the first time. 'Thank you. Gather what you need and return at midnight.'",
                choices: [
                    { text: "Leave to gather components", next: 260 }
                ]
            },
            353: {
                title: "Searching for Volunteers",
                text: "You search the city for someone willing to be the Brave Soul.",
                choices: [
                    { text: "Check the tavern", next: 226 },
                    { text: "Ask around the marketplace", next: 213 },
                    { text: "Return to the castle", next: 284 }
                ]
            },
            354: {
                title: "Explaining to Resistance",
                text: "You explain the ritual and the need for a Brave Soul. The resistance members exchange glances.",
                choices: [
                    { text: "Ask for a volunteer", next: 362 },
                    { text: "Say you'll do it yourself", next: 363 }
                ]
            },
            355: {
                title: "Direct Request",
                text: "'We need someone willing to sacrifice themselves for the city,' you say directly. Several people look down, but one steps forward.",
                choices: [
                    { text: "Talk to the volunteer", next: 364 }
                ]
            },
            356: {
                title: "Risk Acknowledgment",
                text: "'It is risky,' Elara admits. 'But all magic is. Have faith in the purity of your intention.'",
                choices: [
                    { text: "Say you'll try", next: 341 }
                ]
            },
            357: {
                title: "Offering Hope",
                text: "You tell Tomas about the possibility that he might not have to die. He looks relieved. 'Even better. Let's do it.'",
                choices: [
                    { text: "Take him to the castle", next: 344 }
                ]
            },
            358: {
                title: "Presenting Tomas",
                text: "Valerius looks at Tomas. 'You are willing to be the Heart?' Tomas nods. 'For my city and my family.'",
                choices: [
                    { text: "Begin the ritual", next: 365 },
                    { text: "Gather the other components first", next: 366 }
                ]
            },
            359: {
                title: "Valerius Explains",
                text: "Valerius explains the ritual to Tomas, who listens intently. 'I understand,' Tomas says. 'I'm ready.'",
                choices: [
                    { text: "Begin the ritual", next: 365 },
                    { text: "Need other components first", next: 366 }
                ]
            },
            360: {
                title: "Presenting the Theory",
                text: "You explain Gerrick's theory to Valerius. His eyes widen. 'Is it possible? Could I be freed without being destroyed?'",
                choices: [
                    { text: "Say you'll try", next: 367 },
                    { text: "Say you need to research more", next: 368 }
                ]
            },
            361: {
                title: "Tomas Explains",
                text: "Tomas explains Gerrick's theory in detail. Valerius becomes increasingly hopeful. 'This changes everything!'",
                choices: [
                    { text: "Plan the modified ritual", next: 369 }
                ]
            },
            362: {
                title: "Resistance Volunteer",
                text: "After a long silence, three people step forward. 'We'll do it,' they say almost in unison.",
                choices: [
                    { text: "Choose one", next: 370 },
                    { text: "Say you'll do it yourself", next: 363 }
                ]
            },
            363: {
                title: "Volunteering Yourself to Resistance",
                text: "The resistance members look at you with respect. 'You have more courage than most of us,' their leader says. 'We'll help you gather what you need.'",
                reward: {
                    provisions: 3,
                    gold: 30
                },
                choices: [
                    { text: "Thank them and leave", next: 260 }
                ]
            },
            364: {
                title: "Resistance Volunteer Interview",
                text: "The volunteer is a former city guard named Kael. 'I failed to protect this city once,' he says. 'Let me protect it now.'",
                choices: [
                    { text: "Accept his offer", next: 371 },
                    { text: "Ask if he's sure", next: 372 }
                ]
            },
            365: {
                title: "Beginning the Ritual",
                text: "You have all three components: the Mirror of Truth, the Tear of the Sun, and Tomas as the Brave Soul. Valerius begins the ritual at midnight.",
                choices: [
                    { text: "Proceed with standard ritual", next: 373 },
                    { text: "Try the modified ritual", next: 374 }
                ]
            },
            366: {
                title: "Missing Components",
                text: "You still need the Mirror and Tear. Time to gather them.",
                choices: [
                    { text: "Go to the Hall of Echoes", next: 272 },
                    { text: "Go to the Garden of Memories", next: 271 }
                ]
            },
            367: {
                title: "Attempting Modification",
                text: "'Let's try,' you say. Valerius nods. 'We'll need to be careful. If it fails...' He doesn't finish the sentence.",
                choices: [
                    { text: "Gather components for modified ritual", next: 375 }
                ]
            },
            368: {
                title: "More Research",
                text: "'We should research this more,' you suggest. 'Make sure we understand it completely.'",
                choices: [
                    { text: "Go to the library", next: 267 },
                    { text: "Search Gerrick's notes more thoroughly", next: 264 }
                ]
            },
            369: {
                title: "Planning the Ritual",
                text: "You, Tomas, and Valerius plan the modified ritual. It's risky, but could save everyone.",
                choices: [
                    { text: "Gather the components", next: 375 },
                    { text: "Perform the ritual now", next: 376 }
                ]
            },
            370: {
                title: "Choosing a Volunteer",
                text: "You choose Kael, the former guard. The others nod in agreement.",
                choices: [
                    { text: "Take Kael to the castle", next: 377 }
                ]
            },
            371: {
                title: "Accepting Kael",
                text: "You accept Kael as the Brave Soul. He seems resolved.",
                choices: [
                    { text: "Take him to the castle", next: 377 }
                ]
            },
            372: {
                title: "Confirming Resolve",
                text: "'Are you absolutely sure?' you ask. Kael nods. 'I've never been more sure of anything.'",
                choices: [
                    { text: "Accept his offer", next: 371 }
                ]
            },
            373: {
                title: "Standard Ritual",
                text: "Valerius performs the standard ritual. Tomas stands bravely as the magic swirls around him. The shadows begin to recede... but Tomas starts to fade too!",
                choices: [
                    { text: "Try to save Tomas", next: 378 },
                    { text: "Let the ritual complete", next: 379 }
                ]
            },
            374: {
                title: "Modified Ritual",
                text: "You attempt Gerrick's modified ritual. The magic works differently, focusing on separating Valerius from the shadows rather than destroying everything.",
                choices: [
                    { text: "Proceed carefully", next: 380 }
                ]
            },
            375: {
                title: "Gathering for Modified Ritual",
                text: "You need the same components, but with a different intention behind their use.",
                choices: [
                    { text: "Go get the Mirror and Tear", next: 366 }
                ]
            },
            376: {
                title: "Immediate Ritual",
                text: "You attempt the modified ritual immediately, using what you have. It's risky without proper preparation.",
                testLuck: {
                    lucky: 381,
                    unlucky: 382
                }
            },
            377: {
                title: "Bringing Kael",
                text: "You bring Kael to Valerius. The former guard and former lord regard each other with mutual respect.",
                choices: [
                    { text: "Begin the ritual", next: 383 },
                    { text: "Gather other components first", next: 366 }
                ]
            },
            378: {
                title: "Saving Tomas",
                text: "You intervene, trying to pull Tomas back. The ritual goes unstable!",
                testLuck: {
                    lucky: 384,
                    unlucky: 385
                }
            },
            379: {
                title: "Completing the Ritual",
                text: "You let the ritual complete. Tomas disappears in a flash of light. The shadows vanish. Sunlight bursts through the darkness for the first time in months. The city is saved... but at what cost?",
                victory: true
            },
            380: {
                title: "Careful Modified Ritual",
                text: "You perform the modified ritual carefully. The shadows separate from Valerius, forming a distinct entity that can be banished. Valerius collapses, now human again. Tomas remains unharmed. The shadow entity shrieks as it's banished by the combined light.",
                victory: true
            },
            381: {
                title: "Lucky Immediate Ritual",
                text: "Against all odds, the immediate ritual works! Valerius is separated from the shadows, which are banished. Tomas is unharmed. Sunlight returns to the city.",
                victory: true
            },
            382: {
                title: "Unlucky Immediate Ritual",
                text: "The unprepared ritual goes wrong. The shadows flare up violently!",
                damage: 6,
                choices: [
                    { text: "Try to stabilize it", testLuck: {
                        lucky: 386,
                        unlucky: 500
                    } },
                    { text: "Abandon the ritual", next: 387 }
                ]
            },
            383: {
                title: "Ritual with Kael",
                text: "Kael stands bravely as the ritual begins. Valerius channels the magic with precision.",
                choices: [
                    { text: "Use standard ritual", next: 388 },
                    { text: "Use modified ritual", next: 389 }
                ]
            },
            384: {
                title: "Lucky Intervention",
                text: "You manage to save Tomas while still completing the ritual! The shadows are banished, Tomas survives, and sunlight returns.",
                victory: true
            },
            385: {
                title: "Unlucky Intervention",
                text: "Your intervention causes the ritual to fail catastrophically! The shadows explode outward!",
                damage: 8,
                choices: [
                    { text: "Try to contain it", next: 390 },
                    { text: "Flee", next: 391 }
                ]
            },
            386: {
                title: "Stabilization Success",
                text: "You manage to stabilize the ritual! It completes successfully, banishing the shadows and saving Valerius.",
                victory: true
            },
            387: {
                title: "Abandoned Ritual",
                text: "You abandon the ritual before it causes more damage. The shadows remain, but at least no one was hurt further.",
                choices: [
                    { text: "Try again with proper preparation", next: 369 },
                    { text: "Give up", next: 500 }
                ]
            },
            388: {
                title: "Standard Ritual with Kael",
                text: "The standard ritual completes. Kael sacrifices himself, the shadows are banished, and sunlight returns. The city has a hero to mourn, but also a future.",
                victory: true
            },
            389: {
                title: "Modified Ritual with Kael",
                text: "The modified ritual works perfectly! Kael's willingness provides the power to separate Valerius from the shadows without requiring his death. Everyone survives, and the city is saved.",
                victory: true
            },
            390: {
                title: "Containing the Catastrophe",
                text: "You try to contain the exploding shadows, but it's too much. You're overwhelmed...",
                gameOver: true
            },
            391: {
                title: "Fleeing",
                text: "You flee as the shadows explode outward. The city is consumed entirely by darkness...",
                gameOver: true
            },
            500: {
                title: "Game Over",
                text: "The City of Shadows claims another victim. The darkness continues, unchallenged...",
                gameOver: true
            }
        },
        enemies: {
            shadow_guards: {
                name: "Shadow Guards",
                skill: 10,
                stamina: 16,
                ascii: `    
    .-.     .-.
   (   )   (   )
    | |     | |
   |   |   |   |
  |     | |     |
   \\___/   \\___/
    | |     | |
   /   \\   /   \\`
            },
            shadow_creature: {
                name: "Shadow Creature",
                skill: 11,
                stamina: 18,
                ascii: `    
    .-.
   (   )
    | |
   |   |
  |     |
   \\___/
    / \\
   /   \\`
            },
            stone_golems: {
                name: "Stone Golems",
                skill: 13,
                stamina: 24,
                ascii: `    
     ___     ___
    /   \\   /   \\
   |     | |     |
    \\___/   \\___/
     /|\\     /|\\
    / | \\   / | \\
   /  |  \\ /  |  \\
      |       |
     / \\     / \\
    /   \\   /   \\`
            },
            garden_shadows: {
                name: "Garden Shadows",
                skill: 12,
                stamina: 20,
                ascii: `    
    .-.     .-.     .-.
   (   )   (   )   (   )
    | |     | |     | |
   |   |   |   |   |   |
  |     | |     | |     |
   \\___/   \\___/   \\___/
    | |     | |     | |
   /   \\   /   \\   /   \\`
            },
            stone_statues: {
                name: "Animated Statues",
                skill: 11,
                stamina: 18,
                ascii: `    
     ___     ___
    /   \\   /   \\
   |     | |     |
    \\___/   \\___/
     /|\\     /|\\
    / | \\   / | \\
   /  |  \\ /  |  \\`
            },
            shadow_librarian: {
                name: "Shadow Librarian",
                skill: 13,
                stamina: 22,
                ascii: `    
     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\
    |  |
    |  |
   /    \\`
            }
        }
    };

    // ============== DICE FUNCTIONS ==============
    function rollDice(numDice = 2) {
        let total = 0;
        let rolls = [];
        for (let i = 0; i < numDice; i++) {
            const roll = Math.floor(Math.random() * 6) + 1;
            rolls.push(roll);
            total += roll;
        }
        
        // Show notification for dice roll
        notificationSystem.showDiceRoll(rolls.join(" + "), total);
        
        return total;
    }

    function rollSkillDice(skill) {
        const diceRoll = rollDice(2);
        return diceRoll + skill;
    }

    function testLuck() {
        const luckRoll = rollDice(2);
        const isLucky = luckRoll <= gameState.player.luck;
        
        // Decrease luck after test
        gameState.player.luck = Math.max(0, gameState.player.luck - 1);
        
        // Show notification
        notificationSystem.showLuckTest(luckRoll, isLucky);
        
        return {
            roll: luckRoll,
            lucky: isLucky
        };
    }

    // ============== EQUIPMENT SYSTEM ==============
    function equipItem(item) {
        // Unequip any item of the same type first
        if (item.type === "weapon") {
            if (gameState.player.equipped.weapon) {
                unequipItem(gameState.player.equipped.weapon);
            }
            gameState.player.equipped.weapon = item;
            gameState.player.skill = gameState.player.baseSkill + (item.skillBonus || 0);
            notificationSystem.show("Item Equipped", `You equipped ${item.name}. Skill increased by ${item.skillBonus || 0}.`);
        } else if (item.type === "armor") {
            if (gameState.player.equipped.armor) {
                unequipItem(gameState.player.equipped.armor);
            }
            gameState.player.equipped.armor = item;
            const oldMaxStamina = gameState.player.maxStamina;
            gameState.player.maxStamina = gameState.player.baseStamina + (item.staminaBonus || 0);
            // Adjust current stamina if it exceeds the new max
            if (gameState.player.stamina > gameState.player.maxStamina) {
                gameState.player.stamina = gameState.player.maxStamina;
            }
            notificationSystem.show("Item Equipped", `You equipped ${item.name}. Maximum Stamina increased by ${item.staminaBonus || 0}.`);
        } else if (item.type === "accessory") {
            if (gameState.player.equipped.accessory) {
                unequipItem(gameState.player.equipped.accessory);
            }
            gameState.player.equipped.accessory = item;
            gameState.player.luck = gameState.player.baseLuck + (item.luckBonus || 0);
            notificationSystem.show("Item Equipped", `You equipped ${item.name}. Luck increased by ${item.luckBonus || 0}.`);
        }
        
        // Remove item from inventory if it's now equipped
        const itemIndex = gameState.player.inventory.findIndex(i => i.id === item.id);
        if (itemIndex !== -1) {
            gameState.player.inventory.splice(itemIndex, 1);
        }
        
        updateHeaderStats();
        updateInventoryScreen();
    }

    function unequipItem(item) {
        if (item.type === "weapon") {
            gameState.player.skill = gameState.player.baseSkill;
            gameState.player.equipped.weapon = null;
        } else if (item.type === "armor") {
            gameState.player.maxStamina = gameState.player.baseStamina;
            // Adjust current stamina if it exceeds the new max
            if (gameState.player.stamina > gameState.player.maxStamina) {
                gameState.player.stamina = gameState.player.maxStamina;
            }
            gameState.player.equipped.armor = null;
        } else if (item.type === "accessory") {
            gameState.player.luck = gameState.player.baseLuck;
            gameState.player.equipped.accessory = null;
        }
        
        // Add item back to inventory
        gameState.player.inventory.push(item);
        notificationSystem.show("Item Unequipped", `You unequipped ${item.name}.`);
        
        updateHeaderStats();
        updateInventoryScreen();
    }

    function useConsumable(item) {
        if (item.effect === "heal") {
            const healAmount = Math.min(item.value, gameState.player.maxStamina - gameState.player.stamina);
            gameState.player.stamina += healAmount;
            notificationSystem.show("Item Used", `You used ${item.name} and restored ${healAmount} Stamina!`);
        } else if (item.effect === "light") {
            // Light crystals can be used in combat against shadows
            if (gameState.currentEnemy && gameState.currentEnemy.name.toLowerCase().includes("shadow")) {
                gameState.currentEnemy.currentStamina -= item.value;
                notificationSystem.show("Item Used", `You used Light Crystals on ${gameState.currentEnemy.name} for ${item.value} damage!`);
                
                // Check if enemy is defeated
                if (gameState.currentEnemy.currentStamina <= 0) {
                    notificationSystem.show("Victory!", `The ${gameState.currentEnemy.name} is defeated!`);
                    document.getElementById('attack-btn').style.display = 'none';
                    document.getElementById('flee-combat').style.display = 'none';
                    document.getElementById('victory-continue').style.display = 'block';
                }
                
                // Update combat display
                document.getElementById('enemy-stamina').textContent = Math.max(0, gameState.currentEnemy.currentStamina);
                const enemyHealthPercent = (gameState.currentEnemy.currentStamina / gameState.currentEnemy.stamina) * 100;
                document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
                
                // Remove the item from inventory
                const itemIndex = gameState.player.inventory.findIndex(i => i.id === item.id);
                if (itemIndex !== -1) {
                    gameState.player.inventory.splice(itemIndex, 1);
                }
                
                showScreen('combat-screen');
                return;
            } else {
                notificationSystem.show("Item Used", `You have light crystals, but there's no shadow creature to use them on right now.`);
            }
        } else if (item.effect === "escape") {
            // Smoke bomb for escaping combat
            if (gameState.currentEnemy) {
                notificationSystem.show("Smoke Bomb Used", "You throw a smoke bomb and escape from combat!");
                showScreen('story-screen');
                // Return to previous location or a safe location
                showParagraph(200); // Return to city entrance
                return;
            }
        } else if (item.effect === "skill") {
            // Temporary skill boost for next combat
            notificationSystem.show("Item Used", `You used ${item.name}. Your Skill is increased by ${item.value} for the next combat.`);
            // This would need to be tracked separately for next combat
        } else if (item.effect === "provision") {
            gameState.player.provisions += item.value;
            notificationSystem.show("Item Bought", `You bought ${item.value} provision(s)!`);
        }
        
        // Remove the item from inventory if it's a single-use consumable
        if (item.effect !== "provision") {
            const itemIndex = gameState.player.inventory.findIndex(i => i.id === item.id);
            if (itemIndex !== -1) {
                gameState.player.inventory.splice(itemIndex, 1);
            }
        }
        
        updateHeaderStats();
        updateInventoryScreen();
    }

    // ============== COMBAT SYSTEM ==============
    function startCombat(enemyKey, victoryParagraph) {
        gameState.currentEnemy = {
            ...gameState.enemies[enemyKey],
            currentStamina: gameState.enemies[enemyKey].stamina
        };
        
        gameState.combatRound = 0;
        gameState.currentCombatVictoryParagraph = victoryParagraph;
        
        document.getElementById('enemy-name').textContent = gameState.currentEnemy.name;
        document.getElementById('enemy-ascii').textContent = gameState.currentEnemy.ascii;
        document.getElementById('enemy-skill').textContent = gameState.currentEnemy.skill;
        document.getElementById('enemy-stamina').textContent = gameState.currentEnemy.currentStamina;
        document.getElementById('player-combat-skill').textContent = gameState.player.skill;
        document.getElementById('player-combat-stamina').textContent = gameState.player.stamina;
        
        document.getElementById('player-health-fill').style.width = '100%';
        document.getElementById('enemy-health-fill').style.width = '100%';
        
        document.getElementById('combat-log').innerHTML = `<div>Combat begins! You face a ${gameState.currentEnemy.name}.</div>`;
        
        // Show/hide appropriate buttons
        document.getElementById('attack-btn').style.display = 'block';
        document.getElementById('flee-combat').style.display = 'block';
        document.getElementById('victory-continue').style.display = 'none';
        document.getElementById('use-luck-combat').style.display = 'none';
        
        notificationSystem.show("Combat Started", `You encounter a ${gameState.currentEnemy.name}! Prepare for battle!`);
        
        showScreen('combat-screen');
    }

    function combatRound() {
        gameState.combatRound++;
        
        const playerAttack = rollSkillDice(gameState.player.skill);
        const enemyAttack = rollSkillDice(gameState.currentEnemy.skill);
        
        document.getElementById('combat-dice-roll').style.display = 'block';
        document.getElementById('player-attack').textContent = playerAttack;
        document.getElementById('enemy-attack').textContent = enemyAttack;
        
        let logMessage = '';
        let damage = 0;
        
        if (playerAttack > enemyAttack) {
            // Player hits enemy
            damage = 2;
            gameState.currentEnemy.currentStamina -= damage;
            logMessage = `You hit the ${gameState.currentEnemy.name} for ${damage} damage!`;
            
            if (gameState.currentEnemy.currentStamina <= 0) {
                logMessage += ` The ${gameState.currentEnemy.name} is defeated!`;
                document.getElementById('attack-btn').style.display = 'none';
                document.getElementById('flee-combat').style.display = 'none';
                document.getElementById('victory-continue').style.display = 'block';
                notificationSystem.showCombatResult("You defeated the enemy!", "");
            }
        } else if (enemyAttack > playerAttack) {
            // Enemy hits player
            damage = 2;
            gameState.player.stamina -= damage;
            logMessage = `The ${gameState.currentEnemy.name} hits you for ${damage} damage!`;
            
            if (gameState.player.stamina <= 0) {
                logMessage += ` You have been defeated!`;
                document.getElementById('attack-btn').style.display = 'none';
                setTimeout(() => endCombat(false), 1500);
                notificationSystem.showCombatResult("You were defeated!", `You took ${damage} damage.`);
            } else {
                notificationSystem.showCombatResult("Enemy hits you!", `You took ${damage} damage.`);
            }
        } else {
            // Tie
            logMessage = `You both miss each other!`;
            notificationSystem.showCombatResult("Draw!", "Both attacks miss.");
        }
        
        // Update displays
        document.getElementById('player-combat-stamina').textContent = gameState.player.stamina;
        document.getElementById('enemy-stamina').textContent = Math.max(0, gameState.currentEnemy.currentStamina);
        
        const playerHealthPercent = (gameState.player.stamina / gameState.player.maxStamina) * 100;
        const enemyHealthPercent = (gameState.currentEnemy.currentStamina / gameState.currentEnemy.stamina) * 100;
        
        document.getElementById('player-health-fill').style.width = `${playerHealthPercent}%`;
        document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
        
        document.getElementById('combat-result').textContent = logMessage;
        
        // Add to combat log
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `<strong>Round ${gameState.combatRound}:</strong> ${logMessage}`;
        document.getElementById('combat-log').appendChild(logEntry);
        document.getElementById('combat-log').scrollTop = document.getElementById('combat-log').scrollHeight;
        
        updateHeaderStats();
    }

    function endCombat(victory) {
        if (victory) {
            // Find the victory paragraph from the current story paragraph
            if (gameState.currentCombatVictoryParagraph) {
                showParagraph(gameState.currentCombatVictoryParagraph);
            } else {
                showParagraph(200); // Default to Level 2 beginning if no victory paragraph specified
            }
        } else {
            showGameOver(`You were defeated by the ${gameState.currentEnemy.name}.`);
        }
    }

    // ============== CAMPAIGN SAVE/LOAD SYSTEM ==============
    function saveGame() {
        const saveData = {
            player: gameState.player,
            currentParagraph: gameState.currentParagraph,
            currentLevel: gameState.currentLevel,
            completedLevels: gameState.completedLevels
        };
        localStorage.setItem('ffCampaignSave', JSON.stringify(saveData));
        notificationSystem.show("Game Saved", "Your progress has been saved successfully!", { timeout: 2000 });
    }

    function loadGame() {
        const saveData = localStorage.getItem('ffCampaignSave');
        if (saveData) {
            try {
                const saved = JSON.parse(saveData);
                
                // Check if player is trying to access a level they shouldn't
                if (saved.currentLevel > 2 && !saved.completedLevels.includes(saved.currentLevel - 1)) {
                    notificationSystem.show("Cannot Load", `You must complete Level ${saved.currentLevel - 1} first!`);
                    return false;
                }
                
                gameState.player = saved.player;
                gameState.currentParagraph = saved.currentParagraph;
                gameState.currentLevel = saved.currentLevel;
                gameState.completedLevels = saved.completedLevels;
                
                // Update level display
                document.getElementById('header-level').textContent = gameState.currentLevel;
                document.getElementById('combat-level').textContent = gameState.currentLevel;
                document.getElementById('inv-level').textContent = gameState.currentLevel;
                document.getElementById('game-over-level').textContent = gameState.currentLevel;
                
                updateHeaderStats();
                showParagraph(gameState.currentParagraph);
                updateMainMenuStats();
                
                notificationSystem.show("Game Loaded", "Your saved game has been loaded successfully!");
                return true;
            } catch (e) {
                console.error("Failed to load saved game:", e);
                notificationSystem.show("Load Failed", "Failed to load saved game. Starting new campaign.");
                return false;
            }
        } else {
            notificationSystem.show("No Save Found", "No saved game found. Start a new campaign.");
            return false;
        }
    }

    function initializeNewGameForLevel(level) {
        // Only initialize if level is 1 - otherwise load existing stats
        if (level === 1) {
            // Roll initial stats (as in Fighting Fantasy books)
            gameState.player.baseSkill = rollDice(1) + 6; // 7-12
            gameState.player.baseStamina = rollDice(2) + 12; // 14-24
            gameState.player.baseLuck = rollDice(1) + 6; // 7-12
            
            gameState.player.skill = gameState.player.baseSkill;
            gameState.player.stamina = gameState.player.baseStamina;
            gameState.player.maxStamina = gameState.player.baseStamina;
            gameState.player.luck = gameState.player.baseLuck;
            
            // Starting gold/provisions for new Level 1 game
            gameState.player.gold = 30;
            gameState.player.provisions = 8;
            gameState.player.inventory = [];
            gameState.player.equipped = {
                weapon: null,
                armor: null,
                accessory: null
            };
            
            gameState.currentParagraph = 1;
            gameState.currentLevel = 1;
            gameState.completedLevels = [1];
            
            // Save immediately
            saveGame();
            
            updateHeaderStats();
            updateMainMenuStats();
            
            // Redirect to Level 1
            window.location.href = "level1.html";
        } else {
            // For Level 2, we should load existing stats
            if (!loadGame()) {
                // If no save exists, can't start Level 2
                notificationSystem.show("Cannot Start Level 2", "You must complete Level 1 first!");
                return;
            }
            
            // Check if player has completed Level 1
            if (!gameState.completedLevels.includes(1)) {
                notificationSystem.show("Level 1 Not Completed", "You must complete Level 1 before starting Level 2!");
                showScreen('main-menu');
                return;
            }
            
            // Set to Level 2
            gameState.currentLevel = 2;
            gameState.currentParagraph = 200; // Start of Level 2
            
            // Add Level 2 to completed levels if not already there
            if (!gameState.completedLevels.includes(2)) {
                gameState.completedLevels.push(2);
            }
            
            // Save the Level 2 start
            saveGame();
            
            updateHeaderStats();
            updateMainMenuStats();
            showParagraph(200);
            
            notificationSystem.show("Welcome to Level 2", "Your adventure continues in the City of Shadows! Your stats and inventory have been carried over from Level 1.");
        }
    }

    function goToNextLevel() {
        // Unlock next level
        const nextLevel = gameState.currentLevel + 1;
        if (!gameState.completedLevels.includes(nextLevel)) {
            gameState.completedLevels.push(nextLevel);
        }
        
        // Save current state
        saveGame();
        
        // Redirect to next level HTML file
        if (nextLevel === 3) {
            notificationSystem.show("Level Complete!", `Congratulations! Level 2 complete! Moving to Level 3.`);
            setTimeout(() => {
                // In actual implementation, redirect to level3.html
                alert(`In the full game, this would redirect to Level 3. For this demo, you can continue playing Level 2.`);
                showScreen('main-menu');
            }, 2000);
        } else {
            notificationSystem.show("Campaign Complete!", "Congratulations! You've completed the entire campaign!");
            showScreen('main-menu');
        }
    }

    function loadLevel(level) {
        // Check if level is unlocked
        const saveData = localStorage.getItem('ffCampaignSave');
        if (saveData) {
            const saved = JSON.parse(saveData);
            if (!saved.completedLevels.includes(level) && level > 1) {
                notificationSystem.show("Level Locked", `Level ${level} is locked. Complete Level ${level - 1} first!`);
                return;
            }
        } else if (level > 1) {
            notificationSystem.show("Level Locked", `Level ${level} is locked. Start a new campaign first!`);
            return;
        }
        
        if (level === 1) {
            window.location.href = "level1.html";
        } else if (level === 2) {
            // Already on Level 2
            showScreen('main-menu');
            notificationSystem.show("Level Selected", "Starting Level 2: City of Shadows");
            initializeNewGameForLevel(2);
        } else {
            notificationSystem.show("Level Not Available", `Level ${level} is not available in this demo.`);
        }
    }

    // ============== LEVEL MANAGEMENT ==============
    function showLevelSelect() {
        const levelButtons = document.getElementById('level-buttons');
        levelButtons.innerHTML = '';
        
        // Create buttons for each level
        for (let i = 1; i <= 5; i++) {
            const button = document.createElement('button');
            button.className = 'choice-btn';
            button.textContent = `LEVEL ${i}: ${getLevelName(i)}`;
            
            // Check if level is unlocked
            const saveData = localStorage.getItem('ffCampaignSave');
            let isUnlocked = i === 1; // Level 1 is always unlocked
            
            if (saveData) {
                const saved = JSON.parse(saveData);
                if (saved.completedLevels && saved.completedLevels.includes(i)) {
                    isUnlocked = true;
                } else if (i > 1) {
                    // Check if previous level is completed
                    if (saved.completedLevels && saved.completedLevels.includes(i-1)) {
                        isUnlocked = true;
                    }
                }
            }
            
            if (isUnlocked) {
                button.onclick = () => loadLevel(i);
            } else {
                button.disabled = true;
                button.textContent += ' (LOCKED)';
            }
            
            levelButtons.appendChild(button);
        }
        
        showScreen('level-select-screen');
    }

    function getLevelName(level) {
        const levelNames = {
            1: "Island of the Undead",
            2: "City of Shadows",
            3: "Mountain of Doom",
            4: "Caverns of Chaos",
            5: "Final Battle"
        };
        return levelNames[level] || `Level ${level}`;
    }

    function showCampaignProgress() {
        const saveData = localStorage.getItem('ffCampaignSave');
        let progressHtml = "<h3>CAMPAIGN PROGRESS</h3>";
        
        if (saveData) {
            try {
                const saved = JSON.parse(saveData);
                const currentLevel = saved.currentLevel || 1;
                const completedLevels = saved.completedLevels || [1];
                const characterLevel = Math.floor(saved.player.skill/3 + saved.player.maxStamina/20 + saved.player.luck/6);
                
                progressHtml += `<p><strong>Current Level:</strong> ${currentLevel} - ${getLevelName(currentLevel)}</p>`;
                progressHtml += `<p><strong>Character Level:</strong> ${characterLevel}</p>`;
                progressHtml += `<p><strong>Gold:</strong> ${saved.player.gold}</p>`;
                progressHtml += `<p><strong>Skill:</strong> ${saved.player.skill}</p>`;
                progressHtml += `<p><strong>Stamina:</strong> ${saved.player.stamina}/${saved.player.maxStamina}</p>`;
                progressHtml += `<p><strong>Luck:</strong> ${saved.player.luck}</p>`;
                
                progressHtml += `<h4>Completed Levels:</h4>`;
                for (let i = 1; i <= 5; i++) {
                    const isCompleted = completedLevels.includes(i);
                    progressHtml += `<p>${isCompleted ? '✅' : '🔒'} Level ${i}: ${getLevelName(i)} ${isCompleted ? '(COMPLETED)' : '(LOCKED)'}</p>`;
                }
                
                // Show Level 2 specific progress
                if (currentLevel === 2) {
                    progressHtml += `<h4>Level 2 Progress:</h4>`;
                    progressHtml += `<p>City of Shadows Adventure</p>`;
                    if (saved.player.inventory) {
                        const hasMirror = saved.player.inventory.some(item => item.id === "mirror_of_truth");
                        const hasTear = saved.player.inventory.some(item => item.id === "tear_of_sun");
                        const hasBraveSoul = saved.player.inventory.some(item => item.id && item.id.includes("tomas") || item.id.includes("kael"));
                        
                        progressHtml += `<p>Mirror of Truth: ${hasMirror ? '✅ Found' : '❌ Not Found'}</p>`;
                        progressHtml += `<p>Tear of the Sun: ${hasTear ? '✅ Found' : '❌ Not Found'}</p>`;
                        progressHtml += `<p>Brave Soul: ${hasBraveSoul ? '✅ Found' : '❌ Not Found'}</p>`;
                    }
                }
            } catch (e) {
                progressHtml += "<p>Error reading save data. Start a new campaign.</p>";
            }
        } else {
            progressHtml += "<p>No campaign progress yet. Start a new game!</p>";
        }
        
        document.getElementById('progress-content').innerHTML = progressHtml;
        showScreen('progress-screen');
    }

    function updateMainMenuStats() {
        const saveData = localStorage.getItem('ffCampaignSave');
        if (saveData) {
            try {
                const saved = JSON.parse(saveData);
                document.getElementById('menu-current-level').textContent = saved.currentLevel || 1;
                document.getElementById('menu-character-level').textContent = Math.floor(saved.player.skill/3 + saved.player.maxStamina/20 + saved.player.luck/6);
                document.getElementById('menu-gold').textContent = saved.player.gold;
            } catch (e) {
                // If error, show defaults
                document.getElementById('menu-current-level').textContent = '-';
                document.getElementById('menu-character-level').textContent = '-';
                document.getElementById('menu-gold').textContent = '-';
            }
        } else {
            document.getElementById('menu-current-level').textContent = '-';
            document.getElementById('menu-character-level').textContent = '-';
            document.getElementById('menu-gold').textContent = '-';
        }
    }

    // ============== STORY SYSTEM ==============
    function showParagraph(paragraphId) {
        gameState.currentParagraph = paragraphId;
        const paragraph = gameState.story[paragraphId];
        
        if (!paragraph) {
            showGameOver("Your adventure has reached an unknown path.");
            return;
        }
        
        if (paragraph.gameOver) {
            showGameOver(paragraph.text);
            return;
        }
        
        if (paragraph.victory) {
            showVictory();
            return;
        }
        
        document.getElementById('story-title').textContent = paragraph.title;
        document.getElementById('story-text').textContent = paragraph.text;
        
        // Clear previous choices
        const choiceList = document.getElementById('choice-list');
        choiceList.innerHTML = '';
        
        // Hide dice and luck sections
        document.getElementById('dice-roll-section').style.display = 'none';
        document.getElementById('luck-test-section').style.display = 'none';
        
        // Make sure choice list is visible
        choiceList.style.display = 'block';
        
        // Apply damage if any
        if (paragraph.damage) {
            gameState.player.stamina = Math.max(0, gameState.player.stamina - paragraph.damage);
            notificationSystem.show("Damage Taken", `You took ${paragraph.damage} damage!`);
            updateHeaderStats();
            
            if (gameState.player.stamina <= 0) {
                showGameOver("You have succumbed to your injuries.");
                return;
            }
        }
        
        // Add new choices
        if (paragraph.choices && paragraph.choices.length > 0) {
            paragraph.choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                
                // Handle dynamic next values
                let nextValue = choice.next;
                if (typeof nextValue === 'function') {
                    nextValue = nextValue();
                }
                
                button.textContent = choice.text;
                
                if (choice.cost && choice.cost > gameState.player.gold) {
                    button.disabled = true;
                    button.textContent += ` (Need ${choice.cost} Gold)`;
                }
                
                button.addEventListener('click', () => {
                    handleChoice(choice);
                });
                
                choiceList.appendChild(button);
            });
        } else if (paragraph.combat) {
            // If paragraph leads directly to combat
            const button = document.createElement('button');
            button.className = 'choice-btn';
            button.textContent = `Fight the ${paragraph.combat.enemy}`;
            button.addEventListener('click', () => {
                startCombat(paragraph.combat.enemy, paragraph.combat.victory);
            });
            choiceList.appendChild(button);
        } else if (paragraph.testLuck) {
            // If paragraph requires a luck test
            const button = document.createElement('button');
            button.className = 'choice-btn';
            button.textContent = "Test Your Luck";
            button.addEventListener('click', () => {
                const luckResult = testLuck();
                if (luckResult.lucky) {
                    showParagraph(paragraph.testLuck.lucky);
                } else {
                    showParagraph(paragraph.testLuck.unlucky);
                }
            });
            choiceList.appendChild(button);
        } else if (paragraph.skillTest) {
            // If paragraph requires a skill test
            const button = document.createElement('button');
            button.className = 'choice-btn';
            button.textContent = "Test Your Skill";
            button.addEventListener('click', () => {
                const skillTest = rollSkillDice(gameState.player.skill);
                const target = 12; // Typical target number
                if (skillTest >= target) {
                    showParagraph(paragraph.skillTest.success);
                } else {
                    showParagraph(paragraph.skillTest.failure);
                }
            });
            choiceList.appendChild(button);
        }
        
        // Apply rewards if any
        if (paragraph.reward) {
            if (typeof paragraph.reward === 'function') {
                const reward = paragraph.reward();
                applyReward(reward);
            } else {
                applyReward(paragraph.reward);
            }
        }
        
        // Apply damage bonus if any (for backstabs, etc.)
        if (paragraph.damageBonus) {
            // This would need to be implemented in combat
            notificationSystem.show("Advantage Gained", `You have a damage advantage of +${paragraph.damageBonus} for the next combat!`);
        }
        
        updateHeaderStats();
        showScreen('story-screen');
    }

    function applyReward(reward) {
        if (reward.gold) {
            gameState.player.gold += reward.gold;
            if (reward.gold > 0) {
                notificationSystem.showReward({ gold: reward.gold });
            } else if (reward.gold < 0) {
                notificationSystem.show("Gold Lost", `You lost ${Math.abs(reward.gold)} gold!`);
            }
        }
        if (reward.inventory) {
            gameState.player.inventory.push(...reward.inventory);
            notificationSystem.showReward({ inventory: reward.inventory });
        }
        if (reward.skill) {
            gameState.player.skill += reward.skill;
            gameState.player.baseSkill += reward.skill;
            notificationSystem.showReward({ skill: reward.skill });
        }
        if (reward.maxStamina) {
            gameState.player.maxStamina += reward.maxStamina;
            gameState.player.baseStamina += reward.maxStamina;
            notificationSystem.showReward({ maxStamina: reward.maxStamina });
        }
        if (reward.stamina) {
            gameState.player.stamina = Math.min(gameState.player.maxStamina, gameState.player.stamina + reward.stamina);
            notificationSystem.showReward({ stamina: reward.stamina });
        }
        if (reward.provisions) {
            gameState.player.provisions += reward.provisions;
            notificationSystem.showReward({ provisions: reward.provisions });
        }
        if (reward.luck) {
            gameState.player.luck += reward.luck;
            gameState.player.baseLuck += reward.luck;
            notificationSystem.showReward({ luck: reward.luck });
        }
        
        updateHeaderStats();
        updateMainMenuStats();
        saveGame(); // Auto-save on rewards
    }

    function handleChoice(choice) {
        if (choice.cost && choice.cost > 0) {
            if (gameState.player.gold < choice.cost) {
                notificationSystem.show("Not Enough Gold", `You need ${choice.cost} Gold for this choice!`);
                return;
            }
            gameState.player.gold -= choice.cost;
        }
        
        if (choice.test === "luck") {
            // Show luck test interface
            document.getElementById('luck-test-section').style.display = 'block';
            document.getElementById('choice-list').style.display = 'none';
            
            const luckResult = testLuck();
            document.getElementById('luck-dice-result').textContent = luckResult.roll;
            
            if (luckResult.lucky) {
                document.getElementById('luck-result').textContent = "You are Lucky!";
                document.getElementById('luck-result').className = "luck-result success";
            } else {
                document.getElementById('luck-result').textContent = "You are Unlucky!";
                document.getElementById('luck-result').className = "luck-result failure";
            }
            
            // Store the luck test result
            gameState.lastLuckTest = luckResult;
            
            updateHeaderStats();
            updateMainMenuStats();
        } else if (choice.combat) {
            startCombat(choice.combat, choice.next);
        } else {
            // Handle dynamic next values
            let nextValue = choice.next;
            if (typeof nextValue === 'function') {
                nextValue = nextValue();
            }
            showParagraph(nextValue);
        }
    }

    // ============== MARKET SYSTEM ==============
    function updateMarketScreen() {
        const marketItems = document.getElementById('market-items');
        marketItems.innerHTML = '';
        
        gameState.marketItems.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'market-item';
            
            const itemInfo = document.createElement('div');
            itemInfo.innerHTML = `
                <h3>${item.name}</h3>
                <p>${item.description}</p>
                <p><strong>Cost: ${item.cost} Gold</strong></p>
            `;
            
            const buyButton = document.createElement('button');
            buyButton.className = 'item-action-btn';
            buyButton.textContent = 'Buy';
            buyButton.onclick = () => buyItem(item);
            buyButton.disabled = gameState.player.gold < item.cost;
            
            itemElement.appendChild(itemInfo);
            itemElement.appendChild(buyButton);
            marketItems.appendChild(itemElement);
        });
        
        document.getElementById('market-gold').textContent = gameState.player.gold;
    }

    function buyItem(item) {
        if (gameState.player.gold < item.cost) {
            notificationSystem.show("Not Enough Gold", "You don't have enough gold!");
            return;
        }
        
        gameState.player.gold -= item.cost;
        
        if (item.type === "consumable" && item.effect === "provision") {
            gameState.player.provisions += item.value;
            notificationSystem.show("Item Purchased", `You bought ${item.value} provision(s) for ${item.cost} gold.`);
        } else {
            // Create a copy of the item to add to inventory
            const itemCopy = {...item};
            gameState.player.inventory.push(itemCopy);
            notificationSystem.show("Item Purchased", `You bought ${item.name} for ${item.cost} gold.`);
        }
        
        updateMarketScreen();
        updateHeaderStats();
        updateInventoryScreen();
        updateMainMenuStats();
        saveGame();
    }

    // ============== UI MANAGEMENT ==============
    function showScreen(screenName) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenName).classList.add('active');
    }

    function updateHeaderStats() {
        document.getElementById('header-level').textContent = gameState.currentLevel;
        document.getElementById('header-skill').textContent = gameState.player.skill;
        document.getElementById('header-stamina').textContent = gameState.player.stamina;
        document.getElementById('header-max-stamina').textContent = gameState.player.maxStamina;
        document.getElementById('header-luck').textContent = gameState.player.luck;
        document.getElementById('header-gold').textContent = gameState.player.gold;
        
        document.getElementById('combat-level').textContent = gameState.currentLevel;
        document.getElementById('combat-skill').textContent = gameState.player.skill;
        document.getElementById('combat-stamina').textContent = gameState.player.stamina;
        document.getElementById('combat-max-stamina').textContent = gameState.player.maxStamina;
        document.getElementById('combat-luck').textContent = gameState.player.luck;
        
        document.getElementById('inv-level').textContent = gameState.currentLevel;
        document.getElementById('inv-skill').textContent = gameState.player.skill;
        document.getElementById('inv-stamina').textContent = gameState.player.stamina;
        document.getElementById('inv-luck').textContent = gameState.player.luck;
        document.getElementById('inv-gold').textContent = gameState.player.gold;
        document.getElementById('provisions-count').textContent = gameState.player.provisions;
    }

    function updateInventoryScreen() {
        const equippedItems = document.getElementById('equipped-items');
        equippedItems.innerHTML = '';
        
        // Show equipped items
        Object.keys(gameState.player.equipped).forEach(slot => {
            const item = gameState.player.equipped[slot];
            if (item) {
                const itemElement = document.createElement('div');
                itemElement.className = 'item item-equipped';
                
                let itemText = `${slot.charAt(0).toUpperCase() + slot.slice(1)}: ${item.name}`;
                if (item.skillBonus) itemText += ` (+${item.skillBonus} Skill)`;
                if (item.staminaBonus) itemText += ` (+${item.staminaBonus} Stamina)`;
                if (item.luckBonus) itemText += ` (+${item.luckBonus} Luck)`;
                
                const textElement = document.createElement('div');
                textElement.textContent = itemText;
                itemElement.appendChild(textElement);
                
                const actionsElement = document.createElement('div');
                actionsElement.className = 'item-actions';
                
                const unequipButton = document.createElement('button');
                unequipButton.className = 'item-action-btn';
                unequipButton.textContent = 'Unequip';
                unequipButton.onclick = () => unequipItem(item);
                actionsElement.appendChild(unequipButton);
                
                itemElement.appendChild(actionsElement);
                equippedItems.appendChild(itemElement);
            }
        });
        
        const inventoryList = document.getElementById('inventory-list');
        inventoryList.innerHTML = '';
        
        if (gameState.player.inventory.length === 0) {
            inventoryList.innerHTML = '<div style="text-align: center; padding: 10px; color: #a0a0a0;">Your backpack is empty</div>';
        } else {
            gameState.player.inventory.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'item item-special';
                
                let itemText = `${item.name}`;
                if (item.skillBonus) itemText += ` (+${item.skillBonus} Skill)`;
                if (item.staminaBonus) itemText += ` (+${item.staminaBonus} Stamina)`;
                if (item.luckBonus) itemText += ` (+${item.luckBonus} Luck)`;
                if (item.effect === "heal") itemText += ` (Heals ${item.value} Stamina)`;
                if (item.effect === "light") itemText += ` (Damages shadows: ${item.value})`;
                if (item.effect === "escape") itemText += ` (Allows escape from combat)`;
                if (item.effect === "skill") itemText += ` (+${item.value} Skill for next combat)`;
                
                const textElement = document.createElement('div');
                textElement.textContent = itemText;
                itemElement.appendChild(textElement);
                
                const actionsElement = document.createElement('div');
                actionsElement.className = 'item-actions';
                
                if (item.type === "weapon" || item.type === "armor" || item.type === "accessory") {
                    const equipButton = document.createElement('button');
                    equipButton.className = 'item-action-btn';
                    equipButton.textContent = 'Equip';
                    equipButton.onclick = () => equipItem(item);
                    actionsElement.appendChild(equipButton);
                }
                
                if (item.type === "consumable") {
                    const useButton = document.createElement('button');
                    useButton.className = 'item-action-btn';
                    useButton.textContent = 'Use';
                    useButton.onclick = () => useConsumable(item);
                    actionsElement.appendChild(useButton);
                }
                
                itemElement.appendChild(actionsElement);
                inventoryList.appendChild(itemElement);
            });
        }
    }

    function showGameOver(message) {
        document.getElementById('game-over-message').textContent = message;
        document.getElementById('game-over-level').textContent = gameState.currentLevel;
        document.getElementById('game-over-location').textContent = gameState.story[gameState.currentParagraph]?.title || "Unknown";
        document.getElementById('game-over-paragraph').textContent = gameState.currentParagraph;
        
        // Hide next level button on game over
        document.getElementById('next-level-btn').style.display = 'none';
        
        showScreen('game-over-screen');
    }

    function showVictory() {
        // Unlock next level
        const nextLevel = gameState.currentLevel + 1;
        if (!gameState.completedLevels.includes(nextLevel) && nextLevel <= 5) {
            gameState.completedLevels.push(nextLevel);
            saveGame(); // Save with unlocked level
        }
        
        // Check if this is the final level
        const isFinalLevel = gameState.currentLevel >= 5;
        
        document.getElementById('game-over-message').innerHTML = `
            <h3>${isFinalLevel ? 'CONGRATULATIONS!' : 'LEVEL COMPLETE!'}</h3>
            <p>${isFinalLevel ? 
                'You have completed the entire campaign! You are a true hero.' : 
                'You have broken the shadow curse and saved Karazhan! The sunlight returns to the city. Ready for the next challenge?'}</p>
        `;
        document.getElementById('game-over-message').className = "game-over-message victory-message";
        document.getElementById('game-over-level').textContent = gameState.currentLevel;
        document.getElementById('game-over-location').textContent = `LEVEL ${gameState.currentLevel} COMPLETE`;
        document.getElementById('game-over-paragraph').textContent = gameState.currentParagraph;
        
        // Show/hide appropriate buttons
        document.getElementById('restart-after-game-over').textContent = isFinalLevel ? "PLAY AGAIN" : "RETRY LEVEL";
        
        if (!isFinalLevel) {
            document.getElementById('next-level-btn').style.display = 'block';
            document.getElementById('next-level-btn').textContent = `NEXT LEVEL → (Level ${nextLevel})`;
        } else {
            document.getElementById('next-level-btn').style.display = 'none';
        }
        
        showScreen('game-over-screen');
        updateMainMenuStats();
    }

    function eatProvision() {
        if (gameState.player.provisions > 0) {
            const healAmount = Math.min(4, gameState.player.maxStamina - gameState.player.stamina);
            gameState.player.stamina += healAmount;
            gameState.player.provisions--;
            updateHeaderStats();
            updateInventoryScreen();
            updateMainMenuStats();
            notificationSystem.show("Provision Eaten", `You eat a provision and restore ${healAmount} Stamina.`);
            saveGame();
        } else {
            notificationSystem.show("No Provisions", "You have no provisions left!");
        }
    }

    // ============== INITIALIZATION ==============
    document.addEventListener('DOMContentLoaded', function() {
        // Update main menu stats
        updateMainMenuStats();
        
        // Main menu buttons
        document.getElementById('new-game').addEventListener('click', () => {
            notificationSystem.show("Start New Game", "Are you sure you want to start a new campaign? This will overwrite any existing save.", {
                buttons: [
                    { text: "Yes, Start New", action: "initializeNewGameForLevel(1)" },
                    { text: "Cancel", action: "notificationSystem.closePopup('popup-' + Date.now())" }
                ]
            });
        });
        
        document.getElementById('continue-game').addEventListener('click', () => {
            if (!loadGame()) {
                // If no save exists, start new game
                notificationSystem.show("No Save Found", "No saved game found. Start a new campaign?", {
                    buttons: [
                        { text: "Start New", action: "initializeNewGameForLevel(1)" },
                        { text: "Cancel", action: "notificationSystem.closePopup('popup-' + Date.now())" }
                    ]
                });
            }
        });
        
        document.getElementById('select-level').addEventListener('click', showLevelSelect);
        document.getElementById('campaign-progress').addEventListener('click', showCampaignProgress);
        document.getElementById('rules-btn').addEventListener('click', () => showScreen('rules-screen'));
        
        // Story screen buttons
        document.getElementById('inventory-btn').addEventListener('click', () => {
            updateInventoryScreen();
            showScreen('inventory-screen');
        });
        document.getElementById('market-btn').addEventListener('click', () => {
            updateMarketScreen();
            showScreen('market-screen');
        });
        document.getElementById('save-game').addEventListener('click', saveGame);
        
        // Inventory screen buttons
        document.getElementById('back-from-inventory').addEventListener('click', () => showScreen('story-screen'));
        document.getElementById('eat-provision').addEventListener('click', eatProvision);
        
        // Market screen buttons
        document.getElementById('back-from-market').addEventListener('click', () => showScreen('story-screen'));
        
        // Level select screen buttons
        document.getElementById('back-from-level-select').addEventListener('click', () => showScreen('main-menu'));
        
        // Progress screen buttons
        document.getElementById('back-from-progress').addEventListener('click', () => showScreen('main-menu'));
        
        // Rules screen buttons
        document.getElementById('back-from-rules').addEventListener('click', () => showScreen('main-menu'));
        
        // Combat screen buttons
        document.getElementById('attack-btn').addEventListener('click', combatRound);
        document.getElementById('flee-combat').addEventListener('click', () => {
            notificationSystem.show("Attempting to Flee", "You try to flee from combat...", { timeout: 1000 });
            setTimeout(() => {
                if (Math.random() < 0.5) {
                    // Successful flee
                    document.getElementById('combat-log').innerHTML += '<div>You successfully flee from combat!</div>';
                    notificationSystem.show("Flee Successful", "You successfully flee from combat!");
                    setTimeout(() => showParagraph(200), 1500);
                } else {
                    // Failed flee - enemy gets a free attack
                    document.getElementById('combat-log').innerHTML += '<div>You fail to flee! The enemy attacks!</div>';
                    gameState.player.stamina -= 2;
                    updateHeaderStats();
                    updateMainMenuStats();
                    
                    if (gameState.player.stamina <= 0) {
                        document.getElementById('combat-log').innerHTML += '<div>You have been defeated!</div>';
                        notificationSystem.show("Flee Failed", "You failed to flee and were defeated!");
                        setTimeout(() => endCombat(false), 1500);
                    } else {
                        notificationSystem.show("Flee Failed", "You failed to flee and took 2 damage!");
                    }
                }
            }, 1000);
        });
        
        // Victory continue button
        document.getElementById('victory-continue').addEventListener('click', () => {
            if (gameState.currentCombatVictoryParagraph) {
                showParagraph(gameState.currentCombatVictoryParagraph);
            } else {
                showParagraph(200);
            }
        });
        
        // Next level button
        document.getElementById('next-level-btn').addEventListener('click', goToNextLevel);
        
        // Luck test buttons
        document.getElementById('continue-after-luck').addEventListener('click', () => {
            document.getElementById('luck-test-section').style.display = 'none';
            document.getElementById('choice-list').style.display = 'block';
        });
        
        // Game over buttons
        document.getElementById('restart-after-game-over').addEventListener('click', () => {
            initializeNewGameForLevel(gameState.currentLevel);
        });
        
        document.getElementById('main-menu-after-game-over').addEventListener('click', () => {
            showScreen('main-menu');
            updateMainMenuStats();
        });
        
        // Check if we should auto-load Level 2
        // If coming from Level 1 completion, auto-start Level 2
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('fromLevel1') === 'true') {
            setTimeout(() => {
                notificationSystem.show("Welcome to Level 2", "Congratulations on completing Level 1! Your adventure continues in the City of Shadows...");
                initializeNewGameForLevel(2);
            }, 1000);
        } else {
            // Otherwise, check for existing save
            const saveData = localStorage.getItem('ffCampaignSave');
            if (saveData) {
                try {
                    const saved = JSON.parse(saveData);
                    if (saved.currentLevel === 2) {
                        // Already playing Level 2, load it
                        setTimeout(() => {
                            notificationSystem.show("Welcome Back", "Continuing your adventure in the City of Shadows...");
                            loadGame();
                        }, 1000);
                    }
                } catch (e) {
                    // Error loading, show main menu
                }
            }
            
            // Test the notification system
            setTimeout(() => {
                notificationSystem.show("Welcome to Level 2", "City of Shadows awaits... if you dare enter its perpetual darkness.", { timeout: 3000 });
            }, 1000);
        }
    });
    </script>
</body>
</html>
