<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DreadWood: City of Shadows</title>
    <style>
        /* EXACT SAME STYLE as level1.html */
        body {
            font-family: 'Courier New', monospace;
            background-color: #0a0a2a;
            color: #33ff33;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            border: 2px solid #33ff33;
            background-color: #000;
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #33ff33;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #ff33ff;
            text-shadow: 0 0 5px #ff33ff;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
        }
        
        h2 {
            color: #33ccff;
            border-bottom: 1px solid #33ccff;
            padding-bottom: 5px;
            margin-top: 25px;
        }
        
        .screen {
            display: none;
        }
        
        .active-screen {
            display: block;
        }
        
        .stats-bar {
            background-color: #111133;
            border: 1px solid #33ff33;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-value {
            color: #ffff33;
            font-weight: bold;
        }
        
        .inventory {
            background-color: #111122;
            border: 1px solid #ff33ff;
            padding: 10px;
            margin: 15px 0;
            min-height: 60px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222244;
            border: 1px solid #33ccff;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
        }
        
        .story-text {
            background-color: #111111;
            border: 1px solid #33ff33;
            padding: 15px;
            margin: 20px 0;
            min-height: 150px;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222244;
            color: #33ff33;
            border: 2px solid #33ff33;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333366;
            color: #ffff33;
            border-color: #ffff33;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #330033;
            color: #ff33ff;
            border: 2px solid #ff33ff;
            padding: 10px 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #550055;
            color: #ff99ff;
        }
        
        .dice-roll {
            background-color: #223322;
            border: 1px solid #33ff33;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ffff33;
        }
        
        .game-over {
            color: #ff3333;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #ff3333;
        }
        
        .success {
            color: #33ff33;
            font-weight: bold;
        }
        
        .damage {
            color: #ff3333;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9933;
            font-weight: bold;
        }
        
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #003333;
            color: #33ff99;
            border: 2px solid #33ff99;
            padding: 15px 30px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #005555;
            color: #99ffcc;
        }
        
        .retro-notice {
            text-align: center;
            color: #888888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333333;
            padding-top: 10px;
        }
        
        .warning-dialog {
            background-color: #332222;
            border: 2px solid #ff3333;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .warning-text {
            color: #ff9933;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .dialog-btn {
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid;
        }
        
        .dialog-btn-yes {
            background-color: #223322;
            color: #33ff33;
            border-color: #33ff33;
        }
        
        .dialog-btn-no {
            background-color: #332222;
            color: #ff3333;
            border-color: #ff3333;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 10px;
                font-size: 14px;
            }
            
            .dialog-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DREADWOOD</h1>
            <h2>CITY OF SHADOWS</h2>
            <div class="retro-notice">Level 2 - Your Adventure Continues</div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item">SKILL: <span id="stat-skill" class="stat-value">0</span></div>
                <div class="stat-item">STAMINA: <span id="stat-stamina" class="stat-value">0</span>/<span id="stat-maxstamina" class="stat-value">0</span></div>
                <div class="stat-item">LUCK: <span id="stat-luck" class="stat-value">0</span></div>
                <div class="stat-item">GOLD: <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <h2>INVENTORY</h2>
            <div class="inventory" id="inventory">
                <!-- Inventory will be loaded from saved game -->
            </div>
            
            <h2>THE ADVENTURE</h2>
            <div class="story-text" id="story-text">
                <p>Welcome to the CITY OF SHADOWS. You have successfully crossed the Mountains of Doom and now stand before the ominous gates of this ancient, cursed city. The buildings loom like dark giants against the twilight sky. Your quest continues here...</p>
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <button class="choice-btn" onclick="loadSection(1)">Enter the City Gates</button>
                <button class="choice-btn" onclick="loadSection(2)">Sneak through the Sewers</button>
                <button class="choice-btn" onclick="loadSection(3)">Search for Supplies Outside</button>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useLuck()">TEST LUCK</button>
                <button class="action-btn" onclick="checkInventory()">INVENTORY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="showNewGameWarning()">START NEW GAME</button>
            </div>
        </div>
        
        <!-- Warning Dialog for New Game -->
        <div id="warning-dialog" class="screen">
            <div class="warning-dialog">
                <div class="warning-text">WARNING: Starting a new game will delete ALL your current progress!</div>
                <p>Your current character, stats, inventory, and gold will be permanently erased.</p>
                <p>You will return to the beginning of the game to create a new character.</p>
                <div class="dialog-buttons">
                    <button class="dialog-btn dialog-btn-yes" onclick="startNewGame()">YES, START NEW GAME</button>
                    <button class="dialog-btn dialog-btn-no" onclick="cancelNewGame()">NO, KEEP MY CHARACTER</button>
                </div>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>VICTORY!</h2>
            <div class="story-text">
                <p>You have survived the CITY OF SHADOWS!</p>
                <p>After navigating the treacherous streets and defeating the shadowy guardians, you emerge on the other side of the city. Before you stretches the foul SWAMP OF SORROWS, a mist-shrouded bog that reeks of decay and despair.</p>
                <p>Your journey continues... All your stats, gold, and inventory will carry over to the next chapter.</p>
                <div class="stats-bar">
                    <div class="stat-item">SKILL: <span id="next-stat-skill" class="stat-value">0</span></div>
                    <div class="stat-item">STAMINA: <span id="next-stat-stamina" class="stat-value">0</span></div>
                    <div class="stat-item">LUCK: <span id="next-stat-luck" class="stat-value">0</span></div>
                    <div class="stat-item">GOLD: <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO SWAMP OF SORROWS</button>
            </div>
        </div>
        
        <div class="retro-notice">
            DREADWOOD - A Retro Gamebook Adventure<br>
            Level 2: City of Shadows
        </div>
    </div>

    <script>
        // Game state (loaded from localStorage)
        let gameState = JSON.parse(localStorage.getItem('dreadwoodGameState')) || {
            playerClass: 'warrior',
            skill: 10,
            maxStamina: 18,
            stamina: 18,
            luck: 10,
            gold: 20,
            inventory: ['Dagger', 'Leather Armor'],
            weapons: [{name: 'Dagger', damage: '1d6'}],
            armor: [{name: 'Leather Armor', defense: 1}],
            currentWeaponIndex: 0,
            currentArmorIndex: 0,
            currentSection: 0,
            gameComplete: false
        };
        
        // FIX: ADD COMBAT STATE LIKE IN LEVEL 3 AND 4
        let combatState = {
            active: false,
            enemyName: '',
            enemyStamina: 0,
            enemyCurrentStamina: 0,
            enemySkill: 0,
            nextSection: 0,
            round: 1
        };
        
        // FIX: Reset currentSection when starting a new level
        // Level 1 ends at section 100, so if we're coming from level 1, reset to start of level 2
        if (gameState.currentSection === 100 || gameState.gameComplete) {
            gameState.currentSection = 0;
            gameState.gameComplete = false;
        }
        
        // Ensure indices exist
        if (gameState.currentWeaponIndex === undefined) {
            gameState.currentWeaponIndex = gameState.weapons.length - 1;
        }
        if (gameState.currentArmorIndex === undefined) {
            gameState.currentArmorIndex = gameState.armor.length - 1;
        }
        
        // Level 2 story sections - COMPLETE ADVENTURE
        const storySections = {
            0: {
                text: "Welcome to the CITY OF SHADOWS. You have successfully crossed the Mountains of Doom and now stand before the ominous gates of this ancient, cursed city. The buildings loom like dark giants against the twilight sky. Your quest continues here...",
                choices: [
                    {text: "Enter the City Gates", nextSection: 1, skillCheck: false},
                    {text: "Sneak through the Sewers", nextSection: 2, skillCheck: false},
                    {text: "Search for Supplies Outside", nextSection: 3, skillCheck: false}
                ]
            },
            1: {
                text: "You approach the massive iron gates of the city. Two shadowy guards block your path. 'Halt! None may enter without paying the toll of 10 Gold!' one of them growls.",
                choices: [
                    {text: "Pay the 10 Gold toll", nextSection: 4, skillCheck: false},
                    {text: "Try to intimidate the guards", nextSection: 5, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Attack the guards", nextSection: 6, skillCheck: false}
                ]
            },
            2: {
                text: "You find a sewer entrance near the city walls. The smell is horrific, but it might provide unnoticed access. As you climb down, you hear skittering sounds in the darkness.",
                choices: [
                    {text: "Continue through the sewer", nextSection: 7, skillCheck: false},
                    {text: "Light a torch to see better", nextSection: 8, skillCheck: false},
                    {text: "Go back and try the main gate", nextSection: 1, skillCheck: false}
                ]
            },
            3: {
                text: "You search the area outside the city walls. In an abandoned caravan, you find a locked strongbox and some discarded supplies.",
                choices: [
                    {text: "Try to open the strongbox", nextSection: 9, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Take the supplies and head to the gates", nextSection: 10, skillCheck: false},
                    {text: "Search more thoroughly", nextSection: 11, skillCheck: false}
                ]
            },
            4: {
                text: "You hand over 10 Gold to the guards. They nod grimly and swing open the massive gates. 'Watch your back in there, stranger. The City of Shadows eats the unwary.'",
                choices: [
                    {text: "Enter the city cautiously", nextSection: 12, skillCheck: false},
                    {text: "Ask the guards about the city", nextSection: 13, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 10) {
                        gameState.gold -= 10;
                        updateStatsDisplay();
                        return "You pay 10 Gold and the guards let you pass.";
                    } else {
                        gameState.stamina -= 5;
                        updateStatsDisplay();
                        if (gameState.stamina <= 0) {
                            return "You don't have enough gold! The guards beat you for your insolence. You lose 5 Stamina and are left unconscious outside the gates.";
                        }
                        return "You don't have enough gold! The guards shove you away from the gate. You lose 5 Stamina.";
                    }
                }
            },
            5: {
                text: "You attempt to intimidate the guards...",
                choices: [
                    {text: "Continue", nextSection: 14, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "The guards step back, intimidated by your presence. 'Very well, you may pass. But don't cause trouble.'";
                    } else {
                        gameState.stamina -= 3;
                        updateStatsDisplay();
                        return "The guards laugh at your attempt. 'Think you're tough?' One punches you in the gut. You lose 3 Stamina and they force you to pay 15 Gold to enter.";
                    }
                }
            },
            6: {
                text: "You attack the city guards! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 601, skillCheck: false}
                ]
            },
            601: {
                text: "You face the City Guards! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 602, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for City Guards
                    combatState.active = true;
                    combatState.enemyName = "City Guard";
                    combatState.enemyStamina = 12;
                    combatState.enemyCurrentStamina = 12;
                    combatState.enemySkill = 8;
                    combatState.nextSection = 16;
                    combatState.round = 1;
                    
                    return "City Guard: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            7: {
                text: "You wade through the foul-smelling sewer water. Suddenly, giant rats emerge from the shadows, their eyes glowing red!",
                choices: [
                    {text: "Fight the sewer rats", nextSection: 17, skillCheck: false},
                    {text: "Try to scare them away", nextSection: 18, skillCheck: true, checkType: 'luck', difficulty: 10},
                    {text: "Run deeper into the sewer", nextSection: 19, skillCheck: false}
                ]
            },
            8: {
                text: "You light a torch. The sudden light reveals dozens of giant rats scuttling away from the flame. However, the light also attracts something else... a slithering shape moves in the water ahead.",
                choices: [
                    {text: "Advance cautiously", nextSection: 20, skillCheck: false},
                    {text: "Extinguish the torch and proceed in darkness", nextSection: 7, skillCheck: false},
                    {text: "Return to the surface", nextSection: 1, skillCheck: false}
                ]
            },
            9: {
                text: "You attempt to pick the lock on the strongbox...",
                choices: [
                    {text: "Continue", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.gold += 25;
                        gameState.inventory.push("Silver Key");
                        updateStatsDisplay();
                        updateInventoryDisplay();
                        return "You successfully pick the lock! Inside you find 25 Gold and a mysterious silver key.";
                    } else {
                        return "The lock is too complex. You break your lockpick trying to open it.";
                    }
                }
            },
            10: {
                text: "You take the supplies (a healing potion restoring 4 Stamina) and head toward the city gates.",
                choices: [
                    {text: "Approach the gates", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 4);
                    gameState.inventory.push("Healing Potion");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    return "You drink the healing potion and restore 4 Stamina.";
                }
            },
            11: {
                text: "You search more thoroughly and find a hidden compartment in the caravan floor! Inside is a map of the city sewers and a silver dagger.",
                choices: [
                    {text: "Take the findings and head to the gates", nextSection: 1, skillCheck: false},
                    {text: "Take the findings and try the sewers", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    gameState.weapons.push({name: 'Silver Dagger', damage: '1d6+2'});
                    gameState.inventory.push("Silver Dagger", "Sewer Map");
                    updateInventoryDisplay();
                    return "You find a Silver Dagger (+2 damage against undead) and a sewer map! The dagger is added to your inventory.";
                }
            },
            12: {
                text: "You enter the city cautiously. The streets are narrow and winding, with buildings looming overhead. You hear strange whispers in the shadows. Ahead, you see three distinct paths.",
                choices: [
                    {text: "Follow the main street toward the market", nextSection: 22, skillCheck: false},
                    {text: "Take a side alley that seems less traveled", nextSection: 23, skillCheck: false},
                    {text: "Look for an inn or tavern to gather information", nextSection: 24, skillCheck: false}
                ]
            },
            13: {
                text: "'What should I know about this city?' you ask the guards. The older one sighs. 'Avoid the Temple District after dark. Don't trust the merchants in the market. And whatever you do, stay out of the catacombs.'",
                choices: [
                    {text: "Thank them and enter", nextSection: 12, skillCheck: false},
                    {text: "Ask about the catacombs", nextSection: 25, skillCheck: false}
                ]
            },
            14: {
                text: window.checkResult ? 
                    "The guards let you pass without paying. You enter the City of Shadows." : 
                    "The guards take 15 Gold from you and let you pass, still laughing at your failed intimidation.",
                choices: [
                    {text: "Continue into the city", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult && gameState.gold >= 15) {
                        gameState.gold -= 15;
                        updateStatsDisplay();
                    }
                }
            },
            15: {
                text: "", // Will be filled by combat results
                choices: [
                    {text: "Continue into the city", nextSection: 12, skillCheck: false}
                ]
            },
            16: {
                text: "After defeating the guards, you enter the city.",
                choices: [
                    {text: "Continue into the city", nextSection: 12, skillCheck: false}
                ]
            },
            17: {
                text: "You draw your weapon to fight the giant rats! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 1701, skillCheck: false}
                ]
            },
            1701: {
                text: "You face the Giant Rats! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 1702, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for Giant Rats
                    combatState.active = true;
                    combatState.enemyName = "Giant Rats";
                    combatState.enemyStamina = 8;
                    combatState.enemyCurrentStamina = 8;
                    combatState.enemySkill = 6;
                    combatState.nextSection = 27;
                    combatState.round = 1;
                    
                    return "Giant Rats: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            18: {
                text: "You attempt to scare the rats away with a show of force...",
                choices: [
                    {text: "Continue", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "The rats scatter in fear! You continue through the sewers unharmed.";
                    } else {
                        gameState.stamina -= 4;
                        updateStatsDisplay();
                        return "The rats aren't scared! They swarm you, biting and scratching. You lose 4 Stamina fighting them off.";
                    }
                }
            },
            19: {
                text: "You run deeper into the sewer, splashing through the filthy water. You come to a junction with three pipes leading in different directions.",
                choices: [
                    {text: "Take the left pipe", nextSection: 29, skillCheck: false},
                    {text: "Take the center pipe", nextSection: 30, skillCheck: false},
                    {text: "Take the right pipe", nextSection: 31, skillCheck: false}
                ]
            },
            20: {
                text: "You advance cautiously with your torch held high. The slithering shape resolves into a massive sewer serpent! It hisses and coils to strike.",
                choices: [
                    {text: "Fight the sewer serpent", nextSection: 32, skillCheck: false},
                    {text: "Throw the torch at it and run", nextSection: 33, skillCheck: false},
                    {text: "Try to sneak past it", nextSection: 34, skillCheck: true, checkType: 'skill', difficulty: 13}
                ]
            },
            21: {
                text: window.checkResult ? 
                    "With the silver key in hand, you head toward the city entrance." : 
                    "Frustrated, you leave the strongbox and head toward the city entrance.",
                choices: [
                    {text: "Go to the city gates", nextSection: 1, skillCheck: false}
                ]
            },
            22: {
                text: "You follow the main street into a bustling market. Strange creatures and shadowy figures trade exotic goods. A hooded merchant beckons you toward his stall.",
                choices: [
                    {text: "Approach the merchant", nextSection: 35, skillCheck: false},
                    {text: "Browse other stalls", nextSection: 36, skillCheck: false},
                    {text: "Leave the market quickly", nextSection: 37, skillCheck: false}
                ]
            },
            23: {
                text: "The side alley is dark and quiet. You notice a faint glowing symbol on a door. It looks like it could be a secret entrance to something important.",
                choices: [
                    {text: "Investigate the glowing symbol", nextSection: 38, skillCheck: true, checkType: 'luck', difficulty: 11},
                    {text: "Continue down the alley", nextSection: 39, skillCheck: false},
                    {text: "Return to the main street", nextSection: 22, skillCheck: false}
                ]
            },
            24: {
                text: "You find a tavern called 'The Shadowed Flagon'. Inside, shadowy figures drink silently. The bartender looks up as you enter.",
                choices: [
                    {text: "Order a drink and listen for rumors", nextSection: 40, skillCheck: false},
                    {text: "Ask the bartender about the city", nextSection: 41, skillCheck: false},
                    {text: "Challenge someone to a game of dice", nextSection: 42, skillCheck: false}
                ]
            },
            25: {
                text: "'The catacombs?' The guard shudders. 'They say the original inhabitants are buried there... and they don't like visitors. Many have entered, few return.'",
                choices: [
                    {text: "Enter the city", nextSection: 12, skillCheck: false},
                    {text: "Ask how to find the catacombs", nextSection: 43, skillCheck: false}
                ]
            },
            26: {
                text: "", // Combat results
                choices: [
                    {text: "Continue through the sewer", nextSection: 44, skillCheck: false}
                ]
            },
            27: {
                text: "After dealing with the rats, you find a small niche in the sewer wall containing a watertight chest!",
                choices: [
                    {text: "Open the chest", nextSection: 45, skillCheck: false},
                    {text: "Leave it and continue", nextSection: 44, skillCheck: false}
                ]
            },
            28: {
                text: window.checkResult ? 
                    "The rats scatter and you continue through the sewers." : 
                    "You fight off the rats and continue, wounded.",
                choices: [
                    {text: "Continue through the sewer", nextSection: 44, skillCheck: false}
                ]
            },
            29: {
                text: "The left pipe leads to a dead end with a rusted ladder going up. You climb it and emerge in an abandoned courtyard within the city walls.",
                choices: [
                    {text: "Explore the courtyard", nextSection: 46, skillCheck: false},
                    {text: "Head into the city streets", nextSection: 12, skillCheck: false}
                ]
            },
            30: {
                text: "The center pipe leads you to an underground chamber with strange glowing fungi. In the center sits a stone chest.",
                choices: [
                    {text: "Open the stone chest", nextSection: 47, skillCheck: false},
                    {text: "Take some glowing fungi", nextSection: 48, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 49, skillCheck: false}
                ]
            },
            31: {
                text: "The right pipe spills you out into a fast-flowing channel. You're swept along and dumped into a murky pool within the city.",
                choices: [
                    {text: "Swim to the surface", nextSection: 50, skillCheck: false}
                ]
            },
            32: {
                text: "You face the massive sewer serpent! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 3201, skillCheck: false}
                ]
            },
            3201: {
                text: "You face the Sewer Serpent! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 3202, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for Sewer Serpent
                    combatState.active = true;
                    combatState.enemyName = "Sewer Serpent";
                    combatState.enemyStamina = 15;
                    combatState.enemyCurrentStamina = 15;
                    combatState.enemySkill = 10;
                    combatState.nextSection = 52;
                    combatState.round = 1;
                    
                    return "Sewer Serpent: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            33: {
                text: "You throw your torch at the serpent and run! The creature thrashes in surprise. You escape down a side passage, but now you're in complete darkness.",
                choices: [
                    {text: "Feel your way forward", nextSection: 53, skillCheck: true, checkType: 'luck', difficulty: 9},
                    {text: "Try to relight a torch", nextSection: 54, skillCheck: false}
                ]
            },
            34: {
                text: "You attempt to sneak past the serpent...",
                choices: [
                    {text: "Continue", nextSection: 55, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        return "You successfully sneak past the serpent! You continue through the sewers.";
                    } else {
                        gameState.stamina -= 6;
                        updateStatsDisplay();
                        return "The serpent spots you and strikes! You lose 6 Stamina from its venomous bite.";
                    }
                }
            },
            35: {
                text: "'Interested in rare items, traveler?' the merchant whispers. 'I have a potion of invisibility for 30 Gold, or a scroll of teleportation for 50 Gold.'",
                choices: [
                    {text: "Buy the invisibility potion (30 Gold)", nextSection: 56, skillCheck: false},
                    {text: "Buy the teleportation scroll (50 Gold)", nextSection: 57, skillCheck: false},
                    {text: "Browse other items", nextSection: 58, skillCheck: false},
                    {text: "Leave the stall", nextSection: 36, skillCheck: false}
                ]
            },
            36: {
                text: "You browse other stalls. One sells exotic weapons, another strange artifacts. At the end of the row, you see a crowd gathered around a notice board.",
                choices: [
                    {text: "Check the notice board", nextSection: 59, skillCheck: false},
                    {text: "Return to the merchant", nextSection: 35, skillCheck: false},
                    {text: "Leave the market", nextSection: 37, skillCheck: false}
                ]
            },
            37: {
                text: "You leave the market and find yourself in a residential district. The houses here are dark and silent. At the end of the street, you see the city's central tower.",
                choices: [
                    {text: "Approach the central tower", nextSection: 60, skillCheck: false},
                    {text: "Knock on a door to ask for directions", nextSection: 61, skillCheck: false},
                    {text: "Look for the city exit", nextSection: 62, skillCheck: false}
                ]
            },
            38: {
                text: window.checkResult ? 
                    "The glowing symbol responds to your touch! The door slides open silently, revealing a hidden temple." : 
                    "The symbol flickers but nothing happens. It seems you need a specific key or knowledge to open it.",
                choices: [
                    window.checkResult ? 
                        {text: "Enter the hidden temple", nextSection: 63, skillCheck: false} :
                        {text: "Continue down the alley", nextSection: 39, skillCheck: false}
                ]
            },
            39: {
                text: "The alley ends at a high wall. You notice a shadowy figure watching you from a rooftop.",
                choices: [
                    {text: "Confront the watcher", nextSection: 64, skillCheck: false},
                    {text: "Try to climb the wall", nextSection: 65, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Return the way you came", nextSection: 23, skillCheck: false}
                ]
            },
            40: {
                text: "You order a drink and listen to conversations around you. You overhear talk of 'the Shadow King' who rules the city from the central tower, and whispers of a rebellion brewing in the catacombs.",
                choices: [
                    {text: "Ask the bartender about the Shadow King", nextSection: 66, skillCheck: false},
                    {text: "Look for rebels in the tavern", nextSection: 67, skillCheck: false},
                    {text: "Leave the tavern", nextSection: 37, skillCheck: false}
                ]
            },
            41: {
                text: "'The City of Shadows has stood for a thousand years,' the bartender says. 'We live under the Shadow King's rule. Some say he's immortal. Others say he's a lich. Best not to ask too many questions.'",
                choices: [
                    {text: "Ask how to leave the city", nextSection: 68, skillCheck: false},
                    {text: "Order a drink", nextSection: 40, skillCheck: false},
                    {text: "Leave", nextSection: 37, skillCheck: false}
                ]
            },
            42: {
                text: "You challenge a shadowy figure to a game of dice. 'Five Gold per roll,' he says, his voice like gravel.",
                choices: [
                    {text: "Accept the game", nextSection: 69, skillCheck: false},
                    {text: "Decline and leave", nextSection: 40, skillCheck: false}
                ]
            },
            43: {
                text: "'The catacombs entrance is beneath the central tower,' the guard says nervously. 'But you'd be a fool to go there. The Shadow King's guards patrol it constantly.'",
                choices: [
                    {text: "Enter the city", nextSection: 12, skillCheck: false}
                ]
            },
            44: {
                text: "You continue through the sewers and eventually find a ladder leading up to a street grate. You emerge in the city streets, covered in filth but alive.",
                choices: [
                    {text: "Explore the city", nextSection: 12, skillCheck: false}
                ]
            },
            45: {
                text: "You open the chest and find a beautifully crafted short sword that gleams with a faint blue light, along with 40 Gold coins!",
                choices: [
                    {text: "Take the treasure and continue", nextSection: 44, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 40;
                    gameState.weapons.push({name: 'Moonlight Blade', damage: '2d6'});
                    gameState.inventory.push("Moonlight Blade");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    return "You find a Moonlight Blade (2d6 damage) and 40 Gold! The blade is added to your inventory.";
                }
            },
            46: {
                text: "The courtyard contains a dried-up fountain with a statue of a weeping angel. At the base of the statue, you find a small silver locket.",
                choices: [
                    {text: "Take the locket", nextSection: 70, skillCheck: false},
                    {text: "Leave it and enter the city", nextSection: 12, skillCheck: false}
                ]
            },
            47: {
                text: "You open the stone chest. Inside is a set of dark leather armor that seems to absorb the light around it.",
                choices: [
                    {text: "Take the shadow armor", nextSection: 71, skillCheck: false},
                    {text: "Leave it", nextSection: 49, skillCheck: false}
                ]
            },
            48: {
                text: "You collect some of the glowing fungi. They pulse with a soft blue light in your hand.",
                choices: [
                    {text: "Eat some fungi", nextSection: 72, skillCheck: false},
                    {text: "Keep them for later", nextSection: 73, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 49, skillCheck: false}
                ]
            },
            49: {
                text: "You leave the chamber and find another ladder leading up. You emerge in the city near the market district.",
                choices: [
                    {text: "Go to the market", nextSection: 22, skillCheck: false}
                ]
            },
            50: {
                text: "You swim to the surface and pull yourself out of the water, finding yourself in a public bathhouse that's long been abandoned. A door leads to the city streets.",
                choices: [
                    {text: "Enter the city", nextSection: 12, skillCheck: false}
                ]
            },
            51: {
                text: "", // Combat results
                choices: [
                    {text: "Continue through the sewer", nextSection: 74, skillCheck: false}
                ]
            },
            52: {
                text: "After defeating the serpent, you notice it was guarding a niche in the wall. Inside is a crystal that glows with inner light.",
                choices: [
                    {text: "Take the crystal", nextSection: 75, skillCheck: false},
                    {text: "Leave it and continue", nextSection: 74, skillCheck: false}
                ]
            },
            53: {
                text: window.checkResult ? 
                    "You feel your way carefully and find a ladder leading up. You emerge in the city safely." : 
                    "You stumble in the darkness and fall into a deep pit! You take 8 damage.",
                choices: [
                    window.checkResult ? 
                        {text: "Enter the city", nextSection: 12, skillCheck: false} :
                        {text: "Try to climb out", nextSection: 76, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult) {
                        gameState.stamina -= 8;
                        updateStatsDisplay();
                        if (gameState.stamina <= 0) {
                            return "You fall to your death in the pit. Game Over.";
                        }
                    }
                }
            },
            54: {
                text: "You try to relight a torch, but your flint is wet. You'll have to proceed in darkness.",
                choices: [
                    {text: "Feel your way forward", nextSection: 53, skillCheck: true, checkType: 'luck', difficulty: 9}
                ]
            },
            55: {
                text: window.checkResult ? 
                    "You sneak past the serpent and find your way to a ladder leading up to the city." : 
                    "You escape the serpent's bite and find a ladder leading up.",
                choices: [
                    {text: "Climb to the city", nextSection: 12, skillCheck: false}
                ]
            },
            56: {
                text: gameState.gold >= 30 ? 
                    "You buy the invisibility potion for 30 Gold. 'Use it wisely,' the merchant says with a wink." : 
                    "You don't have enough gold for the potion.",
                choices: [
                    {text: "Browse other items", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 30) {
                        gameState.gold -= 30;
                        gameState.inventory.push("Invisibility Potion");
                        updateStatsDisplay();
                        updateInventoryDisplay();
                        return "You purchase an Invisibility Potion.";
                    }
                }
            },
            57: {
                text: gameState.gold >= 50 ? 
                    "You buy the teleportation scroll for 50 Gold. 'This will take you anywhere in the city once,' the merchant explains." : 
                    "You don't have enough gold for the scroll.",
                choices: [
                    {text: "Browse other items", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 50) {
                        gameState.gold -= 50;
                        gameState.inventory.push("Teleportation Scroll");
                        updateStatsDisplay();
                        updateInventoryDisplay();
                        return "You purchase a Teleportation Scroll.";
                    }
                }
            },
            58: {
                text: "The merchant shows you more items: a healing salve (10 Gold), a luck charm (20 Gold), and a map of the city's secret passages (15 Gold).",
                choices: [
                    {text: "Buy healing salve (10 Gold)", nextSection: 77, skillCheck: false},
                    {text: "Buy luck charm (20 Gold)", nextSection: 78, skillCheck: false},
                    {text: "Buy secret map (15 Gold)", nextSection: 79, skillCheck: false},
                    {text: "Leave the stall", nextSection: 36, skillCheck: false}
                ]
            },
            59: {
                text: "The notice board has several postings. One catches your eye: 'Wanted: Brave souls to investigate the catacombs. Reward: 100 Gold.' Another says: 'Seeking escort through the Swamp of Sorrows. Pay negotiable.'",
                choices: [
                    {text: "Take the catacombs job", nextSection: 80, skillCheck: false},
                    {text: "Take the swamp escort job", nextSection: 81, skillCheck: false},
                    {text: "Ignore the notices", nextSection: 36, skillCheck: false}
                ]
            },
            60: {
                text: "You approach the central tower. Two elite guards in black armor block the entrance. 'The Shadow King sees no one without an appointment,' one says coldly.",
                choices: [
                    {text: "Try to convince them to let you in", nextSection: 82, skillCheck: true, checkType: 'luck', difficulty: 14},
                    {text: "Attack the guards", nextSection: 83, skillCheck: false},
                    {text: "Leave and find another way", nextSection: 84, skillCheck: false}
                ]
            },
            61: {
                text: "You knock on a door. It creaks open slightly, and a pale face peers out. 'What do you want?' a voice whispers.",
                choices: [
                    {text: "Ask for directions out of the city", nextSection: 85, skillCheck: false},
                    {text: "Ask about the Shadow King", nextSection: 86, skillCheck: false},
                    {text: "Apologize and leave", nextSection: 37, skillCheck: false}
                ]
            },
            62: {
                text: "You look for the city's exit and find the western gate. It's heavily guarded, but appears to be the way out to the Swamp of Sorrows.",
                choices: [
                    {text: "Approach the guards", nextSection: 87, skillCheck: false},
                    {text: "Look for another way out", nextSection: 88, skillCheck: false},
                    {text: "Return to the city center", nextSection: 37, skillCheck: false}
                ]
            },
            63: {
                text: "You enter the hidden temple. Inside, you find rebels planning against the Shadow King! Their leader approaches you.",
                choices: [
                    {text: "Join the rebellion", nextSection: 89, skillCheck: false},
                    {text: "Pretend to be lost and leave", nextSection: 90, skillCheck: false},
                    {text: "Attack the rebels", nextSection: 91, skillCheck: false}
                ]
            },
            64: {
                text: "'You're not from here,' the watcher says from the rooftop. 'The Shadow King has eyes everywhere. If you value your life, leave this city.'",
                choices: [
                    {text: "Ask who they are", nextSection: 92, skillCheck: false},
                    {text: "Demand information", nextSection: 93, skillCheck: false},
                    {text: "Attack the watcher", nextSection: 94, skillCheck: false}
                ]
            },
            65: {
                text: window.checkResult ? 
                    "You scale the wall easily and find yourself on the roof next to the watcher." : 
                    "You slip and fall, taking 5 damage.",
                choices: [
                    window.checkResult ? 
                        {text: "Confront the watcher", nextSection: 64, skillCheck: false} :
                        {text: "Give up and return", nextSection: 39, skillCheck: false}
                ],
                action: function() {
                    if (!window.checkResult) {
                        gameState.stamina -= 5;
                        updateStatsDisplay();
                    }
                }
            },
            66: {
                text: "'The Shadow King?' The bartender looks around nervously. 'He rules from the central tower. They say he can see through shadows, hear whispers in the dark. Best not to speak of him here.'",
                choices: [
                    {text: "Ask about leaving the city", nextSection: 68, skillCheck: false},
                    {text: "Return to your drink", nextSection: 40, skillCheck: false}
                ]
            },
            67: {
                text: "You discreetly look for rebels. In a dark corner, you notice three figures speaking in hushed tones. One catches your eye and motions you over.",
                choices: [
                    {text: "Approach the figures", nextSection: 95, skillCheck: false},
                    {text: "Ignore them", nextSection: 40, skillCheck: false}
                ]
            },
            68: {
                text: "'To leave the city, you need exit papers from the tower,' the bartender says. 'Or you could try the western gate at midnight when the guards change. But that's dangerous.'",
                choices: [
                    {text: "Thank him and leave", nextSection: 37, skillCheck: false},
                    {text: "Ask about the catacombs", nextSection: 96, skillCheck: false}
                ]
            },
            69: {
                text: "You play three rounds of dice with the shadowy figure...",
                choices: [
                    {text: "Continue", nextSection: 97, skillCheck: false}
                ],
                action: function() {
                    let result = "You play three rounds:\n";
                    let totalWon = 0;
                    
                    for (let i = 0; i < 3; i++) {
                        const playerRoll = rollDiceHelper(2, 6);
                        const opponentRoll = rollDiceHelper(2, 6);
                        
                        if (playerRoll > opponentRoll) {
                            gameState.gold += 5;
                            totalWon += 5;
                            result += `Round ${i+1}: You win 5 Gold! (${playerRoll} vs ${opponentRoll})\n`;
                        } else {
                            gameState.gold -= 5;
                            totalWon -= 5;
                            result += `Round ${i+1}: You lose 5 Gold. (${playerRoll} vs ${opponentRoll})\n`;
                        }
                    }
                    
                    updateStatsDisplay();
                    
                    if (totalWon > 0) {
                        result += `\nYou won ${totalWon} Gold total!`;
                    } else if (totalWon < 0) {
                        result += `\nYou lost ${Math.abs(totalWon)} Gold total.`;
                    } else {
                        result += `\nYou broke even.`;
                    }
                    
                    return result;
                }
            },
            70: {
                text: "You open the locket. Inside is a portrait of a beautiful woman and a lock of silver hair. The locket feels warm in your hand.",
                choices: [
                    {text: "Keep the locket and enter the city", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Silver Locket");
                    gameState.luck += 1;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                    return "You take the silver locket. It seems to bring you luck! Your Luck increases by 1.";
                }
            },
            71: {
                text: "You put on the shadow armor. It fits perfectly and seems to make you blend with the darkness.",
                choices: [
                    {text: "Leave the chamber", nextSection: 49, skillCheck: false}
                ],
                action: function() {
                    gameState.armor.push({name: 'Shadow Armor', defense: 3});
                    gameState.currentArmorIndex = gameState.armor.length - 1;
                    updateInventoryDisplay();
                    return "You equip the Shadow Armor (3 DEF). It provides excellent protection and helps you move silently.";
                }
            },
            72: {
                text: "You eat some of the glowing fungi. Immediately, you feel strange - your vision sharpens but your head spins.",
                choices: [
                    {text: "Continue", nextSection: 98, skillCheck: false}
                ],
                action: function() {
                    const effect = rollDiceHelper(1, 6);
                    if (effect <= 3) {
                        gameState.stamina -= 5;
                        updateStatsDisplay();
                        return "The fungi are poisonous! You lose 5 Stamina.";
                    } else {
                        gameState.skill += 1;
                        updateStatsDisplay();
                        return "The fungi have a strange beneficial effect! Your Skill increases by 1.";
                    }
                }
            },
            73: {
                text: "You pocket the glowing fungi for later use.",
                choices: [
                    {text: "Leave the chamber", nextSection: 49, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Glowing Fungi");
                    updateInventoryDisplay();
                    return "You take the glowing fungi. They might be useful later.";
                }
            },
            74: {
                text: "You continue through the sewer and find a ladder leading up to the city streets near the western gate.",
                choices: [
                    {text: "Climb to the city", nextSection: 62, skillCheck: false}
                ]
            },
            75: {
                text: "You take the glowing crystal. It pulses with a warm, comforting light.",
                choices: [
                    {text: "Continue", nextSection: 74, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Glowing Crystal");
                    updateInventoryDisplay();
                    return "You take the glowing crystal. It seems to repel darkness.";
                }
            },
            76: {
                text: "You manage to climb out of the pit, battered but alive. You find a ladder leading up to the city.",
                choices: [
                    {text: "Climb to the city", nextSection: 12, skillCheck: false}
                ]
            },
            77: {
                text: gameState.gold >= 10 ? 
                    "You buy the healing salve for 10 Gold. It can restore 6 Stamina when used." : 
                    "You don't have enough gold.",
                choices: [
                    {text: "Browse other items", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 10) {
                        gameState.gold -= 10;
                        gameState.inventory.push("Healing Salve");
                        updateStatsDisplay();
                        updateInventoryDisplay();
                        return "You purchase a Healing Salve.";
                    }
                }
            },
            78: {
                text: gameState.gold >= 20 ? 
                    "You buy the luck charm for 20 Gold. 'This will bring you fortune,' the merchant says." : 
                    "You don't have enough gold.",
                choices: [
                    {text: "Browse other items", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 20) {
                        gameState.gold -= 20;
                        gameState.luck += 2;
                        updateStatsDisplay();
                        updateInventoryDisplay();
                        return "You purchase a Luck Charm. Your Luck increases by 2!";
                    }
                }
            },
            79: {
                text: gameState.gold >= 15 ? 
                    "You buy the secret map for 15 Gold. It shows hidden passages throughout the city." : 
                    "You don't have enough gold.",
                choices: [
                    {text: "Browse other items", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 15) {
                        gameState.gold -= 15;
                        gameState.inventory.push("Secret City Map");
                        updateStatsDisplay();
                        updateInventoryDisplay();
                        return "You purchase a Secret City Map.";
                    }
                }
            },
            80: {
                text: "You take the catacombs job notice. The instructions say to meet at the central tower at midnight.",
                choices: [
                    {text: "Go to the central tower", nextSection: 99, skillCheck: false},
                    {text: "Forget the job and continue", nextSection: 36, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Catacombs Job Notice");
                    updateInventoryDisplay();
                    return "You take the catacombs job notice. Reward: 100 Gold.";
                }
            },
            81: {
                text: "You take the swamp escort job notice. It says to meet at the western gate at dawn.",
                choices: [
                    {text: "Go to the western gate", nextSection: 100, skillCheck: false},
                    {text: "Forget the job and continue", nextSection: 36, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Swamp Escort Job");
                    updateInventoryDisplay();
                    return "You take the swamp escort job. Pay is negotiable.";
                }
            },
            82: {
                text: window.checkResult ? 
                    "The guards look at each other, then nod. 'The Shadow King will see you. Follow me.'" : 
                    "The guards shake their heads. 'No appointment, no entry.'",
                choices: [
                    window.checkResult ? 
                        {text: "Follow the guard", nextSection: 101, skillCheck: false} :
                        {text: "Leave", nextSection: 84, skillCheck: false}
                ]
            },
            83: {
                text: "You attack the elite guards! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 8301, skillCheck: false}
                ]
            },
            8301: {
                text: "You face the Elite Tower Guards! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 8302, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for Elite Tower Guards
                    combatState.active = true;
                    combatState.enemyName = "Elite Tower Guards";
                    combatState.enemyStamina = 20;
                    combatState.enemyCurrentStamina = 20;
                    combatState.enemySkill = 12;
                    combatState.nextSection = 103;
                    combatState.round = 1;
                    
                    return "Elite Tower Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            84: {
                text: "You decide to find another way through the city. Perhaps the western gate is your best option.",
                choices: [
                    {text: "Go to the western gate", nextSection: 62, skillCheck: false}
                ]
            },
            85: {
                text: "'The western gate leads to the Swamp of Sorrows,' the voice whispers. 'But you'll need exit papers or... alternative methods.' The door starts to close.",
                choices: [
                    {text: "Ask about alternative methods", nextSection: 104, skillCheck: false},
                    {text: "Thank them and leave", nextSection: 37, skillCheck: false}
                ]
            },
            86: {
                text: "The door slams shut. 'We don't speak of him here!' the voice shouts from behind the door.",
                choices: [
                    {text: "Leave", nextSection: 37, skillCheck: false}
                ]
            },
            87: {
                text: "You approach the guards at the western gate. 'Exit papers?' one asks sternly.",
                choices: [
                    {text: "Show exit papers (if you have them)", nextSection: 105, skillCheck: false},
                    {text: "Try to bribe the guards", nextSection: 106, skillCheck: false},
                    {text: "Attack the guards", nextSection: 107, skillCheck: false},
                    {text: "Leave and find another way", nextSection: 88, skillCheck: false}
                ]
            },
            88: {
                text: "You look for another way out and find a forgotten postern gate in the city wall. It's old and rusted, but might be forced open.",
                choices: [
                    {text: "Try to force the gate open", nextSection: 108, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Return to the main gate", nextSection: 87, skillCheck: false}
                ]
            },
            89: {
                text: "'Welcome, friend,' the rebel leader says. 'We fight to free this city from the Shadow King's tyranny. Will you help us?'",
                choices: [
                    {text: "Join their cause", nextSection: 109, skillCheck: false},
                    {text: "Ask for help leaving the city", nextSection: 110, skillCheck: false},
                    {text: "Decline and leave", nextSection: 90, skillCheck: false}
                ]
            },
            90: {
                text: "'Sorry, wrong door,' you say, backing out slowly. The rebels watch you warily but let you leave.",
                choices: [
                    {text: "Return to the alley", nextSection: 39, skillCheck: false}
                ]
            },
            91: {
                text: "You attack the rebels! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 9101, skillCheck: false}
                ]
            },
            9101: {
                text: "You face the Rebel Fighters! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 9102, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for Rebel Fighters
                    combatState.active = true;
                    combatState.enemyName = "Rebel Fighters";
                    combatState.enemyStamina = 18;
                    combatState.enemyCurrentStamina = 18;
                    combatState.enemySkill = 9;
                    combatState.nextSection = 112;
                    combatState.round = 1;
                    
                    return "Rebel Fighters: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            92: {
                text: "'I am a watcher. I observe. I remember. The Shadow King would have me killed if he knew I spoke to you.'",
                choices: [
                    {text: "Ask how to leave the city", nextSection: 113, skillCheck: false},
                    {text: "Ask about the Shadow King", nextSection: 114, skillCheck: false},
                    {text: "Attack the watcher", nextSection: 94, skillCheck: false}
                ]
            },
            93: {
                text: "'You demand nothing here,' the watcher says coldly. 'Leave now, or I'll alert the guards.'",
                choices: [
                    {text: "Back down", nextSection: 39, skillCheck: false},
                    {text: "Attack anyway", nextSection: 94, skillCheck: false}
                ]
            },
            94: {
                text: "You attack the watcher! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 9401, skillCheck: false}
                ]
            },
            9401: {
                text: "You face the Mysterious Watcher! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 9402, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for Mysterious Watcher
                    combatState.active = true;
                    combatState.enemyName = "Mysterious Watcher";
                    combatState.enemyStamina = 14;
                    combatState.enemyCurrentStamina = 14;
                    combatState.enemySkill = 11;
                    combatState.nextSection = 116;
                    combatState.round = 1;
                    
                    return "Mysterious Watcher: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            95: {
                text: "'You look like someone who doesn't belong here,' the figure says. 'We can help you leave the city... for a price.'",
                choices: [
                    {text: "Ask about the price", nextSection: 117, skillCheck: false},
                    {text: "Decline and leave", nextSection: 40, skillCheck: false}
                ]
            },
            96: {
                text: "'The catacombs?' The bartender pales. 'Only fools and the desperate go there. They say the original shadow creatures still dwell there, waiting.'",
                choices: [
                    {text: "Thank him and leave", nextSection: 37, skillCheck: false}
                ]
            },
            97: {
                text: "After the dice game, the shadowy figure nods. 'You have spirit, outsider. Good luck in the City of Shadows.'",
                choices: [
                    {text: "Return to drinking", nextSection: 40, skillCheck: false}
                ]
            },
            98: {
                text: "The effects of the fungi wear off. You need to find your way out of the sewers.",
                choices: [
                    {text: "Continue", nextSection: 49, skillCheck: false}
                ]
            },
            99: {
                text: "You wait until midnight and approach the central tower. A hooded figure meets you. 'You're here for the catacombs job? Follow me.'",
                choices: [
                    {text: "Follow the figure", nextSection: 118, skillCheck: false},
                    {text: "Change your mind and leave", nextSection: 119, skillCheck: false}
                ]
            },
            100: {
                text: "At dawn, you meet a nervous merchant at the western gate. 'Thank the shadows you came! I need protection through the Swamp of Sorrows. I'll pay 50 Gold.'",
                choices: [
                    {text: "Accept the job", nextSection: 120, skillCheck: false},
                    {text: "Negotiate for more pay", nextSection: 121, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Decline the job", nextSection: 122, skillCheck: false}
                ]
            },
            101: {
                text: "You're led through dark corridors to a throne room. On a shadow-wreathed throne sits the Shadow King. 'Why have you come to my city?' he asks, his voice echoing.",
                choices: [
                    {text: "Ask permission to leave the city", nextSection: 123, skillCheck: false},
                    {text: "Challenge the Shadow King", nextSection: 124, skillCheck: false},
                    {text: "Ask about the city's history", nextSection: 125, skillCheck: false}
                ]
            },
            102: {
                text: "", // Combat results
                choices: [
                    {text: "Enter the tower", nextSection: 126, skillCheck: false}
                ]
            },
            103: {
                text: "After defeating the guards, you enter the central tower. The door swings shut behind you.",
                choices: [
                    {text: "Explore the tower", nextSection: 127, skillCheck: false}
                ]
            },
            104: {
                text: "'There are tunnels beneath the city... old ways out. But they're dangerous.' The door closes completely.",
                choices: [
                    {text: "Look for the tunnels", nextSection: 128, skillCheck: false},
                    {text: "Try the main gate", nextSection: 87, skillCheck: false}
                ]
            },
            105: {
                text: "If you had exit papers, you could show them here. But you don't have any.",
                choices: [
                    {text: "Try another approach", nextSection: 87, skillCheck: false}
                ],
                action: function() {
                    // Check if player has exit papers in inventory
                    const hasPapers = gameState.inventory.includes("Exit Papers");
                    if (hasPapers) {
                        gameState.currentSection = 200; // This would be the victory section
                        loadSection(200);
                        return "You show your exit papers. The guards examine them and nod. 'You may pass.' The gates swing open, revealing the path to the Swamp of Sorrows.";
                    } else {
                        return "You don't have any exit papers to show.";
                    }
                }
            },
            106: {
                text: "'A bribe, eh?' The guard smiles. '50 Gold might make us forget we ever saw you.'",
                choices: [
                    {text: "Pay 50 Gold", nextSection: 129, skillCheck: false},
                    {text: "Refuse and try another approach", nextSection: 87, skillCheck: false}
                ]
            },
            107: {
                text: "You attack the gate guards! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 10701, skillCheck: false}
                ]
            },
            10701: {
                text: "You face the Gate Guards! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 10702, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for Gate Guards
                    combatState.active = true;
                    combatState.enemyName = "Gate Guards";
                    combatState.enemyStamina = 16;
                    combatState.enemyCurrentStamina = 16;
                    combatState.enemySkill = 10;
                    combatState.nextSection = 131;
                    combatState.round = 1;
                    
                    return "Gate Guards: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            108: {
                text: window.checkResult ? 
                    "You force the rusted gate open! It leads outside the city walls to the Swamp of Sorrows." : 
                    "The gate won't budge. It's sealed shut with ancient magic.",
                choices: [
                    window.checkResult ? 
                        {text: "Exit the city", nextSection: 200, skillCheck: false} :
                        {text: "Return to the main gate", nextSection: 87, skillCheck: false}
                ]
            },
            109: {
                text: "'Excellent!' the rebel leader says. 'Our plan is to plant explosives in the catacombs beneath the tower. Will you help?'",
                choices: [
                    {text: "Help with the explosives", nextSection: 132, skillCheck: false},
                    {text: "Ask for something in return", nextSection: 133, skillCheck: false},
                    {text: "Change your mind", nextSection: 90, skillCheck: false}
                ]
            },
            110: {
                text: "'Help you leave? We can get you exit papers... if you do something for us first.'",
                choices: [
                    {text: "Ask what they want", nextSection: 134, skillCheck: false},
                    {text: "Leave", nextSection: 90, skillCheck: false}
                ]
            },
            111: {
                text: "", // Combat results
                choices: [
                    {text: "Flee the temple", nextSection: 135, skillCheck: false}
                ]
            },
            112: {
                text: "After defeating the rebels, you search the temple. You find exit papers and 75 Gold!",
                choices: [
                    {text: "Take the papers and gold", nextSection: 136, skillCheck: false},
                    {text: "Leave the temple", nextSection: 135, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Exit Papers");
                    gameState.gold += 75;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                    return "You find Exit Papers and 75 Gold!";
                }
            },
            113: {
                text: "'The western gate is your only official way out. But there's an old aqueduct that leads outside... if you can find it.'",
                choices: [
                    {text: "Ask where the aqueduct is", nextSection: 137, skillCheck: false},
                    {text: "Thank the watcher and leave", nextSection: 39, skillCheck: false}
                ]
            },
            114: {
                text: "'The Shadow King is not what he seems. He's been here for centuries. Some say he's bound to the city, unable to leave. Others say he feeds on the shadows of the inhabitants.'",
                choices: [
                    {text: "Ask how to defeat him", nextSection: 138, skillCheck: false},
                    {text: "Thank the watcher and leave", nextSection: 39, skillCheck: false}
                ]
            },
            115: {
                text: "", // Combat results
                choices: [
                    {text: "Search the watcher's body", nextSection: 139, skillCheck: false}
                ]
            },
            116: {
                text: "On the watcher's body, you find a strange amulet and a map showing the aqueduct entrance.",
                choices: [
                    {text: "Take the items", nextSection: 140, skillCheck: false},
                    {text: "Leave them", nextSection: 141, skillCheck: false}
                ]
            },
            117: {
                text: "'50 Gold gets you exit papers and safe passage to the western gate,' the figure says.",
                choices: [
                    {text: "Pay 50 Gold", nextSection: 142, skillCheck: false},
                    {text: "Try to negotiate", nextSection: 143, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Decline", nextSection: 40, skillCheck: false}
                ]
            },
            118: {
                text: "You're led into the catacombs beneath the tower. The air is cold and filled with whispers. 'Your job is to retrieve a black crystal from the deepest chamber,' your guide says.",
                choices: [
                    {text: "Accept the mission", nextSection: 144, skillCheck: false},
                    {text: "Ask about the dangers", nextSection: 145, skillCheck: false},
                    {text: "Back out now", nextSection: 146, skillCheck: false}
                ]
            },
            119: {
                text: "You decide the catacombs are too dangerous and tear up the job notice.",
                choices: [
                    {text: "Return to the market", nextSection: 36, skillCheck: false}
                ],
                action: function() {
                    // Remove the job notice from inventory
                    const index = gameState.inventory.indexOf("Catacombs Job Notice");
                    if (index > -1) {
                        gameState.inventory.splice(index, 1);
                        updateInventoryDisplay();
                    }
                }
            },
            120: {
                text: "'Excellent!' the merchant says. 'Let's go before more guards arrive.' He pays you 50 Gold upfront.",
                choices: [
                    {text: "Leave the city with the merchant", nextSection: 200, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 50;
                    updateStatsDisplay();
                    return "The merchant pays you 50 Gold upfront.";
                }
            },
            121: {
                text: window.checkResult ? 
                    "'Very well, I'll pay 75 Gold instead,' the merchant says nervously." : 
                    "'50 Gold is my final offer,' the merchant insists.",
                choices: [
                    window.checkResult ? 
                        {text: "Accept 75 Gold", nextSection: 147, skillCheck: false} :
                        {text: "Accept 50 Gold", nextSection: 120, skillCheck: false}
                ]
            },
            122: {
                text: "You decline the job. The merchant looks disappointed but hurries away.",
                choices: [
                    {text: "Return to the gate", nextSection: 87, skillCheck: false}
                ]
            },
            123: {
                text: "'Leave? Why would you want to leave my beautiful city?' the Shadow King asks. 'Stay, and I will grant you power beyond your imagining.'",
                choices: [
                    {text: "Accept his offer", nextSection: 148, skillCheck: false},
                    {text: "Politely insist on leaving", nextSection: 149, skillCheck: true, checkType: 'luck', difficulty: 13},
                    {text: "Attack the Shadow King", nextSection: 150, skillCheck: false}
                ]
            },
            124: {
                text: "'You dare challenge me?' the Shadow King rises from his throne, shadows swirling around him. 'Then face your doom!'",
                choices: [
                    {text: "Prepare for battle", nextSection: 1501, skillCheck: false}
                ]
            },
            125: {
                text: "'This city was built on ancient magic,' the Shadow King says. 'I have protected it for centuries. But tell me, why do you wish to know?'",
                choices: [
                    {text: "Say you're a scholar", nextSection: 152, skillCheck: false},
                    {text: "Say you seek power", nextSection: 153, skillCheck: false},
                    {text: "Ask to leave again", nextSection: 123, skillCheck: false}
                ]
            },
            126: {
                text: "You enter the tower after defeating the guards.",
                choices: [
                    {text: "Explore", nextSection: 127, skillCheck: false}
                ]
            },
            127: {
                text: "Inside the tower, you find the Shadow King's chambers and steal exit papers!",
                choices: [
                    {text: "Escape with the papers", nextSection: 200, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Exit Papers");
                    updateInventoryDisplay();
                }
            },
            128: {
                text: "You find the old tunnels and navigate them successfully.",
                choices: [
                    {text: "Exit the city", nextSection: 200, skillCheck: false}
                ]
            },
            129: {
                text: "You bribe the guards and they let you pass.",
                choices: [
                    {text: "Exit the city", nextSection: 200, skillCheck: false}
                ],
                action: function() {
                    if(gameState.gold >= 50) {
                        gameState.gold -= 50;
                        updateStatsDisplay();
                    }
                }
            },
            130: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 131, skillCheck: false}
                ]
            },
            131: {
                text: "You defeat the gate guards and open the gates yourself.",
                choices: [
                    {text: "Exit the city", nextSection: 200, skillCheck: false}
                ]
            },
            132: {
                text: "You help the rebels and they give you exit papers as reward.",
                choices: [
                    {text: "Take the papers and leave", nextSection: 200, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Exit Papers");
                    updateInventoryDisplay();
                }
            },
            133: {
                text: "The rebels agree to give you exit papers after you help.",
                choices: [
                    {text: "Help them", nextSection: 132, skillCheck: false}
                ]
            },
            134: {
                text: "'Steal a shadow crystal from the tower guards,' they say.",
                choices: [
                    {text: "Accept the task", nextSection: 154, skillCheck: false}
                ]
            },
            135: {
                text: "You flee the temple with the exit papers.",
                choices: [
                    {text: "Go to the western gate", nextSection: 200, skillCheck: false}
                ]
            },
            136: {
                text: "With exit papers in hand, you can now leave the city.",
                choices: [
                    {text: "Go to the western gate", nextSection: 200, skillCheck: false}
                ]
            },
            137: {
                text: "'The aqueduct entrance is near the old bathhouse,' the watcher says.",
                choices: [
                    {text: "Find the aqueduct", nextSection: 128, skillCheck: false}
                ]
            },
            138: {
                text: "'Only light can defeat true shadow,' the watcher whispers before vanishing.",
                choices: [
                    {text: "Return to the alley", nextSection: 39, skillCheck: false}
                ]
            },
            139: {
                text: "You search the watcher's body...",
                choices: [
                    {text: "Continue", nextSection: 116, skillCheck: false}
                ]
            },
            140: {
                text: "You take the amulet and map. The map shows the aqueduct entrance.",
                choices: [
                    {text: "Follow the map", nextSection: 128, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Shadow Amulet", "Aqueduct Map");
                    updateInventoryDisplay();
                }
            },
            141: {
                text: "You leave the items and climb down from the roof.",
                choices: [
                    {text: "Return to the alley", nextSection: 39, skillCheck: false}
                ]
            },
            142: {
                text: "You pay 50 Gold and receive exit papers.",
                choices: [
                    {text: "Go to the western gate", nextSection: 200, skillCheck: false}
                ],
                action: function() {
                    if(gameState.gold >= 50) {
                        gameState.gold -= 50;
                        gameState.inventory.push("Exit Papers");
                        updateStatsDisplay();
                        updateInventoryDisplay();
                    }
                }
            },
            143: {
                text: window.checkResult ? "They agree to 35 Gold instead." : "They insist on 50 Gold.",
                choices: [
                    window.checkResult ? 
                        {text: "Pay 35 Gold", nextSection: 155, skillCheck: false} : 
                        {text: "Pay 50 Gold", nextSection: 142, skillCheck: false}
                ]
            },
            144: {
                text: "You brave the catacombs, retrieve the crystal, and receive your 100 Gold reward plus exit papers!",
                choices: [
                    {text: "Leave the city", nextSection: 200, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 100;
                    gameState.inventory.push("Exit Papers");
                    updateStatsDisplay();
                    updateInventoryDisplay();
                }
            },
            145: {
                text: "'Shadow creatures, traps, and the spirits of the dead,' your guide says ominously.",
                choices: [
                    {text: "Proceed anyway", nextSection: 144, skillCheck: false},
                    {text: "Back out", nextSection: 146, skillCheck: false}
                ]
            },
            146: {
                text: "You decide not to enter the catacombs.",
                choices: [
                    {text: "Return to the city", nextSection: 36, skillCheck: false}
                ]
            },
            147: {
                text: "The merchant pays you 75 Gold and you escort him out of the city.",
                choices: [
                    {text: "Exit the city", nextSection: 200, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 75;
                    updateStatsDisplay();
                }
            },
            148: {
                text: "The Shadow King grants you dark powers but you become trapped in the city forever. Game Over.",
                choices: [],
                action: function() {
                    document.getElementById('story-text').innerHTML += "<div class='game-over'>YOU BECOME A SERVANT OF SHADOW</div>";
                    setTimeout(() => {
                        localStorage.removeItem('dreadwoodGameState');
                        location.reload();
                    }, 3000);
                }
            },
            149: {
                text: window.checkResult ? "The Shadow King sighs. 'Very well. Take these exit papers and go.'" : "The Shadow King becomes angry. 'You refuse my gift? Then die!'",
                choices: [
                    window.checkResult ? 
                        {text: "Take the papers and leave", nextSection: 200, skillCheck: false} : 
                        {text: "Fight for your life", nextSection: 1501, skillCheck: false}
                ],
                action: function() {
                    if(window.checkResult) {
                        gameState.inventory.push("Exit Papers");
                        updateInventoryDisplay();
                    }
                }
            },
            150: {
                text: "You attack the Shadow King!",
                choices: [
                    {text: "Roll for attack", nextSection: 1501, skillCheck: false}
                ]
            },
            1501: {
                text: "You face the Shadow King in epic combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 1502, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for Shadow King
                    combatState.active = true;
                    combatState.enemyName = "The Shadow King";
                    combatState.enemyStamina = 30;
                    combatState.enemyCurrentStamina = 30;
                    combatState.enemySkill = 15;
                    combatState.nextSection = 157;
                    combatState.round = 1;
                    
                    return "The Shadow King: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            152: {
                text: "'A scholar? How interesting. Take this ancient text as a gift, and these exit papers.'",
                choices: [
                    {text: "Accept and leave", nextSection: 200, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Ancient Text", "Exit Papers");
                    updateInventoryDisplay();
                }
            },
            153: {
                text: "'Power? I can give you power... if you serve me.'",
                choices: [
                    {text: "Accept servitude", nextSection: 148, skillCheck: false},
                    {text: "Refuse", nextSection: 149, skillCheck: false}
                ]
            },
            154: {
                text: "You steal a shadow crystal and give it to the rebels. They give you exit papers.",
                choices: [
                    {text: "Take the papers and leave", nextSection: 200, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Exit Papers");
                    updateInventoryDisplay();
                }
            },
            155: {
                text: "You pay 35 Gold and receive exit papers.",
                choices: [
                    {text: "Go to the western gate", nextSection: 200, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 35) {
                        gameState.gold -= 35;
                        gameState.inventory.push("Exit Papers");
                        updateStatsDisplay();
                        updateInventoryDisplay();
                    }
                }
            },
            156: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 157, skillCheck: false}
                ]
            },
            157: {
                text: "Against all odds, you defeat the Shadow King! The city begins to brighten as the shadows fade. You take the king's crown and exit papers.",
                choices: [
                    {text: "Leave the city in triumph", nextSection: 200, skillCheck: false}
                ],
                action: function() {
                    gameState.inventory.push("Shadow King's Crown", "Exit Papers");
                    gameState.gold += 200;
                    updateInventoryDisplay();
                    updateStatsDisplay();
                }
            },
            // Combat sections
            602: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 603, skillCheck: false}
                ]
            },
            603: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 602, skillCheck: false}
                ]
            },
            1702: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 1703, skillCheck: false}
                ]
            },
            1703: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 1702, skillCheck: false}
                ]
            },
            3202: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 3203, skillCheck: false}
                ]
            },
            3203: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 3202, skillCheck: false}
                ]
            },
            8302: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 8303, skillCheck: false}
                ]
            },
            8303: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 8302, skillCheck: false}
                ]
            },
            9102: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 9103, skillCheck: false}
                ]
            },
            9103: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 9102, skillCheck: false}
                ]
            },
            9402: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 9403, skillCheck: false}
                ]
            },
            9403: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 9402, skillCheck: false}
                ]
            },
            10702: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 10703, skillCheck: false}
                ]
            },
            10703: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 10702, skillCheck: false}
                ]
            },
            1502: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 1503, skillCheck: false}
                ]
            },
            1503: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 1502, skillCheck: false}
                ]
            },
            // VICTORY SECTION - Player completes the level
            200: {
                text: "You have successfully navigated the City of Shadows! Whether through stealth, combat, or diplomacy, you've found your way out. The western gates swing open before you, revealing the mist-shrouded path to the Swamp of Sorrows.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-skill').textContent = gameState.skill;
                    document.getElementById('next-stat-stamina').textContent = gameState.stamina;
                    document.getElementById('next-stat-luck').textContent = gameState.luck;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    return "You've completed Level 2: City of Shadows!";
                }
            }
        };
        
        // Initialize game
        function initGame() {
            updateStatsDisplay();
            updateInventoryDisplay();
            
            // If we have a current section from saved game, load it
            if (gameState.currentSection > 0) {
                loadSection(gameState.currentSection);
            } else {
                loadSection(0);
            }
        }
        
        // Show warning dialog for new game
        function showNewGameWarning() {
            // Show warning dialog
            document.getElementById('screen-game').classList.remove('active-screen');
            document.getElementById('warning-dialog').classList.add('active-screen');
        }
        
        // Cancel new game and return to game screen
        function cancelNewGame() {
            document.getElementById('warning-dialog').classList.remove('active-screen');
            document.getElementById('screen-game').classList.add('active-screen');
        }
        
        // Start new game - reset everything
        function startNewGame() {
            // Clear all saved game data
            localStorage.removeItem('dreadwoodGameState');
            
            // Reset game state to completely empty
            gameState = {
                playerClass: '',
                skill: 0,
                maxStamina: 0,
                stamina: 0,
                luck: 0,
                gold: 0,
                inventory: [],
                weapons: [],
                armor: [],
                currentWeaponIndex: 0,
                currentArmorIndex: 0,
                currentSection: 0,
                gameComplete: false
            };
            
            // Redirect to level1.html to start fresh
            window.location.href = 'level1.html';
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-skill').textContent = gameState.skill;
            document.getElementById('stat-stamina').textContent = gameState.stamina;
            document.getElementById('stat-maxstamina').textContent = gameState.maxStamina;
            document.getElementById('stat-luck').textContent = gameState.luck;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Show current equipped weapon
            if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                const weapon = gameState.weapons[gameState.currentWeaponIndex];
                const weaponSpan = document.createElement('span');
                weaponSpan.className = 'inventory-item';
                weaponSpan.id = 'inv-weapon';
                weaponSpan.textContent = `${weapon.name} (${weapon.damage})`;
                inventoryDiv.appendChild(weaponSpan);
            }
            
            // Show current equipped armor
            if (gameState.armor && gameState.armor.length > 0 && gameState.currentArmorIndex >= 0) {
                const armor = gameState.armor[gameState.currentArmorIndex];
                const armorSpan = document.createElement('span');
                armorSpan.className = 'inventory-item';
                armorSpan.id = 'inv-armor';
                armorSpan.textContent = `${armor.name} (${armor.defense} DEF)`;
                inventoryDiv.appendChild(armorSpan);
            }
            
            // Show gold
            const goldSpan = document.createElement('span');
            goldSpan.className = 'inventory-item';
            goldSpan.textContent = `${gameState.gold} Gold`;
            inventoryDiv.appendChild(goldSpan);
            
            // Show other inventory items
            if (gameState.inventory) {
                gameState.inventory.forEach(item => {
                    // Don't show items that are currently equipped as weapons/armor
                    const isCurrentWeapon = gameState.weapons[gameState.currentWeaponIndex] && 
                        gameState.weapons[gameState.currentWeaponIndex].name === item;
                    const isCurrentArmor = gameState.armor[gameState.currentArmorIndex] && 
                        gameState.armor[gameState.currentArmorIndex].name === item;
                    
                    if (!isCurrentWeapon && !isCurrentArmor) {
                        const itemSpan = document.createElement('span');
                        itemSpan.className = 'inventory-item';
                        itemSpan.textContent = item;
                        inventoryDiv.appendChild(itemSpan);
                    }
                });
            }
        }
        
        // Load story section
        function loadSection(sectionId) {
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                // If section doesn't exist yet, show a placeholder
                document.getElementById('story-text').innerHTML = "<p>Your adventure in the City of Shadows continues... More content will be added in future updates!</p>";
                document.getElementById('choice-buttons').innerHTML = `
                    <button class="choice-btn" onclick="loadSection(0)">Return to City Entrance</button>
                `;
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 602 || sectionId === 603 || 
                                 sectionId === 1702 || sectionId === 1703 ||
                                 sectionId === 3202 || sectionId === 3203 ||
                                 sectionId === 8302 || sectionId === 8303 ||
                                 sectionId === 9102 || sectionId === 9103 ||
                                 sectionId === 9402 || sectionId === 9403 ||
                                 sectionId === 10702 || sectionId === 10703 ||
                                 sectionId === 1502 || sectionId === 1503);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended, show victory and continue to next section
                    const goldReward = Math.floor(Math.random() * 30) + 10;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find ${goldReward} Gold on the body.`;
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                section.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    button.onclick = function() {
                        if (choice.skillCheck) {
                            performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                        } else {
                            loadSection(choice.nextSection);
                        }
                    };
                    choiceButtons.appendChild(button);
                });
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat (FIXED VERSION like level3 and level4)
        function executeCombatRound() {
            combatState.round++;
            
            const playerAttack = rollDiceHelper(2, 6) + gameState.skill;
            const enemyAttack = rollDiceHelper(2, 6) + combatState.enemySkill;
            
            let resultText = `<span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Stamina: ${gameState.stamina}, Enemy Stamina: ${combatState.enemyCurrentStamina}<br>`;
            resultText += `You attack with ${playerAttack} vs enemy's ${enemyAttack}.<br>`;
            
            if (playerAttack > enemyAttack) {
                // Player hits
                let damage = 0;
                if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                    const weapon = gameState.weapons[gameState.currentWeaponIndex];
                    if (weapon.damage === '1d6') damage = rollDiceHelper(1, 6);
                    else if (weapon.damage === '1d6+1') damage = rollDiceHelper(1, 6) + 1;
                    else if (weapon.damage === '1d6+2') damage = rollDiceHelper(1, 6) + 2;
                    else if (weapon.damage === '2d4') damage = rollDiceHelper(2, 4);
                    else if (weapon.damage === '2d6') damage = rollDiceHelper(2, 6);
                    else if (weapon.damage === '3d6') damage = rollDiceHelper(3, 6);
                    else damage = rollDiceHelper(1, 6);
                } else {
                    damage = rollDiceHelper(1, 6);
                }
                
                combatState.enemyCurrentStamina -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                
                if (combatState.enemyCurrentStamina <= 0) {
                    combatState.active = false;
                    return resultText;
                }
                
                // Enemy counterattacks
                const enemyDamage = rollDiceHelper(1, 6);
                gameState.stamina -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits back for ${enemyDamage} damage!</span>`;
                
            } else if (playerAttack < enemyAttack) {
                // Enemy hits
                const enemyDamage = rollDiceHelper(1, 6);
                gameState.stamina -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
            } else {
                // Tie
                resultText += "The attacks cancel each other out!";
            }
            
            updateStatsDisplay();
            
            // Check if player died
            if (gameState.stamina <= 0) {
                combatState.active = false;
                resultText += `<br><span class="game-over">You have been defeated by the ${combatState.enemyName}! Game Over.</span>`;
                setTimeout(() => {
                    localStorage.removeItem('dreadwoodGameState');
                    location.reload();
                }, 3000);
            }
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            const diceRoll = rollDiceHelper(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Luck
        function useLuck() {
            if (gameState.luck <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Luck left!</div>`;
                return;
            }
            
            const diceRoll = rollDiceHelper(2, 6);
            const success = diceRoll <= gameState.luck;
            
            gameState.luck -= 1;
            updateStatsDisplay();
            
            let resultText = `You test your Luck... Roll: ${diceRoll}, Luck: ${gameState.luck + 1}. `;
            resultText += success ? 
                `<span class="success">Lucky!</span> Something good happens.` : 
                `<span class="damage">Unlucky!</span> Something bad happens.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            // Apply Luck effect
            if (success) {
                // Good effect
                const goodEffects = [
                    "You find 10 Gold on the ground!",
                    "You feel a surge of energy! Restore 5 Stamina.",
                    "You spot a hidden path that might be useful.",
                    "A kind stranger gives you a healing potion!",
                    "Your weapon feels sharper! Next attack does +2 damage."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Gold")) {
                    gameState.gold += 10;
                } else if (effect.includes("Stamina")) {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 5);
                } else if (effect.includes("potion")) {
                    gameState.inventory.push("Healing Potion");
                    updateInventoryDisplay();
                }
            } else {
                // Bad effect
                const badEffects = [
                    "You trip and take 3 damage!",
                    "You drop 5 Gold!",
                    "You feel weaker. Lose 1 Skill until next rest.",
                    "Your armor strap breaks! Lose 1 DEF until repaired.",
                    "You attract unwanted attention from city guards!"
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.stamina -= 3;
                    if (gameState.stamina <= 0) {
                        document.getElementById('story-text').innerHTML += `<div class="game-over">You have been defeated! Game Over.</div>`;
                        setTimeout(() => {
                            localStorage.removeItem('dreadwoodGameState');
                            location.reload();
                        }, 3000);
                    }
                } else if (effect.includes("Gold")) {
                    gameState.gold = Math.max(0, gameState.gold - 5);
                } else if (effect.includes("Skill")) {
                    gameState.skill = Math.max(1, gameState.skill - 1);
                } else if (effect.includes("guard")) {
                    // This could trigger a combat encounter
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">Two city guards approach you menacingly!</div>`;
                    setTimeout(() => {
                        combatState.active = true;
                        combatState.enemyName = "City Guards";
                        combatState.enemyStamina = 10;
                        combatState.enemyCurrentStamina = 10;
                        combatState.enemySkill = 7;
                        combatState.nextSection = gameState.currentSection;
                        combatState.round = 0;
                        loadSection(602); // Use guard combat section
                    }, 1000);
                }
            }
            
            updateStatsDisplay();
            updateInventoryDisplay();
        }
        
        // NEW FUNCTION: Use Item
        function useItem() {
            // Filter to get only usable items (not equipped weapons/armor)
            const usableItems = gameState.inventory.filter(item => {
                const isWeapon = gameState.weapons.some(w => w.name === item);
                const isArmor = gameState.armor.some(a => a.name === item);
                return !isWeapon && !isArmor;
            });
            
            if (usableItems.length === 0) {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory!</div>`;
                return;
            }
            
            let itemText = "<h3>Select an item to use:</h3>";
            
            usableItems.forEach((item, index) => {
                itemText += `<p>${item} `;
                
                // Add use button with appropriate effect
                if (item === "Healing Potion" || item === "Healing Salve") {
                    itemText += `<button onclick="useHealingItem('${item}')" style="font-size:12px; padding:3px 8px;">Use (Restore Stamina)</button>`;
                } else if (item === "Invisibility Potion") {
                    itemText += `<button onclick="useInvisibilityPotion()" style="font-size:12px; padding:3px 8px;">Use (Become Invisible)</button>`;
                } else if (item === "Teleportation Scroll") {
                    itemText += `<button onclick="useTeleportationScroll()" style="font-size:12px; padding:3px 8px;">Use (Teleport)</button>`;
                } else if (item === "Glowing Fungi") {
                    itemText += `<button onclick="useGlowingFungi()" style="font-size:12px; padding:3px 8px;">Use (Random Effect)</button>`;
                } else if (item === "Luck Charm") {
                    itemText += `<button onclick="useLuckCharm()" style="font-size:12px; padding:3px 8px;">Use (Boost Luck)</button>`;
                } else if (item === "Silver Locket" || item === "Shadow Amulet" || item === "Magical Amulet") {
                    itemText += `<button onclick="useMagicalAmulet('${item}')" style="font-size:12px; padding:3px 8px;">Use (Magical Effect)</button>`;
                } else {
                    // Generic use button for other items
                    itemText += `<button onclick="useGenericItem('${item}')" style="font-size:12px; padding:3px 8px;">Use</button>`;
                }
                
                itemText += `</p>`;
            });
            
            itemText += `<p><button onclick="cancelItemUse()" style="font-size:12px; padding:3px 8px; margin-top:10px;">Cancel</button></p>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${itemText}</div>`;
        }
        
        // NEW FUNCTION: Use Healing Item
        function useHealingItem(itemName) {
            // Find and remove the item from inventory
            const itemIndex = gameState.inventory.indexOf(itemName);
            if (itemIndex !== -1) {
                gameState.inventory.splice(itemIndex, 1);
                
                // Restore stamina based on item type
                let healAmount = 0;
                if (itemName === "Healing Potion") {
                    healAmount = 6;
                } else if (itemName === "Healing Salve") {
                    healAmount = 8;
                } else {
                    healAmount = 4; // Default for other healing items
                }
                
                const oldStamina = gameState.stamina;
                gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                const actualHeal = gameState.stamina - oldStamina;
                
                updateInventoryDisplay();
                updateStatsDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You use the ${itemName} and restore ${actualHeal} Stamina!</span></div>`;
            }
        }
        
        // NEW FUNCTION: Use Invisibility Potion
        function useInvisibilityPotion() {
            // Find and remove the potion from inventory
            const potionIndex = gameState.inventory.indexOf("Invisibility Potion");
            if (potionIndex !== -1) {
                gameState.inventory.splice(potionIndex, 1);
                
                updateInventoryDisplay();
                
                // Invisibility effect - could be used to bypass guards or enemies
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You drink the Invisibility Potion! You become completely invisible for a short time.</span></div>`;
                
                // Store invisibility state (could be used in specific story sections)
                gameState.invisible = true;
                setTimeout(() => {
                    gameState.invisible = false;
                    document.getElementById('story-text').innerHTML += 
                        `<div class="dice-roll">The invisibility wears off.</div>`;
                }, 30000); // 30 seconds of invisibility
            }
        }
        
        // NEW FUNCTION: Use Teleportation Scroll
        function useTeleportationScroll() {
            // Find and remove the scroll from inventory
            const scrollIndex = gameState.inventory.indexOf("Teleportation Scroll");
            if (scrollIndex !== -1) {
                gameState.inventory.splice(scrollIndex, 1);
                
                updateInventoryDisplay();
                
                // Teleport to a random location in the city
                const teleportLocations = [
                    {section: 12, description: "the main street"},
                    {section: 22, description: "the market"},
                    {section: 37, description: "the residential district"},
                    {section: 62, description: "the western gate"},
                    {section: 60, description: "the central tower"}
                ];
                
                const location = teleportLocations[Math.floor(Math.random() * teleportLocations.length)];
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You activate the Teleportation Scroll! You vanish and reappear at ${location.description}.</span></div>`;
                
                // Load the new section after a delay
                setTimeout(() => {
                    loadSection(location.section);
                }, 1500);
            }
        }
        
        // NEW FUNCTION: Use Glowing Fungi
        function useGlowingFungi() {
            // Find and remove the fungi from inventory
            const fungiIndex = gameState.inventory.indexOf("Glowing Fungi");
            if (fungiIndex !== -1) {
                gameState.inventory.splice(fungiIndex, 1);
                
                updateInventoryDisplay();
                
                // Random effect from eating the fungi
                const effect = rollDiceHelper(1, 6);
                let effectText = "";
                
                if (effect <= 2) {
                    // Bad effect
                    gameState.stamina -= 5;
                    effectText = "The fungi are poisonous! You lose 5 Stamina.";
                } else if (effect <= 4) {
                    // Neutral effect
                    effectText = "The fungi have a strange taste but no noticeable effect.";
                } else if (effect === 5) {
                    // Good effect
                    gameState.skill += 1;
                    effectText = "The fungi sharpen your senses! Your Skill increases by 1.";
                } else {
                    // Very good effect
                    gameState.luck += 2;
                    effectText = "The fungi make you feel incredibly lucky! Your Luck increases by 2.";
                }
                
                updateStatsDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You eat the glowing fungi... ${effectText}</span></div>`;
            }
        }
        
        // NEW FUNCTION: Use Luck Charm
        function useLuckCharm() {
            // Find and remove the charm from inventory
            const charmIndex = gameState.inventory.indexOf("Luck Charm");
            if (charmIndex !== -1) {
                gameState.inventory.splice(charmIndex, 1);
                
                updateInventoryDisplay();
                
                // Boost luck permanently
                gameState.luck += 3;
                updateStatsDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You activate the Luck Charm! Your Luck increases by 3!</span></div>`;
            }
        }
        
        // NEW FUNCTION: Use Magical Amulet
        function useMagicalAmulet(itemName) {
            // Find and remove the amulet from inventory
            const amuletIndex = gameState.inventory.indexOf(itemName);
            if (amuletIndex !== -1) {
                gameState.inventory.splice(amuletIndex, 1);
                
                updateInventoryDisplay();
                
                // Different effects based on amulet type
                let effectText = "";
                if (itemName === "Silver Locket") {
                    gameState.luck += 2;
                    effectText = "The silver locket glows warmly! Your Luck increases by 2.";
                } else if (itemName === "Shadow Amulet") {
                    gameState.skill += 1;
                    gameState.luck += 1;
                    effectText = "The shadow amulet merges with you! Your Skill increases by 1 and Luck by 1.";
                } else if (itemName === "Magical Amulet") {
                    gameState.skill += 2;
                    effectText = "The magical amulet empowers you! Your Skill increases by 2.";
                } else {
                    // Generic amulet effect
                    gameState.luck += 1;
                    effectText = "The amulet has a magical effect! Your Luck increases by 1.";
                }
                
                updateStatsDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You activate the ${itemName}! ${effectText}</span></div>`;
            }
        }
        
        // NEW FUNCTION: Use Generic Item
        function useGenericItem(itemName) {
            // Generic item use function
            const itemIndex = gameState.inventory.indexOf(itemName);
            if (itemIndex !== -1) {
                gameState.inventory.splice(itemIndex, 1);
                updateInventoryDisplay();
                
                // Determine effect based on item name
                let effectText = "";
                if (itemName.includes("Potion") || itemName.includes("Elixir")) {
                    // Generic potion effect
                    const healAmount = rollDiceHelper(1, 4) + 2;
                    const oldStamina = gameState.stamina;
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                    const actualHeal = gameState.stamina - oldStamina;
                    effectText = `You use the ${itemName} and restore ${actualHeal} Stamina!`;
                    updateStatsDisplay();
                } else if (itemName.includes("Scroll") || itemName.includes("Rune")) {
                    // Magical item effect
                    gameState.luck += 1;
                    effectText = `You use the ${itemName} and feel luckier! Luck +1`;
                    updateStatsDisplay();
                } else if (itemName.includes("Key")) {
                    // Key item - might be useful later
                    effectText = `You examine the ${itemName}. It might unlock something important.`;
                    // Keep the key in inventory (don't consume it)
                    gameState.inventory.push(itemName);
                    updateInventoryDisplay();
                    return; // Don't remove keys
                } else {
                    // Default effect
                    effectText = `You use the ${itemName}.`;
                }
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">${effectText}</span></div>`;
            }
        }
        
        // NEW FUNCTION: Cancel Item Use
        function cancelItemUse() {
            document.getElementById('story-text').innerHTML += 
                `<div class="dice-roll">You decide not to use an item.</div>`;
        }
        
        // UPDATED: Check inventory (now includes use buttons)
        function checkInventory() {
            let inventoryText = "<h3>Your Inventory:</h3>";
            
            // Show current equipped weapon
            if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                const weapon = gameState.weapons[gameState.currentWeaponIndex];
                inventoryText += `<p><strong>Equipped Weapon:</strong> ${weapon.name} (${weapon.damage} damage)</p>`;
            }
            
            // Show all available weapons
            inventoryText += "<p><strong>Available Weapons:</strong><br>";
            gameState.weapons.forEach((weapon, index) => {
                const isEquipped = index === gameState.currentWeaponIndex;
                inventoryText += `${isEquipped ? " " : ""}${weapon.name} (${weapon.damage})`;
                if (!isEquipped) {
                    inventoryText += ` <button onclick="equipWeapon(${index})" style="font-size:10px; padding:2px 5px;">Equip</button>`;
                }
                inventoryText += "<br>";
            });
            inventoryText += "</p>";
            
            // Show all armor
            inventoryText += "<p><strong>Armor:</strong><br>";
            gameState.armor.forEach((armor, index) => {
                const isEquipped = index === gameState.currentArmorIndex;
                inventoryText += `${isEquipped ? " " : ""}${armor.name} (${armor.defense} DEF)`;
                if (!isEquipped) {
                    inventoryText += ` <button onclick="equipArmor(${index})" style="font-size:10px; padding:2px 5px;">Equip</button>`;
                }
                inventoryText += "<br>";
            });
            inventoryText += "</p>";
            
            inventoryText += `<p><strong>Gold:</strong> ${gameState.gold}</p>`;
            
            // Show other items WITH USE BUTTONS
            if (gameState.inventory && gameState.inventory.length > 0) {
                inventoryText += `<p><strong>Usable Items:</strong><br>`;
                const usableItems = gameState.inventory.filter(item => {
                    const isWeapon = gameState.weapons.some(w => w.name === item);
                    const isArmor = gameState.armor.some(a => a.name === item);
                    return !isWeapon && !isArmor;
                });
                
                if (usableItems.length > 0) {
                    usableItems.forEach(item => {
                        inventoryText += `${item} `;
                        
                        // Add use button based on item type
                        if (item === "Healing Potion" || item === "Healing Salve") {
                            inventoryText += `<button onclick="useHealingItem('${item}')" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Invisibility Potion") {
                            inventoryText += `<button onclick="useInvisibilityPotion()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Teleportation Scroll") {
                            inventoryText += `<button onclick="useTeleportationScroll()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Glowing Fungi") {
                            inventoryText += `<button onclick="useGlowingFungi()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Luck Charm") {
                            inventoryText += `<button onclick="useLuckCharm()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Silver Locket" || item === "Shadow Amulet" || item === "Magical Amulet") {
                            inventoryText += `<button onclick="useMagicalAmulet('${item}')" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else {
                            inventoryText += `<button onclick="useGenericItem('${item}')" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        }
                        
                        inventoryText += `<br>`;
                    });
                } else {
                    inventoryText += "None";
                }
                inventoryText += `</p>`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${inventoryText}</div>`;
        }
        
        // Equip weapon function
        function equipWeapon(index) {
            if (index >= 0 && index < gameState.weapons.length) {
                gameState.currentWeaponIndex = index;
                updateInventoryDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped ${gameState.weapons[index].name}!</div>`;
                saveGame();
            }
        }
        
        // Equip armor function
        function equipArmor(index) {
            if (index >= 0 && index < gameState.armor.length) {
                gameState.currentArmorIndex = index;
                updateInventoryDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped ${gameState.armor[index].name}!</div>`;
                saveGame();
            }
        }
        
        // Save game
        function saveGame() {
            // Ensure indices are valid before saving
            if (gameState.currentWeaponIndex >= gameState.weapons.length) {
                gameState.currentWeaponIndex = gameState.weapons.length - 1;
            }
            if (gameState.currentArmorIndex >= gameState.armor.length) {
                gameState.currentArmorIndex = gameState.armor.length - 1;
            }
            
            localStorage.setItem('dreadwoodGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">Game saved!</div>`;
        }
        
        // Go to next level
        function goToNextLevel() {
            // Save game state for level 3
            localStorage.setItem('dreadwoodGameState', JSON.stringify(gameState));
            // Redirect to level 3
            window.location.href = 'level3.html';
        }
        
        // Utility function to roll dice
        function rollDiceHelper(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
    </script>
</body>
</html>
