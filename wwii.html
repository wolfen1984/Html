<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operation: Valkyrie & Vengeance</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        body {
            background-color: #0a0a1a;
            color: #e0e0ff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(28, 58, 173, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(173, 28, 58, 0.1) 0%, transparent 20%);
        }
        
        #game-container {
            width: 100%;
            max-width: 550px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border: 2px solid #4a4a9a;
            background-color: #121230;
            position: relative;
            box-shadow: 0 0 30px rgba(74, 74, 154, 0.3);
        }
        
        .screen {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            padding: 15px;
            overflow-y: auto;
        }
        
        .active {
            display: flex;
        }
        
        h1, h2, h3 {
            color: #ffcc00;
            text-align: center;
            margin: 10px 0;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
            letter-spacing: 1px;
        }
        
        .button {
            background-color: #1a1a3a;
            color: #e0e0ff;
            border: 1px solid #4a4a9a;
            padding: 12px;
            margin: 8px 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            font-weight: bold;
        }
        
        .button:hover {
            background-color: #2a2a5a;
            border-color: #ffcc00;
            color: #ffffff;
        }
        
        .button:active {
            transform: scale(0.98);
            background-color: #3a3a7a;
        }
        
        .button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #1a1a3a;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            border-bottom: 1px dashed #4a4a9a;
            padding-bottom: 15px;
        }
        
        .log {
            border: 1px solid #4a4a9a;
            padding: 15px;
            height: 220px;
            overflow-y: auto;
            margin: 15px 0;
            font-size: 14px;
            background-color: rgba(10, 10, 26, 0.7);
            line-height: 1.4;
        }
        
        .log-entry {
            margin: 8px 0;
            padding-left: 5px;
            border-left: 2px solid #4a4a9a;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
        }
        
        .item {
            border: 1px solid #4a4a9a;
            padding: 10px;
            cursor: pointer;
            position: relative;
            background-color: rgba(26, 26, 58, 0.8);
        }
        
        .item-stats {
            font-size: 12px;
            margin-top: 5px;
            color: #a0a0ff;
        }
        
        .equipment-slots {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
        }
        
        .equipment-slot {
            border: 1px solid #4a4a9a;
            padding: 10px;
            min-height: 70px;
            background-color: rgba(26, 26, 58, 0.8);
        }
        
        .equipment-stats {
            font-size: 12px;
            margin-top: 5px;
            color: #a0a0ff;
        }
        
        .enemy {
            text-align: center;
            margin: 20px 0;
            font-size: 24px;
            position: relative;
            color: #ff6666;
            text-shadow: 0 0 10px rgba(255, 102, 102, 0.5);
        }
        
        .battle-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .spell-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin: 15px 0;
        }
        
        .spell-item {
            border: 1px solid #4a4a9a;
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            background-color: rgba(26, 26, 58, 0.8);
        }
        
        .spell-info {
            flex: 1;
        }
        
        .spell-cost {
            color: #66ccff;
            margin-left: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #0a0a1a;
            border: 1px solid #4a4a9a;
            margin: 8px 0;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #00ccff);
            width: 0%;
            transition: width 0.3s;
        }
        
        .energy-bar {
            background: linear-gradient(90deg, #9900cc, #cc66ff);
        }
        
        .class-select {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 25px 0;
        }
        
        .class-option {
            border: 1px solid #4a4a9a;
            padding: 20px;
            cursor: pointer;
            background-color: rgba(26, 26, 58, 0.8);
            transition: all 0.3s;
        }
        
        .class-option:hover {
            border-color: #ffcc00;
            background-color: rgba(42, 42, 90, 0.9);
            transform: translateY(-2px);
        }
        
        .loot-item {
            color: #ffcc00;
            animation: pulse 1s infinite;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .crit-message {
            color: #ff3333;
            font-weight: bold;
        }
        
        .dodge-message {
            color: #33cc33;
            font-weight: bold;
        }
        
        .miss-message {
            color: #8888aa;
            font-style: italic;
        }
        
        .shop-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        
        .shop-item {
            border: 1px solid #4a4a9a;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(26, 26, 58, 0.8);
        }
        
        .shop-item-info {
            flex: 1;
        }
        
        .shop-item-cost {
            color: #ffcc00;
            margin-left: 10px;
        }
        
        .item-comparison {
            font-size: 12px;
            margin-top: 3px;
        }
        
        .better-stat {
            color: #33cc33;
        }
        
        .worse-stat {
            color: #ff3333;
        }
        
        .same-stat {
            color: #8888aa;
        }
        
        .rarity-common { color: #cccccc; }
        .rarity-uncommon { color: #33cc33; }
        .rarity-rare { color: #3366ff; }
        .rarity-epic { color: #cc33ff; }
        .rarity-legendary { color: #ff9900; }
        
        .floating-text {
            position: absolute;
            font-weight: bold;
            pointer-events: none;
            z-index: 100;
            animation: floatUp 1s ease-out forwards;
        }
        
        .damage-text {
            color: #ff3333;
        }
        
        .heal-text {
            color: #33cc33;
        }
        
        .energy-text {
            color: #cc66ff;
        }
        
        .enemy-health-bar {
            width: 100%;
            height: 12px;
            background-color: #0a0a1a;
            border: 1px solid #ff3333;
            margin: 8px 0;
            position: relative;
            overflow: hidden;
        }
        
        .enemy-health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff3333, #ff6666);
            width: 100%;
            transition: width 0.3s;
        }
        
        .hotkey {
            font-size: 11px;
            color: #8888aa;
            margin-left: 5px;
        }
        
        .sound-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #1a1a3a;
            color: #e0e0ff;
            border: 1px solid #4a4a9a;
            padding: 8px;
            cursor: pointer;
            z-index: 1000;
            font-size: 12px;
        }
        
        .quest-log {
            border: 1px solid #4a4a9a;
            padding: 15px;
            margin: 15px 0;
            max-height: 180px;
            overflow-y: auto;
            background-color: rgba(26, 26, 58, 0.8);
        }
        
        .quest-item {
            margin: 8px 0;
            padding: 8px;
            border-left: 3px solid #4a4a9a;
            background-color: rgba(10, 10, 26, 0.5);
        }
        
        .quest-completed {
            color: #33cc33;
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .status-effect {
            display: inline-block;
            padding: 3px 6px;
            margin: 0 3px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .status-bleeding {
            background-color: #990000;
            color: #ffffff;
        }
        
        .status-burning {
            background-color: #cc6600;
            color: #ffffff;
        }
        
        .status-shocked {
            background-color: #ffcc00;
            color: #000000;
        }
        
        .status-frozen {
            background-color: #0066cc;
            color: #ffffff;
        }
        
        .status-cursed {
            background-color: #660099;
            color: #ffffff;
        }
        
        .tooltip {
            position: absolute;
            background: #1a1a3a;
            border: 1px solid #4a4a9a;
            padding: 10px;
            z-index: 1000;
            max-width: 280px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .tooltip.show {
            opacity: 1;
        }
        
        .quick-slot {
            display: inline-block;
            width: 45px;
            height: 45px;
            border: 1px solid #4a4a9a;
            margin: 3px;
            text-align: center;
            line-height: 45px;
            cursor: pointer;
            background-color: rgba(26, 26, 58, 0.8);
        }
        
        .quick-slots-container {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }
        
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a3a;
            border: 2px solid #ffcc00;
            padding: 25px;
            z-index: 2000;
            text-align: center;
            animation: achievementPop 3s ease-in-out forwards;
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.5);
            min-width: 300px;
        }
        
        .achievement-icon {
            font-size: 45px;
            margin-bottom: 15px;
        }
        
        .save-slot {
            border: 1px solid #4a4a9a;
            padding: 18px;
            margin: 12px 0;
            cursor: pointer;
            background-color: rgba(26, 26, 58, 0.8);
        }
        
        .save-slot:hover {
            border-color: #ffcc00;
            background-color: rgba(42, 42, 90, 0.9);
        }
        
        .save-info {
            font-size: 13px;
            color: #8888aa;
        }
        
        .skill-tree {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 15px 0;
        }
        
        .skill-node {
            border: 1px solid #4a4a9a;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background-color: rgba(26, 26, 58, 0.8);
        }
        
        .skill-node.unlocked {
            background-color: #2a2a5a;
            border-color: #ffcc00;
            color: #ffffff;
        }
        
        .skill-node.available {
            border-color: #33cc33;
        }
        
        .skill-node.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .boss-health-container {
            position: relative;
            margin: 15px 0;
        }
        
        .boss-health-bar {
            height: 22px;
            background: linear-gradient(90deg, #ff3333, #ff9900);
            border: 1px solid #ffffff;
            position: relative;
            overflow: hidden;
        }
        
        .boss-health-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
            color: #ffffff;
            font-weight: bold;
            text-shadow: 1px 1px 3px #000000;
            line-height: 22px;
        }
        
        .phase-indicator {
            color: #ff9900;
            font-weight: bold;
            text-align: center;
            margin: 8px 0;
            animation: pulse 1s infinite;
        }
        
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 50;
        }
        
        .mission-briefing {
            background-color: rgba(26, 26, 58, 0.8);
            border: 1px solid #4a4a9a;
            padding: 20px;
            margin: 20px 0;
            line-height: 1.6;
        }
        
        .year-display {
            position: absolute;
            top: 15px;
            left: 15px;
            color: #ffcc00;
            font-size: 14px;
            font-weight: bold;
        }
        
        .location-display {
            position: absolute;
            top: 35px;
            left: 15px;
            color: #a0a0ff;
            font-size: 12px;
        }
        
        .set-bonus-indicator {
            color: #ff9900;
            font-weight: bold;
            margin-top: 5px;
            font-size: 11px;
        }
        
        .radio-message {
            background-color: rgba(26, 58, 26, 0.8);
            border-left: 3px solid #33cc33;
            padding: 10px;
            margin: 10px 0;
            font-style: italic;
        }
        
        .hazard-warning {
            background-color: rgba(58, 26, 26, 0.8);
            border-left: 3px solid #cc3333;
            padding: 10px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .event-message {
            background-color: rgba(26, 26, 58, 0.8);
            border-left: 3px solid #4a4a9a;
            padding: 10px;
            margin: 10px 0;
        }
        
        .side-mission {
            background-color: rgba(58, 58, 26, 0.8);
            border-left: 3px solid #ffcc00;
            padding: 10px;
            margin: 10px 0;
        }
        
        .narrative-message {
            background-color: rgba(10, 10, 26, 0.9);
            border: 1px solid #4a4a9a;
            padding: 15px;
            margin: 10px 0;
            font-style: italic;
            text-align: center;
        }
        
        .boss-intro {
            background-color: rgba(58, 10, 10, 0.9);
            border: 2px solid #ff3333;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-35px); opacity: 0; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        
        @keyframes achievementPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        
        .shake {
            animation: shake 0.3s ease-in-out;
        }
        
        .boss-enemy {
            color: #ff3333;
            text-shadow: 0 0 10px rgba(255, 51, 51, 0.7);
            font-size: 28px;
        }
        
        .inventory-sort {
            display: flex;
            gap: 8px;
            margin: 15px 0;
        }
        
        .sort-button {
            flex: 1;
            padding: 8px;
            font-size: 13px;
        }
        
        .objective-item {
            margin: 10px 0;
            padding: 10px;
            background-color: rgba(10, 10, 26, 0.5);
            border-left: 3px solid #ffcc00;
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 600px) {
            #game-container {
                max-width: 100%;
                height: 100vh;
                border: none;
                box-shadow: none;
            }
            
            .battle-actions, .inventory-grid, .equipment-slots {
                grid-template-columns: 1fr;
            }
            
            .stats, .stat-grid {
                flex-direction: column;
                font-size: 12px;
            }
            
            .button {
                padding: 10px;
                font-size: 14px;
            }
            
            .skill-tree {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quick-slots-container {
                flex-wrap: wrap;
            }
            
            .log {
                height: 180px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="year-display">1945</div>
        <div class="location-display" id="location-display">BERLIN, GERMANY</div>
        <div class="sound-toggle" id="sound-toggle">ðŸ”Š SOUND ON</div>
        
        <!-- Tooltip Element -->
        <div id="tooltip" class="tooltip"></div>
        
        <!-- Start Screen -->
        <div id="start-screen" class="screen active">
            <h1>OPERATION: VALKYRIE & VENGEANCE</h1>
            <h3>Supernatural WWII RPG</h3>
            <div class="mission-briefing" id="mission-briefing">
                <!-- Dynamic briefing will be inserted here -->
            </div>
            <div class="button" id="start-button">BEGIN OPERATION</div>
            <div class="button" id="load-button">LOAD MISSION</div>
            <div style="margin-top: 30px; font-size: 12px; color: #8888aa; text-align: center;">
                Classified: TOP SECRET - EYES ONLY<br>
                Project: PHANTOM STRIKE
            </div>
        </div>
        
        <!-- Load Game Screen -->
        <div id="load-screen" class="screen">
            <h1>LOAD MISSION</h1>
            <div id="save-slots">
                <!-- Save slots will be populated here -->
            </div>
            <div class="button" id="back-from-load">BACK TO BRIEFING</div>
        </div>
        
        <!-- Class Selection Screen -->
        <div id="class-screen" class="screen">
            <h1>SELECT OPERATIVE</h1>
            <p style="text-align: center; margin-bottom: 20px;">Choose your specialist for the Berlin incursion:</p>
            <div class="class-select">
                <div class="class-option" data-class="commando">
                    <h3>COMMANDO</h3>
                    <p>Heavy weapons and combat expertise</p>
                    <p>Specializes in suppression and brute force</p>
                    <p>Starting Gear: Thompson SMG, Combat Armor</p>
                </div>
                <div class="class-option" data-class="occultist">
                    <h3>OCCULTIST</h3>
                    <p>Esoteric knowledge and supernatural abilities</p>
                    <p>Can manipulate reality and counter dark magic</p>
                    <p>Starting Gear: Ritual Focus, Occult Robes</p>
                </div>
                <div class="class-option" data-class="infiltrator">
                    <h3>INFILTRATOR</h3>
                    <p>Stealth, sabotage, and precision strikes</p>
                    <p>Excels at bypassing defenses and critical hits</p>
                    <p>Starting Gear: Silenced Pistol, Camouflage Gear</p>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <h2>OPERATION VALKYRIE</h2>
            <div class="stats">
                <div>
                    <div>Rank: <span id="player-level">1</span></div>
                    <div>HP: <span id="player-hp">100</span>/<span id="player-max-hp">100</span></div>
                    <div>Energy: <span id="player-mp">50</span>/<span id="player-max-mp">50</span></div>
                </div>
                <div>
                    <div>EXP: <span id="player-exp">0</span>/<span id="player-exp-needed">100</span></div>
                    <div>Intel: <span id="player-gold">10</span></div>
                </div>
            </div>
            <div class="progress-bar">
                <div id="exp-bar" class="progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-bar">
                <div id="mp-bar" class="progress-fill energy-bar" style="width: 100%"></div>
            </div>
            
            <!-- Quick Slots -->
            <div class="quick-slots-container">
                <div class="quick-slot" data-slot="0" id="quick-slot-0">1</div>
                <div class="quick-slot" data-slot="1" id="quick-slot-1">2</div>
                <div class="quick-slot" data-slot="2" id="quick-slot-2">3</div>
            </div>
            
            <div class="stat-grid">
                <div>Strength: <span id="player-strength">10</span></div>
                <div>Defense: <span id="player-defense">5</span></div>
                <div>Agility: <span id="player-agility">10</span></div>
                <div>Dodge: <span id="player-dodge">5</span>%</div>
                <div>Critical: <span id="player-critical">5</span>%</div>
                <div>Accuracy: <span id="player-accuracy">85</span>%</div>
            </div>
            
            <div class="button" id="explore-button">ADVANCE INTO BERLIN</div>
            <div class="button" id="inventory-button">INVENTORY</div>
            <div class="button" id="spells-button">SPECIAL ABILITIES</div>
            <div class="button" id="spell-shop-button">ACQUIRE INTEL</div>
            <div class="button" id="quests-button">OBJECTIVES</div>
            <div class="button" id="skills-button">TRAINING</div>
            <div class="button" id="achievements-button">CITATIONS</div>
            <div class="button" id="save-button">SAVE MISSION</div>
            
            <h3>Active Effects</h3>
            <div id="status-effects">
                <!-- Status effects will appear here -->
            </div>
            
            <div class="log" id="game-log">
                <div class="log-entry">You stand at the edge of the corrupted Berlin sector. The air crackles with unnatural energy...</div>
            </div>
        </div>
        
        <!-- Battle Screen -->
        <div id="battle-screen" class="screen">
            <h2>CONTACT!</h2>
            <div class="stats">
                <div>
                    <div>Operative HP: <span id="battle-player-hp">100</span>/<span id="battle-player-max-hp">100</span></div>
                    <div>Energy: <span id="battle-player-mp">50</span>/<span id="battle-player-max-mp">50</span></div>
                </div>
                <div>
                    <div><span id="enemy-name">SS Trooper</span> HP: <span id="enemy-hp">50</span>/<span id="enemy-max-hp">50</span></div>
                </div>
            </div>
            <div class="progress-bar">
                <div id="battle-mp-bar" class="progress-fill energy-bar" style="width: 100%"></div>
            </div>
            
            <!-- Boss Health Bar -->
            <div id="boss-health-container" class="boss-health-container" style="display: none;">
                <div class="boss-health-bar">
                    <div id="boss-health-fill" style="width: 100%; height: 100%; background: linear-gradient(90deg, #ff3333, #ff9900);"></div>
                </div>
                <div class="boss-health-text" id="boss-health-text">BOSS HEALTH: 100%</div>
            </div>
            
            <div class="enemy-health-bar">
                <div id="enemy-health-fill" class="enemy-health-fill" style="width: 100%"></div>
            </div>
            
            <div class="phase-indicator" id="phase-indicator" style="display: none;"></div>
            
            <div class="enemy" id="enemy-display">[ENEMY]</div>
            <div class="log" id="battle-log">
                <div class="log-entry">Enemy forces detected!</div>
            </div>
            <div class="battle-actions">
                <div class="button" id="attack-button">OPEN FIRE <span class="hotkey">(1)</span></div>
                <div class="button" id="spell-button">SPECIAL ABILITY <span class="hotkey">(2)</span></div>
                <div class="button" id="item-button">USE EQUIPMENT <span class="hotkey">(3)</span></div>
                <div class="button" id="flee-button">TAKE COVER <span class="hotkey">(4)</span></div>
            </div>
            
            <!-- Quick Slots in Battle -->
            <div class="quick-slots-container">
                <div class="quick-slot" data-slot="0" id="battle-quick-slot-0">1</div>
                <div class="quick-slot" data-slot="1" id="battle-quick-slot-1">2</div>
                <div class="quick-slot" data-slot="2" id="battle-quick-slot-2">3</div>
            </div>
        </div>
        
        <!-- Spell Selection Screen (in battle) -->
        <div id="spell-select-screen" class="screen">
            <h2>SPECIAL ABILITIES</h2>
            <div class="stats">
                <div>Energy: <span id="spell-select-mp">50</span>/<span id="spell-select-max-mp">50</span></div>
            </div>
            <div id="spell-select-list" class="spell-list">
                <!-- Spells will be added here dynamically -->
            </div>
            <div class="button" id="back-from-spell-select">BACK TO COMBAT</div>
        </div>
        
        <!-- Inventory Screen -->
        <div id="inventory-screen" class="screen">
            <h2>INVENTORY</h2>
            <div class="stats">
                <div>Intel: <span id="inventory-gold">10</span></div>
            </div>
            
            <!-- Sort Buttons -->
            <div class="inventory-sort">
                <div class="button sort-button" data-sort="name">Sort by Name</div>
                <div class="button sort-button" data-sort="type">Sort by Type</div>
                <div class="button sort-button" data-sort="rarity">Sort by Rarity</div>
            </div>
            
            <h3>EQUIPMENT</h3>
            <div class="equipment-slots">
                <div class="equipment-slot" data-slot="head">
                    Head: <span id="head-slot">Empty</span>
                    <div id="head-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="chest">
                    Chest: <span id="chest-slot">Empty</span>
                    <div id="chest-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="hands">
                    Hands: <span id="hands-slot">Empty</span>
                    <div id="hands-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="shield">
                    Off-hand: <span id="shield-slot">Empty</span>
                    <div id="shield-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="mainhand">
                    Primary: <span id="mainhand-slot">Empty</span>
                    <div id="mainhand-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="offhand">
                    Secondary: <span id="offhand-slot">Empty</span>
                    <div id="offhand-stats" class="equipment-stats"></div>
                </div>
            </div>
            
            <h3>INVENTORY ITEMS</h3>
            <div class="inventory-grid" id="inventory-items">
                <!-- Items will be added here dynamically -->
            </div>
            
            <div class="button" id="back-from-inventory">BACK TO OPERATIONS</div>
        </div>
        
        <!-- Spells Screen -->
        <div id="spells-screen" class="screen">
            <h2>SPECIAL ABILITIES</h2>
            <div id="spells-list" class="spell-list">
                <!-- Spells will be added here dynamically -->
            </div>
            <div class="button" id="back-from-spells">BACK TO OPERATIONS</div>
        </div>
        
        <!-- Intel Acquisition Screen -->
        <div id="spell-shop-screen" class="screen">
            <h2>ACQUIRE INTEL</h2>
            <div class="stats">
                <div>Intel: <span id="shop-gold">10</span></div>
                <div>Rank: <span id="shop-level">1</span></div>
            </div>
            <div id="spell-shop-items" class="spell-list">
                <!-- Intel items will be added here dynamically -->
            </div>
            <div class="button" id="back-from-spell-shop">BACK TO OPERATIONS</div>
        </div>
        
        <!-- Objectives Screen -->
        <div id="quests-screen" class="screen">
            <h2>MISSION OBJECTIVES</h2>
            <div class="quest-log" id="quest-log">
                <!-- Objectives will be added here dynamically -->
            </div>
            <div class="button" id="back-from-quests">BACK TO OPERATIONS</div>
        </div>
        
        <!-- Training Screen -->
        <div id="skills-screen" class="screen">
            <h2>TRAINING</h2>
            <div class="stats">
                <div>Training Points: <span id="skill-points">0</span></div>
                <div>Specialization: <span id="skill-class">None</span></div>
            </div>
            <div id="skill-tree" class="skill-tree">
                <!-- Skill nodes will be added here dynamically -->
            </div>
            <div class="button" id="back-from-skills">BACK TO OPERATIONS</div>
        </div>
        
        <!-- Citations Screen -->
        <div id="achievements-screen" class="screen">
            <h2>CITATIONS & AWARDS</h2>
            <div id="achievements-list">
                <!-- Achievements will be added here dynamically -->
            </div>
            <div class="button" id="back-from-achievements">BACK TO OPERATIONS</div>
        </div>
        
        <!-- Loot Screen -->
        <div id="loot-screen" class="screen">
            <h2>ENEMY NEUTRALIZED</h2>
            <div class="log">
                <div class="log-entry">Target eliminated!</div>
                <div class="log-entry">Gained <span id="exp-gained">0</span> experience!</div>
                <div class="log-entry">Acquired:</div>
                <div id="loot-items">
                    <!-- Loot items will be added here -->
                </div>
            </div>
            <div class="button" id="take-loot">CONTINUE MISSION</div>
        </div>
    </div>

    <script>
        // Game State for Operation: Valkyrie & Vengeance
        const gameState = {
            currentScreen: 'start',
            player: {
                class: null,
                level: 1,
                exp: 0,
                expNeeded: 100,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                gold: 50,
                strength: 10,
                defense: 5,
                agility: 10,
                magic: 0,
                intelligence: 10,
                dodge: 5,
                critical: 5,
                accuracy: 85,
                equipment: {
                    head: null,
                    chest: null,
                    hands: null,
                    shield: null,
                    mainhand: null,
                    offhand: null
                },
                inventory: [],
                spells: [],
                statusEffects: [],
                quests: [],
                skillPoints: 0,
                skills: [],
                quickSlots: [null, null, null],
                achievements: [],
                completedMainQuests: 0,
                moralityScore: 0, // -100 to 100, affects ending
                discoveredSecrets: []
            },
            currentEnemy: null,
            battleLog: [],
            gameLog: [],
            soundEnabled: true,
            enemyMaxHp: 0,
            saveSlots: 3,
            tooltipTimeout: null,
            // Mission tracking
            enemiesDefeated: 0,
            sectorsCleared: 0,
            totalIntelGathered: 0,
            abilitiesLearned: 0,
            occultistsDefeated: 0,
            ssDefeated: 0,
            werewolvesDefeated: 0,
            necromancersDefeated: 0,
            // New tracking
            sideMissionsCompleted: 0,
            environmentalEvents: 0,
            radioMessages: 0,
            currentLocation: "BERLIN_OUTSKIRTS",
            gamePhase: 1 // 1-5, affects story progression
        };

        // Story Progression Data
        const storyProgression = {
            missionBriefings: {
                1: `
                    <p><strong>DECEMBER 1945 - BERLIN OUTSKIRTS</strong></p>
                    <p>Hitler's occult researches have borne terrible fruit. As the Third Reich collapsed, he activated ancient artifacts that transformed Berlin into a nightmare realm.</p>
                    <p>You are part of an Allied special operations team sent into the heart of the corrupted city. Your mission: penetrate the FÃ¼hrerbunker, neutralize the occult threat, and restore reality before the darkness spreads beyond Germany.</p>
                    <p>The fate of the world hangs in the balance.</p>
                `,
                2: `
                    <p><strong>DECEMBER 1945 - BERLIN URBAN SECTOR</strong></p>
                    <p>You've penetrated the outer defenses. The streets are eerily quiet except for the howling of unnatural winds and distant screams.</p>
                    <p>Radio intercepts suggest Hitler has created a "Reality Anchor" in the FÃ¼hrerbunker. It's warping reality around Berlin. You must find and disable it.</p>
                    <p>Reports indicate some German soldiers have been transformed into werewolf-like creatures. Exercise extreme caution.</p>
                `,
                3: `
                    <p><strong>DECEMBER 1945 - REICHSTAG DISTRICT</strong></p>
                    <p>You're approaching the government district. The air grows thicker with occult energy. Reality itself seems to waver and shift.</p>
                    <p>SS Occultists have erected barriers around the area. You'll need to find their power sources and disable them to proceed.</p>
                    <p>Allied High Command reports similar phenomena appearing in Tokyo. The infection is spreading globally.</p>
                `,
                4: `
                    <p><strong>DECEMBER 1945 - GOVERNMENT QUARTER</strong></p>
                    <p>The FÃ¼hrerbunker lies just ahead. The sky above it swirls with unnatural colors and energy.</p>
                    <p>Intelligence suggests Hitler is no longer fully human. The artifacts have transformed him into something... else. Something that feeds on fear and chaos.</p>
                    <p>This will be your final push. Success means saving the world. Failure means the end of reality as we know it.</p>
                `,
                5: `
                    <p><strong>DECEMBER 1945 - FÃœHRERBUNKER ENTRANCE</strong></p>
                    <p>You stand before the final threshold. The bunker entrance glows with unnatural energy.</p>
                    <p>The ritual is reaching its climax. You can feel reality straining around you. Time is running out.</p>
                    <p>Whatever awaits inside, remember: humanity's future depends on your success. Good luck, soldier.</p>
                `
            },
            
            radioMessages: [
                "Command to operative: Reports of strange energy readings in your sector. Investigate with caution.",
                "Radio intercept: German units are calling for reinforcements. They sound... terrified.",
                "Science team reports: Reality distortion at 23%. The anomaly is growing.",
                "Allied HQ: We're detecting massive energy buildup in the FÃ¼hrerbunker area. Hurry.",
                "Survivor report: Some soldiers are... changing. Becoming monsters. Be careful.",
                "Weather anomaly: Unnatural storm forming over Berlin. Lightning is... wrong color.",
                "Occult analysis: The artifacts are channeling ancient energy. Older than humanity.",
                "Final transmission from previous team: 'The shadows... they're alive!'",
                "Emergency broadcast: Reality distortion at 47%. Effects spreading beyond Berlin.",
                "Command: You're our last hope. All other teams... lost contact."
            ],
            
            bossIntroductions: {
                Necromancer: `
                    <div class="boss-intro">
                        <h3>THE NECROMANCER</h3>
                        <p>The air grows cold as a figure in tattered SS robes rises before you.</p>
                        <p>"The FÃ¼hrer has granted me power over life and death," he cackles.</p>
                        <p>"Your bones will join my army of the damned!"</p>
                    </div>
                `,
                "Shadow Hitler": `
                    <div class="boss-intro">
                        <h3>SHADOW HITLER</h3>
                        <p>The bunker's inner chamber swirls with darkness. A figure materializes from the shadows.</p>
                        <p>It has Hitler's face, but the eyes burn with unnatural fire.</p>
                        <p>"I have become more than human! I am a god!"</p>
                        <p>"And you... are nothing!"</p>
                    </div>
                `,
                "Alpha Werewolf": `
                    <div class="boss-intro">
                        <h3>ALPHA WEREWOLF</h3>
                        <p>A massive, hulking form emerges from the darkness.</p>
                        <p>Its fur is matted with blood and its eyes glow with primal rage.</p>
                        <p>The creature lets out a roar that shakes the very ground.</p>
                        <p>This is no ordinary werewolf - this is their leader.</p>
                    </div>
                `
            },
            
            endings: {
                heroic: {
                    title: "HEROIC VICTORY",
                    description: "You defeated Shadow Hitler and destroyed the Reality Anchor. Berlin returns to normal, and the occult threat is ended forever. You're hailed as a hero who saved the world.",
                    requirements: { morality: 50, secrets: 3, quests: 5 }
                },
                sacrifice: {
                    title: "NOBLE SACRIFICE",
                    description: "You destroyed the Reality Anchor, but at great personal cost. The occult energy was too much for your body to contain. Berlin is saved, but you become one with the energy you fought against.",
                    requirements: { morality: 80, secrets: 2, quests: 4 }
                },
                corrupted: {
                    title: "CORRUPTED VICTORY",
                    description: "You defeated Hitler and took the Reality Anchor's power for yourself. Berlin is saved, but you now wield the very power you fought against. Who will save the world from you?",
                    requirements: { morality: -30, secrets: 4, quests: 3 }
                },
                pyrrhic: {
                    title: "PYRRHIC VICTORY",
                    description: "The Reality Anchor was destroyed, but the backlash destroyed Berlin. The occult threat is ended, but so is the city. You survive, haunted by what you had to do.",
                    requirements: { morality: 0, secrets: 1, quests: 2 }
                },
                failure: {
                    title: "REALITY UNRAVELED",
                    description: "You failed to stop the ritual. Reality unravels, spreading from Berlin across the globe. The world becomes a nightmarish realm of twisted physics and monstrous creatures.",
                    requirements: { morality: -100, secrets: 0, quests: 0 }
                }
            }
        };

        // Environmental Hazards System
        const environmentalEvents = {
            hazards: [
                {
                    name: "Reality Storm",
                    description: "A sudden storm of chaotic energy strikes the area!",
                    effect: "All combatants take 10-20 damage",
                    type: "damage",
                    chance: 0.15
                },
                {
                    name: "Temporal Distortion",
                    description: "Time itself seems to warp and bend!",
                    effect: "All combatants have reduced accuracy this turn",
                    type: "accuracy_debuff",
                    chance: 0.10
                },
                {
                    name: "Occult Surge",
                    description: "A wave of occult energy washes over the battlefield!",
                    effect: "Magic abilities cost 50% more this turn",
                    type: "mana_cost_increase",
                    chance: 0.12
                },
                {
                    name: "Healing Spring",
                    description: "You find a strange, glowing spring!",
                    effect: "Restores 20-40 HP to all living combatants",
                    type: "heal",
                    chance: 0.08
                },
                {
                    name: "Energy Vortex",
                    description: "A vortex of pure energy appears!",
                    effect: "Restores 15-30 Energy to all combatants",
                    type: "mana_restore",
                    chance: 0.07
                },
                {
                    name: "German Artillery",
                    description: "Incoming artillery fire! Take cover!",
                    effect: "Massive damage to all combatants",
                    type: "artillery",
                    chance: 0.05
                }
            ],
            
            triggerEvent: function() {
                // 20% chance of an environmental event during exploration
                if (Math.random() < 0.2) {
                    const event = this.hazards[Math.floor(Math.random() * this.hazards.length)];
                    gameState.environmentalEvents++;
                    return event;
                }
                return null;
            },
            
            applyEventEffect: function(event) {
                const log = document.getElementById('game-log');
                const eventDiv = document.createElement('div');
                eventDiv.className = 'hazard-warning';
                eventDiv.innerHTML = `<strong>${event.name}</strong>: ${event.description}<br>${event.effect}`;
                log.appendChild(eventDiv);
                
                switch(event.type) {
                    case 'damage':
                        const damage = Math.floor(Math.random() * 11) + 10;
                        gameState.player.hp = Math.max(1, gameState.player.hp - damage);
                        addToGameLog(`You take ${damage} damage from the ${event.name}!`);
                        break;
                    case 'heal':
                        const heal = Math.floor(Math.random() * 21) + 20;
                        gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + heal);
                        addToGameLog(`You are healed for ${heal} HP by the ${event.name}!`);
                        break;
                }
                
                updatePlayerStats();
            }
        };

        // Side Missions System
        const sideMissions = {
            missions: [
                {
                    id: "rescuePOW",
                    name: "Rescue Prisoners of War",
                    description: "Rescue 3 Allied POWs held in a nearby building",
                    objective: { type: "rescue", target: "POW", required: 3 },
                    reward: { gold: 150, exp: 100, item: "officer_uniform", morality: 20 },
                    location: "Urban Sector",
                    availableAtLevel: 2
                },
                {
                    id: "destroyArtillery",
                    name: "Destroy Artillery Position",
                    description: "Destroy the German artillery emplacement",
                    objective: { type: "destroy", target: "Artillery", required: 1 },
                    reward: { gold: 200, exp: 120, item: "panzerschreck_part", morality: 10 },
                    location: "Government Quarter",
                    availableAtLevel: 4
                },
                {
                    id: "recoverIntel",
                    name: "Recover Classified Intel",
                    description: "Find and recover classified documents from SS headquarters",
                    objective: { type: "collect", target: "Intel_Documents", required: 5 },
                    reward: { gold: 300, exp: 150, item: "encrypted_radio", morality: 15 },
                    location: "Reichstag District",
                    availableAtLevel: 3
                },
                {
                    id: "eliminateOfficers",
                    name: "Eliminate SS Officers",
                    description: "Take out 4 high-ranking SS officers",
                    objective: { type: "eliminate", target: "SS_Officer", required: 4 },
                    reward: { gold: 250, exp: 130, item: "silver_bullets", morality: 5 },
                    location: "All Sectors",
                    availableAtLevel: 3
                },
                {
                    id: "secureArtifact",
                    name: "Secure Occult Artifact",
                    description: "Recover a dangerous occult artifact before the Germans can use it",
                    objective: { type: "secure", target: "Artifact", required: 1 },
                    reward: { gold: 400, exp: 200, item: "reality_shard", morality: -10 },
                    location: "FÃ¼hrerbunker",
                    availableAtLevel: 5
                }
            ],
            
            activeMissions: [],
            
            checkForNewMission: function() {
                // 25% chance of a new side mission after each battle
                if (Math.random() < 0.25 && this.activeMissions.length < 2) {
                    const availableMissions = this.missions.filter(mission => 
                        mission.availableAtLevel <= gameState.player.level && 
                        !this.activeMissions.some(active => active.id === mission.id)
                    );
                    
                    if (availableMissions.length > 0) {
                        const mission = {...availableMissions[Math.floor(Math.random() * availableMissions.length)]};
                        mission.current = 0;
                        mission.completed = false;
                        this.activeMissions.push(mission);
                        
                        const missionDiv = document.createElement('div');
                        missionDiv.className = 'side-mission';
                        missionDiv.innerHTML = `
                            <strong>NEW SIDE MISSION: ${mission.name}</strong><br>
                            <small>${mission.description}</small><br>
                            <small>Reward: ${mission.reward.gold} Intel, ${mission.reward.exp} EXP</small>
                        `;
                        document.getElementById('game-log').appendChild(missionDiv);
                        
                        addToGameLog(`New side mission available: ${mission.name}`);
                    }
                }
            },
            
            completeMission: function(missionId) {
                const missionIndex = this.activeMissions.findIndex(m => m.id === missionId);
                if (missionIndex !== -1) {
                    const mission = this.activeMissions[missionIndex];
                    const reward = mission.reward;
                    
                    // Give rewards
                    gameState.player.gold += reward.gold;
                    gameState.player.exp += reward.exp;
                    gameState.player.moralityScore += reward.morality || 0;
                    if (reward.item) {
                        gameState.player.inventory.push(reward.item);
                    }
                    
                    // Remove from active missions
                    this.activeMissions.splice(missionIndex, 1);
                    gameState.sideMissionsCompleted++;
                    
                    // Add to log
                    const rewardDiv = document.createElement('div');
                    rewardDiv.className = 'side-mission';
                    rewardDiv.innerHTML = `
                        <strong>SIDE MISSION COMPLETED: ${mission.name}</strong><br>
                        <small>Rewards received: ${reward.gold} Intel, ${reward.exp} EXP</small>
                    `;
                    document.getElementById('game-log').appendChild(rewardDiv);
                    
                    addToGameLog(`Side mission "${mission.name}" completed!`);
                    checkAchievements();
                }
            },
            
            updateMissionProgress: function(enemyName, action) {
                this.activeMissions.forEach(mission => {
                    if (!mission.completed) {
                        if (mission.objective.type === "eliminate" && enemyName.includes(mission.objective.target)) {
                            mission.current++;
                        } else if (mission.objective.type === action) {
                            mission.current++;
                        }
                        
                        if (mission.current >= mission.objective.required) {
                            mission.completed = true;
                            this.completeMission(mission.id);
                        }
                    }
                });
            }
        };

        // Set Bonuses System
        const setBonuses = {
            sets: {
                german_set: {
                    name: "German Officer Set",
                    pieces: ["steel_helmet", "officer_uniform", "mp40"],
                    bonuses: [
                        { pieces: 2, effect: "+10% critical chance" },
                        { pieces: 3, effect: "+15% damage against Allied units" }
                    ]
                },
                occult_set: {
                    name: "Occultist Set",
                    pieces: ["mystic_robe", "occult_focus", "reality_shard"],
                    bonuses: [
                        { pieces: 2, effect: "-20% ability Energy cost" },
                        { pieces: 3, effect: "+25% occult damage" }
                    ]
                },
                commando_set: {
                    name: "Commando Set",
                    pieces: ["combat_armor", "thompson_smg", "reinforced_armor"],
                    bonuses: [
                        { pieces: 2, effect: "+15% max HP" },
                        { pieces: 3, effect: "+20% explosive damage" }
                    ]
                },
                infiltrator_set: {
                    name: "Infiltrator Set",
                    pieces: ["camouflage_gear", "silenced_pistol", "ghost_cloak"],
                    bonuses: [
                        { pieces: 2, effect: "+25% dodge chance" },
                        { pieces: 3, effect: "+30% critical damage" }
                    ]
                }
            },
            
            getActiveSetBonuses: function() {
                const equippedItems = Object.values(gameState.player.equipment).filter(item => item !== null);
                const bonuses = [];
                
                Object.values(this.sets).forEach(set => {
                    const equippedPieces = equippedItems.filter(item => set.pieces.includes(item)).length;
                    
                    set.bonuses.forEach(bonus => {
                        if (equippedPieces >= bonus.pieces) {
                            bonuses.push({
                                set: set.name,
                                pieces: equippedPieces,
                                effect: bonus.effect
                            });
                        }
                    });
                });
                
                return bonuses;
            },
            
            applySetBonuses: function() {
                const bonuses = this.getActiveSetBonuses();
                
                // Reset player stats to base before applying bonuses
                const classData = classes[gameState.player.class];
                if (!classData) return;
                
                // Reapply equipment bonuses first
                // (This would be part of your existing equipment system)
                
                // Then apply set bonuses
                bonuses.forEach(bonus => {
                    addToGameLog(`Set bonus active: ${bonus.set} (${bonus.pieces}/3) - ${bonus.effect}`);
                });
                
                return bonuses;
            }
        };

        // Sound Manager
        const SoundManager = {
            context: null,
            
            init() {
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log("Web Audio API not supported");
                }
            },
            
            playTone(frequency, duration, type = 'sine', volume = 0.1) {
                if (!gameState.soundEnabled || !this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.value = volume;
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.context.currentTime + duration);
                
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + duration);
            },
            
            playClick() {
                this.playTone(800, 0.1, 'square', 0.05);
            },
            
            playGunshot() {
                this.playTone(200, 0.1, 'sawtooth', 0.1);
            },
            
            playOccult() {
                this.playTone(400, 0.4, 'sine', 0.1);
            },
            
            playHeal() {
                this.playTone(300, 0.3, 'sine', 0.1);
            },
            
            playLevelUp() {
                this.playTone(523, 0.1, 'sine', 0.1);
                setTimeout(() => this.playTone(659, 0.1, 'sine', 0.1), 100);
                setTimeout(() => this.playTone(784, 0.1, 'sine', 0.1), 200);
            },
            
            playVictory() {
                this.playTone(784, 0.2, 'sine', 0.1);
                setTimeout(() => this.playTone(659, 0.2, 'sine', 0.1), 200);
                setTimeout(() => this.playTone(523, 0.2, 'sine', 0.1), 400);
            },
            
            playDefeat() {
                this.playTone(150, 0.5, 'sawtooth', 0.1);
            },
            
            playCritical() {
                this.playTone(1200, 0.2, 'sawtooth', 0.2);
            },
            
            playDodge() {
                this.playTone(1400, 0.1, 'triangle', 0.1);
            },
            
            playAchievement() {
                this.playTone(1047, 0.1, 'sine', 0.1);
                setTimeout(() => this.playTone(1319, 0.1, 'sine', 0.1), 100);
                setTimeout(() => this.playTone(1568, 0.2, 'sine', 0.1), 200);
            },
            
            playRadio() {
                this.playTone(600, 0.3, 'square', 0.08);
                setTimeout(() => this.playTone(500, 0.2, 'square', 0.06), 300);
            }
        };

        // Mission Objectives
        const quests = {
            ssElimination: {
                id: "ssElimination",
                name: "SS Elimination",
                description: "Neutralize 5 SS Troopers",
                target: "SS Trooper",
                required: 5,
                current: 0,
                reward: { gold: 100, exp: 50, item: "mp40", morality: 5 },
                completed: false
            },
            occultSuppression: {
                id: "occultSuppression",
                name: "Occult Suppression",
                description: "Destroy 3 Occult Researchers",
                target: "Occult Researcher",
                required: 3,
                current: 0,
                reward: { gold: 75, exp: 40, item: "steel_helmet", morality: 5 },
                completed: false
            },
            werewolfHunter: {
                id: "werewolfHunter",
                name: "Werewolf Hunter",
                description: "Eliminate 4 Werewolf Guards",
                target: "Werewolf Guard",
                required: 4,
                current: 0,
                reward: { gold: 200, exp: 150, item: "silver_bullets", morality: 10 },
                completed: false
            },
            necromancerVanquisher: {
                id: "necromancerVanquisher",
                name: "Necromancer Vanquisher",
                description: "Destroy the Necromancer",
                target: "Necromancer",
                required: 1,
                current: 0,
                reward: { gold: 500, exp: 300, item: "occult_focus", morality: 15 },
                completed: false
            },
            fuhrerbunkerAssault: {
                id: "fuhrerbunkerAssault",
                name: "FÃ¼hrerbunker Assault",
                description: "Breach the FÃ¼hrerbunker",
                target: "Shadow Hitler",
                required: 1,
                current: 0,
                reward: { gold: 1000, exp: 500, item: "reality_anchor", morality: 20 },
                completed: false
            },
            supplyRaid: {
                id: "supplyRaid",
                name: "Supply Raid",
                description: "Collect 10 medkits and 10 energy cells",
                target: "supply_collection",
                required: 20,
                current: 0,
                reward: { gold: 300, exp: 200, item: "combat_stim", morality: 10 },
                completed: false
            }
        };

        // Citations & Awards System
        const achievements = {
            firstBlood: {
                id: "firstBlood",
                name: "First Blood",
                description: "Neutralize your first enemy",
                icon: "âš”ï¸",
                check: () => gameState.enemiesDefeated >= 1,
                unlocked: false
            },
            ssHunter: {
                id: "ssHunter",
                name: "SS Hunter",
                description: "Eliminate 10 SS Troopers",
                icon: "ðŸª–",
                check: () => gameState.ssDefeated >= 10,
                unlocked: false
            },
            masterInfiltrator: {
                id: "masterInfiltrator",
                name: "Master Infiltrator",
                description: "Clear 20 sectors of Berlin",
                icon: "ðŸ—ºï¸",
                check: () => gameState.sectorsCleared >= 20,
                unlocked: false
            },
            intelligenceExpert: {
                id: "intelligenceExpert",
                name: "Intelligence Expert",
                description: "Gather 500 Intel",
                icon: "ðŸ“Š",
                check: () => gameState.totalIntelGathered >= 500,
                unlocked: false
            },
            occultSpecialist: {
                id: "occultSpecialist",
                name: "Occult Specialist",
                description: "Learn 5 supernatural abilities",
                icon: "ðŸ”®",
                check: () => gameState.abilitiesLearned >= 5,
                unlocked: false
            },
            werewolfSlayer: {
                id: "werewolfSlayer",
                name: "Werewolf Slayer",
                description: "Eliminate the Alpha Werewolf",
                icon: "ðŸº",
                check: () => gameState.werewolvesDefeated >= 1,
                unlocked: false
            },
            realityGuardian: {
                id: "realityGuardian",
                name: "Reality Guardian",
                description: "Complete the main mission",
                icon: "ðŸ›¡ï¸",
                check: () => gameState.necromancersDefeated >= 1,
                unlocked: false
            },
            eliteOperative: {
                id: "eliteOperative",
                name: "Elite Operative",
                description: "Reach Rank 15",
                icon: "â­",
                check: () => gameState.player.level >= 15,
                unlocked: false
            },
            sideMissionMaster: {
                id: "sideMissionMaster",
                name: "Side Mission Master",
                description: "Complete 5 side missions",
                icon: "ðŸŽ¯",
                check: () => gameState.sideMissionsCompleted >= 5,
                unlocked: false
            },
            setCollector: {
                id: "setCollector",
                name: "Set Collector",
                description: "Complete a full equipment set",
                icon: "ðŸ†",
                check: function() {
                    const equippedItems = Object.values(gameState.player.equipment).filter(item => item !== null);
                    return Object.values(setBonuses.sets).some(set => 
                        set.pieces.every(piece => equippedItems.includes(piece))
                    );
                },
                unlocked: false
            }
        };

        // Training Trees
        const skillTrees = {
            commando: [
                { id: "commando1", name: "Suppressing Fire", description: "Increases weapon damage by 15%", cost: 1, effect: "damageBoost", value: 0.15, requires: [] },
                { id: "commando2", name: "Combat Armor", description: "Increases defense by 20%", cost: 1, effect: "defenseBoost", value: 0.2, requires: ["commando1"] },
                { id: "commando3", name: "Grenade Expert", description: "Critical chance increased by 8%", cost: 2, effect: "criticalBoost", value: 8, requires: ["commando1"] },
                { id: "commando4", name: "Adrenaline Rush", description: "Chance to heal when below 30% HP", cost: 2, effect: "secondWind", value: 0.25, requires: ["commando2", "commando3"] },
                { id: "commando5", name: "Heavy Weapons", description: "Can use heavy weapons", cost: 2, effect: "heavyWeapons", value: 0, requires: ["commando2"] },
                { id: "commando6", name: "Berserker", description: "Damage increases as HP decreases", cost: 3, effect: "berserkerRage", value: 0.4, requires: ["commando4"] }
            ],
            occultist: [
                { id: "occultist1", name: "Reality Warp", description: "Occult damage increased by 20%", cost: 1, effect: "spellDamageBoost", value: 0.2, requires: [] },
                { id: "occultist2", name: "Energy Efficiency", description: "Ability costs reduced by 25%", cost: 1, effect: "manaEfficiency", value: 0.25, requires: ["occultist1"] },
                { id: "occultist3", name: "Elemental Mastery", description: "Chance to apply elemental effects", cost: 2, effect: "elementalMastery", value: 0.2, requires: ["occultist1"] },
                { id: "occultist4", name: "Psychic Barrier", description: "Chance to negate enemy attacks", cost: 2, effect: "psychicBarrier", value: 0.15, requires: ["occultist2", "occultist3"] },
                { id: "occultist5", name: "Reality Anchor", description: "Resistance to occult effects", cost: 2, effect: "realityAnchor", value: 0.3, requires: ["occultist2"] },
                { id: "occultist6", name: "Time Dilation", description: "Occasionally get extra turns", cost: 3, effect: "timeDilation", value: 0.1, requires: ["occultist4"] }
            ],
            infiltrator: [
                { id: "infiltrator1", name: "Precision Shot", description: "Critical damage increased by 30%", cost: 1, effect: "criticalDamage", value: 0.3, requires: [] },
                { id: "infiltrator2", name: "Shadow Move", description: "Dodge chance increased by 12%", cost: 1, effect: "dodgeBoost", value: 12, requires: ["infiltrator1"] },
                { id: "infiltrator3", name: "Poisoned Blade", description: "Chance to apply poison on hit", cost: 2, effect: "poisonChance", value: 0.25, requires: ["infiltrator1"] },
                { id: "infiltrator4", name: "Silent Elimination", description: "Chance to instantly kill weak enemies", cost: 2, effect: "assassinate", value: 0.15, requires: ["infiltrator2", "infiltrator3"] },
                { id: "infiltrator5", name: "Smoke Bomb", description: "Chance to escape battles automatically", cost: 2, effect: "smokeBomb", value: 0.35, requires: ["infiltrator2"] },
                { id: "infiltrator6", name: "Ghost Strike", description: "Chance to attack twice", cost: 3, effect: "doubleAttack", value: 0.2, requires: ["infiltrator4"] }
            ]
        };

        // Operative Classes
        const classes = {
            commando: {
                name: "Commando",
                hp: 120,
                mp: 40,
                strength: 16,
                defense: 12,
                agility: 7,
                magic: 0,
                intelligence: 6,
                dodge: 3,
                critical: 6,
                accuracy: 80,
                startingItems: ['thompson_smg', 'combat_armor', 'medkit'],
                startingSpells: ['grenade_toss']
            },
            occultist: {
                name: "Occultist",
                hp: 85,
                mp: 110,
                strength: 4,
                defense: 3,
                agility: 9,
                magic: 18,
                intelligence: 16,
                dodge: 6,
                critical: 9,
                accuracy: 90,
                startingItems: ['ritual_focus', 'occult_robes', 'energy_cell', 'medkit'],
                startingSpells: ['reality_bolt']
            },
            infiltrator: {
                name: "Infiltrator",
                hp: 95,
                mp: 70,
                strength: 13,
                defense: 4,
                agility: 17,
                magic: 5,
                intelligence: 9,
                dodge: 12,
                critical: 18,
                accuracy: 96,
                startingItems: ['silenced_pistol', 'camouflage_gear', 'medkit'],
                startingSpells: ['shadow_strike']
            }
        };

        // WWII Supernatural Items
        const items = {
            // Common Weapons
            thompson_smg: { 
                name: "Thompson SMG", 
                type: "weapon", 
                slot: "mainhand", 
                damage: { min: 10, max: 16 },
                strength: 3,
                critical: 3,
                value: 20,
                rarity: "common",
                set: "commando_set"
            },
            silenced_pistol: { 
                name: "Silenced Pistol", 
                type: "weapon", 
                slot: "mainhand", 
                damage: { min: 8, max: 12 },
                agility: 4,
                critical: 8,
                value: 15,
                rarity: "common",
                set: "infiltrator_set"
            },
            ritual_focus: { 
                name: "Ritual Focus", 
                type: "weapon", 
                slot: "mainhand", 
                damage: { min: 4, max: 8 },
                magic: 6,
                intelligence: 3,
                value: 18,
                rarity: "common",
                set: null
            },
            
            // Uncommon Weapons
            mp40: { 
                name: "MP40", 
                type: "weapon", 
                slot: "mainhand", 
                damage: { min: 14, max: 20 },
                strength: 4,
                critical: 4,
                value: 35,
                rarity: "uncommon",
                set: "german_set"
            },
            kar98k: {
                name: "Karabiner 98k",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 18, max: 24 },
                strength: 2,
                critical: 10,
                value: 40,
                rarity: "uncommon",
                set: null
            },
            occult_focus: {
                name: "Occult Focus",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 6, max: 12 },
                magic: 10,
                intelligence: 5,
                value: 45,
                rarity: "uncommon",
                set: "occult_set"
            },
            
            // Rare Weapons
            mg42: {
                name: "MG42",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 20, max: 28 },
                strength: 6,
                critical: 5,
                value: 110,
                rarity: "rare",
                set: null
            },
            silver_bullets: {
                name: "Silver Bullets",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 16, max: 22 },
                agility: 9,
                critical: 18,
                value: 100,
                rarity: "rare",
                set: null
            },
            reality_shard: {
                name: "Reality Shard",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 10, max: 18 },
                magic: 15,
                intelligence: 10,
                value: 120,
                rarity: "rare",
                set: "occult_set"
            },
            
            // Epic Weapons
            panzerschreck: {
                name: "Panzerschreck",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 28, max: 38 },
                strength: 12,
                critical: 8,
                value: 320,
                rarity: "epic",
                set: null
            },
            void_blade: {
                name: "Void Blade",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 22, max: 32 },
                agility: 14,
                critical: 25,
                value: 300,
                rarity: "epic",
                set: null
            },
            reality_anchor: {
                name: "Reality Anchor",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 18, max: 28 },
                magic: 28,
                intelligence: 15,
                value: 350,
                rarity: "epic",
                set: null
            },
            
            // Common Armor
            combat_armor: { 
                name: "Combat Armor", 
                type: "armor", 
                slot: "chest", 
                defense: 8,
                strength: 2,
                value: 15,
                rarity: "common",
                set: "commando_set"
            },
            occult_robes: { 
                name: "Occult Robes", 
                type: "armor", 
                slot: "chest", 
                defense: 3, 
                magic: 5,
                intelligence: 3,
                value: 12,
                rarity: "common",
                set: null
            },
            camouflage_gear: { 
                name: "Camouflage Gear", 
                type: "armor", 
                slot: "chest", 
                defense: 4,
                agility: 5,
                dodge: 4,
                value: 10,
                rarity: "common",
                set: "infiltrator_set"
            },
            
            // Uncommon Armor
            steel_helmet: { 
                name: "Steel Helmet", 
                type: "armor", 
                slot: "head", 
                defense: 5,
                value: 20,
                rarity: "uncommon",
                set: "german_set"
            },
            reinforced_armor: {
                name: "Reinforced Armor",
                type: "armor",
                slot: "chest",
                defense: 12,
                strength: 3,
                agility: -2,
                value: 40,
                rarity: "uncommon",
                set: "commando_set"
            },
            mystic_robe: {
                name: "Mystic Robe",
                type: "armor",
                slot: "chest",
                defense: 6,
                magic: 8,
                intelligence: 6,
                value: 45,
                rarity: "uncommon",
                set: "occult_set"
            },
            
            // Rare Armor
            officer_uniform: {
                name: "Officer Uniform",
                type: "armor",
                slot: "chest",
                defense: 8,
                agility: 9,
                dodge: 10,
                value: 80,
                rarity: "rare",
                set: "german_set"
            },
            ghost_cloak: {
                name: "Ghost Cloak",
                type: "armor",
                slot: "chest",
                defense: 7,
                agility: 12,
                dodge: 15,
                value: 95,
                rarity: "rare",
                set: "infiltrator_set"
            },
            
            // Consumables
            medkit: { 
                name: "Medkit", 
                type: "consumable", 
                effect: "heal", 
                power: 40, 
                value: 8,
                rarity: "common"
            },
            energy_cell: { 
                name: "Energy Cell", 
                type: "consumable", 
                effect: "restore_mana", 
                power: 30, 
                value: 8,
                rarity: "common"
            },
            combat_stim: {
                name: "Combat Stim",
                type: "consumable",
                effect: "strength_boost",
                power: 6,
                duration: 4,
                value: 25,
                rarity: "uncommon"
            },
            adrenaline_syringe: {
                name: "Adrenaline Syringe",
                type: "consumable",
                effect: "agility_boost",
                power: 8,
                duration: 3,
                value: 30,
                rarity: "uncommon"
            },
            occult_powder: {
                name: "Occult Powder",
                type: "consumable",
                effect: "magic_boost",
                power: 7,
                duration: 4,
                value: 35,
                rarity: "uncommon"
            },
            
            // New items for set bonuses
            panzerschreck_part: {
                name: "Panzerschreck Part",
                type: "misc",
                value: 50,
                rarity: "rare"
            },
            encrypted_radio: {
                name: "Encrypted Radio",
                type: "misc",
                value: 75,
                rarity: "rare"
            }
        };

        // Supernatural Abilities
        const spells = {
            grenade_toss: { 
                name: "Grenade Toss", 
                cost: 8, 
                damage: { min: 25, max: 35 },
                type: "attack",
                element: "explosive",
                accuracy: 85,
                levelReq: 1,
                goldCost: 25,
                description: "Throw a fragmentation grenade at the enemy",
                effect: { type: "burning", chance: 0.3, duration: 2, damage: 5 }
            },
            shadow_strike: { 
                name: "Shadow Strike", 
                cost: 10, 
                damage: { min: 30, max: 40 },
                type: "attack",
                element: "dark",
                accuracy: 95,
                critical: 20,
                levelReq: 1,
                goldCost: 35,
                description: "Strike from the shadows with increased critical chance"
            },
            reality_bolt: { 
                name: "Reality Bolt", 
                cost: 6, 
                damage: { min: 20, max: 30 },
                type: "attack",
                element: "arcane",
                accuracy: 90,
                levelReq: 1,
                goldCost: 30,
                description: "Fire a bolt of distorted reality",
                effect: { type: "cursed", chance: 0.2, duration: 3, damage: 4 }
            },
            field_medic: { 
                name: "Field Medic", 
                cost: 12, 
                power: 35, 
                type: "heal",
                levelReq: 2,
                goldCost: 60,
                description: "Apply emergency medical treatment"
            },
            ice_shard: {
                name: "Frost Grenade",
                cost: 9,
                damage: { min: 15, max: 25 },
                type: "attack",
                element: "ice",
                accuracy: 80,
                levelReq: 3,
                goldCost: 45,
                description: "Launch a freezing explosive device",
                effect: { type: "frozen", chance: 0.2, duration: 1 }
            },
            lightning_strike: {
                name: "Lightning Strike",
                cost: 15,
                damage: { min: 35, max: 45 },
                type: "attack",
                element: "lightning",
                accuracy: 85,
                levelReq: 4,
                goldCost: 70,
                description: "Call down electrical energy",
                effect: { type: "shocked", chance: 0.15, duration: 2 }
            },
            temporal_distortion: {
                name: "Temporal Distortion",
                cost: 25,
                damage: { min: 50, max: 70 },
                type: "attack",
                element: "time",
                accuracy: 80,
                levelReq: 8,
                goldCost: 160,
                description: "Warp time around the target",
                effect: { type: "slowed", chance: 0.4, duration: 3 }
            },
            psychic_barrier: {
                name: "Psychic Barrier",
                cost: 18,
                type: "buff",
                levelReq: 5,
                goldCost: 90,
                description: "Create a protective psychic field",
                effect: { type: "barrier", chance: 1.0, duration: 3, value: 40 }
            },
            reality_shift: {
                name: "Reality Shift",
                cost: 30,
                type: "buff",
                levelReq: 10,
                goldCost: 220,
                description: "Phase slightly out of reality, increasing dodge",
                effect: { type: "dodge_boost", chance: 1.0, duration: 3, value: 30 }
            }
        };

        // Enhanced Supernatural WWII Enemies with more variety
        const enemies = {
            level1: [
                { 
                    name: "SS Trooper", 
                    hp: 35, 
                    attack: 10, 
                    defense: 3, 
                    agility: 8,
                    dodge: 6,
                    critical: 6,
                    accuracy: 78,
                    exp: 25, 
                    gold: 8, 
                    loot: [
                        { id: 'medkit', chance: 0.7 }
                    ],
                    resistances: { explosive: 0.8 },
                    weaknesses: { arcane: 1.5 }
                },
                { 
                    name: "Wehrmacht Soldier", 
                    hp: 30, 
                    attack: 9, 
                    defense: 4, 
                    agility: 7,
                    dodge: 5,
                    critical: 4,
                    accuracy: 75,
                    exp: 22, 
                    gold: 6, 
                    loot: [
                        { id: 'steel_helmet', chance: 0.5 }
                    ],
                    resistances: { physical: 0.9 },
                    weaknesses: { explosive: 1.5 }
                },
                { 
                    name: "Occult Researcher", 
                    hp: 28, 
                    attack: 12, 
                    defense: 2, 
                    agility: 9,
                    dodge: 7,
                    critical: 8,
                    accuracy: 85,
                    exp: 28, 
                    gold: 10, 
                    loot: [
                        { id: 'energy_cell', chance: 0.8 }
                    ],
                    abilities: ["reality_bolt"],
                    resistances: { arcane: 0.7, dark: 0.8 },
                    weaknesses: { physical: 1.3 }
                },
                // New Level 1 Enemies
                { 
                    name: "SS Guard Dog", 
                    hp: 25, 
                    attack: 12, 
                    defense: 1, 
                    agility: 14,
                    dodge: 10,
                    critical: 12,
                    accuracy: 70,
                    exp: 20, 
                    gold: 5, 
                    loot: [
                        { id: 'medkit', chance: 0.4 }
                    ],
                    abilities: ["savage_bite"],
                    resistances: { physical: 0.8 },
                    weaknesses: { fire: 1.5 }
                },
                { 
                    name: "Corrupted Civilian", 
                    hp: 20, 
                    attack: 8, 
                    defense: 0, 
                    agility: 6,
                    dodge: 3,
                    critical: 2,
                    accuracy: 65,
                    exp: 18, 
                    gold: 3, 
                    loot: [
                        { id: 'energy_cell', chance: 0.3 }
                    ],
                    resistances: { arcane: 0.5 },
                    weaknesses: { physical: 1.8 },
                    special: "Sometimes drops intel about secrets"
                },
                { 
                    name: "Panzerfaust Trooper", 
                    hp: 40, 
                    attack: 15, 
                    defense: 5, 
                    agility: 5,
                    dodge: 3,
                    critical: 10,
                    accuracy: 75,
                    exp: 30, 
                    gold: 12, 
                    loot: [
                        { id: 'combat_stim', chance: 0.6 }
                    ],
                    abilities: ["explosive_shot"],
                    resistances: { explosive: 0.9 },
                    weaknesses: { lightning: 1.5 }
                }
            ],
            level2: [
                { 
                    name: "Werewolf Guard", 
                    hp: 60, 
                    attack: 16, 
                    defense: 5, 
                    agility: 12,
                    dodge: 10,
                    critical: 12,
                    accuracy: 82,
                    exp: 45, 
                    gold: 18, 
                    loot: [
                        { id: 'medkit', chance: 0.8 },
                        { id: 'adrenaline_syringe', chance: 0.6 }
                    ],
                    abilities: ["savage_strike"],
                    resistances: { physical: 0.7, dark: 0.9 },
                    weaknesses: { silver: 2.0, fire: 1.5 }
                },
                { 
                    name: "Panzer Grenadier", 
                    hp: 55, 
                    attack: 18, 
                    defense: 8, 
                    agility: 6,
                    dodge: 4,
                    critical: 5,
                    accuracy: 80,
                    exp: 50, 
                    gold: 20, 
                    loot: [
                        { id: 'reinforced_armor', chance: 0.7 }
                    ],
                    abilities: ["grenade_toss"]
                },
                { 
                    name: "Reality Twister", 
                    hp: 50, 
                    attack: 20, 
                    defense: 3, 
                    agility: 11,
                    dodge: 9,
                    critical: 15,
                    accuracy: 88,
                    exp: 48, 
                    gold: 15, 
                    loot: [
                        { id: 'occult_powder', chance: 0.7 }
                    ],
                    abilities: ["temporal_distortion"],
                    resistances: { arcane: 0.9, time: 0.8 },
                    weaknesses: { reality: 2.0 }
                },
                // New Level 2 Enemies
                { 
                    name: "SS Sniper", 
                    hp: 45, 
                    attack: 22, 
                    defense: 2, 
                    agility: 10,
                    dodge: 8,
                    critical: 25,
                    accuracy: 95,
                    exp: 42, 
                    gold: 16, 
                    loot: [
                        { id: 'silenced_pistol', chance: 0.5 }
                    ],
                    abilities: ["sniper_shot"],
                    resistances: { physical: 0.8 },
                    weaknesses: { close_combat: 1.8 }
                },
                { 
                    name: "Void Spawn", 
                    hp: 65, 
                    attack: 19, 
                    defense: 4, 
                    agility: 8,
                    dodge: 7,
                    critical: 18,
                    accuracy: 78,
                    exp: 52, 
                    gold: 22, 
                    loot: [
                        { id: 'reality_shard', chance: 0.3 }
                    ],
                    abilities: ["void_blast"],
                    resistances: { dark: 1.2, arcane: 0.9 },
                    weaknesses: { light: 2.5 }
                },
                { 
                    name: "Corrupted Officer", 
                    hp: 58, 
                    attack: 17, 
                    defense: 7, 
                    agility: 9,
                    dodge: 6,
                    critical: 12,
                    accuracy: 84,
                    exp: 46, 
                    gold: 19, 
                    loot: [
                        { id: 'officer_uniform', chance: 0.6 }
                    ],
                    abilities: ["command_aura"],
                    resistances: { physical: 0.9 },
                    weaknesses: { explosive: 1.6 }
                }
            ],
            level3: [
                { 
                    name: "SS Occultist", 
                    hp: 90, 
                    attack: 24, 
                    defense: 6, 
                    agility: 13,
                    dodge: 11,
                    critical: 18,
                    accuracy: 87,
                    exp: 70, 
                    gold: 35, 
                    loot: [
                        { id: 'mystic_robe', chance: 0.8 },
                        { id: 'energy_cell', chance: 0.9 }
                    ],
                    abilities: ["psychic_barrier", "reality_bolt"],
                    resistances: { arcane: 0.9, dark: 0.8 },
                    weaknesses: { reality: 1.8, light: 1.5 }
                },
                { 
                    name: "Panzerwolf", 
                    hp: 110, 
                    attack: 28, 
                    defense: 9, 
                    agility: 10,
                    dodge: 8,
                    critical: 14,
                    accuracy: 85,
                    exp: 85, 
                    gold: 45, 
                    loot: [
                        { id: 'silver_bullets', chance: 0.7 }
                    ],
                    abilities: ["savage_strike", "howl"],
                    resistances: { physical: 0.8, dark: 0.9 },
                    weaknesses: { silver: 2.5, fire: 1.8 }
                },
                { 
                    name: "Void Stalker", 
                    hp: 95, 
                    attack: 26, 
                    defense: 7, 
                    agility: 15,
                    dodge: 14,
                    critical: 22,
                    accuracy: 92,
                    exp: 80, 
                    gold: 50, 
                    loot: [
                        { id: 'ghost_cloak', chance: 0.6 }
                    ],
                    abilities: ["shadow_strike", "phase_shift"],
                    resistances: { dark: 1.0, physical: 0.6 },
                    weaknesses: { light: 2.5, reality: 2.0 }
                },
                // New Level 3 Enemies
                { 
                    name: "Reality Breaker", 
                    hp: 105, 
                    attack: 30, 
                    defense: 8, 
                    agility: 12,
                    dodge: 10,
                    critical: 20,
                    accuracy: 86,
                    exp: 88, 
                    gold: 48, 
                    loot: [
                        { id: 'reality_anchor', chance: 0.2 }
                    ],
                    abilities: ["reality_rupture"],
                    resistances: { arcane: 1.1, time: 0.7 },
                    weaknesses: { physical: 1.7 }
                },
                { 
                    name: "Shadow Assassin", 
                    hp: 88, 
                    attack: 32, 
                    defense: 5, 
                    agility: 18,
                    dodge: 16,
                    critical: 30,
                    accuracy: 94,
                    exp: 78, 
                    gold: 42, 
                    loot: [
                        { id: 'void_blade', chance: 0.4 }
                    ],
                    abilities: ["assassinate", "shadow_dance"],
                    resistances: { dark: 1.3 },
                    weaknesses: { light: 3.0 }
                },
                { 
                    name: "Abomination", 
                    hp: 130, 
                    attack: 26, 
                    defense: 12, 
                    agility: 6,
                    dodge: 4,
                    critical: 8,
                    accuracy: 80,
                    exp: 92, 
                    gold: 55, 
                    loot: [
                        { id: 'panzerschreck', chance: 0.5 }
                    ],
                    abilities: ["crushing_blow"],
                    resistances: { physical: 1.2, explosive: 0.8 },
                    weaknesses: { arcane: 1.9 }
                }
            ],
            bosses: [
                {
                    name: "Necromancer",
                    hp: 250,
                    attack: 32,
                    defense: 10,
                    agility: 14,
                    dodge: 12,
                    critical: 25,
                    accuracy: 90,
                    exp: 200,
                    gold: 150,
                    loot: [
                        { id: 'reality_shard', chance: 0.6 },
                        { id: 'occult_focus', chance: 0.6 },
                        { id: 'reality_anchor', chance: 0.2 }
                    ],
                    isBoss: true,
                    phases: [
                        { hpThreshold: 0.75, ability: "summon_undead", message: "The Necromancer summons spectral soldiers!" },
                        { hpThreshold: 0.5, ability: "death_aura", message: "A chilling death aura fills the area!" },
                        { hpThreshold: 0.25, ability: "soul_drain", message: "The Necromancer begins draining life force!" }
                    ],
                    abilities: {
                        summon_undead: { count: 2, cooldown: 4 },
                        death_aura: { damage: 20, duration: 3 },
                        soul_drain: { heal: 60, cooldown: 5 }
                    }
                },
                {
                    name: "Shadow Hitler",
                    hp: 300,
                    attack: 35,
                    defense: 12,
                    agility: 16,
                    dodge: 15,
                    critical: 20,
                    accuracy: 95,
                    exp: 300,
                    gold: 250,
                    loot: [
                        { id: 'void_blade', chance: 0.5 },
                        { id: 'reality_anchor', chance: 0.5 },
                        { id: 'panzerschreck', chance: 0.3 }
                    ],
                    isBoss: true,
                    phases: [
                        { hpThreshold: 0.8, ability: "rally_troops", message: "Hitler calls for reinforcements!" },
                        { hpThreshold: 0.6, ability: "occult_power", message: "Dark energy surges around Hitler!" },
                        { hpThreshold: 0.3, ability: "final_solution", message: "Hitler unleashes his ultimate occult power!" }
                    ],
                    abilities: {
                        rally_troops: { count: 3, cooldown: 4 },
                        occult_power: { damage: 40, cooldown: 3 },
                        final_solution: { damage: 60, cooldown: 6 }
                    }
                },
                // New Boss
                {
                    name: "Alpha Werewolf",
                    hp: 280,
                    attack: 38,
                    defense: 11,
                    agility: 17,
                    dodge: 14,
                    critical: 28,
                    accuracy: 88,
                    exp: 260,
                    gold: 180,
                    loot: [
                        { id: 'silver_bullets', chance: 0.8 },
                        { id: 'ghost_cloak', chance: 0.4 }
                    ],
                    isBoss: true,
                    phases: [
                        { hpThreshold: 0.7, ability: "summon_pack", message: "The Alpha Werewolf howls, calling its pack!" },
                        { hpThreshold: 0.4, ability: "blood_frenzy", message: "The Alpha enters a blood frenzy!" },
                        { hpThreshold: 0.2, ability: "moonlight_heal", message: "Moonlight heals the Alpha Werewolf!" }
                    ],
                    abilities: {
                        summon_pack: { count: 3, cooldown: 5 },
                        blood_frenzy: { damage: 50, cooldown: 3 },
                        moonlight_heal: { heal: 80, cooldown: 6 }
                    }
                }
            ]
        };

        // DOM Elements
        const screens = {
            start: document.getElementById('start-screen'),
            load: document.getElementById('load-screen'),
            class: document.getElementById('class-screen'),
            game: document.getElementById('game-screen'),
            battle: document.getElementById('battle-screen'),
            spellSelect: document.getElementById('spell-select-screen'),
            inventory: document.getElementById('inventory-screen'),
            spells: document.getElementById('spells-screen'),
            spellShop: document.getElementById('spell-shop-screen'),
            quests: document.getElementById('quests-screen'),
            skills: document.getElementById('skills-screen'),
            achievements: document.getElementById('achievements-screen'),
            loot: document.getElementById('loot-screen')
        };

        // Story Progression Functions
        function updateMissionBriefing() {
            const briefingElement = document.getElementById('mission-briefing');
            const phase = Math.min(gameState.gamePhase, 5);
            briefingElement.innerHTML = storyProgression.missionBriefings[phase];
        }

        function showRadioMessage() {
            // 15% chance of a radio message when exploring
            if (Math.random() < 0.15 && gameState.radioMessages < 10) {
                const message = storyProgression.radioMessages[gameState.radioMessages];
                if (message) {
                    const radioDiv = document.createElement('div');
                    radioDiv.className = 'radio-message';
                    radioDiv.innerHTML = `<strong>RADIO:</strong> ${message}`;
                    document.getElementById('game-log').appendChild(radioDiv);
                    
                    SoundManager.playRadio();
                    gameState.radioMessages++;
                    
                    // Check for secret triggers in radio messages
                    if (message.includes("secret") || message.includes("ancient") || message.includes("older than humanity")) {
                        if (!gameState.player.discoveredSecrets.includes("radio_secret")) {
                            gameState.player.discoveredSecrets.push("radio_secret");
                            addToGameLog("Secret discovered: Radio intercept contains hidden information!");
                        }
                    }
                }
            }
        }

        function showBossIntroduction(bossName) {
            if (storyProgression.bossIntroductions[bossName]) {
                const introDiv = document.createElement('div');
                introDiv.innerHTML = storyProgression.bossIntroductions[bossName];
                document.getElementById('battle-log').appendChild(introDiv);
                
                // Pause briefly for dramatic effect
                return new Promise(resolve => {
                    setTimeout(resolve, 3000);
                });
            }
            return Promise.resolve();
        }

        function checkGamePhase() {
            const oldPhase = gameState.gamePhase;
            
            // Update phase based on player level
            if (gameState.player.level >= 10) {
                gameState.gamePhase = 5;
                gameState.currentLocation = "FÃœHRERBUNKER";
            } else if (gameState.player.level >= 8) {
                gameState.gamePhase = 4;
                gameState.currentLocation = "GOVERNMENT_QUARTER";
            } else if (gameState.player.level >= 6) {
                gameState.gamePhase = 3;
                gameState.currentLocation = "REICHSTAG_DISTRICT";
            } else if (gameState.player.level >= 3) {
                gameState.gamePhase = 2;
                gameState.currentLocation = "URBAN_SECTOR";
            } else {
                gameState.gamePhase = 1;
                gameState.currentLocation = "BERLIN_OUTSKIRTS";
            }
            
            // Update location display
            document.getElementById('location-display').textContent = gameState.currentLocation.replace(/_/g, ' ');
            
            // If phase changed, show update
            if (oldPhase !== gameState.gamePhase) {
                addToGameLog(`Advanced to ${gameState.currentLocation.replace(/_/g, ' ')}`);
                updateMissionBriefing();
            }
        }

        function determineEnding() {
            const endings = storyProgression.endings;
            const playerStats = {
                morality: gameState.player.moralityScore,
                secrets: gameState.player.discoveredSecrets.length,
                quests: gameState.player.completedMainQuests
            };
            
            // Check each ending's requirements
            for (const [key, ending] of Object.entries(endings)) {
                const req = ending.requirements;
                if (playerStats.morality >= req.morality && 
                    playerStats.secrets >= req.secrets && 
                    playerStats.quests >= req.quests) {
                    return ending;
                }
            }
            
            // Default to pyrrhic victory if no other ending matches
            return endings.pyrrhic;
        }

        function showEnding() {
            const ending = determineEnding();
            
            // Create ending screen
            const endingScreen = document.createElement('div');
            endingScreen.id = 'ending-screen';
            endingScreen.className = 'screen active';
            endingScreen.style.background = 'rgba(10, 10, 26, 0.95)';
            endingScreen.style.padding = '20px';
            endingScreen.style.textAlign = 'center';
            endingScreen.innerHTML = `
                <h1 style="color: #ffcc00; margin-bottom: 30px;">${ending.title}</h1>
                <div class="mission-briefing" style="max-width: 500px; margin: 0 auto 30px;">
                    <p style="font-size: 18px; line-height: 1.6;">${ending.description}</p>
                </div>
                <div style="margin: 20px 0;">
                    <h3>Mission Statistics</h3>
                    <p>Enemies Defeated: ${gameState.enemiesDefeated}</p>
                    <p>Sectors Cleared: ${gameState.sectorsCleared}</p>
                    <p>Side Missions Completed: ${gameState.sideMissionsCompleted}</p>
                    <p>Final Rank: ${gameState.player.level}</p>
                    <p>Morality Score: ${gameState.player.moralityScore}</p>
                    <p>Secrets Discovered: ${gameState.player.discoveredSecrets.length}</p>
                </div>
                <div class="button" id="restart-button" style="margin: 20px auto; width: 200px;">NEW GAME</div>
            `;
            
            document.getElementById('game-container').appendChild(endingScreen);
            
            // Add restart button functionality
            document.getElementById('restart-button').addEventListener('click', () => {
                location.reload();
            });
            
            // Save ending achievement
            if (!gameState.player.achievements.includes("ending_" + ending.title.toLowerCase().replace(/\s+/g, '_'))) {
                gameState.player.achievements.push("ending_" + ending.title.toLowerCase().replace(/\s+/g, '_'));
            }
        }

        // Initialize game
        function initGame() {
            console.log("Initializing Operation: Valkyrie & Vengeance...");
            
            // Initialize sound manager
            SoundManager.init();
            
            // Set initial mission briefing
            updateMissionBriefing();
            
            // Set up event listeners
            document.getElementById('start-button').addEventListener('click', () => {
                SoundManager.playClick();
                showClassSelection();
            });
            
            document.getElementById('load-button').addEventListener('click', () => {
                SoundManager.playClick();
                showLoadScreen();
            });
            
            const classOptions = document.querySelectorAll('.class-option');
            classOptions.forEach(option => {
                option.addEventListener('click', () => {
                    SoundManager.playClick();
                    selectClass(option.dataset.class);
                });
            });
            
            document.getElementById('explore-button').addEventListener('click', () => {
                SoundManager.playClick();
                // Check for environmental events
                const event = environmentalEvents.triggerEvent();
                if (event) {
                    environmentalEvents.applyEventEffect(event);
                }
                
                // Check for radio messages
                showRadioMessage();
                
                // Check for side missions
                sideMissions.checkForNewMission();
                
                startBattle();
            });
            
            document.getElementById('inventory-button').addEventListener('click', () => {
                SoundManager.playClick();
                showInventory();
            });
            
            document.getElementById('spells-button').addEventListener('click', () => {
                SoundManager.playClick();
                showSpells();
            });
            
            document.getElementById('spell-shop-button').addEventListener('click', () => {
                SoundManager.playClick();
                showSpellShop();
            });
            
            document.getElementById('quests-button').addEventListener('click', () => {
                SoundManager.playClick();
                showQuests();
            });
            
            document.getElementById('skills-button').addEventListener('click', () => {
                SoundManager.playClick();
                showSkills();
            });
            
            document.getElementById('achievements-button').addEventListener('click', () => {
                SoundManager.playClick();
                showAchievements();
            });
            
            document.getElementById('save-button').addEventListener('click', () => {
                SoundManager.playClick();
                saveGame(0);
                addToGameLog("Mission progress saved!");
            });
            
            // Back buttons
            document.getElementById('back-from-inventory').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-spells').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-spell-shop').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-quests').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-skills').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-achievements').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-load').addEventListener('click', () => {
                SoundManager.playClick();
                showScreen('start');
            });
            
            document.getElementById('back-from-spell-select').addEventListener('click', () => {
                SoundManager.playClick();
                showBattleScreen();
            });
            
            // Battle buttons
            document.getElementById('attack-button').addEventListener('click', playerAttack);
            document.getElementById('spell-button').addEventListener('click', () => {
                SoundManager.playClick();
                showSpellSelection();
            });
            document.getElementById('item-button').addEventListener('click', useItemInBattle);
            document.getElementById('flee-button').addEventListener('click', attemptFlee);
            
            document.getElementById('take-loot').addEventListener('click', () => {
                SoundManager.playClick();
                takeLoot();
            });
            
            // Sound toggle
            document.getElementById('sound-toggle').addEventListener('click', toggleSound);
            
            // Sort buttons
            document.querySelectorAll('.sort-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    SoundManager.playClick();
                    sortInventory(e.target.dataset.sort);
                });
            });
            
            // Quick slots
            document.querySelectorAll('.quick-slot').forEach(slot => {
                slot.addEventListener('click', (e) => {
                    SoundManager.playClick();
                    useQuickSlot(parseInt(e.target.dataset.slot));
                });
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyPress);
            
            // Initialize objectives
            initializeQuests();
            
            // Initialize achievements
            initializeAchievements();
            
            // Initialize game log
            addToGameLog("You stand at the edge of the corrupted Berlin sector. The air crackles with unnatural energy...");
            
            console.log("Operation: Valkyrie & Vengeance initialized successfully");
        }

        // Screen management
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            
            screens[screenName].classList.add('active');
            gameState.currentScreen = screenName;
        }

        function showClassSelection() {
            showScreen('class');
        }

        function selectClass(className) {
            gameState.player.class = className;
            const classData = classes[className];
            
            // Set player stats based on class
            gameState.player.maxHp = classData.hp;
            gameState.player.hp = classData.hp;
            gameState.player.maxMp = classData.mp;
            gameState.player.mp = classData.mp;
            gameState.player.strength = classData.strength;
            gameState.player.defense = classData.defense;
            gameState.player.agility = classData.agility;
            gameState.player.magic = classData.magic;
            gameState.player.intelligence = classData.intelligence;
            gameState.player.dodge = classData.dodge;
            gameState.player.critical = classData.critical;
            gameState.player.accuracy = classData.accuracy;
            
            // Add starting items
            classData.startingItems.forEach(itemId => {
                gameState.player.inventory.push(itemId);
            });
            
            // Add starting spells
            classData.startingSpells.forEach(spellId => {
                gameState.player.spells.push(spellId);
            });
            
            // Equip starting items
            if (className === 'commando') {
                equipItem('thompson_smg', 'mainhand');
                equipItem('combat_armor', 'chest');
            } else if (className === 'occultist') {
                equipItem('ritual_focus', 'mainhand');
                equipItem('occult_robes', 'chest');
            } else if (className === 'infiltrator') {
                equipItem('silenced_pistol', 'mainhand');
                equipItem('camouflage_gear', 'chest');
            }
            
            // Update UI
            updatePlayerStats();
            showGameScreen();
            
            addToGameLog(`You have selected the ${classData.name} specialization.`);
            addToGameLog("Beginning incursion into the corrupted Berlin sector...");
        }

        function showGameScreen() {
            showScreen('game');
            updatePlayerStats();
            updateStatusEffects();
            checkGamePhase();
        }

        function showBattleScreen() {
            showScreen('battle');
            updateBattleStats();
        }

        function showInventory() {
            showScreen('inventory');
            updateInventoryDisplay();
        }

        function showSpells() {
            showScreen('spells');
            updateSpellsDisplay();
        }

        function showSpellShop() {
            showScreen('spellShop');
            updateSpellShopDisplay();
        }

        function showSpellSelection() {
            showScreen('spellSelect');
            updateSpellSelectionDisplay();
        }

        function showQuests() {
            showScreen('quests');
            updateQuestsDisplay();
        }

        function showSkills() {
            showScreen('skills');
            updateSkillsDisplay();
        }

        function showAchievements() {
            showScreen('achievements');
            updateAchievementsDisplay();
        }

        function showLoadScreen() {
            showScreen('load');
            updateLoadScreen();
        }

        // Initialize objectives
        function initializeQuests() {
            gameState.player.quests = [
                { ...quests.ssElimination },
                { ...quests.occultSuppression },
                { ...quests.werewolfHunter },
                { ...quests.necromancerVanquisher },
                { ...quests.fuhrerbunkerAssault },
                { ...quests.supplyRaid }
            ];
        }

        // Initialize achievements
        function initializeAchievements() {
            gameState.player.achievements = [];
        }

        // Check achievements
        function checkAchievements() {
            Object.keys(achievements).forEach(achievementId => {
                const achievement = achievements[achievementId];
                if (!gameState.player.achievements.includes(achievementId) && achievement.check()) {
                    unlockAchievement(achievementId);
                }
            });
        }

        function unlockAchievement(achievementId) {
            const achievement = achievements[achievementId];
            gameState.player.achievements.push(achievementId);
            
            // Show achievement popup
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <div class="achievement-icon">${achievement.icon}</div>
                <h3>Citation Awarded!</h3>
                <strong>${achievement.name}</strong><br>
                <small>${achievement.description}</small>
            `;
            
            document.body.appendChild(popup);
            
            // Play sound
            SoundManager.playAchievement();
            
            // Remove popup after animation
            setTimeout(() => {
                popup.remove();
            }, 3000);
            
            addToGameLog(`Citation awarded: ${achievement.name}!`);
        }

        // Handle keyboard shortcuts
        function handleKeyPress(event) {
            if (gameState.currentScreen === 'battle') {
                switch(event.key) {
                    case '1':
                        SoundManager.playClick();
                        playerAttack();
                        break;
                    case '2':
                        SoundManager.playClick();
                        showSpellSelection();
                        break;
                    case '3':
                        SoundManager.playClick();
                        useItemInBattle();
                        break;
                    case '4':
                        SoundManager.playClick();
                        attemptFlee();
                        break;
                }
            }
        }

        // Toggle sound on/off
        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            document.getElementById('sound-toggle').textContent = 
                gameState.soundEnabled ? "ðŸ”Š SOUND ON" : "ðŸ”‡ SOUND OFF";
            SoundManager.playClick();
        }

        // Quick Slot System
        function useQuickSlot(slot) {
            const itemId = gameState.player.quickSlots[slot];
            if (!itemId) return;
            
            if (items[itemId]) {
                // It's an item
                useItem(itemId);
            } else if (spells[itemId]) {
                // It's a spell
                if (gameState.currentScreen === 'battle') {
                    castSpell(itemId);
                }
            }
        }

        function assignQuickSlot(slot, itemId) {
            gameState.player.quickSlots[slot] = itemId;
            updateQuickSlotDisplay();
        }

        function updateQuickSlotDisplay() {
            for (let i = 0; i < 3; i++) {
                const itemId = gameState.player.quickSlots[i];
                const slotElement = document.getElementById(`quick-slot-${i}`);
                const battleSlotElement = document.getElementById(`battle-quick-slot-${i}`);
                
                if (itemId) {
                    const item = items[itemId] || spells[itemId];
                    if (item) {
                        slotElement.textContent = `${i + 1}: ${item.name.substring(0, 4)}`;
                        if (battleSlotElement) {
                            battleSlotElement.textContent = `${i + 1}: ${item.name.substring(0, 4)}`;
                        }
                    }
                } else {
                    slotElement.textContent = i + 1;
                    if (battleSlotElement) {
                        battleSlotElement.textContent = i + 1;
                    }
                }
            }
        }

        // Save System
        function saveGame(slot) {
            const saveData = {
                player: gameState.player,
                timestamp: Date.now(),
                version: "1.1",
                enemiesDefeated: gameState.enemiesDefeated,
                sectorsCleared: gameState.sectorsCleared,
                totalIntelGathered: gameState.totalIntelGathered,
                abilitiesLearned: gameState.abilitiesLearned,
                occultistsDefeated: gameState.occultistsDefeated,
                ssDefeated: gameState.ssDefeated,
                werewolvesDefeated: gameState.werewolvesDefeated,
                necromancersDefeated: gameState.necromancersDefeated,
                sideMissionsCompleted: gameState.sideMissionsCompleted,
                environmentalEvents: gameState.environmentalEvents,
                radioMessages: gameState.radioMessages,
                currentLocation: gameState.currentLocation,
                gamePhase: gameState.gamePhase
            };
            
            localStorage.setItem(`operationValkyrieSave_${slot}`, JSON.stringify(saveData));
        }

        function loadGame(slot) {
            const saveData = localStorage.getItem(`operationValkyrieSave_${slot}`);
            if (saveData) {
                const data = JSON.parse(saveData);
                
                // Restore game state
                gameState.player = data.player;
                gameState.enemiesDefeated = data.enemiesDefeated || 0;
                gameState.sectorsCleared = data.sectorsCleared || 0;
                gameState.totalIntelGathered = data.totalIntelGathered || 0;
                gameState.abilitiesLearned = data.abilitiesLearned || 0;
                gameState.occultistsDefeated = data.occultistsDefeated || 0;
                gameState.ssDefeated = data.ssDefeated || 0;
                gameState.werewolvesDefeated = data.werewolvesDefeated || 0;
                gameState.necromancersDefeated = data.necromancersDefeated || 0;
                gameState.sideMissionsCompleted = data.sideMissionsCompleted || 0;
                gameState.environmentalEvents = data.environmentalEvents || 0;
                gameState.radioMessages = data.radioMessages || 0;
                gameState.currentLocation = data.currentLocation || "BERLIN_OUTSKIRTS";
                gameState.gamePhase = data.gamePhase || 1;
                
                updatePlayerStats();
                showGameScreen();
                addToGameLog("Mission data loaded successfully!");
                
                // Check achievements after load
                checkAchievements();
                
                // Update location display
                document.getElementById('location-display').textContent = gameState.currentLocation.replace(/_/g, ' ');
            }
        }

        function updateLoadScreen() {
            const saveSlotsElement = document.getElementById('save-slots');
            saveSlotsElement.innerHTML = '';
            
            for (let i = 0; i < gameState.saveSlots; i++) {
                const saveData = localStorage.getItem(`operationValkyrieSave_${i}`);
                const slotElement = document.createElement('div');
                slotElement.className = 'save-slot';
                
                if (saveData) {
                    const data = JSON.parse(saveData);
                    const date = new Date(data.timestamp);
                    slotElement.innerHTML = `
                        <strong>Slot ${i + 1}</strong><br>
                        Rank ${data.player.level} ${data.player.class}<br>
                        <small class="save-info">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</small>
                    `;
                } else {
                    slotElement.innerHTML = `
                        <strong>Slot ${i + 1}</strong><br>
                        <small class="save-info">Empty</small>
                    `;
                }
                
                slotElement.addEventListener('click', () => {
                    if (saveData) {
                        loadGame(i);
                    }
                });
                
                saveSlotsElement.appendChild(slotElement);
            }
        }

        // Training System
        function updateSkillsDisplay() {
            document.getElementById('skill-points').textContent = gameState.player.skillPoints;
            document.getElementById('skill-class').textContent = gameState.player.class ? 
                gameState.player.class.charAt(0).toUpperCase() + gameState.player.class.slice(1) : 'None';
            
            const skillTreeElement = document.getElementById('skill-tree');
            skillTreeElement.innerHTML = '';
            
            if (!gameState.player.class) {
                skillTreeElement.innerHTML = '<div>Select operative specialization first!</div>';
                return;
            }
            
            const skills = skillTrees[gameState.player.class];
            skills.forEach(skill => {
                const isUnlocked = gameState.player.skills.includes(skill.id);
                const requirementsMet = skill.requires.every(req => gameState.player.skills.includes(req));
                const canUnlock = !isUnlocked && requirementsMet && gameState.player.skillPoints >= skill.cost;
                
                const skillElement = document.createElement('div');
                skillElement.className = `skill-node ${isUnlocked ? 'unlocked' : canUnlock ? 'available' : 'locked'}`;
                skillElement.innerHTML = `
                    <strong>${skill.name}</strong><br>
                    <small>${skill.description}</small><br>
                    <small>Cost: ${skill.cost} point(s)</small>
                `;
                
                if (canUnlock) {
                    skillElement.addEventListener('click', () => {
                        unlockSkill(skill.id);
                    });
                }
                
                skillTreeElement.appendChild(skillElement);
            });
        }

        function unlockSkill(skillId) {
            const skills = skillTrees[gameState.player.class];
            const skill = skills.find(s => s.id === skillId);
            
            if (skill && gameState.player.skillPoints >= skill.cost && !gameState.player.skills.includes(skillId)) {
                gameState.player.skillPoints -= skill.cost;
                gameState.player.skills.push(skillId);
                
                // Apply skill effect
                applySkillEffect(skill);
                
                addToGameLog(`Trained skill: ${skill.name}!`);
                updateSkillsDisplay();
                updatePlayerStats();
            }
        }

        function applySkillEffect(skill) {
            // Apply skill effects to player stats
            switch(skill.effect) {
                case 'damageBoost':
                    gameState.player.strength = Math.floor(gameState.player.strength * (1 + skill.value));
                    break;
                case 'defenseBoost':
                    gameState.player.defense = Math.floor(gameState.player.defense * (1 + skill.value));
                    break;
                case 'criticalBoost':
                    gameState.player.critical += skill.value;
                    break;
                case 'spellDamageBoost':
                    gameState.player.magic = Math.floor(gameState.player.magic * (1 + skill.value));
                    break;
                case 'dodgeBoost':
                    gameState.player.dodge += skill.value;
                    break;
            }
        }

       function startBattle() {
    // Determine enemy based on player level
    let enemyPool;
    if (gameState.player.level <= 2) {
        enemyPool = enemies.level1;
    } else if (gameState.player.level <= 4) {
        enemyPool = enemies.level2;
    } else if (gameState.player.level <= 6) {
        enemyPool = enemies.level3;
    } else {
        // Chance for boss encounter at higher levels
        if (Math.random() < 0.3) {
            enemyPool = enemies.bosses;
        } else {
            // Use level3 enemies for high-level non-boss encounters
            enemyPool = enemies.level3;
        }
    }
    
    // Select random enemy
    const randomIndex = Math.floor(Math.random() * enemyPool.length);
    gameState.currentEnemy = { ...enemyPool[randomIndex] };
    gameState.enemyMaxHp = gameState.currentEnemy.hp;
    
    // Initialize boss systems if it's a boss
    if (gameState.currentEnemy.isBoss) {
        document.getElementById('boss-health-container').style.display = 'block';
        updateBossHealth();
        gameState.currentEnemy.currentPhase = 0;
        
        // Show boss introduction
        showBossIntroduction(gameState.currentEnemy.name).then(() => {
            addToBattleLog(`A ${gameState.currentEnemy.name} appears!`);
        });
    } else {
        document.getElementById('boss-health-container').style.display = 'none';
        addToBattleLog(`A ${gameState.currentEnemy.name} appears!`);
    }
    
    // Reset battle log
    gameState.battleLog = [];
    
    // Update battle UI
    updateBattleStats();
    
    // Display enemy
    const enemyDisplay = document.getElementById('enemy-display');
    enemyDisplay.textContent = `[${gameState.currentEnemy.name.toUpperCase()}]`;
    
    // Add boss styling for high-level enemies
    if (gameState.currentEnemy.isBoss) {
        enemyDisplay.classList.add('boss-enemy');
        addToBattleLog("A major threat detected! Exercise extreme caution!");
    } else {
        enemyDisplay.classList.remove('boss-enemy');
    }
    
    showScreen('battle');
}

        function playerAttack() {
            if (!gameState.currentEnemy) return;
            
            SoundManager.playGunshot();
            
            // Calculate hit chance
            const playerAccuracy = gameState.player.accuracy;
            const enemyDodge = gameState.currentEnemy.dodge;
            const hitChance = Math.max(10, Math.min(95, playerAccuracy - enemyDodge));
            
            // Check if attack hits
            if (Math.random() * 100 > hitChance) {
                addToBattleLog(`<span class="miss-message">Your attack missed the target!</span>`);
                enemyAttack();
                return;
            }
            
            // Calculate player damage
            const playerStrength = gameState.player.strength;
            const weapon = gameState.player.equipment.mainhand ? items[gameState.player.equipment.mainhand] : null;
            const baseDamage = weapon ? 
                Math.floor(Math.random() * (weapon.damage.max - weapon.damage.min + 1)) + weapon.damage.min :
                8;
                
            const strengthBonus = Math.floor(playerStrength / 4);
            let damage = baseDamage + strengthBonus;
            
            // Check for critical hit
            const criticalChance = gameState.player.critical + (weapon ? weapon.critical || 0 : 0);
            let isCritical = false;
            
            if (Math.random() * 100 < criticalChance) {
                damage = Math.floor(damage * 1.6);
                isCritical = true;
                SoundManager.playCritical();
            }
            
            // Apply enemy defense
            const enemyDefense = gameState.currentEnemy.defense;
            damage = Math.max(1, damage - Math.floor(enemyDefense / 2));
            
            // Apply damage
            gameState.currentEnemy.hp -= damage;
            
            // Display attack result
            if (isCritical) {
                addToBattleLog(`<span class="crit-message">CRITICAL HIT! You strike the ${gameState.currentEnemy.name} for ${damage} damage!</span>`);
            } else {
                addToBattleLog(`You hit the ${gameState.currentEnemy.name} for ${damage} damage!`);
            }
            
            // Show floating damage number
            showFloatingText(damage, document.getElementById('enemy-display'), isCritical ? 'damage-text crit-message' : 'damage-text');
            
            if (gameState.currentEnemy.isBoss) {
                updateBossHealth();
            } else {
                updateEnemyHP();
            }
            
            if (gameState.currentEnemy.hp <= 0) {
                enemyDefeated();
                return;
            }
            
            // Enemy attacks back
            enemyAttack();
        }

        function enemyAttack() {
            if (!gameState.currentEnemy) return;
            
            // Calculate hit chance
            const enemyAccuracy = gameState.currentEnemy.accuracy;
            const playerDodge = gameState.player.dodge;
            const hitChance = Math.max(10, Math.min(95, enemyAccuracy - playerDodge));
            
            // Check if attack hits
            if (Math.random() * 100 > hitChance) {
                addToBattleLog(`<span class="dodge-message">You dodged the ${gameState.currentEnemy.name}'s attack!</span>`);
                SoundManager.playDodge();
                return;
            }
            
            // Calculate enemy damage
            const enemyAttack = gameState.currentEnemy.attack;
            const baseDamage = Math.floor(Math.random() * 6) + enemyAttack - 3;
            
            // Check for critical hit
            const criticalChance = gameState.currentEnemy.critical;
            let damage, isCritical = false;
            
            if (Math.random() * 100 < criticalChance) {
                damage = Math.floor(baseDamage * 1.6);
                isCritical = true;
            } else {
                damage = baseDamage;
            }
            
            // Apply player defense
            const playerDefense = gameState.player.defense;
            damage = Math.max(1, damage - Math.floor(playerDefense / 2));
            
            // Apply damage
            gameState.player.hp -= damage;
            
            // Display attack result
            if (isCritical) {
                addToBattleLog(`<span class="crit-message">CRITICAL HIT! The ${gameState.currentEnemy.name} hits you for ${damage} damage!</span>`);
            } else {
                addToBattleLog(`The ${gameState.currentEnemy.name} hits you for ${damage} damage!`);
            }
            
            // Show floating damage number and shake effect
            showFloatingText(damage, document.getElementById('battle-player-hp').parentElement, isCritical ? 'damage-text crit-message' : 'damage-text');
            document.getElementById('battle-screen').classList.add('shake');
            setTimeout(() => document.getElementById('battle-screen').classList.remove('shake'), 300);
            
            updatePlayerHP();
            
            if (gameState.player.hp <= 0) {
                playerDefeated();
            }
        }

        function castSpell(spellId) {
            const spell = spells[spellId];
            
            // Check if player has enough Energy
            if (gameState.player.mp < spell.cost) {
                addToBattleLog(`Not enough Energy to use ${spell.name}!`);
                showBattleScreen();
                return;
            }
            
            SoundManager.playOccult();
            
            // Deduct Energy cost
            gameState.player.mp -= spell.cost;
            updatePlayerMP();
            
            // Check if ability hits
            const spellAccuracy = spell.accuracy || 85;
            if (Math.random() * 100 > spellAccuracy) {
                addToBattleLog(`<span class="miss-message">Your ${spell.name} missed!</span>`);
                enemyAttack();
                showBattleScreen();
                return;
            }
            
            if (spell.type === 'attack') {
                const minDamage = spell.damage.min + Math.floor(gameState.player.magic / 3);
                const maxDamage = spell.damage.max + Math.floor(gameState.player.magic / 2);
                let damage = Math.floor(Math.random() * (maxDamage - minDamage + 1)) + minDamage;
                
                // Check for spell critical (based on intelligence)
                let isCritical = false;
                if (spell.critical && Math.random() * 100 < (spell.critical + Math.floor(gameState.player.intelligence / 5))) {
                    damage = Math.floor(damage * 1.6);
                    isCritical = true;
                    SoundManager.playCritical();
                }
                
                gameState.currentEnemy.hp -= damage;
                
                if (isCritical) {
                    addToBattleLog(`<span class="crit-message">CRITICAL ABILITY! You use ${spell.name} for ${damage} damage!</span>`);
                } else {
                    addToBattleLog(`You use ${spell.name} for ${damage} damage!`);
                }
                
                // Show floating damage number
                showFloatingText(damage, document.getElementById('enemy-display'), isCritical ? 'damage-text crit-message' : 'damage-text');
                
                if (gameState.currentEnemy.isBoss) {
                    updateBossHealth();
                } else {
                    updateEnemyHP();
                }
                
                if (gameState.currentEnemy.hp <= 0) {
                    enemyDefeated();
                    return;
                }
            } else if (spell.type === 'heal') {
                SoundManager.playHeal();
                const healAmount = spell.power + Math.floor(gameState.player.magic / 2);
                gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
                addToBattleLog(`You use ${spell.name} and heal for ${healAmount} HP!`);
                
                // Show floating heal number
                showFloatingText(healAmount, document.getElementById('battle-player-hp').parentElement, 'heal-text');
                
                updatePlayerHP();
            }
            
            // Enemy attacks back
            enemyAttack();
            
            showBattleScreen();
        }

        function enemyDefeated() {
            SoundManager.playVictory();
            addToBattleLog(`You neutralized the ${gameState.currentEnemy.name}!`);
            
            // Calculate experience gained
            const expGained = gameState.currentEnemy.exp;
            gameState.player.exp += expGained;
            
            // Update objective progress
            updateQuestProgress(gameState.currentEnemy.name);
            
            // Update side mission progress
            sideMissions.updateMissionProgress(gameState.currentEnemy.name, "eliminate");
            
            // Update mission tracking
            gameState.enemiesDefeated++;
            gameState.sectorsCleared++;
            
            if (gameState.currentEnemy.name === "SS Trooper" || gameState.currentEnemy.name.includes("SS")) {
                gameState.ssDefeated++;
            }
            if (gameState.currentEnemy.name === "Necromancer") {
                gameState.necromancersDefeated++;
                gameState.player.completedMainQuests++;
            }
            if (gameState.currentEnemy.name.includes("Werewolf")) {
                gameState.werewolvesDefeated++;
            }
            if (gameState.currentEnemy.name.includes("Occult")) {
                gameState.occultistsDefeated++;
            }
            
            // Check for main quest completion (Shadow Hitler)
            if (gameState.currentEnemy.name === "Shadow Hitler") {
                gameState.player.completedMainQuests++;
                // Show ending
                setTimeout(showEnding, 2000);
            }
            
            // Check for rank up
            if (gameState.player.exp >= gameState.player.expNeeded) {
                levelUp();
            }
            
            // Collect loot
            const loot = [];
            const intelGained = gameState.currentEnemy.gold;
            gameState.player.gold += intelGained;
            gameState.totalIntelGathered += intelGained;
            
            // Check each loot item from enemy's loot table
            gameState.currentEnemy.loot.forEach(lootItem => {
                if (Math.random() < lootItem.chance) {
                    loot.push(lootItem.id);
                }
            });
            
            // Check for rare additional loot
            const rareLootChance = 0.12 + (gameState.player.level * 0.04);
            if (Math.random() < rareLootChance) {
                // Get all uncommon, rare, and epic items
                const rareItems = Object.keys(items).filter(itemId => {
                    const rarity = items[itemId].rarity;
                    return rarity === 'uncommon' || rarity === 'rare' || rarity === 'epic';
                });
                
                if (rareItems.length > 0) {
                    const randomRareItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                    loot.push(randomRareItem);
                    addToBattleLog(`<span class="rarity-${items[randomRareItem].rarity}">RARE FIND: Acquired ${items[randomRareItem].name}!</span>`);
                }
            }
            
            // Check for secret discovery
            if (gameState.currentEnemy.special && Math.random() < 0.1) {
                const secretId = `enemy_${gameState.currentEnemy.name.toLowerCase().replace(/\s+/g, '_')}_secret`;
                if (!gameState.player.discoveredSecrets.includes(secretId)) {
                    gameState.player.discoveredSecrets.push(secretId);
                    addToBattleLog(`<span class="rarity-rare">SECRET DISCOVERED: ${gameState.currentEnemy.special}</span>`);
                }
            }
            
            // Add loot to inventory
            loot.forEach(itemId => {
                gameState.player.inventory.push(itemId);
            });
            
            // Display loot screen
            document.getElementById('exp-gained').textContent = expGained;
            
            const lootItemsElement = document.getElementById('loot-items');
            lootItemsElement.innerHTML = '';
            
            loot.forEach(itemId => {
                const itemElement = document.createElement('div');
                itemElement.className = `log-entry loot-item rarity-${items[itemId].rarity}`;
                itemElement.textContent = items[itemId].name;
                lootItemsElement.appendChild(itemElement);
            });
            
            if (intelGained > 0) {
                const intelElement = document.createElement('div');
                intelElement.className = 'log-entry loot-item';
                intelElement.textContent = `${intelGained} Intel`;
                lootItemsElement.appendChild(intelElement);
            }
            
            // Check achievements
            checkAchievements();
            
            // Check set bonuses
            const setBonusesActive = setBonuses.getActiveSetBonuses();
            if (setBonusesActive.length > 0) {
                setBonusesActive.forEach(bonus => {
                    addToBattleLog(`<span class="set-bonus-indicator">Set Bonus: ${bonus.effect}</span>`);
                });
            }
            
            showScreen('loot');
        }

        function playerDefeated() {
            SoundManager.playDefeat();
            addToBattleLog("You have been incapacitated...");
            addToBattleLog("You regain consciousness at a safe location, wounded but alive.");
            
            // Reset player HP to 40%
            gameState.player.hp = Math.floor(gameState.player.maxHp * 0.4);
            gameState.player.mp = Math.floor(gameState.player.maxMp * 0.4);
            
            // Lose some intel
            const intelLost = Math.floor(gameState.player.gold * 0.15);
            gameState.player.gold -= intelLost;
            
            // Morality penalty for failure
            gameState.player.moralityScore -= 5;
            
            setTimeout(() => {
                addToGameLog(`You were incapacitated and lost ${intelLost} Intel.`);
                showGameScreen();
                updatePlayerStats();
            }, 2000);
        }

        function attemptFlee() {
            // Flee chance based on player agility vs enemy agility
            const playerAgility = gameState.player.agility;
            const enemyAgility = gameState.currentEnemy.agility;
            const fleeChance = 0.35 + (playerAgility - enemyAgility) * 0.025;
            
            if (Math.random() < fleeChance) {
                addToBattleLog("You successfully took cover and disengaged!");
                // Morality penalty for fleeing
                gameState.player.moralityScore -= 2;
                setTimeout(() => {
                    showGameScreen();
                }, 1000);
            } else {
                addToBattleLog("You failed to disengage!");
                enemyAttack();
            }
        }

        function useItemInBattle() {
            // Find medkit if available
            const medkitIndex = gameState.player.inventory.indexOf('medkit');
            
            if (medkitIndex !== -1) {
                SoundManager.playHeal();
                // Use medkit
                gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + items.medkit.power);
                gameState.player.inventory.splice(medkitIndex, 1);
                addToBattleLog("You used a Medkit!");
                
                // Show floating heal number
                showFloatingText(items.medkit.power, document.getElementById('battle-player-hp').parentElement, 'heal-text');
                
                updatePlayerHP();
                
                // Enemy still attacks
                enemyAttack();
            } else {
                addToBattleLog("You don't have any usable equipment!");
            }
        }

        function takeLoot() {
            showGameScreen();
            updatePlayerStats();
            addToGameLog("You continue advancing through the corrupted Berlin streets...");
            
            // Update game phase
            checkGamePhase();
        }

        // Level system
        function levelUp() {
            SoundManager.playLevelUp();
            gameState.player.level++;
            gameState.player.exp -= gameState.player.expNeeded;
            gameState.player.expNeeded = Math.floor(gameState.player.expNeeded * 1.5);
            
            // Increase stats based on class
            const classData = classes[gameState.player.class];
            
            gameState.player.maxHp += 22 + (classData.hp > 100 ? 6 : 0);
            gameState.player.hp = gameState.player.maxHp;
            gameState.player.maxMp += 12 + (classData.mp > 50 ? 6 : 0);
            gameState.player.mp = gameState.player.maxMp;
            gameState.player.strength += 2 + (classData.strength > 10 ? 1 : 0);
            gameState.player.defense += 1 + (classData.defense > 5 ? 1 : 0);
            gameState.player.agility += 1 + (classData.agility > 10 ? 1 : 0);
            gameState.player.magic += 1 + (classData.magic > 5 ? 1 : 0);
            gameState.player.intelligence += 1 + (classData.intelligence > 10 ? 1 : 0);
            gameState.player.dodge += 0.6;
            gameState.player.critical += 0.6;
            
            // Grant training point every 2 levels
            if (gameState.player.level % 2 === 0) {
                gameState.player.skillPoints++;
                addToGameLog("You gained a training point!");
            }
            
            // Morality reward for leveling up
            gameState.player.moralityScore += 3;
            
            addToGameLog(`You advanced to Rank ${gameState.player.level}!`);
            addToGameLog("Your combat effectiveness has improved!");
            
            updatePlayerStats();
            checkGamePhase();
        }

        // Update objective progress
        function updateQuestProgress(enemyName) {
            gameState.player.quests.forEach(quest => {
                if (!quest.completed) {
                    if (quest.target === enemyName) {
                        quest.current++;
                    } else if (quest.target === "supply_collection") {
                        // Special case for supply collection quest
                        if (enemyName === "medkit" || enemyName === "energy_cell") {
                            quest.current++;
                        }
                    }
                    
                    if (quest.current >= quest.required) {
                        quest.completed = true;
                        gameState.player.completedMainQuests++;
                        addToGameLog(`Objective completed: ${quest.name}!`);
                        
                        // Give rewards
                        gameState.player.gold += quest.reward.gold;
                        gameState.player.exp += quest.reward.exp;
                        gameState.player.moralityScore += quest.reward.morality || 0;
                        if (quest.reward.item) {
                            gameState.player.inventory.push(quest.reward.item);
                            addToGameLog(`You received ${items[quest.reward.item].name} as a reward!`);
                        }
                        
                        addToGameLog(`You received ${quest.reward.gold} Intel and ${quest.reward.exp} experience!`);
                    }
                }
            });
        }

        // Floating text for damage/healing
        function showFloatingText(value, parentElement, className) {
            const floatingText = document.createElement('div');
            floatingText.className = `floating-text ${className}`;
            floatingText.textContent = value;
            floatingText.style.left = `${Math.random() * 50 + 25}%`;
            floatingText.style.top = '50%';
            
            parentElement.appendChild(floatingText);
            
            // Remove after animation
            setTimeout(() => {
                floatingText.remove();
            }, 1000);
        }

        // Update boss health display
        function updateBossHealth() {
            const healthPercent = (gameState.currentEnemy.hp / gameState.enemyMaxHp) * 100;
            document.getElementById('boss-health-fill').style.width = `${healthPercent}%`;
            document.getElementById('boss-health-text').textContent = `BOSS HEALTH: ${Math.round(healthPercent)}%`;
        }

        // Update status effects display
        function updateStatusEffects() {
            const statusEffectsElement = document.getElementById('status-effects');
            statusEffectsElement.innerHTML = '';
            
            if (gameState.player.statusEffects.length === 0) {
                statusEffectsElement.innerHTML = '<div>No active effects</div>';
                return;
            }
        }

        // Update objectives display
        function updateQuestsDisplay() {
            const questLogElement = document.getElementById('quest-log');
            questLogElement.innerHTML = '';
            
            // Show main quests
            gameState.player.quests.forEach(quest => {
                const questElement = document.createElement('div');
                questElement.className = `quest-item ${quest.completed ? 'quest-completed' : ''}`;
                
                const progressText = quest.completed ? 
                    'Completed!' : 
                    `${quest.current}/${quest.required} ${quest.target}`;
                
                questElement.innerHTML = `
                    <strong>${quest.name}</strong><br>
                    <small>${quest.description}</small><br>
                    <small>Progress: ${progressText}</small>
                `;
                
                questLogElement.appendChild(questElement);
            });
            
            // Show side missions
            if (sideMissions.activeMissions.length > 0) {
                const sideMissionHeader = document.createElement('div');
                sideMissionHeader.innerHTML = '<h3>SIDE MISSIONS</h3>';
                questLogElement.appendChild(sideMissionHeader);
                
                sideMissions.activeMissions.forEach(mission => {
                    const missionElement = document.createElement('div');
                    missionElement.className = 'side-mission';
                    
                    const progressText = mission.completed ? 
                        'Completed!' : 
                        `${mission.current}/${mission.objective.required} ${mission.objective.target}`;
                    
                    missionElement.innerHTML = `
                        <strong>${mission.name}</strong><br>
                        <small>${mission.description}</small><br>
                        <small>Progress: ${progressText}</small>
                    `;
                    
                    questLogElement.appendChild(missionElement);
                });
            }
        }

        // Update citations display
        function updateAchievementsDisplay() {
            const achievementsElement = document.getElementById('achievements-list');
            achievementsElement.innerHTML = '';
            
            Object.keys(achievements).forEach(achievementId => {
                const achievement = achievements[achievementId];
                const isUnlocked = gameState.player.achievements.includes(achievementId);
                
                const achievementElement = document.createElement('div');
                achievementElement.className = `item ${isUnlocked ? 'rarity-uncommon' : ''}`;
                achievementElement.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div style="font-size: 24px; margin-right: 10px;">${isUnlocked ? achievement.icon : 'â“'}</div>
                        <div>
                            <strong>${achievement.name}</strong><br>
                            <small>${achievement.description}</small><br>
                            <small>${isUnlocked ? 'âœ“ Awarded' : 'Not Yet Earned'}</small>
                        </div>
                    </div>
                `;
                
                achievementsElement.appendChild(achievementElement);
            });
        }

        // Inventory system
        function updateInventoryDisplay() {
            // Update intel display
            document.getElementById('inventory-gold').textContent = gameState.player.gold;
            
            // Update equipment slots with stats
            updateEquipmentDisplay();
            
            // Update inventory items
            const inventoryElement = document.getElementById('inventory-items');
            inventoryElement.innerHTML = '';
            
            // Group items by type for display
            const itemCounts = {};
            gameState.player.inventory.forEach(itemId => {
                itemCounts[itemId] = (itemCounts[itemId] || 0) + 1;
            });
            
            Object.keys(itemCounts).forEach(itemId => {
                const itemElement = document.createElement('div');
                itemElement.className = `item rarity-${items[itemId].rarity}`;
                
                const itemName = document.createElement('div');
                itemName.textContent = `${items[itemId].name} (x${itemCounts[itemId]})`;
                
                const itemStats = document.createElement('div');
                itemStats.className = 'item-stats';
                itemStats.innerHTML = getItemStatsDisplay(itemId);
                
                // Add quick slot assignment buttons
                const quickSlotButtons = document.createElement('div');
                quickSlotButtons.style.marginTop = '5px';
                quickSlotButtons.style.display = 'flex';
                quickSlotButtons.style.gap = '2px';
                
                for (let i = 0; i < 3; i++) {
                    const slotButton = document.createElement('button');
                    slotButton.textContent = `Q${i + 1}`;
                    slotButton.style.flex = '1';
                    slotButton.style.padding = '2px';
                    slotButton.style.fontSize = '10px';
                    slotButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        assignQuickSlot(i, itemId);
                        addToGameLog(`Assigned ${items[itemId].name} to quick slot ${i + 1}`);
                    });
                    quickSlotButtons.appendChild(slotButton);
                }
                
                itemElement.appendChild(itemName);
                itemElement.appendChild(itemStats);
                itemElement.appendChild(quickSlotButtons);
                
                // Add click event to equip/use item
                itemElement.addEventListener('click', () => {
                    SoundManager.playClick();
                    if (items[itemId].type === 'consumable') {
                        useItem(itemId);
                    } else {
                        equipItem(itemId, items[itemId].slot);
                    }
                });
                
                inventoryElement.appendChild(itemElement);
            });
            
            // Show set bonuses
            const setBonusesActive = setBonuses.getActiveSetBonuses();
            if (setBonusesActive.length > 0) {
                const bonusHeader = document.createElement('h3');
                bonusHeader.textContent = 'ACTIVE SET BONUSES';
                inventoryElement.parentNode.insertBefore(bonusHeader, inventoryElement);
                
                setBonusesActive.forEach(bonus => {
                    const bonusElement = document.createElement('div');
                    bonusElement.className = 'set-bonus-indicator';
                    bonusElement.textContent = `${bonus.set} (${bonus.pieces}/3): ${bonus.effect}`;
                    inventoryElement.parentNode.insertBefore(bonusElement, inventoryElement);
                });
            }
        }

        function sortInventory(sortType) {
            // Group items by type for display
            const itemCounts = {};
            gameState.player.inventory.forEach(itemId => {
                itemCounts[itemId] = (itemCounts[itemId] || 0) + 1;
            });
            
            let sortedItems = Object.keys(itemCounts);
            
            switch (sortType) {
                case 'name':
                    sortedItems.sort((a, b) => items[a].name.localeCompare(items[b].name));
                    break;
                case 'type':
                    sortedItems.sort((a, b) => items[a].type.localeCompare(items[b].type));
                    break;
                case 'rarity':
                    const rarityOrder = { common: 0, uncommon: 1, rare: 2, epic: 3, legendary: 4 };
                    sortedItems.sort((a, b) => rarityOrder[items[b].rarity] - rarityOrder[items[a].rarity]);
                    break;
            }
            
            updateInventoryDisplayWithSort(sortedItems, itemCounts);
        }

        function updateInventoryDisplayWithSort(sortedItems, itemCounts) {
            const inventoryElement = document.getElementById('inventory-items');
            inventoryElement.innerHTML = '';
            
            sortedItems.forEach(itemId => {
                const itemElement = document.createElement('div');
                itemElement.className = `item rarity-${items[itemId].rarity}`;
                
                const itemName = document.createElement('div');
                itemName.textContent = `${items[itemId].name} (x${itemCounts[itemId]})`;
                
                const itemStats = document.createElement('div');
                itemStats.className = 'item-stats';
                itemStats.innerHTML = getItemStatsDisplay(itemId);
                
                itemElement.appendChild(itemName);
                itemElement.appendChild(itemStats);
                
                // Add click event to equip/use item
                itemElement.addEventListener('click', () => {
                    SoundManager.playClick();
                    if (items[itemId].type === 'consumable') {
                        useItem(itemId);
                    } else {
                        equipItem(itemId, items[itemId].slot);
                    }
                });
                
                inventoryElement.appendChild(itemElement);
            });
        }

        function updateEquipmentDisplay() {
            // Head
            const headSlot = document.getElementById('head-slot');
            const headStats = document.getElementById('head-stats');
            if (gameState.player.equipment.head) {
                const item = items[gameState.player.equipment.head];
                headSlot.textContent = item.name;
                headStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.head);
            } else {
                headSlot.textContent = 'Empty';
                headStats.innerHTML = '';
            }
            
            // Chest
            const chestSlot = document.getElementById('chest-slot');
            const chestStats = document.getElementById('chest-stats');
            if (gameState.player.equipment.chest) {
                const item = items[gameState.player.equipment.chest];
                chestSlot.textContent = item.name;
                chestStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.chest);
            } else {
                chestSlot.textContent = 'Empty';
                chestStats.innerHTML = '';
            }
            
            // Hands
            const handsSlot = document.getElementById('hands-slot');
            const handsStats = document.getElementById('hands-stats');
            if (gameState.player.equipment.hands) {
                const item = items[gameState.player.equipment.hands];
                handsSlot.textContent = item.name;
                handsStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.hands);
            } else {
                handsSlot.textContent = 'Empty';
                handsStats.innerHTML = '';
            }
            
            // Shield
            const shieldSlot = document.getElementById('shield-slot');
            const shieldStats = document.getElementById('shield-stats');
            if (gameState.player.equipment.shield) {
                const item = items[gameState.player.equipment.shield];
                shieldSlot.textContent = item.name;
                shieldStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.shield);
            } else {
                shieldSlot.textContent = 'Empty';
                shieldStats.innerHTML = '';
            }
            
            // Main Hand
            const mainhandSlot = document.getElementById('mainhand-slot');
            const mainhandStats = document.getElementById('mainhand-stats');
            if (gameState.player.equipment.mainhand) {
                const item = items[gameState.player.equipment.mainhand];
                mainhandSlot.textContent = item.name;
                mainhandStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.mainhand);
            } else {
                mainhandSlot.textContent = 'Empty';
                mainhandStats.innerHTML = '';
            }
            
            // Off Hand
            const offhandSlot = document.getElementById('offhand-slot');
            const offhandStats = document.getElementById('offhand-stats');
            if (gameState.player.equipment.offhand) {
                const item = items[gameState.player.equipment.offhand];
                offhandSlot.textContent = item.name;
                offhandStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.offhand);
            } else {
                offhandSlot.textContent = 'Empty';
                offhandStats.innerHTML = '';
            }
        }

        function getItemStatsDisplay(itemId) {
            const item = items[itemId];
            let statsHTML = '';
            
            if (item.type === 'weapon') {
                statsHTML = `DMG: ${item.damage.min}-${item.damage.max}`;
                
                // Add comparison if player has an equipped item in this slot
                const equippedItemId = gameState.player.equipment[item.slot];
                if (equippedItemId && equippedItemId !== itemId) {
                    const equippedItem = items[equippedItemId];
                    const currentAvg = (equippedItem.damage.min + equippedItem.damage.max) / 2;
                    const newAvg = (item.damage.min + item.damage.max) / 2;
                    
                    if (newAvg > currentAvg) {
                        statsHTML += ` <span class="better-stat">(+${Math.round(newAvg - currentAvg)})</span>`;
                    } else if (newAvg < currentAvg) {
                        statsHTML += ` <span class="worse-stat">(${Math.round(newAvg - currentAvg)})</span>`;
                    } else {
                        statsHTML += ` <span class="same-stat">(=)</span>`;
                    }
                }
                
                // Add other stats
                if (item.strength) statsHTML += ` | STR: ${item.strength}`;
                if (item.agility) statsHTML += ` | AGI: ${item.agility}`;
                if (item.magic) statsHTML += ` | MAG: ${item.magic}`;
                if (item.critical) statsHTML += ` | CRIT: ${item.critical}%`;
            } else if (item.type === 'armor') {
                statsHTML = `DEF: ${item.defense}`;
                
                // Add comparison if player has an equipped item in this slot
                const equippedItemId = gameState.player.equipment[item.slot];
                if (equippedItemId && equippedItemId !== itemId) {
                    const equippedItem = items[equippedItemId];
                    
                    if (item.defense > equippedItem.defense) {
                        statsHTML += ` <span class="better-stat">(+${item.defense - equippedItem.defense})</span>`;
                    } else if (item.defense < equippedItem.defense) {
                        statsHTML += ` <span class="worse-stat">(${item.defense - equippedItem.defense})</span>`;
                    } else {
                        statsHTML += ` <span class="same-stat">(=)</span>`;
                    }
                }
                
                // Add other stats
                if (item.strength) statsHTML += ` | STR: ${item.strength}`;
                if (item.agility) statsHTML += ` | AGI: ${item.agility}`;
                if (item.magic) statsHTML += ` | MAG: ${item.magic}`;
                if (item.dodge) statsHTML += ` | DODGE: ${item.dodge}%`;
            } else if (item.type === 'consumable') {
                if (item.effect === 'heal' || item.effect === 'full_heal') {
                    statsHTML = `Heals: ${item.power} HP`;
                } else if (item.effect === 'restore_mana') {
                    statsHTML = `Restores: ${item.power} Energy`;
                } else if (item.effect.includes('boost')) {
                    statsHTML = `+${item.power} ${item.effect.split('_')[1]} for ${item.duration} turns`;
                }
            }
            
            // Add set information if applicable
            if (item.set) {
                const set = setBonuses.sets[item.set];
                if (set) {
                    statsHTML += `<br><small class="set-bonus-indicator">Part of ${set.name} set</small>`;
                }
            }
            
            return statsHTML;
        }

        function equipItem(itemId, slot) {
            // If slot is already occupied, unequip current item
            if (gameState.player.equipment[slot]) {
                gameState.player.inventory.push(gameState.player.equipment[slot]);
            }
            
            // Remove item from inventory
            const itemIndex = gameState.player.inventory.indexOf(itemId);
            if (itemIndex !== -1) {
                gameState.player.inventory.splice(itemIndex, 1);
            }
            
            // Equip new item
            gameState.player.equipment[slot] = itemId;
            
            // Update stats
            updatePlayerStats();
            updateInventoryDisplay();
            
            // Check for set completion achievement
            checkAchievements();
            
            addToGameLog(`You equipped ${items[itemId].name}.`);
            
            // Show set bonus if applicable
            const setBonusesActive = setBonuses.getActiveSetBonuses();
            if (setBonusesActive.length > 0) {
                setBonusesActive.forEach(bonus => {
                    if (bonus.pieces >= 2) {
                        addToGameLog(`Set bonus activated: ${bonus.set} - ${bonus.effect}`);
                    }
                });
            }
        }

        function useItem(itemId) {
            const item = items[itemId];
            
            if (item.type === 'consumable') {
                if (item.effect === 'heal') {
                    gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + item.power);
                    addToGameLog(`You used ${item.name} and restored ${item.power} HP.`);
                } else if (item.effect === 'full_heal') {
                    gameState.player.hp = gameState.player.maxHp;
                    addToGameLog(`You used ${item.name} and fully restored your health!`);
                } else if (item.effect === 'restore_mana') {
                    gameState.player.mp = Math.min(gameState.player.maxMp, gameState.player.mp + item.power);
                    addToGameLog(`You used ${item.name} and restored ${item.power} Energy.`);
                }
                
                // Remove item from inventory
                const itemIndex = gameState.player.inventory.indexOf(itemId);
                if (itemIndex !== -1) {
                    gameState.player.inventory.splice(itemIndex, 1);
                }
                
                updatePlayerStats();
                updateInventoryDisplay();
            }
        }

        function updateSpellsDisplay() {
            const spellsElement = document.getElementById('spells-list');
            spellsElement.innerHTML = '';
            
            gameState.player.spells.forEach(spellId => {
                const spell = spells[spellId];
                const spellElement = document.createElement('div');
                spellElement.className = 'spell-item';
                
                const spellInfo = document.createElement('div');
                spellInfo.className = 'spell-info';
                spellInfo.innerHTML = `
                    <strong>${spell.name}</strong><br>
                    <small>${spell.description}</small>
                `;
                
                const spellCost = document.createElement('div');
                spellCost.className = 'spell-cost';
                spellCost.textContent = `${spell.cost} Energy`;
                
                spellElement.appendChild(spellInfo);
                spellElement.appendChild(spellCost);
                
                spellsElement.appendChild(spellElement);
            });
        }

        function updateSpellSelectionDisplay() {
            // Update Energy display
            document.getElementById('spell-select-mp').textContent = gameState.player.mp;
            document.getElementById('spell-select-max-mp').textContent = gameState.player.maxMp;
            
            const spellSelectElement = document.getElementById('spell-select-list');
            spellSelectElement.innerHTML = '';
            
            gameState.player.spells.forEach(spellId => {
                const spell = spells[spellId];
                const spellElement = document.createElement('div');
                spellElement.className = 'spell-item';
                
                // Disable if not enough Energy
                if (gameState.player.mp < spell.cost) {
                    spellElement.classList.add('disabled');
                }
                
                const spellInfo = document.createElement('div');
                spellInfo.className = 'spell-info';
                spellInfo.innerHTML = `
                    <strong>${spell.name}</strong><br>
                    <small>${spell.description}</small><br>
                    ${spell.type === 'attack' ? `Damage: ${spell.damage.min}-${spell.damage.max}` : `Heal: ${spell.power}`}
                `;
                
                const spellCost = document.createElement('div');
                spellCost.className = 'spell-cost';
                spellCost.textContent = `${spell.cost} Energy`;
                
                spellElement.appendChild(spellInfo);
                spellElement.appendChild(spellCost);
                
                // Add click event to cast spell
                if (gameState.player.mp >= spell.cost) {
                    spellElement.addEventListener('click', () => {
                        SoundManager.playClick();
                        castSpell(spellId);
                    });
                }
                
                spellSelectElement.appendChild(spellElement);
            });
        }

        function updateSpellShopDisplay() {
            // Update shop display
            document.getElementById('shop-gold').textContent = gameState.player.gold;
            document.getElementById('shop-level').textContent = gameState.player.level;
            
            const shopElement = document.getElementById('spell-shop-items');
            shopElement.innerHTML = '';
            
            // Show all abilities that player doesn't already have and meets level requirement
            Object.keys(spells).forEach(spellId => {
                const spell = spells[spellId];
                
                // Skip if player already has this ability
                if (gameState.player.spells.includes(spellId)) return;
                
                // Skip if player doesn't meet level requirement
                if (gameState.player.level < spell.levelReq) return;
                
                const shopItemElement = document.createElement('div');
                shopItemElement.className = 'spell-item';
                
                const infoElement = document.createElement('div');
                infoElement.className = 'spell-info';
                infoElement.innerHTML = `
                    <strong>${spell.name}</strong> (Rank ${spell.levelReq}+)<br>
                    <small>${spell.description}</small><br>
                    ${spell.type === 'attack' ? `Damage: ${spell.damage.min}-${spell.damage.max}` : `Heal: ${spell.power}`} | Cost: ${spell.cost} Energy
                `;
                
                const costElement = document.createElement('div');
                costElement.className = 'spell-cost';
                costElement.textContent = `${spell.goldCost} Intel`;
                
                const buyButton = document.createElement('div');
                buyButton.className = 'button';
                buyButton.textContent = 'ACQUIRE';
                buyButton.addEventListener('click', () => {
                    SoundManager.playClick();
                    buySpell(spellId);
                });
                
                shopItemElement.appendChild(infoElement);
                shopItemElement.appendChild(costElement);
                shopItemElement.appendChild(buyButton);
                
                shopElement.appendChild(shopItemElement);
            });
        }

        function buySpell(spellId) {
            const spell = spells[spellId];
            
            // Check if player can afford the ability
            if (gameState.player.gold < spell.goldCost) {
                addToGameLog("You don't have enough Intel to acquire this ability.");
                return;
            }
            
            // Check if player meets level requirement
            if (gameState.player.level < spell.levelReq) {
                addToGameLog(`You need to be Rank ${spell.levelReq} to learn this ability.`);
                return;
            }
            
            // Check if player already has the ability
            if (gameState.player.spells.includes(spellId)) {
                addToGameLog("You already know this ability.");
                return;
            }
            
            // Acquire the ability
            gameState.player.gold -= spell.goldCost;
            gameState.player.spells.push(spellId);
            gameState.abilitiesLearned++;
            
            addToGameLog(`You learned ${spell.name} for ${spell.goldCost} Intel!`);
            
            // Morality reward for learning new abilities
            gameState.player.moralityScore += 2;
            
            // Update displays
            updatePlayerStats();
            updateSpellShopDisplay();
            
            // Check achievements
            checkAchievements();
        }

        // Calculate total player stats including equipment
        function calculatePlayerStats() {
            // Start with base stats
            const stats = {
                strength: gameState.player.strength,
                defense: gameState.player.defense,
                agility: gameState.player.agility,
                magic: gameState.player.magic,
                intelligence: gameState.player.intelligence,
                dodge: gameState.player.dodge,
                critical: gameState.player.critical,
                accuracy: gameState.player.accuracy
            };
            
            // Add equipment bonuses
            Object.values(gameState.player.equipment).forEach(itemId => {
                if (itemId && items[itemId]) {
                    const item = items[itemId];
                    if (item.strength) stats.strength += item.strength;
                    if (item.defense) stats.defense += item.defense;
                    if (item.agility) stats.agility += item.agility;
                    if (item.magic) stats.magic += item.magic;
                    if (item.intelligence) stats.intelligence += item.intelligence;
                    if (item.dodge) stats.dodge += item.dodge;
                    if (item.critical) stats.critical += item.critical;
                }
            });
            
            return stats;
        }

        // UI updates
        function updatePlayerStats() {
            const stats = calculatePlayerStats();
            
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('player-hp').textContent = gameState.player.hp;
            document.getElementById('player-max-hp').textContent = gameState.player.maxHp;
            document.getElementById('player-mp').textContent = gameState.player.mp;
            document.getElementById('player-max-mp').textContent = gameState.player.maxMp;
            document.getElementById('player-exp').textContent = gameState.player.exp;
            document.getElementById('player-exp-needed').textContent = gameState.player.expNeeded;
            document.getElementById('player-gold').textContent = gameState.player.gold;
            
            // Update stat display
            document.getElementById('player-strength').textContent = stats.strength;
            document.getElementById('player-defense').textContent = stats.defense;
            document.getElementById('player-agility').textContent = stats.agility;
            document.getElementById('player-dodge').textContent = Math.floor(stats.dodge);
            document.getElementById('player-critical').textContent = Math.floor(stats.critical);
            document.getElementById('player-accuracy').textContent = stats.accuracy;
            
            // Update exp bar
            const expPercent = (gameState.player.exp / gameState.player.expNeeded) * 100;
            document.getElementById('exp-bar').style.width = `${expPercent}%`;
            
            // Update Energy bar
            const mpPercent = (gameState.player.mp / gameState.player.maxMp) * 100;
            document.getElementById('mp-bar').style.width = `${mpPercent}%`;
            
            // Update quick slots
            updateQuickSlotDisplay();
        }

        function updateBattleStats() {
            document.getElementById('enemy-name').textContent = gameState.currentEnemy.name;
            document.getElementById('enemy-hp').textContent = gameState.currentEnemy.hp;
            document.getElementById('enemy-max-hp').textContent = gameState.enemyMaxHp;
            document.getElementById('battle-player-hp').textContent = gameState.player.hp;
            document.getElementById('battle-player-max-hp').textContent = gameState.player.maxHp;
            document.getElementById('battle-player-mp').textContent = gameState.player.mp;
            document.getElementById('battle-player-max-mp').textContent = gameState.player.maxMp;
            
            // Update enemy health bar
            const enemyHealthPercent = (gameState.currentEnemy.hp / gameState.enemyMaxHp) * 100;
            document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
            
            // Update Energy bar in battle
            const mpPercent = (gameState.player.mp / gameState.player.maxMp) * 100;
            document.getElementById('battle-mp-bar').style.width = `${mpPercent}%`;
            
            // Update quick slots in battle
            updateQuickSlotDisplay();
        }

        function updatePlayerHP() {
            document.getElementById('player-hp').textContent = gameState.player.hp;
            document.getElementById('battle-player-hp').textContent = gameState.player.hp;
        }

        function updatePlayerMP() {
            document.getElementById('player-mp').textContent = gameState.player.mp;
            document.getElementById('battle-player-mp').textContent = gameState.player.mp;
            document.getElementById('spell-select-mp').textContent = gameState.player.mp;
            
            // Update Energy bars
            const mpPercent = (gameState.player.mp / gameState.player.maxMp) * 100;
            document.getElementById('mp-bar').style.width = `${mpPercent}%`;
            document.getElementById('battle-mp-bar').style.width = `${mpPercent}%`;
        }

        function updateEnemyHP() {
            document.getElementById('enemy-hp').textContent = Math.max(0, gameState.currentEnemy.hp);
            
            // Update enemy health bar
            const enemyHealthPercent = (gameState.currentEnemy.hp / gameState.enemyMaxHp) * 100;
            document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
        }

        function addToBattleLog(message) {
            const logElement = document.getElementById('battle-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = message;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function addToGameLog(message) {
            const logElement = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Initialize the game when the page loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
