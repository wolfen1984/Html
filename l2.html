<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHAMBERS OF FEAR - Level 2: The Dark Corridor</title>
    <style>
        /* Retro 80s DOS computer style - Green/Yellow/White/Black theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #0f0;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(0, 20, 0, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 20, 0, 0.3) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #0f0;
            background-color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 20, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #0f0;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            color: #ff0;
            text-shadow: 0 0 5px #ff0;
            font-size: 32px;
            margin: 10px 0;
            letter-spacing: 3px;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        h2 {
            color: #fff;
            border-bottom: 1px solid #0f0;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
        }
        
        .level-number.completed {
            background-color: #220;
            color: #ff0;
            border-color: #ff0;
        }
        
        .level-number.current {
            background-color: #0f0;
            color: #000;
            border-color: #ff0;
            box-shadow: 0 0 8px #0f0;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #ff0;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #ff0;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #0f0;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #ff0;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "âœ“";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff0;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #111;
            border: 1px solid #0f0;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #ff0;
            border-color: #ff0;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #0f0;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #ff0;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #ff0;
            border-color: #ff0;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #112211;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ff0;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #221100;
            border: 1px solid #ff0;
            padding: 10px;
            margin: 10px 0;
            color: #ff0;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f00;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f00;
        }
        
        .success {
            color: #0f0;
            font-weight: bold;
        }
        
        .damage {
            color: #f00;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9900;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #0ff;
            font-weight: bold;
        }
        
        .warning {
            color: #ff0;
            font-weight: bold;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #113311;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 15px 30px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #0f0;
            color: #000;
            border-color: #ff0;
            box-shadow: 0 0 15px #0f0;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #0f0;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #0f0;
            color: #0f0;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
        }
        
        .sound-toggle:hover {
            background: #222;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CHAMBERS OF FEAR</h1>
            <h2>LEVEL 2: THE DARK CORRIDOR</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number current">2</div>
            <div class="level-number">3</div>
            <div class="level-number">4</div>
            <div class="level-number">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">SKILL:</span> <span id="stat-skill" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">STAMINA:</span> <span id="stat-stamina" class="stat-value">0</span>/<span id="stat-maxstamina" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">LUCK:</span> <span id="stat-luck" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/10</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>CHAMBER 2: THE DARK CORRIDOR</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useLuck()">TEST LUCK</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL COMPLETE!</h2>
            <div class="story-text">
                <p>You have survived the Dark Corridor of the Chambers of Fear!</p>
                <p>The corridor ends at another heavy stone door. This one bears the symbol of a serpent coiled around a sword. As you approach, the door slowly grinds open, revealing a large chamber beyond.</p>
                <p>Your journey continues into Chamber 3... All your stats, gold, and inventory will carry over.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">SKILL:</span> <span id="next-stat-skill" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">STAMINA:</span> <span id="next-stat-stamina" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">LUCK:</span> <span id="next-stat-luck" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO CHAMBER 3</button>
            </div>
        </div>
        
        <div class="footer">
            CHAMBERS OF FEAR - A Retro Gamebook Adventure<br>
            Level 2: The Dark Corridor
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects using the beep generator
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    // Multiple beeps for dice roll
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    // Ascending beeps for level completion
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'trap':
                    playBeep(150, 0.3, 'sawtooth');
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            // Play a test sound when turning on
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - loaded from localStorage
        const gameState = {
            playerClass: '',
            skill: 0,
            maxStamina: 0,
            stamina: 0,
            luck: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Rusty Dagger',
            equippedArmor: 'Leather Tunic',
            currentSection: 1,
            gameComplete: false,
            level: 2,
            persistentItems: [],
            // Level 2 specific state
            pitTrapAvoided: false,
            waterCrossed: false,
            secretFound: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyStamina: 0,
            enemyCurrentStamina: 0,
            enemySkill: 0,
            nextSection: 0,
            round: 1
        };
        
        // Game story sections for Level 2
        const storySections = {
            1: {
                text: "You enter a long, dark corridor. The air is damp and cold. Water drips from cracks in the ceiling, creating shallow puddles on the stone floor. The corridor stretches into darkness ahead. Your footsteps echo ominously.",
                choices: [
                    {text: "Proceed cautiously down the corridor", nextSection: 2, skillCheck: false},
                    {text: "Light your Green Torch if you have one", nextSection: 3, skillCheck: false, requirement: 'Green Torch'},
                    {text: "Check the walls for markings or symbols", nextSection: 4, skillCheck: false}
                ]
            },
            2: {
                text: "You move forward carefully. After about fifty feet, you notice the floor looks different ahead. Some stones appear slightly depressed. This might be a pressure plate trap.",
                choices: [
                    {text: "Try to detect the trap mechanism", nextSection: 5, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Leap across the suspicious area", nextSection: 6, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Throw a heavy object to trigger the trap", nextSection: 7, skillCheck: false}
                ]
            },
            3: {
                text: "You light the Green Torch. Its eerie light reveals details hidden in darkness. You can see the corridor extends about 100 feet before turning left. You also notice the floor has suspicious-looking tiles ahead, and there's a faint inscription on the wall.",
                choices: [
                    {text: "Read the inscription on the wall", nextSection: 8, skillCheck: false},
                    {text: "Examine the suspicious floor tiles", nextSection: 9, skillCheck: false},
                    {text: "Continue down the corridor", nextSection: 2, skillCheck: false}
                ]
            },
            4: {
                text: "You examine the walls closely. They're made of rough-hewn stone, but you find some faded carvings. One shows a figure falling into a pit. Another shows a serpent-like creature. There's also what appears to be a hidden alcove about halfway down the corridor.",
                choices: [
                    {text: "Investigate the hidden alcove", nextSection: 10, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Continue down the corridor", nextSection: 2, skillCheck: false},
                    {text: "Study the serpent carving more closely", nextSection: 11, skillCheck: false}
                ]
            },
            5: {
                text: "You examine the floor carefully, looking for trap mechanisms...",
                choices: [
                    {text: "Continue", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.pitTrapAvoided = true;
                        playSound('success');
                        return "You identify the pressure plates! You carefully step around them, avoiding the trap completely.";
                    } else {
                        playSound('failure');
                        return "You can't determine exactly where the pressure plates are. You'll have to proceed carefully.";
                    }
                }
            },
            6: {
                text: "You take a running leap over the suspicious area...",
                choices: [
                    {text: "Continue", nextSection: 13, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.pitTrapAvoided = true;
                        playSound('success');
                        return "You leap gracefully over the trapped area, landing safely on the other side!";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('trap');
                        
                        if (gameState.stamina <= 0) {
                            return "You misjudge the distance! You land on a pressure plate, triggering a pit trap. You fall in and take " + damage + " damage! The fall knocks you unconscious.";
                        } else {
                            return "You misjudge the distance! You land on a pressure plate, triggering a pit trap. You barely catch the edge, haul yourself up, and take " + damage + " damage.";
                        }
                    }
                }
            },
            7: {
                text: "You look for something heavy to throw. You find a loose stone from the wall and toss it onto the suspicious area.",
                choices: [
                    {text: "Continue", nextSection: 14, skillCheck: false}
                ],
                action: function() {
                    gameState.pitTrapAvoided = true;
                    playSound('trap');
                    return "The stone lands on a pressure plate. A section of floor drops away, revealing a 10-foot-deep pit filled with rusty spikes! The trap is now triggered and safe to cross.";
                }
            },
            8: {
                text: "The inscription reads: 'Beware the guardian of the deep waters. Only the pure of heart may pass.' It's written in an ancient dialect, but you manage to decipher it.",
                choices: [
                    {text: "Continue down the corridor", nextSection: 2, skillCheck: false},
                    {text: "Examine the suspicious floor tiles", nextSection: 9, skillCheck: false}
                ]
            },
            9: {
                text: "With the Green Torch light, you can clearly see the pattern of pressure plates. There's a safe path winding through them. You also notice a small, hidden button on the wall that might disable the trap.",
                choices: [
                    {text: "Press the hidden button", nextSection: 15, skillCheck: false},
                    {text: "Follow the safe path through the plates", nextSection: 16, skillCheck: false},
                    {text: "Continue examining the area", nextSection: 17, skillCheck: false}
                ]
            },
            10: {
                text: "You search for the hidden alcove mentioned in the carvings...",
                choices: [
                    {text: "Continue", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.secretFound = true;
                        gameState.gold += 40;
                        addToInventory('Silver Amulet');
                        updateStatsDisplay();
                        playSound('item');
                        return "You find the hidden alcove! Inside is a small chest containing <span class='gold'>40 Gold</span> and a <span class='item'>Silver Amulet</span> that glows with a soft light.";
                    } else {
                        playSound('failure');
                        return "You search the walls but can't find any hidden alcove. The carving must be symbolic or the alcove too well hidden.";
                    }
                }
            },
            11: {
                text: "The serpent carving is intricate. The serpent has three heads, each facing a different direction. Its scales are detailed, and its eyes seem to be made of some dark gemstone. One of the eyes looks loose.",
                choices: [
                    {text: "Try to pry out the gemstone eye", nextSection: 19, skillCheck: true, checkType: 'skill', difficulty: 13},
                    {text: "Leave it and continue", nextSection: 2, skillCheck: false}
                ]
            },
            12: {
                text: "After dealing with the trapped area, you continue down the corridor. It turns left and opens into a larger section. The floor here is flooded with ankle-deep water. You hear something moving in the water ahead.",
                choices: [
                    {text: "Wade through the water", nextSection: 20, skillCheck: false},
                    {text: "Try to find a way around the water", nextSection: 21, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Throw something into the water to see what's there", nextSection: 22, skillCheck: false}
                ]
            },
            13: {
                text: "After your leap, you continue down the corridor. It turns left and opens into a larger section. The floor here is flooded with ankle-deep water. You hear something moving in the water ahead.",
                choices: [
                    {text: "Wade through the water", nextSection: 20, skillCheck: false},
                    {text: "Try to find a way around the water", nextSection: 21, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Throw something into the water to see what's there", nextSection: 22, skillCheck: false}
                ]
            },
            14: {
                text: "After triggering the trap, you carefully cross over the now-revealed pit. The corridor turns left and opens into a larger section. The floor here is flooded with ankle-deep water. You hear something moving in the water ahead.",
                choices: [
                    {text: "Wade through the water", nextSection: 20, skillCheck: false},
                    {text: "Try to find a way around the water", nextSection: 21, skillCheck: true, checkType: 'skill', difficulty: 11},
                    {text: "Throw something into the water to see what's there", nextSection: 22, skillCheck: false}
                ]
            },
            15: {
                text: "You press the hidden button. There's a series of clicks from within the walls, and the pressure plates reset themselves, becoming harmless.",
                choices: [
                    {text: "Continue down the corridor", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    gameState.pitTrapAvoided = true;
                    playSound('success');
                    return "You've disabled the pit trap! The corridor is now safe to cross.";
                }
            },
            16: {
                text: "You carefully follow the safe path through the pressure plates, stepping only on the secure stones.",
                choices: [
                    {text: "Continue down the corridor", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    gameState.pitTrapAvoided = true;
                    playSound('success');
                    return "You successfully navigate through the trapped area without triggering anything.";
                }
            },
            17: {
                text: "As you examine the area more closely, you notice something glinting in a crack between stones. It's a small silver key!",
                choices: [
                    {text: "Take the key and continue", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Small Silver Key');
                    playSound('item');
                    return "You find a <span class='item'>Small Silver Key</span>! It might be useful later.";
                }
            },
            18: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue down the corridor", nextSection: 2, skillCheck: false}
                ]
            },
            19: {
                text: "You try to pry out the gemstone eye from the serpent carving...",
                choices: [
                    {text: "Continue", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.gold += 25;
                        updateStatsDisplay();
                        playSound('item');
                        return "You successfully pry out the gemstone! It's a black opal worth <span class='gold'>25 Gold</span>.";
                    } else {
                        const damage = rollDice(1, 3);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The gemstone is stuck fast. You slip and cut your hand on the sharp stone, taking " + damage + " damage.";
                    }
                }
            },
            20: {
                text: "You wade into the cold water. It reaches up to your knees in the deepest parts. About halfway across, something brushes against your leg! A serpentine creature emerges from the water - a WATER SERPENT!",
                choices: [
                    {text: "Fight the Water Serpent", nextSection: 24, skillCheck: false},
                    {text: "Try to scare it away with fire or light", nextSection: 25, skillCheck: false},
                    {text: "Attempt to swim past it quickly", nextSection: 26, skillCheck: true, checkType: 'skill', difficulty: 13}
                ]
            },
            21: {
                text: "You search for a way around the flooded area...",
                choices: [
                    {text: "Continue", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.waterCrossed = true;
                        playSound('success');
                        return "You find a narrow ledge along the wall, just above the water level. You carefully inch along it, avoiding the water completely.";
                    } else {
                        playSound('failure');
                        return "There doesn't seem to be any way around the water. You'll have to wade through it.";
                    }
                }
            },
            22: {
                text: "You throw a stone into the water. It splashes, and immediately a serpentine head breaks the surface, looking around for the source of the disturbance. It's a Water Serpent, guarding this area.",
                choices: [
                    {text: "Fight the Water Serpent", nextSection: 24, skillCheck: false},
                    {text: "Try to distract it and slip past", nextSection: 28, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Use an item to deal with it", nextSection: 29, skillCheck: false}
                ]
            },
            23: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue down the corridor", nextSection: 2, skillCheck: false}
                ]
            },
            24: {
                text: "The Water Serpent hisses and rears up, ready to strike! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 240, skillCheck: false}
                ]
            },
            240: {
                text: "You face the Water Serpent! Roll for initiative!",
                choices: [
                    {text: "Attack!", nextSection: 241, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for Water Serpent
                    combatState.active = true;
                    combatState.enemyName = "Water Serpent";
                    combatState.enemyStamina = 12;
                    combatState.enemyCurrentStamina = 12;
                    combatState.enemySkill = 8;
                    combatState.nextSection = 30;
                    combatState.round = 1;
                    
                    playSound('combat');
                    return "<span class='enemy'>Water Serpent</span>: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            25: {
                text: "You try to scare the Water Serpent away with fire or light...",
                choices: [
                    {text: "Continue", nextSection: 31, skillCheck: false}
                ],
                action: function() {
                    if (gameState.inventory.includes('Green Torch')) {
                        gameState.waterCrossed = true;
                        playSound('success');
                        return "You raise your Green Torch high. The unnatural green flame seems to terrify the Water Serpent! It slinks away into the depths, allowing you to cross safely.";
                    } else {
                        playSound('failure');
                        return "You have no light source that would scare the creature. It prepares to attack!";
                    }
                }
            },
            26: {
                text: "You try to swim past the Water Serpent quickly...",
                choices: [
                    {text: "Continue", nextSection: 32, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.waterCrossed = true;
                        playSound('success');
                        return "You swim swiftly past the serpent before it can react! You reach the other side, wet but unharmed.";
                    } else {
                        const damage = rollDice(1, 4);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The serpent strikes as you swim past! It bites your leg, dealing " + damage + " damage before you scramble to safety on the other side.";
                    }
                }
            },
            27: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue", nextSection: 33, skillCheck: false}
                ]
            },
            28: {
                text: "You try to distract the Water Serpent and slip past...",
                choices: [
                    {text: "Continue", nextSection: 34, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.waterCrossed = true;
                        playSound('success');
                        return "You throw a stone to the far side of the chamber. As the serpent investigates the noise, you slip past unnoticed.";
                    } else {
                        playSound('failure');
                        return "The serpent isn't fooled by your distraction! It turns its attention back to you, ready to attack.";
                    }
                }
            },
            29: {
                text: "You consider using an item to deal with the Water Serpent...",
                choices: [
                    {text: "Use a weapon if you have one", nextSection: 24, skillCheck: false},
                    {text: "Try to feed it something", nextSection: 35, skillCheck: false},
                    {text: "Use the Silver Amulet if you have it", nextSection: 36, skillCheck: false, requirement: 'Silver Amulet'}
                ]
            },
            30: {
                text: "", // Will be filled by combat results
                choices: [
                    {text: "Continue", nextSection: 37, skillCheck: false}
                ]
            },
            31: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue to the far side", nextSection: 33, skillCheck: false}
                ]
            },
            32: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue", nextSection: 33, skillCheck: false}
                ]
            },
            33: {
                text: "You reach the far side of the flooded area. Before you is another door, this one made of dark wood with iron bindings. There are two keyholes - one silver, one iron.",
                choices: [
                    {text: "Try the Small Silver Key if you have it", nextSection: 38, skillCheck: false, requirement: 'Small Silver Key'},
                    {text: "Examine the door more closely", nextSection: 39, skillCheck: false},
                    {text: "Try to force the door open", nextSection: 40, skillCheck: true, checkType: 'skill', difficulty: 15}
                ]
            },
            34: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue", nextSection: 33, skillCheck: false}
                ]
            },
            35: {
                text: "You search for something to feed the serpent...",
                choices: [
                    {text: "Continue", nextSection: 41, skillCheck: false}
                ],
                action: function() {
                    if (gameState.inventory.includes('Healing Herb')) {
                        removeFromInventory('Healing Herb');
                        gameState.waterCrossed = true;
                        playSound('item');
                        return "You toss your Healing Herb into the water. The serpent eagerly devours it and seems to calm down, allowing you to pass.";
                    } else {
                        playSound('failure');
                        return "You have nothing to feed the serpent. It remains aggressive.";
                    }
                }
            },
            36: {
                text: "You hold up the Silver Amulet...",
                choices: [
                    {text: "Continue", nextSection: 42, skillCheck: false}
                ],
                action: function() {
                    gameState.waterCrossed = true;
                    removeFromInventory('Silver Amulet');
                    playSound('item');
                    return "The Silver Amulet glows brightly. The Water Serpent bows its head respectfully and retreats into the water. The inscription said 'only the pure of heart may pass' - the amulet must prove your purity!";
                }
            },
            37: {
                text: "After the battle, you wade through the rest of the water and reach the far side. Before you is another door, this one made of dark wood with iron bindings. There are two keyholes - one silver, one iron.",
                choices: [
                    {text: "Try the Small Silver Key if you have it", nextSection: 38, skillCheck: false, requirement: 'Small Silver Key'},
                    {text: "Examine the door more closely", nextSection: 39, skillCheck: false},
                    {text: "Try to force the door open", nextSection: 40, skillCheck: true, checkType: 'skill', difficulty: 15}
                ]
            },
            38: {
                text: "You try the Small Silver Key in the silver keyhole...",
                choices: [
                    {text: "Continue", nextSection: 43, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Small Silver Key');
                    playSound('success');
                    return "The Small Silver Key fits perfectly! One of the locks clicks open. You'll need to find a way to open the iron lock as well.";
                }
            },
            39: {
                text: "You examine the door closely. Besides the two keyholes, you notice some text carved into the wood: 'Two keys for two locks, but a third way exists for the clever.' There's also a hidden panel near the floor.",
                choices: [
                    {text: "Open the hidden panel", nextSection: 44, skillCheck: false},
                    {text: "Search for another way around", nextSection: 45, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Try to pick the iron lock", nextSection: 46, skillCheck: true, checkType: 'skill', difficulty: 16}
                ]
            },
            40: {
                text: "You try to force the door open...",
                choices: [
                    {text: "Continue", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With tremendous effort, you force the door open! The locks break with a loud crack, and the door swings inward.";
                    } else {
                        const damage = rollDice(1, 4);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The door is too strong! You strain yourself and take " + damage + " damage. The door remains firmly locked.";
                    }
                }
            },
            41: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue", nextSection: 33, skillCheck: false}
                ]
            },
            42: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue", nextSection: 33, skillCheck: false}
                ]
            },
            43: {
                text: "With the silver lock opened, you still need to deal with the iron lock.",
                choices: [
                    {text: "Try to force the door now", nextSection: 48, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Examine the door again", nextSection: 39, skillCheck: false}
                ]
            },
            44: {
                text: "You open the hidden panel. Inside is a lever and a riddle carved into the metal: 'I speak without a mouth and hear without ears. I have no body, but I come alive with wind. What am I?'",
                choices: [
                    {text: "Answer: 'An echo'", nextSection: 49, skillCheck: false},
                    {text: "Answer: 'A river'", nextSection: 50, skillCheck: false},
                    {text: "Answer: 'A shadow'", nextSection: 51, skillCheck: false},
                    {text: "Pull the lever without answering", nextSection: 52, skillCheck: false}
                ]
            },
            45: {
                text: "You search for another way around the door...",
                choices: [
                    {text: "Continue", nextSection: 53, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You find a loose stone in the wall next to the door. Behind it is a narrow passage that bypasses the door completely!";
                    } else {
                        playSound('failure');
                        return "You search thoroughly but find no alternative route. The door is the only way forward.";
                    }
                }
            },
            46: {
                text: "You attempt to pick the iron lock...",
                choices: [
                    {text: "Continue", nextSection: 54, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully pick the iron lock! With both locks disengaged, the door swings open easily.";
                    } else {
                        playSound('failure');
                        return "The lock is too complex for your skills. You'll need another way to open it.";
                    }
                }
            },
            47: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Try another approach", nextSection: 39, skillCheck: false}
                ]
            },
            48: {
                text: "With only one lock engaged, you try to force the door...",
                choices: [
                    {text: "Continue", nextSection: 55, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With the silver lock already open, you're able to force the door! It gives way with a groan, swinging inward.";
                    } else {
                        const damage = rollDice(1, 3);
                        gameState.stamina -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "Even with one lock open, the door is too strong. You strain yourself and take " + damage + " damage.";
                    }
                }
            },
            49: {
                text: "You say 'An echo' confidently. The mechanism whirs, and the iron lock clicks open!",
                choices: [
                    {text: "Open the door", nextSection: 100, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "Correct! The riddle's answer was indeed 'an echo'. Both locks are now open.";
                }
            },
            50: {
                text: "You say 'A river'. Nothing happens. That's not the correct answer.",
                choices: [
                    {text: "Try another answer", nextSection: 44, skillCheck: false},
                    {text: "Pull the lever", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    playSound('failure');
                    return "Incorrect answer. Try again.";
                }
            },
            51: {
                text: "You say 'A shadow'. Nothing happens. That's not the correct answer.",
                choices: [
                    {text: "Try another answer", nextSection: 44, skillCheck: false},
                    {text: "Pull the lever", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    playSound('failure');
                    return "Incorrect answer. Try again.";
                }
            },
            52: {
                text: "You pull the lever without answering the riddle...",
                choices: [
                    {text: "Continue", nextSection: 56, skillCheck: false}
                ],
                action: function() {
                    const damage = rollDice(1, 6);
                    gameState.stamina -= damage;
                    updateStatsDisplay();
                    playSound('trap');
                    
                    if (gameState.stamina <= 0) {
                        return "Pulling the lever triggers a trap! Darts shoot from the wall, hitting you for " + damage + " damage. You collapse, poisoned.";
                    } else {
                        return "Pulling the lever triggers a trap! Darts shoot from the wall. You dodge most of them but one grazes your arm, dealing " + damage + " damage.";
                    }
                }
            },
            53: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Take the bypass passage", nextSection: 100, skillCheck: false}
                ]
            },
            54: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Open the door", nextSection: 100, skillCheck: false}
                ]
            },
            55: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Enter through the forced door", nextSection: 100, skillCheck: false}
                ]
            },
            56: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Try another approach", nextSection: 39, skillCheck: false}
                ]
            },
            // Combat sections
            241: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 242, skillCheck: false}
                ]
            },
            242: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 241, skillCheck: false}
                ]
            },
            100: {
                text: "Congratulations! You have survived the Dark Corridor of the Chambers of Fear. The door leads to another chamber, this one larger and filled with strange glowing fungi. You can now continue your journey to Chamber 3.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-skill').textContent = gameState.skill;
                    document.getElementById('next-stat-stamina').textContent = gameState.stamina;
                    document.getElementById('next-stat-luck').textContent = gameState.luck;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 3;
                    saveGame();
                    
                    return "";
                }
            }
        };
        
        // Initialize game
        function initGame() {
            // Check for saved game from Level 1
            const savedGame = localStorage.getItem('chambersOfFearGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 2 (coming from level 1)
                if (savedState.level === 2) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(1);
                    return;
                } else if (savedState.level === 1) {
                    // Player hasn't completed level 1 yet
                    alert("You must complete Level 1 first!");
                    window.location.href = 'level1.html';
                    return;
                }
            } else {
                // No saved game at all
                alert("No saved game found. Starting from Level 1.");
                window.location.href = 'level1.html';
                return;
            }
            
            // Otherwise start the game
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-skill').textContent = gameState.skill;
            document.getElementById('stat-stamina').textContent = gameState.stamina;
            document.getElementById('stat-maxstamina').textContent = gameState.maxStamina;
            document.getElementById('stat-luck').textContent = gameState.luck;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item)) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/10`;
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Herb') {
                const healAmount = rollDice(1, 6);
                const oldStamina = gameState.stamina;
                gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                const actualHeal = gameState.stamina - oldStamina;
                removeFromInventory('Healing Herb');
                playSound('item');
                message = `You use the <span class='item'>Healing Herb</span> and restore ${actualHeal} Stamina!`;
                updateStatsDisplay();
            } else if (item === 'Green Torch') {
                message = "The <span class='item'>Green Torch</span> casts an eerie light. It might reveal hidden secrets in dark places.";
            } else if (item === 'Ancient Journal') {
                message = "The <span class='item'>Ancient Journal</span> contains warnings about the chambers. It might contain clues for future levels.";
            } else if (item === 'Chamber Map') {
                message = "The <span class='item'>Chamber Map</span> shows the layout of the first three chambers. It already warned you about the pit trap in Chamber 2.";
            } else if (item === 'Scroll of Protection') {
                gameState.luck += 2;
                removeFromInventory('Scroll of Protection');
                playSound('item');
                message = "You read the <span class='item'>Scroll of Protection</span>. You feel luckier! Luck +2";
                updateStatsDisplay();
            } else if (item === 'Silver Ring') {
                message = "The <span class='item'>Silver Ring</span> is engraved with protective runes. It might have magical properties.";
            } else if (item === 'Silver Amulet') {
                message = "The <span class='item'>Silver Amulet</span> glows with a soft light. It might have protective properties.";
            } else if (item === 'Small Silver Key') {
                message = "A <span class='item'>Small Silver Key</span>. It might fit a lock somewhere.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Dagger' && 
                gameState.equippedArmor === 'Leather Tunic') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 241 || sectionId === 242);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    const goldReward = Math.floor(Math.random() * 20) + 10;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find <span class="gold">${goldReward} Gold</span> in the water.`;
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue exploring";
                    button.onclick = function() {
                        loadSection(33); // Go to the door section
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add skill to dice rolls
            const playerTotal = playerRoll + gameState.skill;
            const enemyTotal = enemyRoll + combatState.enemySkill;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Stamina: ${gameState.stamina}, Enemy Stamina: ${combatState.enemyCurrentStamina}<br>`;
            resultText += `You roll ${playerRoll} + Skill ${gameState.skill} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Skill ${combatState.enemySkill} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                if (gameState.equippedWeapon === 'Rusty Dagger') damage = rollDice(1, 6);
                else if (gameState.equippedWeapon === 'Steel Longsword') damage = rollDice(2, 6);
                else damage = rollDice(1, 6); // Default
                
                combatState.enemyCurrentStamina -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentStamina <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                const enemyDamage = rollDice(1, 6);
                gameState.stamina -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.stamina <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('chambersOfFearGameState');
                        location.reload();
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Luck
        function useLuck() {
            playSound('click');
            if (gameState.luck <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Luck left!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.luck;
            
            gameState.luck -= 1;
            updateStatsDisplay();
            
            let resultText = `You test your Luck... Roll: ${diceRoll}, Luck: ${gameState.luck + 1}. `;
            resultText += success ? 
                `<span class="success">Lucky!</span> Something good happens.` : 
                `<span class="damage">Unlucky!</span> Something bad happens.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Apply Luck effect
            if (success) {
                // Good effect
                const goodEffects = [
                    "You find 5 Gold on the ground!",
                    "You feel a surge of energy! Restore 3 Stamina.",
                    "You spot a hidden path that might be useful."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Gold")) {
                    gameState.gold += 5;
                } else if (effect.includes("Stamina")) {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 3);
                }
            } else {
                // Bad effect
                const badEffects = [
                    "You trip and take 2 damage!",
                    "You drop 3 Gold!",
                    "You feel weaker. Lose 1 Skill until next rest."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.stamina -= 2;
                    playSound('damage');
                } else if (effect.includes("Gold")) {
                    gameState.gold = Math.max(0, gameState.gold - 3);
                } else if (effect.includes("Skill")) {
                    gameState.skill = Math.max(1, gameState.skill - 1);
                }
            }
            
            updateStatsDisplay();
            updateInventoryDisplay();
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('chambersOfFearGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('chambersOfFearGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 2 (this page)
                if (savedState.level === 2) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 2.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 3 with updated level
            gameState.level = 3;
            localStorage.setItem('chambersOfFearGameState', JSON.stringify(gameState));
            // Redirect to level 3
            window.location.href = 'l3.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
