<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASTLE OF THE UNDEAD - Level 2: Mountains of Moor</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Red/Yellow/White/Black theme with proper contrast */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(30, 30, 60, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 30, 60, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #669;
            background-color: #000;
            box-shadow: 0 0 20px rgba(102, 102, 153, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(30, 30, 60, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #669;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #aaf;
            text-shadow: 0 0 5px #66f;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #669;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #669;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #500;
            color: #ff0;
            border-color: #ff0;
        }
        
        .level-number.current {
            background-color: #669;
            color: #ff0;
            border-color: #aaf;
            box-shadow: 0 0 8px #66f;
            text-shadow: 0 0 2px #000;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #669;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #ff0;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #669;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #aaf;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #669;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #aaf;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #aaf;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #669;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #669;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #aaf;
            border-color: #aaf;
            box-shadow: 0 0 10px rgba(102, 102, 255, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #669;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #aaf;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #669;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #aaf;
            border-color: #aaf;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #112;
            border: 1px solid #669;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #aaf;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #223;
            border: 1px solid #aaf;
            padding: 10px;
            margin: 10px 0;
            color: #aaf;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #6ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #669;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #669;
            color: #aaf;
            border-color: #aaf;
            box-shadow: 0 0 15px #66f;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #669;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #669;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #aaf;
        }
        
        /* Merchant Items */
        .merchant-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .merchant-item {
            background-color: #222;
            border: 1px solid #669;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: #fff;
        }
        
        .merchant-item:hover {
            background-color: #333;
            border-color: #aaf;
        }
        
        .merchant-item h3 {
            color: #aaf;
            margin: 0 0 5px 0;
            font-size: 16px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .merchant-item p {
            color: #fff;
            font-size: 14px;
            margin: 0;
        }
        
        .merchant-cost {
            color: #ff0;
            font-weight: bold;
            margin-top: 5px;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .merchant-items {
                grid-template-columns: 1fr;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CASTLE OF THE UNDEAD</h1>
            <h2>LEVEL 2: MOUNTAINS OF MOOR</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number current">2</div>
            <div class="level-number">3</div>
            <div class="level-number">4</div>
            <div class="level-number">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Level Intro Screen -->
        <div id="screen-intro" class="screen active-screen">
            <h2>THE MOUNTAINS OF MOOR</h2>
            <div class="story-text">
                <p>You stand at the base of the Mountains of Moor, a jagged range of peaks that pierce the sky like broken teeth. Somewhere high above, Castle Vorlak awaits.</p>
                <p>The air is thin and cold here. Wind howls through the rocky passes, carrying with it the scent of ice and something... ancient.</p>
                <p>From your position, you can see several paths winding upward:</p>
                <ul>
                    <li>A <span class="item">winding mountain trail</span> that switchbacks up the slope</li>
                    <li>A dark <span class="item">cave entrance</span> at the base of the cliffs</li>
                    <li>A treacherous-looking <span class="item">rocky ledge</span> that seems to offer a shortcut</li>
                </ul>
                <p>Your journey continues. All your stats and inventory from Level 1 have been preserved.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="intro-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="intro-stat-health" class="stat-value">0</span>/<span id="intro-stat-maxhealth" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="intro-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="intro-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="startLevel2()">BEGIN THE MOUNTAIN ASCENT</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>MOUNTAINS OF MOOR</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Mountain Merchant Screen -->
        <div id="screen-merchant" class="screen">
            <h2>MOUNTAIN TRAVELER'S CART</h2>
            <div class="story-text">
                <p>You come across a small wooden cart pulled by a weary-looking horse. An old man with a thick beard and heavy furs tends to a fire.</p>
                <p>"Ho there, traveler!" he calls out. "Not many brave these peaks. Care to trade? The road ahead is treacherous."</p>
                <p>You have <span class="gold" id="merchant-gold">0</span> gold.</p>
                
                <div class="merchant-items">
                    <div class="merchant-item" onclick="selectMerchantItem('climbing_gear')">
                        <h3>CLIMBING GEAR</h3>
                        <p>Ropes, pitons, and harness. Essential for mountain travel.</p>
                        <div class="merchant-cost">Cost: 40 Gold</div>
                    </div>
                    <div class="merchant-item" onclick="selectMerchantItem('warm_cloak')">
                        <h3>WARM CLOAK</h3>
                        <p>Thick fur cloak. Protects against mountain cold.</p>
                        <div class="merchant-cost">Cost: 25 Gold</div>
                    </div>
                    <div class="merchant-item" onclick="selectMerchantItem('mountain_potion')">
                        <h3>MOUNTAIN POTION</h3>
                        <p>Herbal remedy for altitude sickness and healing.</p>
                        <div class="merchant-cost">Cost: 30 Gold</div>
                    </div>
                    <div class="merchant-item" onclick="selectMerchantItem('ice_axe')">
                        <h3>ICE AXE</h3>
                        <p>Useful for climbing and combat on ice.</p>
                        <div class="merchant-cost">Cost: 35 Gold</div>
                    </div>
                    <div class="merchant-item" onclick="selectMerchantItem('lantern_oil')">
                        <h3>LANTERN OIL</h3>
                        <p>Refills any lantern. Essential for dark caves.</p>
                        <div class="merchant-cost">Cost: 15 Gold</div>
                    </div>
                    <div class="merchant-item" onclick="selectMerchantItem('goat_cheese')">
                        <h3>GOAT CHEESE</h3>
                        <p>Nutritious mountain food. Restores health.</p>
                        <div class="merchant-cost">Cost: 10 Gold</div>
                    </div>
                </div>
                
                <div id="selected-item-display" style="display: none; margin-top: 15px; padding: 10px; background-color: #112; border: 1px solid #669;">
                    <p>Selected: <span id="selected-item-name" class="item"></span></p>
                    <p id="selected-item-desc"></p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="confirmMerchantItem()" id="confirm-item-btn" disabled>PURCHASE ITEM</button>
                <button class="action-btn" onclick="leaveMerchant()">LEAVE WITHOUT BUYING</button>
                <button class="action-btn" onclick="talkToMerchant()">TALK TO TRAVELER</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL 2 COMPLETE!</h2>
            <div class="story-text">
                <p>You have conquered the Mountains of Moor!</p>
                <p>Standing at the peak, you finally see Castle Vorlak clearly for the first time. It's a massive, gothic structure built into the mountain itself. Dark towers pierce the stormy sky, and a single bridge connects it to the mountain peak.</p>
                <p>The air here is thin and cold, but your determination burns hot. The vampire lord awaits within those walls.</p>
                <p>All your stats, gold, and inventory will carry over to Level 3.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #112; border: 1px solid #669;">
                    <h3 style="color: #aaf; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO LEVEL 3: CASTLE GATES</button>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE UNDEAD - A Retro Vampire Hunt Adventure<br>
            Level 2: Mountains of Moor
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'mountain':
                    playBeep(250, 0.3, 'sine');
                    setTimeout(() => playBeep(200, 0.3, 'sine'), 300);
                    break;
                case 'wind':
                    playBeep(300, 0.5, 'sine');
                    break;
                case 'cave':
                    playBeep(150, 0.4, 'triangle');
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - loaded from Level 1
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Rusty Sword',
            equippedArmor: 'Leather Armor',
            currentSection: 1,
            gameComplete: false,
            level: 2,
            merchantItem: null,
            // Level 2 specific flags
            hasClimbingGear: false,
            hasWarmCloak: false,
            metOldHermit: false,
            crossedRopeBridge: false,
            caveExplored: false,
            helpedCartMerchant: false
        };
        
        // Mountain merchant items data
        const merchantItems = {
            climbing_gear: {
                name: 'Climbing Gear',
                description: 'Ropes, pitons, and harness for mountain climbing',
                cost: 40,
                effect: '+2 to agility checks on mountain paths'
            },
            warm_cloak: {
                name: 'Warm Cloak',
                description: 'Thick fur cloak that protects against cold',
                cost: 25,
                effect: 'Prevents damage from cold environments'
            },
            mountain_potion: {
                name: 'Mountain Potion',
                description: 'Herbal remedy for altitude sickness',
                cost: 30,
                effect: 'Restores 3d6+10 health and cures altitude effects'
            },
            ice_axe: {
                name: 'Ice Axe',
                description: 'Useful for climbing and combat on ice',
                cost: 35,
                effect: '+2 damage in mountain environments, can be equipped'
            },
            lantern_oil: {
                name: 'Lantern Oil',
                description: 'Refills any lantern for extended use',
                cost: 15,
                effect: 'Allows lantern to burn twice as long'
            },
            goat_cheese: {
                name: 'Goat Cheese',
                description: 'Nutritious mountain food',
                cost: 10,
                effect: 'Restores 2d6+5 health'
            }
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1
        };
        
        // Game story sections for Level 2
        const storySections = {
            1: {
                text: "You stand at the base of the Mountains of Moor. The wind howls through the rocky passes, carrying with it the scent of ice and ancient stone. Three paths lead upward into the mist-shrouded peaks.",
                choices: [
                    {text: "Take the winding mountain trail (safer but longer)", nextSection: 2, skillCheck: false},
                    {text: "Enter the dark cave entrance (shortcut but dangerous)", nextSection: 3, skillCheck: false},
                    {text: "Climb the rocky ledge (requires agility)", nextSection: 4, skillCheck: true, checkType: 'agility', difficulty: 14}
                ]
            },
            2: {
                text: "The mountain trail switchbacks up the slope. The going is slow but steady. As you round a bend, you encounter an old man sitting on a tree stump. He's wrapped in furs and has a long, white beard.",
                choices: [
                    {text: "Greet the old man", nextSection: 5, skillCheck: false},
                    {text: "Pass by quietly", nextSection: 6, skillCheck: false},
                    {text: "Ask about the path ahead", nextSection: 7, skillCheck: false}
                ]
            },
            3: {
                text: "You enter the cave. The air inside is still and cold. Strange mineral formations glitter on the walls in the dim light. The cave splits into two tunnels.",
                choices: [
                    {text: "Take the left tunnel (descends deeper)", nextSection: 8, skillCheck: false},
                    {text: "Take the right tunnel (seems to ascend)", nextSection: 9, skillCheck: false},
                    {text: "Light a torch if you have one", nextSection: 10, skillCheck: false, requirement: 'Torch'}
                ]
            },
            4: {
                text: "You attempt to climb the rocky ledge. The stone is slippery with frost, and the wind threatens to tear you from the face.",
                choices: [
                    {text: "Continue the climb", nextSection: 11, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.gold += 15;
                        updateStatsDisplay();
                        playSound('success');
                        return "You skillfully navigate the ledge! Halfway up, you spot a small crevice containing <span class='gold'>15 Gold</span> coins left by a previous climber.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        
                        if (gameState.health <= 0) {
                            return "You slip on the icy rock and fall! You take " + damage + " damage! The impact leaves you unconscious...";
                        } else {
                            return "You slip and scrape against the rocks, taking " + damage + " damage. You manage to catch yourself before falling too far.";
                        }
                    }
                }
            },
            5: {
                text: "\"Ho there, traveler,\" the old man says, his voice raspy but strong. \"Not many come this way anymore. The mountains are not what they once were.\" He gestures to a small fire beside him. \"Rest awhile, if you wish.\"",
                choices: [
                    {text: "Sit and rest by the fire", nextSection: 12, skillCheck: false},
                    {text: "Ask about Castle Vorlak", nextSection: 13, skillCheck: false},
                    {text: "Offer to share your rations", nextSection: 14, skillCheck: false}
                ]
            },
            6: {
                text: "You pass by the old man without a word. He watches you silently as you continue up the trail. You can feel his eyes on your back until you round the next bend.",
                choices: [
                    {text: "Continue up the trail", nextSection: 15, skillCheck: false}
                ]
            },
            7: {
                text: "\"The path ahead is treacherous,\" the old man warns. \"There's a rope bridge that's half-rotten, a nest of mountain harpies, and the cave up yonder is home to something... not natural. But if you reach the merchant's cart, you might find supplies.\"",
                choices: [
                    {text: "Thank him and continue", nextSection: 15, skillCheck: false},
                    {text: "Ask about the merchant", nextSection: 16, skillCheck: false},
                    {text: "Ask about the 'not natural' thing", nextSection: 17, skillCheck: false}
                ]
            },
            8: {
                text: "The left tunnel descends into darkness. The air grows colder with each step. You hear dripping water echoing from deep below. Suddenly, you see glowing eyes in the darkness ahead!",
                choices: [
                    {text: "Approach cautiously", nextSection: 18, skillCheck: false},
                    {text: "Draw your weapon", nextSection: 19, skillCheck: false},
                    {text: "Retreat back to the entrance", nextSection: 20, skillCheck: false}
                ]
            },
            9: {
                text: "The right tunnel ascends gradually. After about a hundred feet, you find a natural chimney leading upward. Sunlight filters down from above.",
                choices: [
                    {text: "Climb the chimney", nextSection: 21, skillCheck: true, checkType: 'agility', difficulty: 12},
                    {text: "Return to the cave entrance", nextSection: 20, skillCheck: false}
                ]
            },
            10: {
                text: "You light your torch. The flickering light reveals ancient markings on the cave walls - symbols of protection and warning. The cave splits ahead, but now you can see more clearly.",
                choices: [
                    {text: "Examine the markings", nextSection: 22, skillCheck: false},
                    {text: "Take the left tunnel", nextSection: 8, skillCheck: false},
                    {text: "Take the right tunnel", nextSection: 9, skillCheck: false}
                ],
                action: function() {
                    // Torch gets used up
                    removeFromInventory('Torch');
                    addToInventory('Burnt Torch');
                    return "Your torch burns brightly, illuminating the cave. You'll need to find another light source soon.";
                }
            },
            11: {
                text: "After your climb, you reach a narrow mountain path. The wind howls fiercely here, threatening to blow you off the edge. Ahead, you see a terrifying sight: a rope bridge spanning a deep chasm.",
                choices: [
                    {text: "Cross the rope bridge", nextSection: 23, skillCheck: false},
                    {text: "Look for another way around", nextSection: 24, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Rest before crossing", nextSection: 25, skillCheck: false}
                ]
            },
            12: {
                text: "You sit by the fire. The old man produces a clay bottle and offers you a drink. \"Mountain tea,\" he says. \"Good for the bones.\"",
                choices: [
                    {text: "Drink the tea", nextSection: 26, skillCheck: false},
                    {text: "Politely decline", nextSection: 27, skillCheck: false},
                    {text: "Ask about his life in the mountains", nextSection: 28, skillCheck: false}
                ]
            },
            13: {
                text: "\"Castle Vorlak...\" the old man's eyes grow distant. \"A place of darkness. The vampire lord has slept there for centuries, but he stirs now. He feels your approach.\" He leans closer. \"They say he cannot be killed by ordinary means.\"",
                choices: [
                    {text: "Ask how to kill him", nextSection: 29, skillCheck: false},
                    {text: "Ask about the castle defenses", nextSection: 30, skillCheck: false},
                    {text: "Thank him and continue", nextSection: 15, skillCheck: false}
                ]
            },
            14: {
                text: "You share some of your rations with the old man. He accepts gratefully. \"Kindness is rare in these mountains,\" he says. He reaches into his pack and produces a small, carved wooden talisman.",
                choices: [
                    {text: "Accept the talisman", nextSection: 31, skillCheck: false},
                    {text: "Refuse politely", nextSection: 32, skillCheck: false}
                ],
                action: function() {
                    // Use some rations
                    if (gameState.inventory.includes('Iron Rations')) {
                        removeFromInventory('Iron Rations');
                    }
                    return "You share your food with the old hermit.";
                }
            },
            15: {
                text: "You continue up the mountain trail. The path grows steeper and more treacherous. Rounding a bend, you come across a remarkable sight: a small wooden cart pulled by a weary-looking horse. An old man tends to a fire beside it.",
                choices: [
                    {text: "Approach the cart", nextSection: 33, skillCheck: false},
                    {text: "Observe from a distance", nextSection: 34, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 35, skillCheck: true, checkType: 'agility', difficulty: 13}
                ]
            },
            16: {
                text: "\"Old Gregor with the cart?\" the hermit asks. \"Aye, he comes through these parts sometimes. Sells supplies to fools like you trying to reach the castle. He might have something useful, if you have the coin.\"",
                choices: [
                    {text: "Thank him and continue", nextSection: 15, skillCheck: false}
                ]
            },
            17: {
                text: "The old man's face grows serious. \"Something sleeps in the deep caves. Not vampire, not man. Something old from before the castle was built. Best to avoid the deep places if you can.\"",
                choices: [
                    {text: "Ask for more details", nextSection: 36, skillCheck: false},
                    {text: "Thank him for the warning", nextSection: 15, skillCheck: false}
                ]
            },
            18: {
                text: "You approach cautiously. The glowing eyes resolve into a creature with pale, hairless skin and too many limbs. It's a CAVE DWELLER, twisted by dark magic!",
                choices: [
                    {text: "Attack the creature", nextSection: 37, skillCheck: false},
                    {text: "Try to communicate", nextSection: 38, skillCheck: false},
                    {text: "Retreat slowly", nextSection: 39, skillCheck: true, checkType: 'agility', difficulty: 12}
                ]
            },
            19: {
                text: "You draw your weapon just as the creature charges! It moves with unnatural speed, its claws scraping against the stone floor.",
                choices: [
                    {text: "Fight the cave dweller", nextSection: 40, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Cave Dweller";
                    combatState.enemyHealth = 40;
                    combatState.enemyCurrentHealth = 40;
                    combatState.enemyStrength = 11;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 41;
                    combatState.round = 1;
                    
                    playSound('cave');
                    return "<span class='enemy'>Cave Dweller</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            20: {
                text: "You retreat back to the cave entrance. The mountain trail continues upward from here.",
                choices: [
                    {text: "Take the mountain trail", nextSection: 2, skillCheck: false}
                ]
            },
            21: {
                text: "You climb the natural chimney. It's a tight squeeze, but after about thirty feet, you emerge onto a rocky ledge high on the mountainside. The view is breathtaking, but dangerous.",
                choices: [
                    {text: "Continue along the ledge", nextSection: 42, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.gold += 25;
                        addToInventory('Glowing Crystal');
                        updateStatsDisplay();
                        playSound('item');
                        return "You successfully climb the chimney! On the ledge above, you find a <span class='item'>Glowing Crystal</span> and <span class='gold'>25 Gold</span> in an old pouch.";
                    } else {
                        const damage = rollDice(1, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You slip while climbing and fall back down, taking " + damage + " damage.";
                    }
                }
            },
            22: {
                text: "The markings are ancient and worn, but you can make out warnings in an old language: 'Beware the Sleeper Below' and 'The Price of Greed is Death'. There's also a crude map showing the cave system.",
                choices: [
                    {text: "Study the map", nextSection: 43, skillCheck: false},
                    {text: "Continue exploring", nextSection: 44, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Cave Map Fragment');
                    return "You copy the cave map onto a piece of parchment. You now have a <span class='item'>Cave Map Fragment</span>.";
                }
            },
            23: {
                text: "The rope bridge looks ancient and poorly maintained. Several planks are missing, and the ropes are frayed. The chasm below is hundreds of feet deep. The wind howls, making the bridge sway dangerously.",
                choices: [
                    {text: "Cross carefully", nextSection: 45, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Use climbing gear if you have it", nextSection: 46, skillCheck: false, requirement: 'Climbing Gear'},
                    {text: "Look for another way", nextSection: 24, skillCheck: false}
                ]
            },
            24: {
                text: "You search for another way around the chasm. The mountain face looks climbable, but it's sheer and icy.",
                choices: [
                    {text: "Attempt to climb around", nextSection: 47, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Return to the bridge", nextSection: 23, skillCheck: false}
                ]
            },
            25: {
                text: "You rest for a moment, catching your breath. The altitude is making you lightheaded. You need to be careful.",
                choices: [
                    {text: "Cross the bridge after resting", nextSection: 48, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 6);
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    updateStatsDisplay();
                    playSound('item');
                    return "You rest and recover " + actualHeal + " Health. You feel slightly better prepared for the crossing.";
                }
            },
            26: {
                text: "You drink the tea. It's bitter but warming. You feel energy returning to your limbs.",
                choices: [
                    {text: "Thank the old man", nextSection: 49, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(2, 6);
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    updateStatsDisplay();
                    playSound('item');
                    return "The mountain tea restores " + actualHeal + " Health! You feel invigorated.";
                }
            },
            27: {
                text: "\"Suit yourself,\" the old man says, taking a sip from the bottle himself. \"The cold will get to you eventually up there.\"",
                choices: [
                    {text: "Ask another question", nextSection: 50, skillCheck: false},
                    {text: "Continue your journey", nextSection: 15, skillCheck: false}
                ]
            },
            28: {
                text: "\"I've lived in these mountains for sixty years,\" the hermit says. \"Came up here to get away from... things down below. The mountains change you. They either make you strong or break you.\"",
                choices: [
                    {text: "Ask what he's running from", nextSection: 51, skillCheck: false},
                    {text: "Ask about mountain survival", nextSection: 52, skillCheck: false}
                ]
            },
            29: {
                text: "The old man leans in conspiratorially. \"They say a wooden stake through the heart will do it, but only if he's resting in his coffin. Silver hurts him. Sunlight destroys him. But getting close enough... that's the trick.\"",
                choices: [
                    {text: "Ask about his weaknesses", nextSection: 53, skillCheck: false},
                    {text: "Thank him for the information", nextSection: 15, skillCheck: false}
                ]
            },
            30: {
                text: "\"The castle is protected by more than stone walls,\" the hermit warns. \"There are creatures that serve the vampire - bats, wolves, things worse than that. And the castle itself... it's said to be alive in some way.\"",
                choices: [
                    {text: "Ask about the castle's magic", nextSection: 54, skillCheck: false},
                    {text: "Continue your journey", nextSection: 15, skillCheck: false}
                ]
            },
            31: {
                text: "\"This will protect you,\" the old man says, handing you the talisman. \"It's old magic, but it still has power.\"",
                choices: [
                    {text: "Continue your journey", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Mountain Talisman');
                    gameState.agility += 1;
                    updateStatsDisplay();
                    playSound('item');
                    return "You receive a <span class='item'>Mountain Talisman</span>! The old magic within grants you +1 Agility.";
                }
            },
            32: {
                text: "\"As you wish,\" the old man says, pocketing the talisman. \"But remember: sometimes accepting help is wiser than pride.\"",
                choices: [
                    {text: "Continue your journey", nextSection: 15, skillCheck: false}
                ]
            },
            33: {
                text: "\"Ho there!\" the merchant calls out. \"You're the first traveler I've seen in weeks! Looking for supplies? The road ahead only gets worse.\" His cart is filled with various goods, and his horse looks exhausted.",
                choices: [
                    {text: "Browse his wares", nextSection: 55, skillCheck: false},
                    {text: "Ask about his journey", nextSection: 56, skillCheck: false},
                    {text: "Offer to help with his horse", nextSection: 57, skillCheck: false}
                ]
            },
            34: {
                text: "You observe from behind a large rock. The merchant seems to be alone, just tending his fire. His cart appears to be stuck in the mud, and his horse looks like it can barely stand.",
                choices: [
                    {text: "Approach and offer help", nextSection: 57, skillCheck: false},
                    {text: "Sneak past while he's distracted", nextSection: 35, skillCheck: true, checkType: 'agility', difficulty: 12},
                    {text: "Browse his wares", nextSection: 55, skillCheck: false}
                ]
            },
            35: {
                text: "You try to sneak past the cart without being noticed...",
                choices: [
                    {text: "Continue", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You successfully sneak past the merchant's cart without being noticed. You continue up the mountain path.";
                    } else {
                        playSound('failure');
                        return "\"Hey! Who's there?\" the merchant calls out. He's spotted you!";
                    }
                }
            },
            36: {
                text: "\"The deep-dwellers,\" the hermit whispers. \"They were here before men, before even the vampire. They sleep in the stone, and they don't take kindly to being disturbed. If you value your sanity, stay out of the deep caves.\"",
                choices: [
                    {text: "Thank him for the warning", nextSection: 15, skillCheck: false}
                ]
            },
            37: {
                text: "The cave dweller lets out a guttural screech and charges! Its movements are unnaturally fast.",
                choices: [
                    {text: "Fight the cave dweller", nextSection: 40, skillCheck: false}
                ]
            },
            38: {
                text: "You hold up your hands in a peaceful gesture. The creature pauses, tilting its head. It makes a series of clicking sounds, but you don't understand.",
                choices: [
                    {text: "Try to communicate with gestures", nextSection: 59, skillCheck: false},
                    {text: "Slowly back away", nextSection: 39, skillCheck: true, checkType: 'agility', difficulty: 10},
                    {text: "Attack while it's confused", nextSection: 40, skillCheck: false}
                ]
            },
            39: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 60, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slowly back away from the creature. It watches you but doesn't follow. You retreat to the cave entrance safely.";
                    } else {
                        playSound('failure');
                        return "You stumble on a loose rock! The creature shrieks and attacks!";
                    }
                }
            },
            40: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 61, skillCheck: false}
                ]
            },
            41: {
                text: "After defeating the cave dweller, you search its lair. In a pile of bones and debris, you find something valuable.",
                choices: [
                    {text: "Take the treasure", nextSection: 62, skillCheck: false},
                    {text: "Leave the cave", nextSection: 20, skillCheck: false}
                ]
            },
            42: {
                text: "The ledge is narrow and treacherous. Wind whips around you, threatening to blow you off. Suddenly, you hear a screech above - MOUNTAIN HARPIES are diving toward you!",
                choices: [
                    {text: "Fight the harpies", nextSection: 63, skillCheck: false},
                    {text: "Try to take cover", nextSection: 64, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Use a ranged weapon if you have one", nextSection: 65, skillCheck: false, requirement: 'Silver Dagger'}
                ]
            },
            43: {
                text: "The map shows the cave system in detail. There's a main chamber marked with an 'X' and the words 'Treasure but Danger'. Another passage is marked 'Escape to surface'.",
                choices: [
                    {text: "Follow the map to the treasure", nextSection: 66, skillCheck: false},
                    {text: "Take the escape route", nextSection: 67, skillCheck: false}
                ]
            },
            44: {
                text: "With the torchlight fading, you need to decide where to go quickly.",
                choices: [
                    {text: "Left tunnel", nextSection: 8, skillCheck: false},
                    {text: "Right tunnel", nextSection: 9, skillCheck: false}
                ]
            },
            45: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 68, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.crossedRopeBridge = true;
                        playSound('success');
                        return "You cross the rope bridge carefully, testing each plank before putting your weight on it. The bridge sways alarmingly, but you make it across safely!";
                    } else {
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        
                        if (gameState.health <= 0) {
                            return "A plank gives way beneath you! You fall into the chasm, taking " + damage + " fatal damage!";
                        } else {
                            return "A plank breaks! You manage to catch yourself on the ropes, but you take " + damage + " damage from the impact.";
                        }
                    }
                }
            },
            46: {
                text: "You use your climbing gear to secure yourself to the bridge ropes. Even if a plank breaks, you won't fall far.",
                choices: [
                    {text: "Cross the bridge safely", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    gameState.crossedRopeBridge = true;
                    playSound('success');
                    return "With your <span class='item'>Climbing Gear</span>, you cross the bridge safely and securely. The gear was worth every penny!";
                }
            },
            47: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 70, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.gold += 30;
                        updateStatsDisplay();
                        playSound('success');
                        return "You skillfully climb around the chasm! On the other side, you find a small cache containing <span class='gold'>30 Gold</span>!";
                    } else {
                        const damage = rollDice(4, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        
                        if (gameState.health <= 0) {
                            return "You lose your grip and fall into the chasm, taking " + damage + " fatal damage!";
                        } else {
                            return "You slip and fall, but manage to catch yourself on a ledge partway down. You climb back up, battered and bruised, taking " + damage + " damage.";
                        }
                    }
                }
            },
            48: {
                text: "Refreshed from your rest, you approach the rope bridge again.",
                choices: [
                    {text: "Cross carefully", nextSection: 45, skillCheck: true, checkType: 'agility', difficulty: 12},
                    {text: "Use climbing gear if you have it", nextSection: 46, skillCheck: false, requirement: 'Climbing Gear'}
                ]
            },
            49: {
                text: "\"Safe travels,\" the old man says. \"And remember: the mountain tests everyone. Don't let it break your spirit.\"",
                choices: [
                    {text: "Continue up the trail", nextSection: 15, skillCheck: false}
                ]
            },
            50: {
                text: "The old man looks at you expectantly, waiting for your next question.",
                choices: [
                    {text: "Ask about Castle Vorlak", nextSection: 13, skillCheck: false},
                    {text: "Ask about the path ahead", nextSection: 7, skillCheck: false},
                    {text: "Continue your journey", nextSection: 15, skillCheck: false}
                ]
            },
            51: {
                text: "The hermit's face darkens. \"Some memories are best left buried,\" he says quietly. \"Let's just say the world below has its own monsters, and they don't all have fangs and claws.\"",
                choices: [
                    {text: "Respect his privacy and change subject", nextSection: 52, skillCheck: false},
                    {text: "Continue your journey", nextSection: 15, skillCheck: false}
                ]
            },
            52: {
                text: "\"Keep to the high ground when you can,\" the hermit advises. \"The things that hunt these mountains don't like the thin air up high. And always have a way to make fire - it keeps more than just the cold away.\"",
                choices: [
                    {text: "Thank him for the advice", nextSection: 15, skillCheck: false}
                ]
            },
            53: {
                text: "\"He can't cross running water,\" the hermit says. \"He must be invited into a home. He casts no reflection. And they say he can turn into mist or a bat. But in his castle... there, he's strongest.\"",
                choices: [
                    {text: "Continue your journey", nextSection: 15, skillCheck: false}
                ]
            },
            54: {
                text: "\"The castle is old magic,\" the hermit says, his voice dropping to a whisper. \"Built on a place of power. Some say it was there before the vampire came. He just... moved in.\"",
                choices: [
                    {text: "Ask what was there before", nextSection: 71, skillCheck: false},
                    {text: "Continue your journey", nextSection: 15, skillCheck: false}
                ]
            },
            55: {
                text: "The merchant shows you his wares. \"Business has been slow,\" he admits. \"The mountain creatures have been more active lately. It's like they know something's about to happen.\"",
                choices: [
                    {text: "Browse the selection", nextSection: 72, skillCheck: false},
                    {text: "Ask why he's on the mountain", nextSection: 56, skillCheck: false},
                    {text: "Offer to help with his cart", nextSection: 57, skillCheck: false}
                ]
            },
            56: {
                text: "\"I supply the few hermits and hunters who live up here,\" the merchant explains. \"Used to be more of them. But lately... people disappear. My last trip, three of my regular customers were just gone.\"",
                choices: [
                    {text: "Ask about the disappearances", nextSection: 73, skillCheck: false},
                    {text: "Browse his wares", nextSection: 72, skillCheck: false}
                ]
            },
            57: {
                text: "\"My horse, Buttercup, she's getting old,\" the merchant says sadly. \"The mountain's been hard on her. If you could help get my cart unstuck, I'd be mighty grateful.\"",
                choices: [
                    {text: "Help push the cart", nextSection: 74, skillCheck: true, checkType: 'strength', difficulty: 14},
                    {text: "Use your rope to help", nextSection: 75, skillCheck: false, requirement: 'Rope'},
                    {text: "Offer to buy something instead", nextSection: 72, skillCheck: false}
                ]
            },
            58: {
                text: "Whether you were spotted or not, you continue up the mountain path. The air grows thinner, and you start to feel lightheaded from the altitude.",
                choices: [
                    {text: "Continue upward", nextSection: 76, skillCheck: false},
                    {text: "Rest and acclimate", nextSection: 77, skillCheck: false}
                ]
            },
            59: {
                text: "You make calming gestures. The creature seems to understand. It points deeper into the cave, then makes a crossing motion with its arms - a warning. Then it points back the way you came.",
                choices: [
                    {text: "Heed the warning and leave", nextSection: 20, skillCheck: false},
                    {text: "Continue deeper despite warning", nextSection: 66, skillCheck: false}
                ]
            },
            60: {
                text: "You retreat from the cave dweller and make your way back to the entrance. The mountain trail continues upward from here.",
                choices: [
                    {text: "Take the mountain trail", nextSection: 2, skillCheck: false}
                ]
            },
            61: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 40, skillCheck: false}
                ]
            },
            62: {
                text: "Among the bones, you find several interesting items: a bag of coins, a strange glowing fungus, and an old, well-made dagger.",
                choices: [
                    {text: "Take everything", nextSection: 78, skillCheck: false},
                    {text: "Take only the coins", nextSection: 79, skillCheck: false},
                    {text: "Leave the cave", nextSection: 20, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    addToInventory('Glowing Cave Fungus');
                    addToInventory('Ancient Bone Dagger');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span>, <span class='item'>Glowing Cave Fungus</span>, and an <span class='item'>Ancient Bone Dagger</span>!";
                }
            },
            63: {
                text: "Two harpies dive at you, claws extended! They have the bodies of large birds but the faces of twisted women.",
                choices: [
                    {text: "Fight the mountain harpies", nextSection: 80, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Mountain Harpies (2)";
                    combatState.enemyHealth = 50;
                    combatState.enemyCurrentHealth = 50;
                    combatState.enemyStrength = 9;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 81;
                    combatState.round = 1;
                    
                    playSound('mountain');
                    return "<span class='enemy'>Mountain Harpies (2)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            64: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 82, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You duck into a small crevice just as the harpies dive. They screech in frustration but can't reach you. After a few minutes, they fly away.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You try to take cover but the harpies spot you! One rakes you with its claws, dealing " + damage + " damage!";
                    }
                }
            },
            65: {
                text: "You throw your silver dagger at one of the harpies. It strikes true, and the creature shrieks in pain!",
                choices: [
                    {text: "Retrieve your dagger and fight", nextSection: 83, skillCheck: false}
                ],
                action: function() {
                    const initialDamage = rollDice(2, 6) + 3;
                    combatState.enemyCurrentHealth -= initialDamage;
                    playSound('combat');
                    return "You throw your <span class='item'>Silver Dagger</span>, dealing " + initialDamage + " initial damage! The harpy is badly wounded.";
                }
            },
            66: {
                text: "Following the map, you find the treasure chamber. In the center of the room lies a chest, but standing guard is a massive STONE GOLEM!",
                choices: [
                    {text: "Fight the stone golem", nextSection: 84, skillCheck: false},
                    {text: "Try to sneak past it", nextSection: 85, skillCheck: true, checkType: 'agility', difficulty: 20},
                    {text: "Use the glowing crystal if you have it", nextSection: 86, skillCheck: false, requirement: 'Glowing Crystal'}
                ]
            },
            67: {
                text: "You follow the escape route marked on the map. It leads upward through narrow tunnels, eventually emerging onto a mountainside. You're higher up than you expected!",
                choices: [
                    {text: "Continue your ascent", nextSection: 87, skillCheck: false}
                ]
            },
            68: {
                text: "Having crossed the rope bridge, you continue up the mountain. The peak is visible now, and you can just make out the dark shape of Castle Vorlak against the stormy sky.",
                choices: [
                    {text: "Press on toward the peak", nextSection: 88, skillCheck: false}
                ]
            },
            69: {
                text: "Safely across the bridge, you continue upward. The air grows colder, and you start to see patches of snow on the ground.",
                choices: [
                    {text: "Continue toward the peak", nextSection: 88, skillCheck: false}
                ]
            },
            70: {
                text: "Whether you succeeded or failed in climbing around the chasm, you continue your journey upward. The mountain peak draws nearer.",
                choices: [
                    {text: "Continue toward the peak", nextSection: 88, skillCheck: false}
                ]
            },
            71: {
                text: "\"Some say it was a temple to older gods,\" the hermit says. \"Others say it was a prison for something worse than vampires. Either way, it's a place of power, and power attracts those who would misuse it.\"",
                choices: [
                    {text: "Continue your journey", nextSection: 15, skillCheck: false}
                ]
            },
            72: {
                text: "The merchant shows you his wares. \"Pick what you need,\" he says. \"But be quick - I need to be off this mountain before nightfall.\"",
                choices: [],
                action: function() {
                    showScreen('screen-merchant');
                    document.getElementById('merchant-gold').textContent = gameState.gold;
                    return "";
                }
            },
            73: {
                text: "\"First it was just things going missing from camps,\" the merchant says, lowering his voice. \"Then animals started disappearing. Now people. Something's hunting in these mountains, and it's not natural.\"",
                choices: [
                    {text: "Ask what he thinks it is", nextSection: 89, skillCheck: false},
                    {text: "Browse his wares", nextSection: 72, skillCheck: false}
                ]
            },
            74: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 90, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.helpedCartMerchant = true;
                        const rewardGold = rollDice(2, 10);
                        gameState.gold += rewardGold;
                        updateStatsDisplay();
                        playSound('success');
                        return "You put your shoulder to the cart and push with all your strength! With a great heave, the cart comes free of the mud. The merchant thanks you profusely and gives you <span class='gold'>" + rewardGold + " Gold</span> as reward.";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You strain against the cart, but it won't budge. You pull a muscle in your back, taking " + damage + " damage.";
                    }
                }
            },
            75: {
                text: "You use your rope to help free the cart, tying it to a sturdy rock and using it for leverage.",
                choices: [
                    {text: "Pull with the rope", nextSection: 91, skillCheck: false}
                ],
                action: function() {
                    gameState.helpedCartMerchant = true;
                    removeFromInventory('Rope');
                    const rewardGold = rollDice(3, 10);
                    gameState.gold += rewardGold;
                    updateStatsDisplay();
                    playSound('success');
                    return "Using your <span class='item'>Rope</span>, you create a pulley system that helps free the cart. The merchant is thrilled and gives you <span class='gold'>" + rewardGold + " Gold</span>!";
                }
            },
            76: {
                text: "You push onward despite the altitude sickness. Your head pounds, and your vision swims. This is dangerous, but you're so close to the peak.",
                choices: [
                    {text: "Rest now", nextSection: 77, skillCheck: false},
                    {text: "Continue despite the sickness", nextSection: 92, skillCheck: true, checkType: 'strength', difficulty: 16}
                ]
            },
            77: {
                text: "You stop to rest and acclimate to the altitude. After a few hours, you feel better prepared to continue.",
                choices: [
                    {text: "Continue upward", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 8);
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    updateStatsDisplay();
                    playSound('item');
                    return "You rest and acclimate to the altitude, recovering " + actualHeal + " Health. The headache subsides.";
                }
            },
            78: {
                text: "You take all the treasure from the cave dweller's lair. The bone dagger feels cold and ancient in your hand.",
                choices: [
                    {text: "Leave the cave", nextSection: 20, skillCheck: false}
                ]
            },
            79: {
                text: "You take only the coins, leaving the strange items behind. The glowing fungus pulses rhythmically, as if alive.",
                choices: [
                    {text: "Leave the cave", nextSection: 20, skillCheck: false}
                ]
            },
            80: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 93, skillCheck: false}
                ]
            },
            81: {
                text: "After defeating the harpies, you search their nest. Among the bones and debris, you find something valuable.",
                choices: [
                    {text: "Take the treasure", nextSection: 94, skillCheck: false},
                    {text: "Continue up the mountain", nextSection: 87, skillCheck: false}
                ]
            },
            82: {
                text: "After dealing with the harpies (whether by fighting or hiding), you continue along the ledge. It eventually connects with a mountain path.",
                choices: [
                    {text: "Follow the path upward", nextSection: 87, skillCheck: false}
                ]
            },
            83: {
                text: "You retrieve your dagger and prepare to fight the remaining harpy.",
                choices: [
                    {text: "Continue the fight", nextSection: 95, skillCheck: false}
                ]
            },
            84: {
                text: "The stone golem awakens with a grinding sound of stone on stone. It moves slowly but with tremendous power.",
                choices: [
                    {text: "Fight the stone golem", nextSection: 96, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Stone Golem";
                    combatState.enemyHealth = 60;
                    combatState.enemyCurrentHealth = 60;
                    combatState.enemyStrength = 14;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 97;
                    combatState.round = 1;
                    
                    playSound('cave');
                    return "<span class='enemy'>Stone Golem</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            85: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 98, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You move with supernatural quietness, slipping past the stone golem while it's motionless. You reach the chest without alerting it!";
                    } else {
                        playSound('failure');
                        return "You step on a loose stone! The golem's head turns toward you, its eyes glowing with blue light. It attacks!";
                    }
                }
            },
            86: {
                text: "The glowing crystal in your possession begins to pulse with light. The stone golem's eyes focus on it, and then... it bows its head and steps aside!",
                choices: [
                    {text: "Approach the chest", nextSection: 99, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The <span class='item'>Glowing Crystal</span> resonates with the golem! It recognizes the crystal's power and allows you to pass.";
                }
            },
            87: {
                text: "You emerge from the cave system high on the mountainside. The peak is visible above you, and the dark shape of Castle Vorlak stands stark against the grey sky.",
                choices: [
                    {text: "Make the final ascent", nextSection: 100, skillCheck: false}
                ]
            },
            88: {
                text: "The final ascent is the most difficult. The path is steep and covered in ice. The wind howls with ferocious intensity. But you can see the peak now - and the castle.",
                choices: [
                    {text: "Make the final push", nextSection: 101, skillCheck: true, checkType: 'strength', difficulty: 15},
                    {text: "Rest before the final climb", nextSection: 102, skillCheck: false}
                ]
            },
            89: {
                text: "\"I've seen tracks,\" the merchant whispers. \"Bigger than a bear, but not shaped right. And the way things are taken... it's like they're plucked from their camps without a struggle.\" He shudders. \"I'll be glad to be off this mountain.\"",
                choices: [
                    {text: "Browse his wares", nextSection: 72, skillCheck: false}
                ]
            },
            90: {
                text: "Having helped (or tried to help) the merchant, you continue up the mountain path.",
                choices: [
                    {text: "Continue upward", nextSection: 76, skillCheck: false}
                ]
            },
            91: {
                text: "With the cart freed, the merchant packs up quickly. \"Thank you, traveler! May the mountain be kind to you!\" he calls as he heads back down the path.",
                choices: [
                    {text: "Continue upward", nextSection: 76, skillCheck: false}
                ]
            },
            92: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 103, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You push through the altitude sickness through sheer willpower! The symptoms fade as your body adapts.";
                    } else {
                        const damage = rollDice(2, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        
                        if (gameState.health <= 0) {
                            return "The altitude sickness overwhelms you! You collapse, taking " + damage + " fatal damage from pulmonary edema!";
                        } else {
                            return "The altitude sickness worsens! You vomit and struggle to breathe, taking " + damage + " damage. You must rest!";
                        }
                    }
                }
            },
            93: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 80, skillCheck: false}
                ]
            },
            94: {
                text: "In the harpy nest, you find shiny objects they've collected: coins, jewelry, and a strange amulet.",
                choices: [
                    {text: "Take everything", nextSection: 87, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    addToInventory('Harpy Feather Amulet');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Harpy Feather Amulet</span> that might have magical properties.";
                }
            },
            95: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 104, skillCheck: false}
                ]
            },
            96: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 105, skillCheck: false}
                ]
            },
            97: {
                text: "With the stone golem defeated, you approach the chest. It's old but still intact.",
                choices: [
                    {text: "Open the chest", nextSection: 106, skillCheck: false}
                ]
            },
            98: {
                text: "Whether you succeeded in sneaking past or had to fight the golem, you now stand before the chest.",
                choices: [
                    {text: "Open the chest", nextSection: 106, skillCheck: false}
                ]
            },
            99: {
                text: "The chest opens easily. Inside, you find treasure beyond your wildest dreams!",
                choices: [
                    {text: "Take the treasure", nextSection: 107, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(10, 20);
                    gameState.gold += goldFound;
                    addToInventory('Ancient Gold Crown');
                    addToInventory('Ruby the Size of Your Fist');
                    updateStatsDisplay();
                    playSound('item');
                    return "The chest contains <span class='gold'>" + goldFound + " Gold</span>, an <span class='item'>Ancient Gold Crown</span>, and a <span class='item'>Ruby the Size of Your Fist</span>! This is a king's ransom!";
                }
            },
            100: {
                text: "YOU HAVE REACHED THE PEAK! Castle Vorlak stands before you, a massive gothic structure built into the mountain itself. Dark towers pierce the stormy sky, and a single bridge connects it to the mountain peak. The castle gates await.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 3;
                    saveGame();
                    
                    return "";
                }
            },
            101: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 108, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With a final burst of strength, you scramble up the icy slope and haul yourself onto the mountain peak! Castle Vorlak looms before you!";
                    } else {
                        const damage = rollDice(2, 10);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        
                        if (gameState.health <= 0) {
                            return "You slip on the ice and tumble down the mountainside, taking " + damage + " fatal damage!";
                        } else {
                            return "You slip and fall partway down, taking " + damage + " damage. Bruised and battered, you try again.";
                        }
                    }
                }
            },
            102: {
                text: "You rest one last time before the final push. This is it - the last obstacle before the castle.",
                choices: [
                    {text: "Make the final climb", nextSection: 101, skillCheck: true, checkType: 'strength', difficulty: 12}
                ],
                action: function() {
                    const healAmount = rollDice(2, 6);
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    updateStatsDisplay();
                    playSound('item');
                    return "You rest and gather your strength, recovering " + actualHeal + " Health. You're as ready as you'll ever be.";
                }
            },
            103: {
                text: "After your struggle with altitude sickness, you continue upward. The peak is so close you can almost touch it.",
                choices: [
                    {text: "Make the final ascent", nextSection: 100, skillCheck: false}
                ]
            },
            104: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 95, skillCheck: false}
                ]
            },
            105: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 96, skillCheck: false}
                ]
            },
            106: {
                text: "You open the chest. Inside is a fortune in treasure!",
                choices: [
                    {text: "Take everything", nextSection: 107, skillCheck: false}
                ]
            },
            107: {
                text: "With your newfound wealth, you find the exit from the cave system and emerge high on the mountainside.",
                choices: [
                    {text: "Continue to the peak", nextSection: 100, skillCheck: false}
                ]
            },
            108: {
                text: "Having reached the peak, you stand before Castle Vorlak. The final leg of your journey is complete.",
                choices: [
                    {text: "Approach the castle gates", nextSection: 100, skillCheck: false}
                ]
            }
        };
        
        // Initialize game for Level 2
        function initGame() {
            // Load game state from Level 1
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 2 (coming from Level 1)
                if (savedState.level === 2) {
                    Object.assign(gameState, savedState);
                    
                    // Update intro screen with loaded stats
                    document.getElementById('intro-stat-strength').textContent = gameState.strength;
                    document.getElementById('intro-stat-health').textContent = gameState.health;
                    document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('intro-stat-agility').textContent = gameState.agility;
                    document.getElementById('intro-stat-gold').textContent = gameState.gold;
                    
                    showScreen('screen-intro');
                    return;
                } else if (savedState.level === 1) {
                    // If coming directly from Level 1 without completing it
                    alert("You must complete Level 1 first!");
                    window.location.href = 'level1.html';
                    return;
                }
            } else {
                // No saved game found
                alert("No saved game found. Starting from Level 1.");
                window.location.href = 'level1.html';
                return;
            }
        }
        
        function startLevel2() {
            playSound('click');
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item)) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Merchant item selection
        let selectedMerchantItem = null;
        
        function selectMerchantItem(itemKey) {
            playSound('click');
            selectedMerchantItem = itemKey;
            const item = merchantItems[itemKey];
            
            document.getElementById('selected-item-name').textContent = item.name;
            document.getElementById('selected-item-desc').innerHTML = 
                `<span class="item">${item.name}</span>: ${item.description}<br>Effect: ${item.effect}`;
            document.getElementById('selected-item-display').style.display = 'block';
            
            // Enable confirm button if player has enough gold
            if (gameState.gold >= item.cost) {
                document.getElementById('confirm-item-btn').disabled = false;
            } else {
                document.getElementById('confirm-item-btn').disabled = true;
            }
        }
        
        function confirmMerchantItem() {
            if (!selectedMerchantItem) return;
            
            const item = merchantItems[selectedMerchantItem];
            
            if (gameState.gold >= item.cost) {
                playSound('item');
                gameState.gold -= item.cost;
                addToInventory(item.name);
                
                // Special handling for ice axe (can be equipped)
                if (selectedMerchantItem === 'ice_axe') {
                    gameState.equippedWeapon = 'Ice Axe';
                }
                // Special handling for warm cloak (can be equipped)
                if (selectedMerchantItem === 'warm_cloak') {
                    gameState.equippedArmor = 'Warm Cloak';
                    gameState.hasWarmCloak = true;
                }
                // Special handling for climbing gear
                if (selectedMerchantItem === 'climbing_gear') {
                    gameState.hasClimbingGear = true;
                    gameState.agility += 2;
                }
                
                updateStatsDisplay();
                updateInventoryDisplay();
                document.getElementById('selected-item-display').style.display = 'none';
                selectedMerchantItem = null;
                document.getElementById('confirm-item-btn').disabled = true;
            }
        }
        
        function leaveMerchant() {
            playSound('click');
            showScreen('screen-game');
            loadSection(76); // Continue from where merchant was encountered
        }
        
        function talkToMerchant() {
            playSound('click');
            // Simple conversation option
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">The merchant tells you: "Be careful up there. The castle... it changes people. I've seen strong men go up and never come back down."</div>`;
            showScreen('screen-game');
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Potion' || item === 'Mountain Potion') {
                const healAmount = item === 'Mountain Potion' ? rollDice(3, 6) + 10 : rollDice(2, 6) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Goat Cheese' || item === 'Iron Rations') {
                const healAmount = rollDice(2, 6);
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You eat the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Torch') {
                message = "The <span class='item'>Torch</span> provides light in dark areas. It will eventually burn out.";
            } else if (item === 'Glowing Cave Fungus') {
                message = "The <span class='item'>Glowing Cave Fungus</span> emits a soft blue light. It might be useful in dark places.";
            } else if (item === 'Lantern Oil' && gameState.inventory.includes('Everburning Lantern')) {
                message = "You use the <span class='item'>Lantern Oil</span> to refill your Everburning Lantern. It should burn for days now.";
                removeFromInventory('Lantern Oil');
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Sword' && 
                gameState.equippedArmor === 'Leather Armor') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 40 || sectionId === 61 || sectionId === 80 || sectionId === 93 || 
                                   sectionId === 95 || sectionId === 104 || sectionId === 96 || sectionId === 105);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    const goldReward = Math.floor(Math.random() * 25) + 15;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find <span class="gold">${goldReward} Gold</span> on the remains.`;
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue up the mountain";
                    button.onclick = function() {
                        loadSection(100); // Go to peak
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                if (gameState.equippedWeapon === 'Rusty Sword') damage = rollDice(2, 6);
                else if (gameState.equippedWeapon === 'Silver Dagger') damage = rollDice(2, 6) + 3;
                else if (gameState.equippedWeapon === 'Ice Axe') damage = rollDice(2, 6) + 2;
                else if (gameState.equippedWeapon === 'Ancient Bone Dagger') damage = rollDice(2, 6) + 1;
                else damage = rollDice(2, 6);
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                const enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('castleUndeadGameState');
                        window.location.href = 'level1.html';
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You find a safer path up the mountain!",
                    "You avoid a rockslide!",
                    "You move silently past a sleeping creature."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip on loose rocks and take 3 damage!",
                    "You make noise and alert nearby creatures.",
                    "You get your foot stuck in a crevice."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 3;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 2 (this page)
                if (savedState.level === 2) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 2.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 3 with updated level
            gameState.level = 3;
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            // Redirect to level 3 (you'll need to create l3.html)
            window.location.href = 'l3.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
