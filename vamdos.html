<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle of the Vampire Lord - Fixed</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #0a0a0a;
            color: #e0e0c0;
            line-height: 1.4;
            padding: 0;
            overflow-x: hidden;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect fill="%23e0e0c0" width="100" height="100"/></svg>');
        }

        #game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        #main-menu {
            display: flex;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), 
                        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><path fill="%23505050" d="M100,20 L180,60 L180,140 L100,180 L20,140 L20,60 Z"/></svg>');
        }

        .active {
            display: flex !important;
        }

        .header {
            text-align: center;
            padding: 8px;
            border-bottom: 1px solid #e0e0c0;
            margin-bottom: 0;
            flex-shrink: 0;
            flex-grow: 0;
            background-color: #1a1a1a;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            min-height: 0;
            margin: 0;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            background-color: #0f0f0f;
        }

        .compact-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            justify-content: flex-start;
        }

        .footer {
            padding: 8px;
            border-top: 1px solid #e0e0c0;
            margin-top: 0;
            flex-shrink: 0;
            flex-grow: 0;
            background-color: #1a1a1a;
        }

        button {
            background-color: #1a1a1a;
            color: #e0e0c0;
            border: 1px solid #e0e0c0;
            padding: 12px 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 2px 0;
            cursor: pointer;
            width: 100%;
            min-height: 50px;
            flex-shrink: 0;
            transition: all 0.1s ease;
        }

        button:active {
            background-color: #3a3a1a;
            color: #ffffa0;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap;
            border: 1px solid #e0e0c0;
            padding: 8px;
            background-color: #1a1a1a;
        }

        .stat-box {
            text-align: center;
            padding: 5px;
            min-width: 80px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #ffffa0;
        }

        .battle-area {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .combatant {
            text-align: center;
            width: 48%;
            min-width: 150px;
            margin-bottom: 10px;
            border: 1px solid #e0e0c0;
            padding: 10px;
            background-color: #1a1a1a;
            position: relative;
        }

        .combatant-ascii {
            font-size: 12px;
            line-height: 1;
            margin: 5px 0;
            white-space: pre;
        }

        .health-bar {
            width: 100%;
            height: 10px;
            background-color: #333;
            margin: 5px 0;
        }

        .health-fill {
            height: 100%;
            background-color: #a05050;
            transition: width 0.5s ease;
        }

        .story-text {
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .choice-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .choice-btn {
            text-align: left;
            padding: 12px;
            background-color: #1a1a1a;
            border: 1px solid #e0e0c0;
            color: #e0e0c0;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .choice-btn:active {
            background-color: #3a3a1a;
            color: #ffffa0;
        }

        .dice-roll {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border: 1px dashed #e0e0c0;
            background-color: #1a1a1a;
        }

        .dice-result {
            font-size: 24px;
            font-weight: bold;
            color: #ffffa0;
            margin: 5px 0;
        }

        .combat-log {
            height: 120px;
            overflow-y: auto;
            border: 1px solid #e0e0c0;
            padding: 8px;
            margin-top: 10px;
            font-size: 13px;
            flex-shrink: 0;
            background-color: #1a1a1a;
        }

        .inventory {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 5px;
            margin-top: 10px;
        }

        .item {
            width: 48%;
            margin-bottom: 5px;
            border: 1px solid #e0e0c0;
            padding: 8px;
            min-width: 140px;
            background-color: #1a1a1a;
            position: relative;
        }

        .item-special {
            border-color: #ffffa0;
            background-color: #2a2a1a;
        }

        .item-equipped {
            border-color: #a0ffa0;
            background-color: #1a2a1a;
        }

        .luck-test {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ffffa0;
            background-color: #2a2a1a;
        }

        .luck-result {
            font-weight: bold;
            margin: 5px 0;
            color: #ffffa0;
        }

        .success {
            color: #a0ffa0;
        }

        .failure {
            color: #ffa0a0;
        }

        .scrollable-container {
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            -webkit-overflow-scrolling: touch;
            padding: 5px;
            display: flex;
            flex-direction: column;
        }

        .game-over {
            text-align: center;
            padding: 20px;
        }

        .game-over-message {
            font-size: 18px;
            margin: 15px 0;
            color: #ffffa0;
        }

        .victory-message {
            color: #a0ffa0;
        }

        .defeat-message {
            color: #ffa0a0;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        @keyframes flash {
            0% { background-color: transparent; }
            50% { background-color: #ffa0a0; }
            100% { background-color: transparent; }
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px #ffffa0; }
            50% { box-shadow: 0 0 20px #ffffa0; }
            100% { box-shadow: 0 0 5px #ffffa0; }
        }

        @keyframes float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }

        @keyframes roll {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
            100% { transform: rotate(360deg); }
        }

        .critical-hit {
            color: #ffffa0;
            font-weight: bold;
            animation: pulse 0.5s infinite;
        }

        .monster-name {
            color: #ffa0a0;
            font-weight: bold;
        }

        .market-item {
            border: 1px solid #e0e0c0;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .item-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            width: 100%;
        }

        .item-action-btn {
            flex: 1;
            padding: 6px;
            font-size: 12px;
        }

        .shake {
            animation: shake 0.5s ease;
        }

        .flash {
            animation: flash 0.5s ease;
        }

        .glow {
            animation: glow 1s infinite;
        }

        .float {
            animation: float 2s infinite;
        }

        .rolling {
            animation: roll 0.5s linear;
        }

        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
        }

        .magic-particle {
            background: radial-gradient(circle, #ffffa0, #ffa500);
            box-shadow: 0 0 10px #ffffa0;
        }

        .heal-particle {
            background: radial-gradient(circle, #a0ffa0, #00ff00);
            box-shadow: 0 0 10px #a0ffa0;
        }

        .damage-particle {
            background: radial-gradient(circle, #ffa0a0, #ff0000);
            box-shadow: 0 0 10px #ffa0a0;
        }

        .level-up {
            color: #ffffa0;
            font-weight: bold;
            animation: glow 1s infinite, float 2s infinite;
        }

        .special-attack {
            background-color: #3a1a1a;
            border-color: #ffa0a0;
        }

        .special-attack:active {
            background-color: #5a1a1a;
        }

        .status-effect {
            display: inline-block;
            padding: 2px 6px;
            margin: 0 2px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }

        .buff {
            background-color: #1a3a1a;
            color: #a0ffa0;
        }

        .debuff {
            background-color: #3a1a1a;
            color: #ffa0a0;
        }

        .save-slot {
            border: 1px solid #e0e0c0;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .save-slot:hover {
            background-color: #2a2a2a;
        }

        .save-slot.active {
            border-color: #ffffa0;
            background-color: #2a2a1a;
        }

        .auto-save-indicator {
            font-size: 10px;
            color: #a0a0a0;
            margin-left: 5px;
        }

        @media (max-height: 700px) {
            .header {
                padding: 5px;
            }
            
            .header pre {
                font-size: 10px;
                line-height: 1;
            }
            
            .header h2 {
                font-size: 16px;
            }
            
            .content {
                padding: 8px;
            }
            
            button {
                padding: 10px 6px;
                min-height: 40px;
                font-size: 13px;
            }
            
            .footer {
                padding: 5px;
            }
        }

        @media (max-height: 500px) {
            .header pre {
                display: none;
            }
            
            .header {
                padding: 3px;
            }
            
            .content {
                padding: 5px;
            }
            
            button {
                padding: 8px 4px;
                min-height: 36px;
                font-size: 12px;
            }
        }

        #audio-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: #1a1a1a;
            border: 1px solid #e0e0c0;
            color: #e0e0c0;
            border-radius: 50%;
            z-index: 1000;
            cursor: pointer;
        }
        
        .vampire-theme {
            background: linear-gradient(rgba(10,0,10,0.8), rgba(20,0,10,0.9)), 
                        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect fill="%23e0e0c0" width="100" height="100"/></svg>');
        }
        
        .castle-bg {
            background: linear-gradient(rgba(10,0,10,0.8), rgba(20,0,10,0.9)), 
                        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><path fill="%23505050" d="M50,50 L150,50 L150,150 L50,150 Z M70,70 L130,70 L130,130 L70,130 Z M90,90 L110,90 L110,110 L90,110 Z"/></svg>');
        }
    </style>
</head>
<body>
    <button id="audio-toggle">ðŸ”Š</button>
    
    <!-- Audio Elements -->
    <audio id="bg-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-horror-ambience-429.mp3" type="audio/mpeg">
    </audio>
    <audio id="combat-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-sword-slash-2761.mp3" type="audio/mpeg">
    </audio>
    <audio id="victory-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3" type="audio/mpeg">
    </audio>
    <audio id="game-over-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-ominous-drums-227.mp3" type="audio/mpeg">
    </audio>
    <audio id="click-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" type="audio/mpeg">
    </audio>
    <audio id="vampire-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-creature-monster-growl-233.mp3" type="audio/mpeg">
    </audio>
    
    <div id="game-container">
        <!-- Main Menu Screen -->
        <div id="main-menu" class="screen active vampire-theme">
            <div class="header">
                <pre>
   _____           _             _   _                 _____       _            
  / ____|         | |           | | | |               |  __ \     | |           
 | |     __ _  ___| |_ ___  __ _| | | | ___   ___ __ _| |  | | ___| |_ ___ _ __ 
 | |    / _` |/ __| __/ _ \/ _` | | | |/ _ \ / __/ _` | |  | |/ _ \ __/ _ \ '__|
 | |___| (_| | (__| ||  __/ (_| | | | | (_) | (_| (_| | |__| |  __/ ||  __/ |   
  \_____\__,_|\___|\__\___|\__,_|_| |_|\___/ \___\__,_|_____/ \___|\__\___|_|   
                </pre>
                <h2>CASTLE OF THE VAMPIRE LORD</h2>
            </div>
            <div class="content">
                <div class="compact-list">
                    <button id="new-game">BEGIN YOUR HUNT</button>
                    <button id="continue-game">CONTINUE HUNT</button>
                    <button id="rules-btn">HOW TO PLAY</button>
                    <div class="stats" style="margin-top: 15px;">
                        <div class="stat-box">
                            <div>Skill</div>
                            <div class="stat-value">-</div>
                        </div>
                        <div class="stat-box">
                            <div>Stamina</div>
                            <div class="stat-value">-</div>
                        </div>
                        <div class="stat-box">
                            <div>Luck</div>
                            <div class="stat-value">-</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #a0a0a0;">
                        A Vampire Hunting Adventure
                    </div>
                </div>
            </div>
            <div class="footer">
                <p>Enter the castle and hunt the vampire lord!</p>
            </div>
        </div>

        <!-- Save/Load Screen -->
        <div id="save-load-screen" class="screen vampire-theme">
            <div class="header">
                <h2>SAVE & LOAD GAME</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <h3>Save Slots</h3>
                    <div id="save-slots">
                        <!-- Save slots will appear here -->
                    </div>
                    <div style="margin-top: 20px;">
                        <button id="quick-save">QUICK SAVE</button>
                        <button id="quick-load">QUICK LOAD</button>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-save">BACK TO GAME</button>
            </div>
        </div>

        <!-- Story Screen -->
        <div id="story-screen" class="screen castle-bg">
            <div class="header">
                <h2 id="story-title">CASTLE OF THE VAMPIRE LORD</h2>
                <div class="stats" style="margin: 5px 0 0 0; padding: 4px; font-size: 12px;">
                    <div>Skill: <span id="header-skill">0</span></div>
                    <div>Stamina: <span id="header-stamina">0</span>/<span id="header-max-stamina">0</span></div>
                    <div>Luck: <span id="header-luck">0</span></div>
                    <div>Gold: <span id="header-gold">0</span></div>
                    <div>Level: <span id="header-level">1</span> XP: <span id="header-xp">0</span></div>
                </div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="story-text" id="story-text">
                        <!-- Story text will appear here -->
                    </div>
                    <div class="choice-list" id="choice-list">
                        <!-- Choice buttons will appear here -->
                    </div>
                    <div id="dice-roll-section" style="display: none;">
                        <div class="dice-roll">
                            <div>Rolling 2 dice...</div>
                            <div class="dice-result" id="dice-result">?</div>
                            <div id="dice-total"></div>
                        </div>
                        <button id="continue-after-roll">CONTINUE</button>
                    </div>
                    <div id="luck-test-section" style="display: none;">
                        <div class="luck-test">
                            <h3>Test Your Luck</h3>
                            <div>Roll 2 dice. If the total is less than or equal to your Luck, you are lucky!</div>
                            <div class="dice-result" id="luck-dice-result">?</div>
                            <div class="luck-result" id="luck-result"></div>
                            <div>Your Luck will decrease by 1 after this test.</div>
                        </div>
                        <button id="continue-after-luck">CONTINUE</button>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="inventory-btn">INVENTORY</button>
                <button id="chapel-btn">CHAPEL</button>
                <button id="save-load-btn">SAVE/LOAD</button>
            </div>
        </div>

        <!-- Combat Screen -->
        <div id="combat-screen" class="screen castle-bg">
            <div class="header">
                <h2>COMBAT</h2>
                <div class="stats" style="margin: 5px 0 0 0; padding: 4px; font-size: 12px;">
                    <div>Skill: <span id="combat-skill">0</span></div>
                    <div>Stamina: <span id="combat-stamina">0</span>/<span id="combat-max-stamina">0</span></div>
                    <div>Luck: <span id="combat-luck">0</span></div>
                    <div>Level: <span id="combat-level">1</span></div>
                </div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="battle-area">
                        <div class="combatant" id="player-combatant">
                            <h3>VAMPIRE HUNTER</h3>
                            <div class="combatant-ascii">
    /\
   /  \
  /    \
 /______\
   |  |
   |  |
  /    \
                            </div>
                            <div>Skill: <span id="player-combat-skill">0</span></div>
                            <div>Stamina: <span id="player-combat-stamina">0</span></div>
                            <div class="health-bar">
                                <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
                            </div>
                            <div id="player-status-effects"></div>
                        </div>
                        <div class="combatant" id="enemy-combatant">
                            <h3 id="enemy-name">ENEMY</h3>
                            <div class="combatant-ascii" id="enemy-ascii">
     /\
    /**\
   /****\
  /______\
   |    |
   |    |
  /      \
                            </div>
                            <div>Skill: <span id="enemy-skill">0</span></div>
                            <div>Stamina: <span id="enemy-stamina">0</span></div>
                            <div class="health-bar">
                                <div class="health-fill" id="enemy-health-fill" style="width: 100%;"></div>
                            </div>
                            <div id="enemy-status-effects"></div>
                        </div>
                    </div>
                    <div class="combat-log" id="combat-log">
                        <!-- Combat log will appear here -->
                    </div>
                    <div class="dice-roll" id="combat-dice-roll" style="display: none;">
                        <h4>Combat Round</h4>
                        <div>Your Attack Strength: <span id="player-attack">0</span></div>
                        <div>Enemy Attack Strength: <span id="enemy-attack">0</span></div>
                        <div id="combat-result"></div>
                    </div>
                    <button id="attack-btn" style="margin-top: 10px;">ATTACK</button>
                    <button id="holy-attack-btn" class="special-attack" style="margin-top: 5px; display: none;">HOLY ATTACK</button>
                    <button id="garlic-attack-btn" class="special-attack" style="margin-top: 5px; display: none;">USE GARLIC</button>
                    <button id="use-luck-combat" style="display: none;">TEST YOUR LUCK</button>
                    <button id="flee-combat" style="background-color: #3a1a1a;">FLEE</button>
                    <button id="victory-continue" style="display: none; background-color: #1a3a1a;">CONTINUE YOUR QUEST</button>
                </div>
            </div>
        </div>

        <!-- Inventory Screen -->
        <div id="inventory-screen" class="screen vampire-theme">
            <div class="header">
                <h2>INVENTORY</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="stats">
                        <div class="stat-box">
                            <div>Skill</div>
                            <div class="stat-value" id="inv-skill">0</div>
                        </div>
                        <div class="stat-box">
                            <div>Stamina</div>
                            <div class="stat-value" id="inv-stamina">0</div>
                        </div>
                        <div class="stat-box">
                            <div>Luck</div>
                            <div class="stat-value" id="inv-luck">0</div>
                        </div>
                        <div class="stat-box">
                            <div>Gold</div>
                            <div class="stat-value" id="inv-gold">0</div>
                        </div>
                        <div class="stat-box">
                            <div>Level</div>
                            <div class="stat-value" id="inv-level">1</div>
                        </div>
                        <div class="stat-box">
                            <div>XP</div>
                            <div class="stat-value" id="inv-xp">0</div>
                        </div>
                    </div>
                    
                    <h3>Provisions: <span id="provisions-count">0</span></h3>
                    <button id="eat-provision" style="margin-bottom: 10px;">EAT PROVISION (Restore 4 Stamina)</button>
                    
                    <h3>Equipped Items:</h3>
                    <div id="equipped-items">
                        <!-- Equipped items will appear here -->
                    </div>
                    
                    <h3>Backpack:</h3>
                    <div id="inventory-list">
                        <!-- Inventory items will appear here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-inventory">BACK TO STORY</button>
            </div>
        </div>

        <!-- Chapel Screen -->
        <div id="chapel-screen" class="screen vampire-theme">
            <div class="header">
                <h2>CASTLE CHAPEL</h2>
                <div>Your Gold: <span id="chapel-gold">0</span></div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="chapel-items">
                        <!-- Chapel items will appear here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-chapel">BACK TO STORY</button>
            </div>
        </div>

        <!-- Rules Screen -->
        <div id="rules-screen" class="screen vampire-theme">
            <div class="header">
                <h2>HOW TO PLAY</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="story-text">
                        <h3>Vampire Hunting Adventure</h3>
                        <p>In this adventure, you are a vampire hunter who has entered the castle of the vampire lord, Count Vorlak. Your mission is to find and destroy him before he completes his dark ritual.</p>
                        
                        <h4>Your Attributes:</h4>
                        <ul style="margin-left: 20px; margin-bottom: 15px;">
                            <li><strong>SKILL</strong>: Your fighting ability. Determines how good you are in combat.</li>
                            <li><strong>STAMINA</strong>: Your health. If it reaches zero, you die.</li>
                            <li><strong>LUCK</strong>: Your good fortune. Test your Luck to change your fate.</li>
                            <li><strong>LEVEL</strong>: Your experience level. Gain XP from combat and quests to level up.</li>
                            <li><strong>GOLD</strong>: Currency used to buy holy items and equipment.</li>
                        </ul>
                        
                        <h4>Combat:</h4>
                        <p>When you enter combat, you and your enemy roll 2 dice and add your Skill scores.</p>
                        <p>The higher score wins and inflicts 2 damage on the loser.</p>
                        <p>If scores are equal, you both miss.</p>
                        <p>Special attacks like Holy Attack and Garlic are effective against vampires and other undead.</p>
                        
                        <h4>Testing Your Luck:</h4>
                        <p>You may Test Your Luck in certain situations. Roll 2 dice:</p>
                        <ul style="margin-left: 20px;">
                            <li>If the total is LESS than or equal to your current Luck: You are Lucky!</li>
                            <li>If the total is GREATER than your current Luck: You are Unlucky!</li>
                        </ul>
                        <p>Each time you Test Your Luck, your Luck score decreases by 1.</p>
                        
                        <h4>Provisions:</h4>
                        <p>You begin with 10 Provisions. Each Provision restores 4 Stamina when eaten.</p>
                        <p>You can eat Provisions during your adventure (except during combat).</p>

                        <h4>Equipment:</h4>
                        <p>You can find and purchase weapons, armor, and holy items in the castle chapel.</p>
                        <p>Weapons increase your Skill in combat.</p>
                        <p>Armor increases your maximum Stamina.</p>
                        <p>Holy items provide special abilities against vampires.</p>

                        <h4>Character Progression:</h4>
                        <p>Gain experience points (XP) from combat and completing quests.</p>
                        <p>When you level up, your base stats increase permanently.</p>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-rules">BACK TO MAIN MENU</button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen vampire-theme">
            <div class="header">
                <h2>YOUR HUNT IS OVER</h2>
            </div>
            <div class="content">
                <div class="game-over">
                    <pre>
   _____                         ____
  / ____|                       / __ \
 | |  __  __ _ _ __ ___   ___  | |  | |_   _____ _ __
 | | |_ |/ _` | '_ ` _ \ / _ \ | |  | \ \ / / _ \ '__|
 | |__| | (_| | | | | | |  __/ | |__| |\ V /  __/ |
  \_____|\__,_|_| |_| |_|\___|  \____/  \_/ \___|_|
                    </pre>
                    <div class="game-over-message" id="game-over-message">
                        You have failed in your hunt.
                    </div>
                    <div style="margin: 20px 0;">
                        <div>Your journey ended at: <span id="game-over-location">Unknown</span></div>
                        <div>You reached paragraph: <span id="game-over-paragraph">0</span></div>
                        <div>You reached level: <span id="game-over-level">1</span></div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="restart-after-game-over">TRY AGAIN</button>
                <button id="main-menu-after-game-over">MAIN MENU</button>
            </div>
        </div>
    </div>

    <script>
    // ============== GAME STATE ==============
    const gameState = {
        player: {
            baseSkill: 0,
            skill: 0,
            baseStamina: 0,
            stamina: 0,
            maxStamina: 0,
            baseLuck: 0,
            luck: 0,
            gold: 0,
            provisions: 10,
            inventory: [],
            equipped: {
                weapon: null,
                armor: null,
                accessory: null
            },
            experience: 0,
            level: 1,
            hasHolyWater: false,
            hasGarlic: false,
            hasSilverCross: false
        },
        currentParagraph: 1,
        currentEnemy: null,
        combatRound: 0,
        currentCombatVictoryParagraph: null,
        lastLuckTest: null,
        chapelItems: [
            {
                id: "wooden_stake",
                name: "Wooden Stake",
                type: "weapon",
                cost: 15,
                skillBonus: 1,
                description: "A sharpened wooden stake. Effective against vampires. Increases Skill by 1."
            },
            {
                id: "silver_sword",
                name: "Silver Sword",
                type: "weapon",
                cost: 40,
                skillBonus: 2,
                description: "A blessed silver sword that glows faintly. Increases Skill by 2."
            },
            {
                id: "holy_water",
                name: "Holy Water",
                type: "consumable",
                cost: 10,
                effect: "holy",
                value: 1,
                description: "A vial of blessed water. Can be used against undead creatures."
            },
            {
                id: "garlic",
                name: "Garlic Bundle",
                type: "consumable",
                cost: 5,
                effect: "garlic",
                value: 1,
                description: "A bundle of fresh garlic. Repels vampires and weakens them."
            },
            {
                id: "silver_cross",
                name: "Silver Cross",
                type: "accessory",
                cost: 25,
                luckBonus: 2,
                description: "A blessed silver cross. Increases Luck by 2 and protects against evil."
            },
            {
                id: "leather_armor",
                name: "Leather Armor",
                type: "armor",
                cost: 20,
                staminaBonus: 4,
                description: "Light leather armor that increases your maximum Stamina by 4."
            },
            {
                id: "chainmail",
                name: "Chainmail",
                type: "armor",
                cost: 40,
                staminaBonus: 8,
                description: "Heavy chainmail armor that increases your maximum Stamina by 8."
            },
            {
                id: "healing_potion",
                name: "Healing Potion",
                type: "consumable",
                cost: 15,
                effect: "heal",
                value: 10,
                description: "Restores 10 Stamina when used."
            },
            {
                id: "provisions",
                name: "Provisions",
                type: "consumable",
                cost: 5,
                effect: "provision",
                value: 1,
                description: "A day's worth of food. Restores 4 Stamina when eaten."
            }
        ],
        story: {
            1: {
                title: "The Castle Gates",
                text: "You stand before the massive gates of Castle Vorlak. The moon is full, casting an eerie glow on the ancient stone walls. Your mission is clear: find and destroy the vampire lord, Count Vorlak, before he completes his dark ritual. The heavy wooden gates are slightly ajar. Will you:",
                choices: [
                    { text: "Enter through the main gates", next: 2 },
                    { text: "Search for a side entrance", next: 3 },
                    { text: "Check the old chapel first", next: 4 }
                ]
            },
            2: {
                title: "The Grand Hall",
                text: "You step into the grand hall of the castle. Dust covers the once-opulent furniture, and cobwebs hang from the chandeliers. A grand staircase leads upward, and two corridors branch off to the east and west. You hear faint whispers echoing through the hall.",
                choices: [
                    { text: "Ascend the grand staircase", next: 5 },
                    { text: "Take the eastern corridor", next: 6 },
                    { text: "Take the western corridor", next: 7 },
                    { text: "Return to the castle gates", next: 1 }
                ]
            },
            3: {
                title: "The Side Entrance",
                text: "You find a small, hidden door along the castle wall. It's unlocked and leads into a dark, narrow corridor. The air is musty and cold. You can barely see in the dim light, but you notice two paths ahead.",
                choices: [
                    { text: "Follow the left path", next: 8 },
                    { text: "Follow the right path", next: 9 },
                    { text: "Return to the castle gates", next: 1 }
                ]
            },
            4: {
                title: "The Castle Chapel",
                text: "You enter the castle chapel. Though dusty and neglected, it still retains a holy atmosphere. On an altar, you find various items that might aid you in your hunt. This seems like a safe place to rest and prepare.",
                choices: [
                    { text: "Browse the holy items", next: 10 },
                    { text: "Rest and pray (restore 4 Stamina)", next: 11 },
                    { text: "Leave the chapel", next: 1 }
                ]
            },
            5: {
                title: "The Upper Gallery",
                text: "You reach the upper gallery overlooking the grand hall. Portraits of the Vorlak family line the walls, their eyes seeming to follow you. One portrait in particular catches your attention - a pale nobleman with piercing red eyes. A door at the end of the gallery stands slightly open.",
                choices: [
                    { text: "Examine the portrait closely", next: 12 },
                    { text: "Enter the door at the end of the gallery", next: 13 },
                    { text: "Return to the grand hall", next: 2 }
                ]
            },
            6: {
                title: "The Eastern Corridor",
                text: "The eastern corridor is lined with suits of armor. As you pass, one of them suddenly moves, its empty helmet turning to face you! It draws its sword and advances.",
                combat: {
                    enemy: "animated_armor",
                    skill: 8,
                    stamina: 10,
                    ascii: `     ___
    |___|
     | |
    /   \\
   |_____|
    | | |
    | | |
   /     \\`,
                    victory: 14,
                    defeat: 100
                }
            },
            7: {
                title: "The Western Corridor",
                text: "The western corridor leads to a library. Books are scattered everywhere, and the air smells of old paper and dust. On a large table, you notice an open journal. As you approach, a shadowy figure materializes from the bookshelves!",
                combat: {
                    enemy: "shadow_wraith",
                    skill: 9,
                    stamina: 8,
                    ascii: `     .-.
    (   )
     | |
     | |
    _| |_
   |_____|
     | |
     | |
    /   \\`,
                    victory: 15,
                    defeat: 100
                }
            },
            8: {
                title: "The Dungeon",
                text: "The left path descends into the castle dungeon. The air grows colder, and you hear faint moans from the cells. Suddenly, a group of skeletal remains rises from the ground, their bones rattling as they advance toward you!",
                combat: {
                    enemy: "skeletons",
                    skill: 7,
                    stamina: 12,
                    ascii: `     ___     ___     ___
    /   \\   /   \\   /   \\
   | () | | () | | () |
    \\___/   \\___/   \\___/
     /|      /|      /|
    / |     / |     / |`,
                    victory: 16,
                    defeat: 100
                }
            },
            9: {
                title: "The Kitchen",
                text: "The right path leads to the castle kitchen. It's surprisingly well-stocked, with fresh provisions. As you search for anything useful, a large, bat-like creature drops from the ceiling!",
                combat: {
                    enemy: "giant_bat",
                    skill: 6,
                    stamina: 8,
                    ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    \\    /
     \\  /
      \\/`,
                    victory: 17,
                    defeat: 100
                }
            },
            10: {
                title: "Chapel Supplies",
                text: "You examine the items on the altar. There are various holy symbols, weapons, and supplies that could aid you in your hunt against the vampire.",
                choices: [
                    { text: "Browse the chapel items", next: 18 },
                    { text: "Return to the chapel entrance", next: 4 }
                ]
            },
            11: {
                title: "Rest and Prayer",
                text: "You take a moment to rest and pray in the chapel. The holy atmosphere revitalizes you, restoring 4 Stamina.",
                reward: {
                    stamina: 4
                },
                choices: [
                    { text: "Continue", next: 4 }
                ]
            },
            12: {
                title: "The Vorlak Portrait",
                text: "As you examine the portrait of the pale nobleman, the eyes seem to glow red. A secret compartment opens beneath the painting, revealing a silver dagger and a note. The note reads: 'Beware the Count's thralls. Only silver and faith can defeat them.'",
                reward: {
                    inventory: [{
                        id: "silver_dagger",
                        name: "Silver Dagger",
                        type: "weapon",
                        skillBonus: 1,
                        description: "A finely crafted silver dagger. Increases Skill by 1."
                    }]
                },
                choices: [
                    { text: "Take the dagger and continue", next: 13 },
                    { text: "Return to the gallery", next: 5 }
                ]
            },
            13: {
                title: "The Count's Study",
                text: "You enter what appears to be Count Vorlak's personal study. The room is lavishly decorated with dark wood and red velvet. On the desk, you find a journal with recent entries. The last entry reads: 'The ritual is nearly complete. When the moon reaches its zenith, I shall become immortal. My thralls guard the ritual chamber below.'",
                choices: [
                    { text: "Search the study for more clues", next: 19 },
                    { text: "Head to the ritual chamber", next: 20 },
                    { text: "Return to the gallery", next: 5 }
                ]
            },
            14: {
                title: "Armor Defeated",
                text: "The animated armor collapses into a heap of metal. Searching through the pieces, you find a small key and 15 gold coins.",
                reward: {
                    gold: 15,
                    inventory: [{
                        id: "armor_key",
                        name: "Ornate Key",
                        type: "special",
                        description: "A beautifully crafted key. It might unlock something important."
                    }]
                },
                choices: [
                    { text: "Continue down the corridor", next: 21 },
                    { text: "Return to the grand hall", next: 2 }
                ]
            },
            15: {
                title: "Shadow Defeated",
                text: "The shadow wraith dissipates into nothingness. Where it stood, you find a glowing crystal and 10 gold coins.",
                reward: {
                    gold: 10,
                    inventory: [{
                        id: "glowing_crystal",
                        name: "Glowing Crystal",
                        type: "special",
                        description: "A crystal that emits a soft light. It might have magical properties."
                    }]
                },
                choices: [
                    { text: "Search the library", next: 22 },
                    { text: "Return to the grand hall", next: 2 }
                ]
            },
            16: {
                title: "Skeletons Defeated",
                text: "The skeletons crumble to dust. Among the bones, you find a rusted key and 20 gold coins.",
                reward: {
                    gold: 20,
                    inventory: [{
                        id: "rusted_key",
                        name: "Rusted Key",
                        type: "special",
                        description: "An old, rusted key. It might open something in the dungeon."
                    }]
                },
                choices: [
                    { text: "Continue exploring the dungeon", next: 23 },
                    { text: "Return to the side entrance", next: 3 }
                ]
            },
            17: {
                title: "Giant Bat Defeated",
                text: "The giant bat lets out a final shriek before collapsing. You search the kitchen and find fresh provisions and 5 gold coins.",
                reward: {
                    gold: 5,
                    provisions: 3
                },
                choices: [
                    { text: "Search the kitchen further", next: 24 },
                    { text: "Return to the side entrance", next: 3 }
                ]
            },
            18: {
                title: "Chapel Items",
                text: "You look at the holy items available in the chapel.",
                choices: [
                    { text: "Browse the chapel items", next: 25 },
                    { text: "Return to the chapel entrance", next: 4 }
                ]
            },
            19: {
                title: "Study Search",
                text: "You thoroughly search the study. In a hidden drawer, you find a map of the castle showing the location of the ritual chamber in the catacombs below. You also find a vial of holy water.",
                reward: {
                    inventory: [{
                        id: "castle_map",
                        name: "Castle Map",
                        type: "special",
                        description: "A detailed map of Castle Vorlak, showing secret passages."
                    },
                    {
                        id: "holy_water",
                        name: "Holy Water",
                        type: "consumable",
                        effect: "holy",
                        value: 1,
                        description: "A vial of blessed water. Can be used against undead creatures."
                    }]
                },
                choices: [
                    { text: "Head to the ritual chamber", next: 20 },
                    { text: "Return to the gallery", next: 5 }
                ]
            },
            20: {
                title: "The Catacombs",
                text: "Following the map, you find a hidden staircase leading down to the catacombs. The air grows cold and heavy. Torchlight flickers ahead, and you hear chanting. The ritual has begun!",
                choices: [
                    { text: "Sneak closer to observe", next: 26 },
                    { text: "Charge in and interrupt the ritual", next: 27 },
                    { text: "Set up an ambush", next: 28 }
                ]
            },
            21: {
                title: "Eastern Corridor Continued",
                text: "Beyond the defeated armor, the corridor leads to a locked door. The ornate key you found fits perfectly. The door opens to reveal a treasure room!",
                reward: {
                    gold: 50,
                    inventory: [{
                        id: "silver_sword",
                        name: "Silver Sword",
                        type: "weapon",
                        skillBonus: 2,
                        description: "A blessed silver sword that glows faintly. Increases Skill by 2."
                    }]
                },
                choices: [
                    { text: "Take the treasure and return", next: 2 }
                ]
            },
            22: {
                title: "Library Search",
                text: "You search the library and find a book on vampire lore. It contains valuable information about their weaknesses. You also find 25 gold coins hidden in a hollow book.",
                reward: {
                    gold: 25,
                    inventory: [{
                        id: "vampire_tome",
                        name: "Vampire Tome",
                        type: "special",
                        description: "An ancient book containing knowledge about vampires and their weaknesses."
                    }]
                },
                choices: [
                    { text: "Continue searching", next: 29 },
                    { text: "Return to the grand hall", next: 2 }
                ]
            },
            23: {
                title: "Dungeon Depths",
                text: "You venture deeper into the dungeon. The rusted key opens a cell containing a prisoner who turns out to be a former vampire hunter. Before dying, he gives you his silver cross. 'Use it well,' he whispers with his last breath.",
                reward: {
                    inventory: [{
                        id: "silver_cross",
                        name: "Silver Cross",
                        type: "accessory",
                        luckBonus: 2,
                        description: "A blessed silver cross. Increases Luck by 2 and protects against evil."
                    }]
                },
                choices: [
                    { text: "Continue through the dungeon", next: 30 },
                    { text: "Return to the side entrance", next: 3 }
                ]
            },
            24: {
                title: "Kitchen Supplies",
                text: "You find a stash of garlic in the kitchen pantry - a useful weapon against vampires. You also find a healing potion.",
                reward: {
                    inventory: [{
                        id: "garlic",
                        name: "Garlic Bundle",
                        type: "consumable",
                        effect: "garlic",
                        value: 1,
                        description: "A bundle of fresh garlic. Repels vampires and weakens them."
                    },
                    {
                        id: "healing_potion",
                        name: "Healing Potion",
                        type: "consumable",
                        effect: "heal",
                        value: 10,
                        description: "Restores 10 Stamina when used."
                    }]
                },
                choices: [
                    { text: "Return to the side entrance", next: 3 }
                ]
            },
            25: {
                title: "Chapel Items",
                text: "You examine the items available in the chapel.",
                choices: [
                    { text: "Browse the chapel items", next: 31 },
                    { text: "Return to the chapel entrance", next: 4 }
                ]
            },
            26: {
                title: "Ritual Observation",
                text: "You sneak closer and observe the ritual. Count Vorlak stands at an altar, surrounded by his vampire thralls. He's chanting in an ancient language, and a dark energy is gathering around him. You have the element of surprise.",
                choices: [
                    { text: "Attack the Count directly", next: 32 },
                    { text: "Attack the thralls first", next: 33 },
                    { text: "Use holy water to disrupt the ritual", next: 34 }
                ]
            },
            27: {
                title: "Direct Assault",
                text: "You charge into the ritual chamber, disrupting the ceremony. Count Vorlak turns to you, his eyes burning with fury. 'Foolish mortal! You dare interrupt my ascension?'",
                combat: {
                    enemy: "vorlak",
                    skill: 12,
                    stamina: 20,
                    ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    |    |
    |    |
   /      \\`,
                    victory: 35,
                    defeat: 100
                }
            },
            28: {
                title: "Ambush",
                text: "You set up an ambush near the entrance. When a vampire thrall passes by, you strike!",
                combat: {
                    enemy: "vampire_thrall",
                    skill: 10,
                    stamina: 14,
                    ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    |    |
    |    |
   /      \\`,
                    victory: 36,
                    defeat: 100
                }
            },
            29: {
                title: "More Library Finds",
                text: "Your continued search reveals a secret passage behind a bookshelf! It leads to a small room containing a chest. Inside, you find 40 gold coins and a protective amulet.",
                reward: {
                    gold: 40,
                    inventory: [{
                        id: "protective_amulet",
                        name: "Protective Amulet",
                        type: "accessory",
                        luckBonus: 1,
                        description: "A protective amulet that increases your Luck by 1."
                    }]
                },
                choices: [
                    { text: "Take the treasure and return", next: 2 }
                ]
            },
            30: {
                title: "Dungeon Exit",
                text: "The dungeon leads to a secret passage that emerges near the ritual chamber. You've found a back way in!",
                choices: [
                    { text: "Enter the ritual chamber", next: 26 },
                    { text: "Return to the side entrance", next: 3 }
                ]
            },
            31: {
                title: "Chapel Items",
                text: "You look at the items available in the chapel.",
                choices: [
                    { text: "Browse the chapel items", next: 37 },
                    { text: "Return to the chapel entrance", next: 4 }
                ]
            },
            32: {
                title: "Attack the Count",
                text: "You leap at Count Vorlak, catching him by surprise! The ritual is disrupted, and dark energy dissipates.",
                combat: {
                    enemy: "surprised_vorlak",
                    skill: 10,
                    stamina: 18,
                    ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    |    |
    |    |
   /      \\`,
                    victory: 38,
                    defeat: 100
                }
            },
            33: {
                title: "Attack the Thralls",
                text: "You attack the vampire thralls first, hoping to weaken the Count's protection.",
                combat: {
                    enemy: "thralls",
                    skill: 9,
                    stamina: 16,
                    ascii: `      /\\       /\\
     /  \\     /  \\
    / /\\ \\   / /\\ \\
   / ____ \\ / ____ \\
  /_/    \\_/_/    \\_\\
    |    |   |    |
    |    |   |    |
   /      \\ /      \\`,
                    victory: 39,
                    defeat: 100
                }
            },
            34: {
                title: "Holy Water",
                text: "You throw holy water at the ritual circle. The dark energy recoils, and Count Vorlak screams in pain and rage. The ritual is completely disrupted!",
                reward: {
                    inventory: [{
                        id: "holy_water",
                        name: "Holy Water",
                        type: "consumable",
                        effect: "holy",
                        value: 1,
                        description: "A vial of blessed water. Can be used against undead creatures."
                    }]
                },
                choices: [
                    { text: "Attack the weakened Count", next: 40 },
                    { text: "Use garlic to further weaken him", next: 41 }
                ]
            },
            35: {
                title: "Count Vorlak Defeated",
                text: "You have defeated Count Vorlak! The vampire lord crumbles to dust, and the dark energy in the castle dissipates. You've saved the region from his evil reign!",
                victory: true
            },
            36: {
                title: "Thrall Defeated",
                text: "You defeat the vampire thrall. The noise alerts the others, but you've reduced their numbers.",
                choices: [
                    { text: "Attack the remaining thralls", next: 33 },
                    { text: "Attack Count Vorlak", next: 32 }
                ]
            },
            37: {
                title: "Chapel Items",
                text: "You examine the items available in the chapel.",
                choices: [
                    { text: "Browse the chapel items", next: 42 },
                    { text: "Return to the chapel entrance", next: 4 }
                ]
            },
            38: {
                title: "Weakened Count",
                text: "Your surprise attack has wounded Count Vorlak! He's weakened but still dangerous.",
                combat: {
                    enemy: "weakened_vorlak",
                    skill: 11,
                    stamina: 14,
                    ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    |    |
    |    |
   /      \\`,
                    victory: 35,
                    defeat: 100
                }
            },
            39: {
                title: "Thralls Defeated",
                text: "You've defeated the vampire thralls! Count Vorlak is now unprotected and vulnerable.",
                combat: {
                    enemy: "vulnerable_vorlak",
                    skill: 11,
                    stamina: 16,
                    ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    |    |
    |    |
   /      \\`,
                    victory: 35,
                    defeat: 100
                }
            },
            40: {
                title: "Attack Weakened Count",
                text: "You attack the Count while he's weakened by the holy water!",
                combat: {
                    enemy: "holy_weakened_vorlak",
                    skill: 9,
                    stamina: 14,
                    ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    |    |
    |    |
   /      \\`,
                    victory: 35,
                    defeat: 100
                }
            },
            41: {
                title: "Garlic Attack",
                text: "You use garlic to further weaken the Count. He recoils in disgust and pain!",
                reward: {
                    inventory: [{
                        id: "garlic",
                        name: "Garlic Bundle",
                        type: "consumable",
                        effect: "garlic",
                        value: 1,
                        description: "A bundle of fresh garlic. Repels vampires and weakens them."
                    }]
                },
                combat: {
                    enemy: "garlic_weakened_vorlak",
                    skill: 8,
                    stamina: 12,
                    ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    |    |
    |    |
   /      \\`,
                    victory: 35,
                    defeat: 100
                }
            },
            42: {
                title: "Chapel Items",
                text: "You look at the items available in the chapel.",
                choices: [
                    { text: "Browse the chapel items", next: 43 },
                    { text: "Return to the chapel entrance", next: 4 }
                ]
            },
            43: {
                title: "Chapel Items",
                text: "You examine the items available in the chapel.",
                choices: [
                    { text: "Browse the chapel items", next: 44 },
                    { text: "Return to the chapel entrance", next: 4 }
                ]
            },
            44: {
                title: "Chapel Items",
                text: "You look at the items available in the chapel.",
                choices: [
                    { text: "Browse the chapel items", next: 45 },
                    { text: "Return to the chapel entrance", next: 4 }
                ]
            },
            45: {
                title: "Chapel Items",
                text: "You examine the items available in the chapel.",
                choices: [
                    { text: "Return to the chapel entrance", next: 4 }
                ]
            },
            100: {
                title: "Game Over",
                text: "Your hunt has ended in failure. The vampire lord completes his ritual and plunges the region into eternal darkness.",
                gameOver: true
            }
        },
        enemies: {
            animated_armor: {
                name: "Animated Armor",
                skill: 8,
                stamina: 10,
                ascii: `     ___
    |___|
     | |
    /   \\
   |_____|
    | | |
    | | |
   /     \\`
            },
            shadow_wraith: {
                name: "Shadow Wraith",
                skill: 9,
                stamina: 8,
                ascii: `     .-.
    (   )
     | |
     | |
    _| |_
   |_____|
     | |
     | |
    /   \\`
            },
            skeletons: {
                name: "Skeletons",
                skill: 7,
                stamina: 12,
                ascii: `     ___     ___     ___
    /   \\   /   \\   /   \\
   | () | | () | | () |
    \\___/   \\___/   \\___/
     /|      /|      /|
    / |     / |     / |`
            },
            giant_bat: {
                name: "Giant Bat",
                skill: 6,
                stamina: 8,
                ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    \\    /
     \\  /
      \\/`
            },
            vorlak: {
                name: "Count Vorlak",
                skill: 12,
                stamina: 20,
                ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    |    |
    |    |
   /      \\`
            },
            surprised_vorlak: {
                name: "Surprised Count Vorlak",
                skill: 10,
                stamina: 18,
                ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    |    |
    |    |
   /      \\`
            },
            vampire_thrall: {
                name: "Vampire Thrall",
                skill: 10,
                stamina: 14,
                ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    |    |
    |    |
   /      \\`
            },
            thralls: {
                name: "Vampire Thralls",
                skill: 9,
                stamina: 16,
                ascii: `      /\\       /\\
     /  \\     /  \\
    / /\\ \\   / /\\ \\
   / ____ \\ / ____ \\
  /_/    \\_/_/    \\_\\
    |    |   |    |
    |    |   |    |
   /      \\ /      \\`
            },
            weakened_vorlak: {
                name: "Weakened Count Vorlak",
                skill: 11,
                stamina: 14,
                ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    |    |
    |    |
   /      \\`
            },
            vulnerable_vorlak: {
                name: "Vulnerable Count Vorlak",
                skill: 11,
                stamina: 16,
                ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    |    |
    |    |
   /      \\`
            },
            holy_weakened_vorlak: {
                name: "Holy-Weakened Vorlak",
                skill: 9,
                stamina: 14,
                ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    |    |
    |    |
   /      \\`
            },
            garlic_weakened_vorlak: {
                name: "Garlic-Weakened Vorlak",
                skill: 8,
                stamina: 12,
                ascii: `      /\\
     /  \\
    / /\\ \\
   / ____ \\
  /_/    \\_\\
    |    |
    |    |
   /      \\`
            }
        }
    };

    // ============== AUDIO MANAGEMENT ==============
    const audioManager = {
        enabled: true,
        bgMusic: document.getElementById('bg-music'),
        combatSound: document.getElementById('combat-sound'),
        victorySound: document.getElementById('victory-sound'),
        gameOverSound: document.getElementById('game-over-sound'),
        clickSound: document.getElementById('click-sound'),
        vampireSound: document.getElementById('vampire-sound'),
        
        init: function() {
            this.bgMusic.volume = 0.3;
            this.combatSound.volume = 0.5;
            this.victorySound.volume = 0.5;
            this.gameOverSound.volume = 0.5;
            this.clickSound.volume = 0.3;
            this.vampireSound.volume = 0.5;
        },
        
        play: function(sound) {
            if (this.enabled) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("Audio play failed:", e));
            }
        },
        
        toggle: function() {
            this.enabled = !this.enabled;
            if (!this.enabled) {
                this.bgMusic.pause();
            } else {
                this.bgMusic.play().catch(e => console.log("Background music play failed:", e));
            }
            return this.enabled;
        }
    };

    // ============== CORE GAME FUNCTIONS ==============
    function rollDice(numDice = 2) {
        let total = 0;
        for (let i = 0; i < numDice; i++) {
            total += Math.floor(Math.random() * 6) + 1;
        }
        return total;
    }

    function rollSkillDice(skill) {
        const diceRoll = rollDice(2);
        return diceRoll + skill;
    }

    function testLuck() {
        const luckRoll = rollDice(2);
        const isLucky = luckRoll <= gameState.player.luck;
        
        // Decrease luck after test
        gameState.player.luck = Math.max(0, gameState.player.luck - 1);
        
        return {
            roll: luckRoll,
            lucky: isLucky
        };
    }

    function showScreen(screenName) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenName).classList.add('active');
        
        // Play appropriate sounds
        if (screenName === 'combat-screen') {
            audioManager.play(audioManager.vampireSound);
        } else if (screenName === 'game-over-screen') {
            audioManager.play(audioManager.gameOverSound);
        }
    }

    function updateHeaderStats() {
        document.getElementById('header-skill').textContent = gameState.player.skill;
        document.getElementById('header-stamina').textContent = gameState.player.stamina;
        document.getElementById('header-max-stamina').textContent = gameState.player.maxStamina;
        document.getElementById('header-luck').textContent = gameState.player.luck;
        document.getElementById('header-gold').textContent = gameState.player.gold;
        document.getElementById('header-level').textContent = gameState.player.level;
        document.getElementById('header-xp').textContent = gameState.player.experience;
        
        document.getElementById('combat-skill').textContent = gameState.player.skill;
        document.getElementById('combat-stamina').textContent = gameState.player.stamina;
        document.getElementById('combat-max-stamina').textContent = gameState.player.maxStamina;
        document.getElementById('combat-luck').textContent = gameState.player.luck;
        document.getElementById('combat-level').textContent = gameState.player.level;
        
        document.getElementById('inv-skill').textContent = gameState.player.skill;
        document.getElementById('inv-stamina').textContent = gameState.player.stamina;
        document.getElementById('inv-luck').textContent = gameState.player.luck;
        document.getElementById('inv-gold').textContent = gameState.player.gold;
        document.getElementById('inv-level').textContent = gameState.player.level;
        document.getElementById('inv-xp').textContent = gameState.player.experience;
        document.getElementById('provisions-count').textContent = gameState.player.provisions;
    }

    function showParagraph(paragraphId) {
        gameState.currentParagraph = paragraphId;
        const paragraph = gameState.story[paragraphId];
        
        if (!paragraph) {
            console.error("Paragraph not found:", paragraphId);
            showGameOver("Your adventure has reached an unknown path. Paragraph " + paragraphId + " not found.");
            return;
        }
        
        if (paragraph.gameOver) {
            showGameOver(paragraph.text);
            return;
        }
        
        if (paragraph.victory) {
            showVictory();
            return;
        }
        
        document.getElementById('story-title').textContent = paragraph.title;
        
        // Handle dynamic text
        if (paragraph.dynamicText) {
            document.getElementById('story-text').textContent = paragraph.text + " " + paragraph.dynamicText();
        } else {
            document.getElementById('story-text').textContent = paragraph.text;
        }
        
        // Clear previous choices
        const choiceList = document.getElementById('choice-list');
        choiceList.innerHTML = '';
        
        // Hide dice and luck sections
        document.getElementById('dice-roll-section').style.display = 'none';
        document.getElementById('luck-test-section').style.display = 'none';
        
        // Make sure choice list is visible
        choiceList.style.display = 'block';
        
        // Add new choices
        if (paragraph.choices && paragraph.choices.length > 0) {
            paragraph.choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = choice.text;
                
                if (choice.cost && choice.cost > gameState.player.gold) {
                    button.disabled = true;
                    button.textContent += ` (Need ${choice.cost} Gold)`;
                }
                
                button.addEventListener('click', () => {
                    try {
                        audioManager.play(audioManager.clickSound);
                        handleChoice(choice);
                    } catch (error) {
                        console.error('Error in choice click:', error);
                        showGameOver('A technical error occurred: ' + error.message);
                    }
                });
                
                choiceList.appendChild(button);
            });
        } else if (paragraph.combat) {
            // If paragraph leads directly to combat
            const button = document.createElement('button');
            button.className = 'choice-btn';
            button.textContent = `Fight the ${paragraph.combat.enemy}`;
            button.addEventListener('click', () => {
                try {
                    audioManager.play(audioManager.clickSound);
                    startCombat(paragraph.combat.enemy, paragraph.combat.victory);
                } catch (error) {
                    console.error('Error in combat choice click:', error);
                    showGameOver('A technical error occurred: ' + error.message);
                }
            });
            choiceList.appendChild(button);
        }
        
        // Apply rewards if any
        if (paragraph.reward) {
            applyReward(paragraph.reward);
        }
        
        updateHeaderStats();
        showScreen('story-screen');
    }

    function applyReward(reward) {
        if (reward.gold) {
            gameState.player.gold += reward.gold;
            addToLog(`You gained ${reward.gold} gold!`);
        }
        if (reward.provisions) {
            gameState.player.provisions += reward.provisions;
            addToLog(`You gained ${reward.provisions} provisions!`);
        }
        if (reward.inventory) {
            gameState.player.inventory.push(...reward.inventory);
            reward.inventory.forEach(item => {
                addToLog(`You gained ${item.name}!`);
            });
        }
        if (reward.skill) {
            gameState.player.skill += reward.skill;
            gameState.player.baseSkill += reward.skill;
            addToLog(`Your Skill increased by ${reward.skill}!`);
        }
        if (reward.maxStamina) {
            gameState.player.maxStamina += reward.maxStamina;
            gameState.player.baseStamina += reward.maxStamina;
            addToLog(`Your maximum Stamina increased by ${reward.maxStamina}!`);
        }
        if (reward.stamina) {
            gameState.player.stamina += reward.stamina;
            addToLog(`Your Stamina increased by ${reward.stamina}!`);
        }
        
        updateHeaderStats();
    }

    function handleChoice(choice) {
        if (choice.cost && choice.cost > 0) {
            if (gameState.player.gold < choice.cost) {
                alert(`You need ${choice.cost} Gold for this choice!`);
                return;
            }
            gameState.player.gold -= choice.cost;
        }
        
        if (choice.test === "luck") {
            // Show luck test interface
            document.getElementById('luck-test-section').style.display = 'block';
            document.getElementById('choice-list').style.display = 'none';
            
            const luckResult = testLuck();
            document.getElementById('luck-dice-result').textContent = luckResult.roll;
            
            if (luckResult.lucky) {
                document.getElementById('luck-result').textContent = "You are Lucky!";
                document.getElementById('luck-result').className = "luck-result success";
            } else {
                document.getElementById('luck-result').textContent = "You are Unlucky!";
                document.getElementById('luck-result').className = "luck-result failure";
            }
            
            // Store the luck test result
            gameState.lastLuckTest = luckResult;
            
            updateHeaderStats();
        } else if (choice.combat) {
            startCombat(choice.combat, choice.next);
        } else {
            showParagraph(choice.next);
        }
    }

    function startCombat(enemyKey, victoryParagraph) {
        gameState.currentEnemy = {
            ...gameState.enemies[enemyKey],
            currentStamina: gameState.enemies[enemyKey].stamina
        };
        
        gameState.combatRound = 0;
        gameState.currentCombatVictoryParagraph = victoryParagraph;
        
        document.getElementById('enemy-name').textContent = gameState.currentEnemy.name;
        document.getElementById('enemy-ascii').textContent = gameState.currentEnemy.ascii;
        document.getElementById('enemy-skill').textContent = gameState.currentEnemy.skill;
        document.getElementById('enemy-stamina').textContent = gameState.currentEnemy.currentStamina;
        document.getElementById('player-combat-skill').textContent = gameState.player.skill;
        document.getElementById('player-combat-stamina').textContent = gameState.player.stamina;
        
        document.getElementById('player-health-fill').style.width = '100%';
        document.getElementById('enemy-health-fill').style.width = '100%';
        
        document.getElementById('combat-log').innerHTML = `<div>Combat begins! You face a ${gameState.currentEnemy.name}.</div>`;
        
        // Show/hide appropriate buttons
        document.getElementById('attack-btn').style.display = 'block';
        document.getElementById('flee-combat').style.display = 'block';
        document.getElementById('victory-continue').style.display = 'none';
        
        // Show special attack buttons if player has the items
        const hasHolyWater = gameState.player.inventory.some(item => item.id === 'holy_water');
        const hasGarlic = gameState.player.inventory.some(item => item.id === 'garlic');
        
        document.getElementById('holy-attack-btn').style.display = hasHolyWater ? 'block' : 'none';
        document.getElementById('garlic-attack-btn').style.display = hasGarlic ? 'block' : 'none';
        
        showScreen('combat-screen');
    }

    function combatRound() {
        gameState.combatRound++;
        
        const playerAttack = rollSkillDice(gameState.player.skill);
        const enemyAttack = rollSkillDice(gameState.currentEnemy.skill);
        
        document.getElementById('combat-dice-roll').style.display = 'block';
        document.getElementById('player-attack').textContent = playerAttack;
        document.getElementById('enemy-attack').textContent = enemyAttack;
        
        let logMessage = '';
        
        if (playerAttack > enemyAttack) {
            // Player hits enemy
            gameState.currentEnemy.currentStamina -= 2;
            logMessage = `You hit the ${gameState.currentEnemy.name} for 2 damage!`;
            audioManager.play(audioManager.combatSound);
            
            if (gameState.currentEnemy.currentStamina <= 0) {
                logMessage += ` The ${gameState.currentEnemy.name} is defeated!`;
                audioManager.play(audioManager.victorySound);
                document.getElementById('attack-btn').style.display = 'none';
                document.getElementById('flee-combat').style.display = 'none';
                document.getElementById('victory-continue').style.display = 'block';
                document.getElementById('holy-attack-btn').style.display = 'none';
                document.getElementById('garlic-attack-btn').style.display = 'none';
            }
        } else if (enemyAttack > playerAttack) {
            // Enemy hits player
            gameState.player.stamina -= 2;
            logMessage = `The ${gameState.currentEnemy.name} hits you for 2 damage!`;
            audioManager.play(audioManager.combatSound);
            
            if (gameState.player.stamina <= 0) {
                logMessage += ` You have been defeated!`;
                document.getElementById('attack-btn').style.display = 'none';
                document.getElementById('holy-attack-btn').style.display = 'none';
                document.getElementById('garlic-attack-btn').style.display = 'none';
                setTimeout(() => endCombat(false), 1500);
            }
        } else {
            // Tie
            logMessage = `You both miss each other!`;
        }
        
        // Update displays
        document.getElementById('player-combat-stamina').textContent = gameState.player.stamina;
        document.getElementById('enemy-stamina').textContent = gameState.currentEnemy.currentStamina;
        
        const playerHealthPercent = (gameState.player.stamina / gameState.player.maxStamina) * 100;
        const enemyHealthPercent = (gameState.currentEnemy.currentStamina / gameState.currentEnemy.stamina) * 100;
        
        document.getElementById('player-health-fill').style.width = `${playerHealthPercent}%`;
        document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
        
        document.getElementById('combat-result').textContent = logMessage;
        
        // Add to combat log
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `<strong>Round ${gameState.combatRound}:</strong> ${logMessage}`;
        document.getElementById('combat-log').appendChild(logEntry);
        document.getElementById('combat-log').scrollTop = document.getElementById('combat-log').scrollHeight;
        
        updateHeaderStats();
    }

    function holyAttack() {
        if (!gameState.player.inventory.some(item => item.id === 'holy_water')) {
            addToLog("You don't have any holy water!");
            return;
        }
        
        // Remove holy water from inventory
        const holyWaterIndex = gameState.player.inventory.findIndex(item => item.id === 'holy_water');
        if (holyWaterIndex !== -1) {
            gameState.player.inventory.splice(holyWaterIndex, 1);
        }
        
        const damage = 4;
        gameState.currentEnemy.currentStamina -= damage;
        
        addToLog(`You use holy water! The ${gameState.currentEnemy.name} takes ${damage} damage and is weakened!`);
        audioManager.play(audioManager.combatSound);
        
        if (gameState.currentEnemy.currentStamina <= 0) {
            addToLog(`The ${gameState.currentEnemy.name} is defeated!`);
            audioManager.play(audioManager.victorySound);
            document.getElementById('attack-btn').style.display = 'none';
            document.getElementById('flee-combat').style.display = 'none';
            document.getElementById('victory-continue').style.display = 'block';
            document.getElementById('holy-attack-btn').style.display = 'none';
            document.getElementById('garlic-attack-btn').style.display = 'none';
        }
        
        updateCombatDisplay();
        document.getElementById('holy-attack-btn').style.display = 'none';
    }

    function garlicAttack() {
        if (!gameState.player.inventory.some(item => item.id === 'garlic')) {
            addToLog("You don't have any garlic!");
            return;
        }
        
        // Remove garlic from inventory
        const garlicIndex = gameState.player.inventory.findIndex(item => item.id === 'garlic');
        if (garlicIndex !== -1) {
            gameState.player.inventory.splice(garlicIndex, 1);
        }
        
        const damage = 3;
        gameState.currentEnemy.currentStamina -= damage;
        
        addToLog(`You use garlic! The ${gameState.currentEnemy.name} takes ${damage} damage and recoils in disgust!`);
        audioManager.play(audioManager.combatSound);
        
        if (gameState.currentEnemy.currentStamina <= 0) {
            addToLog(`The ${gameState.currentEnemy.name} is defeated!`);
            audioManager.play(audioManager.victorySound);
            document.getElementById('attack-btn').style.display = 'none';
            document.getElementById('flee-combat').style.display = 'none';
            document.getElementById('victory-continue').style.display = 'block';
            document.getElementById('holy-attack-btn').style.display = 'none';
            document.getElementById('garlic-attack-btn').style.display = 'none';
        }
        
        updateCombatDisplay();
        document.getElementById('garlic-attack-btn').style.display = 'none';
    }

    function updateCombatDisplay() {
        document.getElementById('player-combat-stamina').textContent = gameState.player.stamina;
        document.getElementById('enemy-stamina').textContent = gameState.currentEnemy.currentStamina;
        
        const playerHealthPercent = (gameState.player.stamina / gameState.player.maxStamina) * 100;
        const enemyHealthPercent = (gameState.currentEnemy.currentStamina / gameState.currentEnemy.stamina) * 100;
        
        document.getElementById('player-health-fill').style.width = `${playerHealthPercent}%`;
        document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
        
        updateHeaderStats();
    }

    function endCombat(victory) {
        if (victory) {
            // Gain XP from combat
            gameState.player.experience += 5;
            addToLog(`You gained 5 experience points!`);
            
            // Check for level up
            if (gameState.player.experience >= gameState.player.level * 10) {
                gameState.player.level++;
                gameState.player.baseSkill += 1;
                gameState.player.baseStamina += 2;
                gameState.player.baseLuck += 1;
                gameState.player.skill = gameState.player.baseSkill;
                gameState.player.maxStamina = gameState.player.baseStamina;
                gameState.player.luck = gameState.player.baseLuck;
                gameState.player.stamina = gameState.player.maxStamina;
                addToLog(`You reached level ${gameState.player.level}! Your skills have improved!`);
            }
            
            // Find the victory paragraph from the current story paragraph
            if (gameState.currentCombatVictoryParagraph) {
                showParagraph(gameState.currentCombatVictoryParagraph);
            } else {
                showParagraph(1); // Default to beginning if no victory paragraph specified
            }
        } else {
            showGameOver(`You were defeated by the ${gameState.currentEnemy.name}.`);
        }
    }

    function equipItem(item) {
        // Unequip any item of the same type first
        if (item.type === "weapon") {
            if (gameState.player.equipped.weapon) {
                unequipItem(gameState.player.equipped.weapon);
            }
            gameState.player.equipped.weapon = item;
            gameState.player.skill = gameState.player.baseSkill + (item.skillBonus || 0);
        } else if (item.type === "armor") {
            if (gameState.player.equipped.armor) {
                unequipItem(gameState.player.equipped.armor);
            }
            gameState.player.equipped.armor = item;
            const oldMaxStamina = gameState.player.maxStamina;
            gameState.player.maxStamina = gameState.player.baseStamina + (item.staminaBonus || 0);
            // Adjust current stamina if it exceeds the new max
            if (gameState.player.stamina > gameState.player.maxStamina) {
                gameState.player.stamina = gameState.player.maxStamina;
            }
        } else if (item.type === "accessory") {
            if (gameState.player.equipped.accessory) {
                unequipItem(gameState.player.equipped.accessory);
            }
            gameState.player.equipped.accessory = item;
            gameState.player.luck = gameState.player.baseLuck + (item.luckBonus || 0);
        }
        
        updateHeaderStats();
        updateInventoryScreen();
    }

    function unequipItem(item) {
        if (item.type === "weapon") {
            gameState.player.skill = gameState.player.baseSkill;
            gameState.player.equipped.weapon = null;
        } else if (item.type === "armor") {
            const oldMaxStamina = gameState.player.maxStamina;
            gameState.player.maxStamina = gameState.player.baseStamina;
            // Adjust current stamina if it exceeds the new max
            if (gameState.player.stamina > gameState.player.maxStamina) {
                gameState.player.stamina = gameState.player.maxStamina;
            }
            gameState.player.equipped.armor = null;
        } else if (item.type === "accessory") {
            gameState.player.luck = gameState.player.baseLuck;
            gameState.player.equipped.accessory = null;
        }
        
        updateHeaderStats();
        updateInventoryScreen();
    }

    function useConsumable(item) {
        if (item.effect === "heal") {
            const healAmount = Math.min(item.value, gameState.player.maxStamina - gameState.player.stamina);
            gameState.player.stamina += healAmount;
            addToLog(`You used ${item.name} and restored ${healAmount} Stamina!`);
        } else if (item.effect === "provision") {
            gameState.player.provisions += item.value;
            addToLog(`You bought ${item.value} provision(s)!`);
        }
        
        // Remove the item from inventory if it's a single-use consumable
        if (item.effect !== "provision") {
            const itemIndex = gameState.player.inventory.findIndex(i => i.id === item.id);
            if (itemIndex !== -1) {
                gameState.player.inventory.splice(itemIndex, 1);
            }
        }
        
        updateHeaderStats();
        updateInventoryScreen();
    }

    function updateInventoryScreen() {
        const equippedItems = document.getElementById('equipped-items');
        equippedItems.innerHTML = '';
        
        // Show equipped items
        Object.keys(gameState.player.equipped).forEach(slot => {
            const item = gameState.player.equipped[slot];
            if (item) {
                const itemElement = document.createElement('div');
                itemElement.className = 'item item-equipped';
                
                let itemText = `${slot.charAt(0).toUpperCase() + slot.slice(1)}: ${item.name}`;
                if (item.skillBonus) itemText += ` (+${item.skillBonus} Skill)`;
                if (item.staminaBonus) itemText += ` (+${item.staminaBonus} Stamina)`;
                if (item.luckBonus) itemText += ` (+${item.luckBonus} Luck)`;
                
                const textElement = document.createElement('div');
                textElement.textContent = itemText;
                itemElement.appendChild(textElement);
                
                const actionsElement = document.createElement('div');
                actionsElement.className = 'item-actions';
                
                const unequipButton = document.createElement('button');
                unequipButton.className = 'item-action-btn';
                unequipButton.textContent = 'Unequip';
                unequipButton.onclick = () => {
                    audioManager.play(audioManager.clickSound);
                    unequipItem(item);
                };
                actionsElement.appendChild(unequipButton);
                
                itemElement.appendChild(actionsElement);
                equippedItems.appendChild(itemElement);
            }
        });
        
        const inventoryList = document.getElementById('inventory-list');
        inventoryList.innerHTML = '';
        
        if (gameState.player.inventory.length === 0) {
            inventoryList.innerHTML = '<div style="text-align: center; padding: 10px; color: #a0a0a0;">Your backpack is empty</div>';
        } else {
            gameState.player.inventory.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'item item-special';
                
                let itemText = `${item.name}`;
                if (item.skillBonus) itemText += ` (+${item.skillBonus} Skill)`;
                if (item.staminaBonus) itemText += ` (+${item.staminaBonus} Stamina)`;
                if (item.luckBonus) itemText += ` (+${item.luckBonus} Luck)`;
                if (item.effect === "heal") itemText += ` (Heals ${item.value} Stamina)`;
                if (item.effect === "holy") itemText += ` (Damages undead)`;
                if (item.effect === "garlic") itemText += ` (Repels vampires)`;
                
                const textElement = document.createElement('div');
                textElement.textContent = itemText;
                itemElement.appendChild(textElement);
                
                const actionsElement = document.createElement('div');
                actionsElement.className = 'item-actions';
                
                if (item.type === "weapon" || item.type === "armor" || item.type === "accessory") {
                    const equipButton = document.createElement('button');
                    equipButton.className = 'item-action-btn';
                    equipButton.textContent = 'Equip';
                    equipButton.onclick = () => {
                        audioManager.play(audioManager.clickSound);
                        equipItem(item);
                    };
                    actionsElement.appendChild(equipButton);
                }
                
                if (item.type === "consumable") {
                    const useButton = document.createElement('button');
                    useButton.className = 'item-action-btn';
                    useButton.textContent = 'Use';
                    useButton.onclick = () => {
                        audioManager.play(audioManager.clickSound);
                        useConsumable(item);
                    };
                    actionsElement.appendChild(useButton);
                }
                
                itemElement.appendChild(actionsElement);
                inventoryList.appendChild(itemElement);
            });
        }
    }

    function updateChapelScreen() {
        const chapelItems = document.getElementById('chapel-items');
        chapelItems.innerHTML = '';
        
        gameState.chapelItems.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'market-item';
            
            const itemInfo = document.createElement('div');
            itemInfo.innerHTML = `
                <h3>${item.name}</h3>
                <p>${item.description}</p>
                <p><strong>Cost: ${item.cost} Gold</strong></p>
            `;
            
            const buyButton = document.createElement('button');
            buyButton.className = 'item-action-btn';
            buyButton.textContent = 'Buy';
            buyButton.onclick = () => {
                audioManager.play(audioManager.clickSound);
                buyItem(item);
            };
            buyButton.disabled = gameState.player.gold < item.cost;
            
            itemElement.appendChild(itemInfo);
            itemElement.appendChild(buyButton);
            chapelItems.appendChild(itemElement);
        });
        
        document.getElementById('chapel-gold').textContent = gameState.player.gold;
    }

    function buyItem(item) {
        if (gameState.player.gold < item.cost) {
            alert("You don't have enough gold!");
            return;
        }
        
        gameState.player.gold -= item.cost;
        
        if (item.type === "consumable" && item.effect === "provision") {
            gameState.player.provisions += item.value;
            addToLog(`You bought ${item.value} provision(s) for ${item.cost} gold.`);
        } else {
            // Create a copy of the item to add to inventory
            const itemCopy = {...item};
            gameState.player.inventory.push(itemCopy);
            addToLog(`You bought ${item.name} for ${item.cost} gold.`);
        }
        
        updateChapelScreen();
        updateHeaderStats();
        updateInventoryScreen();
    }

    function showGameOver(message) {
        document.getElementById('game-over-message').textContent = message;
        document.getElementById('game-over-location').textContent = gameState.story[gameState.currentParagraph].title;
        document.getElementById('game-over-paragraph').textContent = gameState.currentParagraph;
        document.getElementById('game-over-level').textContent = gameState.player.level;
        showScreen('game-over-screen');
    }

    function showVictory() {
        document.getElementById('game-over-message').textContent = "You have defeated Count Vorlak and saved the region from his evil reign! The castle is cleansed of darkness.";
        document.getElementById('game-over-message').className = "game-over-message victory-message";
        document.getElementById('game-over-location').textContent = "VICTORY!";
        document.getElementById('game-over-paragraph').textContent = gameState.currentParagraph;
        document.getElementById('game-over-level').textContent = gameState.player.level;
        showScreen('game-over-screen');
        audioManager.play(audioManager.victorySound);
    }

    function initializePlayer() {
        // Roll initial stats (as in Fighting Fantasy books)
        gameState.player.baseSkill = rollDice(1) + 6; // 7-12
        gameState.player.baseStamina = rollDice(2) + 12; // 14-24
        gameState.player.baseLuck = rollDice(1) + 6; // 7-12
        
        gameState.player.skill = gameState.player.baseSkill;
        gameState.player.stamina = gameState.player.baseStamina;
        gameState.player.maxStamina = gameState.player.baseStamina;
        gameState.player.luck = gameState.player.baseLuck;
        gameState.player.gold = 20; // Starting gold
        gameState.player.provisions = 10;
        gameState.player.inventory = [];
        gameState.player.equipped = {
            weapon: null,
            armor: null,
            accessory: null
        };
        gameState.player.experience = 0;
        gameState.player.level = 1;
        gameState.player.hasHolyWater = false;
        gameState.player.hasGarlic = false;
        gameState.player.hasSilverCross = false;
        
        gameState.currentParagraph = 1;
        
        updateHeaderStats();
        showParagraph(1);
        
        // Start background music
        audioManager.bgMusic.play().catch(e => console.log("Background music play failed:", e));
    }

    function eatProvision() {
        if (gameState.player.provisions > 0) {
            gameState.player.stamina = Math.min(gameState.player.maxStamina, gameState.player.stamina + 4);
            gameState.player.provisions--;
            updateHeaderStats();
            updateInventoryScreen();
            alert("You eat a provision and restore 4 Stamina.");
        } else {
            alert("You have no provisions left!");
        }
    }

    function addToLog(message) {
        // This function would add messages to a game log if we had one
        console.log(message);
    }

    // ============== SAVE/LOAD SYSTEM ==============
    function saveGame() {
        const saveData = {
            player: gameState.player,
            currentParagraph: gameState.currentParagraph
        };
        localStorage.setItem('vampireCastleSave', JSON.stringify(saveData));
        alert("Game saved successfully!");
    }

    function loadGame() {
        const saveData = localStorage.getItem('vampireCastleSave');
        if (saveData) {
            try {
                const saved = JSON.parse(saveData);
                gameState.player = saved.player;
                gameState.currentParagraph = saved.currentParagraph;
                updateHeaderStats();
                showParagraph(gameState.currentParagraph);
                alert("Game loaded successfully!");
                
                // Start background music
                audioManager.bgMusic.play().catch(e => console.log("Background music play failed:", e));
            } catch (e) {
                alert("Failed to load saved game.");
            }
        } else {
            alert("No saved game found.");
        }
    }

    // ============== INITIALIZATION ==============
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize audio manager
        audioManager.init();
        
        // Main menu buttons
        document.getElementById('new-game').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            initializePlayer();
        });
        document.getElementById('continue-game').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            loadGame();
        });
        document.getElementById('rules-btn').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            showScreen('rules-screen');
        });
        
        // Story screen buttons
        document.getElementById('inventory-btn').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            updateInventoryScreen();
            showScreen('inventory-screen');
        });
        document.getElementById('chapel-btn').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            updateChapelScreen();
            showScreen('chapel-screen');
        });
        document.getElementById('save-load-btn').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            showScreen('save-load-screen');
        });
        
        // Inventory screen buttons
        document.getElementById('back-from-inventory').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            showScreen('story-screen');
        });
        document.getElementById('eat-provision').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            eatProvision();
        });
        
        // Chapel screen buttons
        document.getElementById('back-from-chapel').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            showScreen('story-screen');
        });
        
        // Save/Load screen buttons
        document.getElementById('back-from-save').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            showScreen('story-screen');
        });
        document.getElementById('quick-save').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            saveGame();
        });
        document.getElementById('quick-load').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            loadGame();
        });
        
        // Rules screen buttons
        document.getElementById('back-from-rules').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            showScreen('main-menu');
        });
        
        // Combat screen buttons
        document.getElementById('attack-btn').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            combatRound();
        });
        document.getElementById('holy-attack-btn').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            holyAttack();
        });
        document.getElementById('garlic-attack-btn').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            garlicAttack();
        });
        document.getElementById('flee-combat').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            if (Math.random() < 0.5) {
                // Successful flee
                document.getElementById('combat-log').innerHTML += '<div>You successfully flee from combat!</div>';
                setTimeout(() => showParagraph(1), 1500);
            } else {
                // Failed flee - enemy gets a free attack
                document.getElementById('combat-log').innerHTML += '<div>You fail to flee! The enemy attacks!</div>';
                gameState.player.stamina -= 2;
                updateHeaderStats();
                
                if (gameState.player.stamina <= 0) {
                    document.getElementById('combat-log').innerHTML += '<div>You have been defeated!</div>';
                    setTimeout(() => endCombat(false), 1500);
                }
            }
        });
        
        // Victory continue button
        document.getElementById('victory-continue').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            if (gameState.currentCombatVictoryParagraph) {
                showParagraph(gameState.currentCombatVictoryParagraph);
            } else {
                showParagraph(1);
            }
        });
        
        // Luck test buttons
        document.getElementById('continue-after-luck').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            // For now, just continue to the next paragraph
            document.getElementById('luck-test-section').style.display = 'none';
            document.getElementById('choice-list').style.display = 'block';
        });
        
        // Game over buttons
        document.getElementById('restart-after-game-over').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            initializePlayer();
        });
        document.getElementById('main-menu-after-game-over').addEventListener('click', function() {
            audioManager.play(audioManager.clickSound);
            showScreen('main-menu');
        });
        
        // Audio toggle button
        document.getElementById('audio-toggle').addEventListener('click', function() {
            const audioEnabled = audioManager.toggle();
            this.textContent = audioEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
        });
    });
    </script>
</body>
</html>
