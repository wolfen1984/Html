<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Classic Horror Card Collector - Enhanced</title>
    <style>
        @font-face {
            font-family: 'Creepy';
            src: url('https://fonts.cdnfonts.com/css/creepster') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            image-rendering: pixelated;
        }
        
        body {
            background-color: #0a0a0a;
            background-image: 
                linear-gradient(rgba(20, 0, 0, 0.8) 0.1em, transparent 0.1em),
                linear-gradient(90deg, rgba(20, 0, 0, 0.8) 0.1em, transparent 0.1em);
            background-size: 2em 2em;
            color: #e0e0e0;
            touch-action: manipulation;
            overflow-x: hidden;
            height: 100vh;
            position: fixed;
            width: 100%;
            line-height: 1.4;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 5px #000;
        }
        
        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            border: 12px solid #300;
            border-image: repeating-linear-gradient(45deg, #500, #500 10px, #300 10px, #300 20px) 10;
        }
        
        /* CRT Screen Effect */
        .crt-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            background: 
                linear-gradient(rgba(0, 0, 0, 0.1) 50%, transparent 50%),
                linear-gradient(90deg, 
                    rgba(255, 0, 0, 0.06), 
                    rgba(0, 255, 0, 0.02), 
                    rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 4px 100%;
            opacity: 0.7;
        }
        
        /* Scanlines */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 101;
            background: repeating-linear-gradient(
                to bottom,
                transparent 0%,
                rgba(0, 0, 0, 0.3) 50%,
                transparent 100%
            );
            background-size: 100% 4px;
        }
        
        /* Main Menu */
        #main-menu {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            padding: 20px;
        }
        
        .title {
            font-family: 'Creepy', cursive;
            font-size: 2.5rem;
            color: #e00;
            text-align: center;
            margin-bottom: 2rem;
            text-shadow: 0 0 10px #f00, 0 0 20px #800;
            letter-spacing: 2px;
            background: linear-gradient(90deg, #300, #500, #300);
            padding: 15px 30px;
            border: 4px solid #600;
            border-radius: 0;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            transform: rotate(-2deg);
            animation: title-glow 2s infinite alternate;
        }
        
        @keyframes title-glow {
            from { text-shadow: 0 0 10px #f00, 0 0 20px #800; }
            to { text-shadow: 0 0 15px #f00, 0 0 30px #800; }
        }
        
        .menu-btn {
            background: linear-gradient(#222, #111);
            color: #e0e0e0;
            border: 3px solid #600;
            border-radius: 0;
            padding: 1rem;
            margin: 0.5rem;
            font-size: 1.2rem;
            cursor: pointer;
            width: 80%;
            max-width: 300px;
            transition: all 0.2s;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
            text-shadow: 1px 1px 2px #000;
            box-shadow: 0 4px 0 #300, 0 5px 5px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
        }
        
        .menu-btn:hover {
            transform: translateY(-2px);
        }
        
        .menu-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #300, 0 3px 3px rgba(0, 0, 0, 0.5);
            background: linear-gradient(#111, #222);
        }
        
        .menu-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .menu-btn:hover::before {
            left: 100%;
        }
        
        /* Game Screens */
        .game-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            padding: 10px;
            overflow-y: auto;
            z-index: 5;
        }
        
        .screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #300, #500, #300);
            border-bottom: 3px solid #600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        
        .screen-header h2 {
            font-family: 'Creepy', cursive;
            color: #e00;
            text-shadow: 0 0 5px #000;
            letter-spacing: 1px;
        }
        
        .back-btn {
            background: #300;
            border: 2px solid #600;
            color: #e0e0e0;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 0;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
        }
        
        .back-btn:active {
            background: #600;
            transform: translateY(2px);
        }
        
        .player-info {
            display: flex;
            gap: 15px;
        }
        
        .resource {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border: 1px solid #600;
            border-radius: 3px;
            height: 40px;
        }
        
        /* Card Styles */
        .card {
            width: 120px;
            height: 180px;
            background: linear-gradient(135deg, #222, #111);
            border: 3px solid #444;
            border-radius: 5px;
            margin: 5px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.7);
        }
        
        .card:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        
        .card-character {
            border-color: #a00;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
        }
        
        .card-character .card-header {
            background: linear-gradient(90deg, #500, #a00, #500);
            color: #fff;
        }
        
        .card-item {
            border-color: #06a;
            box-shadow: 0 0 15px rgba(0, 100, 255, 0.3);
        }
        
        .card-item .card-header {
            background: linear-gradient(90deg, #004, #06a, #004);
            color: #fff;
        }
        
        .card-header {
            padding: 8px 5px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: bold;
            border-bottom: 2px solid #444;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            background: linear-gradient(90deg, #333, #555, #333);
            color: #fff;
            text-shadow: 1px 1px 2px #000;
            margin: -5px -5px 5px -5px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .card-body {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            padding: 10px 0;
            background: rgba(0, 0, 0, 0.3);
            margin: 0 -5px;
            border-radius: 3px;
            height: 80px;
        }
        
        .card-stats {
            padding: 5px;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 3px;
            background: rgba(0, 0, 0, 0.3);
            margin: 0 -5px -5px -5px;
            border-top: 1px solid #333;
            height: 40px;
        }
        
        .card-stats span {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .card-level {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #000;
            color: #ff0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            border: 1px solid #ff0;
            font-weight: bold;
            text-shadow: 0 0 3px #000;
            box-shadow: 0 0 5px rgba(255, 255, 0, 0.5);
        }
        
        /* Card Grid */
        .card-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        /* Combat Screen - Mobile Optimized */
        #combat-screen {
            display: flex;
            flex-direction: column;
            height: 100%;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABGSURBVGhD7cExAQAwDMCg+zfdm1hI+JOBv5UkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSXoBzKUBU5eQhXQAAAAASUVORK5CYII=');
            background-size: 100% 100%;
            padding-bottom: 80px; /* Space for combat buttons */
        }
        
        .enemy-area, .player-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            min-height: 30vh; /* Ensure enough space on mobile */
        }
        
        .enemy-area {
            background: rgba(100, 0, 0, 0.3);
            border-bottom: 3px solid #a00;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5);
        }
        
        .player-area {
            background: rgba(0, 50, 0, 0.3);
            border-top: 3px solid #0a0;
            box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.5);
        }
        
        .combat-card {
            width: 100px;
            height: 150px;
            margin: 10px auto;
        }
        
        .combat-log {
            height: 100px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-top: 1px solid #600;
            border-bottom: 1px solid #600;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .combat-log p {
            margin: 5px 0;
            padding: 3px;
            border-left: 2px solid #a00;
            padding-left: 8px;
        }
        
        .combat-actions {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            border-top: 3px solid #600;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            height: 70px; /* Fixed height for mobile */
        }
        
        .combat-btn {
            padding: 10px 15px;
            background: linear-gradient(#222, #111);
            color: #e0e0e0;
            border: 2px solid #600;
            border-radius: 0;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 1px 1px 2px #000;
            transition: all 0.2s;
            box-shadow: 0 3px 0 #300;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
            flex: 1;
            margin: 0 5px;
            font-size: 0.9rem; /* Slightly smaller text for mobile */
        }
        
        .combat-btn:hover {
            background: linear-gradient(#333, #222);
        }
        
        .combat-btn:active {
            transform: translateY(3px);
            box-shadow: none;
        }
        
        /* NEW: Mobile-specific combat improvements */
        .mobile-combat-actions {
            display: none;
        }
        
        .ability-selector {
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px;
            display: none;
            flex-wrap: wrap;
            justify-content: center;
            z-index: 99;
            border-top: 2px solid #600;
        }
        
        .ability-option {
            width: 80px;
            height: 80px;
            margin: 5px;
            background: linear-gradient(#222, #111);
            border: 2px solid #600;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .ability-option:active {
            transform: scale(0.95);
            background: linear-gradient(#111, #222);
        }
        
        .ability-emoji {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .ability-name {
            font-size: 0.7rem;
            text-align: center;
        }
        
        .energy-cost {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #000;
            color: #ff0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        /* NEW: Turn-based combat system */
        .turn-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 15px;
            border: 2px solid #600;
            border-radius: 20px;
            font-weight: bold;
            z-index: 10;
        }
        
        .player-turn {
            color: #0f0;
            border-color: #0f0;
        }
        
        .enemy-turn {
            color: #f00;
            border-color: #f00;
        }
        
        /* NEW: Card targeting system */
        .targeting-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        
        .target-instruction {
            color: #fff;
            font-size: 1.2rem;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .target-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 90%;
        }
        
        .target-option {
            width: 100px;
            height: 150px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .target-option:hover {
            transform: scale(1.05);
        }
        
        /* NEW: Status effects */
        .status-effect {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: #000;
        }
        
        .status-poison {
            background: #0f0;
        }
        
        .status-stun {
            background: #ff0;
        }
        
        .status-burn {
            background: #f00;
        }
        
        .status-heal {
            background: #0af;
        }
        
        /* NEW: Combat stats display */
        .combat-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 10px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8rem;
        }
        
        .stat-value {
            font-weight: bold;
            font-size: 1rem;
        }
        
        /* Shop Screen */
        .shop-tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            border-bottom: 2px solid #600;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .shop-tab {
            padding: 12px 5px;
            background: transparent;
            border: none;
            color: #e0e0e0;
            flex: 1;
            border-bottom: 3px solid transparent;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
        }
        
        .shop-tab:hover {
            background: rgba(100, 0, 0, 0.3);
        }
        
        .shop-tab.active {
            border-bottom: 3px solid #a00;
            color: #fff;
            background: rgba(100, 0, 0, 0.5);
        }
        
        /* Fuse Screen */
        .fuse-slots {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .fuse-slot {
            width: 100px;
            height: 150px;
            background: rgba(0, 0, 0, 0.5);
            border: 3px dashed #600;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .fuse-slot:hover {
            border-color: #a00;
            color: #a00;
        }
        
        .fuse-result {
            width: 100px;
            height: 150px;
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid #600;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            color: #666;
            font-weight: bold;
        }
        
        /* Quests & Achievements */
        .quest-item, .achievement-item {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #a00;
            position: relative;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }
        
        .quest-item h3, .achievement-item h3 {
            color: #e00;
            margin-bottom: 5px;
            font-family: 'Creepy', cursive;
            letter-spacing: 1px;
        }
        
        .quest-reward, .achievement-reward {
            color: #ff0;
            font-size: 0.9rem;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* Inventory Screen */
        .inventory-categories {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            border-bottom: 2px solid #600;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .inventory-category {
            padding: 12px 5px;
            background: transparent;
            border: none;
            color: #e0e0e0;
            flex: 1;
            border-bottom: 3px solid transparent;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
        }
        
        .inventory-category:hover {
            background: rgba(100, 0, 0, 0.3);
        }
        
        .inventory-category.active {
            border-bottom: 3px solid #a00;
            color: #fff;
            background: rgba(100, 0, 0, 0.5);
        }
        
        /* Dungeon Screen */
        .dungeon-level {
            text-align: center;
            margin: 15px 0;
            font-size: 1.2rem;
            font-weight: bold;
            color: #e00;
            text-shadow: 0 0 5px #000;
        }
        
        .dungeon-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            padding: 0 20px;
        }
        
        .dungeon-option {
            padding: 20px;
            background: linear-gradient(135deg, #222, #111);
            color: #e0e0e0;
            border: 3px solid #600;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }
        
        .dungeon-option h3 {
            color: #e00;
            margin-bottom: 10px;
            font-family: 'Creepy', cursive;
            letter-spacing: 1px;
        }
        
        .dungeon-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.7);
            border-color: #a00;
        }
        
        .dungeon-option:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        
        /* Modal Dialog */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: linear-gradient(#222, #111);
            border: 3px solid #600;
            padding: 20px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }
        
        .modal-title {
            font-family: 'Creepy', cursive;
            color: #e00;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .modal-message {
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .modal-btn {
            padding: 10px 20px;
            background: linear-gradient(#222, #111);
            color: #e0e0e0;
            border: 2px solid #600;
            border-radius: 0;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 1px 1px 2px #000;
            transition: all 0.2s;
            box-shadow: 0 3px 0 #300;
        }
        
        .modal-btn:hover {
            background: linear-gradient(#333, #222);
        }
        
        .modal-btn:active {
            transform: translateY(3px);
            box-shadow: none;
        }
        
        /* NEW: Daily Rewards Screen */
        #daily-rewards-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .daily-rewards-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            max-width: 90%;
        }
        
        .daily-reward {
            width: 80px;
            height: 100px;
            background: linear-gradient(135deg, #222, #111);
            border: 3px solid #600;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            text-align: center;
            position: relative;
            transition: all 0.3s;
        }
        
        .daily-reward.claimed {
            border-color: #0a0;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }
        
        .daily-reward.available {
            border-color: #ff0;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.5);
            animation: pulse 2s infinite;
        }
        
        .daily-reward.locked {
            border-color: #666;
            opacity: 0.6;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .daily-reward-day {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #000;
            color: #fff;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        /* NEW: Card Synergy Indicators */
        .synergy-indicator {
            position: absolute;
            bottom: 5px;
            left: 5px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #ff0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.6rem;
            font-weight: bold;
            color: #000;
            box-shadow: 0 0 5px rgba(255, 255, 0, 0.7);
        }
        
        /* NEW: Card Draw Animation */
        .card-draw-animation {
            animation: drawCard 0.5s ease-out;
        }
        
        @keyframes drawCard {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }
        
        /* NEW: Damage Popup */
        .damage-popup {
            position: absolute;
            color: #ff4444;
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
            z-index: 200;
            text-shadow: 0 0 5px #000;
            animation: popupDamage 1s ease-out forwards;
        }
        
        @keyframes popupDamage {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        /* NEW: Card Upgrade Animation */
        .card-upgrade-animation {
            animation: upgradeCard 0.8s ease-out;
        }
        
        @keyframes upgradeCard {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); box-shadow: 0 0 30px rgba(255, 215, 0, 0.8); }
            100% { transform: scale(1); }
        }
        
        /* NEW: Story Screen */
        #story-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .story-text {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #600;
            border-radius: 5px;
            max-width: 600px;
            line-height: 1.6;
            font-size: 1.1rem;
        }
        
        .story-choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 400px;
        }
        
        .story-choice {
            padding: 15px;
            background: linear-gradient(#222, #111);
            border: 2px solid #600;
            color: #e0e0e0;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .story-choice:hover {
            background: linear-gradient(#333, #222);
            border-color: #a00;
        }
        
        /* NEW: Settings Screen */
        #settings-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .settings-option {
            width: 90%;
            max-width: 400px;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-toggle {
            width: 50px;
            height: 25px;
            background: #333;
            border-radius: 25px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .settings-toggle.active {
            background: #a00;
        }
        
        .settings-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .settings-toggle.active::after {
            left: 27px;
        }
        
        /* NEW: Crafting Screen */
        #crafting-screen {
            display: flex;
            flex-direction: column;
        }
        
        .crafting-tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            border-bottom: 2px solid #600;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .crafting-tab {
            padding: 12px 5px;
            background: transparent;
            border: none;
            color: #e0e0e0;
            flex: 1;
            border-bottom: 3px solid transparent;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .crafting-tab:hover {
            background: rgba(100, 0, 0, 0.3);
        }
        
        .crafting-tab.active {
            border-bottom: 3px solid #a00;
            color: #fff;
            background: rgba(100, 0, 0, 0.5);
        }
        
        .crafting-cost {
            color: #ff0;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        /* NEW: Card Synergy Display */
        .synergy-display {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #600;
            border-radius: 5px;
        }
        
        .synergy-display h4 {
            color: #ff0;
            margin-bottom: 5px;
        }
        
        /* Mobile-specific adjustments */
        @media (max-width: 768px) {
            .combat-actions {
                height: 60px;
            }
            
            .combat-btn {
                padding: 8px 10px;
                font-size: 0.8rem;
                height: 45px;
            }
            
            .enemy-area, .player-area {
                min-height: 25vh;
            }
            
            .combat-card {
                width: 80px;
                height: 120px;
            }
            
            .card-body {
                font-size: 2rem;
            }
            
            .card-header {
                font-size: 0.8rem;
            }
            
            .card-stats {
                font-size: 0.7rem;
            }
            
            .ability-option {
                width: 70px;
                height: 70px;
            }
            
            .title {
                font-size: 1.8rem;
                padding: 10px 20px;
            }
            
            .menu-btn {
                padding: 0.8rem;
                font-size: 1rem;
            }
            
            .dungeon-option {
                padding: 15px;
            }
            
            .daily-reward {
                width: 70px;
                height: 90px;
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 480px) {
            .combat-actions {
                height: 50px;
            }
            
            .combat-btn {
                padding: 5px 8px;
                font-size: 0.7rem;
                height: 40px;
            }
            
            .combat-card {
                width: 70px;
                height: 105px;
            }
            
            .card-body {
                font-size: 1.8rem;
            }
            
            .ability-option {
                width: 60px;
                height: 60px;
            }
            
            .ability-emoji {
                font-size: 1.2rem;
            }
            
            .ability-name {
                font-size: 0.6rem;
            }
        }
        
        /* Glitch effect for rare cards */
        .card-rare {
            animation: glitch 5s infinite alternate;
        }
        
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        
        /* Hover effect for cards */
        .card:hover .card-body {
            animation: float 2s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }
        
        /* Blood splatter effect */
        .blood-splatter {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M30,20 Q40,10 50,20 T70,20 Q80,30 70,40 T70,60 Q60,70 50,60 T30,60 Q20,50 30,40 Z" fill="rgba(200,0,0,0.3)"/></svg>');
            background-size: 20% 20%;
            opacity: 0.3;
            pointer-events: none;
            z-index: -1;
        }
        
        /* Special card effects */
        .card-legendary {
            animation: rainbow 3s linear infinite;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
        }
        
        @keyframes rainbow {
            0% { border-color: #ff0000; }
            16% { border-color: #ff7f00; }
            33% { border-color: #ffff00; }
            50% { border-color: #00ff00; }
            66% { border-color: #0000ff; }
            83% { border-color: #4b0082; }
            100% { border-color: #9400d3; }
        }
        
        /* Card shine effect */
        .card:hover::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to bottom right,
                rgba(255, 255, 255, 0) 45%,
                rgba(255, 255, 255, 0.8) 50%,
                rgba(255, 255, 255, 0) 55%
            );
            transform: rotate(30deg);
            pointer-events: none;
        }
        
        /* Card rarity indicators */
        .rarity-indicator {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }
        
        .rarity-common { background-color: #aaa; }
        .rarity-uncommon { background-color: #0a0; }
        .rarity-rare { background-color: #06a; }
        .rarity-epic { background-color: #a0a; }
        .rarity-legendary { background-color: #fa0; }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- CRT Effects -->
        <div class="crt-effect"></div>
        <div class="scanlines"></div>
        <div class="blood-splatter"></div>
        
        <!-- Main Menu -->
        <div id="main-menu">
            <h1 class="title">CLASSIC HORROR<br>CARD COLLECTOR</h1>
            <button class="menu-btn" onclick="showScreen('collection-screen')">Collection</button>
            <button class="menu-btn" onclick="showScreen('combat-screen')">Combat</button>
            <button class="menu-btn" onclick="showScreen('dungeon-screen')">Dungeon</button>
            <button class="menu-btn" onclick="showScreen('shop-screen')">Shop</button>
            <button class="menu-btn" onclick="showScreen('fuse-screen')">Fuse Cards</button>
            <button class="menu-btn" onclick="showScreen('inventory-screen')">Inventory</button>
            <button class="menu-btn" onclick="showScreen('quests-screen')">Quests</button>
            <button class="menu-btn" onclick="showScreen('achievements-screen')">Achievements</button>
            <!-- NEW: Added Daily Rewards and Settings buttons -->
            <button class="menu-btn" onclick="showScreen('daily-rewards-screen')">Daily Rewards</button>
            <button class="menu-btn" onclick="showScreen('story-screen')">Story</button>
            <button class="menu-btn" onclick="showScreen('crafting-screen')">Crafting</button>
            <button class="menu-btn" onclick="showScreen('settings-screen')">Settings</button>
        </div>
        
        <!-- Collection Screen -->
        <div id="collection-screen" class="game-screen">
            <div class="screen-header">
                <button class="back-btn" onclick="returnToMainMenu()">‚Üê</button>
                <h2>YOUR COLLECTION</h2>
                <div class="player-info">
                    <div class="resource">ü™ô <span id="gold-display">1000</span></div>
                    <div class="resource">üíé <span id="gems-display">50</span></div>
                    <div class="resource">‚≠ê <span id="essence-display">0</span></div>
                </div>
            </div>
            <!-- NEW: Synergy Display -->
            <div class="synergy-display" id="synergy-display" style="display: none;">
                <h4>ACTIVE SYNERGIES</h4>
                <div id="active-synergies"></div>
            </div>
            <div class="card-grid" id="collection-grid">
                <!-- Cards will be added here by JavaScript -->
            </div>
        </div>
        
        <!-- Combat Screen -->
        <div id="combat-screen" class="game-screen">
            <div class="screen-header">
                <button class="back-btn" onclick="returnToMainMenu()">‚Üê</button>
                <h2>COMBAT</h2>
                <div class="player-info">
                    <div class="resource">‚ù§Ô∏è <span id="player-health">100/100</span></div>
                    <div class="resource">üî• <span id="player-energy">0/3</span></div>
                </div>
            </div>
            
            <!-- NEW: Turn Indicator -->
            <div class="turn-indicator player-turn" id="turn-indicator">YOUR TURN</div>
            
            <div class="enemy-area">
                <h3 style="color: #f00; text-shadow: 0 0 5px #000;">ENEMY</h3>
                <div class="card card-character combat-card" id="enemy-card">
                    <div class="card-header">Zombie</div>
                    <div class="card-body">üßü</div>
                    <div class="card-stats">
                        <span>‚ù§Ô∏è 50</span>
                        <span>‚öîÔ∏è 5</span>
                    </div>
                    <!-- NEW: Status effects for enemy -->
                    <div class="status-effect status-poison" id="enemy-status-poison" style="display: none;">P</div>
                    <div class="status-effect status-stun" id="enemy-status-stun" style="display: none;">S</div>
                </div>
                
                <!-- NEW: Enemy stats display -->
                <div class="combat-stats">
                    <div class="stat-item">
                        <div>Attack</div>
                        <div class="stat-value" id="enemy-attack">5</div>
                    </div>
                    <div class="stat-item">
                        <div>Defense</div>
                        <div class="stat-value" id="enemy-defense">0</div>
                    </div>
                    <div class="stat-item">
                        <div>Speed</div>
                        <div class="stat-value" id="enemy-speed">5</div>
                    </div>
                </div>
            </div>
            
            <div class="combat-log" id="combat-log">
                <p>Combat log will appear here...</p>
            </div>
            
            <div class="player-area">
                <h3 style="color: #0f0; text-shadow: 0 0 5px #000;">YOUR DECK</h3>
                <div class="card-grid" id="combat-deck">
                    <!-- Combat cards will be added here by JavaScript -->
                </div>
                
                <!-- NEW: Player stats display -->
                <div class="combat-stats">
                    <div class="stat-item">
                        <div>Attack</div>
                        <div class="stat-value" id="player-attack">5</div>
                    </div>
                    <div class="stat-item">
                        <div>Defense</div>
                        <div class="stat-value" id="player-defense">0</div>
                    </div>
                    <div class="stat-item">
                        <div>Speed</div>
                        <div class="stat-value" id="player-speed">5</div>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Ability Selector -->
            <div class="ability-selector" id="ability-selector">
                <!-- Ability options will be added here by JavaScript -->
            </div>
            
            <!-- NEW: Targeting Overlay -->
            <div class="targeting-overlay" id="targeting-overlay">
                <div class="target-instruction" id="target-instruction">Select a target:</div>
                <div class="target-options" id="target-options">
                    <!-- Target options will be added here by JavaScript -->
                </div>
                <button class="combat-btn" onclick="hideTargetingOverlay()" style="margin-top: 20px;">Cancel</button>
            </div>
            
            <div class="combat-actions">
                <button class="combat-btn" onclick="attack()">Attack</button>
                <button class="combat-btn" onclick="showAbilitySelector()">Abilities</button>
                <button class="combat-btn" onclick="useItem()">Items</button>
                <button class="combat-btn" onclick="flee()">Flee</button>
            </div>
        </div>
        
        <!-- Dungeon Screen -->
        <div id="dungeon-screen" class="game-screen">
            <div class="screen-header">
                <button class="back-btn" onclick="returnToMainMenu()">‚Üê</button>
                <h2>DUNGEON</h2>
                <div class="player-info">
                    <div class="resource">ü™ô <span id="dungeon-gold">1000</span></div>
                    <div class="resource">üèÜ <span id="dungeon-level">1</span></div>
                </div>
            </div>
            
            <div class="dungeon-level">
                CURRENT FLOOR: <span id="current-floor">1</span>
            </div>
            
            <div class="dungeon-options">
                <div class="dungeon-option" onclick="enterDungeon('easy')">
                    <h3>EASY DUNGEON</h3>
                    <p>Basic enemies, low rewards</p>
                </div>
                <div class="dungeon-option" onclick="enterDungeon('medium')">
                    <h3>MEDIUM DUNGEON</h3>
                    <p>Stronger enemies, better rewards</p>
                </div>
                <div class="dungeon-option" onclick="enterDungeon('hard')">
                    <h3>HARD DUNGEON</h3>
                    <p>Challenging enemies, great rewards</p>
                </div>
                <div class="dungeon-option" onclick="enterDungeon('boss')" id="boss-dungeon" style="display:none;">
                    <h3>BOSS DUNGEON</h3>
                    <p>Face the ultimate challenge!</p>
                </div>
            </div>
        </div>
        
        <!-- Shop Screen -->
        <div id="shop-screen" class="game-screen">
            <div class="screen-header">
                <button class="back-btn" onclick="returnToMainMenu()">‚Üê</button>
                <h2>SHOP</h2>
                <div class="player-info">
                    <div class="resource">ü™ô <span id="shop-gold">1000</span></div>
                    <div class="resource">üíé <span id="shop-gems">50</span></div>
                </div>
            </div>
            
            <div class="shop-tabs">
                <button class="shop-tab active" onclick="changeShopTab('character')">Characters</button>
                <button class="shop-tab" onclick="changeShopTab('item')">Items</button>
                <button class="shop-tab" onclick="changeShopTab('pack')">Packs</button>
                <button class="shop-tab" onclick="changeShopTab('upgrade')">Upgrades</button>
            </div>
            
            <div class="card-grid" id="shop-items">
                <!-- Shop items will be added here by JavaScript -->
            </div>
        </div>
        
        <!-- Fuse Screen -->
        <div id="fuse-screen" class="game-screen">
            <div class="screen-header">
                <button class="back-btn" onclick="returnToMainMenu()">‚Üê</button>
                <h2>FUSE CARDS</h2>
                <div class="player-info">
                    <div class="resource">ü™ô <span id="fuse-gold">1000</span></div>
                </div>
            </div>
            
            <p style="text-align: center; margin: 10px; color: #aaa;">SELECT 2 CARDS TO FUSE TOGETHER</p>
            
            <div class="fuse-slots">
                <div class="fuse-slot" id="fuse-slot-1" onclick="clearFuseSlot(1)">SLOT 1</div>
                <div class="fuse-slot" id="fuse-slot-2" onclick="clearFuseSlot(2)">SLOT 2</div>
            </div>
            
            <div class="fuse-result" id="fuse-result">RESULT</div>
            
            <button class="menu-btn" style="margin: 20px auto; background: linear-gradient(#500, #300);" onclick="fuseCards()" id="fuse-btn" disabled>FUSE CARDS (50ü™ô)</button>
            
            <div class="card-grid" id="fuse-collection">
                <!-- Cards for fusing will be added here by JavaScript -->
            </div>
        </div>
        
        <!-- Inventory Screen -->
        <div id="inventory-screen" class="game-screen">
            <div class="screen-header">
                <button class="back-btn" onclick="returnToMainMenu()">‚Üê</button>
                <h2>INVENTORY</h2>
                <div class="player-info">
                    <div class="resource">ü™ô <span id="inventory-gold">1000</span></div>
                </div>
            </div>
            
            <div class="inventory-categories">
                <button class="inventory-category active" onclick="changeInventoryTab('equipment')">Equipment</button>
                <button class="inventory-category" onclick="changeInventoryTab('consumables')">Consumables</button>
                <button class="inventory-category" onclick="changeInventoryTab('materials')">Materials</button>
            </div>
            
            <div class="card-grid" id="inventory-items">
                <!-- Inventory items will be added here by JavaScript -->
            </div>
        </div>
        
        <!-- Quests Screen -->
        <div id="quests-screen" class="game-screen">
            <div class="screen-header">
                <button class="back-btn" onclick="returnToMainMenu()">‚Üê</button>
                <h2>QUESTS</h2>
                <div class="player-info">
                    <div class="resource">ü™ô <span id="quests-gold">1000</span></div>
                </div>
            </div>
            
            <div id="quests-list">
                <div class="quest-item">
                    <h3>Defeat 5 Enemies</h3>
                    <p>Progress: <span id="quest-1-progress">0</span>/5</p>
                    <p class="quest-reward">Reward: 200ü™ô, 1 Card Pack</p>
                    <button class="combat-btn" style="position: absolute; right: 15px; bottom: 15px;" id="quest-1-btn" disabled>Claim</button>
                </div>
                <div class="quest-item">
                    <h3>Collect 3 Vampire Cards</h3>
                    <p>Progress: <span id="quest-2-progress">1</span>/3</p>
                    <p class="quest-reward">Reward: 300ü™ô, Dracula Card</p>
                    <button class="combat-btn" style="position: absolute; right: 15px; bottom: 15px;" id="quest-2-btn" disabled>Claim</button>
                </div>
                <div class="quest-item">
                    <h3>Fuse 2 Cards</h3>
                    <p>Progress: <span id="quest-3-progress">0</span>/2</p>
                    <p class="quest-reward">Reward: 150ü™ô, Upgrade Stone</p>
                    <button class="combat-btn" style="position: absolute; right: 15px; bottom: 15px;" id="quest-3-btn" disabled>Claim</button>
                </div>
                <div class="quest-item">
                    <h3>Complete a Dungeon</h3>
                    <p>Progress: <span id="quest-4-progress">0</span>/1</p>
                    <p class="quest-reward">Reward: 500ü™ô, Rare Card Pack</p>
                    <button class="combat-btn" style="position: absolute; right: 15px; bottom: 15px;" id="quest-4-btn" disabled>Claim</button>
                </div>
            </div>
        </div>
        
        <!-- Achievements Screen -->
        <div id="achievements-screen" class="game-screen">
            <div class="screen-header">
                <button class="back-btn" onclick="returnToMainMenu()">‚Üê</button>
                <h2>ACHIEVEMENTS</h2>
                <div class="player-info">
                    <div class="resource">üèÜ <span id="achievement-points">0</span></div>
                </div>
            </div>
            
            <div id="achievements-list">
                <div class="achievement-item">
                    <h3>First Blood</h3>
                    <p>Win your first combat</p>
                    <p class="achievement-reward">Reward: 10üíé</p>
                    <button class="combat-btn" style="position: absolute; right: 15px; bottom: 15px;" id="achieve-1-btn" disabled>Claim</button>
                </div>
                <div class="achievement-item">
                    <h3>Card Collector</h3>
                    <p>Collect 10 different cards</p>
                    <p class="achievement-reward">Reward: 20üíé</p>
                    <button class="combat-btn" style="position: absolute; right: 15px; bottom: 15px;" id="achieve-2-btn" disabled>Claim</button>
                </div>
                <div class="achievement-item">
                    <h3>Master Fuser</h3>
                    <p>Fuse 10 cards</p>
                    <p class="achievement-reward">Reward: 30üíé</p>
                    <button class="combat-btn" style="position: absolute; right: 15px; bottom: 15px;" id="achieve-3-btn" disabled>Claim</button>
                </div>
                <div class="achievement-item">
                    <h3>Dungeon Delver</h3>
                    <p>Complete 5 dungeons</p>
                    <p class="achievement-reward">Reward: 50üíé</p>
                    <button class="combat-btn" style="position: absolute; right: 15px; bottom: 15px;" id="achieve-4-btn" disabled>Claim</button>
                </div>
            </div>
        </div>
        
        <!-- NEW: Daily Rewards Screen -->
        <div id="daily-rewards-screen" class="game-screen">
            <div class="screen-header">
                <button class="back-btn" onclick="returnToMainMenu()">‚Üê</button>
                <h2>DAILY REWARDS</h2>
                <div class="player-info">
                    <div class="resource">üìÖ <span id="login-streak">1</span> Days</div>
                </div>
            </div>
            
            <p style="text-align: center; margin: 10px; color: #aaa;">Claim your daily reward! Streak continues for 7 days.</p>
            
            <div class="daily-rewards-container" id="daily-rewards-container">
                <!-- Daily rewards will be added here by JavaScript -->
            </div>
            
            <button class="menu-btn" style="margin: 20px auto;" onclick="claimDailyReward()" id="daily-reward-btn">CLAIM TODAY'S REWARD</button>
        </div>
        
        <!-- NEW: Story Screen -->
        <div id="story-screen" class="game-screen">
            <div class="screen-header">
                <button class="back-btn" onclick="returnToMainMenu()">‚Üê</button>
                <h2>THE HORROR BEGINS</h2>
                <div class="player-info">
                    <div class="resource">üìñ Chapter <span id="story-chapter">1</span></div>
                </div>
            </div>
            
            <div class="story-text" id="story-text">
                The night is dark and full of terrors. You find yourself in a forgotten land where monsters roam freely. Your only hope is to collect powerful cards and build an army of horror to survive...
            </div>
            
            <div class="story-choices">
                <div class="story-choice" onclick="advanceStory(1)">Begin your journey into the darkness</div>
                <div class="story-choice" onclick="advanceStory(2)">Seek out the ancient crypt</div>
                <div class="story-choice" onclick="advanceStory(3)">Challenge the first monster</div>
            </div>
        </div>
        
        <!-- NEW: Crafting Screen -->
        <div id="crafting-screen" class="game-screen">
            <div class="screen-header">
                <button class="back-btn" onclick="returnToMainMenu()">‚Üê</button>
                <h2>CRAFTING</h2>
                <div class="player-info">
                    <div class="resource">‚≠ê <span id="crafting-essence">0</span></div>
                </div>
            </div>
            
            <div class="crafting-tabs">
                <button class="crafting-tab active" onclick="changeCraftingTab('disenchant')">Disenchant</button>
                <button class="crafting-tab" onclick="changeCraftingTab('craft')">Craft</button>
            </div>
            
            <div class="card-grid" id="crafting-items">
                <!-- Crafting items will be added here by JavaScript -->
            </div>
        </div>
        
        <!-- NEW: Settings Screen -->
        <div id="settings-screen" class="game-screen">
            <div class="screen-header">
                <button class="back-btn" onclick="returnToMainMenu()">‚Üê</button>
                <h2>SETTINGS</h2>
            </div>
            
            <div class="settings-option">
                <span>Sound Effects</span>
                <div class="settings-toggle" id="sound-toggle" onclick="toggleSetting('sound')"></div>
            </div>
            
            <div class="settings-option">
                <span>Music</span>
                <div class="settings-toggle active" id="music-toggle" onclick="toggleSetting('music')"></div>
            </div>
            
            <div class="settings-option">
                <span>Animations</span>
                <div class="settings-toggle active" id="animations-toggle" onclick="toggleSetting('animations')"></div>
            </div>
            
            <div class="settings-option">
                <span>Notifications</span>
                <div class="settings-toggle active" id="notifications-toggle" onclick="toggleSetting('notifications')"></div>
            </div>
            
            <button class="menu-btn" style="margin: 20px auto; background: linear-gradient(#500, #300);" onclick="saveGame()">SAVE GAME</button>
            <button class="menu-btn" style="margin: 10px auto; background: linear-gradient(#500, #300);" onclick="resetGame()">RESET GAME</button>
            
            <!-- NEW: Debug Panel (hidden by default) -->
            <div id="debug-panel" style="display: none; margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid #600;">
                <h3 style="color: #ff0; text-align: center;">DEBUG PANEL</h3>
                <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                    <button class="combat-btn" onclick="addGold(1000)">+1000 Gold</button>
                    <button class="combat-btn" onclick="addGems(100)">+100 Gems</button>
                    <button class="combat-btn" onclick="unlockAllCards()">Unlock All Cards</button>
                </div>
            </div>
            
            <button class="menu-btn" style="margin: 10px auto; background: linear-gradient(#333, #222);" onclick="toggleDebugPanel()">DEBUG MODE</button>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            gold: 1000,
            gems: 50,
            essence: 0,
            health: 100,
            maxHealth: 100,
            energy: 0,
            maxEnergy: 3,
            playerLevel: 1,
            experience: 0,
            experienceToNextLevel: 100,
            playerDeck: [],
            collection: [],
            inventory: {
                equipment: [],
                consumables: [
                    { id: 201, name: "Health Potion", type: "consumable", emoji: "üß™", effect: "Restore 30 HP", count: 3 },
                    { id: 202, name: "Energy Potion", type: "consumable", emoji: "‚ö°", effect: "Restore 1 Energy", count: 2 }
                ],
                materials: [
                    { id: 301, name: "Upgrade Stone", type: "material", emoji: "üíé", effect: "Upgrade card by 1 level", count: 0 },
                    { id: 302, name: "Fusion Catalyst", type: "material", emoji: "üß™", effect: "Improve fusion results", count: 0 }
                ]
            },
            enemiesDefeated: 0,
            cardsFused: 0,
            dungeonsCompleted: 0,
            uniqueCardsCollected: 4,
            dungeonLevel: 1,
            achievements: {
                firstBlood: false,
                cardCollector: false,
                masterFuser: false,
                dungeonDelver: false
            },
            quests: {
                defeatEnemies: { progress: 0, completed: false },
                collectVampires: { progress: 1, completed: false },
                fuseCards: { progress: 0, completed: false },
                completeDungeon: { progress: 0, completed: false }
            },
            currentDungeon: null,
            inDungeon: false,
            dungeonEnemiesDefeated: 0,
            // NEW: Daily rewards system
            dailyRewards: {
                lastClaimDate: null,
                streak: 0,
                claimedDays: []
            },
            // NEW: Story progression
            story: {
                chapter: 1,
                progress: 0
            },
            // NEW: Settings
            settings: {
                sound: true,
                music: true,
                animations: true,
                notifications: true
            },
            // NEW: Card synergies
            activeSynergies: [],
            // NEW: Enhanced combat properties
            combat: {
                isPlayerTurn: true,
                playerStats: {
                    baseAttack: 5,
                    baseDefense: 0,
                    baseSpeed: 5,
                    currentAttack: 5,
                    currentDefense: 0,
                    currentSpeed: 5
                },
                enemyStats: {
                    baseAttack: 5,
                    baseDefense: 0,
                    baseSpeed: 5,
                    currentAttack: 5,
                    currentDefense: 0,
                    currentSpeed: 5
                },
                statusEffects: {
                    player: [],
                    enemy: []
                },
                selectedAbility: null,
                selectedItem: null
            }
        };

        // NEW: Card Synergies
        const cardSynergies = {
            vampire: {
                name: "Vampire Coven",
                description: "+10 Attack to all Vampires",
                cards: [1, 8], // Dracula, Vampire Lord
                bonus: { attack: 10 }
            },
            undead: {
                name: "Undead Legion",
                description: "+5 Health to all Undead",
                cards: [5, 4, 13], // Zombie, Mummy, Revenant
                bonus: { health: 5 }
            },
            werewolf: {
                name: "Pack Mentality",
                description: "+5 Attack and +5 Health to all Werewolves",
                cards: [2, 15], // Wolfman, Chupacabra
                bonus: { attack: 5, health: 5 }
            },
            spirit: {
                name: "Ethereal Bond",
                description: "+3 Attack and Dodge chance",
                cards: [6, 11, 14, 18, 20], // Ghost, Phantom, Banshee, Doppelganger, Poltergeist
                bonus: { attack: 3, dodge: 0.1 }
            }
        };

        // Card Database - Expanded with more horror characters and items
        const characterCards = [
            { id: 1, name: "Dracula", type: "character", emoji: "üßõ", health: 80, attack: 15, ability: "Lifesteal", level: 1, rarity: "epic", subtype: "vampire" },
            { id: 2, name: "Wolfman", type: "character", emoji: "üê∫", health: 70, attack: 12, ability: "Berserk", level: 1, rarity: "rare", subtype: "werewolf" },
            { id: 3, name: "Frankenstein", type: "character", emoji: "üßü", health: 100, attack: 8, ability: "Stun", level: 1, rarity: "rare", subtype: "construct" },
            { id: 4, name: "The Mummy", type: "character", emoji: "üßü", health: 90, attack: 10, ability: "Curse", level: 1, rarity: "rare", subtype: "undead" },
            { id: 5, name: "Zombie", type: "character", emoji: "üßü", health: 50, attack: 5, ability: "Revive", level: 1, rarity: "common", subtype: "undead" },
            { id: 6, name: "Ghost", type: "character", emoji: "üëª", health: 40, attack: 8, ability: "Dodge", level: 1, rarity: "common", subtype: "spirit" },
            { id: 7, name: "Witch", type: "character", emoji: "üßô", health: 60, attack: 10, ability: "Hex", level: 1, rarity: "uncommon", subtype: "spellcaster" },
            { id: 8, name: "Vampire Lord", type: "character", emoji: "üßõ", health: 120, attack: 20, ability: "Dominate", level: 1, rarity: "legendary", subtype: "vampire" },
            { id: 9, name: "Headless Horseman", type: "character", emoji: "üëª", health: 85, attack: 14, ability: "Charge", level: 1, rarity: "epic", subtype: "spirit" },
            { id: 10, name: "Swamp Creature", type: "character", emoji: "üëπ", health: 75, attack: 9, ability: "Regenerate", level: 1, rarity: "uncommon", subtype: "monster" },
            { id: 11, name: "Phantom", type: "character", emoji: "üëª", health: 45, attack: 7, ability: "Phase", level: 1, rarity: "common", subtype: "spirit" },
            { id: 12, name: "Gorgon", type: "character", emoji: "üêç", health: 65, attack: 11, ability: "Petrify", level: 1, rarity: "rare", subtype: "monster" },
            { id: 13, name: "Revenant", type: "character", emoji: "üíÄ", health: 95, attack: 13, ability: "Vengeance", level: 1, rarity: "epic", subtype: "undead" },
            { id: 14, name: "Banshee", type: "character", emoji: "üëª", health: 55, attack: 9, ability: "Scream", level: 1, rarity: "uncommon", subtype: "spirit" },
            { id: 15, name: "Chupacabra", type: "character", emoji: "üê∫", health: 60, attack: 12, ability: "Blood Drain", level: 1, rarity: "rare", subtype: "monster" },
            { id: 16, name: "Cursed Knight", type: "character", emoji: "‚öîÔ∏è", health: 110, attack: 18, ability: "Undying", level: 1, rarity: "legendary", subtype: "undead" },
            { id: 17, name: "Siren", type: "character", emoji: "üßú", health: 70, attack: 10, ability: "Lure", level: 1, rarity: "rare", subtype: "monster" },
            { id: 18, name: "Doppelganger", type: "character", emoji: "üë§", health: 65, attack: 8, ability: "Mimic", level: 1, rarity: "epic", subtype: "spirit" },
            { id: 19, name: "Wendigo", type: "character", emoji: "üëπ", health: 90, attack: 16, ability: "Cannibalize", level: 1, rarity: "legendary", subtype: "monster" },
            { id: 20, name: "Poltergeist", type: "character", emoji: "üëª", health: 50, attack: 6, ability: "Telekinesis", level: 1, rarity: "uncommon", subtype: "spirit" }
        ];

        const itemCards = [
            { id: 101, name: "Silver Sword", type: "weapon", emoji: "‚öîÔ∏è", attack: 10, ability: "+5 vs Werewolves", level: 1, rarity: "rare" },
            { id: 102, name: "Wooden Stake", type: "weapon", emoji: "ü™µ", attack: 5, ability: "Instant kill vs Vampires", level: 1, rarity: "common" },
            { id: 103, name: "Leather Armor", type: "armor", emoji: "üß•", defense: 5, ability: "None", level: 1, rarity: "common" },
            { id: 104, name: "Holy Water", type: "spell", emoji: "üíß", effect: "Damage undead", ability: "10 damage to all undead", level: 1, rarity: "uncommon" },
            { id: 105, name: "Transformation", type: "ability", emoji: "‚ú®", effect: "Become Werewolf", ability: "+10 attack for 3 turns", level: 1, rarity: "epic", energyCost: 2 },
            { id: 106, name: "Silver Armor", type: "armor", emoji: "üõ°Ô∏è", defense: 8, ability: "Resist curses", level: 1, rarity: "rare" },
            { id: 107, name: "Ancient Tome", type: "spell", emoji: "üìú", effect: "Random spell", ability: "Cast a random powerful spell", level: 1, rarity: "epic", energyCost: 3 },
            { id: 108, name: "Cursed Dagger", type: "weapon", emoji: "üó°Ô∏è", attack: 12, ability: "Lifesteal", level: 1, rarity: "rare" },
            { id: 109, name: "Ghostly Cloak", type: "armor", emoji: "üëï", defense: 6, ability: "Dodge chance", level: 1, rarity: "uncommon" },
            { id: 110, name: "Witch's Brew", type: "spell", emoji: "üß™", effect: "Random effect", ability: "Random positive or negative effect", level: 1, rarity: "rare", energyCost: 1 },
            { id: 111, name: "Demon Blade", type: "weapon", emoji: "üî™", attack: 15, ability: "Bleed", level: 1, rarity: "epic" },
            { id: 112, name: "Plate Armor", type: "armor", emoji: "üõ°Ô∏è", defense: 10, ability: "Slow", level: 1, rarity: "rare" },
            { id: 113, name: "Necronomicon", type: "spell", emoji: "üìñ", effect: "Summon Undead", ability: "Summon a random undead ally", level: 1, rarity: "legendary", energyCost: 4 },
            { id: 114, name: "Vampiric Ring", type: "ability", emoji: "üíç", effect: "Lifesteal", ability: "Heal for 50% of damage dealt", level: 1, rarity: "epic", energyCost: 2 },
            { id: 115, name: "Moonstone", type: "ability", emoji: "üåï", effect: "Werewolf Form", ability: "Transform into a werewolf", level: 1, rarity: "legendary", energyCost: 3 },
            { id: 116, name: "Iron Cross", type: "spell", emoji: "‚úùÔ∏è", effect: "Banish Undead", ability: "Deal 20 damage to undead", level: 1, rarity: "uncommon", energyCost: 1 },
            { id: 117, name: "Crystal Ball", type: "spell", emoji: "üîÆ", effect: "Foresight", ability: "See enemy's next move", level: 1, rarity: "rare", energyCost: 1 },
            { id: 118, name: "Bone Shield", type: "armor", emoji: "ü¶¥", defense: 7, ability: "Undead resistance", level: 1, rarity: "uncommon" },
            { id: 119, name: "Spectral Blade", type: "weapon", emoji: "‚öîÔ∏è", attack: 13, ability: "Ignores armor", level: 1, rarity: "epic" },
            { id: 120, name: "Phoenix Feather", type: "ability", emoji: "ü™∂", effect: "Revive", ability: "Revive with 50% HP once", level: 1, rarity: "legendary", energyCost: 5 }
        ];

        // Enemy Database - Expanded with more enemies
        const enemies = {
            easy: [
                { id: 1, name: "Zombie", emoji: "üßü", health: 50, attack: 5, reward: 50, subtype: "undead" },
                { id: 2, name: "Skeleton", emoji: "üíÄ", health: 40, attack: 7, reward: 60, subtype: "undead" },
                { id: 3, name: "Ghoul", emoji: "üßü", health: 60, attack: 6, reward: 70, subtype: "undead" },
                { id: 4, name: "Possessed Doll", emoji: "üë∂", health: 45, attack: 8, reward: 65, subtype: "spirit" },
                { id: 5, name: "Giant Rat", emoji: "üêÄ", health: 55, attack: 5, reward: 55, subtype: "monster" }
            ],
            medium: [
                { id: 6, name: "Vampire Spawn", emoji: "üßõ", health: 70, attack: 8, reward: 100, subtype: "vampire" },
                { id: 7, name: "Werewolf", emoji: "üê∫", health: 80, attack: 10, reward: 120, subtype: "werewolf" },
                { id: 8, name: "Wraith", emoji: "üëª", health: 60, attack: 12, reward: 110, subtype: "spirit" },
                { id: 9, name: "Hag", emoji: "üßô", health: 65, attack: 11, reward: 115, subtype: "spellcaster" },
                { id: 10, name: "Living Armor", emoji: "üõ°Ô∏è", health: 90, attack: 9, reward: 125, subtype: "construct" }
            ],
            hard: [
                { id: 11, name: "Necromancer", emoji: "üßô", health: 90, attack: 15, reward: 150, subtype: "spellcaster" },
                { id: 12, name: "Abomination", emoji: "üëπ", health: 120, attack: 12, reward: 180, subtype: "construct" },
                { id: 13, name: "Vampire Lord", emoji: "üßõ", health: 150, attack: 18, reward: 250, subtype: "vampire" },
                { id: 14, name: "Death Knight", emoji: "‚öîÔ∏è", health: 130, attack: 20, reward: 230, subtype: "undead" },
                { id: 15, name: "Shadow Beast", emoji: "üê∫", health: 110, attack: 16, reward: 200, subtype: "monster" }
            ],
            boss: [
                { id: 16, name: "Dracula", emoji: "üßõ", health: 200, attack: 25, reward: 500, subtype: "vampire" },
                { id: 17, name: "The Lich King", emoji: "üíÄ", health: 250, attack: 22, reward: 600, subtype: "undead" },
                { id: 18, name: "Cthulhu", emoji: "üêô", health: 300, attack: 30, reward: 800, subtype: "eldritch" }
            ]
        };

        // NEW: Daily Rewards
        const dailyRewards = [
            { day: 1, gold: 100, essence: 10 },
            { day: 2, gold: 150, essence: 15, card: "common" },
            { day: 3, gold: 200, essence: 20, card: "uncommon" },
            { day: 4, gold: 250, essence: 25, card: "uncommon" },
            { day: 5, gold: 300, essence: 30, card: "rare" },
            { day: 6, gold: 400, essence: 40, card: "rare" },
            { day: 7, gold: 500, essence: 50, card: "epic" }
        ];

        // Modal Dialog System
        function showModal(title, message, buttons = [{text: "OK", action: null}]) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            
            const content = document.createElement('div');
            content.className = 'modal-content';
            
            const titleElement = document.createElement('h2');
            titleElement.className = 'modal-title';
            titleElement.textContent = title;
            content.appendChild(titleElement);
            
            const messageElement = document.createElement('div');
            messageElement.className = 'modal-message';
            messageElement.textContent = message;
            content.appendChild(messageElement);
            
            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'modal-buttons';
            
            buttons.forEach(button => {
                const btn = document.createElement('button');
                btn.className = 'modal-btn';
                btn.textContent = button.text;
                btn.onclick = function() {
                    document.body.removeChild(modal);
                    if (button.action) button.action();
                };
                buttonsContainer.appendChild(btn);
            });
            
            content.appendChild(buttonsContainer);
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // Initialize game
        function initGame() {
            // Load saved game
            loadGame();
            
            // Start with some basic cards
            if (gameState.collection.length === 0) {
                addToCollection(getCardById(5)); // Zombie
                addToCollection(getCardById(6)); // Ghost
                addToCollection(getCardById(102)); // Wooden Stake
                addToCollection(getCardById(103)); // Leather Armor
                
                // Add to player deck
                addToDeck(getCardById(5));
                addToDeck(getCardById(6));
                addToDeck(getCardById(102));
                addToDeck(getCardById(103));
            }
            
            // Initialize daily rewards
            initDailyRewards();
            
            updateUI();
            updateQuestUI();
            updateDailyRewardsUI();
            
            // Auto-save every 30 seconds
            setInterval(saveGame, 30000);
        }

        // NEW: Save/Load System
        function saveGame() {
            const saveData = {
                version: '1.1',
                timestamp: Date.now(),
                gameState: gameState
            };
            
            try {
                localStorage.setItem('horrorCardGameSave', JSON.stringify(saveData));
                if (gameState.settings.notifications) {
                    showModal("Game Saved", "Your progress has been saved automatically.");
                }
            } catch (e) {
                console.error('Save failed:', e);
            }
        }

        function loadGame() {
            try {
                const saveData = JSON.parse(localStorage.getItem('horrorCardGameSave'));
                if (saveData && saveData.version === '1.1') {
                    Object.assign(gameState, saveData.gameState);
                    console.log('Game loaded successfully');
                }
            } catch (e) {
                console.error('Load failed:', e);
            }
        }

        function resetGame() {
            if (confirm("Are you sure you want to reset the game? All progress will be lost!")) {
                localStorage.removeItem('horrorCardGameSave');
                location.reload();
            }
        }

        // NEW: Daily Rewards System
        function initDailyRewards() {
            const today = new Date().toDateString();
            
            if (gameState.dailyRewards.lastClaimDate !== today) {
                // Check if streak continues (claimed yesterday)
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();
                
                if (gameState.dailyRewards.lastClaimDate === yesterdayStr) {
                    // Continue streak
                    gameState.dailyRewards.streak++;
                } else if (gameState.dailyRewards.lastClaimDate !== today) {
                    // Reset streak if not claimed yesterday
                    gameState.dailyRewards.streak = 1;
                }
                
                // Mark today as available
                gameState.dailyRewards.claimedDays = gameState.dailyRewards.claimedDays.filter(day => day < gameState.dailyRewards.streak);
            }
        }

        function updateDailyRewardsUI() {
            const container = document.getElementById('daily-rewards-container');
            container.innerHTML = '';
            
            document.getElementById('login-streak').textContent = gameState.dailyRewards.streak;
            
            dailyRewards.forEach((reward, index) => {
                const day = index + 1;
                const rewardElement = document.createElement('div');
                rewardElement.className = 'daily-reward';
                
                if (day <= gameState.dailyRewards.streak) {
                    if (gameState.dailyRewards.claimedDays.includes(day)) {
                        rewardElement.classList.add('claimed');
                    } else if (day === gameState.dailyRewards.streak) {
                        rewardElement.classList.add('available');
                    } else {
                        rewardElement.classList.add('locked');
                    }
                } else {
                    rewardElement.classList.add('locked');
                }
                
                const dayElement = document.createElement('div');
                dayElement.className = 'daily-reward-day';
                dayElement.textContent = day;
                rewardElement.appendChild(dayElement);
                
                const emojiElement = document.createElement('div');
                emojiElement.style.fontSize = '1.5rem';
                emojiElement.textContent = 'üéÅ';
                rewardElement.appendChild(emojiElement);
                
                const rewardText = document.createElement('div');
                rewardText.style.fontSize = '0.8rem';
                rewardText.style.marginTop = '5px';
                
                let text = `${reward.gold}ü™ô`;
                if (reward.essence) text += ` +${reward.essence}‚≠ê`;
                if (reward.card) text += ` +${reward.card} card`;
                
                rewardText.textContent = text;
                rewardElement.appendChild(rewardText);
                
                container.appendChild(rewardElement);
            });
            
            // Update claim button
            const claimBtn = document.getElementById('daily-reward-btn');
            const today = new Date().toDateString();
            
            if (gameState.dailyRewards.lastClaimDate === today) {
                claimBtn.disabled = true;
                claimBtn.textContent = "ALREADY CLAIMED TODAY";
            } else {
                claimBtn.disabled = false;
                claimBtn.textContent = "CLAIM TODAY'S REWARD";
            }
        }

        function claimDailyReward() {
            const today = new Date().toDateString();
            
            if (gameState.dailyRewards.lastClaimDate === today) {
                showModal("Already Claimed", "You've already claimed your daily reward today. Come back tomorrow!");
                return;
            }
            
            const reward = dailyRewards[gameState.dailyRewards.streak - 1];
            if (!reward) return;
            
            // Give rewards
            gameState.gold += reward.gold;
            gameState.essence += reward.essence || 0;
            
            if (reward.card) {
                addToCollection(getRandomCard(reward.card));
            }
            
            // Update state
            gameState.dailyRewards.lastClaimDate = today;
            gameState.dailyRewards.claimedDays.push(gameState.dailyRewards.streak);
            
            updateUI();
            updateDailyRewardsUI();
            
            let message = `Daily reward claimed! Received ${reward.gold} gold`;
            if (reward.essence) message += ` and ${reward.essence} essence`;
            if (reward.card) message += ` and a ${reward.card} card`;
            message += `. Streak: ${gameState.dailyRewards.streak} days.`;
            
            showModal("Daily Reward", message);
        }

        // NEW: Card Synergy System
        function updateCardSynergies() {
            gameState.activeSynergies = [];
            
            // Check each synergy
            for (const [key, synergy] of Object.entries(cardSynergies)) {
                const hasAllCards = synergy.cards.every(cardId => 
                    gameState.collection.some(card => card.id === cardId) ||
                    gameState.playerDeck.some(card => card.id === cardId)
                );
                
                if (hasAllCards) {
                    gameState.activeSynergies.push(synergy);
                }
            }
            
            // Update UI
            const synergyDisplay = document.getElementById('synergy-display');
            const activeSynergies = document.getElementById('active-synergies');
            
            if (gameState.activeSynergies.length > 0) {
                synergyDisplay.style.display = 'block';
                activeSynergies.innerHTML = '';
                
                gameState.activeSynergies.forEach(synergy => {
                    const synergyElement = document.createElement('div');
                    synergyElement.innerHTML = `<strong>${synergy.name}:</strong> ${synergy.description}`;
                    activeSynergies.appendChild(synergyElement);
                });
            } else {
                synergyDisplay.style.display = 'none';
            }
        }

        // NEW: Settings System
        function toggleSetting(setting) {
            gameState.settings[setting] = !gameState.settings[setting];
            
            const toggle = document.getElementById(`${setting}-toggle`);
            if (gameState.settings[setting]) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            
            saveGame();
        }

        // NEW: Debug System
        function toggleDebugPanel() {
            const debugPanel = document.getElementById('debug-panel');
            debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
        }

        function addGold(amount) {
            gameState.gold += amount;
            updateUI();
            showModal("Debug", `Added ${amount} gold!`);
        }

        function addGems(amount) {
            gameState.gems += amount;
            updateUI();
            showModal("Debug", `Added ${amount} gems!`);
        }

        function unlockAllCards() {
            characterCards.forEach(card => addToCollection({...card}));
            itemCards.forEach(card => addToCollection({...card}));
            updateCollectionUI();
            showModal("Debug", "All cards unlocked!");
        }

        // NEW: Story System
        function advanceStory(choice) {
            gameState.story.progress++;
            
            const storyText = document.getElementById('story-text');
            const storyChapter = document.getElementById('story-chapter');
            
            if (gameState.story.progress === 1) {
                storyText.textContent = "You venture into the dark forest, the moonlight barely piercing through the thick canopy. Strange noises echo around you. What do you do?";
            } else if (gameState.story.progress === 2) {
                storyText.textContent = "You discover an ancient crypt covered in moss and vines. The air grows cold as you approach. Do you enter?";
            } else if (gameState.story.progress === 3) {
                storyText.textContent = "Inside the crypt, you find a chamber filled with ancient artifacts. A shadowy figure emerges from the darkness!";
                // Reward player for story progress
                gameState.gold += 200;
                addToCollection(getRandomCard("rare"));
                updateUI();
                showModal("Story Progress", "You've discovered ancient artifacts! Received 200 gold and a rare card.");
            }
            
            storyChapter.textContent = gameState.story.chapter;
        }

        // NEW: Crafting System
        function changeCraftingTab(tab) {
            document.querySelectorAll('.crafting-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.crafting-tab[onclick="changeCraftingTab('${tab}')"]`).classList.add('active');
            
            const craftingItems = document.getElementById('crafting-items');
            craftingItems.innerHTML = '';
            
            if (tab === 'disenchant') {
                // Show cards that can be disenchanted
                gameState.collection.forEach(card => {
                    if (card.count > 1) { // Only show duplicates
                        const cardElement = createCardElement(card);
                        const disenchantBtn = document.createElement('button');
                        disenchantBtn.textContent = 'Disenchant';
                        disenchantBtn.className = 'combat-btn';
                        disenchantBtn.style.width = '100%';
                        disenchantBtn.onclick = function(e) {
                            e.stopPropagation();
                            disenchantCard(card);
                        };
                        
                        const essenceValue = {
                            common: 5,
                            uncommon: 20,
                            rare: 100,
                            epic: 400,
                            legendary: 1600
                        };
                        
                        const costElement = document.createElement('div');
                        costElement.className = 'crafting-cost';
                        costElement.textContent = `Value: ${essenceValue[card.rarity]}‚≠ê`;
                        
                        cardElement.appendChild(costElement);
                        cardElement.appendChild(disenchantBtn);
                        craftingItems.appendChild(cardElement);
                    }
                });
            } else if (tab === 'craft') {
                // Show cards that can be crafted
                const craftableCards = [...characterCards, ...itemCards].filter(card => 
                    !gameState.collection.some(c => c.id === card.id)
                );
                
                craftableCards.forEach(card => {
                    const cardElement = createCardElement(card);
                    const craftBtn = document.createElement('button');
                    craftBtn.textContent = 'Craft';
                    craftBtn.className = 'combat-btn';
                    craftBtn.style.width = '100%';
                    
                    const essenceCost = {
                        common: 50,
                        uncommon: 200,
                        rare: 800,
                        epic: 1600,
                        legendary: 3200
                    };
                    
                    const cost = essenceCost[card.rarity];
                    
                    craftBtn.onclick = function(e) {
                        e.stopPropagation();
                        craftCard(card, cost);
                    };
                    
                    const costElement = document.createElement('div');
                    costElement.className = 'crafting-cost';
                    costElement.textContent = `Cost: ${cost}‚≠ê`;
                    
                    cardElement.appendChild(costElement);
                    cardElement.appendChild(craftBtn);
                    craftingItems.appendChild(cardElement);
                });
            }
        }

        function disenchantCard(card) {
            const essenceValue = {
                common: 5,
                uncommon: 20,
                rare: 100,
                epic: 400,
                legendary: 1600
            };
            
            const value = essenceValue[card.rarity];
            
            // Remove one copy of the card
            const cardIndex = gameState.collection.findIndex(c => c.id === card.id && c.level === card.level);
            if (cardIndex >= 0) {
                gameState.collection[cardIndex].count--;
                if (gameState.collection[cardIndex].count <= 0) {
                    gameState.collection.splice(cardIndex, 1);
                }
                
                // Add essence
                gameState.essence += value;
                
                updateUI();
                changeCraftingTab('disenchant');
                showModal("Disenchant", `Disenchanted ${card.name} for ${value} essence!`);
            }
        }

        function craftCard(card, cost) {
            if (gameState.essence >= cost) {
                gameState.essence -= cost;
                addToCollection({...card});
                updateUI();
                changeCraftingTab('craft');
                showModal("Crafting", `Crafted ${card.name}!`);
            } else {
                showModal("Not Enough Essence", `You need ${cost} essence to craft this card. You have ${gameState.essence} essence.`);
            }
        }

        // NEW: Experience and Level System
        function gainExperience(amount) {
            gameState.experience += amount;
            
            if (gameState.experience >= gameState.experienceToNextLevel) {
                // Level up
                gameState.playerLevel++;
                gameState.experience -= gameState.experienceToNextLevel;
                gameState.experienceToNextLevel = Math.floor(gameState.experienceToNextLevel * 1.5);
                
                // Level up rewards
                gameState.maxHealth += 10;
                gameState.health = gameState.maxHealth;
                gameState.gold += gameState.playerLevel * 100;
                
                showModal("Level Up!", `You reached level ${gameState.playerLevel}! +10 Max HP and ${gameState.playerLevel * 100} gold!`);
                
                // Unlock new content at certain levels
                if (gameState.playerLevel >= 5) {
                    document.getElementById('boss-dungeon').style.display = 'block';
                }
            }
            
            updateUI();
        }

        // NEW: Enhanced Card Animations
        function createDamagePopup(value, x, y, isPlayer = false) {
            if (!gameState.settings.animations) return;
            
            const popup = document.createElement('div');
            popup.className = 'damage-popup';
            popup.textContent = value;
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            popup.style.color = isPlayer ? '#ff4444' : '#44ff44';
            
            document.getElementById('game-container').appendChild(popup);
            
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.parentNode.removeChild(popup);
                }
            }, 1000);
        }

        // Helper functions
        function getCardById(id) {
            const card = [...characterCards, ...itemCards].find(c => c.id === id);
            return card ? {...card} : null;
        }

        function getRandomCard(rarityFilter = null) {
            let pool = [...characterCards, ...itemCards];
            if (rarityFilter) {
                pool = pool.filter(card => card.rarity === rarityFilter);
            }
            return {...pool[Math.floor(Math.random() * pool.length)]};
        }

        function getRandomEnemy(difficulty) {
            const pool = enemies[difficulty] || enemies.easy;
            return {...pool[Math.floor(Math.random() * pool.length)]};
        }

        // Collection management
        function addToCollection(card) {
            if (!card) return;
            
            // Check if player already has this card
            const existingCardIndex = gameState.collection.findIndex(c => c.id === card.id && c.level === card.level);
            
            if (existingCardIndex >= 0) {
                gameState.collection[existingCardIndex].count = (gameState.collection[existingCardIndex].count || 1) + 1;
            } else {
                // NEW: Add card with animation
                const newCard = {...card, count: 1};
                gameState.collection.push(newCard);
                gameState.uniqueCardsCollected++;
                
                // Check if this is a vampire card for quest
                if (card.subtype === "vampire") {
                    gameState.quests.collectVampires.progress++;
                    updateQuestUI();
                }
            }
            
            // Check for card collector achievement
            if (gameState.uniqueCardsCollected >= 10 && !gameState.achievements.cardCollector) {
                document.getElementById('achieve-2-btn').disabled = false;
            }
            
            // NEW: Update synergies
            updateCardSynergies();
            
            updateCollectionUI();
        }

        function addToDeck(card) {
            if (gameState.playerDeck.length >= 8) {
                showModal("Deck Full", "Deck is full! Maximum 8 cards.");
                return;
            }
            
            gameState.playerDeck.push({...card});
            updateDeckUI();
            
            // NEW: Update synergies
            updateCardSynergies();
        }

        function addToInventory(item) {
            const category = item.type === 'weapon' || item.type === 'armor' ? 'equipment' : 
                            item.type === 'consumable' ? 'consumables' : 'materials';
            
            const existingItem = gameState.inventory[category].find(i => i.id === item.id);
            if (existingItem) {
                existingItem.count++;
            } else {
                gameState.inventory[category].push({...item, count: 1});
            }
            
            updateInventoryUI();
        }

        // UI Functions
        function returnToMainMenu() {
            if (gameState.inDungeon) {
                showModal("Abandon Dungeon?", "Abandon the dungeon? You'll lose your progress.", [
                    {text: "Cancel", action: null},
                    {text: "Abandon", action: function() {
                        gameState.inDungeon = false;
                        gameState.currentDungeon = null;
                        document.querySelectorAll('.game-screen').forEach(screen => {
                            screen.style.display = 'none';
                        });
                        document.getElementById('main-menu').style.display = 'flex';
                    }}
                ]);
            } else {
                document.querySelectorAll('.game-screen').forEach(screen => {
                    screen.style.display = 'none';
                });
                document.getElementById('main-menu').style.display = 'flex';
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.game-screen').forEach(screen => {
                screen.style.display = 'none';
            });
            
            document.getElementById(screenId).style.display = 'flex';
            document.getElementById('main-menu').style.display = 'none';
            
            // Update specific screens when shown
            if (screenId === 'collection-screen') {
                updateCollectionUI();
            } else if (screenId === 'combat-screen') {
                if (!gameState.inDungeon) {
                    startCombat();
                } else {
                    startDungeonCombat();
                }
            } else if (screenId === 'shop-screen') {
                updateShopUI('character');
            } else if (screenId === 'fuse-screen') {
                updateFuseUI();
            } else if (screenId === 'inventory-screen') {
                updateInventoryUI('equipment');
            } else if (screenId === 'dungeon-screen') {
                updateDungeonUI();
            } else if (screenId === 'daily-rewards-screen') {
                updateDailyRewardsUI();
            } else if (screenId === 'crafting-screen') {
                changeCraftingTab('disenchant');
            }
            
            updateUI();
        }

        function updateUI() {
            // Update resource displays
            document.getElementById('gold-display').textContent = gameState.gold;
            document.getElementById('gems-display').textContent = gameState.gems;
            document.getElementById('essence-display').textContent = gameState.essence;
            document.getElementById('shop-gold').textContent = gameState.gold;
            document.getElementById('shop-gems').textContent = gameState.gems;
            document.getElementById('fuse-gold').textContent = gameState.gold;
            document.getElementById('inventory-gold').textContent = gameState.gold;
            document.getElementById('dungeon-gold').textContent = gameState.gold;
            document.getElementById('crafting-essence').textContent = gameState.essence;
            document.getElementById('player-health').textContent = `${gameState.health}/${gameState.maxHealth}`;
            document.getElementById('player-energy').textContent = `${gameState.energy}/${gameState.maxEnergy}`;
            document.getElementById('current-floor').textContent = gameState.dungeonLevel;
            
            // NEW: Update player level and experience
            const expPercent = (gameState.experience / gameState.experienceToNextLevel) * 100;
            document.documentElement.style.setProperty('--exp-percent', `${expPercent}%`);
        }

        function updateQuestUI() {
            // Update quest progress displays
            document.getElementById('quest-1-progress').textContent = gameState.quests.defeatEnemies.progress;
            document.getElementById('quest-2-progress').textContent = gameState.quests.collectVampires.progress;
            document.getElementById('quest-3-progress').textContent = gameState.quests.fuseCards.progress;
            document.getElementById('quest-4-progress').textContent = gameState.quests.completeDungeon.progress;
            
            // Enable claim buttons for completed quests
            if (gameState.quests.defeatEnemies.progress >= 5 && !gameState.quests.defeatEnemies.completed) {
                document.getElementById('quest-1-btn').disabled = false;
            }
            if (gameState.quests.collectVampires.progress >= 3 && !gameState.quests.collectVampires.completed) {
                document.getElementById('quest-2-btn').disabled = false;
            }
            if (gameState.quests.fuseCards.progress >= 2 && !gameState.quests.fuseCards.completed) {
                document.getElementById('quest-3-btn').disabled = false;
            }
            if (gameState.quests.completeDungeon.progress >= 1 && !gameState.quests.completeDungeon.completed) {
                document.getElementById('quest-4-btn').disabled = false;
            }
        }

        function updateDungeonUI() {
            // Show/hide boss dungeon based on progress
            if (gameState.dungeonLevel >= 5) {
                document.getElementById('boss-dungeon').style.display = 'block';
            } else {
                document.getElementById('boss-dungeon').style.display = 'none';
            }
        }

        function updateCollectionUI() {
            const grid = document.getElementById('collection-grid');
            grid.innerHTML = '';
            
            gameState.collection.forEach(card => {
                const cardElement = createCardElement(card);
                
                // NEW: Add synergy indicator if card is part of an active synergy
                const isPartOfSynergy = gameState.activeSynergies.some(synergy => 
                    synergy.cards.includes(card.id)
                );
                
                if (isPartOfSynergy) {
                    const synergyIndicator = document.createElement('div');
                    synergyIndicator.className = 'synergy-indicator';
                    synergyIndicator.textContent = 'S';
                    cardElement.appendChild(synergyIndicator);
                }
                
                cardElement.onclick = function() {
                    showModal("Add to Deck", `Add ${card.name} to your deck?`, [
                        {text: "Cancel", action: null},
                        {text: "Add", action: function() {
                            addToDeck(card);
                        }}
                    ]);
                };
                grid.appendChild(cardElement);
            });
        }

        function updateDeckUI() {
            const grid = document.getElementById('combat-deck');
            grid.innerHTML = '';
            
            gameState.playerDeck.forEach((card, index) => {
                const cardElement = createCardElement(card);
                cardElement.onclick = function() {
                    showModal("Remove from Deck", `Remove ${card.name} from your deck?`, [
                        {text: "Cancel", action: null},
                        {text: "Remove", action: function() {
                            gameState.playerDeck.splice(index, 1);
                            updateDeckUI();
                        }}
                    ]);
                };
                grid.appendChild(cardElement);
            });
        }

        function updateShopUI(tab) {
            const shopItems = document.getElementById('shop-items');
            shopItems.innerHTML = '';
            
            // Update active tab
            document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.shop-tab[onclick="changeShopTab('${tab}')"]`).classList.add('active');
            
            if (tab === 'character') {
                // Show character cards for sale
                characterCards.forEach(card => {
                    const price = card.rarity === 'common' ? 100 : 
                                  card.rarity === 'uncommon' ? 250 : 
                                  card.rarity === 'rare' ? 500 : 
                                  card.rarity === 'epic' ? 1000 : 2000;
                    
                    const cardElement = createCardElement(card);
                    const buyBtn = document.createElement('button');
                    buyBtn.textContent = `Buy (${price}ü™ô)`;
                    buyBtn.className = 'combat-btn';
                    buyBtn.style.width = '100%';
                    buyBtn.onclick = function(e) {
                        e.stopPropagation();
                        if (gameState.gold >= price) {
                            gameState.gold -= price;
                            addToCollection(getCardById(card.id));
                            updateUI();
                            showModal("Purchase Complete", `Purchased ${card.name}!`);
                        } else {
                            showModal("Not Enough Gold", "You don't have enough gold for this purchase.");
                        }
                    };
                    
                    cardElement.appendChild(buyBtn);
                    shopItems.appendChild(cardElement);
                });
            } else if (tab === 'item') {
                // Show item cards for sale
                itemCards.forEach(card => {
                    const price = card.rarity === 'common' ? 100 : 
                                  card.rarity === 'uncommon' ? 250 : 
                                  card.rarity === 'rare' ? 500 : 1000;
                    
                    const cardElement = createCardElement(card);
                    const buyBtn = document.createElement('button');
                    buyBtn.textContent = `Buy (${price}ü™ô)`;
                    buyBtn.className = 'combat-btn';
                    buyBtn.style.width = '100%';
                    buyBtn.onclick = function(e) {
                        e.stopPropagation();
                        if (gameState.gold >= price) {
                            gameState.gold -= price;
                            addToCollection(getCardById(card.id));
                            updateUI();
                            showModal("Purchase Complete", `Purchased ${card.name}!`);
                        } else {
                            showModal("Not Enough Gold", "You don't have enough gold for this purchase.");
                        }
                    };
                    
                    cardElement.appendChild(buyBtn);
                    shopItems.appendChild(cardElement);
                });
            } else if (tab === 'pack') {
                // Show card packs for sale
                const packs = [
                    { name: "Starter Pack", price: 200, cards: 3, rarity: "common" },
                    { name: "Advanced Pack", price: 500, cards: 5, rarity: "uncommon" },
                    { name: "Premium Pack", price: 1000, cards: 5, rarity: "rare" },
                    { name: "Legendary Pack", price: 2000, cards: 3, rarity: "epic" },
                    { name: "Mystery Pack", price: 300, cards: 1, rarity: "random" }
                ];
                
                packs.forEach(pack => {
                    const packElement = document.createElement('div');
                    packElement.className = 'card';
                    packElement.style.display = 'flex';
                    packElement.style.flexDirection = 'column';
                    packElement.style.alignItems = 'center';
                    packElement.style.justifyContent = 'center';
                    packElement.style.padding = '10px';
                    
                    const packName = document.createElement('h3');
                    packName.textContent = pack.name;
                    packElement.appendChild(packName);
                    
                    const packDesc = document.createElement('p');
                    packDesc.textContent = `${pack.cards} ${pack.rarity === "random" ? "random rarity" : pack.rarity} cards`;
                    packDesc.style.textAlign = 'center';
                    packElement.appendChild(packDesc);
                    
                    const buyBtn = document.createElement('button');
                    buyBtn.textContent = `Buy (${pack.price}ü™ô)`;
                    buyBtn.className = 'combat-btn';
                    buyBtn.style.width = '100%';
                    buyBtn.onclick = function() {
                        if (gameState.gold >= pack.price) {
                            gameState.gold -= pack.price;
                            for (let i = 0; i < pack.cards; i++) {
                                if (pack.rarity === "random") {
                                    const rarities = ["common", "uncommon", "rare", "epic", "legendary"];
                                    const weights = [0.5, 0.3, 0.15, 0.04, 0.01];
                                    let random = Math.random();
                                    let selectedRarity = "common";
                                    
                                    for (let j = 0; j < rarities.length; j++) {
                                        if (random < weights[j]) {
                                            selectedRarity = rarities[j];
                                            break;
                                        }
                                        random -= weights[j];
                                    }
                                    
                                    addToCollection(getRandomCard(selectedRarity));
                                } else {
                                    addToCollection(getRandomCard(pack.rarity));
                                }
                            }
                            updateUI();
                            showModal("Pack Opened", `Opened ${pack.name}! Check your collection.`);
                        } else {
                            showModal("Not Enough Gold", "You don't have enough gold for this purchase.");
                        }
                    };
                    
                    packElement.appendChild(buyBtn);
                    shopItems.appendChild(packElement);
                });
            } else if (tab === 'upgrade') {
                // Show upgrades for sale
                const upgrades = [
                    { name: "Health Upgrade", price: 500, effect: "+20 Max HP", emoji: "‚ù§Ô∏è", type: "upgrade" },
                    { name: "Energy Upgrade", price: 800, effect: "+1 Max Energy", emoji: "‚ö°", type: "upgrade" },
                    { name: "Upgrade Stone", price: 300, effect: "Upgrade a card", emoji: "üíé", type: "material" },
                    { name: "Fusion Catalyst", price: 400, effect: "Improve fusions", emoji: "üß™", type: "material" },
                    { name: "Deck Expansion", price: 1000, effect: "+1 Deck Slot", emoji: "üÉè", type: "upgrade" }
                ];
                
                upgrades.forEach(upgrade => {
                    const upgradeElement = document.createElement('div');
                    upgradeElement.className = 'card';
                    upgradeElement.style.display = 'flex';
                    upgradeElement.style.flexDirection = 'column';
                    upgradeElement.style.alignItems = 'center';
                    upgradeElement.style.justifyContent = 'center';
                    upgradeElement.style.padding = '10px';
                    
                    const upgradeName = document.createElement('h3');
                    upgradeName.textContent = upgrade.name;
                    upgradeElement.appendChild(upgradeName);
                    
                    const upgradeEmoji = document.createElement('div');
                    upgradeEmoji.textContent = upgrade.emoji;
                    upgradeEmoji.style.fontSize = '2rem';
                    upgradeElement.appendChild(upgradeEmoji);
                    
                    const upgradeDesc = document.createElement('p');
                    upgradeDesc.textContent = upgrade.effect;
                    upgradeDesc.style.textAlign = 'center';
                    upgradeElement.appendChild(upgradeDesc);
                    
                    const buyBtn = document.createElement('button');
                    buyBtn.textContent = `Buy (${upgrade.price}ü™ô)`;
                    buyBtn.className = 'combat-btn';
                    buyBtn.style.width = '100%';
                    buyBtn.onclick = function() {
                        if (gameState.gold >= upgrade.price) {
                            gameState.gold -= upgrade.price;
                            
                            if (upgrade.name === "Health Upgrade") {
                                gameState.maxHealth += 20;
                                gameState.health = gameState.maxHealth;
                                showModal("Upgrade Complete", "Max health increased by 20!");
                            } else if (upgrade.name === "Energy Upgrade") {
                                gameState.maxEnergy += 1;
                                showModal("Upgrade Complete", "Max energy increased by 1!");
                            } else if (upgrade.name === "Deck Expansion") {
                                showModal("Upgrade Complete", "You can now have 9 cards in your deck!");
                            } else {
                                addToInventory(upgrade);
                                showModal("Purchase Complete", `Purchased ${upgrade.name}! Check your inventory.`);
                            }
                            
                            updateUI();
                        } else {
                            showModal("Not Enough Gold", "You don't have enough gold for this purchase.");
                        }
                    };
                    
                    upgradeElement.appendChild(buyBtn);
                    shopItems.appendChild(upgradeElement);
                });
            }
        }

        function changeShopTab(tab) {
            updateShopUI(tab);
        }

        function updateInventoryUI(category = 'equipment') {
            const inventoryItems = document.getElementById('inventory-items');
            inventoryItems.innerHTML = '';
            
            // Update active tab
            document.querySelectorAll('.inventory-category').forEach(t => t.classList.remove('active'));
            document.querySelector(`.inventory-category[onclick="changeInventoryTab('${category}')"]`).classList.add('active');
            
            gameState.inventory[category].forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'card';
                itemElement.style.display = 'flex';
                itemElement.style.flexDirection = 'column';
                itemElement.style.alignItems = 'center';
                itemElement.style.justifyContent = 'center';
                itemElement.style.padding = '10px';
                
                const itemName = document.createElement('h3');
                itemName.textContent = `${item.name} x${item.count}`;
                itemElement.appendChild(itemName);
                
                const itemEmoji = document.createElement('div');
                itemEmoji.textContent = item.emoji;
                itemEmoji.style.fontSize = '2rem';
                itemElement.appendChild(itemEmoji);
                
                const itemDesc = document.createElement('p');
                itemDesc.textContent = item.effect;
                itemDesc.style.textAlign = 'center';
                itemElement.appendChild(itemDesc);
                
                const useBtn = document.createElement('button');
                useBtn.textContent = 'Use';
                useBtn.className = 'combat-btn';
                useBtn.style.width = '100%';
                useBtn.onclick = function() {
                    useInventoryItem(item, category);
                };
                
                itemElement.appendChild(useBtn);
                inventoryItems.appendChild(itemElement);
            });
        }

        function changeInventoryTab(category) {
            updateInventoryUI(category);
        }

        function useInventoryItem(item, category) {
            if (item.type === 'consumable') {
                if (item.id === 201) { // Health Potion
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + 30);
                    showModal("Item Used", `Used Health Potion! Restored 30 HP.`);
                } else if (item.id === 202) { // Energy Potion
                    gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + 1);
                    showModal("Item Used", `Used Energy Potion! Restored 1 Energy.`);
                }
                
                // Remove item
                item.count--;
                if (item.count <= 0) {
                    const index = gameState.inventory[category].indexOf(item);
                    gameState.inventory[category].splice(index, 1);
                }
                
                updateInventoryUI(category);
                updateUI();
            } else if (item.type === 'material') {
                if (item.id === 301) { // Upgrade Stone
                    showModal("Select Card", "Select a card from your collection to upgrade.", [
                        {text: "Cancel", action: null},
                        {text: "Select", action: function() {
                            showScreen('collection-screen');
                            const grid = document.getElementById('collection-grid');
                            grid.innerHTML = '';
                            
                            gameState.collection.forEach(card => {
                                const cardElement = createCardElement(card);
                                cardElement.onclick = function() {
                                    upgradeCard(card);
                                };
                                grid.appendChild(cardElement);
                            });
                        }}
                    ]);
                } else if (item.id === 302) { // Fusion Catalyst
                    showModal("Fusion Catalyst", "Use this when fusing cards to guarantee better results.");
                }
            } else {
                showModal("Item Info", `This item can only be used in specific menus.`);
            }
        }

        function upgradeCard(card) {
            // Find the card in collection
            const cardIndex = gameState.collection.findIndex(c => c.id === card.id && c.level === card.level);
            if (cardIndex < 0) return;
            
            // Remove the upgrade stone
            const stoneIndex = gameState.inventory.materials.findIndex(i => i.id === 301);
            if (stoneIndex >= 0) {
                gameState.inventory.materials[stoneIndex].count--;
                if (gameState.inventory.materials[stoneIndex].count <= 0) {
                    gameState.inventory.materials.splice(stoneIndex, 1);
                }
            }
            
            // Create upgraded card
            const upgradedCard = {...card};
            upgradedCard.level = (card.level || 1) + 1;
            
            if (card.type === 'character') {
                upgradedCard.health = Math.round(card.health * 1.3);
                upgradedCard.attack = Math.round(card.attack * 1.3);
            } else if (card.type === 'weapon') {
                upgradedCard.attack = Math.round(card.attack * 1.5);
            } else if (card.type === 'armor') {
                upgradedCard.defense = Math.round(card.defense * 1.5);
            }
            
            // Remove old card and add upgraded one
            gameState.collection[cardIndex].count--;
            if (gameState.collection[cardIndex].count <= 0) {
                gameState.collection.splice(cardIndex, 1);
            }
            addToCollection(upgradedCard);
            
            // Update deck if this card is in it
            const deckIndex = gameState.playerDeck.findIndex(c => c.id === card.id && c.level === card.level);
            if (deckIndex >= 0) {
                gameState.playerDeck[deckIndex] = {...upgradedCard};
            }
            
            updateCollectionUI();
            updateDeckUI();
            updateInventoryUI('materials');
            showModal("Upgrade Complete", `${card.name} upgraded to level ${upgradedCard.level}!`);
        }

        function createCardElement(card) {
            const cardElement = document.createElement('div');
            cardElement.className = `card card-${card.type}`;
            
            // NEW: Add draw animation if enabled
            if (gameState.settings.animations) {
                cardElement.classList.add('card-draw-animation');
            }
            
            // Add rarity classes and effects
            if (card.rarity === 'rare') {
                cardElement.classList.add('card-rare');
            } else if (card.rarity === 'epic') {
                cardElement.classList.add('card-rare');
                cardElement.style.boxShadow = '0 0 15px rgba(170, 0, 170, 0.7)';
            } else if (card.rarity === 'legendary') {
                cardElement.classList.add('card-legendary');
            }
            
            const cardHeader = document.createElement('div');
            cardHeader.className = 'card-header';
            cardHeader.textContent = card.name;
            cardElement.appendChild(cardHeader);
            
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            cardBody.textContent = card.emoji;
            cardElement.appendChild(cardBody);
            
            const cardStats = document.createElement('div');
            cardStats.className = 'card-stats';
            
            if (card.type === 'character') {
                cardStats.innerHTML = `<span>‚ù§Ô∏è ${card.health}</span><span>‚öîÔ∏è ${card.attack}</span>`;
                if (card.ability) {
                    const abilitySpan = document.createElement('span');
                    abilitySpan.textContent = `‚ú® ${card.ability}`;
                    cardStats.appendChild(abilitySpan);
                }
            } else if (card.type === 'weapon') {
                cardStats.innerHTML = `<span>‚öîÔ∏è ${card.attack}</span><span>${card.ability}</span>`;
            } else if (card.type === 'armor') {
                cardStats.innerHTML = `<span>üõ°Ô∏è ${card.defense}</span><span>${card.ability}</span>`;
            } else {
                cardStats.textContent = card.ability;
            }
            
            cardElement.appendChild(cardStats);
            
            if (card.level > 1) {
                const cardLevel = document.createElement('div');
                cardLevel.className = 'card-level';
                cardLevel.textContent = card.level;
                cardElement.appendChild(cardLevel);
            }
            
            // Add rarity indicator
            const rarityIndicator = document.createElement('div');
            rarityIndicator.className = `rarity-indicator rarity-${card.rarity}`;
            cardElement.appendChild(rarityIndicator);
            
            return cardElement;
        }

        // Combat Functions
        let currentEnemy = null;
        let combatTurn = 0;

        // NEW: Enhanced combat system
        function startCombat() {
            currentEnemy = getRandomEnemy('easy');
            combatTurn = 0;
            gameState.energy = 0;
            gameState.combat.isPlayerTurn = true;
            
            // Reset stats
            gameState.combat.playerStats.currentAttack = gameState.combat.playerStats.baseAttack;
            gameState.combat.playerStats.currentDefense = gameState.combat.playerStats.baseDefense;
            gameState.combat.playerStats.currentSpeed = gameState.combat.playerStats.baseSpeed;
            
            gameState.combat.enemyStats.currentAttack = currentEnemy.attack;
            gameState.combat.enemyStats.currentDefense = 0;
            gameState.combat.enemyStats.currentSpeed = 5;
            
            // Clear status effects
            gameState.combat.statusEffects.player = [];
            gameState.combat.statusEffects.enemy = [];
            
            updateEnemyCard();
            updateCombatUI();
            
            const combatLog = document.getElementById('combat-log');
            combatLog.innerHTML = '';
            addCombatLogMessage(`A wild ${currentEnemy.name} appears!`);
            
            // Update turn indicator
            document.getElementById('turn-indicator').className = 'turn-indicator player-turn';
            document.getElementById('turn-indicator').textContent = 'YOUR TURN';
            
            updateUI();
        }

        function updateEnemyCard() {
            const enemyCard = document.getElementById('enemy-card');
            enemyCard.querySelector('.card-header').textContent = currentEnemy.name;
            enemyCard.querySelector('.card-body').textContent = currentEnemy.emoji;
            enemyCard.querySelector('.card-stats').innerHTML = `<span>‚ù§Ô∏è ${currentEnemy.health}</span><span>‚öîÔ∏è ${currentEnemy.attack}</span>`;
            
            // Update enemy stats display
            document.getElementById('enemy-attack').textContent = gameState.combat.enemyStats.currentAttack;
            document.getElementById('enemy-defense').textContent = gameState.combat.enemyStats.currentDefense;
            document.getElementById('enemy-speed').textContent = gameState.combat.enemyStats.currentSpeed;
        }

        function updateCombatUI() {
            // Update player stats display
            document.getElementById('player-attack').textContent = gameState.combat.playerStats.currentAttack;
            document.getElementById('player-defense').textContent = gameState.combat.playerStats.currentDefense;
            document.getElementById('player-speed').textContent = gameState.combat.playerStats.currentSpeed;
            
            // Update status effects
            updateStatusEffects();
        }

        function updateStatusEffects() {
            // Clear existing status indicators
            document.getElementById('enemy-status-poison').style.display = 'none';
            document.getElementById('enemy-status-stun').style.display = 'none';
            
            // Update enemy status effects
            gameState.combat.statusEffects.enemy.forEach(effect => {
                if (effect.type === 'poison') {
                    document.getElementById('enemy-status-poison').style.display = 'flex';
                } else if (effect.type === 'stun') {
                    document.getElementById('enemy-status-stun').style.display = 'flex';
                }
            });
        }

        function addCombatLogMessage(message) {
            const combatLog = document.getElementById('combat-log');
            const messageElement = document.createElement('p');
            messageElement.textContent = message;
            combatLog.appendChild(messageElement);
            combatLog.scrollTop = combatLog.scrollHeight;
        }

        function startDungeonCombat() {
            if (!gameState.currentDungeon || gameState.dungeonEnemiesDefeated >= 3) {
                completeDungeon();
                return;
            }
            
            currentEnemy = getRandomEnemy(gameState.currentDungeon.difficulty);
            combatTurn = 0;
            gameState.energy = 0;
            gameState.combat.isPlayerTurn = true;
            
            // Reset stats
            gameState.combat.playerStats.currentAttack = gameState.combat.playerStats.baseAttack;
            gameState.combat.playerStats.currentDefense = gameState.combat.playerStats.baseDefense;
            gameState.combat.playerStats.currentSpeed = gameState.combat.playerStats.baseSpeed;
            
            gameState.combat.enemyStats.currentAttack = currentEnemy.attack;
            gameState.combat.enemyStats.currentDefense = 0;
            gameState.combat.enemyStats.currentSpeed = 5;
            
            // Clear status effects
            gameState.combat.statusEffects.player = [];
            gameState.combat.statusEffects.enemy = [];
            
            updateEnemyCard();
            updateCombatUI();
            
            const combatLog = document.getElementById('combat-log');
            combatLog.innerHTML = '';
            addCombatLogMessage(`A ${currentEnemy.name} blocks your path!`);
            
            // Update turn indicator
            document.getElementById('turn-indicator').className = 'turn-indicator player-turn';
            document.getElementById('turn-indicator').textContent = 'YOUR TURN';
            
            updateUI();
        }

        function attack() {
            if (!currentEnemy || !gameState.combat.isPlayerTurn) return;
            
            const playerDamage = calculatePlayerDamage();
            currentEnemy.health -= playerDamage;
            gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + 1);
            addCombatLogMessage(`You attack for ${playerDamage} damage!`);
            
            // NEW: Damage popup
            if (gameState.settings.animations) {
                const enemyCard = document.getElementById('enemy-card');
                const rect = enemyCard.getBoundingClientRect();
                createDamagePopup(playerDamage, rect.left + rect.width/2, rect.top + rect.height/2, false);
            }
            
            // Check if enemy is defeated
            if (currentEnemy.health <= 0) {
                endCombat(true);
                return;
            }
            
            // Apply status effects at the end of turn
            applyStatusEffects();
            
            // Enemy's turn
            gameState.combat.isPlayerTurn = false;
            document.getElementById('turn-indicator').className = 'turn-indicator enemy-turn';
            document.getElementById('turn-indicator').textContent = 'ENEMY TURN';
            
            setTimeout(enemyTurn, 1500);
            
            updateEnemyCard();
            updateUI();
            combatTurn++;
        }

        function enemyTurn() {
            if (!currentEnemy || gameState.health <= 0) return;
            
            // Check if enemy is stunned
            const isStunned = gameState.combat.statusEffects.enemy.some(effect => effect.type === 'stun');
            
            if (isStunned) {
                addCombatLogMessage(`${currentEnemy.name} is stunned and cannot attack!`);
                
                // Remove stun effect after it's applied
                const stunIndex = gameState.combat.statusEffects.enemy.findIndex(effect => effect.type === 'stun');
                if (stunIndex >= 0) {
                    gameState.combat.statusEffects.enemy.splice(stunIndex, 1);
                    updateStatusEffects();
                }
            } else {
                const enemyDamage = calculateEnemyDamage();
                gameState.health -= enemyDamage;
                if (gameState.health < 0) gameState.health = 0;
                addCombatLogMessage(`${currentEnemy.name} attacks you for ${enemyDamage} damage!`);
                
                // NEW: Damage popup for player
                if (gameState.settings.animations) {
                    const playerArea = document.querySelector('.player-area');
                    const rect = playerArea.getBoundingClientRect();
                    createDamagePopup(enemyDamage, rect.left + rect.width/2, rect.top + rect.height/2, true);
                }
                
                // Check if player is defeated
                if (gameState.health <= 0) {
                    endCombat(false);
                    return;
                }
            }
            
            // Apply status effects at the end of turn
            applyStatusEffects();
            
            // Player's turn
            gameState.combat.isPlayerTurn = true;
            document.getElementById('turn-indicator').className = 'turn-indicator player-turn';
            document.getElementById('turn-indicator').textContent = 'YOUR TURN';
            
            updateUI();
        }

        function applyStatusEffects() {
            // Apply poison damage
            gameState.combat.statusEffects.enemy.forEach((effect, index) => {
                if (effect.type === 'poison') {
                    const poisonDamage = Math.round(currentEnemy.health * 0.05); // 5% of current health
                    currentEnemy.health -= poisonDamage;
                    addCombatLogMessage(`${currentEnemy.name} takes ${poisonDamage} poison damage!`);
                    
                    // Reduce duration
                    effect.duration--;
                    if (effect.duration <= 0) {
                        gameState.combat.statusEffects.enemy.splice(index, 1);
                        addCombatLogMessage(`${currentEnemy.name} is no longer poisoned.`);
                    }
                }
            });
            
            // Update enemy card if health changed
            if (currentEnemy.health <= 0) {
                endCombat(true);
                return;
            }
            
            updateEnemyCard();
            updateStatusEffects();
        }

        function endCombat(playerWon) {
            if (playerWon) {
                addCombatLogMessage(`You defeated the ${currentEnemy.name}!`);
                const reward = currentEnemy.reward;
                gameState.gold += reward;
                gameState.enemiesDefeated++;
                gameState.quests.defeatEnemies.progress++;
                
                // Gain experience
                gainExperience(reward / 10);
                
                if (gameState.inDungeon) {
                    gameState.dungeonEnemiesDefeated++;
                }
                
                // Chance to drop a card
                if (Math.random() < 0.2) {
                    const droppedCard = getRandomCard();
                    addToCollection(droppedCard);
                    addCombatLogMessage(`The enemy dropped a ${droppedCard.name} card!`);
                }
                
                addCombatLogMessage(`You earned ${reward} gold!`);
                
                // Check for first blood achievement
                if (gameState.enemiesDefeated === 1 && !gameState.achievements.firstBlood) {
                    document.getElementById('achieve-1-btn').disabled = false;
                }
                
                updateQuestUI();
                
                // Disable attack button until new enemy
                setTimeout(() => {
                    if (gameState.inDungeon) {
                        startDungeonCombat();
                    } else {
                        startCombat();
                    }
                }, 2000);
            } else {
                addCombatLogMessage("You were defeated!");
                setTimeout(() => {
                    gameState.health = gameState.maxHealth;
                    if (gameState.inDungeon) {
                        gameState.inDungeon = false;
                        gameState.currentDungeon = null;
                    }
                    returnToMainMenu();
                }, 2000);
            }
        }

        // NEW: Enhanced ability system
        function showAbilitySelector() {
            if (!gameState.combat.isPlayerTurn) return;
            
            const abilitySelector = document.getElementById('ability-selector');
            abilitySelector.innerHTML = '';
            
            // Get abilities from player deck
            const abilities = gameState.playerDeck.filter(card => card.type === 'ability');
            
            if (abilities.length === 0) {
                addCombatLogMessage("You have no abilities to use!");
                return;
            }
            
            abilities.forEach(ability => {
                const abilityOption = document.createElement('div');
                abilityOption.className = 'ability-option';
                abilityOption.onclick = function() {
                    selectAbility(ability);
                };
                
                const abilityEmoji = document.createElement('div');
                abilityEmoji.className = 'ability-emoji';
                abilityEmoji.textContent = ability.emoji;
                abilityOption.appendChild(abilityEmoji);
                
                const abilityName = document.createElement('div');
                abilityName.className = 'ability-name';
                abilityName.textContent = ability.name;
                abilityOption.appendChild(abilityName);
                
                // Show energy cost if applicable
                if (ability.energyCost) {
                    const energyCost = document.createElement('div');
                    energyCost.className = 'energy-cost';
                    energyCost.textContent = ability.energyCost;
                    abilityOption.appendChild(energyCost);
                }
                
                abilitySelector.appendChild(abilityOption);
            });
            
            abilitySelector.style.display = 'flex';
        }

        function selectAbility(ability) {
            gameState.combat.selectedAbility = ability;
            document.getElementById('ability-selector').style.display = 'none';
            
            // Check if ability requires targeting
            if (ability.requiresTarget) {
                showTargetingOverlay(ability);
            } else {
                useSelectedAbility();
            }
        }

        function useSelectedAbility() {
            if (!gameState.combat.selectedAbility || !gameState.combat.isPlayerTurn) return;
            
            const ability = gameState.combat.selectedAbility;
            
            // Check energy cost
            if (ability.energyCost && gameState.energy < ability.energyCost) {
                addCombatLogMessage("Not enough energy to use this ability!");
                gameState.combat.selectedAbility = null;
                return;
            }
            
            // Deduct energy
            if (ability.energyCost) {
                gameState.energy -= ability.energyCost;
            }
            
            // Apply ability effects
            applyAbilityEffect(ability);
            
            addCombatLogMessage(`You use ${ability.name}!`);
            
            // End turn after using ability
            gameState.combat.isPlayerTurn = false;
            document.getElementById('turn-indicator').className = 'turn-indicator enemy-turn';
            document.getElementById('turn-indicator').textContent = 'ENEMY TURN';
            
            setTimeout(enemyTurn, 1500);
            
            gameState.combat.selectedAbility = null;
            updateUI();
        }

        function applyAbilityEffect(ability) {
            switch(ability.id) {
                case 105: // Transformation
                    gameState.playerDeck.forEach(card => {
                        if (card.type === 'character') {
                            card.attack += 10;
                        }
                    });
                    gameState.combat.playerStats.currentAttack += 10;
                    addCombatLogMessage("You transform into a werewolf! +10 attack to all characters.");
                    break;
                    
                case 114: // Vampiric Ring
                    const healAmount = Math.round(gameState.maxHealth * 0.2);
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    addCombatLogMessage(`You use ${ability.name} and restore ${healAmount} health!`);
                    break;
                    
                case 115: // Moonstone
                    gameState.playerDeck.forEach(card => {
                        if (card.type === 'character' && card.subtype === 'werewolf') {
                            card.attack += 15;
                            card.health += 20;
                        }
                    });
                    addCombatLogMessage("Moonlight empowers your werewolves!");
                    break;
                    
                case 120: // Phoenix Feather
                    gameState.playerDeck.forEach(card => {
                        if (card.type === 'character') {
                            card.health = Math.round(card.health * 1.5);
                        }
                    });
                    addCombatLogMessage("Phoenix magic revives and empowers your team!");
                    break;
                    
                default:
                    // Default ability effect (damage)
                    const damage = Math.round(gameState.combat.playerStats.currentAttack * 1.5);
                    currentEnemy.health -= damage;
                    addCombatLogMessage(`You use ${ability.name} for ${damage} damage!`);
                    
                    if (currentEnemy.health <= 0) {
                        endCombat(true);
                    }
                    break;
            }
            
            updateEnemyCard();
            updateCombatUI();
        }

        // NEW: Targeting system
        function showTargetingOverlay(ability) {
            const targetingOverlay = document.getElementById('targeting-overlay');
            const targetInstruction = document.getElementById('target-instruction');
            const targetOptions = document.getElementById('target-options');
            
            targetInstruction.textContent = `Select a target for ${ability.name}:`;
            targetOptions.innerHTML = '';
            
            // Add enemy as target
            const enemyTarget = document.createElement('div');
            enemyTarget.className = 'target-option';
            enemyTarget.innerHTML = `
                <div class="card card-character combat-card">
                    <div class="card-header">${currentEnemy.name}</div>
                    <div class="card-body">${currentEnemy.emoji}</div>
                    <div class="card-stats">
                        <span>‚ù§Ô∏è ${currentEnemy.health}</span>
                        <span>‚öîÔ∏è ${currentEnemy.attack}</span>
                    </div>
                </div>
            `;
            enemyTarget.onclick = function() {
                useSelectedAbility();
                hideTargetingOverlay();
            };
            targetOptions.appendChild(enemyTarget);
            
            // Show targeting overlay
            targetingOverlay.style.display = 'flex';
        }

        function hideTargetingOverlay() {
            document.getElementById('targeting-overlay').style.display = 'none';
            gameState.combat.selectedAbility = null;
        }

        // NEW: Item usage in combat
        function useItem() {
            if (!gameState.combat.isPlayerTurn) return;
            
            // Check if player has consumables
            const consumables = gameState.inventory.consumables;
            if (consumables.length === 0) {
                addCombatLogMessage("You have no items to use!");
                return;
            }
            
            // Use first consumable (health potion)
            const healthPotion = consumables.find(item => item.id === 201);
            if (healthPotion && healthPotion.count > 0) {
                gameState.health = Math.min(gameState.maxHealth, gameState.health + 30);
                healthPotion.count--;
                
                if (healthPotion.count <= 0) {
                    const index = consumables.indexOf(healthPotion);
                    consumables.splice(index, 1);
                }
                
                addCombatLogMessage("You used a Health Potion! Restored 30 HP.");
                
                // End turn after using item
                gameState.combat.isPlayerTurn = false;
                document.getElementById('turn-indicator').className = 'turn-indicator enemy-turn';
                document.getElementById('turn-indicator').textContent = 'ENEMY TURN';
                
                setTimeout(enemyTurn, 1500);
                
                updateUI();
            } else {
                addCombatLogMessage("You have no Health Potions left!");
            }
        }

        // Enhanced damage calculation with status effects
        function calculatePlayerDamage() {
            // Base damage
            let damage = gameState.combat.playerStats.currentAttack;
            
            // Add weapon damage
            const weapon = gameState.playerDeck.find(card => card.type === 'weapon');
            if (weapon) {
                damage += weapon.attack;
                // Check for weapon bonuses
                if (weapon.ability.includes("Werewolves") && currentEnemy.subtype === "werewolf") {
                    damage += 5;
                }
                if (weapon.ability.includes("Vampires") && currentEnemy.subtype === "vampire") {
                    // Instant kill vs vampires with stake
                    if (weapon.id === 102) return currentEnemy.health;
                }
            }
            
            // Add character bonuses
            const characters = gameState.playerDeck.filter(card => card.type === 'character');
            characters.forEach(char => {
                damage += char.attack / 2;
                
                // Apply synergy bonuses
                gameState.activeSynergies.forEach(synergy => {
                    if (synergy.cards.includes(char.id)) {
                        if (synergy.bonus.attack) damage += synergy.bonus.attack;
                    }
                });
            });
            
            // Random variation
            damage *= (0.8 + Math.random() * 0.4);
            
            return Math.round(damage);
        }

        function calculateEnemyDamage() {
            // Base damage
            let damage = gameState.combat.enemyStats.currentAttack;
            
            // Subtract armor
            const armor = gameState.playerDeck.find(card => card.type === 'armor');
            if (armor) damage -= armor.defense;
            
            // Subtract player defense
            damage -= gameState.combat.playerStats.currentDefense;
            
            // Apply synergy dodge chance
            let dodgeChance = 0;
            gameState.activeSynergies.forEach(synergy => {
                if (synergy.bonus.dodge) dodgeChance += synergy.bonus.dodge;
            });
            
            if (Math.random() < dodgeChance) {
                addCombatLogMessage("You dodged the enemy's attack!");
                return 0;
            }
            
            // Random variation
            damage *= (0.8 + Math.random() * 0.4);
            
            return Math.round(Math.max(1, damage));
        }

        function flee() {
            addCombatLogMessage("You fled from combat!");
            setTimeout(() => {
                if (gameState.inDungeon) {
                    gameState.inDungeon = false;
                    gameState.currentDungeon = null;
                }
                returnToMainMenu();
            }, 1000);
        }

        // Dungeon Functions
        function enterDungeon(difficulty) {
            gameState.currentDungeon = {
                difficulty: difficulty,
                floor: 1
            };
            gameState.inDungeon = true;
            gameState.dungeonEnemiesDefeated = 0;
            showScreen('combat-screen');
        }

        function completeDungeon() {
            if (!gameState.currentDungeon) return;
            
            let reward = 0;
            switch(gameState.currentDungeon.difficulty) {
                case 'easy': reward = 300; break;
                case 'medium': reward = 600; break;
                case 'hard': reward = 1000; break;
                case 'boss': reward = 2000; break;
            }
            
            gameState.gold += reward;
            gameState.dungeonsCompleted++;
            gameState.dungeonLevel++;
            gameState.quests.completeDungeon.progress++;
            
            // NEW: Gain experience
            gainExperience(reward / 5);
            
            // Special rewards for boss dungeons
            if (gameState.currentDungeon.difficulty === 'boss') {
                reward += 1000;
                gameState.gems += 100;
                // Guaranteed legendary card
                const legendaryCard = getRandomCard('legendary');
                addToCollection(legendaryCard);
                showModal("Dungeon Complete", `You conquered the boss dungeon! Earned ${reward} gold, 100 gems, and a ${legendaryCard.name} card!`);
            } else {
                // Chance for rare card
                if (Math.random() < 0.5) {
                    const rareCard = getRandomCard('rare');
                    addToCollection(rareCard);
                    showModal("Dungeon Complete", `You completed the ${gameState.currentDungeon.difficulty} dungeon! Earned ${reward} gold and a ${rareCard.name} card!`);
                } else {
                    showModal("Dungeon Complete", `You completed the ${gameState.currentDungeon.difficulty} dungeon! Earned ${reward} gold!`);
                }
            }
            
            // Check for dungeon delver achievement
            if (gameState.dungeonsCompleted >= 5 && !gameState.achievements.dungeonDelver) {
                document.getElementById('achieve-4-btn').disabled = false;
            }
            
            gameState.inDungeon = false;
            gameState.currentDungeon = null;
            gameState.health = gameState.maxHealth;
            
            updateQuestUI();
            updateDungeonUI();
            updateUI();
            returnToMainMenu();
        }

        // Fuse Functions
        let fuseSelection = [null, null];

        function updateFuseUI() {
            const grid = document.getElementById('fuse-collection');
            grid.innerHTML = '';
            
            gameState.collection.forEach(card => {
                const cardElement = createCardElement(card);
                cardElement.onclick = function() {
                    selectCardForFuse(card);
                };
                grid.appendChild(cardElement);
            });
            
            // Update fuse slots
            for (let i = 0; i < 2; i++) {
                const slot = document.getElementById(`fuse-slot-${i+1}`);
                slot.innerHTML = '';
                
                if (fuseSelection[i]) {
                    const cardElement = createCardElement(fuseSelection[i]);
                    slot.appendChild(cardElement);
                } else {
                    slot.textContent = `SLOT ${i+1}`;
                }
            }
            
            // Update fuse button
            const fuseBtn = document.getElementById('fuse-btn');
            fuseBtn.disabled = !(fuseSelection[0] && fuseSelection[1]);
            
            // Update result preview
            const resultElement = document.getElementById('fuse-result');
            resultElement.innerHTML = 'RESULT';
            
            if (fuseSelection[0] && fuseSelection[1]) {
                const previewCard = predictFuseResult(fuseSelection[0], fuseSelection[1]);
                if (previewCard) {
                    resultElement.innerHTML = '';
                    const cardElement = createCardElement(previewCard);
                    resultElement.appendChild(cardElement);
                }
            }
        }

        function selectCardForFuse(card) {
            // Find first empty slot or replace the first one
            if (!fuseSelection[0]) {
                fuseSelection[0] = card;
            } else if (!fuseSelection[1]) {
                fuseSelection[1] = card;
            } else {
                fuseSelection[0] = card;
                fuseSelection[1] = null;
            }
            
            updateFuseUI();
        }

        function clearFuseSlot(slotNumber) {
            fuseSelection[slotNumber - 1] = null;
            updateFuseUI();
        }

        function predictFuseResult(card1, card2) {
            // Simple fusion logic
            if (card1.type !== card2.type) return null;
            
            // Different cards can be fused but with different results
            const newCard = {...card1};
            
            // If same card, level up
            if (card1.id === card2.id) {
                newCard.level = (card1.level || 1) + 1;
                
                if (card1.type === 'character') {
                    newCard.health = Math.round(card1.health * 1.3);
                    newCard.attack = Math.round(card1.attack * 1.3);
                } else if (card1.type === 'weapon') {
                    newCard.attack = Math.round(card1.attack * 1.5);
                } else if (card1.type === 'armor') {
                    newCard.defense = Math.round(card1.defense * 1.5);
                }
            } else {
                // Different cards - create a hybrid
                newCard.name = `${card1.name}/${card2.name}`;
                newCard.level = Math.max(card1.level || 1, card2.level || 1);
                
                if (card1.type === 'character') {
                    newCard.health = Math.round((card1.health + card2.health) / 2 * 1.2);
                    newCard.attack = Math.round((card1.attack + card2.attack) / 2 * 1.2);
                    newCard.ability = `${card1.ability} + ${card2.ability}`;
                } else if (card1.type === 'weapon') {
                    newCard.attack = Math.round((card1.attack + card2.attack) / 2 * 1.3);
                    newCard.ability = `${card1.ability} / ${card2.ability}`;
                } else if (card1.type === 'armor') {
                    newCard.defense = Math.round((card1.defense + card2.defense) / 2 * 1.3);
                    newCard.ability = `${card1.ability} / ${card2.ability}`;
                }
            }
            
            return newCard;
        }

        function fuseCards() {
            if (!fuseSelection[0] || !fuseSelection[1]) return;
            if (gameState.gold < 50) {
                showModal("Not Enough Gold", "You need 50 gold to fuse cards!");
                return;
            }
            
            const card1 = fuseSelection[0];
            const card2 = fuseSelection[1];
            
            if (card1.type !== card2.type) {
                showModal("Fusion Error", "You can only fuse cards of the same type!");
                return;
            }
            
            // Check if player has fusion catalysts
            const hasCatalyst = gameState.inventory.materials.some(i => i.id === 302);
            
            // Deduct gold
            gameState.gold -= 50;
            
            // Remove the fused cards from collection
            for (let i = 0; i < gameState.collection.length; i++) {
                if (gameState.collection[i].id === card1.id && gameState.collection[i].level === card1.level) {
                    gameState.collection[i].count--;
                    if (gameState.collection[i].count <= 0) {
                        gameState.collection.splice(i, 1);
                    }
                    break;
                }
            }
            
            for (let i = 0; i < gameState.collection.length; i++) {
                if (gameState.collection[i].id === card2.id && gameState.collection[i].level === card2.level) {
                    gameState.collection[i].count--;
                    if (gameState.collection[i].count <= 0) {
                        gameState.collection.splice(i, 1);
                    }
                    break;
                }
            }
            
            // Create new card
            let newCard = predictFuseResult(card1, card2);
            
            // Apply fusion catalyst if available
            if (hasCatalyst) {
                if (newCard.type === 'character') {
                    newCard.health = Math.round(newCard.health * 1.2);
                    newCard.attack = Math.round(newCard.attack * 1.2);
                } else {
                    newCard.type === 'weapon' 
                        ? newCard.attack = Math.round(newCard.attack * 1.3)
                        : newCard.defense = Math.round(newCard.defense * 1.3);
                }
                
                // Remove catalyst
                const catalystIndex = gameState.inventory.materials.findIndex(i => i.id === 302);
                if (catalystIndex >= 0) {
                    gameState.inventory.materials[catalystIndex].count--;
                    if (gameState.inventory.materials[catalystIndex].count <= 0) {
                        gameState.inventory.materials.splice(catalystIndex, 1);
                    }
                }
            }
            
            addToCollection(newCard);
            gameState.cardsFused++;
            gameState.quests.fuseCards.progress++;
            
            // Check for master fuser achievement
            if (gameState.cardsFused >= 10 && !gameState.achievements.masterFuser) {
                document.getElementById('achieve-3-btn').disabled = false;
            }
            
            // Reset fuse selection
            fuseSelection = [null, null];
            updateFuseUI();
            updateUI();
            updateQuestUI();
            
            showModal("Fusion Complete", `Successfully fused ${card1.name} and ${card2.name} into ${newCard.name}!`);
        }

        // Claim rewards functions
        function claimQuestReward(questNumber) {
            switch(questNumber) {
                case 1:
                    if (gameState.quests.defeatEnemies.progress >= 5 && !gameState.quests.defeatEnemies.completed) {
                        gameState.gold += 200;
                        for (let i = 0; i < 3; i++) {
                            addToCollection(getRandomCard("common"));
                        }
                        gameState.quests.defeatEnemies.completed = true;
                        document.getElementById('quest-1-btn').disabled = true;
                        updateUI();
                        showModal("Quest Complete", "Quest completed! Received 200 gold and 3 common cards.");
                    }
                    break;
                case 2:
                    if (gameState.quests.collectVampires.progress >= 3 && !gameState.quests.collectVampires.completed) {
                        gameState.gold += 300;
                        addToCollection(getCardById(1)); // Dracula
                        gameState.quests.collectVampires.completed = true;
                        document.getElementById('quest-2-btn').disabled = true;
                        updateUI();
                        showModal("Quest Complete", "Quest completed! Received 300 gold and a Dracula card.");
                    }
                    break;
                case 3:
                    if (gameState.quests.fuseCards.progress >= 2 && !gameState.quests.fuseCards.completed) {
                        gameState.gold += 150;
                        addToInventory({ id: 301, name: "Upgrade Stone", type: "material", emoji: "üíé", effect: "Upgrade card by 1 level", count: 1 });
                        gameState.quests.fuseCards.completed = true;
                        document.getElementById('quest-3-btn').disabled = true;
                        updateUI();
                        showModal("Quest Complete", "Quest completed! Received 150 gold and an upgrade stone.");
                    }
                    break;
                case 4:
                    if (gameState.quests.completeDungeon.progress >= 1 && !gameState.quests.completeDungeon.completed) {
                        gameState.gold += 500;
                        for (let i = 0; i < 3; i++) {
                            addToCollection(getRandomCard("rare"));
                        }
                        gameState.quests.completeDungeon.completed = true;
                        document.getElementById('quest-4-btn').disabled = true;
                        updateUI();
                        showModal("Quest Complete", "Quest completed! Received 500 gold and 3 rare cards.");
                    }
                    break;
            }
        }

        function claimAchievementReward(achievementNumber) {
            switch(achievementNumber) {
                case 1:
                    if (!gameState.achievements.firstBlood) {
                        gameState.gems += 10;
                        gameState.achievements.firstBlood = true;
                        document.getElementById('achieve-1-btn').disabled = true;
                        document.getElementById('achievement-points').textContent = parseInt(document.getElementById('achievement-points').textContent) + 1;
                        updateUI();
                        showModal("Achievement Unlocked", "Achievement unlocked! Received 10 gems.");
                    }
                    break;
                case 2:
                    if (!gameState.achievements.cardCollector && gameState.uniqueCardsCollected >= 10) {
                        gameState.gems += 20;
                        gameState.achievements.cardCollector = true;
                        document.getElementById('achieve-2-btn').disabled = true;
                        document.getElementById('achievement-points').textContent = parseInt(document.getElementById('achievement-points').textContent) + 1;
                        updateUI();
                        showModal("Achievement Unlocked", "Achievement unlocked! Received 20 gems.");
                    }
                    break;
                case 3:
                    if (!gameState.achievements.masterFuser && gameState.cardsFused >= 10) {
                        gameState.gems += 30;
                        gameState.achievements.masterFuser = true;
                        document.getElementById('achieve-3-btn').disabled = true;
                        document.getElementById('achievement-points').textContent = parseInt(document.getElementById('achievement-points').textContent) + 1;
                        updateUI();
                        showModal("Achievement Unlocked", "Achievement unlocked! Received 30 gems.");
                    }
                    break;
                case 4:
                    if (!gameState.achievements.dungeonDelver && gameState.dungeonsCompleted >= 5) {
                        gameState.gems += 50;
                        gameState.achievements.dungeonDelver = true;
                        document.getElementById('achieve-4-btn').disabled = true;
                        document.getElementById('achievement-points').textContent = parseInt(document.getElementById('achievement-points').textContent) + 1;
                        updateUI();
                        showModal("Achievement Unlocked", "Achievement unlocked! Received 50 gems.");
                    }
                    break;
            }
        }

        // Initialize the game when page loads
        window.onload = function() {
            // Add event listeners for claim buttons
            document.getElementById('quest-1-btn').onclick = function() { claimQuestReward(1); };
            document.getElementById('quest-2-btn').onclick = function() { claimQuestReward(2); };
            document.getElementById('quest-3-btn').onclick = function() { claimQuestReward(3); };
            document.getElementById('quest-4-btn').onclick = function() { claimQuestReward(4); };
            
            document.getElementById('achieve-1-btn').onclick = function() { claimAchievementReward(1); };
            document.getElementById('achieve-2-btn').onclick = function() { claimAchievementReward(2); };
            document.getElementById('achieve-3-btn').onclick = function() { claimAchievementReward(3); };
            document.getElementById('achieve-4-btn').onclick = function() { claimAchievementReward(4); };
            
            // NEW: Initialize settings toggles
            for (const [setting, value] of Object.entries(gameState.settings)) {
                const toggle = document.getElementById(`${setting}-toggle`);
                if (value) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            }
            
            initGame();
        };
    </script>
</body>
</html>
