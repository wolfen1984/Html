<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Graveyard of Souls (1988) - Nightfalls Games</title>
    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            line-height: 1.4;
            background-color: #0a0a0a;
            color: #32cd32;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 5px;
            touch-action: manipulation;
        }
        #header {
            text-align: center;
            border-bottom: 2px solid #32cd32;
            padding-bottom: 8px;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        #game-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        #output {
            flex-grow: 1;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            border: 1px solid #32cd32;
            padding: 8px;
            margin-bottom: 8px;
            background-color: #111;
            -webkit-overflow-scrolling: touch;
        }
        #input-line {
            display: flex;
            flex-shrink: 0;
            align-items: center;
        }
        #prompt {
            margin-right: 8px;
            white-space: nowrap;
        }
        #input {
            flex-grow: 1;
            background: transparent;
            border: none;
            border-bottom: 1px solid #32cd32;
            color: #32cd32;
            font-family: inherit;
            font-size: inherit;
            outline: none;
            padding: 4px 0;
        }
        #status {
            border-top: 1px solid #32cd32;
            padding-top: 8px;
            margin-top: 8px;
            flex-shrink: 0;
            white-space: pre;
            font-size: 10px;
        }
        .command {
            color: #ff69b4;
        }
        .error {
            color: #ff0000;
        }
        .item {
            color: #00ffff;
        }
        .enemy {
            color: #dc143c;
        }
        .npc {
            color: #ffd700;
        }
        .success {
            color: #7cfc00;
        }
        .quest {
            color: #ff69b4;
        }
        .loot {
            color: #ffa500;
        }
        .system {
            color: #888;
        }
        .damage {
            color: #ff4500;
        }
        .heal {
            color: #32cd32;
        }
        .puzzle {
            color: #9370db;
        }
        .equipped {
            color: #00ff7f;
            font-weight: bold;
        }
        .secret {
            color: #da70d6;
            font-style: italic;
        }
        .trap {
            color: #ff1493;
        }
        .corpse {
            color: #8b4513;
        }
        .ghost {
            color: #e6e6fa;
        }
        #sound-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #000;
            border: 1px solid #32cd32;
            color: #32cd32;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            z-index: 1000;
        }
        .quick-command {
            display: inline-block;
            background: #222;
            border: 1px solid #32cd32;
            color: #32cd32;
            padding: 2px 6px;
            margin: 2px;
            cursor: pointer;
            font-size: 10px;
        }
        #quick-commands {
            margin-top: 8px;
            text-align: center;
        }
        #volume-control {
            position: fixed;
            top: 40px;
            right: 10px;
            background: #000;
            border: 1px solid #32cd32;
            color: #32cd32;
            padding: 4px;
            font-size: 10px;
            z-index: 999;
        }
        #volume-slider {
            width: 80px;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <button id="sound-toggle">ðŸ”Š ON</button>
    <div id="volume-control">
        <div>Volume:</div>
        <input type="range" id="volume-slider" min="0" max="100" value="70">
    </div>
    <div id="header">
        <h1>GRAVEYARD OF SOULS</h1>
        <div>1988 â€¢ NIGHTFALLS GAMES</div>
    </div>
    <div id="game-container">
        <div id="output">Welcome to Graveyard of Souls! Type 'help' for commands.</div>
        <div id="input-line">
            <span id="prompt">&gt;</span>
            <input type="text" id="input" autocomplete="off" autofocus>
        </div>
        <div id="quick-commands">
            <span class="quick-command" onclick="quickCommand('n')">N</span>
            <span class="quick-command" onclick="quickCommand('s')">S</span>
            <span class="quick-command" onclick="quickCommand('e')">E</span>
            <span class="quick-command" onclick="quickCommand('w')">W</span>
            <span class="quick-command" onclick="quickCommand('look')">LOOK</span>
            <span class="quick-command" onclick="quickCommand('inventory')">INV</span>
            <span class="quick-command" onclick="quickCommand('stats')">STATS</span>
        </div>
        <div id="status"></div>
    </div>

    <script>
        // ==================== GOTHIC SOUND SYSTEM ====================
        class GothicSoundSystem {
            constructor() {
                this.audioContext = null;
                this.masterGain = null;
                this.bgGain = null;
                this.sfxGain = null;
                this.enabled = true;
                this.currentBg = null;
                this.currentBgSource = null;
                this.currentBgName = null;
                
                this.init();
            }
            
            init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.audioContext.createGain();
                    this.bgGain = this.audioContext.createGain();
                    this.sfxGain = this.audioContext.createGain();
                    
                    // Set initial volumes
                    this.masterGain.gain.value = 0.7;
                    this.bgGain.gain.value = 0.2;
                    this.sfxGain.gain.value = 0.5;
                    
                    // Connect nodes
                    this.bgGain.connect(this.masterGain);
                    this.sfxGain.connect(this.masterGain);
                    this.masterGain.connect(this.audioContext.destination);
                    
                    // Volume control
                    document.getElementById('volume-slider').addEventListener('input', (e) => {
                        const volume = e.target.value / 100;
                        this.setMasterVolume(volume);
                    });
                    
                } catch (e) {
                    console.log('Web Audio API not supported:', e);
                    this.enabled = false;
                }
            }
            
            // ==================== GOTHIC HORROR MUSIC ====================
            playBackground(musicName, loop = true) {
                if (!this.enabled || !musicName) return;
                
                // Don't restart same music
                if (this.currentBgName === musicName && this.currentBgSource) {
                    return;
                }
                
                // Stop current background
                this.stopBackground();
                
                this.currentBgName = musicName;
                
                // Generate gothic horror music based on name
                switch(musicName) {
                    case 'main_theme':
                        this.playGothicTheme(loop);
                        break;
                    case 'cemetery':
                        this.playCemeteryMusic(loop);
                        break;
                    case 'mausoleum':
                        this.playMausoleumMusic(loop);
                        break;
                    case 'catacombs':
                        this.playCatacombsMusic(loop);
                        break;
                    case 'crypts':
                        this.playCryptsMusic(loop);
                        break;
                    case 'haunted_woods':
                        this.playHauntedWoodsMusic(loop);
                        break;
                    case 'witch_coven':
                        this.playWitchCovenMusic(loop);
                        break;
                    case 'escape_theme':
                        this.playEscapeTheme(loop);
                        break;
                    case 'victory':
                        this.playVictoryMusic(loop);
                        break;
                    default:
                        this.playGothicTheme(loop);
                }
            }
            
            playGothicTheme(loop) {
                const melody = [
                    {note: 82.41, duration: 0.8},
                    {note: 61.74, duration: 0.4},
                    {note: 73.42, duration: 0.8},
                    {note: 55.00, duration: 0.4},
                    {note: 65.41, duration: 1.6},
                ];
                
                this.playGothicMelody(melody, 'sawtooth', loop, 0.15);
            }
            
            playCemeteryMusic(loop) {
                const melody = [
                    {note: 77.78, duration: 1.0},
                    {note: 58.27, duration: 0.5},
                    {note: 69.30, duration: 1.0},
                    {note: 51.91, duration: 0.5},
                    {note: 61.74, duration: 2.0},
                ];
                
                this.playGothicMelody(melody, 'triangle', loop, 0.12);
            }
            
            playMausoleumMusic(loop) {
                const melody = [
                    {note: 130.81, duration: 0.4},
                    {note: 123.47, duration: 0.4},
                    {note: 116.54, duration: 0.4},
                    {note: 110.00, duration: 0.8},
                    {note: 103.83, duration: 0.8},
                ];
                
                this.playGothicMelody(melody, 'square', loop, 0.1);
            }
            
            playCatacombsMusic(loop) {
                const melody = [
                    {note: 87.31, duration: 0.3},
                    {note: 73.42, duration: 0.3},
                    {note: 65.41, duration: 0.3},
                    {note: 55.00, duration: 0.9},
                ];
                
                this.playGothicMelody(melody, 'sine', loop, 0.08);
            }
            
            playCryptsMusic(loop) {
                const melody = [
                    {note: 98.00, duration: 0.6},
                    {note: 82.41, duration: 0.3},
                    {note: 92.50, duration: 0.6},
                    {note: 77.78, duration: 0.3},
                    {note: 87.31, duration: 1.2},
                ];
                
                this.playGothicMelody(melody, 'sawtooth', loop, 0.13);
            }
            
            playHauntedWoodsMusic(loop) {
                const melody = [
                    {note: 110.00, duration: 0.2},
                    {note: 130.81, duration: 0.2},
                    {note: 146.83, duration: 0.2},
                    {note: 164.81, duration: 0.3},
                    {note: 123.47, duration: 0.2},
                    {note: 138.59, duration: 0.2},
                    {note: 155.56, duration: 0.3},
                ];
                
                this.playGothicMelody(melody, 'sine', loop, 0.15);
            }
            
            playWitchCovenMusic(loop) {
                const melody = [
                    {note: 220.00, duration: 0.2},
                    {note: 196.00, duration: 0.2},
                    {note: 174.61, duration: 0.2},
                    {note: 164.81, duration: 0.3},
                    {note: 146.83, duration: 0.4},
                ];
                
                this.playGothicMelody(melody, 'square', loop, 0.12);
            }
            
            playEscapeTheme(loop) {
                const melody = [
                    {note: 261.63, duration: 0.2},
                    {note: 311.13, duration: 0.2},
                    {note: 349.23, duration: 0.2},
                    {note: 415.30, duration: 0.3},
                    {note: 329.63, duration: 0.2},
                    {note: 392.00, duration: 0.2},
                    {note: 493.88, duration: 0.3},
                    {note: 523.25, duration: 0.4},
                ];
                
                this.playGothicMelody(melody, 'sine', loop, 0.2);
            }
            
            playVictoryMusic(loop) {
                const melody = [
                    {note: 329.63, duration: 0.2},
                    {note: 392.00, duration: 0.2},
                    {note: 493.88, duration: 0.2},
                    {note: 659.25, duration: 0.3},
                    {note: 587.33, duration: 0.2},
                    {note: 783.99, duration: 0.2},
                    {note: 987.77, duration: 0.3},
                    {note: 880.00, duration: 0.4},
                ];
                
                this.playGothicMelody(melody, 'sine', loop, 0.25);
            }
            
            playGothicMelody(melody, waveType, loop, volume) {
                if (!this.enabled) return;
                
                const now = this.audioContext.currentTime;
                const source = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                source.type = waveType;
                gainNode.connect(this.bgGain);
                source.connect(gainNode);
                
                let currentTime = now;
                melody.forEach((note, index) => {
                    source.frequency.setValueAtTime(note.note, currentTime);
                    
                    gainNode.gain.setValueAtTime(0, currentTime);
                    gainNode.gain.linearRampToValueAtTime(volume, currentTime + 0.08);
                    gainNode.gain.exponentialRampToValueAtTime(volume * 0.2, currentTime + note.duration - 0.08);
                    gainNode.gain.linearRampToValueAtTime(0, currentTime + note.duration);
                    
                    currentTime += note.duration;
                });
                
                if (loop) {
                    source.start(now);
                    source.stop(now + currentTime - now);
                    
                    this.currentBg = setTimeout(() => {
                        this.playGothicMelody(melody, waveType, loop, volume);
                    }, (currentTime - now) * 1000);
                } else {
                    source.start(now);
                    source.stop(now + currentTime - now);
                }
                
                this.currentBgSource = source;
            }
            
            stopBackground() {
                if (this.currentBg) {
                    clearTimeout(this.currentBg);
                    this.currentBg = null;
                }
                if (this.currentBgSource) {
                    try {
                        this.currentBgSource.stop();
                    } catch (e) {}
                    this.currentBgSource = null;
                }
                this.currentBgName = null;
            }
            
            // ==================== GOTHIC SOUND EFFECTS ====================
            playSound(soundName, volume = 1.0) {
                if (!this.enabled) return;
                
                switch(soundName) {
                    case 'click':
                        this.playGothicClick(volume);
                        break;
                    case 'notification':
                        this.playGothicNotification(volume);
                        break;
                    case 'attack':
                        this.playGothicAttack(volume);
                        break;
                    case 'enemyHit':
                        this.playGothicEnemyHit(volume);
                        break;
                    case 'playerHit':
                        this.playGothicPlayerHit(volume);
                        break;
                    case 'victory':
                        this.playGothicVictory(volume);
                        break;
                    case 'pickup':
                        this.playGothicPickup(volume);
                        break;
                    case 'door':
                        this.playGothicDoor(volume);
                        break;
                    case 'step':
                        this.playGothicStep(volume);
                        break;
                    case 'puzzle':
                        this.playGothicPuzzle(volume);
                        break;
                    case 'error':
                        this.playGothicError(volume);
                        break;
                    case 'equip':
                        this.playGothicEquip(volume);
                        break;
                    case 'trap':
                        this.playTombTrapSound(volume);
                        break;
                    case 'chains':
                        this.playGraveChainsSound(volume);
                        break;
                    case 'moan':
                        this.playGhostMoan(volume);
                        break;
                    case 'wind':
                        this.playCemeteryWind(volume);
                        break;
                    case 'wolf':
                        this.playWolfHowl(volume);
                        break;
                    case 'ritual':
                        this.playRitualChant(volume);
                        break;
                    case 'crypt':
                        this.playCryptDoor(volume);
                        break;
                    case 'spell':
                        this.playWitchSpell(volume);
                        break;
                    case 'secret':
                        this.playSecretReveal(volume);
                        break;
                }
            }
            
            playGothicClick(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, now);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.3, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 0.1);
            }
            
            playGothicNotification(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(300, now);
                oscillator.frequency.exponentialRampToValueAtTime(600, now + 0.3);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.4, now + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 0.3);
            }
            
            playGothicAttack(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(350, now);
                oscillator.frequency.exponentialRampToValueAtTime(120, now + 0.2);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.5, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 0.2);
            }
            
            playGothicEnemyHit(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(180, now);
                oscillator.frequency.exponentialRampToValueAtTime(70, now + 0.3);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.6, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 0.3);
            }
            
            playGothicPlayerHit(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(240, now);
                oscillator.frequency.exponentialRampToValueAtTime(130, now + 0.2);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.5, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 0.2);
            }
            
            playGothicVictory(volume) {
                const now = this.audioContext.currentTime;
                
                const notes = [
                    {freq: 659.25, time: 0.0, duration: 0.2},
                    {freq: 783.99, time: 0.2, duration: 0.2},
                    {freq: 987.77, time: 0.4, duration: 0.2},
                    {freq: 1318.51, time: 0.6, duration: 0.5},
                ];
                
                notes.forEach(note => {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(note.freq, now + note.time);
                    
                    gainNode.gain.setValueAtTime(0, now + note.time);
                    gainNode.gain.linearRampToValueAtTime(volume * 0.4, now + note.time + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + note.time + note.duration);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.sfxGain);
                    
                    oscillator.start(now + note.time);
                    oscillator.stop(now + note.time + note.duration);
                });
            }
            
            playGothicPickup(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(1200, now);
                oscillator.frequency.exponentialRampToValueAtTime(1800, now + 0.1);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.3, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 0.1);
            }
            
            playGothicDoor(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(220, now);
                oscillator.frequency.exponentialRampToValueAtTime(120, now + 0.5);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.3, now + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 0.5);
            }
            
            playGothicStep(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(450, now);
                oscillator.frequency.exponentialRampToValueAtTime(220, now + 0.1);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.2, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 0.1);
            }
            
            playGothicPuzzle(volume) {
                const now = this.audioContext.currentTime;
                
                const notes = [330, 415, 494, 660];
                
                notes.forEach((note, index) => {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(note, now + (index * 0.15));
                    
                    gainNode.gain.setValueAtTime(0, now + (index * 0.15));
                    gainNode.gain.linearRampToValueAtTime(volume * 0.3, now + (index * 0.15) + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + (index * 0.15) + 0.2);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.sfxGain);
                    
                    oscillator.start(now + (index * 0.15));
                    oscillator.stop(now + (index * 0.15) + 0.2);
                });
            }
            
            playGothicError(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(130, now);
                oscillator.frequency.setValueAtTime(110, now + 0.1);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.4, now + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 0.3);
            }
            
            playGothicEquip(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(700, now);
                oscillator.frequency.exponentialRampToValueAtTime(500, now + 0.2);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.4, now + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 0.2);
            }
            
            playTombTrapSound(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(90, now);
                oscillator.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.6, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 0.3);
            }
            
            playGraveChainsSound(volume) {
                const now = this.audioContext.currentTime;
                const oscillator1 = this.audioContext.createOscillator();
                const oscillator2 = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator1.type = 'square';
                oscillator2.type = 'square';
                oscillator1.frequency.setValueAtTime(220, now);
                oscillator2.frequency.setValueAtTime(223, now);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.3, now + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
                
                oscillator1.connect(gainNode);
                oscillator2.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator1.start(now);
                oscillator2.start(now);
                oscillator1.stop(now + 0.5);
                oscillator2.stop(now + 0.5);
            }
            
            playGhostMoan(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(200, now);
                oscillator.frequency.exponentialRampToValueAtTime(150, now + 1.0);
                oscillator.frequency.setValueAtTime(180, now + 1.2);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.4, now + 0.2);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 2.0);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 2.0);
            }
            
            playCemeteryWind(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(150, now);
                oscillator.frequency.exponentialRampToValueAtTime(250, now + 3.0);
                
                // Add noise for wind effect
                const noise = this.audioContext.createBufferSource();
                const noiseBuffer = this.audioContext.createBuffer(1, this.audioContext.sampleRate * 3, this.audioContext.sampleRate);
                const noiseData = noiseBuffer.getChannelData(0);
                for (let i = 0; i < noiseData.length; i++) {
                    noiseData[i] = Math.random() * 2 - 1;
                }
                noise.buffer = noiseBuffer;
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.2, now + 0.5);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 3.0);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 3.0);
            }
            
            playWolfHowl(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(300, now);
                oscillator.frequency.exponentialRampToValueAtTime(600, now + 1.0);
                oscillator.frequency.exponentialRampToValueAtTime(200, now + 2.0);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.5, now + 0.3);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 2.5);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 2.5);
            }
            
            playRitualChant(volume) {
                const now = this.audioContext.currentTime;
                
                const notes = [440, 392, 349, 294];
                
                notes.forEach((note, index) => {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(note, now + (index * 0.5));
                    
                    gainNode.gain.setValueAtTime(0, now + (index * 0.5));
                    gainNode.gain.linearRampToValueAtTime(volume * 0.3, now + (index * 0.5) + 0.2);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + (index * 0.5) + 0.8);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.sfxGain);
                    
                    oscillator.start(now + (index * 0.5));
                    oscillator.stop(now + (index * 0.5) + 0.8);
                });
            }
            
            playCryptDoor(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(120, now);
                oscillator.frequency.exponentialRampToValueAtTime(60, now + 0.8);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.4, now + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 0.8);
            }
            
            playWitchSpell(volume) {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, now);
                oscillator.frequency.exponentialRampToValueAtTime(1600, now + 0.5);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.5, now + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.sfxGain);
                
                oscillator.start(now);
                oscillator.stop(now + 0.5);
            }
            
            playSecretReveal(volume) {
                const now = this.audioContext.currentTime;
                
                const notes = [660, 784, 988, 1320];
                
                notes.forEach((note, index) => {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(note, now + (index * 0.1));
                    
                    gainNode.gain.setValueAtTime(0, now + (index * 0.1));
                    gainNode.gain.linearRampToValueAtTime(volume * 0.2, now + (index * 0.1) + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + (index * 0.1) + 0.15);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.sfxGain);
                    
                    oscillator.start(now + (index * 0.1));
                    oscillator.stop(now + (index * 0.1) + 0.15);
                });
            }
            
            // ==================== UTILITY METHODS ====================
            setMasterVolume(volume) {
                if (this.masterGain) {
                    this.masterGain.gain.value = Math.max(0, Math.min(1, volume));
                }
            }
            
            toggle() {
                this.enabled = !this.enabled;
                const toggleBtn = document.getElementById('sound-toggle');
                toggleBtn.textContent = this.enabled ? 'ðŸ”Š ON' : 'ðŸ”‡ OFF';
                
                if (!this.enabled) {
                    this.stopBackground();
                } else if (gameStarted) {
                    this.playBackground(currentBackground);
                }
                
                this.playSound('click');
            }
            
            resumeAudioContext() {
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
            }
        }

        // ==================== SURVIVOR CLASSES ====================
        const classes = {
            hunter: { 
                hp: 45, mp: 10, str: 9, def: 7, int: 3,
                desc: "A monster hunter caught in the graveyard. Strong and resilient against the undead.",
                startingItems: ['silver_dagger', 'holy_symbol']
            },
            grave_robber: { 
                hp: 35, mp: 15, str: 7, def: 5, int: 6,
                desc: "A thief who came to loot tombs but became trapped. Quick and stealthy.",
                startingItems: ['lockpick', 'skeleton_key']
            },
            occultist: { 
                hp: 30, mp: 35, str: 4, def: 4, int: 9,
                desc: "A scholar of the dark arts seeking forbidden knowledge. Weak but magically powerful.",
                startingItems: ['necronomicon_page', 'witch_herb']
            }
        };

        // ==================== 40 GRAVEYARD ROOMS ====================
        const rooms = [
            { // Room 0: Entrance Gates
                id: 0,
                name: "RUSTED GATES",
                desc: "The entrance to the graveyard. Iron gates hang broken on rusted hinges. Mist obscures the path ahead.",
                sound: 'main_theme',
                exits: { n: 1, s: null, e: null, w: null },
                items: ['iron_gate_shard'],
                npc: null,
                enemy: 'gatekeeper_ghoul',
                container: 'gatekeeper_hut',
                puzzle: 'open_gates',
                dark: false,
                locked: false,
                trap: 'rusted_spikes',
                secret: null
            },
            { // Room 1: Cemetery Path
                id: 1,
                name: "CEMETERY PATH",
                desc: "A winding path between ancient tombstones. Some are cracked, others overturned by grasping roots.",
                sound: 'cemetery',
                exits: { n: 2, s: 0, e: 3, w: 4 },
                items: ['wooden_stake'],
                npc: 'mourning_ghost',
                enemy: null,
                container: 'fresh_grave',
                puzzle: null,
                dark: true,
                locked: false,
                trap: 'grave_hand',
                secret: null
            },
            { // Room 2: Mausoleum Entrance
                id: 2,
                name: "MAUSOLEUM ENTRANCE",
                desc: "A massive stone mausoleum with ornate carvings of skulls and angels. The doors are slightly ajar.",
                sound: 'mausoleum',
                exits: { n: 5, s: 1, e: null, w: null },
                items: ['stone_skull_fragment'],
                npc: null,
                enemy: 'stone_gargoyle',
                container: 'offering_bowl',
                puzzle: 'mausoleum_lock',
                dark: true,
                locked: true,
                trap: 'falling_skull',
                secret: null
            },
            { // Room 3: Mourner's Chapel
                id: 3,
                name: "MOURNER'S CHAPEL",
                desc: "A small, crumbling chapel. Pews are covered in dust, and the altar is stained with dark fluids.",
                sound: 'cemetery',
                exits: { n: 6, s: null, e: null, w: 1 },
                items: ['holy_water'],
                npc: 'priest_ghost',
                enemy: null,
                container: 'confessional',
                puzzle: 'chapel_blessing',
                dark: true,
                locked: false,
                trap: 'collapsing_pew',
                secret: 'hidden_crypt'
            },
            { // Room 4: Willow Grove
                id: 4,
                name: "WEEPING WILLOW GROVE",
                desc: "Ancient willows droop over mossy graves. Their branches move like skeletal fingers in the wind.",
                sound: 'haunted_woods',
                exits: { n: 7, s: null, e: 1, w: 8 },
                items: ['willow_branch'],
                npc: 'tree_spirit',
                enemy: null,
                container: 'hollow_tree',
                puzzle: 'willow_whisper',
                dark: true,
                locked: false,
                trap: 'grasping_roots',
                secret: null
            },
            { // Room 5: Mausoleum Interior
                id: 5,
                name: "MAUSOLEUM INTERIOR",
                desc: "Dusty coffins line marble walls. A chill fills the air, and whispers echo from the corners.",
                sound: 'mausoleum',
                exits: { n: 9, s: 2, e: 6, w: 7 },
                items: ['funeral_urn'],
                npc: 'coffin_ghost',
                enemy: null,
                container: 'sarcophagus',
                puzzle: 'coffin_arrangement',
                dark: true,
                locked: false,
                trap: 'coffin_trap',
                secret: null
            },
            { // Room 6: Crypt Entrance
                id: 6,
                name: "CRYPT ENTRANCE",
                desc: "Stone steps descend into darkness. The air grows colder with each step downward.",
                sound: 'crypts',
                exits: { n: 10, s: 3, e: null, w: 5 },
                items: ['rusty_lantern'],
                npc: null,
                enemy: 'crypt_crawler',
                container: 'torch_sconce',
                puzzle: null,
                dark: true,
                locked: false,
                trap: 'crumbling_stairs',
                secret: null
            },
            { // Room 7: Sunken Graveyard
                id: 7,
                name: "SUNKEN GRAVEYARD",
                desc: "This section of the cemetery has sunk into the marsh. Coffins float in murky water.",
                sound: 'haunted_woods',
                exits: { n: 11, s: 4, e: 5, w: 12 },
                items: ['waterlogged_coffin_plank'],
                npc: 'drowned_spirit',
                enemy: null,
                container: 'floating_coffin',
                puzzle: 'sunken_path',
                dark: true,
                locked: false,
                trap: 'sinking_ground',
                secret: null
            },
            { // Room 8: Haunted Woods
                id: 8,
                name: "HAUNTED WOODS",
                desc: "Gnarled trees with faces in their bark. Eyes seem to watch from the shadows.",
                sound: 'haunted_woods',
                exits: { n: 12, s: null, e: 4, w: 13 },
                items: ['ghostly_moss'],
                npc: null,
                enemy: 'werewolf',
                container: 'wolf_den',
                puzzle: null,
                dark: true,
                locked: false,
                trap: 'snare_trap',
                secret: 'witch_circle'
            },
            { // Room 9: Family Crypt
                id: 9,
                name: "FAMILY CRYPT",
                desc: "A lavish crypt for a noble family. Marble statues of the deceased stare blankly.",
                sound: 'crypts',
                exits: { n: 14, s: 5, e: 10, w: 11 },
                items: ['silver_family_seal'],
                npc: 'noble_ghost',
                enemy: null,
                container: 'family_altar',
                puzzle: 'family_curse',
                dark: true,
                locked: false,
                trap: 'statue_curse',
                secret: null
            },
            { // Room 10: Bone Chamber
                id: 10,
                name: "BONE CHAMBER",
                desc: "Walls made entirely of skulls and bones. The floor is paved with rib cages.",
                sound: 'catacombs',
                exits: { n: 15, s: 6, e: null, w: 9 },
                items: ['polished_skull'],
                npc: 'bone_collector',
                enemy: null,
                container: 'bone_pile',
                puzzle: 'bone_pattern',
                dark: false,
                locked: false,
                trap: 'bone_cage',
                secret: 'bone_key'
            },
            { // Room 11: Marsh Crypt
                id: 11,
                name: "MARSH CRYPT",
                desc: "Water seeps through cracks in the walls. Algae-covered coffins float in ankle-deep water.",
                sound: 'crypts',
                exits: { n: 16, s: 7, e: 9, w: 17 },
                items: ['marsh_herb'],
                npc: null,
                enemy: 'marsh_ghoul',
                container: 'watery_coffin',
                puzzle: 'marsh_puzzle',
                dark: true,
                locked: false,
                trap: 'water_rise',
                secret: null
            },
            { // Room 12: Witch's Grove
                id: 12,
                name: "WITCH'S GROVE",
                desc: "Strange symbols carved into trees. A cauldron bubbles over a cold, blue fire.",
                sound: 'witch_coven',
                exits: { n: 17, s: 8, e: 7, w: 18 },
                items: ['witch_herb'],
                npc: 'grave_witch',
                enemy: null,
                container: 'witch_cauldron',
                puzzle: 'potion_brew',
                dark: false,
                locked: false,
                trap: 'hex_trap',
                secret: 'witch_scroll'
            },
            { // Room 13: Ancient Oak
                id: 13,
                name: "ANCIENT OAK",
                desc: "A massive, twisted oak tree with a doorway carved into its trunk. It seems to breathe.",
                sound: 'haunted_woods',
                exits: { n: 18, s: null, e: 8, w: 19 },
                items: ['acorn_charm'],
                npc: 'dryad_spirit',
                enemy: null,
                container: 'tree_hollow',
                puzzle: 'dryad_riddle',
                dark: false,
                locked: false,
                trap: 'tree_grasp',
                secret: null
            },
            { // Room 14: Noble Tomb
                id: 14,
                name: "NOBLE TOMB",
                desc: "The tomb of a vampire lord. Silver chains hold the coffin shut, but they are weakening.",
                sound: 'crypts',
                exits: { n: 20, s: 9, e: 15, w: 16 },
                items: ['silver_chain_link'],
                npc: null,
                enemy: 'vampire_spawn',
                container: 'vampire_coffin',
                puzzle: 'silver_chains',
                dark: true,
                locked: true,
                trap: 'vampire_bite',
                secret: null
            },
            { // Room 15: Ossuary
                id: 15,
                name: "OSSURY",
                desc: "A chapel dedicated to bones. Every surface is decorated with skeletal remains arranged artfully.",
                sound: 'catacombs',
                exits: { n: 21, s: 10, e: 22, w: 14 },
                items: ['bone_chalice'],
                npc: 'ossuary_priest',
                enemy: null,
                container: 'bone_altar',
                puzzle: 'bone_prayer',
                dark: true,
                locked: false,
                trap: 'bone_collapse',
                secret: 'holy_bone'
            },
            { // Room 16: Sunken Chapel
                id: 16,
                name: "SUNKEN CHAPEL",
                desc: "A chapel half-submerged in swamp water. Pews float, and the altar is underwater.",
                sound: 'crypts',
                exits: { n: 23, s: 11, e: 14, w: 24 },
                items: ['waterlogged_bible'],
                npc: 'drowned_priest',
                enemy: null,
                container: 'floating_pew',
                puzzle: 'water_ritual',
                dark: true,
                locked: false,
                trap: 'undertow',
                secret: null
            },
            { // Room 17: Witch Coven
                id: 17,
                name: "WITCH COVEN",
                desc: "A circle of standing stones where witches gather. The air crackles with dark energy.",
                sound: 'witch_coven',
                exits: { n: 24, s: 12, e: 16, w: 25 },
                items: ['witch_wand'],
                npc: 'coven_leader',
                enemy: null,
                container: 'ritual_circle',
                puzzle: 'coven_ritual',
                dark: false,
                locked: false,
                trap: 'witch_curse',
                secret: 'coven_tome'
            },
            { // Room 18: Spirit Grove
                id: 18,
                name: "SPIRIT GROVE",
                desc: "A grove where spirits manifest as will-o-wisps. They dance between the trees.",
                sound: 'haunted_woods',
                exits: { n: 25, s: 13, e: 17, w: 26 },
                items: ['spirit_essence'],
                npc: 'wisp_collector',
                enemy: null,
                container: 'spirit_pool',
                puzzle: 'wisp_capture',
                dark: false,
                locked: false,
                trap: 'spirit_drain',
                secret: null
            },
            { // Room 19: Forest Crypt
                id: 19,
                name: "FOREST CRYPT",
                desc: "A crypt overgrown with roots and vines. Trees have broken through the roof.",
                sound: 'haunted_woods',
                exits: { n: 26, s: null, e: 13, w: 27 },
                items: ['root_bound_skull'],
                npc: null,
                enemy: 'root_monster',
                container: 'root_coffin',
                puzzle: 'root_puzzle',
                dark: true,
                locked: false,
                trap: 'grasping_vines',
                secret: 'forest_treasure'
            },
            { // Room 20: Vampire Crypt
                id: 20,
                name: "VAMPIRE CRYPT",
                desc: "The resting place of the vampire lord. His coffin is empty - he walks tonight.",
                sound: 'crypts',
                exits: { n: 28, s: 14, e: 21, w: 23 },
                items: ['vampire_dust'],
                npc: null,
                enemy: 'vampire_lord',
                container: 'vampire_throne',
                puzzle: 'sunlight_reflection',
                dark: true,
                locked: true,
                trap: 'blood_drain',
                secret: null
            },
            { // Room 21: Catacomb Crossroads
                id: 21,
                name: "CATACOMB CROSSROADS",
                desc: "Intersection of multiple bone-lined tunnels. Whispers seem to come from all directions.",
                sound: 'catacombs',
                exits: { n: 29, s: 15, e: 22, w: 20 },
                items: ['catacomb_map_fragment'],
                npc: 'lost_explorer_ghost',
                enemy: null,
                container: 'map_table',
                puzzle: 'catacomb_navigation',
                dark: true,
                locked: false,
                trap: 'collapsing_tunnel',
                secret: 'secret_tunnel'
            },
            { // Room 22: Executioner's Tomb
                id: 22,
                name: "EXECUTIONER'S TOMB",
                desc: "A massive tomb housing an executioner and his tools. The axe still looks sharp.",
                sound: 'catacombs',
                exits: { n: 30, s: null, e: null, w: 21 },
                items: ['executioner_axe'],
                npc: null,
                enemy: 'executioner_ghost',
                container: 'tool_rack',
                puzzle: 'executioner_justice',
                dark: true,
                locked: false,
                trap: 'guillotine_trap',
                secret: null
            },
            { // Room 23: Flooded Crypts
                id: 23,
                name: "FLOODED CRYPTS",
                desc: "Crypts completely underwater. You need to hold your breath to explore.",
                sound: 'crypts',
                exits: { n: 31, s: 16, e: 20, w: 32 },
                items: ['water_breathing_charm'],
                npc: 'water_spirit',
                enemy: null,
                container: 'sunken_treasure',
                puzzle: 'underwater_path',
                dark: true,
                locked: false,
                trap: 'drowning_risk',
                secret: 'sunken_relic'
            },
            { // Room 24: Ritual Chamber
                id: 24,
                name: "RITUAL CHAMBER",
                desc: "A chamber used for dark rituals. Blood stains the floor in intricate patterns.",
                sound: 'witch_coven',
                exits: { n: 32, s: 17, e: 23, w: 33 },
                items: ['ritual_dagger'],
                npc: 'ritual_master',
                enemy: null,
                container: 'ritual_table',
                puzzle: 'ritual_completion',
                dark: true,
                locked: false,
                trap: 'sacrificial_trap',
                secret: 'dark_artifact'
            },
            { // Room 25: Ghost Gathering
                id: 25,
                name: "GHOST GATHERING",
                desc: "A clearing where spirits gather. Their mournful songs fill the air.",
                sound: 'haunted_woods',
                exits: { n: 33, s: 18, e: 24, w: 34 },
                items: ['ectoplasm'],
                npc: 'ghost_choir',
                enemy: null,
                container: 'spirit_well',
                puzzle: 'ghost_song',
                dark: false,
                locked: false,
                trap: 'possession_risk',
                secret: null
            },
            { // Room 26: Ancient Burial Mound
                id: 26,
                name: "ANCIENT BURIAL MOUND",
                desc: "A prehistoric burial mound. Primitive artifacts and bones are scattered about.",
                sound: 'haunted_woods',
                exits: { n: 34, s: 19, e: 25, w: 35 },
                items: ['primitive_amulet'],
                npc: 'ancient_shaman',
                enemy: null,
                container: 'burial_pit',
                puzzle: 'ancestor_offering',
                dark: true,
                locked: false,
                trap: 'ancestor_curse',
                secret: 'shaman_staff'
            },
            { // Room 27: Plague Pit
                id: 27,
                name: "PLAGUE PIT",
                desc: "A mass grave from a plague outbreak. The air is thick with disease and despair.",
                sound: 'crypts',
                exits: { n: 35, s: null, e: 19, w: 36 },
                items: ['plague_doctor_mask'],
                npc: null,
                enemy: 'plague_zombie',
                container: 'plague_victim_pile',
                puzzle: 'plague_cure',
                dark: true,
                locked: false,
                trap: 'disease_cloud',
                secret: null
            },
            { // Room 28: Clock Tower Crypt
                id: 28,
                name: "CLOCK TOWER CRYPT",
                desc: "A crypt with a massive clock mechanism. It chimes the hour of death.",
                sound: 'crypts',
                exits: { n: 36, s: 20, e: 29, w: 31 },
                items: ['clockwork_gear'],
                npc: 'clockwork_ghost',
                enemy: null,
                container: 'clock_mechanism',
                puzzle: 'death_hour',
                dark: true,
                locked: false,
                trap: 'clockwork_trap',
                secret: 'time_key'
            },
            { // Room 29: Labyrinth Entrance
                id: 29,
                name: "LABYRINTH ENTRANCE",
                desc: "The entrance to a hedge maze filled with graves. Paths twist and turn confusingly.",
                sound: 'haunted_woods',
                exits: { n: 37, s: 21, e: 30, w: 28 },
                items: ['maze_map'],
                npc: 'maze_keeper',
                enemy: null,
                container: 'maze_center',
                puzzle: 'labyrinth_navigation',
                dark: true,
                locked: false,
                trap: 'dead_end_trap',
                secret: 'maze_treasure'
            },
            { // Room 30: Gargoyle Perch
                id: 30,
                name: "GARGOYLE PERCH",
                desc: "Stone gargoyles line the walls, some come to life at night.",
                sound: 'mausoleum',
                exits: { n: null, s: 22, e: null, w: 29 },
                items: ['gargoyle_wing_fragment'],
                npc: null,
                enemy: 'gargoyle_swarm',
                container: 'gargoyle_nest',
                puzzle: 'gargoyle_stillness',
                dark: true,
                locked: false,
                trap: 'gargoyle_attack',
                secret: null
            },
            { // Room 31: Underground River
                id: 31,
                name: "UNDERGROUND RIVER",
                desc: "A river flows through the crypts. Ghostly faces appear in the water.",
                sound: 'crypts',
                exits: { n: 38, s: 23, e: 28, w: null },
                items: ['river_pearl'],
                npc: 'river_ghost',
                enemy: null,
                container: 'riverbank',
                puzzle: 'river_crossing',
                dark: true,
                locked: false,
                trap: 'current_pull',
                secret: 'river_treasure'
            },
            { // Room 32: Alchemy Lab
                id: 32,
                name: "ALCHEMY LAB",
                desc: "An underground laboratory for dark experiments. Strange potions bubble in beakers.",
                sound: 'witch_coven',
                exits: { n: null, s: 24, e: 31, w: 33 },
                items: ['elixir_of_life'],
                npc: 'mad_alchemist',
                enemy: null,
                container: 'alchemy_table',
                puzzle: 'potion_creation',
                dark: false,
                locked: false,
                trap: 'explosive_concoction',
                secret: 'philosopher_stone'
            },
            { // Room 33: SÃ©ance Room
                id: 33,
                name: "SÃ‰ANCE ROOM",
                desc: "A room for contacting the dead. A ouija board sits on a round table.",
                sound: 'witch_coven',
                exits: { n: null, s: 25, e: 32, w: 34 },
                items: ['ouija_planchette'],
                npc: 'medium_ghost',
                enemy: null,
                container: 'spirit_cabinet',
                puzzle: 'spirit_communication',
                dark: true,
                locked: false,
                trap: 'evil_spirit',
                secret: null
            },
            { // Room 34: Druid Circle
                id: 34,
                name: "DRUID CIRCLE",
                desc: "Ancient standing stones arranged in a circle. They hum with primal energy.",
                sound: 'haunted_woods',
                exits: { n: null, s: 26, e: 33, w: 35 },
                items: ['druid_staff'],
                npc: 'druid_ghost',
                enemy: null,
                container: 'stone_altar',
                puzzle: 'druid_ritual',
                dark: false,
                locked: false,
                trap: 'nature_wrath',
                secret: 'druid_treasure'
            },
            { // Room 35: Mass Grave
                id: 35,
                name: "MASS GRAVE",
                desc: "A pit filled with countless bones. The ground seems to shift with restless spirits.",
                sound: 'catacombs',
                exits: { n: null, s: 27, e: 34, w: 36 },
                items: ['mass_grave_token'],
                npc: null,
                enemy: 'bone_army',
                container: 'grave_edge',
                puzzle: 'mass_blessing',
                dark: true,
                locked: false,
                trap: 'sinkhole',
                secret: null
            },
            { // Room 36: Gate of Souls
                id: 36,
                name: "GATE OF SOULS",
                desc: "A massive gate that separates the living from the dead. It glows with spectral energy.",
                sound: 'escape_theme',
                exits: { n: 39, s: 28, e: 35, w: 37 },
                items: ['soul_key_fragment'],
                npc: 'gate_guardian',
                enemy: null,
                container: 'gate_mechanism',
                puzzle: 'soul_gate',
                dark: false,
                locked: true,
                trap: 'soul_drain',
                secret: null
            },
            { // Room 37: Labyrinth Heart
                id: 37,
                name: "LABYRINTH HEART",
                desc: "The center of the hedge maze. A fountain of black water bubbles here.",
                sound: 'haunted_woods',
                exits: { n: null, s: 29, e: 36, w: 38 },
                items: ['black_water_vial'],
                npc: 'fountain_spirit',
                enemy: null,
                container: 'fountain_base',
                puzzle: 'fountain_riddle',
                dark: true,
                locked: false,
                trap: 'fountain_trap',
                secret: 'labyrinth_heart'
            },
            { // Room 38: Crypt of the Founder
                id: 38,
                name: "CRYPT OF THE FOUNDER",
                desc: "The oldest crypt in the graveyard. The founder's ghost guards his treasures.",
                sound: 'crypts',
                exits: { n: null, s: 31, e: 37, w: null },
                items: ['founder_medallion'],
                npc: 'founder_ghost',
                enemy: null,
                container: 'founder_coffin',
                puzzle: 'founder_test',
                dark: true,
                locked: true,
                trap: 'founder_curse',
                secret: 'graveyard_deed'
            },
            { // Room 39: ESCAPE BRIDGE
                id: 39,
                name: "ESCAPE BRIDGE",
                desc: "A bridge over a chasm, leading out of the graveyard. The living world awaits on the other side!",
                sound: 'escape_theme',
                exits: { n: null, s: 36, e: null, w: null },
                items: [],
                npc: null,
                enemy: 'final_specter',
                container: null,
                puzzle: 'final_escape',
                dark: false,
                locked: true,
                trap: null,
                secret: null
            }
        ];

        // ==================== GRAVEYARD ITEMS ====================
        const items = {
            // Starting items
            silver_dagger: {
                name: "Silver Dagger",
                desc: "A dagger made of pure silver. Effective against supernatural creatures.",
                type: "weapon",
                damage: 8,
                value: 50,
                keywords: ["dagger", "silver dagger", "weapon"]
            },
            holy_symbol: {
                name: "Holy Symbol",
                desc: "A religious symbol that glows in the presence of evil.",
                type: "tool",
                usable: true,
                effect: "repels undead, lights dark areas",
                value: 40,
                keywords: ["symbol", "holy symbol", "holy"]
            },
            lockpick: {
                name: "Lockpick Set",
                desc: "Tools for picking locks. Essential for a grave robber.",
                type: "tool",
                usable: true,
                effect: "opens some locks",
                value: 25,
                keywords: ["lockpick", "lockpicks", "tool"]
            },
            skeleton_key: {
                name: "Skeleton Key",
                desc: "An ornate key that can open many simple locks.",
                type: "key",
                value: 30,
                keywords: ["key", "skeleton key"]
            },
            necronomicon_page: {
                name: "Necronomicon Page",
                desc: "A page from the forbidden book. Contains dark incantations.",
                type: "consumable",
                usable: true,
                effect: "summons minor spirit (20 damage)",
                value: 60,
                keywords: ["page", "necronomicon", "spell"]
            },
            witch_herb: {
                name: "Witch Herb",
                desc: "A rare herb used in occult rituals. Restores magical energy.",
                type: "consumable",
                usable: true,
                effect: "restores 20 MP",
                value: 35,
                keywords: ["herb", "witch herb", "magic"]
            },
            
            // Common graveyard items
            iron_gate_shard: {
                name: "Iron Gate Shard",
                desc: "A sharp piece of the rusted entrance gate.",
                type: "weapon",
                damage: 6,
                value: 10,
                keywords: ["shard", "iron shard", "weapon"]
            },
            wooden_stake: {
                name: "Wooden Stake",
                desc: "A sharpened wooden stake. Classic vampire hunting tool.",
                type: "weapon",
                damage: 7,
                value: 15,
                keywords: ["stake", "wooden stake", "weapon"]
            },
            stone_skull_fragment: {
                name: "Stone Skull Fragment",
                desc: "A piece of a decorative stone skull from the mausoleum.",
                type: "component",
                value: 20,
                keywords: ["skull", "stone skull", "fragment"]
            },
            holy_water: {
                name: "Holy Water",
                desc: "Water blessed by a priest. Burns undead.",
                type: "consumable",
                usable: true,
                effect: "damages undead (25 damage)",
                value: 40,
                keywords: ["water", "holy water", "holy"]
            },
            willow_branch: {
                name: "Weeping Willow Branch",
                desc: "A branch from a weeping willow. Said to have mystical properties.",
                type: "component",
                value: 15,
                keywords: ["branch", "willow branch"]
            },
            funeral_urn: {
                name: "Funeral Urn",
                desc: "A clay urn containing ancient ashes.",
                type: "container",
                value: 25,
                keywords: ["urn", "funeral urn", "ashes"]
            },
            rusty_lantern: {
                name: "Rusty Lantern",
                desc: "An old lantern that still works. Provides light in darkness.",
                type: "tool",
                usable: true,
                effect: "lights dark areas",
                value: 20,
                keywords: ["lantern", "rusty lantern", "light"]
            },
            waterlogged_coffin_plank: {
                name: "Waterlogged Coffin Plank",
                desc: "A piece of coffin that has been soaked in swamp water.",
                type: "component",
                value: 5,
                keywords: ["plank", "coffin plank", "wood"]
            },
            ghostly_moss: {
                name: "Ghostly Moss",
                desc: "Moss that glows with a faint blue light in the dark.",
                type: "component",
                value: 18,
                keywords: ["moss", "ghostly moss"]
            },
            silver_family_seal: {
                name: "Silver Family Seal",
                desc: "A noble family's seal made of silver.",
                type: "treasure",
                value: 80,
                keywords: ["seal", "silver seal", "family seal"]
            },
            polished_skull: {
                name: "Polished Skull",
                desc: "A human skull polished to a shine. Could be valuable or useful.",
                type: "component",
                value: 35,
                keywords: ["skull", "polished skull"]
            },
            marsh_herb: {
                name: "Marsh Herb",
                desc: "A medicinal herb that grows in marshes. Restores health.",
                type: "consumable",
                usable: true,
                effect: "restores 15 HP",
                value: 25,
                keywords: ["herb", "marsh herb", "heal"]
            },
            acorn_charm: {
                name: "Acorn Charm",
                desc: "An acorn carved with protective runes.",
                type: "artifact",
                value: 45,
                keywords: ["acorn", "charm", "acorn charm"]
            },
            silver_chain_link: {
                name: "Silver Chain Link",
                desc: "A link from silver chains used to bind vampires.",
                type: "component",
                value: 30,
                keywords: ["chain", "silver chain", "link"]
            },
            bone_chalice: {
                name: "Bone Chalice",
                desc: "A drinking cup made from a human skull.",
                type: "artifact",
                value: 60,
                keywords: ["chalice", "bone chalice"]
            },
            waterlogged_bible: {
                name: "Waterlogged Bible",
                desc: "A holy book damaged by water. Some pages are still readable.",
                type: "document",
                value: 20,
                keywords: ["bible", "waterlogged bible", "book"]
            },
            witch_wand: {
                name: "Witch Wand",
                desc: "A wand carved from yew wood. Used to focus magical energy.",
                type: "weapon",
                damage: 12,
                value: 70,
                keywords: ["wand", "witch wand", "weapon"]
            },
            spirit_essence: {
                name: "Spirit Essence",
                desc: "A glowing vial containing captured spirit energy.",
                type: "consumable",
                usable: true,
                effect: "restores 30 MP",
                value: 50,
                keywords: ["essence", "spirit essence", "magic"]
            },
            root_bound_skull: {
                name: "Root-Bound Skull",
                desc: "A skull entangled in tree roots.",
                type: "component",
                value: 25,
                keywords: ["skull", "root skull"]
            },
            vampire_dust: {
                name: "Vampire Dust",
                desc: "The remains of a destroyed vampire.",
                type: "component",
                value: 90,
                keywords: ["dust", "vampire dust"]
            },
            catacomb_map_fragment: {
                name: "Catacomb Map Fragment",
                desc: "Part of a map showing the catacomb layout.",
                type: "document",
                value: 35,
                keywords: ["map", "catacomb map", "fragment"]
            },
            executioner_axe: {
                name: "Executioner's Axe",
                desc: "A massive, heavy axe used for executions.",
                type: "weapon",
                damage: 16,
                value: 85,
                keywords: ["axe", "executioner axe", "weapon"]
            },
            water_breathing_charm: {
                name: "Water Breathing Charm",
                desc: "A charm that allows temporary underwater breathing.",
                type: "consumable",
                usable: true,
                effect: "breathe underwater for 5 minutes",
                value: 55,
                keywords: ["charm", "water breathing", "breathing"]
            },
            ritual_dagger: {
                name: "Ritual Dagger",
                desc: "A dagger used in dark rituals. Glows with dark energy.",
                type: "weapon",
                damage: 10,
                value: 65,
                keywords: ["dagger", "ritual dagger", "weapon"]
            },
            ectoplasm: {
                name: "Ectoplasm",
                desc: "A sticky, glowing substance left by spirits.",
                type: "component",
                value: 40,
                keywords: ["ectoplasm", "ghost substance"]
            },
            primitive_amulet: {
                name: "Primitive Amulet",
                desc: "A simple amulet from ancient times.",
                type: "artifact",
                value: 55,
                keywords: ["amulet", "primitive amulet"]
            },
            plague_doctor_mask: {
                name: "Plague Doctor Mask",
                desc: "A beaked mask worn by plague doctors.",
                type: "armor",
                defense: 2,
                value: 45,
                keywords: ["mask", "plague mask", "armor"]
            },
            clockwork_gear: {
                name: "Clockwork Gear",
                desc: "A gear from a clockwork mechanism.",
                type: "component",
                value: 30,
                keywords: ["gear", "clockwork gear"]
            },
            maze_map: {
                name: "Maze Map",
                desc: "A map of the hedge maze.",
                type: "document",
                value: 40,
                keywords: ["map", "maze map"]
            },
            gargoyle_wing_fragment: {
                name: "Gargoyle Wing Fragment",
                desc: "A piece of stone wing from a gargoyle.",
                type: "component",
                value: 20,
                keywords: ["gargoyle", "wing fragment"]
            },
            river_pearl: {
                name: "River Pearl",
                desc: "A perfect pearl from the underground river.",
                type: "treasure",
                value: 75,
                keywords: ["pearl", "river pearl"]
            },
            elixir_of_life: {
                name: "Elixir of Life",
                desc: "A potion that restores health and cures ailments.",
                type: "consumable",
                usable: true,
                effect: "restores 50 HP and cures poison",
                value: 100,
                keywords: ["elixir", "life elixir", "heal"]
            },
            ouija_planchette: {
                name: "Ouija Planchette",
                desc: "The pointer from a spirit board.",
                type: "tool",
                usable: true,
                effect: "communicate with spirits",
                value: 35,
                keywords: ["ouija", "planchette", "spirit"]
            },
            druid_staff: {
                name: "Druid Staff",
                desc: "A wooden staff carved with druidic symbols.",
                type: "weapon",
                damage: 14,
                value: 80,
                keywords: ["staff", "druid staff", "weapon"]
            },
            mass_grave_token: {
                name: "Mass Grave Token",
                desc: "A token left on a mass grave to honor the dead.",
                type: "artifact",
                value: 30,
                keywords: ["token", "grave token"]
            },
            soul_key_fragment: {
                name: "Soul Key Fragment",
                desc: "Part of a key needed to open the Gate of Souls.",
                type: "key",
                value: 120,
                keywords: ["key", "soul key", "fragment"]
            },
            black_water_vial: {
                name: "Black Water Vial",
                desc: "A vial of water from the black fountain.",
                type: "consumable",
                usable: true,
                effect: "grants dark vision temporarily",
                value: 45,
                keywords: ["vial", "black water", "water"]
            },
            founder_medallion: {
                name: "Founder's Medallion",
                desc: "A medallion belonging to the graveyard's founder.",
                type: "artifact",
                value: 150,
                keywords: ["medallion", "founder medallion"]
            },
            
            // Special items
            master_key: {
                name: "Master Key",
                desc: "A key that can open any lock in the graveyard.",
                type: "key",
                value: 200,
                keywords: ["key", "master key"]
            },
            ghost_cloak: {
                name: "Ghost Cloak",
                desc: "A cloak that makes the wearer partially invisible to undead.",
                type: "armor",
                defense: 3,
                value: 180,
                keywords: ["cloak", "ghost cloak", "armor"]
            },
            spectral_blade: {
                name: "Spectral Blade",
                desc: "A blade that can harm both physical and spiritual beings.",
                type: "weapon",
                damage: 22,
                value: 220,
                keywords: ["blade", "spectral blade", "weapon"]
            },
            necronomicon_complete: {
                name: "Complete Necronomicon",
                desc: "The complete forbidden book of the dead.",
                type: "artifact",
                value: 300,
                keywords: ["necronomicon", "book", "complete"]
            }
        };

        // ==================== GRAVEYARD NPCS ====================
        const npcs = {
            mourning_ghost: {
                name: "Mourning Ghost",
                desc: "The ghost of a woman weeping at a grave.",
                dialog: "My child... buried here centuries ago... Have you seen a locket?",
                quest: {
                    given: false,
                    completed: false,
                    type: "find",
                    target: "silver_locket",
                    reward: "holy_water"
                },
                trade: null
            },
            priest_ghost: {
                name: "Priest Ghost",
                desc: "The ghost of a priest still tending his chapel.",
                dialog: "This place is cursed! The dead walk! Help me perform a blessing.",
                quest: {
                    given: false,
                    completed: false,
                    type: "assist",
                    target: "blessing_ritual",
                    reward: "holy_symbol"
                },
                trade: null
            },
            tree_spirit: {
                name: "Weeping Willow Spirit",
                desc: "A spirit bound to the ancient willow tree.",
                dialog: "The trees remember all the deaths here... Listen to their whispers...",
                quest: {
                    given: false,
                    completed: false,
                    type: "listen",
                    target: "tree_whispers",
                    reward: "willow_branch"
                },
                trade: null
            },
            coffin_ghost: {
                name: "Coffin Ghost",
                desc: "A ghost bound to its coffin in the mausoleum.",
                dialog: "I cannot rest until my coffin is arranged properly with my family...",
                quest: {
                    given: false,
                    completed: false,
                    type: "arrange",
                    target: "coffin_order",
                    reward: "funeral_urn"
                },
                trade: null
            },
            drowned_spirit: {
                name: "Drowned Spirit",
                desc: "A spirit that drowned in the marsh.",
                dialog: "The water rises... always rises... Find the dry path through the marsh.",
                quest: {
                    given: false,
                    completed: false,
                    type: "navigate",
                    target: "marsh_path",
                    reward: "water_breathing_charm"
                },
                trade: null
            },
            grave_witch: {
                name: "Grave Witch",
                desc: "A witch who practices magic in the graveyard.",
                dialog: "Ingredients for my potions... Bring me ghostly moss and a willow branch.",
                quest: {
                    given: false,
                    completed: false,
                    type: "give",
                    target: ["ghostly_moss", "willow_branch"],
                    reward: "witch_wand"
                },
                trade: {
                    buy: ["witch_herb", "ritual_dagger"],
                    sell: true
                }
            },
            dryad_spirit: {
                name: "Dryad Spirit",
                desc: "A tree spirit bound to the ancient oak.",
                dialog: "Answer my riddle to pass: I speak without a mouth and hear without ears. What am I?",
                quest: {
                    given: false,
                    completed: false,
                    type: "riddle",
                    question: "I speak without a mouth and hear without ears. What am I?",
                    answer: "echo",
                    reward: "acorn_charm"
                },
                trade: null
            },
            bone_collector: {
                name: "Bone Collector",
                desc: "A strange being that collects and arranges bones.",
                dialog: "The bones must be arranged in the pattern of the constellation...",
                quest: {
                    given: false,
                    completed: false,
                    type: "arrange",
                    target: "bone_constellation",
                    reward: "bone_chalice"
                },
                trade: null
            },
            ossuary_priest: {
                name: "Ossuary Priest",
                desc: "A priest who tends the bone chapel.",
                dialog: "Recite the prayer for the dead with me... 'Requiem aeternam dona eis, Domine'...",
                quest: {
                    given: false,
                    completed: false,
                    type: "recite",
                    target: "prayer_for_dead",
                    reward: "holy_water"
                },
                trade: null
            },
            drowned_priest: {
                name: "Drowned Priest",
                desc: "A priest who drowned in the flooded chapel.",
                dialog: "The holy water must be mixed with river water for the ritual...",
                quest: {
                    given: false,
                    completed: false,
                    type: "mix",
                    target: ["holy_water", "river_water"],
                    reward: "blessed_water"
                },
                trade: null
            },
            coven_leader: {
                name: "Coven Leader",
                desc: "The leader of the witch coven.",
                dialog: "Join our circle for the ritual! Bring a ritual dagger and witch herb.",
                quest: {
                    given: false,
                    completed: false,
                    type: "participate",
                    target: "coven_ritual",
                    reward: "dark_power"
                },
                trade: {
                    buy: ["witch_wand", "necronomicon_page"],
                    sell: true
                }
            },
            wisp_collector: {
                name: "Wisp Collector",
                desc: "A ghost who collects will-o-wisps.",
                dialog: "Capture three wisps for me with this jar... Be quick, they're elusive!",
                quest: {
                    given: false,
                    completed: false,
                    type: "capture",
                    target: "three_wisps",
                    reward: "spirit_essence"
                },
                trade: null
            },
            lost_explorer_ghost: {
                name: "Lost Explorer Ghost",
                desc: "The ghost of an explorer who died in the catacombs.",
                dialog: "I was mapping the catacombs when I died... Help me complete my map.",
                quest: {
                    given: false,
                    completed: false,
                    type: "explore",
                    target: "map_catacombs",
                    reward: "catacomb_map_fragment"
                },
                trade: null
            },
            water_spirit: {
                name: "Water Spirit",
                desc: "A spirit of the underground river.",
                dialog: "Cross my river by stepping on the stones in the correct order...",
                quest: {
                    given: false,
                    completed: false,
                    type: "cross",
                    target: "river_stones",
                    reward: "river_pearl"
                },
                trade: null
            },
            ritual_master: {
                name: "Ritual Master",
                desc: "A master of dark rituals.",
                dialog: "Complete the blood ritual circle by placing offerings at each point...",
                quest: {
                    given: false,
                    completed: false,
                    type: "complete",
                    target: "blood_ritual",
                    reward: "ritual_dagger"
                },
                trade: null
            },
            ghost_choir: {
                name: "Ghost Choir",
                desc: "A group of singing ghosts.",
                dialog: "Join our song! The melody is: high, low, high, middle, low...",
                quest: {
                    given: false,
                    completed: false,
                    type: "sing",
                    target: "ghost_melody",
                    reward: "ectoplasm"
                },
                trade: null
            },
            ancient_shaman: {
                name: "Ancient Shaman",
                desc: "A prehistoric shaman's spirit.",
                dialog: "Make an offering to the ancestors... Place it in the burial pit.",
                quest: {
                    given: false,
                    completed: false,
                    type: "offer",
                    target: "ancestor_offering",
                    reward: "primitive_amulet"
                },
                trade: null
            },
            clockwork_ghost: {
                name: "Clockwork Ghost",
                desc: "A ghost bound to the clock mechanism.",
                dialog: "Set the clock to the hour of my death... It was midnight...",
                quest: {
                    given: false,
                    completed: false,
                    type: "set",
                    target: "midnight",
                    reward: "clockwork_gear"
                },
                trade: null
            },
            maze_keeper: {
                name: "Maze Keeper",
                desc: "The ghost of the maze's gardener.",
                dialog: "Take the correct path: left, right, straight, left, right...",
                quest: {
                    given: false,
                    completed: false,
                    type: "navigate",
                    target: "maze_path",
                    reward: "maze_map"
                },
                trade: null
            },
            river_ghost: {
                name: "River Ghost",
                desc: "A ghost who haunts the river.",
                dialog: "Find what was lost in the river... My wedding ring...",
                quest: {
                    given: false,
                    completed: false,
                    type: "find",
                    target: "wedding_ring",
                    reward: "river_treasure"
                },
                trade: null
            },
            mad_alchemist: {
                name: "Mad Alchemist",
                desc: "An alchemist who went insane experimenting.",
                dialog: "The formula! I need marsh herb and spirit essence for the elixir!",
                quest: {
                    given: false,
                    completed: false,
                    type: "brew",
                    target: ["marsh_herb", "spirit_essence"],
                    reward: "elixir_of_life"
                },
                trade: {
                    buy: ["elixir_of_life", "water_breathing_charm"],
                    sell: true
                }
            },
            medium_ghost: {
                name: "Medium Ghost",
                desc: "A ghost who was a medium in life.",
                dialog: "Use the ouija board to contact the other side... Ask the right questions...",
                quest: {
                    given: false,
                    completed: false,
                    type: "contact",
                    target: "spirit_contact",
                    reward: "ouija_planchette"
                },
                trade: null
            },
            druid_ghost: {
                name: "Druid Ghost",
                desc: "A druid's spirit bound to the stone circle.",
                dialog: "Perform the ancient ritual at each stone in the correct order...",
                quest: {
                    given: false,
                    completed: false,
                    type: "perform",
                    target: "druid_ritual",
                    reward: "druid_staff"
                },
                trade: null
            },
            gate_guardian: {
                name: "Gate Guardian",
                desc: "The guardian of the Gate of Souls.",
                dialog: "To pass, you must prove you understand life and death... Answer my questions...",
                quest: {
                    given: false,
                    completed: false,
                    type: "answer",
                    target: "life_death_questions",
                    reward: "soul_key_fragment"
                },
                trade: null
            },
            fountain_spirit: {
                name: "Fountain Spirit",
                desc: "The spirit of the black water fountain.",
                dialog: "Drink from the fountain if you dare... Or answer my riddle instead...",
                quest: {
                    given: false,
                    completed: false,
                    type: "riddle",
                    question: "What belongs to you but others use it more than you do?",
                    answer: "name",
                    reward: "black_water_vial"
                },
                trade: null
            },
            founder_ghost: {
                name: "Founder's Ghost",
                desc: "The ghost of the graveyard's founder.",
                dialog: "I built this place to contain the dead... Now prove you're worthy to leave.",
                quest: {
                    given: false,
                    completed: false,
                    type: "prove",
                    target: "founder_test",
                    reward: "founder_medallion"
                },
                trade: null
            }
        };

        // ==================== GRAVEYARD ENEMIES ====================
        const enemies = {
            gatekeeper_ghoul: {
                name: "Gatekeeper Ghoul",
                hp: 40,
                damage: 9,
                desc: "A ghoul that guards the cemetery gates. Hungry for fresh meat.",
                weak: "silver",
                loot: ["iron_gate_shard"],
                sound: 'main_theme'
            },
            stone_gargoyle: {
                name: "Stone Gargoyle",
                hp: 55,
                damage: 12,
                desc: "A gargoyle that comes to life at night. Stone-hard and relentless.",
                weak: "blunt",
                loot: ["stone_skull_fragment"],
                sound: 'mausoleum'
            },
            crypt_crawler: {
                name: "Crypt Crawler",
                hp: 35,
                damage: 8,
                desc: "A creature that lives in crypts. Fast and nimble in the dark.",
                weak: "light",
                loot: ["rusty_lantern"],
                sound: 'crypts'
            },
            werewolf: {
                name: "Werewolf",
                hp: 65,
                damage: 15,
                desc: "A man transformed into a wolf-like beast by the full moon.",
                weak: "silver",
                loot: ["wolf_pelt"],
                sound: 'haunted_woods'
            },
            marsh_ghoul: {
                name: "Marsh Ghoul",
                hp: 50,
                damage: 11,
                desc: "A ghoul that lurks in the marshes. Covered in algae and mud.",
                weak: "fire",
                loot: ["marsh_herb"],
                sound: 'crypts'
            },
            vampire_spawn: {
                name: "Vampire Spawn",
                hp: 70,
                damage: 14,
                desc: "A newly created vampire. Hungry for blood and violent.",
                weak: "wood",
                loot: ["silver_chain_link"],
                sound: 'crypts'
            },
            root_monster: {
                name: "Root Monster",
                hp: 60,
                damage: 13,
                desc: "A creature made of animated roots and vines.",
                weak: "axe",
                loot: ["root_bound_skull"],
                sound: 'haunted_woods'
            },
            vampire_lord: {
                name: "Vampire Lord",
                hp: 120,
                damage: 20,
                desc: "An ancient vampire with powerful dark magic.",
                weak: "holy",
                loot: ["vampire_dust"],
                sound: 'crypts'
            },
            executioner_ghost: {
                name: "Executioner Ghost",
                hp: 85,
                damage: 18,
                desc: "The ghost of an executioner, still carrying his axe.",
                weak: "forgiveness",
                loot: ["executioner_axe"],
                sound: 'catacombs'
            },
            plague_zombie: {
                name: "Plague Zombie",
                hp: 45,
                damage: 10,
                desc: "A zombie created by plague. Infects with disease.",
                weak: "fire",
                loot: ["plague_doctor_mask"],
                sound: 'crypts'
            },
            gargoyle_swarm: {
                name: "Gargoyle Swarm",
                hp: 75,
                damage: 16,
                desc: "A swarm of small gargoyles that attack together.",
                weak: "area",
                loot: ["gargoyle_wing_fragment"],
                sound: 'mausoleum'
            },
            bone_army: {
                name: "Bone Army",
                hp: 90,
                damage: 19,
                desc: "Animated bones that rise from the mass grave.",
                weak: "holy",
                loot: ["mass_grave_token"],
                sound: 'catacombs'
            },
            final_specter: {
                name: "Final Specter",
                hp: 150,
                damage: 25,
                desc: "A powerful specter that guards the escape bridge.",
                weak: "all_weaknesses",
                loot: ["master_key"],
                sound: 'escape_theme'
            }
        };

        // ==================== GRAVEYARD PUZZLES ====================
        const puzzles = {
            open_gates: {
                room: 0,
                type: "defeat",
                description: "The gatekeeper ghoul blocks the entrance. Defeat it to enter the graveyard.",
                solution: "defeat gatekeeper_ghoul",
                solved: false,
                reward: "access"
            },
            mausoleum_lock: {
                room: 2,
                type: "unlock",
                description: "The mausoleum doors are locked. Find a key or pick the lock.",
                solution: "skeleton_key or lockpick",
                solved: false,
                reward: "access"
            },
            chapel_blessing: {
                room: 3,
                type: "perform",
                description: "The chapel needs to be blessed to cleanse the evil.",
                solution: "use holy_water on altar",
                solved: false,
                reward: "hidden_crypt"
            },
            willow_whisper: {
                room: 4,
                type: "listen",
                description: "Listen to the willow's whispers to learn the safe path.",
                solution: "listen to tree_spirit",
                solved: false,
                reward: "safe_path"
            },
            coffin_arrangement: {
                room: 5,
                type: "arrange",
                description: "Arrange the coffins in chronological order of death.",
                solution: "oldest to newest",
                solved: false,
                reward: "funeral_urn"
            },
            sunken_path: {
                room: 7,
                type: "navigate",
                description: "Find the safe path through the sunken graveyard.",
                solution: "follow floating_coffins",
                solved: false,
                reward: "access"
            },
            root_puzzle: {
                room: 19,
                type: "cut",
                description: "Cut through the roots blocking the way in the correct pattern.",
                solution: "cut pattern: X, O, X, O",
                solved: false,
                reward: "access"
            },
            sunlight_reflection: {
                room: 20,
                type: "reflect",
                description: "Use a mirror to reflect moonlight onto the vampire's coffin.",
                solution: "use polished_skull as mirror",
                solved: false,
                reward: "access"
            },
            catacomb_navigation: {
                room: 21,
                type: "navigate",
                description: "Navigate the catacombs using the map fragments.",
                solution: "follow map_directions",
                solved: false,
                reward: "access"
            },
            underwater_path: {
                room: 23,
                type: "breathe",
                description: "Find a way to breathe underwater to explore the flooded crypts.",
                solution: "use water_breathing_charm",
                solved: false,
                reward: "access"
            },
            ritual_completion: {
                room: 24,
                type: "complete",
                description: "Complete the dark ritual to proceed.",
                solution: "place ritual_dagger on altar",
                solved: false,
                reward: "access"
            },
            ghost_song: {
                room: 25,
                type: "sing",
                description: "Sing the correct melody with the ghost choir.",
                solution: "high, low, high, middle, low",
                solved: false,
                reward: "ectoplasm"
            },
            ancestor_offering: {
                room: 26,
                type: "offer",
                description: "Make an offering to the ancient ancestors.",
                solution: "place primitive_amulet in burial_pit",
                solved: false,
                reward: "access"
            },
            plague_cure: {
                room: 27,
                type: "cure",
                description: "Find or create a cure for the plague.",
                solution: "use elixir_of_life",
                solved: false,
                reward: "access"
            },
            death_hour: {
                room: 28,
                type: "set",
                description: "Set the clock to the hour of death.",
                solution: "set to midnight",
                solved: false,
                reward: "access"
            },
            labyrinth_navigation: {
                room: 29,
                type: "maze",
                description: "Navigate the hedge maze to reach the center.",
                solution: "follow maze_map",
                solved: false,
                reward: "maze_treasure"
            },
            gargoyle_stillness: {
                room: 30,
                type: "still",
                description: "Remain perfectly still until the gargoyles return to stone.",
                solution: "don't move for 30 seconds",
                solved: false,
                reward: "access"
            },
            river_crossing: {
                room: 31,
                type: "cross",
                description: "Cross the underground river safely.",
                solution: "use stepping_stones",
                solved: false,
                reward: "access"
            },
            potion_creation: {
                room: 32,
                type: "brew",
                description: "Brew the correct potion at the alchemy lab.",
                solution: "mix witch_herb and spirit_essence",
                solved: false,
                reward: "elixir_of_life"
            },
            spirit_communication: {
                room: 33,
                type: "communicate",
                description: "Use the ouija board to contact the spirits.",
                solution: "ask correct_questions",
                solved: false,
                reward: "access"
            },
            druid_ritual: {
                room: 34,
                type: "perform",
                description: "Perform the druid ritual at the stone circle.",
                solution: "circle stones clockwise",
                solved: false,
                reward: "access"
            },
            mass_blessing: {
                room: 35,
                type: "bless",
                description: "Bless the mass grave to calm the spirits.",
                solution: "use holy_water on grave",
                solved: false,
                reward: "access"
            },
            soul_gate: {
                room: 36,
                type: "unlock",
                description: "Unlock the Gate of Souls with the soul key fragments.",
                solution: "use three soul_key_fragments",
                solved: false,
                reward: "access"
            },
            fountain_riddle: {
                room: 37,
                type: "answer",
                description: "Answer the fountain spirit's riddle.",
                solution: "answer is 'name'",
                solved: false,
                reward: "black_water_vial"
            },
            founder_test: {
                room: 38,
                type: "prove",
                description: "Prove your worth to the founder's ghost.",
                solution: "show respect_for_dead",
                solved: false,
                reward: "founder_medallion"
            },
            final_escape: {
                room: 39,
                type: "escape",
                description: "Defeat the final specter and use the master key to unlock the bridge!",
                solution: "defeat final_specter then use master_key",
                solved: false,
                reward: "freedom",
                sound: 'victory'
            }
        };

        // ==================== GAME STATE ====================
        let player = {
            class: null,
            hp: 0,
            maxHp: 0,
            mp: 0,
            maxMp: 0,
            str: 0,
            def: 0,
            baseDef: 0,
            int: 0,
            gold: 0,
            inventory: [],
            equipped: {
                weapon: null,
                armor: null
            },
            baseDamage: 0,
            totalDamage: 0,
            totalDefense: 0,
            location: 0,
            inCombat: false,
            hasLight: false,
            time: "eternal night",
            stats: {
                enemiesDefeated: 0,
                puzzlesSolved: 0,
                roomsExplored: 0,
                secretsFound: 0,
                trapsSprung: 0
            }
        };

        let gameStarted = false;
        let currentBackground = 'main_theme';
        const soundSystem = new GothicSoundSystem();

        // ==================== HELPER FUNCTIONS ====================
        function findItemByName(itemName) {
            // First try exact match with item IDs
            if (items[itemName]) {
                return itemName;
            }
            
            // Try to match with item name (case-insensitive)
            itemName = itemName.toLowerCase();
            for (const itemId in items) {
                const item = items[itemId];
                if (item.name.toLowerCase() === itemName) {
                    return itemId;
                }
                
                // Try keywords
                if (item.keywords) {
                    for (const keyword of item.keywords) {
                        if (keyword.toLowerCase() === itemName) {
                            return itemId;
                        }
                    }
                }
                
                // Try partial match in name
                if (item.name.toLowerCase().includes(itemName)) {
                    return itemId;
                }
            }
            
            return null;
        }

        function calculatePlayerStats() {
            // Calculate base damage (strength + class modifier)
            player.baseDamage = player.str + 3;
            
            // Calculate total damage (base + weapon)
            player.totalDamage = player.baseDamage;
            if (player.equipped.weapon) {
                const weapon = items[player.equipped.weapon];
                if (weapon && weapon.damage) {
                    player.totalDamage += weapon.damage;
                }
            }
            
            // Calculate base defense (class base)
            player.baseDef = classes[player.class].def;
            
            // Calculate total defense (base + armor)
            player.totalDefense = player.baseDef;
            if (player.equipped.armor) {
                const armor = items[player.equipped.armor];
                if (armor && armor.defense) {
                    player.totalDefense += armor.defense;
                }
            }
            
            // Update status display
            updateStatus();
        }

        // ==================== UI FUNCTIONS ====================
        const output = document.getElementById('output');
        const input = document.getElementById('input');
        const status = document.getElementById('status');

        function print(text, className = '') {
            const line = document.createElement('div');
            line.textContent = text;
            if (className) line.className = className;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
            
            if (className === 'success' || className === 'quest') {
                soundSystem.playSound('notification', 0.5);
            } else if (className === 'error') {
                soundSystem.playSound('error', 0.3);
            } else if (className === 'puzzle') {
                soundSystem.playSound('puzzle', 0.4);
            } else if (className === 'secret') {
                soundSystem.playSound('secret', 0.5);
            } else if (className === 'trap') {
                soundSystem.playSound('trap', 0.6);
            } else if (className === 'ghost') {
                soundSystem.playSound('moan', 0.2);
            } else if (className === 'corpse') {
                soundSystem.playSound('crypt', 0.3);
            }
        }

        function updateStatus() {
            const room = rooms[player.location];
            const light = player.hasLight ? "LIT" : "DARK";
            
            // Get equipped weapon and armor names
            const weaponName = player.equipped.weapon ? items[player.equipped.weapon].name : "None";
            const armorName = player.equipped.armor ? items[player.equipped.armor].name : "None";
            
            status.textContent = 
                `HP:${player.hp}/${player.maxHp} MP:${player.mp}/${player.maxMp} ` +
                `DMG:${player.totalDamage} DEF:${player.totalDefense} ` +
                `GOLD:${player.gold} ROOM:${room.id} ${light}\n` +
                `Weapon: ${weaponName} | Armor: ${armorName}`;
        }

        // ==================== GAME LOGIC ====================
        function startGame(className) {
            player.class = className;
            const c = classes[className];
            
            player.hp = player.maxHp = c.hp;
            player.mp = player.maxMp = c.mp;
            player.str = c.str;
            player.def = c.def;
            player.int = c.int;
            player.gold = 0;
            
            // Starting items
            player.inventory = c.startingItems.map(item => item);
            
            // Check for light sources
            player.hasLight = c.startingItems.some(item => 
                item === 'holy_symbol' || item === 'rusty_lantern'
            );
            
            // Initialize equipment
            player.equipped.weapon = null;
            player.equipped.armor = null;
            
            gameStarted = true;
            soundSystem.playBackground(currentBackground);
            
            print(`You are a ${className.replace('_', ' ').toUpperCase()}. ${c.desc}`, 'success');
            
            // Display all starting items
            const itemNames = c.startingItems.map(itemId => items[itemId].name).join(', ');
            print(`You start with: ${itemNames}`, 'success');
            
            calculatePlayerStats();
            look();
            updateStatus();
        }

        function look() {
            const room = rooms[player.location];
            
            // Update music based on area
            if (room.sound !== currentBackground) {
                currentBackground = room.sound;
                soundSystem.playBackground(currentBackground);
            }
            
            // Ambient sounds
            if (room.sound === 'haunted_woods' && Math.random() > 0.7) {
                soundSystem.playSound('wind', 0.1);
            }
            if (room.sound === 'crypts' && Math.random() > 0.8) {
                soundSystem.playSound('moan', 0.2);
            }
            if (room.sound === 'witch_coven' && Math.random() > 0.6) {
                soundSystem.playSound('ritual', 0.15);
            }
            
            // Check darkness
            if (room.dark && !player.hasLight) {
                print("It's pitch black! You need a light source to see.", 'error');
                print("You can feel exits to: " + Object.keys(room.exits).filter(dir => room.exits[dir] !== null).join(' '));
                return;
            }
            
            print(`${room.name}:`, 'command');
            print(room.desc, 'system');
            
            // List items
            if (room.items.length > 0) {
                print("You see:", 'system');
                room.items.forEach(itemId => {
                    const item = items[itemId];
                    print(`  ${item.name}`, 'item');
                });
            }
            
            // List NPC
            if (room.npc) {
                const npc = npcs[room.npc];
                print(`${npc.name} is here. ${npc.desc}`, 'npc');
            }
            
            // List enemy
            if (room.enemy) {
                const enemy = enemies[room.enemy];
                print(`${enemy.name} blocks your path! ${enemy.desc}`, 'enemy');
            }
            
            // List container
            if (room.container) {
                print(`There is a ${room.container} here.`, 'system');
            }
            
            // List puzzle
            if (room.puzzle) {
                const puzzle = Object.values(puzzles).find(p => p.room === room.id);
                if (puzzle && !puzzle.solved) {
                    print("There seems to be a puzzle here...", 'puzzle');
                }
            }
            
            // List exits
            const exits = [];
            if (room.exits.n !== null) exits.push("north");
            if (room.exits.s !== null) exits.push("south");
            if (room.exits.e !== null) exits.push("east");
            if (room.exits.w !== null) exits.push("west");
            
            print("Exits: " + exits.join(', '));
            
            if (!room.explored) {
                room.explored = true;
                player.stats.roomsExplored++;
            }
            
            updateStatus();
        }

        function move(direction) {
            const room = rooms[player.location];
            const newRoomId = room.exits[direction];
            
            if (newRoomId === null) {
                print("You can't go that way.", 'error');
                return;
            }
            
            // Check for locked room
            const newRoom = rooms[newRoomId];
            if (newRoom.locked) {
                print("The way is locked!", 'error');
                return;
            }
            
            // Check for trap
            if (room.trap && Math.random() > 0.7) {
                springTrap(room.trap);
                if (player.hp <= 0) return;
            }
            
            soundSystem.playSound('step');
            player.location = newRoomId;
            
            // Check for enemy
            if (newRoom.enemy) {
                print(`A ${newRoom.enemy} blocks your path!`, 'enemy');
            }
            
            look();
        }

        function take(itemName) {
            const room = rooms[player.location];
            
            if (room.dark && !player.hasLight) {
                print("It's too dark to see anything!", 'error');
                return;
            }
            
            // Find the item ID by name
            const itemId = findItemByName(itemName);
            
            if (!itemId) {
                print("You don't see that here.", 'error');
                return;
            }
            
            // Check if the item is in the room
            const itemIndex = room.items.indexOf(itemId);
            if (itemIndex === -1) {
                print("You don't see that here.", 'error');
                return;
            }
            
            // Remove from room and add to inventory
            room.items.splice(itemIndex, 1);
            player.inventory.push(itemId);
            
            print(`You take the ${items[itemId].name}.`, 'success');
            soundSystem.playSound('pickup');
            
            // Special case for light sources
            if (itemId === 'rusty_lantern' || itemId === 'holy_symbol') {
                player.hasLight = true;
            }
            
            updateStatus();
        }

        function equip(itemName) {
            // Find the item ID by name
            const itemId = findItemByName(itemName);
            
            if (!itemId) {
                print("You don't have that item.", 'error');
                return;
            }
            
            // Check if player has the item
            if (!player.inventory.includes(itemId)) {
                print("You don't have that item.", 'error');
                return;
            }
            
            const item = items[itemId];
            
            // Check if it's equipment
            if (item.type === 'weapon') {
                // If already have a weapon equipped, put it back in inventory
                if (player.equipped.weapon) {
                    player.inventory.push(player.equipped.weapon);
                }
                
                // Equip the new weapon
                player.equipped.weapon = itemId;
                player.inventory.splice(player.inventory.indexOf(itemId), 1);
                print(`You equip the ${item.name}.`, 'success');
                soundSystem.playSound('equip');
                
            } else if (item.type === 'armor') {
                // If already have armor equipped, put it back in inventory
                if (player.equipped.armor) {
                    player.inventory.push(player.equipped.armor);
                }
                
                // Equip the new armor
                player.equipped.armor = itemId;
                player.inventory.splice(player.inventory.indexOf(itemId), 1);
                print(`You equip the ${item.name}.`, 'success');
                soundSystem.playSound('equip');
                
            } else {
                print("That's not something you can equip.", 'error');
                return;
            }
            
            // Recalculate stats
            calculatePlayerStats();
        }

        function useItem(itemName, target = null) {
            // Find the item ID by name
            const itemId = findItemByName(itemName);
            
            if (!itemId || !player.inventory.includes(itemId)) {
                print("You don't have that.", 'error');
                return;
            }
            
            const item = items[itemId];
            const room = rooms[player.location];
            
            // Use holy symbol
            if (itemId === 'holy_symbol') {
                player.hasLight = !player.hasLight;
                print(player.hasLight ? "The holy symbol glows with divine light." : "The holy symbol's light fades.", 'success');
                soundSystem.playSound('click');
                if (player.hasLight) look();
                return;
            }
            
            // Use lantern
            if (itemId === 'rusty_lantern') {
                player.hasLight = !player.hasLight;
                print(player.hasLight ? "You light the lantern." : "You extinguish the lantern.", 'success');
                soundSystem.playSound('click');
                if (player.hasLight) look();
                return;
            }
            
            // Use necronomicon page
            if (itemId === 'necronomicon_page') {
                if (room.enemy) {
                    const enemy = enemies[room.enemy];
                    enemy.hp -= 20;
                    print("You recite a dark incantation! A spirit attacks for 20 damage!", 'damage');
                    soundSystem.playSound('spell');
                    
                    if (enemy.hp <= 0) {
                        print(`You defeated the ${enemy.name}!`, 'success');
                        if (enemy.loot) {
                            enemy.loot.forEach(lootId => {
                                room.items.push(lootId);
                                print(`It drops: ${items[lootId].name}`, 'loot');
                            });
                        }
                        room.enemy = null;
                        player.stats.enemiesDefeated++;
                    }
                } else {
                    print("You recite a dark incantation to no effect.", 'system');
                }
                player.inventory.splice(player.inventory.indexOf(itemId), 1);
                updateStatus();
                return;
            }
            
            // Use witch herb
            if (itemId === 'witch_herb') {
                const mpAmount = 20;
                player.mp = Math.min(player.maxMp, player.mp + mpAmount);
                player.inventory.splice(player.inventory.indexOf(itemId), 1);
                print(`You consume the witch herb and restore ${mpAmount} MP.`, 'heal');
                soundSystem.playSound('notification');
                updateStatus();
                return;
            }
            
            // Use holy water
            if (itemId === 'holy_water') {
                if (room.enemy) {
                    const enemy = enemies[room.enemy];
                    // Extra damage to undead
                    const damage = enemy.name.toLowerCase().includes('ghost') || 
                                   enemy.name.toLowerCase().includes('ghoul') ||
                                   enemy.name.toLowerCase().includes('zombie') ||
                                   enemy.name.toLowerCase().includes('vampire') ||
                                   enemy.name.toLowerCase().includes('specter') ? 35 : 15;
                    
                    enemy.hp -= damage;
                    print(`You splash holy water on the ${enemy.name}! It takes ${damage} damage!`, 'damage');
                    soundSystem.playSound('attack');
                    
                    if (enemy.hp <= 0) {
                        print(`You defeated the ${enemy.name}!`, 'success');
                        if (enemy.loot) {
                            enemy.loot.forEach(lootId => {
                                room.items.push(lootId);
                                print(`It drops: ${items[lootId].name}`, 'loot');
                            });
                        }
                        room.enemy = null;
                        player.stats.enemiesDefeated++;
                    }
                } else {
                    print("You splash holy water around.", 'system');
                }
                player.inventory.splice(player.inventory.indexOf(itemId), 1);
                updateStatus();
                return;
            }
            
            // Use healing items
            if (itemId === 'marsh_herb') {
                const healAmount = 15;
                player.hp = Math.min(player.maxHp, player.hp + healAmount);
                player.inventory.splice(player.inventory.indexOf(itemId), 1);
                print(`You chew the marsh herb and restore ${healAmount} HP.`, 'heal');
                soundSystem.playSound('notification');
                updateStatus();
                return;
            }
            
            if (itemId === 'elixir_of_life') {
                const healAmount = 50;
                player.hp = Math.min(player.maxHp, player.hp + healAmount);
                player.inventory.splice(player.inventory.indexOf(itemId), 1);
                print(`You drink the elixir of life and restore ${healAmount} HP.`, 'heal');
                soundSystem.playSound('notification');
                updateStatus();
                return;
            }
            
            if (itemId === 'spirit_essence') {
                const mpAmount = 30;
                player.mp = Math.min(player.maxMp, player.mp + mpAmount);
                player.inventory.splice(player.inventory.indexOf(itemId), 1);
                print(`You absorb the spirit essence and restore ${mpAmount} MP.`, 'heal');
                soundSystem.playSound('notification');
                updateStatus();
                return;
            }
            
            // Use lockpick
            if (itemId === 'lockpick' && target === 'door') {
                const room = rooms[player.location];
                if (room.locked) {
                    if (player.class === 'grave_robber' || Math.random() > 0.4) {
                        room.locked = false;
                        print("You successfully pick the lock!", 'success');
                        soundSystem.playSound('click');
                    } else {
                        print("You fail to pick the lock.", 'error');
                        // Chance to break lockpick
                        if (Math.random() > 0.6) {
                            player.inventory.splice(player.inventory.indexOf(itemId), 1);
                            print("Your lockpick breaks!", 'error');
                        }
                    }
                } else {
                    print("The door isn't locked.", 'error');
                }
                return;
            }
            
            // Use key on locked room
            if (item.type === 'key' && target === 'door') {
                const room = rooms[player.location];
                if (room.locked) {
                    // Check specific key requirements
                    if (room.id === 39 && itemId === 'master_key') {
                        room.locked = false;
                        player.inventory.splice(player.inventory.indexOf(itemId), 1);
                        print("The master key fits! The bridge to freedom unlocks!", 'success');
                        soundSystem.playSound('crypt');
                        print("*** YOU ESCAPE! ***", 'success');
                        print("You have escaped the Graveyard of Souls!", 'success');
                        soundSystem.playBackground('victory');
                        return;
                    } else if (room.id === 2 && itemId === 'skeleton_key') {
                        room.locked = false;
                        print("The skeleton key unlocks the mausoleum doors.", 'success');
                        soundSystem.playSound('door');
                        return;
                    } else if (room.id === 36 && itemId === 'soul_key_fragment') {
                        // Need three fragments
                        const fragments = player.inventory.filter(i => i === 'soul_key_fragment').length;
                        if (fragments >= 3) {
                            room.locked = false;
                            // Remove three fragments
                            for (let i = 0; i < 3; i++) {
                                const idx = player.inventory.indexOf('soul_key_fragment');
                                if (idx !== -1) player.inventory.splice(idx, 1);
                            }
                            print("You combine the soul key fragments and unlock the Gate of Souls!", 'success');
                            soundSystem.playSound('crypt');
                        } else {
                            print(`You need 3 soul key fragments. You have ${fragments}.`, 'error');
                        }
                        return;
                    } else {
                        print("The key doesn't fit this lock.", 'error');
                    }
                } else {
                    print("The door isn't locked.", 'error');
                }
                return;
            }
            
            // Use object on object
            if (target) {
                const targetId = findItemByName(target);
                
                // Use item on container
                if (room.container && target === room.container) {
                    // Example puzzle solution
                    if (room.id === 3 && itemId === 'holy_water' && target === 'altar') {
                        print("You bless the altar with holy water. A hidden crypt is revealed!", 'puzzle');
                        soundSystem.playSound('puzzle');
                        return;
                    }
                }
                
                // Use item on NPC
                if (room.npc && target === room.npc) {
                    const npc = npcs[room.npc];
                    if (npc.quest && npc.quest.type === 'give' && npc.quest.target.includes(itemId)) {
                        print(`You give ${items[itemId].name} to ${npc.name}.`, 'success');
                        player.inventory.splice(player.inventory.indexOf(itemId), 1);
                        if (npc.quest.reward) {
                            player.inventory.push(npc.quest.reward);
                            npc.quest.completed = true;
                            print(`${npc.name}: "Thank you! Here is ${items[npc.quest.reward].name}."`, 'quest');
                            soundSystem.playSound('pickup');
                        }
                        return;
                    }
                }
            }
            
            print(`You're not sure how to use the ${item.name} here.`, 'error');
        }

        function talk(npcName = null) {
            const room = rooms[player.location];
            
            if (!room.npc) {
                print("There's no one here to talk to.", 'error');
                return;
            }
            
            const npc = npcs[room.npc];
            print(`${npc.name}: "${npc.dialog}"`, 'npc');
            
            // Handle quests
            if (npc.quest && !npc.quest.completed) {
                if (npc.quest.type === 'find' && !npc.quest.given) {
                    npc.quest.given = true;
                    print(`${npc.name}: "Find the ${items[npc.quest.target].name} for me."`, 'quest');
                } else if (npc.quest.type === 'give') {
                    const hasItems = npc.quest.target.every(item => player.inventory.includes(item));
                    if (hasItems) {
                        print(`${npc.name}: "You have them! Thank you!"`, 'quest');
                        npc.quest.target.forEach(item => {
                            player.inventory.splice(player.inventory.indexOf(item), 1);
                        });
                        player.inventory.push(npc.quest.reward);
                        npc.quest.completed = true;
                        print(`You receive: ${items[npc.quest.reward].name}`, 'success');
                        soundSystem.playSound('pickup');
                    } else {
                        const itemNames = npc.quest.target.map(i => items[i].name).join(' and ');
                        print(`${npc.name}: "I need ${itemNames}."`, 'quest');
                    }
                } else if (npc.quest.type === 'riddle') {
                    print(`${npc.name}: "${npc.quest.question}"`, 'quest');
                }
            }
        }

        function search(target = null) {
            const room = rooms[player.location];
            
            if (room.dark && !player.hasLight) {
                print("It's too dark to search.", 'error');
                return;
            }
            
            if (target) {
                // Search specific object
                if (room.container && target === room.container) {
                    print(`You search the ${room.container}...`, 'system');
                    
                    // Check for special items
                    if (room.id === 8 && room.container === 'witch_circle') {
                        if (!player.inventory.includes('witch_scroll') && !room.items.includes('witch_scroll')) {
                            room.items.push('witch_scroll');
                            print("You find a hidden witch scroll!", 'secret');
                            soundSystem.playSound('secret');
                            player.stats.secretsFound++;
                        }
                    }
                    return;
                }
                
                print("You don't see that here.", 'error');
            } else {
                // General room search
                print("You search the room...", 'system');
                
                if (room.items.length > 0) {
                    print("You find:", 'system');
                    room.items.forEach(itemId => {
                        print(`  ${items[itemId].name}`, 'item');
                    });
                } else {
                    print("You don't find anything.", 'system');
                }
                
                // Check for hidden puzzles
                if (room.puzzle) {
                    const puzzle = Object.values(puzzles).find(p => p.room === room.id);
                    if (puzzle && !puzzle.solved) {
                        print(`Puzzle clue: ${puzzle.description}`, 'puzzle');
                    }
                }
                
                // Chance to find secret
                if (room.secret && Math.random() > 0.7) {
                    print("You discover something hidden!", 'secret');
                    player.stats.secretsFound++;
                }
            }
        }

        function springTrap(trapType) {
            const room = rooms[player.location];
            player.stats.trapsSprung++;
            
            print(`You trigger a ${trapType}!`, 'trap');
            soundSystem.playSound('trap');
            
            switch(trapType) {
                case 'rusted_spikes':
                    const spikeDamage = 12 - Math.floor(player.totalDefense / 2);
                    player.hp -= Math.max(1, spikeDamage);
                    print(`Rusted spikes shoot up from the ground! You take ${Math.max(1, spikeDamage)} damage!`, 'damage');
                    break;
                    
                case 'grave_hand':
                    print("A skeletal hand grabs your ankle!", 'trap');
                    player.hp -= 5;
                    break;
                    
                case 'grasping_roots':
                    print("Roots spring from the ground and wrap around you!", 'trap');
                    player.hp -= 8;
                    break;
                    
                case 'sinking_ground':
                    print("The ground gives way beneath you! You barely escape.", 'trap');
                    player.hp -= 10;
                    break;
            }
            
            if (player.hp <= 0) {
                print("The trap finishes you off... Your soul joins the others in the graveyard.", 'error');
                soundSystem.playSound('error');
                resetGame();
            } else {
                updateStatus();
            }
        }

        function attack(target = null) {
            const room = rooms[player.location];
            
            if (!room.enemy) {
                print("There's nothing to attack here.", 'error');
                return;
            }
            
            const enemy = enemies[room.enemy];
            soundSystem.playSound('attack');
            
            print(`You attack the ${enemy.name}!`, 'command');
            
            // Calculate damage using player's total damage
            let damage = player.totalDamage + Math.floor(Math.random() * 6) - 3;
            damage = Math.max(1, damage);
            
            // Bonus damage with silver against certain enemies
            if (player.equipped.weapon && items[player.equipped.weapon].name.toLowerCase().includes('silver')) {
                if (enemy.weak === 'silver') {
                    damage += 5;
                    print("Your silver weapon is especially effective!", 'damage');
                }
            }
            
            enemy.hp -= damage;
            
            print(`You hit for ${damage} damage!`, 'damage');
            soundSystem.playSound('enemyHit');
            
            if (enemy.hp <= 0) {
                print(`You defeated the ${enemy.name}!`, 'success');
                
                // Drop loot
                if (enemy.loot) {
                    enemy.loot.forEach(lootId => {
                        room.items.push(lootId);
                        print(`It drops: ${items[lootId].name}`, 'loot');
                    });
                }
                
                // Gold reward
                const goldReward = 15 + Math.floor(Math.random() * 25);
                player.gold += goldReward;
                print(`You find ${goldReward} gold.`, 'loot');
                
                player.stats.enemiesDefeated++;
                
                soundSystem.playSound('victory');
                
                // Special cases
                if (room.id === 39 && room.enemy === 'final_specter') {
                    print("The final specter is defeated! The escape bridge is now accessible!", 'success');
                    // Master key appears
                    room.items.push('master_key');
                    print("The specter drops a master key!", 'loot');
                }
                
                room.enemy = null;
            } else {
                print(`The ${enemy.name} has ${enemy.hp} HP remaining.`, 'enemy');
                
                // Enemy counterattack (reduced by player's defense)
                let enemyDamage = Math.max(1, enemy.damage - Math.floor(player.totalDefense / 2));
                player.hp -= enemyDamage;
                print(`The ${enemy.name} hits you for ${enemyDamage} damage!`, 'damage');
                soundSystem.playSound('playerHit');
                
                if (player.hp <= 0) {
                    print("You have been defeated... Your soul is trapped in the graveyard forever.", 'error');
                    soundSystem.playSound('error');
                    resetGame();
                }
            }
            
            updateStatus();
        }

        function showInventory() {
            if (player.inventory.length === 0) {
                print("Your inventory is empty.", 'system');
            } else {
                print("Inventory:", 'system');
                player.inventory.forEach(itemId => {
                    const item = items[itemId];
                    const equipped = (player.equipped.weapon === itemId || player.equipped.armor === itemId) ? " [EQUIPPED]" : "";
                    print(`  ${item.name}${equipped} - ${item.desc}`, equipped ? 'equipped' : 'item');
                });
            }
            
            // Show equipped items
            print("", 'system');
            print("Equipped:", 'system');
            if (player.equipped.weapon) {
                const weapon = items[player.equipped.weapon];
                print(`  Weapon: ${weapon.name} (${weapon.damage} DMG)`, 'equipped');
            } else {
                print("  Weapon: None (3 DMG)", 'system');
            }
            
            if (player.equipped.armor) {
                const armor = items[player.equipped.armor];
                print(`  Armor: ${armor.name} (${armor.defense} DEF)`, 'equipped');
            } else {
                print("  Armor: None (0 DEF)", 'system');
            }
            
            print("", 'system');
            print(`Total Stats: ${player.totalDamage} DMG | ${player.totalDefense} DEF`, 'system');
        }

        function showStats() {
            print("=== CHARACTER STATS ===", 'command');
            print(`Class: ${player.class ? player.class.replace('_', ' ').toUpperCase() : 'None'}`, 'system');
            print(`HP: ${player.hp}/${player.maxHp}`, 'system');
            print(`MP: ${player.mp}/${player.maxMp}`, 'system');
            print(`Gold: ${player.gold}`, 'system');
            print(`Strength: ${player.str}`, 'system');
            print(`Defense: ${player.def}`, 'system');
            print(`Intelligence: ${player.int}`, 'system');
            print("=== EQUIPMENT ===", 'command');
            if (player.equipped.weapon) {
                const weapon = items[player.equipped.weapon];
                print(`Weapon: ${weapon.name} (${weapon.damage} DMG)`, 'equipped');
            } else {
                print("Weapon: None", 'system');
            }
            if (player.equipped.armor) {
                const armor = items[player.equipped.armor];
                print(`Armor: ${armor.name} (${armor.defense} DEF)`, 'equipped');
            } else {
                print("Armor: None", 'system');
            }
            print(`Total Damage: ${player.totalDamage}`, 'system');
            print(`Total Defense: ${player.totalDefense}`, 'system');
            print("=== GRAVEYARD PROGRESS ===", 'command');
            print(`Rooms Explored: ${player.stats.roomsExplored}/40`, 'system');
            print(`Enemies Defeated: ${player.stats.enemiesDefeated}`, 'system');
            print(`Puzzles Solved: ${player.stats.puzzlesSolved}`, 'system');
            print(`Secrets Found: ${player.stats.secretsFound}`, 'system');
            print(`Traps Sprung: ${player.stats.trapsSprung}`, 'system');
            print(`Current Location: Room ${player.location}`, 'system');
        }

        function showHelp() {
            print("=== GRAVEYARD OF SOULS ===", 'command');
            print("MOVEMENT: n, s, e, w, look", 'system');
            print("INTERACTION: take [item], use [item], use [item] on [object]", 'system');
            print("           equip [item], search, search [container]", 'system');
            print("           drop [item], inventory", 'system');
            print("COMBAT: attack", 'system');
            print("NPCS: talk", 'system');
            print("INFO: stats, help", 'system');
            print("=== GRAVEYARD ESCAPE TIPS ===", 'command');
            print("- Find keys to unlock tombs and gates", 'system');
            print("- Light sources needed in dark crypts", 'system');
            print("- Silver weapons effective against undead", 'system');
            print("- Holy items repel evil creatures", 'system');
            print("- Solve puzzles to progress through areas", 'system');
            print("- Talk to ghosts for help and quests", 'system');
            print("- Find the Master Key to escape (Room 39)", 'system');
            print("- Different classes have different strengths", 'system');
        }

        function resetGame() {
            player.class = null;
            gameStarted = false;
            soundSystem.playBackground('main_theme');
            print("GAME OVER", 'error');
            print("Choose a class: hunter, grave_robber, occultist.", 'system');
            updateStatus();
        }

        function quickCommand(cmd) {
            document.getElementById('input').value = cmd;
            const event = new KeyboardEvent('keydown', { key: 'Enter' });
            document.getElementById('input').dispatchEvent(event);
        }

        // ==================== COMMAND PARSER ====================
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                const cmd = input.value.trim().toLowerCase();
                input.value = '';
                if (!cmd) return;

                soundSystem.playSound('click', 0.3);
                print(`> ${cmd}`, 'command');
                
                // Convert "use X on Y" to array
                let parts;
                if (cmd.includes(' on ')) {
                    parts = cmd.split(' on ');
                    parts = ['use', parts[0], parts[1]];
                } else {
                    parts = cmd.split(' ');
                }
                
                const verb = parts[0];
                const arg1 = parts[1];
                const arg2 = parts[2];

                // Class selection
                if (!player.class && ['hunter', 'grave_robber', 'occultist'].includes(verb)) {
                    startGame(verb);
                    return;
                }
                
                if (!player.class) {
                    print("Choose a class first: hunter, grave_robber, occultist.", 'error');
                    return;
                }

                // Game commands
                switch (verb) {
                    case 'n': case 'north': move('n'); break;
                    case 's': case 'south': move('s'); break;
                    case 'e': case 'east': move('e'); break;
                    case 'w': case 'west': move('w'); break;
                    case 'l': case 'look': look(); break;
                    case 'take': if (arg1) take(arg1); else print("Take what?"); break;
                    case 'use': 
                        if (arg2) {
                            useItem(arg1, arg2);
                        } else if (arg1) {
                            useItem(arg1);
                        } else {
                            print("Use what?"); 
                        }
                        break;
                    case 'equip': if (arg1) equip(arg1); else print("Equip what?"); break;
                    case 'talk': talk(arg1); break;
                    case 'search': search(arg1); break;
                    case 'drop': if (arg1) drop(arg1); else print("Drop what?"); break;
                    case 'i': case 'inventory': case 'inv': showInventory(); break;
                    case 'attack': attack(arg1); break;
                    case 'stats': showStats(); break;
                    case 'help': case '?': showHelp(); break;
                    case 'quit': resetGame(); break;
                    default: print("Unknown command. Type 'help'.", 'error');
                }
            }
        });

        // Sound toggle button
        document.getElementById('sound-toggle').addEventListener('click', () => {
            soundSystem.toggle();
        });

        // Initialize audio on first user interaction
        document.addEventListener('click', function initAudio() {
            soundSystem.resumeAudioContext();
            if (!gameStarted) {
                soundSystem.playBackground('main_theme');
            }
            document.removeEventListener('click', initAudio);
        }, { once: true });

        // ==================== INIT ====================
        print("GRAVEYARD OF SOULS (1988)", 'success');
        print("NIGHTFALLS GAMES PRESENTS", 'system');
        print("", 'system');
        print("A gothic horror adventure through 40 rooms of haunted graves!", 'system');
        print("Battle undead, solve puzzles, and escape with your soul!", 'system');
        print("", 'system');
        print("Classes:", 'system');
        print("- hunter: Silver dagger and holy symbol", 'system');
        print("- grave_robber: Lockpick set and skeleton key", 'system');
        print("- occultist: Necronomicon page and witch herb", 'system');
        print("", 'system');
        print("Commands: n/s/e/w, look, take, equip, use, talk, search, attack, inventory", 'system');
        print("", 'system');
        print("Choose your class: hunter, grave_robber, occultist.", 'system');
        updateStatus();
        input.focus();
    </script>
</body>
</html>
