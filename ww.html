<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Normandy Beach Assault - WWII RPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        body {
            background-color: #1a1f16;
            color: #d4af37;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-image: radial-gradient(#2a3325 15%, transparent 16%),
                              radial-gradient(#2a3325 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
        }
        
        #game-container {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border: 2px solid #d4af37;
            background-color: rgba(26, 31, 22, 0.95);
            position: relative;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }
        
        .screen {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            padding: 10px;
            overflow-y: auto;
        }
        
        .active {
            display: flex;
        }
        
        h1, h2, h3 {
            color: #d4af37;
            text-align: center;
            margin: 10px 0;
            text-transform: uppercase;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .button {
            background-color: #2a3325;
            color: #d4af37;
            border: 1px solid #d4af37;
            padding: 12px;
            margin: 8px 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .button:hover {
            background-color: #d4af37;
            color: #1a1f16;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        .button:active {
            transform: scale(0.98);
        }
        
        .button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            border-bottom: 1px dashed #d4af37;
            padding-bottom: 10px;
        }
        
        .log {
            border: 1px solid #d4af37;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            font-size: 14px;
            background-color: rgba(42, 51, 37, 0.7);
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 3px;
            border-left: 2px solid #d4af37;
            padding-left: 8px;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .item {
            border: 1px solid #d4af37;
            padding: 8px;
            cursor: pointer;
            position: relative;
            background-color: rgba(42, 51, 37, 0.7);
        }
        
        .item-stats {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .equipment-slots {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .equipment-slot {
            border: 1px solid #d4af37;
            padding: 8px;
            min-height: 60px;
            background-color: rgba(42, 51, 37, 0.7);
        }
        
        .equipment-stats {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .enemy {
            text-align: center;
            margin: 20px 0;
            font-size: 24px;
            position: relative;
            padding: 10px;
            border: 2px solid #8b0000;
            background-color: rgba(139, 0, 0, 0.2);
        }
        
        .battle-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .ability-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 5px;
            margin: 10px 0;
        }
        
        .ability-item {
            border: 1px solid #d4af37;
            padding: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            background-color: rgba(42, 51, 37, 0.7);
        }
        
        .ability-info {
            flex: 1;
        }
        
        .ability-cost {
            color: #4d7c9e;
            margin-left: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #1a1f16;
            border: 1px solid #d4af37;
            margin: 5px 0;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #d4af37;
            width: 0%;
            transition: width 0.3s;
        }
        
        .stamina-bar {
            background-color: #4d7c9e;
        }
        
        .class-select {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .class-option {
            border: 1px solid #d4af37;
            padding: 15px;
            cursor: pointer;
            background-color: rgba(42, 51, 37, 0.7);
        }
        
        .class-option:hover {
            background-color: #d4af37;
            color: #1a1f16;
        }
        
        .loot-item {
            color: #d4af37;
            animation: pulse 1s infinite;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .crit-message {
            color: #ff0000;
            font-weight: bold;
        }
        
        .dodge-message {
            color: #4d7c9e;
            font-weight: bold;
        }
        
        .miss-message {
            color: #888;
            font-style: italic;
        }
        
        .shop-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .shop-item {
            border: 1px solid #d4af37;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(42, 51, 37, 0.7);
        }
        
        .shop-item-info {
            flex: 1;
        }
        
        .shop-item-cost {
            color: #d4af37;
            margin-left: 10px;
        }
        
        .item-comparison {
            font-size: 12px;
            margin-top: 3px;
        }
        
        .better-stat {
            color: #00ff00;
        }
        
        .worse-stat {
            color: #ff0000;
        }
        
        .same-stat {
            color: #888;
        }
        
        .rarity-common { color: #cccccc; }
        .rarity-uncommon { color: #1eff00; }
        .rarity-rare { color: #0070dd; }
        .rarity-epic { color: #a335ee; }
        .rarity-legendary { color: #ff8000; }
        
        .floating-text {
            position: absolute;
            font-weight: bold;
            pointer-events: none;
            z-index: 100;
            animation: floatUp 1s ease-out forwards;
        }
        
        .damage-text {
            color: #ff0000;
        }
        
        .heal-text {
            color: #00ff00;
        }
        
        .stamina-text {
            color: #4d7c9e;
        }
        
        .enemy-health-bar {
            width: 100%;
            height: 10px;
            background-color: #1a1f16;
            border: 1px solid #8b0000;
            margin: 5px 0;
            position: relative;
            overflow: hidden;
        }
        
        .enemy-health-fill {
            height: 100%;
            background-color: #8b0000;
            width: 100%;
            transition: width 0.3s;
        }
        
        .hotkey {
            font-size: 10px;
            color: #888;
            margin-left: 5px;
        }
        
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #2a3325;
            color: #d4af37;
            border: 1px solid #d4af37;
            padding: 5px;
            cursor: pointer;
            z-index: 1000;
        }
        
        .orders-log {
            border: 1px solid #d4af37;
            padding: 10px;
            margin: 10px 0;
            max-height: 150px;
            overflow-y: auto;
            background-color: rgba(42, 51, 37, 0.7);
        }
        
        .order-item {
            margin: 5px 0;
            padding: 5px;
            border-left: 2px solid #d4af37;
        }
        
        .order-completed {
            color: #00ff00;
            text-decoration: line-through;
        }
        
        .status-effect {
            display: inline-block;
            padding: 2px 5px;
            margin: 0 2px;
            border-radius: 3px;
            font-size: 10px;
        }
        
        .status-suppressed {
            background-color: #666;
            color: #fff;
        }
        
        .status-bleeding {
            background-color: #8b0000;
            color: #fff;
        }
        
        .status-pinned {
            background-color: #4d7c9e;
            color: #fff;
        }
        
        .tooltip {
            position: absolute;
            background: #1a1f16;
            border: 1px solid #d4af37;
            padding: 8px;
            z-index: 1000;
            max-width: 250px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            background-color: rgba(26, 31, 22, 0.95);
        }
        
        .tooltip.show {
            opacity: 1;
        }
        
        .quick-slot {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 1px solid #d4af37;
            margin: 2px;
            text-align: center;
            line-height: 40px;
            cursor: pointer;
            background-color: rgba(42, 51, 37, 0.7);
        }
        
        .quick-slots-container {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }
        
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1f16;
            border: 2px solid #d4af37;
            padding: 20px;
            z-index: 2000;
            text-align: center;
            animation: achievementPop 3s ease-in-out forwards;
            background-color: rgba(26, 31, 22, 0.95);
        }
        
        .achievement-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .save-slot {
            border: 1px solid #d4af37;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            background-color: rgba(42, 51, 37, 0.7);
        }
        
        .save-slot:hover {
            background-color: #d4af37;
            color: #1a1f16;
        }
        
        .save-info {
            font-size: 12px;
            color: #888;
        }
        
        .skill-tree {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        
        .skill-node {
            border: 1px solid #d4af37;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background-color: rgba(42, 51, 37, 0.7);
        }
        
        .skill-node.unlocked {
            background-color: #d4af37;
            color: #1a1f16;
        }
        
        .skill-node.available {
            border-color: #ffd700;
        }
        
        .skill-node.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .boss-health-container {
            position: relative;
            margin: 10px 0;
        }
        
        .boss-health-bar {
            height: 20px;
            background: linear-gradient(90deg, #8b0000, #ff0000);
            border: 1px solid #fff;
            position: relative;
            overflow: hidden;
        }
        
        .boss-health-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
            color: #fff;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
        }
        
        .phase-indicator {
            color: #ffd700;
            font-weight: bold;
            text-align: center;
            margin: 5px 0;
            animation: pulse 1s infinite;
        }
        
        .inventory-sort {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }
        
        .sort-button {
            flex: 1;
            padding: 5px;
            font-size: 12px;
        }
        
        .rank-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #2a3325;
            border: 1px solid #d4af37;
            padding: 5px 10px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .medal-display {
            display: inline-block;
            margin: 0 5px;
            font-size: 20px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes achievementPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        
        @keyframes explosion {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .shake {
            animation: shake 0.3s ease-in-out;
        }
        
        .boss-enemy {
            color: #ff0000;
            text-shadow: 0 0 5px #ff0000;
        }
        
        .explosion-effect {
            position: absolute;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #ff9900, #ff0000);
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            animation: explosion 0.5s ease-out;
        }
        
        .bullet-hit {
            position: absolute;
            width: 10px;
            height: 10px;
            background: radial-gradient(circle, #ff9900, #ff0000);
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            animation: explosion 0.3s ease-out;
        }
        
        .cover-indicator {
            display: inline-block;
            padding: 2px 5px;
            background: #4d7c9e;
            color: white;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="sound-toggle" id="sound-toggle">ðŸ”Š SOUND ON</div>
        <div class="rank-display" id="rank-display">Rank: Private</div>
        
        <!-- Tooltip Element -->
        <div id="tooltip" class="tooltip"></div>
        
        <!-- Start Screen -->
        <div id="start-screen" class="screen active">
            <h1>NORMANDY BEACH ASSAULT</h1>
            <h3>WWII Tactical RPG</h3>
            <div style="margin: 40px 0; text-align: center;">
                <p style="margin: 10px 0;">June 6, 1944 - D-Day</p>
                <p style="margin: 10px 0;">Omaha Beach, Normandy Coast</p>
                <p style="margin: 10px 0;">You are part of the Allied invasion force.</p>
                <p style="margin: 10px 0;">Your mission: Break through German defenses.</p>
            </div>
            <div class="button" id="start-button">BEGIN MISSION</div>
            <div class="button" id="load-button">LOAD GAME</div>
        </div>
        
        <!-- Load Game Screen -->
        <div id="load-screen" class="screen">
            <h1>LOAD GAME</h1>
            <div id="save-slots">
                <!-- Save slots will be populated here -->
            </div>
            <div class="button" id="back-from-load">BACK</div>
        </div>
        
        <!-- Class Selection Screen -->
        <div id="class-screen" class="screen">
            <h1>SELECT YOUR ROLE</h1>
            <div class="class-select">
                <div class="class-option" data-class="infantry">
                    <h3>INFANTRY</h3>
                    <p>All-around soldier, balanced stats</p>
                    <p>Starts with M1 Garand and Helmet</p>
                    <p>Special Ability: Grenade Toss</p>
                </div>
                <div class="class-option" data-class="sniper">
                    <h3>SNIPER</h3>
                    <p>High accuracy and critical hits</p>
                    <p>Starts with Springfield Rifle</p>
                    <p>Special Ability: Aimed Shot</p>
                </div>
                <div class="class-option" data-class="medic">
                    <h3>COMBAT MEDIC</h3>
                    <p>Healing abilities, support role</p>
                    <p>Starts with Medical Kit and Pistol</p>
                    <p>Special Ability: Field Bandage</p>
                </div>
                <div class="class-option" data-class="engineer">
                    <h3>COMBAT ENGINEER</h3>
                    <p>High defense, explosive expert</p>
                    <p>Starts with Shotgun and Flak Jacket</p>
                    <p>Special Ability: Satchel Charge</p>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <h2>COMMAND POST</h2>
            <div class="stats">
                <div>
                    <div>Rank: <span id="player-rank">Private</span></div>
                    <div>Health: <span id="player-hp">100</span>/<span id="player-max-hp">100</span></div>
                    <div>Stamina: <span id="player-mp">50</span>/<span id="player-max-mp">50</span></div>
                </div>
                <div>
                    <div>EXP: <span id="player-exp">0</span>/<span id="player-exp-needed">100</span></div>
                    <div>Supplies: <span id="player-gold">50</span></div>
                </div>
            </div>
            <div class="progress-bar">
                <div id="exp-bar" class="progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-bar">
                <div id="mp-bar" class="progress-fill stamina-bar" style="width: 100%"></div>
            </div>
            
            <!-- Quick Slots -->
            <div class="quick-slots-container">
                <div class="quick-slot" data-slot="0" id="quick-slot-0">1</div>
                <div class="quick-slot" data-slot="1" id="quick-slot-1">2</div>
                <div class="quick-slot" data-slot="2" id="quick-slot-2">3</div>
            </div>
            
            <div class="stat-grid">
                <div>Strength: <span id="player-strength">10</span></div>
                <div>Defense: <span id="player-defense">5</span></div>
                <div>Agility: <span id="player-agility">10</span></div>
                <div>Accuracy: <span id="player-accuracy">75</span>%</div>
                <div>Critical: <span id="player-critical">5</span>%</div>
                <div>Cover: <span id="player-cover">0</span>%</div>
            </div>
            
            <div class="button" id="scout-button">SCOUT ENEMY LINES</div>
            <div class="button" id="inventory-button">EQUIPMENT</div>
            <div class="button" id="abilities-button">COMBAT ABILITIES</div>
            <div class="button" id="supply-button">SUPPLY DEPOT</div>
            <div class="button" id="orders-button">MISSION ORDERS</div>
            <div class="button" id="training-button">COMBAT TRAINING</div>
            <div class="button" id="achievements-button">MEDALS & CITATIONS</div>
            <div class="button" id="save-button">SAVE GAME</div>
            
            <h3>Status</h3>
            <div id="status-effects">
                <!-- Status effects will appear here -->
            </div>
            
            <div class="log" id="game-log">
                <div class="log-entry">You're at the command post behind the front lines. The sound of artillery echoes in the distance...</div>
            </div>
        </div>
        
        <!-- Battle Screen -->
        <div id="battle-screen" class="screen">
            <h2>COMBAT ENGAGEMENT!</h2>
            <div class="stats">
                <div>
                    <div>Your Health: <span id="battle-player-hp">100</span>/<span id="battle-player-max-hp">100</span></div>
                    <div>Stamina: <span id="battle-player-mp">50</span>/<span id="battle-player-max-mp">50</span></div>
                    <div>Cover: <span id="battle-player-cover">0</span>%</div>
                </div>
                <div>
                    <div><span id="enemy-name">German Infantry</span> Health: <span id="enemy-hp">50</span>/<span id="enemy-max-hp">50</span></div>
                    <div>Enemy Cover: <span id="enemy-cover">0</span>%</div>
                </div>
            </div>
            <div class="progress-bar">
                <div id="battle-mp-bar" class="progress-fill stamina-bar" style="width: 100%"></div>
            </div>
            
            <!-- Boss Health Bar -->
            <div id="boss-health-container" class="boss-health-container" style="display: none;">
                <div class="boss-health-bar">
                    <div id="boss-health-fill" style="width: 100%; height: 100%; background: linear-gradient(90deg, #8b0000, #ff0000);"></div>
                </div>
                <div class="boss-health-text" id="boss-health-text">PANZER TANK: 100%</div>
            </div>
            
            <div class="enemy-health-bar">
                <div id="enemy-health-fill" class="enemy-health-fill" style="width: 100%"></div>
            </div>
            
            <div class="phase-indicator" id="phase-indicator" style="display: none;"></div>
            
            <div class="enemy" id="enemy-display">[GERMAN INFANTRY]</div>
            <div class="log" id="battle-log">
                <div class="log-entry">Enemy spotted! Take cover!</div>
            </div>
            <div class="battle-actions">
                <div class="button" id="attack-button">FIRE WEAPON <span class="hotkey">(1)</span></div>
                <div class="button" id="ability-button">USE ABILITY <span class="hotkey">(2)</span></div>
                <div class="button" id="item-button">USE ITEM <span class="hotkey">(3)</span></div>
                <div class="button" id="cover-button">TAKE COVER <span class="hotkey">(4)</span></div>
                <div class="button" id="flee-button">RETREAT <span class="hotkey">(5)</span></div>
            </div>
            
            <!-- Quick Slots in Battle -->
            <div class="quick-slots-container">
                <div class="quick-slot" data-slot="0" id="battle-quick-slot-0">1</div>
                <div class="quick-slot" data-slot="1" id="battle-quick-slot-1">2</div>
                <div class="quick-slot" data-slot="2" id="battle-quick-slot-2">3</div>
            </div>
        </div>
        
        <!-- Ability Selection Screen (in battle) -->
        <div id="ability-select-screen" class="screen">
            <h2>SELECT COMBAT ABILITY</h2>
            <div class="stats">
                <div>Stamina: <span id="ability-select-mp">50</span>/<span id="ability-select-max-mp">50</span></div>
            </div>
            <div id="ability-select-list" class="ability-list">
                <!-- Abilities will be added here dynamically -->
            </div>
            <div class="button" id="back-from-ability-select">BACK</div>
        </div>
        
        <!-- Inventory Screen -->
        <div id="inventory-screen" class="screen">
            <h2>EQUIPMENT & SUPPLIES</h2>
            <div class="stats">
                <div>Supplies: <span id="inventory-gold">50</span></div>
                <div>Rank: <span id="inventory-rank">Private</span></div>
            </div>
            
            <!-- Sort Buttons -->
            <div class="inventory-sort">
                <div class="button sort-button" data-sort="name">Sort by Name</div>
                <div class="button sort-button" data-sort="type">Sort by Type</div>
                <div class="button sort-button" data-sort="rarity">Sort by Rarity</div>
            </div>
            
            <h3>EQUIPMENT</h3>
            <div class="equipment-slots">
                <div class="equipment-slot" data-slot="head">
                    Helmet: <span id="head-slot">Empty</span>
                    <div id="head-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="chest">
                    Chest: <span id="chest-slot">Empty</span>
                    <div id="chest-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="hands">
                    Gloves: <span id="hands-slot">Empty</span>
                    <div id="hands-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="secondary">
                    Sidearm: <span id="secondary-slot">Empty</span>
                    <div id="secondary-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="primary">
                    Primary Weapon: <span id="primary-slot">Empty</span>
                    <div id="primary-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="special">
                    Special: <span id="special-slot">Empty</span>
                    <div id="special-stats" class="equipment-stats"></div>
                </div>
            </div>
            
            <h3>SUPPLIES</h3>
            <div class="inventory-grid" id="inventory-items">
                <!-- Items will be added here dynamically -->
            </div>
            
            <div class="button" id="back-from-inventory">BACK</div>
        </div>
        
        <!-- Abilities Screen -->
        <div id="abilities-screen" class="screen">
            <h2>COMBAT ABILITIES</h2>
            <div id="abilities-list" class="ability-list">
                <!-- Abilities will be added here dynamically -->
            </div>
            <div class="button" id="back-from-abilities">BACK</div>
        </div>
        
        <!-- Supply Depot Screen -->
        <div id="supply-screen" class="screen">
            <h2>SUPPLY DEPOT</h2>
            <div class="stats">
                <div>Supplies: <span id="supply-gold">50</span></div>
                <div>Rank: <span id="supply-rank">Private</span></div>
            </div>
            <div id="supply-items" class="ability-list">
                <!-- Supply items will be added here dynamically -->
            </div>
            <div class="button" id="back-from-supply">BACK</div>
        </div>
        
        <!-- Orders Screen -->
        <div id="orders-screen" class="screen">
            <h2>MISSION ORDERS</h2>
            <div class="orders-log" id="orders-log">
                <!-- Orders will be added here dynamically -->
            </div>
            <div class="button" id="back-from-orders">BACK</div>
        </div>
        
        <!-- Training Screen -->
        <div id="training-screen" class="screen">
            <h2>COMBAT TRAINING</h2>
            <div class="stats">
                <div>Training Points: <span id="training-points">0</span></div>
                <div>Role: <span id="training-class">None</span></div>
            </div>
            <div id="training-tree" class="skill-tree">
                <!-- Training nodes will be added here dynamically -->
            </div>
            <div class="button" id="back-from-training">BACK</div>
        </div>
        
        <!-- Achievements Screen -->
        <div id="achievements-screen" class="screen">
            <h2>MEDALS & CITATIONS</h2>
            <div id="achievements-list">
                <!-- Achievements will be added here dynamically -->
            </div>
            <div class="button" id="back-from-achievements">BACK</div>
        </div>
        
        <!-- Loot Screen -->
        <div id="loot-screen" class="screen">
            <h2>OBJECTIVE SECURED!</h2>
            <div class="log">
                <div class="log-entry">Enemy neutralized!</div>
                <div class="log-entry">You gained <span id="exp-gained">0</span> experience!</div>
                <div class="log-entry">You recovered:</div>
                <div id="loot-items">
                    <!-- Loot items will be added here -->
                </div>
            </div>
            <div class="button" id="take-loot">CONTINUE MISSION</div>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            currentScreen: 'start',
            player: {
                class: null,
                rank: 'Private',
                level: 1,
                exp: 0,
                expNeeded: 100,
                hp: 100,
                maxHp: 100,
                mp: 50, // Stamina
                maxMp: 50,
                gold: 50, // Supplies
                strength: 10,
                defense: 5,
                agility: 10,
                accuracy: 75,
                critical: 5,
                cover: 0,
                equipment: {
                    head: null,
                    chest: null,
                    hands: null,
                    secondary: null,
                    primary: null,
                    special: null
                },
                inventory: [],
                abilities: [],
                statusEffects: [],
                orders: [],
                trainingPoints: 0,
                skills: [],
                quickSlots: [null, null, null],
                achievements: [],
                medals: []
            },
            currentEnemy: null,
            battleLog: [],
            gameLog: [],
            soundEnabled: true,
            enemyMaxHp: 0,
            saveSlots: 3,
            tooltipTimeout: null,
            // Achievement tracking
            enemiesDefeated: 0,
            missionsCompleted: 0,
            totalSuppliesEarned: 0,
            abilitiesLearned: 0,
            tanksDestroyed: 0,
            infantryDefeated: 0,
            snipersDefeated: 0,
            officersDefeated: 0,
            timesWounded: 0
        };

        // Sound Manager
        const SoundManager = {
            context: null,
            
            init() {
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log("Web Audio API is not supported in this browser");
                }
            },
            
            playTone(frequency, duration, type = 'sine', volume = 0.1) {
                if (!gameState.soundEnabled || !this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.value = volume;
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.context.currentTime + duration);
                
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + duration);
            },
            
            playClick() {
                this.playTone(800, 0.1, 'square', 0.05);
            },
            
            playGunshot() {
                this.playTone(200, 0.05, 'sawtooth', 0.2);
                this.playTone(100, 0.1, 'sawtooth', 0.1);
            },
            
            playExplosion() {
                this.playTone(80, 0.3, 'sawtooth', 0.3);
                this.playTone(60, 0.5, 'sawtooth', 0.2);
            },
            
            playHeal() {
                this.playTone(400, 0.3, 'sine', 0.1);
            },
            
            playLevelUp() {
                this.playTone(523, 0.1, 'sine', 0.1);
                setTimeout(() => this.playTone(659, 0.1, 'sine', 0.1), 100);
                setTimeout(() => this.playTone(784, 0.1, 'sine', 0.1), 200);
            },
            
            playVictory() {
                this.playTone(784, 0.2, 'sine', 0.1);
                setTimeout(() => this.playTone(659, 0.2, 'sine', 0.1), 200);
                setTimeout(() => this.playTone(523, 0.2, 'sine', 0.1), 400);
            },
            
            playDefeat() {
                this.playTone(200, 0.5, 'sawtooth', 0.1);
            },
            
            playCritical() {
                this.playTone(1000, 0.2, 'sawtooth', 0.2);
            },
            
            playDodge() {
                this.playTone(1200, 0.1, 'triangle', 0.1);
            },
            
            playAchievement() {
                this.playTone(1047, 0.1, 'sine', 0.1);
                setTimeout(() => this.playTone(1319, 0.1, 'sine', 0.1), 100);
                setTimeout(() => this.playTone(1568, 0.2, 'sine', 0.1), 200);
            }
        };

        // Ranks System
        const ranks = [
            { level: 1, name: 'Private', expRequired: 0 },
            { level: 2, name: 'Private First Class', expRequired: 100 },
            { level: 3, name: 'Corporal', expRequired: 250 },
            { level: 4, name: 'Sergeant', expRequired: 500 },
            { level: 5, name: 'Staff Sergeant', expRequired: 800 },
            { level: 6, name: 'Sergeant First Class', expRequired: 1200 },
            { level: 7, name: 'Master Sergeant', expRequired: 1700 },
            { level: 8, name: 'First Sergeant', expRequired: 2300 },
            { level: 9, name: 'Sergeant Major', expRequired: 3000 },
            { level: 10, name: 'Lieutenant', expRequired: 4000 }
        ];

        // Orders (Quests)
        const orders = {
            clearBeach: {
                id: "clearBeach",
                name: "Clear the Beach",
                description: "Eliminate 5 German Infantry units",
                target: "German Infantry",
                required: 5,
                current: 0,
                reward: { gold: 100, exp: 75, item: "thompson_smg" },
                completed: false
            },
            destroyMG: {
                id: "destroyMG",
                name: "Destroy MG Nest",
                description: "Take out 3 MG42 Gunners",
                target: "MG42 Gunner",
                required: 3,
                current: 0,
                reward: { gold: 150, exp: 100, item: "flak_jacket" },
                completed: false
            },
            assassinateOfficer: {
                id: "assassinateOfficer",
                name: "Assassinate SS Officer",
                description: "Eliminate the SS Officer",
                target: "SS Officer",
                required: 1,
                current: 0,
                reward: { gold: 200, exp: 150, item: "springfield_rifle" },
                completed: false
            },
            // NEW ORDERS
            destroyTank: {
                id: "destroyTank",
                name: "Destroy Panzer Tank",
                description: "Take out the enemy tank",
                target: "Panzer Tank",
                required: 1,
                current: 0,
                reward: { gold: 300, exp: 250, item: "bazooka" },
                completed: false
            },
            secureBunker: {
                id: "secureBunker",
                name: "Secure Coastal Bunker",
                description: "Clear 10 enemies from the beach",
                target: "total_enemies",
                required: 10,
                current: 0,
                reward: { gold: 250, exp: 200, item: "medal_purple_heart" },
                completed: false
            },
            rescuePOW: {
                id: "rescuePOW",
                name: "Rescue Prisoners of War",
                description: "Complete 5 missions without being defeated",
                target: "missions_survived",
                required: 5,
                current: 0,
                reward: { gold: 350, exp: 300, item: "medal_bronze_star" },
                completed: false
            }
        };

        // Achievements (Medals)
        const achievements = {
            firstBlood: {
                id: "firstBlood",
                name: "First Blood",
                description: "Defeat your first enemy",
                icon: "âš”ï¸",
                check: () => gameState.enemiesDefeated >= 1,
                unlocked: false
            },
            infantryExpert: {
                id: "infantryExpert",
                name: "Infantry Expert",
                description: "Defeat 25 German Infantry",
                icon: "ðŸŽ¯",
                check: () => gameState.infantryDefeated >= 25,
                unlocked: false
            },
            tankHunter: {
                id: "tankHunter",
                name: "Tank Hunter",
                description: "Destroy 3 Panzer Tanks",
                icon: "ðŸ›¡ï¸",
                check: () => gameState.tanksDestroyed >= 3,
                unlocked: false
            },
            marksman: {
                id: "marksman",
                name: "Expert Marksman",
                description: "Land 50 critical hits",
                icon: "ðŸŽ–ï¸",
                check: () => {
                    // We'll track this separately, but for now use a placeholder
                    return gameState.enemiesDefeated >= 30;
                },
                unlocked: false
            },
            medic: {
                id: "medic",
                name: "Field Medic",
                description: "Use healing items 20 times",
                icon: "ðŸ¥",
                check: () => gameState.timesWounded >= 5, // Placeholder
                unlocked: false
            },
            dDayHero: {
                id: "dDayHero",
                name: "D-Day Hero",
                description: "Complete 25 missions",
                icon: "ðŸ…",
                check: () => gameState.missionsCompleted >= 25,
                unlocked: false
            },
            // NEW ACHIEVEMENTS
            sniperHunter: {
                id: "sniperHunter",
                name: "Sniper Hunter",
                description: "Defeat 10 enemy snipers",
                icon: "ðŸ‘ï¸",
                check: () => gameState.snipersDefeated >= 10,
                unlocked: false
            },
            officerEliminator: {
                id: "officerEliminator",
                name: "Officer Eliminator",
                description: "Defeat 5 SS Officers",
                icon: "â­",
                check: () => gameState.officersDefeated >= 5,
                unlocked: false
            },
            beachMaster: {
                id: "beachMaster",
                name: "Beach Master",
                description: "Clear 50 beach enemies",
                icon: "ðŸ–ï¸",
                check: () => gameState.enemiesDefeated >= 50,
                unlocked: false
            },
            survivalExpert: {
                id: "survivalExpert",
                name: "Survival Expert",
                description: "Survive 10 battles without retreating",
                icon: "â¤ï¸",
                check: () => gameState.missionsCompleted >= 10 && gameState.timesWounded <= 2,
                unlocked: false
            }
        };

        // Training Trees
        const trainingTrees = {
            infantry: [
                { id: "infantry1", name: "Rifle Training", description: "Increases accuracy by 10%", cost: 1, effect: "accuracyBoost", value: 10, requires: [] },
                { id: "infantry2", name: "Grenade Expert", description: "Grenade damage +25%", cost: 1, effect: "grenadeBoost", value: 0.25, requires: ["infantry1"] },
                { id: "infantry3", name: "Bayonet Drill", description: "Close combat damage +20%", cost: 2, effect: "meleeBoost", value: 0.2, requires: ["infantry1"] },
                { id: "infantry4", name: "Fire Discipline", description: "Reduces stamina cost by 20%", cost: 2, effect: "staminaEfficiency", value: 0.2, requires: ["infantry2", "infantry3"] },
                { id: "infantry5", name: "Cover Movement", description: "Cover effectiveness +30%", cost: 2, effect: "coverBoost", value: 30, requires: ["infantry2"] },
                { id: "infantry6", name: "Fire Team Leader", description: "Critical chance +10%", cost: 3, effect: "criticalBoost", value: 10, requires: ["infantry4"] }
            ],
            sniper: [
                { id: "sniper1", name: "Sniper Training", description: "Critical damage +25%", cost: 1, effect: "criticalDamage", value: 0.25, requires: [] },
                { id: "sniper2", name: "Steady Aim", description: "Accuracy +15%", cost: 1, effect: "accuracyBoost", value: 15, requires: ["sniper1"] },
                { id: "sniper3", name: "Camouflage", description: "Enemy accuracy -10% against you", cost: 2, effect: "camouflage", value: 10, requires: ["sniper1"] },
                { id: "sniper4", name: "Breath Control", description: "Aimed shot costs -30% stamina", cost: 2, effect: "staminaEfficiency", value: 0.3, requires: ["sniper2", "sniper3"] },
                { id: "sniper5", name: "Quick Scope", description: "Can fire twice per turn occasionally", cost: 2, effect: "quickScope", value: 0.15, requires: ["sniper2"] },
                { id: "sniper6", name: "Master Sniper", description: "Ignore enemy cover 50% of time", cost: 3, effect: "coverPenetration", value: 0.5, requires: ["sniper4"] }
            ],
            medic: [
                { id: "medic1", name: "Field Medicine", description: "Healing effectiveness +25%", cost: 1, effect: "healBoost", value: 0.25, requires: [] },
                { id: "medic2", name: "Triage Training", description: "Can heal while in cover", cost: 1, effect: "coverHeal", value: 1, requires: ["medic1"] },
                { id: "medic3", name: "Pain Management", description: "Restore 10% stamina when healing", cost: 2, effect: "staminaRestore", value: 0.1, requires: ["medic1"] },
                { id: "medic4", name: "Combat Medic", description: "25% chance to heal when attacked", cost: 2, effect: "autoHeal", value: 0.25, requires: ["medic2", "medic3"] },
                { id: "medic5", name: "Medical Supplies", description: "Medical items 50% more effective", cost: 2, effect: "itemBoost", value: 0.5, requires: ["medic2"] },
                { id: "medic6", name: "Master Medic", description: "Can revive once per mission", cost: 3, effect: "revive", value: 1, requires: ["medic4"] }
            ],
            engineer: [
                { id: "engineer1", name: "Demolitions", description: "Explosive damage +30%", cost: 1, effect: "explosiveBoost", value: 0.3, requires: [] },
                { id: "engineer2", name: "Fortifications", description: "Defense +20%", cost: 1, effect: "defenseBoost", value: 0.2, requires: ["engineer1"] },
                { id: "engineer3", name: "Tank Warfare", description: "Damage vs vehicles +50%", cost: 2, effect: "antiTank", value: 0.5, requires: ["engineer1"] },
                { id: "engineer4", name: "Breaching Expert", description: "Ignore enemy cover 30% of time", cost: 2, effect: "coverPenetration", value: 0.3, requires: ["engineer2", "engineer3"] },
                { id: "engineer5", name: "Shrapnel Expert", description: "Explosives have wider area", cost: 2, effect: "areaBoost", value: 0.4, requires: ["engineer2"] },
                { id: "engineer6", name: "Master Engineer", description: "Chance to stun with explosives", cost: 3, effect: "stunChance", value: 0.25, requires: ["engineer4"] }
            ]
        };

        // Game Data - WWII Classes
        const classes = {
            infantry: {
                name: "Infantry",
                hp: 110,
                mp: 60,
                strength: 12,
                defense: 8,
                agility: 8,
                accuracy: 75,
                critical: 5,
                startingItems: ['m1_garand', 'helmet', 'rations', 'grenade'],
                startingAbilities: ['grenade_toss']
            },
            sniper: {
                name: "Sniper",
                hp: 90,
                mp: 50,
                strength: 8,
                defense: 5,
                agility: 12,
                accuracy: 90,
                critical: 20,
                startingItems: ['springfield_rifle', 'helmet', 'rations'],
                startingAbilities: ['aimed_shot']
            },
            medic: {
                name: "Combat Medic",
                hp: 100,
                mp: 80,
                strength: 7,
                defense: 6,
                agility: 10,
                accuracy: 70,
                critical: 3,
                startingItems: ['m1911_pistol', 'medic_helmet', 'medkit', 'rations'],
                startingAbilities: ['field_bandage']
            },
            engineer: {
                name: "Combat Engineer",
                hp: 120,
                mp: 40,
                strength: 15,
                defense: 12,
                agility: 6,
                accuracy: 65,
                critical: 8,
                startingItems: ['shotgun', 'flak_jacket', 'rations', 'satchel_charge'],
                startingAbilities: ['satchel_charge']
            }
        };

        // WWII Items
        const items = {
            // Weapons - Primary
            m1_garand: { 
                name: "M1 Garand", 
                type: "weapon", 
                slot: "primary", 
                damage: { min: 15, max: 25 },
                accuracy: 10,
                critical: 5,
                value: 30,
                rarity: "common"
            },
            springfield_rifle: { 
                name: "Springfield M1903", 
                type: "weapon", 
                slot: "primary", 
                damage: { min: 25, max: 40 },
                accuracy: 20,
                critical: 15,
                value: 50,
                rarity: "uncommon"
            },
            thompson_smg: { 
                name: "Thompson SMG", 
                type: "weapon", 
                slot: "primary", 
                damage: { min: 8, max: 20 },
                agility: 5,
                accuracy: 5,
                value: 40,
                rarity: "uncommon"
            },
            shotgun: { 
                name: "M1897 Trench Gun", 
                type: "weapon", 
                slot: "primary", 
                damage: { min: 20, max: 35 },
                critical: 10,
                accuracy: -10,
                value: 45,
                rarity: "uncommon"
            },
            bar_rifle: { 
                name: "BAR Automatic Rifle", 
                type: "weapon", 
                slot: "primary", 
                damage: { min: 18, max: 30 },
                accuracy: 5,
                critical: 8,
                value: 60,
                rarity: "rare"
            },
            bazooka: { 
                name: "M1 Bazooka", 
                type: "weapon", 
                slot: "special", 
                damage: { min: 40, max: 60 },
                accuracy: -15,
                value: 120,
                rarity: "epic"
            },
            
            // Weapons - Secondary
            m1911_pistol: { 
                name: "M1911 Pistol", 
                type: "weapon", 
                slot: "secondary", 
                damage: { min: 8, max: 15 },
                accuracy: 5,
                value: 15,
                rarity: "common"
            },
            
            // Armor
            helmet: { 
                name: "M1 Steel Helmet", 
                type: "armor", 
                slot: "head", 
                defense: 6,
                value: 10,
                rarity: "common"
            },
            medic_helmet: { 
                name: "Medic Helmet", 
                type: "armor", 
                slot: "head", 
                defense: 4,
                value: 12,
                rarity: "common"
            },
            flak_jacket: { 
                name: "Flak Jacket", 
                type: "armor", 
                slot: "chest", 
                defense: 10,
                value: 30,
                rarity: "uncommon"
            },
            combat_boots: { 
                name: "Combat Boots", 
                type: "armor", 
                slot: "hands", 
                defense: 3,
                agility: 2,
                value: 15,
                rarity: "common"
            },
            
            // Special Equipment
            binoculars: { 
                name: "Field Binoculars", 
                type: "special", 
                slot: "special", 
                accuracy: 15,
                value: 25,
                rarity: "uncommon"
            },
            first_aid_pack: { 
                name: "First Aid Pack", 
                type: "special", 
                slot: "special", 
                defense: 5,
                value: 20,
                rarity: "common"
            },
            
            // Consumables
            rations: { 
                name: "C-Rations", 
                type: "consumable", 
                effect: "heal", 
                power: 25, 
                value: 5,
                rarity: "common"
            },
            medkit: { 
                name: "Field Medkit", 
                type: "consumable", 
                effect: "heal", 
                power: 50, 
                value: 15,
                rarity: "uncommon"
            },
            morphine: { 
                name: "Morphine Syrette", 
                type: "consumable", 
                effect: "full_heal", 
                power: 0, 
                value: 30,
                rarity: "rare"
            },
            grenade: { 
                name: "Frag Grenade", 
                type: "consumable", 
                effect: "grenade_damage", 
                power: 40, 
                value: 20,
                rarity: "uncommon"
            },
            smoke_grenade: { 
                name: "Smoke Grenade", 
                type: "consumable", 
                effect: "smoke_screen", 
                power: 0, 
                value: 25,
                rarity: "uncommon"
            },
            satchel_charge: { 
                name: "Satchel Charge", 
                type: "consumable", 
                effect: "explosive_damage", 
                power: 60, 
                value: 40,
                rarity: "rare"
            },
            
            // Medals
            medal_purple_heart: {
                name: "Purple Heart",
                type: "medal",
                slot: "medal",
                defense: 5,
                value: 100,
                rarity: "epic"
            },
            medal_bronze_star: {
                name: "Bronze Star",
                type: "medal",
                slot: "medal",
                strength: 5,
                critical: 5,
                value: 150,
                rarity: "epic"
            }
        };

        // Abilities (Replacing Spells)
        const abilities = {
            grenade_toss: { 
                name: "Grenade Toss", 
                cost: 20, 
                damage: { min: 30, max: 50 },
                type: "attack",
                accuracy: 70,
                levelReq: 1,
                goldCost: 40,
                description: "Throw a fragmentation grenade at the enemy",
                effect: { type: "suppressed", chance: 0.3, duration: 2 }
            },
            aimed_shot: { 
                name: "Aimed Shot", 
                cost: 25, 
                damage: { min: 35, max: 55 },
                type: "attack",
                accuracy: 95,
                critical: 25,
                levelReq: 1,
                goldCost: 60,
                description: "Take careful aim for a precise, powerful shot"
            },
            field_bandage: { 
                name: "Field Bandage", 
                cost: 15, 
                power: 40, 
                type: "heal",
                levelReq: 1,
                goldCost: 30,
                description: "Apply emergency field dressing to stop bleeding"
            },
            bayonet_charge: { 
                name: "Bayonet Charge", 
                cost: 30, 
                damage: { min: 25, max: 40 },
                type: "attack",
                accuracy: 80,
                levelReq: 2,
                goldCost: 50,
                description: "Close-quarters bayonet assault",
                effect: { type: "bleeding", chance: 0.4, duration: 3, damage: 5 }
            },
            suppression_fire: { 
                name: "Suppression Fire", 
                cost: 18, 
                damage: { min: 15, max: 25 },
                type: "attack",
                accuracy: 65,
                levelReq: 2,
                goldCost: 35,
                description: "Lay down suppressing fire to pin enemy",
                effect: { type: "pinned", chance: 0.5, duration: 2 }
            },
            // NEW ABILITIES
            satchel_charge: {
                name: "Satchel Charge",
                cost: 40,
                damage: { min: 50, max: 75 },
                type: "attack",
                accuracy: 60,
                levelReq: 3,
                goldCost: 80,
                description: "Place explosive charge on enemy position",
                effect: { type: "stunned", chance: 0.6, duration: 2 }
            },
            smoke_screen: {
                name: "Smoke Screen",
                cost: 15,
                type: "buff",
                levelReq: 2,
                goldCost: 25,
                description: "Deploy smoke for cover",
                effect: { type: "cover", chance: 1.0, duration: 3, value: 40 }
            },
            first_aid: {
                name: "First Aid",
                cost: 20,
                power: 60,
                type: "heal",
                levelReq: 3,
                goldCost: 50,
                description: "Advanced medical treatment"
            },
            rapid_fire: {
                name: "Rapid Fire",
                cost: 35,
                damage: { min: 20, max: 35 },
                type: "attack",
                accuracy: 70,
                levelReq: 4,
                goldCost: 70,
                description: "Unload a burst of automatic fire",
                effect: { type: "suppressed", chance: 0.8, duration: 3 }
            },
            artillery_call: {
                name: "Artillery Call",
                cost: 50,
                damage: { min: 60, max: 90 },
                type: "attack",
                accuracy: 85,
                levelReq: 5,
                goldCost: 120,
                description: "Call in artillery support on enemy position"
            }
        };

        // WWII Enemies
        const enemies = {
            level1: [
                { 
                    name: "German Infantry", 
                    hp: 40, 
                    attack: 12, 
                    defense: 6, 
                    accuracy: 70,
                    dodge: 5,
                    critical: 5,
                    exp: 25, 
                    gold: 15, 
                    loot: [
                        { id: 'rations', chance: 0.8 },
                        { id: 'helmet', chance: 0.3 }
                    ],
                    resistances: { explosive: 0.8 }
                },
                { 
                    name: "German Rifleman", 
                    hp: 35, 
                    attack: 14, 
                    defense: 5, 
                    accuracy: 75,
                    critical: 8,
                    exp: 28, 
                    gold: 18, 
                    loot: [
                        { id: 'rations', chance: 0.7 },
                        { id: 'm1911_pistol', chance: 0.2 }
                    ]
                },
                { 
                    name: "German Grenadier", 
                    hp: 45, 
                    attack: 16, 
                    defense: 7, 
                    accuracy: 65,
                    exp: 30, 
                    gold: 20, 
                    loot: [
                        { id: 'grenade', chance: 0.5 },
                        { id: 'rations', chance: 0.6 }
                    ],
                    abilities: ["grenade_attack"]
                }
            ],
            level2: [
                { 
                    name: "MG42 Gunner", 
                    hp: 60, 
                    attack: 20, 
                    defense: 8, 
                    accuracy: 75,
                    exp: 40, 
                    gold: 30, 
                    loot: [
                        { id: 'rations', chance: 0.6 },
                        { id: 'first_aid_pack', chance: 0.4 }
                    ],
                    abilities: ["suppression_fire"]
                },
                { 
                    name: "German Sniper", 
                    hp: 50, 
                    attack: 22, 
                    defense: 4, 
                    accuracy: 90,
                    critical: 20,
                    exp: 45, 
                    gold: 35, 
                    loot: [
                        { id: 'rations', chance: 0.5 },
                        { id: 'binoculars', chance: 0.3 }
                    ],
                    abilities: ["aimed_shot"]
                },
                { 
                    name: "German Officer", 
                    hp: 55, 
                    attack: 18, 
                    defense: 9, 
                    accuracy: 80,
                    critical: 10,
                    exp: 50, 
                    gold: 40, 
                    loot: [
                        { id: 'medkit', chance: 0.4 },
                        { id: 'flak_jacket', chance: 0.3 }
                    ],
                    abilities: ["command_aura"]
                }
            ],
            level3: [
                { 
                    name: "SS Trooper", 
                    hp: 80, 
                    attack: 25, 
                    defense: 12, 
                    accuracy: 80,
                    critical: 12,
                    exp: 70, 
                    gold: 50, 
                    loot: [
                        { id: 'medkit', chance: 0.6 },
                        { id: 'thompson_smg', chance: 0.3 }
                    ],
                    abilities: ["elite_combat"]
                },
                { 
                    name: "SS Officer", 
                    hp: 90, 
                    attack: 28, 
                    defense: 10, 
                    accuracy: 85,
                    critical: 15,
                    exp: 80, 
                    gold: 60, 
                    loot: [
                        { id: 'morphine', chance: 0.4 },
                        { id: 'bar_rifle', chance: 0.2 }
                    ],
                    abilities: ["command", "inspire"]
                },
                { 
                    name: "German Engineer", 
                    hp: 75, 
                    attack: 22, 
                    defense: 15, 
                    accuracy: 70,
                    exp: 65, 
                    gold: 55, 
                    loot: [
                        { id: 'satchel_charge', chance: 0.3 },
                        { id: 'flak_jacket', chance: 0.5 }
                    ],
                    abilities: ["explosives"]
                }
            ],
            level4: [
                { 
                    name: "Panzer Grenadier", 
                    hp: 100, 
                    attack: 30, 
                    defense: 14, 
                    accuracy: 75,
                    exp: 90, 
                    gold: 70, 
                    loot: [
                        { id: 'medkit', chance: 0.7 },
                        { id: 'bazooka', chance: 0.1 }
                    ],
                    abilities: ["armor_piercing"]
                },
                { 
                    name: "FallschirmjÃ¤ger", 
                    hp: 95, 
                    attack: 32, 
                    defense: 10, 
                    accuracy: 85,
                    critical: 18,
                    exp: 95, 
                    gold: 75, 
                    loot: [
                        { id: 'morphine', chance: 0.5 },
                        { id: 'springfield_rifle', chance: 0.2 }
                    ],
                    abilities: ["paratrooper_training"]
                }
            ],
            bosses: [
                {
                    name: "Panzer Tank",
                    hp: 200,
                    attack: 35,
                    defense: 25,
                    accuracy: 70,
                    exp: 150,
                    gold: 120,
                    isBoss: true,
                    loot: [
                        { id: 'bazooka', chance: 0.5 },
                        { id: 'medal_purple_heart', chance: 0.3 }
                    ],
                    phases: [
                        { hpThreshold: 0.7, ability: "main_gun", message: "The Panzer fires its main gun!" },
                        { hpThreshold: 0.4, ability: "machine_gun", message: "The Panzer's machine gun opens fire!" },
                        { hpThreshold: 0.2, ability: "emergency_repair", message: "The crew attempts emergency repairs!" }
                    ]
                },
                {
                    name: "Bunker Complex",
                    hp: 180,
                    attack: 30,
                    defense: 30,
                    accuracy: 80,
                    exp: 140,
                    gold: 110,
                    isBoss: true,
                    loot: [
                        { id: 'bar_rifle', chance: 0.6 },
                        { id: 'medal_bronze_star', chance: 0.2 }
                    ],
                    phases: [
                        { hpThreshold: 0.75, ability: "mg_nest", message: "MG42 nest opens fire from the bunker!" },
                        { hpThreshold: 0.5, ability: "mortar_support", message: "Mortar rounds begin falling!" },
                        { hpThreshold: 0.25, ability: "last_stand", message: "Enemies make a final stand!" }
                    ]
                }
            ]
        };

        // DOM Elements
        const screens = {
            start: document.getElementById('start-screen'),
            load: document.getElementById('load-screen'),
            class: document.getElementById('class-screen'),
            game: document.getElementById('game-screen'),
            battle: document.getElementById('battle-screen'),
            abilitySelect: document.getElementById('ability-select-screen'),
            inventory: document.getElementById('inventory-screen'),
            abilities: document.getElementById('abilities-screen'),
            supply: document.getElementById('supply-screen'),
            orders: document.getElementById('orders-screen'),
            training: document.getElementById('training-screen'),
            achievements: document.getElementById('achievements-screen'),
            loot: document.getElementById('loot-screen')
        };

        function initGame() {
    console.log("Initializing Normandy Beach Assault...");
    
    // Initialize sound manager
    SoundManager.init();
    
    // Set up event listeners
    document.getElementById('start-button').addEventListener('click', () => {
        SoundManager.playClick();
        showClassSelection();
    });
    
    document.getElementById('load-button').addEventListener('click', () => {
        SoundManager.playClick();
        showLoadScreen();
    });
    
    // FIX: Properly set up class selection with event delegation
    const classScreen = document.getElementById('class-screen');
    if (classScreen) {
        classScreen.addEventListener('click', (e) => {
            // Find the clicked class option
            const classOption = e.target.closest('.class-option');
            if (classOption) {
                SoundManager.playClick();
                const selectedClass = classOption.dataset.class;
                console.log('Selected class:', selectedClass);
                selectClass(selectedClass);
            }
        });
    }
    
    // Rest of your existing event listeners...
    document.getElementById('scout-button').addEventListener('click', () => {
        SoundManager.playClick();
        startBattle();
    });
    
    // ... rest of your existing initGame code ...
    
    console.log("Game initialized successfully");
}
            
            const classOptions = document.querySelectorAll('.class-option');
            classOptions.forEach(option => {
                option.addEventListener('click', () => {
                    SoundManager.playClick();
                    selectClass(option.dataset.class);
                });
            });
            
            document.getElementById('scout-button').addEventListener('click', () => {
                SoundManager.playClick();
                startBattle();
            });
            
            document.getElementById('inventory-button').addEventListener('click', () => {
                SoundManager.playClick();
                showInventory();
            });
            
            document.getElementById('abilities-button').addEventListener('click', () => {
                SoundManager.playClick();
                showAbilities();
            });
            
            document.getElementById('supply-button').addEventListener('click', () => {
                SoundManager.playClick();
                showSupplyDepot();
            });
            
            document.getElementById('orders-button').addEventListener('click', () => {
                SoundManager.playClick();
                showOrders();
            });
            
            document.getElementById('training-button').addEventListener('click', () => {
                SoundManager.playClick();
                showTraining();
            });
            
            document.getElementById('achievements-button').addEventListener('click', () => {
                SoundManager.playClick();
                showAchievements();
            });
            
            document.getElementById('save-button').addEventListener('click', () => {
                SoundManager.playClick();
                saveGame(0);
                addToGameLog("Game saved at command post.");
            });
            
            document.getElementById('back-from-inventory').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-abilities').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-supply').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-orders').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-training').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-achievements').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-load').addEventListener('click', () => {
                SoundManager.playClick();
                showScreen('start');
            });
            
            document.getElementById('back-from-ability-select').addEventListener('click', () => {
                SoundManager.playClick();
                showBattleScreen();
            });
            
            // Battle buttons
            document.getElementById('attack-button').addEventListener('click', playerAttack);
            document.getElementById('ability-button').addEventListener('click', () => {
                SoundManager.playClick();
                showAbilitySelection();
            });
            document.getElementById('item-button').addEventListener('click', useItemInBattle);
            document.getElementById('cover-button').addEventListener('click', takeCover);
            document.getElementById('flee-button').addEventListener('click', attemptRetreat);
            
            document.getElementById('take-loot').addEventListener('click', () => {
                SoundManager.playClick();
                takeLoot();
            });
            
            // Sound toggle
            document.getElementById('sound-toggle').addEventListener('click', toggleSound);
            
            // Sort buttons
            document.querySelectorAll('.sort-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    SoundManager.playClick();
                    sortInventory(e.target.dataset.sort);
                });
            });
            
            // Quick slots
            document.querySelectorAll('.quick-slot').forEach(slot => {
                slot.addEventListener('click', (e) => {
                    SoundManager.playClick();
                    useQuickSlot(parseInt(e.target.dataset.slot));
                });
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyPress);
            
            // Initialize orders
            initializeOrders();
            
            // Initialize achievements
            initializeAchievements();
            
            // Initialize game log
            addToGameLog("June 6, 1944 - Omaha Beach. You're at the command post behind the front lines. The sound of artillery echoes in the distance...");
            
            console.log("Game initialized successfully");
        }

        // Screen management
        function showScreen(screenName) {
            // Hide all screens
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show the requested screen
            screens[screenName].classList.add('active');
            gameState.currentScreen = screenName;
        }

        function showClassSelection() {
    showScreen('class');
    // Make sure class options are visible and clickable
    const classOptions = document.querySelectorAll('.class-option');
    classOptions.forEach(option => {
        option.style.cursor = 'pointer';
        option.style.pointerEvents = 'auto';
    });
}

        function selectClass(className) {
    console.log('selectClass called with:', className);
    
    if (!classes[className]) {
        console.error('Invalid class selected:', className);
        return;
    }
    
    gameState.player.class = className;
    const classData = classes[className];
    
    // Set player stats based on class
    gameState.player.maxHp = classData.hp;
    gameState.player.hp = classData.hp;
    gameState.player.maxMp = classData.mp;
    gameState.player.mp = classData.mp;
    gameState.player.strength = classData.strength;
    gameState.player.defense = classData.defense;
    gameState.player.agility = classData.agility;
    gameState.player.accuracy = classData.accuracy;
    gameState.player.critical = classData.critical;
    
    // Add starting items
    classData.startingItems.forEach(itemId => {
        gameState.player.inventory.push(itemId);
    });
    
    // Add starting abilities
    classData.startingAbilities.forEach(abilityId => {
        gameState.player.abilities.push(abilityId);
    });
    
    // Equip starting items
    if (className === 'infantry') {
        equipItem('m1_garand', 'primary');
        equipItem('helmet', 'head');
    } else if (className === 'sniper') {
        equipItem('springfield_rifle', 'primary');
        equipItem('helmet', 'head');
    } else if (className === 'medic') {
        equipItem('m1911_pistol', 'secondary');
        equipItem('medic_helmet', 'head');
    } else if (className === 'engineer') {
        equipItem('shotgun', 'primary');
        equipItem('flak_jacket', 'chest');
    }
    
    // Update UI
    updatePlayerStats();
    showGameScreen();
    
    addToGameLog(`You have been assigned as ${classData.name}.`);
    addToGameLog("Report to the command post for your orders...");
}
            

        function showGameScreen() {
            showScreen('game');
            updatePlayerStats();
            updateStatusEffects();
            updateRankDisplay();
        }

        function showBattleScreen() {
            showScreen('battle');
            updateBattleStats();
        }

        function showInventory() {
            showScreen('inventory');
            updateInventoryDisplay();
        }

        function showAbilities() {
            showScreen('abilities');
            updateAbilitiesDisplay();
        }

        function showSupplyDepot() {
            showScreen('supply');
            updateSupplyDepotDisplay();
        }

        function showAbilitySelection() {
            showScreen('abilitySelect');
            updateAbilitySelectionDisplay();
        }

        function showOrders() {
            showScreen('orders');
            updateOrdersDisplay();
        }

        function showTraining() {
            showScreen('training');
            updateTrainingDisplay();
        }

        function showAchievements() {
            showScreen('achievements');
            updateAchievementsDisplay();
        }

        function showLoadScreen() {
            showScreen('load');
            updateLoadScreen();
        }

        // Initialize orders
        function initializeOrders() {
            gameState.player.orders = [
                { ...orders.clearBeach },
                { ...orders.destroyMG },
                { ...orders.assassinateOfficer },
                { ...orders.destroyTank },
                { ...orders.secureBunker },
                { ...orders.rescuePOW }
            ];
        }

        // Initialize achievements
        function initializeAchievements() {
            gameState.player.achievements = [];
        }

        // Check achievements
        function checkAchievements() {
            Object.keys(achievements).forEach(achievementId => {
                const achievement = achievements[achievementId];
                if (!gameState.player.achievements.includes(achievementId) && achievement.check()) {
                    unlockAchievement(achievementId);
                }
            });
        }

        function unlockAchievement(achievementId) {
            const achievement = achievements[achievementId];
            gameState.player.achievements.push(achievementId);
            
            // Show achievement popup
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <div class="achievement-icon">${achievement.icon}</div>
                <h3>Medal Awarded!</h3>
                <strong>${achievement.name}</strong><br>
                <small>${achievement.description}</small>
            `;
            
            document.body.appendChild(popup);
            
            // Play sound
            SoundManager.playAchievement();
            
            // Remove popup after animation
            setTimeout(() => {
                popup.remove();
            }, 3000);
            
            addToGameLog(`Awarded: ${achievement.name}!`);
        }

        // Handle keyboard shortcuts
        function handleKeyPress(event) {
            if (gameState.currentScreen === 'battle') {
                switch(event.key) {
                    case '1':
                        SoundManager.playClick();
                        playerAttack();
                        break;
                    case '2':
                        SoundManager.playClick();
                        showAbilitySelection();
                        break;
                    case '3':
                        SoundManager.playClick();
                        useItemInBattle();
                        break;
                    case '4':
                        SoundManager.playClick();
                        takeCover();
                        break;
                    case '5':
                        SoundManager.playClick();
                        attemptRetreat();
                        break;
                }
            }
        }

        // Toggle sound on/off
        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            document.getElementById('sound-toggle').textContent = 
                gameState.soundEnabled ? "ðŸ”Š SOUND ON" : "ðŸ”‡ SOUND OFF";
            SoundManager.playClick();
        }

        // Quick Slot System
        function useQuickSlot(slot) {
            const itemId = gameState.player.quickSlots[slot];
            if (!itemId) return;
            
            if (items[itemId]) {
                // It's an item
                useItem(itemId);
            } else if (abilities[itemId]) {
                // It's an ability
                if (gameState.currentScreen === 'battle') {
                    castAbility(itemId);
                }
            }
        }

        function assignQuickSlot(slot, itemId) {
            gameState.player.quickSlots[slot] = itemId;
            updateQuickSlotDisplay();
        }

        function updateQuickSlotDisplay() {
            for (let i = 0; i < 3; i++) {
                const itemId = gameState.player.quickSlots[i];
                const slotElement = document.getElementById(`quick-slot-${i}`);
                const battleSlotElement = document.getElementById(`battle-quick-slot-${i}`);
                
                if (itemId) {
                    const item = items[itemId] || abilities[itemId];
                    if (item) {
                        slotElement.textContent = `${i + 1}: ${item.name.substring(0, 3)}`;
                        if (battleSlotElement) {
                            battleSlotElement.textContent = `${i + 1}: ${item.name.substring(0, 3)}`;
                        }
                    }
                } else {
                    slotElement.textContent = i + 1;
                    if (battleSlotElement) {
                        battleSlotElement.textContent = i + 1;
                    }
                }
            }
        }

        // Save System
        function saveGame(slot) {
            const saveData = {
                player: gameState.player,
                timestamp: Date.now(),
                version: "1.0",
                enemiesDefeated: gameState.enemiesDefeated,
                missionsCompleted: gameState.missionsCompleted,
                totalSuppliesEarned: gameState.totalSuppliesEarned,
                abilitiesLearned: gameState.abilitiesLearned,
                tanksDestroyed: gameState.tanksDestroyed,
                infantryDefeated: gameState.infantryDefeated,
                snipersDefeated: gameState.snipersDefeated,
                officersDefeated: gameState.officersDefeated,
                timesWounded: gameState.timesWounded
            };
            
            localStorage.setItem(`normandySave_${slot}`, JSON.stringify(saveData));
        }

        function loadGame(slot) {
            const saveData = localStorage.getItem(`normandySave_${slot}`);
            if (saveData) {
                const data = JSON.parse(saveData);
                
                // Restore game state
                gameState.player = data.player;
                gameState.enemiesDefeated = data.enemiesDefeated || 0;
                gameState.missionsCompleted = data.missionsCompleted || 0;
                gameState.totalSuppliesEarned = data.totalSuppliesEarned || 0;
                gameState.abilitiesLearned = data.abilitiesLearned || 0;
                gameState.tanksDestroyed = data.tanksDestroyed || 0;
                gameState.infantryDefeated = data.infantryDefeated || 0;
                gameState.snipersDefeated = data.snipersDefeated || 0;
                gameState.officersDefeated = data.officersDefeated || 0;
                gameState.timesWounded = data.timesWounded || 0;
                
                updatePlayerStats();
                showGameScreen();
                addToGameLog("Game loaded successfully!");
                
                // Check achievements after load
                checkAchievements();
            }
        }

        function updateLoadScreen() {
            const saveSlotsElement = document.getElementById('save-slots');
            saveSlotsElement.innerHTML = '';
            
            for (let i = 0; i < gameState.saveSlots; i++) {
                const saveData = localStorage.getItem(`normandySave_${i}`);
                const slotElement = document.createElement('div');
                slotElement.className = 'save-slot';
                
                if (saveData) {
                    const data = JSON.parse(saveData);
                    const date = new Date(data.timestamp);
                    slotElement.innerHTML = `
                        <strong>Slot ${i + 1}</strong><br>
                        ${data.player.rank} ${data.player.class}<br>
                        <small class="save-info">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</small>
                    `;
                } else {
                    slotElement.innerHTML = `
                        <strong>Slot ${i + 1}</strong><br>
                        <small class="save-info">Empty</small>
                    `;
                }
                
                slotElement.addEventListener('click', () => {
                    if (saveData) {
                        loadGame(i);
                    }
                });
                
                saveSlotsElement.appendChild(slotElement);
            }
        }

        // Training System
        function updateTrainingDisplay() {
            document.getElementById('training-points').textContent = gameState.player.trainingPoints;
            document.getElementById('training-class').textContent = gameState.player.class ? 
                gameState.player.class.charAt(0).toUpperCase() + gameState.player.class.slice(1) : 'None';
            
            const trainingTreeElement = document.getElementById('training-tree');
            trainingTreeElement.innerHTML = '';
            
            if (!gameState.player.class) {
                trainingTreeElement.innerHTML = '<div>Select a role first!</div>';
                return;
            }
            
            const skills = trainingTrees[gameState.player.class];
            skills.forEach(skill => {
                const isUnlocked = gameState.player.skills.includes(skill.id);
                const requirementsMet = skill.requires.every(req => gameState.player.skills.includes(req));
                const canUnlock = !isUnlocked && requirementsMet && gameState.player.trainingPoints >= skill.cost;
                
                const skillElement = document.createElement('div');
                skillElement.className = `skill-node ${isUnlocked ? 'unlocked' : canUnlock ? 'available' : 'locked'}`;
                skillElement.innerHTML = `
                    <strong>${skill.name}</strong><br>
                    <small>${skill.description}</small><br>
                    <small>Cost: ${skill.cost} point(s)</small>
                `;
                
                if (canUnlock) {
                    skillElement.addEventListener('click', () => {
                        unlockSkill(skill.id);
                    });
                }
                
                trainingTreeElement.appendChild(skillElement);
            });
        }

        function unlockSkill(skillId) {
            const skills = trainingTrees[gameState.player.class];
            const skill = skills.find(s => s.id === skillId);
            
            if (skill && gameState.player.trainingPoints >= skill.cost && !gameState.player.skills.includes(skillId)) {
                gameState.player.trainingPoints -= skill.cost;
                gameState.player.skills.push(skillId);
                
                // Apply skill effect
                applySkillEffect(skill);
                
                addToGameLog(`Trained: ${skill.name}!`);
                updateTrainingDisplay();
                updatePlayerStats();
            }
        }

        function applySkillEffect(skill) {
            // Apply skill effects to player stats
            switch(skill.effect) {
                case 'accuracyBoost':
                    gameState.player.accuracy += skill.value;
                    break;
                case 'grenadeBoost':
                    // Handled in combat calculations
                    break;
                case 'meleeBoost':
                    gameState.player.strength = Math.floor(gameState.player.strength * (1 + skill.value));
                    break;
                case 'staminaEfficiency':
                    // Handled in ability cost calculations
                    break;
                case 'coverBoost':
                    gameState.player.cover += skill.value;
                    break;
                case 'criticalBoost':
                    gameState.player.critical += skill.value;
                    break;
                case 'criticalDamage':
                    // Handled in combat calculations
                    break;
                case 'healBoost':
                    // Handled in healing calculations
                    break;
                case 'defenseBoost':
                    gameState.player.defense = Math.floor(gameState.player.defense * (1 + skill.value));
                    break;
            }
        }

        // Battle system
        function startBattle() {
            gameState.missionsCompleted++;
            
            // Determine enemy based on player level
            let enemyPool;
            if (gameState.player.level <= 2) {
                enemyPool = enemies.level1;
            } else if (gameState.player.level <= 4) {
                enemyPool = enemies.level2;
            } else if (gameState.player.level <= 6) {
                enemyPool = enemies.level3;
            } else if (gameState.player.level <= 8) {
                enemyPool = enemies.level4;
            } else {
                // Chance for boss encounter at higher levels
                if (Math.random() < 0.3) {
                    enemyPool = enemies.bosses;
                } else {
                    enemyPool = enemies.level4;
                }
            }
            
            // Select random enemy
            const randomIndex = Math.floor(Math.random() * enemyPool.length);
            gameState.currentEnemy = { ...enemyPool[randomIndex] };
            gameState.enemyMaxHp = gameState.currentEnemy.hp;
            
            // Initialize boss systems if it's a boss
            if (gameState.currentEnemy.isBoss) {
                document.getElementById('boss-health-container').style.display = 'block';
                document.getElementById('enemy-health-bar').style.display = 'none';
                updateBossHealth();
                gameState.currentEnemy.currentPhase = 0;
            } else {
                document.getElementById('boss-health-container').style.display = 'none';
                document.getElementById('enemy-health-bar').style.display = 'block';
            }
            
            // Reset battle log
            gameState.battleLog = [];
            addToBattleLog(`Enemy spotted: ${gameState.currentEnemy.name}!`);
            addToBattleLog("Take cover and return fire!");
            
            // Update battle UI
            updateBattleStats();
            
            // Display enemy
            const enemyDisplay = document.getElementById('enemy-display');
            enemyDisplay.textContent = `[${gameState.currentEnemy.name.toUpperCase()}]`;
            
            // Add boss styling for high-level enemies
            if (gameState.currentEnemy.isBoss) {
                enemyDisplay.classList.add('boss-enemy');
                addToBattleLog("Major enemy threat detected! Exercise extreme caution!");
            } else {
                enemyDisplay.classList.remove('boss-enemy');
            }
            
            showScreen('battle');
        }

        function playerAttack() {
            if (!gameState.currentEnemy) return;
            
            SoundManager.playGunshot();
            
            // Calculate hit chance
            const playerAccuracy = gameState.player.accuracy;
            const enemyDodge = gameState.currentEnemy.dodge || 0;
            const coverPenalty = gameState.currentEnemy.cover || 0;
            const hitChance = Math.max(10, Math.min(95, playerAccuracy - enemyDodge - coverPenalty));
            
            // Check if attack hits
            if (Math.random() * 100 > hitChance) {
                addToBattleLog(`<span class="miss-message">Your shot missed!</span>`);
                enemyAttack();
                return;
            }
            
            // Calculate player damage
            const playerStrength = gameState.player.strength;
            const weapon = gameState.player.equipment.primary ? items[gameState.player.equipment.primary] : null;
            const baseDamage = weapon ? 
                Math.floor(Math.random() * (weapon.damage.max - weapon.damage.min + 1)) + weapon.damage.min :
                10;
                
            const strengthBonus = Math.floor(playerStrength / 5);
            let damage = baseDamage + strengthBonus;
            
            // Check for critical hit
            const criticalChance = gameState.player.critical + (weapon ? weapon.critical || 0 : 0);
            let isCritical = false;
            
            if (Math.random() * 100 < criticalChance) {
                damage = Math.floor(damage * 1.5);
                isCritical = true;
                SoundManager.playCritical();
            }
            
            // Apply enemy defense and cover
            const enemyDefense = gameState.currentEnemy.defense;
            const enemyCover = gameState.currentEnemy.cover || 0;
            damage = Math.max(1, damage - Math.floor(enemyDefense / 2) - Math.floor(enemyCover / 4));
            
            // Apply damage
            gameState.currentEnemy.hp -= damage;
            
            // Display attack result
            if (isCritical) {
                addToBattleLog(`<span class="crit-message">CRITICAL HIT! You hit the ${gameState.currentEnemy.name} for ${damage} damage!</span>`);
            } else {
                addToBattleLog(`You hit the ${gameState.currentEnemy.name} for ${damage} damage!`);
            }
            
            // Show floating damage number
            showFloatingText(damage, document.getElementById('enemy-display'), isCritical ? 'damage-text crit-message' : 'damage-text');
            
            if (gameState.currentEnemy.isBoss) {
                updateBossHealth();
            } else {
                updateEnemyHP();
            }
            
            if (gameState.currentEnemy.hp <= 0) {
                enemyDefeated();
                return;
            }
            
            // Enemy attacks back
            enemyAttack();
        }

        function enemyAttack() {
            if (!gameState.currentEnemy) return;
            
            // Calculate hit chance
            const enemyAccuracy = gameState.currentEnemy.accuracy;
            const playerDodge = Math.floor(gameState.player.agility / 3);
            const playerCover = gameState.player.cover || 0;
            const hitChance = Math.max(10, Math.min(95, enemyAccuracy - playerDodge - playerCover));
            
            // Check if attack hits
            if (Math.random() * 100 > hitChance) {
                addToBattleLog(`<span class="dodge-message">You dodged the ${gameState.currentEnemy.name}'s attack!</span>`);
                SoundManager.playDodge();
                return;
            }
            
            // Calculate enemy damage
            const enemyAttack = gameState.currentEnemy.attack;
            const baseDamage = Math.floor(Math.random() * 5) + enemyAttack - 2;
            
            // Check for critical hit
            const criticalChance = gameState.currentEnemy.critical || 5;
            let damage, isCritical = false;
            
            if (Math.random() * 100 < criticalChance) {
                damage = Math.floor(baseDamage * 1.5);
                isCritical = true;
                SoundManager.playCritical();
            } else {
                damage = baseDamage;
            }
            
            // Apply player defense and cover
            const playerDefense = gameState.player.defense;
            const playerCoverValue = gameState.player.cover || 0;
            damage = Math.max(1, damage - Math.floor(playerDefense / 2) - Math.floor(playerCoverValue / 3));
            
            // Apply damage
            gameState.player.hp -= damage;
            
            // Display attack result
            if (isCritical) {
                addToBattleLog(`<span class="crit-message">CRITICAL HIT! The ${gameState.currentEnemy.name} hits you for ${damage} damage!</span>`);
            } else {
                addToBattleLog(`The ${gameState.currentEnemy.name} hits you for ${damage} damage!`);
            }
            
            // Show floating damage number and shake effect
            showFloatingText(damage, document.getElementById('battle-player-hp').parentElement, isCritical ? 'damage-text crit-message' : 'damage-text');
            document.getElementById('battle-screen').classList.add('shake');
            setTimeout(() => document.getElementById('battle-screen').classList.remove('shake'), 300);
            
            updatePlayerHP();
            
            if (gameState.player.hp <= 0) {
                playerDefeated();
            }
        }

        function castAbility(abilityId) {
            const ability = abilities[abilityId];
            
            // Check if player has enough stamina
            if (gameState.player.mp < ability.cost) {
                addToBattleLog(`Not enough stamina to use ${ability.name}!`);
                showBattleScreen();
                return;
            }
            
            // Deduct stamina cost
            gameState.player.mp -= ability.cost;
            updatePlayerMP();
            
            if (ability.type === 'attack') {
                SoundManager.playExplosion();
                
                // Check if ability hits
                const abilityAccuracy = ability.accuracy || 85;
                if (Math.random() * 100 > abilityAccuracy) {
                    addToBattleLog(`<span class="miss-message">Your ${ability.name} missed!</span>`);
                    enemyAttack();
                    showBattleScreen();
                    return;
                }
                
                const minDamage = ability.damage.min + Math.floor(gameState.player.strength / 3);
                const maxDamage = ability.damage.max + Math.floor(gameState.player.strength / 2);
                let damage = Math.floor(Math.random() * (maxDamage - minDamage + 1)) + minDamage;
                
                // Check for critical
                let isCritical = false;
                if (ability.critical && Math.random() * 100 < (ability.critical + Math.floor(gameState.player.critical / 2))) {
                    damage = Math.floor(damage * 1.5);
                    isCritical = true;
                    SoundManager.playCritical();
                }
                
                gameState.currentEnemy.hp -= damage;
                
                if (isCritical) {
                    addToBattleLog(`<span class="crit-message">CRITICAL! ${ability.name} deals ${damage} damage!</span>`);
                } else {
                    addToBattleLog(`${ability.name} deals ${damage} damage!`);
                }
                
                // Show floating damage number
                showFloatingText(damage, document.getElementById('enemy-display'), isCritical ? 'damage-text crit-message' : 'damage-text');
                
                if (gameState.currentEnemy.isBoss) {
                    updateBossHealth();
                } else {
                    updateEnemyHP();
                }
                
                if (gameState.currentEnemy.hp <= 0) {
                    enemyDefeated();
                    return;
                }
            } else if (ability.type === 'heal') {
                SoundManager.playHeal();
                const healAmount = ability.power + Math.floor(gameState.player.defense / 2);
                gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
                addToBattleLog(`${ability.name} restores ${healAmount} health!`);
                
                // Show floating heal number
                showFloatingText(healAmount, document.getElementById('battle-player-hp').parentElement, 'heal-text');
                
                updatePlayerHP();
            } else if (ability.type === 'buff') {
                if (ability.effect.type === 'cover') {
                    gameState.player.cover += ability.effect.value;
                    addToBattleLog(`${ability.name} provides ${ability.effect.value}% cover!`);
                    updatePlayerCover();
                }
            }
            
            // Enemy attacks back
            enemyAttack();
            
            showBattleScreen();
        }

        function takeCover() {
            const coverAmount = 20 + Math.floor(gameState.player.agility / 2);
            gameState.player.cover = Math.min(80, gameState.player.cover + coverAmount);
            addToBattleLog(`You take cover! (+${coverAmount}% cover)`);
            updatePlayerCover();
            
            // Enemy still gets to attack
            enemyAttack();
        }

        function enemyDefeated() {
            SoundManager.playVictory();
            addToBattleLog(`Enemy ${gameState.currentEnemy.name} neutralized!`);
            
            // Calculate experience gained
            const expGained = gameState.currentEnemy.exp;
            gameState.player.exp += expGained;
            
            // Update order progress
            updateOrderProgress(gameState.currentEnemy.name);
            
            // Update achievement tracking
            gameState.enemiesDefeated++;
            if (gameState.currentEnemy.name === "German Infantry" || gameState.currentEnemy.name === "German Rifleman") {
                gameState.infantryDefeated++;
            }
            if (gameState.currentEnemy.name === "Panzer Tank") {
                gameState.tanksDestroyed++;
            }
            if (gameState.currentEnemy.name === "German Sniper") {
                gameState.snipersDefeated++;
            }
            if (gameState.currentEnemy.name.includes("Officer")) {
                gameState.officersDefeated++;
            }
            
            // Check for level up
            if (gameState.player.exp >= gameState.player.expNeeded) {
                levelUp();
            }
            
            // Collect loot
            const loot = [];
            const suppliesGained = gameState.currentEnemy.gold;
            gameState.player.gold += suppliesGained;
            gameState.totalSuppliesEarned += suppliesGained;
            
            // Check each loot item from enemy's loot table
            gameState.currentEnemy.loot.forEach(lootItem => {
                if (Math.random() < lootItem.chance) {
                    loot.push(lootItem.id);
                }
            });
            
            // Rare loot chance
            const rareLootChance = 0.10 + (gameState.player.level * 0.03);
            if (Math.random() < rareLootChance) {
                const rareItems = Object.keys(items).filter(itemId => {
                    const rarity = items[itemId].rarity;
                    return rarity === 'rare' || rarity === 'epic';
                });
                
                if (rareItems.length > 0) {
                    const randomRareItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                    loot.push(randomRareItem);
                    addToBattleLog(`<span class="rarity-${items[randomRareItem].rarity}">RARE LOOT: Found ${items[randomRareItem].name}!</span>`);
                }
            }
            
            // Add loot to inventory
            loot.forEach(itemId => {
                gameState.player.inventory.push(itemId);
            });
            
            // Display loot screen
            document.getElementById('exp-gained').textContent = expGained;
            
            const lootItemsElement = document.getElementById('loot-items');
            lootItemsElement.innerHTML = '';
            
            loot.forEach(itemId => {
                const itemElement = document.createElement('div');
                itemElement.className = `log-entry loot-item rarity-${items[itemId].rarity}`;
                itemElement.textContent = items[itemId].name;
                lootItemsElement.appendChild(itemElement);
            });
            
            if (suppliesGained > 0) {
                const suppliesElement = document.createElement('div');
                suppliesElement.className = 'log-entry loot-item';
                suppliesElement.textContent = `${suppliesGained} supplies`;
                lootItemsElement.appendChild(suppliesElement);
            }
            
            // Check achievements
            checkAchievements();
            
            showScreen('loot');
        }

        function playerDefeated() {
            SoundManager.playDefeat();
            addToBattleLog("You've been wounded in action...");
            addToBattleLog("Medics evacuate you to the field hospital.");
            
            gameState.timesWounded++;
            
            // Reset player HP to 50%
            gameState.player.hp = Math.floor(gameState.player.maxHp / 2);
            gameState.player.mp = Math.floor(gameState.player.maxMp / 2);
            gameState.player.cover = 0;
            
            // Lose some supplies
            const suppliesLost = Math.floor(gameState.player.gold * 0.1);
            gameState.player.gold -= suppliesLost;
            
            setTimeout(() => {
                addToGameLog(`You were wounded and lost ${suppliesLost} supplies.`);
                showGameScreen();
                updatePlayerStats();
            }, 2000);
        }

        function attemptRetreat() {
            // Retreat chance based on agility and cover
            const playerAgility = gameState.player.agility;
            const playerCover = gameState.player.cover;
            const retreatChance = 0.4 + (playerAgility * 0.01) + (playerCover * 0.005);
            
            if (Math.random() < retreatChance) {
                addToBattleLog("You successfully retreat to safer position!");
                setTimeout(() => {
                    showGameScreen();
                }, 1000);
            } else {
                addToBattleLog("You're pinned down! Can't retreat!");
                enemyAttack();
            }
        }

        function useItemInBattle() {
            // Use a ration if available
            const rationIndex = gameState.player.inventory.indexOf('rations');
            
            if (rationIndex !== -1) {
                SoundManager.playHeal();
                // Use ration
                gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + items.rations.power);
                gameState.player.inventory.splice(rationIndex, 1);
                addToBattleLog("You consumed field rations!");
                
                // Show floating heal number
                showFloatingText(items.rations.power, document.getElementById('battle-player-hp').parentElement, 'heal-text');
                
                updatePlayerHP();
                
                // Enemy still attacks
                enemyAttack();
            } else {
                addToBattleLog("You don't have any usable items!");
            }
        }

        function takeLoot() {
            // Reset cover
            gameState.player.cover = 0;
            showGameScreen();
            updatePlayerStats();
            addToGameLog("You return to the command post...");
        }

        // Level and Rank system
        function levelUp() {
            SoundManager.playLevelUp();
            gameState.player.level++;
            gameState.player.exp -= gameState.player.expNeeded;
            gameState.player.expNeeded = Math.floor(gameState.player.expNeeded * 1.5);
            
            // Increase stats based on class
            const classData = classes[gameState.player.class];
            
            gameState.player.maxHp += 20 + (classData.hp > 100 ? 5 : 0);
            gameState.player.hp = gameState.player.maxHp;
            gameState.player.maxMp += 10 + (classData.mp > 50 ? 5 : 0);
            gameState.player.mp = gameState.player.maxMp;
            gameState.player.strength += 2 + (classData.strength > 10 ? 1 : 0);
            gameState.player.defense += 1 + (classData.defense > 5 ? 1 : 0);
            gameState.player.agility += 1 + (classData.agility > 10 ? 1 : 0);
            gameState.player.accuracy += 2;
            gameState.player.critical += 1;
            
            // Check for rank promotion
            checkRankPromotion();
            
            // Grant training point every 3 levels
            if (gameState.player.level % 3 === 0) {
                gameState.player.trainingPoints++;
                addToGameLog("You earned a training point!");
            }
            
            addToGameLog(`Promotion! You are now Level ${gameState.player.level}!`);
            addToGameLog("Your combat effectiveness has improved!");
            
            updatePlayerStats();
        }

        function checkRankPromotion() {
            const currentRank = ranks.find(r => r.name === gameState.player.rank);
            const nextRank = ranks.find(r => r.level === currentRank.level + 1);
            
            if (nextRank && gameState.player.level >= nextRank.level) {
                gameState.player.rank = nextRank.name;
                addToGameLog(`Congratulations! You've been promoted to ${nextRank.name}!`);
                updateRankDisplay();
            }
        }

        function updateRankDisplay() {
            document.getElementById('player-rank').textContent = gameState.player.rank;
            document.getElementById('rank-display').textContent = `Rank: ${gameState.player.rank}`;
            document.getElementById('inventory-rank').textContent = gameState.player.rank;
            document.getElementById('supply-rank').textContent = gameState.player.rank;
        }

        // Update order progress
        function updateOrderProgress(enemyName) {
            gameState.player.orders.forEach(order => {
                if (!order.completed) {
                    if (order.target === enemyName) {
                        order.current++;
                    } else if (order.target === "total_enemies") {
                        order.current++;
                    }
                    
                    if (order.current >= order.required) {
                        order.completed = true;
                        addToGameLog(`Order completed: ${order.name}!`);
                        
                        // Give rewards
                        gameState.player.gold += order.reward.gold;
                        gameState.player.exp += order.reward.exp;
                        if (order.reward.item) {
                            gameState.player.inventory.push(order.reward.item);
                            addToGameLog(`You received ${items[order.reward.item].name} as a reward!`);
                        }
                        
                        addToGameLog(`You received ${order.reward.gold} supplies and ${order.reward.exp} experience!`);
                    }
                }
            });
        }

        // Floating text for damage/healing
        function showFloatingText(value, parentElement, className) {
            const floatingText = document.createElement('div');
            floatingText.className = `floating-text ${className}`;
            floatingText.textContent = value;
            floatingText.style.left = `${Math.random() * 50 + 25}%`;
            floatingText.style.top = '50%';
            
            parentElement.appendChild(floatingText);
            
            // Remove after animation
            setTimeout(() => {
                floatingText.remove();
            }, 1000);
        }

        // Update boss health display
        function updateBossHealth() {
            const healthPercent = (gameState.currentEnemy.hp / gameState.enemyMaxHp) * 100;
            document.getElementById('boss-health-fill').style.width = `${healthPercent}%`;
            document.getElementById('boss-health-text').textContent = `${gameState.currentEnemy.name.toUpperCase()}: ${Math.round(healthPercent)}%`;
        }

        // Update status effects display
        function updateStatusEffects() {
            const statusEffectsElement = document.getElementById('status-effects');
            statusEffectsElement.innerHTML = '';
            
            if (gameState.player.statusEffects.length === 0) {
                statusEffectsElement.innerHTML = '<div>No status effects</div>';
                return;
            }
        }

        // Update orders display
        function updateOrdersDisplay() {
            const ordersLogElement = document.getElementById('orders-log');
            ordersLogElement.innerHTML = '';
            
            if (gameState.player.orders.length === 0) {
                ordersLogElement.innerHTML = '<div>No current orders</div>';
                return;
            }
            
            gameState.player.orders.forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.className = `order-item ${order.completed ? 'order-completed' : ''}`;
                
                const progressText = order.completed ? 
                    'Completed!' : 
                    `${order.current}/${order.required}`;
                
                orderElement.innerHTML = `
                    <strong>${order.name}</strong><br>
                    <small>${order.description}</small><br>
                    <small>Progress: ${progressText}</small>
                `;
                
                ordersLogElement.appendChild(orderElement);
            });
        }

        // Update achievements display
        function updateAchievementsDisplay() {
            const achievementsElement = document.getElementById('achievements-list');
            achievementsElement.innerHTML = '';
            
            Object.keys(achievements).forEach(achievementId => {
                const achievement = achievements[achievementId];
                const isUnlocked = gameState.player.achievements.includes(achievementId);
                
                const achievementElement = document.createElement('div');
                achievementElement.className = `item ${isUnlocked ? 'rarity-uncommon' : ''}`;
                achievementElement.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div style="font-size: 24px; margin-right: 10px;">${isUnlocked ? achievement.icon : 'â“'}</div>
                        <div>
                            <strong>${achievement.name}</strong><br>
                            <small>${achievement.description}</small><br>
                            <small>${isUnlocked ? 'âœ“ Awarded' : 'Not Earned'}</small>
                        </div>
                    </div>
                `;
                
                achievementsElement.appendChild(achievementElement);
            });
        }

        // Inventory system
        function updateInventoryDisplay() {
            // Update supplies display
            document.getElementById('inventory-gold').textContent = gameState.player.gold;
            
            // Update equipment slots with stats
            updateEquipmentDisplay();
            
            // Update inventory items
            const inventoryElement = document.getElementById('inventory-items');
            inventoryElement.innerHTML = '';
            
            // Group items by type for display
            const itemCounts = {};
            gameState.player.inventory.forEach(itemId => {
                itemCounts[itemId] = (itemCounts[itemId] || 0) + 1;
            });
            
            Object.keys(itemCounts).forEach(itemId => {
                const itemElement = document.createElement('div');
                itemElement.className = `item rarity-${items[itemId].rarity}`;
                
                const itemName = document.createElement('div');
                itemName.textContent = `${items[itemId].name} (x${itemCounts[itemId]})`;
                
                const itemStats = document.createElement('div');
                itemStats.className = 'item-stats';
                itemStats.innerHTML = getItemStatsDisplay(itemId);
                
                // Add quick slot assignment buttons
                const quickSlotButtons = document.createElement('div');
                quickSlotButtons.style.marginTop = '5px';
                quickSlotButtons.style.display = 'flex';
                quickSlotButtons.style.gap = '2px';
                
                for (let i = 0; i < 3; i++) {
                    const slotButton = document.createElement('button');
                    slotButton.textContent = `Q${i + 1}`;
                    slotButton.style.flex = '1';
                    slotButton.style.padding = '2px';
                    slotButton.style.fontSize = '10px';
                    slotButton.style.backgroundColor = '#2a3325';
                    slotButton.style.color = '#d4af37';
                    slotButton.style.border = '1px solid #d4af37';
                    slotButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        assignQuickSlot(i, itemId);
                        addToGameLog(`Assigned ${items[itemId].name} to quick slot ${i + 1}`);
                    });
                    quickSlotButtons.appendChild(slotButton);
                }
                
                itemElement.appendChild(itemName);
                itemElement.appendChild(itemStats);
                itemElement.appendChild(quickSlotButtons);
                
                // Add click event to equip/use item
                itemElement.addEventListener('click', () => {
                    SoundManager.playClick();
                    if (items[itemId].type === 'consumable' || items[itemId].type === 'medal') {
                        useItem(itemId);
                    } else {
                        equipItem(itemId, items[itemId].slot);
                    }
                });
                
                inventoryElement.appendChild(itemElement);
            });
        }

        function sortInventory(sortType) {
            // Group items by type for display
            const itemCounts = {};
            gameState.player.inventory.forEach(itemId => {
                itemCounts[itemId] = (itemCounts[itemId] || 0) + 1;
            });
            
            let sortedItems = Object.keys(itemCounts);
            
            switch (sortType) {
                case 'name':
                    sortedItems.sort((a, b) => items[a].name.localeCompare(items[b].name));
                    break;
                case 'type':
                    sortedItems.sort((a, b) => items[a].type.localeCompare(items[b].type));
                    break;
                case 'rarity':
                    const rarityOrder = { common: 0, uncommon: 1, rare: 2, epic: 3, legendary: 4 };
                    sortedItems.sort((a, b) => rarityOrder[items[b].rarity] - rarityOrder[items[a].rarity]);
                    break;
            }
            
            updateInventoryDisplayWithSort(sortedItems, itemCounts);
        }

        function updateInventoryDisplayWithSort(sortedItems, itemCounts) {
            const inventoryElement = document.getElementById('inventory-items');
            inventoryElement.innerHTML = '';
            
            sortedItems.forEach(itemId => {
                const itemElement = document.createElement('div');
                itemElement.className = `item rarity-${items[itemId].rarity}`;
                
                const itemName = document.createElement('div');
                itemName.textContent = `${items[itemId].name} (x${itemCounts[itemId]})`;
                
                const itemStats = document.createElement('div');
                itemStats.className = 'item-stats';
                itemStats.innerHTML = getItemStatsDisplay(itemId);
                
                itemElement.appendChild(itemName);
                itemElement.appendChild(itemStats);
                
                // Add click event to equip/use item
                itemElement.addEventListener('click', () => {
                    SoundManager.playClick();
                    if (items[itemId].type === 'consumable' || items[itemId].type === 'medal') {
                        useItem(itemId);
                    } else {
                        equipItem(itemId, items[itemId].slot);
                    }
                });
                
                inventoryElement.appendChild(itemElement);
            });
        }

        function updateEquipmentDisplay() {
            // Head
            const headSlot = document.getElementById('head-slot');
            const headStats = document.getElementById('head-stats');
            if (gameState.player.equipment.head) {
                const item = items[gameState.player.equipment.head];
                headSlot.textContent = item.name;
                headStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.head);
            } else {
                headSlot.textContent = 'Empty';
                headStats.innerHTML = '';
            }
            
            // Chest
            const chestSlot = document.getElementById('chest-slot');
            const chestStats = document.getElementById('chest-stats');
            if (gameState.player.equipment.chest) {
                const item = items[gameState.player.equipment.chest];
                chestSlot.textContent = item.name;
                chestStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.chest);
            } else {
                chestSlot.textContent = 'Empty';
                chestStats.innerHTML = '';
            }
            
            // Hands
            const handsSlot = document.getElementById('hands-slot');
            const handsStats = document.getElementById('hands-stats');
            if (gameState.player.equipment.hands) {
                const item = items[gameState.player.equipment.hands];
                handsSlot.textContent = item.name;
                handsStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.hands);
            } else {
                handsSlot.textContent = 'Empty';
                handsStats.innerHTML = '';
            }
            
            // Secondary
            const secondarySlot = document.getElementById('secondary-slot');
            const secondaryStats = document.getElementById('secondary-stats');
            if (gameState.player.equipment.secondary) {
                const item = items[gameState.player.equipment.secondary];
                secondarySlot.textContent = item.name;
                secondaryStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.secondary);
            } else {
                secondarySlot.textContent = 'Empty';
                secondaryStats.innerHTML = '';
            }
            
            // Primary
            const primarySlot = document.getElementById('primary-slot');
            const primaryStats = document.getElementById('primary-stats');
            if (gameState.player.equipment.primary) {
                const item = items[gameState.player.equipment.primary];
                primarySlot.textContent = item.name;
                primaryStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.primary);
            } else {
                primarySlot.textContent = 'Empty';
                primaryStats.innerHTML = '';
            }
            
            // Special
            const specialSlot = document.getElementById('special-slot');
            const specialStats = document.getElementById('special-stats');
            if (gameState.player.equipment.special) {
                const item = items[gameState.player.equipment.special];
                specialSlot.textContent = item.name;
                specialStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.special);
            } else {
                specialSlot.textContent = 'Empty';
                specialStats.innerHTML = '';
            }
        }

        function getItemStatsDisplay(itemId) {
            const item = items[itemId];
            let statsHTML = '';
            
            if (item.type === 'weapon') {
                statsHTML = `DMG: ${item.damage.min}-${item.damage.max}`;
                
                // Add comparison if player has an equipped item in this slot
                const equippedItemId = gameState.player.equipment[item.slot];
                if (equippedItemId && equippedItemId !== itemId) {
                    const equippedItem = items[equippedItemId];
                    const currentAvg = (equippedItem.damage.min + equippedItem.damage.max) / 2;
                    const newAvg = (item.damage.min + item.damage.max) / 2;
                    
                    if (newAvg > currentAvg) {
                        statsHTML += ` <span class="better-stat">(+${Math.round(newAvg - currentAvg)})</span>`;
                    } else if (newAvg < currentAvg) {
                        statsHTML += ` <span class="worse-stat">(${Math.round(newAvg - currentAvg)})</span>`;
                    } else {
                        statsHTML += ` <span class="same-stat">(=)</span>`;
                    }
                }
                
                // Add other stats
                if (item.accuracy) statsHTML += ` | ACC: ${item.accuracy > 0 ? '+' : ''}${item.accuracy}%`;
                if (item.critical) statsHTML += ` | CRIT: +${item.critical}%`;
                if (item.agility) statsHTML += ` | AGI: +${item.agility}`;
            } else if (item.type === 'armor') {
                statsHTML = `DEF: ${item.defense}`;
                
                // Add comparison if player has an equipped item in this slot
                const equippedItemId = gameState.player.equipment[item.slot];
                if (equippedItemId && equippedItemId !== itemId) {
                    const equippedItem = items[equippedItemId];
                    
                    if (item.defense > equippedItem.defense) {
                        statsHTML += ` <span class="better-stat">(+${item.defense - equippedItem.defense})</span>`;
                    } else if (item.defense < equippedItem.defense) {
                        statsHTML += ` <span class="worse-stat">(${item.defense - equippedItem.defense})</span>`;
                    } else {
                        statsHTML += ` <span class="same-stat">(=)</span>`;
                    }
                }
                
                // Add other stats
                if (item.agility) statsHTML += ` | AGI: +${item.agility}`;
            } else if (item.type === 'consumable') {
                if (item.effect === 'heal') {
                    statsHTML = `Heals: ${item.power} HP`;
                } else if (item.effect === 'full_heal') {
                    statsHTML = `Fully restores health`;
                } else if (item.effect === 'grenade_damage') {
                    statsHTML = `Damage: ${item.power}`;
                } else if (item.effect === 'explosive_damage') {
                    statsHTML = `Damage: ${item.power}`;
                } else if (item.effect === 'smoke_screen') {
                    statsHTML = `Provides cover`;
                }
            } else if (item.type === 'special') {
                if (item.accuracy) statsHTML += `ACC: +${item.accuracy}%`;
                if (item.defense) statsHTML += `DEF: +${item.defense}`;
            } else if (item.type === 'medal') {
                if (item.defense) statsHTML += `DEF: +${item.defense}`;
                if (item.strength) statsHTML += `STR: +${item.strength}`;
                if (item.critical) statsHTML += `CRIT: +${item.critical}%`;
            }
            
            return statsHTML;
        }

        function equipItem(itemId, slot) {
            // If slot is already occupied, unequip current item
            if (gameState.player.equipment[slot]) {
                gameState.player.inventory.push(gameState.player.equipment[slot]);
            }
            
            // Remove item from inventory
            const itemIndex = gameState.player.inventory.indexOf(itemId);
            if (itemIndex !== -1) {
                gameState.player.inventory.splice(itemIndex, 1);
            }
            
            // Equip new item
            gameState.player.equipment[slot] = itemId;
            
            // Update stats
            updatePlayerStats();
            updateInventoryDisplay();
            
            addToGameLog(`You equipped ${items[itemId].name}.`);
        }

        function useItem(itemId) {
            const item = items[itemId];
            
            if (item.type === 'consumable') {
                if (item.effect === 'heal') {
                    gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + item.power);
                    addToGameLog(`You used ${item.name} and restored ${item.power} HP.`);
                } else if (item.effect === 'full_heal') {
                    gameState.player.hp = gameState.player.maxHp;
                    addToGameLog(`You used ${item.name} and fully restored your health!`);
                } else if (item.effect === 'grenade_damage' || item.effect === 'explosive_damage') {
                    addToGameLog(`You saved ${item.name} for combat use.`);
                    return; // Don't consume, just inform
                }
                
                // Remove item from inventory
                const itemIndex = gameState.player.inventory.indexOf(itemId);
                if (itemIndex !== -1) {
                    gameState.player.inventory.splice(itemIndex, 1);
                }
                
                updatePlayerStats();
                updateInventoryDisplay();
            } else if (item.type === 'medal') {
                // Medals are permanent and just provide stats when in inventory
                addToGameLog(`${item.name} is proudly displayed on your uniform.`);
            }
        }

        function updateAbilitiesDisplay() {
            const abilitiesElement = document.getElementById('abilities-list');
            abilitiesElement.innerHTML = '';
            
            gameState.player.abilities.forEach(abilityId => {
                const ability = abilities[abilityId];
                const abilityElement = document.createElement('div');
                abilityElement.className = 'ability-item';
                
                const abilityInfo = document.createElement('div');
                abilityInfo.className = 'ability-info';
                abilityInfo.innerHTML = `
                    <strong>${ability.name}</strong><br>
                    <small>${ability.description}</small>
                `;
                
                const abilityCost = document.createElement('div');
                abilityCost.className = 'ability-cost';
                abilityCost.textContent = `${ability.cost} Stamina`;
                
                abilityElement.appendChild(abilityInfo);
                abilityElement.appendChild(abilityCost);
                
                abilitiesElement.appendChild(abilityElement);
            });
        }

        function updateAbilitySelectionDisplay() {
            // Update stamina display
            document.getElementById('ability-select-mp').textContent = gameState.player.mp;
            document.getElementById('ability-select-max-mp').textContent = gameState.player.maxMp;
            
            const abilitySelectElement = document.getElementById('ability-select-list');
            abilitySelectElement.innerHTML = '';
            
            gameState.player.abilities.forEach(abilityId => {
                const ability = abilities[abilityId];
                const abilityElement = document.createElement('div');
                abilityElement.className = 'ability-item';
                
                // Disable if not enough stamina
                if (gameState.player.mp < ability.cost) {
                    abilityElement.classList.add('disabled');
                }
                
                const abilityInfo = document.createElement('div');
                abilityInfo.className = 'ability-info';
                abilityInfo.innerHTML = `
                    <strong>${ability.name}</strong><br>
                    <small>${ability.description}</small><br>
                    ${ability.type === 'attack' ? `Damage: ${ability.damage.min}-${ability.damage.max}` : 
                      ability.type === 'heal' ? `Heal: ${ability.power}` : 
                      `Effect: ${ability.effect.type}`}
                `;
                
                const abilityCost = document.createElement('div');
                abilityCost.className = 'ability-cost';
                abilityCost.textContent = `${ability.cost} Stamina`;
                
                abilityElement.appendChild(abilityInfo);
                abilityElement.appendChild(abilityCost);
                
                // Add click event to use ability
                if (gameState.player.mp >= ability.cost) {
                    abilityElement.addEventListener('click', () => {
                        SoundManager.playClick();
                        castAbility(abilityId);
                    });
                }
                
                abilitySelectElement.appendChild(abilityElement);
            });
        }

        function updateSupplyDepotDisplay() {
            // Update supply display
            document.getElementById('supply-gold').textContent = gameState.player.gold;
            
            const supplyElement = document.getElementById('supply-items');
            supplyElement.innerHTML = '';
            
            // Show all abilities that player doesn't already have and meets level requirement
            Object.keys(abilities).forEach(abilityId => {
                const ability = abilities[abilityId];
                
                // Skip if player already has this ability
                if (gameState.player.abilities.includes(abilityId)) return;
                
                // Skip if player doesn't meet level requirement
                if (gameState.player.level < ability.levelReq) return;
                
                const supplyItemElement = document.createElement('div');
                supplyItemElement.className = 'ability-item';
                
                const infoElement = document.createElement('div');
                infoElement.className = 'ability-info';
                infoElement.innerHTML = `
                    <strong>${ability.name}</strong> (Level ${ability.levelReq}+)<br>
                    <small>${ability.description}</small><br>
                    ${ability.type === 'attack' ? `Damage: ${ability.damage.min}-${ability.damage.max}` : 
                      ability.type === 'heal' ? `Heal: ${ability.power}` : 
                      `Effect: ${ability.effect.type}`} | Cost: ${ability.cost} Stamina
                `;
                
                const costElement = document.createElement('div');
                costElement.className = 'ability-cost';
                costElement.textContent = `${ability.goldCost} Supplies`;
                
                const buyButton = document.createElement('div');
                buyButton.className = 'button';
                buyButton.textContent = 'TRAIN';
                buyButton.addEventListener('click', () => {
                    SoundManager.playClick();
                    trainAbility(abilityId);
                });
                
                supplyItemElement.appendChild(infoElement);
                supplyItemElement.appendChild(costElement);
                supplyItemElement.appendChild(buyButton);
                
                supplyElement.appendChild(supplyItemElement);
            });
        }

        function trainAbility(abilityId) {
            const ability = abilities[abilityId];
            
            // Check if player can afford the ability
            if (gameState.player.gold < ability.goldCost) {
                addToGameLog("You don't have enough supplies to train this ability.");
                return;
            }
            
            // Check if player meets level requirement
            if (gameState.player.level < ability.levelReq) {
                addToGameLog(`You need to be level ${ability.levelReq} to train this ability.`);
                return;
            }
            
            // Check if player already has the ability
            if (gameState.player.abilities.includes(abilityId)) {
                addToGameLog("You already know this combat technique.");
                return;
            }
            
            // Purchase the ability
            gameState.player.gold -= ability.goldCost;
            gameState.player.abilities.push(abilityId);
            gameState.abilitiesLearned++;
            
            addToGameLog(`You trained in ${ability.name} for ${ability.goldCost} supplies!`);
            
            // Update displays
            updatePlayerStats();
            updateSupplyDepotDisplay();
            
            // Check achievements
            checkAchievements();
        }

        // Calculate total player stats including equipment
        function calculatePlayerStats() {
            // Start with base stats
            const stats = {
                strength: gameState.player.strength,
                defense: gameState.player.defense,
                agility: gameState.player.agility,
                accuracy: gameState.player.accuracy,
                critical: gameState.player.critical,
                cover: gameState.player.cover
            };
            
            // Add equipment bonuses
            Object.values(gameState.player.equipment).forEach(itemId => {
                if (itemId && items[itemId]) {
                    const item = items[itemId];
                    if (item.strength) stats.strength += item.strength;
                    if (item.defense) stats.defense += item.defense;
                    if (item.agility) stats.agility += item.agility;
                    if (item.accuracy) stats.accuracy += item.accuracy;
                    if (item.critical) stats.critical += item.critical;
                }
            });
            
            return stats;
        }

        // UI updates
        function updatePlayerStats() {
            const stats = calculatePlayerStats();
            
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('player-hp').textContent = gameState.player.hp;
            document.getElementById('player-max-hp').textContent = gameState.player.maxHp;
            document.getElementById('player-mp').textContent = gameState.player.mp;
            document.getElementById('player-max-mp').textContent = gameState.player.maxMp;
            document.getElementById('player-exp').textContent = gameState.player.exp;
            document.getElementById('player-exp-needed').textContent = gameState.player.expNeeded;
            document.getElementById('player-gold').textContent = gameState.player.gold;
            
            // Update stat display
            document.getElementById('player-strength').textContent = stats.strength;
            document.getElementById('player-defense').textContent = stats.defense;
            document.getElementById('player-agility').textContent = stats.agility;
            document.getElementById('player-accuracy').textContent = stats.accuracy;
            document.getElementById('player-critical').textContent = stats.critical;
            document.getElementById('player-cover').textContent = stats.cover;
            
            // Update exp bar
            const expPercent = (gameState.player.exp / gameState.player.expNeeded) * 100;
            document.getElementById('exp-bar').style.width = `${expPercent}%`;
            
            // Update stamina bar
            const mpPercent = (gameState.player.mp / gameState.player.maxMp) * 100;
            document.getElementById('mp-bar').style.width = `${mpPercent}%`;
            
            // Update quick slots
            updateQuickSlotDisplay();
        }

        function updateBattleStats() {
            document.getElementById('enemy-name').textContent = gameState.currentEnemy.name;
            document.getElementById('enemy-hp').textContent = gameState.currentEnemy.hp;
            document.getElementById('enemy-max-hp').textContent = gameState.enemyMaxHp;
            document.getElementById('enemy-cover').textContent = gameState.currentEnemy.cover || 0;
            document.getElementById('battle-player-hp').textContent = gameState.player.hp;
            document.getElementById('battle-player-max-hp').textContent = gameState.player.maxHp;
            document.getElementById('battle-player-mp').textContent = gameState.player.mp;
            document.getElementById('battle-player-max-mp').textContent = gameState.player.maxMp;
            document.getElementById('battle-player-cover').textContent = gameState.player.cover;
            
            // Update enemy health bar
            const enemyHealthPercent = (gameState.currentEnemy.hp / gameState.enemyMaxHp) * 100;
            document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
            
            // Update stamina bar in battle
            const mpPercent = (gameState.player.mp / gameState.player.maxMp) * 100;
            document.getElementById('battle-mp-bar').style.width = `${mpPercent}%`;
            
            // Update quick slots in battle
            updateQuickSlotDisplay();
        }

        function updatePlayerHP() {
            document.getElementById('player-hp').textContent = gameState.player.hp;
            document.getElementById('battle-player-hp').textContent = gameState.player.hp;
        }

        function updatePlayerMP() {
            document.getElementById('player-mp').textContent = gameState.player.mp;
            document.getElementById('battle-player-mp').textContent = gameState.player.mp;
            document.getElementById('ability-select-mp').textContent = gameState.player.mp;
            
            // Update stamina bars
            const mpPercent = (gameState.player.mp / gameState.player.maxMp) * 100;
            document.getElementById('mp-bar').style.width = `${mpPercent}%`;
            document.getElementById('battle-mp-bar').style.width = `${mpPercent}%`;
        }

        function updatePlayerCover() {
            document.getElementById('player-cover').textContent = gameState.player.cover;
            document.getElementById('battle-player-cover').textContent = gameState.player.cover;
        }

        function updateEnemyHP() {
            document.getElementById('enemy-hp').textContent = Math.max(0, gameState.currentEnemy.hp);
            
            // Update enemy health bar
            const enemyHealthPercent = (gameState.currentEnemy.hp / gameState.enemyMaxHp) * 100;
            document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
        }

        function addToBattleLog(message) {
            const logElement = document.getElementById('battle-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = message;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function addToGameLog(message) {
            const logElement = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Initialize the game when the page loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
