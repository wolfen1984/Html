<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last Stop Motel</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* ORIGINAL STYLE - COMPLETELY UNCHANGED */
        body {
            background-color: black;
            color: white;
            font-family: 'Press Start 2P', cursive;
            margin: 20px;
            font-size: 16px;
            line-height: 1.5;
        }
        #game-container {
            max-width: 800px;
            margin: 0 auto;
        }
        #output {
            border: 1px solid #333;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            background-color: #111;
        }
        #input {
            width: 100%;
            background-color: #222;
            color: white;
            border: 1px solid #333;
            padding: 10px;
            font-family: inherit;
        }
        #title {
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="title">
            <h1>Last Stop Motel</h1>
            <p>Created in 1984 by Nightfall Games</p>
            <p>A text adventure in the style of David Lynch, Stephen King, and Alfred Hitchcock horror.</p>
            <p>Commands: n s e w up down, use [item], take [item], give [item] to [npc], talk to [npc], look, examine [object], punch [npc], inventory</p>
        </div>
        <div id="output"></div>
        <input type="text" id="input" placeholder="Enter command...">
    </div>

    <script>
        const output = document.getElementById('output');
        const input = document.getElementById('input');

        // Game state
        let currentRoom = 'entrance';
        let inventory = [];
        let gameOver = false;
        let gameWon = false;
        
        // NPC states
        let npcStates = {
            clerk: { conscious: true, talked: 0, gaveEvidence: false },
            Bob: { conscious: true, talked: 0, drugged: false, suspicious: 0 },
            Frank: { conscious: true, talked: 0, drugged: false, suspicious: 0 },
            Laura: { conscious: true, talked: 0, trusted: false },
            hitchhiker: { vanished: false }
        };
        
        // Puzzle states
        let puzzleStates = {
            room101Floorboard: false,
            room102Pillow: false,
            room103Lining: false,
            room103Drawers: false,
room103WhiskeyTaken: false
            room201Wall: false,
            room203Drawer: false,
            room301Wallpaper: false,
            room302Trapdoor: false,
            lobbyPanel: false,
            parkingSeat: false,
            hallway1fVent: false
        };

        // ROOMS with three floors - staircases at ends
        const rooms = {
            entrance: {
                description: "You stand before the flickering neon sign of the Last Stop Motel. The 'Vacancy' light buzzes erratically, casting shadows that seem to move on their own. Rain pours down like tears from a forgotten god. To the north is the lobby door. East leads to a dark parking lot. West? A chain-link fence blocks the way, but something whispers from beyond.",
                exits: { n: 'lobby', e: 'parking' },
                items: [],
                npcs: [],
                examinables: {
                    sign: "The sign reads 'Last Stop Motel' in blood-red letters. Below it, faint scratches spell 'Turn back... or don't.' Scratched into the pole: 'KEY UNDER STONE'.",
                    stone: "A loose stone near the fence. Underneath: a room key for 201."
                }
            },
            parking: {
                description: "The parking lot is a graveyard of rusted cars, their windows fogged as if breathing. A single streetlamp flickers, illuminating puddles that reflect impossible skies. West back to entrance. North? A gate creaks open to a foggy road.",
                exits: { w: 'entrance', n: 'road' },
                items: ['crowbar'],
                npcs: [],
                examinables: {
                    cars: "One car has a door ajar. Inside, a radio plays static whispers: 'They're coming... for you.' Under the seat, something glints.",
                    seat: "You reach under the seat and find a maintenance keycard.",
                    puddles: "Staring into the puddle, you see not your reflection, but a face twisted in eternal scream."
                }
            },
            lobby: {
                description: "The lobby smells of mildew and regret. A dusty counter stands before you, manned by a clerk whose smile doesn't reach his eyesâ€”eyes that seem too wide, too knowing. Behind him, a wall of keys dangles like hanged men. A staircase goes up, and a corridor goes east. South back to entrance.",
                exits: { s: 'entrance', e: 'hallway1f', up: 'hallway2f' },
                items: ['bell'],
                npcs: ['clerk'],
                examinables: {
                    counter: "The counter is scarred with what look like claw marks. A guestbook lies open, pages filled with names that blur when you try to read them. Under the counter, a loose panel.",
                    panel: "You pry open the panel. Inside: a straight razor with 'BOB' scratched on it.",
                    keys: "Rows of keys, each tagged with room numbers. Room 101's key is missing. Room 201's key is also gone. Room 301's key is here but covered in dust."
                }
            },
            // FIRST FLOOR - with stairs at EAST END
            hallway1f: {
                description: "First floor hallway. Faded carpet, flickering fluorescent lights. Room 101 to the north, 102 east, 103 west. The south end leads back to lobby. A staircase at the east end goes up.",
                exits: { s: 'lobby', n: 'room101', e: 'room102', w: 'room103', up: 'hallway2f' },
                items: [],
                npcs: [],
                examinables: {
                    carpet: "The carpet is stained with dark patches. One patch near room 101 is wet.",
                    ceiling: "You notice a vent cover loose. Something glints inside.",
                    vent: "You reach into the vent and pull out a roll of duct tape and a key to room 103."
                }
            },
            room101: {
                description: "Room 101: Walls pulse like living flesh, wallpaper peeling to reveal veins beneath. A bed sags in the corner, stained with what you hope is rust. Frank sits in the corner, watching you with cold, dead eyes. A bathroom door east. South back to hallway.",
                exits: { s: 'hallway1f', e: 'bathroom101' },
                items: [],
                npcs: ['Frank'],
                examinables: {
                    bed: "A filthy mattress. You lift it â€” a loose floorboard is visible underneath.",
                    floorboard: "The board is loose. You pry it up. Underneath: a bloodstained knife and letters from Laura.",
                    writings: "The names on the wall - all women. 'LAURA' is written in fresh ink. 'SHE'S NEXT' is scrawled below it.",
                    nightstand: "The drawer is locked. You need a key."
                }
            },
            bathroom101: {
                description: "The bathroom mirror is cracked, your reflection splintered into madness. The tub is filled with murky water that swirls on its own. West back to room 101.",
                exits: { w: 'room101' },
                items: [],
                npcs: [],
                examinables: {
                    mirror: "In the shards, eyes not your own stare back. One winks. You see Frank standing behind you in the reflection. You spin - no one's there.",
                    tub: "Something long and tentacled slithers just below the surface. You reach in and pull out a wet keycard.",
                    cabinet: "The medicine cabinet is open. Inside: sleeping pills and a note: 'FOR BOB - HE GETS RESTLESS'."
                }
            },
            room102: {
                description: "Room 102: tidy but sparse. Laura sits on the edge of the bed, clutching a pillow, staring at nothing. West to hallway.",
                exits: { w: 'hallway1f' },
                items: [],
                npcs: ['Laura'],
                examinables: {
                    bed: "Under the pillow, you see the corner of an envelope.",
                    pillow: "You lift the pillow. Underneath: a key to room 301.",
                    envelope: "It contains letters from Laura to her sister. 'Frank followed me here. Bob watches through vents. I found something in room 301.'",
                    closet: "The closet door is jammed. You need something to pry it open."
                }
            },
            room103: {
                description: "Room 103: trashed. Drawers pulled out, glass on the floor. A small wall safe hangs open, empty. East to hallway.",
                exits: { e: 'hallway1f' },
                items: ['screwdriver'],
                npcs: [],
                examinables: {
                    safe: "The safe is open. Inside, a note: 'BOB - CHECK THIRD FLOOR VENTS - MANAGEMENT'",
                    mattress: "The mattress is slashed open. Something's sewn into the lining.",
                    lining: "You tear it open. Inside: a photograph of Bob with a young girl, and a key to 103.",
                    drawers: "A half-empty bottle of cheap whiskey rolls under the bed."
                }
            },
            // SECOND FLOOR - with stairs at EAST END
            hallway2f: {
                description: "Second floor hallway. The buzz of old neon. Lights flicker. Bob the janitor leans against the wall, mop in hand, staring at you with a greasy smile. Room 201 north, 202 east, 203 west. Down leads to lobby. A staircase at the east end goes up.",
                exits: { down: 'lobby', n: 'room201', e: 'room202', w: 'room203', up: 'hallway3f' },
                items: [],
                npcs: ['Bob'],
                examinables: {
                    mop: "The mop bucket is filled with dark, oily water. Something floats in it.",
                    bucket: "You reach in and pull out a set of keys (Bob's keys). They're covered in slime.",
                    Bob: "He's watching you. Always watching. His pants bulge unnaturally."
                }
            },
            room201: {
                description: "Room 201: cheap wallpaper, a crucifix hanging upside down. A suitcase on the bed. South to hallway.",
                exits: { s: 'hallway2f' },
                items: [],
                npcs: [],
                examinables: {
                    suitcase: "The suitcase is locked. You need a key or something to force it.",
                    crucifix: "It's been turned deliberately. You turn it back - the wall behind clicks.",
                    wall: "A hidden compartment opens. Inside: bondage gear, photos of women sleeping, and Bob's 'trophy' album.",
                    bed: "Under the mattress: a notebook filled with Bob's 'observations' about female guests."
                }
            },
            room202: {
                description: "Room 202: sterile, almost clinical. A single photograph on the nightstand. West to hallway.",
                exits: { w: 'hallway2f' },
                items: [],
                npcs: [],
                examinables: {
                    photograph: "A woman with a sad smile. On the back: 'Laura, 1983. Bob took this. He won't leave me alone.'",
                    nightstand: "The drawer contains a diary. It details Laura's fear of Bob and Frank working together.",
                    bed: "The sheets are cold. Under the pillow: a can of pepper spray."
                }
            },
            room203: {
                description: "Room 203: dark, curtains drawn. A typewriter on the desk. East to hallway.",
                exits: { e: 'hallway2f' },
                items: [],
                npcs: [],
                examinables: {
                    typewriter: "The last line reads: 'FRANK KILLED HER. BOB HELPED DISPOSE. PROOF IN 301.'",
                    desk: "The drawer is locked. There's a keypad. 4 digits.",
                    keypad: "You try 1983 (the year on Laura's photo). It clicks open.",
                    drawer: "Inside: a tape recorder. You play it - Frank's voice: 'She's in the wall, Bob. No one will find her.'"
                }
            },
            // THIRD FLOOR - with stairs at EAST END
            hallway3f: {
                description: "Third floor hallway. Narrow, low ceiling. Room 301 north, 302 east, 303 west. Down to second floor. A staircase at the east end goes down. A vent cover is loose.",
                exits: { down: 'hallway2f', n: 'room301', e: 'room302', w: 'room303' },
                items: [],
                npcs: [],
                examinables: {
                    vent: "You remove the cover. Inside: a room key and a note: 'FOUND THIS WHERE BOB HIDES HIS THINGS'.",
                    ceiling: "Water stains form patterns. One looks like a body."
                }
            },
            room301: {
                description: "Room 301: converted into a makeshift office. Filing cabinets, old radios. South to hallway.",
                exits: { s: 'hallway3f' },
                items: [],
                npcs: [],
                examinables: {
                    cabinets: "One cabinet is locked. Needs a key. Another is open - filled with police reports about missing women.",
                    radio: "You turn it on. Static, then a whisper: 'Behind the wallpaper.'",
                    wallpaper: "You tear it away. Behind it: a hole in the wall with bones inside.",
                    bones: "Human remains. A silver locket around the neck."
                }
            },
            room302: {
                description: "Room 302: wallpapered with newspaper clippings about missing people. A single chair in the center. West to hallway.",
                exits: { w: 'hallway3f' },
                items: [],
                npcs: [],
                examinables: {
                    clippings: "All describe disappearances at motels. One mentions 'Laura M., last seen at Last Stop Motel.' Another: 'Frank R. questioned, released.'",
                    chair: "Under the chair: a trapdoor.",
                    trapdoor: "It opens to a crawlspace. Inside: Bob's 'trophy box' - jewelry, IDs, and a master key."
                }
            },
            room303: {
                description: "Room 303: filthy mattress, shackles bolted to the wall. A duffel bag in the corner. East to hallway.",
                exits: { e: 'hallway3f' },
                items: [],
                npcs: [],
                examinables: {
                    shackles: "They've been used recently. Fresh blood on the cuffs.",
                    bag: "Empty. Inside a hidden pocket you find Frank's ID badge and a key to room 101.",
                    mattress: "You lift it. Underneath: a journal detailing Frank's 'discipline' methods."
                }
            },
            road: {
                description: "The foggy road leads into infinity, whispers echoing from the mist. South back to parking. But ahead... something waits.",
                exits: { s: 'parking' },
                items: [],
                npcs: ['hitchhiker'],
                examinables: {
                    mist: "Shapes form in the fog: twisted figures, beckoning you deeper. One looks like a woman reaching out.",
                    figure: "The hitchhiker turns. Its face is a swirl of fog."
                }
            }
        };

        // Items with descriptions and functions
        const items = {
            // Tools
            crowbar: { 
                description: "A rusty crowbar, good for prying... or swinging.", 
                takeable: true, 
                usable: true,
                onUse: (target) => {
                    if (target === 'closet' && currentRoom === 'room102') {
                        print("You pry open the closet. Inside: a box of Laura's belongings and a key to 202.");
                        if (!rooms.room102.items.includes('key202')) rooms.room102.items.push('key202');
                    } else if (target === 'suitcase' && currentRoom === 'room201') {
                        print("You force the suitcase open. Inside: Frank's address book and photos of Laura.");
                        inventory.push('frank address book');
                    } else {
                        print("You brandish the crowbar. Nothing happens.");
                    }
                }
            },
            screwdriver: { 
                description: "A flathead screwdriver, slightly bent.", 
                takeable: true, 
                usable: true,
                onUse: (target) => {
                    if (target === 'vent' && currentRoom === 'hallway1f' && !puzzleStates.hallway1fVent) {
                        print("You unscrew the vent cover. Inside: duct tape and a key to room 103.");
                        rooms.hallway1f.items.push('duct tape', 'key103');
                        puzzleStates.hallway1fVent = true;
                    } else {
                        print("You fidget with the screwdriver. Nothing happens.");
                    }
                }
            },
            'duct tape': { 
                description: "Heavy-duty duct tape. A hundred uses.", 
                takeable: true, 
                usable: true,
                onUse: (target) => {
                    if (target === 'Bob' && currentRoom === 'hallway2f' && !npcStates.Bob.conscious) {
                        print("You tape Bob's hands and mouth. He's neutralized.");
                    } else {
                        print("You could tape something...");
                    }
                }
            },
            
            // Weapons/defense
            'pepper spray': { 
                description: "A small canister of pepper spray.", 
                takeable: true, 
                usable: true,
                onUse: (target) => {
                    if (target === 'Bob' && currentRoom === 'hallway2f') {
                        print("You spray Bob! He screams, clawing his eyes. You have a few seconds.");
                    } else if (target === 'Frank' && currentRoom === 'room101') {
                        print("You spray Frank! He howls in pain. Laura screams.");
                    } else {
                        print("You spray the air. Your eyes water.");
                    }
                }
            },
            'straight razor': { 
                description: "A rusty straight razor. 'Property of Bob' scratched on the handle.", 
                takeable: true, 
                usable: true,
                onUse: () => print("You open the razor. It gleams menacingly.")
            },
            'bloody knife': { 
                description: "A kitchen knife with dried blood. Laura's name carved in the handle.", 
                takeable: true, 
                usable: true,
                onUse: () => print("The knife feels heavy with evil.")
            },
            
            // Keys
            'key101': { description: "Key to room 101.", takeable: true, usable: false },
            'key102': { description: "Key to room 102.", takeable: true, usable: false },
            'key103': { description: "Key to room 103.", takeable: true, usable: false },
            'key201': { description: "Key to room 201.", takeable: true, usable: false },
            'key202': { description: "Key to room 202.", takeable: true, usable: false },
            'key203': { description: "Key to room 203.", takeable: true, usable: false },
            'key301': { description: "Key to room 301.", takeable: true, usable: false },
            'key302': { description: "Key to room 302.", takeable: true, usable: false },
            'key303': { description: "Key to room 303.", takeable: true, usable: false },
            'master key': { description: "A master key that opens all rooms.", takeable: true, usable: false },
            'bob keys': { description: "Bob's keyring. Opens maintenance closets and room 201.", takeable: true, usable: false },
            'maintenance card': { description: "Keycard for maintenance areas.", takeable: true, usable: false },
            'wet keycard': { description: "A water-damaged keycard. Still works on room 301.", takeable: true, usable: false },
            
            // Evidence items
            'tape recorder': { 
                description: "A tape recorder with Frank's confession: 'She's in the wall, Bob. No one will find her.'", 
                takeable: true, 
                usable: true,
                onUse: () => print("You play it: 'She's in the wall, Bob. No one will find her.'")
            },
            'frank journal': { 
                description: "Frank's journal detailing his obsession with Laura and his 'discipline' methods.", 
                takeable: true, 
                usable: true,
                onUse: () => print("You read about his control over Laura. It's sickening.")
            },
            'bob journal': { 
                description: "Bob's 'observations' about female guests. Dates, times, room numbers.", 
                takeable: true, 
                usable: true,
                onUse: () => print("He's been watching everyone. Taking things from their rooms.")
            },
            'laura diary': { 
                description: "Laura's diary. Fear, desperation, pleas for help.", 
                takeable: true, 
                usable: true,
                onUse: () => print("'Found evidence in 301. If I die, check there.'")
            },
            'laura letters': { 
                description: "Letters from Laura to her sister about Frank and Bob.", 
                takeable: true, 
                usable: true,
                onUse: () => print("'They'll kill me if I try to leave. Tell the police.'")
            },
            'trophy box': { 
                description: "A box of jewelry and IDs from missing women.", 
                takeable: true, 
                usable: true,
                onUse: () => print("Each ID is a woman who never left the motel.")
            },
            'silver locket': { 
                description: "A tarnished silver locket. Inside, a photo of a young girl and the inscription 'Laura's sister - 1982'.", 
                takeable: true, 
                usable: true,
                onUse: () => print("The locket opens. A hidden compartment contains a microfilm of evidence.")
            },
            'bob photo': { 
                description: "A photo of Bob with a young girl. She looks uncomfortable. On the back: 'My special friend. She won't tell.'", 
                takeable: true, 
                usable: true,
                onUse: () => print("The photo disturbs you deeply.")
            },
            'frank id': { 
                description: "Frank's ID badge. There's a room key taped to the back.", 
                takeable: true, 
                usable: true,
                onUse: () => print("You remove the key. It's for room 101.")
            },
            'bell': { 
                description: "A tarnished bell on the counter.", 
                takeable: true, 
                usable: true,
                onUse: () => print("You ring the bell. The clerk's smile widens unnaturally.")
            },
            'sleeping pills': { 
                description: "A bottle of strong sleeping pills. 'Take with alcohol' the label warns.", 
                takeable: true, 
                usable: true,
                onUse: (target) => {
                    if (target === 'Bob' && currentRoom === 'hallway2f') {
                        print("You offer Bob the pills. 'For my back?' He takes them. He'll be drowsy soon.");
                        npcStates.Bob.drugged = true;
                    } else if (target === 'Frank' && currentRoom === 'room101') {
                        print("You offer Frank the pills. He eyes you suspiciously but takes them.");
                        npcStates.Frank.drugged = true;
                    } else {
                        print("You rattle the bottle.");
                    }
                }
            },
            'whiskey': { 
                description: "A half-empty bottle of cheap whiskey.", 
                takeable: true, 
                usable: true,
                onUse: (target) => {
                    if (target === 'Bob' && npcStates.Bob.drugged) {
                        print("Bob washes down the pills with whiskey. He passes out cold.");
                        npcStates.Bob.conscious = false;
                        print("You search him. You find his keys, his journal, and the straight razor.");
                        inventory.push('bob keys');
                        inventory.push('bob journal');
                        inventory.push('straight razor');
                    } else {
                        print("You take a swig. It burns.");
                    }
                }
            }
        };

        // NPCs with full personalities
        const npcs = {
            clerk: {
                talk: () => {
                    if (!npcStates.clerk.conscious) {
                        print("The clerk is unconscious.");
                        return;
                    }
                    npcStates.clerk.talked++;
                    
                    if (npcStates.clerk.talked === 1) {
                        print("The clerk leans in, breath like decay. 'Rooms are cheap... your soul cheaper. Bob's been asking about you. Says you're 'interesting.' Want my advice? Leave while you can.'");
                    } else if (npcStates.clerk.talked === 2) {
                        print("He lowers his voice: 'Look, between us? Bob's dangerous. Frank's worse. Laura's a prisoner. If you find evidence, bring it to me. I'm... not what I seem.'");
                    } else {
                        print("He whispers: 'Find the locket. Room 301. It's the key to everything.'");
                    }
                    
                    if (inventory.includes('silver locket') && !npcStates.clerk.gaveEvidence) {
                        print("The clerk notices the locket chain. His eyes widen. 'That's it. Give it to me. NOW.'");
                    }
                },
                give: (item) => {
                    if (!npcStates.clerk.conscious) return;
                    
                    if (item === 'silver locket') {
                        print("The clerk snatches the locket. He pulls out a police badge. 'Undercover detective. You've given me enough for a warrant. Get out before they realize.' He hands you a master key and ushers you toward the exit.");
                        inventory.push('master key');
                        gameWon = true;
                        print("ðŸŒŸðŸŒŸðŸŒŸ YOU ESCAPED. The police raid the motel. Frank and Bob are arrested. Laura is saved. The remains are identified. JUSTICE. ðŸŒŸðŸŒŸðŸŒŸ");
                    } else if (item === 'tape recorder' || item === 'trophy box' || item === 'bob journal') {
                        print("The clerk nods. 'Good evidence. Keep collecting. The locket is the main piece.'");
                    } else {
                        print("He shakes his head. 'That won't help. Find the locket in 301.'");
                    }
                },
                punch: () => {
                    if (npcStates.clerk.conscious) {
                        print("You punch the clerk. He crumples. As he falls, you see a police badge. He was undercover. You just assaulted a cop. Game over.");
                        gameOver = true;
                    }
                }
            },
            
            Bob: {
                talk: () => {
                    if (!npcStates.Bob.conscious) {
                        print("Bob is unconscious. You should probably run before he wakes.");
                        return;
                    }
                    
                    npcStates.Bob.talked++;
                    npcStates.Bob.suspicious++;
                    
                    const dialogues = [
                        "Bob leans on his mop, eyes roaming over your body. 'New guest, huh? I keep the rooms clean. Especially the ones the pretty ladies stay in. I'm very... thorough.' He licks his lips.",
                        
                        "He moves closer than necessary. 'I got keys to every room. In case of emergencies. I check on people at night. Make sure they're comfortable. Ever had someone watch you sleep? It's... intimate.'",
                        
                        "Bob whispers, breath hot and sour. 'Room 201's got a peephole into 202. Laura doesn't know I watch her change. Frank doesn't mind. We have an... arrangement.' He laughs softly.",
                        
                        "'I got a collection. Under the floorboards in 201. Underwear, photos, little souvenirs. Want to see?' His hand reaches for your arm.",
                        
                        "'You're real pretty. I could show you the boiler room. Real private. No cameras. No one would hear you scream.' He's not joking."
                    ];
                    
                    const idx = Math.min(npcStates.Bob.talked - 1, dialogues.length - 1);
                    print(dialogues[idx]);
                    
                    if (npcStates.Bob.talked >= dialogues.length) {
                        print("Bob grabs your wrist. 'Enough talking. My shift ends in five minutes. Meet me in the basement or I'll tell Frank you're asking questions.'");
                    }
                    
                    if (npcStates.Bob.suspicious > 3 && !npcStates.Bob.drugged) {
                        print("Bob's eyes narrow. 'You ask too many questions. Time for a private tour.' He lunges.");
                        gameOver = true;
                        print("Bob overpowers you. Game over.");
                    }
                },
                give: (item) => {
                    if (!npcStates.Bob.conscious) return;
                    
                    if (item === 'bob photo') {
                        print("Bob's face contorts with rage. 'Where did you get that?!' He attacks. Game over.");
                        gameOver = true;
                    } else if (item === 'sleeping pills') {
                        print("Bob eyes the pills. 'For my back?' He takes them. 'Be a dear and get me some whiskey.'");
                        npcStates.Bob.drugged = true;
                    } else if (item === 'whiskey' && npcStates.Bob.drugged) {
                        print("Bob chugs the whiskey. Within minutes, he's unconscious. You search him.");
                        inventory.push('bob keys');
                        inventory.push('bob journal');
                        inventory.push('straight razor');
                        if (!inventory.includes('trophy box') && puzzleStates.room302Trapdoor) {
                            inventory.push('trophy box');
                        }
                        npcStates.Bob.conscious = false;
                    } else {
                        print("Bob grabs your hand. 'That's not what I want from you.' You pull away, disgusted.");
                    }
                },
                punch: () => {
                    if (!npcStates.Bob.conscious) {
                        print("He's already out.");
                        return;
                    }
                    
                    const hasWeapon = inventory.some(i => ['crowbar', 'straight razor', 'bloody knife'].includes(i));
                    
                    if (hasWeapon) {
                        print("You hit Bob with your weapon. He goes down hard. You search his unconscious body.");
                        inventory.push('bob keys');
                        inventory.push('bob journal');
                        inventory.push('straight razor');
                        npcStates.Bob.conscious = false;
                    } else {
                        print("You punch Bob. He laughs, then grabs you. 'Feisty. I like that.' He drags you toward room 201. Game over.");
                        gameOver = true;
                    }
                }
            },
            
            Frank: {
                talk: () => {
                    if (!npcStates.Frank.conscious) {
                        print("Frank is unconscious. Laura might be safe.");
                        return;
                    }
                    
                    npcStates.Frank.talked++;
                    npcStates.Frank.suspicious++;
                    
                    if (npcStates.Frank.talked === 1) {
                        print("Frank stares at the wall where Laura's name is written. 'She's mine. Three years now. I decide when she eats. When she sleeps. When she breathes. She forgot that. So we're here. Reminding her.'");
                    } else if (npcStates.Frank.talked === 2) {
                        print("'She tried to leave once. I broke her ankle. Told the hospital she fell. She limps now. That's how I know where she is at all times.' He smiles slightly.");
                    } else if (npcStates.Frank.talked === 3) {
                        print("'You keep talking to me. That's suspicious. Laura doesn't have friends. I don't allow friends. Are you her friend?' His eyes narrow.");
                    } else {
                        print("Frank stands, pulling a knife. 'You ask too many questions. Laura needs another lesson. And you're going to watch.' He attacks.");
                        gameOver = true;
                        print("Frank kills you. Game over.");
                    }
                    
                    if (inventory.includes('laura letters') && npcStates.Frank.talked < 3) {
                        print("Frank notices the letters. 'Those are mine. Give them back or I'll add you to the wall.'");
                    }
                },
                give: (item) => {
                    if (!npcStates.Frank.conscious) return;
                    
                    if (item === 'laura letters') {
                        print("Frank grabs the letters. 'These are private.' He beats you unconscious. You wake tied in room 303. Game over.");
                        gameOver = true;
                    } else if (item === 'whiskey') {
                        print("Frank takes the whiskey. 'Leave it. Now get out.' While he's distracted, you notice a key in his pocket.");
                        rooms.room101.items.push('frank keys');
                    } else if (item === 'sleeping pills') {
                        print("Frank eyes the pills. 'For my back.' He takes them. Soon he's drowsy, then unconscious.");
                        npcStates.Frank.conscious = false;
                        print("You search him. You find keys to 101, 201, and a bloody knife.");
                        inventory.push('key101');
                        inventory.push('key201');
                        inventory.push('bloody knife');
                    } else {
                        print("Frank backhands you. 'Don't give me things.' You see stars.");
                    }
                },
                punch: () => {
                    if (!npcStates.Frank.conscious) {
                        print("He's already unconscious.");
                        return;
                    }
                    
                    const hasWeapon = inventory.some(i => ['crowbar', 'straight razor', 'bloody knife'].includes(i));
                    
                    if (hasWeapon) {
                        print("You strike Frank with the weapon. He collapses. You search him.");
                        inventory.push('key101');
                        inventory.push('key201');
                        inventory.push('frank journal');
                        inventory.push('bloody knife');
                        npcStates.Frank.conscious = false;
                    } else {
                        print("You punch Frank. He barely flinches, then beats you senseless. Game over.");
                        gameOver = true;
                    }
                }
            },
            
            Laura: {
                talk: () => {
                    if (!npcStates.Laura.conscious) {
                        print("Laura is unconscious. You monster.");
                        return;
                    }
                    
                    npcStates.Laura.talked++;
                    
                    if (npcStates.Laura.talked === 1) {
                        print("Laura whispers, tears streaming. 'Please... you have to help me. Frank won't let me leave. And Bob... Bob watches me through the vents. He leaves notes under my door.'");
                    } else if (npcStates.Laura.talked === 2) {
                        print("'I found something in room 301. Proof they killed a woman. But I can't get to it. Frank checks on me every hour.'");
                    } else {
                        print("'Please. If you find evidence, take it to the clerk. I think he's a cop. And be careful. They're both monsters.'");
                    }
                    
                    if (npcStates.Laura.trusted) {
                        print("'Thank you for believing me. The proof is in the wall of room 301. Behind the wallpaper.'");
                    }
                },
                give: (item) => {
                    if (!npcStates.Laura.conscious) return;
                    
                    if (item === 'pepper spray') {
                        print("Laura takes it gratefully. 'For Frank. Or Bob.' She hands you a key. 'This opens Bob's supply closet. He keeps evidence in there.'");
                        inventory.push('bob keys');
                        npcStates.Laura.trusted = true;
                    } else if (item === 'frank journal') {
                        print("Laura reads, pales. 'He's been planning to... to kill me. There's a safe in room 103. Combination is 1983. Evidence inside.'");
                        rooms.room103.items.push('safe combo');
                    } else {
                        print("Laura shakes her head. 'That won't help. Find what's in room 301.'");
                    }
                },
                punch: () => {
                    print("You hit Laura. She crumples, terrified. You're no better than Frank. You feel sick.");
                    npcStates.Laura.conscious = false;
                }
            },
            
            hitchhiker: {
                talk: () => {
                    if (npcStates.hitchhiker.vanished) {
                        print("The mist swirls where the hitchhiker stood.");
                        return;
                    }
                    print("The hitchhiker turns. Its face is a swirl of fog. 'They're in the walls. Bob and Frank. They put them there. The proof is in the silver locket.' It fades away, leaving a key.");
                    inventory.push('key301');
                    npcStates.hitchhiker.vanished = true;
                },
                give: () => print("It's gone."),
                punch: () => print("Your fist passes through mist.")
            }
        };

        // Helper function for examine with hidden items
        function handleExamine(obj) {
            const room = rooms[currentRoom];
            
            // Multi-step hidden item chains
            if (currentRoom === 'room101' && obj === 'bed' && !puzzleStates.room101Floorboard) {
                print("You lift the mattress. A loose floorboard is visible underneath.");
                room.examinables.floorboard = "The board is loose. You could pry it up.";
                return true;
            }
            if (currentRoom === 'room101' && obj === 'floorboard' && !puzzleStates.room101Floorboard) {
                print("You pry up the floorboard. Underneath: a bloodstained knife and letters from Laura.");
                room.items.push('bloody knife', 'laura letters');
                puzzleStates.room101Floorboard = true;
                return true;
            }
            
            if (currentRoom === 'room102' && obj === 'pillow' && !puzzleStates.room102Pillow) {
                print("You lift the pillow. Underneath is a key to room 301.");
                room.items.push('key301');
                puzzleStates.room102Pillow = true;
                return true;
            }
            
            if (currentRoom === 'room103' && obj === 'lining' && !puzzleStates.room103Lining) {
                print("You tear open the lining. Inside: a photo of Bob with a young girl, and a key to 103.");
                room.items.push('bob photo', 'key103');
                puzzleStates.room103Lining = true;
                return true;
            }

            if (currentRoom === 'room103' && obj === 'drawers' && !puzzleStates.room103Drawers) {
    print("A half-empty bottle of cheap whiskey rolls out and stops under the bed.");
    puzzleStates.room103Drawers = true;
    // Make the bed examinable now
    rooms.room103.examinables.underbed = "You see a bottle of whiskey under the bed.";
    return true;
}
            
if (currentRoom === 'room103' && (obj === 'bed' || obj === 'underbed') && puzzleStates.room103Drawers && !puzzleStates.room103WhiskeyTaken) {
    print("You reach under the bed and grab the whiskey bottle.");
    rooms.room103.items.push('whiskey');
    puzzleStates.room103WhiskeyTaken = true;
    return true;
}
            
            if (currentRoom === 'room201' && obj === 'wall' && !puzzleStates.room201Wall) {
                print("The hidden compartment opens. Inside: bondage gear, photos of sleeping women, and Bob's 'trophy' album.");
                room.items.push('bob journal', 'trophy box');
                puzzleStates.room201Wall = true;
                return true;
            }
            
            if (currentRoom === 'room203' && obj === 'drawer' && !puzzleStates.room203Drawer) {
                print("The drawer opens. Inside: a tape recorder with Frank's confession.");
                room.items.push('tape recorder');
                puzzleStates.room203Drawer = true;
                return true;
            }
            
            if (currentRoom === 'room301' && obj === 'wallpaper' && !puzzleStates.room301Wallpaper) {
                print("You tear away the wallpaper. Behind it: a hole in the wall with bones inside. Around the neck: a silver locket.");
                room.items.push('silver locket');
                puzzleStates.room301Wallpaper = true;
                return true;
            }
            
            if (currentRoom === 'room302' && obj === 'trapdoor' && !puzzleStates.room302Trapdoor) {
                print("It opens to a crawlspace. Inside: Bob's 'trophy box' - jewelry, IDs, and a master key.");
                room.items.push('trophy box', 'master key');
                puzzleStates.room302Trapdoor = true;
                return true;
            }
            
            if (currentRoom === 'lobby' && obj === 'panel' && !puzzleStates.lobbyPanel) {
                print("Behind the panel: a straight razor with 'BOB' scratched on it.");
                room.items.push('straight razor');
                puzzleStates.lobbyPanel = true;
                return true;
            }
            
            if (currentRoom === 'parking' && obj === 'seat' && !puzzleStates.parkingSeat) {
                print("You reach under the seat and find a maintenance keycard.");
                room.items.push('maintenance card');
                puzzleStates.parkingSeat = true;
                return true;
            }
            
            if (currentRoom === 'hallway1f' && obj === 'vent' && !puzzleStates.hallway1fVent) {
                print("You reach into the vent. You find duct tape and a key to room 103.");
                room.items.push('duct tape', 'key103');
                puzzleStates.hallway1fVent = true;
                return true;
            }
            
            // Standard examinables
            if (room.examinables[obj]) {
                print(room.examinables[obj]);
                return true;
            }
            
            return false;
        }

        function print(text) {
            output.innerHTML += text + '<br>';
            output.scrollTop = output.scrollHeight;
        }

        function describeRoom() {
            const room = rooms[currentRoom];
            print(room.description);
            if (room.items.length > 0) print("You see: " + room.items.join(', '));
            if (room.npcs.length > 0) print("Here: " + room.npcs.join(', '));
        }

        function handleCommand(cmd) {
            if (gameOver) {
                print("Game over. Refresh to restart.");
                return;
            }
            if (gameWon) {
                print("You've escaped the Last Stop Motel. The nightmare is over. (Refresh to play again.)");
                return;
            }
            
            cmd = cmd.toLowerCase().trim();
            const words = cmd.split(' ');

            // Movement
            if (['n', 's', 'e', 'w', 'up', 'down'].includes(cmd)) {
                const exit = rooms[currentRoom].exits[cmd];
                if (exit) {
                    currentRoom = exit;
                    describeRoom();
                } else {
                    print("Can't go that way.");
                }
                return;
            }

            // Look
            if (cmd === 'look') {
                describeRoom();
                return;
            }
            
            // Inventory
            if (cmd === 'inventory') {
                print(inventory.length > 0 ? "Inventory: " + inventory.join(', ') : "Nothing in inventory.");
                return;
            }

            // Take
            if (words[0] === 'take') {
                const item = words.slice(1).join(' ');
                const roomItems = rooms[currentRoom].items;
                
                if (roomItems.includes(item)) {
                    if (items[item] && items[item].takeable !== false) {
                        inventory.push(item);
                        roomItems.splice(roomItems.indexOf(item), 1);
                        print("Taken: " + item);
                    } else {
                        print("Can't take that.");
                    }
                } else {
                    print("You don't see that here.");
                }
                return;
            }

            // Use with target (use crowbar on closet)
            if (cmd.includes(' on ')) {
                const parts = cmd.split(' on ');
                const item = parts[0].replace('use ', '').trim();
                const target = parts[1].trim();
                
                if (inventory.includes(item) && items[item] && items[item].usable) {
                    items[item].onUse(target);
                } else {
                    print("Can't do that.");
                }
                return;
            }

            // Use without target
            if (words[0] === 'use') {
                const item = words.slice(1).join(' ');
                if (inventory.includes(item) && items[item] && items[item].usable) {
                    items[item].onUse(null);
                } else {
                    print("You don't have that or can't use it.");
                }
                return;
            }

            // Give - FIXED
            if (cmd.startsWith('give ')) {
                const withoutGive = cmd.substring(5);
                if (!withoutGive.includes(' to ')) {
                    print("Give what to whom? Example: give silver locket to clerk");
                    return;
                }
                
                const parts = withoutGive.split(' to ');
                const item = parts[0].trim();
                const npc = parts[1].trim();
                
                // Find NPC in room (case insensitive)
                const foundNPC = rooms[currentRoom].npcs.find(n => n.toLowerCase() === npc.toLowerCase());
                
                if (!foundNPC) {
                    print(npc + " isn't here.");
                    return;
                }
                
                if (!inventory.includes(item)) {
                    print("You don't have " + item);
                    return;
                }
                
                if (npcs[foundNPC] && npcs[foundNPC].give) {
                    npcs[foundNPC].give(item);
                    inventory.splice(inventory.indexOf(item), 1);
                } else {
                    print(foundNPC + " doesn't respond.");
                }
                return;
            }

            // Talk to - FIXED
            if (cmd.startsWith('talk to ')) {
                const npc = cmd.substring(8).trim();
                
                const foundNPC = rooms[currentRoom].npcs.find(n => n.toLowerCase() === npc.toLowerCase());
                
                if (!foundNPC) {
                    print("No one named '" + npc + "' is here.");
                    return;
                }
                
                if (npcs[foundNPC] && npcs[foundNPC].talk) {
                    npcs[foundNPC].talk();
                } else {
                    print(foundNPC + " stares at you silently.");
                }
                return;
            }

            // Talk (without to) - also support
            if (words[0] === 'talk') {
                const npc = words.slice(1).join(' ');
                const foundNPC = rooms[currentRoom].npcs.find(n => n.toLowerCase() === npc.toLowerCase());
                
                if (!foundNPC) {
                    print("No one named '" + npc + "' is here.");
                    return;
                }
                
                if (npcs[foundNPC] && npcs[foundNPC].talk) {
                    npcs[foundNPC].talk();
                } else {
                    print(foundNPC + " ignores you.");
                }
                return;
            }

            // Examine
            if (words[0] === 'examine' || words[0] === 'x') {
                const obj = words.slice(1).join(' ');
                
                if (!obj) {
                    print("Examine what?");
                    return;
                }
                
                // Check hidden items first
                if (!handleExamine(obj)) {
                    // Then check inventory
                    if (inventory.includes(obj) && items[obj]) {
                        print(items[obj].description);
                    } 
                    // Then check room items
                    else if (rooms[currentRoom].items.includes(obj) && items[obj]) {
                        print(items[obj].description);
                    }
                    // Then check NPCs
                    else if (rooms[currentRoom].npcs.includes(obj)) {
                        print("You examine " + obj + ". They notice you looking.");
                    }
                    else {
                        print("You see nothing special about that.");
                    }
                }
                return;
            }

            // Punch - FIXED
            if (words[0] === 'punch') {
                const target = words.slice(1).join(' ');
                const foundTarget = rooms[currentRoom].npcs.find(n => n.toLowerCase() === target.toLowerCase());
                
                if (foundTarget) {
                    if (npcs[foundTarget] && npcs[foundTarget].punch) {
                        npcs[foundTarget].punch();
                    } else {
                        print("You can't punch that.");
                    }
                } else {
                    print("Punch what?");
                }
                return;
            }

            print("Unknown command. Try: n/s/e/w/up/down, take, use, give, talk to, examine, punch, look, inventory");
        }

        // Event listener
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const cmd = input.value;
                print('> ' + cmd);
                handleCommand(cmd);
                input.value = '';
            }
        });

        // Start game
        print("Welcome to Last Stop Motel.");
        print("Three floors of horror. Examine everything. Trust no one.");
        describeRoom();
    </script>
</body>
</html>
