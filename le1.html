<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dracula's Last Rise - Level 1: Journey to the Tavern</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Dark Red/Gold/Black theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(120, 0, 0, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(120, 0, 0, 0.15) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 3px solid #ffd700;
            background-color: #000;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(120, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #ffd700;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #ffd700;
            text-shadow: 0 0 8px #ffd700;
            font-size: 32px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #ffd700;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 20px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #ffd700;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #440000;
            color: #cc8888;
            border-color: #cc8888;
        }
        
        .level-number.current {
            background-color: #ffd700;
            color: #000;
            border-color: #ffd700;
            box-shadow: 0 0 12px #ffd700;
            text-shadow: 0 0 2px #000;
            font-weight: bold;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #ffd700;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #ffd700;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #ffd700;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #ffd700;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #ffd700;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #ffed4e;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ffd700;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #ffd700;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #ffd700;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #ffed4e;
            border-color: #ffed4e;
            box-shadow: 0 0 10px rgba(255, 237, 78, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #ffd700;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #ffed4e;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #ffd700;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #ffed4e;
            border-color: #ffed4e;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #330000;
            border: 1px solid #ffd700;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ffd700;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #550000;
            border: 1px solid #ff4444;
            padding: 10px;
            margin: 10px 0;
            color: #ffd700;
            font-weight: bold;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .victory {
            color: #ffd700;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 8px #ffd700;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ffd700;
            font-weight: bold;
        }
        
        .item {
            color: #8ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        .tavern {
            color: #c96;
            font-weight: bold;
        }
        
        .farmer {
            color: #9c6;
            font-weight: bold;
        }
        
        .hunter {
            color: #96c;
            font-weight: bold;
        }
        
        .merchant {
            color: #fc6;
            font-weight: bold;
        }
        
        .danger {
            color: #f44;
            font-weight: bold;
        }
        
        /* Victory Screen */
        .victory-screen {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .victory-btn {
            background-color: #222;
            color: #fff;
            border: 3px solid #ffd700;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .victory-btn:hover, .victory-btn:active {
            background-color: #ffd700;
            color: #000;
            border-color: #ffed4e;
            box-shadow: 0 0 20px #ffd700;
        }
        
        /* Blood Pool Animation */
        .blood-animation {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #330000;
            border: 1px solid #ff0040;
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0% { border-color: #ff0040; }
            50% { border-color: #ff6666; }
            100% { border-color: #ff0040; }
        }
        
        /* Gold Animation */
        .gold-animation {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #332200;
            border: 1px solid #ffd700;
            animation: pulse-gold 2s infinite;
        }
        
        @keyframes pulse-gold {
            0% { border-color: #ffd700; }
            50% { border-color: #ffed4e; }
            100% { border-color: #ffd700; }
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #ffd700;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #ffd700;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #ffed4e;
        }
        
        /* New Game Button */
        .new-game-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #111;
            border: 1px solid #ffd700;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .new-game-btn:hover {
            background: #222;
            color: #ffed4e;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            h2 {
                font-size: 16px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .victory-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <!-- New Game Button -->
        <div class="new-game-btn" onclick="startNewGame()">
            NEW GAME
        </div>
        
        <div class="header">
            <h1>DRACULA'S LAST RISE</h1>
            <h2>LEVEL 1: JOURNEY TO THE TAVERN</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number current">1</div>
            <div class="level-number">2</div>
            <div class="level-number">3</div>
            <div class="level-number">4</div>
            <div class="level-number">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Character Creation Screen -->
        <div id="screen-creation" class="screen active-screen">
            <h2>CHARACTER CREATION</h2>
            <div class="story-text">
                <p>The year is 1897. In the remote village of Wolfsthorne, rumors spread of strange occurrences in the night. Livestock drained of blood, travelers gone missing, and whispers of an ancient evil awakening.</p>
                <p>You have come to Wolfsthorne seeking answers, or perhaps fleeing from something. Before you begin your journey, you must choose your path.</p>
                <p>Who are you?</p>
                
                <div class="choice-buttons">
                    <button class="choice-btn" onclick="createCharacter('hunter')">VAMPIRE HUNTER</button>
                    <button class="choice-btn" onclick="createCharacter('scholar')">OCCULT SCHOLAR</button>
                    <button class="choice-btn" onclick="createCharacter('mercenary')">TRAVELING MERCENARY</button>
                </div>
                
                <div id="class-description" style="margin-top: 20px; padding: 10px; background-color: #111; border: 1px solid #444;">
                    <p>Select a class to see description...</p>
                </div>
            </div>
        </div>
        
        <!-- Level Intro Screen -->
        <div id="screen-intro" class="screen">
            <h2>JOURNEY TO THE TAVERN</h2>
            <div class="story-text">
                <p>The sun sets behind the Carpathian mountains as you approach the village of Wolfsthorne. The air grows cold, and an unnatural mist begins to creep across the road.</p>
                <p>According to the map, there should be a tavern at the edge of the village where travelers gather. The <span class="tavern">"Blood Moon Tavern"</span> might hold information about the strange happenings, or at least provide shelter for the night.</p>
                <p>You check your equipment and prepare for what lies ahead. The journey begins now.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="intro-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="intro-stat-health" class="stat-value">0</span>/<span id="intro-stat-maxhealth" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="intro-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="intro-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="startLevel1()">BEGIN THE JOURNEY</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/10</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>JOURNEY TO THE TAVERN</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Level Complete Screen -->
        <div id="screen-complete" class="screen">
            <h2>LEVEL COMPLETE!</h2>
            <div class="story-text">
                <p class="victory">YOU HAVE REACHED THE TAVERN!</p>
                <div class="gold-animation">
                    <p>The Blood Moon Tavern stands before you, its windows glowing with warm light. You've survived the journey through the dark woods and gathered what information you could.</p>
                    <p>But this is only the beginning. The real dangers lie ahead, in the dark woodlands where creatures of the night await.</p>
                </div>
                <p>Your journey continues tomorrow, when you must venture into the woodlands to reach Castle Dracula.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="complete-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="complete-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="complete-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="complete-stat-gold" class="stat-value">0</span></div>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background-color: #330000; border: 1px solid #ffd700;">
                    <h3 style="color: #ffd700; margin-top: 0;">INVENTORY:</h3>
                    <div id="complete-inventory-display"></div>
                </div>
            </div>
            
            <div class="victory-screen">
                <button class="victory-btn" onclick="goToNextLevel()">CONTINUE TO LEVEL 2</button>
            </div>
        </div>
        
        <div class="footer">
            DRACULA'S LAST RISE - A Gothic Horror Adventure<br>
            Level 1: Journey to the Tavern
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects for the game
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'victory':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    setTimeout(() => playBeep(1300, 0.3, 'sine'), 500);
                    break;
                case 'vampire':
                    playBeep(150, 0.5, 'sawtooth');
                    break;
                case 'wolf':
                    playBeep(80, 0.4, 'square');
                    setTimeout(() => playBeep(60, 0.4, 'square'), 400);
                    break;
                case 'gold':
                    playBeep(1000, 0.1, 'sine');
                    for(let i = 0; i < 5; i++) {
                        setTimeout(() => playBeep(800 + i*100, 0.1, 'sine'), 100 + i*100);
                    }
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: '',
            equippedArmor: '',
            currentSection: 1,
            level: 1,
            // Level 1 specific flags
            hasTorch: false,
            hasMap: false,
            metFarmer: false,
            helpedHunter: false,
            talkedToMerchant: false,
            wolvesDefeated: false,
            // Items with special functions
            hasHealingHerb: false,
            hasSilverCoin: false,
            hasStake: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            isGroup: false,
            groupCount: 0
        };
        
        // Initialize game
        function initGame() {
            // Load game state from localStorage
            const savedGame = localStorage.getItem('draculaRiseGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 1
                if (savedState.level === 1) {
                    Object.assign(gameState, savedState);
                    
                    // Show intro screen with loaded stats
                    document.getElementById('intro-stat-strength').textContent = gameState.strength;
                    document.getElementById('intro-stat-health').textContent = gameState.health;
                    document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('intro-stat-agility').textContent = gameState.agility;
                    document.getElementById('intro-stat-gold').textContent = gameState.gold;
                    
                    showScreen('screen-intro');
                } else if (savedState.level > 1) {
                    // If player has progressed beyond level 1, show character creation
                    showScreen('screen-creation');
                }
            } else {
                // No saved game found, show character creation
                showScreen('screen-creation');
            }
        }
        
        // Start new game (reset everything)
        function startNewGame() {
            playSound('click');
            if (confirm("Are you sure you want to start a new game? All progress will be lost.")) {
                localStorage.removeItem('draculaRiseGameState');
                window.location.reload();
            }
        }
        
        // Character creation
        function createCharacter(className) {
            playSound('click');
            
            // Update description
            const descDiv = document.getElementById('class-description');
            if (className === 'hunter') {
                descDiv.innerHTML = "<p><span class='hunter'>VAMPIRE HUNTER</span>: You are trained in tracking and slaying creatures of the night. Start with higher Strength and a Wooden Stake.</p>";
            } else if (className === 'scholar') {
                descDiv.innerHTML = "<p><span class='npc'>OCCULT SCHOLAR</span>: You study the dark arts and know vampire weaknesses. Start with higher Agility and a Map of the area.</p>";
            } else if (className === 'mercenary') {
                descDiv.innerHTML = "<p><span class='merchant'>TRAVELING MERCENARY</span>: You fight for gold and survival. Start with more Gold and better armor.</p>";
            }
            
            // Create character button
            descDiv.innerHTML += "<br><button class='choice-btn' onclick='confirmCharacter(\"" + className + "\")'>SELECT THIS CLASS</button>";
        }
        
        // Confirm character selection
        function confirmCharacter(className) {
            playSound('click');
            
            // Set base stats based on class
            gameState.playerClass = className;
            
            if (className === 'hunter') {
                gameState.strength = 16;
                gameState.maxHealth = 30;
                gameState.health = 30;
                gameState.agility = 12;
                gameState.gold = 10;
                gameState.equippedWeapon = 'Hunting Knife';
                gameState.equippedArmor = 'Leather Coat';
                gameState.inventory = ['Wooden Stake', 'Healing Herb'];
                gameState.hasStake = true;
                gameState.hasHealingHerb = true;
            } else if (className === 'scholar') {
                gameState.strength = 10;
                gameState.maxHealth = 25;
                gameState.health = 25;
                gameState.agility = 18;
                gameState.gold = 15;
                gameState.equippedWeapon = 'Walking Cane';
                gameState.equippedArmor = 'Traveler\'s Cloak';
                gameState.inventory = ['Ancient Tome', 'Map of Wolfsthorne'];
                gameState.hasMap = true;
            } else if (className === 'mercenary') {
                gameState.strength = 14;
                gameState.maxHealth = 35;
                gameState.health = 35;
                gameState.agility = 14;
                gameState.gold = 30;
                gameState.equippedWeapon = 'Short Sword';
                gameState.equippedArmor = 'Brigandine Vest';
                gameState.inventory = ['Healing Potion', 'Silver Coin'];
                gameState.hasSilverCoin = true;
            }
            
            // Update intro screen stats
            document.getElementById('intro-stat-strength').textContent = gameState.strength;
            document.getElementById('intro-stat-health').textContent = gameState.health;
            document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('intro-stat-agility').textContent = gameState.agility;
            document.getElementById('intro-stat-gold').textContent = gameState.gold;
            
            showScreen('screen-intro');
            saveGame();
        }
        
        function startLevel1() {
            playSound('click');
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item) && item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/10`;
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Herb' || item === 'Healing Potion' || item === 'Mountain Herbs') {
                const healAmount = item === 'Healing Potion' ? rollDice(2, 6) + 5 : 
                                 item === 'Mountain Herbs' ? rollDice(1, 8) + 3 : rollDice(1, 6) + 2;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Wooden Stake') {
                message = "The <span class='item'>Wooden Stake</span> could be used against vampires. It's sharp and sturdy.";
            } else if (item === 'Map of Wolfsthorne') {
                message = "The <span class='item'>Map of Wolfsthorne</span> shows the village layout and surrounding woods. You notice a hidden path marked with an 'X'.";
                gameState.hasMap = true;
            } else if (item === 'Torch') {
                message = "The <span class='item'>Torch</span> provides light in dark places and could scare away wild animals.";
                gameState.hasTorch = true;
            } else if (item === 'Silver Coin') {
                message = "The <span class='item'>Silver Coin</span> is pure silver, which harms some creatures of the night. It might also be used for trade.";
                gameState.hasSilverCoin = true;
            } else if (item === 'Ancient Tome') {
                message = "The <span class='item'>Ancient Tome</span> contains lore about vampires. You recall a passage: 'Silver and garlic weaken them, but only a stake through the heart can kill.'";
            } else if (item === 'Wolf Pelt') {
                message = "The <span class='item'>Wolf Pelt</span> is worth gold to traders and might provide some warmth in cold nights.";
            } else if (item === 'Garlic Clove') {
                message = "The <span class='item'>Garlic Clove</span> is said to repel vampires and other evil creatures.";
            } else if (item === 'Rope') {
                message = "The <span class='item'>Rope</span> could be useful for climbing or securing things.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0) {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Game story sections for Level 1
        const storySections = {
            1: {
                text: "You stand at the crossroads outside Wolfsthorne village. The road splits in three directions. To the left, a dark forest path. Straight ahead, the main road to the village. To the right, a muddy trail that seems less traveled.",
                choices: [
                    {text: "Take the dark forest path (shorter but dangerous)", nextSection: 2, skillCheck: false},
                    {text: "Follow the main road (safe but longer)", nextSection: 3, skillCheck: false},
                    {text: "Try the muddy trail (unknown)", nextSection: 4, skillCheck: false},
                    {text: "Check your map if you have one", nextSection: 5, skillCheck: false, requirement: function() { return gameState.hasMap; }}
                ]
            },
            2: {
                text: "You enter the dark forest. The trees loom overhead, blocking out what little moonlight remains. You hear strange noises in the distance.",
                choices: [
                    {text: "Continue cautiously through the forest", nextSection: 6, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Light a torch if you have one", nextSection: 7, skillCheck: false, requirement: function() { return gameState.inventory.includes('Torch'); }},
                    {text: "Return to the crossroads", nextSection: 1, skillCheck: false}
                ]
            },
            3: {
                text: "You take the main road. It's well-traveled but eerily empty tonight. After walking for a while, you see a farmhouse with lights on.",
                choices: [
                    {text: "Knock on the farmhouse door", nextSection: 8, skillCheck: false},
                    {text: "Continue straight to the tavern", nextSection: 9, skillCheck: false},
                    {text: "Investigate the barn", nextSection: 10, skillCheck: false}
                ]
            },
            4: {
                text: "The muddy trail is difficult to navigate. Your boots sink into the mud with each step. You come across an abandoned cart.",
                choices: [
                    {text: "Search the abandoned cart", nextSection: 11, skillCheck: true, checkType: 'agility', difficulty: 12},
                    {text: "Try to find a way around the mud", nextSection: 12, skillCheck: true, checkType: 'strength', difficulty: 14},
                    {text: "Return to the crossroads", nextSection: 1, skillCheck: false}
                ]
            },
            5: {
                text: "You consult your map. It shows that the forest path leads directly to the tavern but is marked 'Danger - Wolves'. The main road is safer but circles around the village. The muddy trail leads to an old mill.",
                choices: [
                    {text: "Take the forest path anyway", nextSection: 2, skillCheck: false},
                    {text: "Take the main road", nextSection: 3, skillCheck: false},
                    {text: "Try the muddy trail to the mill", nextSection: 4, skillCheck: false}
                ]
            },
            6: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 13, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You move quietly through the forest, avoiding loose branches and dry leaves. You spot the tavern lights in the distance.";
                    } else {
                        playSound('failure');
                        // Encounter wolves
                        combatState.active = true;
                        combatState.enemyName = "Wolf Pack";
                        combatState.enemyHealth = 40;
                        combatState.enemyCurrentHealth = 40;
                        combatState.enemyStrength = 14;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 14;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 3;
                        
                        playSound('wolf');
                        return "You step on a dry branch! The snap echoes through the forest. From the shadows, glowing eyes appear. <span class='enemy'>Wolf Pack</span> approaches!";
                    }
                }
            },
            7: {
                text: "You light your torch. The flame pushes back the darkness and shadows retreat. Animals are wary of fire.",
                choices: [
                    {text: "Continue through the forest with torch", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The torchlight keeps predators at bay. You safely navigate through the forest.";
                }
            },
            8: {
                text: "A weary-looking farmer answers the door. 'Traveler? You shouldn't be out tonight. Strange things are about.'",
                choices: [
                    {text: "Ask about the strange happenings", nextSection: 16, skillCheck: false},
                    {text: "Ask for directions to the tavern", nextSection: 17, skillCheck: false},
                    {text: "Offer to help with any problems", nextSection: 18, skillCheck: false},
                    {text: "Thank him and continue to tavern", nextSection: 9, skillCheck: false}
                ],
                action: function() {
                    gameState.metFarmer = true;
                    playSound('click');
                    return "<span class='farmer'>Farmer</span>: 'Lost some sheep last night. No blood, just... drained.'";
                }
            },
            9: {
                text: "You continue along the main road and finally see the Blood Moon Tavern ahead. Warm light spills from its windows.",
                choices: [
                    {text: "Enter the tavern", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "You've reached your destination! The tavern awaits.";
                }
            },
            10: {
                text: "The barn is quiet. As you approach, you hear a faint whimpering sound from inside.",
                choices: [
                    {text: "Enter the barn cautiously", nextSection: 20, skillCheck: true, checkType: 'agility', difficulty: 12},
                    {text: "Call out to see if anyone is there", nextSection: 21, skillCheck: false},
                    {text: "Return to the farmhouse", nextSection: 8, skillCheck: false}
                ]
            },
            11: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 22, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        const goldFound = rollDice(2, 10);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        return "You find a small locked box in the cart. With some effort, you pry it open to find <span class='gold'>" + goldFound + " Gold</span>!";
                    } else {
                        playSound('failure');
                        return "The cart is empty except for some rotting vegetables. You find nothing of value.";
                    }
                }
            },
            12: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 23, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You find solid ground and bypass the worst of the mud. You continue toward the tavern.";
                    } else {
                        playSound('failure');
                        const damage = rollDice(1, 4);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "You slip in the mud and take " + damage + " damage! Exhausted, you return to the crossroads.";
                    }
                }
            },
            13: {
                text: "Having safely navigated the forest, you emerge near the Blood Moon Tavern.",
                choices: [
                    {text: "Enter the tavern", nextSection: 19, skillCheck: false}
                ]
            },
            14: {
                text: "The wolves circle you, teeth bared!",
                choices: [
                    {text: "Fight the wolves!", nextSection: 24, skillCheck: false}
                ],
                action: function() {
                    playSound('combat');
                    return "<span class='enemy'>Wolf Pack</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            15: {
                text: "With your torch lighting the way, you safely pass through the forest and arrive at the tavern.",
                choices: [
                    {text: "Enter the tavern", nextSection: 19, skillCheck: false}
                ]
            },
            16: {
                text: "'What's been happening?' you ask. The farmer looks around nervously. 'Strange lights in the old castle on the hill. Animals disappearing. Some folks say they've seen... things in the woods.'",
                choices: [
                    {text: "Ask about the castle", nextSection: 25, skillCheck: false},
                    {text: "Ask about the tavern", nextSection: 17, skillCheck: false},
                    {text: "Offer to help", nextSection: 18, skillCheck: false}
                ],
                action: function() {
                    return "<span class='farmer'>Farmer</span>: 'Castle Dracula, they call it. Been empty for years... or so we thought.'";
                }
            },
            17: {
                text: "'The Blood Moon Tavern? Just down the road. Tell Old Gregor I sent you. He might have work for a strong traveler.'",
                choices: [
                    {text: "Ask about the strange happenings", nextSection: 16, skillCheck: false},
                    {text: "Offer to help", nextSection: 18, skillCheck: false},
                    {text: "Thank him and continue to tavern", nextSection: 9, skillCheck: false}
                ],
                action: function() {
                    return "<span class='farmer'>Farmer</span>: 'Old Gregor knows more about what's happening than anyone. But he doesn't talk to just anyone.'";
                }
            },
            18: {
                text: "'I could use help with the wolves,' the farmer says. 'They've been getting bolder. If you can deal with them, I'll pay you.'",
                choices: [
                    {text: "Accept the wolf-hunting task", nextSection: 26, skillCheck: false},
                    {text: "Decline and continue to tavern", nextSection: 9, skillCheck: false}
                ],
                action: function() {
                    return "<span class='farmer'>Farmer</span>: 'There's a silver coin in it for you. Silver's good against... unnatural things.'";
                }
            },
            19: {
                text: "You enter the Blood Moon Tavern. The air is thick with smoke and the smell of ale. A few patrons sit at tables, speaking in hushed tones. The bartender, a grizzled old man, eyes you warily.",
                choices: [
                    {text: "Approach the bartender", nextSection: 27, skillCheck: false},
                    {text: "Talk to the hunter in the corner", nextSection: 28, skillCheck: false},
                    {text: "Speak with the mysterious merchant", nextSection: 29, skillCheck: false},
                    {text: "Rent a room for the night", nextSection: 30, skillCheck: false}
                ],
                action: function() {
                    playSound('click');
                    return "This is the gathering place for information in Wolfsthorne. Choose your approach carefully.";
                }
            },
            20: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 31, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        addToInventory('Rope');
                        return "You find a trapped sheep caught in some old rope. You free it and take the <span class='item'>Rope</span>. The farmer will be grateful.";
                    } else {
                        playSound('failure');
                        // Another wolf encounter
                        combatState.active = true;
                        combatState.enemyName = "Lone Wolf";
                        combatState.enemyHealth = 25;
                        combatState.enemyCurrentHealth = 25;
                        combatState.enemyStrength = 12;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 4;
                        combatState.nextSection = 32;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('wolf');
                        return "A wolf has taken shelter in the barn! It snarls and attacks!";
                    }
                }
            },
            21: {
                text: "'Hello? Is anyone there?' you call out. The whimpering stops. A moment later, a sheep emerges from the shadows, trailing a rope.",
                choices: [
                    {text: "Approach and free the sheep", nextSection: 33, skillCheck: false},
                    {text: "Return to the farmhouse", nextSection: 8, skillCheck: false}
                ],
                action: function() {
                    return "The sheep seems to have gotten tangled in some old rope.";
                }
            },
            22: {
                text: "After searching the cart, you continue along the muddy trail.",
                choices: [
                    {text: "Continue toward the tavern", nextSection: 34, skillCheck: false},
                    {text: "Return to the crossroads", nextSection: 1, skillCheck: false}
                ]
            },
            23: {
                text: "You return to the crossroads, wet and muddy.",
                choices: [
                    {text: "Take the forest path", nextSection: 2, skillCheck: false},
                    {text: "Take the main road", nextSection: 3, skillCheck: false}
                ]
            },
            24: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 35, skillCheck: false}
                ]
            },
            25: {
                text: "'Castle Dracula,' the farmer whispers. 'They say the Count sleeps there during the day. At night... he hunts.'",
                choices: [
                    {text: "Ask about the tavern", nextSection: 17, skillCheck: false},
                    {text: "Offer to help with wolves", nextSection: 26, skillCheck: false},
                    {text: "Thank him and continue to tavern", nextSection: 9, skillCheck: false}
                ],
                action: function() {
                    return "<span class='farmer'>Farmer</span>: 'If you're going up there, you'll need silver, garlic, and a stake. And courage. Lots of courage.'";
                }
            },
            26: {
                text: "You agree to help with the wolves. The farmer gives you directions to where they've been seen.",
                choices: [
                    {text: "Hunt the wolves now", nextSection: 36, skillCheck: false},
                    {text: "Go to the tavern first", nextSection: 9, skillCheck: false}
                ],
                action: function() {
                    gameState.helpedHunter = true;
                    return "<span class='farmer'>Farmer</span>: 'Thank you. Be careful. These aren't normal wolves.'";
                }
            },
            27: {
                text: "'What'll it be?' the bartender grunts, wiping a glass with a dirty rag.",
                choices: [
                    {text: "Ask for information about Castle Dracula", nextSection: 37, skillCheck: false},
                    {text: "Ask about a room for the night", nextSection: 38, skillCheck: false},
                    {text: "Buy a drink", nextSection: 39, skillCheck: false},
                    {text: "Mention the farmer sent you", nextSection: 40, skillCheck: false, requirement: function() { return gameState.metFarmer; }}
                ],
                action: function() {
                    playSound('click');
                    return "<span class='tavern'>Bartender</span>: 'We don't get many strangers these days. Not since the troubles began.'";
                }
            },
            28: {
                text: "The hunter looks up as you approach. 'You're not from around here. What brings you to Wolfsthorne?'",
                choices: [
                    {text: "Say you're looking for work", nextSection: 41, skillCheck: false},
                    {text: "Ask about the strange occurrences", nextSection: 42, skillCheck: false},
                    {text: "Ask about Castle Dracula", nextSection: 43, skillCheck: false}
                ],
                action: function() {
                    playSound('click');
                    return "<span class='hunter'>Hunter</span>: 'If you're smart, you'll turn around and leave. This place is cursed.'";
                }
            },
            29: {
                text: "The merchant eyes you with interest. 'Interested in rare goods? I have items that might help someone going into dangerous places.'",
                choices: [
                    {text: "Browse the merchant's wares", nextSection: 44, skillCheck: false},
                    {text: "Ask about Castle Dracula", nextSection: 45, skillCheck: false},
                    {text: "Return to other tavern activities", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    gameState.talkedToMerchant = true;
                    playSound('click');
                    return "<span class='merchant'>Merchant</span>: 'For the right price, I can equip you for the dangers ahead.'";
                }
            },
            30: {
                text: "You rent a room for the night. This completes your journey to the tavern.",
                choices: [
                    {text: "Complete Level 1", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "You've secured shelter for the night. Tomorrow, your journey continues into the woodlands toward Castle Dracula.";
                }
            },
            31: {
                text: "After dealing with the barn situation, you return to the farmer.",
                choices: [
                    {text: "Return to the farmhouse", nextSection: 47, skillCheck: false}
                ]
            },
            32: {
                text: "You defeat the lone wolf in the barn!",
                choices: [
                    {text: "Take the wolf pelt", nextSection: 48, skillCheck: false},
                    {text: "Return to the farmer", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    gameState.wolvesDefeated = true;
                    return "The wolf collapses. You've defended the farmer's livestock.";
                }
            },
            33: {
                text: "You free the sheep from the rope. It bleats gratefully and trots back toward the farmhouse.",
                choices: [
                    {text: "Take the rope", nextSection: 49, skillCheck: false},
                    {text: "Return to the farmer", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    return "The sheep is freed! You now have some rope that might be useful.";
                }
            },
            34: {
                text: "The muddy trail eventually connects back to the main road. You can see the tavern ahead.",
                choices: [
                    {text: "Enter the tavern", nextSection: 19, skillCheck: false}
                ]
            },
            35: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 14, skillCheck: false}
                ]
            },
            36: {
                text: "You track the wolves to a small clearing. Three of them are waiting.",
                choices: [
                    {text: "Attack the wolves", nextSection: 50, skillCheck: false}
                ],
                action: function() {
                    // Wolf encounter
                    combatState.active = true;
                    combatState.enemyName = "Wolf Pack";
                    combatState.enemyHealth = 45;
                    combatState.enemyCurrentHealth = 45;
                    combatState.enemyStrength = 15;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 51;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 3;
                    
                    playSound('wolf');
                    return "<span class='enemy'>Wolf Pack</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            37: {
                text: "The bartender's expression darkens. 'Castle Dracula? That's no place for the living. Even hunters who go up there don't come back.'",
                choices: [
                    {text: "Ask about hunters who tried", nextSection: 52, skillCheck: false},
                    {text: "Ask about a room", nextSection: 38, skillCheck: false},
                    {text: "Buy a drink", nextSection: 39, skillCheck: false}
                ],
                action: function() {
                    return "<span class='tavern'>Bartender</span>: 'If you're determined to go, you'll need more than courage. You'll need silver, holy water, and a stake.'";
                }
            },
            38: {
                text: "'Room's 5 gold for the night,' the bartender says. 'Includes a meal.'",
                choices: [
                    {text: "Pay for the room (5 gold)", nextSection: 53, skillCheck: false, requirement: function() { return gameState.gold >= 5; }},
                    {text: "Say you'll sleep in the common room", nextSection: 54, skillCheck: false},
                    {text: "Return to other options", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    return "<span class='tavern'>Bartender</span>: 'Upstairs, first door on the right.'";
                }
            },
            39: {
                text: "'Ale's 1 gold,' the bartender says, pouring a mug.",
                choices: [
                    {text: "Pay for ale (1 gold)", nextSection: 55, skillCheck: false, requirement: function() { return gameState.gold >= 1; }},
                    {text: "Return to other options", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    return "A drink might help you gather information from the other patrons.";
                }
            },
            40: {
                text: "'Old Thomas sent you, eh?' The bartender's expression softens slightly. 'He's a good man. What do you need?'",
                choices: [
                    {text: "Ask about Castle Dracula", nextSection: 56, skillCheck: false},
                    {text: "Ask about a room", nextSection: 57, skillCheck: false},
                    {text: "Ask about work", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    return "<span class='tavern'>Bartender</span>: 'Since Thomas sent you, I'll give it to you straight. The castle is waking. Something evil stirs there.'";
                }
            },
            41: {
                text: "'Work?' The hunter laughs bitterly. 'Only work here is hunting things that hunt you back.'",
                choices: [
                    {text: "Ask what he means", nextSection: 42, skillCheck: false},
                    {text: "Ask about Castle Dracula", nextSection: 43, skillCheck: false}
                ],
                action: function() {
                    return "<span class='hunter'>Hunter</span>: 'I lost my partner last week up near the castle. Wolf got him, they say. But the wounds... weren't right.'";
                }
            },
            42: {
                text: "'Wolves that move like men,' the hunter whispers. 'Shadows that shouldn't be there. Animals drained of blood. The castle's curse spreads.'",
                choices: [
                    {text: "Ask about Castle Dracula", nextSection: 43, skillCheck: false},
                    {text: "Ask if he needs help", nextSection: 59, skillCheck: false},
                    {text: "Return to other tavern activities", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    return "<span class='hunter'>Hunter</span>: 'They say Dracula sleeps in a coffin filled with earth from his homeland. Sunlight kills him. A stake through the heart makes sure.'";
                }
            },
            43: {
                text: "'The castle?' The hunter shakes his head. 'Forget it. No one comes back from there. Not really.'",
                choices: [
                    {text: "Ask about the strange occurrences", nextSection: 42, skillCheck: false},
                    {text: "Ask if he needs help", nextSection: 59, skillCheck: false},
                    {text: "Return to other tavern activities", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    return "<span class='hunter'>Hunter</span>: 'If you're determined, take the western path through the woodlands at dawn. And don't travel at night.'";
                }
            },
            44: {
                text: "'I have these items for sale,' the merchant says, displaying his wares.",
                choices: [
                    {text: "Buy Torch (3 gold)", nextSection: 60, skillCheck: false, requirement: function() { return gameState.gold >= 3 && !gameState.inventory.includes('Torch'); }},
                    {text: "Buy Garlic Clove (2 gold)", nextSection: 61, skillCheck: false, requirement: function() { return gameState.gold >= 2 && !gameState.inventory.includes('Garlic Clove'); }},
                    {text: "Buy Healing Potion (5 gold)", nextSection: 62, skillCheck: false, requirement: function() { return gameState.gold >= 5; }},
                    {text: "Return to other tavern activities", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    return "<span class='merchant'>Merchant</span>: 'Choose wisely. These items might save your life.'";
                }
            },
            45: {
                text: "'Castle Dracula? I have items specifically for such ventures,' the merchant says with a sly smile.",
                choices: [
                    {text: "Browse the merchant's wares", nextSection: 44, skillCheck: false},
                    {text: "Return to other tavern activities", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    return "<span class='merchant'>Merchant</span>: 'The castle is protected by more than stone walls. You'll need special equipment.'";
                }
            },
            46: {
                text: "You complete your preparations at the tavern. Tomorrow, you venture into the woodlands toward Castle Dracula.",
                choices: [
                    {text: "Complete the level", nextSection: 63, skillCheck: false}
                ]
            },
            47: {
                text: "You return to the farmer. 'Thank you for helping!' he says. 'Here's your reward.'",
                choices: [
                    {text: "Take the reward and continue to tavern", nextSection: 64, skillCheck: false}
                ],
                action: function() {
                    const goldReward = rollDice(1, 10) + 5;
                    gameState.gold += goldReward;
                    addToInventory('Silver Coin');
                    updateStatsDisplay();
                    playSound('gold');
                    return "The farmer gives you <span class='gold'>" + goldReward + " Gold</span> and a <span class='item'>Silver Coin</span>.";
                }
            },
            48: {
                text: "You skin the wolf and take its pelt.",
                choices: [
                    {text: "Return to the farmer for reward", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Wolf Pelt');
                    return "You take the <span class='item'>Wolf Pelt</span>. It might be worth something.";
                }
            },
            49: {
                text: "You take the rope that was tangled around the sheep.",
                choices: [
                    {text: "Return to the farmer for reward", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Rope');
                    return "You take the <span class='item'>Rope</span>. It could be useful.";
                }
            },
            50: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 65, skillCheck: false}
                ]
            },
            51: {
                text: "You defeat the wolf pack! The farmer will be pleased.",
                choices: [
                    {text: "Take wolf pelts", nextSection: 66, skillCheck: false},
                    {text: "Return to the farmer for reward", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    gameState.wolvesDefeated = true;
                    return "The wolves are defeated. The area is safer now.";
                }
            },
            52: {
                text: "'Last hunter who went up there was Van Helsing's apprentice,' the bartender says. 'Left his journal behind. You can have it for 10 gold.'",
                choices: [
                    {text: "Buy the journal (10 gold)", nextSection: 67, skillCheck: false, requirement: function() { return gameState.gold >= 10; }},
                    {text: "Ask about a room", nextSection: 38, skillCheck: false},
                    {text: "Return to other options", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    return "<span class='tavern'>Bartender</span>: 'It's got notes about vampire weaknesses, castle layout, everything.'";
                }
            },
            53: {
                text: "You pay for the room and get the key.",
                choices: [
                    {text: "Go to your room", nextSection: 68, skillCheck: false}
                ],
                action: function() {
                    gameState.gold -= 5;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You pay <span class='gold'>5 Gold</span> for the room. The bartender gives you a key.";
                }
            },
            54: {
                text: "'Suit yourself,' the bartender says. 'Common room's free, but don't expect comfort.'",
                choices: [
                    {text: "Sleep in the common room", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    return "You'll save money but won't get as good a rest.";
                }
            },
            55: {
                text: "You buy an ale and sip it slowly, listening to conversations around you.",
                choices: [
                    {text: "Listen for useful information", nextSection: 70, skillCheck: true, checkType: 'agility', difficulty: 12},
                    {text: "Talk to the hunter", nextSection: 28, skillCheck: false},
                    {text: "Talk to the merchant", nextSection: 29, skillCheck: false}
                ],
                action: function() {
                    gameState.gold -= 1;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You pay <span class='gold'>1 Gold</span> for the ale.";
                }
            },
            56: {
                text: "'Since Thomas sent you, I'll tell you what I know,' the bartender says. 'The castle has three ways in: the main gate, the servant's entrance, and a secret tunnel from the old chapel.'",
                choices: [
                    {text: "Ask about the secret tunnel", nextSection: 71, skillCheck: false},
                    {text: "Ask about a room", nextSection: 57, skillCheck: false},
                    {text: "Ask about work", nextSection: 58, skillCheck: false}
                ],
                action: function() {
                    return "<span class='tavern'>Bartender</span>: 'The tunnel's the safest way, but it's guarded. Nothing in that castle is unguarded.'";
                }
            },
            57: {
                text: "'For Thomas's friend, room's only 3 gold,' the bartender says.",
                choices: [
                    {text: "Pay for the room (3 gold)", nextSection: 72, skillCheck: false, requirement: function() { return gameState.gold >= 3; }},
                    {text: "Sleep in common room", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    return "<span class='tavern'>Bartender</span>: 'Special price for a friend of Thomas.'";
                }
            },
            58: {
                text: "'Work?' The bartender thinks. 'Cellar's infested with rats. Clear them out, I'll pay 5 gold.'",
                choices: [
                    {text: "Accept the rat-clearing job", nextSection: 73, skillCheck: false},
                    {text: "Decline", nextSection: 56, skillCheck: false}
                ],
                action: function() {
                    return "<span class='tavern'>Bartender</span>: 'They're big rats. Nasty ones.'";
                }
            },
            59: {
                text: "'Help?' The hunter looks at you. 'I'm heading into the woodlands tomorrow to track what killed my partner. Could use backup.'",
                choices: [
                    {text: "Agree to help the hunter", nextSection: 74, skillCheck: false},
                    {text: "Decline politely", nextSection: 42, skillCheck: false}
                ],
                action: function() {
                    return "<span class='hunter'>Hunter</span>: 'We leave at dawn. Meet me here if you're coming.'";
                }
            },
            60: {
                text: "You buy a torch from the merchant.",
                choices: [
                    {text: "Browse other items", nextSection: 44, skillCheck: false},
                    {text: "Return to tavern activities", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    gameState.gold -= 3;
                    addToInventory('Torch');
                    updateStatsDisplay();
                    playSound('gold');
                    return "You buy a <span class='item'>Torch</span> for <span class='gold'>3 Gold</span>.";
                }
            },
            61: {
                text: "You buy a garlic clove from the merchant.",
                choices: [
                    {text: "Browse other items", nextSection: 44, skillCheck: false},
                    {text: "Return to tavern activities", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    gameState.gold -= 2;
                    addToInventory('Garlic Clove');
                    updateStatsDisplay();
                    playSound('gold');
                    return "You buy a <span class='item'>Garlic Clove</span> for <span class='gold'>2 Gold</span>. It's said to repel vampires.";
                }
            },
            62: {
                text: "You buy a healing potion from the merchant.",
                choices: [
                    {text: "Browse other items", nextSection: 44, skillCheck: false},
                    {text: "Return to tavern activities", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    gameState.gold -= 5;
                    addToInventory('Healing Potion');
                    updateStatsDisplay();
                    playSound('gold');
                    return "You buy a <span class='item'>Healing Potion</span> for <span class='gold'>5 Gold</span>.";
                }
            },
            63: {
                text: "",
                choices: [
                    {text: "Complete Level 1", nextSection: 75, skillCheck: false}
                ],
                action: function() {
                    // Show level complete screen
                    showLevelComplete();
                    return "";
                }
            },
            64: {
                text: "With your reward from the farmer, you continue to the tavern.",
                choices: [
                    {text: "Enter the tavern", nextSection: 19, skillCheck: false}
                ]
            },
            65: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 36, skillCheck: false}
                ]
            },
            66: {
                text: "You take pelts from the wolves you defeated.",
                choices: [
                    {text: "Return to the farmer for reward", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Wolf Pelt');
                    addToInventory('Wolf Pelt');
                    return "You take two <span class='item'>Wolf Pelts</span>. They should be worth something.";
                }
            },
            67: {
                text: "You buy the hunter's journal from the bartender.",
                choices: [
                    {text: "Read the journal", nextSection: 76, skillCheck: false},
                    {text: "Ask about a room", nextSection: 38, skillCheck: false}
                ],
                action: function() {
                    gameState.gold -= 10;
                    addToInventory("Van Helsing's Journal");
                    updateStatsDisplay();
                    playSound('gold');
                    return "You buy <span class='item'>Van Helsing's Journal</span> for <span class='gold'>10 Gold</span>.";
                }
            },
            68: {
                text: "You go to your room. It's small but clean. You secure the door and prepare to rest for the night.",
                choices: [
                    {text: "Sleep and complete the level", nextSection: 77, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 8) + 5;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    updateStatsDisplay();
                    return "A good night's rest in a proper bed restores " + actualHeal + " Health.";
                }
            },
            69: {
                text: "You find a spot in the common room and try to sleep. It's uncomfortable, but you manage some rest.",
                choices: [
                    {text: "Complete the level", nextSection: 77, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 4) + 2;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    updateStatsDisplay();
                    return "You get some rest in the common room, restoring " + actualHeal + " Health.";
                }
            },
            70: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 78, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        addToInventory('Mountain Herbs');
                        return "You overhear two travelers talking about mountain herbs that heal wounds. One drops a small pouch. You discreetly pick it up - it contains <span class='item'>Mountain Herbs</span>!";
                    } else {
                        playSound('failure');
                        return "You listen carefully but can't make out anything useful over the tavern noise.";
                    }
                }
            },
            71: {
                text: "'The tunnel starts in the old chapel ruin in the woodlands,' the bartender says. 'But it's collapsed in places. You'll need rope and maybe a shovel.'",
                choices: [
                    {text: "Ask about a room", nextSection: 57, skillCheck: false},
                    {text: "Ask about work", nextSection: 58, skillCheck: false},
                    {text: "Return to other tavern activities", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    return "<span class='tavern'>Bartender</span>: 'The chapel's marked on most maps of the area. Look for the stone angel.'";
                }
            },
            72: {
                text: "You get the discounted room key from the bartender.",
                choices: [
                    {text: "Go to your room", nextSection: 68, skillCheck: false}
                ],
                action: function() {
                    gameState.gold -= 3;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You pay <span class='gold'>3 Gold</span> for the room (discounted price).";
                }
            },
            73: {
                text: "You head to the cellar to clear out the rats.",
                choices: [
                    {text: "Fight the rats", nextSection: 79, skillCheck: false}
                ],
                action: function() {
                    // Rat encounter
                    combatState.active = true;
                    combatState.enemyName = "Giant Rats";
                    combatState.enemyHealth = 30;
                    combatState.enemyCurrentHealth = 30;
                    combatState.enemyStrength = 8;
                    combatState.enemyDamageDice = 1;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 80;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 5;
                    
                    playSound('combat');
                    return "The cellar is dark and smells of mold. Giant rats scurry toward you!";
                }
            },
            74: {
                text: "'Good,' the hunter says. 'We leave at dawn. Get some rest.'",
                choices: [
                    {text: "Get a room for the night", nextSection: 38, skillCheck: false},
                    {text: "Sleep in the common room", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    gameState.helpedHunter = true;
                    return "<span class='hunter'>Hunter</span>: 'I'll see you at dawn. Don't be late.'";
                }
            },
            75: {
                text: "",
                choices: [
                    {text: "Complete Level 1", nextSection: 63, skillCheck: false}
                ]
            },
            76: {
                text: "You skim through the journal. It contains detailed notes about vampire weaknesses, castle layout sketches, and warnings about Dracula's powers.",
                choices: [
                    {text: "Ask about a room", nextSection: 38, skillCheck: false},
                    {text: "Return to other tavern activities", nextSection: 19, skillCheck: false}
                ],
                action: function() {
                    return "The journal mentions that Dracula can transform into a wolf or bat, control the weather, and command lesser vampires. His weaknesses include sunlight, garlic, holy symbols, and running water.";
                }
            },
            77: {
                text: "You wake at dawn, ready to continue your journey. The next stage leads into the dark woodlands toward Castle Dracula.",
                choices: [
                    {text: "Complete Level 1", nextSection: 63, skillCheck: false}
                ]
            },
            78: {
                text: "After listening in the tavern, you consider your next move.",
                choices: [
                    {text: "Talk to the hunter", nextSection: 28, skillCheck: false},
                    {text: "Talk to the merchant", nextSection: 29, skillCheck: false},
                    {text: "Talk to the bartender", nextSection: 27, skillCheck: false}
                ]
            },
            79: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 81, skillCheck: false}
                ]
            },
            80: {
                text: "You clear the cellar of rats! The bartender pays you as promised.",
                choices: [
                    {text: "Take the reward", nextSection: 82, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 5;
                    updateStatsDisplay();
                    playSound('gold');
                    return "The bartender gives you <span class='gold'>5 Gold</span> as promised. 'Good work,' he says.";
                }
            },
            81: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 73, skillCheck: false}
                ]
            },
            82: {
                text: "With the rat job complete, you return to the tavern main room.",
                choices: [
                    {text: "Get a room for the night", nextSection: 38, skillCheck: false},
                    {text: "Sleep in the common room", nextSection: 69, skillCheck: false},
                    {text: "Talk to other patrons", nextSection: 19, skillCheck: false}
                ]
            }
        };
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in combat
            if (!combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    if (typeof choice.requirement === 'function') {
                        return choice.requirement();
                    }
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                let weaponType = gameState.equippedWeapon;
                
                if (weaponType.includes('Sword') || weaponType.includes('Knife')) {
                    damage = rollDice(2, 6) + 3;
                } else if (weaponType === 'Walking Cane') {
                    damage = rollDice(1, 6) + 1;
                } else {
                    damage = rollDice(1, 4) + 1;
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                let enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                
                // Group enemies attack together
                if (combatState.isGroup && combatState.groupCount > 1) {
                    enemyDamage += Math.floor(combatState.groupCount * 2); // Extra damage for group
                    resultText += `The enemies attack together!<br>`;
                }
                
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('draculaRiseGameState');
                        window.location.reload();
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Enemy attack (for when player uses item in combat)
        function enemyAttack() {
            const combatResult = executeCombatRound();
            document.getElementById('story-text').innerHTML += combatResult;
            
            // Check if combat is over
            if (!combatState.active) {
                endCombatVictory();
            }
        }
        
        // End combat with victory
        function endCombatVictory() {
            let goldReward = 0;
            
            if (combatState.enemyName.includes('Wolf')) {
                goldReward = Math.floor(Math.random() * 10) + 5;
            } else if (combatState.enemyName.includes('Rat')) {
                goldReward = 5; // Already given by bartender
            }
            
            if (goldReward > 0) {
                gameState.gold += goldReward;
                updateStatsDisplay();
            }
            
            document.getElementById('story-text').innerHTML += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
            
            if (goldReward > 0) {
                document.getElementById('story-text').innerHTML += `<br>You find <span class="gold">${goldReward} Gold</span>.`;
            }
            
            // Clear choice buttons - combat is over
            document.getElementById('choice-buttons').innerHTML = '';
            
            // Auto-continue to next section after combat
            setTimeout(() => {
                loadSection(combatState.nextSection);
            }, 2000);
        }
        
        // Show level complete screen
        function showLevelComplete() {
            // Update complete screen stats
            document.getElementById('complete-stat-strength').textContent = gameState.strength;
            document.getElementById('complete-stat-health').textContent = gameState.health;
            document.getElementById('complete-stat-agility').textContent = gameState.agility;
            document.getElementById('complete-stat-gold').textContent = gameState.gold;
            
            // Display inventory
            const inventoryDisplay = document.getElementById('complete-inventory-display');
            inventoryDisplay.innerHTML = '';
            
            // Show equipped items
            const equippedDiv = document.createElement('div');
            equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
            inventoryDisplay.appendChild(equippedDiv);
            
            // Show other inventory
            if (gameState.inventory.length > 0) {
                const invDiv = document.createElement('div');
                invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                inventoryDisplay.appendChild(invDiv);
            }
            
            playSound('victory');
            showScreen('screen-complete');
            
            // Save completed game state
            saveGame();
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('victory');
            
            // Update game state for level 2
            gameState.level = 2;
            gameState.currentSection = 1; // Reset section for next level
            
            // Save updated state
            saveGame();
            
            // Redirect to level 2
            alert("Congratulations! You have completed Level 1. Your progress has been saved. Continuing to Level 2: Entering the Woodlands...");
            window.location.href = 'le2.html';
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You dodge an attack!",
                    "You move silently past an enemy.",
                    "You climb a difficult obstacle.",
                    "You slip through a narrow passage."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip and take 5 damage!",
                    "You make noise and alert nearby enemies.",
                    "You get tangled in something.",
                    "You knock something over, making noise."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 5;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('draculaRiseGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('draculaRiseGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 1 (this page)
                if (savedState.level === 1) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 1.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
