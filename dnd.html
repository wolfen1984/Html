<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>D&D Kingdom Management</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        /* Mobile-first CSS for Android portrait */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            line-height: 1.5;
            padding: 10px;
            max-width: 100vw;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 20px);
            border: 3px solid #fff;
            padding: 10px;
            position: relative;
        }

        .header {
            text-align: center;
            padding: 10px 0;
            border-bottom: 2px solid #fff;
            margin-bottom: 10px;
            position: relative;
        }

        .game-title {
            color: #fff;
            font-size: 1.2rem;
            text-shadow: 0 0 5px #fff;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #aaa;
            font-size: 0.6rem;
            margin-bottom: 5px;
        }

        .stats-toggle {
            position: absolute;
            top: 10px;
            right: 0;
            background: #000;
            border: 2px solid #fff;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            padding: 5px 8px;
            font-size: 0.5rem;
            cursor: pointer;
        }

        .content-area {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 10px;
        }

        .game-screen {
            flex: 3;
            border: 2px solid #fff;
            padding: 12px;
            background-color: #111;
            overflow-y: auto;
            min-height: 200px;
            font-size: 0.8rem;
        }

        .character-panel {
            flex: 2;
            border: 2px solid #fff;
            padding: 12px;
            background-color: #111;
            overflow-y: auto;
            font-size: 0.7rem;
            display: none;
        }

        .character-panel.hidden {
            display: none;
        }

        .kingdom-panel {
            flex: 2;
            border: 2px solid #fff;
            padding: 12px;
            background-color: #111;
            overflow-y: auto;
            font-size: 0.7rem;
            display: block;
        }

        .kingdom-panel.hidden {
            display: none;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #fff;
        }

        .action-btn {
            background-color: #000;
            color: #fff;
            border: 2px solid #fff;
            padding: 14px 8px;
            font-family: 'Press Start 2P', monospace;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .action-btn:hover, .action-btn:active {
            background-color: #fff;
            color: #000;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn:disabled:hover {
            background-color: #000;
            color: #fff;
        }

        .game-text {
            margin-bottom: 12px;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        .input-section {
            margin: 12px 0;
            padding: 10px;
            border: 1px dashed #fff;
            text-align: center;
        }

        .input-section input {
            font-family: 'Press Start 2P', monospace;
            padding: 12px;
            width: 100%;
            background: #000;
            color: #fff;
            border: 2px solid #fff;
            font-size: 0.8rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .stat-box {
            border: 1px solid #444;
            padding: 8px;
            text-align: center;
        }

        .stat-label {
            color: #aaa;
            font-size: 0.6rem;
            margin-bottom: 4px;
        }

        .stat-value {
            color: #fff;
            font-size: 0.9rem;
        }

        .resource-bar-container {
            margin: 8px 0;
        }

        .resource-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            margin-bottom: 5px;
        }

        .resource-bar {
            height: 16px;
            width: 100%;
            background-color: #333;
            border: 1px solid #fff;
        }

        .resource-fill {
            height: 100%;
            transition: width 0.5s;
        }

        .kingdom-log {
            color: #55aaff;
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #55aaff;
            background-color: rgba(85, 170, 255, 0.1);
            font-size: 0.7rem;
        }

        .crisis-log {
            color: #ff5555;
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ff5555;
            background-color: rgba(255, 85, 85, 0.1);
            font-size: 0.7rem;
        }

        .game-over {
            color: #ff0000;
            font-size: 1.2rem;
            text-align: center;
            margin: 15px 0;
            text-shadow: 0 0 10px #ff0000;
        }

        .victory {
            color: #00ff00;
            font-size: 1.2rem;
            text-align: center;
            margin: 15px 0;
            text-shadow: 0 0 10px #00ff00;
        }

        .building-name {
            color: #55ff55;
        }

        .resource-gain {
            color: #55ffff;
        }

        .resource-loss {
            color: #ff5555;
        }

        .gold-gain {
            color: #ffd700;
        }

        .level-up {
            color: #ffaa00;
        }

        .dialog-text {
            color: #ffff55;
        }

        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .inventory-item {
            border: 1px solid #55ff55;
            padding: 5px;
            font-size: 0.6rem;
            background: rgba(85, 255, 85, 0.1);
        }

        .section-title {
            color: #fff;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #fff;
            font-size: 0.8rem;
        }

        .kingdom-name {
            color: #fff;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px dashed #fff;
            padding-bottom: 5px;
        }

        .quick-stats {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #444;
            background: rgba(255, 255, 255, 0.05);
            font-size: 0.7rem;
        }

        .quick-stat {
            text-align: center;
        }

        .quick-stat-label {
            color: #aaa;
            font-size: 0.6rem;
        }

        .quick-stat-value {
            color: #fff;
            font-size: 0.8rem;
        }

        .building-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .building-card {
            border: 1px solid #444;
            padding: 8px;
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .building-card:hover {
            border-color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        .building-card.built {
            border-color: #55ff55;
            background: rgba(85, 255, 85, 0.1);
        }

        .building-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .council-member {
            border: 1px solid #55aaff;
            padding: 8px;
            margin-bottom: 8px;
            background: rgba(85, 170, 255, 0.1);
            font-size: 0.6rem;
        }

        .crisis-event {
            border: 2px solid #ff5555;
            padding: 10px;
            margin: 10px 0;
            background: rgba(255, 85, 85, 0.1);
            font-size: 0.7rem;
        }

        /* Portrait orientation specific */
        @media (orientation: portrait) and (max-height: 800px) {
            .game-text {
                font-size: 0.7rem;
            }
            
            .action-btn {
                padding: 12px 6px;
                font-size: 0.6rem;
                min-height: 50px;
            }
        }

        /* Landscape orientation adjustments */
        @media (orientation: landscape) {
            .content-area {
                flex-direction: row;
            }
            
            .character-panel, .kingdom-panel {
                max-width: 40%;
            }
        }

        /* Animation for new messages */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .new-message {
            animation: fadeIn 0.3s ease-out;
        }

        /* Resource animations */
        @keyframes resourceUp {
            0% { color: #fff; transform: scale(1); }
            50% { color: #55ffff; transform: scale(1.2); }
            100% { color: #fff; transform: scale(1); }
        }

        .resource-up {
            animation: resourceUp 0.5s ease;
        }

        @keyframes resourceDown {
            0% { color: #fff; transform: scale(1); }
            50% { color: #ff5555; transform: scale(0.9); }
            100% { color: #fff; transform: scale(1); }
        }

        .resource-down {
            animation: resourceDown 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1 class="game-title">D&D KINGDOM MANAGEMENT</h1>
            <div class="subtitle">BUILD YOUR REALM</div>
            <button class="stats-toggle" id="stats-toggle">KINGDOM</button>
            <button class="stats-toggle" id="character-toggle" style="right: 80px;">CHARACTER</button>
        </div>
        
        <div class="quick-stats" id="quick-stats">
            <div class="quick-stat">
                <div class="quick-stat-label">GOLD</div>
                <div class="quick-stat-value" id="quick-gold">500</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-label">FOOD</div>
                <div class="quick-stat-value" id="quick-food">100/200</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-label">POPULATION</div>
                <div class="quick-stat-value" id="quick-pop">50</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-label">MONTH</div>
                <div class="quick-stat-value" id="quick-month">1</div>
            </div>
        </div>
        
        <div class="content-area">
            <div class="game-screen" id="game-screen">
                <div class="game-text" id="game-text">Welcome to D&D Kingdom Management! Create your ruler to begin building your realm.</div>
            </div>
            
            <div class="character-panel hidden" id="character-panel">
                <div class="section-title">RULER SHEET</div>
                <div id="character-stats"></div>
            </div>
            
            <div class="kingdom-panel" id="kingdom-panel">
                <div class="section-title">KINGDOM STATUS</div>
                <div id="kingdom-stats"></div>
            </div>
        </div>
        
        <div class="controls" id="controls">
            <!-- Action buttons will be inserted here -->
        </div>
    </div>

    <script>
        // Wait for DOM to load
        document.addEventListener('DOMContentLoaded', function() {
            console.log("D&D Kingdom Management loading...");
            
            // Game state
            const gameState = {
                screen: 'characterCreation',
                player: {
                    name: '',
                    race: '',
                    class: '',
                    level: 1,
                    str: 16,
                    dex: 12,
                    con: 14,
                    int: 10,
                    wis: 8,
                    cha: 13,
                    gold: 500,
                    inventory: [],
                    abilities: []
                },
                kingdom: {
                    name: '',
                    month: 1,
                    year: 1,
                    stability: 75, // 0-100
                    population: 50,
                    maxPopulation: 100,
                    food: 100,
                    maxFood: 200,
                    wood: 50,
                    stone: 30,
                    iron: 20,
                    morale: 60, // 0-100
                    reputation: 50, // 0-100
                    buildings: [],
                    council: [],
                    events: [],
                    crises: [],
                    activeProjects: []
                },
                buildings: {
                    farm: { name: 'Farm', cost: { gold: 50, wood: 20 }, time: 1, effect: '+20 max food, +5 food/month', built: false },
                    barracks: { name: 'Barracks', cost: { gold: 100, wood: 50, stone: 30 }, time: 2, effect: 'Unlocks guards, +10 stability', built: false },
                    market: { name: 'Market', cost: { gold: 150, wood: 30 }, time: 1, effect: '+20 gold/month, +10 reputation', built: false },
                    watchtower: { name: 'Watchtower', cost: { gold: 80, stone: 40 }, time: 1, effect: 'Early warning system, +15 stability', built: false },
                    temple: { name: 'Temple', cost: { gold: 200, wood: 50, stone: 60 }, time: 3, effect: '+20 morale, +1 event choice', built: false },
                    library: { name: 'Library', cost: { gold: 120, wood: 40 }, time: 2, effect: '+20% research speed, +10 reputation', built: false },
                    mine: { name: 'Iron Mine', cost: { gold: 180, wood: 60 }, time: 2, effect: '+10 iron/month, dangerous', built: false },
                    walls: { name: 'Stone Walls', cost: { gold: 300, stone: 200 }, time: 4, effect: '+40 stability, -20% crisis damage', built: false },
                    castle: { name: 'Castle', cost: { gold: 1000, wood: 200, stone: 300, iron: 100 }, time: 6, effect: 'WIN CONDITION', built: false }
                },
                councilPositions: {
                    steward: { name: 'Steward', effect: '+20% gold income', filled: false, candidate: null },
                    marshal: { name: 'Marshal', effect: '+30% defense', filled: false, candidate: null },
                    spymaster: { name: 'Spymaster', effect: 'See crises early', filled: false, candidate: null },
                    highPriest: { name: 'High Priest', effect: '+20 morale/month', filled: false, candidate: null },
                    architect: { name: 'Architect', effect: '-20% building cost', filled: false, candidate: null }
                },
                gameLog: [],
                difficulty: 'normal'
            };

            // Game content
            const gameContent = {
                characterCreation: {
                    text: "Welcome, future ruler! Before you build your kingdom, you must create your character.",
                    steps: [
                        { text: "What is your name, ruler?", field: "name" },
                        { text: "Choose your race:", field: "race" },
                        { text: "Choose your class:", field: "class" },
                        { text: "Name your kingdom:", field: "kingdomName" }
                    ],
                    currentStep: 0
                },
                
                races: {
                    Human: { cha: 2, int: 1, desc: "Charismatic leaders, good diplomats" },
                    Elf: { int: 2, wis: 1, cha: -1, desc: "Wise planners, long-term thinkers" },
                    Dwarf: { con: 2, wis: 1, cha: -1, desc: "Excellent builders, resilient" },
                    Halfling: { dex: 2, cha: 1, str: -1, desc: "Good with people, lucky" },
                    Dragonborn: { str: 2, cha: 1, int: -1, desc: "Inspiring presence, intimidating" }
                },
                
                classes: {
                    Noble: {
                        stats: { str: 12, dex: 10, con: 12, int: 14, wis: 10, cha: 16 },
                        ability: 'Diplomatic Immunity',
                        bonus: '+100 starting gold, +20 starting reputation',
                        desc: 'Born to rule, skilled in politics'
                    },
                    Commander: {
                        stats: { str: 16, dex: 12, con: 14, int: 10, wis: 12, cha: 14 },
                        ability: 'Military Tactics',
                        bonus: 'Start with Barracks, +20 starting stability',
                        desc: 'Military leader, strategic thinker'
                    },
                    Merchant: {
                        stats: { str: 10, dex: 14, con: 12, int: 16, wis: 10, cha: 14 },
                        ability: 'Trade Networks',
                        bonus: '+200 starting gold, start with Market',
                        desc: 'Master of trade and economy'
                    },
                    Sage: {
                        stats: { str: 8, dex: 10, con: 12, int: 16, wis: 16, cha: 10 },
                        ability: 'Ancient Knowledge',
                        bonus: 'Start with Library, +1 event choice always',
                        desc: 'Wise scholar, keeper of lore'
                    },
                    Priest: {
                        stats: { str: 12, dex: 10, con: 14, int: 10, wis: 16, cha: 14 },
                        ability: 'Divine Favor',
                        bonus: 'Start with Temple, +30 starting morale',
                        desc: 'Spiritual leader, moral compass'
                    }
                },
                
                monthlyEvents: [
                    {
                        name: 'Trade Caravan',
                        description: 'A wealthy trade caravan passes through your lands.',
                        choices: [
                            { text: 'Tax them heavily (+100 gold, -15 reputation)', effect: { gold: 100, reputation: -15 } },
                            { text: 'Offer protection (+50 gold, +5 reputation)', effect: { gold: 50, reputation: 5 } },
                            { text: 'Let them pass freely (+20 reputation)', effect: { reputation: 20 } }
                        ]
                    },
                    {
                        name: 'Bandit Threat',
                        description: 'Bandits are preying on your trade routes.',
                        choices: [
                            { text: 'Send guards (Cost: 50 gold, +10 stability)', effect: { gold: -50, stability: 10 } },
                            { text: 'Negotiate with them (CHA check)', effect: { special: 'negotiate' } },
                            { text: 'Ignore the problem (-20 stability)', effect: { stability: -20 } }
                        ]
                    },
                    {
                        name: 'Plague Outbreak',
                        description: 'A mysterious illness spreads among your people.',
                        choices: [
                            { text: 'Quarantine the sick (-10 population, +20 stability)', effect: { population: -10, stability: 20 } },
                            { text: 'Call for healers (Cost: 80 gold, WIS check)', effect: { gold: -80, special: 'heal' } },
                            { text: 'Pray for divine help (WIS/CHA check)', effect: { special: 'pray' } }
                        ]
                    },
                    {
                        name: 'Bountiful Harvest',
                        description: 'The harvest is better than expected!',
                        choices: [
                            { text: 'Store the surplus (+100 food)', effect: { food: 100 } },
                            { text: 'Hold a feast (+20 morale, -30 food)', effect: { morale: 20, food: -30 } },
                            { text: 'Sell the excess (+150 gold)', effect: { gold: 150 } }
                        ]
                    },
                    {
                        name: 'Noble Visit',
                        description: 'A noble from a neighboring kingdom visits.',
                        choices: [
                            { text: 'Lavishæ‹›å¾… (+50 gold, +30 reputation)', effect: { gold: -50, reputation: 30 } },
                            { text: 'Modestæ‹›å¾… (+10 reputation)', effect: { reputation: 10 } },
                            { text: 'Insult them (-40 reputation, possible war)', effect: { reputation: -40, special: 'insult' } }
                        ]
                    }
                ],
                
                crises: [
                    {
                        name: 'Dragon Attack',
                        severity: 'high',
                        warning: 'Dragons seen in nearby mountains',
                        description: 'A dragon attacks your kingdom!',
                        effects: { population: -20, stability: -40, morale: -30, buildings: ['random'] },
                        solutions: [
                            { text: 'Fight it (STR/class check)', cost: {}, special: 'fightDragon' },
                            { text: 'Pay tribute (500 gold)', cost: { gold: 500 }, effect: { stability: 10 } },
                            { text: 'Evacuate (-30 population, -20 morale)', cost: {}, effect: { population: -30, morale: -20 } }
                        ]
                    },
                    {
                        name: 'Famine',
                        severity: 'medium',
                        warning: 'Crops are failing',
                        description: 'Food supplies are critically low!',
                        effects: { food: -100, population: -15, morale: -25 },
                        solutions: [
                            { text: 'Import food (300 gold)', cost: { gold: 300 }, effect: { food: 150 } },
                            { text: 'Ration supplies (WIS check)', cost: {}, special: 'ration' },
                            { text: 'Let people leave (-25 population)', cost: {}, effect: { population: -25, morale: -10 } }
                        ]
                    },
                    {
                        name: 'Rebellion',
                        severity: 'medium',
                        warning: 'Rumors of discontent',
                        description: 'A faction rebels against your rule!',
                        effects: { stability: -30, morale: -20, population: -10 },
                        solutions: [
                            { text: 'Crush the rebellion (STR/class check)', cost: {}, special: 'crushRebellion' },
                            { text: 'Negotiate (CHA/INT check)', cost: {}, special: 'negotiateRebellion' },
                            { text: 'Make concessions (-20 stability, +20 morale)', cost: {}, effect: { stability: -20, morale: 20 } }
                        ]
                    }
                ]
            };

            // DOM Elements
            const gameScreen = document.getElementById('game-screen');
            const gameText = document.getElementById('game-text');
            const characterPanel = document.getElementById('character-panel');
            const kingdomPanel = document.getElementById('kingdom-panel');
            const characterStats = document.getElementById('character-stats');
            const kingdomStats = document.getElementById('kingdom-stats');
            const controls = document.getElementById('controls');
            const statsToggle = document.getElementById('stats-toggle');
            const characterToggle = document.getElementById('character-toggle');
            const quickStats = document.getElementById('quick-stats');
            const quickGold = document.getElementById('quick-gold');
            const quickFood = document.getElementById('quick-food');
            const quickPop = document.getElementById('quick-pop');
            const quickMonth = document.getElementById('quick-month');

            // Toggle panels
            statsToggle.addEventListener('click', function() {
                kingdomPanel.classList.toggle('hidden');
                characterPanel.classList.add('hidden');
                this.textContent = kingdomPanel.classList.contains('hidden') ? 'KINGDOM' : 'HIDE';
            });

            characterToggle.addEventListener('click', function() {
                characterPanel.classList.toggle('hidden');
                kingdomPanel.classList.add('hidden');
                this.textContent = characterPanel.classList.contains('hidden') ? 'CHARACTER' : 'HIDE';
            });

            // Update quick stats
            function updateQuickStats() {
                quickGold.textContent = gameState.player.gold;
                quickFood.textContent = `${gameState.kingdom.food}/${gameState.kingdom.maxFood}`;
                quickPop.textContent = gameState.kingdom.population;
                quickMonth.textContent = gameState.kingdom.month;
                
                // Color code food
                const foodPercent = (gameState.kingdom.food / gameState.kingdom.maxFood) * 100;
                if (foodPercent < 25) {
                    quickFood.style.color = '#ff0000';
                } else if (foodPercent < 50) {
                    quickFood.style.color = '#ffaa00';
                } else {
                    quickFood.style.color = '#00ff00';
                }
            }

            // Initialize the game
            function initGame() {
                console.log("Initializing kingdom management game...");
                gameState.screen = 'characterCreation';
                gameContent.characterCreation.currentStep = 0;
                
                // Reset player
                gameState.player = {
                    name: '',
                    race: '',
                    class: '',
                    level: 1,
                    str: 10,
                    dex: 10,
                    con: 10,
                    int: 10,
                    wis: 10,
                    cha: 10,
                    gold: 500,
                    inventory: [],
                    abilities: []
                };
                
                // Reset kingdom
                gameState.kingdom = {
                    name: '',
                    month: 1,
                    year: 1,
                    stability: 75,
                    population: 50,
                    maxPopulation: 100,
                    food: 100,
                    maxFood: 200,
                    wood: 50,
                    stone: 30,
                    iron: 20,
                    morale: 60,
                    reputation: 50,
                    buildings: [],
                    council: [],
                    events: [],
                    crises: [],
                    activeProjects: []
                };
                
                // Reset buildings
                Object.keys(gameState.buildings).forEach(building => {
                    gameState.buildings[building].built = false;
                });
                
                // Reset council
                Object.keys(gameState.councilPositions).forEach(position => {
                    gameState.councilPositions[position].filled = false;
                    gameState.councilPositions[position].candidate = null;
                });
                
                gameState.gameLog = [];
                
                renderCharacterCreation();
                updateQuickStats();
            }

            // Render character creation
            function renderCharacterCreation() {
                clearGameScreen();
                
                const step = gameContent.characterCreation.steps[gameContent.characterCreation.currentStep];
                
                addTextToScreen(gameContent.characterCreation.text);
                addTextToScreen('');
                addTextToScreen(step.text);
                
                if (step.field === 'name' || step.field === 'kingdomName') {
                    renderNameInput(step.field);
                } else if (step.field === 'race') {
                    renderRaceSelection();
                } else if (step.field === 'class') {
                    renderClassSelection();
                }
            }

            // Render name input
            function renderNameInput(field) {
                const inputSection = document.createElement('div');
                inputSection.className = 'input-section';
                inputSection.innerHTML = `
                    <input type="text" id="name-input" placeholder="Enter ${field === 'kingdomName' ? 'kingdom name' : 'name'}" maxlength="20">
                    <button id="name-submit" class="action-btn">CONFIRM</button>
                `;
                gameScreen.appendChild(inputSection);
                
                const nameInput = document.getElementById('name-input');
                const nameSubmit = document.getElementById('name-submit');
                
                nameSubmit.addEventListener('click', () => {
                    const name = nameInput.value.trim();
                    if (name && name.length >= 2) {
                        if (field === 'kingdomName') {
                            gameState.kingdom.name = name;
                        } else {
                            gameState.player.name = name;
                        }
                        gameContent.characterCreation.currentStep++;
                        renderCharacterCreation();
                    } else {
                        addTextToScreen("Please enter a name (at least 2 characters).", true);
                    }
                });
                
                nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') nameSubmit.click();
                });
                
                nameInput.focus();
            }

            // Render race selection
            function renderRaceSelection() {
                clearControls();
                
                Object.keys(gameContent.races).forEach(race => {
                    const raceInfo = gameContent.races[race];
                    const button = document.createElement('button');
                    button.className = 'action-btn';
                    button.innerHTML = `${race}<br><span style="font-size:0.6rem;color:#aaa">${raceInfo.desc}</span>`;
                    button.addEventListener('click', () => {
                        gameState.player.race = race;
                        
                        // Apply racial bonuses
                        Object.keys(raceInfo).forEach(stat => {
                            if (['str','dex','con','int','wis','cha'].includes(stat)) {
                                gameState.player[stat] += raceInfo[stat];
                            }
                        });
                        
                        gameContent.characterCreation.currentStep++;
                        renderCharacterCreation();
                    });
                    controls.appendChild(button);
                });
            }

            // Render class selection
            function renderClassSelection() {
                clearControls();
                
                Object.keys(gameContent.classes).forEach(cls => {
                    const classInfo = gameContent.classes[cls];
                    const button = document.createElement('button');
                    button.className = 'action-btn';
                    button.innerHTML = `${cls}<br><span style="font-size:0.6rem;color:#aaa">${classInfo.desc}<br>${classInfo.bonus}</span>`;
                    button.addEventListener('click', () => {
                        gameState.player.class = cls;
                        
                        // Apply class stats
                        Object.keys(classInfo.stats).forEach(stat => {
                            gameState.player[stat] = classInfo.stats[stat];
                        });
                        
                        // Apply class bonuses
                        applyClassBonuses(cls);
                        
                        // Move to kingdom naming
                        gameContent.characterCreation.currentStep++;
                        renderCharacterCreation();
                    });
                    controls.appendChild(button);
                });
            }

            // Apply class starting bonuses
            function applyClassBonuses(cls) {
                switch(cls) {
                    case 'Noble':
                        gameState.player.gold += 100;
                        gameState.kingdom.reputation += 20;
                        break;
                    case 'Commander':
                        gameState.buildings.barracks.built = true;
                        gameState.kingdom.stability += 20;
                        gameState.kingdom.buildings.push('Barracks');
                        break;
                    case 'Merchant':
                        gameState.player.gold += 200;
                        gameState.buildings.market.built = true;
                        gameState.kingdom.buildings.push('Market');
                        break;
                    case 'Sage':
                        gameState.buildings.library.built = true;
                        gameState.kingdom.buildings.push('Library');
                        break;
                    case 'Priest':
                        gameState.buildings.temple.built = true;
                        gameState.kingdom.morale += 30;
                        gameState.kingdom.buildings.push('Temple');
                        break;
                }
            }

            // Start the game
            function startGame() {
                gameState.screen = 'kingdomManagement';
                updateCharacterPanel();
                updateKingdomPanel();
                updateQuickStats();
                renderMonthStart();
            }

            // Render month start
            function renderMonthStart() {
                clearGameScreen();
                clearControls();
                
                // Process month end effects
                processMonthEnd();
                
                // Check for crises
                if (gameState.kingdom.crises.length > 0) {
                    renderCrisis();
                    return;
                }
                
                // Check for victory
                if (checkVictory()) {
                    renderVictory();
                    return;
                }
                
                // Check for game over
                if (checkGameOver()) {
                    renderGameOver();
                    return;
                }
                
                addTextToScreen(`<div class="kingdom-name">MONTH ${gameState.kingdom.month}, YEAR ${gameState.kingdom.year}</div>`);
                addTextToScreen(`The kingdom of <span class="building-name">${gameState.kingdom.name}</span> awaits your guidance.`);
                
                // Show monthly event
                if (Math.random() < 0.7 || gameState.kingdom.month % 3 === 0) {
                    const event = gameContent.monthlyEvents[Math.floor(Math.random() * gameContent.monthlyEvents.length)];
                    renderEvent(event);
                    return;
                }
                
                // Show game log
                if (gameState.gameLog.length > 0) {
                    addTextToScreen('');
                    const logElement = document.createElement('div');
                    logElement.className = 'kingdom-log';
                    logElement.innerHTML = gameState.gameLog.join('<br>');
                    gameScreen.appendChild(logElement);
                    gameState.gameLog = [];
                }
                
                addTextToScreen('<br>What is your command this month?');
                
                // Main action buttons
                const actions = [
                    { text: "ðŸ—ï¸ BUILD", icon: "ðŸ—ï¸", action: () => renderBuildMenu() },
                    { text: "ðŸ‘¥ COUNCIL", icon: "ðŸ‘¥", action: () => renderCouncilMenu() },
                    { text: "ðŸ“Š SURVEY", icon: "ðŸ“Š", action: () => renderSurvey() },
                    { text: "â­ï¸ NEXT MONTH", icon: "â­ï¸", action: () => nextMonth() }
                ];
                
                // Add class-specific action
                const classActions = {
                    Noble: { text: "ðŸ¤ DIPLOMACY", icon: "ðŸ¤", action: () => renderDiplomacy() },
                    Commander: { text: "âš”ï¸ TRAIN TROOPS", icon: "âš”ï¸", action: () => renderTraining() },
                    Merchant: { text: "ðŸ’° TRADE", icon: "ðŸ’°", action: () => renderTrade() },
                    Sage: { text: "ðŸ“š RESEARCH", icon: "ðŸ“š", action: () => renderResearch() },
                    Priest: { text: "ðŸ™ PRAY", icon: "ðŸ™", action: () => renderPrayer() }
                };
                
                actions.forEach(action => {
                    const button = document.createElement('button');
                    button.className = 'action-btn';
                    button.innerHTML = `${action.icon} ${action.text}`;
                    button.addEventListener('click', action.action);
                    controls.appendChild(button);
                });
                
                // Add class action if available
                if (classActions[gameState.player.class]) {
                    const classAction = classActions[gameState.player.class];
                    const button = document.createElement('button');
                    button.className = 'action-btn';
                    button.innerHTML = `${classAction.icon} ${classAction.text}`;
                    button.addEventListener('click', classAction.action);
                    controls.appendChild(button);
                }
            }

            // Process month end
            function processMonthEnd() {
                const k = gameState.kingdom;
                
                // Monthly income
                let goldIncome = 50;
                let foodProduction = 20;
                let woodProduction = 10;
                let stoneProduction = 5;
                let ironProduction = 0;
                
                // Building effects
                if (gameState.buildings.farm.built) foodProduction += 20;
                if (gameState.buildings.market.built) goldIncome += 20;
                if (gameState.buildings.mine.built) ironProduction += 10;
                
                // Council effects
                if (gameState.councilPositions.steward.filled) goldIncome = Math.floor(goldIncome * 1.2);
                if (gameState.councilPositions.architect.filled) {
                    // Reduced in processing
                }
                
                // Apply production
                k.food = Math.min(k.maxFood, k.food + foodProduction);
                k.wood += woodProduction;
                k.stone += stoneProduction;
                k.iron += ironProduction;
                gameState.player.gold += goldIncome;
                
                // Population consumes food
                const foodConsumption = Math.floor(k.population * 0.5);
                k.food -= foodConsumption;
                
                // Population growth (if enough food)
                if (k.food > k.population && k.population < k.maxPopulation) {
                    const growth = Math.floor(Math.random() * 5) + 1;
                    k.population = Math.min(k.maxPopulation, k.population + growth);
                    addToGameLog(`Population grew by ${growth}.`, 'resource-up');
                }
                
                // Morale adjustments
                if (k.food < k.population) {
                    k.morale -= 10;
                    addToGameLog("Food shortages lower morale.", 'resource-down');
                }
                
                if (k.stability < 30) {
                    k.morale -= 5;
                }
                
                if (gameState.buildings.temple.built) {
                    k.morale += 5;
                }
                
                if (gameState.councilPositions.highPriest.filled) {
                    k.morale += 20;
                }
                
                // Stability adjustments
                if (k.morale > 80) k.stability += 5;
                if (k.morale < 30) k.stability -= 10;
                
                // Clamp values
                k.morale = Math.max(0, Math.min(100, k.morale));
                k.stability = Math.max(0, Math.min(100, k.stability));
                k.reputation = Math.max(0, Math.min(100, k.reputation));
                k.food = Math.max(0, k.food);
                
                // Check for crises
                if (Math.random() < 0.3) {
                    const crisisChance = (100 - k.stability) / 100;
                    if (Math.random() < crisisChance) {
                        const crisis = gameContent.crises[Math.floor(Math.random() * gameContent.crises.length)];
                        k.crises.push({...crisis, active: true});
                        addToGameLog(`<span style="color:#ff5555">CRISIS: ${crisis.warning}</span>`, 'resource-down');
                    }
                }
                
                // Update displays
                updateKingdomPanel();
                updateQuickStats();
            }

            // Next month
            function nextMonth() {
                gameState.kingdom.month++;
                if (gameState.kingdom.month > 12) {
                    gameState.kingdom.month = 1;
                    gameState.kingdom.year++;
                }
                
                // Complete any building projects
                completeProjects();
                
                renderMonthStart();
            }

            // Render build menu
            function renderBuildMenu() {
                clearGameScreen();
                clearControls();
                
                addTextToScreen(`<div class="kingdom-name">CONSTRUCTION</div>`);
                addTextToScreen(`Available projects:`);
                
                const buildingGrid = document.createElement('div');
                buildingGrid.className = 'building-grid';
                
                Object.keys(gameState.buildings).forEach(buildingKey => {
                    const building = gameState.buildings[buildingKey];
                    const buildingCard = document.createElement('div');
                    buildingCard.className = `building-card ${building.built ? 'built' : ''}`;
                    
                    let costText = 'Cost: ';
                    Object.keys(building.cost).forEach(resource => {
                        costText += `${building.cost[resource]} ${resource}, `;
                    });
                    costText = costText.slice(0, -2);
                    
                    buildingCard.innerHTML = `
                        <div style="color:#55ff55;margin-bottom:5px;">${building.name}</div>
                        <div style="color:#aaa;font-size:0.5rem;">${costText}</div>
                        <div style="color:#aaa;font-size:0.5rem;">Time: ${building.time} month(s)</div>
                        <div style="color:#55ffff;font-size:0.5rem;">${building.effect}</div>
                    `;
                    
                    if (!building.built) {
                        buildingCard.addEventListener('click', () => startBuilding(buildingKey));
                        
                        // Check if player can afford it
                        let canAfford = true;
                        Object.keys(building.cost).forEach(resource => {
                            if (resource === 'gold') {
                                if (gameState.player.gold < building.cost[resource]) canAfford = false;
                            } else {
                                if (gameState.kingdom[resource] < building.cost[resource]) canAfford = false;
                            }
                        });
                        
                        if (!canAfford) {
                            buildingCard.classList.add('locked');
                            buildingCard.innerHTML += '<div style="color:#ff5555;font-size:0.5rem;margin-top:5px;">CANNOT AFFORD</div>';
                        }
                    } else {
                        buildingCard.innerHTML += '<div style="color:#55ff55;font-size:0.5rem;margin-top:5px;">BUILT</div>';
                    }
                    
                    buildingGrid.appendChild(buildingCard);
                });
                
                gameScreen.appendChild(buildingGrid);
                
                // Back button
                const backBtn = document.createElement('button');
                backBtn.className = 'action-btn';
                backBtn.textContent = 'â¬…ï¸ BACK';
                backBtn.addEventListener('click', renderMonthStart);
                controls.appendChild(backBtn);
            }

            // Start building
            function startBuilding(buildingKey) {
                const building = gameState.buildings[buildingKey];
                
                // Check resources
                Object.keys(building.cost).forEach(resource => {
                    if (resource === 'gold') {
                        gameState.player.gold -= building.cost[resource];
                    } else {
                        gameState.kingdom[resource] -= building.cost[resource];
                    }
                });
                
                // Apply architect discount refund
                if (gameState.councilPositions.architect.filled) {
                    const discount = 0.2;
                    Object.keys(building.cost).forEach(resource => {
                        const refund = Math.floor(building.cost[resource] * discount);
                        if (resource === 'gold') {
                            gameState.player.gold += refund;
                        } else {
                            gameState.kingdom[resource] += refund;
                        }
                    });
                }
                
                // Add to projects
                gameState.kingdom.activeProjects.push({
                    name: building.name,
                    type: buildingKey,
                    monthsRemaining: building.time
                });
                
                addToGameLog(`Started construction: ${building.name} (${building.time} months)`, 'resource-up');
                
                updateKingdomPanel();
                updateQuickStats();
                renderBuildMenu();
            }

            // Complete projects
            function completeProjects() {
                const completed = [];
                
                gameState.kingdom.activeProjects.forEach((project, index) => {
                    project.monthsRemaining--;
                    if (project.monthsRemaining <= 0) {
                        gameState.buildings[project.type].built = true;
                        gameState.kingdom.buildings.push(project.name);
                        completed.push(project.name);
                        addToGameLog(`Construction completed: ${project.name}!`, 'building-name');
                        
                        // Apply building effects immediately
                        switch(project.type) {
                            case 'farm':
                                gameState.kingdom.maxFood += 20;
                                break;
                            case 'barracks':
                                gameState.kingdom.stability += 10;
                                break;
                            case 'market':
                                gameState.kingdom.reputation += 10;
                                break;
                            case 'watchtower':
                                gameState.kingdom.stability += 15;
                                break;
                            case 'temple':
                                gameState.kingdom.morale += 20;
                                break;
                        }
                    }
                });
                
                // Remove completed projects
                gameState.kingdom.activeProjects = gameState.kingdom.activeProjects.filter(
                    p => p.monthsRemaining > 0
                );
                
                return completed;
            }

            // Render council menu
            function renderCouncilMenu() {
                clearGameScreen();
                clearControls();
                
                addTextToScreen(`<div class="kingdom-name">ROYAL COUNCIL</div>`);
                
                if (gameState.kingdom.council.length === 0) {
                    addTextToScreen('Your council is empty. Recruit advisors to help manage your kingdom.');
                } else {
                    gameState.kingdom.council.forEach(member => {
                        const memberDiv = document.createElement('div');
                        memberDiv.className = 'council-member';
                        memberDiv.innerHTML = `
                            <div style="color:#55aaff">${member.name}</div>
                            <div style="color:#aaa;font-size:0.6rem">${member.position} - ${member.effect}</div>
                        `;
                        gameScreen.appendChild(memberDiv);
                    });
                }
                
                addTextToScreen('<br>Available positions:');
                
                Object.keys(gameState.councilPositions).forEach(positionKey => {
                    const position = gameState.councilPositions[positionKey];
                    if (!position.filled) {
                        const positionDiv = document.createElement('div');
                        positionDiv.style.cssText = 'border:1px solid #444;padding:8px;margin:5px 0;font-size:0.7rem;cursor:pointer';
                        positionDiv.innerHTML = `
                            <div style="color:#ffff55">${position.name}</div>
                            <div style="color:#aaa;font-size:0.6rem">${position.effect}</div>
                            <div style="color:#55ff55;font-size:0.6rem">Click to recruit (200 gold)</div>
                        `;
                        positionDiv.addEventListener('click', () => recruitCouncil(positionKey));
                        gameScreen.appendChild(positionDiv);
                    }
                });
                
                // Back button
                const backBtn = document.createElement('button');
                backBtn.className = 'action-btn';
                backBtn.textContent = 'â¬…ï¸ BACK';
                backBtn.addEventListener('click', renderMonthStart);
                controls.appendChild(backBtn);
            }

            // Recruit council member
            function recruitCouncil(positionKey) {
                if (gameState.player.gold >= 200) {
                    gameState.player.gold -= 200;
                    
                    const position = gameState.councilPositions[positionKey];
                    position.filled = true;
                    
                    const names = ['Aldric', 'Seraphina', 'Thrain', 'Elowen', 'Kaelen', 'Isolde', 'Borin', 'Lyra'];
                    const name = names[Math.floor(Math.random() * names.length)];
                    
                    gameState.kingdom.council.push({
                        name: name,
                        position: position.name,
                        effect: position.effect
                    });
                    
                    addToGameLog(`Recruited ${name} as ${position.name}.`, 'resource-up');
                    
                    updateKingdomPanel();
                    updateQuickStats();
                    renderCouncilMenu();
                } else {
                    addToGameLog('Not enough gold to recruit.', 'resource-down');
                    renderCouncilMenu();
                }
            }

            // Render survey
            function renderSurvey() {
                clearGameScreen();
                clearControls();
                
                const k = gameState.kingdom;
                
                addTextToScreen(`<div class="kingdom-name">KINGDOM SURVEY</div>`);
                addTextToScreen(`<br><span style="color:#55ffff">Stability:</span> ${k.stability}/100`);
                addTextToScreen(`<span style="color:#55ffff">Morale:</span> ${k.morale}/100`);
                addTextToScreen(`<span style="color:#55ffff">Reputation:</span> ${k.reputation}/100`);
                
                addTextToScreen(`<br><span style="color:#55ff55">Resources:</span>`);
                addTextToScreen(`Food: ${k.food}/${k.maxFood}`);
                addTextToScreen(`Wood: ${k.wood}`);
                addTextToScreen(`Stone: ${k.stone}`);
                addTextToScreen(`Iron: ${k.iron}`);
                
                addTextToScreen(`<br><span style="color:#ffaa00">Buildings:</span>`);
                if (k.buildings.length === 0) {
                    addTextToScreen('None built yet');
                } else {
                    k.buildings.forEach(building => {
                        addTextToScreen(`â€¢ ${building}`);
                    });
                }
                
                if (k.activeProjects.length > 0) {
                    addTextToScreen(`<br><span style="color:#55aaff">Under Construction:</span>`);
                    k.activeProjects.forEach(project => {
                        addTextToScreen(`â€¢ ${project.name} (${project.monthsRemaining} months left)`);
                    });
                }
                
                // Back button
                const backBtn = document.createElement('button');
                backBtn.className = 'action-btn';
                backBtn.textContent = 'â¬…ï¸ BACK';
                backBtn.addEventListener('click', renderMonthStart);
                controls.appendChild(backBtn);
            }

            // Render event
            function renderEvent(event) {
                clearGameScreen();
                clearControls();
                
                addTextToScreen(`<div class="kingdom-name">EVENT: ${event.name}</div>`);
                addTextToScreen(event.description);
                
                // Determine number of choices (Sage class gets all choices)
                let numChoices = 2;
                if (gameState.player.class === 'Sage' || gameState.buildings.library.built) {
                    numChoices = 3;
                }
                
                event.choices.slice(0, numChoices).forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'action-btn';
                    button.innerHTML = choice.text;
                    button.addEventListener('click', () => handleEventChoice(choice));
                    controls.appendChild(button);
                });
            }

            // Handle event choice
            function handleEventChoice(choice) {
                if (choice.effect.special) {
                    handleSpecialEvent(choice.effect.special);
                } else {
                    // Apply regular effects
                    Object.keys(choice.effect).forEach(effect => {
                        const value = choice.effect[effect];
                        if (effect === 'gold') {
                            gameState.player.gold += value;
                            if (value > 0) {
                                addToGameLog(`Gained ${value} gold.`, 'gold-gain');
                            } else {
                                addToGameLog(`Lost ${-value} gold.`, 'resource-down');
                            }
                        } else {
                            gameState.kingdom[effect] += value;
                            if (value > 0) {
                                addToGameLog(`${effect.toUpperCase()} increased by ${value}.`, 'resource-up');
                            } else {
                                addToGameLog(`${effect.toUpperCase()} decreased by ${-value}.`, 'resource-down');
                            }
                        }
                    });
                }
                
                updateKingdomPanel();
                updateQuickStats();
                renderMonthStart();
            }

            // Handle special events
            function handleSpecialEvent(specialType) {
                const roll = Math.floor(Math.random() * 20) + 1;
                let bonus = 0;
                let success = false;
                
                switch(specialType) {
                    case 'negotiate':
                        bonus = Math.floor(gameState.player.cha / 4);
                        success = (roll + bonus) >= 15;
                        if (success) {
                            addToGameLog(`Negotiation successful! Bandits agree to leave. (+20 reputation)`, 'resource-up');
                            gameState.kingdom.reputation += 20;
                        } else {
                            addToGameLog(`Negotiation failed. Bandits attack! (-30 stability)`, 'resource-down');
                            gameState.kingdom.stability -= 30;
                        }
                        break;
                        
                    case 'heal':
                        bonus = Math.floor(gameState.player.wis / 4);
                        success = (roll + bonus) >= 12;
                        if (success) {
                            addToGameLog(`Healers contain the plague. (-5 population)`, 'resource-up');
                            gameState.kingdom.population -= 5;
                        } else {
                            addToGameLog(`Plague spreads. (-20 population, -20 morale)`, 'resource-down');
                            gameState.kingdom.population -= 20;
                            gameState.kingdom.morale -= 20;
                        }
                        break;
                        
                    case 'pray':
                        bonus = Math.floor((gameState.player.wis + gameState.player.cha) / 4);
                        success = (roll + bonus) >= 18;
                        if (success) {
                            addToGameLog(`Divine intervention! Plague cured.`, 'resource-up');
                            // No negative effects
                        } else {
                            addToGameLog(`Prayers unanswered. (-15 population)`, 'resource-down');
                            gameState.kingdom.population -= 15;
                        }
                        break;
                }
            }

            // Render crisis
            function renderCrisis() {
                clearGameScreen();
                clearControls();
                
                const crisis = gameState.kingdom.crises[0];
                
                addTextToScreen(`<div class="kingdom-name" style="color:#ff5555">CRISIS: ${crisis.name}</div>`);
                
                const crisisDiv = document.createElement('div');
                crisisDiv.className = 'crisis-event';
                crisisDiv.innerHTML = crisis.description;
                gameScreen.appendChild(crisisDiv);
                
                addTextToScreen('<br>How do you respond?');
                
                crisis.solutions.forEach(solution => {
                    const button = document.createElement('button');
                    button.className = 'action-btn';
                    button.innerHTML = solution.text;
                    
                    // Check if player can afford cost
                    let canAfford = true;
                    if (solution.cost) {
                        Object.keys(solution.cost).forEach(resource => {
                            if (resource === 'gold') {
                                if (gameState.player.gold < solution.cost[resource]) canAfford = false;
                            } else {
                                if (gameState.kingdom[resource] < solution.cost[resource]) canAfford = false;
                            }
                        });
                    }
                    
                    if (!canAfford) {
                        button.disabled = true;
                        button.innerHTML += ' (Cannot afford)';
                    }
                    
                    button.addEventListener('click', () => handleCrisisSolution(solution));
                    controls.appendChild(button);
                });
            }

            // Handle crisis solution
            function handleCrisisSolution(solution) {
                const crisis = gameState.kingdom.crises[0];
                
                // Pay costs
                if (solution.cost) {
                    Object.keys(solution.cost).forEach(resource => {
                        if (resource === 'gold') {
                            gameState.player.gold -= solution.cost[resource];
                        } else {
                            gameState.kingdom[resource] -= solution.cost[resource];
                        }
                    });
                }
                
                // Handle special solutions
                if (solution.special) {
                    handleSpecialCrisis(solution.special, crisis);
                }
                
                // Apply regular effects
                if (solution.effect) {
                    Object.keys(solution.effect).forEach(effect => {
                        gameState.kingdom[effect] += solution.effect[effect];
                    });
                }
                
                // Remove crisis
                gameState.kingdom.crises.shift();
                
                updateKingdomPanel();
                updateQuickStats();
                renderMonthStart();
            }

            // Handle special crisis solutions
            function handleSpecialCrisis(specialType, crisis) {
                const roll = Math.floor(Math.random() * 20) + 1;
                let bonus = 0;
                let success = false;
                
                switch(specialType) {
                    case 'fightDragon':
                        if (gameState.player.class === 'Commander') bonus += 4;
                        bonus += Math.floor(gameState.player.str / 4);
                        success = (roll + bonus) >= 20;
                        if (success) {
                            addToGameLog(`You defeat the dragon! (+50 reputation, +1000 gold from hoard)`, 'victory');
                            gameState.kingdom.reputation += 50;
                            gameState.player.gold += 1000;
                        } else {
                            addToGameLog(`The dragon devastates your kingdom before leaving.`, 'game-over');
                            Object.keys(crisis.effects).forEach(effect => {
                                if (effect !== 'buildings') {
                                    gameState.kingdom[effect] += crisis.effects[effect];
                                }
                            });
                        }
                        break;
                        
                    case 'ration':
                        bonus = Math.floor(gameState.player.wis / 4);
                        success = (roll + bonus) >= 14;
                        if (success) {
                            addToGameLog(`Rationing works. Population accepts hardships.`, 'resource-up');
                            // Less severe effects
                            gameState.kingdom.food += 50;
                            gameState.kingdom.morale -= 10;
                        } else {
                            addToGameLog(`Rationing fails. Riots break out.`, 'resource-down');
                            gameState.kingdom.stability -= 20;
                            gameState.kingdom.morale -= 20;
                        }
                        break;
                }
            }

            // Class-specific actions
            function renderDiplomacy() {
                clearGameScreen();
                clearControls();
                
                addTextToScreen(`<div class="kingdom-name">DIPLOMACY</div>`);
                addTextToScreen(`As a Noble, you can use your diplomatic skills.`);
                
                const actions = [
                    { text: 'Improve Relations (50 gold, CHA check)', action: improveRelations },
                    { text: 'Arrange Marriage Alliance (200 gold, huge boost)', action: marriageAlliance },
                    { text: 'Host Tournament (100 gold, +morale)', action: hostTournament }
                ];
                
                actions.forEach(action => {
                    const button = document.createElement('button');
                    button.className = 'action-btn';
                    button.innerHTML = action.text;
                    button.addEventListener('click', action.action);
                    controls.appendChild(button);
                });
                
                const backBtn = document.createElement('button');
                backBtn.className = 'action-btn';
                backBtn.textContent = 'â¬…ï¸ BACK';
                backBtn.addEventListener('click', renderMonthStart);
                controls.appendChild(backBtn);
            }

            function improveRelations() {
                if (gameState.player.gold >= 50) {
                    gameState.player.gold -= 50;
                    const roll = Math.floor(Math.random() * 20) + 1 + Math.floor(gameState.player.cha / 4);
                    
                    if (roll >= 15) {
                        gameState.kingdom.reputation += 25;
                        addToGameLog('Diplomatic success! Reputation greatly improved.', 'resource-up');
                    } else if (roll >= 10) {
                        gameState.kingdom.reputation += 10;
                        addToGameLog('Relations improved somewhat.', 'resource-up');
                    } else {
                        addToGameLog('Diplomatic effort failed.', 'resource-down');
                    }
                    
                    updateKingdomPanel();
                    updateQuickStats();
                    renderDiplomacy();
                }
            }

            // Other class actions would be implemented similarly...

            // Check victory conditions
            function checkVictory() {
                // Win by building the castle
                if (gameState.buildings.castle.built) {
                    return true;
                }
                
                // Win by reaching year 10 with high stats
                if (gameState.kingdom.year >= 10 && 
                    gameState.kingdom.stability >= 80 && 
                    gameState.kingdom.morale >= 80 && 
                    gameState.kingdom.reputation >= 80) {
                    return true;
                }
                
                return false;
            }

            // Check game over conditions
            function checkGameOver() {
                if (gameState.kingdom.stability <= 0) {
                    addToGameLog('Your kingdom has collapsed!', 'game-over');
                    return true;
                }
                
                if (gameState.kingdom.population <= 0) {
                    addToGameLog('Your people have abandoned you!', 'game-over');
                    return true;
                }
                
                if (gameState.kingdom.morale <= 0) {
                    addToGameLog('Your people have revolted!', 'game-over');
                    return true;
                }
                
                return false;
            }

            // Render victory
            function renderVictory() {
                clearGameScreen();
                clearControls();
                
                addTextToScreen('<div class="victory">VICTORY!</div>');
                addTextToScreen(`You have successfully built a lasting kingdom!`);
                addTextToScreen(`<br>The Kingdom of ${gameState.kingdom.name}`);
                addTextToScreen(`Ruled by ${gameState.player.name} the ${gameState.player.race} ${gameState.player.class}`);
                addTextToScreen(`For ${gameState.kingdom.year} years and ${gameState.kingdom.month} months`);
                addTextToScreen(`<br>Final Population: ${gameState.kingdom.population}`);
                addTextToScreen(`Final Gold: ${gameState.player.gold}`);
                addTextToScreen(`Buildings: ${gameState.kingdom.buildings.length}`);
                addTextToScreen('<br>Your legacy will be remembered!');
                
                const restartBtn = document.createElement('button');
                restartBtn.className = 'action-btn';
                restartBtn.textContent = 'NEW KINGDOM';
                restartBtn.addEventListener('click', initGame);
                controls.appendChild(restartBtn);
            }

            // Render game over
            function renderGameOver() {
                clearGameScreen();
                clearControls();
                
                addTextToScreen('<div class="game-over">KINGDOM FALLEN</div>');
                addTextToScreen(`Your reign has ended...`);
                addTextToScreen(`<br>${gameState.player.name} the ${gameState.player.race} ${gameState.player.class}`);
                addTextToScreen(`Ruled for ${gameState.kingdom.year} years`);
                addTextToScreen(`Final Population: ${gameState.kingdom.population}`);
                addTextToScreen(`Buildings: ${gameState.kingdom.buildings.length}`);
                addTextToScreen('<br>Press below to begin anew');
                
                const restartBtn = document.createElement('button');
                restartBtn.className = 'action-btn';
                restartBtn.textContent = 'TRY AGAIN';
                restartBtn.addEventListener('click', initGame);
                controls.appendChild(restartBtn);
            }

            // Update character panel
            function updateCharacterPanel() {
                const p = gameState.player;
                
                let html = `
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-label">Name</div>
                            <div class="stat-value">${p.name || 'Unknown'}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Race</div>
                            <div class="stat-value">${p.race || 'Unknown'}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Class</div>
                            <div class="stat-value">${p.class || 'Unknown'}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Ruler</div>
                            <div class="stat-value">Level ${p.level}</div>
                        </div>
                    </div>
                    
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-label">STR</div>
                            <div class="stat-value">${p.str}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">DEX</div>
                            <div class="stat-value">${p.dex}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">CON</div>
                            <div class="stat-value">${p.con}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">INT</div>
                            <div class="stat-value">${p.int}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">WIS</div>
                            <div class="stat-value">${p.wis}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">CHA</div>
                            <div class="stat-value">${p.cha}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top:15px;">
                        <div class="stat-label">Class Ability</div>
                        <div style="color:#ffaa00;font-size:0.7rem;">
                            ${p.class ? gameContent.classes[p.class].ability : 'None'}
                        </div>
                    </div>
                    
                    <div style="margin-top:15px;">
                        <div class="stat-label">Gold</div>
                        <div style="color:#ffd700;font-size:0.9rem;">${p.gold}</div>
                    </div>
                `;
                
                characterStats.innerHTML = html;
            }

            // Update kingdom panel
            function updateKingdomPanel() {
                const k = gameState.kingdom;
                
                let html = `
                    <div style="text-align:center;color:#55ff55;margin-bottom:10px;">${k.name}</div>
                    
                    <div class="resource-bar-container">
                        <div class="resource-label">
                            <span>Stability</span>
                            <span>${k.stability}/100</span>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-fill" style="width: ${k.stability}%; background: linear-gradient(to right, #f00, #ff0, #0f0);"></div>
                        </div>
                    </div>
                    
                    <div class="resource-bar-container">
                        <div class="resource-label">
                            <span>Morale</span>
                            <span>${k.morale}/100</span>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-fill" style="width: ${k.morale}%; background: linear-gradient(to right, #f00, #ff0, #0f0);"></div>
                        </div>
                    </div>
                    
                    <div class="resource-bar-container">
                        <div class="resource-label">
                            <span>Reputation</span>
                            <span>${k.reputation}/100</span>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-fill" style="width: ${k.reputation}%; background: linear-gradient(to right, #f00, #ff0, #0f0);"></div>
                        </div>
                    </div>
                    
                    <div class="stat-grid" style="margin-top:15px;">
                        <div class="stat-box">
                            <div class="stat-label">Food</div>
                            <div class="stat-value">${k.food}/${k.maxFood}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Population</div>
                            <div class="stat-value">${k.population}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Wood</div>
                            <div class="stat-value">${k.wood}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Stone</div>
                            <div class="stat-value">${k.stone}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top:15px;">
                        <div class="stat-label">Council</div>
                        <div style="color:#55aaff;font-size:0.6rem;">
                            ${k.council.length} / 5 positions filled
                        </div>
                    </div>
                    
                    <div style="margin-top:15px;">
                        <div class="stat-label">Active Projects</div>
                        <div style="color:#ffaa00;font-size:0.6rem;">
                            ${k.activeProjects.length} in progress
                        </div>
                    </div>
                `;
                
                if (k.crises.length > 0) {
                    html += `
                        <div style="margin-top:15px;">
                            <div class="stat-label" style="color:#ff5555">Active Crises</div>
                            <div style="color:#ff5555;font-size:0.6rem;">
                                ${k.crises.length} crisis(es)
                            </div>
                        </div>
                    `;
                }
                
                kingdomStats.innerHTML = html;
            }

            // Utility functions
            function clearGameScreen() {
                const initialText = document.getElementById('game-text');
                gameScreen.innerHTML = '';
                gameScreen.appendChild(initialText);
            }

            function clearControls() {
                controls.innerHTML = '';
            }

            function addTextToScreen(text, isHTML = false) {
                const textElement = document.createElement('div');
                textElement.className = 'game-text new-message';
                
                if (isHTML) {
                    textElement.innerHTML = text;
                } else {
                    textElement.textContent = text;
                }
                
                gameScreen.appendChild(textElement);
                gameScreen.scrollTop = gameScreen.scrollHeight;
            }

            function addToGameLog(text, effect = '') {
                const textElement = document.createElement('div');
                textElement.className = `game-text new-message ${effect}`;
                textElement.innerHTML = text;
                gameState.gameLog.push(textElement.outerHTML);
                
                // Keep log manageable
                if (gameState.gameLog.length > 5) {
                    gameState.gameLog.shift();
                }
            }

            // Initialize game
            initGame();
        });
    </script>
</body>
</html>
