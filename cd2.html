  <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle of the Dammed 1982 - Castle Tower</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            overflow-x: hidden;
        }
        
        .game-container {
            border: 2px solid #fff;
            padding: 20px;
            margin-top: 20px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px dashed #fff;
            padding-bottom: 10px;
        }
        
        .game-title {
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #fff;
        }
        
        .game-subtitle {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }
        
        .game-output {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
            border: 1px solid #333;
            padding: 15px;
            background-color: #111;
        }
        
        .game-output p {
            margin-bottom: 10px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .game-output .location {
            color: #ffff00;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .game-output .hint {
            color: #888;
            font-style: italic;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .game-output .enemy {
            color: #ff5555;
        }
        
        .game-output .npc {
            color: #55ff55;
        }
        
        .game-output .combat {
            color: #ff4444;
            font-weight: bold;
        }
        
        .game-output .player {
            color: #55ffff;
        }
        
        .game-output .health {
            color: #ff6666;
        }
        
        .game-output .damage {
            color: #ff9966;
        }
        
        .game-output .victory {
            color: #ffff55;
            font-weight: bold;
        }
        
        .game-output .defeat {
            color: #ff5555;
            font-weight: bold;
        }
        
        .game-output .gold {
            color: #ffd700;
        }
        
        .game-output .shop {
            color: #ffaa00;
        }
        
        .game-output .magic {
            color: #ff66ff;
        }
        
        .game-output .item {
            color: #55ff55;
        }
        
        .game-input-container {
            display: flex;
            align-items: center;
            border-top: 1px dashed #fff;
            padding-top: 15px;
        }
        
        .game-prompt {
            margin-right: 10px;
            color: #00ff00;
        }
        
        #game-input {
            background-color: #000;
            color: #fff;
            border: 1px solid #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            padding: 10px;
            flex-grow: 1;
            outline: none;
        }
        
        #game-input:focus {
            box-shadow: 0 0 5px #fff;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Scrollbar styling */
        .game-output::-webkit-scrollbar {
            width: 10px;
        }
        
        .game-output::-webkit-scrollbar-track {
            background: #111;
        }
        
        .game-output::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 5px;
        }
        
        .game-output::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
        
        /* Status bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #222;
            border: 1px solid #444;
            font-size: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
        }
        
        .health-bar {
            width: 100px;
            height: 12px;
            background-color: #333;
            margin-left: 5px;
            border: 1px solid #555;
        }
        
        .health-fill {
            height: 100%;
            background-color: #ff5555;
            transition: width 0.3s;
        }
        
        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                font-size: 14px;
                padding: 10px;
            }
            
            .game-title {
                font-size: 18px;
            }
            
            .game-container {
                padding: 10px;
            }
            
            #game-input {
                font-size: 12px;
                padding: 8px;
            }
            
            .status-bar {
                font-size: 10px;
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1 class="game-title">CASTLE OF THE DAMMED</h1>
        <p class="game-subtitle">Â© 1982 Dark Castle Software</p>
        <p class="game-subtitle">Text Adventure v3.3 - CASTLE TOWER ADDED</p>
    </div>
    
    <div class="status-bar" id="status-bar">
        <div class="status-item">
            HP: <span id="player-hp-text">25/25</span>
            <div class="health-bar">
                <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
            </div>
        </div>
        <div class="status-item">
            Weapon: <span id="player-weapon">Fists</span>
        </div>
        <div class="status-item">
            Gold: <span id="player-gold">10</span>
        </div>
        <div class="status-item">
            Enemy HP: <span id="enemy-hp-text">-</span>
            <div class="health-bar">
                <div class="health-fill" id="enemy-health-fill" style="width: 0%; background-color: #ff9966;"></div>
            </div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="game-output" id="game-output">
            <!-- Game text will appear here -->
        </div>
        
        <div class="game-input-container">
            <span class="game-prompt">&gt;</span>
            <input type="text" id="game-input" placeholder="Type your command..." autocomplete="off">
        </div>
    </div>

    <script>
        // ==================== COMBAT SYSTEM ====================
        
        // Player stats
        const player = {
            maxHP: 50,
            currentHP: 50,
            gold: 10,
            weapon: {
                name: "Fists",
                minDamage: 4,
                maxDamage: 6
            },
            inventory: [],
            spells: [], // Track learned spells
            hasAmuletOfDawn: false // For spellcasting
        };
        
        // Enemy types - ADDED TOWER ENEMIES
        const enemies = {
            goblin: {
                name: "Forest Goblin",
                maxHP: 10,
                currentHP: 10,
                minDamage: 2,
                maxDamage: 4,
                description: "A small, green-skinned goblin with sharp teeth and beady red eyes.",
                defeatMessage: "The goblin squeals and runs off into the forest!",
                loot: "crude dagger"
            },
            wolf: {
                name: "Hungry Wolf",
                maxHP: 12,
                currentHP: 12,
                minDamage: 3,
                maxDamage: 5,
                description: "A lean, gray wolf with bared teeth and hungry eyes.",
                defeatMessage: "The wolf yelps and retreats into the woods!",
                loot: "wolf pelt"
            },
            rat: {
                name: "Giant Black Rat",
                maxHP: 8,
                currentHP: 8,
                minDamage: 2,
                maxDamage: 4,
                description: "A massive, black-furred rat with beady red eyes and sharp yellow teeth.",
                defeatMessage: "The giant rat squeals and scurries back down the well!",
                loot: null
            },
            skeletalHorse: {
                name: "Skeletal Horse",
                maxHP: 18,
                currentHP: 18,
                minDamage: 4,
                maxDamage: 7,
                description: "A terrifying undead horse with glowing red eyes in its empty sockets.",
                defeatMessage: "The skeletal horse collapses into a pile of bones!",
                loot: null
            },
            // NEW TOWER ENEMIES
            stoneGargoyle: {
                name: "Stone Gargoyle",
                maxHP: 25,
                currentHP: 25,
                minDamage: 5,
                maxDamage: 9,
                description: "A grotesque stone creature that has come to life. Its stone wings scrape against the tower walls.",
                defeatMessage: "The stone gargoyle shatters into a thousand pieces!",
                loot: "obsidian shard"
            },
            shadowWraith: {
                name: "Shadow Wraith",
                maxHP: 20,
                currentHP: 20,
                minDamage: 4,
                maxDamage: 8,
                description: "A dark, shadowy entity that floats in the air. Its form seems to shift and waver.",
                defeatMessage: "The shadow wraith dissipates into a dark mist!",
                loot: "void essence"
            },
            zombieGuard: {
                name: "Zombie Castle Guard",
                maxHP: 15,
                currentHP: 15,
                minDamage: 3,
                maxDamage: 6,
                description: "A castle guard in tattered armor, now reanimated as a mindless zombie.",
                defeatMessage: "The zombie guard collapses, finally at rest!",
                loot: "rusted sword"
            }
        };
        
        // Hermit's Shop Inventory
        const hermitShop = {
            items: [
                { name: "health potion", price: 5, description: "Restores 10 HP when used." },
                { name: "torch", price: 3, description: "Provides light in dark places." },
                { name: "rope", price: 4, description: "A sturdy length of rope. Useful for climbing." },
                { name: "bread loaf", price: 2, description: "A fresh loaf of bread. Restores 5 HP." },
                { name: "iron key", price: 8, description: "A sturdy iron key. Might unlock something." }
            ],
            buyItems: ["crude dagger", "wolf pelt", "rusty key", "obsidian shard", "void essence", "rusted sword"],
            buyPrices: {
                "crude dagger": 3,
                "wolf pelt": 4,
                "rusty key": 5,
                "obsidian shard": 15,
                "void essence": 20,
                "rusted sword": 8
            }
        };
        
        // Current combat state
        let combatActive = false;
        let currentEnemy = null;
        
        // ==================== GAME STATE ====================
        const gameState = {
            currentLocation: 'towerEntranceHall',
            inventory: player.inventory,
            visitedLocations: ['towerEntranceHall'],
            gameEnded: false,
            
            // Tower states
            towerMapExplored: {
                entranceHall: true,
                grandHallway: false,
                library: false,
                observatory: false,
                armory: false,
                towerGuardRoom: false,
                spiralStaircase: false
            },
            gargoyleDefeated: false,
            shadowWraithDefeated: false,
            zombieGuardDefeated: false,
            amuletFound: false,
            libraryExamined: false,
            observatoryExamined: false,
            armoryLooted: false,
            guardRoomKeyTaken: false,
            guardRoomDoorUnlocked: false,
            spiralStaircaseAccessed: false
        };
        
        // Load saved game from cd1.html
        function loadSavedGame() {
            const savedGame = localStorage.getItem('castleDamnedSave');
            
            if (savedGame) {
                try {
                    const saveData = JSON.parse(savedGame);
                    
                    // Load player data
                    Object.assign(player, saveData.player);
                    Object.assign(gameState, saveData.gameState);
                    combatActive = saveData.combatActive || false;
                    currentEnemy = saveData.currentEnemy || null;
                    
                    // Ensure spells are loaded properly
                    if (!player.spells || player.spells.length === 0) {
                        // If player has spellbook in inventory, learn spells
                        if (gameState.inventory.includes("leather bound spellbook")) {
                            player.spells = ["blood drain", "moon rising", "night glare", "mist of souls"];
                        }
                    }
                    
                    // Set current location to tower entrance
                    gameState.currentLocation = 'towerEntranceHall';
                    gameState.visitedLocations = ['towerEntranceHall'];
                    
                    // Clear the save so it doesn't reload on refresh
                    localStorage.removeItem('castleDamnedSave');
                    
                    return true;
                    
                } catch (error) {
                    console.error("Error loading save:", error);
                    return false;
                }
            }
            return false;
        }
        
        // Save game for transfer back to cd1.html
        function saveForCD1() {
            const saveData = {
                player: {
                    maxHP: player.maxHP,
                    currentHP: player.currentHP,
                    gold: player.gold,
                    weapon: player.weapon,
                    inventory: player.inventory,
                    spells: player.spells,
                    hasAmuletOfDawn: player.hasAmuletOfDawn
                },
                gameState: gameState,
                combatActive: combatActive,
                currentEnemy: currentEnemy
            };
            
            // Save to localStorage with different key for cd1.html
            localStorage.setItem('castleDamnedSaveToCD1', JSON.stringify(saveData));
        }
        
        // Function to transfer back to cd1.html
        function transferToCD1() {
            // Save game state for cd1.html
            saveForCD1();
            
            // Add transition message
            addToOutput("You return to the courtyard through the massive oak door...", "player");
            addToOutput("Loading Courtyard...", "hint");
            
            // Delay slightly for message to show, then transfer
            setTimeout(() => {
                window.location.href = 'cd1.html';
            }, 2000);
        }
        
        // Update status display
        function updateStatus() {
            document.getElementById('player-hp-text').textContent = 
                `${player.currentHP}/${player.maxHP}`;
            
            const playerHealthPercent = (player.currentHP / player.maxHP) * 100;
            document.getElementById('player-health-fill').style.width = 
                `${Math.max(0, playerHealthPercent)}%`;
            
            document.getElementById('player-weapon').textContent = player.weapon.name;
            document.getElementById('player-gold').textContent = player.gold;
            
            if (currentEnemy && combatActive) {
                document.getElementById('enemy-hp-text').textContent = 
                    `${currentEnemy.currentHP}/${currentEnemy.maxHP}`;
                
                const enemyHealthPercent = (currentEnemy.currentHP / currentEnemy.maxHP) * 100;
                document.getElementById('enemy-health-fill').style.width = 
                    `${Math.max(0, enemyHealthPercent)}%`;
                document.getElementById('enemy-health-fill').style.display = 'block';
            } else {
                document.getElementById('enemy-hp-text').textContent = '-';
                document.getElementById('enemy-health-fill').style.display = 'none';
            }
        }
        
        // Combat functions
        function startCombat(enemyType) {
            currentEnemy = JSON.parse(JSON.stringify(enemies[enemyType])); // Clone enemy
            combatActive = true;
            updateStatus();
            
            addToOutput(`A ${currentEnemy.name} appears!`, "enemy");
            addToOutput("COMBAT STARTED! Use ATTACK to fight!", "combat");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP} | ${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "combat");
        }
        
        function playerAttack() {
            if (!combatActive || !currentEnemy) {
                addToOutput("There's nothing to attack here.");
                return;
            }
            
            const playerDamage = Math.floor(
                Math.random() * (player.weapon.maxDamage - player.weapon.minDamage + 1)
            ) + player.weapon.minDamage;
            
            currentEnemy.currentHP -= playerDamage;
            currentEnemy.currentHP = Math.max(0, currentEnemy.currentHP);
            
            addToOutput(`You attack with your ${player.weapon.name} and deal ${playerDamage} damage!`, "player");
            addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
            
            if (currentEnemy.currentHP <= 0) {
                endCombat(true);
                return;
            }
            
            enemyAttack();
            updateStatus();
        }
        
        function enemyAttack() {
            const enemyDamage = Math.floor(
                Math.random() * (currentEnemy.maxDamage - currentEnemy.minDamage + 1)
            ) + currentEnemy.minDamage;
            
            player.currentHP -= enemyDamage;
            player.currentHP = Math.max(0, player.currentHP);
            
            addToOutput(`${currentEnemy.name} attacks you for ${enemyDamage} damage!`, "enemy");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP}`, "health");
            
            if (player.currentHP <= 0) {
                endCombat(false);
            }
        }
        
        function endCombat(playerWon) {
            if (playerWon) {
                addToOutput(currentEnemy.defeatMessage, "victory");
                
                if (currentEnemy.loot && !gameState.inventory.includes(currentEnemy.loot)) {
                    gameState.inventory.push(currentEnemy.loot);
                    addToOutput(`You found a ${currentEnemy.loot}!`);
                    
                    // Special loot handling
                    if (currentEnemy.loot === "crude dagger") {
                        player.weapon = {
                            name: "Crude Dagger",
                            minDamage: 5,
                            maxDamage: 7
                        };
                        addToOutput("You equip the crude dagger! (Damage: 5-7)", "player");
                        updateStatus();
                    } else if (currentEnemy.loot === "rusted sword") {
                        player.weapon = {
                            name: "Rusted Sword",
                            minDamage: 6,
                            maxDamage: 9
                        };
                        addToOutput("You equip the rusted sword! (Damage: 6-9)", "player");
                        updateStatus();
                    }
                }
                
                // Update enemy defeat states
                if (currentEnemy.name === "Stone Gargoyle") {
                    gameState.gargoyleDefeated = true;
                } else if (currentEnemy.name === "Shadow Wraith") {
                    gameState.shadowWraithDefeated = true;
                } else if (currentEnemy.name === "Zombie Castle Guard") {
                    gameState.zombieGuardDefeated = true;
                    addToOutput("The guard room is now accessible!", "hint");
                }
            } else {
                addToOutput("You have been defeated!", "defeat");
                addToOutput("GAME OVER - Refresh the page to try again.", "defeat");
                gameState.gameEnded = true;
                gameInput.disabled = true;
            }
            
            combatActive = false;
            currentEnemy = null;
            updateStatus();
        }
        
        // Object descriptions - UPDATED WITH TOWER OBJECTS
        const objectDescriptions = {
            // Weapons
            "fists": "Your bare hands. Not very effective but better than nothing. Damage: 4-6",
            "crude dagger": "A small, poorly made dagger. Better than fists. Damage: 5-7",
            "rusted sword": "A rusted but still serviceable sword from a castle guard. Damage: 6-9",
            "rusty key": "A rusty iron key. It might fit the castle gates.",
            
            // Tower items
            "amulet of dawn": "A golden amulet with a sun symbol. It radiates magical energy and allows the wearer to cast spells from the spellbook.",
            "obsidian shard": "A sharp black shard from the stone gargoyle. It might have value.",
            "void essence": "A small, dark orb that seems to contain shifting shadows. It feels cold to the touch.",
            "guard room key": "A small iron key with an emblem of crossed swords. It likely opens the guard room.",
            "ancient scroll": "A scroll written in an ancient language. It might contain secrets.",
            "silver candelabra": "An ornate silver candelabra with three candles. It looks valuable.",
            "tapestry": "A large tapestry depicting the history of the castle. It's faded but still beautiful.",
            
            // Magic items
            "leather bound spellbook": "A thick book bound in dark leather. Strange symbols are etched into the cover. Contains powerful spells.",
            
            // Tower locations/objects
            "tower entrance": "The massive oak door entrance to the castle tower. Intricate carvings depict scenes of battle and magic.",
            "grand hallway": "A long, wide hallway with suits of armor lining the walls. Tapestries hang between them.",
            "stone gargoyle": "A grotesque stone creature perched on a ledge. Its eyes seem to follow you.",
            "shadow wraith": "A dark, shadowy entity that floats in the air. Its form seems to shift and waver.",
            "zombie castle guard": "A castle guard in tattered armor, now reanimated as a mindless zombie.",
            "library bookshelves": "Tall oak bookshelves filled with ancient tomes. Many are covered in dust.",
            "reading table": "A large wooden table in the center of the library with several books open on it.",
            "ancient telescope": "A large brass telescope mounted on a tripod. It's pointed at the night sky.",
            "star charts": "Complex charts mapping the constellations and celestial movements.",
            "weapon racks": "Wooden racks holding various weapons - swords, axes, and spears.",
            "armor stands": "Stands displaying suits of plate armor.",
            "broken shield": "A large shield that has been cracked in half.",
            "guard's desk": "A simple wooden desk with papers scattered on it.",
            "iron bars": "Heavy iron bars blocking the way forward.",
            "spiral staircase": "A stone spiral staircase leading up to the higher levels of the tower.",
            
            // Other items (from cd1)
            "wolf pelt": "The pelt of a wolf. It's still warm and bloody.",
            "health potion": "A small vial containing red liquid. Restores 10 HP when used.",
            "torch": "A wooden torch wrapped in cloth. Can be lit to provide light.",
            "bread loaf": "A fresh loaf of bread. Restores 5 HP when eaten.",
            "iron key": "A sturdy iron key. Might unlock something.",
            "silver chain necklace": "A beautiful silver chain necklace with a wolf's head pendant. The wolf's eyes are red gems that seem to glow faintly.",
            "gold ring": "A gold ring with a green crystal set in it. Small engravings on the inside read: 'If worn, you summon the undead.'",
            "graveyard key": "An old, ornate key made of tarnished silver. It looks like it might fit the graveyard gate.",
            "castle tower key": "A large iron key with intricate designs. It looks like it would fit the main tower door.",
            "leather bound spellbook": "A thick book bound in dark leather. Strange symbols are etched into the cover.",
            "cursed map": "A parchment map that seems to shift and change as you look at it.",
            "iron trapdoor handle": "A heavy iron ring attached to a trapdoor. It looks like it leads underground."
        };

        // Game locations - TOWER INTERIOR
        const locations = {
            // TOWER ENTRANCE HALL
            towerEntranceHall: {
                name: "CASTLE TOWER ENTRANCE HALL",
                description: function() {
                    let desc = "You stand in the entrance hall of the castle tower. ";
                    desc += "Massive stone pillars support the high ceiling. ";
                    desc += "To the EAST, the massive oak door leads back to the courtyard. ";
                    desc += "Ahead to the NORTH, a grand hallway stretches into darkness. ";
                    desc += "To the WEST, a stone spiral staircase leads upward. ";
                    
                    if (!gameState.gargoyleDefeated) {
                        desc += "A STONE GARGOYLE perches on a ledge above the door, watching you with glowing red eyes!";
                    } else {
                        desc += " The shattered remains of the gargoyle litter the floor.";
                    }
                    
                    return desc;
                },
                items: [],
                exits: {
                    east: "cd1_transfer",
                    north: "grandHallway",
                    west: "spiralStaircase",
                    south: null,
                    up: null
                },
                visited: true,
                enemy: !gameState.gargoyleDefeated ? "stoneGargoyle" : null
            },
            
            // GRAND HALLWAY
            grandHallway: {
                name: "GRAND HALLWAY",
                description: function() {
                    let desc = "A long, wide hallway with suits of ARMOR lining the walls. ";
                    desc += "Faded TAPESTRIES hang between them, depicting scenes of ancient battles. ";
                    desc += "To the SOUTH is the entrance hall. ";
                    desc += "Doors lead EAST to a LIBRARY and WEST to an ARMORY. ";
                    desc += "At the north end of the hallway, another door leads to what appears to be a GUARD ROOM.";
                    
                    if (!gameState.shadowWraithDefeated) {
                        desc += " A SHADOW WRAITH floats in the center of the hallway, blocking your path!";
                    }
                    
                    return desc;
                },
                items: ["tapestry"],
                exits: {
                    south: "towerEntranceHall",
                    east: "library",
                    west: "armory",
                    north: gameState.shadowWraithDefeated ? "guardRoom" : null
                },
                visited: false,
                enemy: !gameState.shadowWraithDefeated ? "shadowWraith" : null
            },
            
            // LIBRARY (WITH AMULET OF DAWN)
            library: {
                name: "TOWER LIBRARY",
                description: function() {
                    let desc = "You enter a vast circular library. ";
                    desc += "Tall oak BOOKSHELVES line the curved walls, filled with ancient tomes. ";
                    desc += "A large READING TABLE sits in the center with several books open. ";
                    desc += "To the WEST is the grand hallway. ";
                    
                    if (!gameState.amuletFound && !gameState.libraryExamined) {
                        desc += " On the reading table, a golden AMULET OF DAWN glows softly.";
                    } else if (gameState.amuletFound) {
                        desc += " The reading table is empty except for a few open books.";
                    }
                    
                    return desc;
                },
                items: gameState.amuletFound ? [] : ["amulet of dawn"],
                exits: {
                    west: "grandHallway"
                },
                visited: false,
                enemy: null
            },
            
            // ARMORY
            armory: {
                name: "TOWER ARMORY",
                description: function() {
                    let desc = "This room was once the castle armory. ";
                    desc += "WEAPON RACKS line the walls, though most are empty now. ";
                    desc += "Several ARMOR STANDS display rusted suits of plate armor. ";
                    desc += "To the EAST is the grand hallway. ";
                    
                    if (!gameState.armoryLooted) {
                        desc += " A BROKEN SHIELD lies in one corner, and you notice a RUSTED SWORD on a weapon rack.";
                        this.items = ["rusted sword", "broken shield"];
                    } else {
                        desc += " The room has been thoroughly looted.";
                        this.items = [];
                    }
                    
                    return desc;
                },
                items: [],
                exits: {
                    east: "grandHallway"
                },
                visited: false,
                enemy: null
            },
            
            // GUARD ROOM
            guardRoom: {
                name: "TOWER GUARD ROOM",
                description: function() {
                    let desc = "This appears to have been a guard room. ";
                    desc += "A simple wooden DESK sits against one wall with papers scattered on it. ";
                    desc += "Heavy IRON BARS block a passage to the north. ";
                    desc += "To the SOUTH is the grand hallway. ";
                    
                    if (!gameState.zombieGuardDefeated) {
                        desc += " A ZOMBIE CASTLE GUARD shambles toward you, its rusted sword raised!";
                    } else {
                        desc += " The zombie guard lies motionless on the floor.";
                        
                        if (!gameState.guardRoomKeyTaken) {
                            desc += " On the desk, you notice a small KEY.";
                            if (!this.items.includes('guard room key')) {
                                this.items.push('guard room key');
                            }
                        }
                    }
                    
                    return desc;
                },
                items: [],
                exits: {
                    south: "grandHallway",
                    north: gameState.guardRoomDoorUnlocked ? "observatory" : null
                },
                visited: false,
                enemy: !gameState.zombieGuardDefeated ? "zombieGuard" : null
            },
            
            // OBSERVATORY
            observatory: {
                name: "TOWER OBSERVATORY",
                description: function() {
                    let desc = "You enter a circular room with a domed glass ceiling. ";
                    desc += "An ancient brass TELESCOPE is mounted in the center, pointed at the night sky. ";
                    desc += "STAR CHARTS cover the walls. ";
                    desc += "To the SOUTH is the guard room (through the iron bars). ";
                    desc += "To the WEST, a door leads back to the spiral staircase area.";
                    
                    if (!gameState.observatoryExamined) {
                        desc += " A silver CANDELABRA sits on a small table, and an ANCIENT SCROLL is unrolled next to it.";
                        this.items = ["silver candelabra", "ancient scroll"];
                    }
                    
                    return desc;
                },
                items: [],
                exits: {
                    south: "guardRoom",
                    west: "spiralStaircase"
                },
                visited: false,
                enemy: null
            },
            
            // SPIRAL STAIRCASE
            spiralStaircase: {
                name: "SPIRAL STAIRCASE",
                description: function() {
                    let desc = "A stone SPIRAL STAIRCcase winds upward through the tower. ";
                    desc += "To the EAST is the entrance hall. ";
                    desc += "The stairs lead UP to the higher levels of the tower. ";
                    desc += "A door to the EAST leads to the OBSERVATORY.";
                    
                    if (!gameState.spiralStaircaseAccessed) {
                        desc += " The way up is blocked by a heavy iron gate.";
                    } else {
                        desc += " The iron gate is now open, allowing access upward.";
                        this.exits.up = "upperTower";
                    }
                    
                    return desc;
                },
                items: [],
                exits: {
                    east: "towerEntranceHall",
                    north: "observatory",
                    up: gameState.spiralStaircaseAccessed ? "upperTower" : null
                },
                visited: false,
                enemy: null
            },
            
            // UPPER TOWER (TO BE DEVELOPED LATER)
            upperTower: {
                name: "UPPER TOWER LEVEL",
                description: function() {
                    let desc = "You have reached the upper levels of the castle tower. ";
                    desc += "This area is still under construction. More adventures await! ";
                    desc += "To the DOWN is the spiral staircase.";
                    
                    return desc;
                },
                items: [],
                exits: {
                    down: "spiralStaircase"
                },
                visited: false,
                enemy: null
            }
        };

        // Game commands
        const commands = {
            'north': 'north',
            'n': 'north',
            'south': 'south',
            's': 'south',
            'east': 'east',
            'e': 'east',
            'west': 'west',
            'w': 'west',
            'up': 'up',
            'u': 'up',
            'down': 'down',
            'd': 'down',
            'look': 'look',
            'l': 'look',
            'inventory': 'inventory',
            'i': 'inventory',
            'take': 'take',
            'get': 'take',
            'grab': 'take',
            'drop': 'drop',
            'examine': 'examine',
            'x': 'examine',
            'use': 'use',
            'open': 'open',
            'read': 'read',
            'talk': 'talk',
            'speak': 'talk',
            'ask': 'talk',
            'give': 'give',
            'attack': 'attack',
            'fight': 'attack',
            'kill': 'attack',
            'light': 'light',
            'repair': 'repair',
            'fix': 'repair',
            'eat': 'eat',
            'drink': 'drink',
            'buy': 'buy',
            'purchase': 'buy',
            'sell': 'sell',
            'shop': 'shop',
            'list': 'shop',
            'cast': 'cast',
            'help': 'help',
            'h': 'help',
            'quit': 'quit',
            'q': 'quit'
        };

        // DOM elements
        const gameOutput = document.getElementById('game-output');
        const gameInput = document.getElementById('game-input');

        // Initialize game
        function initGame() {
            // Load saved game from cd1.html
            const loaded = loadSavedGame();
            
            gameOutput.innerHTML = '';
            
            if (loaded) {
                addToOutput("CASTLE OF THE DAMMED - CASTLE TOWER", "title");
                addToOutput("Game state loaded successfully!", "victory");
                addToOutput(`HP: ${player.currentHP}/${player.maxHP} | Gold: ${player.gold} | Weapon: ${player.weapon.name}`, "player");
                
                // Show inventory if not empty
                if (gameState.inventory.length > 0) {
                    addToOutput("Inventory: " + gameState.inventory.map(item => item.toUpperCase()).join(", "));
                }
                
                // Show spells if spellbook has been read or loaded
                if (player.spells.length > 0) {
                    addToOutput("Known spells: " + player.spells.map(spell => spell.toUpperCase()).join(", "), "magic");
                } else if (gameState.inventory.includes("leather bound spellbook")) {
                    addToOutput("You have a spellbook but haven't read it yet. Use READ SPELLBOOK to learn spells.", "magic");
                }
                
                if (player.hasAmuletOfDawn) {
                    addToOutput("You have the AMULET OF DAWN and can now cast spells!", "magic");
                }
                
                addToOutput(" ");
            } else {
                // If no save found (direct access to cd2.html)
                addToOutput("CASTLE OF THE DAMMED", "title");
                addToOutput("CASTLE TOWER ADDED", "subtitle");
                addToOutput(" ");
                addToOutput("Error: No saved game found!", "defeat");
                addToOutput("Please start the game from cd1.html", "hint");
                addToOutput("Redirecting in 5 seconds...", "hint");
                
                setTimeout(() => {
                    window.location.href = 'cd1.html';
                }, 5000);
                
                gameInput.disabled = true;
                return;
            }
            
            updateStatus();
            showLocation();
            
            gameInput.focus();
            
            gameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processCommand(this.value);
                    this.value = '';
                }
            });
        }

        // Add text to game output
        function addToOutput(text, className = '') {
            const p = document.createElement('p');
            p.textContent = text;
            if (className) {
                p.className = className;
            }
            gameOutput.appendChild(p);
            
            gameOutput.scrollTop = gameOutput.scrollHeight;
        }

        // Show current location
        function showLocation() {
            const loc = locations[gameState.currentLocation];
            
            addToOutput(loc.name, "location");
            
            const description = loc.description();
            addToOutput(description);
            
            if (!loc.visited) {
                loc.visited = true;
                gameState.visitedLocations.push(gameState.currentLocation);
                
                // Update tower map exploration
                const locationKey = gameState.currentLocation;
                if (gameState.towerMapExplored.hasOwnProperty(locationKey)) {
                    gameState.towerMapExplored[locationKey] = true;
                }
            }
            
            // Check for enemy in location
            if (loc.enemy && !combatActive && !gameState[`${loc.enemy}Defeated`]) {
                startCombat(loc.enemy);
            }
            
            const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
            if (exits.length > 0) {
                addToOutput("Exits: " + exits.map(exit => exit.toUpperCase()).join(", "));
            }
        }

        // Process player command
        function processCommand(input) {
            if (gameState.gameEnded) {
                addToOutput("The game has ended. Refresh the page to try again.", "hint");
                return;
            }
            
            const command = input.trim().toLowerCase();
            if (!command) return;
            
            const parts = command.split(' ');
            const verb = parts[0];
            const object = parts.slice(1).join(' ');
            
            if (!commands[verb]) {
                addToOutput(`I don't understand "${verb}".`);
                return;
            }
            
            const action = commands[verb];
            
            switch(action) {
                case 'north':
                case 'south':
                case 'east':
                case 'west':
                case 'up':
                case 'down':
                    movePlayer(action);
                    break;
                case 'look':
                    lookAround();
                    break;
                case 'inventory':
                    showInventory();
                    break;
                case 'take':
                    takeItem(object);
                    break;
                case 'drop':
                    dropItem(object);
                    break;
                case 'examine':
                    examineObject(object);
                    break;
                case 'use':
                    useItem(object);
                    break;
                case 'open':
                    openObject(object);
                    break;
                case 'read':
                    readObject(object);
                    break;
                case 'talk':
                    talkTo(object);
                    break;
                case 'give':
                    giveItem(object);
                    break;
                case 'attack':
                    if (combatActive) {
                        playerAttack();
                    } else {
                        attackEnemy(object);
                    }
                    break;
                case 'light':
                    lightLantern();
                    break;
                case 'repair':
                    repairBridge();
                    break;
                case 'eat':
                    eatItem(object);
                    break;
                case 'buy':
                    buyItem(object);
                    break;
                case 'sell':
                    sellItem(object);
                    break;
                case 'shop':
                    showShop();
                    break;
                case 'cast':
                    castSpell(object);
                    break;
                case 'help':
                    showHelp();
                    break;
                case 'quit':
                    quitGame();
                    break;
                default:
                    addToOutput(`Command "${verb}" not implemented yet.`);
            }
        }

        // Move player - HANDLES TRANSFER BACK TO CD1.HTML
        function movePlayer(direction) {
            if (combatActive) {
                addToOutput("You can't run from combat! You must FIGHT!", "combat");
                return;
            }
            
            const currentLoc = locations[gameState.currentLocation];
            let newLocation = currentLoc.exits[direction];
            
            // Handle transfer back to cd1.html
            if (newLocation === "cd1_transfer") {
                transferToCD1();
                return; // Stop further processing
            }
            
            if (!newLocation) {
                addToOutput(`You can't go ${direction}.`);
                return;
            }
            
            // Special handling for guard room north exit (blocked by iron bars)
            if (gameState.currentLocation === "guardRoom" && direction === 'north') {
                if (!gameState.guardRoomDoorUnlocked) {
                    addToOutput("Heavy iron bars block the way north. You need a key to open them.");
                    return;
                }
            }
            
            // Special handling for spiral staircase up exit
            if (gameState.currentLocation === "spiralStaircase" && direction === 'up') {
                if (!gameState.spiralStaircaseAccessed) {
                    addToOutput("A heavy iron gate blocks the way up. You need to find a way to open it.");
                    return;
                }
            }
            
            gameState.currentLocation = newLocation;
            addToOutput(`You go ${direction}.`);
            showLocation();
        }

        // Look around
        function lookAround() {
            const loc = locations[gameState.currentLocation];
            
            addToOutput(loc.name, "location");
            
            const description = loc.description();
            addToOutput(description);
            
            const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
            if (exits.length > 0) {
                addToOutput("Exits: " + exits.map(exit => exit.toUpperCase()).join(", "));
            }
        }

        // Show inventory
        function showInventory() {
            if (gameState.inventory.length === 0) {
                addToOutput("You are carrying nothing.");
            } else {
                addToOutput("You are carrying: " + gameState.inventory.map(item => item.toUpperCase()).join(", "));
            }
            
            // Show spells if spellbook has been read OR is in inventory
            if (player.spells.length > 0) {
                addToOutput("Known spells: " + player.spells.map(spell => spell.toUpperCase()).join(", "), "magic");
            } else if (gameState.inventory.includes("leather bound spellbook")) {
                addToOutput("You have a spellbook but haven't read it yet. Use READ SPELLBOOK to learn spells.", "magic");
            }
            
            addToOutput(`Equipped weapon: ${player.weapon.name} (${player.weapon.minDamage}-${player.weapon.maxDamage} damage)`, "player");
            addToOutput(`HP: ${player.currentHP}/${player.maxHP}`, "health");
            addToOutput(`Gold: ${player.gold}`, "gold");
            
            if (player.hasAmuletOfDawn) {
                addToOutput("You have the AMULET OF DAWN and can cast spells!", "magic");
            }
        }

        // Take item
        function takeItem(itemName) {
            if (!itemName) {
                addToOutput("Take what?");
                return;
            }
            
            const loc = locations[gameState.currentLocation];
            const itemIndex = loc.items.findIndex(item => item.toLowerCase().includes(itemName.toLowerCase()));
            
            if (itemIndex === -1) {
                addToOutput(`I don't see a ${itemName} here.`);
                return;
            }
            
            const item = loc.items[itemIndex];
            
            // Handle specific items
            if (item === "amulet of dawn") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                gameState.amuletFound = true;
                player.hasAmuletOfDawn = true;
                addToOutput(`You take the Amulet of Dawn!`, "victory");
                addToOutput("You feel magical energy coursing through you!", "magic");
                addToOutput("You can now cast spells from your spellbook!", "magic");
                return;
            }
            
            if (item === "rusted sword") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                addToOutput(`You take the rusted sword!`, "item");
                
                // Store the original event handler
                const originalKeypressHandler = gameInput.onkeypress;
                
                // Create a new handler for the Y/N response
                gameInput.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        const answer = this.value.trim().toLowerCase();
                        if (answer === 'y' || answer === 'yes') {
                            player.weapon = {
                                name: "Rusted Sword",
                                minDamage: 6,
                                maxDamage: 9
                            };
                            addToOutput("You equip the rusted sword! (Damage: 6-9)", "player");
                            updateStatus();
                        } else {
                            addToOutput("You keep the rusted sword in your inventory.");
                        }
                        
                        // Restore the original handler
                        gameInput.onkeypress = originalKeypressHandler;
                        gameInput.value = '';
                        gameInput.focus();
                    }
                };
                
                // Ask if player wants to equip it
                addToOutput("Do you want to equip the rusted sword? (Y/N)");
                return;
            }
            
            if (item === "guard room key") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                gameState.guardRoomKeyTaken = true;
                addToOutput(`You take the guard room key!`, "victory");
                addToOutput("This might unlock the iron bars in the guard room.", "hint");
                return;
            }
            
            if (item === "obsidian shard" || item === "void essence") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                addToOutput(`You take the ${item}.`);
                addToOutput("This might be valuable to a collector.", "hint");
                return;
            }
            
            if (item === "silver candelabra" || item === "ancient scroll" || item === "tapestry") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                addToOutput(`You take the ${item}.`);
                addToOutput("This looks valuable.", "hint");
                return;
            }
            
            if (item === "broken shield") {
                loc.items.splice(itemIndex, 1);
                gameState.inventory.push(item);
                addToOutput(`You take the broken shield.`);
                addToOutput("It's too damaged to be useful in combat.", "hint");
                return;
            }
            
            // Default handling for other items
            loc.items.splice(itemIndex, 1);
            gameState.inventory.push(item);
            addToOutput(`You take the ${item}.`);
            
            // Mark armory as looted
            if (gameState.currentLocation === "armory") {
                gameState.armoryLooted = true;
            }
        }

        // Drop item
        function dropItem(itemName) {
            if (!itemName) {
                addToOutput("Drop what?");
                return;
            }
            
            const itemIndex = gameState.inventory.findIndex(item => item.toLowerCase().includes(itemName.toLowerCase()));
            
            if (itemIndex === -1) {
                addToOutput(`You're not carrying a ${itemName}.`);
                return;
            }
            
            const item = gameState.inventory[itemIndex];
            
            // Don't allow dropping equipped weapon
            if ((item === "crude dagger" && player.weapon.name === "Crude Dagger") ||
                (item === "rusted sword" && player.weapon.name === "Rusted Sword")) {
                addToOutput("You can't drop your equipped weapon!");
                return;
            }
            
            gameState.inventory.splice(itemIndex, 1);
            locations[gameState.currentLocation].items.push(item);
            
            if (item === "amulet of dawn") {
                player.hasAmuletOfDawn = false;
                addToOutput("You feel the magical energy fade as you drop the amulet.", "magic");
            }
            
            addToOutput(`You drop the ${item}.`);
        }

        // Examine object
        function examineObject(objectName) {
            if (!objectName) {
                addToOutput("Examine what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            const loc = locations[gameState.currentLocation];
            
            // Check inventory first
            const inventoryItem = gameState.inventory.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (inventoryItem) {
                if (objectDescriptions[inventoryItem]) {
                    addToOutput(objectDescriptions[inventoryItem]);
                } else {
                    addToOutput(`You examine the ${inventoryItem}. It's in your inventory.`);
                }
                return;
            }
            
            // Check location items
            const locationItem = loc.items.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (locationItem) {
                if (objectDescriptions[locationItem]) {
                    addToOutput(objectDescriptions[locationItem]);
                } else {
                    addToOutput(`You examine the ${locationItem}.`);
                }
                return;
            }
            
            // Check for spellbook
            if (objectLower.includes("spellbook") && gameState.inventory.includes("leather bound spellbook")) {
                addToOutput("A thick book bound in dark leather. Strange symbols are etched into the cover.");
                addToOutput("Use READ SPELLBOOK to learn the spells within.", "hint");
                return;
            }
            
            // Check for specific location objects
            if (gameState.currentLocation === "library") {
                if (objectLower.includes("bookshelf") || objectLower.includes("book")) {
                    gameState.libraryExamined = true;
                    addToOutput("The bookshelves are filled with ancient tomes on magic, history, and alchemy.");
                    addToOutput("Many are written in languages you don't recognize.");
                    return;
                }
                
                if (objectLower.includes("table") || objectLower.includes("reading")) {
                    gameState.libraryExamined = true;
                    addToOutput("The reading table has several open books. One shows diagrams of magical amulets.");
                    
                    if (!gameState.amuletFound) {
                        addToOutput("A golden AMULET OF DAWN rests on the table, glowing softly.", "magic");
                    }
                    return;
                }
            }
            
            if (gameState.currentLocation === "observatory") {
                if (objectLower.includes("telescope")) {
                    gameState.observatoryExamined = true;
                    addToOutput("You look through the ancient telescope.");
                    addToOutput("The night sky is filled with strange, unfamiliar constellations.");
                    addToOutput("One constellation looks like a dragon with seven heads.");
                    return;
                }
                
                if (objectLower.includes("star") || objectLower.includes("chart")) {
                    gameState.observatoryExamined = true;
                    addToOutput("The star charts show celestial movements for the past thousand years.");
                    addToOutput("A notation in the corner reads: 'When the seven-headed dragon aligns with the moon, the gate will open.'");
                    return;
                }
            }
            
            if (gameState.currentLocation === "armory") {
                if (objectLower.includes("weapon") || objectLower.includes("rack")) {
                    addToOutput("The weapon racks once held swords, axes, and spears.");
                    addToOutput("Most are empty now, but you see a rusted sword on one rack.");
                    return;
                }
                
                if (objectLower.includes("armor") || objectLower.includes("stand")) {
                    addToOutput("The armor stands display suits of plate armor.");
                    addToOutput("They're heavily rusted and wouldn't provide much protection.");
                    return;
                }
            }
            
            if (gameState.currentLocation === "guardRoom") {
                if (objectLower.includes("desk")) {
                    addToOutput("The guard's desk is covered in old papers.");
                    addToOutput("Most are routine reports, but one mentions 'increased shadow activity in the north hallway.'");
                    
                    if (!gameState.guardRoomKeyTaken && gameState.zombieGuardDefeated) {
                        addToOutput("A small key sits on the desk.", "hint");
                    }
                    return;
                }
                
                if (objectLower.includes("iron") || objectLower.includes("bar")) {
                    addToOutput("Heavy iron bars block the northern passage.");
                    addToOutput("There's a keyhole in the center bar.");
                    
                    if (gameState.inventory.includes("guard room key")) {
                        addToOutput("You have the key that might fit this lock.", "hint");
                    }
                    return;
                }
            }
            
            if (gameState.currentLocation === "spiralStaircase") {
                if (objectLower.includes("stair") || objectLower.includes("spiral")) {
                    addToOutput("The stone spiral staircase winds upward through the tower.");
                    
                    if (!gameState.spiralStaircaseAccessed) {
                        addToOutput("A heavy iron gate blocks the way up. It's locked with a complex mechanism.");
                    } else {
                        addToOutput("The iron gate is now open.");
                    }
                    return;
                }
            }
            
            // Check object descriptions
            if (objectDescriptions[objectLower]) {
                addToOutput(objectDescriptions[objectLower]);
                return;
            }
            
            // Partial matches
            for (const [objKey, description] of Object.entries(objectDescriptions)) {
                if (objKey.includes(objectLower) || objectLower.includes(objKey)) {
                    addToOutput(description);
                    return;
                }
            }
            
            // Direction check
            if (['north', 'south', 'east', 'west', 'up', 'down'].includes(objectLower)) {
                const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
                if (exits.includes(objectLower)) {
                    addToOutput(`You look ${objectLower}. You can go that way.`);
                } else {
                    addToOutput(`You look ${objectLower}. You cannot go that way.`);
                }
                return;
            }
            
            addToOutput(`You don't see a ${objectName} here.`);
        }

        // Use item
        function useItem(objectName) {
            if (!objectName) {
                addToOutput("Use what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Use rusted sword to equip it
            if (objectLower.includes("rusted sword") && gameState.inventory.includes("rusted sword")) {
                if (player.weapon.name === "Rusted Sword") {
                    addToOutput("You're already wielding the rusted sword.");
                } else {
                    player.weapon = {
                        name: "Rusted Sword",
                        minDamage: 6,
                        maxDamage: 9
                    };
                    addToOutput("You equip the rusted sword! (Damage: 6-9)", "player");
                    updateStatus();
                }
                return;
            }
            
            // Use crude dagger to equip it
            if (objectLower.includes("crude dagger") && gameState.inventory.includes("crude dagger")) {
                if (player.weapon.name === "Crude Dagger") {
                    addToOutput("You're already wielding the crude dagger.");
                } else {
                    player.weapon = {
                        name: "Crude Dagger",
                        minDamage: 5,
                        maxDamage: 7
                    };
                    addToOutput("You equip the crude dagger! (Damage: 5-7)", "player");
                    updateStatus();
                }
                return;
            }
            
            // Use guard room key on iron bars
            if (objectLower.includes("guard room key") && gameState.currentLocation === "guardRoom") {
                if (!gameState.inventory.includes("guard room key")) {
                    addToOutput("You don't have the guard room key.");
                    return;
                }
                
                if (gameState.guardRoomDoorUnlocked) {
                    addToOutput("The iron bars are already unlocked.");
                    return;
                }
                
                addToOutput("You use the guard room key on the iron bars.", "player");
                addToOutput("The key fits perfectly! With a loud clank, the bars retract into the ceiling!", "victory");
                gameState.guardRoomDoorUnlocked = true;
                locations.guardRoom.exits.north = "observatory";
                addToOutput("The way north to the observatory is now open!", "hint");
                return;
            }
            
            // Use ancient scroll
            if (objectLower.includes("ancient scroll") && gameState.inventory.includes("ancient scroll")) {
                addToOutput("You unroll the ancient scroll and read it:", "magic");
                addToOutput("'To open the gate of spirals, seek the eye of the dragon in the night sky.'");
                addToOutput("'When seven heads align with the silver moon, the path upward shall be revealed.'");
                addToOutput("This might be a clue about the spiral staircase gate.", "hint");
                return;
            }
            
            // Use health potion
            if (objectLower.includes("health potion") && gameState.inventory.includes("health potion")) {
                const potionIndex = gameState.inventory.indexOf("health potion");
                gameState.inventory.splice(potionIndex, 1);
                
                const healAmount = 10;
                player.currentHP = Math.min(player.maxHP, player.currentHP + healAmount);
                addToOutput(`You drink the health potion. It restores ${healAmount} HP!`, "health");
                updateStatus();
                return;
            }
            
            // Use bread
            if ((objectLower.includes("bread") || objectLower.includes("loaf")) && 
                gameState.inventory.includes("bread loaf")) {
                const breadIndex = gameState.inventory.indexOf("bread loaf");
                gameState.inventory.splice(breadIndex, 1);
                
                const healAmount = 5;
                player.currentHP = Math.min(player.maxHP, player.currentHP + healAmount);
                addToOutput(`You eat the bread. It restores ${healAmount} HP!`, "health");
                updateStatus();
                return;
            }
            
            // Use cursed map
            if (objectLower.includes("cursed map") && gameState.inventory.includes("cursed map")) {
                addToOutput("You examine the cursed map. It now shows:", "item");
                addToOutput(" ");
                
                const exploredRooms = Object.entries(gameState.towerMapExplored)
                    .filter(([room, explored]) => explored)
                    .map(([room]) => room.replace(/([A-Z])/g, ' $1').toUpperCase());
                
                if (exploredRooms.length > 0) {
                    addToOutput("Explored tower rooms:", "item");
                    exploredRooms.forEach(room => {
                        addToOutput(`- ${room}`, "item");
                    });
                } else {
                    addToOutput("No tower rooms explored yet.", "item");
                }
                
                addToOutput(" ");
                addToOutput("The map seems to be magically updating as you explore.", "hint");
                return;
            }
            
            // Use amulet of dawn
            if (objectLower.includes("amulet") && gameState.inventory.includes("amulet of dawn")) {
                if (player.hasAmuletOfDawn) {
                    addToOutput("You're already wearing the amulet. Its magic is flowing through you.", "magic");
                } else {
                    player.hasAmuletOfDawn = true;
                    addToOutput("You put on the Amulet of Dawn.", "player");
                    addToOutput("Magical energy surges through you! You can now cast spells!", "magic");
                }
                return;
            }
            
            addToOutput(`You're not sure how to use the ${objectName} here.`);
        }

        // Open object
        function openObject(objectName) {
            if (!objectName) {
                addToOutput("Open what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Trying to open iron bars in guard room
            if ((objectLower.includes("iron") || objectLower.includes("bar")) && 
                gameState.currentLocation === "guardRoom") {
                if (gameState.guardRoomDoorUnlocked) {
                    addToOutput("The iron bars are already open.");
                } else if (gameState.inventory.includes("guard room key")) {
                    addToOutput("You need to USE the guard room key on the bars.");
                } else {
                    addToOutput("The iron bars are locked. You need a key.");
                }
                return;
            }
            
            // Trying to open spiral staircase gate
            if ((objectLower.includes("gate") || objectLower.includes("spiral")) && 
                gameState.currentLocation === "spiralStaircase") {
                if (gameState.spiralStaircaseAccessed) {
                    addToOutput("The gate is already open.");
                } else {
                    addToOutput("The iron gate is locked by a magical mechanism.");
                    addToOutput("Perhaps there's a clue elsewhere in the tower.", "hint");
                }
                return;
            }
            
            addToOutput(`You can't open the ${objectName}.`);
        }

        // Read object
        function readObject(objectName) {
            if (!objectName) {
                addToOutput("Read what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Read spellbook - if player hasn't learned spells yet
            if ((objectLower.includes("spellbook") || objectLower.includes("spell book")) && 
                gameState.inventory.includes("leather bound spellbook")) {
                
                if (player.spells.length === 0) {
                    player.spells = ["blood drain", "moon rising", "night glare", "mist of souls"];
                    addToOutput("You open the leather bound spellbook and study its contents:", "magic");
                    addToOutput(" ");
                    addToOutput("You have learned the following spells:", "magic");
                    addToOutput("- BLOOD DRAIN: Drains life from your enemy", "magic");
                    addToOutput("- MOON RISING: Summons moonlight to reveal hidden paths", "magic");
                    addToOutput("- NIGHT GLARE: Blinds enemies with a flash of dark light", "magic");
                    addToOutput("- MIST OF SOULS: Summons a protective mist of lost souls", "magic");
                    addToOutput(" ");
                    addToOutput("You can now cast these spells! Use CAST [spell name] to cast them.", "magic");
                    addToOutput("Note: You need the Amulet of Dawn to actually cast spells.", "hint");
                } else {
                    addToOutput("You review the spells you've already learned:", "magic");
                    addToOutput("Known spells: " + player.spells.map(spell => spell.toUpperCase()).join(", "), "magic");
                }
                return;
            }
            
            // Read ancient scroll
            if ((objectLower.includes("scroll") || objectLower.includes("ancient")) && 
                gameState.inventory.includes("ancient scroll")) {
                useItem("ancient scroll"); // Same as use
                return;
            }
            
            // Read books in library
            if ((objectLower.includes("book") && gameState.currentLocation === "library")) {
                addToOutput("You pick up a book and read a random passage:");
                addToOutput("'...and thus the Amulet of Dawn was forged in the heart of the sun,'");
                addToOutput("'to grant mortal beings the power to shape magic with their will...'");
                addToOutput("The rest of the text is too faded to read.");
                return;
            }
            
            // Read papers on guard desk
            if ((objectLower.includes("paper") || objectLower.includes("report")) && 
                gameState.currentLocation === "guardRoom") {
                addToOutput("You read through the papers on the guard's desk:");
                addToOutput("'Report: Shadow activity increasing in north hallway.'");
                addToOutput("'Recommend posting additional guards during night watch.'");
                addToOutput("'Last night, three guards reported seeing moving shadows that disappeared when approached.'");
                return;
            }
            
            addToOutput(`There's nothing to read on the ${objectName}.`);
        }

        // Cast spell
        function castSpell(spellName) {
            if (!spellName) {
                addToOutput("Cast what spell?");
                return;
            }
            
            const spellLower = spellName.toLowerCase();
            
            // Check if player knows the spell
            const knownSpell = player.spells.find(spell => 
                spell.toLowerCase().includes(spellLower) || 
                spellLower.includes(spell.toLowerCase())
            );
            
            if (!knownSpell) {
                addToOutput(`You don't know the spell '${spellName}'.`, "magic");
                
                // Give helpful hints
                if (gameState.inventory.includes("leather bound spellbook")) {
                    addToOutput("You have a spellbook. Try READING it to learn spells.", "hint");
                } else if (player.spells.length === 0) {
                    addToOutput("You haven't learned any spells yet.", "hint");
                } else {
                    addToOutput("Your known spells are: " + player.spells.map(spell => spell.toUpperCase()).join(", "), "magic");
                }
                return;
            }
            
            // Check if player has amulet of dawn
            if (!player.hasAmuletOfDawn) {
                addToOutput(`You can't cast ${knownSpell} without the Amulet of Dawn!`, "magic");
                addToOutput("Find the Amulet of Dawn in the library to enable spellcasting.", "hint");
                return;
            }
            
            // If player has amulet, implement spell effects
            addToOutput(`You cast ${knownSpell.toUpperCase()}!`, "magic");
            
            // Special effect for Moon Rising in observatory
            if (knownSpell.toLowerCase() === "moon rising" && gameState.currentLocation === "observatory") {
                addToOutput("Moonlight floods through the glass ceiling, illuminating the room.", "magic");
                addToOutput("Through the telescope, you see the seven-headed dragon constellation align with the moon!", "magic");
                addToOutput("A clicking sound echoes through the tower as the spiral staircase gate unlocks!", "victory");
                gameState.spiralStaircaseAccessed = true;
                locations.spiralStaircase.exits.up = "upperTower";
                addToOutput("The way up the spiral staircase is now open!", "hint");
                return;
            }
            
            // Basic spell effects
            switch(knownSpell.toLowerCase()) {
                case "blood drain":
                    if (combatActive && currentEnemy) {
                        const drainAmount = Math.floor(Math.random() * 5) + 3;
                        currentEnemy.currentHP -= drainAmount;
                        player.currentHP = Math.min(player.maxHP, player.currentHP + Math.floor(drainAmount / 2));
                        addToOutput(`You drain ${drainAmount} HP from ${currentEnemy.name}!`, "magic");
                        addToOutput(`You heal ${Math.floor(drainAmount / 2)} HP.`, "health");
                        
                        if (currentEnemy.currentHP <= 0) {
                            endCombat(true);
                        } else {
                            addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
                        }
                        updateStatus();
                    } else {
                        addToOutput("The spell has no effect here.", "magic");
                    }
                    break;
                case "moon rising":
                    addToOutput("Moonlight fills the area, revealing hidden details.", "magic");
                    break;
                case "night glare":
                    if (combatActive && currentEnemy) {
                        addToOutput(`A flash of dark light blinds ${currentEnemy.name}!`, "magic");
                        addToOutput("The enemy is stunned and misses its next turn!", "magic");
                    } else {
                        addToOutput("The spell has no effect here.", "magic");
                    }
                    break;
                case "mist of souls":
                    addToOutput("A protective mist of lost souls swirls around you.", "magic");
                    addToOutput("You feel protected from harm.", "magic");
                    break;
                default:
                    addToOutput(`The spell ${knownSpell} has no effect here.`, "magic");
            }
        }

        // Talk to NPC (none in tower yet, but keeping for consistency)
        function talkTo(objectName) {
            if (!objectName) {
                addToOutput("Talk to who?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Talking to gargoyle (before combat)
            if (objectLower.includes("gargoyle") && gameState.currentLocation === "towerEntranceHall") {
                if (!gameState.gargoyleDefeated) {
                    addToOutput("You speak to the stone gargoyle.", "player");
                    addToOutput("The gargoyle's stone eyes glow brighter.", "npc");
                    addToOutput("A raspy, grinding voice echoes in your mind:", "npc");
                    addToOutput("'None shall pass... The tower is forbidden...'", "npc");
                    addToOutput("The gargoyle spreads its stone wings, ready to attack!");
                } else {
                    addToOutput("The gargoyle is now just a pile of stone rubble.");
                }
                return;
            }
            
            // Talking to shadow wraith
            if (objectLower.includes("wraith") && gameState.currentLocation === "grandHallway") {
                if (!gameState.shadowWraithDefeated) {
                    addToOutput("You try to speak to the shadow wraith.", "player");
                    addToOutput("A chilling whisper fills the air:", "npc");
                    addToOutput("'Join us... in the darkness...'", "npc");
                    addToOutput("The wraith drifts toward you menacingly!");
                } else {
                    addToOutput("The shadow wraith has dissipated.");
                }
                return;
            }
            
            if ((objectLower.includes("zombie") || objectLower.includes("guard")) && 
                gameState.currentLocation === "guardRoom") {
                if (!gameState.zombieGuardDefeated) {
                    addToOutput("The zombie guard groans incoherently.", "enemy");
                    addToOutput("It seems beyond reasoning, focused only on attacking the living.");
                } else {
                    addToOutput("The zombie guard lies motionless on the floor.");
                }
                return;
            }
            
            addToOutput("There's no one here to talk to.");
        }

        // Give item
        function giveItem(objectName) {
            addToOutput("There's no one here to give anything to.");
        }

        // Attack enemy
        function attackEnemy(objectName) {
            if (!objectName) {
                addToOutput("Attack what?");
                return;
            }
            
            if (combatActive) {
                playerAttack();
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            const loc = locations[gameState.currentLocation];
            
            if (loc.enemy && !gameState[`${loc.enemy}Defeated`]) {
                startCombat(loc.enemy);
                return;
            }
            
            addToOutput("There's nothing to attack here.");
        }

        // Light lantern (from cd1)
        function lightLantern() {
            if (!gameState.inventory.includes("lantern")) {
                addToOutput("You don't have a lantern to light.");
                return;
            }
            
            if (gameState.hasLantern) {
                addToOutput("Your lantern is already lit.");
            } else {
                addToOutput("You light the lantern. It casts a warm, flickering light.");
                gameState.hasLantern = true;
            }
        }

        // Repair bridge (from cd1)
        function repairBridge() {
            addToOutput("There's nothing to repair here.");
        }

        // Eat item
        function eatItem(objectName) {
            if (!objectName) {
                addToOutput("Eat what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            if (objectLower.includes("berries") && gameState.inventory.includes("berries")) {
                const berryIndex = gameState.inventory.indexOf("berries");
                gameState.inventory.splice(berryIndex, 1);
                
                const healAmount = 5;
                player.currentHP = Math.min(player.maxHP, player.currentHP + healAmount);
                addToOutput(`You eat the berries. They taste sweet and restore ${healAmount} HP!`, "health");
                updateStatus();
                return;
            }
            
            if (objectLower.includes("mushrooms") && gameState.inventory.includes("mushrooms")) {
                const mushroomIndex = gameState.inventory.indexOf("mushrooms");
                gameState.inventory.splice(mushroomIndex, 1);
                
                addToOutput("You eat the glowing mushrooms. They taste terrible!");
                addToOutput("You feel sick and lose 3 HP!", "health");
                player.currentHP = Math.max(0, player.currentHP - 3);
                updateStatus();
                return;
            }
            
            if ((objectLower.includes("bread") || objectLower.includes("loaf")) && 
                gameState.inventory.includes("bread loaf")) {
                useItem("bread loaf");
                return;
            }
            
            addToOutput(`You can't eat ${objectName}.`);
        }

        // BUY item (no shop in tower, but keeping for consistency)
        function buyItem(itemName) {
            addToOutput("There's no shop here.");
        }

        // SELL item
        function sellItem(itemName) {
            addToOutput("There's no one to sell to here.");
        }

        // SHOW shop
        function showShop() {
            addToOutput("There's no shop here.");
        }

        // Show help
        function showHelp() {
            addToOutput("CASTLE OF THE DAMMED - CASTLE TOWER COMMANDS", "location");
            addToOutput("Movement: NORTH, SOUTH, EAST, WEST, UP, DOWN (or N, S, E, W, U, D)");
            addToOutput("Basic: LOOK, EXAMINE [object], TAKE [item], DROP [item], INVENTORY");
            addToOutput("Interactive: USE [item], OPEN [object], READ [object], TALK [NPC], GIVE [item] TO [NPC]");
            addToOutput("Magic: CAST [spell name] (requires spellbook and amulet of dawn)", "magic");
            addToOutput("COMBAT: ATTACK (in combat)", "combat");
            addToOutput("Shop: SHOP, BUY [item], SELL [item]", "shop");
            addToOutput("Other: LIGHT, REPAIR, EAT [food], HELP, QUIT");
            addToOutput(" ");
            addToOutput("TOWER EXPLORATION TIPS:", "hint");
            addToOutput("- Find the Amulet of Dawn in the library to enable spellcasting", "hint");
            addToOutput("- Use spells in specific locations for special effects", "magic");
            addToOutput("- Defeat enemies to access new areas", "hint");
            addToOutput("- Examine everything carefully for clues", "hint");
            addToOutput("- The observatory holds important secrets", "hint");
        }

        // Quit game
        function quitGame() {
            addToOutput("Are you sure you want to quit? (Y/N)");
            
            const originalKeypressHandler = gameInput.onkeypress;
            
            gameInput.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    const answer = this.value.trim().toLowerCase();
                    if (answer === 'y' || answer === 'yes') {
                        addToOutput("Thanks for playing Castle of the Dammed!");
                        gameState.gameEnded = true;
                    } else {
                        addToOutput("Resuming game...");
                    }
                    
                    gameInput.onkeypress = originalKeypressHandler;
                    gameInput.value = '';
                    gameInput.focus();
                }
            };
        }

        window.onload = initGame;
    </script>
</body>
</html>
