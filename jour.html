<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journey - Dark Encounters</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #111;
            color: #0f0;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            padding: 0;
            display: flex;
            flex-direction: column;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(0, 80, 0, 0.2) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(0, 80, 0, 0.2) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        #header {
            padding: 12px 10px;
            background-color: #000;
            border-bottom: 2px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 255, 0, 0.3);
            z-index: 10;
            flex-wrap: wrap;
        }
        
        #header h1 {
            font-size: 14px;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            margin-right: auto;
        }
        
        #header-stats {
            display: flex;
            gap: 15px;
            margin: 0 10px;
        }
        
        .header-stat {
            display: flex;
            align-items: center;
            font-size: 10px;
        }
        
        .header-stat i {
            margin-right: 5px;
        }
        
        #btn-back {
            background: #300;
            color: #f88;
            border: 2px solid #f88;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-left: 10px;
        }

        #btn-back:hover, #btn-back:active {
            background: #f88;
            color: #300;
            box-shadow: 0 0 10px #f88;
        }
        
        #game-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
        }
        
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 2px solid #0f0;
            border-radius: 8px;
            padding: 10px;
            overflow: hidden;
            background-color: rgba(0, 20, 0, 0.8);
            box-shadow: inset 0 0 15px rgba(0, 255, 0, 0.2), 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        /* Location navigation */
        .location-container {
            display: flex;
            border-bottom: 2px solid #0f0;
            margin-bottom: 10px;
            flex-wrap: wrap;
            overflow-x: auto;
        }
        
        .location {
            padding: 8px 15px;
            cursor: pointer;
            border: 2px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 6px 6px 0 0;
            background-color: #000;
            color: #0f0;
            font-size: 10px;
            white-space: nowrap;
        }
        
        .location.active {
            background-color: #0f0;
            color: #000;
            border-color: #0f0;
        }
        
        .location-content {
            display: none;
            padding: 10px;
            overflow-y: auto;
            height: calc(100% - 50px);
        }
        
        .location-content.active {
            display: block;
        }
        
        /* NPC styles */
        .npc {
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .npc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .npc-name {
            color: #f55;
            font-size: 12px;
            text-shadow: 0 0 3px #f55;
        }
        
        .npc-type {
            font-size: 10px;
            color: #fc0;
            background: #300;
            padding: 3px 6px;
            border-radius: 10px;
        }
        
        .npc-description {
            font-size: 10px;
            color: #aaa;
            margin-bottom: 8px;
            font-style: italic;
        }
        
        .npc-dialogue {
            font-size: 10px;
            color: #af0;
            margin-bottom: 8px;
            padding: 8px;
            background-color: rgba(0, 20, 0, 0.5);
            border-left: 2px solid #af0;
        }
        
        .npc-offer {
            font-size: 10px;
            color: #5cf;
            margin-bottom: 10px;
        }
        
        .npc-buttons {
            display: flex;
            gap: 10px;
        }
        
        .npc-button {
            background: #000;
            border: 2px solid #0f0;
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            font-size: 10px;
            flex: 1;
            transition: all 0.2s;
        }
        
        .npc-button.accept {
            color: #0f0;
        }
        
        .npc-button.accept:hover {
            background: #0f0;
            color: #000;
        }
        
        .npc-button.reject {
            color: #f55;
            border-color: #f55;
        }
        
        .npc-button.reject:hover {
            background: #f55;
            color: #000;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 6px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast.error {
            color: #f55;
            border-color: #f55;
        }
        
        .toast.success {
            color: #0f0;
            border-color: #0f0;
        }
        
        /* Empty state message */
        .empty-state {
            text-align: center;
            color: #666;
            font-size: 12px;
            padding: 20px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 480px) {
            #header h1 {
                font-size: 12px;
            }
            
            .header-stat {
                font-size: 9px;
            }
            
            .location {
                padding: 6px 8px;
                font-size: 9px;
            }
            
            .npc-name {
                font-size: 11px;
            }
        }
        
        /* Soul bar styles */
        .soul-bar-container {
            height: 8px;
            background-color: #222;
            border-radius: 4px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .soul-bar {
            height: 100%;
            background: linear-gradient(90deg, #f55, #f5f);
            width: 100%;
            transition: width 0.5s;
        }
        
        /* Cathedral of Light specific styles */
        .priest {
            border: 1px solid #555;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            background: linear-gradient(to bottom, rgba(50, 50, 100, 0.6), rgba(20, 20, 60, 0.8));
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .priest-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 12px;
            width: 100%;
        }
        
        .priest-name {
            color: #5cf;
            font-size: 14px;
            text-shadow: 0 0 5px #5cf;
        }
        
        .priest-description {
            font-size: 10px;
            color: #aaf;
            margin-bottom: 12px;
            font-style: italic;
        }
        
        .priest-dialogue {
            font-size: 11px;
            color: #ddf;
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(30, 30, 80, 0.5);
            border: 1px solid #55f;
            border-radius: 4px;
            width: 100%;
        }
        
        .exorcism-cost {
            font-size: 12px;
            color: #ff5;
            margin-bottom: 15px;
            text-shadow: 0 0 3px #ff5;
        }
        
        .exorcism-button {
            background: linear-gradient(to bottom, #338, #114);
            color: #aaf;
            border: 2px solid #55f;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            margin-bottom: 15px;
            text-transform: uppercase;
        }
        
        .exorcism-button:hover {
            background: linear-gradient(to bottom, #55a, #338);
            color: #fff;
            box-shadow: 0 0 10px #55f;
        }
        
        .exorcism-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .ritual-timer {
            width: 100%;
            margin: 15px 0;
            display: none;
        }
        
        .timer-text {
            font-size: 11px;
            color: #aaf;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .timer-bar-container {
            height: 12px;
            background-color: #223;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #55f;
        }
        
        .timer-bar {
            height: 100%;
            background: linear-gradient(to right, #55f, #aaf);
            width: 0%;
            transition: width 1s linear;
        }
        
        .completion-message {
            font-size: 12px;
            color: #5f5;
            margin-top: 15px;
            text-align: center;
            display: none;
            text-shadow: 0 0 5px #5f5;
        }
        
        /* Location background effects */
        #deadwood-forest {
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(60, 20, 0, 0.2) 1px, transparent 1px),
                radial-gradient(circle at 90% 80%, rgba(60, 20, 0, 0.2) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        
        #caves-of-moor {
            background-image: 
                linear-gradient(45deg, rgba(0, 0, 30, 0.1) 25%, transparent 25%),
                linear-gradient(-45deg, rgba(0, 0, 30, 0.1) 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, rgba(0, 0, 30, 0.1) 75%),
                linear-gradient(-45deg, transparent 75%, rgba(0, 0, 30, 0.1) 75%);
            background-size: 20px 20px;
        }
        
        #mortlock-mountain {
            background-image: 
                linear-gradient(0deg, transparent 24%, rgba(50, 50, 50, 0.1) 25%, rgba(50, 50, 50, 0.1) 26%, transparent 27%, transparent 74%, rgba(50, 50, 50, 0.1) 75%, rgba(50, 50, 50, 0.1) 76%, transparent 77%, transparent),
                linear-gradient(90deg, transparent 24%, rgba(50, 50, 50, 0.1) 25%, rgba(50, 50, 50, 0.1) 26%, transparent 27%, transparent 74%, rgba(50, 50, 50, 0.1) 75%, rgba(50, 50, 50, 0.1) 76%, transparent 77%, transparent);
            background-size: 30px 30px;
        }
        
        #lake-of-souls {
            background-image: 
                radial-gradient(circle, rgba(0, 100, 100, 0.2) 1px, transparent 2px);
            background-size: 30px 30px;
            background-color: rgba(0, 30, 30, 0.1);
        }
        
        #village-of-dread {
            background-image: 
                linear-gradient(rgba(50, 0, 0, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(50, 0, 0, 0.2) 1px, transparent 1px);
            background-size: 25px 25px;
            background-color: rgba(30, 0, 0, 0.1);
        }
        
        #cathedral-of-light {
            background-image: 
                radial-gradient(circle at center, rgba(100, 100, 255, 0.1) 0%, transparent 70%),
                linear-gradient(0deg, transparent 49%, rgba(100, 100, 255, 0.1) 50%, transparent 51%),
                linear-gradient(90deg, transparent 49%, rgba(100, 100, 255, 0.1) 50%, transparent 51%);
            background-size: 40px 40px;
            background-color: rgba(10, 10, 40, 0.2);
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Journey - Dark Encounters</h1>
        <div id="header-stats">
            <div class="header-stat">Soul: <span id="header-soul">100</span>/100</div>
            <div class="header-stat">Gold: <span id="header-gold">0</span></div>
            <div class="header-stat">Materials: <span id="header-materials">0</span></div>
        </div>
        <button id="btn-back">Back to Main</button>
    </div>
    
    <div id="game-wrapper">
        <div id="game-container">
            <div class="location-container">
                <div class="location active" data-location="deadwood-forest">Deadwood Forest</div>
                <div class="location" data-location="caves-of-moor">Caves of Moor</div>
                <div class="location" data-location="mortlock-mountain">Mortlock Mountain</div>
                <div class="location" data-location="lake-of-souls">Lake of Souls</div>
                <div class="location" data-location="village-of-dread">Village of Dread</div>
                <div class="location" data-location="cathedral-of-light">Cathedral of Light</div>
            </div>
            
            <!-- Deadwood Forest Content -->
            <div class="location-content active" id="deadwood-forest">
                <!-- NPCs will be dynamically added here -->
            </div>
            
            <!-- Caves of Moor Content -->
            <div class="location-content" id="caves-of-moor">
                <!-- NPCs will be dynamically added here -->
            </div>
            
            <!-- Mortlock Mountain Content -->
            <div class="location-content" id="mortlock-mountain">
                <!-- NPCs will be dynamically added here -->
            </div>
            
            <!-- Lake of Souls Content -->
            <div class="location-content" id="lake-of-souls">
                <!-- NPCs will be dynamically added here -->
            </div>
            
            <!-- Village of Dread Content -->
            <div class="location-content" id="village-of-dread">
                <!-- NPCs will be dynamically added here -->
            </div>
            
            <!-- Cathedral of Light Content -->
            <div class="location-content" id="cathedral-of-light">
                <!-- Priest NPC will be added here -->
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // Main game state key
        const MAIN_GAME_SAVE_KEY = 'sanctuaryRPG_save';
        
        // Journey system state
        const journeyState = {
            soul: 100,
            maxSoul: 100,
            gold: 0,
            materials: 0,
            exorcismInProgress: false,
            exorcismEndTime: null,
            locations: {
                "deadwood-forest": {
                    name: "Deadwood Forest",
                    visited: true,
                    npcs: [
                        {
                            id: "soul-trader",
                            name: "The Wailing Merchant",
                            type: "Soul Trader",
                            description: "A gaunt figure draped in tattered robes, its face hidden in shadows except for two faint pinpricks of light where eyes should be.",
                            dialogue: "I sense your vitality... so fresh, so vibrant. I could offer you materials beyond your wildest dreams. A mere 20 soul fragments for 50 materials. What say you?",
                            offer: "20 Soul for 50 Materials",
                            cost: { type: "soul", amount: 20 },
                            reward: { type: "materials", amount: 50 }
                        },
                        {
                            id: "gold-gambler",
                            name: "The Coin-Fed Man",
                            type: "Gambler",
                            description: "A corpulent being with coins for eyes and a mouth that opens too wide, filled with gleaming gold teeth.",
                            dialogue: "Fortune favors the bold, little mortal. I'll wager 75 gold against 15 of your life essence. Will you take the bet?",
                            offer: "15 Soul for 75 Gold",
                            cost: { type: "soul", amount: 15 },
                            reward: { type: "gold", amount: 75 }
                        }
                    ]
                },
                "caves-of-moor": {
                    name: "Caves of Moor",
                    visited: false,
                    npcs: [
                        {
                            id: "material-hoarder",
                            name: "The Petrified Collector",
                            type: "Hoarder",
                            description: "A creature made of shifting stone and shadow, with long bony fingers that click as they move.",
                            dialogue: "Gold... shiny, precious gold. I hunger for it. Bring me 30 gold pieces and I shall grant you 25 materials from my collection.",
                            offer: "30 Gold for 25 Materials",
                            cost: { type: "gold", amount: 30 },
                            reward: { type: "materials", amount: 25 }
                        },
                        {
                            id: "soul-siphon",
                            name: "The Bloodless One",
                            type: "Soul Drinker",
                            description: "A pale, emaciated figure that seems to absorb the light around it. Its touch makes your skin crawl.",
                            dialogue: "Your vitality calls to me... I can give you 40 gold pieces. Just 10 droplets of your life essence. A fair trade, is it not?",
                            offer: "10 Soul for 40 Gold",
                            cost: { type: "soul", amount: 10 },
                            reward: { type: "gold", amount: 40 }
                        }
                    ]
                },
                "mortlock-mountain": {
                    name: "Mortlock Mountain",
                    visited: false,
                    npcs: [
                        {
                            id: "mountain-hermit",
                            name: "The Stone-Skinned Hermit",
                            type: "Recluse",
                            description: "An ancient being with skin like granite, moss growing in the crevices of its motionless form.",
                            dialogue: "I have guarded these materials for centuries. I will trade them for something... shinier. 45 gold for 35 materials.",
                            offer: "45 Gold for 35 Materials",
                            cost: { type: "gold", amount: 45 },
                            reward: { type: "materials", amount: 35 }
                        },
                        {
                            id: "peak-demon",
                            name: "The Howling Wind",
                            type: "Air Spirit",
                            description: "A swirling vortex of mist and anguish that takes a vaguely humanoid form when it addresses you.",
                            dialogue: "Your mortal form is so fragile... so temporary. I can make you richer. 25 soul fragments for 80 gold. The pain is fleeting, the wealth eternal.",
                            offer: "25 Soul for 80 Gold",
                            cost: { type: "soul", amount: 25 },
                            reward: { type: "gold", amount: 80 }
                        }
                    ]
                },
                "lake-of-souls": {
                    name: "Lake of Souls",
                    visited: false,
                    npcs: [
                        {
                            id: "drowned-spirit",
                            name: "The Weeping Drowned",
                            type: "Aquatic Spirit",
                            description: "A translucent figure that seems to be made of water and sorrow, with hollow eyes that weep ectoplasmic tears.",
                            dialogue: "The depths hunger for shiny things... 50 gold pieces for 20 materials. The lake will be pleased with your offering.",
                            offer: "50 Gold for 20 Materials",
                            cost: { type: "gold", amount: 50 },
                            reward: { type: "materials", amount: 20 }
                        },
                        {
                            id: "soul-fisher",
                            name: "The Fisher of Souls",
                            type: "Abyssal Entity",
                            description: "A hunched figure in a dripping cloak, holding a rod made of bone with a hook that seems to pierce reality itself.",
                            dialogue: "I catch fragments of souls in these waters... trade me 15 of yours, and I'll give you 30 materials I've gathered from the depths.",
                            offer: "15 Soul for 30 Materials",
                            cost: { type: "soul", amount: 15 },
                            reward: { type: "materials", amount: 30 }
                        },
                        {
                            id: "lake-guardian",
                            name: "The Silent Guardian",
                            type: "Lake Warden",
                            description: "A towering figure made of water and forgotten memories, its form constantly shifting and reforming.",
                            dialogue: "I protect what lies beneath. For 18 soul fragments, I will grant you passage to treasures below... 55 gold pieces await.",
                            offer: "18 Soul for 55 Gold",
                            cost: { type: "soul", amount: 18 },
                            reward: { type: "gold", amount: 55 }
                        }
                    ]
                },
                "village-of-dread": {
                    name: "Village of Dread",
                    visited: false,
                    npcs: [
                        {
                            id: "cursed-merchant",
                            name: "The Twisted Merchant",
                            type: "Cursed Trader",
                            description: "A figure whose limbs bend in unnatural directions, with a smile that stretches too wide across its face.",
                            dialogue: "Everything has a price here... 35 gold for 20 special materials. The village whispers that it's a fair deal.",
                            offer: "35 Gold for 20 Materials",
                            cost: { type: "gold", amount: 35 },
                            reward: { type: "materials", amount: 20 }
                        },
                        {
                            id: "soul-eater",
                            name: "The Ever-Hungry",
                            type: "Village Elder",
                            description: "An ancient, withered being that seems to be more shadow than substance, with a gaping mouth that never closes.",
                            dialogue: "Your soul energy is... delicious. I must have more. 22 fragments for 65 gold. Your essence will sustain me.",
                            offer: "22 Soul for 65 Gold",
                            cost: { type: "soul", amount: 22 },
                            reward: { type: "gold", amount: 65 }
                        },
                        {
                            id: "dread-blacksmith",
                            name: "The Forgemaster of Fear",
                            type: "Village Blacksmith",
                            description: "A massive figure with arms of molten metal, hammering on an anvil that seems to be made of solidified anguish.",
                            dialogue: "I craft weapons from soul-stuff. Bring me 40 gold, and I'll give you 25 refined materials. My creations require payment.",
                            offer: "40 Gold for 25 Materials",
                            cost: { type: "gold", amount: 40 },
                            reward: { type: "materials", amount: 25 }
                        }
                    ]
                },
                "cathedral-of-light": {
                    name: "Cathedral of Light",
                    visited: true,
                    npcs: [
                        {
                            id: "priest-of-light",
                            name: "Father Lumière",
                            type: "High Priest",
                            description: "A serene figure clad in white and gold robes, with eyes that seem to see into your very soul. A soft glow emanates from him.",
                            dialogue: "Welcome, weary traveler. I see the darkness that clings to your soul. For 50 gold, I can perform an exorcism to restore your essence to its full glory. The ritual takes one minute to complete.",
                            offer: "50 Gold for Full Soul Restoration",
                            cost: { type: "gold", amount: 50 },
                            reward: { type: "soul", amount: 100 }
                        }
                    ]
                }
            }
        };

        // DOM Elements
        const headerSoul = document.getElementById('header-soul');
        const headerGold = document.getElementById('header-gold');
        const headerMaterials = document.getElementById('header-materials');
        const btnBack = document.getElementById('btn-back');
        const locations = document.querySelectorAll('.location');
        const locationContents = document.querySelectorAll('.location-content');
        const toastEl = document.getElementById('toast');

        // Initialize the page
        window.addEventListener('load', () => {
            // Load game state from localStorage
            loadGameState();
            
            // Update UI with loaded data
            updateUI();
            
            // Set up location navigation
            setupLocations();
            
            // Render all locations
            renderLocation('deadwood-forest');
            
            // Set up back button
            btnBack.addEventListener('click', goBackToCastle);
            
            // Set up exorcism timer if one is in progress
            checkExorcismTimer();
            
            // Save game state when page is about to be unloaded
            window.addEventListener('beforeunload', saveGameState);
            
            // Start checking exorcism timer
            setInterval(checkExorcismTimer, 1000);
        });

        function loadGameState() {
            try {
                const saveData = localStorage.getItem(MAIN_GAME_SAVE_KEY);
                if (saveData) {
                    const loadedState = JSON.parse(saveData);
                    
                    // Load player stats
                    if (loadedState.player) {
                        journeyState.soul = loadedState.player.soul !== undefined ? loadedState.player.soul : 100;
                        journeyState.maxSoul = loadedState.player.maxSoul !== undefined ? loadedState.player.maxSoul : 100;
                        journeyState.gold = loadedState.player.gold !== undefined ? loadedState.player.gold : 0;
                        journeyState.materials = loadedState.player.materials !== undefined ? loadedState.player.materials : 0;
                    }
                    
                    // Load exorcism state if available
                    if (loadedState.journey) {
                        journeyState.exorcismInProgress = loadedState.journey.exorcismInProgress || false;
                        journeyState.exorcismEndTime = loadedState.journey.exorcismEndTime || null;
                    }
                    
                    // Load location visited status if available
                    if (loadedState.journey && loadedState.journey.locations) {
                        for (const locationId in loadedState.journey.locations) {
                            if (journeyState.locations[locationId]) {
                                journeyState.locations[locationId].visited = loadedState.journey.locations[locationId].visited;
                            }
                        }
                    }
                }
            } catch (e) {
                console.error("Failed to load game state:", e);
            }
        }

        function saveGameState() {
            try {
                // First load existing save data to preserve other game state
                let mainState = {};
                const existingSave = localStorage.getItem(MAIN_GAME_SAVE_KEY);
                if (existingSave) {
                    mainState = JSON.parse(existingSave);
                }
                
                // Update player stats
                if (!mainState.player) mainState.player = {};
                mainState.player.soul = journeyState.soul;
                mainState.player.maxSoul = journeyState.maxSoul;
                mainState.player.gold = journeyState.gold;
                mainState.player.materials = journeyState.materials;
                
                // Save exorcism state
                if (!mainState.journey) mainState.journey = {};
                mainState.journey.exorcismInProgress = journeyState.exorcismInProgress;
                mainState.journey.exorcismEndTime = journeyState.exorcismEndTime;
                
                // Save location visited status
                if (!mainState.journey.locations) mainState.journey.locations = {};
                
                for (const locationId in journeyState.locations) {
                    if (!mainState.journey.locations[locationId]) {
                        mainState.journey.locations[locationId] = {};
                    }
                    mainState.journey.locations[locationId].visited = journeyState.locations[locationId].visited;
                }
                
                // Save back to localStorage
                localStorage.setItem(MAIN_GAME_SAVE_KEY, JSON.stringify(mainState));
            } catch (e) {
                console.error("Failed to save game state:", e);
            }
        }

        function setupLocations() {
            locations.forEach(location => {
                location.addEventListener('click', () => {
                    locations.forEach(l => l.classList.remove('active'));
                    locationContents.forEach(c => c.classList.remove('active'));
                    
                    location.classList.add('active');
                    const locationId = location.dataset.location;
                    document.getElementById(locationId).classList.add('active');
                    
                    // Mark location as visited and render its NPCs
                    journeyState.locations[locationId].visited = true;
                    renderLocation(locationId);
                });
            });
        }

        function renderLocation(locationId) {
            const location = journeyState.locations[locationId];
            const container = document.getElementById(locationId);
            container.innerHTML = '';
            
            if (!location.visited) {
                container.innerHTML = '<div class="empty-state">You have not discovered this location yet. Explore more to unlock it!</div>';
                return;
            }
            
            // Special rendering for Cathedral of Light
            if (locationId === 'cathedral-of-light') {
                renderCathedral();
                return;
            }
            
            // Standard rendering for other locations
            location.npcs.forEach(npc => {
                const npcElement = document.createElement('div');
                npcElement.className = 'npc';
                npcElement.innerHTML = `
                    <div class="npc-header">
                        <div class="npc-name">${npc.name}</div>
                        <div class="npc-type">${npc.type}</div>
                    </div>
                    <div class="npc-description">${npc.description}</div>
                    <div class="npc-dialogue">"${npc.dialogue}"</div>
                    <div class="npc-offer">Offer: ${npc.offer}</div>
                    <div class="soul-bar-container">
                        <div class="soul-bar" style="width: ${(journeyState.soul / journeyState.maxSoul) * 100}%"></div>
                    </div>
                    <div class="npc-buttons">
                        <button class="npc-button accept" data-npc="${npc.id}" data-location="${locationId}">Accept</button>
                        <button class="npc-button reject" data-npc="${npc.id}" data-location="${locationId}">Reject</button>
                    </div>
                `;
                container.appendChild(npcElement);
                
                // Add event listeners to buttons
                const acceptButton = npcElement.querySelector('.npc-button.accept');
                const rejectButton = npcElement.querySelector('.npc-button.reject');
                
                acceptButton.addEventListener('click', () => handleOffer(npc, locationId, true));
                rejectButton.addEventListener('click', () => handleOffer(npc, locationId, false));
            });
        }

        function renderCathedral() {
            const location = journeyState.locations['cathedral-of-light'];
            const container = document.getElementById('cathedral-of-light');
            const npc = location.npcs[0]; // Priest is the only NPC here
            
            const priestElement = document.createElement('div');
            priestElement.className = 'priest';
            priestElement.innerHTML = `
                <div class="priest-header">
                    <div class="priest-name">${npc.name}</div>
                </div>
                <div class="priest-description">${npc.description}</div>
                <div class="priest-dialogue">"${npc.dialogue}"</div>
                <div class="exorcism-cost">Cost: ${npc.cost.amount} Gold</div>
                <div class="soul-bar-container">
                    <div class="soul-bar" style="width: ${(journeyState.soul / journeyState.maxSoul) * 100}%"></div>
                </div>
                <button class="exorcism-button" id="exorcism-button" ${journeyState.exorcismInProgress || journeyState.gold < npc.cost.amount ? 'disabled' : ''}>
                    ${journeyState.exorcismInProgress ? 'Ritual in Progress' : 'Perform Exorcism'}
                </button>
                <div class="ritual-timer" id="ritual-timer" style="${journeyState.exorcismInProgress ? 'display: block;' : 'display: none;'}">
                    <div class="timer-text" id="timer-text">Ritual completes in: 60 seconds</div>
                    <div class="timer-bar-container">
                        <div class="timer-bar" id="timer-bar"></div>
                    </div>
                </div>
                <div class="completion-message" id="completion-message" style="display: none;">
                    The exorcism is complete! Your soul has been restored to full strength.
                </div>
            `;
            container.appendChild(priestElement);
            
            // Add event listener to exorcism button
            const exorcismButton = document.getElementById('exorcism-button');
            if (exorcismButton && !journeyState.exorcismInProgress) {
                exorcismButton.addEventListener('click', () => startExorcism(npc));
            }
            
            // Update timer if exorcism is in progress
            if (journeyState.exorcismInProgress) {
                updateExorcismTimer();
            }
        }

        function startExorcism(npc) {
            // Check if player can afford the cost
            if (journeyState.gold < npc.cost.amount) {
                showToast("You don't have enough gold for the exorcism!", "error");
                return;
            }
            
            // Check if already at full soul
            if (journeyState.soul >= journeyState.maxSoul) {
                showToast("Your soul is already at full strength!", "error");
                return;
            }
            
            // Deduct cost
            journeyState.gold -= npc.cost.amount;
            
            // Start exorcism timer (60 seconds)
            journeyState.exorcismInProgress = true;
            journeyState.exorcismEndTime = Date.now() + 60000; // 60 seconds
            
            // Update UI
            updateUI();
            renderLocation('cathedral-of-light');
            
            // Save game state
            saveGameState();
            
            // Show message
            showToast("The exorcism ritual has begun! It will complete in 60 seconds.", "success");
        }

        function completeExorcism() {
            // Restore soul to full
            journeyState.soul = journeyState.maxSoul;
            journeyState.exorcismInProgress = false;
            journeyState.exorcismEndTime = null;
            
            // Update UI
            updateUI();
            
            // Show completion message in cathedral
            const completionMessage = document.getElementById('completion-message');
            if (completionMessage) {
                completionMessage.style.display = 'block';
            }
            
            // Re-render cathedral to update button state
            renderLocation('cathedral-of-light');
            
            // Save game state
            saveGameState();
            
            // Show toast notification
            showToast("The exorcism is complete! Your soul has been fully restored.", "success");
        }

        function checkExorcismTimer() {
            if (journeyState.exorcismInProgress && journeyState.exorcismEndTime) {
                const timeRemaining = journeyState.exorcismEndTime - Date.now();
                
                if (timeRemaining <= 0) {
                    completeExorcism();
                } else {
                    updateExorcismTimer();
                }
            }
        }

        function updateExorcismTimer() {
            if (journeyState.exorcismInProgress && journeyState.exorcismEndTime) {
                const timeRemaining = journeyState.exorcismEndTime - Date.now();
                const secondsRemaining = Math.ceil(timeRemaining / 1000);
                const progressPercent = 100 - (timeRemaining / 60000 * 100);
                
                // Update timer text
                const timerText = document.getElementById('timer-text');
                if (timerText) {
                    timerText.textContent = `Ritual completes in: ${secondsRemaining} seconds`;
                }
                
                // Update progress bar
                const timerBar = document.getElementById('timer-bar');
                if (timerBar) {
                    timerBar.style.width = `${progressPercent}%`;
                }
            }
        }

        function handleOffer(npc, locationId, accepted) {
            if (!accepted) {
                showToast(`You rejected ${npc.name}'s offer.`, "error");
                return;
            }
            
            // Check if player can afford the cost
            if (npc.cost.type === "soul" && journeyState.soul <= npc.cost.amount) {
                showToast("You don't have enough Soul for this trade!", "error");
                return;
            }
            
            if (npc.cost.type === "gold" && journeyState.gold < npc.cost.amount) {
                showToast("You don't have enough gold for this trade!", "error");
                return;
            }
            
            // Apply cost
            if (npc.cost.type === "soul") {
                journeyState.soul -= npc.cost.amount;
                if (journeyState.soul <= 0) {
                    journeyState.soul = 1; // Never drop below 1 Soul
                    showToast("Your soul is nearly extinguished! Be more careful with your essence.", "error");
                }
            } else if (npc.cost.type === "gold") {
                journeyState.gold -= npc.cost.amount;
            }
            
            // Apply reward
            if (npc.reward.type === "gold") {
                journeyState.gold += npc.reward.amount;
            } else if (npc.reward.type === "materials") {
                journeyState.materials += npc.reward.amount;
            } else if (npc.reward.type === "soul") {
                journeyState.soul = Math.min(journeyState.soul + npc.reward.amount, journeyState.maxSoul);
            }
            
            // Update UI
            updateUI();
            
            // Show result message
            showToast(
                `You traded ${npc.cost.amount} ${npc.cost.type.toUpperCase()} for ${npc.reward.amount} ${npc.reward.type.toUpperCase()}.`, 
                "success"
            );
            
            // Save game state
            saveGameState();
            
            // Re-render the location to update soul bars
            renderLocation(locationId);
        }

        function updateUI() {
            headerSoul.textContent = journeyState.soul;
            headerGold.textContent = journeyState.gold;
            headerMaterials.textContent = journeyState.materials;
        }

        function goBackToCastle() {
            // Save game state before navigating back
            saveGameState();
            
            // Navigate back to the castle page
            window.location.href = 'sanc2.html';
        }

        function showToast(message, type = "success") {
            toastEl.textContent = message;
            toastEl.className = `toast show ${type}`;
            
            setTimeout(() => {
                toastEl.className = 'toast';
            }, 3000);
        }
    </script>
</body>
</html>
