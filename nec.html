<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Necromancer's Rise - ASCII Dark Fantasy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #0f0;
            line-height: 1.2;
            padding: 0;
            overflow-x: hidden;
            width: 100%;
            height: 100vh;
            height: 100dvh;
        }

        #game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        #main-menu {
            display: flex;
        }

        .active {
            display: flex !important;
        }

        .header {
            text-align: center;
            padding: 8px;
            border-bottom: 1px solid #0f0;
            margin-bottom: 0;
            flex-shrink: 0;
            flex-grow: 0;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            min-height: 0;
            margin: 0;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }

        .compact-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            justify-content: flex-start;
        }

        .footer {
            padding: 8px;
            border-top: 1px solid #0f0;
            margin-top: 0;
            flex-shrink: 0;
            flex-grow: 0;
        }

        button {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 12px 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 2px 0;
            cursor: pointer;
            width: 100%;
            min-height: 50px;
            flex-shrink: 0;
            transition: all 0.1s ease;
        }

        button:active {
            background-color: #0a0;
            color: #000;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }

        .battle-area {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .necromancer, .enemy {
            text-align: center;
            width: 48%;
            min-width: 150px;
            margin-bottom: 10px;
        }

        .ascii-art {
            font-size: 12px;
            line-height: 1;
            margin: 5px 0;
            white-space: pre;
        }

        .health-bar, .mana-bar, .soul-bar {
            width: 100%;
            height: 10px;
            background-color: #333;
            margin: 5px 0;
        }

        .health-fill {
            height: 100%;
            background-color: #0f0;
        }

        .mana-fill {
            height: 100%;
            background-color: #00f;
        }

        .soul-fill {
            height: 100%;
            background-color: #f0f;
        }

        .spell-list, .minion-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 5px;
        }

        .spell, .minion {
            width: 48%;
            margin-bottom: 5px;
            min-width: 120px;
        }

        .log {
            height: 100px;
            overflow-y: auto;
            border: 1px solid #0f0;
            padding: 5px;
            margin-top: 10px;
            font-size: 12px;
            flex-shrink: 0;
        }

        .enemy-list {
            display: flex;
            flex-direction: column;
        }

        .enemy-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border: 1px solid #0f0;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }

        .profile {
            border: 1px solid #0f0;
            padding: 5px;
            margin-bottom: 10px;
        }

        .inventory {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 5px;
        }

        .item {
            width: 48%;
            margin-bottom: 5px;
            border: 1px solid #0f0;
            padding: 5px;
            min-width: 140px;
        }

        .item-common { border-color: #0f0; }
        .item-rare { border-color: #00f; }
        .item-epic { border-color: #90f; }
        .item-legendary { border-color: #ff0; }

        .xp-bar {
            width: 100%;
            height: 10px;
            background-color: #333;
            margin: 5px 0;
        }

        .xp-fill {
            height: 100%;
            background-color: #ff0;
        }

        .upgrade-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border: 1px solid #0f0;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }

        .mana-warning {
            color: #f00;
            text-align: center;
            margin: 5px 0;
        }

        .victory-screen, .defeat-screen, .loot-screen {
            text-align: center;
            padding: 10px;
        }

        .victory-rewards, .defeat-stats, .loot-items {
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
        }

        .victory-message, .defeat-message {
            font-size: 16px;
            margin: 10px 0;
            color: #ff0;
        }

        .defeat-message {
            color: #f00;
        }

        .health-critical {
            color: #f00;
            animation: pulse 1s infinite;
        }

        .loot-item {
            margin: 5px 0;
            padding: 5px;
            border: 1px solid #0f0;
        }

        .loot-rarity-common { color: #0f0; }
        .loot-rarity-rare { color: #00f; }
        .loot-rarity-epic { color: #90f; }
        .loot-rarity-legendary { color: #ff0; }

        .consumable-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin: 10px 0;
            gap: 5px;
        }

        .consumable-btn {
            width: 48%;
            margin-bottom: 5px;
            min-width: 120px;
        }

        .inventory-item {
            width: 100%;
            margin-bottom: 10px;
            border: 1px solid #0f0;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .item-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 5px;
            width: 100%;
            justify-content: flex-end;
        }

        .item-action-btn {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
            margin: 0;
            flex: 1;
            min-width: 80px;
        }

        .inventory-empty {
            text-align: center;
            padding: 20px;
            color: #666;
            width: 100%;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .enemy-defeated {
            color: #ff0;
            font-weight: bold;
        }

        .elemental-bonus {
            color: #ff0;
            font-weight: bold;
        }

        .status-effect {
            display: inline-block;
            padding: 2px 5px;
            margin: 0 2px;
            border-radius: 3px;
            font-size: 10px;
        }

        .status-poison { background-color: #8f0; color: #000; }
        .status-curse { background-color: #90f; color: #fff; }
        .status-fear { background-color: #f90; color: #000; }
        .status-decay { background-color: #0f0; color: #000; }

        .damage-number {
            position: absolute;
            color: #f00;
            font-weight: bold;
            animation: floatUp 1s ease-out forwards;
        }

        .critical-hit {
            color: #ff0;
            font-size: 14px;
            font-weight: bold;
        }

        .combo-counter {
            text-align: center;
            font-size: 16px;
            color: #ff0;
            margin: 5px 0;
        }

        .gold-display, .soul-display, .corpse-display {
            text-align: center;
            margin: 5px 0;
            color: #ff0;
        }

        .achievement-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #000;
            border: 2px solid #ff0;
            padding: 10px;
            z-index: 100;
            text-align: center;
            max-width: 90%;
        }

        .shop-item {
            border: 1px solid #0f0;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .daily-challenge {
            border: 1px solid #ff0;
            padding: 10px;
            margin: 10px 0;
        }

        .scrollable-container {
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            -webkit-overflow-scrolling: touch;
            padding: 5px;
            display: flex;
            flex-direction: column;
        }

        .compact-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            justify-content: flex-start;
        }

        .compact-item {
            padding: 8px;
            border: 1px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .compact-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            width: 100%;
        }

        .compact-action-btn {
            flex: 1;
            padding: 4px 8px;
            font-size: 11px;
        }

        /* Minion management styles */
        .minion-management {
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
        }

        .minion-category {
            margin-bottom: 15px;
        }

        .minion {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border: 1px solid #0f0;
            margin: 5px 0;
        }

        .minion.unlocked {
            border-color: #ff0;
            background-color: rgba(255, 255, 0, 0.1);
        }

        .minion.locked {
            opacity: 0.6;
        }

        .soul-points {
            text-align: center;
            margin: 10px 0;
            color: #ff0;
            font-weight: bold;
        }

        /* Graveyard system */
        .graveyard {
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
        }

        .corpse-pile {
            text-align: center;
            margin: 5px 0;
            font-size: 12px;
        }

        .corpse-btn {
            width: 30%;
            margin: 2px;
            min-width: 80px;
        }

        .corpse-buttons {
            display: flex;
            justify-content: center;
            margin: 5px 0;
        }

        /* Cooldown indicators */
        .spell-cooldown {
            position: relative;
        }

        .cooldown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
        }

        /* Info section styles */
        .info-section {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #0f0;
        }

        .info-section h3 {
            color: #ff0;
            margin-bottom: 8px;
        }

        .spell-info {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px dashed #0f0;
        }

        .minion-combo {
            margin: 8px 0;
            padding: 8px;
            background-color: rgba(255, 255, 0, 0.1);
            border-left: 3px solid #ff0;
        }

        .combo-effect {
            color: #ff0;
            font-weight: bold;
        }

        /* Fix for achievements display */
        .achievement-item {
            border: 1px solid #0f0;
            padding: 10px;
            margin-bottom: 10px;
        }

        .achievement-unlocked {
            border-color: #ff0;
            background-color: rgba(255, 255, 0, 0.1);
        }

        .achievement-locked {
            opacity: 0.7;
        }

        /* Quest system styles */
        .quest-item {
            border: 1px solid #0f0;
            padding: 10px;
            margin-bottom: 10px;
        }

        .quest-completed {
            border-color: #ff0;
            background-color: rgba(255, 255, 0, 0.1);
        }

        .quest-progress {
            height: 5px;
            background-color: #333;
            margin: 5px 0;
        }

        .quest-progress-fill {
            height: 100%;
            background-color: #0f0;
        }

        /* Animation effects */
        .spell-animation {
            position: absolute;
            font-size: 24px;
            animation: spellFly 0.5s ease-out forwards;
            z-index: 10;
        }

        @keyframes spellFly {
            0% { transform: translateX(0) translateY(0); opacity: 1; }
            100% { transform: translateX(100px) translateY(-50px); opacity: 0; }
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #000;
            color: #0f0;
            text-align: center;
            border: 1px solid #0f0;
            border-radius: 3px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Quick play button */
        .quick-play-btn {
            background-color: #0a0;
            font-weight: bold;
        }

        /* Sound controls */
        .sound-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .sound-btn {
            width: auto;
            padding: 5px;
            min-height: auto;
            font-size: 12px;
        }

        @media (max-height: 700px) {
            .header {
                padding: 5px;
            }
            
            .header pre {
                font-size: 10px;
                line-height: 1;
            }
            
            .header h2 {
                font-size: 16px;
            }
            
            .content {
                padding: 5px;
            }
            
            button {
                padding: 10px 6px;
                min-height: 40px;
                font-size: 13px;
            }
            
            .footer {
                padding: 5px;
            }
        }

        @media (max-height: 500px) {
            .header pre {
                display: none;
            }
            
            .header {
                padding: 3px;
            }
            
            .content {
                padding: 3px;
            }
            
            button {
                padding: 8px 4px;
                min-height: 36px;
                font-size: 12px;
            }
            
            .compact-list {
                gap: 3px;
            }
        }

        @media (orientation: portrait) {
            .screen {
                height: 100vh;
                height: 100dvh;
            }
            
            .content {
                padding: 6px;
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            
            .compact-list {
                gap: 6px;
                flex: 1;
            }
            
            .scrollable-container {
                padding: 4px;
                flex: 1;
            }
        }

        @media (max-width: 480px) and (orientation: portrait) {
            body {
                padding: 0;
            }
            
            #game-container {
                height: 100vh;
                height: 100dvh;
            }
            
            .screen {
                height: 100vh;
                height: 100dvh;
            }
            
            .header {
                padding: 6px;
            }
            
            .content {
                padding: 6px;
                flex: 1;
            }
            
            .footer {
                padding: 6px;
            }
            
            .compact-list {
                gap: 6px;
                flex: 1;
            }
            
            button {
                margin: 1px 0;
                min-height: 44px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Sound Controls -->
        <div class="sound-controls">
            <button id="toggle-sound" class="sound-btn">ðŸ”Š Sound: ON</button>
        </div>

        <!-- Main Menu Screen -->
        <div id="main-menu" class="screen active">
            <div class="header">
                <pre>
  _   _            _                                     
 | \ | |          | |                                    
 |  \| | ___  ___ | |_ ___  _ __ ___   ___ _ __ ___ _ __ 
 | . ` |/ _ \/ _ \| __/ _ \| '_ ` _ \ / _ \ '__/ _ \ '__|
 | |\  |  __/ (_) | || (_) | | | | | |  __/ | |  __/ |   
 |_| \_|\___|\___/ \__\___/|_| |_| |_|\___|_|  \___|_|   
                </pre>
                <h2>NECROMANCER'S RISE</h2>
            </div>
            <div class="content">
                <div class="compact-list">
                    <button id="new-game">NEW GAME</button>
                    <button id="quick-play" class="quick-play-btn">QUICK RAID</button>
                    <button id="player-profile">NECROMANCER PROFILE</button>
                    <button id="select-enemy">RAID SETTLEMENT</button>
                    <button id="manage-minions">MANAGE MINIONS</button>
                    <button id="graveyard-btn">GRAVEYARD</button>
                    <button id="use-consumables">USE ARTIFACTS</button>
                    <button id="shop-btn">DARK MARKET</button>
                    <button id="skill-tree-btn">SOUL MASTERY</button>
                    <button id="achievements-btn">ACHIEVEMENTS</button>
                    <button id="quests-btn">DARK QUESTS</button>
                    <button id="rest-btn">REST (Gather Corpses)</button>
                    <button id="info-btn">DARK ARTS INFO</button>
                    <div class="soul-display">Souls: <span id="soul-amount">0</span></div>
                    <div class="corpse-display">Corpses: <span id="corpse-amount">0</span></div>
                    <div class="soul-points">Soul Points: <span id="soul-points-amount">0</span></div>
                    <div id="combo-counter-main" class="combo-counter" style="display: none;"></div>
                    <div id="daily-challenge-main" class="daily-challenge" style="display: none;">
                        <h3>Dark Ritual Available!</h3>
                        <button id="daily-challenge-btn">PERFORM RITUAL</button>
                    </div>
                </div>
            </div>
            <div class="footer">
                <p>Command your undead army! (1-4: Quick Cast)</p>
            </div>
        </div>
        
        <!-- Player Profile Screen -->
        <div id="player-profile-screen" class="screen">
            <div class="header">
                <h2>NECROMANCER PROFILE</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="profile">
                        <div class="profile-header">
                            <pre>
    .-.
   (o.o)
    |=|
   __|__
  //.=|=\\
 // .=|=\\
 \\ .=|=\\
  \\(_=_)//
   (:| |:)
    || ||
    () ()
    || ||
    || ||
   ==' '==
                            </pre>
                            <h3 id="player-name">MORDRED</h3>
                            <div class="stats">
                                <div>Souls: <span id="player-souls">0</span></div>
                                <div>Corpses: <span id="player-corpses">0</span></div>
                                <div>Soul Points: <span id="player-soul-points">0</span></div>
                                <div>Achievements: <span id="player-achievements">0</span>/5</div>
                            </div>
                        </div>
                        <div class="stats">
                            <div>Level: <span id="player-level">1</span></div>
                            <div>XP: <span id="player-xp">0</span>/<span id="player-next-level">100</span></div>
                        </div>
                        <div class="xp-bar">
                            <div class="xp-fill" id="player-xp-bar" style="width: 0%;"></div>
                        </div>
                        <div class="stats">
                            <div>Health: <span id="player-health">50</span>/<span id="player-max-health">50</span></div>
                            <div>Mana: <span id="player-mana">30</span>/<span id="player-max-mana">30</span></div>
                        </div>
                        <div class="stats">
                            <div>Dark Power: <span id="player-attack">5</span></div>
                            <div>Defense: <span id="player-defense">3</span></div>
                            <div>Critical: <span id="player-critical">5</span>%</div>
                        </div>
                        <div class="corpse-pile">
                            Corpses Available: <span id="player-available-corpses">0</span>
                        </div>
                        <div id="player-status-effects" class="stats">
                            <!-- Status effects will appear here -->
                        </div>
                        <h4>DARK SPELLS:</h4>
                        <div class="spell-list" id="profile-spells">
                            <!-- Spells will be dynamically added here -->
                        </div>
                        <h4>ACTIVE MINIONS:</h4>
                        <div id="player-active-minions">
                            <div class="inventory-empty">No active minions</div>
                        </div>
                        <h4>ARTIFACTS:</h4>
                        <div class="inventory">
                            <div class="item">
                                <div>Weapon: <span id="player-weapon">Bone Staff</span></div>
                                <div>DMG: +<span id="player-weapon-dmg">2</span></div>
                            </div>
                            <div class="item">
                                <div>Armor: <span id="player-armor">Necromancer Robes</span></div>
                                <div>DEF: +<span id="player-armor-def">1</span></div>
                            </div>
                        </div>
                        <h4>INVENTORY:</h4>
                        <div id="player-inventory-items">
                            <div class="inventory-empty">No artifacts in inventory</div>
                        </div>
                        <button id="manage-inventory" style="margin-top: 10px;">MANAGE ARTIFACTS</button>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-profile">BACK</button>
            </div>
        </div>

        <!-- Soul Mastery Screen -->
        <div id="skill-tree-screen" class="screen">
            <div class="header">
                <h2>SOUL MASTERY</h2>
                <div class="soul-points">Available Soul Points: <span id="available-soul-points">0</span></div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="skill-tree">
                        <h3>Undead Mastery</h3>
                        <div class="skill-category">
                            <h4>Skeleton Line</h4>
                            <div class="skill" id="skill-skeleton-1">
                                <div>
                                    <strong>Skeletal Fortitude</strong>
                                    <div>Skeletons gain +2 health</div>
                                </div>
                                <button class="skill-btn" data-skill="skeletal_fortitude" data-cost="1">Learn (1 point)</button>
                            </div>
                            <div class="skill locked" id="skill-skeleton-2">
                                <div>
                                    <strong>Bone Armor</strong>
                                    <div>Skeletons gain +1 defense</div>
                                </div>
                                <button class="skill-btn" data-skill="bone_armor" data-cost="2">Learn (2 points)</button>
                            </div>
                        </div>
                        <div class="skill-category">
                            <h4>Zombie Line</h4>
                            <div class="skill" id="skill-zombie-1">
                                <div>
                                    <strong>Plague Bearer</strong>
                                    <div>Zombies inflict poison more often</div>
                                </div>
                                <button class="skill-btn" data-skill="plague_bearer" data-cost="1">Learn (1 point)</button>
                            </div>
                            <div class="skill locked" id="skill-zombie-2">
                                <div>
                                    <strong>Endless Horde</strong>
                                    <div>Zombies cost 1 less corpse to raise</div>
                                </div>
                                <button class="skill-btn" data-skill="endless_horde" data-cost="2">Learn (2 points)</button>
                            </div>
                        </div>
                        <div class="skill-category">
                            <h4>Ghost Line</h4>
                            <div class="skill" id="skill-ghost-1">
                                <div>
                                    <strong>Ethereal Form</strong>
                                    <div>Ghosts take 25% less physical damage</div>
                                </div>
                                <button class="skill-btn" data-skill="ethereal_form" data-cost="1">Learn (1 point)</button>
                            </div>
                            <div class="skill locked" id="skill-ghost-2">
                                <div>
                                    <strong>Soul Drain</strong>
                                    <div>Ghosts restore your mana on attack</div>
                                </div>
                                <button class="skill-btn" data-skill="soul_drain" data-cost="3">Learn (3 points)</button>
                            </div>
                        </div>
                        <div class="skill-category">
                            <h4>General Skills</h4>
                            <div class="skill" id="skill-general-1">
                                <div>
                                    <strong>Dark Efficiency</strong>
                                    <div>All spells cost 1 less mana (min 1)</div>
                                </div>
                                <button class="skill-btn" data-skill="dark_efficiency" data-cost="2">Learn (2 points)</button>
                            </div>
                            <div class="skill locked" id="skill-general-2">
                                <div>
                                    <strong>Soul Harvest</strong>
                                    <div>+10% more souls from defeated enemies</div>
                                </div>
                                <button class="skill-btn" data-skill="soul_harvest" data-cost="3">Learn (3 points)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="reset-skills" style="background-color: #600; margin-bottom: 5px;">RESET SOUL MASTERY</button>
                <button id="back-from-skills">BACK</button>
            </div>
        </div>
        
        <!-- Enemy Selection Screen -->
        <div id="enemy-selection" class="screen">
            <div class="header">
                <h2>RAID SETTLEMENT</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="enemy-list" id="enemy-list">
                        <!-- Enemies will be dynamically added here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-enemies">BACK</button>
            </div>
        </div>
        
        <!-- Battle Screen -->
        <div id="battle-screen" class="screen">
            <div class="header">
                <h2>DARK CONFLICT</h2>
                <div id="combo-counter-battle" class="combo-counter" style="display: none;"></div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="battle-area">
                        <div class="necromancer">
                            <h3>NECROMANCER</h3>
                            <div class="ascii-art" id="player-ascii">
    .-.
   (o.o)
    |=|
   __|__
  //.=|=\\
 // .=|=\\
 \\ .=|=\\
  \\(_=_)//
   (:| |:)
    || ||
    () ()
    || ||
    || ||
   ==' '==
                            </div>
                            <div>Health: <span id="battle-player-health">50</span>/<span id="battle-player-max-health">50</span></div>
                            <div class="health-bar">
                                <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
                            </div>
                            <div>Mana: <span id="battle-player-mana">30</span>/<span id="battle-player-max-mana">30</span></div>
                            <div class="mana-bar">
                                <div class="mana-fill" id="player-mana-fill" style="width: 100%;"></div>
                            </div>
                            <div id="player-status-effects-battle" class="stats">
                                <!-- Player status effects in battle -->
                            </div>
                        </div>
                        <div class="enemy">
                            <h3 id="enemy-name">VILLAGE MILITIA</h3>
                            <div class="ai-behavior" id="enemy-ai-behavior">AI: Defensive</div>
                            <div class="ascii-art" id="enemy-ascii">
      /\
     /**\
    /****\
   /******\
  /********\
 /__________\
     |  |
     |  |
    /    \
   /______\
                            </div>
                            <div>Health: <span id="battle-enemy-health">40</span>/<span id="battle-enemy-max-health">40</span></div>
                            <div class="health-bar">
                                <div class="health-fill" id="enemy-health-fill" style="width: 100%;"></div>
                            </div>
                            <div>Morale: <span id="battle-enemy-mana">25</span>/<span id="battle-enemy-max-mana">25</span></div>
                            <div class="mana-bar">
                                <div class="mana-fill" id="enemy-mana-fill" style="width: 100%;"></div>
                            </div>
                            <div id="enemy-status-effects" class="stats">
                                <!-- Enemy status effects -->
                            </div>
                        </div>
                    </div>
                    <div class="log" id="battle-log">
                        <div>The dead rise to serve you!</div>
                    </div>
                    <div id="mana-warning" class="mana-warning" style="display: none;">
                        Low on mana! Consider fleeing to gather more souls.
                    </div>
                    <div id="health-warning" class="mana-warning health-critical" style="display: none;">
                        CRITICAL HEALTH! Use Dark Heal or flee!
                    </div>
                    <h4>DARK SPELLS:</h4>
                    <div class="spell-list" id="battle-spells">
                        <!-- Spells will be dynamically added here -->
                    </div>
                    <h4>ACTIVE MINIONS:</h4>
                    <div class="minion-list" id="battle-minions">
                        <!-- Minions will be dynamically added here -->
                    </div>
                    <div class="consumable-buttons" id="battle-consumables" style="display: none;">
                        <!-- Consumable buttons will be added here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="flee">RETREAT TO SHADOWS</button>
            </div>
        </div>
        
        <!-- Victory Screen -->
        <div id="victory-screen" class="screen">
            <div class="header">
                <h2>VICTORY!</h2>
            </div>
            <div class="content">
                <div class="victory-screen">
                    <pre>
   __   _____  _  _  ____  __    ____ 
  /__\ (  _  )( \( )( ___)(  )  ( ___)
 /(__)\ )(_)(  )  (  )__)  )(__  )__) 
(__)(__)(_____)(_)\_)(____)(____)(____)
                    </pre>
                    <div class="victory-message" id="victory-message">
                        You have defeated the enemy and claimed their souls!
                    </div>
                    <div class="victory-rewards">
                        <h3>DARK BOUNTY:</h3>
                        <div id="victory-xp">XP Gained: 0</div>
                        <div id="victory-souls">Souls Gained: 0</div>
                        <div id="victory-corpses">Corpses Gained: 0</div>
                        <div id="victory-soul-points" style="display: none;">Soul Point Gained!</div>
                        <div id="victory-level-up" style="display: none; color: #ff0; font-weight: bold;">
                            DARK ASCENSION! You are now level <span id="new-level">2</span>!
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="continue-after-victory">CONTINUE YOUR RISE</button>
            </div>
        </div>
        
        <!-- Loot Screen -->
        <div id="loot-screen" class="screen">
            <div class="header">
                <h2>DARK BOOTY FOUND!</h2>
            </div>
            <div class="content">
                <div class="loot-screen">
                    <pre>
   __   _____   ___  _____ 
  / /  |  _  | / _ \|_   _|
 / /   | | | |/ /_\ \ | |  
/ /    | | | ||  _  | | |  
\ \    | |_| || | | | | |  
 \_\   |_____/\_| |_/ \_/  
                    </pre>
                    <div class="loot-message">
                        You found dark artifacts from the defeated!
                    </div>
                    <div class="loot-items" id="loot-items">
                        <!-- Loot items will be displayed here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="take-loot">CLAIM BOOTY</button>
            </div>
        </div>
        
        <!-- Defeat Screen -->
        <div id="defeat-screen" class="screen">
            <div class="header">
                <h2>DEFEAT</h2>
            </div>
            <div class="content">
                <div class="defeat-screen">
                    <pre>
  _____  ______  _____  ______  _______  _____ 
 |  __ \|  ____|/ ____||  ____||__   __|/ ____|
 | |  | | |__  | (___  | |__      | |  | (___  
 | |  | |  __|  \___ \ |  __|     | |   \___ \ 
 | |__| | |____ ____) || |____    | |   ____) |
 |_____/|______|_____/ |______|   |_|  |_____/ 
                    </pre>
                    <div class="defeat-message" id="defeat-message">
                        Your dark ambitions have been thwarted!
                    </div>
                    <div class="defeat-stats">
                        <h3>BATTLE STATS:</h3>
                        <div id="defeat-enemy">Defeated by: Unknown</div>
                        <div id="defeat-level">Your Level: 1</div>
                        <div id="defeat-xp">Current XP: 0</div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="try-again">TRY AGAIN</button>
                <button id="main-menu-after-defeat">DARK SANCTUARY</button>
            </div>
        </div>
        
        <!-- Upgrade Screen -->
        <div id="upgrade-screen" class="screen">
            <div class="header">
                <h2>DARK ASCENSION!</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <p>You've grown in dark power! Choose an upgrade:</p>
                    <div class="upgrade-option">
                        <div>
                            <h4>+10 Max Health</h4>
                            <p>Increases your maximum health by 10</p>
                        </div>
                        <button class="upgrade-btn" data-upgrade="health">SELECT</button>
                    </div>
                    <div class="upgrade-option">
                        <div>
                            <h4>+5 Max Mana</h4>
                            <p>Increases your maximum mana by 5</p>
                        </div>
                        <button class="upgrade-btn" data-upgrade="mana">SELECT</button>
                    </div>
                    <div class="upgrade-option">
                        <div>
                            <h4>+2 Dark Power</h4>
                            <p>Increases your dark power by 2</p>
                        </div>
                        <button class="upgrade-btn" data-upgrade="attack">SELECT</button>
                    </div>
                    <div class="upgrade-option">
                        <div>
                            <h4>+2 Defense</h4>
                            <p>Increases your defense by 2</p>
                        </div>
                        <button class="upgrade-btn" data-upgrade="defense">SELECT</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Minion Management Screen -->
        <div id="minion-management-screen" class="screen">
            <div class="header">
                <h2>MANAGE YOUR UNDEAD HORDE</h2>
                <div>Available Corpses: <span id="minion-corpses">0</span></div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="minion-management">
                        <h3>Raise New Minions</h3>
                        <div class="minion-category">
                            <h4>Skeletons</h4>
                            <div class="minion" id="minion-skeleton">
                                <div>
                                    <strong>Skeleton Warrior</strong>
                                    <div>Health: 8 | Damage: 3 | Cost: 1 Corpse</div>
                                    <div>Abilities: Basic attack, 10% chance to dodge</div>
                                </div>
                                <button class="minion-btn" data-minion="skeleton" data-cost="1">Raise (1 Corpse)</button>
                            </div>
                            <div class="minion locked" id="minion-archer">
                                <div>
                                    <strong>Skeleton Archer</strong>
                                    <div>Health: 6 | Damage: 4 | Cost: 2 Corpses</div>
                                    <div>Abilities: Ranged attack, +10% critical chance</div>
                                </div>
                                <button class="minion-btn" data-minion="archer" data-cost="2">Raise (2 Corpses)</button>
                            </div>
                        </div>
                        <div class="minion-category">
                            <h4>Zombies</h4>
                            <div class="minion" id="minion-zombie">
                                <div>
                                    <strong>Zombie</strong>
                                    <div>Health: 12 | Damage: 2 | Cost: 2 Corpses</div>
                                    <div>Abilities: 30% chance to inflict poison</div>
                                </div>
                                <button class="minion-btn" data-minion="zombie" data-cost="2">Raise (2 Corpses)</button>
                            </div>
                            <div class="minion locked" id="minion-brute">
                                <div>
                                    <strong>Zombie Brute</strong>
                                    <div>Health: 18 | Damage: 4 | Cost: 3 Corpses</div>
                                    <div>Abilities: High health, can taunt enemies</div>
                                </div>
                                <button class="minion-btn" data-minion="brute" data-cost="3">Raise (3 Corpses)</button>
                            </div>
                        </div>
                        <div class="minion-category">
                            <h4>Ghosts</h4>
                            <div class="minion" id="minion-ghost">
                                <div>
                                    <strong>Ghost</strong>
                                    <div>Health: 5 | Damage: 5 | Cost: 3 Corpses + 5 Souls</div>
                                    <div>Abilities: Ethereal (25% less physical damage), mana drain</div>
                                </div>
                                <button class="minion-btn" data-minion="ghost" data-cost="3">Raise (3 Corpses + 5 Souls)</button>
                            </div>
                            <div class="minion locked" id="minion-wraith">
                                <div>
                                    <strong>Wraith</strong>
                                    <div>Health: 8 | Damage: 7 | Cost: 5 Corpses + 10 Souls</div>
                                    <div>Abilities: Fear aura, life drain, ethereal</div>
                                </div>
                                <button class="minion-btn" data-minion="wraith" data-cost="5">Raise (5 Corpses + 10 Souls)</button>
                            </div>
                        </div>
                    </div>
                    <h3>Your Active Minions</h3>
                    <div id="active-minions-list">
                        <div class="inventory-empty">No active minions</div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-minions">BACK</button>
            </div>
        </div>

        <!-- Graveyard Screen -->
        <div id="graveyard-screen" class="screen">
            <div class="header">
                <h2>GRAVEYARD</h2>
                <div>Available Corpses: <span id="graveyard-corpses">0</span></div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="graveyard">
                        <h3>Corpse Collection</h3>
                        <p>Use corpses to raise undead minions or perform dark rituals.</p>
                        
                        <div class="corpse-pile">
                            <h4>Your Corpse Pile</h4>
                            <div>Total Corpses: <span id="total-corpses">0</span></div>
                            <div>Fresh Corpses: <span id="fresh-corpses">0</span> (Best for raising)</div>
                            <div>Decaying Corpses: <span id="decaying-corpses">0</span> (Lower quality)</div>
                        </div>
                        
                        <h4>Dark Rituals</h4>
                        <div class="spell-list">
                            <button class="ritual-btn" data-ritual="gather_corpses" data-cost="10">Gather Corpses (10 Mana)</button>
                            <button class="ritual-btn" data-ritual="preserve_corpses" data-cost="15">Preserve Corpses (15 Mana)</button>
                            <button class="ritual-btn" data-ritual="mass_raise" data-cost="25">Mass Raise (25 Mana + 5 Corpses)</button>
                        </div>
                        
                        <h4>Recent Additions</h4>
                        <div id="recent-corpses">
                            <div class="inventory-empty">No recent corpses</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-graveyard">BACK</button>
            </div>
        </div>
        
        <!-- Consumables Screen -->
        <div id="consumables-screen" class="screen">
            <div class="header">
                <h2>DARK ARTIFACTS</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="consumables-list">
                        <!-- Consumable items will be listed here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-consumables">BACK</button>
            </div>
        </div>
        
        <!-- Inventory Screen -->
        <div id="inventory-screen" class="screen">
            <div class="header">
                <h2>ARTIFACT COLLECTION</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="inventory-items">
                        <!-- Inventory items with actions will be listed here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-inventory">BACK</button>
            </div>
        </div>
        
        <!-- Shop Screen -->
        <div id="shop-screen" class="screen">
            <div class="header">
                <h2>DARK MARKET</h2>
                <div>Your Souls: <span id="shop-souls">0</span></div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="shop-items">
                        <!-- Shop items will be dynamically added here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-shop">BACK</button>
            </div>
        </div>
        
        <!-- Achievements Screen -->
        <div id="achievements-screen" class="screen">
            <div class="header">
                <h2>DARK ACHIEVEMENTS</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="achievements-list">
                        <!-- Achievements will be dynamically added here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-achievements">BACK</button>
            </div>
        </div>

        <!-- Quests Screen -->
        <div id="quests-screen" class="screen">
            <div class="header">
                <h2>DARK QUESTS</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="quests-list">
                        <!-- Quests will be dynamically added here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-quests">BACK</button>
            </div>
        </div>
        
        <!-- Info Screen -->
        <div id="info-screen" class="screen">
            <div class="header">
                <h2>DARK ARTS INFORMATION</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="info-section">
                        <h3>HOW TO PLAY</h3>
                        <p>Welcome to Necromancer's Rise! You are a dark necromancer raising an undead army to conquer the land.</p>
                        <p><strong>Basic Gameplay:</strong></p>
                        <ul>
                            <li>Gather corpses from battles or the graveyard</li>
                            <li>Raise undead minions to fight for you</li>
                            <li>Raid settlements to gain souls, corpses, and dark artifacts</li>
                            <li>Use souls to upgrade your dark powers and minions</li>
                            <li>Expand your undead horde and become the ultimate necromancer</li>
                        </ul>
                        <p><strong>Battle Tips:</strong></p>
                        <ul>
                            <li>Use different minion types strategically - skeletons are cheap, zombies are durable, ghosts are powerful but expensive</li>
                            <li>Manage your mana carefully - raising minions and casting spells costs mana</li>
                            <li>Use status effects to your advantage - poison, fear, and curses can turn the tide</li>
                            <li>Retreat if you're overwhelmed to preserve your minions</li>
                        </ul>
                    </div>

                    <div class="info-section">
                        <h3>MINION TYPES</h3>
                        <p>Here are the minions you can raise:</p>
                        
                        <div class="spell-info">
                            <strong>Skeleton Warrior</strong>
                            <div>Health: 8 | Damage: 3 | Cost: 1 Corpse</div>
                            <div>Abilities: Basic attack, 10% chance to dodge</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Skeleton Archer</strong>
                            <div>Health: 6 | Damage: 4 | Cost: 2 Corpses</div>
                            <div>Abilities: Ranged attack, +10% critical chance</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Zombie</strong>
                            <div>Health: 12 | Damage: 2 | Cost: 2 Corpses</div>
                            <div>Abilities: 30% chance to inflict poison</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Zombie Brute</strong>
                            <div>Health: 18 | Damage: 4 | Cost: 3 Corpses</div>
                            <div>Abilities: High health, can taunt enemies</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Ghost</strong>
                            <div>Health: 5 | Damage: 5 | Cost: 3 Corpses + 5 Souls</div>
                            <div>Abilities: Ethereal (25% less physical damage), mana drain</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Wraith</strong>
                            <div>Health: 8 | Damage: 7 | Cost: 5 Corpses + 10 Souls</div>
                            <div>Abilities: Fear aura, life drain, ethereal</div>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>DARK SPELLS</h3>
                        <p>Master these dark arts to enhance your power:</p>
                        
                        <div class="spell-info">
                            <strong>Dark Bolt</strong>
                            <div>Damage: 8 | Cost: 5 Mana</div>
                            <div>Effect: Basic dark energy attack</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Life Drain</strong>
                            <div>Damage: 6 | Heal: 3 | Cost: 7 Mana</div>
                            <div>Effect: Steal life from your enemy</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Raise Dead</strong>
                            <div>Cost: 10 Mana + 1 Corpse</div>
                            <div>Effect: Instantly raise a skeleton in battle</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Curse of Weakness</strong>
                            <div>Cost: 8 Mana</div>
                            <div>Effect: Reduces enemy attack power</div>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>RESOURCES</h3>
                        <div class="spell-info">
                            <strong>Souls</strong>
                            <div>Currency obtained from defeated enemies. Used for upgrades and purchasing artifacts.</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Corpses</strong>
                            <div>Required for raising undead minions. Gathered from battles or the graveyard.</div>
                        </div>
                        
                        <div class="spell-info">
                            <strong>Mana</strong>
                            <div>Energy used to cast spells. Regenerates over time or through special abilities.</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-info">BACK</button>
            </div>
        </div>
        
        <!-- Daily Challenge Screen -->
        <div id="daily-challenge-screen" class="screen">
            <div class="header">
                <h2>DARK RITUAL</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="daily-challenge-info">
                        <!-- Daily challenge info will be displayed here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-daily">BACK</button>
                <button id="start-daily-challenge">BEGIN RITUAL</button>
            </div>
        </div>
    </div>

    <script>
    // ============== NECROMANCER'S RISE GAME STATE ==============
    const gameState = {
        player: {
            name: "MORDRED",
            level: 1,
            xp: 0,
            nextLevel: 100,
            health: 50,
            maxHealth: 50,
            mana: 30,
            maxMana: 30,
            attack: 5,
            defense: 3,
            critical: 5,
            souls: 0,
            soulPoints: 0,
            corpses: 0,
            availableCorpses: 0,
            position: "medium",
            statusEffects: [],
            spells: [
                { name: "Dark Bolt", damage: 8, cost: 5, element: "dark", cooldown: 0, maxCooldown: 0 },
                { name: "Life Drain", damage: 6, heal: 3, cost: 7, element: "dark", cooldown: 0, maxCooldown: 1 },
                { name: "Raise Dead", cost: 10, element: "necromancy", cooldown: 0, maxCooldown: 2, requiresCorpse: true },
                { name: "Curse of Weakness", cost: 8, element: "curse", statusEffect: "curse", cooldown: 0, maxCooldown: 3 }
            ],
            minions: [],
            maxMinions: 3,
            equipment: {
                weapon: { name: "Bone Staff", damage: 2 },
                armor: { name: "Necromancer Robes", defense: 1 }
            },
            inventory: [],
            unlockedSpells: [0, 1, 2, 3],
            comboCount: 0,
            lastSpellElement: null,
            skills: {
                skeletal_fortitude: false,
                bone_armor: false,
                plague_bearer: false,
                endless_horde: false,
                ethereal_form: false,
                soul_drain: false,
                dark_efficiency: false,
                soul_harvest: false
            }
        },
        currentEnemy: null,
        currentXpReward: 0,
        currentSoulReward: 0,
        currentCorpseReward: 0,
        battleLog: [],
        currentLoot: [],
        achievements: {
            first_blood: { name: "First Blood", description: "Defeat your first enemy", unlocked: false, reward: { souls: 50 } },
            undead_master: { name: "Undead Master", description: "Raise 10 minions", unlocked: false, reward: { souls: 100 } },
            soul_collector: { name: "Soul Collector", description: "Collect 1000 souls", unlocked: false, reward: { souls: 200 } },
            horde_master: { name: "Horde Master", description: "Have 5 minions active at once", unlocked: false, reward: { souls: 75 } },
            dragon_slayer: { name: "Dragon Slayer", description: "Defeat the Holy Paladin", unlocked: false, reward: { souls: 500 } },
            skill_master: { name: "Skill Master", description: "Unlock 5 soul masteries", unlocked: false, reward: { souls: 150 } }
        },
        quests: {
            novice_necromancer: {
                name: "Novice Necromancer",
                description: "Defeat 3 enemies",
                type: "defeat_enemies",
                target: 3,
                progress: 0,
                completed: false,
                reward: { souls: 50, xp: 100 }
            },
            minion_master: {
                name: "Minion Master",
                description: "Raise 5 minions",
                type: "raise_minions",
                progress: 0,
                target: 5,
                completed: false,
                reward: { soulPoint: 1 }
            },
            grave_robber: {
                name: "Grave Robber",
                description: "Collect 20 corpses",
                type: "collect_corpses",
                progress: 0,
                target: 20,
                completed: false,
                reward: { souls: 100 }
            }
        },
        dailyChallenge: {
            available: false,
            completed: false,
            progress: 0,
            required: 3,
            reward: { xp: 200, souls: 100 }
        },
        enemies: {
            militia: {
                name: "Village Militia",
                level: 1,
                health: 40,
                maxHealth: 40,
                mana: 25,
                maxMana: 25,
                attack: 4,
                defense: 2,
                element: "holy",
                aiBehavior: "defensive",
                preferredPosition: "close",
                spells: [
                    { name: "Strike", damage: 6, cost: 0 },
                    { name: "Guard", defense: 3, cost: 5, duration: 2 }
                ],
                ascii: `      /\
     /**\\
    /****\\
   /******\\
  /********\\
 /__________\\
     |  |
     |  |
    /    \\
   /______\\`,
                xpReward: 25,
                soulReward: 10,
                corpseReward: 2,
                lootTier: 1
            },
            priest: {
                name: "Village Priest",
                level: 2,
                health: 50,
                maxHealth: 50,
                mana: 30,
                maxMana: 30,
                attack: 3,
                defense: 3,
                element: "holy",
                aiBehavior: "supportive",
                preferredPosition: "far",
                spells: [
                    { name: "Smite", damage: 8, cost: 6, element: "holy" },
                    { name: "Heal", heal: 10, cost: 8, element: "holy" },
                    { name: "Turn Undead", damage: 12, cost: 10, element: "holy", bonusVsUndead: true }
                ],
                ascii: `      /\\
     /++\\
    /++++\\
   /++++++\\
  /++++++++\\
 /__________\\
    |    |
    |    |
   /      \\
  /________\\
    |    |
    |    |`,
                xpReward: 40,
                soulReward: 15,
                corpseReward: 1,
                lootTier: 2
            },
            knight: {
                name: "Holy Knight",
                level: 3,
                health: 60,
                maxHealth: 60,
                mana: 20,
                maxMana: 20,
                attack: 7,
                defense: 5,
                element: "holy",
                aiBehavior: "aggressive",
                preferredPosition: "close",
                spells: [
                    { name: "Heavy Strike", damage: 10, cost: 5 },
                    { name: "Shield Bash", damage: 6, cost: 4, stun: true },
                    { name: "Divine Protection", defense: 5, cost: 8, element: "holy", duration: 3 }
                ],
                ascii: `     /\\
    /##\\
   /####\\
  /######\\
 /########\\
/__________\\
   |    |
   |    |
  /------\\
 /|      |\\
  |      |
  |      |`,
                xpReward: 60,
                soulReward: 20,
                corpseReward: 3,
                lootTier: 3
            },
            inquisitor: {
                name: "Inquisitor",
                level: 4,
                health: 70,
                maxHealth: 70,
                mana: 40,
                maxMana: 40,
                attack: 6,
                defense: 4,
                element: "holy",
                aiBehavior: "tactical",
                preferredPosition: "medium",
                spells: [
                    { name: "Judgment", damage: 12, cost: 8, element: "holy", bonusVsUndead: true },
                    { name: "Purge", damage: 8, cost: 6, element: "holy", removesStatus: true },
                    { name: "Divine Wrath", damage: 15, cost: 12, element: "holy", bonusVsUndead: true }
                ],
                ascii: `      /\\
     /**\\
    /****\\
   /******\\
  /********\\
 /__________\\
    |    |
    |    |
   /------\\
  /|      |\\
   |      |
   |      |`,
                xpReward: 80,
                soulReward: 25,
                corpseReward: 2,
                lootTier: 4
            },
            paladin: {
                name: "Holy Paladin",
                level: 10,
                health: 150,
                maxHealth: 150,
                mana: 60,
                maxMana: 60,
                attack: 10,
                defense: 8,
                element: "holy",
                aiBehavior: "adaptive",
                preferredPosition: "close",
                spells: [
                    { name: "Divine Strike", damage: 15, cost: 10, element: "holy", bonusVsUndead: true },
                    { name: "Lay on Hands", heal: 25, cost: 15, element: "holy" },
                    { name: "Consecrate", damage: 12, cost: 12, element: "holy", bonusVsUndead: true, area: true }
                ],
                ascii: `        __
       /##\\
      /####\\
     /######\\
    /########\\
   /##########\\
  /############\\
 /______________\\
      |    |
      |    |
     /------\\
    /|      |\\
     |      |
     |      |`,
                xpReward: 200,
                soulReward: 100,
                corpseReward: 5,
                lootTier: 5
            }
        },
        minionTypes: {
            skeleton: {
                name: "Skeleton Warrior",
                health: 8,
                maxHealth: 8,
                damage: 3,
                defense: 0,
                cost: { corpses: 1, souls: 0 },
                abilities: ["Basic Attack", "10% Dodge"],
                ascii: `     .-.
    (o.o)
     |=|
    __|__
   //.=.\\
  // .=|=\\
  \\\\. .=|=\\
   \\(_=_)//
    (:| |:)
     || ||
     () ()
     || ||
   ==' '==`,
                type: "skeleton"
            },
            archer: {
                name: "Skeleton Archer",
                health: 6,
                maxHealth: 6,
                damage: 4,
                defense: 0,
                cost: { corpses: 2, souls: 0 },
                abilities: ["Ranged Attack", "+10% Critical"],
                ascii: `     .-.
    (o.o)
     |=|
    __|__
   //.=.\\
  // .=|=\\
  \\\\. .=|=\\
   \\(_=_)//
    (:| |:)
     || ||
    ( -|- )
     |---|
     '---'`,
                type: "skeleton",
                unlocked: false
            },
            zombie: {
                name: "Zombie",
                health: 12,
                maxHealth: 12,
                damage: 2,
                defense: 1,
                cost: { corpses: 2, souls: 0 },
                abilities: ["30% Poison Chance"],
                ascii: `     .-.
    (X.X)
     |=|
    __|__
   //.=.\\
  // .=|=\\
  \\\\. .=|=\\
   \\(_=_)//
    (:| |:)
     || ||
    (\\_/_)
     |   |
     |   |`,
                type: "zombie"
            },
            brute: {
                name: "Zombie Brute",
                health: 18,
                maxHealth: 18,
                damage: 4,
                defense: 2,
                cost: { corpses: 3, souls: 0 },
                abilities: ["High Health", "Taunt"],
                ascii: `     .-.
    (O.O)
     |=|
    _|_|_
   //.=.\\
  // .=|=\\
  \\\\. .=|=\\
   \\(_=_)//
    (:| |:)
     || ||
    (|   |)
     |   |
     |   |`,
                type: "zombie",
                unlocked: false
            },
            ghost: {
                name: "Ghost",
                health: 5,
                maxHealth: 5,
                damage: 5,
                defense: 0,
                cost: { corpses: 3, souls: 5 },
                abilities: ["Ethereal (25% less physical damage)", "Mana Drain"],
                ascii: `    .~~~.
   ( 0.0 )
    \~~~/ 
    /   \\
   /     \\
  /       \\
 (         )
  \       /
   \     /
    \___/`,
                type: "ghost"
            },
            wraith: {
                name: "Wraith",
                health: 8,
                maxHealth: 8,
                damage: 7,
                defense: 0,
                cost: { corpses: 5, souls: 10 },
                abilities: ["Fear Aura", "Life Drain", "Ethereal"],
                ascii: `    .~~~.
   ( O.O )
    \~-~/ 
    / | \\
   /  |  \\
  /   |   \\
 (    |    )
  \   |   /
   \  |  /
    \___/`,
                type: "ghost",
                unlocked: false
            }
        },
        statusEffects: {
            poison: { 
                name: "Poison", 
                damagePerTurn: 2, 
                duration: 3, 
                element: "poison",
                description: "Takes damage over time"
            },
            curse: { 
                name: "Curse", 
                attackReduction: 2, 
                duration: 3, 
                element: "curse",
                description: "Reduces attack power"
            },
            fear: { 
                name: "Fear", 
                defenseReduction: 2, 
                duration: 2, 
                element: "dark",
                description: "Reduces defense"
            },
            decay: {
                name: "Decay",
                damagePerTurn: 3,
                duration: 2,
                element: "necromancy",
                description: "Rapid decomposition"
            }
        },
        lootItems: {
            weapons: [
                { name: "Bone Staff", damage: 3, rarity: "common", type: "weapon" },
                { name: "Soul Reaper", damage: 5, rarity: "rare", type: "weapon" },
                { name: "Necrotic Scepter", damage: 7, rarity: "epic", type: "weapon" },
                { name: "Lich King's Staff", damage: 8, critical: 10, rarity: "legendary", type: "weapon" }
            ],
            armor: [
                { name: "Necromancer Robes", defense: 2, rarity: "common", type: "armor" },
                { name: "Shadow Cloak", defense: 3, rarity: "rare", type: "armor" },
                { name: "Death Knight Armor", defense: 5, rarity: "epic", type: "armor" },
                { name: "Lich King's Armor", defense: 7, health: 20, rarity: "legendary", type: "armor" }
            ],
            potions: [
                { name: "Health Potion", type: "potion", potionType: "health", value: 20, rarity: "common" },
                { name: "Mana Potion", type: "potion", potionType: "mana", value: 15, rarity: "common" },
                { name: "Greater Health Potion", type: "potion", potionType: "health", value: 40, rarity: "rare" },
                { name: "Greater Mana Potion", type: "potion", potionType: "mana", value: 30, rarity: "rare" },
                { name: "Soul Crystal", type: "special", effect: "soul_boost", value: 10, rarity: "epic", description: "+10 souls immediately" },
                { name: "Corpse Dust", type: "special", effect: "corpse_boost", value: 3, rarity: "rare", description: "+3 corpses immediately" },
                { name: "Phoenix Ash", type: "special", effect: "revive", value: 50, rarity: "legendary", description: "Auto-revive with 50% health once" }
            ],
            spells: [
                { name: "Death Coil", damage: 12, cost: 8, rarity: "rare", type: "spell", element: "necromancy" },
                { name: "Army of the Dead", cost: 15, rarity: "epic", type: "spell", element: "necromancy" },
                { name: "Soul Harvest", damage: 20, cost: 15, rarity: "legendary", type: "spell", element: "dark" }
            ]
        },
        shopItems: [
            { name: "Health Potion", cost: 20, type: "potion", item: { name: "Health Potion", type: "potion", potionType: "health", value: 20, rarity: "common" } },
            { name: "Mana Potion", cost: 15, type: "potion", item: { name: "Mana Potion", type: "potion", potionType: "mana", value: 15, rarity: "common" } },
            { name: "Greater Health Potion", cost: 40, type: "potion", item: { name: "Greater Health Potion", type: "potion", potionType: "health", value: 40, rarity: "rare" } },
            { name: "Greater Mana Potion", cost: 35, type: "potion", item: { name: "Greater Mana Potion", type: "potion", potionType: "mana", value: 30, rarity: "rare" } },
            { name: "Soul Crystal", cost: 100, type: "special", item: { name: "Soul Crystal", type: "special", effect: "soul_boost", value: 10, rarity: "epic", description: "+10 souls immediately" } },
            { name: "Corpse Dust", cost: 75, type: "special", item: { name: "Corpse Dust", type: "special", effect: "corpse_boost", value: 3, rarity: "rare", description: "+3 corpses immediately" } }
        ],
        positionModifiers: {
            close: {
                physicalBonus: 1.2,
                spellBonus: 0.8,
                description: "Better for physical attacks"
            },
            medium: {
                physicalBonus: 1.0,
                spellBonus: 1.0,
                description: "Balanced for all attacks"
            },
            far: {
                physicalBonus: 0.8,
                spellBonus: 1.2,
                description: "Better for spell attacks"
            }
        },
        // Game settings
        settings: {
            soundEnabled: true,
            difficultyScaling: {
                enemyHealth: 1.0,
                enemyDamage: 1.0,
                soulReward: 1.0
            }
        },
        // Game statistics
        gameStats: {
            totalBattles: 0,
            victories: 0,
            spellsCast: {},
            minionsRaised: 0,
            soulsCollected: 0,
            playTime: 0
        }
    };

    // ============== AUDIO SYSTEM ==============
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let soundEnabled = true;

    function playSound(frequency, duration, type = 'sine') {
        if (!soundEnabled) return;
        
        try {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        } catch (e) {
            console.log("Audio error:", e);
        }
    }

    const soundEffects = {
        spellCast: () => playSound(600, 0.1),
        minionRaise: () => playSound(300, 0.3, 'sawtooth'),
        damage: () => playSound(200, 0.2),
        heal: () => playSound(800, 0.3, 'sine'),
        victory: () => {
            playSound(500, 0.2);
            setTimeout(() => playSound(400, 0.2), 200);
            setTimeout(() => playSound(300, 0.3), 400);
        },
        defeat: () => {
            playSound(200, 0.3);
            setTimeout(() => playSound(180, 0.3), 300);
            setTimeout(() => playSound(160, 0.4), 600);
        },
        levelUp: () => {
            playSound(800, 0.1);
            setTimeout(() => playSound(1000, 0.1), 100);
            setTimeout(() => playSound(1200, 0.2), 200);
        }
    };

    // ============== SAVE SYSTEM ==============
    function saveGame() {
        const saveData = {
            player: gameState.player,
            achievements: gameState.achievements,
            quests: gameState.quests,
            gameStats: gameState.gameStats,
            souls: gameState.player.souls,
            corpses: gameState.player.corpses,
            timestamp: Date.now()
        };
        localStorage.setItem('necromancerRiseSave', JSON.stringify(saveData));
    }

    function loadGame() {
        const saveData = localStorage.getItem('necromancerRiseSave');
        if (saveData) {
            try {
                const saved = JSON.parse(saveData);
                Object.assign(gameState.player, saved.player);
                Object.assign(gameState.achievements, saved.achievements);
                Object.assign(gameState.quests, saved.quests);
                Object.assign(gameState.gameStats, saved.gameStats);
                
                // Update UI
                updatePlayerProfile();
                updateSoulMastery();
                addToLog("Dark powers restored!");
            } catch (e) {
                console.error("Failed to load save:", e);
                addToLog("Failed to restore dark powers.");
            }
        }
    }

    function autoSave() {
        saveGame();
    }

    // ============== MINION MANAGEMENT SYSTEM ==============

    function raiseMinion(minionType) {
        const minionTemplate = gameState.minionTypes[minionType];
        const cost = minionTemplate.cost;
        
        if (gameState.player.corpses < cost.corpses) {
            addToLog("Not enough corpses to raise this minion!");
            return;
        }
        
        if (gameState.player.souls < cost.souls) {
            addToLog("Not enough souls to raise this minion!");
            return;
        }
        
        if (gameState.player.minions.length >= gameState.player.maxMinions) {
            addToLog("You've reached your maximum minion capacity!");
            return;
        }
        
        // Apply skill modifications
        let finalHealth = minionTemplate.health;
        let finalDefense = minionTemplate.defense;
        
        if (minionTemplate.type === "skeleton") {
            if (gameState.player.skills.skeletal_fortitude) {
                finalHealth += 2;
            }
            if (gameState.player.skills.bone_armor) {
                finalDefense += 1;
            }
        }
        
        if (minionTemplate.type === "zombie" && gameState.player.skills.endless_horde) {
            // This skill reduces corpse cost, applied before the check
        }
        
        // Create the minion
        const minion = {
            ...minionTemplate,
            health: finalHealth,
            maxHealth: finalHealth,
            defense: finalDefense,
            id: Date.now() // Unique identifier
        };
        
        // Pay costs
        gameState.player.corpses -= cost.corpses;
        gameState.player.souls -= cost.souls;
        
        // Add to minion list
        gameState.player.minions.push(minion);
        
        // Update quest progress
        updateQuestProgress('raise_minion');
        gameState.gameStats.minionsRaised++;
        
        addToLog(`You raised a ${minion.name}!`);
        soundEffects.minionRaise();
        
        updatePlayerProfile();
        updateMinionManagement();
        updateActiveMinionsDisplay();
        autoSave();
    }

    function updateMinionManagement() {
        document.getElementById('minion-corpses').textContent = gameState.player.corpses;
        
        Object.keys(gameState.minionTypes).forEach(minionType => {
            const minion = gameState.minionTypes[minionType];
            const minionElement = document.getElementById(`minion-${minionType}`);
            if (!minionElement) return;
            
            const button = minionElement.querySelector('.minion-btn');
            const cost = button.dataset.cost;
            
            if (minion.unlocked === false && !gameState.player.skills[`${minionType}_unlocked`]) {
                // Minion is locked
                minionElement.classList.add('locked');
                button.disabled = true;
                button.textContent = 'Locked';
            } else {
                // Minion is available
                minionElement.classList.remove('locked');
                
                // Check if player has enough resources
                if (gameState.player.corpses >= minion.cost.corpses && 
                    gameState.player.souls >= minion.cost.souls &&
                    gameState.player.minions.length < gameState.player.maxMinions) {
                    button.disabled = false;
                    let costText = `Raise (${minion.cost.corpses} Corpse${minion.cost.corpses > 1 ? 's' : ''}`;
                    if (minion.cost.souls > 0) {
                        costText += ` + ${minion.cost.souls} Souls`;
                    }
                    costText += ")";
                    button.textContent = costText;
                } else {
                    button.disabled = true;
                    let costText = `Raise (${minion.cost.corpses} Corpse${minion.cost.corpses > 1 ? 's' : ''}`;
                    if (minion.cost.souls > 0) {
                        costText += ` + ${minion.cost.souls} Souls`;
                    }
                    costText += ")";
                    button.textContent = costText;
                }
            }
        });
    }

    function updateActiveMinionsDisplay() {
        const activeMinionsElement = document.getElementById('active-minions-list');
        const profileMinionsElement = document.getElementById('player-active-minions');
        const battleMinionsElement = document.getElementById('battle-minions');
        
        if (activeMinionsElement) {
            activeMinionsElement.innerHTML = '';
            
            if (gameState.player.minions.length === 0) {
                activeMinionsElement.innerHTML = '<div class="inventory-empty">No active minions</div>';
            } else {
                gameState.player.minions.forEach((minion, index) => {
                    const minionElement = document.createElement('div');
                    minionElement.className = 'compact-item';
                    
                    minionElement.innerHTML = `
                        <div>
                            <strong>${minion.name}</strong>
                            <div>Health: ${minion.health}/${minion.maxHealth} | Damage: ${minion.damage}</div>
                            <div>Abilities: ${minion.abilities.join(', ')}</div>
                        </div>
                        <div class="compact-actions">
                            <button class="compact-action-btn" onclick="dismissMinion(${index})">Dismiss</button>
                        </div>
                    `;
                    
                    activeMinionsElement.appendChild(minionElement);
                });
            }
        }
        
        if (profileMinionsElement) {
            profileMinionsElement.innerHTML = '';
            
            if (gameState.player.minions.length === 0) {
                profileMinionsElement.innerHTML = '<div class="inventory-empty">No active minions</div>';
            } else {
                gameState.player.minions.forEach(minion => {
                    const minionElement = document.createElement('div');
                    minionElement.className = 'compact-item';
                    
                    minionElement.innerHTML = `
                        <div>
                            <strong>${minion.name}</strong>
                            <div>Health: ${minion.health}/${minion.maxHealth} | Damage: ${minion.damage}</div>
                        </div>
                    `;
                    
                    profileMinionsElement.appendChild(minionElement);
                });
            }
        }
        
        if (battleMinionsElement) {
            battleMinionsElement.innerHTML = '';
            
            if (gameState.player.minions.length === 0) {
                // Don't show anything if no minions in battle
            } else {
                gameState.player.minions.forEach((minion, index) => {
                    const minionElement = document.createElement('div');
                    minionElement.className = 'minion';
                    
                    const healthPercent = (minion.health / minion.maxHealth) * 100;
                    
                    minionElement.innerHTML = `
                        <button class="minion-battle-btn" data-minion="${index}">
                            <div>${minion.name}</div>
                            <div>Health: ${minion.health}/${minion.maxHealth}</div>
                            <div class="health-bar">
                                <div class="health-fill" style="width: ${healthPercent}%;"></div>
                            </div>
                        </button>
                    `;
                    
                    battleMinionsElement.appendChild(minionElement);
                });
                
                // Add event listeners to minion battle buttons
                document.querySelectorAll('.minion-battle-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const minionIndex = parseInt(btn.dataset.minion);
                        commandMinion(minionIndex);
                    });
                });
            }
        }
    }

    function dismissMinion(index) {
        const minion = gameState.player.minions[index];
        addToLog(`You dismissed your ${minion.name}.`);
        gameState.player.minions.splice(index, 1);
        updateActiveMinionsDisplay();
        updateMinionManagement();
        autoSave();
    }

    function commandMinion(minionIndex) {
        const minion = gameState.player.minions[minionIndex];
        if (!minion || minion.health <= 0) return;
        
        const damage = minion.damage;
        gameState.currentEnemy.health -= damage;
        
        document.getElementById('battle-enemy-health').textContent = gameState.currentEnemy.health;
        document.getElementById('enemy-health-fill').style.width = 
            `${(gameState.currentEnemy.health / gameState.currentEnemy.maxHealth) * 100}%`;
        
        addToLog(`${minion.name} attacks and deals ${damage} damage!`);
        soundEffects.damage();
        
        // Special minion abilities
        if (minion.type === "zombie" && Math.random() < 0.3) {
            applyStatusEffect(gameState.currentEnemy, "poison");
            addToLog(`${minion.name} poisons the enemy!`);
        }
        
        if (minion.type === "ghost" && Math.random() < 0.2) {
            const manaDrain = 3;
            gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + manaDrain);
            document.getElementById('battle-player-mana').textContent = gameState.player.mana;
            document.getElementById('player-mana-fill').style.width = 
                `${(gameState.player.mana / gameState.player.maxMana) * 100}%`;
            addToLog(`${minion.name} drains ${manaDrain} mana from the enemy!`);
        }
        
        if (gameState.currentEnemy.health <= 0) {
            endBattle(true);
            return;
        }
        
        setTimeout(enemyTurn, 1000);
    }

    // ============== GRAVEYARD SYSTEM ==============

    function updateGraveyard() {
        document.getElementById('graveyard-corpses').textContent = gameState.player.corpses;
        document.getElementById('total-corpses').textContent = gameState.player.corpses;
        document.getElementById('fresh-corpses').textContent = Math.floor(gameState.player.corpses * 0.7);
        document.getElementById('decaying-corpses').textContent = Math.floor(gameState.player.corpses * 0.3);
        
        const recentCorpsesElement = document.getElementById('recent-corpses');
        recentCorpsesElement.innerHTML = '';
        
        // Show recent corpse additions (simulated)
        if (gameState.player.corpses > 0) {
            const recentCount = Math.min(5, gameState.player.corpses);
            for (let i = 0; i < recentCount; i++) {
                const corpseElement = document.createElement('div');
                corpseElement.className = 'compact-item';
                corpseElement.textContent = `Fresh Corpse ${i + 1}`;
                recentCorpsesElement.appendChild(corpseElement);
            }
        } else {
            recentCorpsesElement.innerHTML = '<div class="inventory-empty">No recent corpses</div>';
        }
    }

    function performRitual(ritualType) {
        const ritualCosts = {
            gather_corpses: { mana: 10, corpses: 0 },
            preserve_corpses: { mana: 15, corpses: 0 },
            mass_raise: { mana: 25, corpses: 5 }
        };
        
        const cost = ritualCosts[ritualType];
        
        if (gameState.player.mana < cost.mana) {
            addToLog("Not enough mana for this ritual!");
            return;
        }
        
        if (gameState.player.corpses < cost.corpses) {
            addToLog("Not enough corpses for this ritual!");
            return;
        }
        
        gameState.player.mana -= cost.mana;
        gameState.player.corpses -= cost.corpses;
        
        switch(ritualType) {
            case 'gather_corpses':
                const gathered = 3 + Math.floor(Math.random() * 3);
                gameState.player.corpses += gathered;
                addToLog(`You gathered ${gathered} fresh corpses from the graveyard!`);
                break;
            case 'preserve_corpses':
                addToLog("You preserved your corpses, preventing decay!");
                // In a full implementation, this would prevent corpse loss over time
                break;
            case 'mass_raise':
                // Try to raise as many skeletons as possible with available corpses
                const skeletonsToRaise = Math.min(3, Math.floor(gameState.player.corpses / 1));
                for (let i = 0; i < skeletonsToRaise && gameState.player.minions.length < gameState.player.maxMinions; i++) {
                    raiseMinion('skeleton');
                }
                addToLog(`You raised ${skeletonsToRaise} skeletons in a mass ritual!`);
                break;
        }
        
        updatePlayerProfile();
        updateGraveyard();
        updateMinionManagement();
        autoSave();
    }

    // ============== SOUL MASTERY SYSTEM ==============

    function applySoulMasteryEffect(skillId) {
        const p = gameState.player;
        
        switch(skillId) {
            case 'skeletal_fortitude':
                // This skill is applied when raising skeletons
                addToLog("Skeletons now have +2 health!");
                break;
            case 'bone_armor':
                // This skill is applied when raising skeletons
                addToLog("Skeletons now have +1 defense!");
                break;
            case 'plague_bearer':
                // This skill increases zombie poison chance
                addToLog("Zombies now poison enemies more often!");
                break;
            case 'endless_horde':
                // This skill reduces zombie corpse cost
                addToLog("Zombies now cost 1 less corpse to raise!");
                break;
            case 'ethereal_form':
                // This skill is applied when raising ghosts
                addToLog("Ghosts now take 25% less physical damage!");
                break;
            case 'soul_drain':
                // This skill enhances ghost mana drain
                addToLog("Ghosts now restore your mana on attack!");
                break;
            case 'dark_efficiency':
                // This skill is applied in calculateManaCost
                addToLog("All spells now cost 1 less mana!");
                break;
            case 'soul_harvest':
                p.soulHarvestBonus = 1.1; // 10% more souls
                addToLog("You now gain 10% more souls from defeated enemies!");
                break;
        }
        
        updatePlayerProfile();
    }

    function updateSoulMastery() {
        document.getElementById('available-soul-points').textContent = gameState.player.soulPoints;
        
        Object.keys(gameState.player.skills).forEach(skillId => {
            const skillElement = document.getElementById(`skill-${skillId.replace('_', '-')}`);
            if (!skillElement) return;
            
            const button = skillElement.querySelector('.skill-btn');
            const cost = parseInt(button.dataset.cost);
            
            if (gameState.player.skills[skillId]) {
                // Skill is already learned
                skillElement.classList.add('unlocked');
                skillElement.classList.remove('locked');
                button.textContent = 'âœ“ Learned';
                button.disabled = true;
                button.style.backgroundColor = '#0a0';
                button.style.color = '#000';
            } else {
                // Skill is not learned yet
                skillElement.classList.remove('unlocked');
                skillElement.classList.add('locked');
                
                // Check if player has enough points and meets requirements
                if (gameState.player.soulPoints >= cost) {
                    button.disabled = false;
                    button.textContent = `Learn (${cost} point${cost > 1 ? 's' : ''})`;
                    button.style.backgroundColor = '';
                    button.style.color = '';
                } else {
                    button.disabled = true;
                    button.textContent = `Learn (${cost} point${cost > 1 ? 's' : ''})`;
                    button.style.backgroundColor = '';
                    button.style.color = '';
                }
            }
        });
    }

    function learnSkill(skillId) {
        const button = document.querySelector(`[data-skill="${skillId}"]`);
        const cost = parseInt(button.dataset.cost);
        
        if (gameState.player.soulPoints < cost) {
            addToLog("Not enough soul points!");
            soundEffects.damage(); // Error sound
            return;
        }
        
        gameState.player.soulPoints -= cost;
        gameState.player.skills[skillId] = true;
        
        applySoulMasteryEffect(skillId);
        
        addToLog(`Learned soul mastery: ${formatSkillName(skillId)}!`);
        soundEffects.levelUp(); // Success sound
        
        // Update achievements
        const learnedSkills = Object.values(gameState.player.skills).filter(s => s).length;
        if (learnedSkills >= 5 && !gameState.achievements.skill_master.unlocked) {
            unlockAchievement('skill_master');
        }
        
        updatePlayerProfile();
        updateSoulMastery();
        autoSave();
    }

    function formatSkillName(skillId) {
        return skillId.replace(/_/g, ' ')
            .split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }

    function awardSoulPoints(amount = 1) {
        gameState.player.soulPoints += amount;
        addToLog(`You gained ${amount} soul point${amount > 1 ? 's' : ''}!`);
        updatePlayerProfile();
        updateSoulMastery();
        
        // Show notification
        const notification = document.createElement('div');
        notification.className = 'achievement-notification';
        notification.innerHTML = `
            <h3>Soul Point Earned!</h3>
            <p>You now have ${gameState.player.soulPoints} soul point${gameState.player.soulPoints > 1 ? 's' : ''} available.</p>
            <p>Visit Soul Mastery to learn new dark powers!</p>
            <button onclick="this.parentElement.remove(); showScreen('skillTree')">Go to Soul Mastery</button>
            <button onclick="this.parentElement.remove()">Continue</button>
        `;
        document.body.appendChild(notification);
    }

    function resetSoulMastery() {
        if (confirm("Reset your soul mastery? This will refund all spent soul points but you'll need to relearn skills.")) {
            // Count how many skills were learned
            const learnedSkills = Object.values(gameState.player.skills).filter(s => s).length;
            
            // Refund points
            gameState.player.soulPoints += learnedSkills;
            
            // Reset all skills
            Object.keys(gameState.player.skills).forEach(skillId => {
                gameState.player.skills[skillId] = false;
            });
            
            // Reset player stats that were modified by skills
            if (gameState.player.soulHarvestBonus) {
                delete gameState.player.soulHarvestBonus;
            }
            
            addToLog(`Soul mastery reset! ${learnedSkills} soul points refunded.`);
            updatePlayerProfile();
            updateSoulMastery();
            autoSave();
        }
    }

    // ============== QUEST SYSTEM ==============
    function updateQuestProgress(questType, data = null) {
        Object.keys(gameState.quests).forEach(questId => {
            const quest = gameState.quests[questId];
            if (quest.completed) return;
            
            switch(quest.type) {
                case 'defeat_enemies':
                    if (questType === 'defeat_enemy') {
                        quest.progress++;
                        if (quest.progress >= quest.target) {
                            completeQuest(questId);
                        }
                    }
                    break;
                case 'raise_minions':
                    if (questType === 'raise_minion') {
                        quest.progress++;
                        if (quest.progress >= quest.target) {
                            completeQuest(questId);
                        }
                    }
                    break;
                case 'collect_corpses':
                    if (questType === 'collect_corpses') {
                        quest.progress = gameState.player.corpses;
                        if (quest.progress >= quest.target) {
                            completeQuest(questId);
                        }
                    }
                    break;
            }
        });
        
        updateQuestsScreen();
    }

    function completeQuest(questId) {
        const quest = gameState.quests[questId];
        quest.completed = true;
        
        // Apply rewards
        if (quest.reward.souls) {
            gameState.player.souls += quest.reward.souls;
            addToLog(`Quest completed! Received ${quest.reward.souls} souls.`);
        }
        if (quest.reward.xp) {
            gameState.player.xp += quest.reward.xp;
            addToLog(`Quest completed! Received ${quest.reward.xp} XP.`);
        }
        if (quest.reward.soulPoint) {
            awardSoulPoints(quest.reward.soulPoint);
        }
        
        updatePlayerProfile();
    }

    function updateQuestsScreen() {
        const questsList = document.getElementById('quests-list');
        if (!questsList) return;
        
        questsList.innerHTML = '';
        
        Object.keys(gameState.quests).forEach(questId => {
            const quest = gameState.quests[questId];
            const questElement = document.createElement('div');
            questElement.className = `quest-item ${quest.completed ? 'quest-completed' : ''}`;
            
            let progressHtml = '';
            if (quest.type === 'collect_corpses') {
                progressHtml = `
                    <div>Progress: ${quest.progress}/${quest.target}</div>
                    <div class="quest-progress">
                        <div class="quest-progress-fill" style="width: ${(quest.progress / quest.target) * 100}%"></div>
                    </div>
                `;
            } else {
                progressHtml = `
                    <div>Progress: ${quest.progress}/${quest.target}</div>
                    <div class="quest-progress">
                        <div class="quest-progress-fill" style="width: ${(quest.progress / quest.target) * 100}%"></div>
                    </div>
                `;
            }
            
            questElement.innerHTML = `
                <h3>${quest.name}</h3>
                <p>${quest.description}</p>
                ${progressHtml}
                <p><strong>Status: ${quest.completed ? 'COMPLETED' : 'IN PROGRESS'}</strong></p>
            `;
            
            questsList.appendChild(questElement);
        });
    }

    // ============== QUICK PLAY SYSTEM ==============
    function quickPlay() {
        // Select an appropriate enemy based on player level
        let availableEnemies = [];
        
        if (gameState.player.level <= 2) {
            availableEnemies = ['militia'];
        } else if (gameState.player.level <= 4) {
            availableEnemies = ['militia', 'priest'];
        } else if (gameState.player.level <= 6) {
            availableEnemies = ['priest', 'knight'];
        } else if (gameState.player.level <= 8) {
            availableEnemies = ['knight', 'inquisitor'];
        } else {
            availableEnemies = ['inquisitor', 'paladin'];
        }
        
        const randomEnemy = availableEnemies[Math.floor(Math.random() * availableEnemies.length)];
        startBattle(randomEnemy);
    }

    // ============== REST SYSTEM ==============
    function rest() {
        const manaRestore = Math.floor(gameState.player.maxMana * 0.5);
        const healthRestore = Math.floor(gameState.player.maxHealth * 0.25);
        const corpseGather = 2 + Math.floor(Math.random() * 3);
        
        gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + manaRestore);
        gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + healthRestore);
        gameState.player.corpses += corpseGather;
        
        // Clear status effects
        gameState.player.statusEffects = [];
        
        addToLog(`You rest in your dark sanctuary and recover ${manaRestore} mana, ${healthRestore} health, and gather ${corpseGather} corpses.`);
        updatePlayerProfile();
        showScreen('main-menu');
    }

    // ============== BATTLE SYSTEM ==============

    
      function castSpell(spellIndex) {
    const spell = gameState.player.spells[spellIndex];
    
    if (spell.cooldown > 0) {
        addToLog(`${spell.name} is on cooldown for ${spell.cooldown} more turns!`);
        return;
    }
    
    const manaCost = calculateManaCost(spell.cost, spell.element);
    
    if (gameState.player.mana < manaCost) {
        addToLog("Not enough mana!");
        return;
    }
    
    // Check for corpse requirement
    if (spell.requiresCorpse && gameState.player.availableCorpses < 1) {
        addToLog("You need at least 1 corpse to cast this spell!");
        return;
    }
    
    gameState.player.mana -= manaCost;
    document.getElementById('battle-player-mana').textContent = gameState.player.mana;
    document.getElementById('player-mana-fill').style.width = 
        `${(gameState.player.mana / gameState.player.maxMana) * 100}%`;
    
    if (spell.maxCooldown > 0) {
        spell.cooldown = spell.maxCooldown;
    }
    
    // Track spell usage for quests
    if (spell.element) {
        gameState.gameStats.spellsCast[spell.element] = (gameState.gameStats.spellsCast[spell.element] || 0) + 1;
    }
    
    updateComboCounter(spell.element);
    soundEffects.spellCast();
    
    if (spell.name === "Life Drain") {
        const healAmount = Math.min(
            spell.heal, 
            gameState.player.maxHealth - gameState.player.health
        );
        const damage = Math.max(1, spell.damage + gameState.player.attack - gameState.currentEnemy.defense);
        
        gameState.player.health += healAmount;
        gameState.currentEnemy.health -= damage;
        
        document.getElementById('battle-player-health').textContent = gameState.player.health;
        document.getElementById('player-health-fill').style.width = 
            `${(gameState.player.health / gameState.player.maxHealth) * 100}%`;
        document.getElementById('battle-enemy-health').textContent = gameState.currentEnemy.health;
        document.getElementById('enemy-health-fill').style.width = 
            `${(gameState.currentEnemy.health / gameState.currentEnemy.maxHealth) * 100}%`;
            
        addToLog(`You cast ${spell.name}, dealing ${damage} damage and healing ${healAmount} health.`);
        soundEffects.heal();
        soundEffects.damage();
    } 
    else if (spell.name === "Raise Dead") {
        // Use a corpse to instantly raise a skeleton in battle
        gameState.player.availableCorpses--;
        
        if (gameState.player.minions.length < gameState.player.maxMinions) {
            raiseMinion('skeleton');
            addToLog(`You use a corpse to instantly raise a skeleton!`);
        } else {
            addToLog("You can't raise more minions - at capacity!");
            // Refund the mana since we didn't actually cast the spell
            gameState.player.mana += manaCost;
        }
    }
    else if (spell.name === "Curse of Weakness") {
        applyStatusEffect(gameState.currentEnemy, spell.statusEffect);
        addToLog(`You cast ${spell.name}, weakening the enemy!`);
    }
    else {
        // Standard damage spell - FIXED SECTION
        const totalAttack = gameState.player.attack + (gameState.player.equipment.weapon ? gameState.player.equipment.weapon.damage : 0);
        const isCritical = calculateCriticalStrike();
        
        // Calculate base damage (spell damage + player attack - enemy defense)
        let baseDamage = spell.damage + totalAttack - gameState.currentEnemy.defense;
        baseDamage = Math.max(1, baseDamage); // Ensure at least 1 damage
        
        // Apply critical hit if applicable
        const damage = isCritical ? Math.floor(baseDamage * 1.5) : baseDamage;
        
        // Apply damage to enemy
        gameState.currentEnemy.health -= damage;
        
        // Update enemy health display
        document.getElementById('battle-enemy-health').textContent = Math.max(0, gameState.currentEnemy.health);
        document.getElementById('enemy-health-fill').style.width = 
            `${(Math.max(0, gameState.currentEnemy.health) / gameState.currentEnemy.maxHealth) * 100}%`;
        
        let logMessage = `You cast ${spell.name} and deal ${damage} damage.`;
        
        if (isCritical) {
            logMessage += ` <span class="critical-hit">CRITICAL HIT!</span>`;
            soundEffects.damage();
        }
        
        addToLog(logMessage);
        soundEffects.damage();
        
        // Apply status effect if applicable
        if (spell.statusEffect && Math.random() < 0.3) {
            let duration = gameState.statusEffects[spell.statusEffect].duration;
            applyStatusEffect(gameState.currentEnemy, spell.statusEffect, duration);
        }
    }
    
    updateSpellButtons();
    
    // Check if enemy is defeated
    if (gameState.currentEnemy.health <= 0) {
        endBattle(true);
        return;
    }
    
    // Enemy's turn
    setTimeout(enemyTurn, 1000);
}  

    function calculateManaCost(baseCost, element = null) {
        let cost = baseCost;
        
        // Apply dark efficiency skill (reduces all spell costs)
        if (gameState.player.skills.dark_efficiency) {
            cost = Math.max(1, cost - 1);
        }
        
        return cost;
    }

    function calculateCriticalStrike() {
        const criticalChance = gameState.player.critical;
        return Math.random() * 100 < criticalChance;
    }

    
        function enemyTurn() {
    processStatusEffects(gameState.currentEnemy);
    
    const spell = getEnemyAction();
    
    if (!spell) {
        // Enemy uses physical attack when no spells available
        const damage = Math.max(1, Math.floor(
            gameState.currentEnemy.attack - gameState.player.defense
        ));
        gameState.player.health -= damage;
        document.getElementById('battle-player-health').textContent = gameState.player.health;
        document.getElementById('player-health-fill').style.width = 
            `${(gameState.player.health / gameState.player.maxHealth) * 100}%`;
        addToLog(`${gameState.currentEnemy.name} attacks and deals ${damage} damage.`);
        soundEffects.damage();
    } else {
        // Enemy casts spell if they have enough mana
        if (gameState.currentEnemy.mana >= spell.cost) {
            gameState.currentEnemy.mana -= spell.cost;
            document.getElementById('battle-enemy-mana').textContent = gameState.currentEnemy.mana;
            document.getElementById('enemy-mana-fill').style.width = 
                `${(gameState.currentEnemy.mana / gameState.currentEnemy.maxMana) * 100}%`;
            
            if (spell.heal) {
                const healAmount = Math.min(spell.heal, gameState.currentEnemy.maxHealth - gameState.currentEnemy.health);
                gameState.currentEnemy.health += healAmount;
                document.getElementById('battle-enemy-health').textContent = gameState.currentEnemy.health;
                document.getElementById('enemy-health-fill').style.width = 
                    `${(gameState.currentEnemy.health / gameState.currentEnemy.maxHealth) * 100}%`;
                addToLog(`${gameState.currentEnemy.name} casts ${spell.name} and heals ${healAmount} health.`);
            } else if (spell.defense) {
                applyStatusEffect(gameState.currentEnemy, "defense_buff", spell.duration);
                addToLog(`${gameState.currentEnemy.name} casts ${spell.name} and gains +${spell.defense} defense.`);
            } else {
                // Check for bonus vs undead
                let bonusMultiplier = 1;
                if (spell.bonusVsUndead && gameState.player.minions.length > 0) {
                    bonusMultiplier = 1.5;
                    addToLog(`${spell.name} is especially effective against undead!`);
                }
                
                const damage = Math.max(1, Math.floor(
                    (spell.damage + gameState.currentEnemy.attack - gameState.player.defense) * bonusMultiplier
                ));
                gameState.player.health -= damage;
                document.getElementById('battle-player-health').textContent = gameState.player.health;
                document.getElementById('player-health-fill').style.width = 
                    `${(gameState.player.health / gameState.player.maxHealth) * 100}%`;
                addToLog(`${gameState.currentEnemy.name} casts ${spell.name} and deals ${damage} damage.`);
                soundEffects.damage();
                
                if (spell.stun) {
                    // Skip player's next turn
                    addToLog("You are stunned and will miss your next turn!");
                    // In a full implementation, this would set a flag to skip the next player turn
                }
                
                if (spell.removesStatus) {
                    // Remove status effects from enemy
                    gameState.currentEnemy.statusEffects = [];
                    addToLog("The enemy's status effects are purged!");
                }
            }
        } else {
            // Enemy doesn't have enough mana for spell, use physical attack instead
            const damage = Math.max(1, Math.floor(
                gameState.currentEnemy.attack - gameState.player.defense
            ));
            gameState.player.health -= damage;
            document.getElementById('battle-player-health').textContent = gameState.player.health;
            document.getElementById('player-health-fill').style.width = 
                `${(gameState.player.health / gameState.player.maxHealth) * 100}%`;
            addToLog(`${gameState.currentEnemy.name} attacks and deals ${damage} damage.`);
            soundEffects.damage();
        }
    }
    
    // Minions also take damage in enemy turns (simplified)
    if (gameState.player.minions.length > 0 && Math.random() < 0.5) {
        const randomMinionIndex = Math.floor(Math.random() * gameState.player.minions.length);
        const minion = gameState.player.minions[randomMinionIndex];
        const minionDamage = Math.max(1, Math.floor(gameState.currentEnemy.attack * 0.5 - minion.defense));
        
        minion.health -= minionDamage;
        addToLog(`${gameState.currentEnemy.name} attacks your ${minion.name} for ${minionDamage} damage!`);
        
        // Remove dead minions
        if (minion.health <= 0) {
            addToLog(`Your ${minion.name} has been destroyed!`);
            gameState.player.minions.splice(randomMinionIndex, 1);
        }
        
        updateActiveMinionsDisplay();
    }
    
    if (gameState.player.health <= 0) {
        endBattle(false);
    } else {
        processStatusEffects(gameState.player);
        reduceCooldowns();
        updateSpellButtons();
    }
}
            

    function getEnemyAction() {
        const enemy = gameState.currentEnemy;
        const affordableSpells = enemy.spells.filter(spell => 
            enemy.mana >= (spell.cost || 0)
        );
        
        switch(enemy.aiBehavior) {
            case "aggressive":
                return getAggressiveAction(affordableSpells);
            case "defensive":
                return getDefensiveAction(affordableSpells);
            case "supportive":
                return getSupportiveAction(affordableSpells);
            case "tactical":
                return getTacticalAction(affordableSpells);
            case "adaptive":
                return getAdaptiveAction(affordableSpells);
            default:
                return getDefaultAction(affordableSpells);
        }
    }

    function getAggressiveAction(spells) {
        const damageSpells = spells.filter(s => s.damage);
        if (damageSpells.length > 0) {
            return damageSpells.reduce((max, spell) => 
                spell.damage > max.damage ? spell : max
            );
        }
        return spells[0] || null;
    }

    function getDefensiveAction(spells) {
        if (gameState.currentEnemy.health < gameState.currentEnemy.maxHealth * 0.5) {
            const healSpells = spells.filter(s => s.heal);
            if (healSpells.length > 0) return healSpells[0];
            
            const defenseSpells = spells.filter(s => s.defense);
            if (defenseSpells.length > 0) return defenseSpells[0];
        }
        
        return spells[0] || null;
    }

    function getSupportiveAction(spells) {
        const playerHealthPercent = gameState.player.health / gameState.player.maxHealth;
        const enemyHealthPercent = gameState.currentEnemy.health / gameState.currentEnemy.maxHealth;
        
        if (enemyHealthPercent < 0.6) {
            const healSpells = spells.filter(s => s.heal);
            if (healSpells.length > 0) return healSpells[0];
        }
        
        if (playerHealthPercent > 0.7) {
            const damageSpells = spells.filter(s => s.damage);
            if (damageSpells.length > 0) return damageSpells[0];
        }
        
        return spells[Math.floor(Math.random() * spells.length)] || null;
    }

    function getTacticalAction(spells) {
        const playerHealthPercent = gameState.player.health / gameState.player.maxHealth;
        const enemyHealthPercent = gameState.currentEnemy.health / gameState.currentEnemy.maxHealth;
        
        if (enemyHealthPercent < 0.3) {
            const healSpells = spells.filter(s => s.heal);
            if (healSpells.length > 0) return healSpells[0];
        }
        
        if (playerHealthPercent < 0.3) {
            const finishingSpells = spells.filter(s => s.damage > 8);
            if (finishingSpells.length > 0) return finishingSpells[0];
        }
        
        // Use spells that are effective against undead if player has minions
        if (gameState.player.minions.length > 0) {
            const antiUndeadSpells = spells.filter(s => s.bonusVsUndead);
            if (antiUndeadSpells.length > 0) return antiUndeadSpells[0];
        }
        
        return spells[Math.floor(Math.random() * spells.length)] || null;
    }

    function getAdaptiveAction(spells) {
        if (gameState.player.minions.length > 2) {
            const areaSpells = spells.filter(s => s.area);
            if (areaSpells.length > 0) return areaSpells[0];
        }
        
        return getTacticalAction(spells);
    }

    function getDefaultAction(spells) {
        return spells[0] || null;
    }

    function applyStatusEffect(target, effectType, duration = null) {
        const effect = gameState.statusEffects[effectType];
        if (!effect) return;
        
        let finalDuration = duration || effect.duration;
        
        const existingEffect = target.statusEffects.find(e => e.type === effectType);
        if (existingEffect) {
            existingEffect.duration = finalDuration;
        } else {
            target.statusEffects.push({
                type: effectType,
                duration: finalDuration,
                ...effect
            });
        }
        
        updateStatusEffectsDisplay();
    }

    function processStatusEffects(target) {
        if (!target.statusEffects || target.statusEffects.length === 0) return;
        
        const effectsToRemove = [];
        
        target.statusEffects.forEach((effect, index) => {
            if (effect.damagePerTurn) {
                target.health -= effect.damagePerTurn;
                addToLog(`${target.name} takes ${effect.damagePerTurn} damage from ${effect.name}!`);
            }
            
            if (effect.attackReduction) {
                // This would reduce attack power for the turn
                addToLog(`${target.name}'s attack is reduced by ${effect.attackReduction} from ${effect.name}!`);
            }
            
            if (effect.defenseReduction) {
                // This would reduce defense for the turn
                addToLog(`${target.name}'s defense is reduced by ${effect.defenseReduction} from ${effect.name}!`);
            }
            
            effect.duration--;
            
            if (effect.duration <= 0) {
                effectsToRemove.push(index);
                addToLog(`${effect.name} wears off from ${target.name}.`);
            }
        });
        
        effectsToRemove.reverse().forEach(index => {
            target.statusEffects.splice(index, 1);
        });
        
        updateStatusEffectsDisplay();
    }

    function updateStatusEffectsDisplay() {
        const playerEffectsElement = document.getElementById('player-status-effects');
        const playerBattleEffectsElement = document.getElementById('player-status-effects-battle');
        const enemyEffectsElement = document.getElementById('enemy-status-effects');
        
        if (playerEffectsElement) playerEffectsElement.innerHTML = '';
        if (playerBattleEffectsElement) playerBattleEffectsElement.innerHTML = '';
        if (enemyEffectsElement) enemyEffectsElement.innerHTML = '';
        
        gameState.player.statusEffects.forEach(effect => {
            const effectElement = document.createElement('span');
            effectElement.className = `status-effect status-${effect.type}`;
            effectElement.textContent = effect.name;
            effectElement.title = effect.description;
            
            if (playerEffectsElement) playerEffectsElement.appendChild(effectElement);
            if (playerBattleEffectsElement) playerBattleEffectsElement.appendChild(effectElement.cloneNode(true));
        });
        
        if (gameState.currentEnemy && gameState.currentEnemy.statusEffects) {
            gameState.currentEnemy.statusEffects.forEach(effect => {
                const effectElement = document.createElement('span');
                effectElement.className = `status-effect status-${effect.type}`;
                effectElement.textContent = effect.name;
                effectElement.title = effect.description;
                
                if (enemyEffectsElement) enemyEffectsElement.appendChild(effectElement);
            });
        }
    }

    function updateComboCounter(spellElement) {
        if (gameState.player.lastSpellElement === spellElement) {
            gameState.player.comboCount++;
        } else {
            gameState.player.comboCount = 1;
        }
        gameState.player.lastSpellElement = spellElement;
        
        if (gameState.player.comboCount >= 5 && !gameState.achievements.combo_master.unlocked) {
            unlockAchievement('combo_master');
        }
        
        updateComboDisplay();
    }

    function updateComboDisplay() {
        const comboCounterMain = document.getElementById('combo-counter-main');
        const comboCounterBattle = document.getElementById('combo-counter-battle');
        
        if (gameState.player.comboCount > 1) {
            const comboText = `Dark Combo: x${gameState.player.comboCount}`;
            if (comboCounterMain) {
                comboCounterMain.textContent = comboText;
                comboCounterMain.style.display = 'block';
            }
            if (comboCounterBattle) {
                comboCounterBattle.textContent = comboText;
                comboCounterBattle.style.display = 'block';
            }
        } else {
            if (comboCounterMain) comboCounterMain.style.display = 'none';
            if (comboCounterBattle) comboCounterBattle.style.display = 'none';
        }
    }

    function reduceCooldowns() {
        gameState.player.spells.forEach(spell => {
            if (spell.cooldown > 0) {
                spell.cooldown--;
            }
        });
    }

    function updateSpellButtons() {
        const spellButtons = document.querySelectorAll('.spell-btn');
        const manaWarning = document.getElementById('mana-warning');
        const healthWarning = document.getElementById('health-warning');
        let hasEnoughMana = false;
        
        spellButtons.forEach(button => {
            const spellIndex = parseInt(button.dataset.spell);
            const spell = gameState.player.spells[spellIndex];
            
            const manaCost = calculateManaCost(spell.cost, spell.element);
            
            let canCast = gameState.player.mana >= manaCost && spell.cooldown === 0;
            
            // Check for corpse requirement
            if (spell.requiresCorpse && gameState.player.availableCorpses < 1) {
                canCast = false;
            }
            
            if (canCast) {
                button.disabled = false;
                hasEnoughMana = true;
                
                if (spell.cooldown > 0) {
                    button.textContent = `${spell.name} (CD: ${spell.cooldown})`;
                } else {
                    button.textContent = `${spell.name} (${manaCost} MP)`;
                }
            } else {
                button.disabled = true;
                if (spell.cooldown > 0) {
                    button.textContent = `${spell.name} (CD: ${spell.cooldown})`;
                } else {
                    button.textContent = `${spell.name} (${manaCost} MP)`;
                }
            }
        });
        
        manaWarning.style.display = !hasEnoughMana && gameState.player.mana > 0 ? 'block' : 'none';
        healthWarning.style.display = gameState.player.health <= gameState.player.maxHealth * 0.3 ? 'block' : 'none';
    }

    function startBattle(enemyType) {
    gameState.currentEnemy = JSON.parse(JSON.stringify(gameState.enemies[enemyType]));
    gameState.currentEnemy.statusEffects = [];
    
    // Set available corpses for battle (can be used for Raise Dead)
    gameState.player.availableCorpses = Math.min(3, gameState.player.corpses);
    
    document.getElementById('enemy-name').textContent = gameState.currentEnemy.name;
    document.getElementById('enemy-ai-behavior').textContent = `AI: ${gameState.currentEnemy.aiBehavior.charAt(0).toUpperCase() + gameState.currentEnemy.aiBehavior.slice(1)}`;
    document.getElementById('enemy-ascii').textContent = gameState.currentEnemy.ascii;
    document.getElementById('battle-enemy-health').textContent = gameState.currentEnemy.health;
    document.getElementById('battle-enemy-max-health').textContent = gameState.currentEnemy.maxHealth;
    document.getElementById('battle-enemy-mana').textContent = gameState.currentEnemy.mana;
    document.getElementById('battle-enemy-max-mana').textContent = gameState.currentEnemy.maxMana;
    
    document.getElementById('battle-player-health').textContent = gameState.player.health;
    document.getElementById('battle-player-max-health').textContent = gameState.player.maxHealth;
    document.getElementById('battle-player-mana').textContent = gameState.player.mana;
    document.getElementById('battle-player-max-mana').textContent = gameState.player.maxMana;
    
    document.getElementById('player-health-fill').style.width = `${(gameState.player.health / gameState.player.maxHealth) * 100}%`;
    document.getElementById('player-mana-fill').style.width = `${(gameState.player.mana / gameState.player.maxMana) * 100}%`;
    document.getElementById('enemy-health-fill').style.width = '100%';
    document.getElementById('enemy-mana-fill').style.width = '100%';
    
    gameState.battleLog = ["The dead rise to serve you!"];
    updateBattleLog();
    
    updateSpellButtons();
    updateActiveMinionsDisplay();
    updateStatusEffectsDisplay();
    updateComboDisplay();
    
    showScreen('battle');
}

    function endBattle(playerWon) {
        gameState.gameStats.totalBattles++;
        
        if (playerWon) {
            gameState.gameStats.victories++;
            addToLog(`You defeated ${gameState.currentEnemy.name}!`);
            
            const xpReward = gameState.currentEnemy.xpReward;
            let soulReward = gameState.currentEnemy.soulReward;
            const corpseReward = gameState.currentEnemy.corpseReward;
            
            // Apply soul harvest skill bonus
            if (gameState.player.soulHarvestBonus) {
                soulReward = Math.floor(soulReward * gameState.player.soulHarvestBonus);
            }
            
            gameState.currentXpReward = xpReward;
            gameState.currentSoulReward = soulReward;
            gameState.currentCorpseReward = corpseReward;
            
            gameState.player.xp += xpReward;
            gameState.player.souls += soulReward;
            gameState.player.corpses += corpseReward;
            gameState.gameStats.soulsCollected += soulReward;
            
            // Enhanced soul point chance - scales with enemy difficulty
            const soulPointChance = 0.1 + (gameState.currentEnemy.level * 0.02); // 10% base + 2% per enemy level
            if (Math.random() < soulPointChance) {
                awardSoulPoints(1);
            }
            
            addToLog(`You gained ${xpReward} XP, ${soulReward} souls, and ${corpseReward} corpses!`);
            
            // Update quests
            updateQuestProgress('defeat_enemy');
            
            if (!gameState.achievements.first_blood.unlocked) {
                unlockAchievement('first_blood');
            }
            
            if (gameState.player.souls >= 1000 && !gameState.achievements.soul_collector.unlocked) {
                unlockAchievement('soul_collector');
            }
            
            if (gameState.currentEnemy.name === "Holy Paladin" && !gameState.achievements.dragon_slayer.unlocked) {
                unlockAchievement('dragon_slayer');
            }
            
            if (gameState.player.minions.length >= 5 && !gameState.achievements.horde_master.unlocked) {
                unlockAchievement('horde_master');
            }
            
            if (gameState.gameStats.minionsRaised >= 10 && !gameState.achievements.undead_master.unlocked) {
                unlockAchievement('undead_master');
            }
            
            const loot = generateLoot(gameState.currentEnemy.lootTier);
            
            const manaRestore = Math.floor(gameState.player.maxMana * 0.25);
            gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + manaRestore);
            addToLog(`You recovered ${manaRestore} mana.`);
            
            gameState.player.comboCount = 0;
            gameState.player.lastSpellElement = null;
            gameState.player.spells.forEach(spell => {
                spell.cooldown = 0;
            });
            updateComboDisplay();
            
            if (loot.length > 0) {
                updateQuestProgress('collect_corpses');
                setTimeout(() => showLootScreen(loot), 1500);
            } else {
                setTimeout(() => showVictoryScreen(), 1500);
            }
            
            updatePlayerProfile();
            soundEffects.victory();
        } else {
            addToLog("You have been defeated!");
            // Lose some minions on defeat
            const minionsLost = Math.max(1, Math.floor(gameState.player.minions.length * 0.5));
            for (let i = 0; i < minionsLost && gameState.player.minions.length > 0; i++) {
                const randomIndex = Math.floor(Math.random() * gameState.player.minions.length);
                addToLog(`Your ${gameState.player.minions[randomIndex].name} was destroyed!`);
                gameState.player.minions.splice(randomIndex, 1);
            }
            setTimeout(() => showDefeatScreen(), 1500);
            soundEffects.defeat();
        }
        
        // Auto-save after battle
        autoSave();
    }

    function showVictoryScreen() {
        const xpReward = gameState.currentEnemy ? gameState.currentEnemy.xpReward : gameState.currentXpReward;
        const soulReward = gameState.currentEnemy ? gameState.currentEnemy.soulReward : gameState.currentSoulReward;
        const corpseReward = gameState.currentEnemy ? gameState.currentEnemy.corpseReward : gameState.currentCorpseReward;
        
        document.getElementById('victory-xp').textContent = `XP Gained: ${xpReward}`;
        document.getElementById('victory-souls').textContent = `Souls Gained: ${soulReward}`;
        document.getElementById('victory-corpses').textContent = `Corpses Gained: ${corpseReward}`;
        document.getElementById('victory-message').textContent = `You have defeated ${gameState.currentEnemy.name} and claimed their souls!`;
        
        const hadSoulPoints = gameState.player.soulPoints - (Math.random() < 0.2 ? 1 : 0);
        if (gameState.player.soulPoints > hadSoulPoints) {
            document.getElementById('victory-soul-points').style.display = 'block';
        } else {
            document.getElementById('victory-soul-points').style.display = 'none';
        }
        
        if (gameState.player.xp >= gameState.player.nextLevel) {
            document.getElementById('victory-level-up').style.display = 'block';
            document.getElementById('new-level').textContent = gameState.player.level + 1;
        } else {
            document.getElementById('victory-level-up').style.display = 'none';
        }
        
        showScreen('victory');
    }

    function showDefeatScreen() {
        document.getElementById('defeat-enemy').textContent = `Defeated by: ${gameState.currentEnemy.name}`;
        document.getElementById('defeat-level').textContent = `Your Level: ${gameState.player.level}`;
        document.getElementById('defeat-xp').textContent = `Current XP: ${gameState.player.xp}`;
        
        showScreen('defeat');
    }

    function showLootScreen(loot) {
        const lootItemsElement = document.getElementById('loot-items');
        lootItemsElement.innerHTML = '';
        
        loot.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = `loot-item loot-rarity-${item.rarity}`;
            
            let itemText = `${item.name} `;
            if (item.type === 'weapon') {
                itemText += `- DMG +${item.damage}`;
            } else if (item.type === 'armor') {
                itemText += `- DEF +${item.defense}`;
            } else if (item.type === 'potion') {
                itemText += `- Restores ${item.value} ${item.potionType}`;
            } else if (item.type === 'spell') {
                itemText += `- DMG: ${item.damage}, Cost: ${item.cost}`;
            } else if (item.type === 'special') {
                itemText += `- ${item.description}`;
            }
            
            itemElement.textContent = itemText;
            lootItemsElement.appendChild(itemElement);
        });
        
        gameState.currentLoot = loot;
        showScreen('loot');
    }

    function takeLoot() {
        gameState.currentLoot.forEach(item => {
            if (item.type === 'spell') {
                const spellExists = gameState.player.spells.some(spell => spell.name === item.name);
                if (!spellExists) {
                    gameState.player.spells.push({
                        name: item.name,
                        damage: item.damage,
                        cost: item.cost,
                        element: item.element || "necromancy"
                    });
                    gameState.player.unlockedSpells.push(gameState.player.spells.length - 1);
                } else {
                    gameState.player.inventory.push(item);
                }
            } else {
                gameState.player.inventory.push(item);
            }
        });
        
        updatePlayerProfile();
        updateInventoryScreen();
        updateConsumablesScreen();
        
        showVictoryScreen();
        autoSave();
    }

    function generateLoot(enemyTier) {
        const loot = [];
        const numItems = Math.floor(Math.random() * 2) + 1;
        
        for (let i = 0; i < numItems; i++) {
            const lootType = Math.random();
            let item;
            
            if (lootType < 0.3) {
                const weaponIndex = Math.min(Math.floor(Math.random() * enemyTier), gameState.lootItems.weapons.length - 1);
                item = {...gameState.lootItems.weapons[weaponIndex]};
            } else if (lootType < 0.5) {
                const armorIndex = Math.min(Math.floor(Math.random() * enemyTier), gameState.lootItems.armor.length - 1);
                item = {...gameState.lootItems.armor[armorIndex]};
            } else if (lootType < 0.8) {
                const potionIndex = Math.min(Math.floor(Math.random() * enemyTier * 1.5), gameState.lootItems.potions.length - 1);
                item = {...gameState.lootItems.potions[potionIndex]};
            } else {
                if (Math.random() < 0.3 && gameState.lootItems.spells.length > 0) {
                    const spellIndex = Math.floor(Math.random() * gameState.lootItems.spells.length);
                    item = {...gameState.lootItems.spells[spellIndex]};
                } else {
                    const potionIndex = Math.min(Math.floor(Math.random() * enemyTier * 1.5), gameState.lootItems.potions.length - 1);
                    item = {...gameState.lootItems.potions[potionIndex]};
                }
            }
            
            loot.push(item);
        }
        
        return loot;
    }

    // ============== KEYBOARD SHORTCUTS ==============
    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Only process number keys 1-4 in battle screen
            if (document.getElementById('battle-screen').classList.contains('active')) {
                const keyMap = { '1': 0, '2': 1, '3': 2, '4': 3 };
                if (keyMap[e.key] !== undefined) {
                    const spellIndex = keyMap[e.key];
                    const spell = gameState.player.spells[spellIndex];
                    
                    // Check if spell is available and has no cooldown
                    if (spell && spell.cooldown === 0) {
                        const manaCost = calculateManaCost(spell.cost, spell.element);
                        if (gameState.player.mana >= manaCost) {
                            // Check for corpse requirement
                            if (spell.requiresCorpse && gameState.player.availableCorpses < 1) {
                                addToLog("Not enough corpses to cast this spell!");
                                return;
                            }
                            castSpell(spellIndex);
                        }
                    }
                }
            }
            
            // Quick access to main menu with Escape
            if (e.key === 'Escape') {
                if (document.getElementById('battle-screen').classList.contains('active')) {
                    document.getElementById('flee').click();
                } else {
                    showScreen('main-menu');
                }
            }
        });
    }

    // ============== DOM ELEMENTS AND INITIALIZATION ==============
    const screens = {
        mainMenu: document.getElementById('main-menu'),
        playerProfile: document.getElementById('player-profile-screen'),
        skillTree: document.getElementById('skill-tree-screen'),
        enemySelection: document.getElementById('enemy-selection'),
        battle: document.getElementById('battle-screen'),
        victory: document.getElementById('victory-screen'),
        loot: document.getElementById('loot-screen'),
        defeat: document.getElementById('defeat-screen'),
        upgrade: document.getElementById('upgrade-screen'),
        minionManagement: document.getElementById('minion-management-screen'),
        graveyard: document.getElementById('graveyard-screen'),
        consumables: document.getElementById('consumables-screen'),
        inventory: document.getElementById('inventory-screen'),
        shop: document.getElementById('shop-screen'),
        achievements: document.getElementById('achievements-screen'),
        quests: document.getElementById('quests-screen'),
        info: document.getElementById('info-screen'),
        dailyChallenge: document.getElementById('daily-challenge-screen')
    };

    // Initialize the game
    document.addEventListener('DOMContentLoaded', function() {
        // Load saved game
        loadGame();
        
        // Initialize UI
        updatePlayerProfile();
        updateEnemySelection();
        generateDailyChallenge();
        updateSoulMastery();
        updateQuestsScreen();
        setupKeyboardShortcuts();

        // Set up sound toggle
        document.getElementById('toggle-sound').addEventListener('click', function() {
            soundEnabled = !soundEnabled;
            this.textContent = soundEnabled ? "ðŸ”Š Sound: ON" : "ðŸ”‡ Sound: OFF";
        });

        // Main menu buttons
        document.getElementById('new-game').addEventListener('click', () => { 
            if (confirm("Start a new game? This will erase your current progress.")) {
                resetGame(); 
                showScreen('enemySelection');
            }
        });
        
        document.getElementById('quick-play').addEventListener('click', () => { 
            quickPlay();
        });
        
        document.getElementById('player-profile').addEventListener('click', () => { 
            updatePlayerProfile(); 
            showScreen('playerProfile');
        });
        
        document.getElementById('skill-tree-btn').addEventListener('click', () => {
            updateSoulMastery();
            showScreen('skillTree');
        });
        
        document.getElementById('select-enemy').addEventListener('click', () => { 
            updateEnemySelection(); 
            showScreen('enemySelection');
        });
        
        document.getElementById('manage-minions').addEventListener('click', () => {
            updateMinionManagement();
            showScreen('minionManagement');
        });
        
        document.getElementById('graveyard-btn').addEventListener('click', () => {
            updateGraveyard();
            showScreen('graveyard');
        });
        
        document.getElementById('use-consumables').addEventListener('click', () => {
            updateConsumablesScreen();
            showScreen('consumables');
        });
        
        document.getElementById('shop-btn').addEventListener('click', () => {
            updateShopScreen();
            showScreen('shop');
        });
        
        document.getElementById('achievements-btn').addEventListener('click', () => {
            updateAchievementsScreen();
            showScreen('achievements');
        });
        
        document.getElementById('quests-btn').addEventListener('click', () => {
            updateQuestsScreen();
            showScreen('quests');
        });
        
        document.getElementById('rest-btn').addEventListener('click', () => {
            rest();
        });
        
        document.getElementById('info-btn').addEventListener('click', () => {
            showScreen('info');
        });
        
        document.getElementById('daily-challenge-btn').addEventListener('click', () => {
            updateDailyChallengeDisplay();
            showScreen('daily-challenge');
        });

        // Navigation buttons
        document.getElementById('back-from-profile').addEventListener('click', () => showScreen('mainMenu'));
        document.getElementById('back-from-skills').addEventListener('click', () => showScreen('mainMenu'));
        document.getElementById('back-from-enemies').addEventListener('click', () => showScreen('mainMenu'));
        document.getElementById('back-from-minions').addEventListener('click', () => showScreen('mainMenu'));
        document.getElementById('back-from-graveyard').addEventListener('click', () => showScreen('mainMenu'));
        document.getElementById('back-from-quests').addEventListener('click', () => showScreen('mainMenu'));
        document.getElementById('back-from-info').addEventListener('click', () => showScreen('mainMenu'));
        
        document.getElementById('flee').addEventListener('click', () => {
            addToLog("You retreat to the shadows!");
            const manaRestore = Math.floor(gameState.player.maxMana * 0.5);
            gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + manaRestore);
            addToLog(`You recovered ${manaRestore} mana while retreating.`);
            setTimeout(() => showScreen('mainMenu'), 1000);
            autoSave();
        });
        
        document.getElementById('continue-after-victory').addEventListener('click', () => {
            completeDailyChallenge();
            
            if (gameState.player.xp >= gameState.player.nextLevel) {
                showScreen('upgrade');
                soundEffects.levelUp();
            } else {
                showScreen('mainMenu');
            }
            autoSave();
        });
        
        document.getElementById('try-again').addEventListener('click', () => {
            restoreAfterDefeat();
            showScreen('enemySelection');
        });
        
        document.getElementById('main-menu-after-defeat').addEventListener('click', () => {
            restoreAfterDefeat();
            showScreen('mainMenu');
        });

        // Loot screen
        document.getElementById('take-loot').addEventListener('click', () => takeLoot());

        // Minion management buttons
        document.querySelectorAll('.minion-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const minionType = btn.dataset.minion;
                raiseMinion(minionType);
            });
        });

        // Graveyard ritual buttons
        document.querySelectorAll('.ritual-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const ritualType = btn.dataset.ritual;
                performRitual(ritualType);
            });
        });

        // Soul mastery buttons
        document.querySelectorAll('.skill-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const skillId = btn.dataset.skill;
                learnSkill(skillId);
            });
        });

        // Upgrade buttons
        document.querySelectorAll('.upgrade-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const upgradeType = btn.dataset.upgrade;
                applyUpgrade(upgradeType);
            });
        });

        // Inventory management button
        document.getElementById('manage-inventory').addEventListener('click', () => {
            updateInventoryScreen();
            showScreen('inventory');
        });

        // Back button for inventory screen
        document.getElementById('back-from-inventory').addEventListener('click', () => showScreen('playerProfile'));

        // Reset skills button
        document.getElementById('reset-skills').addEventListener('click', resetSoulMastery);

        // Make functions globally available
        window.showScreen = showScreen;
        window.raiseMinion = raiseMinion;
        window.dismissMinion = dismissMinion;
        window.commandMinion = commandMinion;
        window.performRitual = performRitual;
        window.learnSkill = learnSkill;
    });

    // ============== ORIGINAL FUNCTIONS (adapted for necromancer theme) ==============

    function updatePlayerProfile() {
        const p = gameState.player;
        document.getElementById('player-name').textContent = p.name;
        document.getElementById('player-level').textContent = p.level;
        document.getElementById('player-xp').textContent = p.xp;
        document.getElementById('player-next-level').textContent = p.nextLevel;
        document.getElementById('player-xp-bar').style.width = `${(p.xp / p.nextLevel) * 100}%`;
        document.getElementById('player-health').textContent = p.health;
        document.getElementById('player-max-health').textContent = p.maxHealth;
        document.getElementById('player-mana').textContent = p.mana;
        document.getElementById('player-max-mana').textContent = p.maxMana;
        document.getElementById('player-attack').textContent = p.attack;
        document.getElementById('player-defense').textContent = p.defense;
        document.getElementById('player-critical').textContent = p.critical;
        document.getElementById('player-souls').textContent = p.souls;
        document.getElementById('player-corpses').textContent = p.corpses;
        document.getElementById('player-soul-points').textContent = p.soulPoints;
        document.getElementById('player-available-corpses').textContent = p.availableCorpses;
        document.getElementById('player-weapon').textContent = p.equipment.weapon.name;
        document.getElementById('player-weapon-dmg').textContent = p.equipment.weapon.damage;
        document.getElementById('player-armor').textContent = p.equipment.armor.name;
        document.getElementById('player-armor-def').textContent = p.equipment.armor.defense;
        
        document.getElementById('soul-amount').textContent = p.souls;
        document.getElementById('corpse-amount').textContent = p.corpses;
        document.getElementById('soul-points-amount').textContent = p.soulPoints;
        
        const unlockedCount = Object.values(gameState.achievements).filter(a => a.unlocked).length;
        document.getElementById('player-achievements').textContent = unlockedCount;
        
        updateProfileInventoryDisplay();
        updateSpellDisplay();
        updateStatusEffectsDisplay();
        updateActiveMinionsDisplay();
    }

    function updateProfileInventoryDisplay() {
        const inventoryElement = document.getElementById('player-inventory-items');
        inventoryElement.innerHTML = '';
        
        if (gameState.player.inventory.length === 0) {
            inventoryElement.innerHTML = '<div class="inventory-empty">No artifacts in inventory</div>';
            return;
        }
        
        gameState.player.inventory.forEach((item, index) => {
            const itemElement = document.createElement('div');
            itemElement.className = `compact-item item-${item.rarity}`;
            
            let itemText = `${item.name}`;
            if (item.type === 'weapon') {
                itemText += ` (DMG +${item.damage})`;
            } else if (item.type === 'armor') {
                itemText += ` (DEF +${item.defense})`;
            } else if (item.type === 'potion') {
                itemText += ` (${item.value} ${item.potionType})`;
            } else if (item.type === 'spell') {
                itemText += ` (DMG: ${item.damage}, Cost: ${item.cost})`;
            } else if (item.type === 'special') {
                itemText += ` (${item.description})`;
            }
            
            const textElement = document.createElement('div');
            textElement.textContent = itemText;
            itemElement.appendChild(textElement);
            
            inventoryElement.appendChild(itemElement);
        });
    }

    function updateSpellDisplay() {
        const profileSpells = document.getElementById('profile-spells');
        profileSpells.innerHTML = '';
        
        const battleSpells = document.getElementById('battle-spells');
        battleSpells.innerHTML = '';
        
        gameState.player.unlockedSpells.forEach(spellIndex => {
            const spell = gameState.player.spells[spellIndex];
            const manaCost = calculateManaCost(spell.cost, spell.element);
            
            const profileSpellElement = document.createElement('div');
            profileSpellElement.className = 'spell';
            
            let spellInfo = `${spell.heal ? `Heal: ${spell.heal}` : `DMG: ${spell.damage}`} | Cost: ${manaCost} MP | Element: ${spell.element || 'None'}`;
            if (spell.requiresCorpse) {
                spellInfo += " | Requires 1 Corpse";
            }
            
            profileSpellElement.innerHTML = `
                <button class="tooltip">${spell.name}
                    <span class="tooltiptext">${spellInfo}</span>
                </button>
            `;
            profileSpells.appendChild(profileSpellElement);
            
            const button = document.createElement('button');
            button.className = 'spell-btn';
            button.setAttribute('data-spell', spellIndex);
            
            // Show cooldown if applicable
            if (spell.cooldown > 0) {
                button.textContent = `${spell.name} (CD: ${spell.cooldown})`;
                button.disabled = true;
                button.style.backgroundColor = '#333';
            } else {
                button.textContent = `${spell.name} (${manaCost} MP)`;
                button.disabled = false;
                
                // Color code based on element
                switch(spell.element) {
                    case 'dark': button.style.backgroundColor = '#330'; break;
                    case 'necromancy': button.style.backgroundColor = '#303'; break;
                    case 'curse': button.style.backgroundColor = '#630'; break;
                    default: button.style.backgroundColor = '';
                }
            }
            
            button.addEventListener('click', () => {
                castSpell(spellIndex);
            });
            
            battleSpells.appendChild(button);
        });
    }

    function updateBattleConsumables() {
        const consumablesElement = document.getElementById('battle-consumables');
        consumablesElement.innerHTML = '';
        
        const potionIndices = [];
        gameState.player.inventory.forEach((item, index) => {
            if (item.type === 'potion' || item.type === 'special') {
                potionIndices.push(index);
            }
        });
        
        if (potionIndices.length === 0) {
            consumablesElement.style.display = 'none';
            return;
        }
        
        consumablesElement.style.display = 'flex';
        
        potionIndices.forEach(inventoryIndex => {
            const potion = gameState.player.inventory[inventoryIndex];
            const button = document.createElement('button');
            button.className = 'consumable-btn';
            button.textContent = `${potion.name}`;
            button.onclick = () => useConsumable(inventoryIndex);
            consumablesElement.appendChild(button);
        });
    }

    function useConsumable(index) {
        const item = gameState.player.inventory[index];
        
        if (!item) return;
        
        if (item.type === 'potion') {
            if (item.potionType === 'health') {
                const healAmount = Math.min(item.value, gameState.player.maxHealth - gameState.player.health);
                gameState.player.health += healAmount;
                addToLog(`You used ${item.name} and healed ${healAmount} health!`);
                soundEffects.heal();
            } else if (item.potionType === 'mana') {
                const manaAmount = Math.min(item.value, gameState.player.maxMana - gameState.player.mana);
                gameState.player.mana += manaAmount;
                addToLog(`You used ${item.name} and restored ${manaAmount} mana!`);
            }
        } 
        else if (item.type === 'special') {
            switch(item.effect) {
                case 'soul_boost':
                    gameState.player.souls += item.value;
                    addToLog(`You used ${item.name} and gained ${item.value} souls!`);
                    break;
                case 'corpse_boost':
                    gameState.player.corpses += item.value;
                    addToLog(`You used ${item.name} and gained ${item.value} corpses!`);
                    break;
                case 'revive':
                    addToLog(`You used ${item.name} - you will automatically revive if defeated!`);
                    break;
            }
        }
        
        gameState.player.inventory.splice(index, 1);
        
        updatePlayerProfile();
        updateBattleConsumables();
        updateConsumablesScreen();
        updateInventoryScreen();
        
        if (document.getElementById('battle-player-health')) {
            document.getElementById('battle-player-health').textContent = gameState.player.health;
            document.getElementById('battle-player-mana').textContent = gameState.player.mana;
            document.getElementById('player-health-fill').style.width = 
                `${(gameState.player.health / gameState.player.maxHealth) * 100}%`;
            document.getElementById('player-mana-fill').style.width = 
                `${(gameState.player.mana / gameState.player.maxMana) * 100}%`;
        }
        
        autoSave();
    }

    function equipItem(index) {
        const item = gameState.player.inventory[index];
        
        if (item.type === 'weapon') {
            const oldWeapon = {...gameState.player.equipment.weapon, type: 'weapon', rarity: 'common'};
            
            gameState.player.equipment.weapon = {
                name: item.name,
                damage: item.damage
            };
            
            gameState.player.inventory[index] = oldWeapon;
            
            addToLog(`You equipped ${item.name}!`);
        } 
        else if (item.type === 'armor') {
            const oldArmor = {...gameState.player.equipment.armor, type: 'armor', rarity: 'common'};
            
            gameState.player.equipment.armor = {
                name: item.name,
                defense: item.defense
            };
            
            gameState.player.inventory[index] = oldArmor;
            
            addToLog(`You equipped ${item.name}!`);
        }
        else if (item.type === 'spell') {
            const spellExists = gameState.player.spells.some(spell => spell.name === item.name);
            if (!spellExists) {
                gameState.player.spells.push({
                    name: item.name,
                    damage: item.damage,
                    cost: item.cost,
                    element: item.element || "necromancy"
                });
                gameState.player.unlockedSpells.push(gameState.player.spells.length - 1);
                
                gameState.player.inventory.splice(index, 1);
                
                addToLog(`You learned ${item.name}!`);
            } else {
                addToLog(`You already know ${item.name}!`);
                return;
            }
        }
        
        updatePlayerProfile();
        updateInventoryScreen();
        autoSave();
    }

    function updateConsumablesScreen() {
        const consumablesList = document.getElementById('consumables-list');
        consumablesList.innerHTML = '';
        
        const potionIndices = [];
        gameState.player.inventory.forEach((item, index) => {
            if (item.type === 'potion' || item.type === 'special') {
                potionIndices.push(index);
            }
        });
        
        if (potionIndices.length === 0) {
            consumablesList.innerHTML = '<div class="inventory-empty">No artifacts in inventory</div>';
            return;
        }
        
        potionIndices.forEach(inventoryIndex => {
            const potion = gameState.player.inventory[inventoryIndex];
            const itemElement = document.createElement('div');
            itemElement.className = `compact-item item-${potion.rarity}`;
            
            const textElement = document.createElement('div');
            let itemText = `${potion.name}`;
            if (potion.type === 'potion') {
                itemText += ` - ${potion.value} ${potion.potionType}`;
            } else if (potion.type === 'special') {
                itemText += ` - ${potion.description}`;
            }
            textElement.textContent = itemText;
            itemElement.appendChild(textElement);
            
            const actionsElement = document.createElement('div');
            actionsElement.className = 'compact-actions';
            
            const useButton = document.createElement('button');
            useButton.className = 'compact-action-btn';
            useButton.textContent = 'Use';
            useButton.onclick = () => {
                useConsumable(inventoryIndex);
            };
            actionsElement.appendChild(useButton);
            
            itemElement.appendChild(actionsElement);
            consumablesList.appendChild(itemElement);
        });
    }

    function updateInventoryScreen() {
        const inventoryItems = document.getElementById('inventory-items');
        inventoryItems.innerHTML = '';
        
        if (gameState.player.inventory.length === 0) {
            inventoryItems.innerHTML = '<div class="inventory-empty">No artifacts in inventory</div>';
            return;
        }
        
        gameState.player.inventory.forEach((item, index) => {
            const itemElement = document.createElement('div');
            itemElement.className = `compact-item item-${item.rarity}`;
            
            let itemText = `${item.name}`;
            if (item.type === 'weapon') {
                itemText += ` (DMG +${item.damage})`;
            } else if (item.type === 'armor') {
                itemText += ` (DEF +${item.defense})`;
            } else if (item.type === 'potion') {
                itemText += ` (${item.value} ${item.potionType})`;
            } else if (item.type === 'spell') {
                itemText += ` (DMG: ${item.damage}, Cost: ${item.cost})`;
            } else if (item.type === 'special') {
                itemText += ` (${item.description})`;
            }
            
            const textElement = document.createElement('div');
            textElement.textContent = itemText;
            itemElement.appendChild(textElement);
            
            const actionsElement = document.createElement('div');
            actionsElement.className = 'compact-actions';
            
            if (item.type === 'potion' || item.type === 'special') {
                const useButton = document.createElement('button');
                useButton.className = 'compact-action-btn';
                useButton.textContent = 'Use';
                useButton.onclick = () => {
                    useConsumable(index);
                };
                actionsElement.appendChild(useButton);
            } else if (item.type === 'weapon' || item.type === 'armor' || item.type === 'spell') {
                const actionButton = document.createElement('button');
                actionButton.className = 'compact-action-btn';
                actionButton.textContent = item.type === 'spell' ? 'Learn' : 'Equip';
                actionButton.onclick = () => {
                    equipItem(index);
                };
                actionsElement.appendChild(actionButton);
            }
            
            itemElement.appendChild(actionsElement);
            inventoryItems.appendChild(itemElement);
        });
    }

    function showScreen(name) {
        Object.values(screens).forEach(s => s.classList.remove('active'));
        if (screens[name]) {
            screens[name].classList.add('active');
            const content = screens[name].querySelector('.content');
            if (content) content.scrollTop = 0;
        }
    }

    function updateBattleLog() {
        const logElement = document.getElementById('battle-log');
        logElement.innerHTML = '';
        gameState.battleLog.forEach(entry => {
            const div = document.createElement('div');
            div.innerHTML = entry;
            logElement.appendChild(div);
        });
        logElement.scrollTop = logElement.scrollHeight;
    }

    function addToLog(message) {
        gameState.battleLog.push(message);
        if (gameState.battleLog.length > 10) {
            gameState.battleLog.shift();
        }
        updateBattleLog();
    }

    function updateEnemySelection() {
        const enemyList = document.getElementById('enemy-list');
        enemyList.innerHTML = '';
        
        Object.keys(gameState.enemies).forEach(enemyType => {
            const enemy = gameState.enemies[enemyType];
            
            const enemyElement = document.createElement('div');
            enemyElement.className = 'enemy-option';
            
            enemyElement.innerHTML = `
                <div>
                    <h3>${enemy.name}</h3>
                    <div>Level: ${enemy.level} | Health: ${enemy.health}</div>
                    <div>Element: ${enemy.element}</div>
                    <div>Abilities: ${enemy.spells.map(s => s.name).join(', ')}</div>
                </div>
                <button class="select-enemy" data-enemy="${enemyType}">RAID</button>
            `;
            
            enemyList.appendChild(enemyElement);
        });
        
        document.querySelectorAll('.select-enemy').forEach(btn => {
            btn.onclick = () => startBattle(btn.dataset.enemy);
        });
    }

    function resetGame() {
        Object.assign(gameState.player, {
            name: "MORDRED",
            level: 1,
            xp: 0,
            nextLevel: 100,
            health: 50,
            maxHealth: 50,
            mana: 30,
            maxMana: 30,
            attack: 5,
            defense: 3,
            critical: 5,
            souls: 0,
            soulPoints: 0,
            corpses: 0,
            availableCorpses: 0,
            position: "medium",
            statusEffects: [],
            spells: [
                { name: "Dark Bolt", damage: 8, cost: 5, element: "dark", cooldown: 0, maxCooldown: 0 },
                { name: "Life Drain", damage: 6, heal: 3, cost: 7, element: "dark", cooldown: 0, maxCooldown: 1 },
                { name: "Raise Dead", cost: 10, element: "necromancy", cooldown: 0, maxCooldown: 2, requiresCorpse: true },
                { name: "Curse of Weakness", cost: 8, element: "curse", statusEffect: "curse", cooldown: 0, maxCooldown: 3 }
            ],
            minions: [],
            maxMinions: 3,
            equipment: {
                weapon: { name: "Bone Staff", damage: 2 },
                armor: { name: "Necromancer Robes", defense: 1 }
            },
            inventory: [],
            unlockedSpells: [0, 1, 2, 3],
            comboCount: 0,
            lastSpellElement: null,
            skills: {
                skeletal_fortitude: false,
                bone_armor: false,
                plague_bearer: false,
                endless_horde: false,
                ethereal_form: false,
                soul_drain: false,
                dark_efficiency: false,
                soul_harvest: false
            }
        });
        
        Object.keys(gameState.achievements).forEach(key => {
            gameState.achievements[key].unlocked = false;
        });
        
        Object.keys(gameState.quests).forEach(key => {
            gameState.quests[key].progress = 0;
            gameState.quests[key].completed = false;
        });
        
        gameState.gameStats = {
            totalBattles: 0,
            victories: 0,
            spellsCast: {},
            minionsRaised: 0,
            soulsCollected: 0,
            playTime: 0
        };
        
        // Clear saved game
        localStorage.removeItem('necromancerRiseSave');
        
        updatePlayerProfile();
        updateQuestsScreen();
    }

    function restoreAfterDefeat() {
        gameState.player.health = gameState.player.maxHealth;
        gameState.player.mana = gameState.player.maxMana;
        gameState.player.statusEffects = [];
        updatePlayerProfile();
    }

    function unlockAchievement(achievementId) {
        const achievement = gameState.achievements[achievementId];
        if (!achievement || achievement.unlocked) return;
        
        achievement.unlocked = true;
        
        const notification = document.createElement('div');
        notification.className = 'achievement-notification';
        notification.innerHTML = `
            <h3>Achievement Unlocked!</h3>
            <p>${achievement.name}</p>
            <p>${achievement.description}</p>
            <p>Reward: ${achievement.reward.souls} Souls</p>
            <button onclick="this.parentElement.remove()">OK</button>
        `;
        document.body.appendChild(notification);
        
        gameState.player.souls += achievement.reward.souls;
        addToLog(`Achievement Unlocked: ${achievement.name}! Received ${achievement.reward.souls} souls.`);
        
        updatePlayerProfile();
        updateAchievementsScreen();
        autoSave();
    }

    function updateAchievementsScreen() {
        const achievementsList = document.getElementById('achievements-list');
        achievementsList.innerHTML = '';
        
        Object.keys(gameState.achievements).forEach(achievementId => {
            const achievement = gameState.achievements[achievementId];
            const achievementElement = document.createElement('div');
            achievementElement.className = `achievement-item ${achievement.unlocked ? 'achievement-unlocked' : 'achievement-locked'}`;
            
            achievementElement.innerHTML = `
                <h3>${achievement.name}</h3>
                <p>${achievement.description}</p>
                <p>Reward: ${achievement.reward.souls} Souls</p>
                <p><strong>Status: ${achievement.unlocked ? 'UNLOCKED' : 'LOCKED'}</strong></p>
            `;
            
            achievementsList.appendChild(achievementElement);
        });
    }

    function updateShopScreen() {
        const shopItems = document.getElementById('shop-items');
        shopItems.innerHTML = '';
        
        gameState.shopItems.forEach((shopItem, index) => {
            const itemElement = document.createElement('div');
            itemElement.className = 'compact-item';
            
            const itemInfo = document.createElement('div');
            itemInfo.innerHTML = `
                <h3>${shopItem.name}</h3>
                <p>Cost: ${shopItem.cost} souls</p>
            `;
            
            const buyButton = document.createElement('button');
            buyButton.className = 'compact-action-btn';
            buyButton.textContent = 'Buy';
            buyButton.onclick = () => buyItem(index);
            buyButton.disabled = gameState.player.souls < shopItem.cost;
            
            itemElement.appendChild(itemInfo);
            itemElement.appendChild(buyButton);
            shopItems.appendChild(itemElement);
        });
        
        document.getElementById('shop-souls').textContent = gameState.player.souls;
    }

    function buyItem(shopIndex) {
        const shopItem = gameState.shopItems[shopIndex];
        
        if (gameState.player.souls < shopItem.cost) {
            addToLog("Not enough souls!");
            return;
        }
        
        gameState.player.souls -= shopItem.cost;
        gameState.player.inventory.push(shopItem.item);
        
        addToLog(`Purchased ${shopItem.name} for ${shopItem.cost} souls!`);
        
        updatePlayerProfile();
        updateShopScreen();
        updateInventoryScreen();
        autoSave();
    }

    function generateDailyChallenge() {
        gameState.dailyChallenge = {
            available: true,
            completed: false,
            progress: 0,
            required: 3,
            reward: { xp: 200, souls: 100 }
        };
        
        updateDailyChallengeDisplay();
    }

    function updateDailyChallengeDisplay() {
        const dailyChallengeElement = document.getElementById('daily-challenge-main');
        const dailyChallengeInfo = document.getElementById('daily-challenge-info');
        
        if (gameState.dailyChallenge.available && !gameState.dailyChallenge.completed) {
            dailyChallengeElement.style.display = 'block';
            
            if (dailyChallengeInfo) {
                dailyChallengeInfo.innerHTML = `
                    <h3>Dark Ritual</h3>
                    <p>Defeat ${gameState.dailyChallenge.required} enemies</p>
                    <p>Progress: ${gameState.dailyChallenge.progress}/${gameState.dailyChallenge.required}</p>
                    <p>Reward: ${gameState.dailyChallenge.reward.xp} XP and ${gameState.dailyChallenge.reward.souls} Souls</p>
                    ${gameState.dailyChallenge.completed ? '<p style="color: #0f0;">Completed!</p>' : ''}
                `;
            }
        } else {
            dailyChallengeElement.style.display = 'none';
        }
    }

    function completeDailyChallenge() {
        if (gameState.dailyChallenge.available && !gameState.dailyChallenge.completed) {
            gameState.dailyChallenge.progress++;
            
            if (gameState.dailyChallenge.progress >= gameState.dailyChallenge.required) {
                gameState.dailyChallenge.completed = true;
                gameState.player.xp += gameState.dailyChallenge.reward.xp;
                gameState.player.souls += gameState.dailyChallenge.reward.souls;
                
                addToLog(`Dark Ritual Completed! Received ${gameState.dailyChallenge.reward.xp} XP and ${gameState.dailyChallenge.reward.souls} souls.`);
                
                updatePlayerProfile();
            }
            
            updateDailyChallengeDisplay();
            autoSave();
        }
    }

    function applyUpgrade(upgradeType) {
        switch(upgradeType) {
            case 'health':
                gameState.player.maxHealth += 10;
                gameState.player.health = gameState.player.maxHealth;
                break;
            case 'mana':
                gameState.player.maxMana += 5;
                gameState.player.mana = gameState.player.maxMana;
                break;
            case 'attack':
                gameState.player.attack += 2;
                break;
            case 'defense':
                gameState.player.defense += 2;
                break;
        }
        
        gameState.player.level++;
        gameState.player.xp = 0;
        gameState.player.nextLevel = Math.floor(gameState.player.nextLevel * 1.5);
        
        updatePlayerProfile();
        showScreen('main-menu');
        autoSave();
    }
    </script>
</body>
</html>
