<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASTLE OF THE UNDEAD - Level 7: The Crypt</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Crypt Blue/Black/White theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(0, 40, 80, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 40, 80, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #0066cc;
            background-color: #000;
            box-shadow: 0 0 20px rgba(0, 102, 204, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 40, 80, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #0066cc;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #66aaff;
            text-shadow: 0 0 5px #0066ff;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #0066cc;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #0066cc;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #003;
            color: #6cf;
            border-color: #6cf;
        }
        
        .level-number.current {
            background-color: #0066cc;
            color: #fff;
            border-color: #66aaff;
            box-shadow: 0 0 8px #0066ff;
            text-shadow: 0 0 2px #000;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #0066cc;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #66aaff;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #0066cc;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #66aaff;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #0066cc;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #66aaff;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #66aaff;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #0066cc;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #0066cc;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #66aaff;
            border-color: #66aaff;
            box-shadow: 0 0 10px rgba(102, 170, 255, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #0066cc;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #66aaff;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #0066cc;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #66aaff;
            border-color: #66aaff;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #112233;
            border: 1px solid #0066cc;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #66aaff;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #223344;
            border: 1px solid #66aaff;
            padding: 10px;
            margin: 10px 0;
            color: #66aaff;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #6ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        .ghost {
            color: #aaf;
            font-weight: bold;
            text-shadow: 0 0 3px #aaf;
        }
        
        .wolf {
            color: #aaa;
            font-weight: bold;
            text-shadow: 0 0 3px #aaa;
        }
        
        .zombie {
            color: #8f8;
            font-weight: bold;
            text-shadow: 0 0 3px #8f8;
        }
        
        .skeleton {
            color: #ccc;
            font-weight: bold;
            text-shadow: 0 0 3px #ccc;
        }
        
        .wraith {
            color: #8af;
            font-weight: bold;
            text-shadow: 0 0 3px #8af;
        }
        
        .cryptkeeper {
            color: #9cf;
            font-weight: bold;
        }
        
        .lich {
            color: #6f6;
            font-weight: bold;
            text-shadow: 0 0 3px #6f6;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #0066cc;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #0066cc;
            color: #fff;
            border-color: #66aaff;
            box-shadow: 0 0 15px #0066ff;
        }
        
        /* Crypt Selection */
        .crypt-selection {
            background-color: #112233;
            border: 1px solid #0066cc;
            padding: 15px;
            margin: 15px 0;
        }
        
        .crypt-option {
            background-color: #223344;
            border: 1px solid #0066cc;
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .crypt-option:hover {
            background-color: #334455;
            border-color: #66aaff;
        }
        
        /* Sarcophagus Opening Animation */
        .sarcophagus-opening {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #112233;
            border: 1px solid #0066cc;
            animation: pulse-blue 2s infinite;
        }
        
        @keyframes pulse-blue {
            0% { border-color: #0066cc; }
            50% { border-color: #66aaff; }
            100% { border-color: #0066cc; }
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #0066cc;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #0066cc;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #66aaff;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CASTLE OF THE UNDEAD</h1>
            <h2>LEVEL 7: THE CRYPT</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number completed">2</div>
            <div class="level-number completed">3</div>
            <div class="level-number completed">4</div>
            <div class="level-number completed">5</div>
            <div class="level-number completed">6</div>
            <div class="level-number current">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Level Intro Screen -->
        <div id="screen-intro" class="screen active-screen">
            <h2>THE CRYPT</h2>
            <div class="story-text">
                <p>The massive stone doors of the crypt close behind you with a heavy finality. You stand in a cold, silent antechamber. The air is stale and smells of dust, old stone, and something else... the faint scent of decay.</p>
                <p>Ancient torches in wall sconces flicker with unnatural blue flames, casting eerie shadows across carved stone walls depicting vampire lords feasting on mortals. The ceiling is vaulted, disappearing into darkness above.</p>
                <p>Before you, three passages branch off: left, center, and right. From the left comes a faint whispering sound. The center passage is wide and grand, leading downward. The right passage is narrow and dark.</p>
                <p>This is where Valerius draws power from his ancestors. Their restless spirits guard these halls. You must navigate the crypt's deadly traps and guardians to find the way to the catacombs below.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="intro-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="intro-stat-health" class="stat-value">0</span>/<span id="intro-stat-maxhealth" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="intro-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="intro-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="startLevel7()">ENTER THE CRYPT</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>VORLAK FAMILY CRYPT</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Sarcophagus Selection Screen -->
        <div id="screen-sarcophagi" class="screen">
            <h2>ANCIENT SARCOPHAGI</h2>
            <div class="story-text">
                <p>You stand before a row of ancient stone sarcophagi. Each is carved with images of the vampire lord within. Some lids are slightly ajar, others sealed with heavy stone.</p>
                <p>Which sarcophagus do you examine?</p>
                
                <div class="crypt-selection">
                    <div class="crypt-option" onclick="selectSarcophagus('vorlak1')">
                        <strong>Lord Viktor Vorlak</strong><br>
                        <small>"First of the Vorlak line. Conqueror of the Northern Pass." (1421-1505)</small>
                    </div>
                    <div class="crypt-option" onclick="selectSarcophagus('vorlak2')">
                        <strong>Lady Isabella Vorlak</strong><br>
                        <small>"Sorceress and strategist. Turned 100 mortals in a single night." (1455-1520)</small>
                    </div>
                    <div class="crypt-option" onclick="selectSarcophagus('vorlak3')">
                        <strong>Count Marcus Vorlak</strong><br>
                        <small>"Master of shadows. Feared by kings and commoners alike." (1488-1567)</small>
                    </div>
                    <div class="crypt-option" onclick="selectSarcophagus('vorlak4')">
                        <strong>Lord Valerius Vorlak (Current)</strong><br>
                        <small>"The current master. Dates show his reign but not his end." (1599-Present)</small>
                    </div>
                    <div class="crypt-option" onclick="selectSarcophagus('cryptkeeper')">
                        <strong>The Crypt Keeper</strong><br>
                        <small>"Guardian of the tombs. Eternal watch over the dead." (Date unknown)</small>
                    </div>
                </div>
                
                <div id="sarcophagus-feedback" style="margin-top: 15px; padding: 10px; background-color: #112233; border: 1px solid #0066cc; display: none;">
                    <p id="sarcophagus-feedback-text"></p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="cancelSarcophagusSelection()">RETURN TO CRYPT</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL 7 COMPLETE!</h2>
            <div class="story-text">
                <p>You have survived the horrors of the Vorlak family crypt and found the entrance to the catacombs!</p>
                <p>A massive stone staircase spirals downward into even deeper darkness. The air grows colder and heavier as you approach. From below, you hear faint whispers and the sound of dripping water.</p>
                <p>The catacombs are the oldest part of Castle Vorlak, where ancient evils sleep and forgotten rituals were performed. This is where Valerius performs his darkest magic.</p>
                <p>All your stats, gold, and inventory will carry over to Level 8: The Castle's Catacombs.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #112233; border: 1px solid #0066cc;">
                    <h3 style="color: #66aaff; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">ENTER THE CATACOMBS - LEVEL 8</button>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE UNDEAD - A Retro Vampire Hunt Adventure<br>
            Level 7: The Crypt
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'skeleton':
                    playBeep(150, 0.3, 'square');
                    setTimeout(() => playBeep(100, 0.3, 'square'), 300);
                    break;
                case 'wraith':
                    playBeep(600, 0.5, 'sine');
                    setTimeout(() => playBeep(400, 0.5, 'sine'), 500);
                    break;
                case 'ghost':
                    playBeep(400, 0.3, 'sine');
                    setTimeout(() => playBeep(300, 0.5, 'sine'), 300);
                    break;
                case 'trap':
                    playBeep(1000, 0.1, 'sawtooth');
                    setTimeout(() => playBeep(500, 0.1, 'sawtooth'), 100);
                    break;
                case 'crypt':
                    playBeep(200, 0.5, 'sine');
                    setTimeout(() => playBeep(150, 0.5, 'sine'), 500);
                    break;
                case 'lich':
                    playBeep(80, 0.8, 'square');
                    setTimeout(() => playBeep(120, 0.6, 'square'), 800);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - loaded from Level 6
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Rusty Sword',
            equippedArmor: 'Leather Armor',
            currentSection: 1,
            gameComplete: false,
            level: 7,
            // Level 7 specific flags
            exploredLeftPassage: false,
            exploredCenterPassage: false,
            exploredRightPassage: false,
            skeletonWarriorsDefeated: false,
            wraithEncountered: false,
            foundCryptMap: false,
            solvedPuzzle: false,
            lichDefeated: false,
            foundCatacombKey: false,
            examinedSarcophagi: false,
            // Special items
            hasHolySymbol: false,
            hasHolyWater: false,
            hasSilverWeapon: false,
            // Puzzle tracking
            puzzleSequence: []
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            isGroup: false,
            groupCount: 0
        };
        
        // Random event tracking
        let randomEvents = {
            whisperingHeard: 0,
            torchFlicker: false,
            coldDraft: false
        };
        
        // Sarcophagus examination results
        const sarcophagusResults = {
            'vorlak1': {
                text: "Lord Viktor Vorlak's sarcophagus. The carvings show him leading an army of vampires against a human kingdom. The lid is heavy but not sealed. Inside, you find ancient bones and a rusted crown.",
                item: 'Rusted Vampire Crown',
                gold: 25,
                special: "The crown is inscribed with ancient vampire runes."
            },
            'vorlak2': {
                text: "Lady Isabella Vorlak's resting place. The sarcophagus shows her casting dark magic. The lid slides open easily. Within, you find her skeletal remains and a book bound in pale skin.",
                item: 'Skin-bound Tome',
                gold: 30,
                special: "The book contains dark rituals and vampire lore."
            },
            'vorlak3': {
                text: "Count Marcus Vorlak's tomb. The carvings depict him moving through shadows. The lid is sealed with magical symbols that glow faintly. You dare not open it fully, but find an item in a small compartment.",
                item: 'Shadow Cloak Clasp',
                gold: 20,
                special: "The clasp feels cold and seems to absorb light."
            },
            'vorlak4': {
                text: "Lord Valerius Vorlak's sarcophagus - but it's empty! The dates show his reign but no death date. The interior is lined with black velvet, as if recently occupied. A single item remains.",
                item: 'Valerius Signet Ring',
                gold: 50,
                special: "The ring bears the Vorlak family crest and feels warm to the touch."
            },
            'cryptkeeper': {
                text: "The Crypt Keeper's sarcophagus is plainer than the others. The lid is heavy stone. As you examine it, you feel a cold presence watching you. You find something tucked beside it.",
                item: 'Crypt Keeper Key',
                gold: 15,
                special: "A heavy iron key that might unlock something important."
            }
        };
        
        // Game story sections for Level 7
        const storySections = {
            1: {
                text: "You stand in the crypt's antechamber. Three passages branch before you, all carved with vampire imagery and lit by flickering blue torches. The air is cold and still, heavy with centuries of death.",
                choices: [
                    {text: "Take the left passage (whispering sounds)", nextSection: 2, skillCheck: false},
                    {text: "Take the center passage (grand staircase downward)", nextSection: 3, skillCheck: false},
                    {text: "Take the right passage (narrow and dark)", nextSection: 4, skillCheck: false},
                    {text: "Examine the antechamber more closely", nextSection: 5, skillCheck: false}
                ],
                action: function() {
                    // Random crypt sounds
                    if (Math.random() > 0.7) {
                        randomEvents.whisperingHeard++;
                        playSound('crypt');
                        return "<br><span class='ghost'>Faint whispers echo through the stone halls, their source unclear.</span>";
                    }
                    return "";
                }
            },
            2: {
                text: "The left passage winds through rows of ancient burial niches. The whispering grows louder here, seeming to come from the walls themselves. Blue torchlight flickers, casting dancing shadows.",
                choices: [
                    {text: "Follow the whispering", nextSection: 6, skillCheck: false},
                    {text: "Search the burial niches", nextSection: 7, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Investigate a side chamber", nextSection: 8, skillCheck: false},
                    {text: "Return to the antechamber", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.exploredLeftPassage = true;
                    playSound('ghost');
                    return "";
                }
            },
            3: {
                text: "The grand central staircase spirals downward into darkness. The steps are worn smooth by centuries of use. Carved stone vampires line the walls, their stone eyes seeming to follow your movement.",
                choices: [
                    {text: "Descend the staircase", nextSection: 9, skillCheck: false},
                    {text: "Examine the carvings", nextSection: 10, skillCheck: false},
                    {text: "Check for traps", nextSection: 11, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Return to the antechamber", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.exploredCenterPassage = true;
                    playSound('crypt');
                    return "A cold draft rises from below, carrying the scent of damp stone and something metallic.";
                }
            },
            4: {
                text: "The right passage is narrow and low-ceilinged. You must move single-file through the darkness, guided only by occasional blue torches. The air here is stale and thick with dust.",
                choices: [
                    {text: "Continue down the narrow passage", nextSection: 12, skillCheck: false},
                    {text: "Feel along the walls", nextSection: 13, skillCheck: false},
                    {text: "Listen for sounds ahead", nextSection: 14, skillCheck: true, checkType: 'agility', difficulty: 12},
                    {text: "Return to the antechamber", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.exploredRightPassage = true;
                    return "Cobwebs brush against your face in the darkness.";
                }
            },
            5: {
                text: "You examine the antechamber more closely. The stone walls are covered in intricate carvings depicting the history of the Vorlak vampire line. A large stone altar stands against one wall, stained dark.",
                choices: [
                    {text: "Examine the altar", nextSection: 15, skillCheck: false},
                    {text: "Study the wall carvings", nextSection: 16, skillCheck: false},
                    {text: "Check for hidden passages", nextSection: 17, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Return to choosing a passage", nextSection: 1, skillCheck: false}
                ]
            },
            6: {
                text: "You follow the whispering to its source - a small chamber where three spectral figures hover above the floor. They turn to face you, their ghostly forms shifting in the torchlight.",
                choices: [
                    {text: "Address the ghosts", nextSection: 18, skillCheck: false},
                    {text: "Attack immediately", nextSection: 19, skillCheck: false},
                    {text: "Try to sneak past", nextSection: 20, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Retreat quickly", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    playSound('ghost');
                    return "The ghostly figures whisper in an ancient tongue. <span class='ghost'>'Why do you disturb our rest, mortal?'</span>";
                }
            },
            7: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(3, 10);
                        gameState.gold += goldFound;
                        addToInventory('Ancient Burial Urn');
                        updateStatsDisplay();
                        playSound('item');
                        return "You carefully search the burial niches and find an <span class='item'>Ancient Burial Urn</span> containing <span class='gold'>" + goldFound + " Gold</span>.";
                    } else {
                        // Trigger trap or encounter
                        const trapDamage = rollDice(1, 6);
                        gameState.health -= trapDamage;
                        updateStatsDisplay();
                        playSound('trap');
                        return "You disturb a skeletal guardian! It attacks before crumbling to dust, dealing " + trapDamage + " damage.";
                    }
                }
            },
            8: {
                text: "You enter a side chamber containing several stone sarcophagi. The room is colder than the passage, and your breath fogs in the air. One sarcophagus lies open, its contents missing.",
                choices: [
                    {text: "Examine the sarcophagi", nextSection: 22, skillCheck: false},
                    {text: "Search the room", nextSection: 23, skillCheck: false},
                    {text: "Take a torch from the wall", nextSection: 24, skillCheck: false},
                    {text: "Leave the side chamber", nextSection: 2, skillCheck: false}
                ]
            },
            9: {
                text: "You descend the grand staircase. The air grows colder with each step. At the bottom, you enter a vast chamber filled with rows of skeletal warriors standing at attention, their empty eye sockets fixed ahead.",
                choices: [
                    {text: "Try to sneak through", nextSection: 25, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Confront the skeletons", nextSection: 26, skillCheck: false},
                    {text: "Look for another way", nextSection: 27, skillCheck: false},
                    {text: "Retreat back up the stairs", nextSection: 3, skillCheck: false}
                ],
                action: function() {
                    playSound('skeleton');
                    return "<span class='skeleton'>The skeletal warriors stand motionless... for now.</span>";
                }
            },
            10: {
                text: "The carvings tell the story of the Vorlak lineage: their rise to power, great battles, dark rituals. One section shows a ritual chamber deep below the castle where a powerful artifact is used to control the dead.",
                choices: [
                    {text: "Continue descending", nextSection: 9, skillCheck: false},
                    {text: "Return to the antechamber", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.foundCryptMap = true;
                    addToInventory('Crypt Carving Knowledge');
                    playSound('item');
                    return "You learn valuable information about the crypt's layout and the ritual chamber below.";
                }
            },
            11: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You spot a pressure plate trap on the fifth step! You carefully avoid it.";
                    } else {
                        const trapDamage = rollDice(2, 6);
                        gameState.health -= trapDamage;
                        updateStatsDisplay();
                        playSound('trap');
                        return "You trigger a dart trap! Poisoned darts shoot from the walls, dealing " + trapDamage + " damage.";
                    }
                }
            },
            12: {
                text: "The narrow passage opens into a circular chamber with a domed ceiling. In the center stands a stone pedestal holding a glowing crystal. Four archways lead from the chamber, each marked with a different symbol.",
                choices: [
                    {text: "Examine the crystal", nextSection: 29, skillCheck: false},
                    {text: "Take the crystal", nextSection: 30, skillCheck: false},
                    {text: "Choose the moon archway", nextSection: 31, skillCheck: false},
                    {text: "Choose the bat archway", nextSection: 32, skillCheck: false},
                    {text: "Choose the skull archway", nextSection: 33, skillCheck: false},
                    {text: "Choose the crown archway", nextSection: 34, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The crystal pulses with soft blue light, illuminating the entire chamber.";
                }
            },
            13: {
                text: "Feeling along the walls, you discover a hidden lever behind a loose stone. When pulled, a section of wall slides open to reveal a hidden chamber.",
                choices: [
                    {text: "Enter the hidden chamber", nextSection: 35, skillCheck: false},
                    {text: "Continue down the passage", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "You've found a secret room!";
                }
            },
            14: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 36, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You hear the faint sound of dripping water ahead, and something else... the soft clatter of bones.";
                    } else {
                        playSound('failure');
                        return "You hear nothing but your own breathing and heartbeat.";
                    }
                }
            },
            15: {
                text: "The stone altar is stained dark with what looks like old blood. Ritual implements lie upon it: a tarnished silver knife, a black candle, and an empty chalice. Carvings on the altar depict a sacrificial ritual.",
                choices: [
                    {text: "Take the ritual implements", nextSection: 37, skillCheck: false},
                    {text: "Examine the carvings", nextSection: 38, skillCheck: false},
                    {text: "Return to examining the antechamber", nextSection: 5, skillCheck: false}
                ]
            },
            16: {
                text: "The wall carvings are a chronological history: 1. The first Vorlak embraces vampirism. 2. The family establishes their castle. 3. They conquer the surrounding lands. 4. A ritual grants them power over the dead. 5. They build the crypt to house their ancestors.",
                choices: [
                    {text: "Return to examining the antechamber", nextSection: 5, skillCheck: false},
                    {text: "Check for hidden passages", nextSection: 17, skillCheck: false}
                ]
            },
            17: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 39, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You find a hidden door behind a tapestry! It leads to a secret passage.";
                    } else {
                        playSound('failure');
                        return "You search thoroughly but find no hidden passages.";
                    }
                }
            },
            18: {
                text: "<span class='ghost'>'We are the guardians of this crypt,'</span> the lead ghost whispers. <span class='ghost'>'Why do you trespass? Do you seek the master's treasure or his destruction?'</span>",
                choices: [
                    {text: "Say you seek to destroy Valerius", nextSection: 40, skillCheck: false},
                    {text: "Say you seek treasure", nextSection: 41, skillCheck: false},
                    {text: "Ask about the crypt's secrets", nextSection: 42, skillCheck: false},
                    {text: "Attack the ghosts", nextSection: 19, skillCheck: false}
                ]
            },
            19: {
                text: "You attack the ghosts, but your weapon passes through them! They retaliate with chilling touch attacks.",
                choices: [
                    {text: "Continue fighting", nextSection: 43, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Crypt Wraiths";
                    combatState.enemyHealth = 75;
                    combatState.enemyCurrentHealth = 75;
                    combatState.enemyStrength = 14;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 44;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 3;
                    
                    playSound('wraith');
                    return "<span class='wraith'>Crypt Wraiths (3)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            20: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 45, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You slip past the ghosts unnoticed. They continue their eternal whispering.";
                    } else {
                        // Ghosts notice and attack
                        combatState.active = true;
                        combatState.enemyName = "Angered Wraith";
                        combatState.enemyHealth = 50;
                        combatState.enemyCurrentHealth = 50;
                        combatState.enemyStrength = 12;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 46;
                        combatState.round = 1;
                        combatState.isGroup = false;
                        
                        playSound('wraith');
                        return "The ghosts notice you!<br><br><span class='wraith'>Angered Wraith</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            21: {
                text: "After searching the niches, you continue down the left passage.",
                choices: [
                    {text: "Follow the whispering", nextSection: 6, skillCheck: false},
                    {text: "Return to the antechamber", nextSection: 1, skillCheck: false}
                ]
            },
            22: {
                text: "You approach the stone sarcophagi. The cold intensifies as you near them. The open one is empty, but the others are sealed with heavy stone lids.",
                choices: [
                    {text: "Open a sealed sarcophagus", nextSection: 47, skillCheck: true, checkType: 'strength', difficulty: 16},
                    {text: "Search the room", nextSection: 23, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 8, skillCheck: false}
                ]
            },
            23: {
                text: "You search the side chamber. Behind one of the sarcophagi, you find a small hidden alcove containing various items.",
                choices: [
                    {text: "Take the items", nextSection: 48, skillCheck: false},
                    {text: "Examine the sarcophagi", nextSection: 22, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    addToInventory('Ancient Crypt Key');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and an <span class='item'>Ancient Crypt Key</span>.";
                }
            },
            24: {
                text: "You take a torch from the wall. Its blue flame burns without consuming the wood and emits no heat.",
                choices: [
                    {text: "Examine the sarcophagi", nextSection: 22, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 8, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Eternal Blue Torch');
                    playSound('item');
                    return "You take an <span class='item'>Eternal Blue Torch</span>. It provides eerie blue light but no warmth.";
                }
            },
            25: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 49, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You move silently between the skeletal warriors. They remain motionless as you pass through the chamber.";
                    } else {
                        // Skeletons animate and attack
                        combatState.active = true;
                        combatState.enemyName = "Skeleton Warriors";
                        combatState.enemyHealth = 80;
                        combatState.enemyCurrentHealth = 80;
                        combatState.enemyStrength = 15;
                        combatState.enemyDamageDice = 3;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 50;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 5;
                        
                        playSound('skeleton');
                        return "The skeletons animate!<br><br><span class='skeleton'>Skeleton Warriors (5)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            26: {
                text: "You approach the skeletal warriors. Their empty eye sockets seem to focus on you, and they raise their rusted weapons.",
                choices: [
                    {text: "Fight the skeletons", nextSection: 51, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Skeleton Warriors";
                    combatState.enemyHealth = 80;
                    combatState.enemyCurrentHealth = 80;
                    combatState.enemyStrength = 15;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 50;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 5;
                    
                    playSound('skeleton');
                    return "<span class='skeleton'>Skeleton Warriors (5)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            27: {
                text: "You look for another way around the skeletal chamber. Along the wall, you find a narrow passage hidden behind a tapestry.",
                choices: [
                    {text: "Take the hidden passage", nextSection: 52, skillCheck: false},
                    {text: "Return to confront the skeletons", nextSection: 26, skillCheck: false}
                ]
            },
            28: {
                text: "After dealing with the trap, you continue down the staircase.",
                choices: [
                    {text: "Descend to the skeletal chamber", nextSection: 9, skillCheck: false},
                    {text: "Return to the antechamber", nextSection: 3, skillCheck: false}
                ]
            },
            29: {
                text: "The crystal pulses with a steady rhythm. Looking closely, you see symbols etched into its surface: moon, bat, skull, crown - the same symbols as on the archways.",
                choices: [
                    {text: "Take the crystal", nextSection: 30, skillCheck: false},
                    {text: "Choose the moon archway", nextSection: 31, skillCheck: false},
                    {text: "Return to the narrow passage", nextSection: 4, skillCheck: false}
                ],
                action: function() {
                    return "The crystal seems to be some kind of key or focus. The symbols might indicate the correct path.";
                }
            },
            30: {
                text: "You take the crystal from the pedestal. As you lift it, the archways glow briefly, then fade. The crystal grows warm in your hand.",
                choices: [
                    {text: "Choose the moon archway", nextSection: 31, skillCheck: false},
                    {text: "Choose the bat archway", nextSection: 32, skillCheck: false},
                    {text: "Return the crystal", nextSection: 53, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Glowing Crypt Crystal');
                    gameState.solvedPuzzle = true;
                    playSound('item');
                    return "You take the <span class='item'>Glowing Crypt Crystal</span>. It might be important for navigating the crypt.";
                }
            },
            31: {
                text: "You enter the moon archway. The passage beyond is lined with silver tiles that reflect the crystal's light. It leads to a chamber with a vaulted ceiling painted with stars.",
                choices: [
                    {text: "Explore the moon chamber", nextSection: 54, skillCheck: false},
                    {text: "Return to the crystal chamber", nextSection: 12, skillCheck: false}
                ]
            },
            32: {
                text: "The bat archway leads to a descending spiral staircase. The walls are carved with thousands of tiny bats. The air grows colder as you descend.",
                choices: [
                    {text: "Descend the bat staircase", nextSection: 55, skillCheck: false},
                    {text: "Return to the crystal chamber", nextSection: 12, skillCheck: false}
                ]
            },
            33: {
                text: "The skull archway opens into a tomb filled with bones piled high. The skulls seem to watch you as you enter. A feeling of dread settles over you.",
                choices: [
                    {text: "Search the bone tomb", nextSection: 56, skillCheck: false},
                    {text: "Leave quickly", nextSection: 12, skillCheck: false}
                ]
            },
            34: {
                text: "The crown archway is the grandest, leading to a throne room with a stone throne atop a dais. Sitting on the throne is a skeletal figure wearing tattered royal robes and a rusted crown.",
                choices: [
                    {text: "Approach the throne", nextSection: 57, skillCheck: false},
                    {text: "Search the room", nextSection: 58, skillCheck: false},
                    {text: "Leave quietly", nextSection: 12, skillCheck: false}
                ]
            },
            35: {
                text: "The hidden chamber contains a small study. A dusty desk holds parchment and writing implements. Books line shelves on the walls. This seems to be where the crypt keeper recorded burials.",
                choices: [
                    {text: "Search the desk", nextSection: 59, skillCheck: false},
                    {text: "Examine the books", nextSection: 60, skillCheck: false},
                    {text: "Take anything valuable", nextSection: 61, skillCheck: false},
                    {text: "Leave the hidden chamber", nextSection: 13, skillCheck: false}
                ]
            },
            36: {
                text: "After listening, you continue down the narrow passage.",
                choices: [
                    {text: "Continue to the crystal chamber", nextSection: 12, skillCheck: false},
                    {text: "Return to the antechamber", nextSection: 4, skillCheck: false}
                ]
            },
            37: {
                text: "You take the ritual implements from the altar. They might be useful or valuable.",
                choices: [
                    {text: "Examine the carvings", nextSection: 38, skillCheck: false},
                    {text: "Return to the antechamber", nextSection: 5, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Tarnished Silver Knife');
                    addToInventory('Black Ritual Candle');
                    addToInventory('Empty Chalice');
                    playSound('item');
                    return "You take the <span class='item'>Tarnished Silver Knife</span>, <span class='item'>Black Ritual Candle</span>, and <span class='item'>Empty Chalice</span>.";
                }
            },
            38: {
                text: "The carvings show a vampire lord sacrificing a human on the altar while other vampires drink from the chalice. The ritual seems to grant them increased power over the dead.",
                choices: [
                    {text: "Take the ritual implements", nextSection: 37, skillCheck: false},
                    {text: "Return to the antechamber", nextSection: 5, skillCheck: false}
                ]
            },
            39: {
                text: "After your search, you return to examining the antechamber.",
                choices: [
                    {text: "Examine the altar", nextSection: 15, skillCheck: false},
                    {text: "Study the wall carvings", nextSection: 16, skillCheck: false},
                    {text: "Choose a passage to explore", nextSection: 1, skillCheck: false}
                ]
            },
            40: {
                text: "<span class='ghost'>'Then you have our blessing,'</span> the ghost whispers. <span class='ghost'>'Valerius defiles this crypt with his presence. Take this knowledge: his power comes from the Heartstone in the lowest chamber. Destroy it, and you weaken him greatly.'</span>",
                choices: [
                    {text: "Ask about the Heartstone", nextSection: 62, skillCheck: false},
                    {text: "Ask about the crypt layout", nextSection: 42, skillCheck: false},
                    {text: "Thank the ghosts and leave", nextSection: 63, skillCheck: false}
                ],
                action: function() {
                    gameState.wraithEncountered = true;
                    playSound('ghost');
                    return "";
                }
            },
            41: {
                text: "<span class='ghost'>'Foolish mortal,'</span> the ghost hisses. <span class='ghost'>'Gold cannot buy peace from the dead. Leave this place or join us in eternity.'</span> The ghosts attack!",
                choices: [
                    {text: "Fight the ghosts", nextSection: 19, skillCheck: false},
                    {text: "Flee", nextSection: 64, skillCheck: true, checkType: 'agility', difficulty: 14}
                ]
            },
            42: {
                text: "<span class='ghost'>'The crypt has three levels,'</span> the ghost explains. <span class='ghost'>'This upper level holds the ancient dead. The middle level contains the ritual chambers. The lowest level holds the Heartstone and the passage to the catacombs.'</span>",
                choices: [
                    {text: "Ask about the Heartstone", nextSection: 62, skillCheck: false},
                    {text: "Ask how to reach the lowest level", nextSection: 65, skillCheck: false},
                    {text: "Thank the ghosts and leave", nextSection: 63, skillCheck: false}
                ]
            },
            43: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 66, skillCheck: false}
                ]
            },
            44: {
                text: "With the wraiths defeated, their spectral forms dissipate into mist. The chamber grows still and silent.",
                choices: [
                    {text: "Search the chamber", nextSection: 67, skillCheck: false},
                    {text: "Continue down the passage", nextSection: 68, skillCheck: false}
                ],
                action: function() {
                    gameState.wraithEncountered = true;
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "The wraiths dissipate, leaving behind <span class='gold'>" + goldFound + " Gold</span> and their knowledge of the crypt.";
                }
            },
            45: {
                text: "Having slipped past the ghosts, you find yourself at the end of the left passage. A stone door blocks further progress, marked with ancient vampire runes.",
                choices: [
                    {text: "Examine the door", nextSection: 69, skillCheck: false},
                    {text: "Return to the ghost chamber", nextSection: 6, skillCheck: false}
                ]
            },
            46: {
                text: "With the wraith defeated, you can continue down the passage.",
                choices: [
                    {text: "Continue to the end of the passage", nextSection: 70, skillCheck: false},
                    {text: "Return to the antechamber", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    gameState.wraithEncountered = true;
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "The wraith dissolves, leaving behind <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            47: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 71, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(6, 10);
                        gameState.gold += goldFound;
                        addToInventory('Ancient Vampire Amulet');
                        updateStatsDisplay();
                        playSound('item');
                        return "You open the sarcophagus! Inside you find <span class='gold'>" + goldFound + " Gold</span> and an <span class='item'>Ancient Vampire Amulet</span>.";
                    } else {
                        playSound('failure');
                        return "The lid is too heavy. You cannot budge it.";
                    }
                }
            },
            48: {
                text: "With the items from the hidden alcove, you return to examining the chamber.",
                choices: [
                    {text: "Open a sealed sarcophagus", nextSection: 47, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 8, skillCheck: false}
                ]
            },
            49: {
                text: "Having passed through the skeletal chamber, you find yourself at a crossroads. Three passages continue from here.",
                choices: [
                    {text: "Take the left passage", nextSection: 72, skillCheck: false},
                    {text: "Take the center passage", nextSection: 73, skillCheck: false},
                    {text: "Take the right passage", nextSection: 74, skillCheck: false},
                    {text: "Return through the skeletal chamber", nextSection: 9, skillCheck: false}
                ]
            },
            50: {
                text: "With the skeleton warriors defeated, you stand amidst their scattered bones. The chamber beyond is now clear.",
                choices: [
                    {text: "Continue to the crossroads", nextSection: 75, skillCheck: false},
                    {text: "Search the chamber", nextSection: 76, skillCheck: false}
                ],
                action: function() {
                    gameState.skeletonWarriorsDefeated = true;
                    const goldFound = rollDice(8, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> among the bones, along with some still-serviceable weapons.";
                }
            },
            51: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 77, skillCheck: false}
                ]
            },
            52: {
                text: "The hidden passage winds through the crypt's walls, eventually emerging in a chamber with a spiral staircase leading downward.",
                choices: [
                    {text: "Descend the staircase", nextSection: 78, skillCheck: false},
                    {text: "Return to the skeletal chamber", nextSection: 9, skillCheck: false}
                ]
            },
            53: {
                text: "You return the crystal to the pedestal. The archways glow again as it settles into place.",
                choices: [
                    {text: "Choose the moon archway", nextSection: 31, skillCheck: false},
                    {text: "Choose the bat archway", nextSection: 32, skillCheck: false}
                ]
            },
            54: {
                text: "The moon chamber contains an observatory with a telescope pointed at a painted night sky. Star charts cover the walls. A silver chest sits beneath the largest star chart.",
                choices: [
                    {text: "Open the silver chest", nextSection: 79, skillCheck: false},
                    {text: "Examine the star charts", nextSection: 80, skillCheck: false},
                    {text: "Return to the crystal chamber", nextSection: 12, skillCheck: false}
                ]
            },
            55: {
                text: "The bat staircase descends deep into the earth. At the bottom, you find a chamber filled with sleeping bats hanging from the ceiling. In the center stands a stone altar with a black gem.",
                choices: [
                    {text: "Take the black gem", nextSection: 81, skillCheck: false},
                    {text: "Try not to disturb the bats", nextSection: 82, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Return up the staircase", nextSection: 12, skillCheck: false}
                ]
            },
            56: {
                text: "As you search the bone tomb, the skulls begin to rattle and move. They roll toward you, forming into a monstrous bone construct!",
                choices: [
                    {text: "Fight the bone construct", nextSection: 83, skillCheck: false},
                    {text: "Flee the tomb", nextSection: 84, skillCheck: true, checkType: 'agility', difficulty: 12}
                ],
                action: function() {
                    playSound('skeleton');
                    return "<span class='skeleton'>A Bone Construct</span> forms from the scattered bones, towering over you!";
                }
            },
            57: {
                text: "You approach the throne. The skeletal figure's head turns slowly to look at you. Empty eye sockets seem to study you. <span class='skeleton'>'Who disturbs the rest of King Vorlok the First?'</span>",
                choices: [
                    {text: "Say you seek passage to the catacombs", nextSection: 85, skillCheck: false},
                    {text: "Attack the skeleton king", nextSection: 86, skillCheck: false},
                    {text: "Bow respectfully", nextSection: 87, skillCheck: false},
                    {text: "Retreat from the throne room", nextSection: 12, skillCheck: false}
                ]
            },
            58: {
                text: "You search the throne room while avoiding the skeletal figure. Behind the throne, you find a hidden compartment containing treasure.",
                choices: [
                    {text: "Take the treasure", nextSection: 88, skillCheck: false},
                    {text: "Approach the throne", nextSection: 57, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(10, 10);
                    gameState.gold += goldFound;
                    addToInventory('Royal Scepter');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Royal Scepter</span>!";
                }
            },
            59: {
                text: "The desk holds ledgers of burials, notes on crypt maintenance, and a map of the crypt levels. The most recent entry mentions 'disturbances near the Heartstone chamber'.",
                choices: [
                    {text: "Take the map", nextSection: 89, skillCheck: false},
                    {text: "Examine the books", nextSection: 60, skillCheck: false}
                ],
                action: function() {
                    gameState.foundCryptMap = true;
                    addToInventory('Detailed Crypt Map');
                    playSound('item');
                    return "You find a <span class='item'>Detailed Crypt Map</span> showing all three levels and secret passages.";
                }
            },
            60: {
                text: "The books are histories of the Vorlak family, records of their victims, and notes on vampire lore. One book details the creation of the Heartstone and its connection to Valerius's power.",
                choices: [
                    {text: "Take the vampire lore book", nextSection: 90, skillCheck: false},
                    {text: "Search the desk", nextSection: 59, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Vampire Lore Tome');
                    playSound('item');
                    return "You take a <span class='item'>Vampire Lore Tome</span>. It might contain valuable information.";
                }
            },
            61: {
                text: "You take anything of value from the study.",
                choices: [
                    {text: "Leave the hidden chamber", nextSection: 35, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    addToInventory('Crypt Keeper Quill');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Crypt Keeper Quill</span> made from a raven's feather.";
                }
            },
            62: {
                text: "<span class='ghost'>'The Heartstone is an ancient artifact that amplifies vampire power,'</span> the ghost explains. <span class='ghost'>'Valerius uses it to control the dead and strengthen his own abilities. It lies in the lowest chamber, guarded by his most powerful servants.'</span>",
                choices: [
                    {text: "Ask how to destroy it", nextSection: 91, skillCheck: false},
                    {text: "Thank the ghosts and leave", nextSection: 63, skillCheck: false}
                ]
            },
            63: {
                text: "The ghosts fade back into the walls, their whispering growing faint. You're left alone in the chamber.",
                choices: [
                    {text: "Continue to the end of the passage", nextSection: 70, skillCheck: false},
                    {text: "Return to the antechamber", nextSection: 2, skillCheck: false}
                ]
            },
            64: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 92, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You flee back down the passage, the ghosts' angry whispers fading behind you.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "A ghost grabs you as you flee, dealing " + damage + " damage before you escape.";
                    }
                }
            },
            65: {
                text: "<span class='ghost'>'The central staircase leads to the middle level,'</span> the ghost says. <span class='ghost'>'From there, find the Chamber of Decay. Within it lies the entrance to the lowest level and the Heartstone chamber.'</span>",
                choices: [
                    {text: "Thank the ghosts and leave", nextSection: 63, skillCheck: false}
                ]
            },
            66: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 43, skillCheck: false}
                ]
            },
            67: {
                text: "You search the ghost chamber. In a corner, you find items left by previous intruders.",
                choices: [
                    {text: "Take the items", nextSection: 93, skillCheck: false},
                    {text: "Continue down the passage", nextSection: 68, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(2, 10);
                    gameState.gold += goldFound;
                    addToInventory('Ghost-touched Dagger');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Ghost-touched Dagger</span> that feels unnaturally cold.";
                }
            },
            68: {
                text: "You continue down the left passage, reaching a stone door marked with ancient vampire runes.",
                choices: [
                    {text: "Examine the door", nextSection: 69, skillCheck: false},
                    {text: "Return to the ghost chamber", nextSection: 6, skillCheck: false}
                ]
            },
            69: {
                text: "The stone door is carved with vampire runes that glow faintly. The inscription reads: 'Here lie the ancient ones. Disturb not their rest.' The door has no visible handle or lock.",
                choices: [
                    {text: "Try to open the door", nextSection: 94, skillCheck: true, checkType: 'strength', difficulty: 18},
                    {text: "Look for a hidden mechanism", nextSection: 95, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Return down the passage", nextSection: 68, skillCheck: false}
                ]
            },
            70: {
                text: "You reach the end of the left passage. A stone door blocks further progress. This seems to be as far as this passage goes.",
                choices: [
                    {text: "Examine the door", nextSection: 69, skillCheck: false},
                    {text: "Return to the antechamber", nextSection: 2, skillCheck: false}
                ]
            },
            71: {
                text: "After attempting to open the sarcophagus, you consider your next move.",
                choices: [
                    {text: "Search the room", nextSection: 23, skillCheck: false},
                    {text: "Leave the chamber", nextSection: 8, skillCheck: false}
                ]
            },
            72: {
                text: "The left passage leads to a chamber filled with standing sarcophagi arranged in a circle. In the center, a stone pedestal holds an ornate key.",
                choices: [
                    {text: "Take the key", nextSection: 96, skillCheck: false},
                    {text: "Examine the sarcophagi", nextSection: 97, skillCheck: false},
                    {text: "Return to the crossroads", nextSection: 49, skillCheck: false}
                ]
            },
            73: {
                text: "The center passage opens into a large ritual chamber. A stone altar dominates the room, stained with dark substances. Symbols are carved into the floor, forming a complex magical circle.",
                choices: [
                    {text: "Examine the altar", nextSection: 98, skillCheck: false},
                    {text: "Study the magical circle", nextSection: 99, skillCheck: false},
                    {text: "Search the room", nextSection: 100, skillCheck: false},
                    {text: "Return to the crossroads", nextSection: 49, skillCheck: false}
                ]
            },
            74: {
                text: "The right passage descends further into the crypt. The air grows colder and smells of decay. At the end, you find a chamber with a spiral staircase leading downward - the way to the lowest level!",
                choices: [
                    {text: "Descend to the lowest level", nextSection: 101, skillCheck: false},
                    {text: "Return to the crossroads", nextSection: 49, skillCheck: false}
                ]
            },
            75: {
                text: "You reach the crossroads beyond the skeletal chamber.",
                choices: [
                    {text: "Take the left passage", nextSection: 72, skillCheck: false},
                    {text: "Take the center passage", nextSection: 73, skillCheck: false},
                    {text: "Take the right passage", nextSection: 74, skillCheck: false}
                ]
            },
            76: {
                text: "You search the skeletal chamber. Among the bones, you find items dropped by previous adventurers.",
                choices: [
                    {text: "Take the items", nextSection: 102, skillCheck: false},
                    {text: "Continue to the crossroads", nextSection: 75, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    addToInventory('Skeleton Finger Bone Key');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a macabre <span class='item'>Skeleton Finger Bone Key</span>.";
                }
            },
            77: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 51, skillCheck: false}
                ]
            },
            78: {
                text: "You descend the hidden staircase. It emerges in the middle level of the crypt, in a dusty corridor lined with burial niches.",
                choices: [
                    {text: "Explore the corridor", nextSection: 103, skillCheck: false},
                    {text: "Return up the staircase", nextSection: 52, skillCheck: false}
                ]
            },
            79: {
                text: "You open the silver chest. Inside, you find star charts and astrological instruments, along with some treasure.",
                choices: [
                    {text: "Take the contents", nextSection: 104, skillCheck: false},
                    {text: "Examine the star charts", nextSection: 80, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    addToInventory('Silver Astrolabe');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Silver Astrolabe</span>.";
                }
            },
            80: {
                text: "The star charts show constellations important to vampire lore. One chart indicates certain stars' positions can weaken vampire powers. This knowledge could be useful.",
                choices: [
                    {text: "Open the silver chest", nextSection: 79, skillCheck: false},
                    {text: "Return to the crystal chamber", nextSection: 12, skillCheck: false}
                ]
            },
            81: {
                text: "You take the black gem from the altar. As you do, the bats awaken! They swarm around you in a dark cloud.",
                choices: [
                    {text: "Fight through the bats", nextSection: 105, skillCheck: false},
                    {text: "Flee back up the staircase", nextSection: 106, skillCheck: true, checkType: 'agility', difficulty: 14}
                ],
                action: function() {
                    addToInventory('Black Bat Gem');
                    playSound('item');
                    return "You take the <span class='item'>Black Bat Gem</span>, but disturb the sleeping bats!";
                }
            },
            82: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 107, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You move silently past the sleeping bats and take the black gem without disturbing them.";
                    } else {
                        // Bats awaken
                        const batDamage = rollDice(1, 6);
                        gameState.health -= batDamage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You accidentally disturb the bats! They swarm around you, dealing " + batDamage + " damage before you escape with the gem.";
                    }
                }
            },
            83: {
                text: "The bone construct attacks with surprising speed for something made of scattered bones!",
                choices: [
                    {text: "Fight the bone construct", nextSection: 108, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Bone Construct";
                    combatState.enemyHealth = 65;
                    combatState.enemyCurrentHealth = 65;
                    combatState.enemyStrength = 16;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 109;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('skeleton');
                    return "<span class='skeleton'>Bone Construct</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            84: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 110, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You flee the bone tomb just as the construct fully forms. You slam the door behind you.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The bone construct grabs you as you flee, dealing " + damage + " damage before you escape.";
                    }
                }
            },
            85: {
                text: "<span class='skeleton'>'The catacombs...'</span> the skeleton king muses. <span class='skeleton'>'Valerius defiles our ancestral resting place with his experiments there. I will grant you passage if you promise to end his desecration.'</span>",
                choices: [
                    {text: "Swear to end Valerius's desecration", nextSection: 111, skillCheck: false},
                    {text: "Attack the skeleton king", nextSection: 86, skillCheck: false},
                    {text: "Ask for a token of passage", nextSection: 112, skillCheck: false}
                ]
            },
            86: {
                text: "You attack the skeleton king! He rises from his throne, drawing a rusted but still deadly sword.",
                choices: [
                    {text: "Fight the skeleton king", nextSection: 113, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Skeleton King Vorlok";
                    combatState.enemyHealth = 100;
                    combatState.enemyCurrentHealth = 100;
                    combatState.enemyStrength = 18;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 114;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('skeleton');
                    return "<span class='skeleton'>Skeleton King Vorlok</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            87: {
                text: "You bow respectfully before the skeleton king. <span class='skeleton'>'Rare is the mortal who shows proper respect,'</span> he says. <span class='skeleton'>'For your courtesy, I grant you safe passage through my domain. Take this key - it will unlock the way to the lowest level.'</span>",
                choices: [
                    {text: "Take the key", nextSection: 115, skillCheck: false},
                    {text: "Ask about Valerius", nextSection: 116, skillCheck: false}
                ]
            },
            88: {
                text: "After taking the treasure, you approach the throne.",
                choices: [
                    {text: "Address the skeleton king", nextSection: 57, skillCheck: false},
                    {text: "Leave the throne room", nextSection: 12, skillCheck: false}
                ]
            },
            89: {
                text: "With the crypt map, you have a much better understanding of the crypt's layout.",
                choices: [
                    {text: "Examine the books", nextSection: 60, skillCheck: false},
                    {text: "Leave the hidden chamber", nextSection: 35, skillCheck: false}
                ]
            },
            90: {
                text: "With the vampire lore book, you continue searching the study.",
                choices: [
                    {text: "Search the desk", nextSection: 59, skillCheck: false},
                    {text: "Leave the hidden chamber", nextSection: 35, skillCheck: false}
                ]
            },
            91: {
                text: "<span class='ghost'>'The Heartstone can be destroyed with pure silver blessed by a priest,'</span> the ghost says. <span class='ghost'>'Or with sunlight, though none reaches that deep. Or with the blood of a Vorlak vampire - their own blood can unravel the magic.'</span>",
                choices: [
                    {text: "Thank the ghosts and leave", nextSection: 63, skillCheck: false}
                ]
            },
            92: {
                text: "Having fled from the ghosts, you catch your breath in the passage.",
                choices: [
                    {text: "Continue down the passage", nextSection: 70, skillCheck: false},
                    {text: "Return to the antechamber", nextSection: 2, skillCheck: false}
                ]
            },
            93: {
                text: "With the items from the ghost chamber, you continue your exploration.",
                choices: [
                    {text: "Continue to the end of the passage", nextSection: 68, skillCheck: false},
                    {text: "Return to the antechamber", nextSection: 2, skillCheck: false}
                ]
            },
            94: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 117, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With great effort, you force the stone door open! It groans in protest but yields.";
                    } else {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The door doesn't budge. You strain yourself, taking " + damage + " damage.";
                    }
                }
            },
            95: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 118, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You find a hidden pressure plate! Stepping on it causes the door to slide open silently.";
                    } else {
                        playSound('failure');
                        return "You find no hidden mechanisms. The door seems to require immense strength to open.";
                    }
                }
            },
            96: {
                text: "You take the ornate key from the pedestal. As you do, the sarcophagi around the room begin to open!",
                choices: [
                    {text: "Prepare for combat", nextSection: 119, skillCheck: false},
                    {text: "Flee with the key", nextSection: 120, skillCheck: true, checkType: 'agility', difficulty: 15}
                ],
                action: function() {
                    addToInventory('Ornate Sarcophagus Key');
                    playSound('item');
                    return "You take the <span class='item'>Ornate Sarcophagus Key</span>, but disturb the room's guardians!";
                }
            },
            97: {
                text: "You examine the sarcophagi. They are carved with images of vampire knights. One bears an inscription: 'Guardians of the Way. Sleep until the key is taken.'",
                choices: [
                    {text: "Take the key", nextSection: 96, skillCheck: false},
                    {text: "Return to the crossroads", nextSection: 72, skillCheck: false}
                ]
            },
            98: {
                text: "The altar is stained with dark, dried substances. Ritual tools lie upon it: a silver dagger, a black candle, and a bowl containing dust. Carvings on the altar depict a ritual to raise the dead.",
                choices: [
                    {text: "Take the ritual tools", nextSection: 121, skillCheck: false},
                    {text: "Study the magical circle", nextSection: 99, skillCheck: false}
                ]
            },
            99: {
                text: "The magical circle is complex, with symbols for necromancy, binding, and power amplification. It seems designed to channel energy from the Heartstone below to empower rituals performed at the altar.",
                choices: [
                    {text: "Examine the altar", nextSection: 98, skillCheck: false},
                    {text: "Search the room", nextSection: 100, skillCheck: false}
                ]
            },
            100: {
                text: "You search the ritual chamber. In a shadowy corner, you find a chest covered in dust.",
                choices: [
                    {text: "Open the chest", nextSection: 122, skillCheck: false},
                    {text: "Examine the altar", nextSection: 98, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(6, 10);
                    gameState.gold += goldFound;
                    addToInventory('Necromancer Robes');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and <span class='item'>Necromancer Robes</span> that might offer protection against dark magic.";
                }
            },
            101: {
                text: "You descend the spiral staircase to the lowest level of the crypt. The air here is thick with magical energy and the scent of ozone. At the bottom, you enter a vast chamber dominated by a glowing red crystal floating above a stone pedestal - the Heartstone!",
                choices: [
                    {text: "Approach the Heartstone", nextSection: 123, skillCheck: false},
                    {text: "Examine the chamber", nextSection: 124, skillCheck: false},
                    {text: "Look for the catacombs entrance", nextSection: 125, skillCheck: false}
                ],
                action: function() {
                    playSound('lich');
                    return "The <span class='lich'>Heartstone</span> pulses with dark energy, casting a bloody light throughout the chamber.";
                }
            },
            102: {
                text: "After searching the skeletal chamber, you continue to the crossroads.",
                choices: [
                    {text: "Take the left passage", nextSection: 72, skillCheck: false},
                    {text: "Take the center passage", nextSection: 73, skillCheck: false},
                    {text: "Take the right passage", nextSection: 74, skillCheck: false}
                ]
            },
            103: {
                text: "You explore the dusty corridor. Burial niches line the walls, each containing skeletal remains. At the end of the corridor, you find a door marked with the symbol of decay.",
                choices: [
                    {text: "Enter the Chamber of Decay", nextSection: 126, skillCheck: false},
                    {text: "Search the burial niches", nextSection: 127, skillCheck: false},
                    {text: "Return to the staircase", nextSection: 78, skillCheck: false}
                ]
            },
            104: {
                text: "With the contents of the silver chest, you leave the moon chamber.",
                choices: [
                    {text: "Return to the crystal chamber", nextSection: 12, skillCheck: false}
                ]
            },
            105: {
                text: "You fight through the swarm of bats, swinging your weapon to clear a path.",
                choices: [
                    {text: "Continue fighting", nextSection: 128, skillCheck: false}
                ],
                action: function() {
                    const batDamage = rollDice(2, 6);
                    gameState.health -= batDamage;
                    updateStatsDisplay();
                    playSound('damage');
                    return "The bats swarm around you, dealing " + batDamage + " damage as you fight your way free.";
                }
            },
            106: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 129, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You flee up the staircase, the bats swirling angrily behind you but unable to catch you.";
                    } else {
                        const batDamage = rollDice(3, 6);
                        gameState.health -= batDamage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The bats catch up to you on the staircase, dealing " + batDamage + " damage before you escape.";
                    }
                }
            },
            107: {
                text: "With the black gem in hand, you leave the bat chamber.",
                choices: [
                    {text: "Return to the crystal chamber", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Black Bat Gem');
                    playSound('item');
                    return "You have the <span class='item'>Black Bat Gem</span>.";
                }
            },
            108: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 130, skillCheck: false}
                ]
            },
            109: {
                text: "With the bone construct defeated, it collapses into a pile of inert bones. The tomb grows still once more.",
                choices: [
                    {text: "Search the bone tomb", nextSection: 131, skillCheck: false},
                    {text: "Leave the tomb", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "Among the bones, you find <span class='gold'>" + goldFound + " Gold</span> that previous victims carried.";
                }
            },
            110: {
                text: "Having fled the bone tomb, you return to the crystal chamber.",
                choices: [
                    {text: "Choose another archway", nextSection: 12, skillCheck: false}
                ]
            },
            111: {
                text: "<span class='skeleton'>'Swear it on your soul,'</span> the skeleton king demands. <span class='skeleton'>'Swear to end Valerius's desecration of our ancestral crypt.'</span>",
                choices: [
                    {text: "Swear the oath", nextSection: 132, skillCheck: false},
                    {text: "Refuse and attack", nextSection: 86, skillCheck: false}
                ]
            },
            112: {
                text: "<span class='skeleton'>'Take this,'</span> the skeleton king says, removing a bone from his own hand. <span class='skeleton'>'It will open the way to the lowest level. Use it wisely.'</span>",
                choices: [
                    {text: "Take the bone key", nextSection: 133, skillCheck: false},
                    {text: "Swear to end Valerius's desecration", nextSection: 111, skillCheck: false}
                ]
            },
            113: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 134, skillCheck: false}
                ]
            },
            114: {
                text: "With the skeleton king defeated, his bones scatter across the throne room. His crown clatters to the floor.",
                choices: [
                    {text: "Take the crown", nextSection: 135, skillCheck: false},
                    {text: "Search the throne room", nextSection: 136, skillCheck: false}
                ],
                action: function() {
                    gameState.foundCatacombKey = true;
                    const goldFound = rollDice(12, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> among the king's remains, and more importantly, a key to the catacombs!";
                }
            },
            115: {
                text: "The skeleton king hands you a bone key. <span class='skeleton'>'The entrance to the lowest level is in the Chamber of Decay. This will open it. Go with my blessing, mortal.'</span>",
                choices: [
                    {text: "Take the key and leave", nextSection: 137, skillCheck: false},
                    {text: "Ask about Valerius", nextSection: 116, skillCheck: false}
                ],
                action: function() {
                    gameState.foundCatacombKey = true;
                    addToInventory('Skeleton King Bone Key');
                    playSound('item');
                    return "You receive the <span class='item'>Skeleton King Bone Key</span> to the lowest level!";
                }
            },
            116: {
                text: "<span class='skeleton'>'Valerius is the greatest and worst of our line,'</span> the skeleton king says. <span class='skeleton'>'He seeks immortality not just for himself, but to raise all Vorlaks as eternal rulers. He perverts our legacy.'</span>",
                choices: [
                    {text: "Take the key", nextSection: 115, skillCheck: false},
                    {text: "Swear to end his desecration", nextSection: 111, skillCheck: false}
                ]
            },
            117: {
                text: "After attempting to force the door, you try other options.",
                choices: [
                    {text: "Look for a hidden mechanism", nextSection: 95, skillCheck: false},
                    {text: "Return down the passage", nextSection: 68, skillCheck: false}
                ]
            },
            118: {
                text: "After searching for hidden mechanisms, you try other options.",
                choices: [
                    {text: "Try to force the door", nextSection: 94, skillCheck: false},
                    {text: "Return down the passage", nextSection: 68, skillCheck: false}
                ]
            },
            119: {
                text: "Vampire guardians emerge from the sarcophagi! They're not fully alive, but preserved corpses animated by dark magic.",
                choices: [
                    {text: "Fight the vampire guardians", nextSection: 138, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Vampire Guardians";
                    combatState.enemyHealth = 90;
                    combatState.enemyCurrentHealth = 90;
                    combatState.enemyStrength = 16;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 139;
                    combatState.round = 1;
                    combatState.isGroup = true;
                    combatState.groupCount = 3;
                    
                    playSound('vampire');
                    return "<span class='vampire'>Vampire Guardians (3)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            120: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 140, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You grab the key and flee before the guardians fully emerge! You escape back to the crossroads.";
                    } else {
                        // Fight the guardians
                        combatState.active = true;
                        combatState.enemyName = "Vampire Guardians";
                        combatState.enemyHealth = 90;
                        combatState.enemyCurrentHealth = 90;
                        combatState.enemyStrength = 16;
                        combatState.enemyDamageDice = 3;
                        combatState.enemyDamageSides = 8;
                        combatState.nextSection = 141;
                        combatState.round = 1;
                        combatState.isGroup = true;
                        combatState.groupCount = 2; // Only 2 catch up
                        
                        playSound('vampire');
                        return "Two guardians catch up to you!<br><br><span class='vampire'>Vampire Guardians (2)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            121: {
                text: "You take the ritual tools from the altar. They might be useful against undead or for understanding Valerius's magic.",
                choices: [
                    {text: "Study the magical circle", nextSection: 99, skillCheck: false},
                    {text: "Search the room", nextSection: 100, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Ritual Silver Dagger');
                    addToInventory('Black Ritual Candle');
                    addToInventory('Dust Bowl');
                    playSound('item');
                    return "You take the <span class='item'>Ritual Silver Dagger</span>, <span class='item'>Black Ritual Candle</span>, and <span class='item'>Dust Bowl</span>.";
                }
            },
            122: {
                text: "After opening the chest, you examine the rest of the ritual chamber.",
                choices: [
                    {text: "Examine the altar", nextSection: 98, skillCheck: false},
                    {text: "Study the magical circle", nextSection: 99, skillCheck: false}
                ]
            },
            123: {
                text: "You approach the Heartstone. Its red glow intensifies as you near. The air crackles with energy. A figure materializes beside the stone - a lich in tattered robes, guardian of the Heartstone!",
                choices: [
                    {text: "Confront the lich guardian", nextSection: 142, skillCheck: false},
                    {text: "Try to destroy the Heartstone", nextSection: 143, skillCheck: false},
                    {text: "Look for the catacombs entrance", nextSection: 125, skillCheck: false}
                ],
                action: function() {
                    playSound('lich');
                    return "The <span class='lich'>Lich Guardian</span> raises a bony hand. <span class='lich'>'The Heartstone is not for mortal hands. Leave now, or join the eternal guardians of this crypt.'</span>";
                }
            },
            124: {
                text: "The Heartstone chamber is vast, with pillars supporting a vaulted ceiling. The stone itself floats above a pedestal carved with binding runes. Around the chamber, you see several exits, including a massive stone door that must lead to the catacombs.",
                choices: [
                    {text: "Approach the Heartstone", nextSection: 123, skillCheck: false},
                    {text: "Examine the catacombs door", nextSection: 144, skillCheck: false}
                ]
            },
            125: {
                text: "You look for the catacombs entrance. Along the far wall, you find a massive stone door carved with images of suffering souls. It's sealed with a complex lock.",
                choices: [
                    {text: "Try to open the catacombs door", nextSection: 144, skillCheck: false},
                    {text: "Return to the Heartstone", nextSection: 123, skillCheck: false}
                ]
            },
            126: {
                text: "The Chamber of Decay is filled with rotting tapestries, crumbling furniture, and the skeletal remains of failed adventurers. The air smells of mold and death. In the center of the room, a stone door sealed with a bone-shaped lock.",
                choices: [
                    {text: "Try the bone key if you have it", nextSection: 145, skillCheck: false, requirement: 'Skeleton King Bone Key'},
                    {text: "Search the chamber", nextSection: 146, skillCheck: false},
                    {text: "Try to force the door", nextSection: 147, skillCheck: true, checkType: 'strength', difficulty: 20},
                    {text: "Return to the corridor", nextSection: 103, skillCheck: false}
                ]
            },
            127: {
                text: "You search the burial niches. Most contain only bones, but one holds a skeleton clutching a valuable item.",
                choices: [
                    {text: "Take the item", nextSection: 148, skillCheck: false},
                    {text: "Enter the Chamber of Decay", nextSection: 126, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    addToInventory('Burial Niche Amulet');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Burial Niche Amulet</span> that might offer protection in the crypt.";
                }
            },
            128: {
                text: "After fighting through the bats, you escape up the staircase with the gem.",
                choices: [
                    {text: "Return to the crystal chamber", nextSection: 12, skillCheck: false}
                ]
            },
            129: {
                text: "After fleeing the bats, you return to the crystal chamber with the gem.",
                choices: [
                    {text: "Choose another archway", nextSection: 12, skillCheck: false}
                ]
            },
            130: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 108, skillCheck: false}
                ]
            },
            131: {
                text: "You search the bone tomb after defeating the construct. Among the bones, you find items left by previous victims.",
                choices: [
                    {text: "Take the items", nextSection: 149, skillCheck: false},
                    {text: "Leave the tomb", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    addToInventory('Bone Charm');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Bone Charm</span> that feels unnaturally cold.";
                }
            },
            132: {
                text: "<span class='skeleton'>'Your oath is sworn,'</span> the skeleton king says. <span class='skeleton'>'Break it, and your soul will know eternal torment. Now take this key and fulfill your promise.'</span>",
                choices: [
                    {text: "Take the key", nextSection: 150, skillCheck: false}
                ],
                action: function() {
                    gameState.foundCatacombKey = true;
                    addToInventory('Skeleton King Bone Key');
                    playSound('item');
                    return "You swear the oath and receive the <span class='item'>Skeleton King Bone Key</span> to the lowest level!";
                }
            },
            133: {
                text: "You take the bone key from the skeleton king. <span class='skeleton'>'Use it in the Chamber of Decay. Now go, and may your quest succeed where others have failed.'</span>",
                choices: [
                    {text: "Leave the throne room", nextSection: 151, skillCheck: false}
                ],
                action: function() {
                    gameState.foundCatacombKey = true;
                    addToInventory('Skeleton King Bone Key');
                    playSound('item');
                    return "You receive the <span class='item'>Skeleton King Bone Key</span>!";
                }
            },
            134: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 113, skillCheck: false}
                ]
            },
            135: {
                text: "You take the skeleton king's crown. It's heavy and ornate, made of tarnished silver set with dark gemstones.",
                choices: [
                    {text: "Search the throne room", nextSection: 136, skillCheck: false},
                    {text: "Leave the throne room", nextSection: 151, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Skeleton King Crown');
                    playSound('item');
                    return "You take the <span class='item'>Skeleton King Crown</span>. It might have value or significance.";
                }
            },
            136: {
                text: "You search the throne room thoroughly. Behind the throne, you find a hidden compartment containing treasure and a key to the catacombs!",
                choices: [
                    {text: "Take everything", nextSection: 152, skillCheck: false},
                    {text: "Take just the catacomb key", nextSection: 153, skillCheck: false}
                ],
                action: function() {
                    gameState.foundCatacombKey = true;
                    const goldFound = rollDice(10, 10);
                    gameState.gold += goldFound;
                    addToInventory('Catacomb Key');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and the <span class='item'>Catacomb Key</span>!";
                }
            },
            137: {
                text: "With the skeleton king's key, you leave the throne room.",
                choices: [
                    {text: "Return to the crystal chamber", nextSection: 12, skillCheck: false}
                ]
            },
            138: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 154, skillCheck: false}
                ]
            },
            139: {
                text: "With the vampire guardians defeated, they crumble to dust. The chamber grows still once more.",
                choices: [
                    {text: "Search the chamber", nextSection: 155, skillCheck: false},
                    {text: "Return to the crossroads", nextSection: 72, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(8, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> on the guardians' remains.";
                }
            },
            140: {
                text: "With the key and having escaped the guardians, you return to the crossroads.",
                choices: [
                    {text: "Take the center passage", nextSection: 73, skillCheck: false},
                    {text: "Take the right passage", nextSection: 74, skillCheck: false}
                ]
            },
            141: {
                text: "With the pursuing guardians defeated, you catch your breath.",
                choices: [
                    {text: "Return to the crossroads", nextSection: 72, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(4, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> on the guardians' remains.";
                }
            },
            142: {
                text: "The lich guardian attacks with dark magic, raising skeletal hands from the floor to grab at you!",
                choices: [
                    {text: "Fight the lich guardian", nextSection: 156, skillCheck: false},
                    {text: "Try to destroy the Heartstone during the fight", nextSection: 157, skillCheck: true, checkType: 'agility', difficulty: 18}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Lich Guardian";
                    combatState.enemyHealth = 120;
                    combatState.enemyCurrentHealth = 120;
                    combatState.enemyStrength = 20;
                    combatState.enemyDamageDice = 4;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 158;
                    combatState.round = 1;
                    combatState.isGroup = false;
                    
                    playSound('lich');
                    return "<span class='lich'>Lich Guardian</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength + "<br>The lich commands powerful necromantic magic!";
                }
            },
            143: {
                text: "You attempt to destroy the Heartstone while ignoring the lich. This is dangerous - the lich will attack as you try!",
                choices: [
                    {text: "Try to smash it with your weapon", nextSection: 159, skillCheck: true, checkType: 'strength', difficulty: 20},
                    {text: "Use holy water if you have it", nextSection: 160, skillCheck: false, requirement: 'Holy Water'},
                    {text: "Use a silver weapon if you have one", nextSection: 161, skillCheck: false, requirement: function() { 
                        return gameState.equippedWeapon.includes('Silver') || gameState.inventory.some(item => item.includes('Silver'));
                    }},
                    {text: "Confront the lich first", nextSection: 142, skillCheck: false}
                ]
            },
            144: {
                text: "The catacombs door is massive, made of black stone. The lock is intricate, requiring a specific key. Carvings show tormented souls being dragged into darkness.",
                choices: [
                    {text: "Try the catacomb key if you have it", nextSection: 162, skillCheck: false, requirement: function() {
                        return gameState.inventory.some(item => item.includes('Catacomb') || item.includes('Key')) || gameState.foundCatacombKey;
                    }},
                    {text: "Try to force the door", nextSection: 163, skillCheck: true, checkType: 'strength', difficulty: 22},
                    {text: "Look for another way", nextSection: 164, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Return to the Heartstone", nextSection: 123, skillCheck: false}
                ]
            },
            145: {
                text: "You use the skeleton king's bone key in the lock. It fits perfectly! The stone door grinds open, revealing a staircase leading downward to the lowest level.",
                choices: [
                    {text: "Descend to the lowest level", nextSection: 101, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Skeleton King Bone Key');
                    playSound('success');
                    return "The <span class='item'>Skeleton King Bone Key</span> unlocks the door to the lowest level!";
                }
            },
            146: {
                text: "You search the Chamber of Decay. Among the rotting debris, you find items left by previous adventurers who failed to get past this point.",
                choices: [
                    {text: "Take the items", nextSection: 165, skillCheck: false},
                    {text: "Try to open the door", nextSection: 126, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    addToInventory('Adventurer Journal Fragment');
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and an <span class='item'>Adventurer Journal Fragment</span> describing the crypt's dangers.";
                }
            },
            147: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 166, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With immense effort, you force the door open! It groans in protest but yields.";
                    } else {
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The door doesn't budge. You strain yourself, taking " + damage + " damage.";
                    }
                }
            },
            148: {
                text: "With the item from the burial niche, you enter the Chamber of Decay.",
                choices: [
                    {text: "Try to open the door", nextSection: 126, skillCheck: false}
                ]
            },
            149: {
                text: "With the items from the bone tomb, you leave the chamber.",
                choices: [
                    {text: "Return to the crystal chamber", nextSection: 12, skillCheck: false}
                ]
            },
            150: {
                text: "With the skeleton king's key and your sworn oath, you leave the throne room.",
                choices: [
                    {text: "Return to the crystal chamber", nextSection: 12, skillCheck: false}
                ]
            },
            151: {
                text: "You leave the throne room, returning to the crystal chamber.",
                choices: [
                    {text: "Choose another archway", nextSection: 12, skillCheck: false}
                ]
            },
            152: {
                text: "You take everything from the hidden compartment.",
                choices: [
                    {text: "Leave the throne room", nextSection: 151, skillCheck: false}
                ],
                action: function() {
                    gameState.foundCatacombKey = true;
                    const goldFound = rollDice(15, 10);
                    gameState.gold += goldFound;
                    addToInventory('Catacomb Key');
                    addToInventory('Royal Jewels');
                    updateStatsDisplay();
                    playSound('item');
                    return "You take <span class='gold'>" + goldFound + " Gold</span>, the <span class='item'>Catacomb Key</span>, and <span class='item'>Royal Jewels</span>!";
                }
            },
            153: {
                text: "You take just the catacomb key from the hidden compartment.",
                choices: [
                    {text: "Leave the throne room", nextSection: 151, skillCheck: false}
                ],
                action: function() {
                    gameState.foundCatacombKey = true;
                    addToInventory('Catacomb Key');
                    playSound('item');
                    return "You take the <span class='item'>Catacomb Key</span>.";
                }
            },
            154: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 138, skillCheck: false}
                ]
            },
            155: {
                text: "You search the chamber after defeating the vampire guardians. In addition to gold, you find a valuable item on the leader's body.",
                choices: [
                    {text: "Take the item", nextSection: 167, skillCheck: false},
                    {text: "Return to the crossroads", nextSection: 72, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Vampire Guardian Medallion');
                    playSound('item');
                    return "You find a <span class='item'>Vampire Guardian Medallion</span> that might offer protection against vampire attacks.";
                }
            },
            156: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 168, skillCheck: false}
                ]
            },
            157: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 169, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        // Destroy Heartstone during fight
                        gameState.lichDefeated = true;
                        const damageToLich = 50; // Destroying Heartstone damages lich
                        combatState.enemyCurrentHealth -= damageToLich;
                        
                        return "While dodging the lich's attacks, you strike the Heartstone! It cracks, releasing a wave of energy that damages the lich for " + damageToLich + " damage!";
                    } else {
                        const damage = rollDice(4, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The lich strikes you as you try to destroy the Heartstone, dealing " + damage + " damage!";
                    }
                }
            },
            158: {
                text: "With the lich guardian defeated, its bones collapse into a pile. The Heartstone's glow dims slightly.",
                choices: [
                    {text: "Destroy the Heartstone", nextSection: 170, skillCheck: false},
                    {text: "Open the catacombs door", nextSection: 144, skillCheck: false}
                ],
                action: function() {
                    gameState.lichDefeated = true;
                    const goldFound = rollDice(20, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> in the lich's robes!";
                }
            },
            159: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 171, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.lichDefeated = true; // Heartstone destruction weakens/defeats lich
                        return "You smash the Heartstone with all your might! It shatters into fragments, releasing a wave of energy that weakens the lich guardian!";
                    } else {
                        const damage = rollDice(4, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The Heartstone resists your attack! The lich strikes you while you're vulnerable, dealing " + damage + " damage!";
                    }
                }
            },
            160: {
                text: "You use holy water on the Heartstone. It sizzles and cracks, dark energy leaking from the fractures.",
                choices: [
                    {text: "Finish destroying it", nextSection: 172, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Holy Water');
                    gameState.lichDefeated = true;
                    playSound('success');
                    return "The <span class='item'>Holy Water</span> causes the Heartstone to fracture! Dark energy leaks out, and the lich guardian screams in agony as its power source is damaged.";
                }
            },
            161: {
                text: "You strike the Heartstone with your silver weapon. It cracks under the blow, and the lich guardian recoils as if struck.",
                choices: [
                    {text: "Continue attacking the Heartstone", nextSection: 173, skillCheck: false}
                ],
                action: function() {
                    gameState.lichDefeated = true;
                    playSound('success');
                    return "Your silver weapon damages the Heartstone! The lich guardian is weakened as its power source is compromised.";
                }
            },
            162: {
                text: "You use the catacomb key in the lock. It turns smoothly, and the massive stone door groans open, revealing darkness beyond.",
                choices: [
                    {text: "Enter the catacombs", nextSection: 174, skillCheck: false}
                ],
                action: function() {
                    // Remove any key used
                    const keyItem = gameState.inventory.find(item => item.includes('Catacomb') || item.includes('Key'));
                    if (keyItem) removeFromInventory(keyItem);
                    
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 8;
                    saveGame();
                    
                    return "";
                }
            },
            163: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 175, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "With incredible effort, you force the catacombs door open! It protests loudly but yields.";
                    } else {
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The door doesn't budge. You strain yourself, taking " + damage + " damage.";
                    }
                }
            },
            164: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 176, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You find a hidden mechanism - a lever behind a loose stone! Pulling it opens the catacombs door.";
                    } else {
                        playSound('failure');
                        return "You find no alternative way to open the door. It requires a specific key.";
                    }
                }
            },
            165: {
                text: "With the items from the Chamber of Decay, you attempt to open the door.",
                choices: [
                    {text: "Try the bone key if you have it", nextSection: 145, skillCheck: false, requirement: 'Skeleton King Bone Key'},
                    {text: "Try to force the door", nextSection: 147, skillCheck: false}
                ]
            },
            166: {
                text: "After attempting to force the door, you try other options.",
                choices: [
                    {text: "Search for a key", nextSection: 146, skillCheck: false},
                    {text: "Return to the corridor", nextSection: 103, skillCheck: false}
                ]
            },
            167: {
                text: "With the vampire guardian medallion, you return to the crossroads.",
                choices: [
                    {text: "Take the center passage", nextSection: 73, skillCheck: false},
                    {text: "Take the right passage", nextSection: 74, skillCheck: false}
                ]
            },
            168: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 156, skillCheck: false}
                ]
            },
            169: {
                text: "After your attempt to destroy the Heartstone during the fight, combat continues.",
                choices: [
                    {text: "Continue fighting the lich", nextSection: 156, skillCheck: false}
                ]
            },
            170: {
                text: "With the lich defeated, you turn your attention to the Heartstone. How will you destroy it?",
                choices: [
                    {text: "Smash it with your weapon", nextSection: 177, skillCheck: true, checkType: 'strength', difficulty: 16},
                    {text: "Use holy water if you have it", nextSection: 178, skillCheck: false, requirement: 'Holy Water'},
                    {text: "Use a silver weapon if you have one", nextSection: 179, skillCheck: false, requirement: function() { 
                        return gameState.equippedWeapon.includes('Silver') || gameState.inventory.some(item => item.includes('Silver'));
                    }},
                    {text: "Leave it and open the catacombs door", nextSection: 144, skillCheck: false}
                ]
            },
            171: {
                text: "After attempting to destroy the Heartstone, the lich continues its attack!",
                choices: [
                    {text: "Fight the lich", nextSection: 142, skillCheck: false}
                ]
            },
            172: {
                text: "With the Heartstone damaged by holy water, you finish destroying it with your weapon.",
                choices: [
                    {text: "Open the catacombs door", nextSection: 144, skillCheck: false}
                ],
                action: function() {
                    gameState.lichDefeated = true;
                    playSound('success');
                    return "You completely destroy the Heartstone! Valerius's power source is gone. The catacombs door is now accessible.";
                }
            },
            173: {
                text: "You continue attacking the damaged Heartstone until it shatters completely.",
                choices: [
                    {text: "Open the catacombs door", nextSection: 144, skillCheck: false}
                ],
                action: function() {
                    gameState.lichDefeated = true;
                    playSound('success');
                    return "The Heartstone shatters into countless fragments! Valerius's connection to this place is severed. The catacombs door is now accessible.";
                }
            },
            174: {
                text: "YOU HAVE ENTERED THE CATACOMBS! The door closes behind you with a final-sounding thud. You stand at the top of a staircase leading down into even deeper darkness.",
                choices: [],
                action: function() {
                    // This is handled in section 162
                    return "";
                }
            },
            175: {
                text: "After trying to force the catacombs door, you try other options.",
                choices: [
                    {text: "Look for another way", nextSection: 164, skillCheck: false},
                    {text: "Return to the Heartstone", nextSection: 123, skillCheck: false}
                ]
            },
            176: {
                text: "After finding the hidden mechanism, the catacombs door is open!",
                choices: [
                    {text: "Enter the catacombs", nextSection: 174, skillCheck: false}
                ],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 8;
                    saveGame();
                    
                    return "";
                }
            },
            177: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 180, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You smash the Heartstone to fragments! Dark energy dissipates into the air. Valerius's power in this place is broken.";
                    } else {
                        playSound('failure');
                        return "The Heartstone resists your attack. It's incredibly durable.";
                    }
                }
            },
            178: {
                text: "You use holy water on the Heartstone. It hisses and cracks, then shatters into pieces.",
                choices: [
                    {text: "Open the catacombs door", nextSection: 144, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Holy Water');
                    playSound('success');
                    return "The <span class='item'>Holy Water</span> destroys the Heartstone completely!";
                }
            },
            179: {
                text: "You attack the Heartstone with your silver weapon. It shatters under the blows.",
                choices: [
                    {text: "Open the catacombs door", nextSection: 144, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "Your silver weapon destroys the Heartstone!";
                }
            },
            180: {
                text: "After destroying the Heartstone, you can now access the catacombs.",
                choices: [
                    {text: "Open the catacombs door", nextSection: 144, skillCheck: false}
                ]
            }
        };
        
        // Initialize game for Level 7
        function initGame() {
            // Load game state from Level 6
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 7 (coming from Level 6)
                if (savedState.level === 7) {
                    Object.assign(gameState, savedState);
                    
                    // Update intro screen with loaded stats
                    document.getElementById('intro-stat-strength').textContent = gameState.strength;
                    document.getElementById('intro-stat-health').textContent = gameState.health;
                    document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('intro-stat-agility').textContent = gameState.agility;
                    document.getElementById('intro-stat-gold').textContent = gameState.gold;
                    
                    showScreen('screen-intro');
                    return;
                } else if (savedState.level === 6) {
                    // If coming directly from Level 6 without completing it
                    alert("You must complete Level 6 first!");
                    window.location.href = 'l6.html';
                    return;
                }
            } else {
                // No saved game found
                alert("No saved game found. Starting from Level 1.");
                window.location.href = 'l1.html';
                return;
            }
        }
        
        function startLevel7() {
            playSound('click');
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item) && item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Sarcophagus selection functions
        function selectSarcophagus(sarcophagusType) {
            playSound('item');
            const result = sarcophagusResults[sarcophagusType];
            
            // Add gold if any
            if (result.gold) {
                gameState.gold += result.gold;
                updateStatsDisplay();
            }
            
            // Add item if any
            if (result.item) {
                addToInventory(result.item);
            }
            
            // Show feedback
            document.getElementById('sarcophagus-feedback-text').innerHTML = result.text + 
                (result.gold ? `<br><br>You find <span class='gold'>${result.gold} Gold</span>` : '') +
                (result.item ? ` and a <span class='item'>${result.item}</span>.` : '.') +
                (result.special ? `<br><br>${result.special}` : '');
            document.getElementById('sarcophagus-feedback').style.display = 'block';
            
            gameState.examinedSarcophagi = true;
        }
        
        function cancelSarcophagusSelection() {
            playSound('click');
            showScreen('screen-game');
            loadSection(22); // Return to sarcophagus examination
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Potion' || item === 'Mountain Potion' || item === 'Ancient Vampire Wine') {
                const healAmount = item === 'Mountain Potion' ? rollDice(3, 6) + 10 : 
                                 item === 'Ancient Vampire Wine' ? rollDice(2, 8) + 5 : rollDice(2, 6) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Holy Water') {
                message = "The <span class='item'>Holy Water</span> is blessed and could harm undead, vampires, or dark artifacts like the Heartstone.";
                gameState.hasHolyWater = true;
            } else if (item === 'Silver Holy Symbol') {
                message = "The <span class='item'>Silver Holy Symbol</span> glows with holy energy. It might repel undead and vampire creatures.";
                gameState.hasHolySymbol = true;
            } else if (item === 'Ghost Bride\'s Locket') {
                message = "The <span class='item'>Ghost Bride's Locket</span> contains a strand of her hair. It might protect you from Valerius's gaze.";
            } else if (item === 'Eternal Blue Torch') {
                message = "The <span class='item'>Eternal Blue Torch</span> provides eerie blue light but no warmth. It never burns out.";
            } else if (item === 'Glowing Crypt Crystal') {
                message = "The <span class='item'>Glowing Crypt Crystal</span> pulses with soft blue light. It might be important for navigating the crypt.";
            } else if (item === 'Vampire Lore Tome') {
                message = "The <span class='item'>Vampire Lore Tome</span> contains valuable information about vampire weaknesses and powers.";
            } else if (item === 'Detailed Crypt Map') {
                message = "The <span class='item'>Detailed Crypt Map</span> shows all three levels of the crypt and secret passages.";
            } else if (item === 'Ancient Vampire Amulet') {
                message = "The <span class='item'>Ancient Vampire Amulet</span> is inscribed with vampire runes. It might offer protection or have other properties.";
            } else if (item === 'Valerius Signet Ring') {
                message = "The <span class='item'>Valerius Signet Ring</span> bears the Vorlak family crest. It feels warm to the touch and might grant authority in the crypt.";
            } else if (item === 'Skeleton King Crown') {
                message = "The <span class='item'>Skeleton King Crown</span> is made of tarnished silver set with dark gemstones. It might have value or significance.";
            } else if (item === 'Vampire Guardian Medallion') {
                message = "The <span class='item'>Vampire Guardian Medallion</span> might offer protection against vampire attacks.";
            } else if (item.includes('Shovel')) {
                gameState.equippedWeapon = item;
                updateInventoryDisplay();
                message = `You equip the <span class='item'>${item}</span>. It's heavy but could be an effective weapon.`;
            } else if (item === 'Necromancer Robes') {
                gameState.equippedArmor = 'Necromancer Robes';
                updateInventoryDisplay();
                message = "You wear the <span class='item'>Necromancer Robes</span>. They might offer protection against dark magic.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Sword' && 
                gameState.equippedArmor === 'Leather Armor') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check for random crypt events (cold draft, torch flicker)
            if (Math.random() > 0.7 && sectionId === 1) {
                randomEvents.coldDraft = true;
                playSound('crypt');
                storyText += "<br><br><span class='ghost'>A sudden cold draft sweeps through the crypt, making the torches flicker wildly.</span>";
            }
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 43 || sectionId === 66 || sectionId === 77 || 
                                   sectionId === 108 || sectionId === 113 || sectionId === 130 || 
                                   sectionId === 134 || sectionId === 138 || sectionId === 154 || 
                                   sectionId === 156 || sectionId === 168);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    let goldReward = 0;
                    
                    if (combatState.enemyName.includes("Wraith")) {
                        goldReward = Math.floor(Math.random() * 50) + 25;
                        gameState.wraithEncountered = true;
                    } else if (combatState.enemyName.includes("Skeleton")) {
                        goldReward = Math.floor(Math.random() * 60) + 30;
                        gameState.skeletonWarriorsDefeated = true;
                    } else if (combatState.enemyName.includes("Vampire Guardian")) {
                        goldReward = Math.floor(Math.random() * 80) + 40;
                    } else if (combatState.enemyName.includes("Bone Construct")) {
                        goldReward = Math.floor(Math.random() * 70) + 35;
                    } else if (combatState.enemyName.includes("Lich")) {
                        goldReward = Math.floor(Math.random() * 150) + 75;
                        gameState.lichDefeated = true;
                    }
                    
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    
                    if (goldReward > 0) {
                        storyText += `<br>You find <span class="gold">${goldReward} Gold</span> on the remains.`;
                    }
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    if (typeof choice.requirement === 'function') {
                        return choice.requirement();
                    }
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue exploring the crypt";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                let weaponType = gameState.equippedWeapon;
                
                // Special weapon bonuses
                if (weaponType.includes('Silver')) {
                    // Silver weapons deal extra damage to undead/vampires
                    damage = rollDice(2, 6) + 4;
                    if (combatState.enemyName.includes('Vampire') || combatState.enemyName.includes('undead') || combatState.enemyName.includes('Skeleton') || combatState.enemyName.includes('Lich') || combatState.enemyName.includes('Wraith')) {
                        damage += 5; // Extra vs undead/vampires
                        resultText += `<span class="item">Your silver weapon is especially effective against undead!</span><br>`;
                    }
                } else if (weaponType === 'Glowing Crystal Sword') {
                    damage = rollDice(3, 6) + 2; // Powerful weapon
                    resultText += `<span class="item">The glowing sword pulses with power!</span><br>`;
                } else if (weaponType === 'Ice Axe') {
                    damage = rollDice(2, 6) + 3;
                } else if (weaponType === 'Ancient Bone Dagger') {
                    damage = rollDice(2, 6) + 2;
                } else if (weaponType.includes('Shovel')) {
                    damage = rollDice(2, 6) + 1; // Shovel as weapon
                } else {
                    damage = rollDice(2, 6);
                }
                
                // Item bonuses
                if (gameState.hasHolyWater && (combatState.enemyName.includes('undead') || combatState.enemyName.includes('Vampire') || combatState.enemyName.includes('Lich') || combatState.enemyName.includes('Wraith'))) {
                    damage += 5;
                    resultText += `<span class="item">Holy water burns the undead creature!</span><br>`;
                }
                
                if (gameState.hasHolySymbol && (combatState.enemyName.includes('undead') || combatState.enemyName.includes('Vampire') || combatState.enemyName.includes('Lich') || combatState.enemyName.includes('Wraith'))) {
                    damage += 3;
                    resultText += `<span class="item">Your holy symbol glows, weakening the undead!</span><br>`;
                }
                
                if (gameState.equippedArmor === 'Necromancer Robes' && (combatState.enemyName.includes('Lich') || combatState.enemyName.includes('Wraith'))) {
                    damage += 2;
                    resultText += `<span class="item">Your necromancer robes absorb some dark energy!</span><br>`;
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                let enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                
                // Group enemies attack together
                if (combatState.isGroup && combatState.enemyName.includes('Skeleton') || combatState.enemyName.includes('Wraith') || combatState.enemyName.includes('Vampire')) {
                    enemyDamage += Math.floor(combatState.groupCount * 1.5); // Extra damage for group
                    if (combatState.groupCount > 1) {
                        resultText += `The enemies attack as a group!<br>`;
                    }
                }
                
                // Lich special attack
                if (combatState.enemyName.includes('Lich')) {
                    if (Math.random() > 0.7) {
                        enemyDamage += rollDice(2, 6); // Extra necromantic damage
                        resultText += `The lich channels dark magic into its attack!<br>`;
                    }
                }
                
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('castleUndeadGameState');
                        window.location.href = 'l1.html';
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You dodge a swinging blade trap!",
                    "You move silently past a sleeping guardian.",
                    "You climb to a high ledge and avoid danger.",
                    "You slip through a narrow passage others would miss."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip and take 3 damage!",
                    "You make noise and alert nearby guardians.",
                    "You get tangled in cobwebs or debris.",
                    "You knock over a skeletal remains, making a loud clatter."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 3;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 7 (this page)
                if (savedState.level === 7) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 7.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 8 with updated level
            gameState.level = 8;
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            // Redirect to level 8 (The Castle's Catacombs)
            window.location.href = 'l8.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
